{"pr_number": 1296, "pr_title": "FINERACT-1135: Fix SQL error at loan repayment template", "pr_createdAt": "2020-08-27T13:20:20Z", "pr_url": "https://github.com/apache/fineract/pull/1296", "timeline": [{"oid": "6202be1c442548d36a54d6dc5d24f0044082abe5", "url": "https://github.com/apache/fineract/commit/6202be1c442548d36a54d6dc5d24f0044082abe5", "message": "Fineract-1135 error at loan repayment", "committedDate": "2020-08-27T13:17:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NDU2MQ==", "url": "https://github.com/apache/fineract/pull/1296#discussion_r479594561", "bodyText": "If we are removing one parameter from the query, should we not also pass one less parameter when we execute the query?", "author": "ptuomola", "createdAt": "2020-08-29T02:10:08Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/service/LoanReadPlatformServiceImpl.java", "diffHunk": "@@ -431,7 +431,7 @@ public LoanTransactionData retrieveLoanTransactionTemplate(final Long loanId) {\n         this.context.authenticatedUser();\n \n         RepaymentTransactionTemplateMapper mapper = new RepaymentTransactionTemplateMapper();\n-        String sql = \"select \" + mapper.schema() + \" where l.id =?\";\n+        String sql = \"select \" + mapper.schema();\n         LoanTransactionData loanTransactionData = this.jdbcTemplate.queryForObject(sql, mapper, LoanTransactionType.REPAYMENT.getValue(),", "originalCommit": "6202be1c442548d36a54d6dc5d24f0044082abe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4MjY1Mg==", "url": "https://github.com/apache/fineract/pull/1296#discussion_r481082652", "bodyText": "I did not remove the parameter i only put it in its rightful place\nsqlBuilder.append(\" GROUP BY ls.duedate\");\t            sqlBuilder.append(\"WHERE l.id = ? \");\njust before the groub by object\nlook at line 2200\nBut still the sql runs even without this paramater is it is already called in other places like line 2198, line 2200 is just a \"fail safe\" parameter just in case there could be more than one result generated by the SQL script ( you never know)", "author": "francisguchie", "createdAt": "2020-09-01T11:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NDU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5NjU1MQ==", "url": "https://github.com/apache/fineract/pull/1296#discussion_r479596551", "bodyText": "Is there a reason for removing all these spaces from beginning of the strings? The reason for them, as far as I can see, is avoiding a situation where someone adds before a string that doesn't have a space at the end, and causes the next string to therefore generate broken SQL. I don't think they are harmful and can save us from some accidental illegal SQL...", "author": "ptuomola", "createdAt": "2020-08-29T02:33:04Z", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/loanaccount/service/LoanReadPlatformServiceImpl.java", "diffHunk": "@@ -2176,35 +2176,36 @@ public CurrencyData mapRow(ResultSet rs, @SuppressWarnings(\"unused\") int rowNum)\n         public String schema() {\n             StringBuilder sqlBuilder = new StringBuilder();\n \n-            sqlBuilder.append(\"if(max(tr.transaction_date)>ls.dueDate,max(tr.transaction_date),ls.dueDate) as transactionDate,\");\n+            sqlBuilder.append(\"if(max(tr.transaction_date)>ls.dueDate,max(tr.transaction_date),ls.dueDate) as transactionDate, \");\n             sqlBuilder.append(\n-                    \"ls.principal_amount - IFNULL(ls.principal_writtenoff_derived,0) - IFNULL(ls.principal_completed_derived,0) as principalDue,\");\n+                    \"ls.principal_amount - IFNULL(ls.principal_writtenoff_derived,0) - IFNULL(ls.principal_completed_derived,0) as principalDue, \");\n             sqlBuilder.append(\n-                    \"ls.interest_amount - IFNULL(ls.interest_completed_derived,0) - IFNULL(ls.interest_waived_derived,0) - IFNULL(ls.interest_writtenoff_derived,0) as interestDue,\");\n+                    \"ls.interest_amount - IFNULL(ls.interest_completed_derived,0) - IFNULL(ls.interest_waived_derived,0) - IFNULL(ls.interest_writtenoff_derived,0) as interestDue, \");\n             sqlBuilder.append(\n-                    \"ls.fee_charges_amount - IFNULL(ls.fee_charges_completed_derived,0) - IFNULL(ls.fee_charges_writtenoff_derived,0) - IFNULL(ls.fee_charges_waived_derived,0) as feeDue,\");\n+                    \"ls.fee_charges_amount - IFNULL(ls.fee_charges_completed_derived,0) - IFNULL(ls.fee_charges_writtenoff_derived,0) - IFNULL(ls.fee_charges_waived_derived,0) as feeDue, \");\n             sqlBuilder.append(\n-                    \"ls.penalty_charges_amount - IFNULL(ls.penalty_charges_completed_derived,0) - IFNULL(ls.penalty_charges_writtenoff_derived,0) - IFNULL(ls.penalty_charges_waived_derived,0) as penaltyDue,\");\n+                    \"ls.penalty_charges_amount - IFNULL(ls.penalty_charges_completed_derived,0) - IFNULL(ls.penalty_charges_writtenoff_derived,0) - IFNULL(ls.penalty_charges_waived_derived,0) as penaltyDue, \");\n             sqlBuilder.append(\n-                    \" l.currency_code as currencyCode, l.currency_digits as currencyDigits, l.currency_multiplesof as inMultiplesOf, rc.`name` as currencyName, \");\n-            sqlBuilder.append(\" rc.display_symbol as currencyDisplaySymbol, rc.internationalized_name_code as currencyNameCode \");\n-            sqlBuilder.append(\" FROM m_loan l\");", "originalCommit": "6202be1c442548d36a54d6dc5d24f0044082abe5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}