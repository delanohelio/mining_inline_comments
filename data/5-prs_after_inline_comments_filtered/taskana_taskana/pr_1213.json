{"pr_number": 1213, "pr_title": "TSK-1335: Add workbasket history events", "pr_createdAt": "2020-08-07T10:06:11Z", "pr_url": "https://github.com/Taskana/taskana/pull/1213", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk3Njk3MQ==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r466976971", "bodyText": "I think we could remove this check? The created timestamp gets set in every constructor", "author": "gitgoodjhe", "createdAt": "2020-08-07T11:15:50Z", "path": "history/taskana-simplehistory-provider/src/main/java/pro/taskana/simplehistory/impl/SimpleHistoryServiceImpl.java", "diffHunk": "@@ -10,48 +10,68 @@\n import pro.taskana.common.api.TaskanaRole;\n import pro.taskana.common.api.exceptions.InvalidArgumentException;\n import pro.taskana.common.api.exceptions.NotAuthorizedException;\n-import pro.taskana.simplehistory.impl.mappings.HistoryEventMapper;\n-import pro.taskana.simplehistory.impl.mappings.HistoryQueryMapper;\n-import pro.taskana.simplehistory.query.HistoryQuery;\n+import pro.taskana.simplehistory.impl.task.TaskHistoryEventMapper;\n+import pro.taskana.simplehistory.impl.task.TaskHistoryQuery;\n+import pro.taskana.simplehistory.impl.workbasket.WorkbasketHistoryEventMapper;\n+import pro.taskana.simplehistory.impl.workbasket.WorkbasketHistoryQuery;\n import pro.taskana.spi.history.api.TaskanaHistory;\n-import pro.taskana.spi.history.api.events.TaskanaHistoryEvent;\n+import pro.taskana.spi.history.api.events.task.TaskHistoryEvent;\n+import pro.taskana.spi.history.api.events.workbasket.WorkbasketHistoryEvent;\n import pro.taskana.spi.history.api.exceptions.TaskanaHistoryEventNotFoundException;\n \n /** This is the implementation of TaskanaHistory. */\n public class SimpleHistoryServiceImpl implements TaskanaHistory {\n \n   private static final Logger LOGGER = LoggerFactory.getLogger(SimpleHistoryServiceImpl.class);\n   private TaskanaHistoryEngineImpl taskanaHistoryEngine;\n-  private HistoryEventMapper historyEventMapper;\n-  private HistoryQueryMapper historyQueryMapper;\n+  private TaskHistoryEventMapper taskHistoryEventMapper;\n+  private WorkbasketHistoryEventMapper workbasketHistoryEventMapper;\n \n   @Override\n   public void initialize(TaskanaEngineConfiguration taskanaEngineConfiguration) {\n \n     this.taskanaHistoryEngine = getTaskanaEngine(taskanaEngineConfiguration);\n+\n     if (LOGGER.isDebugEnabled()) {\n       LOGGER.debug(\n           \"Simple history service implementation initialized with schemaName: {} \",\n           taskanaEngineConfiguration.getSchemaName());\n     }\n \n-    this.historyEventMapper =\n-        this.taskanaHistoryEngine.getSqlSession().getMapper(HistoryEventMapper.class);\n-    this.historyQueryMapper =\n-        this.taskanaHistoryEngine.getSqlSession().getMapper(HistoryQueryMapper.class);\n+    this.taskHistoryEventMapper =\n+        this.taskanaHistoryEngine.getSqlSession().getMapper(TaskHistoryEventMapper.class);\n+    this.workbasketHistoryEventMapper =\n+        this.taskanaHistoryEngine.getSqlSession().getMapper(WorkbasketHistoryEventMapper.class);\n   }\n \n   @Override\n-  public void create(TaskanaHistoryEvent event) {\n+  public void create(TaskHistoryEvent event) {\n     try {\n       taskanaHistoryEngine.openConnection();\n       if (event.getCreated() == null) {", "originalCommit": "bacd2b31c60bd625b4b4fe2238c0034c49a21d8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk3NzA0OA==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r466977048", "bodyText": "see above", "author": "gitgoodjhe", "createdAt": "2020-08-07T11:15:59Z", "path": "history/taskana-simplehistory-provider/src/main/java/pro/taskana/simplehistory/impl/SimpleHistoryServiceImpl.java", "diffHunk": "@@ -10,48 +10,68 @@\n import pro.taskana.common.api.TaskanaRole;\n import pro.taskana.common.api.exceptions.InvalidArgumentException;\n import pro.taskana.common.api.exceptions.NotAuthorizedException;\n-import pro.taskana.simplehistory.impl.mappings.HistoryEventMapper;\n-import pro.taskana.simplehistory.impl.mappings.HistoryQueryMapper;\n-import pro.taskana.simplehistory.query.HistoryQuery;\n+import pro.taskana.simplehistory.impl.task.TaskHistoryEventMapper;\n+import pro.taskana.simplehistory.impl.task.TaskHistoryQuery;\n+import pro.taskana.simplehistory.impl.workbasket.WorkbasketHistoryEventMapper;\n+import pro.taskana.simplehistory.impl.workbasket.WorkbasketHistoryQuery;\n import pro.taskana.spi.history.api.TaskanaHistory;\n-import pro.taskana.spi.history.api.events.TaskanaHistoryEvent;\n+import pro.taskana.spi.history.api.events.task.TaskHistoryEvent;\n+import pro.taskana.spi.history.api.events.workbasket.WorkbasketHistoryEvent;\n import pro.taskana.spi.history.api.exceptions.TaskanaHistoryEventNotFoundException;\n \n /** This is the implementation of TaskanaHistory. */\n public class SimpleHistoryServiceImpl implements TaskanaHistory {\n \n   private static final Logger LOGGER = LoggerFactory.getLogger(SimpleHistoryServiceImpl.class);\n   private TaskanaHistoryEngineImpl taskanaHistoryEngine;\n-  private HistoryEventMapper historyEventMapper;\n-  private HistoryQueryMapper historyQueryMapper;\n+  private TaskHistoryEventMapper taskHistoryEventMapper;\n+  private WorkbasketHistoryEventMapper workbasketHistoryEventMapper;\n \n   @Override\n   public void initialize(TaskanaEngineConfiguration taskanaEngineConfiguration) {\n \n     this.taskanaHistoryEngine = getTaskanaEngine(taskanaEngineConfiguration);\n+\n     if (LOGGER.isDebugEnabled()) {\n       LOGGER.debug(\n           \"Simple history service implementation initialized with schemaName: {} \",\n           taskanaEngineConfiguration.getSchemaName());\n     }\n \n-    this.historyEventMapper =\n-        this.taskanaHistoryEngine.getSqlSession().getMapper(HistoryEventMapper.class);\n-    this.historyQueryMapper =\n-        this.taskanaHistoryEngine.getSqlSession().getMapper(HistoryQueryMapper.class);\n+    this.taskHistoryEventMapper =\n+        this.taskanaHistoryEngine.getSqlSession().getMapper(TaskHistoryEventMapper.class);\n+    this.workbasketHistoryEventMapper =\n+        this.taskanaHistoryEngine.getSqlSession().getMapper(WorkbasketHistoryEventMapper.class);\n   }\n \n   @Override\n-  public void create(TaskanaHistoryEvent event) {\n+  public void create(TaskHistoryEvent event) {\n     try {\n       taskanaHistoryEngine.openConnection();\n       if (event.getCreated() == null) {\n         Instant now = Instant.now();\n         event.setCreated(now);\n       }\n-      historyEventMapper.insert(event);\n+      taskHistoryEventMapper.insert(event);\n     } catch (SQLException e) {\n-      LOGGER.error(\"Error while inserting history event into historyEventMapper\", e);\n+      LOGGER.error(\"Error while inserting task history event into database\", e);\n+    } finally {\n+      taskanaHistoryEngine.returnConnection();\n+      LOGGER.debug(\"Exit from create(TaskanaHistoryEvent event). Returning object = {}.\", event);\n+    }\n+  }\n+\n+  @Override\n+  public void create(WorkbasketHistoryEvent event) {\n+    try {\n+      taskanaHistoryEngine.openConnection();\n+      if (event.getCreated() == null) {", "originalCommit": "bacd2b31c60bd625b4b4fe2238c0034c49a21d8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4MDM3NA==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r467780374", "bodyText": "I think it would make sense to check the content of the event in such cases as well. Don't you think?", "author": "holgerhagen", "createdAt": "2020-08-10T09:17:24Z", "path": "history/taskana-simplehistory-provider/src/test/java/acceptance/events/workbasket/CreateHistoryEventOnWorkbasketDistributionTargetAddedAccTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package acceptance.events.workbasket;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import acceptance.AbstractAccTest;\n+import acceptance.security.JaasExtension;\n+import acceptance.security.WithAccessId;\n+import java.util.List;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import pro.taskana.simplehistory.impl.SimpleHistoryServiceImpl;\n+import pro.taskana.spi.history.api.events.workbasket.WorkbasketHistoryEvent;\n+import pro.taskana.spi.history.api.events.workbasket.WorkbasketHistoryEventType;\n+import pro.taskana.workbasket.api.WorkbasketService;\n+\n+@ExtendWith(JaasExtension.class)\n+class CreateHistoryEventOnWorkbasketDistributionTargetAddedAccTest extends AbstractAccTest {\n+\n+  private final WorkbasketService workbasketService = taskanaEngine.getWorkbasketService();\n+  private final SimpleHistoryServiceImpl historyService = getHistoryService();\n+\n+  @WithAccessId(user = \"admin\")\n+  @Test\n+  void should_CreateWorkbasketDistributionTargetAddedHistoryEvent_When_DistributionTargetIsAdded()\n+      throws Exception {\n+\n+    final String sourceWorkbasketId = \"WBI:100000000000000000000000000000000004\";\n+    final String targetWorkbasketId = \"WBI:100000000000000000000000000000000001\";\n+\n+    List<WorkbasketHistoryEvent> events =\n+        historyService.createWorkbasketHistoryQuery().workbasketIdIn(sourceWorkbasketId).list();\n+\n+    assertThat(events).isEmpty();\n+\n+    workbasketService.addDistributionTarget(sourceWorkbasketId, targetWorkbasketId);\n+\n+    events =\n+        historyService.createWorkbasketHistoryQuery().workbasketIdIn(sourceWorkbasketId).list();\n+\n+    assertThat(events).hasSize(1);\n+\n+    String eventType = events.get(0).getEventType();\n+\n+    assertThat(eventType)", "originalCommit": "bacd2b31c60bd625b4b4fe2238c0034c49a21d8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2NTI4Nw==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r468565287", "bodyText": "done", "author": "gitgoodjhe", "createdAt": "2020-08-11T13:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4MDM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4MDcxNg==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r467780716", "bodyText": "Don't we have access to the engine to reuse the existing methods?", "author": "holgerhagen", "createdAt": "2020-08-10T09:18:03Z", "path": "history/taskana-simplehistory-provider/src/main/java/pro/taskana/simplehistory/TaskanaHistoryEngine.java", "diffHunk": "@@ -10,4 +12,20 @@\n    * @return the HistoryService\n    */\n   TaskanaHistory getTaskanaHistoryService();\n+\n+  /**\n+   * check whether the current user is member of one of the roles specified.\n+   *\n+   * @param roles The roles that are checked for membership of the current user\n+   * @return true if the current user is a member of at least one of the specified groups\n+   */\n+  boolean isUserInRole(TaskanaRole... roles);", "originalCommit": "bacd2b31c60bd625b4b4fe2238c0034c49a21d8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2NjE0Mw==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r468566143", "bodyText": "unfortunately no...as soon as we pass the engine in the spi, this will be different and should be changed with the upcoming ticket to make the whole process transactionally safe", "author": "gitgoodjhe", "createdAt": "2020-08-11T13:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4MDcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTIzMg==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r467791232", "bodyText": "Would it make sense to move the ID generation and the change detection into the history?", "author": "holgerhagen", "createdAt": "2020-08-10T09:38:48Z", "path": "lib/taskana-core/src/main/java/pro/taskana/workbasket/internal/WorkbasketServiceImpl.java", "diffHunk": "@@ -176,6 +205,20 @@ public Workbasket updateWorkbasket(Workbasket workbasketToUpdate)\n \n         workbasketMapper.update(workbasketImplToUpdate);\n       }\n+\n+      if (HistoryEventManager.isHistoryEnabled()) {\n+\n+        String details =\n+            ObjectAttributeChangeDetector.determineChangesInAttributes(\n+                oldWorkbasket, workbasketToUpdate);\n+\n+        historyEventManager.createEvent(\n+            new WorkbasketUpdatedEvent(", "originalCommit": "bacd2b31c60bd625b4b4fe2238c0034c49a21d8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYyMDU5Ng==", "url": "https://github.com/Taskana/taskana/pull/1213#discussion_r468620596", "bodyText": "ID generation maybe, but the change detection is very dependent on the actual method where it takes place because of different parameter objects getting passed to the change detector. While it's possible, this change would require several hours of rework.", "author": "gitgoodjhe", "createdAt": "2020-08-11T14:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTIzMg=="}], "type": "inlineReview"}, {"oid": "9f988bc8436566b394e6b50ae6a9d9897ac19066", "url": "https://github.com/Taskana/taskana/commit/9f988bc8436566b394e6b50ae6a9d9897ac19066", "message": "TSK-1335: Add workbasket history events", "committedDate": "2020-08-12T08:29:04Z", "type": "commit"}, {"oid": "e1f034f0a6411d00798d84e0e7e5598bc6ae3306", "url": "https://github.com/Taskana/taskana/commit/e1f034f0a6411d00798d84e0e7e5598bc6ae3306", "message": "TSK-1335: Added create for WorkbasketHistoryEvents in historyLogger & review findings", "committedDate": "2020-08-12T11:12:46Z", "type": "commit"}]}