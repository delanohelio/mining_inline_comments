{"pr_number": 1210, "pr_title": "TSK-1299: Added embedded LDAP to Wildfly example.", "pr_createdAt": "2020-08-05T09:50:57Z", "pr_url": "https://github.com/Taskana/taskana/pull/1210", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0MTY0Mg==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466341642", "bodyText": "Does the above config.addAllowedMethod(\"*\"); not already include POST?", "author": "gitgoodjhe", "createdAt": "2020-08-06T11:18:12Z", "path": "rest/taskana-rest-spring-example-common/src/test/java/pro/taskana/rest/security/SpringBootWebSecurityConfig.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package pro.taskana.rest.security;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.web.servlet.FilterRegistrationBean;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.http.HttpMethod;\n+import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.core.GrantedAuthority;\n+import org.springframework.security.core.authority.SimpleGrantedAuthority;\n+import org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;\n+import org.springframework.security.core.authority.mapping.SimpleAuthorityMapper;\n+import org.springframework.security.ldap.DefaultSpringSecurityContextSource;\n+import org.springframework.security.ldap.userdetails.DefaultLdapAuthoritiesPopulator;\n+import org.springframework.security.ldap.userdetails.LdapAuthoritiesPopulator;\n+import org.springframework.security.web.jaasapi.JaasApiIntegrationFilter;\n+import org.springframework.security.web.util.matcher.AntPathRequestMatcher;\n+import org.springframework.web.cors.CorsConfiguration;\n+import org.springframework.web.cors.UrlBasedCorsConfigurationSource;\n+import org.springframework.web.filter.CorsFilter;\n+import org.springframework.web.servlet.config.annotation.CorsRegistry;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n+\n+/** Default basic configuration for taskana web example. */\n+@Configuration\n+@EnableWebSecurity\n+public class SpringBootWebSecurityConfig extends WebSecurityConfigurerAdapter {\n+\n+  @Value(\"${taskana.ldap.serverUrl:ldap://localhost:10389}\")\n+  private String ldapServerUrl;\n+\n+  @Value(\"${taskana.ldap.baseDn:OU=Test,O=TASKANA}\")\n+  private String ldapBaseDn;\n+\n+  @Value(\"${taskana.ldap.groupSearchBase:cn=groups}\")\n+  private String ldapGroupSearchBase;\n+\n+  @Value(\"${taskana.ldap.userDnPatterns:uid={0},cn=users}\")\n+  private String ldapUserDnPatterns;\n+\n+  @Value(\"${taskana.ldap.groupSearchFilter:uniqueMember={0}}\")\n+  private String ldapGroupSearchFilter;\n+\n+  @Value(\"${devMode:false}\")\n+  private boolean devMode;\n+\n+  @Bean\n+  public WebMvcConfigurer corsConfigurer() {\n+    return new CorsWebMvcConfigurer();\n+  }\n+\n+  @Bean\n+  public FilterRegistrationBean<CorsFilter> corsFilter() {\n+    final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n+    CorsConfiguration config = new CorsConfiguration();\n+    config.setAllowCredentials(true);\n+    config.addAllowedOrigin(\"*\");\n+    config.addAllowedHeader(\"*\");\n+    config.addAllowedMethod(\"*\");\n+    config.addAllowedMethod(\"POST\");", "originalCommit": "f5e65918f4ef78134bd8b25a49636bfe508d41cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2ODc1OQ==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466868759", "bodyText": "done", "author": "holgerhagen", "createdAt": "2020-08-07T07:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0MTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM0OTgyNg==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466349826", "bodyText": "please remove this", "author": "gitgoodjhe", "createdAt": "2020-08-06T11:35:41Z", "path": "rest/taskana-rest-spring-example-wildfly/src/main/java/pro/taskana/wildfly/security/LogoutController.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package pro.taskana.wildfly.security;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.servlet.view.RedirectView;\n+\n+/** The logout controller. */\n+@Controller\n+public class LogoutController {\n+\n+  private static final Logger LOGGER = LoggerFactory.getLogger(LogoutController.class);\n+\n+  @GetMapping(path = \"/logout\")\n+  public RedirectView loginErrorGet(HttpServletRequest request) {\n+    return logout(request);\n+  }\n+\n+  @PostMapping(path = \"/logout\")\n+  public RedirectView loginErrorPost(HttpServletRequest request) {\n+    return logout(request);\n+  }\n+\n+  public RedirectView logout(HttpServletRequest request) {\n+\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(\"Logging out...\");\n+    }\n+\n+    if (request.getSession(false) != null) {\n+      request.getSession(false).invalidate(); // remove session.\n+    }\n+    if (request.getSession() != null) {\n+      request.getSession().invalidate(); // remove session.\n+    }\n+\n+    try {\n+      request.logout();\n+    } catch (ServletException e) {\n+      e.printStackTrace();", "originalCommit": "f5e65918f4ef78134bd8b25a49636bfe508d41cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MDQxMA==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466350410", "bodyText": "see above", "author": "gitgoodjhe", "createdAt": "2020-08-06T11:37:00Z", "path": "rest/taskana-rest-spring-example-wildfly/src/main/java/pro/taskana/wildfly/security/WildflyWebSecurityConfig.java", "diffHunk": "@@ -1,141 +1,65 @@\n package pro.taskana.wildfly.security;\n \n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.web.servlet.FilterRegistrationBean;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n-import org.springframework.core.annotation.Order;\n-import org.springframework.security.authentication.AuthenticationManager;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n-import org.springframework.security.core.Authentication;\n-import org.springframework.security.core.AuthenticationException;\n-import org.springframework.security.core.GrantedAuthority;\n-import org.springframework.security.core.authority.SimpleGrantedAuthority;\n-import org.springframework.security.core.userdetails.AuthenticationUserDetailsService;\n-import org.springframework.security.core.userdetails.UserDetails;\n-import org.springframework.security.core.userdetails.UsernameNotFoundException;\n-import org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider;\n-import org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationToken;\n-import org.springframework.security.web.authentication.preauth.j2ee.J2eePreAuthenticatedProcessingFilter;\n-import org.wildfly.security.auth.server.SecurityDomain;\n-import org.wildfly.security.auth.server.SecurityIdentity;\n-import org.wildfly.security.authz.Roles;\n-\n-import pro.taskana.rest.security.WebSecurityConfig;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.web.jaasapi.JaasApiIntegrationFilter;\n+import org.springframework.web.cors.CorsConfiguration;\n+import org.springframework.web.cors.UrlBasedCorsConfigurationSource;\n+import org.springframework.web.filter.CorsFilter;\n+import org.springframework.web.servlet.config.annotation.CorsRegistry;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n /**\n  * Default basic configuration for taskana web example running on Wildfly / JBoss with Elytron or\n  * JAAS Security.\n  */\n @Configuration\n @EnableWebSecurity\n-@Order(1)\n-public class WildflyWebSecurityConfig extends WebSecurityConfig {\n-\n-  @Value(\"${devMode:false}\")\n-  private boolean devMode;\n+public class WildflyWebSecurityConfig extends WebSecurityConfigurerAdapter {\n \n   @Bean\n-  public J2eePreAuthenticatedProcessingFilter preAuthFilter() {\n-    J2eePreAuthenticatedProcessingFilter filter = new J2eePreAuthenticatedProcessingFilter();\n-    filter.setAuthenticationManager(preAuthManager());\n-    return filter;\n+  public WebMvcConfigurer corsConfigurer() {\n+    return new CorsWebMvcConfigurer();\n   }\n \n   @Bean\n-  public AuthenticationManager preAuthManager() {\n-    return new AuthenticationManager() {\n-\n-      @Override\n-      public Authentication authenticate(Authentication authentication)\n-          throws AuthenticationException {\n-        return preauthAuthProvider().authenticate(authentication);\n-      }\n-    };\n+  public FilterRegistrationBean<CorsFilter> corsFilter() {\n+    final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n+    CorsConfiguration config = new CorsConfiguration();\n+    config.setAllowCredentials(true);\n+    config.addAllowedOrigin(\"*\");\n+    config.addAllowedHeader(\"*\");\n+    config.addAllowedMethod(\"*\");\n+    config.addAllowedMethod(\"POST\");", "originalCommit": "f5e65918f4ef78134bd8b25a49636bfe508d41cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2ODgxMg==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466868812", "bodyText": "done", "author": "holgerhagen", "createdAt": "2020-08-07T07:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MDQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MzE3Mg==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466353172", "bodyText": "Shouldn't we use a logger for this?", "author": "gitgoodjhe", "createdAt": "2020-08-06T11:42:43Z", "path": "rest/taskana-rest-spring-example-wildfly/src/test/java/pro/taskana/TaskanaWildflyTest.java", "diffHunk": "@@ -34,9 +43,23 @@\n @RunWith(Arquillian.class)\n public class TaskanaWildflyTest {\n \n+  public static final String AUTHORIZATION_TEAMLEAD_1 = \"Basic dGVhbWxlYWQtMTp0ZWFtbGVhZC0x\";\n+\n   @Deployment(testable = false)\n   public static Archive<?> createTestArchive() {\n \n+    String applicationPropertyFile = \"application.properties\";\n+    String dbType = System.getProperty(\"db.type\");\n+    if (dbType != null && !dbType.isEmpty()) {\n+      applicationPropertyFile = \"application-\" + dbType + \".properties\";\n+    }\n+    System.err.println(", "originalCommit": "f5e65918f4ef78134bd8b25a49636bfe508d41cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMzMzMw==", "url": "https://github.com/Taskana/taskana/pull/1210#discussion_r466923333", "bodyText": "I've never done something with websecurityconfig.\nIs something special done here?", "author": "mustaphazorgati", "createdAt": "2020-08-07T09:17:03Z", "path": "rest/taskana-rest-spring-example-boot/src/main/java/pro/taskana/rest/security/SpringBootWebSecurityConfig.java", "diffHunk": "@@ -0,0 +1,180 @@\n+package pro.taskana.rest.security;", "originalCommit": "d6624667e2afd34ce362d6778224b858f226599e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "75e3a4835f35839c4fdfd6c02beb92ab67552b42", "url": "https://github.com/Taskana/taskana/commit/75e3a4835f35839c4fdfd6c02beb92ab67552b42", "message": "TSK-1299: Added embedded LDAP to Wildfly example.", "committedDate": "2020-08-07T11:24:27Z", "type": "commit"}]}