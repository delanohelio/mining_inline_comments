{"pr_number": 1151, "pr_title": "Tsk1308: Fixed ldap group query for access ids", "pr_createdAt": "2020-06-26T15:34:50Z", "pr_url": "https://github.com/Taskana/taskana/pull/1151", "timeline": [{"oid": "9942ed3e1fb44163d9d8d36feca02ab8602a64a9", "url": "https://github.com/Taskana/taskana/commit/9942ed3e1fb44163d9d8d36feca02ab8602a64a9", "message": "TSK-1308: Fixed: return groups from LDAP, accessId is member of.", "committedDate": "2020-06-26T12:19:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxOTYyOA==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447419628", "bodyText": "Why declare the type and then assign the value? This can be optimized (you don't have to do this.. I just noticed it)", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:32:47Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/common/rest/AccessIdController.java", "diffHunk": "@@ -58,16 +66,20 @@ public AccessIdController(LdapClient ldapClient) {\n \n   @GetMapping(path = Mapping.URL_ACCESSID_GROUPS)\n   public ResponseEntity<List<AccessIdRepresentationModel>> getGroupsByAccessId(\n-      @RequestParam(\"access-id\") String accessId) throws InvalidArgumentException {\n+      @RequestParam(\"access-id\") String accessId)\n+      throws InvalidArgumentException, NotAuthorizedException {\n+\n     LOGGER.debug(\"Entry to getGroupsByAccessId(access-id= {})\", accessId);\n+\n+    taskanaEngine.checkRoleMembership(TaskanaRole.ADMIN, TaskanaRole.BUSINESS_ADMIN);\n+\n     if (!validateAccessId(accessId)) {\n       throw new InvalidArgumentException(\"The accessId is invalid\");\n     }\n-    List<AccessIdRepresentationModel> accessIdUsers;\n+    List<AccessIdRepresentationModel> accessIds;\n     ResponseEntity<List<AccessIdRepresentationModel>> response;\n-    accessIdUsers = ldapClient.searchUsersAndGroups(accessId);\n-    accessIdUsers.addAll(ldapClient.searchGroupsofUsersIsMember(accessId));\n-    response = ResponseEntity.ok(accessIdUsers);\n+    accessIds = ldapClient.searchGroupsAccessIdIsMemberOf(accessId);\n+    response = ResponseEntity.ok(accessIds);", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxOTczNw==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447419737", "bodyText": "Does this work recursively?", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:33:11Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/common/rest/ldap/LdapClient.java", "diffHunk": "@@ -187,15 +188,15 @@ public AccessIdRepresentationModel searchGroupByDn(final String name) {\n     return accessId;\n   }\n \n-  public List<AccessIdRepresentationModel> searchGroupsofUsersIsMember(final String name)\n+  public List<AccessIdRepresentationModel> searchGroupsAccessIdIsMemberOf(final String name)", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyMjcxMQ==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447522711", "bodyText": "No, it doesn't. And based on my understanding, it shouldn't. Do you have another opinion?", "author": "holgerhagen", "createdAt": "2020-06-30T08:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxOTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzODI2Ng==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447538266", "bodyText": "Was just wondering. Nothing more :)", "author": "mustaphazorgati", "createdAt": "2020-06-30T09:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxOTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMDA4Mg==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447420082", "bodyText": "What's the reason for the like? Are we not searching strictly according to the accessId name?", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:34:20Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/common/rest/ldap/LdapClient.java", "diffHunk": "@@ -187,15 +188,15 @@ public AccessIdRepresentationModel searchGroupByDn(final String name) {\n     return accessId;\n   }\n \n-  public List<AccessIdRepresentationModel> searchGroupsofUsersIsMember(final String name)\n+  public List<AccessIdRepresentationModel> searchGroupsAccessIdIsMemberOf(final String name)\n       throws InvalidArgumentException {\n-    LOGGER.debug(\"entry to searchGroupsofUsersIsMember(name = {}).\", name);\n+    LOGGER.debug(\"entry to searchGroupsAccessIdIsMemberOf(name = {}).\", name);\n     isInitOrFail();\n     testMinSearchForLength(name);\n \n     final AndFilter andFilter = new AndFilter();\n-    andFilter.and(new WhitespaceWildcardsFilter(getGroupNameAttribute(), \"\"));\n-    andFilter.and(new EqualsFilter(getGroupsOfUser(), name));\n+    andFilter.and(new EqualsFilter(getGroupSearchFilterName(), getGroupSearchFilterValue()));\n+    andFilter.and(new LikeFilter(getGroupsOfUser(), \"*\" + name + \"*\"));", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyMzYzMg==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447523632", "bodyText": "No. name could be a user, which we handle as uid olny. In the uniquemember field we do have the DN for users and groups.", "author": "holgerhagen", "createdAt": "2020-06-30T08:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMDA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzOTU2MQ==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447539561", "bodyText": "Then I don't like the name of the method. The methodname implies that the parameter is a accessId. Can we talk about this? That's faster than typing.", "author": "mustaphazorgati", "createdAt": "2020-06-30T09:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMDA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMjI0MA==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447422240", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                List<AccessIdRepresentationModel> body = response.getBody();\n          \n          \n            \n                assertThat(body).isNotNull();\n          \n          \n            \n                assertThat(body)\n          \n          \n            \n                assertThat(response.getBody()).isNotNull()", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:41:21Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/common/rest/AccessIdControllerIntTest.java", "diffHunk": "@@ -110,6 +111,79 @@ void testBadRequestWhenSearchForIsTooShort() {\n         .isEqualTo(HttpStatus.BAD_REQUEST);\n   }\n \n+  @Test\n+  void should_returnAccessIdsOfGroupsTheAccessIdIsMemberOf_ifAccessIdOfUserIsGiven() {\n+    ResponseEntity<List<AccessIdRepresentationModel>> response =\n+        template.exchange(\n+            restHelper.toUrl(Mapping.URL_ACCESSID_GROUPS) + \"?access-id=teamlead-2\",\n+            HttpMethod.GET,\n+            restHelper.defaultRequest(),\n+            ParameterizedTypeReference.forType(AccessIdListResource.class));\n+\n+    List<AccessIdRepresentationModel> body = response.getBody();\n+    assertThat(body).isNotNull();\n+    assertThat(body)", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMjQxOA==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447422418", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                List<AccessIdRepresentationModel> body = response.getBody();\n          \n          \n            \n                assertThat(body).isNotNull();\n          \n          \n            \n                assertThat(body)\n          \n          \n            \n                assertThat(response.getBody()).isNotNull()", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:41:50Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/common/rest/AccessIdControllerIntTest.java", "diffHunk": "@@ -110,6 +111,79 @@ void testBadRequestWhenSearchForIsTooShort() {\n         .isEqualTo(HttpStatus.BAD_REQUEST);\n   }\n \n+  @Test\n+  void should_returnAccessIdsOfGroupsTheAccessIdIsMemberOf_ifAccessIdOfUserIsGiven() {\n+    ResponseEntity<List<AccessIdRepresentationModel>> response =\n+        template.exchange(\n+            restHelper.toUrl(Mapping.URL_ACCESSID_GROUPS) + \"?access-id=teamlead-2\",\n+            HttpMethod.GET,\n+            restHelper.defaultRequest(),\n+            ParameterizedTypeReference.forType(AccessIdListResource.class));\n+\n+    List<AccessIdRepresentationModel> body = response.getBody();\n+    assertThat(body).isNotNull();\n+    assertThat(body)\n+        .extracting(AccessIdRepresentationModel::getAccessId)\n+        .usingElementComparator(String.CASE_INSENSITIVE_ORDER)\n+        .containsExactlyInAnyOrder(\n+            \"cn=ksc-teamleads,cn=groups,OU=Test,O=TASKANA\",\n+            \"cn=business-admins,cn=groups,OU=Test,O=TASKANA\",\n+            \"cn=monitor-users,cn=groups,OU=Test,O=TASKANA\",\n+            \"cn=Organisationseinheit KSC 2,\"\n+                + \"cn=Organisationseinheit KSC,cn=organisation,OU=Test,O=TASKANA\");\n+  }\n+\n+  @Test\n+  void should_returnAccessIdsOfGroupsTheAccessIdIsMemberOf_ifAccessIdOfGroupIsGiven() {\n+    ResponseEntity<List<AccessIdRepresentationModel>> response =\n+        template.exchange(\n+            restHelper.toUrl(Mapping.URL_ACCESSID_GROUPS)\n+                + \"?access-id=cn=Organisationseinheit KSC 1,\"\n+                + \"cn=Organisationseinheit KSC,cn=organisation,OU=Test,O=TASKANA\",\n+            HttpMethod.GET,\n+            restHelper.defaultRequest(),\n+            ParameterizedTypeReference.forType(AccessIdListResource.class));\n+\n+    List<AccessIdRepresentationModel> body = response.getBody();\n+    assertThat(body).isNotNull();\n+    assertThat(body)", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyNDg4NA==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447424884", "bodyText": "whats the reason for the changes in this file? I don't see a matching change", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:49:38Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/task/rest/TaskControllerIntTest.java", "diffHunk": "@@ -476,8 +476,8 @@ void testGetLastPageSortedByDueWithHiddenTasksRemovedFromResult() {\n     assertThat(response.getBody()).isNotNull();\n     assertThat((response.getBody()).getContent()).hasSize(5);\n     assertThat(response.getBody().getRequiredLink(IanaLinkRelations.LAST).getHref())\n-        .contains(\"page=5\");\n-    assertThat(\"TKI:000000000000000000000000000000000023\")\n+        .contains(\"page=10\");\n+    assertThat(\"TKI:000000000000000000000000000000000005\")", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyNTIyNw==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447525227", "bodyText": "It's due to the changed groupSearchBase. Now he uses the org groups as well, resulting in more hits.", "author": "holgerhagen", "createdAt": "2020-06-30T08:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyNDg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyNTEyOQ==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447425129", "bodyText": "what's the reason for this change?", "author": "mustaphazorgati", "createdAt": "2020-06-30T05:50:15Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/workbasket/rest/WorkbasketControllerIntTest.java", "diffHunk": "@@ -82,7 +82,7 @@ void testGetAllWorkbasketsBusinessAdminHasOpenPermission() {\n             WORKBASKET_SUMMARY_PAGE_MODEL_TYPE);\n     assertThat(response.getBody()).isNotNull();\n     assertThat(response.getBody().getRequiredLink(IanaLinkRelations.SELF)).isNotNull();\n-    assertThat(response.getBody().getContent()).hasSize(3);\n+    assertThat(response.getBody().getContent()).hasSize(6);", "originalCommit": "3429b7f6e7f48ca39a6d53a77ca8ef5caaa6e28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUyNTMyMw==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r447525323", "bodyText": "see above.", "author": "holgerhagen", "createdAt": "2020-06-30T08:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyNTEyOQ=="}], "type": "inlineReview"}, {"oid": "432615af11182aac45aded11f8a58cdd88f370a1", "url": "https://github.com/Taskana/taskana/commit/432615af11182aac45aded11f8a58cdd88f370a1", "message": "TSK-1308: User must be in role ADMIN, BUSINESS_ADMIN to use AccessIdSrv.", "committedDate": "2020-07-01T07:51:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzA4Mw==", "url": "https://github.com/Taskana/taskana/pull/1151#discussion_r448217083", "bodyText": "name = accessId? Aber egal jetzt :D", "author": "mustaphazorgati", "createdAt": "2020-07-01T08:53:15Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/common/rest/ldap/LdapClient.java", "diffHunk": "@@ -187,15 +188,15 @@ public AccessIdRepresentationModel searchGroupByDn(final String name) {\n     return accessId;\n   }\n \n-  public List<AccessIdRepresentationModel> searchGroupsofUsersIsMember(final String name)\n+  public List<AccessIdRepresentationModel> searchGroupsAccessIdIsMemberOf(final String accessId)\n       throws InvalidArgumentException {\n-    LOGGER.debug(\"entry to searchGroupsofUsersIsMember(name = {}).\", name);\n+    LOGGER.debug(\"entry to searchGroupsAccessIdIsMemberOf(name = {}).\", accessId);", "originalCommit": "432615af11182aac45aded11f8a58cdd88f370a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}