{"pr_number": 10825, "pr_title": "Switched Active Directory test from using embedded apache directory \u2026", "pr_createdAt": "2020-02-10T18:59:02Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10825", "timeline": [{"oid": "9251e8ec6103c95e8b4e241e5bd49686963c08b7", "url": "https://github.com/OpenLiberty/open-liberty/commit/9251e8ec6103c95e8b4e241e5bd49686963c08b7", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-17T19:24:59Z", "type": "forcePushed"}, {"oid": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "url": "https://github.com/OpenLiberty/open-liberty/commit/4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-17T19:57:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyODA2Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380828062", "bodyText": "Missing other parameters.", "author": "jvanhill", "createdAt": "2020-02-18T17:37:08Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -54,30 +61,57 @@\n      * @param bases The base entries to create for this in-memory LDAP server.", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyODQ3NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380828474", "bodyText": "keystorePIN seems like it should be keystorePassword....", "author": "jvanhill", "createdAt": "2020-02-18T17:37:57Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -54,30 +61,57 @@\n      * @param bases The base entries to create for this in-memory LDAP server.\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean sslEnabled, String keystore, String keystorePIN, String schemaPath, String... bases) throws Exception {", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyODk1OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380828958", "bodyText": "I would also put the bases parameter first so it matches the default constructor, it is the other parameters that are optional.", "author": "jvanhill", "createdAt": "2020-02-18T17:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyODQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMDI3OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380830279", "bodyText": "It seems to me that the only difference between when SSL is enabled or not is the listener configs. No need to reproduce the other code. Additionally, seems like we should enable both when SSL is enabled. Given the \"setListenerConfigs\" method name, seems like you can pass in multiple listener configs (LDAP and LDAPS)?", "author": "jvanhill", "createdAt": "2020-02-18T17:41:12Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -54,30 +61,57 @@\n      * @param bases The base entries to create for this in-memory LDAP server.\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean sslEnabled, String keystore, String keystorePIN, String schemaPath, String... bases) throws Exception {\n+\n+        if (!sslEnabled) {\n+            config = new InMemoryDirectoryServerConfig(bases);\n+            config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n+            config.setListenerConfigs(\n+                                      InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n+                                                                              null, // Listen address. (null = listen on all interfaces)\n+                                                                              0, // Listen port (0 = automatically choose an available port)\n+                                                                              null) // StartTLS factory\n+\n+            ); // Client factory\n+\n+        } else {\n+            final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePIN", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMTQ4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380831481", "bodyText": "Might even consider always enabling LDAP and LDAPS....", "author": "jvanhill", "createdAt": "2020-02-18T17:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMDI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMTY0MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380831640", "bodyText": "that would remove the need to change the constructor.", "author": "jvanhill", "createdAt": "2020-02-18T17:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMDI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzMDg3OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380830879", "bodyText": "Instead of TLSV1.3, can we pass in a generic TLS (or something similar) that covers any valid TLS version? Then we don't have to come fix this when v4 comes out.", "author": "jvanhill", "createdAt": "2020-02-18T17:42:12Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -54,30 +61,57 @@\n      * @param bases The base entries to create for this in-memory LDAP server.\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean sslEnabled, String keystore, String keystorePIN, String schemaPath, String... bases) throws Exception {\n+\n+        if (!sslEnabled) {\n+            config = new InMemoryDirectoryServerConfig(bases);\n+            config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n+            config.setListenerConfigs(\n+                                      InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n+                                                                              null, // Listen address. (null = listen on all interfaces)\n+                                                                              0, // Listen port (0 = automatically choose an available port)\n+                                                                              null) // StartTLS factory\n+\n+            ); // Client factory\n+\n+        } else {\n+            final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePIN\n+                            .toCharArray(), \"JKS\", \"cert-alias\"), new TrustAllTrustManager());\n+            config = new InMemoryDirectoryServerConfig(bases);\n \n-        config = new InMemoryDirectoryServerConfig(bases);\n-        config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n-        config.setListenerConfigs(\n-                                  InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n-                                                                          null, // Listen address. (null = listen on all interfaces)\n-                                                                          0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n+            config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n+\n+            config.setListenerConfigs(InMemoryListenerConfig.createLDAPSConfig(\"LDAPS\", 0, serverSSLUtil.createSSLServerSocketFactory(\"TLSV1.3\")));", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzNTY1Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380835652", "bodyText": "Shouldn't have new tests. We are only modifying the existing tests.", "author": "jvanhill", "createdAt": "2020-02-18T17:51:00Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/FATSuite.java", "diffHunk": "@@ -54,6 +54,8 @@\n                 FATLDAPNameTest.class,\n                 FATTestPerformance.class,\n                 FATTestReuseConn.class,\n+                FATTestUnboundIDActiveDirectorywithSSL.class,", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzNTgzNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380835837", "bodyText": "Delete this test. Shouldn't have new tests.", "author": "jvanhill", "createdAt": "2020-02-18T17:51:21Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/FATTestUnboundIDActiveDirectorywithSSL.java", "diffHunk": "@@ -0,0 +1,866 @@\n+/*******************************************************************************", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgzNTk2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r380835963", "bodyText": "Delete this test. We shouldn't have new tests.", "author": "jvanhill", "createdAt": "2020-02-18T17:51:35Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/FATTestUnboundIDwithSSL.java", "diffHunk": "@@ -0,0 +1,251 @@\n+/*******************************************************************************", "originalCommit": "4b3f4f64e61a1c4dbbf3a3978252e1030b86fe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "133f498ede8a358ff5e44e4a996f4436548a80a6", "url": "https://github.com/OpenLiberty/open-liberty/commit/133f498ede8a358ff5e44e4a996f4436548a80a6", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-20T17:03:38Z", "type": "forcePushed"}, {"oid": "849fd3f0e5261f3650c3bda4e2fb4953a6dbae29", "url": "https://github.com/OpenLiberty/open-liberty/commit/849fd3f0e5261f3650c3bda4e2fb4953a6dbae29", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-20T19:02:11Z", "type": "forcePushed"}, {"oid": "a46c9b47157e0d9b2891888db87059f4176a5b6e", "url": "https://github.com/OpenLiberty/open-liberty/commit/a46c9b47157e0d9b2891888db87059f4176a5b6e", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-20T19:47:09Z", "type": "forcePushed"}, {"oid": "089f1e8801184889477bdf339dfbe966f8f5b1a1", "url": "https://github.com/OpenLiberty/open-liberty/commit/089f1e8801184889477bdf339dfbe966f8f5b1a1", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-21T16:59:43Z", "type": "forcePushed"}, {"oid": "4bc968908e273babf789f8c11edfcb50b7519f03", "url": "https://github.com/OpenLiberty/open-liberty/commit/4bc968908e273babf789f8c11edfcb50b7519f03", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-24T04:45:29Z", "type": "forcePushed"}, {"oid": "072a6a0852e9e4896c543a104be09bf3f47707f8", "url": "https://github.com/OpenLiberty/open-liberty/commit/072a6a0852e9e4896c543a104be09bf3f47707f8", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-24T17:40:34Z", "type": "forcePushed"}, {"oid": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "url": "https://github.com/OpenLiberty/open-liberty/commit/e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-24T19:37:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NDM1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383984354", "bodyText": "Documentation hasn't been updated for new class. I would explain that this class was created to contain the same data as the Active Directory instance of the ApacheDS stand-alone LDAP servers. This instance wasn't designed to behave like Active Directory.", "author": "jvanhill", "createdAt": "2020-02-25T16:16:27Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,251 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.net.InetAddress;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+\n+import com.unboundid.ldap.listener.InMemoryDirectoryServer;\n+import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;\n+import com.unboundid.ldap.listener.InMemoryListenerConfig;\n+import com.unboundid.ldap.sdk.DeleteRequest;\n+import com.unboundid.ldap.sdk.Entry;\n+import com.unboundid.ldap.sdk.LDAPConnection;\n+import com.unboundid.ldap.sdk.LDAPException;\n+import com.unboundid.ldap.sdk.Modification;\n+import com.unboundid.ldap.sdk.schema.Schema;\n+import com.unboundid.util.ssl.KeyStoreKeyManager;\n+import com.unboundid.util.ssl.SSLUtil;\n+import com.unboundid.util.ssl.TrustAllTrustManager;\n+\n+/**", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NDcwNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383984707", "bodyText": "I expected this class to extend InMemoryLDAPServer, and therefore not have to reimplement all the code.", "author": "jvanhill", "createdAt": "2020-02-25T16:16:59Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,251 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.net.InetAddress;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+\n+import com.unboundid.ldap.listener.InMemoryDirectoryServer;\n+import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;\n+import com.unboundid.ldap.listener.InMemoryListenerConfig;\n+import com.unboundid.ldap.sdk.DeleteRequest;\n+import com.unboundid.ldap.sdk.Entry;\n+import com.unboundid.ldap.sdk.LDAPConnection;\n+import com.unboundid.ldap.sdk.LDAPException;\n+import com.unboundid.ldap.sdk.Modification;\n+import com.unboundid.ldap.sdk.schema.Schema;\n+import com.unboundid.util.ssl.KeyStoreKeyManager;\n+import com.unboundid.util.ssl.SSLUtil;\n+import com.unboundid.util.ssl.TrustAllTrustManager;\n+\n+/**\n+ * An in memory UnboundID LDAP server. See ContextPoolTimeoutTest for an example on how to use this.\n+ *\n+ * <br><br>\n+ * Basic steps: Create an instance of this class passing in your base DNs, eg. o=ibm,c=us. Add users\n+ * and groups via entries. Note you will need to build the LDAP tree, so if you want to create\n+ * uid=user1,ou=users,o=ibm,c=us, then you need an entry for ou=users first.\n+ *\n+ * <br><br>\n+ * In addition to the standard classes, the schema has been extended with the following classes:\n+ * <ul>\n+ * <li>wimInetOrgPerson - an extension to the inetOrgPerson class that contains WIM PersonAccount attributes</li>\n+ * <li>wimGroupOfNames - an extension to the groupofNames class that contains WIM Group attributes.</li>\n+ * <li>simulatedMicrosoftSecurityPrincipal - a simulated Active Directory user containing samAccountName and memberOf</li>\n+ * </ul>\n+ *\n+ * You can view the WIM schema in wimschema.ldif.\n+ */\n+public class InMemoryADLDAPServer {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NTc2OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383985769", "bodyText": "When you extend from InMemoryLDAPServer, I would re-factor some of this. Really, the difference between the classes is the schema that gets loaded. So you could have the parent-class have a constructor that you can call with the schema that you want to load.", "author": "jvanhill", "createdAt": "2020-02-25T16:18:31Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,251 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.io.InputStream;\n+import java.net.InetAddress;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+\n+import com.unboundid.ldap.listener.InMemoryDirectoryServer;\n+import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;\n+import com.unboundid.ldap.listener.InMemoryListenerConfig;\n+import com.unboundid.ldap.sdk.DeleteRequest;\n+import com.unboundid.ldap.sdk.Entry;\n+import com.unboundid.ldap.sdk.LDAPConnection;\n+import com.unboundid.ldap.sdk.LDAPException;\n+import com.unboundid.ldap.sdk.Modification;\n+import com.unboundid.ldap.sdk.schema.Schema;\n+import com.unboundid.util.ssl.KeyStoreKeyManager;\n+import com.unboundid.util.ssl.SSLUtil;\n+import com.unboundid.util.ssl.TrustAllTrustManager;\n+\n+/**\n+ * An in memory UnboundID LDAP server. See ContextPoolTimeoutTest for an example on how to use this.\n+ *\n+ * <br><br>\n+ * Basic steps: Create an instance of this class passing in your base DNs, eg. o=ibm,c=us. Add users\n+ * and groups via entries. Note you will need to build the LDAP tree, so if you want to create\n+ * uid=user1,ou=users,o=ibm,c=us, then you need an entry for ou=users first.\n+ *\n+ * <br><br>\n+ * In addition to the standard classes, the schema has been extended with the following classes:\n+ * <ul>\n+ * <li>wimInetOrgPerson - an extension to the inetOrgPerson class that contains WIM PersonAccount attributes</li>\n+ * <li>wimGroupOfNames - an extension to the groupofNames class that contains WIM Group attributes.</li>\n+ * <li>simulatedMicrosoftSecurityPrincipal - a simulated Active Directory user containing samAccountName and memberOf</li>\n+ * </ul>\n+ *\n+ * You can view the WIM schema in wimschema.ldif.\n+ */\n+public class InMemoryADLDAPServer {\n+\n+    private static final Class<?> c = InMemoryADLDAPServer.class;\n+\n+    private InMemoryDirectoryServerConfig config = null;\n+    private InMemoryDirectoryServer ds = null;\n+\n+    private static final String keystorePassword = \"LDAPpassword\";\n+    private final String keystore;\n+\n+    /**\n+     * Creates a new instance of the in memory LDAP server. It initializes the directory\n+     * service.\n+     *\n+     * @param bases The base entries to create for this in-memory LDAP server.\n+     * @throws Exception If something went wrong\n+     */\n+    public InMemoryADLDAPServer(String... bases) throws Exception {\n+//        Files.copy(getClass().getResourceAsStream(\"/resources/keystore.jks\"), FileSystems.getDefault().getPath(\"\"), StandardCopyOption.REPLACE_EXISTING);\n+//        Log.info(c, \"InMemoryADLDAPSERVER\", FileSystems.getDefault().getPath(\"keystore.jks\").toString());\n+\n+        File tempkeystore = File.createTempFile(\"keystore\", \".jks\");\n+        InputStream src = c.getResourceAsStream(\"/resources/keystore.jks\");\n+        Files.copy(src, Paths.get(tempkeystore.getAbsolutePath()), StandardCopyOption.REPLACE_EXISTING);\n+        keystore = tempkeystore.getAbsolutePath();\n+        config = new InMemoryDirectoryServerConfig(bases);\n+        config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n+        config.setListenerConfigs(\n+                                  InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n+                                                                          null, // Listen address. (null = listen on all interfaces)\n+                                                                          0, // Listen port (0 = automatically choose an available port)\n+                                                                          null));// StartTLS factory\n+\n+        final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePassword\n+                        .toCharArray(), \"JKS\", \"cert-alias\"), new TrustAllTrustManager());\n+\n+        config.setListenerConfigs(InMemoryListenerConfig.createLDAPSConfig(\"LDAPS\", 0, serverSSLUtil.createSSLServerSocketFactory()));\n+\n+        /*\n+         * Merge the default schema with our WIM schema. The WIM schema adds wimInetOrgPerson,\n+         * wimGroupOfNames, and simulatedMicrosoftSecurityPrincipal. The wimInetOrgPerson\n+         * adds WIM properties as LDAP attributes so that we do not need to set up a mapping\n+         * between the WIM properties and other existing LDAP attributes.\n+         */\n+        Schema schema = null;", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NjE5Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383986196", "bodyText": "Why have this if it is commented out? I assume you will want this when you have the new class extend this class.", "author": "jvanhill", "createdAt": "2020-02-25T16:19:09Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -56,28 +67,37 @@\n      */\n     public InMemoryLDAPServer(String... bases) throws Exception {\n \n+        File tempkeystore = File.createTempFile(\"keystore\", \".jks\");\n+        InputStream src = c.getResourceAsStream(\"/resources/keystore.jks\");\n+        Files.copy(src, Paths.get(tempkeystore.getAbsolutePath()), StandardCopyOption.REPLACE_EXISTING);\n+        keystore = tempkeystore.getAbsolutePath();\n         config = new InMemoryDirectoryServerConfig(bases);\n         config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n         config.setListenerConfigs(\n                                   InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n                                                                           null, // Listen address. (null = listen on all interfaces)\n                                                                           0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n+                                                                          null));// StartTLS factory\n+\n+//        final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePassword", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NjU0Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383986547", "bodyText": "Why did you add this? Not sure we want JUnit assertions in here.", "author": "jvanhill", "createdAt": "2020-02-25T16:19:44Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -56,28 +67,37 @@\n      */\n     public InMemoryLDAPServer(String... bases) throws Exception {\n \n+        File tempkeystore = File.createTempFile(\"keystore\", \".jks\");\n+        InputStream src = c.getResourceAsStream(\"/resources/keystore.jks\");\n+        Files.copy(src, Paths.get(tempkeystore.getAbsolutePath()), StandardCopyOption.REPLACE_EXISTING);\n+        keystore = tempkeystore.getAbsolutePath();\n         config = new InMemoryDirectoryServerConfig(bases);\n         config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n         config.setListenerConfigs(\n                                   InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n                                                                           null, // Listen address. (null = listen on all interfaces)\n                                                                           0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n+                                                                          null));// StartTLS factory\n+\n+//        final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePassword\n+//                        .toCharArray(), \"JKS\", \"cert-alias\"), new TrustAllTrustManager());\n+//\n+//        config.setListenerConfigs(InMemoryListenerConfig.createLDAPSConfig(\"LDAPS\", 0, serverSSLUtil.createSSLServerSocketFactory()));\n \n         /*\n          * Merge the default schema with our WIM schema. The WIM schema adds wimInetOrgPerson,\n          * wimGroupOfNames, and simulatedMicrosoftSecurityPrincipal. The wimInetOrgPerson\n          * adds WIM properties as LDAP attributes so that we do not need to set up a mapping\n          * between the WIM properties and other existing LDAP attributes.\n          */\n-\n+        Schema schema = null;\n         InputStream in = getClass().getResourceAsStream(\"/resources/wimschema.ldif\");\n         Schema wimschema = Schema.getSchema(in);\n-        Schema schema = Schema.mergeSchemas(Schema.getDefaultStandardSchema(), wimschema);\n+        schema = Schema.mergeSchemas(Schema.getDefaultStandardSchema(), wimschema);\n         config.setSchema(schema);\n         ds = new InMemoryDirectoryServer(config);\n         ds.startListening();\n+        assertTrue(ds.getListenPort() > 0);", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4Nzk1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383987953", "bodyText": "In general for this class, I wouldn't have expected so many changes. I can't be sure that you didn't change the test. Methods have been moved around, etc.\nI guess I would expect that the difference would be in the general setup of the LDAP and Liberty server (to dynamically configure the LDAP connection). Most everything else should remain the same. Renaming fields just makes it harder to determine what you really changed.", "author": "jvanhill", "createdAt": "2020-02-25T16:21:42Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -12,6 +12,7 @@\n package com.ibm.ws.security.wim.adapter.ldap.fat;\n \n import static componenttest.topology.utils.LDAPFatUtils.assertDNsEqual;\n+import static componenttest.topology.utils.LDAPFatUtils.updateConfigDynamically;", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4ODQwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383988400", "bodyText": "keystorePassword please. I am not sure why UnboundID uses pin, but it is not standard phrasing.", "author": "jvanhill", "createdAt": "2020-02-25T16:22:20Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4ODk0Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383988943", "bodyText": "put this in the finally", "author": "jvanhill", "createdAt": "2020-02-25T16:23:09Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";\n+    private static String KEYSTORE_PATH;\n+    private static String LDIF_PATH;\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupLdapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4OTI0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r383989248", "bodyText": "remove commented out code.", "author": "jvanhill", "createdAt": "2020-02-25T16:23:35Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";\n+    private static String KEYSTORE_PATH;\n+    private static String LDIF_PATH;\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupLdapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n \n-        //Make sure the application has come up before proceeding\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n         assertNotNull(\"Application userRegistry does not appear to have started.\",\n-                      server.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n         assertNotNull(\"Security service did not report it was ready\",\n-                      server.waitForStringInLog(\"CWWKS0008I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n         assertNotNull(\"Server did not came up\",\n-                      server.waitForStringInLog(\"CWWKF0011I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n \n         Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n-        servlet = new UserRegistryServletConnection(server.getHostname(), server.getHttpDefaultPort());\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n \n         if (servlet.getRealm() == null) {\n             Thread.sleep(5000);\n             servlet.getRealm();\n         }\n+\n+        initialConfiguration = libertyServer.getServerConfiguration();\n     }\n \n-    @AfterClass\n-    public static void tearDown() throws Exception {\n-        Log.info(c, \"tearDown\", \"Stopping the server...\");\n-        try {\n-            server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n-        } finally {\n-            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n-        }\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupLdapServer() throws Exception {\n+        String serverPath = libertyServer.getServerRoot();\n+        KEYSTORE_PATH = serverPath + \"/keystore.jks\";\n+        LDIF_PATH = serverPath + \"/AD.ldif\";\n+        Log.info(c, \"setupLdapServer\", \"LDIF Path is \" + LDIF_PATH);\n+        ds = new InMemoryADLDAPServer(BASE_DN);\n+        int entriesAdded = ds.importFromLDIF(true, LDIF_PATH);\n+        Log.info(c, \"setupLdapServer\", \"Adding \" + entriesAdded + \" changes to LDAP Server\");\n+\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = initialConfiguration.clone();\n+\n+        LdapRegistry ldap = server.getLdapRegistries().remove(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+        ldap.setBaseDN(BASE_DN);\n+        ldap.setBindDN(InMemoryADLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryADLDAPServer.getBindPassword());\n+        ldap.setSslRef(\"LDAPSSLSettings\");\n+        ldap.setSslEnabled(true);\n+        server.getLdapRegistries().add(ldap);\n+\n+//        ContextPool cp = new ContextPool(true, 0, 2, 1, \"1m\", \"5s\");", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwOTQ1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384009454", "bodyText": "Update copyright date above.", "author": "jvanhill", "createdAt": "2020-02-25T17:12:36Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -11,13 +11,21 @@\n \n package com.ibm.ws.com.unboundid;\n \n+import static org.junit.Assert.assertTrue;", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwOTgyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384009822", "bodyText": "Update documentation to reflect the method.", "author": "jvanhill", "createdAt": "2020-02-25T17:13:02Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -135,6 +155,15 @@ public void shutDown(boolean b) {\n \n     }\n \n+    /**\n+     * Get the port the server is listening to.", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNzQyOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389937429", "bodyText": "This documentation is still wrong.", "author": "jvanhill", "createdAt": "2020-03-09T20:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwOTgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxMzY4OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384013688", "bodyText": "If we don't change the server.xml very much, we can simply get the configuration and request the single LDAP server from it and update the connection properties.", "author": "jvanhill", "createdAt": "2020-02-25T17:18:53Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";\n+    private static String KEYSTORE_PATH;\n+    private static String LDIF_PATH;\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupLdapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n \n-        //Make sure the application has come up before proceeding\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n         assertNotNull(\"Application userRegistry does not appear to have started.\",\n-                      server.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n         assertNotNull(\"Security service did not report it was ready\",\n-                      server.waitForStringInLog(\"CWWKS0008I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n         assertNotNull(\"Server did not came up\",\n-                      server.waitForStringInLog(\"CWWKF0011I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n \n         Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n-        servlet = new UserRegistryServletConnection(server.getHostname(), server.getHttpDefaultPort());\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n \n         if (servlet.getRealm() == null) {\n             Thread.sleep(5000);\n             servlet.getRealm();\n         }\n+\n+        initialConfiguration = libertyServer.getServerConfiguration();\n     }\n \n-    @AfterClass\n-    public static void tearDown() throws Exception {\n-        Log.info(c, \"tearDown\", \"Stopping the server...\");\n-        try {\n-            server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n-        } finally {\n-            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n-        }\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupLdapServer() throws Exception {\n+        String serverPath = libertyServer.getServerRoot();\n+        KEYSTORE_PATH = serverPath + \"/keystore.jks\";\n+        LDIF_PATH = serverPath + \"/AD.ldif\";\n+        Log.info(c, \"setupLdapServer\", \"LDIF Path is \" + LDIF_PATH);\n+        ds = new InMemoryADLDAPServer(BASE_DN);\n+        int entriesAdded = ds.importFromLDIF(true, LDIF_PATH);\n+        Log.info(c, \"setupLdapServer\", \"Adding \" + entriesAdded + \" changes to LDAP Server\");\n+\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void updateLibertyServer() throws Exception {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNjU5OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384016599", "bodyText": "Why the looping?", "author": "jvanhill", "createdAt": "2020-02-25T17:23:24Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -285,10 +406,12 @@ public void getUsersWithWildcard() throws Exception {\n      */\n     @Test\n     public void getUsersWithInvalidUser() throws Exception {\n-        String user = \"invalid\";\n-        Log.info(c, \"getUsersWithInvalidUser\", \"Checking with a invalid pattern and limit of 2.\");\n-        SearchResult result = servlet.getUsers(user, 2);\n-        assertEquals(\"There should only be one entry\", 0, result.getList().size());\n+        for (int i = 0; i < 500; i++) {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNjgwOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384016809", "bodyText": "Why was this moved?", "author": "jvanhill", "createdAt": "2020-02-25T17:23:43Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -148,16 +292,6 @@ public void getUsersForGroupWithInvalidGroup() throws Exception {\n         servlet.getUsersForGroup(group, 0);\n     }\n \n-    /**", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNjg1MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384016851", "bodyText": "Why was this moved?", "author": "jvanhill", "createdAt": "2020-02-25T17:23:48Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -148,16 +292,6 @@ public void getUsersForGroupWithInvalidGroup() throws Exception {\n         servlet.getUsersForGroup(group, 0);\n     }\n \n-    /**\n-     * Hit the test servlet to see if getRealm works.\n-     * This verifies the various required bundles got installed and are working.\n-     */\n-    @Test\n-    public void getRealm() throws Exception {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNzA5NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384017095", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                    Log.info(c, \"checkPassword\", \"Checking good credentials\");", "author": "jvanhill", "createdAt": "2020-02-25T17:24:10Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -166,7 +300,7 @@ public void getRealm() throws Exception {\n     public void checkPassword() throws Exception {\n         String user = \"vmmtestuser\";\n         String password = \"vmmtestuserpwd\";\n-        Log.info(c, \"checkPassword\", \"Checking good credentials\");\n+", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNzUwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384017500", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    System.out.println(\"getUsersForGroupWithValidGroup: \" + list.toString());", "author": "jvanhill", "createdAt": "2020-02-25T17:24:50Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -102,6 +244,7 @@ public void getUsersForGroupWithValidGroup() throws Exception {\n         Log.info(c, \"getUsersForGroupWithValidGroup\", \"Checking with a valid group.\");\n         SearchResult result = servlet.getUsersForGroup(group, 0);\n         List<String> list = result.getList();\n+        System.out.println(\"getUsersForGroupWithValidGroup: \" + list.toString());", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNzUzMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384017530", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    System.out.print(\"getUsersForGroupWithLimitWithNestedGroup: \" + list.toString());", "author": "jvanhill", "createdAt": "2020-02-25T17:24:52Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -128,6 +271,7 @@ public void getUsersForGroupWithLimitWithNestedGroup() throws Exception {\n         Log.info(c, \"getUsersForGroupWithLimitWithNestedGroup\", \"Checking with a valid group.\");\n         SearchResult result = servlet.getUsersForGroup(group, 10);\n         List<String> list = result.getList();\n+        System.out.print(\"getUsersForGroupWithLimitWithNestedGroup: \" + list.toString());", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNzc3NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384017774", "bodyText": "Why was this moved?", "author": "jvanhill", "createdAt": "2020-02-25T17:25:14Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";\n+    private static String KEYSTORE_PATH;\n+    private static String LDIF_PATH;\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupLdapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n \n-        //Make sure the application has come up before proceeding\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n         assertNotNull(\"Application userRegistry does not appear to have started.\",\n-                      server.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n         assertNotNull(\"Security service did not report it was ready\",\n-                      server.waitForStringInLog(\"CWWKS0008I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n         assertNotNull(\"Server did not came up\",\n-                      server.waitForStringInLog(\"CWWKF0011I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n \n         Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n-        servlet = new UserRegistryServletConnection(server.getHostname(), server.getHttpDefaultPort());\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n \n         if (servlet.getRealm() == null) {\n             Thread.sleep(5000);\n             servlet.getRealm();\n         }\n+\n+        initialConfiguration = libertyServer.getServerConfiguration();\n     }\n \n-    @AfterClass\n-    public static void tearDown() throws Exception {\n-        Log.info(c, \"tearDown\", \"Stopping the server...\");\n-        try {\n-            server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n-        } finally {\n-            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n-        }\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupLdapServer() throws Exception {\n+        String serverPath = libertyServer.getServerRoot();\n+        KEYSTORE_PATH = serverPath + \"/keystore.jks\";\n+        LDIF_PATH = serverPath + \"/AD.ldif\";\n+        Log.info(c, \"setupLdapServer\", \"LDIF Path is \" + LDIF_PATH);\n+        ds = new InMemoryADLDAPServer(BASE_DN);\n+        int entriesAdded = ds.importFromLDIF(true, LDIF_PATH);\n+        Log.info(c, \"setupLdapServer\", \"Adding \" + entriesAdded + \" changes to LDAP Server\");\n+\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = initialConfiguration.clone();\n+\n+        LdapRegistry ldap = server.getLdapRegistries().remove(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+        ldap.setBaseDN(BASE_DN);\n+        ldap.setBindDN(InMemoryADLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryADLDAPServer.getBindPassword());\n+        ldap.setSslRef(\"LDAPSSLSettings\");\n+        ldap.setSslEnabled(true);\n+        server.getLdapRegistries().add(ldap);\n+\n+//        ContextPool cp = new ContextPool(true, 0, 2, 1, \"1m\", \"5s\");\n+//        ldap.setContextPool(cp);\n+//        SearchResultsCache src = new SearchResultsCache();\n+//        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+\n+        KeyStore LDAPKeyStore = new KeyStore();\n+        LDAPKeyStore.setId(\"LDAPKeyStore\");\n+        LDAPKeyStore.setLocation(KEYSTORE_PATH);\n+        LDAPKeyStore.setPassword(keystorePIN);\n+\n+        KeyStore LDAPTrustStore = new KeyStore();\n+        LDAPTrustStore.setId(\"LDAPTrustStore\");\n+        LDAPTrustStore.setLocation(KEYSTORE_PATH);\n+        LDAPTrustStore.setPassword(keystorePIN);\n+\n+        server.getKeyStores().add(LDAPKeyStore);\n+        server.getKeyStores().add(LDAPTrustStore);\n+\n+        SSLDefault defaultSettings = new SSLDefault();\n+        defaultSettings.setSslRef(\"DefaultSSLSettings\");\n+        server.setSSLDefault(defaultSettings);\n+\n+        SSL defaultSSL = new SSL();\n+        defaultSSL.setId(\"DefaultSSLSettings\");\n+        defaultSSL.setKeyStoreRef(\"defaultKeyStore\");\n+        server.addSSL(defaultSSL);\n+\n+        SSL sslCfg = new SSL();\n+        sslCfg.setId(\"LDAPSSLSettings\");\n+        sslCfg.setKeyStoreRef(\"LDAPKeyStore\");\n+        sslCfg.setTrustStoreRef(\"LDAPTrustStore\");\n+        server.addSSL(sslCfg);\n+\n+        updateConfigDynamically(libertyServer, server);\n+        Log.info(c, \"updateLibertyServer\", libertyServer.getServerConfigurationPath());\n+    }\n+\n+    /**\n+     * Hit the test servlet to see if getRealm works.\n+     * This verifies the various required bundles got installed and are working.\n+     */\n+    @Test\n+    public void getRealm() throws Exception {\n+        Log.info(c, \"getRealm\", \"Checking expected realm\");\n+        assertEquals(\"SampleLdapADRealm\", servlet.getRealm());\n+    }\n+\n+    /**\n+     * Hit the test servlet to see if getUsers works when passed in a valid user pattern\n+     * and a limit of 2; should only expect to find one entry\n+     * This verifies the various required bundles got installed and are working.\n+     */\n+    @Test\n+    public void getUsers() throws Exception {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAxNzgxMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r384017813", "bodyText": "Why was this moved?", "author": "jvanhill", "createdAt": "2020-02-25T17:25:18Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +49,189 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    /**\n+     * Nearly empty server configuration. This should just contain the feature manager configuration with no\n+     * registries or federated repository configured.\n+     */\n+    private static ServerConfiguration initialConfiguration = null;\n+\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n+    private static final String USER = \"CN=Users\";\n+    private static String keystorePIN = \"LDAPpassword\";\n+    private static String KEYSTORE_PATH;\n+    private static String LDIF_PATH;\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLibertyServer();\n+        setupLdapServer();\n+        updateLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+        }\n+        libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+        libertyServer.startServer(c.getName() + \".log\");\n \n-        //Make sure the application has come up before proceeding\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n         assertNotNull(\"Application userRegistry does not appear to have started.\",\n-                      server.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n         assertNotNull(\"Security service did not report it was ready\",\n-                      server.waitForStringInLog(\"CWWKS0008I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n         assertNotNull(\"Server did not came up\",\n-                      server.waitForStringInLog(\"CWWKF0011I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n \n         Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n-        servlet = new UserRegistryServletConnection(server.getHostname(), server.getHttpDefaultPort());\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n \n         if (servlet.getRealm() == null) {\n             Thread.sleep(5000);\n             servlet.getRealm();\n         }\n+\n+        initialConfiguration = libertyServer.getServerConfiguration();\n     }\n \n-    @AfterClass\n-    public static void tearDown() throws Exception {\n-        Log.info(c, \"tearDown\", \"Stopping the server...\");\n-        try {\n-            server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n-        } finally {\n-            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n-        }\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupLdapServer() throws Exception {\n+        String serverPath = libertyServer.getServerRoot();\n+        KEYSTORE_PATH = serverPath + \"/keystore.jks\";\n+        LDIF_PATH = serverPath + \"/AD.ldif\";\n+        Log.info(c, \"setupLdapServer\", \"LDIF Path is \" + LDIF_PATH);\n+        ds = new InMemoryADLDAPServer(BASE_DN);\n+        int entriesAdded = ds.importFromLDIF(true, LDIF_PATH);\n+        Log.info(c, \"setupLdapServer\", \"Adding \" + entriesAdded + \" changes to LDAP Server\");\n+\n+    }\n+\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void updateLibertyServer() throws Exception {\n+        ServerConfiguration server = initialConfiguration.clone();\n+\n+        LdapRegistry ldap = server.getLdapRegistries().remove(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+        ldap.setBaseDN(BASE_DN);\n+        ldap.setBindDN(InMemoryADLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryADLDAPServer.getBindPassword());\n+        ldap.setSslRef(\"LDAPSSLSettings\");\n+        ldap.setSslEnabled(true);\n+        server.getLdapRegistries().add(ldap);\n+\n+//        ContextPool cp = new ContextPool(true, 0, 2, 1, \"1m\", \"5s\");\n+//        ldap.setContextPool(cp);\n+//        SearchResultsCache src = new SearchResultsCache();\n+//        src.setEnabled(false); // disable search cache so we can look up the same user over and over again\n+\n+        KeyStore LDAPKeyStore = new KeyStore();\n+        LDAPKeyStore.setId(\"LDAPKeyStore\");\n+        LDAPKeyStore.setLocation(KEYSTORE_PATH);\n+        LDAPKeyStore.setPassword(keystorePIN);\n+\n+        KeyStore LDAPTrustStore = new KeyStore();\n+        LDAPTrustStore.setId(\"LDAPTrustStore\");\n+        LDAPTrustStore.setLocation(KEYSTORE_PATH);\n+        LDAPTrustStore.setPassword(keystorePIN);\n+\n+        server.getKeyStores().add(LDAPKeyStore);\n+        server.getKeyStores().add(LDAPTrustStore);\n+\n+        SSLDefault defaultSettings = new SSLDefault();\n+        defaultSettings.setSslRef(\"DefaultSSLSettings\");\n+        server.setSSLDefault(defaultSettings);\n+\n+        SSL defaultSSL = new SSL();\n+        defaultSSL.setId(\"DefaultSSLSettings\");\n+        defaultSSL.setKeyStoreRef(\"defaultKeyStore\");\n+        server.addSSL(defaultSSL);\n+\n+        SSL sslCfg = new SSL();\n+        sslCfg.setId(\"LDAPSSLSettings\");\n+        sslCfg.setKeyStoreRef(\"LDAPKeyStore\");\n+        sslCfg.setTrustStoreRef(\"LDAPTrustStore\");\n+        server.addSSL(sslCfg);\n+\n+        updateConfigDynamically(libertyServer, server);\n+        Log.info(c, \"updateLibertyServer\", libertyServer.getServerConfigurationPath());\n+    }\n+\n+    /**\n+     * Hit the test servlet to see if getRealm works.\n+     * This verifies the various required bundles got installed and are working.\n+     */\n+    @Test\n+    public void getRealm() throws Exception {", "originalCommit": "e36d3bf1342ac7ecd44ec2ebfd9bc62f9dbe80e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a3eb7f2864a0df10708d43404c2cbe06ea61ecc0", "url": "https://github.com/OpenLiberty/open-liberty/commit/a3eb7f2864a0df10708d43404c2cbe06ea61ecc0", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-27T19:06:55Z", "type": "forcePushed"}, {"oid": "42223727da233e93791f9a6546a14f5b17069651", "url": "https://github.com/OpenLiberty/open-liberty/commit/42223727da233e93791f9a6546a14f5b17069651", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-02-27T19:12:44Z", "type": "forcePushed"}, {"oid": "7b29abbdd809870ee7d6dd5e09a34f42e1fb1362", "url": "https://github.com/OpenLiberty/open-liberty/commit/7b29abbdd809870ee7d6dd5e09a34f42e1fb1362", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-06T20:22:13Z", "type": "forcePushed"}, {"oid": "0ea65a0675492d2301db204a93e8b7c53d108553", "url": "https://github.com/OpenLiberty/open-liberty/commit/0ea65a0675492d2301db204a93e8b7c53d108553", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-06T21:59:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzM4MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389933380", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * example on how to use this.", "author": "jvanhill", "createdAt": "2020-03-09T20:10:19Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import com.ibm.websphere.simplicity.log.Log;\n+\n+/**\n+ * An in memory UnboundID LDAP server designed to contain the same data as the activeDirectory instance of the ApacheDS stand-alone LDAP Servers. See for URAPIs_ADLDAP_SSLTest an\n+ * example on how to use this.", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzQ4OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389933489", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * An in memory UnboundID LDAP server designed to contain the same data as the activeDirectory instance of the ApacheDS stand-alone LDAP Servers. See for URAPIs_ADLDAP_SSLTest an\n          \n          \n            \n             * An in memory UnboundID LDAP server designed to contain the same data as the Active Directory instance of the ApacheDS stand-alone LDAP Servers.", "author": "jvanhill", "createdAt": "2020-03-09T20:10:33Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import com.ibm.websphere.simplicity.log.Log;\n+\n+/**\n+ * An in memory UnboundID LDAP server designed to contain the same data as the activeDirectory instance of the ApacheDS stand-alone LDAP Servers. See for URAPIs_ADLDAP_SSLTest an", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzY5Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389933693", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This InMemoryADLDAPServer is currently using a null schema to host the data, this should be replaced in the future with a robust activeDirectory schema design\n          \n          \n            \n             * This InMemoryADLDAPServer is currently using a null schema to host the data, this could be replaced in the future with a robust activeDirectory schema design", "author": "jvanhill", "createdAt": "2020-03-09T20:10:55Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryADLDAPServer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.com.unboundid;\n+\n+import com.ibm.websphere.simplicity.log.Log;\n+\n+/**\n+ * An in memory UnboundID LDAP server designed to contain the same data as the activeDirectory instance of the ApacheDS stand-alone LDAP Servers. See for URAPIs_ADLDAP_SSLTest an\n+ * example on how to use this.\n+ *\n+ * This InMemoryADLDAPServer is currently using a null schema to host the data, this should be replaced in the future with a robust activeDirectory schema design", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNTU4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389935581", "bodyText": "I thought we talked about allowing both LDAP and LDAPS? We were going to add it to a collection and pass it into setListenerConfigs?\nWe would then probably have two ports and require changes to how we get the port (the method in this class).", "author": "jvanhill", "createdAt": "2020-03-09T20:14:36Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -47,37 +57,66 @@\n     private InMemoryDirectoryServerConfig config = null;\n     private InMemoryDirectoryServer ds = null;\n \n+    private static final String keystorePassword = \"LDAPpassword\";\n+    private String keystore;\n+\n     /**\n      * Creates a new instance of the in memory LDAP server. It initializes the directory\n      * service.\n      *\n      * @param bases The base entries to create for this in-memory LDAP server.\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean useWimSchema, boolean useSSLConfig, String... bases) throws Exception {\n \n         config = new InMemoryDirectoryServerConfig(bases);\n         config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n-        config.setListenerConfigs(\n-                                  InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n-                                                                          null, // Listen address. (null = listen on all interfaces)\n-                                                                          0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n \n+        if (useSSLConfig) {", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNjcyOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389936729", "bodyText": "This javadoc is wrong, even though you marked the conversation as resolved. Move this Javadoc to the other constructor.", "author": "jvanhill", "createdAt": "2020-03-09T20:16:43Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -47,37 +57,66 @@\n     private InMemoryDirectoryServerConfig config = null;\n     private InMemoryDirectoryServer ds = null;\n \n+    private static final String keystorePassword = \"LDAPpassword\";\n+    private String keystore;\n+\n     /**\n      * Creates a new instance of the in memory LDAP server. It initializes the directory", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNzA0MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389937041", "bodyText": "Missing Javadoc. Move the other constructor's javadoc down here.\nMove this in front or right after the other constructor.", "author": "jvanhill", "createdAt": "2020-03-09T20:17:24Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -47,37 +57,66 @@\n     private InMemoryDirectoryServerConfig config = null;\n     private InMemoryDirectoryServer ds = null;\n \n+    private static final String keystorePassword = \"LDAPpassword\";\n+    private String keystore;\n+\n     /**\n      * Creates a new instance of the in memory LDAP server. It initializes the directory\n      * service.\n      *\n      * @param bases The base entries to create for this in-memory LDAP server.\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean useWimSchema, boolean useSSLConfig, String... bases) throws Exception {\n \n         config = new InMemoryDirectoryServerConfig(bases);\n         config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n-        config.setListenerConfigs(\n-                                  InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n-                                                                          null, // Listen address. (null = listen on all interfaces)\n-                                                                          0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n \n+        if (useSSLConfig) {\n+            keystore = extractResourceToFile(\"/resources/keystore.jks\", \"keystore\", \".jks\").getAbsolutePath();\n+            final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePassword\n+                            .toCharArray(), \"JKS\", \"cert-alias\"), new TrustAllTrustManager());\n+            config.setListenerConfigs(InMemoryListenerConfig.createLDAPSConfig(\"LDAPS\", 0, serverSSLUtil.createSSLServerSocketFactory()));\n+        } else {\n+            config.setListenerConfigs(InMemoryListenerConfig.createLDAPConfig(\"LDAP\", null, 0, null));\n+        }\n+        Schema schema = null;\n+        if (useWimSchema) {\n+            InputStream in = getClass().getResourceAsStream(\"/resources/wimschema.ldif\");\n+            Schema wimschema = Schema.getSchema(in);\n+            schema = Schema.mergeSchemas(Schema.getDefaultStandardSchema(), wimschema);\n+        }\n+        config.setSchema(schema);\n+\n+        ds = new InMemoryDirectoryServer(config);\n+        ds.startListening();\n+    }\n+\n+    /**\n+     * Extract a resource from the JAR to a temporary file on the file system. The\n+     * file is marked for deletion on JVM exit.\n+     *\n+     * @param resource The resource from the JAR to extract.\n+     * @param prefix   Prefix for the temporary file.\n+     * @param suffix   Suffix for the temporary file.\n+     * @return The {@link File} instance.\n+     * @throws IOException if there was an issue extracting the file.\n+     */\n+    protected File extractResourceToFile(String resource, String prefix, String suffix) throws IOException {\n+        File tempfile = File.createTempFile(prefix, suffix);\n+        InputStream src = getClass().getResourceAsStream(resource);\n+        Files.copy(src, Paths.get(tempfile.getAbsolutePath()), StandardCopyOption.REPLACE_EXISTING);\n+        return tempfile;\n+    }\n+\n+    public InMemoryLDAPServer(String... bases) throws Exception {", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNzc0MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389937741", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *", "author": "jvanhill", "createdAt": "2020-03-09T20:18:47Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -188,4 +236,32 @@ public void silentDelete(String dn) {\n             // if the user or group doesn't exist, that's fine.\n         }\n     }\n+\n+    /**\n+     * Attempts to establish a client connection to the server.\n+     *\n+     * @param options The connection options to use when creating the connection. It may be null if a default set of options should be used.\n+     * @returns The client connection that has been established.\n+     * @throws LDAPException - If a problem is encountered while attempting to create the connection.\n+     */\n+    public LDAPConnection getConnection(String listenerName) throws LDAPException {\n+        return ds.getConnection(listenerName);\n+    }\n+\n+    /*\n+     * Reads entries from the specified LDIF file and adds them to the server, optionally clearing any existing entries before beginning to add the new entries. If an error is\n+     * encountered while adding entries from LDIF then the server will remain populated with the data it held before the import attempt (even if the clear is given with a value of\n+     * true). This method may be used regardless of whether the server is listening for client connections.\n+     *\n+     * @param clear Indicates whether to remove all existing entries prior to adding entries read from LDIF.\n+     *", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNzgxNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389937815", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *", "author": "jvanhill", "createdAt": "2020-03-09T20:18:57Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -188,4 +236,32 @@ public void silentDelete(String dn) {\n             // if the user or group doesn't exist, that's fine.\n         }\n     }\n+\n+    /**\n+     * Attempts to establish a client connection to the server.\n+     *\n+     * @param options The connection options to use when creating the connection. It may be null if a default set of options should be used.\n+     * @returns The client connection that has been established.\n+     * @throws LDAPException - If a problem is encountered while attempting to create the connection.\n+     */\n+    public LDAPConnection getConnection(String listenerName) throws LDAPException {\n+        return ds.getConnection(listenerName);\n+    }\n+\n+    /*\n+     * Reads entries from the specified LDIF file and adds them to the server, optionally clearing any existing entries before beginning to add the new entries. If an error is\n+     * encountered while adding entries from LDIF then the server will remain populated with the data it held before the import attempt (even if the clear is given with a value of\n+     * true). This method may be used regardless of whether the server is listening for client connections.\n+     *\n+     * @param clear Indicates whether to remove all existing entries prior to adding entries read from LDIF.\n+     *\n+     * @param path The path to the LDIF file from which the entries should be read. It must not be null.\n+     *", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNzkxNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389937917", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *", "author": "jvanhill", "createdAt": "2020-03-09T20:19:09Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -188,4 +236,32 @@ public void silentDelete(String dn) {\n             // if the user or group doesn't exist, that's fine.\n         }\n     }\n+\n+    /**\n+     * Attempts to establish a client connection to the server.\n+     *\n+     * @param options The connection options to use when creating the connection. It may be null if a default set of options should be used.\n+     * @returns The client connection that has been established.\n+     * @throws LDAPException - If a problem is encountered while attempting to create the connection.\n+     */\n+    public LDAPConnection getConnection(String listenerName) throws LDAPException {\n+        return ds.getConnection(listenerName);\n+    }\n+\n+    /*\n+     * Reads entries from the specified LDIF file and adds them to the server, optionally clearing any existing entries before beginning to add the new entries. If an error is\n+     * encountered while adding entries from LDIF then the server will remain populated with the data it held before the import attempt (even if the clear is given with a value of\n+     * true). This method may be used regardless of whether the server is listening for client connections.\n+     *\n+     * @param clear Indicates whether to remove all existing entries prior to adding entries read from LDIF.\n+     *\n+     * @param path The path to the LDIF file from which the entries should be read. It must not be null.\n+     *\n+     * @returns The number of entries read from LDIF and added to the server.\n+     *", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzODcyNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389938727", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LdapRegistry ldap = serverConfig.getLdapRegistries().remove(0);\n          \n          \n            \n                    LdapRegistry ldap = serverConfig.getLdapRegistries().get(0);", "author": "jvanhill", "createdAt": "2020-03-09T20:20:49Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +45,105 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLdapServer();\n+        setupLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+            libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+        }\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+\n+        /*\n+         * Update LDAP configuration with In-Memory Server\n+         */\n+        ServerConfiguration serverConfig = libertyServer.getServerConfiguration();\n+        LdapRegistry ldap = serverConfig.getLdapRegistries().remove(0);", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzODgwNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389938804", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    serverConfig.getLdapRegistries().add(ldap);", "author": "jvanhill", "createdAt": "2020-03-09T20:20:58Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +45,105 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLdapServer();\n+        setupLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+            libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+        }\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+\n+        /*\n+         * Update LDAP configuration with In-Memory Server\n+         */\n+        ServerConfiguration serverConfig = libertyServer.getServerConfiguration();\n+        LdapRegistry ldap = serverConfig.getLdapRegistries().remove(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+        ldap.setBaseDN(BASE_DN);\n+        ldap.setBindDN(InMemoryADLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryADLDAPServer.getBindPassword());\n+        serverConfig.getLdapRegistries().add(ldap);", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzODk5NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389938994", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    libertyServer.getServerConfiguration();", "author": "jvanhill", "createdAt": "2020-03-09T20:21:23Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +45,105 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n-        LDAPUtils.addLDAPVariables(server);\n+    public static void setupClass() throws Exception {\n+        setupLdapServer();\n+        setupLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (libertyServer != null) {\n+                libertyServer.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+            libertyServer.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+        }\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n+        LDAPUtils.addLDAPVariables(libertyServer);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n-        server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n-        server.addInstalledAppForValidation(\"userRegistry\");\n-        server.startServer(c.getName() + \".log\");\n+        libertyServer.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n+        libertyServer.addInstalledAppForValidation(\"userRegistry\");\n+\n+        /*\n+         * Update LDAP configuration with In-Memory Server\n+         */\n+        ServerConfiguration serverConfig = libertyServer.getServerConfiguration();\n+        LdapRegistry ldap = serverConfig.getLdapRegistries().remove(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+        ldap.setBaseDN(BASE_DN);\n+        ldap.setBindDN(InMemoryADLDAPServer.getBindDN());\n+        ldap.setBindPassword(InMemoryADLDAPServer.getBindPassword());\n+        serverConfig.getLdapRegistries().add(ldap);\n+        libertyServer.updateServerConfiguration(serverConfig);\n+        /*\n+         * Make sure the application has come up before proceeding\n+         */\n+        libertyServer.startServer(c.getName() + \".log\");\n \n-        //Make sure the application has come up before proceeding\n         assertNotNull(\"Application userRegistry does not appear to have started.\",\n-                      server.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n+                      libertyServer.waitForStringInLog(\"CWWKZ0001I:.*userRegistry\"));\n         assertNotNull(\"Security service did not report it was ready\",\n-                      server.waitForStringInLog(\"CWWKS0008I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKS0008I\"));\n         assertNotNull(\"Server did not came up\",\n-                      server.waitForStringInLog(\"CWWKF0011I\"));\n+                      libertyServer.waitForStringInLog(\"CWWKF0011I\"));\n \n         Log.info(c, \"setUp\", \"Creating servlet connection the server\");\n-        servlet = new UserRegistryServletConnection(server.getHostname(), server.getHttpDefaultPort());\n+        servlet = new UserRegistryServletConnection(libertyServer.getHostname(), libertyServer.getHttpDefaultPort());\n \n         if (servlet.getRealm() == null) {\n             Thread.sleep(5000);\n             servlet.getRealm();\n         }\n+\n+        libertyServer.getServerConfiguration();", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzOTQ2Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389939462", "bodyText": "Why is this moved? Move it back down where it was.", "author": "jvanhill", "createdAt": "2020-03-09T20:22:19Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -155,7 +209,20 @@ public void getUsersForGroupWithInvalidGroup() throws Exception {\n     @Test\n     public void getRealm() throws Exception {\n         Log.info(c, \"getRealm\", \"Checking expected realm\");\n-        assertEquals(\"ADSSLRealm\", servlet.getRealm());\n+        assertEquals(\"SampleLdapADRealm\", servlet.getRealm());\n+    }\n+\n+    /**\n+     * Hit the test servlet to see if getUsers works when passed in a valid user pattern\n+     * and a limit of 2; should only expect to find one entry\n+     * This verifies the various required bundles got installed and are working.\n+     */\n+    @Test\n+    public void getUsers() throws Exception {", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzOTc0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r389939748", "bodyText": "Can we name this back to server? This rename made a bunch of changes that are just churn.", "author": "jvanhill", "createdAt": "2020-03-09T20:22:56Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -42,54 +45,105 @@\n @RunWith(FATRunner.class)\n @Mode(TestMode.FULL)\n public class URAPIs_ADLDAP_SSLTest {\n-    private static LibertyServer server = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");\n+    private static LibertyServer libertyServer = LibertyServerFactory.getLibertyServer(\"com.ibm.ws.security.wim.adapter.ldap.fat.ad.ssl\");", "originalCommit": "0ea65a0675492d2301db204a93e8b7c53d108553", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2dfe18e743ea83ccdda614e55b0fb9132a64ee8b", "url": "https://github.com/OpenLiberty/open-liberty/commit/2dfe18e743ea83ccdda614e55b0fb9132a64ee8b", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-11T14:16:55Z", "type": "forcePushed"}, {"oid": "74f2b22418b8c450e996e9d28d87d88451e82829", "url": "https://github.com/OpenLiberty/open-liberty/commit/74f2b22418b8c450e996e9d28d87d88451e82829", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-11T14:24:00Z", "type": "forcePushed"}, {"oid": "29169ded73a19b5e7439eafd1705b1e89190c42b", "url": "https://github.com/OpenLiberty/open-liberty/commit/29169ded73a19b5e7439eafd1705b1e89190c42b", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-11T16:30:57Z", "type": "forcePushed"}, {"oid": "b95b622c3a96e3263b9ee9f4fc461478eec47ed6", "url": "https://github.com/OpenLiberty/open-liberty/commit/b95b622c3a96e3263b9ee9f4fc461478eec47ed6", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-12T19:18:58Z", "type": "forcePushed"}, {"oid": "216dc056eca7c2e8c173942af3bdf0eda4bb1ccb", "url": "https://github.com/OpenLiberty/open-liberty/commit/216dc056eca7c2e8c173942af3bdf0eda4bb1ccb", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-12T19:23:38Z", "type": "forcePushed"}, {"oid": "7e6a3516abeda1aeadbd823ecf2588148b70f8c8", "url": "https://github.com/OpenLiberty/open-liberty/commit/7e6a3516abeda1aeadbd823ecf2588148b70f8c8", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-12T19:25:33Z", "type": "forcePushed"}, {"oid": "ec3c694ecb60cbce26897135b33872f44b0a63e0", "url": "https://github.com/OpenLiberty/open-liberty/commit/ec3c694ecb60cbce26897135b33872f44b0a63e0", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-12T19:37:14Z", "type": "forcePushed"}, {"oid": "b30803610993ec8cb72af2c81c46e570dfac3a25", "url": "https://github.com/OpenLiberty/open-liberty/commit/b30803610993ec8cb72af2c81c46e570dfac3a25", "message": "Switched Active Directory test from using emebedded apache directory to unboundid", "committedDate": "2020-03-12T19:56:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNDg0Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r392414843", "bodyText": "I am wondering if we really need to pass in the base entry since I assume we are always loading the AD.ldiff file. The base entry probably always needs to be the same.", "author": "jvanhill", "createdAt": "2020-03-13T18:57:57Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -82,14 +134,13 @@ public static void setUp() throws Exception {\n         }\n     }\n \n-    @AfterClass\n-    public static void tearDown() throws Exception {\n-        Log.info(c, \"tearDown\", \"Stopping the server...\");\n-        try {\n-            server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n-        } finally {\n-            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n-        }\n+    /**\n+     * Configure the embedded LDAP server.\n+     *\n+     * @throws Exception If the server failed to start for some reason.\n+     */\n+    private static void setupLdapServer() throws Exception {\n+        ds = new InMemoryADLDAPServer(BASE_DN);", "originalCommit": "b30803610993ec8cb72af2c81c46e570dfac3a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNTA1OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r392415058", "bodyText": "No reason to leave a commented out line.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //        ldap.setBaseDN(BASE_DN);", "author": "jvanhill", "createdAt": "2020-03-13T18:58:22Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -46,26 +49,75 @@\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";\n \n     /**\n-     * Updates the sample, which is expected to be at the hard-coded path.\n-     * If this test is failing, check this path is correct.\n+     * Setup the test case.\n+     *\n+     * @throws Exception If the setup failed for some reason.\n      */\n     @BeforeClass\n-    public static void setUp() throws Exception {\n-        // Add LDAP variables to bootstrap properties file\n+    public static void setupClass() throws Exception {\n+        setupLdapServer();\n+        setupLibertyServer();\n+    }\n+\n+    /**\n+     * Tear down the test.\n+     */\n+    @AfterClass\n+    public static void teardownClass() throws Exception {\n+        try {\n+            if (server != null) {\n+                server.stopServer(\"CWIML4529E\", \"CWIML4537E\", \"CWPKI0041W\");\n+            }\n+        } finally {\n+            try {\n+                if (ds != null) {\n+                    ds.shutDown(true);\n+                }\n+            } catch (Exception e) {\n+                Log.error(c, \"teardown\", e, \"LDAP server threw error while shutting down. \" + e.getMessage());\n+            }\n+            server.deleteFileFromLibertyInstallRoot(\"lib/features/internalfeatures/securitylibertyinternals-1.0.mf\");\n+        }\n+    }\n+\n+    /**\n+     * Setup the Liberty server. This server will start with very basic configuration. The tests\n+     * will configure the server dynamically.\n+     *\n+     * @throws Exception If there was an issue setting up the Liberty server.\n+     */\n+    private static void setupLibertyServer() throws Exception {\n+        /*\n+         * Add LDAP variables to bootstrap properties file\n+         */\n         LDAPUtils.addLDAPVariables(server);\n         Log.info(c, \"setUp\", \"Starting the server... (will wait for userRegistry servlet to start)\");\n         server.copyFileToLibertyInstallRoot(\"lib/features\", \"internalfeatures/securitylibertyinternals-1.0.mf\");\n         server.addInstalledAppForValidation(\"userRegistry\");\n+\n+        /*\n+         * Update LDAP configuration with In-Memory Server\n+         */\n+        ServerConfiguration serverConfig = server.getServerConfiguration();\n+        LdapRegistry ldap = serverConfig.getLdapRegistries().get(0);\n+        ldap.setHost(\"localhost\");\n+        ldap.setPort(String.valueOf(ds.getListenPort()));\n+//        ldap.setBaseDN(BASE_DN);", "originalCommit": "b30803610993ec8cb72af2c81c46e570dfac3a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNTU1MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r392415550", "bodyText": "Make this a public static final String BASE_ENTRY ... in the new LDAP class.", "author": "jvanhill", "createdAt": "2020-03-13T18:59:32Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -46,26 +49,75 @@\n     private static final Class<?> c = URAPIs_ADLDAP_SSLTest.class;\n     private static UserRegistryServletConnection servlet;\n \n-    //private final LeakedPasswordChecker passwordChecker = new LeakedPasswordChecker(server);\n-\n     /** Test rule for testing for expected exceptions. */\n     @Rule\n     public ExpectedException expectedException = ExpectedException.none();\n+    private static InMemoryADLDAPServer ds;\n+    private static final String BASE_DN = \"DC=SECFVT2,DC=AUSTIN,DC=IBM,DC=COM\";", "originalCommit": "b30803610993ec8cb72af2c81c46e570dfac3a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNTY2NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r392415665", "bodyText": "Update copyright above.", "author": "jvanhill", "createdAt": "2020-03-13T18:59:48Z", "path": "dev/com.ibm.ws.security.wim.adapter.ldap_fat/fat/src/com/ibm/ws/security/wim/adapter/ldap/fat/URAPIs_ADLDAP_SSLTest.java", "diffHunk": "@@ -27,7 +27,10 @@\n import org.junit.rules.ExpectedException;\n import org.junit.runner.RunWith;\n \n+import com.ibm.websphere.simplicity.config.ServerConfiguration;", "originalCommit": "b30803610993ec8cb72af2c81c46e570dfac3a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxNjgyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10825#discussion_r392416822", "bodyText": "Can we not listen on both LDAP and LDAPS?\nHow would this effect getListenAddress()?", "author": "jvanhill", "createdAt": "2020-03-13T19:02:29Z", "path": "dev/com.ibm.ws.com.unboundid/src/com/ibm/ws/com/unboundid/InMemoryLDAPServer.java", "diffHunk": "@@ -47,37 +58,79 @@\n     private InMemoryDirectoryServerConfig config = null;\n     private InMemoryDirectoryServer ds = null;\n \n+    private static final String keystorePassword = \"LDAPpassword\";\n+    private String keystore;\n+\n     /**\n      * Creates a new instance of the in memory LDAP server. It initializes the directory\n      * service.\n      *\n-     * @param bases The base entries to create for this in-memory LDAP server.\n+     * @param useWimSchema      Asking the user if they want to use the default WIM schema\n+     * @param bases             The base entries to create for this in-memory LDAP servers\n+     * @param useSecureListener Use the LDAPS listener\n      * @throws Exception If something went wrong\n      */\n-    public InMemoryLDAPServer(String... bases) throws Exception {\n+    public InMemoryLDAPServer(boolean useWimSchema, boolean useSecureListener, String... bases) throws Exception {\n \n         config = new InMemoryDirectoryServerConfig(bases);\n         config.addAdditionalBindCredentials(getBindDN(), getBindPassword());\n-        config.setListenerConfigs(\n-                                  InMemoryListenerConfig.createLDAPConfig(\"LDAP\", // Listener name\n-                                                                          null, // Listen address. (null = listen on all interfaces)\n-                                                                          0, // Listen port (0 = automatically choose an available port)\n-                                                                          null) // StartTLS factory\n-        ); // Client factory\n \n+        keystore = extractResourceToFile(\"/resources/keystore.jks\", \"keystore\", \".jks\").getAbsolutePath();\n+        final SSLUtil serverSSLUtil = new SSLUtil(new KeyStoreKeyManager(keystore, keystorePassword\n+                        .toCharArray(), \"JKS\", \"cert-alias\"), new TrustAllTrustManager());\n+        ArrayList<InMemoryListenerConfig> configs = new ArrayList<InMemoryListenerConfig>();\n+        InMemoryListenerConfig secure = InMemoryListenerConfig.createLDAPSConfig(\"LDAPS\", 0, serverSSLUtil.createSSLServerSocketFactory());\n+        configs.add(secure);\n+        InMemoryListenerConfig insecure = InMemoryListenerConfig.createLDAPConfig(\"LDAP\", null, 0, null);\n+        configs.add(insecure);\n+        config.setListenerConfigs(configs);\n+        Schema schema = null;\n+        if (useWimSchema) {\n+            InputStream in = getClass().getResourceAsStream(\"/resources/wimschema.ldif\");\n+            Schema wimschema = Schema.getSchema(in);\n+            schema = Schema.mergeSchemas(Schema.getDefaultStandardSchema(), wimschema);\n+        }\n+        config.setSchema(schema);\n+\n+        ds = new InMemoryDirectoryServer(config);\n+        if (useSecureListener)", "originalCommit": "b30803610993ec8cb72af2c81c46e570dfac3a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "308b6387df08a7c0e828efb600ce689ec7fdbb04", "url": "https://github.com/OpenLiberty/open-liberty/commit/308b6387df08a7c0e828efb600ce689ec7fdbb04", "message": "Switched Active Directory test from using embedded apache directory to unboundid", "committedDate": "2020-03-15T21:40:15Z", "type": "forcePushed"}, {"oid": "d4d5d5b2100eaa89c2ca12c8fb227725321d9143", "url": "https://github.com/OpenLiberty/open-liberty/commit/d4d5d5b2100eaa89c2ca12c8fb227725321d9143", "message": "Switched Active Directory test from using embedded apache directory to unboundid", "committedDate": "2020-03-16T15:44:48Z", "type": "forcePushed"}, {"oid": "9e44e8c28a542509cef86e11eae33cb4856f1507", "url": "https://github.com/OpenLiberty/open-liberty/commit/9e44e8c28a542509cef86e11eae33cb4856f1507", "message": "Switched Active Directory test from using embedded apache directory to unboundid", "committedDate": "2020-03-17T14:38:17Z", "type": "commit"}, {"oid": "9e44e8c28a542509cef86e11eae33cb4856f1507", "url": "https://github.com/OpenLiberty/open-liberty/commit/9e44e8c28a542509cef86e11eae33cb4856f1507", "message": "Switched Active Directory test from using embedded apache directory to unboundid", "committedDate": "2020-03-17T14:38:17Z", "type": "forcePushed"}]}