{"pr_number": 14535, "pr_title": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "pr_createdAt": "2020-10-16T19:29:09Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/14535", "timeline": [{"oid": "2523a436cab9bf686112e792f80990d4c55e8b23", "url": "https://github.com/OpenLiberty/open-liberty/commit/2523a436cab9bf686112e792f80990d4c55e8b23", "message": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "committedDate": "2020-10-22T13:37:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzNDkzNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14535#discussion_r510234934", "bodyText": "Doesn't the usual server transformation steps handle this file?  Or is it not transformed because it is not under the 'servers' folder?  Also, there are some helper methods, either on LibertyServer or on ShrinkWrapHelper which may do something similar.", "author": "tbitonti", "createdAt": "2020-10-22T15:01:52Z", "path": "dev/com.ibm.ws.messaging.open_jms20_fat/fat/src/com/ibm/ws/messaging/JMS20/fat/SharedSubscription/SharedSubscriptionWithMsgSelTest_129623.java", "diffHunk": "@@ -85,27 +79,33 @@ private static String getLocalAddress() {\n     }\n \n     private static boolean runInServlet(String test) throws IOException {\n-        return TestUtils.runInServlet( clientHostName, clientPort, subscriptionContextRoot, test, getLocalAddress() );\n+        return TestUtils.runInServlet(clientHostName, clientPort, subscriptionContextRoot, test, getLocalAddress());\n         // throws IOException\n     }\n \n-    //\n-\n     @BeforeClass\n     public static void testConfigFileChange() throws Exception {\n         engineServer.copyFileToLibertyInstallRoot(\n-            \"lib/features\",\n-            \"features/testjmsinternals-1.0.mf\");\n+                                                  \"lib/features\",\n+                                                  \"features/testjmsinternals-1.0.mf\");\n         engineServer.setServerConfigurationFile(\"SharedSubscriptionEngine.xml\");\n \n         clientServer.copyFileToLibertyInstallRoot(\n-            \"lib/features\",\n-            \"features/testjmsinternals-1.0.mf\");\n+                                                  \"lib/features\",\n+                                                  \"features/testjmsinternals-1.0.mf\");\n         TestUtils.addDropinsWebApp(clientServer, subscriptionAppName, subscriptionPackages);\n-        clientServer.setServerConfigurationFile(\"SharedSubscriptionDurClient.xml\");\n+        final String clientXml = \"SharedSubscriptionDurClient.xml\";\n+        if (JakartaEE9Action.isActive()) {\n+            Path clientXmlFile = Paths.get(\n+                                           \"lib/LibertyFATTestFiles\",\n+                                           clientXml);\n+            JakartaEE9Action.transformApp(clientXmlFile);\n+            Log.info(c, \"setUp\", \"Transformed server \" + clientXmlFile);\n+        }\n+        clientServer.setServerConfigurationFile(clientXml);", "originalCommit": "2523a436cab9bf686112e792f80990d4c55e8b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4MTE3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14535#discussion_r510281170", "bodyText": "Simplicity does not invoke the transformer on server.xml files, at least not yet.  The most simple solution is to invoke the transformer directly on the server configuration file and ensure the file name and match-replace properties are in the transformer property set.  That's what I've done here.  @KyleAure Simplicity can be modified to transform server and client configuration files, and there a couple ways this can be done.  Simplicity could scan the publish/ and publish/server/ directories for xml files and transform all that match file names declared in a repeat action builder method, where the transformer is called with arg1=properties file containing the file name(s) and arg2=properties file containing match-replace values for all config metatypes.  Not all server configuration files need transformation.  Alternatively, Simplicity could directly replace matching strings in the ServerConfiguration instance that is created when replacing features.  When the instance is streamed to file all necessary transformation has been done -- i.e., there's no need to invoke the transformer, which is expensive.", "author": "dazavala", "createdAt": "2020-10-22T16:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzNDkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5MTQ4OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14535#discussion_r510291489", "bodyText": "Thanks for the heads up!  I have a PR that does option 1 (calls the transformer on server.xml) here: #14397  but as you mentioned this is an expensive operation to do for each server.xml.  However, it does offer us more control in what we are replacing since not ever instance of javax should be replaced (i.e. javax.sql.XADataSource)\nDirectly replacing strings could work, but the feature replacement action knows it needs to replace config under FeatureManager > Features.", "author": "KyleAure", "createdAt": "2020-10-22T16:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzNDkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMwMzA1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/14535#discussion_r510303054", "bodyText": "Yes, that's the idea.  Augment the ee9 repeat action to replace strings in config elements other than <FeatureManager> according to, say a new builder method, before the ServerConfiguration is streamed to file.  Any solution will have full control over what is transformed.  Even if the repeat action is modified to perform separate operations to replace features and other config, the two operations are still much less costly than invoking the transformer.  Something to consider.  What I like about using the transformer is the consistency of using it for both config metatype metadata and server/client configuration metadata.  Thanks!", "author": "dazavala", "createdAt": "2020-10-22T16:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIzNDkzNA=="}], "type": "inlineReview"}, {"oid": "edb20b5aa6dd16ffc17ac21af1acd325e80337ff", "url": "https://github.com/OpenLiberty/open-liberty/commit/edb20b5aa6dd16ffc17ac21af1acd325e80337ff", "message": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "committedDate": "2020-10-22T18:08:42Z", "type": "forcePushed"}, {"oid": "607f89206b0b907ebc5cb4f11a9658df4b043b2c", "url": "https://github.com/OpenLiberty/open-liberty/commit/607f89206b0b907ebc5cb4f11a9658df4b043b2c", "message": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "committedDate": "2020-10-22T18:25:48Z", "type": "forcePushed"}, {"oid": "68010633ed059fc55a465420d1b2e67b7bc0a0c6", "url": "https://github.com/OpenLiberty/open-liberty/commit/68010633ed059fc55a465420d1b2e67b7bc0a0c6", "message": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "committedDate": "2020-10-23T04:41:53Z", "type": "commit"}, {"oid": "68010633ed059fc55a465420d1b2e67b7bc0a0c6", "url": "https://github.com/OpenLiberty/open-liberty/commit/68010633ed059fc55a465420d1b2e67b7bc0a0c6", "message": "11851 Fix Open JMS20 FAT MessageEndpoint Tests", "committedDate": "2020-10-23T04:41:53Z", "type": "forcePushed"}]}