{"pr_number": 11592, "pr_title": "Fix prometheus/open-metrics format for multiple metrics with same name", "pr_createdAt": "2020-04-01T22:00:41Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11592", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1ODkxNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11592#discussion_r402358916", "bodyText": "Will this message be printed every time /metrics is served?  i.e. will it be printed a lot of times in the log?  Same question for all other Tr.event().", "author": "fmhwong", "createdAt": "2020-04-02T14:30:47Z", "path": "dev/com.ibm.ws.microprofile.metrics.2.0/src/com/ibm/ws/microprofile/metrics/helper/PrometheusBuilder.java", "diffHunk": "@@ -36,30 +37,43 @@\n     private static final String QUANTILE = \"quantile\";\n \n     @FFDCIgnore({ IllegalStateException.class })\n-    public static void buildGauge(StringBuilder builder, String name, Gauge<?> gauge, String description, Double conversionFactor, String tags, String appendUnit) {\n-        // Skip non number values\n-        Number gaugeValNumber = null;\n-        Object gaugeValue = null;\n-        try {\n-            gaugeValue = gauge.getValue();\n-        } catch (IllegalStateException e) {\n-            // The forwarding gauge is likely unloaded. A warning has already been emitted\n-            return;\n-        }\n-        if (!Number.class.isInstance(gaugeValue)) {\n-            Tr.event(tc, \"Skipping Prometheus output for Gauge: \" + name + \" of type \" + gauge.getValue().getClass());\n-            return;\n-        }\n-        gaugeValNumber = (Number) gaugeValue;\n-        if (!(Double.isNaN(conversionFactor))) {\n-            gaugeValNumber = gaugeValNumber.doubleValue() * conversionFactor;\n-        }\n+\n+    public static void buildGauge(StringBuilder builder, String name, String description, Map<MetricID, Metric> currentMetricMap, Double conversionFactor,\n+                                  String appendUnit) {\n         getPromTypeLine(builder, name, \"gauge\", appendUnit);\n         getPromHelpLine(builder, name, description, appendUnit);\n-        getPromValueLine(builder, name, gaugeValNumber, tags, appendUnit);\n+\n+        for (MetricID mid : currentMetricMap.keySet()) {\n+            // Skip non number values\n+            Number gaugeValNumber = null;\n+            Object gaugeValue = null;\n+            try {\n+                gaugeValue = ((Gauge) currentMetricMap.get(mid)).getValue();\n+            } catch (IllegalStateException e) {\n+                // The forwarding gauge is likely unloaded. A warning has already been emitted\n+                return;\n+            }\n+            if (!Number.class.isInstance(gaugeValue)) {\n+                Tr.event(tc, \"Skipping Prometheus output for Gauge: \" + name + \" of type \" + ((Gauge) currentMetricMap.get(mid)).getValue().getClass());", "originalCommit": "5862e29997b2cb93a04c3ee482ced042f9a2a3f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxMTU1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11592#discussion_r402411553", "bodyText": "Yes they would be emitted every time, but only if they did something wrong! Or if something went horribly wrong. For example this event is emitted if the gauge doesn't track a Number value. The other events emitted in PrometheusMetricWriter will happen if the metadata's type isn't correctly set.", "author": "Channyboy", "createdAt": "2020-04-02T15:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1ODkxNg=="}], "type": "inlineReview"}, {"oid": "63b2bc252f3cf829ae98ee9bd37bdcd0f9f31b85", "url": "https://github.com/OpenLiberty/open-liberty/commit/63b2bc252f3cf829ae98ee9bd37bdcd0f9f31b85", "message": "Fix prometheus/open-metrics format so that only there is only one TYPE and HELP line for multiple metrics of the same name", "committedDate": "2020-04-03T02:43:47Z", "type": "commit"}, {"oid": "9fb4c031c343482ed8b8f1fa77409055a2b3767a", "url": "https://github.com/OpenLiberty/open-liberty/commit/9fb4c031c343482ed8b8f1fa77409055a2b3767a", "message": "Limit amount of trace emissions if there is an invalid metric/metadata and gauge value", "committedDate": "2020-04-03T02:43:47Z", "type": "commit"}, {"oid": "9fb4c031c343482ed8b8f1fa77409055a2b3767a", "url": "https://github.com/OpenLiberty/open-liberty/commit/9fb4c031c343482ed8b8f1fa77409055a2b3767a", "message": "Limit amount of trace emissions if there is an invalid metric/metadata and gauge value", "committedDate": "2020-04-03T02:43:47Z", "type": "forcePushed"}, {"oid": "888d2286c37bf1a3261168a2fddea69505f8093a", "url": "https://github.com/OpenLiberty/open-liberty/commit/888d2286c37bf1a3261168a2fddea69505f8093a", "message": "Use MetricID for identifying improper Gauge instead of the name", "committedDate": "2020-04-06T16:18:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NTEwMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11592#discussion_r405765103", "bodyText": "Update copyright year to 2020", "author": "fmhwong", "createdAt": "2020-04-08T19:34:43Z", "path": "dev/com.ibm.ws.microprofile.metrics.2.0/src/com/ibm/ws/microprofile/metrics/helper/PrometheusBuilder.java", "diffHunk": "@@ -10,16 +10,19 @@\n  *******************************************************************************/\n package com.ibm.ws.microprofile.metrics.helper;", "originalCommit": "888d2286c37bf1a3261168a2fddea69505f8093a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "785e7bbadd3d6cef04564b66a3a6f61fb9f7feaf", "url": "https://github.com/OpenLiberty/open-liberty/commit/785e7bbadd3d6cef04564b66a3a6f61fb9f7feaf", "message": "copyright", "committedDate": "2020-04-14T15:56:03Z", "type": "commit"}]}