{"pr_number": 13299, "pr_title": "Chunk Error Fix", "pr_createdAt": "2020-08-04T14:57:39Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13299", "timeline": [{"oid": "ba4167573fbb4c91d4eb7808bd936a867095e194", "url": "https://github.com/OpenLiberty/open-liberty/commit/ba4167573fbb4c91d4eb7808bd936a867095e194", "message": "Reworked", "committedDate": "2020-08-04T14:57:13Z", "type": "commit"}, {"oid": "a7b9bf601d1018d9ffe568c0b96acd794376f686", "url": "https://github.com/OpenLiberty/open-liberty/commit/a7b9bf601d1018d9ffe568c0b96acd794376f686", "message": "Trace changes", "committedDate": "2020-08-04T19:25:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3OTUzOA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r466379538", "bodyText": "Is the  localHisc instanceof HttpInboundServiceContextImpl   check needed? It was checked above before setting localHisc", "author": "tspewak", "createdAt": "2020-08-06T12:35:02Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/channel/internal/HttpServiceContextImpl.java", "diffHunk": "@@ -2853,7 +2854,19 @@ final protected void sendFullOutgoing(WsByteBuffer[] wsbb, HttpBaseMessageImpl m\n                 }\n \n             } else if (msg.isChunkedEncodingSet()) {\n-                createEndOfBodyChunk();\n+                HttpInboundServiceContextImpl localHisc = null;\n+                if (this instanceof HttpInboundServiceContextImpl) {\n+                    localHisc = (HttpInboundServiceContextImpl) this;\n+                }\n+                if (localHisc != null && localHisc instanceof HttpInboundServiceContextImpl", "originalCommit": "a7b9bf601d1018d9ffe568c0b96acd794376f686", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MDI0Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r466380242", "bodyText": "Is && hisc instanceof HttpInboundServiceContextImpl  needed?  it was checked above before setting hisc", "author": "tspewak", "createdAt": "2020-08-06T12:36:24Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/channel/internal/HttpServiceContextImpl.java", "diffHunk": "@@ -2892,8 +2905,18 @@ final protected VirtualConnection sendFullOutgoing(WsByteBuffer[] wsbb, HttpBase\n             if (this instanceof HttpInboundServiceContextImpl) {\n                 hisc = (HttpInboundServiceContextImpl) this;\n             }\n-            if (hisc != null && !(hisc.getLink() instanceof H2HttpInboundLinkWrap)) {\n+            if (hisc != null && hisc instanceof HttpInboundServiceContextImpl) {", "originalCommit": "a7b9bf601d1018d9ffe568c0b96acd794376f686", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MTg2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r466381863", "bodyText": "Could extendedConnection ever be null?", "author": "tspewak", "createdAt": "2020-08-06T12:39:33Z", "path": "dev/com.ibm.ws.webcontainer/src/com/ibm/ws/webcontainer/webapp/WebApp.java", "diffHunk": "@@ -4095,8 +4099,21 @@ public void sendError(HttpServletRequest req, HttpServletResponse res, ServletEr\n         WebContainerRequestState reqState = WebContainerRequestState.getInstance(true);   //PI80786\n \n         // PK82794\n-        if (WCCustomProperties.SUPPRESS_LAST_ZERO_BYTE_PACKAGE)\n-            reqState.setAttribute(\"com.ibm.ws.webcontainer.suppresslastzerobytepackage\", \"true\");\n+        if (WCCustomProperties.SUPPRESS_LAST_ZERO_BYTE_PACKAGE) {\n+           // reqState.setAttribute(\"com.ibm.ws.webcontainer.suppresslastzerobytepackage\", \"true\");\n+            if (req instanceof SRTServletRequest) {\n+                SRTServletRequest srtReq = (SRTServletRequest) req;\n+                IRequestExtended iReq = (IRequestExtended)srtReq.getIRequest();\n+                if (iReq != null) {\n+                    HttpInboundConnection httpInboundConnection = iReq.getHttpInboundConnection();\n+                    HttpInboundConnectionExtended extendedConnection= (HttpInboundConnectionExtended) httpInboundConnection;\n+                    HttpDispatcherLink dispatcherLink=(HttpDispatcherLink) extendedConnection.getHttpDispatcherLink();", "originalCommit": "a7b9bf601d1018d9ffe568c0b96acd794376f686", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d3e44a6fe4f245aecb6677fef567ab61b97e168", "url": "https://github.com/OpenLiberty/open-liberty/commit/3d3e44a6fe4f245aecb6677fef567ab61b97e168", "message": "ReviewChanges", "committedDate": "2020-08-14T15:50:14Z", "type": "commit"}, {"oid": "7ed4e078d8d81810d89bcd69527ae7e7eed2f059", "url": "https://github.com/OpenLiberty/open-liberty/commit/7ed4e078d8d81810d89bcd69527ae7e7eed2f059", "message": "More changes for code review", "committedDate": "2020-08-17T13:29:27Z", "type": "commit"}, {"oid": "367d64d7268e357d26782d0a70c9d97a7c2f3ae1", "url": "https://github.com/OpenLiberty/open-liberty/commit/367d64d7268e357d26782d0a70c9d97a7c2f3ae1", "message": "Merge branch 'integration' into ChunkErrorFix", "committedDate": "2020-08-17T13:30:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwMDMwMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r471500303", "bodyText": "Description ?", "author": "ginnick", "createdAt": "2020-08-17T14:02:29Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/dispatcher/internal/channel/HttpDispatcherLink.java", "diffHunk": "@@ -1260,4 +1260,14 @@ public boolean useForwardedHeaders() {\n         return false;\n     }\n \n+    /**\n+     * @param b", "originalCommit": "367d64d7268e357d26782d0a70c9d97a7c2f3ae1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwMTIwMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r471501202", "bodyText": "Should wrap the \"logp\" with an if testing for enabling trace trace... look elsewhere in part for examples.", "author": "ginnick", "createdAt": "2020-08-17T14:03:58Z", "path": "dev/com.ibm.ws.webcontainer/src/com/ibm/ws/webcontainer/webapp/WebApp.java", "diffHunk": "@@ -4095,8 +4099,22 @@ public void sendError(HttpServletRequest req, HttpServletResponse res, ServletEr\n         WebContainerRequestState reqState = WebContainerRequestState.getInstance(true);   //PI80786\n \n         // PK82794\n-        if (WCCustomProperties.SUPPRESS_LAST_ZERO_BYTE_PACKAGE)\n-            reqState.setAttribute(\"com.ibm.ws.webcontainer.suppresslastzerobytepackage\", \"true\");\n+        if (WCCustomProperties.SUPPRESS_LAST_ZERO_BYTE_PACKAGE) {\n+           // reqState.setAttribute(\"com.ibm.ws.webcontainer.suppresslastzerobytepackage\", \"true\");\n+            if (req instanceof SRTServletRequest) {\n+                SRTServletRequest srtReq = (SRTServletRequest) req;\n+                IRequestExtended iReq = (IRequestExtended)srtReq.getIRequest();\n+                if (iReq != null) {\n+                    HttpInboundConnection httpInboundConnection = iReq.getHttpInboundConnection();\n+                    HttpInboundConnectionExtended extendedConnection= (HttpInboundConnectionExtended) httpInboundConnection;\n+                    if(extendedConnection!=null) {\n+                        HttpDispatcherLink dispatcherLink=(HttpDispatcherLink) extendedConnection.getHttpDispatcherLink();\n+                        logger.logp(Level.FINE, CLASS_NAME, \"sendError\", \"Setting SuppressZeroByteChunk\");", "originalCommit": "367d64d7268e357d26782d0a70c9d97a7c2f3ae1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "890ca3dd6bd1f53636ecd501b1177ee69d9f8999", "url": "https://github.com/OpenLiberty/open-liberty/commit/890ca3dd6bd1f53636ecd501b1177ee69d9f8999", "message": "Update HttpDispatcherLink.java", "committedDate": "2020-08-17T22:59:30Z", "type": "commit"}, {"oid": "d386d0798d0cd548e6065617464d5fb808413f6e", "url": "https://github.com/OpenLiberty/open-liberty/commit/d386d0798d0cd548e6065617464d5fb808413f6e", "message": "Update WebApp.java", "committedDate": "2020-08-17T23:00:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MDg2OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r473040868", "bodyText": "Originally this was checking that the link wasn't an H2HttpInboundLinkWrap, and not doing it now would seem to be a change in behavior. Additionally, by not checking the instanceof of the hisc, this conditional could potentially do a hisc.getSupress0ByteChunk() on an object that isn't an HttpInboundServiceContextImpl, which could lead to exceptions during the runtime. I recommend only doing the new code when the hisc is proven to be HttpInboundServiceContextImpl.", "author": "mrsaldana", "createdAt": "2020-08-19T13:45:16Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/channel/internal/HttpServiceContextImpl.java", "diffHunk": "@@ -2892,8 +2903,16 @@ final protected VirtualConnection sendFullOutgoing(WsByteBuffer[] wsbb, HttpBase\n             if (this instanceof HttpInboundServiceContextImpl) {\n                 hisc = (HttpInboundServiceContextImpl) this;\n             }\n-            if (hisc != null && !(hisc.getLink() instanceof H2HttpInboundLinkWrap)) {\n-                createEndOfBodyChunk();\n+            if (hisc != null) {", "originalCommit": "d386d0798d0cd548e6065617464d5fb808413f6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MzI0MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13299#discussion_r473043240", "bodyText": "Might be useful to log if this method isn't able to set the flag due to the isc being null. Nothing code breaking, just QoL change for easier debugging.", "author": "mrsaldana", "createdAt": "2020-08-19T13:48:30Z", "path": "dev/com.ibm.ws.transport.http/src/com/ibm/ws/http/dispatcher/internal/channel/HttpDispatcherLink.java", "diffHunk": "@@ -1260,4 +1260,14 @@ public boolean useForwardedHeaders() {\n         return false;\n     }\n \n+    /**\n+     * Calls function to set the supress 0 byte chunk flag.\n+     */\n+    public void setSuppressZeroByteChunk(boolean suppress0ByteChunk) {\n+        if (this.isc != null) {", "originalCommit": "d386d0798d0cd548e6065617464d5fb808413f6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "783b5d8855cb407927504e09e1a08537f8ee27a8", "url": "https://github.com/OpenLiberty/open-liberty/commit/783b5d8855cb407927504e09e1a08537f8ee27a8", "message": "Update HttpServiceContextImpl.java", "committedDate": "2020-08-19T14:01:18Z", "type": "commit"}, {"oid": "9dc641620a4a97694456728a0754596af6918c78", "url": "https://github.com/OpenLiberty/open-liberty/commit/9dc641620a4a97694456728a0754596af6918c78", "message": "Update HttpDispatcherLink.java", "committedDate": "2020-08-19T14:04:28Z", "type": "commit"}]}