{"pr_number": 11214, "pr_title": "Add TimedCache and use it to cache config values", "pr_createdAt": "2020-03-06T17:37:16Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11214", "timeline": [{"oid": "83346ea4350cfb716afcdef459f110115083d17b", "url": "https://github.com/OpenLiberty/open-liberty/commit/83346ea4350cfb716afcdef459f110115083d17b", "message": "Add TimedCache and use it to cache config values\n\nUse it to cache:\n - server.xml app properties\n - raw values retrieved from any source", "committedDate": "2020-03-09T11:54:49Z", "type": "commit"}, {"oid": "5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "url": "https://github.com/OpenLiberty/open-liberty/commit/5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "message": "Config-1.4 caching updates for unit testing\n\nMake TimedCache create an executor when it's used in a unit test\n\nMake ConversionTest wait so that the rawValueCache has time to expire.", "committedDate": "2020-03-09T11:55:21Z", "type": "commit"}, {"oid": "5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "url": "https://github.com/OpenLiberty/open-liberty/commit/5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "message": "Config-1.4 caching updates for unit testing\n\nMake TimedCache create an executor when it's used in a unit test\n\nMake ConversionTest wait so that the rawValueCache has time to expire.", "committedDate": "2020-03-09T11:55:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1MTg5Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11214#discussion_r389751896", "bodyText": "The 500 should be in a constant somewhere, possibly a constants file and possibly configurable??", "author": "tevans78", "createdAt": "2020-03-09T15:06:55Z", "path": "dev/com.ibm.ws.microprofile.config.1.4/src/com/ibm/ws/microprofile/config14/impl/Config14Impl.java", "diffHunk": "@@ -47,13 +50,14 @@\n      */\n     public Config14Impl(ConversionManager conversionManager, SortedSources sources, ScheduledExecutorService executor, long refreshInterval) {\n         super(conversionManager, sources);\n+        rawValueCache = new TimedCache<>(executor, 500, TimeUnit.MILLISECONDS);", "originalCommit": "5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1ODM5Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11214#discussion_r389758392", "bodyText": "Unless you object, I'll do that as a follow up.", "author": "Azquelt", "createdAt": "2020-03-09T15:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1MTg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1MzMwMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11214#discussion_r389753302", "bodyText": "Does the convertedValueCache need clearing?", "author": "tevans78", "createdAt": "2020-03-09T15:09:06Z", "path": "dev/com.ibm.ws.microprofile.config.1.4/src/com/ibm/ws/microprofile/config14/impl/Config14Impl.java", "diffHunk": "@@ -135,6 +144,18 @@ private SourcedValue getRawValue(String key) {\n         return raw;\n     }\n \n+    @Override\n+    public void close() {", "originalCommit": "5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1ODEzNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11214#discussion_r389758135", "bodyText": "No. Potentially that could be an improvement, but this whole class should be GC'd shortly after close() is called.\nThe only reason for closing TimedCache is to cancel any pending invalidation task.", "author": "Azquelt", "createdAt": "2020-03-09T15:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1MzMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2NzY0NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11214#discussion_r389767645", "bodyText": "should be based on the 500 constant ... unless that is made configurable", "author": "tevans78", "createdAt": "2020-03-09T15:29:17Z", "path": "dev/com.ibm.ws.microprofile.config.1.4/test/src/com/ibm/ws/microprofile/config14/test/ConversionTest.java", "diffHunk": "@@ -47,14 +47,16 @@ public void testBadCharUnicode() {\n     }\n \n     @Test\n-    public void testConverterCache() {\n+    public void testConverterCache() throws InterruptedException {\n         Config config = ConfigProviderResolver.instance().getBuilder().addDefaultSources().withConverter(TestType.class, 100, new TestTypeConverter()).build();\n         String key = \"testConverterCache\";\n \n         String rawString = \"This is the RAW String 1\";\n         String expected = rawString + \" - 1\";\n         System.setProperty(key, rawString);\n \n+        Thread.sleep(700); // Let the raw value cache expire", "originalCommit": "5fca2c003d716484e9b001b6a9c15f4aa3e9ea50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}