{"pr_number": 13227, "pr_title": "Remaining MP Metrics 3.0 Implementation", "pr_createdAt": "2020-07-29T00:13:30Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13227", "timeline": [{"oid": "14fff4221b1fbb321640c257a9d017ccabf162a8", "url": "https://github.com/OpenLiberty/open-liberty/commit/14fff4221b1fbb321640c257a9d017ccabf162a8", "message": "MP Metrics 3.0 FAT TCK", "committedDate": "2020-08-03T20:56:40Z", "type": "forcePushed"}, {"oid": "e16cedde5e376326a5719902c64c580c9d2e1be6", "url": "https://github.com/OpenLiberty/open-liberty/commit/e16cedde5e376326a5719902c64c580c9d2e1be6", "message": "java 11 compat", "committedDate": "2020-08-04T13:38:22Z", "type": "forcePushed"}, {"oid": "82f8f4129b1665dd44753ddbb341dc8f3d18a887", "url": "https://github.com/OpenLiberty/open-liberty/commit/82f8f4129b1665dd44753ddbb341dc8f3d18a887", "message": "java 11 compat", "committedDate": "2020-08-04T13:56:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIzODc1OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13227#discussion_r465238759", "bodyText": "Would be nice to convert these string literals \"gauge\", \"counter\" to constants.", "author": "fmhwong", "createdAt": "2020-08-04T18:14:28Z", "path": "dev/com.ibm.ws.microprofile.metrics.3.0/src/com/ibm/ws/microprofile/metrics30/helper/PrometheusBuilder30.java", "diffHunk": "@@ -30,47 +37,269 @@\n \n     private static final TraceComponent tc = Tr.register(PrometheusBuilder30.class);\n \n-    public static void buildTimer(StringBuilder builder, String name, String description, Map<MetricID, Metric> currentMetricMap) {\n-        buildMetered(builder, name, description, currentMetricMap);\n+    /**\n+     * If there exists global tags then we will combine these tags with the provided\n+     * MetricID's tags. The returned combination of tags will be represented as a String in\n+     * 'key=\"value\",key2=\"value2\",...'. This is exactly the same as MetricID's getTagAsString()\n+     *\n+     * @param mid the MetricID\n+     * @return String of combined tags 'key=\"value\",key2=\"value2\",...' format\n+     */\n+    protected static String resolveTagsAsStringWithGlobalTags(MetricID mid) {\n+        org.eclipse.microprofile.metrics.Tag[] globalTags = Util30.getCachedGlobalTags();\n+\n+        /*\n+         * If there exists global tags, then we will need to copy\n+         *\n+         */\n+        if (globalTags != null && globalTags.length != 0) {\n+            org.eclipse.microprofile.metrics.Tag[] applicationTags = mid.getTagsAsArray();\n+            org.eclipse.microprofile.metrics.Tag[] combinedTags = new org.eclipse.microprofile.metrics.Tag[globalTags.length + applicationTags.length];\n+\n+            /*\n+             * Copying Global Tags first ensures that any application tag\n+             * with matching key will override the global tag when\n+             * it is copied into the array.\n+             *\n+             * This is because the MetricID will read through the array\n+             * and take the \"newest\" value.\n+             *\n+             * This is the behaviour in mpMetrics-2.x and below\n+             */\n+            System.arraycopy(globalTags, 0, combinedTags, 0, globalTags.length);\n+            System.arraycopy(applicationTags, 0, combinedTags, globalTags.length, applicationTags.length);\n+\n+            MetricID temp = new MetricID(\"temporary\", combinedTags);\n+\n+            return temp.getTagsAsString();\n+        } else {\n+            return mid.getTagsAsString();\n+        }\n+    }\n+\n+    public static void buildTimer30(StringBuilder builder, String name, String description, Map<MetricID, Metric> currentMetricMap) {\n+        buildMetered30(builder, name, description, currentMetricMap);\n         double conversionFactor = Constants.NANOSECONDCONVERSION;\n \n         String lineName = name + \"_elapsedTime_\" + MetricUnits.SECONDS.toString();\n         getPromTypeLine(builder, lineName, \"gauge\");\n         for (MetricID mid : currentMetricMap.keySet()) {\n-            getPromValueLine(builder, lineName, ((Timer) currentMetricMap.get(mid)).getElapsedTime().toNanos() * conversionFactor, mid.getTagsAsString());\n+\n+            getPromValueLine(builder, lineName, ((Timer) currentMetricMap.get(mid)).getElapsedTime().toNanos() * conversionFactor, resolveTagsAsStringWithGlobalTags(mid));\n         }\n \n         // Build Histogram\n-        buildSampling(builder, name, description, currentMetricMap, conversionFactor, Constants.APPENDEDSECONDS);\n+        buildSampling30(builder, name, description, currentMetricMap, conversionFactor, Constants.APPENDEDSECONDS);\n     }\n \n-    public static void buildSimpleTimer(StringBuilder builder, String name, String description, Map<MetricID, Metric> currentMetricMap) {\n+    public static void buildSimpleTimer30(StringBuilder builder, String name, String description, Map<MetricID, Metric> currentMetricMap) {\n         double conversionFactor = Constants.NANOSECONDCONVERSION;\n \n-        buildCounting(builder, name, description, currentMetricMap);\n+        buildCounting30(builder, name, description, currentMetricMap);\n \n         String lineName = name + \"_elapsedTime_\" + MetricUnits.SECONDS.toString();\n         getPromTypeLine(builder, lineName, \"gauge\");", "originalCommit": "82f8f4129b1665dd44753ddbb341dc8f3d18a887", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMzM0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13227#discussion_r465313348", "bodyText": "Fixed.", "author": "Channyboy", "createdAt": "2020-08-04T20:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIzODc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI0ODIxNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13227#discussion_r465248214", "bodyText": "2020?", "author": "fmhwong", "createdAt": "2020-08-04T18:30:53Z", "path": "dev/com.ibm.ws.microprofile.metrics.3.0_fat_tck/publish/tckRunner/tck/src/test/java/com/ibm/ws/microprofile/metrics/test/ArquillianLoadableExtension.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.", "originalCommit": "82f8f4129b1665dd44753ddbb341dc8f3d18a887", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMzI4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13227#discussion_r465313281", "bodyText": "This file is \"copied\". I believe we don't change the copyright for such files since it isn't new.", "author": "Channyboy", "createdAt": "2020-08-04T20:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI0ODIxNA=="}], "type": "inlineReview"}, {"oid": "0b2710d42487147e5a0c6ab63e20f6f8d6e8d1f0", "url": "https://github.com/OpenLiberty/open-liberty/commit/0b2710d42487147e5a0c6ab63e20f6f8d6e8d1f0", "message": "Additional Implementation Changes to statistfy MP Metrics 3.0 specification.\n\n- Cache MP Config mp.metrics.appName tags in Metric Registry by Application level values for each application (defined in mp.config.properties) and on the Server level (i.e env vars or sys props)\n- Cache MP Config mp.metrics.tags tags with the Metric Registry and is appended during metrics export\n- CDI Producers are no longer supported by the @metrics annotation\n- New Gauge register/retrieve methods that take Functions as parameters\n- MP Metrics 3.0 FAT TCK", "committedDate": "2020-08-05T15:45:53Z", "type": "commit"}, {"oid": "0b2710d42487147e5a0c6ab63e20f6f8d6e8d1f0", "url": "https://github.com/OpenLiberty/open-liberty/commit/0b2710d42487147e5a0c6ab63e20f6f8d6e8d1f0", "message": "Additional Implementation Changes to statistfy MP Metrics 3.0 specification.\n\n- Cache MP Config mp.metrics.appName tags in Metric Registry by Application level values for each application (defined in mp.config.properties) and on the Server level (i.e env vars or sys props)\n- Cache MP Config mp.metrics.tags tags with the Metric Registry and is appended during metrics export\n- CDI Producers are no longer supported by the @metrics annotation\n- New Gauge register/retrieve methods that take Functions as parameters\n- MP Metrics 3.0 FAT TCK", "committedDate": "2020-08-05T15:45:53Z", "type": "forcePushed"}]}