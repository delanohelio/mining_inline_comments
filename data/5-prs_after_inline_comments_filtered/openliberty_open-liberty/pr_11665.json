{"pr_number": 11665, "pr_title": "EE9 Build & Test Fixes ", "pr_createdAt": "2020-04-07T15:51:47Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11665", "timeline": [{"oid": "8f049821061ffefc81ea9cfec213995d44c2836b", "url": "https://github.com/OpenLiberty/open-liberty/commit/8f049821061ffefc81ea9cfec213995d44c2836b", "message": "Modify jakarta selection rules", "committedDate": "2020-04-07T17:16:39Z", "type": "forcePushed"}, {"oid": "ca782ebb8f39b632a32b915957f05260322c8be0", "url": "https://github.com/OpenLiberty/open-liberty/commit/ca782ebb8f39b632a32b915957f05260322c8be0", "message": "Update Transformer to 0.0.7\n\nModify jakarta selection rules", "committedDate": "2020-04-07T17:20:02Z", "type": "forcePushed"}, {"oid": "b8d0828573e78b89ffcd4045f7e4ffd4ecd1d9a8", "url": "https://github.com/OpenLiberty/open-liberty/commit/b8d0828573e78b89ffcd4045f7e4ffd4ecd1d9a8", "message": "Update Transformer to 0.0.7\n\nModify jakarta selection rules", "committedDate": "2020-04-07T17:39:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NzQ2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11665#discussion_r404997463", "bodyText": "Use IS_SECURITY_ENABLED in place of System.getSecurityManager() != null", "author": "pmd1nh", "createdAt": "2020-04-07T17:46:22Z", "path": "dev/com.ibm.websphere.jakartaee.el.4.0/src/jakarta/el/FactoryFinder.java", "diffHunk": "@@ -18,43 +18,96 @@\n \n package jakarta.el;\n \n-import static java.io.File.separator;\n-\n+import java.io.BufferedReader;\n import java.io.File;\n import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.UnsupportedEncodingException;\n import java.lang.reflect.Constructor;\n-import java.util.Iterator;\n import java.util.Properties;\n import java.util.ServiceLoader;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n \n class FactoryFinder {\n \n+    private static final boolean IS_SECURITY_ENABLED = (System.getSecurityManager() != null);\n+\n+    private static final String SERVICE_RESOURCE_NAME = \"META-INF/services/jakarta.el.ExpressionFactory\";\n+\n+    private static final String PROPERTY_NAME = \"jakarta.el.ExpressionFactory\";\n+\n+    private static final String SEP;\n+    private static final String PROPERTY_FILE;\n+\n+    static {\n+        if (IS_SECURITY_ENABLED) {\n+            SEP = AccessController.doPrivileged(\n+                                                new PrivilegedAction<String>() {\n+                                                    @Override\n+                                                    public String run() {\n+                                                        return System.getProperty(\"file.separator\");\n+                                                    }\n+\n+                                                });\n+            PROPERTY_FILE = AccessController.doPrivileged(\n+                                                          new PrivilegedAction<String>() {\n+                                                              @Override\n+                                                              public String run() {\n+                                                                  return System.getProperty(\"java.home\") + SEP +\n+                                                                         \"lib\" + SEP + \"el.properties\";\n+                                                              }\n+\n+                                                          });\n+        } else {\n+            SEP = System.getProperty(\"file.separator\");\n+            PROPERTY_FILE = System.getProperty(\"java.home\") + SEP + \"lib\" +\n+                            SEP + \"el.properties\";\n+        }\n+    }\n+\n     /**\n      * Creates an instance of the specified class using the specified <code>ClassLoader</code> object.\n      *\n      * @exception ELException if the given class could not be found or could not be instantiated\n      */\n     private static Object newInstance(String className, ClassLoader classLoader, Properties properties) {\n         try {\n-            Class<?> spiClass;\n+            Class<?> instance;\n             if (classLoader == null) {\n-                spiClass = Class.forName(className);\n+                instance = Class.forName(className);\n             } else {\n-                spiClass = classLoader.loadClass(className);\n+                instance = classLoader.loadClass(className);\n             }\n \n             if (properties != null) {\n                 Constructor<?> constr = null;\n                 try {\n-                    constr = spiClass.getConstructor(Properties.class);\n+                    constr = instance.getConstructor(Properties.class);\n                 } catch (Exception ex) {\n                 }\n \n                 if (constr != null) {\n                     return constr.newInstance(properties);\n                 }\n             }\n-            return spiClass.getDeclaredConstructor().newInstance();\n+            if (System.getSecurityManager() != null) {", "originalCommit": "ba1a7797f8fb75d9b7eff96eb23cba24af08de2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5Nzk1OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11665#discussion_r404997958", "bodyText": "if (IS_SECURITY_ENABLED)", "author": "pmd1nh", "createdAt": "2020-04-07T17:47:10Z", "path": "dev/com.ibm.websphere.jakartaee.el.4.0/src/jakarta/el/FactoryFinder.java", "diffHunk": "@@ -80,56 +133,130 @@ private static Object newInstance(String className, ClassLoader classLoader, Pro\n      * <code>null</code> to indicate that there is no fallback class name\n      * @exception ELException if there is an error\n      */\n-    static Object find(Class<?> serviceClass, String factoryId, String fallbackClassName, Properties properties) {\n+    static Object find(Class<?> serviceClass, Properties properties) {\n         ClassLoader classLoader;\n         try {\n-            classLoader = Thread.currentThread().getContextClassLoader();\n+            if (System.getSecurityManager() != null) {", "originalCommit": "ba1a7797f8fb75d9b7eff96eb23cba24af08de2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f463546ba615bd5ab14cba4ccf9f3fac484830c", "url": "https://github.com/OpenLiberty/open-liberty/commit/8f463546ba615bd5ab14cba4ccf9f3fac484830c", "message": "Update Servlet 4 FAT for EE9", "committedDate": "2020-04-07T19:37:29Z", "type": "commit"}, {"oid": "a81cade11985093ac736142c92a071a77bcd3c93", "url": "https://github.com/OpenLiberty/open-liberty/commit/a81cade11985093ac736142c92a071a77bcd3c93", "message": "Fix Feature '-jar' in JSP", "committedDate": "2020-04-07T19:37:52Z", "type": "commit"}, {"oid": "c99dade90a7d5e6fdbb7f2ffad4e3ab6414b6efe", "url": "https://github.com/OpenLiberty/open-liberty/commit/c99dade90a7d5e6fdbb7f2ffad4e3ab6414b6efe", "message": "Update Transformer to 0.0.7\n\nModify jakarta selection rules", "committedDate": "2020-04-07T19:37:52Z", "type": "commit"}, {"oid": "444d990926dc1ab22d3c692004740041d75d798f", "url": "https://github.com/OpenLiberty/open-liberty/commit/444d990926dc1ab22d3c692004740041d75d798f", "message": "Update EL-4.0 FactoryFinder", "committedDate": "2020-04-07T19:39:02Z", "type": "commit"}, {"oid": "444d990926dc1ab22d3c692004740041d75d798f", "url": "https://github.com/OpenLiberty/open-liberty/commit/444d990926dc1ab22d3c692004740041d75d798f", "message": "Update EL-4.0 FactoryFinder", "committedDate": "2020-04-07T19:39:02Z", "type": "forcePushed"}, {"oid": "764257d1fc62a285f8a30c10e54b3b3033decfab", "url": "https://github.com/OpenLiberty/open-liberty/commit/764257d1fc62a285f8a30c10e54b3b3033decfab", "message": "Update to EL-4.0 RC1", "committedDate": "2020-04-07T20:09:16Z", "type": "commit"}]}