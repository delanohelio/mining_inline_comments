{"pr_number": 13881, "pr_title": "Use AmbiguousEJBReferenceException with legacy EJB bindings", "pr_createdAt": "2020-09-10T22:35:55Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13881", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3MjE3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487072176", "bodyText": "should this be called \"localBinding\" or is that a copy paste thing?", "author": "olendvcook", "createdAt": "2020-09-11T14:11:49Z", "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/NameSpaceBinderImpl.java", "diffHunk": "@@ -254,21 +259,39 @@ public void bindDefaultEJBRemote(EJBBinding bindingObject, HomeRecord hr) {\n      * To bind to root we register a service to the BundleContext, passing it a Reference Object\n      *\n      * @param bindingObject the EJB Binding information\n-     * @param hr the HomeRecord of the EJB\n-     * @param bindingName the JNDI binding name\n+     * @param hr            the HomeRecord of the EJB\n+     * @param bindingName   the JNDI binding name\n+     * @param isSimpleName  Flag used to force creation of an AmbiguousEJBReference if an\n+     *                          ambiguous simple name binding is detected\n      */\n-    private void bindLegacyRemoteBinding(EJBBinding bindingObject, HomeRecord hr, String bindingName) {\n+    private void bindLegacyRemoteBinding(EJBBinding bindingObject, HomeRecord hr, String bindingName, boolean isSimpleName) {\n         EJBRemoteRuntime remoteRuntime = ejbRemoteRuntimeServiceRef.getService();\n         if (remoteRuntime != null) {\n-\n-            // TODO: If BindingsHelper.ivRemoteBindings.contains(bindingName); we have duplicate bindings\n-            // and need to bind Ambiguous. #11441\n-\n             BindingsHelper bh = BindingsHelper.getRemoteHelper(hr);\n-            bh.ivRemoteBindings.add(bindingName);\n-\n             BundleContext bc = ejbRemoteRuntimeServiceRef.getReference().getBundle().getBundleContext();\n             BeanMetaData bmd = hr.getBeanMetaData();\n+            EJBBinding localBinding = new EJBBinding(bindingObject.homeRecord, bindingObject.interfaceName, bindingObject.interfaceIndex, bindingObject.isLocal);", "originalCommit": "287799d96bb8dae6282de766df43d96cc365ffb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MzM4MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487173381", "bodyText": "Updated all usage of 'localBinding' to 'newBinding' to better reflect the intention.", "author": "brideck", "createdAt": "2020-09-11T17:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3MjE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTY2OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487101668", "bodyText": "If I saw just this in trace bind: false I would think the bind failed, not that it's not Ambiguous so I'd make this clearer.", "author": "olendvcook", "createdAt": "2020-09-11T14:55:45Z", "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/naming/EJBLocalNamingHelperImpl.java", "diffHunk": "@@ -81,18 +87,33 @@ public synchronized void bind(EJBBinding binding, String name) {\n             Tr.entry(tc, \"bind: \" + name);\n         }\n \n+        EJBBinding previousBinding = EJBLocalBindings.get(name);\n+\n+        // There won't be a previous binding for an ambiguous simple binding name\n+        if (isSimpleName) {\n+            localBinding.setAmbiguousReference();\n+            notAmbiguous = false;\n+        }\n+\n+        if (previousBinding != null) {\n+            localBinding.setAmbiguousReference();\n+            localBinding.addJ2EENames(previousBinding.getJ2EENames());\n+            notAmbiguous = false;\n+        }\n+\n         Lock writeLock = javaColonLock.writeLock();\n         writeLock.lock();\n         try {\n-            //TODO: If EJBLocalBindings already contains name, bind ambiguous reference exception\n-            EJBLocalBindings.put(name, binding);\n+            EJBLocalBindings.put(name, localBinding);\n         } finally {\n             writeLock.unlock();\n         }\n \n         if (isTraceOn && tc.isEntryEnabled()) {\n-            Tr.exit(tc, \"bind\");\n+            Tr.exit(tc, \"bind: \" + notAmbiguous);", "originalCommit": "287799d96bb8dae6282de766df43d96cc365ffb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MzYyMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487173620", "bodyText": "Updated exit message to \"bind: notAmbiguous = \"", "author": "brideck", "createdAt": "2020-09-11T17:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwNDQ5NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487104495", "bodyText": "Same here, if I saw just this in trace bind: false I would think the bind failed, not that it's not Ambiguous so I'd make this clearer.", "author": "olendvcook", "createdAt": "2020-09-11T15:00:21Z", "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/naming/LocalColonEJBNamingHelperImpl.java", "diffHunk": "@@ -70,25 +74,42 @@ protected void unsetEJBHomeRuntime(ServiceReference<EJBHomeRuntime> ref) {\n     }\n \n     @Override\n-    public synchronized void bind(EJBBinding binding, String name) {\n+    public synchronized boolean bind(EJBBinding binding, String name, boolean isSimpleName) {\n         final boolean isTraceOn = TraceComponent.isAnyTracingEnabled();\n+        boolean notAmbiguous = true;\n+        EJBBinding localBinding = new EJBBinding(binding.homeRecord, binding.interfaceName, binding.interfaceIndex, binding.isLocal);\n+\n         if (isTraceOn && tc.isEntryEnabled()) {\n             Tr.entry(tc, \"bind: \" + name);\n         }\n \n+        EJBBinding previousBinding = localColonEJBBindings.get(name);\n+\n+        // There won't be a previous binding for an ambiguous simple binding name\n+        if (isSimpleName) {\n+            localBinding.setAmbiguousReference();\n+            notAmbiguous = false;\n+        }\n+\n+        if (previousBinding != null) {\n+            localBinding.setAmbiguousReference();\n+            localBinding.addJ2EENames(previousBinding.getJ2EENames());\n+            notAmbiguous = false;\n+        }\n+\n         Lock writeLock = javaColonLock.writeLock();\n         writeLock.lock();\n         try {\n-\n-            //TODO: If LocalColonEJBBindings already contains name, bind ambiguous reference exception\n-            localColonEJBBindings.put(name, binding);\n+            localColonEJBBindings.put(name, localBinding);\n         } finally {\n             writeLock.unlock();\n         }\n \n         if (isTraceOn && tc.isEntryEnabled()) {\n-            Tr.exit(tc, \"bind\");\n+            Tr.exit(tc, \"bind: \" + notAmbiguous);", "originalCommit": "287799d96bb8dae6282de766df43d96cc365ffb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MzY3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487173670", "bodyText": "Updated exit message to \"bind: notAmbiguous = \"", "author": "brideck", "createdAt": "2020-09-11T17:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwNDQ5NQ=="}], "type": "inlineReview"}, {"oid": "46dad3961fec204f81bca34d6e3380b7d11b67a6", "url": "https://github.com/OpenLiberty/open-liberty/commit/46dad3961fec204f81bca34d6e3380b7d11b67a6", "message": "11441: Fix feature checker issues and address review comments\n- Clarify trace and variable names\n- Clean up FAT project dependencies", "committedDate": "2020-09-11T17:23:38Z", "type": "forcePushed"}, {"oid": "8f751cbd9859715d66cc513eb2765b042197e9f2", "url": "https://github.com/OpenLiberty/open-liberty/commit/8f751cbd9859715d66cc513eb2765b042197e9f2", "message": "11441: Update API to version 2.0", "committedDate": "2020-09-16T22:16:38Z", "type": "forcePushed"}, {"oid": "66d8d9bb7a906806a212028a4f115eede18f4b66", "url": "https://github.com/OpenLiberty/open-liberty/commit/66d8d9bb7a906806a212028a4f115eede18f4b66", "message": "Use AmbiguousEJBReferenceException with legacy EJB bindings\n- Expose com.ibm.websphere.ejbcontainer as internal IBM API\n- Remove unused entity EJB APIs\n- Modify legacy bindings to throw AmbiguousEJBReferenceException\n- Update bindings FAT to use AmbiguousEJBReferenceException\n- Cleanup old apps in setup for each FAT test", "committedDate": "2020-09-17T16:28:16Z", "type": "commit"}, {"oid": "c8a488bc6fa943a91f05f0e2662ec47ae1a5750e", "url": "https://github.com/OpenLiberty/open-liberty/commit/c8a488bc6fa943a91f05f0e2662ec47ae1a5750e", "message": "11441: Fix unittest", "committedDate": "2020-09-17T16:28:16Z", "type": "commit"}, {"oid": "e9b1fb45418fe2176dee513c168e321925c1031f", "url": "https://github.com/OpenLiberty/open-liberty/commit/e9b1fb45418fe2176dee513c168e321925c1031f", "message": "11441: Fix whitespace", "committedDate": "2020-09-17T16:28:17Z", "type": "commit"}, {"oid": "326d3e5ef94d27ea1ac61749618ce4704ce015af", "url": "https://github.com/OpenLiberty/open-liberty/commit/326d3e5ef94d27ea1ac61749618ce4704ce015af", "message": "11441: Fix feature checker issues and address review comments\n- Clarify trace and variable names\n- Clean up FAT project dependencies", "committedDate": "2020-09-17T16:28:17Z", "type": "commit"}, {"oid": "6a8b7c3aec49ef876a11582694a1e682f1971858", "url": "https://github.com/OpenLiberty/open-liberty/commit/6a8b7c3aec49ef876a11582694a1e682f1971858", "message": "11441: Update API to version 2.0", "committedDate": "2020-09-17T16:28:17Z", "type": "commit"}, {"oid": "f7f77e774216113c50997bda8fab15e80cf88152", "url": "https://github.com/OpenLiberty/open-liberty/commit/f7f77e774216113c50997bda8fab15e80cf88152", "message": "11441: Update containerServices to version 4.0", "committedDate": "2020-09-17T16:28:18Z", "type": "commit"}, {"oid": "f7f77e774216113c50997bda8fab15e80cf88152", "url": "https://github.com/OpenLiberty/open-liberty/commit/f7f77e774216113c50997bda8fab15e80cf88152", "message": "11441: Update containerServices to version 4.0", "committedDate": "2020-09-17T16:28:18Z", "type": "forcePushed"}]}