{"pr_number": 13935, "pr_title": "Add do-priv blocks for the restful web services 3.0 implementation", "pr_createdAt": "2020-09-14T21:05:17Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13935", "timeline": [{"oid": "8c6192472d7c33d3ee6987ba9dad85dc6a292894", "url": "https://github.com/OpenLiberty/open-liberty/commit/8c6192472d7c33d3ee6987ba9dad85dc6a292894", "message": "add a do-priv block when getting the classloader in ConfigCDIExtension.java", "committedDate": "2020-09-14T20:58:38Z", "type": "commit"}, {"oid": "3621540fb59adc6fa68f0f45e75d80c0e9e24147", "url": "https://github.com/OpenLiberty/open-liberty/commit/3621540fb59adc6fa68f0f45e75d80c0e9e24147", "message": "add a do-priv block when getting the property for MAX_MT_CACHE_SIZE in MediaTypeHeaderDelegate.java", "committedDate": "2020-09-14T21:02:20Z", "type": "commit"}, {"oid": "bf31cc20588e019c88d066df07648a216a20c042", "url": "https://github.com/OpenLiberty/open-liberty/commit/bf31cc20588e019c88d066df07648a216a20c042", "message": "dependabot update", "committedDate": "2020-09-14T21:03:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNDY5NQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488234695", "bodyText": "this has been fixed in RESTEasy, but not yet GA - should be in 4.5.7 when it comes out. maybe mention that in the comment so we know that we can delete this overlay once we pull in 4.5.7 or newer?", "author": "andymc12", "createdAt": "2020-09-14T21:38:13Z", "path": "dev/io.openliberty.org.jboss.resteasy.common/src/org/jboss/resteasy/plugins/delegates/MediaTypeHeaderDelegate.java", "diffHunk": "@@ -0,0 +1,190 @@\n+package org.jboss.resteasy.plugins.delegates;\n+\n+import org.jboss.resteasy.resteasy_jaxrs.i18n.Messages;\n+import org.jboss.resteasy.util.HeaderParameterParser;\n+\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.ext.RuntimeDelegate;\n+\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * @author <a href=\"mailto:bill@burkecentral.com\">Bill Burke</a>\n+ * @version $Revision: 1 $\n+ */\n+public class MediaTypeHeaderDelegate implements RuntimeDelegate.HeaderDelegate\n+{\n+   public static final MediaTypeHeaderDelegate INSTANCE = new MediaTypeHeaderDelegate();\n+\n+   private static Map<String, MediaType> map = new ConcurrentHashMap<String, MediaType>();\n+   private static Map<MediaType, String> reverseMap = new ConcurrentHashMap<MediaType, String>();\n+   private static final int MAX_MT_CACHE_SIZE =\n+                   // Liberty Change", "originalCommit": "bf31cc20588e019c88d066df07648a216a20c042", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNDc4NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488534784", "bodyText": "If this has been fixed in the resteasy master branch, would it be better to build a snapshot version from there and put it in DHE ... rather than creating a new overlay!?", "author": "tevans78", "createdAt": "2020-09-15T09:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTE2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488761164", "bodyText": "Updated the comment. @tevans78 We plan to upgrade to the newer version of Resteasy before release, these overlay changes are are to enable us to do rapid development. This is currently how we override our CXF implementation for jaxrs-2.0 and jaxrs-2.1\nWe discussed having our own CXF fork and pulling that into OpenLiberty on today's design issues call. I assume we'll have a similar discussion about Resteasy in the future.", "author": "WhiteCat22", "createdAt": "2020-09-15T15:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc4MjAwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488782000", "bodyText": "Rapid development now but at what service cost if the overlays are never removed ... which is exactly what has happened with CXF. Your aim should be to avoid a fork or overlay unless there is no other choice. In this case there is a choice, the change is already in RESTEasy.", "author": "tevans78", "createdAt": "2020-09-15T15:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNDY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxNDYwMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488814601", "bodyText": "I don't disagree, but I think this conversation is beyond the scope of this PR.", "author": "WhiteCat22", "createdAt": "2020-09-15T16:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNDY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNTE4MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488235180", "bodyText": "I think I saw this same call to get classloader in other versions of MP Config (besides just 1.1).  It might be good to update them all - when I looked, I saw it in 1.4, but it's a good guess that it needs to be updated in 1.2 and 1.3 too.", "author": "andymc12", "createdAt": "2020-09-14T21:39:18Z", "path": "dev/com.ibm.ws.microprofile.config.1.1.cdi/src/com/ibm/ws/microprofile/config/cdi/ConfigCDIExtension.java", "diffHunk": "@@ -60,7 +62,13 @@ protected void addBadInjectionType(Type type) {\n \n     void processInjectionTarget(@Observes ProcessInjectionTarget<?> pit) {\n         Class<?> targetClass = pit.getAnnotatedType().getJavaClass();\n-        ClassLoader classLoader = targetClass.getClassLoader();\n+\n+        ClassLoader classLoader = AccessController.doPrivileged(new PrivilegedAction<ClassLoader>() {\n+            @Override\n+            public ClassLoader run() {\n+                return targetClass.getClassLoader();", "originalCommit": "bf31cc20588e019c88d066df07648a216a20c042", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUzNjI1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488536253", "bodyText": "I think Andy is right, there is another getClassLoader in Config14CDIExtension. The 1.2 and 1.3 versions don't have much in since they just inherit from this class.", "author": "tevans78", "createdAt": "2020-09-15T09:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNTE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1Nzg2NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13935#discussion_r488757864", "bodyText": "I've updated Config14CDIExtension as well, thanks for pointing it out.", "author": "WhiteCat22", "createdAt": "2020-09-15T15:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzNTE4MA=="}], "type": "inlineReview"}, {"oid": "d5d299850644d85ea41da934c770c53758534cf2", "url": "https://github.com/OpenLiberty/open-liberty/commit/d5d299850644d85ea41da934c770c53758534cf2", "message": "add a do-priv block when getting the classloader in Config14CDIExtension.java", "committedDate": "2020-09-15T15:19:56Z", "type": "commit"}, {"oid": "d64844b335faefc8f0325c03af549d7d6f2fad7a", "url": "https://github.com/OpenLiberty/open-liberty/commit/d64844b335faefc8f0325c03af549d7d6f2fad7a", "message": "update MediaTypeHeaderDelegate comment to indicate that the fix is in a newer version of the upstream", "committedDate": "2020-09-15T15:24:26Z", "type": "commit"}]}