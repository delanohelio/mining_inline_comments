{"pr_number": 10427, "pr_title": "Introspection addition", "pr_createdAt": "2020-01-14T19:30:42Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10427", "timeline": [{"oid": "7fa6bfaa283e323f9b78fca3db54eb2a18898799", "url": "https://github.com/OpenLiberty/open-liberty/commit/7fa6bfaa283e323f9b78fca3db54eb2a18898799", "message": "added beginning of introspect logic", "committedDate": "2020-01-02T20:18:42Z", "type": "commit"}, {"oid": "6625eb524a8c3784d2477589b8296184a7dc2cb6", "url": "https://github.com/OpenLiberty/open-liberty/commit/6625eb524a8c3784d2477589b8296184a7dc2cb6", "message": "introspect works", "committedDate": "2020-01-08T21:15:40Z", "type": "commit"}, {"oid": "eb4be02efb760276b5c50d4c7ce0ec120f6d2e7c", "url": "https://github.com/OpenLiberty/open-liberty/commit/eb4be02efb760276b5c50d4c7ce0ec120f6d2e7c", "message": "Merge remote-tracking branch 'origin/master' into introspection_addition", "committedDate": "2020-01-09T16:22:00Z", "type": "commit"}, {"oid": "baaab0821a01b6ec0090929616b67b7c1fd7496e", "url": "https://github.com/OpenLiberty/open-liberty/commit/baaab0821a01b6ec0090929616b67b7c1fd7496e", "message": "merged in latest metatype code", "committedDate": "2020-01-14T15:42:00Z", "type": "commit"}, {"oid": "67990f1e6edd8057049686f79b85a985b1024feb", "url": "https://github.com/OpenLiberty/open-liberty/commit/67990f1e6edd8057049686f79b85a985b1024feb", "message": "latest changes with error messages", "committedDate": "2020-01-14T16:32:42Z", "type": "commit"}, {"oid": "a2cae041240af1d23e1c8517e48739fa882c2383", "url": "https://github.com/OpenLiberty/open-liberty/commit/a2cae041240af1d23e1c8517e48739fa882c2383", "message": "added correct string processing", "committedDate": "2020-01-14T19:29:45Z", "type": "commit"}, {"oid": "920d99e8617ba14c2217d0f514360b814746a59b", "url": "https://github.com/OpenLiberty/open-liberty/commit/920d99e8617ba14c2217d0f514360b814746a59b", "message": "whitespace:", "committedDate": "2020-01-14T19:38:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3NzgzNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10427#discussion_r366577836", "bodyText": "I'd switch this to use the getRequiredConfigAttribute() method that's defined in this class. If you keep this call as you have it now, this will emit a message that says\n\nCWWKS6104W: The configuration attribute [clientId] that is required is missing or empty and a default value is not provided. Verify that the attribute is configured, that it is not empty, and that it does not consist of only white space characters.\n\nThat's technically correct, but the message doesn't tell us which element is missing that attribute. Using the other method will emit this error message:\n\nCWWKS5479E: The configuration attribute [clientId] that is required in the social login configuration [someSpecificSocialRP] is missing or empty. Verify that the attribute is configured, that it is not empty, and that it does not consist of only white space characters.\n\nThat helps a server admin because then they know that the someSpecificSocialRP element was the one with the problem. A server could have a bunch of social login configurations, so not knowing which specific one caused the problem would be a pain.", "author": "ayoho", "createdAt": "2020-01-14T21:20:15Z", "path": "dev/com.ibm.ws.security.social/src/com/ibm/ws/security/social/internal/Oauth2LoginConfigImpl.java", "diffHunk": "@@ -268,6 +272,19 @@ boolean isConfiguredForProxyFlow(Map<String, Object> props) {\n     protected void checkForRequiredConfigAttributesForProxyFlow(Map<String, Object> props) {\n         configUtils.getRequiredConfigAttributeWithConfigId(props, KEY_userApi, uniqueId);\n     }\n+    \n+    boolean isIntrospectConfiguration(Map<String, Object> props) {\n+        String userApiType = configUtils.getConfigAttribute(props, KEY_userApiType);\n+        if (userApiType != null && \"introspect\".equals(userApiType)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+    \n+    protected void checkForRequiredConfigAttributesForIntrospect(Map<String, Object> props) {\n+        configUtils.getRequiredConfigAttribute(props, KEY_clientId);", "originalCommit": "920d99e8617ba14c2217d0f514360b814746a59b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3OTU1NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10427#discussion_r366579554", "bodyText": "Strictly speaking, this just needs to be a SocialLoginConfig object and not a Oauth2LoginConfigImpl object. Making the change would avoid having to do a cast when this class' constructor is called by the runtime. I'd recommend switching it.", "author": "ayoho", "createdAt": "2020-01-14T21:24:23Z", "path": "dev/com.ibm.ws.security.social/src/com/ibm/ws/security/social/internal/utils/IntrospectUserApiUtils.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ * IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.social.internal.utils;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.io.OutputStreamWriter;\n+import java.io.StringReader;\n+import java.net.HttpURLConnection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.json.Json;\n+import javax.json.JsonObject;\n+import javax.json.JsonObjectBuilder;\n+import javax.json.JsonValue;\n+import javax.json.JsonValue.ValueType;\n+import javax.json.stream.JsonParsingException;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.jose4j.lang.JoseException;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Sensitive;\n+import com.ibm.ws.security.common.http.HttpUtils;\n+import com.ibm.ws.security.social.TraceConstants;\n+import com.ibm.ws.security.social.error.SocialLoginException;\n+import com.ibm.ws.security.social.internal.Oauth2LoginConfigImpl;\n+import com.ibm.ws.common.internal.encoder.Base64Coder;\n+\n+public class IntrospectUserApiUtils {\n+\n+    public static final TraceComponent tc = Tr.register(IntrospectUserApiUtils.class, TraceConstants.TRACE_GROUP, TraceConstants.MESSAGE_BUNDLE);\n+\n+    Oauth2LoginConfigImpl config = null;", "originalCommit": "920d99e8617ba14c2217d0f514360b814746a59b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU4MzMzMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10427#discussion_r366583333", "bodyText": "I just noticed the code that this was based on had a minor mistake. The second argument to this SocialLoginException constructor is an Exception that's the cause of this new exception being thrown. That second argument should be the variable e instead of null.", "author": "ayoho", "createdAt": "2020-01-14T21:32:56Z", "path": "dev/com.ibm.ws.security.social/src/com/ibm/ws/security/social/internal/utils/IntrospectUserApiUtils.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ * IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.security.social.internal.utils;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.io.OutputStreamWriter;\n+import java.io.StringReader;\n+import java.net.HttpURLConnection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import javax.json.Json;\n+import javax.json.JsonObject;\n+import javax.json.JsonObjectBuilder;\n+import javax.json.JsonValue;\n+import javax.json.JsonValue.ValueType;\n+import javax.json.stream.JsonParsingException;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.jose4j.lang.JoseException;\n+\n+import com.ibm.websphere.ras.Tr;\n+import com.ibm.websphere.ras.TraceComponent;\n+import com.ibm.websphere.ras.annotation.Sensitive;\n+import com.ibm.ws.security.common.http.HttpUtils;\n+import com.ibm.ws.security.social.TraceConstants;\n+import com.ibm.ws.security.social.error.SocialLoginException;\n+import com.ibm.ws.security.social.internal.Oauth2LoginConfigImpl;\n+import com.ibm.ws.common.internal.encoder.Base64Coder;\n+\n+public class IntrospectUserApiUtils {\n+\n+    public static final TraceComponent tc = Tr.register(IntrospectUserApiUtils.class, TraceConstants.TRACE_GROUP, TraceConstants.MESSAGE_BUNDLE);\n+\n+    Oauth2LoginConfigImpl config = null;\n+\n+    HttpUtils httpUtils = new HttpUtils();\n+\n+    public IntrospectUserApiUtils(Oauth2LoginConfigImpl config) {\n+        this.config = config;\n+    }\n+\n+    public String getUserApiResponse(@Sensitive String accessToken, SSLSocketFactory sslSocketFactory) throws SocialLoginException {\n+        String response = null;\n+        try {\n+            HttpURLConnection connection = sendUserApiRequest(accessToken, sslSocketFactory);\n+            response = readUserApiResponse(connection);\n+        } catch (Exception e) {\n+            throw new SocialLoginException(\"INTROSPECT_ERROR_GETTING_USER_INFO\", e, new Object[] { e });\n+        }\n+        return response;\n+    }\n+\n+    HttpURLConnection sendUserApiRequest(@Sensitive String accessToken, SSLSocketFactory sslSocketFactory) throws IOException, SocialLoginException {\n+        HttpURLConnection connection = httpUtils.createConnection(HttpUtils.RequestMethod.POST, config.getUserApi(), sslSocketFactory);\n+        connection = httpUtils.setHeaders(connection, getUserApiRequestHeaders());\n+        connection.setDoOutput(true);\n+        \n+        OutputStream outputStream = connection.getOutputStream();\n+        String postData = \"token=\" + accessToken;\n+        outputStream.write(postData.getBytes());\n+        outputStream.close();\n+        connection.connect();\n+        return connection;\n+    }\n+\n+    @Sensitive\n+    Map<String, String> getUserApiRequestHeaders() {\n+        Map<String, String> headers = new HashMap<String, String>();\n+        String idAndSecretEncoded = Base64Coder.base64Encode(config.getClientId() + \":\" + config.getClientSecret());\n+\n+        headers.put(\"Authorization\", \"Basic \" + idAndSecretEncoded);\n+        headers.put(\"Accept\", \"application/json\");\n+        headers.put(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+        return headers;\n+    }\n+\n+    String readUserApiResponse(HttpURLConnection connection) throws IOException, SocialLoginException {\n+        int responseCode = connection.getResponseCode();\n+        String response = httpUtils.readConnectionResponse(connection);\n+        if (responseCode != HttpServletResponse.SC_OK) {\n+            throw new SocialLoginException(\"INTROSPECT_USER_API_BAD_STATUS\", null, new Object[] { responseCode, response });\n+        }\n+        return modifyExistingResponseToJSON(response);\n+    }\n+\n+    String modifyExistingResponseToJSON(String response) throws SocialLoginException {\n+        JsonObject jsonResponse = getJsonResponseIfValid(response);\n+        if(jsonResponse.getBoolean(\"active\")) {\n+            return jsonResponse.toString();\n+        }\n+        else {\n+            throw new SocialLoginException(\"INTROSPECT_USER_API_ACTIVE_NOT_TRUE\",null, null);\n+        }\n+\n+    }\n+\n+    private JsonObject getJsonResponseIfValid(String response) throws SocialLoginException {\n+        if (response == null || response.isEmpty()) {\n+            throw new SocialLoginException(\"INTROSPECT_USER_API_RESPONSE_NULL_EMPTY\", null, null);\n+        }\n+        try {\n+            return Json.createReader(new StringReader(response)).readObject();\n+        } catch (JsonParsingException e) {\n+            throw new SocialLoginException(\"INTROSPECT_USER_API_RESPONSE_NOT_JSON\", null, new Object[] { response, e });", "originalCommit": "920d99e8617ba14c2217d0f514360b814746a59b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8c1d76ab81ee3f807b32a77d1cbcbf6211ac6e5", "url": "https://github.com/OpenLiberty/open-liberty/commit/c8c1d76ab81ee3f807b32a77d1cbcbf6211ac6e5", "message": "made changes", "committedDate": "2020-01-14T21:57:30Z", "type": "commit"}]}