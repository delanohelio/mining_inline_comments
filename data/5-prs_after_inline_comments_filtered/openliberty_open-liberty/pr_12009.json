{"pr_number": 12009, "pr_title": "Update MBean status when application fails to start", "pr_createdAt": "2020-04-30T18:13:09Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/12009", "timeline": [{"oid": "759bb2c2c7ad41463a79ab1c47b134f6d09bd09e", "url": "https://github.com/OpenLiberty/open-liberty/commit/759bb2c2c7ad41463a79ab1c47b134f6d09bd09e", "message": "Update future returned to app manager to wait till context listener startup", "committedDate": "2020-05-08T19:00:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4ODY3MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12009#discussion_r423388671", "bodyText": "Can you fix this copyright header? Formatting is really odd.", "author": "pnicolucci", "createdAt": "2020-05-12T00:07:27Z", "path": "dev/com.ibm.ws.webcontainer.servlet.4.0_fat/fat/src/com/ibm/ws/fat/wc/tests/WCApplicationMBeanStatusTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*******************************************************************************n * Copyright (c) 2020 IBM Corporation and others.n * All rights reserved. This program and the accompanying materialsn * are made available under the terms of the Eclipse Public License v1.0n * which accompanies this distribution, and is available atn * http://www.eclipse.org/legal/epl-v10.htmln *n * Contributors:n *     IBM Corporation - initial API and implementationn *******************************************************************************/\n+package com.ibm.ws.fat.wc.tests;", "originalCommit": "53b919d88a1f5e1babae8f5aee788ba853382910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4ODk1Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12009#discussion_r423388952", "bodyText": "What are these Error/Warning messages for? Are these part of this specific test case?", "author": "pnicolucci", "createdAt": "2020-05-12T00:08:15Z", "path": "dev/com.ibm.ws.webcontainer.servlet.4.0_fat/fat/src/com/ibm/ws/fat/wc/tests/WCApplicationMBeanStatusTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*******************************************************************************n * Copyright (c) 2020 IBM Corporation and others.n * All rights reserved. This program and the accompanying materialsn * are made available under the terms of the Eclipse Public License v1.0n * which accompanies this distribution, and is available atn * http://www.eclipse.org/legal/epl-v10.htmln *n * Contributors:n *     IBM Corporation - initial API and implementationn *******************************************************************************/\n+package com.ibm.ws.fat.wc.tests;\n+\n+import java.util.logging.Logger;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import com.ibm.ws.fat.util.LoggingTest;\n+import com.ibm.ws.fat.util.SharedServer;\n+import com.ibm.ws.fat.wc.WCApplicationHelper;\n+\n+import componenttest.annotation.ExpectedFFDC;\n+import componenttest.custom.junit.runner.FATRunner;\n+\n+/**\n+ *\n+ * The testcase will send request to a servlet in TestServlet40.war\n+ * which has ApplicationMBean and checks for the status of the\n+ * TestBadServletContextListener.war web application\n+ * which is expected to fail to start due to runtime exception.\n+ *\n+ * PASS: if status is INSTALLED\n+ *\n+ */\n+@RunWith(FATRunner.class)\n+public class WCApplicationMBeanStatusTest extends LoggingTest {\n+\n+    private final static String CLASSNAME = WCApplicationMBeanStatusTest.class.getName();\n+\n+    private final static Logger LOG = Logger.getLogger(CLASSNAME);\n+\n+    @ClassRule\n+    public static SharedServer SHARED_SERVER = new SharedServer(\"servlet40_stopAppStartListenerExceptionServer\");\n+\n+    @Override\n+    protected SharedServer getSharedServer() {\n+        return SHARED_SERVER;\n+    }\n+\n+    /**\n+     * @throws Exception\n+     *\n+     *                       The test case expects start of the application fails due to runtime\n+     *                       exception on server start, add the expected ffdc.\n+     */\n+    @BeforeClass\n+    @ExpectedFFDC({ \"java.lang.Exception\", \"java.lang.RuntimeException\" })\n+    public static void setUp() throws Exception {\n+        LOG.info(\"Setup : add TestBadServletContextListener.war to the server if not already present.\");\n+\n+        WCApplicationHelper.addWarToServerDropins(SHARED_SERVER.getLibertyServer(), \"TestBadServletContextListener.war\", false,\n+                                                  \"testbadscl.war.listener\");\n+        LOG.info(\"Setup : TestBadServletContextListener.war added to the server\");\n+\n+        WCApplicationHelper.addWarToServerDropins(SHARED_SERVER.getLibertyServer(), \"TestServlet40.war\", true, \"testservlet40.war.servlets\");\n+\n+        LOG.info(\"Setup : TestServlet40.war added to the server\");\n+\n+        SHARED_SERVER.startIfNotStarted();\n+\n+        // The ApplicationMBean is added in TestServlet40\n+        WCApplicationHelper.waitForAppStart(\"TestServlet40\", WCPushBuilderTest.class.getName(), SHARED_SERVER.getLibertyServer());\n+\n+        LOG.info(\"Setup : TestServlet40.war started on the server\");\n+\n+        // The failing servletcontext is added in TestBadServletContextListener\n+        WCApplicationHelper.waitForAppFailStart(\"TestBadServletContextListener\", CLASSNAME,\n+                                                SHARED_SERVER.getLibertyServer());\n+\n+        LOG.info(\"Setup : TestBadServletContextListener failed to start on the server as expected\");\n+\n+        LOG.info(\"Setup : complete, ready for Tests\");\n+    }\n+\n+    /**\n+     * @throws Exception\n+     *\n+     *                       The test case expects start of the application fails due to runtime\n+     *                       exception in listener, add the expected errors\n+     *\n+     */\n+    @AfterClass\n+    public static void testCleanup() throws Exception {\n+        // test cleanup\n+        if (SHARED_SERVER.getLibertyServer() != null && SHARED_SERVER.getLibertyServer().isStarted()) {\n+            SHARED_SERVER.getLibertyServer().stopServer(\"SRVE0283E:.*\", \"SRVE0265E:.*\", \"CWWKE0921W:.*\", \"CWWKE0912W:.*\", \"SRVE9014E:.*\");\n+        }", "originalCommit": "53b919d88a1f5e1babae8f5aee788ba853382910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4OTA1MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12009#discussion_r423389051", "bodyText": "Can you fix this copyright header? Formatting is really odd.", "author": "pnicolucci", "createdAt": "2020-05-12T00:08:38Z", "path": "dev/com.ibm.ws.webcontainer.servlet.4.0_fat/test-applications/TestBadServletContextListener.war/src/testbadscl/war/listener/RuntimeErrorContextListener.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package testbadscl.war.listener;\n+\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+\n+/*******************************************************************************n * Copyright (c) 2020 IBM Corporation and others.n * All rights reserved. This program and the accompanying materialsn * are made available under the terms of the Eclipse Public License v1.0n * which accompanies this distribution, and is available atn * http://www.eclipse.org/legal/epl-v10.htmln *n * Contributors:n *     IBM Corporation - initial API and implementationn *******************************************************************************/\n+", "originalCommit": "53b919d88a1f5e1babae8f5aee788ba853382910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4OTE2Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12009#discussion_r423389166", "bodyText": "Should we log this vs doing a system out?", "author": "pnicolucci", "createdAt": "2020-05-12T00:09:06Z", "path": "dev/com.ibm.ws.webcontainer.servlet.4.0_fat/test-applications/TestBadServletContextListener.war/src/testbadscl/war/listener/RuntimeErrorContextListener.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package testbadscl.war.listener;\n+\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+\n+/*******************************************************************************n * Copyright (c) 2020 IBM Corporation and others.n * All rights reserved. This program and the accompanying materialsn * are made available under the terms of the Eclipse Public License v1.0n * which accompanies this distribution, and is available atn * http://www.eclipse.org/legal/epl-v10.htmln *n * Contributors:n *     IBM Corporation - initial API and implementationn *******************************************************************************/\n+\n+/**\n+ * The ApplicationMBean and checks for the status of the\n+ * TestBadServletContextListener.war web application\n+ * which has this listener and is expected to fail to\n+ * start due to runtime exception thrown here.\n+ *\n+ */\n+@WebListener\n+public class RuntimeErrorContextListener implements ServletContextListener {\n+\n+    /**\n+     *\n+     */\n+    @Override\n+    public void contextDestroyed(ServletContextEvent scEvent) {\n+        scEvent.getServletContext().log(\"**RuntimeErrorContextListener destroy invoked**\");\n+    }\n+\n+    /**\n+     *\n+     */\n+    @Override\n+    public void contextInitialized(ServletContextEvent sce) {\n+        ServletContext context = sce.getServletContext();\n+        context.log(\"**RuntimeErrorContextListener contextInitialized invoked**\");\n+        System.out.println(\"RuntimeErrorContextListener throws RuntimeException\");\n+        //EXPLICITLY THROW EXCEPTION TO test property \"stopappstartuponlistenerexception\"", "originalCommit": "53b919d88a1f5e1babae8f5aee788ba853382910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4OTIwMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12009#discussion_r423389201", "bodyText": "Can you fix this copyright header? Formatting is really odd.", "author": "pnicolucci", "createdAt": "2020-05-12T00:09:15Z", "path": "dev/com.ibm.ws.webcontainer.servlet.4.0_fat/test-applications/TestServlet40.war/src/testservlet40/war/servlets/ApplicationMBeanServlet.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*******************************************************************************n * Copyright (c) 2020 IBM Corporation and others.n * All rights reserved. This program and the accompanying materialsn * are made available under the terms of the Eclipse Public License v1.0n * which accompanies this distribution, and is available atn * http://www.eclipse.org/legal/epl-v10.htmln *n * Contributors:n *     IBM Corporation - initial API and implementationn *******************************************************************************/\n+package testservlet40.war.servlets;", "originalCommit": "53b919d88a1f5e1babae8f5aee788ba853382910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47052cea4bddf3ca65f3f8b085ba80604609c05c", "url": "https://github.com/OpenLiberty/open-liberty/commit/47052cea4bddf3ca65f3f8b085ba80604609c05c", "message": "Update testcase with permissions and code review fixes", "committedDate": "2020-05-12T20:42:00Z", "type": "forcePushed"}, {"oid": "ea8e4966310083f3ae4f64acdc6f9cb209481e76", "url": "https://github.com/OpenLiberty/open-liberty/commit/ea8e4966310083f3ae4f64acdc6f9cb209481e76", "message": "Add testcases to check Application status using MBean", "committedDate": "2020-05-13T17:13:06Z", "type": "forcePushed"}, {"oid": "f4ad063422e0aeabe4218661d7ca106265a5d119", "url": "https://github.com/OpenLiberty/open-liberty/commit/f4ad063422e0aeabe4218661d7ca106265a5d119", "message": "Update future returned to app manager to wait till context listener startup", "committedDate": "2020-05-14T14:55:23Z", "type": "commit"}, {"oid": "7a8a0b66caeb00e114e9dc7386773761026a8ca9", "url": "https://github.com/OpenLiberty/open-liberty/commit/7a8a0b66caeb00e114e9dc7386773761026a8ca9", "message": "Add testcases to check Application status using MBean", "committedDate": "2020-05-14T14:55:23Z", "type": "commit"}, {"oid": "7a8a0b66caeb00e114e9dc7386773761026a8ca9", "url": "https://github.com/OpenLiberty/open-liberty/commit/7a8a0b66caeb00e114e9dc7386773761026a8ca9", "message": "Add testcases to check Application status using MBean", "committedDate": "2020-05-14T14:55:23Z", "type": "forcePushed"}]}