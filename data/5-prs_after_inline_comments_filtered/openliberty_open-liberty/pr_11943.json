{"pr_number": 11943, "pr_title": "11212 Create SPI for weld extensions", "pr_createdAt": "2020-04-27T10:13:37Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11943", "timeline": [{"oid": "9ab9c64dfe7ce16e4e12578928e5c7e87e8a7497", "url": "https://github.com/OpenLiberty/open-liberty/commit/9ab9c64dfe7ce16e4e12578928e5c7e87e8a7497", "message": "new test for SPI, WIP", "committedDate": "2020-04-27T10:21:30Z", "type": "forcePushed"}, {"oid": "d200d9f56f7151ae30bb9eedab00bd0a5f04688c", "url": "https://github.com/OpenLiberty/open-liberty/commit/d200d9f56f7151ae30bb9eedab00bd0a5f04688c", "message": "new test for SPI, WIP", "committedDate": "2020-04-27T10:30:33Z", "type": "forcePushed"}, {"oid": "f24bc843bbbddf17834f49922264e848f5f2a2fb", "url": "https://github.com/OpenLiberty/open-liberty/commit/f24bc843bbbddf17834f49922264e848f5f2a2fb", "message": "new test for SPI, WIP", "committedDate": "2020-04-27T10:36:02Z", "type": "forcePushed"}, {"oid": "1ded3c2f8359660ba8135a07926fbfffe2a33070", "url": "https://github.com/OpenLiberty/open-liberty/commit/1ded3c2f8359660ba8135a07926fbfffe2a33070", "message": "new test for SPI, WIP", "committedDate": "2020-04-27T10:40:22Z", "type": "forcePushed"}, {"oid": "fb2bdc077ce7c2e7186a5ddd41a01dfd0f504a97", "url": "https://github.com/OpenLiberty/open-liberty/commit/fb2bdc077ce7c2e7186a5ddd41a01dfd0f504a97", "message": "new test for SPI", "committedDate": "2020-04-28T15:52:53Z", "type": "forcePushed"}, {"oid": "b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "url": "https://github.com/OpenLiberty/open-liberty/commit/b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "message": "new test for SPI", "committedDate": "2020-04-29T09:34:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NzY3MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r418557671", "bodyText": "javadoc is wrong", "author": "tevans78", "createdAt": "2020-05-01T14:11:06Z", "path": "dev/com.ibm.ws.cdi.internal/src/com/ibm/ws/cdi/internal/interfaces/CDIRuntime.java", "diffHunk": "@@ -55,6 +56,11 @@\n      */\n     public Iterator<ServiceAndServiceReferencePair<WebSphereCDIExtension>> getExtensionServices();\n \n+    /**\n+     * @return an iterator through all the registered {@link WebSphereCDIExtension} services", "originalCommit": "b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODY5Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r418558692", "bodyText": "what happens if a class is both WebSphereCDIExtension and WebSphereCDIExtensionMetaData?", "author": "tevans78", "createdAt": "2020-05-01T14:13:20Z", "path": "dev/com.ibm.ws.cdi.weld/src/com/ibm/ws/cdi/impl/CDIContainerImpl.java", "diffHunk": "@@ -582,7 +586,26 @@ public String getCurrentApplicationContextID() {\n                         runtimeExtensionMap.put(serviceID, extensionArchive);\n                     }\n                 }\n+                extensionSet.add(extensionArchive);\n+            }\n+        }\n+\n+        //Now do the exact same thing for extensions coming from the SPI\n+        Iterator<ServiceAndServiceReferencePair<WebSphereCDIExtensionMetaData>> spiExtensions = cdiRuntime.getSPIExtensionServices();", "originalCommit": "b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMTUzNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r421021535", "bodyText": "I think there will be two BDAs. I can add a check that throws an exception for it if you'd like. (I think the odds of that happening are low since WebSphereCDIExtension isn't exposed to user features)", "author": "benjamin-confino", "createdAt": "2020-05-06T18:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MDAwNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r418560006", "bodyText": "Are you sure? Throwing a CDIException would be more consistent.", "author": "tevans78", "createdAt": "2020-05-01T14:16:12Z", "path": "dev/com.ibm.ws.cdi.weld/src/com/ibm/ws/cdi/impl/CDIContainerImpl.java", "diffHunk": "@@ -604,6 +627,37 @@ private ExtensionArchive getProbeExtensionArchive() {\n         return this.probeExtensionArchive;\n     }\n \n+    private ExtensionArchive newSPIExtensionArchive(ServiceReference<WebSphereCDIExtensionMetaData> sr,\n+                                                    WebSphereCDIExtensionMetaData webSphereCDIExtensionMetaData, WebSphereCDIDeployment applicationContext) throws CDIException {\n+        Bundle bundle = sr.getBundle();\n+\n+        Set<Class<? extends Extension>> extensionClasses = webSphereCDIExtensionMetaData.getExtensions();\n+        Set<Extension> extensions = new HashSet<Extension>();\n+        Set<String> extensionClassNames = extensionClasses.stream().map(clazz -> clazz.getCanonicalName()).collect(Collectors.toSet());\n+\n+        for (Class<? extends Extension> clazz : extensionClasses) {\n+            try {\n+                extensions.add(clazz.getDeclaredConstructor().newInstance());\n+            } catch (InstantiationException | IllegalAccessException | IllegalArgumentException | InvocationTargetException | NoSuchMethodException | SecurityException e) {\n+                // Just emit an FFDC. This will proceed without using the extension.", "originalCommit": "b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MDUyMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r419340520", "bodyText": "Document when this method needs to be override?", "author": "Emily-Jiang", "createdAt": "2020-05-04T10:23:22Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.wsspi.cdi.extension;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for Weld Runtime extensions. All runtime extensions need to register a service\n+ * under this interface. This bundle will find all of the services and then get hold of the bundle classloader and\n+ * pass onto Weld.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement CDIExtensionClasses then it must\n+ * not return the class annotated WebSphereCDIExtensionMetaData.\n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class)\n+ *\n+ * For example:\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ *                    public class JwtCDIExtension implements WebSphereCDIExtensionMetaData { ... }\n+ */\n+\n+public interface WebSphereCDIExtensionMetaData {\n+\n+    /**\n+     * All classes returned by this method will be treated as CDI beans. All classes must be in the same archive as your WebSphereCDIExtensionMetaData.\n+     */\n+    default public Set<Class<?>> getBeanClasses() {\n+        return Collections.emptySet();\n+    }\n+\n+    /**\n+     * All classes returned by this method will be treated as CDI extensions.\n+     *\n+     * If a class in returned by this method implements WebSphereCDIExtensionMetaData an IllegalArguementException is thrown.\n+     * This is because it will result in OSGI and Weld independently instantiating the class, while it is unlikely for the\n+     * two instances to conflict, it is best to keep the OSGI service and CDI extension separate.\n+     */\n+    public default Set<Class<? extends Extension>> getExtensions() {", "originalCommit": "b0b8502befb895d8c4ae91a6c0d15d89e22e3624", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1ODgxMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423858810", "bodyText": "Maybe something like \"Override this method if you need to observe CDI container lifecycle events to do something more advanced that just providing additional bean classes.\"", "author": "Azquelt", "createdAt": "2020-05-12T16:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MDUyMA=="}], "type": "inlineReview"}, {"oid": "fdb237c0d19d509499c10d68e8b1c472cbf993fc", "url": "https://github.com/OpenLiberty/open-liberty/commit/fdb237c0d19d509499c10d68e8b1c472cbf993fc", "message": "new test for SPI", "committedDate": "2020-05-04T22:13:55Z", "type": "forcePushed"}, {"oid": "2327b1e291ba78fe277bbe3d42687cd62f94951c", "url": "https://github.com/OpenLiberty/open-liberty/commit/2327b1e291ba78fe277bbe3d42687cd62f94951c", "message": "new test for SPI", "committedDate": "2020-05-06T18:53:27Z", "type": "forcePushed"}, {"oid": "290570d91ef47e219a281c8339be98d40dcd2702", "url": "https://github.com/OpenLiberty/open-liberty/commit/290570d91ef47e219a281c8339be98d40dcd2702", "message": "new test for SPI", "committedDate": "2020-05-06T19:01:04Z", "type": "forcePushed"}, {"oid": "60283fc6436a9ea42044dd958973ad349bb1ce66", "url": "https://github.com/OpenLiberty/open-liberty/commit/60283fc6436a9ea42044dd958973ad349bb1ce66", "message": "Deprecate WebSphereCDIExtension", "committedDate": "2020-05-07T09:12:31Z", "type": "forcePushed"}, {"oid": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "url": "https://github.com/OpenLiberty/open-liberty/commit/693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "message": "Deprecate WebSphereCDIExtension", "committedDate": "2020-05-07T09:54:02Z", "type": "forcePushed"}, {"oid": "eaa1befccd26458223dd9e9d9e4ea5756bbe0619", "url": "https://github.com/OpenLiberty/open-liberty/commit/eaa1befccd26458223dd9e9d9e4ea5756bbe0619", "message": "Deprecate WebSphereCDIExtension", "committedDate": "2020-05-12T10:37:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNTM0MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423625340", "bodyText": "2018->2020", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:21:30Z", "path": "dev/com.ibm.ws.cdi.extension_fat/fat/src/com/ibm/ws/cdi12/fat/tests/CDI12ExtensionSPITest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*******************************************************************************\n+ * Copyright (c) 2014, 2018 IBM Corporation and others.", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyODc4OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423628788", "bodyText": "copyright 2015->2020\nCan you rename the file to be CDIExtensionMetadata? We should stop mentioning the WebSphere name.", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:27:53Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyOTQwMQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423629401", "bodyText": "duplication of need to", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:29:06Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for Weld Runtime extensions. Liberty features that wish to extend CDI will need to \n+ * need to register a service under this interface. ", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyOTc4Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423629786", "bodyText": "Weld -> CDI", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:29:49Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for Weld Runtime extensions. Liberty features that wish to extend CDI will need to ", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzMTg5OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423631898", "bodyText": "WebSphereCDIExtensionMetaData -> CDIExtensionMetaData. You should add the package for Extension. Also, you can say\nImplementing CDIExtension or javax.enterprise.inject.spi.Extension is mutually exclusive. Otherwise, none desirable behaviour will occur.", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:33:38Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for Weld Runtime extensions. Liberty features that wish to extend CDI will need to \n+ * need to register a service under this interface. \n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then \n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ * \n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a \n+ * META-INF/services file. It is best practice to not put WebSphereCDIExtensionMetaData and Extension on the same class as that would result", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzMzEwMA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423633100", "bodyText": "If a class in returned by this method implements WebSphereCDIExtensionMetaData, an IllegalArguementException is thrown.", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:35:53Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for Weld Runtime extensions. Liberty features that wish to extend CDI will need to \n+ * need to register a service under this interface. \n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then \n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ * \n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a \n+ * META-INF/services file. It is best practice to not put WebSphereCDIExtensionMetaData and Extension on the same class as that would result\n+ * in CDI and OSGI independently instantiating the class.\n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation. \n+ * \n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation. \n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ * \n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }\n+ *     \n+ * A complete bundle that uses WebSphereCDIExtensionMetaData to register CDI beans can be found at: \n+ * com.ibm.ws.cdi.extension_fat/test-bundles/cdi.spi.extension/ \n+ * \n+ * Note the files com.ibm.ws.cdi.extension_fat/cdi_spi_extension.bnd and com.ibm.ws.cdi.extension_fat/publish/features/cdi.spi.extension.mf \n+ * both of which are needed to include a bundle into liberty. com.ibm.ws.cdi.extension_fat/test-applications/SPIExtension.war/ contains a \n+ * simple app that injects the beans provided by cdi.spi.extension.  \n+ */\n+\n+public interface WebSphereCDIExtensionMetaData {\n+\n+    /**\n+     * All classes returned by this method will be registered with CDI. All classes must be in the same archive as your WebSphereCDIExtensionMetaData.\n+     */\n+    default public Set<Class<?>> getBeanClasses() {\n+        return Collections.emptySet();\n+    }\n+\n+    /**\n+     * All classes returned by this method will be treated as CDI extensions.\n+     *\n+     * If a class in returned by this method implements WebSphereCDIExtensionMetaData an IllegalArguementException is thrown.", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzMzM3Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423633377", "bodyText": "2015->2020", "author": "Emily-Jiang", "createdAt": "2020-05-12T10:36:26Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/io/openliberty/cdi/spi/package-info.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.", "originalCommit": "693bd51a4d650b75adaef6ef9c9c7fd6a928900a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a548e04c1fc16dfaa48d06dc9dbceef8bc6bcd6", "url": "https://github.com/OpenLiberty/open-liberty/commit/3a548e04c1fc16dfaa48d06dc9dbceef8bc6bcd6", "message": "Deprecate WebSphereCDIExtension", "committedDate": "2020-05-12T11:11:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0NjE4OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423846188", "bodyText": "Remove the first sentence, this is not a marker interface.\n(A marker interface is an interface with no methods)", "author": "Azquelt", "createdAt": "2020-05-12T15:54:23Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0NjI2MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423846260", "bodyText": "Use {@code myMethod()} around method names in the javadoc.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n          \n          \n            \n             * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n          \n          \n            \n             * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n          \n          \n            \n             * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n          \n          \n            \n             * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n          \n          \n            \n             * all classes returned by that method will be treated as CDI extensions any observer methods for container lifecycle events will be called when creating the CDI container for each application.", "author": "Azquelt", "createdAt": "2020-05-12T15:54:30Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0NjQzNg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423846436", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n          \n          \n            \n             * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n          \n          \n            \n             * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n          \n          \n            \n             * it is best to keep the OSGI service and CDI extension separate. \n          \n          \n            \n             * Classes returned from {@code getExtensions()} must implement {@link javax.enterprise.inject.spi.Extension} but do <b>not</b> need to be listed in a \n          \n          \n            \n             * {@code META-INF/services} file.\n          \n          \n            \n             * \n          \n          \n            \n             * It is best practise that one class should not implement both this interface and {@link javax.enterprise.inject.spi.Extension}\n          \n          \n            \n             * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n          \n          \n            \n             * it is best to keep the OSGI service and CDI extension separate.", "author": "Azquelt", "createdAt": "2020-05-12T15:54:45Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. ", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0NjQ3NA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423846474", "bodyText": "I don't think we need to explicitly call out that service properties aren't required. That's fairly unusual so stating it could be confusing for users who haven't used the old internal interface and this class has enough documentation and examples in it that people who are familiar with the old interface shouldn't be tempted to randomly add them.\nI'd also list the use of the @Component annotation as an example (since there are other ways to register the service) and add configuraitonPolicy=IGNORE as there's no configuration, so adding that is best practise.\nLastly, code should always be in {@code } tags so that it formats properly when rendered to html.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n          \n          \n            \n             * other properties that can be included in the Component annotation.\n          \n          \n            \n             * The class that implements this interface should be registered as an OSGi service, for example by annotating it with {@code @Component(service = WebSphereCDIExtensionMetaData.class, configurationPolicy=IGNORE)}.", "author": "Azquelt", "createdAt": "2020-05-12T15:54:48Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTA2Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423851063", "bodyText": "Javadoc's rendering sucks, I think you need to do this here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @Component(service = WebSphereCDIExtensionMetaData.class)\n          \n          \n            \n             * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n          \n          \n            \n             *\n          \n          \n            \n             *     @Override\n          \n          \n            \n             *     public Set<Class<?>> getBeanClasses() {\n          \n          \n            \n             *         Set<Class<?>> beans = new HashSet<Class<?>>();\n          \n          \n            \n             *         //This will register a producer class and expose it's produced beans to applications\n          \n          \n            \n             *         beans.add(ClassSPIRegisteredProducer.class);\n          \n          \n            \n             *     }\n          \n          \n            \n             * }\n          \n          \n            \n             * <pre>\n          \n          \n            \n             * @Component(service = WebSphereCDIExtensionMetaData.class)\n          \n          \n            \n             * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n          \n          \n            \n             *\n          \n          \n            \n             *     @Override\n          \n          \n            \n             *     public Set&lt;Class&lt;?&gt;&gt; getBeanClasses() {\n          \n          \n            \n             *         Set&lt;Class&lt;?&gt;&gt; beans = new HashSet&lt;Class&lt;?&gt;&gt;();\n          \n          \n            \n             *         //This will register a producer class and expose it's produced beans to applications\n          \n          \n            \n             *         beans.add(ClassSPIRegisteredProducer.class);\n          \n          \n            \n             *     }\n          \n          \n            \n             * }\n          \n          \n            \n             * </pre>\n          \n      \n    \n    \n  \n\nNeed to check this renders correctly when generated as html.", "author": "Azquelt", "createdAt": "2020-05-12T16:00:53Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.\n+ *\n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation.\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ *\n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQ3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423851470", "bodyText": "Unsure whether we can reference our test code from our SPI documentation.", "author": "Azquelt", "createdAt": "2020-05-12T16:01:28Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.\n+ *\n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation.\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ *\n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }\n+ *\n+ * A complete bundle that uses WebSphereCDIExtensionMetaData to register CDI beans can be found at:\n+ * com.ibm.ws.cdi.extension_fat/test-bundles/cdi.spi.extension/\n+ *\n+ * Note the files com.ibm.ws.cdi.extension_fat/cdi_spi_extension.bnd and com.ibm.ws.cdi.extension_fat/publish/features/cdi.spi.extension.mf\n+ * both of which are needed to include a bundle into liberty. com.ibm.ws.cdi.extension_fat/test-applications/SPIExtension.war/ contains a\n+ * simple app that injects the beans provided by cdi.spi.extension.", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NTYyMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423855622", "bodyText": "I think we need a better explanation of what \"registered with CDI\" means.\nE.g. Are the returned classes always treated as beans, or are they only treated as beans if they have a bean defining annotation.\nWould it be accurate to say \"classes returned from this method will be found by CDI during type discovery so that they can then be used as beans (or interceptors etc. if annotated as such) by the application.\"", "author": "Azquelt", "createdAt": "2020-05-12T16:07:35Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.\n+ *\n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation.\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ *\n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }\n+ *\n+ * A complete bundle that uses WebSphereCDIExtensionMetaData to register CDI beans can be found at:\n+ * com.ibm.ws.cdi.extension_fat/test-bundles/cdi.spi.extension/\n+ *\n+ * Note the files com.ibm.ws.cdi.extension_fat/cdi_spi_extension.bnd and com.ibm.ws.cdi.extension_fat/publish/features/cdi.spi.extension.mf\n+ * both of which are needed to include a bundle into liberty. com.ibm.ws.cdi.extension_fat/test-applications/SPIExtension.war/ contains a\n+ * simple app that injects the beans provided by cdi.spi.extension.\n+ */\n+\n+public interface CDIExtensionMetadata {\n+\n+    /**\n+     * All classes returned by this method will be registered with CDI. All classes must be in the same archive as your WebSphereCDIExtensionMetaData.\n+     */", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NzAxNQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423857015", "bodyText": "I'm not sure we need to say this as the method signature states that only classes extending Extension can be returned.\nIf we do want to say this, use\n@throws IllegalArgumentException if a class returned by this method does not implement javax.enterprise.inject.spi.Extension", "author": "Azquelt", "createdAt": "2020-05-12T16:09:31Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.\n+ *\n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation.\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ *\n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }\n+ *\n+ * A complete bundle that uses WebSphereCDIExtensionMetaData to register CDI beans can be found at:\n+ * com.ibm.ws.cdi.extension_fat/test-bundles/cdi.spi.extension/\n+ *\n+ * Note the files com.ibm.ws.cdi.extension_fat/cdi_spi_extension.bnd and com.ibm.ws.cdi.extension_fat/publish/features/cdi.spi.extension.mf\n+ * both of which are needed to include a bundle into liberty. com.ibm.ws.cdi.extension_fat/test-applications/SPIExtension.war/ contains a\n+ * simple app that injects the beans provided by cdi.spi.extension.\n+ */\n+\n+public interface CDIExtensionMetadata {\n+\n+    /**\n+     * All classes returned by this method will be registered with CDI. All classes must be in the same archive as your WebSphereCDIExtensionMetaData.\n+     */\n+    default public Set<Class<?>> getBeanClasses() {\n+        return Collections.emptySet();\n+    }\n+\n+    /**\n+     * All classes returned by this method will be treated as CDI extensions.\n+     *\n+     * If a class in returned by this method does not implement javax.enterprise.inject.spi.Extension an IllegalArguementException \n+     * is thrown.", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NzU1Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423857553", "bodyText": "You need to use <p> instead of a blank line to get a new paragraph when writing javadoc that's going to be rendered as HTML (which this will because it's SPI).", "author": "Azquelt", "createdAt": "2020-05-12T16:10:17Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *\n+ * To use this class you must implement one of the two methods. If you implement getBeanClasses() all classes returned by that\n+ * method will be registered with CDI and may be used normally by application code. If you implement getExtensions() then\n+ * all classes returned by that method will be treated as CDI extensions and run when creating the CDI container for each application.\n+ *\n+ * Classes returned from getExtensions() must implement javax.enterprise.inject.spi.Extension. They do *not* and should not be listed in a\n+ * META-INF/services file. It is best practice to not put CDIExtensionMetaData and javax.enterprise.inject.spi.Extension on the same class\n+ * as that would result in CDI and OSGI independently instantiating the class. Even though it is unlikely for the two instances to conflict, \n+ * it is best to keep the OSGI service and CDI extension separate. \n+ *\n+ * The class that implements this interface should be annotated with @Component(service = WebSphereCDIExtensionMetaData.class). There are no\n+ * other properties that can be included in the Component annotation.\n+ *\n+ * Here is a worked example of a complete WebSphereCDIExtensionMetaData implementation.\n+ *\n+ * @Component(service = WebSphereCDIExtensionMetaData.class)\n+ * public class SPIMetaData implements WebSphereCDIExtensionMetaData {\n+ *\n+ *     @Override\n+ *     public Set<Class<?>> getBeanClasses() {\n+ *         Set<Class<?>> beans = new HashSet<Class<?>>();\n+ *         //This will register a producer class and expose it's produced beans to applications\n+ *         beans.add(ClassSPIRegisteredProducer.class);\n+ *     }\n+ * }\n+ *\n+ * A complete bundle that uses WebSphereCDIExtensionMetaData to register CDI beans can be found at:\n+ * com.ibm.ws.cdi.extension_fat/test-bundles/cdi.spi.extension/\n+ *\n+ * Note the files com.ibm.ws.cdi.extension_fat/cdi_spi_extension.bnd and com.ibm.ws.cdi.extension_fat/publish/features/cdi.spi.extension.mf\n+ * both of which are needed to include a bundle into liberty. com.ibm.ws.cdi.extension_fat/test-applications/SPIExtension.war/ contains a\n+ * simple app that injects the beans provided by cdi.spi.extension.\n+ */\n+\n+public interface CDIExtensionMetadata {\n+\n+    /**\n+     * All classes returned by this method will be registered with CDI. All classes must be in the same archive as your WebSphereCDIExtensionMetaData.\n+     */\n+    default public Set<Class<?>> getBeanClasses() {\n+        return Collections.emptySet();\n+    }\n+\n+    /**\n+     * All classes returned by this method will be treated as CDI extensions.\n+     *", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1NzY2Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11943#discussion_r423857666", "bodyText": "You need to use <p> instead of a blank line to get a new paragraph when writing javadoc that's going to be rendered as HTML (which this will because it's SPI).", "author": "Azquelt", "createdAt": "2020-05-12T16:10:26Z", "path": "dev/com.ibm.ws.cdi.interfaces/src/com/ibm/wsspi/cdi/extension/WebSphereCDIExtensionMetaData.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*******************************************************************************\n+ * Copyright (c) 2015 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package io.openliberty.cdi.spi;\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+import javax.enterprise.inject.spi.Extension;\n+\n+/**\n+ * This is a *marker* interface for CDI Runtime extensions. Liberty features that wish to extend CDI will need to\n+ * register a service under this interface.\n+ *", "originalCommit": "ec608f76798ac644e8c1b70326bd74aee89b0625", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a29a7b3556f5ad2759941d221419afb841c961da", "url": "https://github.com/OpenLiberty/open-liberty/commit/a29a7b3556f5ad2759941d221419afb841c961da", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T16:45:31Z", "type": "forcePushed"}, {"oid": "ceefbf244307a2b350dad4325c1172844f1e38e6", "url": "https://github.com/OpenLiberty/open-liberty/commit/ceefbf244307a2b350dad4325c1172844f1e38e6", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T16:48:12Z", "type": "forcePushed"}, {"oid": "02976250417e171148b63d38e9511358ea4911b6", "url": "https://github.com/OpenLiberty/open-liberty/commit/02976250417e171148b63d38e9511358ea4911b6", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T16:53:06Z", "type": "forcePushed"}, {"oid": "cd0c67341a3e2df8bec01566f33800a54b84c7f9", "url": "https://github.com/OpenLiberty/open-liberty/commit/cd0c67341a3e2df8bec01566f33800a54b84c7f9", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T16:56:12Z", "type": "forcePushed"}, {"oid": "ba5194a4f492f234520bf48114a59ae5f24fb9a3", "url": "https://github.com/OpenLiberty/open-liberty/commit/ba5194a4f492f234520bf48114a59ae5f24fb9a3", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T17:03:22Z", "type": "forcePushed"}, {"oid": "d2451d03883ec42816e1f902b414ffda03028735", "url": "https://github.com/OpenLiberty/open-liberty/commit/d2451d03883ec42816e1f902b414ffda03028735", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T17:06:58Z", "type": "forcePushed"}, {"oid": "2d9f3d5a4f92e69fab8f4b401c72b2b79acda3c7", "url": "https://github.com/OpenLiberty/open-liberty/commit/2d9f3d5a4f92e69fab8f4b401c72b2b79acda3c7", "message": "create new CDIExtensionMetaData SPI", "committedDate": "2020-05-12T17:20:58Z", "type": "commit"}, {"oid": "dc8c9f147101410efef0ea843e74d5d3016c07a6", "url": "https://github.com/OpenLiberty/open-liberty/commit/dc8c9f147101410efef0ea843e74d5d3016c07a6", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-12T17:21:49Z", "type": "forcePushed"}, {"oid": "f36e7f02d89a549b04f3c6eaaa3ca99903450d28", "url": "https://github.com/OpenLiberty/open-liberty/commit/f36e7f02d89a549b04f3c6eaaa3ca99903450d28", "message": "Deprecate WebSphereCDIExtension", "committedDate": "2020-05-12T17:29:33Z", "type": "commit"}, {"oid": "615ec969c78fe5e8304bc82f6d899d7c45569e70", "url": "https://github.com/OpenLiberty/open-liberty/commit/615ec969c78fe5e8304bc82f6d899d7c45569e70", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-13T09:12:46Z", "type": "commit"}, {"oid": "615ec969c78fe5e8304bc82f6d899d7c45569e70", "url": "https://github.com/OpenLiberty/open-liberty/commit/615ec969c78fe5e8304bc82f6d899d7c45569e70", "message": "New test for CDI Extension SPI", "committedDate": "2020-05-13T09:12:46Z", "type": "forcePushed"}]}