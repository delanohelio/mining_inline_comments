{"pr_number": 13113, "pr_title": "AMR claim in liberty", "pr_createdAt": "2020-07-20T21:31:50Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/13113", "timeline": [{"oid": "b59b192840dadf61fd7e4d84605bd119c6db1eb6", "url": "https://github.com/OpenLiberty/open-liberty/commit/b59b192840dadf61fd7e4d84605bd119c6db1eb6", "message": "Interface changes to other files", "committedDate": "2020-07-21T01:05:37Z", "type": "forcePushed"}, {"oid": "b033536d4bf3f8d5ab32036140b640357ae642b3", "url": "https://github.com/OpenLiberty/open-liberty/commit/b033536d4bf3f8d5ab32036140b640357ae642b3", "message": "Fixed propertyNamings", "committedDate": "2020-07-21T23:23:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMzcwOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461823709", "bodyText": "Please consider using spaces instead of tabs and ensure correct spacing.", "author": "teddyjtorres", "createdAt": "2020-07-28T19:34:51Z", "path": "dev/com.ibm.ws.security.jwt/src/com/ibm/ws/security/jwt/internal/BuilderImpl.java", "diffHunk": "@@ -160,6 +164,14 @@ private void setClaimsUsingTheConfig(JwtConfig jwtConfig) throws InvalidBuilderE\n         if (jwtConfig.getSharedKey() != null) {\n             sharedKey = jwtConfig.getSharedKey();\n         }\n+        \n+        if (jwtConfig.getAMRAttributes() != null) {\n+        \ttry {", "originalCommit": "8550ee341ed627f6a1ac17beba5b3584115e2858", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyNDY0Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461824642", "bodyText": "Please consider using spaces instead of tabs and ensure correct spacing.", "author": "teddyjtorres", "createdAt": "2020-07-28T19:36:30Z", "path": "dev/com.ibm.ws.security.jwt/src/com/ibm/ws/security/jwt/internal/BuilderImpl.java", "diffHunk": "@@ -814,5 +826,36 @@ private Builder copyClaimsMap(Map<String, Object> map) throws InvalidClaimExcept\n         }\n         return this;\n     }\n+    \n+    /** \n+     * Checks the attributes provided exists in the subject, if so add it to the claims\n+     * as \"amr\" values\n+     * \n+     * @param amrAttr\n+     * @throws Exception\n+     */\n+    private void checkAmrAttrInSubject(List<String> amrAttr) throws Exception {\n+    \tSubject subj = WSSubject.getRunAsSubject();\n+    \tList<Object> amrValues= new ArrayList<Object>();\n+    \tif (subj != null) {\n+    \t\tWSCredential wscred = getWSCredential(subj);", "originalCommit": "8550ee341ed627f6a1ac17beba5b3584115e2858", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31b940926fec72f5ade10ad09db24ebd90b9b6ab", "url": "https://github.com/OpenLiberty/open-liberty/commit/31b940926fec72f5ade10ad09db24ebd90b9b6ab", "message": "Added all test for builder", "committedDate": "2020-07-30T21:31:44Z", "type": "forcePushed"}, {"oid": "7385ef949eb2f7537b64e7173959194349901524", "url": "https://github.com/OpenLiberty/open-liberty/commit/7385ef949eb2f7537b64e7173959194349901524", "message": "Fixed attr in the label", "committedDate": "2020-07-30T22:05:36Z", "type": "forcePushed"}, {"oid": "9ec7dceeff9772171433168ae796d502d05eda86", "url": "https://github.com/OpenLiberty/open-liberty/commit/9ec7dceeff9772171433168ae796d502d05eda86", "message": "Fixed attr in the label", "committedDate": "2020-07-30T22:11:04Z", "type": "forcePushed"}, {"oid": "db49fbf6f6cd3fc7ec4eae594189be0e36ef1f11", "url": "https://github.com/OpenLiberty/open-liberty/commit/db49fbf6f6cd3fc7ec4eae594189be0e36ef1f11", "message": "Fixed attr in the label", "committedDate": "2020-07-30T22:56:53Z", "type": "forcePushed"}, {"oid": "7f7934a0bd92f51a4562dd861b50201e922e9361", "url": "https://github.com/OpenLiberty/open-liberty/commit/7f7934a0bd92f51a4562dd861b50201e922e9361", "message": "Added all tests for builder", "committedDate": "2020-08-04T17:32:57Z", "type": "forcePushed"}, {"oid": "369d4c9a99ef9e327cd5852547cb3b6786ac335c", "url": "https://github.com/OpenLiberty/open-liberty/commit/369d4c9a99ef9e327cd5852547cb3b6786ac335c", "message": "Fixed spacing for API class", "committedDate": "2020-08-04T17:43:00Z", "type": "forcePushed"}, {"oid": "fa6a8e34152330f3326a03cec9539cd9e30356ef", "url": "https://github.com/OpenLiberty/open-liberty/commit/fa6a8e34152330f3326a03cec9539cd9e30356ef", "message": "Fixed spacing for API class", "committedDate": "2020-08-04T17:46:53Z", "type": "forcePushed"}, {"oid": "3608162f609dc7ba79a25cb66210cb89dd75040d", "url": "https://github.com/OpenLiberty/open-liberty/commit/3608162f609dc7ba79a25cb66210cb89dd75040d", "message": "Fixed spacing and copyright", "committedDate": "2020-08-04T18:14:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTI0OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461839249", "bodyText": "There is a potential for regression in this logic. A previous JWT that included an \"amr\" claim could have been accepted prior to these changes and it will now be rejected.\nPlease review if the intention is to make the amr claim optional if the jwtConsumer has not been configured with a list of AMRs to validate.", "author": "teddyjtorres", "createdAt": "2020-07-28T19:55:52Z", "path": "dev/com.ibm.ws.security.jwt/src/com/ibm/ws/security/jwt/internal/ConsumerUtil.java", "diffHunk": "@@ -687,5 +695,56 @@ String createDateString(NumericDate date) {\n \t\t// milliseconds\n \t\treturn timeUtils.createDateString(1000 * date.getValue());\n \t}\n+\t\n+\t/**\n+\t * Helper method to get the AMR Claim from the jwtClaims.This method checks\n+\t * if the value is a string and return singletonList or the ArrayList of\n+\t * amrClaims. This is called in validateClaims method\n+\t *\n+\t */\n+\tList<String> getJwtAMRList(JwtClaims jwtClaims) throws MalformedClaimException {\n+\t\tString claimName = \"amr\";\n+\t\tObject amrObject = jwtClaims.getClaimValue(claimName);\n+\t\tif (amrObject instanceof String) {\n+\t\t\treturn Collections.singletonList(jwtClaims.getStringClaimValue(claimName));\n+\t\t} else if (!(amrObject instanceof List) && amrObject != null) {\n+\t\t\tthrow new MalformedClaimException(\n+\t\t\t\t\t\"The value of the 'amr' claim is not an array of strings or a single string value.\");\n+\t\t} else {\n+\t\t\treturn jwtClaims.getStringListClaimValue(claimName);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Verifies that values specified in AMR claim is contained in the\n+\t * authenticationMethodsReferences list. If allowedAMRClaim is not an array\n+\t * then jwtClaims can contain more than required values. If not, then the\n+\t * jwtClaimvalues must be a exact match of an element in the array.\n+\t */\n+\tboolean validateAMRClaim(List<String> allowedAmrClaim, List<String> jwtAMRClaims) {\n+\t\tboolean valid = false;\n+\t\tif (allowedAmrClaim != null && jwtAMRClaims != null) {\n+\t\t\t// If it is not array just check if jwtClaim containsAll and not\n+\t\t\t// equals\n+\t\t\tif (allowedAmrClaim.size() == 1) {\n+\t\t\t\tList<String> allowedAMRSingle = Arrays.asList(allowedAmrClaim.get(0).split(\" \"));\n+\t\t\t\tif (jwtAMRClaims.containsAll(allowedAMRSingle)) {\n+\t\t\t\t\tvalid = true;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tfor (String allowedAMR : allowedAmrClaim) {\n+\t\t\t\t\tList<String> allowedAMRSingle = Arrays.asList(allowedAMR.split(\" \"));\n+\t\t\t\t\tif (jwtAMRClaims.equals(allowedAMRSingle)) {\n+\t\t\t\t\t\tvalid = true;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n+\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else if (allowedAmrClaim == null && (jwtAMRClaims == null || jwtAMRClaims.isEmpty())) {", "originalCommit": "8550ee341ed627f6a1ac17beba5b3584115e2858", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4ODA3Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461888072", "bodyText": "@chunlongliang-ibm This is a default behavior change. Is this what was intended?", "author": "teddyjtorres", "createdAt": "2020-07-28T21:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0MzM2OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r466643369", "bodyText": "This is a default behavior change and cannot be merged in as coded. A previous JWT that included an \"amr\" claim could have been accepted prior to these changes and it will now be rejected even when a consumer has not been configured with amrValues. Please ensure that a JWT that contains an amr claim is not rejected when amrValues is not configured.", "author": "teddyjtorres", "createdAt": "2020-08-06T19:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NzA1Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r466657056", "bodyText": "I can get rid of this code here and it would take that required part off. @chunlongliang-ibm can confirm if that is what it was intended", "author": "AlvinChacko", "createdAt": "2020-08-06T20:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1OTg0Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r466759846", "bodyText": "Fixed it in my new code. Although I have a logic that is if the amrConfig is not specified, then validation returns true. Which means if the amrConfig is specified and the jwt doesnt include amr then the validation will fail. Let me know if I need to add any logic there.", "author": "AlvinChacko", "createdAt": "2020-08-07T00:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzOTI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2NjkxOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461866919", "bodyText": "This new expectation might introduce a regression. A previous JWT that included an \"amr\" claim could have been accepted prior to these changes and it will now be rejected.\nPlease review if the intention is to make the amr claim optional if the jwtConsumer has not been configured with a list of AMRs to validate.", "author": "teddyjtorres", "createdAt": "2020-07-28T20:44:15Z", "path": "dev/com.ibm.ws.security.jwt/test/com/ibm/ws/security/jwt/internal/ConsumerUtilTest.java", "diffHunk": "@@ -1886,6 +1886,61 @@ public void testValidateAlgorithm_algMatch() {\n             outputMgr.failWithThrowable(testName.getMethodName(), t);\n         }\n     }\n+    \n+    /********************************************* validateAMRClaim *********************************************/\n+\n+    /**\n+     * Method under test: {@link ConsumerUtil#validateAMRClaim(List, List)}\n+     */\n+    @Test\n+    public void testValidateAMRClaim() {\n+        try {\n+            List<String> emptyList = new ArrayList<String>();\n+            List<String> singleList = new ArrayList<String>();\n+            singleList.add(\"OTP iris\");\n+            List<String> multipleList = new ArrayList<String>();\n+            multipleList.add(\"OTP iris\");\n+            multipleList.add(\"pwd kba\");\n+\n+            // Null/empty token and allowed amrClaims\n+            assertTrue(\"Validation should have succeeded.\", consumerUtil.validateAMRClaim(null, null));\n+            assertTrue(\"Validation should have succeeded.\", consumerUtil.validateAMRClaim(null, emptyList));\n+            assertFalse(\"Validation should NOT have succeeded.\", consumerUtil.validateAMRClaim(emptyList, null));\n+            assertFalse(\"Validation should NOT have succeeded.\", consumerUtil.validateAMRClaim(emptyList, emptyList));\n+\n+            // Null/empty allowed amr, single amr in the token\n+            assertFalse(\"Validation should NOT have succeeded.\", consumerUtil.validateAMRClaim(null, singleList));", "originalCommit": "8550ee341ed627f6a1ac17beba5b3584115e2858", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3Nzc5Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/13113#discussion_r461877797", "bodyText": "Test description is not consistent with the assertion being performed.", "author": "teddyjtorres", "createdAt": "2020-07-28T21:03:55Z", "path": "dev/com.ibm.ws.security.jwtsso_fat/fat/src/com/ibm/ws/security/jwtsso/fat/ConfigAttributeTests.java", "diffHunk": "@@ -759,4 +759,28 @@ public void test_sslPortNotDefined() throws Exception {\n         validationUtils.validateResult(response, currentAction, expectations);\n     }\n \n+    /**\n+     * Test that the jwtsso cookie respects the webAppSecurity httpOnlyCookies attribute setting.", "originalCommit": "8d9b4d9d9eb1d36e8a3b759288e8c6bc9dac6664", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b27a3c97bccc3fb6faeb2eae1821bd83072b26eb", "url": "https://github.com/OpenLiberty/open-liberty/commit/b27a3c97bccc3fb6faeb2eae1821bd83072b26eb", "message": "Review comments", "committedDate": "2020-08-17T20:59:47Z", "type": "forcePushed"}, {"oid": "131718a92c414e2bd53bfa8acaa345f283098603", "url": "https://github.com/OpenLiberty/open-liberty/commit/131718a92c414e2bd53bfa8acaa345f283098603", "message": "Added beta fencing", "committedDate": "2020-08-19T23:48:09Z", "type": "forcePushed"}, {"oid": "186b8f2ec5b7a033a9bc4520e9322fa001bdb990", "url": "https://github.com/OpenLiberty/open-liberty/commit/186b8f2ec5b7a033a9bc4520e9322fa001bdb990", "message": "Added beta fencing", "committedDate": "2020-08-19T23:51:50Z", "type": "forcePushed"}, {"oid": "1d187a2aa579af21017e8ddaefb8ebf74d9814e0", "url": "https://github.com/OpenLiberty/open-liberty/commit/1d187a2aa579af21017e8ddaefb8ebf74d9814e0", "message": "Intial commit", "committedDate": "2020-08-25T21:15:18Z", "type": "commit"}, {"oid": "6d845dc2a622049c2f0e19f2db51b1e1d37799e8", "url": "https://github.com/OpenLiberty/open-liberty/commit/6d845dc2a622049c2f0e19f2db51b1e1d37799e8", "message": "Added all test for consumer", "committedDate": "2020-08-25T21:23:53Z", "type": "commit"}, {"oid": "d2aceee598b27b7461f69967cbe4bbb8d49e469e", "url": "https://github.com/OpenLiberty/open-liberty/commit/d2aceee598b27b7461f69967cbe4bbb8d49e469e", "message": "Added all tests for builder", "committedDate": "2020-08-25T21:23:56Z", "type": "commit"}, {"oid": "27c861055b69e011692fc47ded1cfc2cdaf3372b", "url": "https://github.com/OpenLiberty/open-liberty/commit/27c861055b69e011692fc47ded1cfc2cdaf3372b", "message": "Fixed spacing and copyright", "committedDate": "2020-08-25T21:23:56Z", "type": "commit"}, {"oid": "b13effa6a351356b5f50769a88dad81f3be8310e", "url": "https://github.com/OpenLiberty/open-liberty/commit/b13effa6a351356b5f50769a88dad81f3be8310e", "message": "Review comments", "committedDate": "2020-08-25T21:23:56Z", "type": "commit"}, {"oid": "c815c9d52de3d1f0d0e58f26f4e0df8796bb7fff", "url": "https://github.com/OpenLiberty/open-liberty/commit/c815c9d52de3d1f0d0e58f26f4e0df8796bb7fff", "message": "Added beta fencing", "committedDate": "2020-08-25T21:24:54Z", "type": "commit"}, {"oid": "c815c9d52de3d1f0d0e58f26f4e0df8796bb7fff", "url": "https://github.com/OpenLiberty/open-liberty/commit/c815c9d52de3d1f0d0e58f26f4e0df8796bb7fff", "message": "Added beta fencing", "committedDate": "2020-08-25T21:24:54Z", "type": "forcePushed"}, {"oid": "eaaf25d7decca43883b9b8f13eef7ce1e4a9fd08", "url": "https://github.com/OpenLiberty/open-liberty/commit/eaaf25d7decca43883b9b8f13eef7ce1e4a9fd08", "message": "Error message number change", "committedDate": "2020-08-25T22:12:27Z", "type": "commit"}]}