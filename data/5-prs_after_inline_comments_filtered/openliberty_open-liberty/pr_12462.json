{"pr_number": 12462, "pr_title": "Only destroy the TCCL if we created it", "pr_createdAt": "2020-06-02T20:39:08Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/12462", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3ODk0Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12462#discussion_r434178947", "bodyText": "To make sure I understand the nature of this fix.  I think the problem could only occur if (newClassloaderHint !=null) because in that case the code above would wrapper the class loader in a Validation20ClassLoader instance and that would always force a replacement of the TCCL even if the expected TCCL instance was already set.  So that would force us to release the existing (previous) TCCL even though we may not have created it.  Is my understanding correct?", "author": "tjwatson", "createdAt": "2020-06-02T21:13:52Z", "path": "dev/com.ibm.ws.beanvalidation.v20.cdi/src/com/ibm/ws/beanvalidation/v20/cdi/internal/LibertyHibernateValidatorExtension.java", "diffHunk": "@@ -109,8 +110,8 @@ private ValidationExtension delegate(String newClassloaderHint) {\n                         Tr.debug(tc, \"Set Class loader back to \" + oldClassLoader);\n                     }\n                 }\n-                if (setClassLoader != null && setClassLoader.wasChanged) {\n-                    releaseLoader(tcclClassLoader);\n+                if (tuple != null && tuple.wasCreatedViaClassLoadingService) {", "originalCommit": "82ff485e629ba3e78a5e31771c7850ca3d807f68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1MzkxOQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12462#discussion_r434653919", "bodyText": "Yes, for sure that case, but it's also possible that the TCCL is inadvertently destroyed (without being created) in a case where the current thread's context classloader is set to anything other than AppClassLoader or ThreadContextClassLoader - so I think it could occur when the thread's context classloader is set to an OSGi loader like \"ContextFinder\", etc.", "author": "andymc12", "createdAt": "2020-06-03T15:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3ODk0Nw=="}], "type": "inlineReview"}, {"oid": "54f51a5f813e6ca75d66fd34c1386e117b36fba3", "url": "https://github.com/OpenLiberty/open-liberty/commit/54f51a5f813e6ca75d66fd34c1386e117b36fba3", "message": "Only destroy the TCCL if we created it", "committedDate": "2020-06-03T15:24:18Z", "type": "commit"}, {"oid": "54f51a5f813e6ca75d66fd34c1386e117b36fba3", "url": "https://github.com/OpenLiberty/open-liberty/commit/54f51a5f813e6ca75d66fd34c1386e117b36fba3", "message": "Only destroy the TCCL if we created it", "committedDate": "2020-06-03T15:24:18Z", "type": "forcePushed"}, {"oid": "b86a75f27fb70da005e85bcf18fda62ba5809e4c", "url": "https://github.com/OpenLiberty/open-liberty/commit/b86a75f27fb70da005e85bcf18fda62ba5809e4c", "message": "Refactor to catch more places where destroy could occur w/o create", "committedDate": "2020-06-04T15:16:12Z", "type": "commit"}, {"oid": "b86a75f27fb70da005e85bcf18fda62ba5809e4c", "url": "https://github.com/OpenLiberty/open-liberty/commit/b86a75f27fb70da005e85bcf18fda62ba5809e4c", "message": "Refactor to catch more places where destroy could occur w/o create", "committedDate": "2020-06-04T15:16:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3MjMyNw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12462#discussion_r435972327", "bodyText": "I think this check is a duplicate of the check done in AbstractBeanValidation.instance().releaseLoader(tuple).", "author": "nmittles", "createdAt": "2020-06-05T14:48:18Z", "path": "dev/com.ibm.ws.beanvalidation.core/src/com/ibm/ws/beanvalidation/ValidatorFactoryAccessor.java", "diffHunk": "@@ -240,8 +241,8 @@ public static ValidatorFactory getValidatorFactory(ClassLoader classLoader, bool\n                     Tr.debug(tc, \"Set Class loader back to \" + oldClassLoader);\n                 }\n             }\n-            if (setClassLoader != null && setClassLoader.wasChanged) {\n-                AbstractBeanValidation.instance().releaseLoader(classLoader);\n+            if (tuple != null && tuple.wasCreatedViaClassLoadingService) {", "originalCommit": "b86a75f27fb70da005e85bcf18fda62ba5809e4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEwODI5MQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/12462#discussion_r436108291", "bodyText": "We'll plan to fix the 1.1 classes in a followup PR - we can remove the extra check in that PR too.  Thanks for the reviews!", "author": "andymc12", "createdAt": "2020-06-05T18:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3MjMyNw=="}], "type": "inlineReview"}]}