{"pr_number": 11336, "pr_title": "Improving timeout message for TCK FATs", "pr_createdAt": "2020-03-16T19:06:12Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/11336", "timeline": [{"oid": "02ade1cc4be7f52488ae6f47d0daa3484d3f44ff", "url": "https://github.com/OpenLiberty/open-liberty/commit/02ade1cc4be7f52488ae6f47d0daa3484d3f44ff", "message": "Draft 1", "committedDate": "2020-03-16T19:04:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1NzM5Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r393257393", "bodyText": "is fat.timeout always guaranteed to be set? May want to default to some high number if unset", "author": "aguibert", "createdAt": "2020-03-16T19:17:00Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,14 +980,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n+\n+        int hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));", "originalCommit": "02ade1cc4be7f52488ae6f47d0daa3484d3f44ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1NzQ0Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r393257447", "bodyText": "this line can be removed", "author": "aguibert", "createdAt": "2020-03-16T19:17:07Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,14 +980,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n+\n+        int hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));\n+        long softTimeout = -1;\n+        long startTime = System.currentTimeMillis();\n+\n+        // We need to ensure that the hard timeout is large enough to avoid future issues\n+        if (hardTimeout >= 30000) {\n+            softTimeout = hardTimeout - 10000; // Soft timeout is 10 seconds less than hard timeout\n+            //softTimeout = 1000;   //ONLY FOR TESTING REMOVE THIS LINE WHEN COMPLETE", "originalCommit": "02ade1cc4be7f52488ae6f47d0daa3484d3f44ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1OTI2MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r393259260", "bodyText": "Instead of this code, we can use p.waitFor(long timeout, TimeUnit units) which was introduced in Java 8. Now that we no longer have to support Java 7 we can use this new java 8 method. If p.waitFor(long,TimeUnit) returns false (i.e. the timeout was reached) then we can report a failure and IIRC the relevant logs will be automatically included", "author": "aguibert", "createdAt": "2020-03-16T19:21:04Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,14 +980,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n+\n+        int hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));\n+        long softTimeout = -1;\n+        long startTime = System.currentTimeMillis();\n+\n+        // We need to ensure that the hard timeout is large enough to avoid future issues\n+        if (hardTimeout >= 30000) {\n+            softTimeout = hardTimeout - 10000; // Soft timeout is 10 seconds less than hard timeout\n+            //softTimeout = 1000;   //ONLY FOR TESTING REMOVE THIS LINE WHEN COMPLETE\n+        }\n+\n         Process p = pb.start();\n-        int exitCode = p.waitFor();\n+        int exitCode = -1;\n+        if (softTimeout > -1) {\n+            boolean exitStatus = false;\n+            boolean softTimeOutFailed = false;\n+            while (!exitStatus) {\n+                try {\n+                    exitCode = p.exitValue();\n+                    exitStatus = true;\n+                } catch (IllegalThreadStateException e) {\n+                    if ((System.currentTimeMillis() - startTime > softTimeout) && !softTimeOutFailed) {\n+                        // Parse through the MVN logs for potential networking issues\n+                        if (outputFile.exists() && outputFile.canRead()) {\n+                            try (Scanner s = new Scanner(outputFile)) {\n+                                // Get the last two lines from the MVN log\n+                                String lastLine = \"\";\n+                                String secondLastLine = \"\"; \n+                                while (s.hasNextLine()) {\n+                                    secondLastLine = lastLine;\n+                                    lastLine = s.nextLine().toLowerCase();\n+                                }\n+                                // Check if the last or second line has the text \"downloading\" or \"downloaded\"\n+                                // Throw custom timeout error rather then the one provided by the JUnitTask\n+                                if ((lastLine.contains(\"downloaded\") || lastLine.contains(\"downloading\")) || (secondLastLine.contains(\"downloaded\") || secondLastLine.contains(\"downloading\"))) {       \n+                                    String timeoutMsg = \"Timeout occurred. FAT timeout set to: \" + System.getProperty(\"fat.timeout\") + \n+                                                    \". It appears there were some issues gathering dependencies. This may be due to network issues such as slow download speeds.\";\n+                                    Log.info(c, \"runCmd\", timeoutMsg);\n+                                    throw new AssertionFailedError(timeoutMsg);\n+                                }\n+                                softTimeOutFailed = true;\n+                            } catch (FileNotFoundException FileError) {\n+                                // Do nothing as we can't look at the MVN log. This leads to hard timeout handled by JUnitTask.\n+                                softTimeOutFailed = true;\n+                            }\n+                        }\n+                    }\n+                }", "originalCommit": "02ade1cc4be7f52488ae6f47d0daa3484d3f44ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1c66a128a5288a18155e8447a7cd280481c4786", "url": "https://github.com/OpenLiberty/open-liberty/commit/b1c66a128a5288a18155e8447a7cd280481c4786", "message": "Intercept TCK FAT timeout to display better messages", "committedDate": "2020-03-19T16:18:17Z", "type": "commit"}, {"oid": "5de5d2d4ed4b392a004006a7565b0e8395b1b2f5", "url": "https://github.com/OpenLiberty/open-liberty/commit/5de5d2d4ed4b392a004006a7565b0e8395b1b2f5", "message": "Intercept TCK FAT timeout to display better messages", "committedDate": "2020-03-19T16:20:35Z", "type": "commit"}, {"oid": "14af1e47091f36df659033ea3409c5251a9d2a67", "url": "https://github.com/OpenLiberty/open-liberty/commit/14af1e47091f36df659033ea3409c5251a9d2a67", "message": "Intercept TCK FAT timeout to display better messages", "committedDate": "2020-03-19T16:29:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2MTk0Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395161946", "bodyText": "instead of catching an exception here you can use System.getProperty(\"fat.timeout\", \"10800000\") where the 2nd param is the default value if no sys prop is found", "author": "aguibert", "createdAt": "2020-03-19T16:34:57Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,12 +981,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n-        Process p = pb.start();\n-        int exitCode = p.waitFor();\n-        return exitCode;\n+        \n+        int hardTimeout;\n+        \n+        try {\n+            hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));", "originalCommit": "14af1e47091f36df659033ea3409c5251a9d2a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2NTkyMw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395165923", "bodyText": "Lets just include the last 5-10 lines of the output file no matter what, instead of special casing it for the last lines containing certain words.", "author": "aguibert", "createdAt": "2020-03-19T16:40:31Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,12 +981,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n-        Process p = pb.start();\n-        int exitCode = p.waitFor();\n-        return exitCode;\n+        \n+        int hardTimeout;\n+        \n+        try {\n+            hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));\n+        }catch (NumberFormatException e) {\n+            hardTimeout = 10800000;  // 10800000ms = 3hr\n+        }\n+        \n+        long softTimeout = -1;\n \n+        // We need to ensure that the hard timeout is large enough to avoid future issues\n+        if (hardTimeout >= 30000) {\n+            softTimeout = hardTimeout - 15000; // Soft timeout is 15 seconds less than hard timeout\n+        }\n+\n+        Process p = pb.start();\n+        int returnCode = 1;\n+        boolean returnStatus;\n+        if (softTimeout > -1) {\n+            returnStatus = p.waitFor(softTimeout, TimeUnit.MILLISECONDS);  // Requires Java 8+\n+            if (returnStatus == false) {\n+                // Parse through the MVN logs for potential networking issues\n+                if (outputFile.exists() && outputFile.canRead()) {\n+                    try (Scanner s = new Scanner(outputFile)) {\n+                        // Get the last two lines from the MVN log\n+                        String lastLine = \"\";\n+                        String secondLastLine = \"\"; \n+                        while (s.hasNextLine()) {\n+                            secondLastLine = lastLine;\n+                            lastLine = s.nextLine().toLowerCase();\n+                        }\n+                        // Check if the last or second line has the text \"downloading\" or \"downloaded\"\n+                        // Throw custom timeout error rather then the one provided by the JUnitTask\n+                        if ((lastLine.contains(\"downloaded\") || lastLine.contains(\"downloading\")) || (secondLastLine.contains(\"downloaded\") || secondLastLine.contains(\"downloading\"))) {       \n+                            String timeoutMsg = \"Timeout occurred. FAT timeout set to: \" + hardTimeout + \n+                                                \". It appears there were some issues gathering dependencies. This may be due to network issues such as slow download speeds.\";\n+                            Log.info(c, \"runCmd\", timeoutMsg);  // Log the timeout message into messages.log or the default log \n+                            throw new AssertionFailedError(timeoutMsg);\n+                        }", "originalCommit": "14af1e47091f36df659033ea3409c5251a9d2a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI2NzQ4OQ==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395267489", "bodyText": "Last 7 line will be included in all cases. Special cases will be left in.", "author": "lamkavan", "createdAt": "2020-03-19T19:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2NTkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2ODI3MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395168270", "bodyText": "I think we should remove this line and just let the test blow up with the soft timeout regardless of what keywords were found in the last few lines of the output", "author": "aguibert", "createdAt": "2020-03-19T16:43:54Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,12 +981,64 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n-        Process p = pb.start();\n-        int exitCode = p.waitFor();\n-        return exitCode;\n+        \n+        int hardTimeout;\n+        \n+        try {\n+            hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\"));\n+        }catch (NumberFormatException e) {\n+            hardTimeout = 10800000;  // 10800000ms = 3hr\n+        }\n+        \n+        long softTimeout = -1;\n \n+        // We need to ensure that the hard timeout is large enough to avoid future issues\n+        if (hardTimeout >= 30000) {\n+            softTimeout = hardTimeout - 15000; // Soft timeout is 15 seconds less than hard timeout\n+        }\n+\n+        Process p = pb.start();\n+        int returnCode = 1;\n+        boolean returnStatus;\n+        if (softTimeout > -1) {\n+            returnStatus = p.waitFor(softTimeout, TimeUnit.MILLISECONDS);  // Requires Java 8+\n+            if (returnStatus == false) {\n+                // Parse through the MVN logs for potential networking issues\n+                if (outputFile.exists() && outputFile.canRead()) {\n+                    try (Scanner s = new Scanner(outputFile)) {\n+                        // Get the last two lines from the MVN log\n+                        String lastLine = \"\";\n+                        String secondLastLine = \"\"; \n+                        while (s.hasNextLine()) {\n+                            secondLastLine = lastLine;\n+                            lastLine = s.nextLine().toLowerCase();\n+                        }\n+                        // Check if the last or second line has the text \"downloading\" or \"downloaded\"\n+                        // Throw custom timeout error rather then the one provided by the JUnitTask\n+                        if ((lastLine.contains(\"downloaded\") || lastLine.contains(\"downloading\")) || (secondLastLine.contains(\"downloaded\") || secondLastLine.contains(\"downloading\"))) {       \n+                            String timeoutMsg = \"Timeout occurred. FAT timeout set to: \" + hardTimeout + \n+                                                \". It appears there were some issues gathering dependencies. This may be due to network issues such as slow download speeds.\";\n+                            Log.info(c, \"runCmd\", timeoutMsg);  // Log the timeout message into messages.log or the default log \n+                            throw new AssertionFailedError(timeoutMsg);\n+                        }\n+                    } catch (FileNotFoundException FileError) {\n+                        // Do nothing as we can't look at the MVN log. This leads to hard timeout handled by JUnitTask.\n+                    }\n+                }\n+                // If the timeout is not for a reason we checked above then return to normal behavior and let it timeout through the Junit Task\n+                returnCode = p.waitFor();", "originalCommit": "14af1e47091f36df659033ea3409c5251a9d2a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI2Njk1Mg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395266952", "bodyText": "We need to leave this line in as we will need to revert back to default behavior if we can not read/open the output file. However, the behavior has been changed so that as long as we can read/open the output file the soft timeout will be used and our custom timeout message will be used.", "author": "lamkavan", "createdAt": "2020-03-19T19:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE2ODI3MA=="}], "type": "inlineReview"}, {"oid": "101a4b1f839bf9a4699f56206122892a30273494", "url": "https://github.com/OpenLiberty/open-liberty/commit/101a4b1f839bf9a4699f56206122892a30273494", "message": "Intercept TCK FAT timeout to display better messages", "committedDate": "2020-03-19T19:47:19Z", "type": "commit"}, {"oid": "be4d726373c9d1819d38f5060cc0b3d3d728aa3e", "url": "https://github.com/OpenLiberty/open-liberty/commit/be4d726373c9d1819d38f5060cc0b3d3d728aa3e", "message": "Intercept TCK FAT timeout to display better messages", "committedDate": "2020-03-19T19:52:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMDE5MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395730190", "bodyText": "does each line of mvn output have a \\n char at the end already?", "author": "aguibert", "createdAt": "2020-03-20T15:53:20Z", "path": "dev/fattest.simplicity/src/componenttest/topology/utils/MvnUtils.java", "diffHunk": "@@ -979,10 +981,67 @@ public static int runCmd(String[] cmd, File workingDirectory, File outputFile) t\n         pb.redirectErrorStream(true);\n \n         Log.info(c, \"runCmd\", \"Running command \" + Arrays.asList(cmd));\n-        Process p = pb.start();\n-        int exitCode = p.waitFor();\n-        return exitCode;\n+        \n+        int  hardTimeout = Integer.parseInt(System.getProperty(\"fat.timeout\", \"10800000\"));\n+        long softTimeout = -1;\n+\n+        // We need to ensure that the hard timeout is large enough to avoid future issues\n+        if (hardTimeout >= 30000) {\n+            softTimeout = hardTimeout - 15000; // Soft timeout is 15 seconds less than hard timeout\n+        }\n \n+        Process p = pb.start();\n+        int returnCode = 1;\n+        boolean returnStatus;\n+        if (softTimeout > -1) {\n+            returnStatus = p.waitFor(softTimeout, TimeUnit.MILLISECONDS);  // Requires Java 8+\n+            if (returnStatus == false) {\n+                // Parse through the mvn logs\n+                if (outputFile.exists() && outputFile.canRead()) {\n+                    try (Scanner s = new Scanner(outputFile)) {\n+                        // Get the last few lines from the MVN log\n+                        ArrayList<String> lastLines = new ArrayList<String>();\n+                        int numOfLinesToInclude = 7;  // We will include the last 7 lines of the output file in the timeout message\n+                        while (s.hasNextLine()) {\n+                            if (lastLines.size() < numOfLinesToInclude) {\n+                                lastLines.add(s.nextLine());\n+                            } else {\n+                                lastLines.remove(0);\n+                                lastLines.add(s.nextLine());\n+                            }\n+                        }\n+                        \n+                        // Prepare the timeout message\n+                        String timeoutMsg = \"Timeout occurred. FAT timeout set to: \" + hardTimeout + \"ms (soft timeout set to \" + softTimeout + \"ms). The last \" +\n+                                            numOfLinesToInclude + \" lines from the mvn logs are as follows:\\n\";\n+                        for (String line : lastLines) {\n+                            timeoutMsg += line + \"\\n\";", "originalCommit": "be4d726373c9d1819d38f5060cc0b3d3d728aa3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NDE4Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/11336#discussion_r395744187", "bodyText": "Checked locally and it appears there isn't \\n included when using nextLine()", "author": "lamkavan", "createdAt": "2020-03-20T16:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMDE5MA=="}], "type": "inlineReview"}]}