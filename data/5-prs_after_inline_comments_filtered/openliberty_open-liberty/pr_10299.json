{"pr_number": 10299, "pr_title": "Persistant Timers Demo Application", "pr_createdAt": "2020-01-06T21:30:50Z", "pr_url": "https://github.com/OpenLiberty/open-liberty/pull/10299", "timeline": [{"oid": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "url": "https://github.com/OpenLiberty/open-liberty/commit/853fea0cb6748d989cb49f84513c117d60e9f5e6", "message": "Timers demo app", "committedDate": "2020-01-06T21:32:54Z", "type": "commit"}, {"oid": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "url": "https://github.com/OpenLiberty/open-liberty/commit/853fea0cb6748d989cb49f84513c117d60e9f5e6", "message": "Timers demo app", "committedDate": "2020-01-06T21:32:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwMDcxMg==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363500712", "bodyText": "minor: mix of tabs and spaces in this file and a few other files causes indentation to appear off", "author": "njr-11", "createdAt": "2020-01-06T21:52:26Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/fat/src/com/ibm/ws/concurrent/persistent/fat/demo/timers/DemoTimerTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+\n+package com.ibm.ws.concurrent.persistent.fat.demo.timers;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.runner.RunWith;\n+import org.testcontainers.containers.JdbcDatabaseContainer;\n+\n+import com.ibm.websphere.simplicity.ShrinkHelper;\n+\n+import componenttest.annotation.Server;\n+import componenttest.annotation.TestServlet;\n+import componenttest.custom.junit.runner.FATRunner;\n+import componenttest.topology.database.container.DatabaseContainerFactory;\n+import componenttest.topology.database.container.DatabaseContainerType;\n+import componenttest.topology.database.container.DatabaseContainerUtil;\n+import componenttest.topology.impl.LibertyServer;\n+import componenttest.topology.utils.FATServletClient;\n+import ejb.timers.PersistentDemoTimersServlet;\n+\n+/**\n+ * This test suite start's an application that has automated timers, \n+ * and scheduled timers that will perform some sort of in memory data manipulation.\n+ * This is to simulate the situation where customers use timers to do something\n+ * like unit conversions, data processing, etc. \n+ * \n+ * These timers will run every half second.  That sort of frequency is the \n+ * maximum we would ever expect a customer to run a timer that is doing \n+ * in memory work.\n+ */\n+@RunWith(FATRunner.class)\n+public class DemoTimerTest extends FATServletClient {\n+\n+\tpublic static final String APP_NAME = \"demotimer\";", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwMjg3Mw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363502873", "bodyText": "I think this comment is wrong.  The code later in this class is for every 30 seconds, not 2.", "author": "njr-11", "createdAt": "2020-01-06T21:58:08Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/AutomaticDatabase.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.Schedule;\n+import javax.ejb.SessionContext;\n+import javax.ejb.Singleton;\n+import javax.ejb.Timer;\n+import javax.sql.DataSource;\n+\n+/**\n+ * This class uses the @Schedule annotation.\n+ * Using this annotation will start the timer immediately on start and will run every 2 seconds. ", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwMzYwNA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363503604", "bodyText": "An error here ought to fail the test", "author": "njr-11", "createdAt": "2020-01-06T22:00:03Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/AutomaticDatabase.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.Schedule;\n+import javax.ejb.SessionContext;\n+import javax.ejb.Singleton;\n+import javax.ejb.Timer;\n+import javax.sql.DataSource;\n+\n+/**\n+ * This class uses the @Schedule annotation.\n+ * Using this annotation will start the timer immediately on start and will run every 2 seconds. \n+ */\n+@Singleton\n+public class AutomaticDatabase {\n+\t@Resource\n+    private SessionContext sessionContext; //Used to get information about timer\n+    \n+    @Resource(name = \"DefaultDatasource\") //Datasource used to create a new table\n+    private DataSource ds;\n+    \n+    private int count = -1; //Incremented with each execution of timer\n+    \n+    private boolean isTableCreated = false;\n+    \n+    /**\n+     * Cancels timer execution\n+     */\n+    public void cancel() {\n+        for (Timer timer : sessionContext.getTimerService().getTimers())\n+            timer.cancel();\n+    }\n+\n+    /**\n+     * Get the value of count.\n+     */\n+    public int getRunCount() {\n+        return count;\n+    }\n+    \n+    /**\n+     * Runs ever 30 seconds.  Automatically starts when application starts. \n+     */\n+    @Schedule(info = \"Performing Database Operations\", hour = \"*\", minute = \"*\", second = \"*/30\")\n+    public void run(Timer timer) {\n+    \tif(!isTableCreated)\n+    \t\tinitTable();\n+    \t\n+        System.out.println(\"Running execution \" + incrementCount(timer) + \" of timer \" + timer.getInfo());\n+    }\n+    \n+    private void initTable() {\n+    \tfinal String createTable = \"CREATE TABLE AutomaticDatabase (name VARCHAR(64) NOT NULL PRIMARY KEY, count INT)\";\n+    \t\n+    \ttry (Connection conn = ds.getConnection()) {\n+    \t\t//See if table was created by another server\n+        \tDatabaseMetaData md = conn.getMetaData();\n+        \tResultSet rs = md.getTables(null, null, \"AutomaticDatabase\", null);\n+        \twhile(rs.next()) {\n+        \t\tisTableCreated = true;\n+        \t\treturn;\n+        \t}\n+    \t\t\n+    \t\t//If not, create it.    \t\t\n+    \t\ttry (PreparedStatement pstmt= conn.prepareStatement(createTable)) {\n+    \t\t\tpstmt.executeUpdate();\n+    \t\t}\n+    \t\tisTableCreated = true;\n+    \t} catch (SQLException e) {\n+\t\t\te.printStackTrace();", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwNDY0OA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363504648", "bodyText": "Should fail the test instead of suppressing the error, unless there is any reason why init logic is expected to fail and need a retry.", "author": "njr-11", "createdAt": "2020-01-06T22:02:56Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/AutomaticDatabase.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.Schedule;\n+import javax.ejb.SessionContext;\n+import javax.ejb.Singleton;\n+import javax.ejb.Timer;\n+import javax.sql.DataSource;\n+\n+/**\n+ * This class uses the @Schedule annotation.\n+ * Using this annotation will start the timer immediately on start and will run every 2 seconds. \n+ */\n+@Singleton\n+public class AutomaticDatabase {\n+\t@Resource\n+    private SessionContext sessionContext; //Used to get information about timer\n+    \n+    @Resource(name = \"DefaultDatasource\") //Datasource used to create a new table\n+    private DataSource ds;\n+    \n+    private int count = -1; //Incremented with each execution of timer\n+    \n+    private boolean isTableCreated = false;\n+    \n+    /**\n+     * Cancels timer execution\n+     */\n+    public void cancel() {\n+        for (Timer timer : sessionContext.getTimerService().getTimers())\n+            timer.cancel();\n+    }\n+\n+    /**\n+     * Get the value of count.\n+     */\n+    public int getRunCount() {\n+        return count;\n+    }\n+    \n+    /**\n+     * Runs ever 30 seconds.  Automatically starts when application starts. \n+     */\n+    @Schedule(info = \"Performing Database Operations\", hour = \"*\", minute = \"*\", second = \"*/30\")\n+    public void run(Timer timer) {\n+    \tif(!isTableCreated)\n+    \t\tinitTable();\n+    \t\n+        System.out.println(\"Running execution \" + incrementCount(timer) + \" of timer \" + timer.getInfo());\n+    }\n+    \n+    private void initTable() {\n+    \tfinal String createTable = \"CREATE TABLE AutomaticDatabase (name VARCHAR(64) NOT NULL PRIMARY KEY, count INT)\";\n+    \t\n+    \ttry (Connection conn = ds.getConnection()) {\n+    \t\t//See if table was created by another server\n+        \tDatabaseMetaData md = conn.getMetaData();\n+        \tResultSet rs = md.getTables(null, null, \"AutomaticDatabase\", null);\n+        \twhile(rs.next()) {\n+        \t\tisTableCreated = true;\n+        \t\treturn;\n+        \t}\n+    \t\t\n+    \t\t//If not, create it.    \t\t\n+    \t\ttry (PreparedStatement pstmt= conn.prepareStatement(createTable)) {\n+    \t\t\tpstmt.executeUpdate();\n+    \t\t}\n+    \t\tisTableCreated = true;\n+    \t} catch (SQLException e) {\n+\t\t\te.printStackTrace();\n+\t\t}\n+    }\n+    \n+    private void initCounter(Timer timer) {\n+    \tfinal String createRow = \"INSERT INTO AutomaticDatabase VALUES(?,?)\";\n+    \t\n+    \t//create count\n+    \tcount = 1;\n+    \t\n+    \ttry (Connection conn = ds.getConnection()) {\n+    \t\ttry (PreparedStatement pstmt = conn.prepareStatement(createRow)) {\n+    \t\t\tpstmt.setString(1, timer.getInfo().toString());\n+    \t\t\tpstmt.setInt(2, count);\n+    \t\t\tpstmt.execute();\n+    \t\t}\n+    \t} catch (SQLException e) {\n+    \t\tcount = -1;\n+\t\t\te.printStackTrace();", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwNTY2MA==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363505660", "bodyText": "Should pre-populating the row just be part of initTable?", "author": "njr-11", "createdAt": "2020-01-06T22:05:52Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/AutomaticDatabase.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.Schedule;\n+import javax.ejb.SessionContext;\n+import javax.ejb.Singleton;\n+import javax.ejb.Timer;\n+import javax.sql.DataSource;\n+\n+/**\n+ * This class uses the @Schedule annotation.\n+ * Using this annotation will start the timer immediately on start and will run every 2 seconds. \n+ */\n+@Singleton\n+public class AutomaticDatabase {\n+\t@Resource\n+    private SessionContext sessionContext; //Used to get information about timer\n+    \n+    @Resource(name = \"DefaultDatasource\") //Datasource used to create a new table\n+    private DataSource ds;\n+    \n+    private int count = -1; //Incremented with each execution of timer\n+    \n+    private boolean isTableCreated = false;\n+    \n+    /**\n+     * Cancels timer execution\n+     */\n+    public void cancel() {\n+        for (Timer timer : sessionContext.getTimerService().getTimers())\n+            timer.cancel();\n+    }\n+\n+    /**\n+     * Get the value of count.\n+     */\n+    public int getRunCount() {\n+        return count;\n+    }\n+    \n+    /**\n+     * Runs ever 30 seconds.  Automatically starts when application starts. \n+     */\n+    @Schedule(info = \"Performing Database Operations\", hour = \"*\", minute = \"*\", second = \"*/30\")\n+    public void run(Timer timer) {\n+    \tif(!isTableCreated)\n+    \t\tinitTable();\n+    \t\n+        System.out.println(\"Running execution \" + incrementCount(timer) + \" of timer \" + timer.getInfo());\n+    }\n+    \n+    private void initTable() {\n+    \tfinal String createTable = \"CREATE TABLE AutomaticDatabase (name VARCHAR(64) NOT NULL PRIMARY KEY, count INT)\";\n+    \t\n+    \ttry (Connection conn = ds.getConnection()) {\n+    \t\t//See if table was created by another server\n+        \tDatabaseMetaData md = conn.getMetaData();\n+        \tResultSet rs = md.getTables(null, null, \"AutomaticDatabase\", null);\n+        \twhile(rs.next()) {\n+        \t\tisTableCreated = true;\n+        \t\treturn;\n+        \t}\n+    \t\t\n+    \t\t//If not, create it.    \t\t\n+    \t\ttry (PreparedStatement pstmt= conn.prepareStatement(createTable)) {\n+    \t\t\tpstmt.executeUpdate();\n+    \t\t}\n+    \t\tisTableCreated = true;\n+    \t} catch (SQLException e) {\n+\t\t\te.printStackTrace();\n+\t\t}\n+    }\n+    \n+    private void initCounter(Timer timer) {", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMDg3Nw==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363510877", "bodyText": "I think it is getting the wrong EJB here. Probably meant \"AutomaticMemory\"", "author": "njr-11", "createdAt": "2020-01-06T22:20:31Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/PersistentDemoTimersServlet.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.EJB;\n+import javax.servlet.annotation.WebServlet;\n+import javax.transaction.UserTransaction;\n+\n+import org.junit.Test;\n+\n+import componenttest.app.FATServlet;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+\n+@SuppressWarnings(\"serial\")\n+@WebServlet(\"/*\")\n+public class PersistentDemoTimersServlet extends FATServlet {\n+\n+    /**\n+     * Interval in milliseconds between polling for task results.\n+     */\n+    private static final long POLL_INTERVAL = 200;\n+\n+    @EJB\n+    private AutomaticDatabase autoTimerDatabase;\n+    \n+    @EJB\n+    private AutomaticDatabase autoTimerMemory;", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUxMTA3Ng==", "url": "https://github.com/OpenLiberty/open-liberty/pull/10299#discussion_r363511076", "bodyText": "Also getting the wrong EJB here. Probably intended \"AutomaticId\"", "author": "njr-11", "createdAt": "2020-01-06T22:21:02Z", "path": "dev/com.ibm.ws.concurrent.persistent_fat_demo_timers/test-application/demotimers/src/ejb/timers/PersistentDemoTimersServlet.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package ejb.timers;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Resource;\n+import javax.ejb.EJB;\n+import javax.servlet.annotation.WebServlet;\n+import javax.transaction.UserTransaction;\n+\n+import org.junit.Test;\n+\n+import componenttest.app.FATServlet;\n+import componenttest.custom.junit.runner.Mode;\n+import componenttest.custom.junit.runner.Mode.TestMode;\n+\n+@SuppressWarnings(\"serial\")\n+@WebServlet(\"/*\")\n+public class PersistentDemoTimersServlet extends FATServlet {\n+\n+    /**\n+     * Interval in milliseconds between polling for task results.\n+     */\n+    private static final long POLL_INTERVAL = 200;\n+\n+    @EJB\n+    private AutomaticDatabase autoTimerDatabase;\n+    \n+    @EJB\n+    private AutomaticDatabase autoTimerMemory;\n+\n+    @EJB\n+    private AutomaticDatabase autoTimerIO;", "originalCommit": "853fea0cb6748d989cb49f84513c117d60e9f5e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f13e9755d4736585cab62800099cffa97a7b0a2", "url": "https://github.com/OpenLiberty/open-liberty/commit/9f13e9755d4736585cab62800099cffa97a7b0a2", "message": "Feedback Changes", "committedDate": "2020-01-07T15:34:26Z", "type": "commit"}]}