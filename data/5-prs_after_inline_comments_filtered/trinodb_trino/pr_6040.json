{"pr_number": 6040, "pr_title": "Require calling convention for scalar functions", "pr_createdAt": "2020-11-21T20:51:34Z", "pr_url": "https://github.com/trinodb/trino/pull/6040", "timeline": [{"oid": "f8b80aeb9c0f784ee86c4b90dfeec9b559a84cdc", "url": "https://github.com/trinodb/trino/commit/f8b80aeb9c0f784ee86c4b90dfeec9b559a84cdc", "message": "Remove unused keyEqualsMethod and keyType from MapElementAtFunction", "committedDate": "2020-11-21T23:15:27Z", "type": "commit"}, {"oid": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "url": "https://github.com/trinodb/trino/commit/b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "message": "Require calling convention for scalar functions", "committedDate": "2020-11-21T23:16:28Z", "type": "commit"}, {"oid": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "url": "https://github.com/trinodb/trino/commit/b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "message": "Require calling convention for scalar functions", "committedDate": "2020-11-21T23:16:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534458894", "bodyText": "Why are we getting an EQUALs operator that allows nullable return? That doesn't seem expected for equals as an operator?", "author": "erichwang", "createdAt": "2020-12-02T20:25:58Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/ExpressionInterpreter.java", "diffHunk": "@@ -581,8 +586,8 @@ protected Object visitInPredicate(InPredicate node, Object context)\n                     set = FastutilSetHelper.toFastutilHashSet(\n                             objectSet,\n                             type,\n-                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(HASH_CODE, ImmutableList.of(type)), Optional.empty()).getMethodHandle(),\n-                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(EQUAL, ImmutableList.of(type, type)), Optional.empty()).getMethodHandle());\n+                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(HASH_CODE, ImmutableList.of(type)), simpleConvention(FAIL_ON_NULL, NEVER_NULL)).getMethodHandle(),\n+                            metadata.getScalarFunctionInvoker(metadata.resolveOperator(EQUAL, ImmutableList.of(type, type)), simpleConvention(NULLABLE_RETURN, NEVER_NULL, NEVER_NULL)).getMethodHandle());", "originalCommit": "b00e6309f89f2499a4c45ab035a8f3b302c70f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ5MzQzNg==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534493436", "bodyText": "i guess ARRAY[NULL] = ARRAY[1] should return NULL", "author": "findepi", "createdAt": "2020-12-02T21:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNjU5OQ==", "url": "https://github.com/trinodb/trino/pull/6040#discussion_r534526599", "bodyText": "Yep that is why", "author": "dain", "createdAt": "2020-12-02T22:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODg5NA=="}], "type": "inlineReview"}]}