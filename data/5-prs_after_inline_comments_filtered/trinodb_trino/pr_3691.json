{"pr_number": 3691, "pr_title": "Limit pushdown for Kudu connector", "pr_createdAt": "2020-05-11T08:09:42Z", "pr_url": "https://github.com/trinodb/trino/pull/3691", "timeline": [{"oid": "132c5aad4f2457f7886948cc154bc68eca949e96", "url": "https://github.com/trinodb/trino/commit/132c5aad4f2457f7886948cc154bc68eca949e96", "message": "Limit pushdown for Kudu connector", "committedDate": "2020-05-11T08:40:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkzODg3Mg==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r422938872", "bodyText": "why is it not guaranteed?", "author": "kokosing", "createdAt": "2020-05-11T10:22:09Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -450,8 +453,29 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 handle.getTable(clientSession),\n                 handle.getConstraint(),\n                 Optional.of(desiredColumns.build()),\n-                handle.isDeleteHandle());\n+                handle.isDeleteHandle(),\n+                handle.getLimit());\n \n         return Optional.of(new ProjectionApplicationResult<>(handle, projections, assignmentList.build()));\n     }\n+\n+    @Override\n+    public Optional<LimitApplicationResult<ConnectorTableHandle>> applyLimit(ConnectorSession session, ConnectorTableHandle table, long limit)\n+    {\n+        KuduTableHandle handle = (KuduTableHandle) table;\n+\n+        if (handle.getLimit().isPresent() && handle.getLimit().getAsLong() <= limit) {\n+            return Optional.empty();\n+        }\n+\n+        handle = new KuduTableHandle(\n+                handle.getSchemaTableName(),\n+                handle.getTable(clientSession),\n+                handle.getConstraint(),\n+                handle.getDesiredColumns(),\n+                handle.isDeleteHandle(),\n+                OptionalLong.of(limit));\n+\n+        return Optional.of(new LimitApplicationResult<>(handle, false));", "originalCommit": "132c5aad4f2457f7886948cc154bc68eca949e96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2NDQyMw==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r422964423", "bodyText": "I think it creates limit for each partition so we can't guarantee a global limit but the limit is applied per partition", "author": "Praveen2112", "createdAt": "2020-05-11T11:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkzODg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDA4Mg==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r423344082", "bodyText": "if limit is present, we cannot apply filter, can we?", "author": "findepi", "createdAt": "2020-05-11T21:58:27Z", "path": "presto-kudu/src/main/java/io/prestosql/plugin/kudu/KuduMetadata.java", "diffHunk": "@@ -394,7 +396,8 @@ public ConnectorTableProperties getTableProperties(ConnectorSession session, Con\n                 handle.getTable(clientSession),\n                 newDomain,\n                 handle.getDesiredColumns(),\n-                handle.isDeleteHandle());\n+                handle.isDeleteHandle(),\n+                handle.getLimit());", "originalCommit": "132c5aad4f2457f7886948cc154bc68eca949e96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI4NTUwNg==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r424285506", "bodyText": "Yes !! The applyLimit will be invoked only during this pattern TableScan -> Limit so in case of filters only if it is fully applied by the connector then limit might be pushed down", "author": "Praveen2112", "createdAt": "2020-05-13T09:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI5ODIwOA==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r424298208", "bodyText": "Consider the cases:\nOutput -> Filter -> Limit -> Scan\n\nand\nOutput -> Limit -> Filter -> Scan\n\nsince we implement both applyLimit and applyFilter, how do we distinguish which one took place?", "author": "findepi", "createdAt": "2020-05-13T09:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI5OTA5MA==", "url": "https://github.com/trinodb/trino/pull/3691#discussion_r424299090", "bodyText": "I realized we had this discussion some time ago with JDBC connectors, but cannot find it now. @martint @electrum ?\nUnfortunately we didn't capture much of the thinking in the code, and it looks as if this was not addressed.", "author": "findepi", "createdAt": "2020-05-13T09:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDA4Mg=="}], "type": "inlineReview"}, {"oid": "b2fac6766ae3e528bafb42f7a4e407a9490bcc79", "url": "https://github.com/trinodb/trino/commit/b2fac6766ae3e528bafb42f7a4e407a9490bcc79", "message": "Include bucketCount for hashCode and equals", "committedDate": "2020-10-28T07:03:53Z", "type": "commit"}, {"oid": "8c5e084c40bdd9e6511196696afa92fdb219f636", "url": "https://github.com/trinodb/trino/commit/8c5e084c40bdd9e6511196696afa92fdb219f636", "message": "Limit pushdown for Kudu connector", "committedDate": "2020-10-28T07:03:54Z", "type": "commit"}, {"oid": "8c5e084c40bdd9e6511196696afa92fdb219f636", "url": "https://github.com/trinodb/trino/commit/8c5e084c40bdd9e6511196696afa92fdb219f636", "message": "Limit pushdown for Kudu connector", "committedDate": "2020-10-28T07:03:54Z", "type": "forcePushed"}]}