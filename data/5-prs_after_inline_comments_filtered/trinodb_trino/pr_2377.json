{"pr_number": 2377, "pr_title": "Use dockerized Cassandra in tests", "pr_createdAt": "2020-01-01T12:42:35Z", "pr_url": "https://github.com/trinodb/trino/pull/2377", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362324288", "bodyText": "i am thinking it could make sense to convert CassandraServer to normal object, rather than having it a static instance.\n-- are we benefiting from the reuse of single cassandra instance across test classes?\nFWIW cassandra module runs tests single threaded today (https://github.com/prestosql/presto/blob/7aaa0f5fac1454b23e4bd2ac3a511d749bd00fbe/presto-cassandra/pom.xml#L17)\n\nthis means we don't need to worry about increased mem usage from multiple tests runs now\nhaving CassandraServer as an object could allow us to run the tests in 2 threads (memory permitting)", "author": "findepi", "createdAt": "2020-01-01T13:49:41Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraQueryRunner.java", "diffHunk": "@@ -44,16 +44,16 @@ public static synchronized DistributedQueryRunner createCassandraQueryRunner()\n \n         queryRunner.installPlugin(new CassandraPlugin());\n         queryRunner.createCatalog(\"cassandra\", \"cassandra\", ImmutableMap.of(\n-                \"cassandra.contact-points\", EmbeddedCassandra.getHost(),\n-                \"cassandra.native-protocol-port\", Integer.toString(EmbeddedCassandra.getPort()),\n+                \"cassandra.contact-points\", CassandraServer.getHost(),", "originalCommit": "705b923103e9f6dca122761d2ef1d67bf0684d38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDQyNg==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362324426", "bodyText": "how long does it take to start cassandra?", "author": "findepi", "createdAt": "2020-01-01T13:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNTI0NQ==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362325245", "bodyText": "It takes about:\n\n37s when the image does not exist in the environment (+data load)\n17s when the image already exist in the environment (+data load)\n\nLet me check the performance with normal object version.", "author": "ebyhr", "createdAt": "2020-01-01T14:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyOTgwNA==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362329804", "bodyText": "Making CassandraServer non-static with 2 threads will extend the test time for a few minutes.\n14m 34s \u2192 16m 58s", "author": "ebyhr", "createdAt": "2020-01-01T15:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMzOTg0Mg==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362339842", "bodyText": "I think it's worth it, since it brings more isolation.\n17 minutes is still a decent run time for a test configuration.\n(BTW Are there any test classes that could be easily merged?)", "author": "findepi", "createdAt": "2020-01-01T19:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM1OTI4MA==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362359280", "bodyText": "I think so too. Let me push the additional commit.\nCurrently, dockerized CassandraServer is called from 4 places.\n\nTestCassandraDistributedQueries\nTestCassandraIntegrationSmokeTest\nTestCassandraConnector\nTestCassandraTokenSplitManager\n\nWe could merge 3 & 4 technically, but I would keep the current implementation.", "author": "ebyhr", "createdAt": "2020-01-02T02:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjMyNDI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUwODQxNQ==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r362508415", "bodyText": "Was cassandra-foreground and cassandra.native.epoll.enabled something important?", "author": "findepi", "createdAt": "2020-01-02T15:16:07Z", "path": "presto-cassandra/src/test/java/io/prestosql/plugin/cassandra/CassandraServer.java", "diffHunk": "@@ -70,18 +68,16 @@ public static synchronized void start()\n \n         log.info(\"Starting cassandra...\");\n \n-        System.setProperty(\"cassandra.config\", \"file:\" + prepareCassandraYaml());\n-        System.setProperty(\"cassandra-foreground\", \"true\");\n-        System.setProperty(\"cassandra.native.epoll.enabled\", \"false\");", "originalCommit": "705b923103e9f6dca122761d2ef1d67bf0684d38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2NzA3MA==", "url": "https://github.com/trinodb/trino/pull/2377#discussion_r363067070", "bodyText": "Yes, we couldn't run tests without these properties on EmbeddedCassandra.", "author": "ebyhr", "createdAt": "2020-01-05T03:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjUwODQxNQ=="}], "type": "inlineReview"}, {"oid": "1c3720455c233082627d2d71503e242fc4c312d9", "url": "https://github.com/trinodb/trino/commit/1c3720455c233082627d2d71503e242fc4c312d9", "message": "Use dockerized Cassandra in tests", "committedDate": "2020-01-05T03:04:19Z", "type": "commit"}, {"oid": "8baacf724d7bcdab396521294d01adbf6de0fc13", "url": "https://github.com/trinodb/trino/commit/8baacf724d7bcdab396521294d01adbf6de0fc13", "message": "Make CassandraServer non-static", "committedDate": "2020-01-05T03:04:19Z", "type": "commit"}, {"oid": "2738fefe3be6c77f1185e0e82f5f91971ab79c10", "url": "https://github.com/trinodb/trino/commit/2738fefe3be6c77f1185e0e82f5f91971ab79c10", "message": "Run Cassandra tests with two threads", "committedDate": "2020-01-05T03:04:19Z", "type": "commit"}, {"oid": "f79bb4412ffe849078632383d990c70fb4a4e1f7", "url": "https://github.com/trinodb/trino/commit/f79bb4412ffe849078632383d990c70fb4a4e1f7", "message": "Fix syntax warning in Cassandra test", "committedDate": "2020-01-05T03:04:19Z", "type": "commit"}, {"oid": "f79bb4412ffe849078632383d990c70fb4a4e1f7", "url": "https://github.com/trinodb/trino/commit/f79bb4412ffe849078632383d990c70fb4a4e1f7", "message": "Fix syntax warning in Cassandra test", "committedDate": "2020-01-05T03:04:19Z", "type": "forcePushed"}]}