{"pr_number": 4924, "pr_title": "Short circuit lazy dynamic filters on Domain.all", "pr_createdAt": "2020-08-21T15:47:48Z", "pr_url": "https://github.com/trinodb/trino/pull/4924", "timeline": [{"oid": "929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c", "url": "https://github.com/trinodb/trino/commit/929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c", "message": "Don't set future in synchronized context\n\nCalling SettableFuture#set might result\nin callback, which should not be executed in\nsynchronization context.", "committedDate": "2020-08-21T14:34:02Z", "type": "commit"}, {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd", "url": "https://github.com/trinodb/trino/commit/a05e91fee593162be3ff0325fd916b712b2feacd", "message": "Short circuit lazy dynamic filters on Domain.all", "committedDate": "2020-08-21T15:57:57Z", "type": "commit"}, {"oid": "a05e91fee593162be3ff0325fd916b712b2feacd", "url": "https://github.com/trinodb/trino/commit/a05e91fee593162be3ff0325fd916b712b2feacd", "message": "Short circuit lazy dynamic filters on Domain.all", "committedDate": "2020-08-21T15:57:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyOTcwOA==", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r474829708", "bodyText": "What if two calls to addPartition race with each other? Whoever's watching resultFuture may see one value and miss the other one. If resultFuture is being used in any way other that as a flag to indicate something changed, that would be a problem.", "author": "martint", "createdAt": "2020-08-21T17:24:33Z", "path": "presto-main/src/main/java/io/prestosql/sql/planner/LocalDynamicFilterConsumer.java", "diffHunk": "@@ -91,16 +91,22 @@ public LocalDynamicFilterConsumer(Multimap<DynamicFilterId, Symbol> probeSymbols\n         return Futures.transform(resultFuture, this::convertTupleDomainForLocalFilters, directExecutor());\n     }\n \n-    private synchronized void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n+    private void addPartition(TupleDomain<DynamicFilterId> tupleDomain)\n     {\n-        // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n-        verify(partitions.size() < partitionCount);\n-        // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n-        // See the comment at TupleDomain::columnWiseUnion() for more details.\n-        partitions.add(tupleDomain);\n-        if (partitions.size() == partitionCount) {\n-            TupleDomain<DynamicFilterId> result = TupleDomain.columnWiseUnion(partitions);\n-            // No more partitions are left to be processed.\n+        TupleDomain<DynamicFilterId> result = null;\n+        synchronized (this) {\n+            // Called concurrently by each DynamicFilterSourceOperator instance (when collection is over).\n+            verify(partitions.size() < partitionCount);\n+            // NOTE: may result in a bit more relaxed constraint if there are multiple columns and multiple rows.\n+            // See the comment at TupleDomain::columnWiseUnion() for more details.\n+            partitions.add(tupleDomain);\n+            if (partitions.size() == partitionCount) {\n+                // No more partitions are left to be processed.\n+                result = TupleDomain.columnWiseUnion(partitions);\n+            }\n+        }\n+\n+        if (result != null) {", "originalCommit": "929a0dcb02e3b25fd36e9d47ce49dcf2bd02752c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3NDE3MQ==", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r475474171", "bodyText": "resultFuture contains union of all partitions.\nThe condition of setting future is:\n\nall partitions have been set (none of them is all)\none of the partitions is all\n\nIn 1) only the last partition would trigger setting of the future\nIn 2) the final DF would always be the same (all), but we don't really have to wait for all partitions", "author": "sopel39", "createdAt": "2020-08-24T09:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyOTcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMDgyMg==", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r474830822", "bodyText": "Not sure I understand why. Aren't the filters \"ANDed\" together?", "author": "martint", "createdAt": "2020-08-21T17:26:50Z", "path": "presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java", "diffHunk": "@@ -268,6 +268,11 @@ void collectDynamicFilters()\n                         .collect(groupingBy(Map.Entry::getKey, mapping(Map.Entry::getValue, toImmutableList())))\n                         .entrySet().stream()\n                         .filter(stageDomains -> {\n+                            if (stageDomains.getValue().stream().anyMatch(Domain::isAll)) {\n+                                // if one of the domains is all, we don't need to get dynamic filters from all tasks", "originalCommit": "a05e91fee593162be3ff0325fd916b712b2feacd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MDkyMA==", "url": "https://github.com/trinodb/trino/pull/4924#discussion_r474980920", "bodyText": "union @ https://github.com/prestosql/presto/blob/80e1bcc2e38d28a05d9caa4440cadf359ef4fdbf/presto-main/src/main/java/io/prestosql/server/DynamicFilterService.java#L279", "author": "findepi", "createdAt": "2020-08-21T21:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzMDgyMg=="}], "type": "inlineReview"}]}