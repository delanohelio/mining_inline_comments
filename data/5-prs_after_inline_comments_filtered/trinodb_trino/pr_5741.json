{"pr_number": 5741, "pr_title": "Avoid lowering memory limit in resource overcommit case", "pr_createdAt": "2020-10-29T17:34:45Z", "pr_url": "https://github.com/trinodb/trino/pull/5741", "timeline": [{"oid": "de006fe48058dbb7e39d0a292f651f233a84e09f", "url": "https://github.com/trinodb/trino/commit/de006fe48058dbb7e39d0a292f651f233a84e09f", "message": "Avoid lowering memory limit in resource overcommit case\n\nEven when resource_overcommit is set to true, SqlTaskManager#updateTask\nfirst attempts to lower the memory limit based on the values from the\nsession. This can cause memory reservation to fail, if bytes are\nupdated before setResourceOvercommit is invoked. This commit fixes the\nrace condition by avoiding the memory limit updates from session values\nwhen resource overcommit is set.", "committedDate": "2020-10-29T17:30:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1NzMxNQ==", "url": "https://github.com/trinodb/trino/pull/5741#discussion_r514557315", "bodyText": "We know we can skip calling setMaxUserMemory because it will be obliterated by setResourceOvercommit invoc if overcommit enabled.\ni.e. This is correct because of what setResourceOvercommit does internally.\nI'd suggest removing (inlining) the setResourceOvercommit method, and exposing this relationship here:\nif (no overcocommit) { \n do usual stuff\n}\nelse {\n setMaxUserMemory & setMaxTotalMemory to memoryPool.max\n}", "author": "findepi", "createdAt": "2020-10-29T20:48:49Z", "path": "presto-main/src/main/java/io/prestosql/execution/SqlTaskManager.java", "diffHunk": "@@ -373,21 +373,22 @@ public TaskInfo updateTask(Session session, TaskId taskId, Optional<PlanFragment\n         requireNonNull(sources, \"sources is null\");\n         requireNonNull(outputBuffers, \"outputBuffers is null\");\n \n-        long sessionQueryMaxMemoryPerNode = getQueryMaxMemoryPerNode(session).toBytes();\n-        long sessionQueryTotalMaxMemoryPerNode = getQueryMaxTotalMemoryPerNode(session).toBytes();\n-        // Session property query_max_memory_per_node is used to only decrease memory limit\n-        if (sessionQueryMaxMemoryPerNode <= queryMaxMemoryPerNode) {\n-            queryContexts.getUnchecked(taskId.getQueryId()).setMaxUserMemory(sessionQueryMaxMemoryPerNode);", "originalCommit": "de006fe48058dbb7e39d0a292f651f233a84e09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY2OTQ1Mg==", "url": "https://github.com/trinodb/trino/pull/5741#discussion_r514669452", "bodyText": "@findepi I thought about this, and feel that it still may not be very clean, since we end up locking the object outside of the class, because we'd like to also access the guarded memoryPool. do you feel that the following would look better?\n......\nelse {\n    synchronized (queryContext) {\n        long maxBytes = queryContext.getMemoryPool().getMaxBytes();\n        queryContext.setMaxUserMemory(maxBytes);\n        queryContext.setMaxTotalMemory(maxBytes);\n    }\n}\n\nAnother option is we introduce specific methods like setMaxUserMemoryToMemoryPoolMaxBytes setMaxTotalMemoryToMemoryPoolMaxBytes. Thoughts?", "author": "phd3", "createdAt": "2020-10-30T01:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1NzMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyOTAzNQ==", "url": "https://github.com/trinodb/trino/pull/5741#discussion_r514929035", "bodyText": "I see your point. Let's get in what you have now.", "author": "findepi", "createdAt": "2020-10-30T08:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU1NzMxNQ=="}], "type": "inlineReview"}]}