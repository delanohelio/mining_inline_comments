{"pr_number": 6063, "pr_title": "Added ability to have unique table location for each iceberg table", "pr_createdAt": "2020-11-23T18:22:45Z", "pr_url": "https://github.com/trinodb/trino/pull/6063", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODcxOQ==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529798719", "bodyText": "We don't need to say \"if true\" for boolean properties, as that's redundant. Let's phrase this as\n\nInclude UUID in the table location", "author": "electrum", "createdAt": "2020-11-24T18:41:23Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -52,4 +54,18 @@ public IcebergConfig setCompressionCodec(HiveCompressionCodec compressionCodec)\n         this.compressionCodec = compressionCodec;\n         return this;\n     }\n+\n+    @NotNull\n+    public boolean isUniqueTableLocation()\n+    {\n+        return uniqueTableLocation;\n+    }\n+\n+    @Config(\"iceberg.unique-table-location\")\n+    @ConfigDescription(\"If true UUID will be added to the table location\")", "originalCommit": "e039d5d9586b9204d0fac111279822be52d24fbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzNzc0MA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529837740", "bodyText": "looks really better, thanks", "author": "sshkvar", "createdAt": "2020-11-24T19:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODc4MA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529798780", "bodyText": "Not needed since this returns a primitive", "author": "electrum", "createdAt": "2020-11-24T18:41:29Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -52,4 +54,18 @@ public IcebergConfig setCompressionCodec(HiveCompressionCodec compressionCodec)\n         this.compressionCodec = compressionCodec;\n         return this;\n     }\n+\n+    @NotNull", "originalCommit": "e039d5d9586b9204d0fac111279822be52d24fbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzODMyNQ==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529838325", "bodyText": "removed, thanks", "author": "sshkvar", "createdAt": "2020-11-24T19:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMTMwOA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529801308", "bodyText": "Should we remove the dashes? Compare\n\nmy_table-1ec297aa2e8511eb9dfe7bf8d2aea93a\nmy_table_1ec297aa-2e85-11eb-9dfe-7bf8d2aea93a", "author": "electrum", "createdAt": "2020-11-24T18:45:50Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -393,7 +397,8 @@ public ConnectorOutputTableHandle beginCreateTable(ConnectorSession session, Con\n         HiveIdentity identity = new HiveIdentity(session);\n         String targetPath = getTableLocation(tableMetadata.getProperties());\n         if (targetPath == null) {\n-            targetPath = getTableDefaultLocation(database, hdfsContext, hdfsEnvironment, schemaName, tableName).toString();\n+            String uniqueTableName = useUniqueTableLocation ? String.format(\"%s_%s\", tableName, UUID.randomUUID()) : tableName;", "originalCommit": "e039d5d9586b9204d0fac111279822be52d24fbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzOTA4Mg==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529839082", "bodyText": "yes, without dashes looks better. Removed dashes and moved generation of unique table name to separate private method", "author": "sshkvar", "createdAt": "2020-11-24T19:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMzE1Mw==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529803153", "bodyText": "Wrap the argument, since all other arguments are wrapped", "author": "electrum", "createdAt": "2020-11-24T18:49:19Z", "path": "presto-iceberg/src/main/java/io/prestosql/plugin/iceberg/IcebergMetadataFactory.java", "diffHunk": "@@ -37,23 +38,24 @@ public IcebergMetadataFactory(\n             TypeManager typeManager,\n             JsonCodec<CommitTaskData> commitTaskDataJsonCodec)\n     {\n-        this(metastore, hdfsEnvironment, typeManager, commitTaskDataJsonCodec);\n+        this(metastore, hdfsEnvironment, typeManager, commitTaskDataJsonCodec, config.isUniqueTableLocation());\n     }\n \n     public IcebergMetadataFactory(\n             HiveMetastore metastore,\n             HdfsEnvironment hdfsEnvironment,\n             TypeManager typeManager,\n-            JsonCodec<CommitTaskData> commitTaskCodec)\n+            JsonCodec<CommitTaskData> commitTaskCodec, boolean useUniqueTableLocation)", "originalCommit": "e039d5d9586b9204d0fac111279822be52d24fbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgzOTY5NA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r529839694", "bodyText": "Not sure that I understand comment correct, but moved  boolean useUniqueTableLocation to the next line", "author": "sshkvar", "createdAt": "2020-11-24T19:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAwOTE5NA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r634009194", "bodyText": "tableName + \"-\" + UUID.randomUUID().toString().replace(\"-\", \"\")", "author": "raunaqmorarka", "createdAt": "2021-05-18T03:14:54Z", "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -1074,6 +1078,11 @@ else if (strings.size() != 2) {\n         return viewToken;\n     }\n \n+    private String generateUniqueTableName(String tableName)\n+    {\n+        return String.format(\"%s-%s\", tableName, UUID.randomUUID().toString().replace(\"-\", \"\"));", "originalCommit": "647298023da5fc86990dcb0d8c2dadc92a83c85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAxNzc4NA==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r634017784", "bodyText": "Append  randomUUID to table location", "author": "raunaqmorarka", "createdAt": "2021-05-18T03:46:26Z", "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergConfig.java", "diffHunk": "@@ -74,4 +76,17 @@ public IcebergConfig setUseFileSizeFromMetadata(boolean useFileSizeFromMetadata)\n         this.useFileSizeFromMetadata = useFileSizeFromMetadata;\n         return this;\n     }\n+\n+    public boolean isUniqueTableLocation()\n+    {\n+        return uniqueTableLocation;\n+    }\n+\n+    @Config(\"iceberg.unique-table-location\")\n+    @ConfigDescription(\"Include UUID in the table location\")", "originalCommit": "647298023da5fc86990dcb0d8c2dadc92a83c85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzMzgxNQ==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r677333815", "bodyText": "\"Use randomized, unique table locations\"", "author": "findepi", "createdAt": "2021-07-27T10:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDAxNzc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzNzUzMg==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r677337532", "bodyText": "The uniqueTableName variable name suggests we're making the table name unique, while we're only changing table location.\nLet's call the variable tableNameForLocation\nSince same naming problem applies to generateUniqueTableName, let's inline that method.\nString tableNameForLocation = tableName;\nif (useUniqueTableLocation) {\n    tableNameForLocation += \"-\" + randomUUID().toString().replace(\"-\", \"\")\n}", "author": "findepi", "createdAt": "2021-07-27T10:53:17Z", "path": "plugin/trino-iceberg/src/main/java/io/trino/plugin/iceberg/IcebergMetadata.java", "diffHunk": "@@ -495,7 +498,8 @@ public ConnectorOutputTableHandle beginCreateTable(ConnectorSession session, Con\n         HiveIdentity identity = new HiveIdentity(session);\n         String targetPath = getTableLocation(tableMetadata.getProperties());\n         if (targetPath == null) {\n-            targetPath = getTableDefaultLocation(database, hdfsContext, hdfsEnvironment, schemaName, tableName).toString();\n+            String uniqueTableName = useUniqueTableLocation ? generateUniqueTableName(tableName) : tableName;", "originalCommit": "647298023da5fc86990dcb0d8c2dadc92a83c85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzYwMzQ4Nw==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r677603487", "bodyText": "@findepi sure, I will rebase this brach, add code fixes and tests in next few days", "author": "sshkvar", "createdAt": "2021-07-27T16:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzNzUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODg3NzE3OQ==", "url": "https://github.com/trinodb/trino/pull/6063#discussion_r678877179", "bodyText": "@findepi I have rebased this brach.\nAdded few tests to check that uuid suffix added to a table location, and also added tests for check that table correctly dropped .\nWill be really appreciate for the review", "author": "sshkvar", "createdAt": "2021-07-29T06:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMzNzUzMg=="}], "type": "inlineReview"}, {"oid": "0a30f7939798f0263cf2594cfa9f39f238afb456", "url": "https://github.com/trinodb/trino/commit/0a30f7939798f0263cf2594cfa9f39f238afb456", "message": "rebase: Added ability to have unique table location for each iceberg table", "committedDate": "2021-08-03T12:08:57Z", "type": "commit"}, {"oid": "0a30f7939798f0263cf2594cfa9f39f238afb456", "url": "https://github.com/trinodb/trino/commit/0a30f7939798f0263cf2594cfa9f39f238afb456", "message": "rebase: Added ability to have unique table location for each iceberg table", "committedDate": "2021-08-03T12:08:57Z", "type": "forcePushed"}]}