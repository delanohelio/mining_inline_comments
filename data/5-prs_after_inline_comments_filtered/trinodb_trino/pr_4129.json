{"pr_number": 4129, "pr_title": "Incorrect JMX stats for queued queries", "pr_createdAt": "2020-06-22T01:45:13Z", "pr_url": "https://github.com/trinodb/trino/pull/4129", "timeline": [{"oid": "49e2b85c80c18cd4eece9c96444fa69adee098dc", "url": "https://github.com/trinodb/trino/commit/49e2b85c80c18cd4eece9c96444fa69adee098dc", "message": "Fix tracking of queued queries in JMX stats\n\nTransfer the responsibility of exposing query manager stats to\nDispatchManager. Stop tracking RunningQueries and QueuedQueries in\nQueryManagerStats, since they were not computed accurately. Expose\nMBean attributes with the same names based on information obtained\nfrom QueryTracker.", "committedDate": "2020-06-23T03:09:31Z", "type": "commit"}, {"oid": "9c32b48abb328a29dc683cf640575067dd5aa9b7", "url": "https://github.com/trinodb/trino/commit/9c32b48abb328a29dc683cf640575067dd5aa9b7", "message": "Check more often if the state we're waiting for has been reached", "committedDate": "2020-06-23T03:09:31Z", "type": "commit"}, {"oid": "9c32b48abb328a29dc683cf640575067dd5aa9b7", "url": "https://github.com/trinodb/trino/commit/9c32b48abb328a29dc683cf640575067dd5aa9b7", "message": "Check more often if the state we're waiting for has been reached", "committedDate": "2020-06-23T03:09:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzOTUyNQ==", "url": "https://github.com/trinodb/trino/pull/4129#discussion_r445639525", "bodyText": "Will this scale for cluster with large number of concurrent queries? The JMX scrape intervals can be as low as 10 seconds. So is calling getAllQueries() at 6 rpm OK for the cluster?\nI too prefer this change since everything is simpler now but am concerned about the above point.", "author": "hashhar", "createdAt": "2020-06-25T15:20:06Z", "path": "presto-main/src/main/java/io/prestosql/dispatcher/DispatchManager.java", "diffHunk": "@@ -261,6 +263,22 @@ private boolean queryCreated(DispatchQuery dispatchQuery)\n                 .collect(toImmutableList());\n     }\n \n+    @Managed\n+    public long getQueuedQueries()\n+    {\n+        return queryTracker.getAllQueries().stream()", "originalCommit": "9c32b48abb328a29dc683cf640575067dd5aa9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2NzIxMA==", "url": "https://github.com/trinodb/trino/pull/4129#discussion_r445667210", "bodyText": "It's not an expensive operation.  The UI actually calls this (see https://github.com/prestosql/presto/blob/master/presto-main/src/main/java/io/prestosql/server/ui/ClusterStatsResource.java#L78) more often than that.", "author": "aalbu", "createdAt": "2020-06-25T16:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzOTUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5OTczMA==", "url": "https://github.com/trinodb/trino/pull/4129#discussion_r445699730", "bodyText": "related?", "author": "findepi", "createdAt": "2020-06-25T16:50:49Z", "path": "presto-tests/src/test/java/io/prestosql/execution/TestQueryRunnerUtil.java", "diffHunk": "@@ -64,7 +64,7 @@ public static void waitForQueryState(DistributedQueryRunner queryRunner, QueryId\n                     dispatchManager.getQueryInfo(queryInfo.getQueryId());\n                 }\n             }\n-            MILLISECONDS.sleep(500);\n+            MILLISECONDS.sleep(100);", "originalCommit": "9c32b48abb328a29dc683cf640575067dd5aa9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxMjQ4MQ==", "url": "https://github.com/trinodb/trino/pull/4129#discussion_r445712481", "bodyText": "It's on a separate commit.  Not necessary, just trying to speed up tests - waiting half a second to check query state changes seemed excessive.  Do you think 100ms is too short?", "author": "aalbu", "createdAt": "2020-06-25T17:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5OTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MTU5NQ==", "url": "https://github.com/trinodb/trino/pull/4129#discussion_r445741595", "bodyText": "It's on a separate commit.\n\nnvrm, i missed that", "author": "findepi", "createdAt": "2020-06-25T18:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5OTczMA=="}], "type": "inlineReview"}]}