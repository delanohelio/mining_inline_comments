{"pr_number": 3257, "pr_title": "Create stub files from Java source files", "pr_createdAt": "2020-04-14T22:09:05Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3257", "timeline": [{"oid": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "url": "https://github.com/typetools/checker-framework/commit/fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "message": "Create stub files from Java source files.\n\nCo-authored-by: zhangjiangqige <zhangjiangqige@gmail.com>", "committedDate": "2020-04-14T22:02:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1MTI1OQ==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r408651259", "bodyText": "This comment doesn't convey what the routine does.  Please make it more specific.  The same feedback applies to other comments in the file.", "author": "mernst", "createdAt": "2020-04-15T07:56:53Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.", "originalCommit": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1MTMwMA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r408651300", "bodyText": "Please say what they are: one or more directories.", "author": "mernst", "createdAt": "2020-04-15T07:56:56Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.\n+     *\n+     * @param args command-line arguments", "originalCommit": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1MjA3Mw==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r408652073", "bodyText": "What is a \"source root\"?\n(Also, here and elsewhere clarify \"process\".", "author": "mernst", "createdAt": "2020-04-15T07:58:16Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.\n+     *\n+     * @param args command-line arguments\n+     */\n+    public static void main(String[] args) {\n+        if (args.length < 1) {\n+            System.err.println(\"Usage: provide one or more directory names to process\");\n+            System.exit(1);\n+        }\n+        for (String dir : args) {\n+            process(dir);\n+        }\n+    }\n+\n+    /**\n+     * Process the given directory.\n+     *\n+     * @param dir directory to process\n+     */\n+    private static void process(String dir) {\n+        Path root = Paths.get(dir);\n+\n+        ParserConfiguration conf = new ParserConfiguration();\n+        MinimizationVisitor sm = new MinimizationVisitor();\n+\n+        ProjectRoot projectRoot = new ParserCollectionStrategy().collect(root);\n+        projectRoot\n+                .getSourceRoots()\n+                .forEach(\n+                        sourceRoot -> {\n+                            try {\n+                                sourceRoot.parse(\"\", conf, new MinimizationCallback(sm));\n+                            } catch (IOException e) {\n+                                System.err.println(\"IOException: \" + e);\n+                            }\n+                        });\n+    }\n+\n+    /** Callback to process one source root. */", "originalCommit": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1Mjk1Ng==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r408652956", "bodyText": "Nit: I would rename Minimization to Minimize or Minimizer throughout, to make the terminology shorter and more active.", "author": "mernst", "createdAt": "2020-04-15T07:59:47Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.\n+     *\n+     * @param args command-line arguments\n+     */\n+    public static void main(String[] args) {\n+        if (args.length < 1) {\n+            System.err.println(\"Usage: provide one or more directory names to process\");\n+            System.exit(1);\n+        }\n+        for (String dir : args) {\n+            process(dir);\n+        }\n+    }\n+\n+    /**\n+     * Process the given directory.\n+     *\n+     * @param dir directory to process\n+     */\n+    private static void process(String dir) {\n+        Path root = Paths.get(dir);\n+\n+        ParserConfiguration conf = new ParserConfiguration();\n+        MinimizationVisitor sm = new MinimizationVisitor();\n+\n+        ProjectRoot projectRoot = new ParserCollectionStrategy().collect(root);\n+        projectRoot\n+                .getSourceRoots()\n+                .forEach(\n+                        sourceRoot -> {\n+                            try {\n+                                sourceRoot.parse(\"\", conf, new MinimizationCallback(sm));\n+                            } catch (IOException e) {\n+                                System.err.println(\"IOException: \" + e);\n+                            }\n+                        });\n+    }\n+\n+    /** Callback to process one source root. */\n+    private static class MinimizationCallback implements SourceRoot.Callback {", "originalCommit": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY1NDk2MA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r408654960", "bodyText": "Does it do so in place?", "author": "mernst", "createdAt": "2020-04-15T08:03:16Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:", "originalCommit": "fc4dbf06cc68bfcd2d05c68f5137a87fcf074688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cfb768f606ca79097a121ce48def4e1e02bac2b2", "url": "https://github.com/typetools/checker-framework/commit/cfb768f606ca79097a121ce48def4e1e02bac2b2", "message": "Merge branch 'master' of github.com:typetools/checker-framework into java-minimizer", "committedDate": "2020-04-15T21:45:34Z", "type": "commit"}, {"oid": "11786e844af937a1349d935494d61766e07cebb9", "url": "https://github.com/typetools/checker-framework/commit/11786e844af937a1349d935494d61766e07cebb9", "message": "Merge remote-tracking branch 'origin/master' into java-minimizer", "committedDate": "2020-04-19T17:12:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk1MTA0NQ==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r410951045", "bodyText": "Can you either remove this or add a flag to turn it on/off?", "author": "smillst", "createdAt": "2020-04-19T17:24:09Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ParserConfiguration;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce minimal stub files, by removing:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.\n+     *\n+     * @param args command-line arguments\n+     */\n+    public static void main(String[] args) {\n+        if (args.length < 1) {\n+            System.err.println(\"Usage: provide one or more directory names to process\");\n+            System.exit(1);\n+        }\n+        for (String dir : args) {\n+            process(dir);\n+        }\n+    }\n+\n+    /**\n+     * Process the given directory.\n+     *\n+     * @param dir directory to process\n+     */\n+    private static void process(String dir) {\n+        Path root = Paths.get(dir);\n+\n+        ParserConfiguration conf = new ParserConfiguration();\n+        MinimizationVisitor sm = new MinimizationVisitor();\n+\n+        ProjectRoot projectRoot = new ParserCollectionStrategy().collect(root);\n+        projectRoot\n+                .getSourceRoots()\n+                .forEach(\n+                        sourceRoot -> {\n+                            try {\n+                                sourceRoot.parse(\"\", conf, new MinimizationCallback(sm));\n+                            } catch (IOException e) {\n+                                System.err.println(\"IOException: \" + e);\n+                            }\n+                        });\n+    }\n+\n+    /** Callback to process one source root. */\n+    private static class MinimizationCallback implements SourceRoot.Callback {\n+        private final MinimizationVisitor sm;\n+\n+        public MinimizationCallback(MinimizationVisitor sm) {\n+            this.sm = sm;\n+        }\n+\n+        @Override\n+        public Result process(\n+                Path localPath, Path absolutePath, ParseResult<CompilationUnit> result) {\n+            Result res = Result.SAVE;\n+            System.out.printf(\"Minimizing %s%n\", absolutePath);", "originalCommit": "11786e844af937a1349d935494d61766e07cebb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f7e0f14e034f8155b8b71fc58ae63013fe5f727", "url": "https://github.com/typetools/checker-framework/commit/8f7e0f14e034f8155b8b71fc58ae63013fe5f727", "message": "Merge branch 'java-minimizer' of github.com:wmdietl/checker-framework into java-minimizer", "committedDate": "2020-04-19T17:43:25Z", "type": "commit"}, {"oid": "44270ab5329ed84e45eae2b7e144cd77ac07405d", "url": "https://github.com/typetools/checker-framework/commit/44270ab5329ed84e45eae2b7e144cd77ac07405d", "message": "Add documentation.", "committedDate": "2020-04-19T18:19:10Z", "type": "commit"}, {"oid": "e619bf16bab0af7dea6d29a8cc93fccbff7674df", "url": "https://github.com/typetools/checker-framework/commit/e619bf16bab0af7dea6d29a8cc93fccbff7674df", "message": "Simplify code. Improve documentation.", "committedDate": "2020-04-19T18:21:34Z", "type": "commit"}, {"oid": "bc3973ba00b106e2d920ef59a313b2b18903dea5", "url": "https://github.com/typetools/checker-framework/commit/bc3973ba00b106e2d920ef59a313b2b18903dea5", "message": "Rename the resource directory jdk11 to annotated-jdk. (#3262)", "committedDate": "2020-04-19T19:11:39Z", "type": "commit"}, {"oid": "daff97129d7e3c7ae4e4d218f7c8de567beb1b83", "url": "https://github.com/typetools/checker-framework/commit/daff97129d7e3c7ae4e4d218f7c8de567beb1b83", "message": "Make field protected because it is referenced from Javadoc of protected method", "committedDate": "2020-04-19T19:11:39Z", "type": "commit"}, {"oid": "bc70a04b851ef4faeb4c646f83555005235f56b8", "url": "https://github.com/typetools/checker-framework/commit/bc70a04b851ef4faeb4c646f83555005235f56b8", "message": "Remove broken link", "committedDate": "2020-04-19T19:11:39Z", "type": "commit"}, {"oid": "4fb51f0fc52aefa117875da98e3fbd6a11330805", "url": "https://github.com/typetools/checker-framework/commit/4fb51f0fc52aefa117875da98e3fbd6a11330805", "message": "Update IntelliJ IDEA instructions (fix broken URLs)", "committedDate": "2020-04-19T19:11:39Z", "type": "commit"}, {"oid": "fbcf5ef486f122ad2e9e8169ae9dba242ac20f9a", "url": "https://github.com/typetools/checker-framework/commit/fbcf5ef486f122ad2e9e8169ae9dba242ac20f9a", "message": "Use JavaStubifier to minimize the annotated jdk.", "committedDate": "2020-04-19T19:12:27Z", "type": "commit"}, {"oid": "5c7882f94ab2fb720d9dba83232b403c3469de9c", "url": "https://github.com/typetools/checker-framework/commit/5c7882f94ab2fb720d9dba83232b403c3469de9c", "message": "Merge branch 'master' into java-minimizer", "committedDate": "2020-04-19T19:13:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTkzNA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r410971934", "bodyText": "I had to add this; otherwise, the interface java files were just removed.  Methods in interfaces are public even if they are not marked as such.  An interface could have a default method whose body should be removed, so we may want to fix this some other way.", "author": "smillst", "createdAt": "2020-04-19T19:19:10Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,184 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce, in-place, minimal stub files. Removes:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument.\n+     *\n+     * @param args command-line arguments: directories to process\n+     */\n+    public static void main(String[] args) {\n+        if (args.length < 1) {\n+            System.err.println(\"Usage: provide one or more directory names to process\");\n+            System.exit(1);\n+        }\n+        for (String arg : args) {\n+            process(arg);\n+        }\n+    }\n+\n+    /**\n+     * Process the given directory.\n+     *\n+     * @param dir directory to process\n+     */\n+    private static void process(String dir) {\n+        Path root = Paths.get(dir);\n+        MinimizerCallback mc = new MinimizerCallback();\n+        ProjectRoot projectRoot = new ParserCollectionStrategy().collect(root);\n+\n+        projectRoot\n+                .getSourceRoots()\n+                .forEach(\n+                        sourceRoot -> {\n+                            try {\n+                                sourceRoot.parse(\"\", mc);\n+                            } catch (IOException e) {\n+                                System.err.println(\"IOException: \" + e);\n+                            }\n+                        });\n+    }\n+\n+    /** Callback to process each Java file. */\n+    private static class MinimizerCallback implements SourceRoot.Callback {\n+        /** The visitor instance. */\n+        private final MinimizerVisitor mv;\n+\n+        /** Create a MinimizerCallback instance. */\n+        public MinimizerCallback() {\n+            this.mv = new MinimizerVisitor();\n+        }\n+\n+        @Override\n+        public Result process(\n+                Path localPath, Path absolutePath, ParseResult<CompilationUnit> result) {\n+            Result res = Result.SAVE;\n+            // System.out.printf(\"Minimizing %s%n\", absolutePath);\n+            Optional<CompilationUnit> opt = result.getResult();\n+            if (opt.isPresent()) {\n+                CompilationUnit cu = opt.get();\n+                // this somehow only removes comments except the\n+                // first one, and copyright headers are kept\n+                cu.getComments().forEach(Node::remove);\n+                mv.visit(cu, null);\n+                if (cu.findAll(ClassOrInterfaceDeclaration.class).isEmpty()\n+                        && cu.findAll(AnnotationDeclaration.class).isEmpty()\n+                        && cu.findAll(EnumDeclaration.class).isEmpty()\n+                        && !absolutePath.endsWith(\"package-info.java\")) {\n+                    // All content is removed, delete this file.\n+                    new File(absolutePath.toUri()).delete();\n+                    res = Result.DONT_SAVE;\n+                }\n+            }\n+            return res;\n+        }\n+    }\n+\n+    /** Visitor to processes one compilation unit. */\n+    private static class MinimizerVisitor extends ModifierVisitor<Void> {\n+        @Override\n+        public ClassOrInterfaceDeclaration visit(ClassOrInterfaceDeclaration cid, Void arg) {\n+            if (cid.isInterface()) {", "originalCommit": "5c7882f94ab2fb720d9dba83232b403c3469de9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk4NzUyMw==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r410987523", "bodyText": "The logic in removeIfPrivateOrPkgPrivate looks at the visibility of the interface itself and removes an interface if it is private or package private.\nIf the interface itself isn't visible, why should we keep it?\nWhich interface did you look at?", "author": "wmdietl", "createdAt": "2020-04-19T20:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk5MzgxMg==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r410993812", "bodyText": "java.util.Map, for example, is remove in MinimizerCallback#process because it has no methods marked as public or protected.\nIt's fine to remove the interface the interface is private or package private, which I suppose you can do by calling removeIfPrivateOrPkgPrivate before the return below.", "author": "smillst", "createdAt": "2020-04-19T21:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMzY3OA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r411003678", "bodyText": "I've added some logic to handle implicitly public members. Map looks fine to me and private interfaces are still removed.", "author": "wmdietl", "createdAt": "2020-04-19T22:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2NzA1Mg==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r411567052", "bodyText": "Thanks!", "author": "smillst", "createdAt": "2020-04-20T17:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTkzNA=="}], "type": "inlineReview"}, {"oid": "8023144cb9864547a3207de9009bdbaf3029afc2", "url": "https://github.com/typetools/checker-framework/commit/8023144cb9864547a3207de9009bdbaf3029afc2", "message": "Fix typo.", "committedDate": "2020-04-19T19:32:07Z", "type": "commit"}, {"oid": "ba8a3450a19609133ac07bf9eddeb07ac3fac03f", "url": "https://github.com/typetools/checker-framework/commit/ba8a3450a19609133ac07bf9eddeb07ac3fac03f", "message": "Handle members of interfaces as implicitly public.", "committedDate": "2020-04-19T22:12:13Z", "type": "commit"}, {"oid": "18e9d3a94b4bd39470656304f8622673da1a0ab4", "url": "https://github.com/typetools/checker-framework/commit/18e9d3a94b4bd39470656304f8622673da1a0ab4", "message": "Work around JavaParser issue.", "committedDate": "2020-04-20T00:12:22Z", "type": "commit"}, {"oid": "f3438536901b045b0d61d117573838bfd311d32c", "url": "https://github.com/typetools/checker-framework/commit/f3438536901b045b0d61d117573838bfd311d32c", "message": "Documentation improvements", "committedDate": "2020-04-21T20:10:54Z", "type": "commit"}, {"oid": "9a22d7bd41c61dad218368da3cb73f1f23a67dc9", "url": "https://github.com/typetools/checker-framework/commit/9a22d7bd41c61dad218368da3cb73f1f23a67dc9", "message": "Rename minimized .java files to .astub.", "committedDate": "2020-04-23T00:09:25Z", "type": "commit"}, {"oid": "8e021e1b40836e03b55e24a1788aac8ae578fb23", "url": "https://github.com/typetools/checker-framework/commit/8e021e1b40836e03b55e24a1788aac8ae578fb23", "message": "Merge branch 'master' of github.com:typetools/checker-framework into java-minimizer", "committedDate": "2020-04-23T00:09:46Z", "type": "commit"}, {"oid": "cdfbc9c45551f1b1a0f907315c80f3c413d9423a", "url": "https://github.com/typetools/checker-framework/commit/cdfbc9c45551f1b1a0f907315c80f3c413d9423a", "message": "Use project subdir.", "committedDate": "2020-04-23T00:11:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDEyNw==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r414084127", "bodyText": "This is removing AbstractStringBuilder because it is a package private class.  However, some of the methods are exposed in public classes.", "author": "smillst", "createdAt": "2020-04-23T19:58:57Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/JavaStubifier.java", "diffHunk": "@@ -0,0 +1,197 @@\n+package org.checkerframework.framework.stub;\n+\n+import com.github.javaparser.ParseResult;\n+import com.github.javaparser.ast.*;\n+import com.github.javaparser.ast.body.*;\n+import com.github.javaparser.ast.expr.MemberValuePair;\n+import com.github.javaparser.ast.expr.NormalAnnotationExpr;\n+import com.github.javaparser.ast.nodeTypes.modifiers.NodeWithAccessModifiers;\n+import com.github.javaparser.ast.stmt.BlockStmt;\n+import com.github.javaparser.ast.visitor.ModifierVisitor;\n+import com.github.javaparser.utils.ParserCollectionStrategy;\n+import com.github.javaparser.utils.ProjectRoot;\n+import com.github.javaparser.utils.SourceRoot;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+/**\n+ * Process Java source files in a directory to produce, in-place, minimal stub files.\n+ *\n+ * <p>To process a file means to remove:\n+ *\n+ * <ol>\n+ *   <li>everything that is private or package-private,\n+ *   <li>all comments, except for an initial copyright header,\n+ *   <li>all method bodies,\n+ *   <li>all field initializers,\n+ *   <li>all initializer blocks,\n+ *   <li>attributes to the {@code Deprecated} annotation (to be Java 8 compatible).\n+ * </ol>\n+ */\n+public class JavaStubifier {\n+    /**\n+     * Processes each provided command-line argument; see class documentation for details.\n+     *\n+     * @param args command-line arguments: directories to process\n+     */\n+    public static void main(String[] args) {\n+        if (args.length < 1) {\n+            System.err.println(\"Usage: provide one or more directory names to process\");\n+            System.exit(1);\n+        }\n+        for (String arg : args) {\n+            process(arg);\n+        }\n+    }\n+\n+    /**\n+     * Process each file in the given directory; see class documentation for details.\n+     *\n+     * @param dir directory to process\n+     */\n+    private static void process(String dir) {\n+        Path root = Paths.get(dir);\n+        MinimizerCallback mc = new MinimizerCallback();\n+        ProjectRoot projectRoot = new ParserCollectionStrategy().collect(root);\n+\n+        projectRoot\n+                .getSourceRoots()\n+                .forEach(\n+                        sourceRoot -> {\n+                            try {\n+                                sourceRoot.parse(\"\", mc);\n+                            } catch (IOException e) {\n+                                System.err.println(\"IOException: \" + e);\n+                            }\n+                        });\n+    }\n+\n+    /** Callback to process each Java file; see class documentation for details. */\n+    private static class MinimizerCallback implements SourceRoot.Callback {\n+        /** The visitor instance. */\n+        private final MinimizerVisitor mv;\n+\n+        /** Create a MinimizerCallback instance. */\n+        public MinimizerCallback() {\n+            this.mv = new MinimizerVisitor();\n+        }\n+\n+        @Override\n+        public Result process(\n+                Path localPath, Path absolutePath, ParseResult<CompilationUnit> result) {\n+            Result res = Result.SAVE;\n+            // System.out.printf(\"Minimizing %s%n\", absolutePath);\n+            Optional<CompilationUnit> opt = result.getResult();\n+            if (opt.isPresent()) {\n+                CompilationUnit cu = opt.get();\n+                // this somehow only removes comments except the\n+                // first one, and copyright headers are kept\n+                cu.getComments().forEach(Node::remove);\n+                mv.visit(cu, null);\n+                if (cu.findAll(ClassOrInterfaceDeclaration.class).isEmpty()\n+                        && cu.findAll(AnnotationDeclaration.class).isEmpty()\n+                        && cu.findAll(EnumDeclaration.class).isEmpty()\n+                        && !absolutePath.endsWith(\"package-info.java\")) {\n+                    // All content is removed, delete this file.\n+                    new File(absolutePath.toUri()).delete();\n+                    res = Result.DONT_SAVE;\n+                }\n+            }\n+            return res;\n+        }\n+    }\n+\n+    /** Visitor to process one compilation unit; see class documentation for details. */\n+    private static class MinimizerVisitor extends ModifierVisitor<Void> {\n+        /** Whether to consider members implicitly public. */\n+        private boolean implicitlyPublic = false;\n+\n+        @Override\n+        public ClassOrInterfaceDeclaration visit(ClassOrInterfaceDeclaration cid, Void arg) {\n+            boolean prevIP = implicitlyPublic;\n+            if (cid.isInterface()) {\n+                // All members of interfaces are implicitly public.\n+                implicitlyPublic = true;\n+            }\n+            super.visit(cid, arg);\n+            removeIfPrivateOrPkgPrivate(cid);", "originalCommit": "cdfbc9c45551f1b1a0f907315c80f3c413d9423a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMjY4MA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r414102680", "bodyText": "@mernst Thanks for noticing this!\nSo it looks like we can probably never remove a class. Even a private inner class can have a public subclass within the same outer class:\nimport org.checkerframework.checker.nullness.qual.Nullable;\nclass Demo {\n    private class Internal {\n        public void foo(@Nullable Object p) {}\n    }\n    public class Public extends Internal {}\n  \n    void bar(Public p) {\n        p.foo(null);\n    }\n}\nThe public inner class could get exposed, so we need to keep it to maintain annotations from it.\nSimilarly, for AbstractStringBuilder, even though nobody from outside the package can refer to that class, there can be visible subclasses.\nI'll remove that line for classes.\nWe kind-of have the same problem with methods: if a package-private method uses an inheritable annotation (like @Pure), the method affects overriding methods that might become public.\nSo we should also stop removing package-private methods.\nIt's still fine to remove private methods, because they cannot be overridden.\nRemoving private and package-private fields still seems ok to me.\nAny other cases I'm missing?", "author": "wmdietl", "createdAt": "2020-04-23T20:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwNjU4MA==", "url": "https://github.com/typetools/checker-framework/pull/3257#discussion_r414106580", "bodyText": "That seems like a reasonable choice for now.  If the stubs remain too big (or if we have accidentally left something out), we can revisit the design later.", "author": "mernst", "createdAt": "2020-04-23T20:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4NDEyNw=="}], "type": "inlineReview"}, {"oid": "32df31022ddf696fd1e2593f3904240e8bfc9945", "url": "https://github.com/typetools/checker-framework/commit/32df31022ddf696fd1e2593f3904240e8bfc9945", "message": "Fix visibility rules.", "committedDate": "2020-04-23T21:29:26Z", "type": "commit"}]}