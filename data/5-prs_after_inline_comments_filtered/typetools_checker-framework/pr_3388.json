{"pr_number": 3388, "pr_title": "Clarify and refactor how warnings are suppressed.", "pr_createdAt": "2020-06-17T17:11:27Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3388", "timeline": [{"oid": "917e81d569b9a6aa75d90a31e46209ef602b7edf", "url": "https://github.com/typetools/checker-framework/commit/917e81d569b9a6aa75d90a31e46209ef602b7edf", "message": "Tweak documentation", "committedDate": "2020-06-09T22:51:41Z", "type": "commit"}, {"oid": "8328d250d9d7cf572fc8fd1f80afc909869cd76b", "url": "https://github.com/typetools/checker-framework/commit/8328d250d9d7cf572fc8fd1f80afc909869cd76b", "message": "Describe new @Suppresswarnings(\"allcheckers\") behavior", "committedDate": "2020-06-09T22:54:50Z", "type": "commit"}, {"oid": "f5940f361023288ca6fd3df193b573baac6a3397", "url": "https://github.com/typetools/checker-framework/commit/f5940f361023288ca6fd3df193b573baac6a3397", "message": "Implement allcheckers as warning suppression prefix.", "committedDate": "2020-06-12T20:54:54Z", "type": "commit"}, {"oid": "e632f2f227973889d0779224ceaac479c2b80379", "url": "https://github.com/typetools/checker-framework/commit/e632f2f227973889d0779224ceaac479c2b80379", "message": "Merge ../checker-framework-branch-master into suppresswarnings-all-documentation", "committedDate": "2020-06-12T21:35:47Z", "type": "commit"}, {"oid": "f4e8e018de99e35869e7971c240450c4bbe71bd2", "url": "https://github.com/typetools/checker-framework/commit/f4e8e018de99e35869e7971c240450c4bbe71bd2", "message": "Merge ../checker-framework-branch-master into suppresswarnings-all-documentation", "committedDate": "2020-06-16T20:50:41Z", "type": "commit"}, {"oid": "c89327bebe071894c376b0189c64b4d756776b69", "url": "https://github.com/typetools/checker-framework/commit/c89327bebe071894c376b0189c64b4d756776b69", "message": "Merge remote-tracking branch 'origin/master' into suppresswarnings-all-documentation", "committedDate": "2020-06-17T15:57:32Z", "type": "commit"}, {"oid": "9f26f560101ef7f4485aae653e2cabd5e8506c0b", "url": "https://github.com/typetools/checker-framework/commit/9f26f560101ef7f4485aae653e2cabd5e8506c0b", "message": "Tweaks.", "committedDate": "2020-06-17T16:57:45Z", "type": "commit"}, {"oid": "dc574eddefe12a44af916b11dcf1a3817fe971d5", "url": "https://github.com/typetools/checker-framework/commit/dc574eddefe12a44af916b11dcf1a3817fe971d5", "message": "Remove code that isn't needed.", "committedDate": "2020-06-17T17:08:57Z", "type": "commit"}, {"oid": "cb25c45381b0ed0a96af37f4755ea77516f6e05b", "url": "https://github.com/typetools/checker-framework/commit/cb25c45381b0ed0a96af37f4755ea77516f6e05b", "message": "Small typo fixes", "committedDate": "2020-06-17T17:46:38Z", "type": "commit"}, {"oid": "c2ca4ce7c231c1ebaddc724f00dd959e31dec477", "url": "https://github.com/typetools/checker-framework/commit/c2ca4ce7c231c1ebaddc724f00dd959e31dec477", "message": "Make naming more consitent.", "committedDate": "2020-06-17T22:33:49Z", "type": "commit"}, {"oid": "edf033721362a1af17a34c8876905eabcbc53fcf", "url": "https://github.com/typetools/checker-framework/commit/edf033721362a1af17a34c8876905eabcbc53fcf", "message": "Merge remote-tracking branch 'origin/master' into suppresswarnings-all-documentation", "committedDate": "2020-06-18T15:28:00Z", "type": "commit"}, {"oid": "ab165895feaeae1039723db1e894e85de5597139", "url": "https://github.com/typetools/checker-framework/commit/ab165895feaeae1039723db1e894e85de5597139", "message": "Add Javadoc.", "committedDate": "2020-06-18T15:29:28Z", "type": "commit"}, {"oid": "0dcdc63e0437d4cdcb67873fb8903ffcaca9f2e1", "url": "https://github.com/typetools/checker-framework/commit/0dcdc63e0437d4cdcb67873fb8903ffcaca9f2e1", "message": "Use consistent terms.", "committedDate": "2020-06-18T16:34:25Z", "type": "commit"}, {"oid": "47a698e298d73fa9efefb2752011bfdf6838a5a8", "url": "https://github.com/typetools/checker-framework/commit/47a698e298d73fa9efefb2752011bfdf6838a5a8", "message": "Add Javadoc.", "committedDate": "2020-06-18T17:56:30Z", "type": "commit"}, {"oid": "7acf7f877f176a74a9ad54500343dc26f6ce5452", "url": "https://github.com/typetools/checker-framework/commit/7acf7f877f176a74a9ad54500343dc26f6ce5452", "message": "Add renaming to change log.", "committedDate": "2020-06-18T20:18:31Z", "type": "commit"}, {"oid": "af52b1bebbd47b273198fcd04568990d208724cc", "url": "https://github.com/typetools/checker-framework/commit/af52b1bebbd47b273198fcd04568990d208724cc", "message": "Refactor methods.", "committedDate": "2020-06-18T21:49:10Z", "type": "commit"}, {"oid": "c2b525118952b6f022e3928ca70fd09ff8b4381c", "url": "https://github.com/typetools/checker-framework/commit/c2b525118952b6f022e3928ca70fd09ff8b4381c", "message": "Add to change log.", "committedDate": "2020-06-18T21:57:38Z", "type": "commit"}, {"oid": "dac8154c94590bb22198ede5b4131daf890f19b8", "url": "https://github.com/typetools/checker-framework/commit/dac8154c94590bb22198ede5b4131daf890f19b8", "message": "Rename -AshowSuppressWarningKeys to -AshowSuppressWarningStrings.", "committedDate": "2020-06-18T22:03:14Z", "type": "commit"}, {"oid": "e08292241563edce4aa025136018953f225a96b0", "url": "https://github.com/typetools/checker-framework/commit/e08292241563edce4aa025136018953f225a96b0", "message": "Edits from code review", "committedDate": "2020-06-19T04:56:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzMDk1MQ==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r442630951", "bodyText": "This does't seem like the right advice.\nIf there is no @SuppressWarningsPrefix annotation, then the implementation chooses a checker name.\nI think the problem here is that the checker override getSuppressWarningsPrefixes incorrectly, and the message should say that the checker should either override it correctly, or not override it.", "author": "mernst", "createdAt": "2020-06-19T04:58:33Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2023,22 +1913,21 @@ public boolean shouldSuppressWarnings(Object src, String errKey) {\n     /**\n      * Determines whether all the warnings pertaining to a given tree should be suppressed. Returns\n      * true if the tree is within the scope of a @SuppressWarnings annotation, one of whose values\n-     * suppresses the checker's warnings. The list of keys that suppress a checker's warnings is\n-     * provided by the {@link SourceChecker#getSuppressWarningsKeys} method.\n+     * suppresses the checker's warnings.\n      *\n      * @param tree the tree that might be a source of a warning\n      * @param errKey the error key the checker is emitting\n      * @return true if no warning should be emitted for the given tree because it is contained by a\n      *     declaration with an appropriately-valued {@literal @}SuppressWarnings annotation; false\n      *     otherwise\n      */\n-    // Public so it can be called from a few places in\n-    // org.checkerframework.framework.flow.CFAbstractTransfer\n     public boolean shouldSuppressWarnings(Tree tree, String errKey) {\n-        // Don't suppress warnings if this checker provides no key to do so.\n-        Collection<String> checkerKeys = this.getSuppressWarningsKeys();\n-        if (checkerKeys.isEmpty()) {\n-            return false;\n+\n+        Collection<String> prefixes = getSuppressWarningsPrefixes();\n+        if (prefixes.isEmpty()\n+                || (prefixes.contains(SUPPRESS_ALL_PREFIX) && prefixes.size() == 1)) {\n+            throw new BugInCF(", "originalCommit": "e08292241563edce4aa025136018953f225a96b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzMTgxMQ==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r442631811", "bodyText": "The use of Arrays.setAll and a lambda is shorter than this implementation and could be used here.\nMy preference would be to retain the arrayToLowerCase abstraction, though, because its purpose is obvious from its name, whereas I had to read the Arrays.setAll line each time I saw it to understand what it does.  Using the method is also shorter in the client.  Defining the method takes more characters than are saved at the client, but it's more important that clients are short.\nAlternately, we could remove the undocumented behavior of lowercasing user-written @SuppressWarnings for the user.", "author": "mernst", "createdAt": "2020-06-19T05:02:13Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2430,19 +2426,6 @@ private void logBugInCF(BugInCF ce) {\n         printMessage(msg.toString());\n     }\n \n-    /**\n-     * Side-effects the array to make each string lowercase, then returns the array.\n-     *\n-     * @param a an array of strings\n-     * @return {@code a}, but each element has been lowercased\n-     */\n-    private static String[] arrayToLowerCase(String[] a) {", "originalCommit": "e08292241563edce4aa025136018953f225a96b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzMzEwMA==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r442633100", "bodyText": "The implementations of\nSourceChecker.shouldSuppressWarningStringSuppressKey\nSourceChecker.warnUnneededSuppressions\nare very similar.\nEither abstract out common logic, or eliminate one of these two methods.\n(Note that there are some undesirable differences, such as the logic for permitting a user-written messagekey to be a substring of a full Checker Framework messagekey.)", "author": "mernst", "createdAt": "2020-06-19T05:07:45Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -1790,27 +1775,27 @@ protected void warnUnneededSuppressions() {\n \n         Set<Element> elementsSuppress = new HashSet<>(this.elementsWithSuppressedWarnings);\n         this.elementsWithSuppressedWarnings.clear();\n-        Set<String> checkerKeys = new HashSet<>(getSuppressWarningsKeys());\n+        Set<String> prefixes = new HashSet<>(getSuppressWarningsPrefixes());\n         Set<String> errorKeys = new HashSet<>(messagesProperties.stringPropertyNames());\n-        warnUnneededSuppressions(elementsSuppress, checkerKeys, errorKeys);\n+        warnUnneededSuppressions(elementsSuppress, prefixes, errorKeys);\n         getVisitor().treesWithSuppressWarnings.clear();\n     }\n \n     /**\n      * Issues a warning about any {@code @SuppressWarnings} that isn't used by this checker, but\n-     * contains a key that would suppress a warning from this checker.\n+     * contains a string that would suppress a warning from this checker.\n      *\n      * @param elementsSuppress elements with a {@code @SuppressWarnings} that actually suppressed a\n      *     warning\n-     * @param checkerKeys suppress warning keys that suppress any warning from this checker\n-     * @param errorKeys error keys that can be issued by this checker\n+     * @param prefixes Suppresswarnings prefixes that suppress any warning from this checker\n+     * @param allErrorKeys all error keys that can be issued by this checker\n      */\n     protected void warnUnneededSuppressions(", "originalCommit": "e08292241563edce4aa025136018953f225a96b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYzMzMyMA==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r442633320", "bodyText": "The implementations of\nSourceChecker.shouldSuppressWarningStringSuppressKey\nSourceChecker.warnUnneededSuppressions\nare very similar.\nEither abstract out common logic, or eliminate one of these two methods.\n(Note that there are some undesirable differences, such as the logic for permitting a user-written messagekey to be a substring of a full Checker Framework messagekey.)", "author": "mernst", "createdAt": "2020-06-19T05:08:44Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2154,24 +2041,115 @@ public boolean shouldSuppressWarnings(@Nullable Element elt, String errKey) {\n             return false;\n         }\n \n-        if (elt == null) {\n-            return false;\n+        if (shouldSuppressWarningStringSuppressKey(\n+                getSuppressWarningsStringsFromOption(), errKey)) {\n+            return true;\n         }\n \n-        if (checkSuppressWarnings(elt.getAnnotation(SuppressWarnings.class), errKey)) {\n-            if (hasOption(\"warnUnneededSuppressions\")) {\n-                elementsWithSuppressedWarnings.add(elt);\n+        while (elt != null) {\n+            SuppressWarnings suppressWarningsAnno = elt.getAnnotation(SuppressWarnings.class);\n+            if (suppressWarningsAnno != null) {\n+                String[] suppressWarningStrings = suppressWarningsAnno.value();\n+                Arrays.setAll(suppressWarningStrings, i -> suppressWarningStrings[i].toLowerCase());\n+                if (shouldSuppressWarningStringSuppressKey(suppressWarningStrings, errKey)) {\n+                    if (hasOption(\"warnUnneededSuppressions\")) {\n+                        elementsWithSuppressedWarnings.add(elt);\n+                    }\n+                    return true;\n+                }\n             }\n-            return true;\n+            if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n+                // Return false immediately. Do NOT check for AnnotatedFor in the\n+                // enclosing elements, because they may not have an @AnnotatedFor.\n+                return false;\n+            }\n+            elt = elt.getEnclosingElement();\n         }\n+        return false;\n+    }\n \n-        if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n-            // Return false immediately. Do NOT check for AnnotatedFor in the\n-            // enclosing elements, because they may not have an @AnnotatedFor.\n+    /**\n+     * Determines whether an error (whose message key is {@code messageKey}) should be suppressed.\n+     * It is suppressed if any of the given SuppressWarnings strings suppresses it.\n+     *\n+     * <p>A SuppressWarnings string may be of the following pattern:\n+     *\n+     * <ol>\n+     *   <li>{@code \"prefix\"}, where prefix is a SuppressWarnings prefix, as specified by {@link\n+     *       #getSuppressWarningsPrefixes()}. For example, {@code \"nullness\"} and {@code\n+     *       \"initialization\"} for the Nullness Checker, {@code \"regex\"} for the Regex Checker.\n+     *   <li>{@code \"partial-message-key\"}, where partial-message-key is a prefix or suffix of the\n+     *       message key that it may suppress. So \"generic.argument\", would suppress any errors a\n+     *       message key that contains to generic.argument.\n+     *   <li>{@code \"prefix:partial-message-key}, where the prefix and partial-message-key is as\n+     *       above. So \"nullness:generic.argument\", would suppress any errors in the Nullness\n+     *       Checker with a message key that contains to generic.argument.\n+     * </ol>\n+     *\n+     * {@code \"allcheckers\"} is a prefix that suppresses a warning from any checker. {@code \"all\"}\n+     * is a partial-message-key that suppresses a warning with any message key.\n+     *\n+     * <p>If {@code -ArequirePrefixInWarningSuppressions}, then {@code prefix} and {@code\n+     * prefix:partial-message-key} are the only SuppressWarnings strings that have an effect.\n+     *\n+     * @param suppressWarningStrings the SuppressWarnings strings. May be null, in which case this\n+     *     method returns false.\n+     * @param messageKey the message key of the error the checker is emitting; a lowercase string,\n+     *     without any \"checkername:\" prefix\n+     * @return true if one of the {@code suppressWarningStrings} suppresses the error\n+     */\n+    private boolean shouldSuppressWarningStringSuppressKey(", "originalCommit": "e08292241563edce4aa025136018953f225a96b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b816ef2a5afaf1089b4896207dae7caf6737281", "url": "https://github.com/typetools/checker-framework/commit/7b816ef2a5afaf1089b4896207dae7caf6737281", "message": "Address code review.", "committedDate": "2020-06-22T17:42:15Z", "type": "commit"}, {"oid": "e85218e4a77f7308268bf44b4e436d5d1dbdb555", "url": "https://github.com/typetools/checker-framework/commit/e85218e4a77f7308268bf44b4e436d5d1dbdb555", "message": "Correct @AssumeAssert manual section.\"", "committedDate": "2020-06-22T18:00:32Z", "type": "commit"}, {"oid": "18fce2f345c494936bb45dad7eab266d9e61c9ec", "url": "https://github.com/typetools/checker-framework/commit/18fce2f345c494936bb45dad7eab266d9e61c9ec", "message": "Merge ../checker-framework-branch-master into suppresswarnings-all-documentation", "committedDate": "2020-06-24T21:44:57Z", "type": "commit"}, {"oid": "2ad4c66ea2155af2778dd3385bb86ae913f2f2dc", "url": "https://github.com/typetools/checker-framework/commit/2ad4c66ea2155af2778dd3385bb86ae913f2f2dc", "message": "Code review improvements", "committedDate": "2020-06-25T00:02:25Z", "type": "commit"}, {"oid": "cbedb9fff145419edc809bd607fdff2411acd44a", "url": "https://github.com/typetools/checker-framework/commit/cbedb9fff145419edc809bd607fdff2411acd44a", "message": "Change spelling of command-line argument", "committedDate": "2020-06-25T00:18:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0MTI0MQ==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r445241241", "bodyText": "How about renaming this to just \"shouldSuppress\" or to some other shorter name?  I find the current name a bit unwieldy, and it doesn't seem to convey more information than the shorter one.  Also, this method is not really about just keys as the method name implies.\nI would rename the other overload as well.", "author": "mernst", "createdAt": "2020-06-25T00:21:28Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2151,24 +2016,133 @@ public boolean shouldSuppressWarnings(@Nullable Element elt, String errKey) {\n             return false;\n         }\n \n-        if (elt == null) {\n-            return false;\n+        if (shouldSuppressWarningsStringSuppressKey(\n+                errKey, getSuppressWarningsStringsFromOption())) {\n+            return true;\n         }\n \n-        if (checkSuppressWarnings(elt.getAnnotation(SuppressWarnings.class), errKey)) {\n-            if (hasOption(\"warnUnneededSuppressions\")) {\n-                elementsWithSuppressedWarnings.add(elt);\n+        while (elt != null) {\n+            SuppressWarnings suppressWarningsAnno = elt.getAnnotation(SuppressWarnings.class);\n+            if (suppressWarningsAnno != null) {\n+                String[] suppressWarningsStrings = suppressWarningsAnno.value();\n+                Arrays.setAll(\n+                        suppressWarningsStrings, i -> suppressWarningsStrings[i].toLowerCase());\n+                if (shouldSuppressWarningsStringSuppressKey(errKey, suppressWarningsStrings)) {\n+                    if (hasOption(\"warnUnneededSuppressions\")) {\n+                        elementsWithSuppressedWarnings.add(elt);\n+                    }\n+                    return true;\n+                }\n             }\n-            return true;\n+            if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n+                // Return false immediately. Do NOT check for AnnotatedFor in the\n+                // enclosing elements, because they may not have an @AnnotatedFor.\n+                return false;\n+            }\n+            elt = elt.getEnclosingElement();\n         }\n+        return false;\n+    }\n \n-        if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n-            // Return false immediately. Do NOT check for AnnotatedFor in the\n-            // enclosing elements, because they may not have an @AnnotatedFor.\n+    /**\n+     * Determines whether an error (whose message key is {@code messageKey}) should be suppressed.\n+     * It is suppressed if any of the given SuppressWarnings strings suppresses it.\n+     *\n+     * <p>A SuppressWarnings string may be of the following pattern:\n+     *\n+     * <ol>\n+     *   <li>{@code \"prefix\"}, where prefix is a SuppressWarnings prefix, as specified by {@link\n+     *       #getSuppressWarningsPrefixes()}. For example, {@code \"nullness\"} and {@code\n+     *       \"initialization\"} for the Nullness Checker, {@code \"regex\"} for the Regex Checker.\n+     *   <li>{@code \"partial-message-key\"}, where partial-message-key is a prefix or suffix of the\n+     *       message key that it may suppress. So \"generic.argument\" would suppress any errors whose\n+     *       message key contains \"generic.argument\".\n+     *   <li>{@code \"prefix:partial-message-key}, where the prefix and partial-message-key is as\n+     *       above. So \"nullness:generic.argument\", would suppress any errors in the Nullness\n+     *       Checker with a message key that contains \"generic.argument\".\n+     * </ol>\n+     *\n+     * {@code \"allcheckers\"} is a prefix that suppresses a warning from any checker. {@code \"all\"}\n+     * is a partial-message-key that suppresses a warning with any message key.\n+     *\n+     * <p>If the {@code -ArequirePrefixInWarningSuppressions} command-line argument was supplied,\n+     * then {@code \"partial-message-key\"} has no effect; {@code \"prefix\"} and {@code\n+     * \"prefix:partial-message-key\"} are the only SuppressWarnings strings that have an effect.\n+     *\n+     * @param messageKey the message key of the error the checker is emitting; a lowercase string,\n+     *     without any \"checkername:\" prefix\n+     * @param suppressWarningsStrings the SuppressWarnings strings that are in effect. May be null,\n+     *     in which case this method returns false.\n+     * @return true if an element of {@code suppressWarningsStrings} suppresses the error\n+     */\n+    private boolean shouldSuppressWarningsStringSuppressKey(\n+            String messageKey, String @Nullable ... suppressWarningsStrings) {\n+        Set<String> prefixes = this.getSuppressWarningsPrefixes();\n+        return shouldSuppressWarningsStringSuppressKey(\n+                prefixes, messageKey, suppressWarningsStrings);\n+    }\n+\n+    /**\n+     * See {@link #shouldSuppressWarningsStringSuppressKey(String, String...)}\n+     *\n+     * @param prefixes the SuppressWarnings prefixes used by this checker\n+     * @param messageKey the message key of the error the checker is emitting; a lowercase string,\n+     *     without any \"checkername:\" prefix\n+     * @param suppressWarningsStrings the SuppressWarnings strings that are in effect. May be null,\n+     *     in which case this method returns false.\n+     * @return true if one of the {@code suppressWarningsStrings} suppresses the error\n+     */\n+    private boolean shouldSuppressWarningsStringSuppressKey(", "originalCommit": "cbedb9fff145419edc809bd607fdff2411acd44a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0MTQ1Nw==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r445241457", "bodyText": "I don't see any client that makes a varargs call to this method.  How about changing ... to [] (also in the other overload).\nAfter doing that, would it make sense to put the array as the first argument to both variants of the call?  That seems a bit more logical to me, and makes the two overloads a bit more consistent.", "author": "mernst", "createdAt": "2020-06-25T00:22:15Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2151,24 +2016,133 @@ public boolean shouldSuppressWarnings(@Nullable Element elt, String errKey) {\n             return false;\n         }\n \n-        if (elt == null) {\n-            return false;\n+        if (shouldSuppressWarningsStringSuppressKey(\n+                errKey, getSuppressWarningsStringsFromOption())) {\n+            return true;\n         }\n \n-        if (checkSuppressWarnings(elt.getAnnotation(SuppressWarnings.class), errKey)) {\n-            if (hasOption(\"warnUnneededSuppressions\")) {\n-                elementsWithSuppressedWarnings.add(elt);\n+        while (elt != null) {\n+            SuppressWarnings suppressWarningsAnno = elt.getAnnotation(SuppressWarnings.class);\n+            if (suppressWarningsAnno != null) {\n+                String[] suppressWarningsStrings = suppressWarningsAnno.value();\n+                Arrays.setAll(\n+                        suppressWarningsStrings, i -> suppressWarningsStrings[i].toLowerCase());\n+                if (shouldSuppressWarningsStringSuppressKey(errKey, suppressWarningsStrings)) {\n+                    if (hasOption(\"warnUnneededSuppressions\")) {\n+                        elementsWithSuppressedWarnings.add(elt);\n+                    }\n+                    return true;\n+                }\n             }\n-            return true;\n+            if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n+                // Return false immediately. Do NOT check for AnnotatedFor in the\n+                // enclosing elements, because they may not have an @AnnotatedFor.\n+                return false;\n+            }\n+            elt = elt.getEnclosingElement();\n         }\n+        return false;\n+    }\n \n-        if (isAnnotatedForThisCheckerOrUpstreamChecker(elt)) {\n-            // Return false immediately. Do NOT check for AnnotatedFor in the\n-            // enclosing elements, because they may not have an @AnnotatedFor.\n+    /**\n+     * Determines whether an error (whose message key is {@code messageKey}) should be suppressed.\n+     * It is suppressed if any of the given SuppressWarnings strings suppresses it.\n+     *\n+     * <p>A SuppressWarnings string may be of the following pattern:\n+     *\n+     * <ol>\n+     *   <li>{@code \"prefix\"}, where prefix is a SuppressWarnings prefix, as specified by {@link\n+     *       #getSuppressWarningsPrefixes()}. For example, {@code \"nullness\"} and {@code\n+     *       \"initialization\"} for the Nullness Checker, {@code \"regex\"} for the Regex Checker.\n+     *   <li>{@code \"partial-message-key\"}, where partial-message-key is a prefix or suffix of the\n+     *       message key that it may suppress. So \"generic.argument\" would suppress any errors whose\n+     *       message key contains \"generic.argument\".\n+     *   <li>{@code \"prefix:partial-message-key}, where the prefix and partial-message-key is as\n+     *       above. So \"nullness:generic.argument\", would suppress any errors in the Nullness\n+     *       Checker with a message key that contains \"generic.argument\".\n+     * </ol>\n+     *\n+     * {@code \"allcheckers\"} is a prefix that suppresses a warning from any checker. {@code \"all\"}\n+     * is a partial-message-key that suppresses a warning with any message key.\n+     *\n+     * <p>If the {@code -ArequirePrefixInWarningSuppressions} command-line argument was supplied,\n+     * then {@code \"partial-message-key\"} has no effect; {@code \"prefix\"} and {@code\n+     * \"prefix:partial-message-key\"} are the only SuppressWarnings strings that have an effect.\n+     *\n+     * @param messageKey the message key of the error the checker is emitting; a lowercase string,\n+     *     without any \"checkername:\" prefix\n+     * @param suppressWarningsStrings the SuppressWarnings strings that are in effect. May be null,\n+     *     in which case this method returns false.\n+     * @return true if an element of {@code suppressWarningsStrings} suppresses the error\n+     */\n+    private boolean shouldSuppressWarningsStringSuppressKey(\n+            String messageKey, String @Nullable ... suppressWarningsStrings) {\n+        Set<String> prefixes = this.getSuppressWarningsPrefixes();\n+        return shouldSuppressWarningsStringSuppressKey(\n+                prefixes, messageKey, suppressWarningsStrings);\n+    }\n+\n+    /**\n+     * See {@link #shouldSuppressWarningsStringSuppressKey(String, String...)}\n+     *\n+     * @param prefixes the SuppressWarnings prefixes used by this checker\n+     * @param messageKey the message key of the error the checker is emitting; a lowercase string,\n+     *     without any \"checkername:\" prefix\n+     * @param suppressWarningsStrings the SuppressWarnings strings that are in effect. May be null,\n+     *     in which case this method returns false.\n+     * @return true if one of the {@code suppressWarningsStrings} suppresses the error\n+     */\n+    private boolean shouldSuppressWarningsStringSuppressKey(\n+            Set<String> prefixes, String messageKey, String @Nullable ... suppressWarningsStrings) {", "originalCommit": "cbedb9fff145419edc809bd607fdff2411acd44a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0MjA2OA==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r445242068", "bodyText": "I wonder if \"allcheckers\" should be put at the end of the list rather than the beginning, so it is less prominent in the output of -AshowSuppressWarningStrings.", "author": "mernst", "createdAt": "2020-06-25T00:24:20Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -2203,38 +2177,59 @@ private boolean isAnnotatedForThisCheckerOrUpstreamChecker(@Nullable Element elt\n     }\n \n     /**\n-     * Determine the standard set of suppress warning keys usable for any checker.\n+     * Returns a modifiable set of lower-case strings that are prefixes for SuppressWarnings\n+     * strings.\n      *\n-     * @see #getSuppressWarningsKeys()\n-     * @return collection of warning keys\n+     * <p>The collection must not be empty and must not contain only {@link #SUPPRESS_ALL_PREFIX}.\n+     *\n+     * @return non-empty modifiable set of lower-case prefixes for SuppressWarnings strings\n+     */\n+    public SortedSet<String> getSuppressWarningsPrefixes() {\n+        return getStandardSuppressWarningsPrefixes();\n+    }\n+\n+    /**\n+     * Returns a sorted set of SuppressWarnings prefixes read from the {@link\n+     * SuppressWarningsPrefix} meta-annotation on the checker class. Or if no {@link\n+     * SuppressWarningsPrefix} is used, the checker name is used. {@link #SUPPRESS_ALL_PREFIX} is\n+     * also added, at the end.\n+     *\n+     * @return a sorted set of SuppressWarnings prefixes\n      */\n-    protected final Collection<String> getStandardSuppressWarningsKeys() {\n-        // TreeSet ensures keys are returned in a consistent order.\n-        Set<String> result = new TreeSet<>();\n-        result.add(SUPPRESS_ALL_KEY);\n+    protected final NavigableSet<String> getStandardSuppressWarningsPrefixes() {\n+        NavigableSet<String> prefixes = new TreeSet<>();\n+        prefixes.add(SUPPRESS_ALL_PREFIX);", "originalCommit": "cbedb9fff145419edc809bd607fdff2411acd44a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwMjQyOQ==", "url": "https://github.com/typetools/checker-framework/pull/3388#discussion_r445702429", "bodyText": "It's a TreeSet, so it is ordered by name. I'll change the order when it is printed though.", "author": "smillst", "createdAt": "2020-06-25T16:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI0MjA2OA=="}], "type": "inlineReview"}, {"oid": "bd00c491bbd1c539f58618f663ebae5a5d2303c9", "url": "https://github.com/typetools/checker-framework/commit/bd00c491bbd1c539f58618f663ebae5a5d2303c9", "message": "Add Javadoc", "committedDate": "2020-06-25T03:08:00Z", "type": "commit"}, {"oid": "f92fa89301f351be36f43872bbcf6428eaf47508", "url": "https://github.com/typetools/checker-framework/commit/f92fa89301f351be36f43872bbcf6428eaf47508", "message": "Fix Javadoc error", "committedDate": "2020-06-25T04:04:06Z", "type": "commit"}, {"oid": "1162a7df18382ffae44e59cabad80c010f8619e6", "url": "https://github.com/typetools/checker-framework/commit/1162a7df18382ffae44e59cabad80c010f8619e6", "message": "Address review comments.", "committedDate": "2020-06-25T17:11:53Z", "type": "commit"}, {"oid": "464de2ab5bcef43c68ab02e46af935561ee40050", "url": "https://github.com/typetools/checker-framework/commit/464de2ab5bcef43c68ab02e46af935561ee40050", "message": "Merge remote-tracking branch 'origin/master' into suppresswarnings-all-documentation", "committedDate": "2020-06-26T15:31:16Z", "type": "commit"}, {"oid": "2e8d783c6336e59d8e0bd865500d002df7c77fd2", "url": "https://github.com/typetools/checker-framework/commit/2e8d783c6336e59d8e0bd865500d002df7c77fd2", "message": "Merge remote-tracking branch 'origin/master' into suppresswarnings-all-documentation", "committedDate": "2020-06-26T16:54:04Z", "type": "commit"}]}