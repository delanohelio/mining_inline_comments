{"pr_number": 3173, "pr_title": "Correct method type argument inference with null; fixes #3056; fixes #3150.", "pr_createdAt": "2020-03-17T14:44:08Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3173", "timeline": [{"oid": "067bed91a1bcf338a230b11b19d933b0607d2d31", "url": "https://github.com/typetools/checker-framework/commit/067bed91a1bcf338a230b11b19d933b0607d2d31", "message": "Fix issues.", "committedDate": "2020-03-17T14:41:50Z", "type": "commit"}, {"oid": "e442dfd6bfc990a646fe8be2546767a9dff43207", "url": "https://github.com/typetools/checker-framework/commit/e442dfd6bfc990a646fe8be2546767a9dff43207", "message": "Fix.", "committedDate": "2020-03-17T18:11:58Z", "type": "commit"}, {"oid": "c48450bc7fa076733115b96b9fb9675e7ffc8d99", "url": "https://github.com/typetools/checker-framework/commit/c48450bc7fa076733115b96b9fb9675e7ffc8d99", "message": "Skip test for now.", "committedDate": "2020-03-17T19:12:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NDg5OQ==", "url": "https://github.com/typetools/checker-framework/pull/3173#discussion_r394494899", "bodyText": "I find this change in expected error message unintuitive and undesirable.\nThere is no type argument here, so raising an invalid type argument error is misleading.\nType argument inference should always produce type arguments that respect the bounds. Then supplied arguments can cause errors if they don't respect that bound.\nHere, I would expect that type argument inference determines @NonNull Object as the type argument and then the argument should give an error.\nFor a similar reason I don't like typetools/jdk#36 : it changes the signature just to account for bad type inference, even though that bad type inference shouldn't give different errors.\nWould it be hard to do a GLB between each inferred type argument and the bounds?", "author": "wmdietl", "createdAt": "2020-03-18T16:50:41Z", "path": "checker/tests/nullness/Issue3150.java", "diffHunk": "@@ -1,15 +1,13 @@\n-// @skip-test until the bug is fixed\n-\n // Test case for https://tinyurl.com/cfissue/3150 .\n \n import org.checkerframework.checker.nullness.qual.NonNull;\n import org.checkerframework.checker.nullness.qual.Nullable;\n \n class Issue3150 {\n     void foo(@Nullable Object nble, @NonNull Object nn) {\n-        // :: error: (argument.type.incompatible)\n+        // :: error: (type.argument.type.incompatible)", "originalCommit": "c48450bc7fa076733115b96b9fb9675e7ffc8d99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4ODI4NQ==", "url": "https://github.com/typetools/checker-framework/pull/3173#discussion_r395288285", "bodyText": "GLB the inferred type argument and its corresponding bound is tricky when the bound is another type variable. See  checker/tests/nullness/InferNullType.java.  As you can see in that example, the Checker Framework currently does infer type arguments that are outside its bounds.  I'll spend a little more time trying to change this so that it infers a type argument within the bound, but if it's not easy, then I think we should just open a separate issue.", "author": "smillst", "createdAt": "2020-03-19T20:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MjExNg==", "url": "https://github.com/typetools/checker-framework/pull/3173#discussion_r396582116", "bodyText": "Something like the following should work:\n1. get possible incorrect assignment of type parameters to inferred type arguments\n2. Iterate while there are changes:\n2.1 Compute the type parameter bounds under the current assignment, to resolve type parameter uses\n2.2 Go through all type parameters and GLB the inferred type argument with the current bound\n\nOnce #979 is fixed, this additional step shouldn't be necessary, but this might be a good time to improve the quality of type inference.", "author": "wmdietl", "createdAt": "2020-03-23T16:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NDg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NjgyNA==", "url": "https://github.com/typetools/checker-framework/pull/3173#discussion_r394496824", "bodyText": "I'm confused why it is the right thing to use the annotations only from the first result. The loop goes through all type parameters, multiple of which might come from null, but only the first determines the value of objectWithAnnosFromNull.\nCan you add an explanation?\nOr should you ask the type factory what the type of null is, instead?", "author": "wmdietl", "createdAt": "2020-03-18T16:53:19Z", "path": "framework/src/main/java/org/checkerframework/framework/util/typeinference/DefaultTypeArgumentInference.java", "diffHunk": "@@ -237,7 +244,14 @@ private void handleNullTypeArguments(\n                 if (withoutNullResult == null) {\n                     // withoutNullResult is null when the only constraint on a type argument is\n                     // where a method argument is null.\n-                    withoutNullResult = typeFactory.getUninferredWildcardType(atv);\n+                    if (objectWithAnnosFromNull == null) {\n+                        Elements elements = typeFactory.getProcessingEnv().getElementUtils();\n+                        TypeMirror objectTM = elements.getTypeElement(\"java.lang.Object\").asType();\n+                        objectWithAnnosFromNull =\n+                                AnnotatedTypeMirror.createType(objectTM, typeFactory, false);\n+                        objectWithAnnosFromNull.addAnnotations(result.getAnnotations());", "originalCommit": "c48450bc7fa076733115b96b9fb9675e7ffc8d99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NzA5Mw==", "url": "https://github.com/typetools/checker-framework/pull/3173#discussion_r394497093", "bodyText": "Also, should objectWithAnnosFromNull be set to null again at some point?", "author": "wmdietl", "createdAt": "2020-03-18T16:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5NjgyNA=="}], "type": "inlineReview"}, {"oid": "0475a56e9744e2c97e5da41d1aefb0c9b2b143cd", "url": "https://github.com/typetools/checker-framework/commit/0475a56e9744e2c97e5da41d1aefb0c9b2b143cd", "message": "Fix.", "committedDate": "2020-03-19T13:33:15Z", "type": "commit"}, {"oid": "c40967d141d5a1f92e87315369665c89041d31c4", "url": "https://github.com/typetools/checker-framework/commit/c40967d141d5a1f92e87315369665c89041d31c4", "message": "Merge remote-tracking branch 'origin/master' into issue3150", "committedDate": "2020-03-20T16:52:56Z", "type": "commit"}, {"oid": "f9ff29067e68f161efbf1132f9d26307d57f7246", "url": "https://github.com/typetools/checker-framework/commit/f9ff29067e68f161efbf1132f9d26307d57f7246", "message": "Unskip test that is fixed by this pull request", "committedDate": "2020-03-24T16:47:08Z", "type": "commit"}]}