{"pr_number": 3338, "pr_title": "Don't issue warnings about compiler-inserted modifiers; fixes #3305", "pr_createdAt": "2020-05-28T20:07:03Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3338", "timeline": [{"oid": "6dde9fcf642f98fc27a09114bb32b1718612219a", "url": "https://github.com/typetools/checker-framework/commit/6dde9fcf642f98fc27a09114bb32b1718612219a", "message": "Don't issue warnings about (more) compiler-inserted modifiers; fixes #3305", "committedDate": "2020-05-27T17:08:09Z", "type": "commit"}, {"oid": "e5d3c6b396effb79a34e5180b72d4a3bb2fdd84e", "url": "https://github.com/typetools/checker-framework/commit/e5d3c6b396effb79a34e5180b72d4a3bb2fdd84e", "message": "Fix URL", "committedDate": "2020-05-28T21:26:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzNDY5MA==", "url": "https://github.com/typetools/checker-framework/pull/3338#discussion_r432134690", "bodyText": "Do you want to add a test with an expected error, e.g. for try (@Nullable final AutoCloseable obj = null) {?", "author": "wmdietl", "createdAt": "2020-05-28T21:29:15Z", "path": "checker/tests/nullness/TryWithResourcesAnno.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Test case for https://tinyurl.com/cfissue/3305 .\n+\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+public class TryWithResourcesAnno {\n+    public static void f() {\n+        try (@Nullable AutoCloseable obj = null) {\n+        } catch (Exception e) {\n+        }\n+    }\n+\n+    public static void g() {\n+        try (@Nullable AutoCloseable obj1 = null;\n+                AutoCloseable obj2 = null) {\n+        } catch (Exception e) {\n+        }\n+    }\n+\n+    public static void h() {\n+        try (AutoCloseable obj1 = null;", "originalCommit": "e5d3c6b396effb79a34e5180b72d4a3bb2fdd84e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzODM4OA==", "url": "https://github.com/typetools/checker-framework/pull/3338#discussion_r432138388", "bodyText": "I now see that the implementation wouldn't find such an issue.\nI'm wondering a bit why the same problem doesn't exist for implicitly public methods in interfaces...\ninterface Foo {\n    @Nullable public Object get();\n}\ncorrectly gives a warning, but when I remove the explicit public the warning goes away.\nMaybe the public isn't added to the modifiers in that situation?\nAnyways, the shortcoming is documented in the method below, so we don't need a todo test.", "author": "wmdietl", "createdAt": "2020-05-28T21:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzNDY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MDQyNw==", "url": "https://github.com/typetools/checker-framework/pull/3338#discussion_r432140427", "bodyText": "I'm always a bit worried about using Paths, because they can be costly.\nI think you can simplify this significantly:\n\ndetermine the variable kind once kind = TreeUtils.elementFromDeclaration((VariableTree) node).getKind()\nif kind is ENUM_CONSTANT it's an enum constant\nif kind is RESOURCE_VARIABLE it's a try resource\n\nSo you don't need a path and the two checks are more symmetric.", "author": "wmdietl", "createdAt": "2020-05-28T21:41:47Z", "path": "framework/src/main/java/org/checkerframework/common/basetype/BaseTypeVisitor.java", "diffHunk": "@@ -1051,13 +1051,25 @@ public Void visitVariable(VariableTree node, Void p) {\n      * @param modifiersTree the modifiers sub-tree of node\n      */\n     private void warnAboutTypeAnnotationsTooEarly(Tree node, ModifiersTree modifiersTree) {\n-        if (node.getKind() == Tree.Kind.VARIABLE\n-                && TreeUtils.elementFromDeclaration((VariableTree) node).getKind()\n-                        == ElementKind.ENUM_CONSTANT) {\n-            // Enums constants are \"public static final\" by default, so the annotation always\n-            // appears to be before public.\n-            return;\n+\n+        // Don't issue warnings about compiler-inserted modifiers.\n+        // These two tests could be made more precise and catch some user errors in enum constants\n+        // and in try-with-resources declarations, but it doesn't seem worth the effort.\n+        if (node.getKind() == Tree.Kind.VARIABLE) {\n+            if (TreeUtils.elementFromDeclaration((VariableTree) node).getKind()\n+                    == ElementKind.ENUM_CONSTANT) {\n+                // Enum constants are \"public static final\" by default, so the annotation always\n+                // appears to be before \"public\".\n+                return;\n+            }\n+            Tree parent = getCurrentPath().getParentPath().getLeaf();", "originalCommit": "e5d3c6b396effb79a34e5180b72d4a3bb2fdd84e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0NzI1OA==", "url": "https://github.com/typetools/checker-framework/pull/3338#discussion_r432147258", "bodyText": "Yes, that is better.  I made that change.", "author": "mernst", "createdAt": "2020-05-28T21:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MDQyNw=="}], "type": "inlineReview"}, {"oid": "7618b8cb051ad2b73dbd7d3f911bf4908cb81c85", "url": "https://github.com/typetools/checker-framework/commit/7618b8cb051ad2b73dbd7d3f911bf4908cb81c85", "message": "Fix comments that were not updated when an argument was removed", "committedDate": "2020-05-28T21:53:36Z", "type": "commit"}, {"oid": "c52e10f3b89b2a5f33a8d7a36efec2a30caa8caa", "url": "https://github.com/typetools/checker-framework/commit/c52e10f3b89b2a5f33a8d7a36efec2a30caa8caa", "message": "Use more efficient and uniform test", "committedDate": "2020-05-28T21:54:08Z", "type": "commit"}, {"oid": "d9645a84e698e447ee587d8966d41f4ffc0c988f", "url": "https://github.com/typetools/checker-framework/commit/d9645a84e698e447ee587d8966d41f4ffc0c988f", "message": "Merge ../checker-framework-branch-master into trywithresources-annobeforemodifier", "committedDate": "2020-05-28T21:54:30Z", "type": "commit"}, {"oid": "74bbc0bd9f3755238af2ed152797cea38d20c963", "url": "https://github.com/typetools/checker-framework/commit/74bbc0bd9f3755238af2ed152797cea38d20c963", "message": "Merge branch 'trywithresources-annobeforemodifier' of github.com:mernst/checker-framework into trywithresources-annobeforemodifier", "committedDate": "2020-05-28T21:55:30Z", "type": "commit"}, {"oid": "e29ed2ca467abb68ceac5e923d4eb9943b1fa790", "url": "https://github.com/typetools/checker-framework/commit/e29ed2ca467abb68ceac5e923d4eb9943b1fa790", "message": "Merge ../checker-framework-branch-master into trywithresources-annobeforemodifier", "committedDate": "2020-05-28T21:56:30Z", "type": "commit"}]}