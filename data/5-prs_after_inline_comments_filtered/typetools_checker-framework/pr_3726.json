{"pr_number": 3726, "pr_title": "Split getValueWithSameAnnotations() into getWidenedValue() and getNarrowedValue()", "pr_createdAt": "2020-10-01T23:58:28Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3726", "timeline": [{"oid": "02f8d117fa6cf37447b291aefa3a27c9247cee84", "url": "https://github.com/typetools/checker-framework/commit/02f8d117fa6cf37447b291aefa3a27c9247cee84", "message": "Split getValueWithSameAnnotations() into getNarrowedValue() and getWidenedValue()", "committedDate": "2020-10-01T16:16:27Z", "type": "commit"}, {"oid": "881cb09519e1d059b0ca25416c130c10c8c6d6f5", "url": "https://github.com/typetools/checker-framework/commit/881cb09519e1d059b0ca25416c130c10c8c6d6f5", "message": "Simplify CharCast test case", "committedDate": "2020-10-01T18:26:00Z", "type": "commit"}, {"oid": "1b915467c4eef79d54516af159b96eba8f054b22", "url": "https://github.com/typetools/checker-framework/commit/1b915467c4eef79d54516af159b96eba8f054b22", "message": "Further simplify CharCast test case", "committedDate": "2020-10-01T18:29:01Z", "type": "commit"}, {"oid": "16175bf7c242b6ac0ced38dced0bb97aaec8be83", "url": "https://github.com/typetools/checker-framework/commit/16175bf7c242b6ac0ced38dced0bb97aaec8be83", "message": "Further simplify CharCast test case", "committedDate": "2020-10-01T18:31:33Z", "type": "commit"}, {"oid": "7a1a965f548b86ce50213aa0f22ce1c7cf030ed6", "url": "https://github.com/typetools/checker-framework/commit/7a1a965f548b86ce50213aa0f22ce1c7cf030ed6", "message": "Merge ../checker-framework-fork-mernst-branch-simplify-charcast-test into split-getValueWithSameAnnotations", "committedDate": "2020-10-01T18:33:55Z", "type": "commit"}, {"oid": "1e729e1a4a0912c3c5286a8bf2e11ef3a6e1c82a", "url": "https://github.com/typetools/checker-framework/commit/1e729e1a4a0912c3c5286a8bf2e11ef3a6e1c82a", "message": "Checkpoint", "committedDate": "2020-10-01T19:50:08Z", "type": "commit"}, {"oid": "1499b0d971ea57cc2cfd34bf574f604c95a05998", "url": "https://github.com/typetools/checker-framework/commit/1499b0d971ea57cc2cfd34bf574f604c95a05998", "message": "Only call getWidenedPrimitive if appropriate", "committedDate": "2020-10-01T23:30:26Z", "type": "commit"}, {"oid": "641f5ce16cfbae11647fc0e3e4739f92d8f2877e", "url": "https://github.com/typetools/checker-framework/commit/641f5ce16cfbae11647fc0e3e4739f92d8f2877e", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-01T23:32:13Z", "type": "commit"}, {"oid": "77aa867e19742ee600487d20a4f853a41312f69f", "url": "https://github.com/typetools/checker-framework/commit/77aa867e19742ee600487d20a4f853a41312f69f", "message": "Augment documentation", "committedDate": "2020-10-01T23:38:14Z", "type": "commit"}, {"oid": "cc8679b206e23e4b5e60476245a2ed0d9a3e9ac3", "url": "https://github.com/typetools/checker-framework/commit/cc8679b206e23e4b5e60476245a2ed0d9a3e9ac3", "message": "Mention widening before narrowing, consistent with the JLS", "committedDate": "2020-10-01T23:53:48Z", "type": "commit"}, {"oid": "eb215dfd3778604b36a3509ad7ebac2688590aa9", "url": "https://github.com/typetools/checker-framework/commit/eb215dfd3778604b36a3509ad7ebac2688590aa9", "message": "Swap order", "committedDate": "2020-10-01T23:59:05Z", "type": "commit"}, {"oid": "584f071bbe5aee0966b9a543f51b87262eaef008", "url": "https://github.com/typetools/checker-framework/commit/584f071bbe5aee0966b9a543f51b87262eaef008", "message": "Merge ../checker-framework-fork-mernst-branch-widening-before-narrowing into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T00:01:15Z", "type": "commit"}, {"oid": "355f6bfe1eba4f468ed65b6eb1fd6c99c3b79560", "url": "https://github.com/typetools/checker-framework/commit/355f6bfe1eba4f468ed65b6eb1fd6c99c3b79560", "message": "Don't require Javadoc for whole file", "committedDate": "2020-10-02T00:21:01Z", "type": "commit"}, {"oid": "af054742ebaa289ae9b3457dd1e60871cac22225", "url": "https://github.com/typetools/checker-framework/commit/af054742ebaa289ae9b3457dd1e60871cac22225", "message": "Merge ../checker-framework-fork-mernst-branch-widening-before-narrowing into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T00:28:36Z", "type": "commit"}, {"oid": "03cda54f4b0ef8d3c48b32df970f3049f37e3aa7", "url": "https://github.com/typetools/checker-framework/commit/03cda54f4b0ef8d3c48b32df970f3049f37e3aa7", "message": "Add test case", "committedDate": "2020-10-02T01:03:45Z", "type": "commit"}, {"oid": "d725bc3d47bad4d8e60c0e775eef934cccb61043", "url": "https://github.com/typetools/checker-framework/commit/d725bc3d47bad4d8e60c0e775eef934cccb61043", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T01:56:57Z", "type": "commit"}, {"oid": "b959bd374fadba27c71b2cc915d0ea899c941207", "url": "https://github.com/typetools/checker-framework/commit/b959bd374fadba27c71b2cc915d0ea899c941207", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T02:42:19Z", "type": "commit"}, {"oid": "01cf64f14276573cc0e6d8bd4f77d855ce45e2d9", "url": "https://github.com/typetools/checker-framework/commit/01cf64f14276573cc0e6d8bd4f77d855ce45e2d9", "message": "Fix bad merge", "committedDate": "2020-10-02T03:50:09Z", "type": "commit"}, {"oid": "b61580793b0f9b055ad9e36dae96fd4525f03432", "url": "https://github.com/typetools/checker-framework/commit/b61580793b0f9b055ad9e36dae96fd4525f03432", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T03:50:34Z", "type": "commit"}, {"oid": "7c4caceb73270cd7370cbaa0274e452b34076123", "url": "https://github.com/typetools/checker-framework/commit/7c4caceb73270cd7370cbaa0274e452b34076123", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T05:00:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0NDU2Ng==", "url": "https://github.com/typetools/checker-framework/pull/3726#discussion_r498944566", "bodyText": "Should widenedTypeKind be renamed to narrowedTypeKind?", "author": "smillst", "createdAt": "2020-10-02T17:08:03Z", "path": "checker/src/main/java/org/checkerframework/checker/signedness/SignednessAnnotatedTypeFactory.java", "diffHunk": "@@ -184,28 +188,39 @@ private void addSignednessGlbAnnotation(Tree tree, AnnotatedTypeMirror type) {\n             Set<AnnotationMirror> annos, TypeKind typeKind, TypeKind widenedTypeKind) {\n         assert annos.size() == 1;\n \n-        if (TypeKindUtils.isNarrower(typeKind, widenedTypeKind)) {\n-            Set<AnnotationMirror> result = AnnotationUtils.createAnnotationSet();\n-            if (TypeKindUtils.isFloatingPoint(widenedTypeKind)) {\n-                result.add(SIGNED);\n-                return result;\n-            }\n-            if (getQualifierHierarchy().isSubtype(annos.iterator().next(), UNSIGNED)) {\n-                result.add(SIGNED_POSITIVE_FROM_UNSIGNED);\n-                return result;\n-            } else {\n-                result.add(SIGNEDNESS_GLB);\n-                return result;\n-            }\n+        Set<AnnotationMirror> result = AnnotationUtils.createAnnotationSet();\n+        if (TypeKindUtils.isFloatingPoint(widenedTypeKind)) {\n+            result.add(SIGNED);\n+            return result;\n         }\n         if (widenedTypeKind == TypeKind.CHAR) {\n-            // It's a non-widening cast to char.  Make it @Unsigned.\n-            Set<AnnotationMirror> result = AnnotationUtils.createAnnotationSet();\n             result.add(UNSIGNED);\n             return result;\n         }\n-        if (widenedTypeKind == TypeKind.FLOAT || widenedTypeKind == TypeKind.DOUBLE) {\n-            Set<AnnotationMirror> result = AnnotationUtils.createAnnotationSet();\n+        AnnotationMirror anno = annos.iterator().next();\n+        if (AnnotationUtils.areSame(anno, POLY_SIGNED)) {\n+            return annos;\n+        } else if (getQualifierHierarchy().isSubtype(anno, UNSIGNED)) {\n+            // TODO: A future enhancement will make the widened type indicate the unsigned basetype\n+            // from which it was widened.\n+            result.add(SIGNED_POSITIVE_FROM_UNSIGNED);\n+            return result;\n+        } else {\n+            // TODO: A future enhancement will make the widened type indicate the signed basetype\n+            // from which it was widened.\n+            result.add(SIGNEDNESS_GLB);\n+            return result;\n+        }\n+    }\n+\n+    @Override\n+    public Set<AnnotationMirror> getNarrowedAnnotations(\n+            Set<AnnotationMirror> annos, TypeKind typeKind, TypeKind widenedTypeKind) {", "originalCommit": "7c4caceb73270cd7370cbaa0274e452b34076123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ad47c3e34071f1d729d2a590af62c33e45a8591b", "url": "https://github.com/typetools/checker-framework/commit/ad47c3e34071f1d729d2a590af62c33e45a8591b", "message": "Address code review feedback", "committedDate": "2020-10-02T17:33:11Z", "type": "commit"}, {"oid": "bdd72f363788bd893fe66d4791fee03b7ee9d2c4", "url": "https://github.com/typetools/checker-framework/commit/bdd72f363788bd893fe66d4791fee03b7ee9d2c4", "message": "Update version number", "committedDate": "2020-10-02T18:13:41Z", "type": "commit"}, {"oid": "bdbb074b7c09cd115f2119ff5ff57fe91b88d097", "url": "https://github.com/typetools/checker-framework/commit/bdbb074b7c09cd115f2119ff5ff57fe91b88d097", "message": "Deprecate, don't remove", "committedDate": "2020-10-02T18:29:49Z", "type": "commit"}, {"oid": "189f4cdc47114975e98b81edddd87611b1a8a9b4", "url": "https://github.com/typetools/checker-framework/commit/189f4cdc47114975e98b81edddd87611b1a8a9b4", "message": "Add test case for #3710", "committedDate": "2020-10-02T19:18:36Z", "type": "commit"}, {"oid": "df9c3b7bcb558d19fca99a5e0f2b8292c2a9217b", "url": "https://github.com/typetools/checker-framework/commit/df9c3b7bcb558d19fca99a5e0f2b8292c2a9217b", "message": "Add Javadoc", "committedDate": "2020-10-02T19:18:47Z", "type": "commit"}, {"oid": "7b813f93ffcdaf82fb7073b4e765fc9fa6e6f1ad", "url": "https://github.com/typetools/checker-framework/commit/7b813f93ffcdaf82fb7073b4e765fc9fa6e6f1ad", "message": "Merge ../checker-framework-branch-master into split-getValueWithSameAnnotations", "committedDate": "2020-10-02T19:20:26Z", "type": "commit"}]}