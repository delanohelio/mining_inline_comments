{"pr_number": 3524, "pr_title": "Propagate length information from argument to return value of Arrays.copyOf()", "pr_createdAt": "2020-07-29T12:29:43Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3524", "timeline": [{"oid": "5624d27a78b4f001b1e3c221bef373f66cb22a7d", "url": "https://github.com/typetools/checker-framework/commit/5624d27a78b4f001b1e3c221bef373f66cb22a7d", "message": "Merge pull request #1 from typetools/master\n\nUpdate fork", "committedDate": "2020-07-10T12:48:35Z", "type": "commit"}, {"oid": "3723b511d80ffc2424695f00d5765514782a92e4", "url": "https://github.com/typetools/checker-framework/commit/3723b511d80ffc2424695f00d5765514782a92e4", "message": "Merge pull request #4 from typetools/master\n\nUpdating fork", "committedDate": "2020-07-21T02:21:51Z", "type": "commit"}, {"oid": "32a728fa0fc51699fbeefd70c7dfa1b797ddfafa", "url": "https://github.com/typetools/checker-framework/commit/32a728fa0fc51699fbeefd70c7dfa1b797ddfafa", "message": "Temporary fix for #3224", "committedDate": "2020-07-25T03:58:04Z", "type": "commit"}, {"oid": "2fea713f6d5402497c9d2abee4b2ba1755b1a54a", "url": "https://github.com/typetools/checker-framework/commit/2fea713f6d5402497c9d2abee4b2ba1755b1a54a", "message": "Add ArrayLen annotations from @IntVal", "committedDate": "2020-07-26T03:45:35Z", "type": "commit"}, {"oid": "888a7a4d45dba9e750ceb1d8dcf144788d4f880e", "url": "https://github.com/typetools/checker-framework/commit/888a7a4d45dba9e750ceb1d8dcf144788d4f880e", "message": "Remove unnecessary () and add documentation to test case", "committedDate": "2020-07-28T02:29:11Z", "type": "commit"}, {"oid": "48ad98a2e508c37609e6afa1816fe662e2444bdc", "url": "https://github.com/typetools/checker-framework/commit/48ad98a2e508c37609e6afa1816fe662e2444bdc", "message": "Merge pull request #8 from typetools/master\n\nUpdate fork", "committedDate": "2020-07-29T02:12:04Z", "type": "commit"}, {"oid": "688ca4f12aa48340354a9fc8b3748296efabcddb", "url": "https://github.com/typetools/checker-framework/commit/688ca4f12aa48340354a9fc8b3748296efabcddb", "message": "Remove unnecessary ()", "committedDate": "2020-07-29T03:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1Njk2OA==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r462456968", "bodyText": "This only tests that the second argument is any array length access expression. The correct test needs to check that it is an array length access for the array that is the first argument. You can add a test case for this:\n    public static void m4(String @MinLen(1) [] args, String[] otherArray) {\n        // :: error: assignment.type.incompatible\n        String @MinLen(1) [] args2 = Arrays.copyOf(args, otherArray.length);\n    }", "author": "kelloggm", "createdAt": "2020-07-29T17:13:05Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueVisitor.java", "diffHunk": "@@ -76,6 +79,26 @@ protected void commonAssignmentCheck(\n                     getTypeFactory().createIntRangeAnnotation(Range.CHAR_EVERYTHING));\n         }\n \n+        if (valueTree.getKind() == Kind.METHOD_INVOCATION\n+                && TreeUtils.isArrayscopyOfMethodInvocation((MethodInvocationTree) valueTree)\n+                && valueType.getKind() == TypeKind.ARRAY) {\n+            List<? extends ExpressionTree> args = ((MethodInvocationTree) valueTree).getArguments();\n+            AnnotatedTypeMirror arrType = atypeFactory.getAnnotatedType(args.get(0));\n+            if (TreeUtils.isArrayLengthAccess(args.get(1))) {", "originalCommit": "688ca4f12aa48340354a9fc8b3748296efabcddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMzA0NQ==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r462723045", "bodyText": "Do we want to check this now? As suggested above I have added to valuetype any @IntVal or @IntRange annotation on the second argument. Suppose the user intends to have args2 of the same length as otherArray, then this check might lead to a false positive.", "author": "PRITI1999", "createdAt": "2020-07-30T04:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1Njk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNDg1NQ==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463124855", "bodyText": "In the test case I suggested, that is a true positive: otherArray might not be @MinLen(1), even if the user hopes that it is - its length could be zero. I think you can add that test method verbatim into the existing test (except for changing the name).", "author": "kelloggm", "createdAt": "2020-07-30T16:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1Njk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1ODkwMA==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r462458900", "bodyText": "Why only IntVal? If there is an IntRange annotation, you could take its lower bound (from field) and use that.", "author": "kelloggm", "createdAt": "2020-07-29T17:16:11Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueVisitor.java", "diffHunk": "@@ -76,6 +79,26 @@ protected void commonAssignmentCheck(\n                     getTypeFactory().createIntRangeAnnotation(Range.CHAR_EVERYTHING));\n         }\n \n+        if (valueTree.getKind() == Kind.METHOD_INVOCATION\n+                && TreeUtils.isArrayscopyOfMethodInvocation((MethodInvocationTree) valueTree)\n+                && valueType.getKind() == TypeKind.ARRAY) {\n+            List<? extends ExpressionTree> args = ((MethodInvocationTree) valueTree).getArguments();\n+            AnnotatedTypeMirror arrType = atypeFactory.getAnnotatedType(args.get(0));\n+            if (TreeUtils.isArrayLengthAccess(args.get(1))) {\n+                valueType = arrType;\n+            } else if (atypeFactory.getAnnotatedType(args.get(1)).getAnnotation(IntVal.class)\n+                    != null) {", "originalCommit": "688ca4f12aa48340354a9fc8b3748296efabcddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1OTEzNw==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r462459137", "bodyText": "(and, you should add a test with IntRange when you do)", "author": "kelloggm", "createdAt": "2020-07-29T17:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1ODkwMA=="}], "type": "inlineReview"}, {"oid": "3966be6af765918300fc12a7e5aac7d5c81edae3", "url": "https://github.com/typetools/checker-framework/commit/3966be6af765918300fc12a7e5aac7d5c81edae3", "message": "Improve fix and augment a func to the test case", "committedDate": "2020-07-30T04:01:05Z", "type": "commit"}, {"oid": "35a6430068cb3d0892bff03d6a6964ab94261e25", "url": "https://github.com/typetools/checker-framework/commit/35a6430068cb3d0892bff03d6a6964ab94261e25", "message": "Merge branch 'fix-issue-3224' of https://github.com/priti1999/checker-framework into fix-issue-3224", "committedDate": "2020-07-30T04:02:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExMTIwNQ==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463111205", "bodyText": "nit: in camel-case, this should be isArraysCopyOfMethodInvocation (that is, capitalize the \"c\" in \"copy\")", "author": "kelloggm", "createdAt": "2020-07-30T16:12:24Z", "path": "javacutil/src/main/java/org/checkerframework/javacutil/TreeUtils.java", "diffHunk": "@@ -1273,6 +1273,27 @@ public static boolean isAnonymousConstructor(final MethodTree method) {\n         return false;\n     }\n \n+    /**\n+     * Determines if the tree is a call to Arrays.copyOf()\n+     *\n+     * @param tree tree to check\n+     * @return true if the given tree is a call to Arrays.copyOf() method\n+     */\n+    public static boolean isArrayscopyOfMethodInvocation(MethodInvocationTree tree) {", "originalCommit": "35a6430068cb3d0892bff03d6a6964ab94261e25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExMzIyMg==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463113222", "bodyText": "This test isn't strong enough - it will return true on any method named copyOf in a class named Arrays, even if it is not the one from the JDK.\nYou should look at how IndexMethodIdentifier in the Index Checker identifies specific methods; you should be able to use the same kind of code here to identify Arrays.copyOf with confidence.\n(It would probably also be worthwhile to add an inner static class named \"Arrays\" with a static \"copyOf\" method to the tests and then ensure that your code is not invoked when that method is called.)", "author": "kelloggm", "createdAt": "2020-07-30T16:15:34Z", "path": "javacutil/src/main/java/org/checkerframework/javacutil/TreeUtils.java", "diffHunk": "@@ -1273,6 +1273,27 @@ public static boolean isAnonymousConstructor(final MethodTree method) {\n         return false;\n     }\n \n+    /**\n+     * Determines if the tree is a call to Arrays.copyOf()\n+     *\n+     * @param tree tree to check\n+     * @return true if the given tree is a call to Arrays.copyOf() method\n+     */\n+    public static boolean isArrayscopyOfMethodInvocation(MethodInvocationTree tree) {\n+        if (tree.getMethodSelect().getKind() != Kind.MEMBER_SELECT) {\n+            return false;\n+        }\n+\n+        MemberSelectTree memberSelectTree = (MemberSelectTree) tree.getMethodSelect();\n+\n+        if (memberSelectTree.getExpression().toString().equals(\"Arrays\")\n+                && getMethodName(memberSelectTree).equals(\"copyOf\")) {\n+            return true;", "originalCommit": "35a6430068cb3d0892bff03d6a6964ab94261e25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMjczMQ==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463122731", "bodyText": "Please add a check here that the length of args is what you expect (i.e. 2) and throw a BugInCF otherwise", "author": "kelloggm", "createdAt": "2020-07-30T16:30:22Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueVisitor.java", "diffHunk": "@@ -76,6 +80,32 @@ protected void commonAssignmentCheck(\n                     getTypeFactory().createIntRangeAnnotation(Range.CHAR_EVERYTHING));\n         }\n \n+        if (valueTree.getKind() == Kind.METHOD_INVOCATION\n+                && TreeUtils.isArrayscopyOfMethodInvocation((MethodInvocationTree) valueTree)\n+                && valueType.getKind() == TypeKind.ARRAY) {\n+            List<? extends ExpressionTree> args = ((MethodInvocationTree) valueTree).getArguments();", "originalCommit": "35a6430068cb3d0892bff03d6a6964ab94261e25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNDI4NA==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463124284", "bodyText": "Rather than checking for IntVal and IntRange by hand, I suggest using ValueCheckerUtils.getPossibleValues, which returns a Range or null if the annotation isn't integral. It already has support for both IntVal and IntRange, and you should be able to just use its lower bound directly rather than doing the computations below. That will greatly simplify the code.", "author": "kelloggm", "createdAt": "2020-07-30T16:33:03Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueVisitor.java", "diffHunk": "@@ -76,6 +80,32 @@ protected void commonAssignmentCheck(\n                     getTypeFactory().createIntRangeAnnotation(Range.CHAR_EVERYTHING));\n         }\n \n+        if (valueTree.getKind() == Kind.METHOD_INVOCATION\n+                && TreeUtils.isArrayscopyOfMethodInvocation((MethodInvocationTree) valueTree)\n+                && valueType.getKind() == TypeKind.ARRAY) {\n+            List<? extends ExpressionTree> args = ((MethodInvocationTree) valueTree).getArguments();\n+            if (getTypeFactory().getAnnotatedType(args.get(1)).getAnnotation(IntVal.class)", "originalCommit": "35a6430068cb3d0892bff03d6a6964ab94261e25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ecb48f5408a45daab742c32b28819618ebc7380e", "url": "https://github.com/typetools/checker-framework/commit/ecb48f5408a45daab742c32b28819618ebc7380e", "message": "Improvements", "committedDate": "2020-07-31T04:26:33Z", "type": "commit"}, {"oid": "e309153a6d4f56e9a1e00ad9849562f1f88c196a", "url": "https://github.com/typetools/checker-framework/commit/e309153a6d4f56e9a1e00ad9849562f1f88c196a", "message": "Correct variable", "committedDate": "2020-07-31T04:30:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY5MzA2Mg==", "url": "https://github.com/typetools/checker-framework/pull/3524#discussion_r463693062", "bodyText": "range can be null here, but createArrayLenRange assumes its input in non-null. Can you add a null check and only do the type.replaceAnnotation(atypeFactory.createArrayLenRangeAnnotation(range)); if the range is non-null?", "author": "kelloggm", "createdAt": "2020-07-31T15:54:58Z", "path": "framework/src/main/java/org/checkerframework/common/value/ValueTreeAnnotator.java", "diffHunk": "@@ -398,6 +399,20 @@ public Void visitMethodInvocation(MethodInvocationTree tree, AnnotatedTypeMirror\n             }\n         }\n \n+        if (atypeFactory\n+                .getMethodIdentifier()\n+                .isArraysCopyOfInvocation(tree, atypeFactory.getProcessingEnv())) {\n+            List<? extends ExpressionTree> args = tree.getArguments();\n+            if (args.size() != 2) {\n+                throw new BugInCF(\n+                        \"Arrays.copyOf() should have 2 arguments. This point should not have reached\");\n+            }\n+            Range range =", "originalCommit": "e309153a6d4f56e9a1e00ad9849562f1f88c196a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "221d3c0a38adb701171050395d054a55631c954f", "url": "https://github.com/typetools/checker-framework/commit/221d3c0a38adb701171050395d054a55631c954f", "message": "Build fix and minor improvement", "committedDate": "2020-08-01T03:44:18Z", "type": "commit"}, {"oid": "5a02c561d662715e38d7bfd29803d41f57e4f2c7", "url": "https://github.com/typetools/checker-framework/commit/5a02c561d662715e38d7bfd29803d41f57e4f2c7", "message": "Add doc", "committedDate": "2020-08-01T05:05:16Z", "type": "commit"}, {"oid": "881bbe943530d2a2e0d8a8a25850c0aa5dbd4dfc", "url": "https://github.com/typetools/checker-framework/commit/881bbe943530d2a2e0d8a8a25850c0aa5dbd4dfc", "message": "build fix", "committedDate": "2020-08-01T06:59:23Z", "type": "commit"}]}