{"pr_number": 3350, "pr_title": "STORM-3714 add rate tracking to TaskMetrics", "pr_createdAt": "2020-11-10T22:24:13Z", "pr_url": "https://github.com/apache/storm/pull/3350", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542780777", "bodyText": "Should this (mod) subtraction be from (valueAtTime - valueAtTimeMinus1), instead of (valueAtTime - valueAtTimePlus1)", "author": "bipinprasad", "createdAt": "2020-12-14T21:01:04Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/RateCounter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.metrics2;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+\n+/**\n+ * A Counter metric that also implements a Gauge to report a 1 minute rate.  This class was added as a compromise to\n+ * using a Meter, which has a much larger performance impact.\n+ */\n+public class RateCounter implements Gauge<Double> {\n+    private Counter counter;\n+    private double currentRate = 0;\n+    private int time = 0;\n+    private final long[] values;\n+    private final int timeSpanInSeconds;\n+\n+    RateCounter(StormMetricRegistry metricRegistry, String metricName, String topologyId,\n+                String componentId, int taskId, int workerPort, String streamId) {\n+        counter = metricRegistry.counter(metricName, topologyId, componentId,\n+                taskId, workerPort, streamId);\n+        metricRegistry.gauge(metricName + \".m1_rate\", this, topologyId, componentId, streamId,\n+                taskId, workerPort);\n+        this.timeSpanInSeconds = Math.max(60 - (60 % metricRegistry.getRateCounterUpdateIntervalSeconds()),\n+                metricRegistry.getRateCounterUpdateIntervalSeconds());\n+        this.values = new long[this.timeSpanInSeconds / metricRegistry.getRateCounterUpdateIntervalSeconds() + 1];\n+\n+    }\n+\n+    /**\n+     * Reports the 1 minute rate for the metric.\n+     * @return the rate\n+     */\n+    @Override\n+    public Double getValue() {\n+        return currentRate;\n+    }\n+\n+    public void inc(long n) {\n+        counter.inc(n);\n+    }\n+\n+    /**\n+     * Updates the rate in a background thread by a StormMetricRegistry at a fixed frequency.\n+     */\n+    void update() {\n+        time = (time + 1) % values.length;\n+        values[time] = counter.getCount();\n+        currentRate =  ((double) (values[time] - values[(time + 1) % values.length]) / timeSpanInSeconds);", "originalCommit": "63d6d8e414758f8f667999e1b83db1323b0f3b47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg1Mjg4OQ==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542852889", "bodyText": "My understanding is values is a ring, and the length of this ring is the elapsed time.   (valueAtTime - valueAtTimePlus1) gives you the difference during this time frame. So the rate is (valueAtTime - valueAtTimePlus1) / elapsed time", "author": "Ethanlm", "createdAt": "2020-12-14T22:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MTk1NA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542891954", "bodyText": "It is a ring - therefore the use of time%length for index. That is fine.\nBut at each update() call, the index \"time\" is first incremented. Then the counter is placed in idx \"time\". Therefore the previos value is in index-1.\nThe increase in counter value should still be currentValue - previousValue. Otherwise the difference will be a negative number.", "author": "bipinprasad", "createdAt": "2020-12-14T22:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMjQzNA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542902434", "bodyText": "Unless, the whole ring represents exact duration of timeSpanInSeconds - but them that would require some guarantee in the call frequency of update().", "author": "bipinprasad", "createdAt": "2020-12-14T22:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAzMjI5MA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r543032290", "bodyText": "Yes the call of update happens in a separate thread", "author": "Ethanlm", "createdAt": "2020-12-15T04:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg5MTMzNw==", "url": "https://github.com/apache/storm/pull/3350#discussion_r546891337", "bodyText": "Ethan is correct.  A separate thread updates at a fixed frequency.", "author": "agresch", "createdAt": "2020-12-21T19:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc4MDc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0OTA1Mw==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542849053", "bodyText": "I am having difficulties understanding this. Can you please elaborate?  What does timeSpanInSeconds  and this equation mean? Thanks", "author": "Ethanlm", "createdAt": "2020-12-14T22:04:47Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/RateCounter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.metrics2;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+\n+/**\n+ * A Counter metric that also implements a Gauge to report a 1 minute rate.  This class was added as a compromise to\n+ * using a Meter, which has a much larger performance impact.\n+ */\n+public class RateCounter implements Gauge<Double> {\n+    private Counter counter;\n+    private double currentRate = 0;\n+    private int time = 0;\n+    private final long[] values;\n+    private final int timeSpanInSeconds;\n+\n+    RateCounter(StormMetricRegistry metricRegistry, String metricName, String topologyId,\n+                String componentId, int taskId, int workerPort, String streamId) {\n+        counter = metricRegistry.counter(metricName, topologyId, componentId,\n+                taskId, workerPort, streamId);\n+        metricRegistry.gauge(metricName + \".m1_rate\", this, topologyId, componentId, streamId,\n+                taskId, workerPort);\n+        this.timeSpanInSeconds = Math.max(60 - (60 % metricRegistry.getRateCounterUpdateIntervalSeconds()),\n+                metricRegistry.getRateCounterUpdateIntervalSeconds());", "originalCommit": "63d6d8e414758f8f667999e1b83db1323b0f3b47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4OTI3NQ==", "url": "https://github.com/apache/storm/pull/3350#discussion_r546889275", "bodyText": "timeSpanInSeconds is 60 for this. The mod seems to be attempting to handle the case where the update interval is odd divisor of the desired timespan.", "author": "agresch", "createdAt": "2020-12-21T19:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0OTA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2ODYzNw==", "url": "https://github.com/apache/storm/pull/3350#discussion_r548268637", "bodyText": "Got it. Thanks for explaining", "author": "Ethanlm", "createdAt": "2020-12-23T21:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0OTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0OTk3NA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r542849974", "bodyText": "The calculation in the update() method looks to me is a per second rate, instead of 1 minute rate. Am I misunderstanding?", "author": "Ethanlm", "createdAt": "2020-12-14T22:05:40Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/RateCounter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.metrics2;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+\n+/**\n+ * A Counter metric that also implements a Gauge to report a 1 minute rate.  This class was added as a compromise to", "originalCommit": "63d6d8e414758f8f667999e1b83db1323b0f3b47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4OTQ3Ng==", "url": "https://github.com/apache/storm/pull/3350#discussion_r546889476", "bodyText": "You are correct, I will update.  It should be rate per second over a one minute period.", "author": "agresch", "createdAt": "2020-12-21T19:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg0OTk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NTU5OQ==", "url": "https://github.com/apache/storm/pull/3350#discussion_r548265599", "bodyText": "m1_rate needs to change", "author": "Ethanlm", "createdAt": "2020-12-23T21:44:42Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/RateCounter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.metrics2;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+\n+/**\n+ * A Counter metric that also implements a Gauge to report the average rate of events per second over 1 minute.  This class\n+ * was added as a compromise to using a Meter, which has a much larger performance impact.\n+ */\n+public class RateCounter implements Gauge<Double> {\n+    private Counter counter;\n+    private double currentRate = 0;\n+    private int time = 0;\n+    private final long[] values;\n+    private final int timeSpanInSeconds;\n+\n+    RateCounter(StormMetricRegistry metricRegistry, String metricName, String topologyId,\n+                String componentId, int taskId, int workerPort, String streamId) {\n+        counter = metricRegistry.counter(metricName, topologyId, componentId,\n+                taskId, workerPort, streamId);\n+        metricRegistry.gauge(metricName + \".m1_rate\", this, topologyId, componentId, streamId,", "originalCommit": "a86fe9feeb936fb48d769bf972afe6b5280984c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQyNjc0MQ==", "url": "https://github.com/apache/storm/pull/3350#discussion_r549426741", "bodyText": "What would be your preferred name?", "author": "agresch", "createdAt": "2020-12-28T17:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NjE2NA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r548266164", "bodyText": "It is not always event per second over 1 minute. It depends on what the value of timeSpanInSeconds is", "author": "Ethanlm", "createdAt": "2020-12-23T21:45:24Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/RateCounter.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.  The ASF licenses this file to you under the Apache License, Version\n+ * 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ */\n+\n+package org.apache.storm.metrics2;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+\n+/**\n+ * A Counter metric that also implements a Gauge to report the average rate of events per second over 1 minute.  This class", "originalCommit": "a86fe9feeb936fb48d769bf972afe6b5280984c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQyNjY3MA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r549426670", "bodyText": "In our case, timeSpanInSeconds is set to 60.  I could allow passing in a value to make it more flexible if desired.", "author": "agresch", "createdAt": "2020-12-28T17:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE3MDczOQ==", "url": "https://github.com/apache/storm/pull/3350#discussion_r552170739", "bodyText": "I was thinking that since RATE_COUNTER_UPDATE_INTERVAL_SECONDS is passed from StormMetricRegistry, if it changes to some value like 21s, then\nthis.timeSpanInSeconds = Math.max(60 - (60 % metricRegistry.getRateCounterUpdateIntervalSeconds()),\n                metricRegistry.getRateCounterUpdateIntervalSeconds());\n\nwe have this.timeSpanInSeconds = 42s so the metric is the average rate of events per 42s, instead of one minute.\nBut I think it is okay for now since RATE_COUNTER_UPDATE_INTERVAL_SECONDS is not configurable and not likely to be changed to a value like 21s.\nFuture developers need to be aware of this implementation details if they want to change RATE_COUNTER_UPDATE_INTERVAL_SECONDS or make it configurable.", "author": "Ethanlm", "createdAt": "2021-01-05T20:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NjE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODI2NzMyMA==", "url": "https://github.com/apache/storm/pull/3350#discussion_r548267320", "bodyText": "nit: this newline can be removed", "author": "Ethanlm", "createdAt": "2020-12-23T21:47:02Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -369,6 +398,7 @@ private String dotToUnderScore(String str) {\n         return str.replace('.', '_');\n     }\n \n+", "originalCommit": "a86fe9feeb936fb48d769bf972afe6b5280984c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec4e2690dafd908d15dbd36cb241715fe53c2e08", "url": "https://github.com/apache/storm/commit/ec4e2690dafd908d15dbd36cb241715fe53c2e08", "message": "STORM-3714 add rate tracking to TaskMetrics", "committedDate": "2021-01-05T19:20:12Z", "type": "forcePushed"}, {"oid": "fb87fde7a219a1eed93bc681da5e60b4360e42cc", "url": "https://github.com/apache/storm/commit/fb87fde7a219a1eed93bc681da5e60b4360e42cc", "message": "STORM-3714 add rate tracking to TaskMetrics", "committedDate": "2021-01-05T19:32:00Z", "type": "commit"}, {"oid": "fb87fde7a219a1eed93bc681da5e60b4360e42cc", "url": "https://github.com/apache/storm/commit/fb87fde7a219a1eed93bc681da5e60b4360e42cc", "message": "STORM-3714 add rate tracking to TaskMetrics", "committedDate": "2021-01-05T19:32:00Z", "type": "forcePushed"}]}