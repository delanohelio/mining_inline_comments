{"pr_number": 3295, "pr_title": "STORM-3660: Remove use of queues for updating credentials", "pr_createdAt": "2020-06-26T14:20:02Z", "pr_url": "https://github.com/apache/storm/pull/3295", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzNjQyNQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r446236425", "bodyText": "I think maybe we should first set  this.needToRefreshCreds to false and then update the creds.  Imagine we uploaded credentials twice in a row and this loaded the first creds and the thread paused.  It would then clear the update flag and miss the second credentials upload.", "author": "agresch", "createdAt": "2020-06-26T14:58:11Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -270,6 +273,15 @@ public ExecutorShutdown execute() throws Exception {\n \n     @Override\n     public void accept(Object event) {\n+        if (this.needToRefreshCreds) {\n+            LOG.info(\"The credentials are being updated {}.\", executorId);\n+            Credentials creds = this.workerData.getCredentials();\n+            idToTask.stream().map(Task::getTaskObject).filter(taskObject -> taskObject instanceof ICredentialsListener)\n+                    .forEach(taskObject -> {\n+                        ((ICredentialsListener) taskObject).setCredentials(creds == null ? null : creds.get_creds());\n+                    });\n+            this.needToRefreshCreds = false;", "originalCommit": "5c4fd31087a4ffcc6d01ec7895c92ff1693c9973", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQwMTk2Mw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r446401963", "bodyText": "Addressed.", "author": "kishorvpatil", "createdAt": "2020-06-26T20:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIzNjQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NTAzMQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r446255031", "bodyText": "Minor: Does this method name and signature needs to change since it is setting a flag and not using the supplied parameter?", "author": "bipinprasad", "createdAt": "2020-06-26T15:30:44Z", "path": "storm-client/src/jvm/org/apache/storm/executor/ExecutorShutdown.java", "diffHunk": "@@ -60,16 +60,7 @@ public ExecutorStats renderStats() {\n \n     @Override\n     public void credentialsChanged(Credentials credentials) {\n-        TupleImpl tuple = new TupleImpl(executor.getWorkerTopologyContext(), new Values(credentials),\n-                                        Constants.SYSTEM_COMPONENT_ID, (int) Constants.SYSTEM_TASK_ID,\n-                                        Constants.CREDENTIALS_CHANGED_STREAM_ID);\n-        AddressedTuple addressedTuple = new AddressedTuple(AddressedTuple.BROADCAST_DEST, tuple);\n-        try {\n-            executor.getReceiveQueue().publish(addressedTuple);\n-            executor.getReceiveQueue().flush();\n-        } catch (InterruptedException e) {\n-            throw new RuntimeException(e);\n-        }\n+        executor.needToRefreshCreds = true;", "originalCommit": "5c4fd31087a4ffcc6d01ec7895c92ff1693c9973", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM3OTY2NA==", "url": "https://github.com/apache/storm/pull/3295#discussion_r446379664", "bodyText": "Since the SpoutExecutor and BoltExecutor during init uses the initialCredentials,  the accept method does not need to worry about it.", "author": "kishorvpatil", "createdAt": "2020-06-26T19:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM3OTY5OA==", "url": "https://github.com/apache/storm/pull/3295#discussion_r446379698", "bodyText": "e.g. https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/executor/spout/SpoutExecutor.java#L144-L146", "author": "kishorvpatil", "createdAt": "2020-06-26T19:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NTAzMQ=="}], "type": "inlineReview"}, {"oid": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "url": "https://github.com/apache/storm/commit/f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "message": "STORM-3660: Remove use of queues for updating credentials", "committedDate": "2020-06-26T20:45:36Z", "type": "commit"}, {"oid": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "url": "https://github.com/apache/storm/commit/f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "message": "STORM-3660: Remove use of queues for updating credentials", "committedDate": "2020-06-26T20:45:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyMzUzMw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447723533", "bodyText": "This can be private", "author": "Ethanlm", "createdAt": "2020-06-30T14:23:28Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -124,6 +126,7 @@\n     protected int idToTaskBase;\n     protected String hostname;\n     private static final double msDurationFactor = 1.0 / TimeUnit.MILLISECONDS.toNanos(1);\n+    protected boolean needToRefreshCreds = true;", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4MTUxMQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448381511", "bodyText": "Addressed", "author": "kishorvpatil", "createdAt": "2020-07-01T13:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyMzUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNTI2Mw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447735263", "bodyText": "This can be private", "author": "Ethanlm", "createdAt": "2020-06-30T14:38:20Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -152,6 +153,7 @@\n     private final AtomicLong nextLoadUpdate = new AtomicLong(0);\n     private final boolean trySerializeLocal;\n     private final Collection<IAutoCredentials> autoCredentials;\n+    AtomicReference<Credentials> credentialsAtom;", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4MTYyMA==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448381620", "bodyText": "Addressed", "author": "kishorvpatil", "createdAt": "2020-07-01T13:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczNTI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzczOTA4Ng==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447739086", "bodyText": "This can be debug.", "author": "Ethanlm", "createdAt": "2020-06-30T14:43:04Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -270,6 +273,15 @@ public ExecutorShutdown execute() throws Exception {\n \n     @Override\n     public void accept(Object event) {\n+        if (this.needToRefreshCreds) {\n+            this.needToRefreshCreds = false;\n+            LOG.info(\"The credentials are being updated {}.\", executorId);", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NTEwOQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447795109", "bodyText": "I am seeing possible race condition here.\nBecause  executor.credentialsChanged happens before this.workerState.credentialsAtom.set(newCreds) is invoked, executor could trigger credential update before the newCreds is not updated yet.", "author": "Ethanlm", "createdAt": "2020-06-30T15:56:36Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -415,13 +414,13 @@ public void updateBlobUpdates() throws IOException {\n \n     public void checkCredentialsChanged() {\n         Credentials newCreds = workerState.stormClusterState.credentials(topologyId, null);\n-        if (!ObjectUtils.equals(newCreds, credentialsAtom.get())) {\n+        if (!ObjectUtils.equals(newCreds, this.workerState.credentialsAtom.get())) {\n             // This does not have to be atomic, worst case we update when one is not needed\n             ClientAuthUtils.updateSubject(subject, autoCreds, (null == newCreds) ? null : newCreds.get_creds());\n             for (IRunningExecutor executor : executorsAtom.get()) {\n                 executor.credentialsChanged(newCreds);\n             }\n-            credentialsAtom.set(newCreds);\n+            this.workerState.credentialsAtom.set(newCreds);", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4MTk0OA==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448381948", "bodyText": "Moved this up before for loop.", "author": "kishorvpatil", "createdAt": "2020-07-01T13:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5NTEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5OTAwMg==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447799002", "bodyText": "There seems to be a race condition here.\nThe executor thread consumes from receiveQ and every time it consumes one tuple, the accept method is invoked and needToRefreshCreds is checked.\nThis needToRefreshCreds variable is accessed by others threads (which invoke credentialsChanged) and the value will be updated to true.\nSo first of all, needToRefreshCreds needs to be at least violate. But violate doesn't seem enough because needToRefreshCreds is set to false in this executor thread, and set to true in other threads.\nBetween checking if needToRefreshCreds is true and setting it to be false in the executor thread, needToRefreshCreds could be modified to true in other threads but this information is lost.", "author": "Ethanlm", "createdAt": "2020-06-30T16:02:11Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -270,6 +273,15 @@ public ExecutorShutdown execute() throws Exception {\n \n     @Override\n     public void accept(Object event) {\n+        if (this.needToRefreshCreds) {\n+            this.needToRefreshCreds = false;", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4NDA0NA==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448384044", "bodyText": "The needToRefreshCreds could be updated to true anytime after if condition is evaluated by the worker credentials refresh thread. If there are consecutive updates, it will either execute the setCredentials twice or will execute only once with latest credentials - no harm/no deadlock.", "author": "kishorvpatil", "createdAt": "2020-07-01T14:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc5OTAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgwMDUyMw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r447800523", "bodyText": "An issue about checking the value here is it might be blocked.\nThis accept is only called when receiveQueue.consume is called. But it could be blocked so credential update will be delayed.", "author": "Ethanlm", "createdAt": "2020-06-30T16:04:28Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -270,6 +273,15 @@ public ExecutorShutdown execute() throws Exception {\n \n     @Override\n     public void accept(Object event) {\n+        if (this.needToRefreshCreds) {", "originalCommit": "f8c56e2e4d26a1d41dcccb097b8642ad705d14ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4NzA3Ng==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448387076", "bodyText": "moved this to separate method and being called fro withing BoltExecutor and SpoutExecutor call at the beginning of each iteration in the asyncloop. This would ensure that credentials are updated on executor irrespective of back pressure or no tuples to process scenarios. For backward compatibility and agreement about invoking setCreentials on user implementation on ICredentialsListener from executor thread, if Executor thread is stuck in execute or nextTuple  methods delays can not be avoided. But otherwise we should be able to get credentials update on next iteration.", "author": "kishorvpatil", "createdAt": "2020-07-01T14:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgwMDUyMw=="}], "type": "inlineReview"}, {"oid": "a87ba6d14e8d9da9532a914cf6e5dec6c3d813d6", "url": "https://github.com/apache/storm/commit/a87ba6d14e8d9da9532a914cf6e5dec6c3d813d6", "message": "Adjust excecutor creds refresh", "committedDate": "2020-07-01T13:56:51Z", "type": "commit"}, {"oid": "a87ba6d14e8d9da9532a914cf6e5dec6c3d813d6", "url": "https://github.com/apache/storm/commit/a87ba6d14e8d9da9532a914cf6e5dec6c3d813d6", "message": "Adjust excecutor creds refresh", "committedDate": "2020-07-01T13:56:51Z", "type": "forcePushed"}, {"oid": "899312945724858bd5dfde4ca13b27a5290cec5b", "url": "https://github.com/apache/storm/commit/899312945724858bd5dfde4ca13b27a5290cec5b", "message": "Merge branch 'master' of github.com:apache/storm into storm3660", "committedDate": "2020-07-01T14:13:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDI2OQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448434269", "bodyText": "Maybe we should change it to be DEBUG since this is on a critical path (even though this method might not be called very frequently)", "author": "Ethanlm", "createdAt": "2020-07-01T15:14:13Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -291,6 +294,22 @@ public void accept(Object event) {\n         }\n     }\n \n+    public void setNeedToRefreshCreds() {\n+        this.needToRefreshCreds = true;\n+    }\n+\n+    protected void updateExecCredsIfRequired() {\n+        if (this.needToRefreshCreds) {\n+            this.needToRefreshCreds = false;\n+            LOG.info(\"The credentials are being updated {}.\", executorId);", "originalCommit": "899312945724858bd5dfde4ca13b27a5290cec5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI0MTIyNQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r450241225", "bodyText": "I think info should be fine.", "author": "agresch", "createdAt": "2020-07-06T14:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDc5Nw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r448434797", "bodyText": "This needs to be volatile  to make sure the changes from other threads can be seen immediately", "author": "Ethanlm", "createdAt": "2020-07-01T15:14:56Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -124,6 +126,7 @@\n     protected int idToTaskBase;\n     protected String hostname;\n     private static final double msDurationFactor = 1.0 / TimeUnit.MILLISECONDS.toNanos(1);\n+    private boolean needToRefreshCreds = true;", "originalCommit": "899312945724858bd5dfde4ca13b27a5290cec5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMwNjU3Mw==", "url": "https://github.com/apache/storm/pull/3295#discussion_r452306573", "bodyText": "Since multiple threads are changing this flag- switching to AtomicBoolean.", "author": "kishorvpatil", "createdAt": "2020-07-09T15:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4OTM0Mg==", "url": "https://github.com/apache/storm/pull/3295#discussion_r452389342", "bodyText": "If only simple get() and set() methods are used in AtomicBoolean, it is basically the same as using volatile boolean unless methods like compareAndSet and getAndSet are required.\nhttps://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/classes/java/util/concurrent/atomic/AtomicBoolean.java#L85-L87 (although the implementation uses volatile int)\nBut anyway, using AtomicBoolean is easier to understand.", "author": "Ethanlm", "createdAt": "2020-07-09T17:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzNDc5Nw=="}], "type": "inlineReview"}, {"oid": "a817ff8e6c692154426355f58c82fd38e26801c1", "url": "https://github.com/apache/storm/commit/a817ff8e6c692154426355f58c82fd38e26801c1", "message": "Use AtomicBoolean for needToRefreshCreds field", "committedDate": "2020-07-09T15:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDUyOQ==", "url": "https://github.com/apache/storm/pull/3295#discussion_r452390529", "bodyText": "The initial value should be false to avoid unnecessary update at the beginning.", "author": "Ethanlm", "createdAt": "2020-07-09T17:52:08Z", "path": "storm-client/src/jvm/org/apache/storm/executor/Executor.java", "diffHunk": "@@ -124,6 +126,7 @@\n     protected int idToTaskBase;\n     protected String hostname;\n     private static final double msDurationFactor = 1.0 / TimeUnit.MILLISECONDS.toNanos(1);\n+    private AtomicBoolean needToRefreshCreds = new AtomicBoolean(true);", "originalCommit": "a817ff8e6c692154426355f58c82fd38e26801c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3ODg3Mg==", "url": "https://github.com/apache/storm/pull/3295#discussion_r453078872", "bodyText": "Fixed", "author": "kishorvpatil", "createdAt": "2020-07-10T21:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDUyOQ=="}], "type": "inlineReview"}, {"oid": "d61d17b71ad42b19bd9fb581d0e1ff38770b2615", "url": "https://github.com/apache/storm/commit/d61d17b71ad42b19bd9fb581d0e1ff38770b2615", "message": "STORM-3660: Update default to false on needToRefreshCreds", "committedDate": "2020-07-10T21:10:10Z", "type": "commit"}]}