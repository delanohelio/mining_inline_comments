{"pr_number": 3336, "pr_title": "[STORM-3701] clean-up topo directory with the check against latest topo blob cache", "pr_createdAt": "2020-09-16T15:49:29Z", "pr_url": "https://github.com/apache/storm/pull/3336", "timeline": [{"oid": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "url": "https://github.com/apache/storm/commit/d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "message": "[STORM-3701] clean-up topo directory with the check against latest topo blob cache", "committedDate": "2020-09-16T15:44:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw==", "url": "https://github.com/apache/storm/pull/3336#discussion_r489551013", "bodyText": "It seems like it may be possible to still have a race condition here where a topology is added to topologyBlobs?\nIf so it seems like we should add synchronization to this code and the adding of a blob?", "author": "agresch", "createdAt": "2020-09-16T16:00:06Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -641,7 +642,12 @@ void cleanup() {\n \n             try {\n                 forEachTopologyDistDir((p, topologyId) -> {\n-                    if (!safeTopologyIds.contains(topologyId)) {\n+                    String topoJarKey = ConfigUtils.masterStormJarKey(topologyId);\n+                    String topoCodeKey = ConfigUtils.masterStormCodeKey(topologyId);\n+                    String topoConfKey = ConfigUtils.masterStormConfKey(topologyId);\n+                    if (!topologyBlobs.containsKey(topoJarKey)", "originalCommit": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1NjA0Mg==", "url": "https://github.com/apache/storm/pull/3336#discussion_r489756042", "bodyText": "My understanding is topo dir is always created after the entries of topologyBlobs are added. So whenever the topology entry is found, we should not delete the dir.\nAlso, topologyBlobs is ConcurrentHashMap which allows the slot and cleanup/update threads to access in parallel.\nIf we added synchronization, the file system dir cleanup might take seconds and block the slot threads to progress.", "author": "RuiLi8080", "createdAt": "2020-09-16T21:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyODE1NQ==", "url": "https://github.com/apache/storm/pull/3336#discussion_r490428155", "bodyText": "What happens if line 648 executes and before line 649 runs getTopoJar(topologyId) is called?", "author": "agresch", "createdAt": "2020-09-17T17:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4NjU0NA==", "url": "https://github.com/apache/storm/pull/3336#discussion_r490986544", "bodyText": "When that happens, the directory will not be deleted. It is okay because when getTopoJar executes, it means the directory is needed.\nThe bottom line here is the code will delete the directory for dead topologies eventually (cleanup thread runs every 30s). But if there is anywhere that needs this directory, this code will not delete the directory", "author": "Ethanlm", "createdAt": "2020-09-18T14:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEyMjk2MQ==", "url": "https://github.com/apache/storm/pull/3336#discussion_r491122961", "bodyText": "@agresch Technically there is a chance. But with this change it would be more unlikely to happen than before.\nBefore this change, we compare topo dir to safeTopologyIds which is essentially a much older version of topologyBlobs  snapshot since it could take about 10s for the forEachTopologyDistDir loop to finish. In this case, race condition is much more likely to happen since the deletion loop keep looking at the snapshot 10s ago.\nNow we directly check the topologyBlobs map right before deletion. So the forEachTopologyDistDir loop could be aware of the concurrent additions from slots and further prevent most of the wrongful deletion to happen.", "author": "RuiLi8080", "createdAt": "2020-09-18T18:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2MzY3Nw==", "url": "https://github.com/apache/storm/pull/3336#discussion_r491163677", "bodyText": "I guess your question is if line 650 (&& !topologyBlobs.containsKey(topoConfKey)) {) executes and before line 651 (fsOps.deleteIfExists(p.toFile());) runs, getTopoJar(topologyId) is called?\nYes there is a chance. But current change is much better than what we have before.\nJust for future reference, one thing about Rui's comment that I want to note is that we still don't know where the 10s delay we observed from the incident we had in our production cluster between where safeTopologyIds is populated and fsOps.deleteIfExists is invoked comes from. It could come from forEachTopologyDistDir file operations. But we don't know yet. Also this issue doesn't alway happen.", "author": "Ethanlm", "createdAt": "2020-09-18T20:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4Njg1Nw==", "url": "https://github.com/apache/storm/pull/3336#discussion_r490986857", "bodyText": "Please update comments at line 470-471 too", "author": "Ethanlm", "createdAt": "2020-09-18T14:25:19Z", "path": "storm-server/src/main/java/org/apache/storm/localizer/AsyncLocalizer.java", "diffHunk": "@@ -474,7 +474,7 @@ public void releaseSlotFor(LocalAssignment assignment, int port) throws IOExcept\n             LOG.info(\"Port and assignment info: {}\", pna);\n             if (e instanceof FileNotFoundException) {\n                 localResourceFileNotFoundWhenReleasingSlot.mark();\n-                LOG.warn(\"Local base blobs have not been downloaded yet. \", e);\n+                LOG.warn(\"Local base blobs are not available. \", e);", "originalCommit": "d50c4f93505cc72bc5963a4a7f99dbafc1ce1f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTEyMzY5MQ==", "url": "https://github.com/apache/storm/pull/3336#discussion_r491123691", "bodyText": "Updated.", "author": "RuiLi8080", "createdAt": "2020-09-18T18:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4Njg1Nw=="}], "type": "inlineReview"}, {"oid": "6c33fb257f4c120997a21a7c96cc76ec8234db6b", "url": "https://github.com/apache/storm/commit/6c33fb257f4c120997a21a7c96cc76ec8234db6b", "message": "update comments", "committedDate": "2020-09-18T16:52:54Z", "type": "commit"}]}