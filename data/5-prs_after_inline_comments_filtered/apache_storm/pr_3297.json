{"pr_number": 3297, "pr_title": "STORM-3662: Use Pacemaker if cluster has set up uses it", "pr_createdAt": "2020-06-26T16:26:07Z", "pr_url": "https://github.com/apache/storm/pull/3297", "timeline": [{"oid": "19f70374e3dc54e6faad40517336e4cd503c11ed", "url": "https://github.com/apache/storm/commit/19f70374e3dc54e6faad40517336e4cd503c11ed", "message": "STORM-3662: Use Pacemaker if cluster has set up uses it", "committedDate": "2020-06-26T15:35:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MjU0MQ==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447052541", "bodyText": "Do you mean backend store?", "author": "Ethanlm", "createdAt": "2020-06-29T15:20:07Z", "path": "storm-client/src/jvm/org/apache/storm/cluster/IStormClusterState.java", "diffHunk": "@@ -74,6 +74,13 @@\n      */\n     boolean isAssignmentsBackendSynchronized();\n \n+    /**\n+     * Flag to indicate if the Pacameker is backup store.", "originalCommit": "19f70374e3dc54e6faad40517336e4cd503c11ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzE4NA==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163184", "bodyText": "Addressed", "author": "kishorvpatil", "createdAt": "2020-06-29T18:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MjU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MzI4Mg==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447053282", "bodyText": "We should delete If. Since if this message is logged, it means pacemaker is not being used.", "author": "Ethanlm", "createdAt": "2020-06-29T15:21:11Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -361,7 +364,11 @@ public void doHeartBeat() throws IOException {\n         state.setWorkerHeartBeat(lsWorkerHeartbeat);\n         state.cleanup(60); // this is just in case supervisor is down so that disk doesn't fill up.\n         // it shouldn't take supervisor 120 seconds between listing dir and reading it\n-        heartbeatToMasterIfLocalbeatFail(lsWorkerHeartbeat);\n+\n+        if (!workerState.stormClusterState.isPacemakerStateStore()) {\n+            LOG.debug(\"If pacemaker is not used, send supervisor\");", "originalCommit": "19f70374e3dc54e6faad40517336e4cd503c11ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzI1Mg==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163252", "bodyText": "Addressed", "author": "kishorvpatil", "createdAt": "2020-06-29T18:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1MzI4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDMyNw==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054327", "bodyText": "We might want to update the comment here https://github.com/apache/storm/blob/master/storm-client/src/jvm/org/apache/storm/Config.java#L1678-L1684\nsince this config is no longer deprecated. and it is used when Pacemaker is in use.", "author": "Ethanlm", "createdAt": "2020-06-29T15:22:35Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/Worker.java", "diffHunk": "@@ -215,8 +215,11 @@ private Object loadWorker(IStateStorage stateStorage, IStormClusterState stormCl\n                 }\n             });\n \n+        Integer execHeartBeatFreqSecs = workerState.stormClusterState.isPacemakerStateStore()\n+            ? (Integer) conf.get(Config.TASK_HEARTBEAT_FREQUENCY_SECS)", "originalCommit": "19f70374e3dc54e6faad40517336e4cd503c11ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM0MQ==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447163341", "bodyText": "Modified Config.", "author": "kishorvpatil", "createdAt": "2020-06-29T18:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1NDc5Nw==", "url": "https://github.com/apache/storm/pull/3297#discussion_r447054797", "bodyText": "We can remove this from this PR since it is being addressed in your other PR #3291", "author": "Ethanlm", "createdAt": "2020-06-29T15:23:19Z", "path": "storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java", "diffHunk": "@@ -377,15 +378,31 @@ public StormTimer getUserTimer() {\n     public SmartThread makeTransferThread() {\n         return workerTransfer.makeTransferThread();\n     }\n-    \n+\n+    public void suicideIfLocalAssignmentsChanged(Assignment assignment) {\n+        if (assignment != null) {\n+            Set<List<Long>> assignedExecutors = new HashSet<>(readWorkerExecutors(assignmentId, port, assignment));\n+            if (!localExecutors.equals(assignedExecutors)) {\n+                LOG.info(\"Found conflicting assignments. We shouldn't be alive!\"\n+                         + \" Assigned: \" + assignedExecutors + \", Current: \"\n+                         + localExecutors);\n+                if (!ConfigUtils.isLocalMode(conf)) {\n+                    suicideCallback.run();\n+                } else {\n+                    LOG.info(\"Local worker tried to commit suicide!\");\n+                }\n+            }\n+        }\n+    }\n+\n     public void refreshConnections() {\n         Assignment assignment = null;\n         try {\n             assignment = getLocalAssignment(stormClusterState, topologyId);\n         } catch (Exception e) {\n             LOG.warn(\"Failed to read assignment. This should only happen when topology is shutting down.\", e);\n         }\n-\n+        suicideIfLocalAssignmentsChanged(assignment);", "originalCommit": "19f70374e3dc54e6faad40517336e4cd503c11ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4152f735708189976d17d3e651b265f41d7e5e2c", "url": "https://github.com/apache/storm/commit/4152f735708189976d17d3e651b265f41d7e5e2c", "message": "Merge branch 'master' of github.com:apache/storm into STORM-3662", "committedDate": "2020-06-29T18:06:03Z", "type": "commit"}, {"oid": "adc0a01e3d6c169a55428482c40f592f2a5d029b", "url": "https://github.com/apache/storm/commit/adc0a01e3d6c169a55428482c40f592f2a5d029b", "message": "STORM-3662: Addressing review comments", "committedDate": "2020-06-29T18:17:41Z", "type": "commit"}, {"oid": "b7fc26fe784e33c8e990c170cdfe4ad66c165f36", "url": "https://github.com/apache/storm/commit/b7fc26fe784e33c8e990c170cdfe4ad66c165f36", "message": "Merge branch 'master' of github.com:apache/storm into STORM-3662", "committedDate": "2020-07-01T16:21:02Z", "type": "commit"}]}