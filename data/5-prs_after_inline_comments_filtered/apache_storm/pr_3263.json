{"pr_number": 3263, "pr_title": "STORM-3627 allow using short metric names for V2 metrics tick", "pr_createdAt": "2020-05-04T19:37:31Z", "pr_url": "https://github.com/apache/storm/pull/3263", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg==", "url": "https://github.com/apache/storm/pull/3263#discussion_r419681532", "bodyText": "We don't really need this config.\nThe taskIdMapping is only used for v2.metrics.tick. We save short name in the taskIdMapping to conform with V1 method of sending metrics.\nMetrics register at codehale metricRegistry should just use the long time.", "author": "Ethanlm", "createdAt": "2020-05-04T19:40:39Z", "path": "storm-client/src/jvm/org/apache/storm/Config.java", "diffHunk": "@@ -277,6 +277,12 @@\n     @IsBoolean\n     public static final String TOPOLOGY_ENABLE_V2_METRICS_TICK = \"topology.enable.v2.metrics.tick\";\n \n+    /**\n+     * This config allows V2 metrics reporting through the metrics tick to use short names.\n+     */\n+    @IsBoolean\n+    public static final String TOPOLOGY_METRICS_USE_SHORTNAME = \"topology.metrics.use.shortname\";", "originalCommit": "7124e32f453cb755ab7b9dfccc03b968c233ea3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4Nzg2NQ==", "url": "https://github.com/apache/storm/pull/3263#discussion_r419687865", "bodyText": "I'm fine with removing the config.  @kishorvpatil - are you also ok with removing this option and always reporting short names?", "author": "agresch", "createdAt": "2020-05-04T19:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA1Mjg0Nw==", "url": "https://github.com/apache/storm/pull/3263#discussion_r421052847", "bodyText": "I think having this configuration, allows us use shortnames even while topology is not using v2 metrics tick. So we should use this configuration.", "author": "kishorvpatil", "createdAt": "2020-05-06T19:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA1NDIzNQ==", "url": "https://github.com/apache/storm/pull/3263#discussion_r421054235", "bodyText": "This PR will only support reporting short names for the V2 metrics tick.  We would need a different solution for tracking short metrics names for the non-V2 tick.", "author": "agresch", "createdAt": "2020-05-06T19:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEzMTU4OA==", "url": "https://github.com/apache/storm/pull/3263#discussion_r421131588", "bodyText": "We can't really use shortname if it is using v2 metrics because codehale metric registry maps name to metric object.\nAnd even if we want to use short name when topology is not using v2 metrics, this config doesn't support it, as Aaron mentioned.", "author": "Ethanlm", "createdAt": "2020-05-06T22:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcyNzY0NA==", "url": "https://github.com/apache/storm/pull/3263#discussion_r421727644", "bodyText": "okay to remove this config and use v2.tick enabled/disabled to choose shortnames.", "author": "kishorvpatil", "createdAt": "2020-05-07T19:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw==", "url": "https://github.com/apache/storm/pull/3263#discussion_r423999763", "bodyText": "I am trying to understand why we have storm.worker and storm.topology prefix. Do we need there prefix on shortnames?", "author": "Ethanlm", "createdAt": "2020-05-12T20:03:21Z", "path": "storm-client/src/jvm/org/apache/storm/metrics2/StormMetricRegistry.java", "diffHunk": "@@ -250,11 +254,14 @@ private String metricName(String name, String stormId, String componentId, Integ\n         sb.append(workerPort);\n         sb.append(\"-\");\n         sb.append(name);\n-        return sb.toString();\n+        String longName = sb.toString();\n+        String shortName = WORKER_METRIC_PREFIX + name;", "originalCommit": "4f6f59edabd70d7030fc15ce242690ce251c777a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMzY0OQ==", "url": "https://github.com/apache/storm/pull/3263#discussion_r424003649", "bodyText": "I thought @kishorvpatil was in favor of keeping these.  I am fine dropping them for short or long names if desired.  Let me know what you want.", "author": "agresch", "createdAt": "2020-05-12T20:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MzIwNw==", "url": "https://github.com/apache/storm/pull/3263#discussion_r424053207", "bodyText": "i think we can leave it as storm.topology,  similar to nimbus metrics and supervisor metrics. Also, storm.worker is suggesting they are worker level metrics.", "author": "kishorvpatil", "createdAt": "2020-05-12T21:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1OTUxMg==", "url": "https://github.com/apache/storm/pull/3263#discussion_r424059512", "bodyText": "@Ethanlm - just making sure you're ok with the prefixes....", "author": "agresch", "createdAt": "2020-05-12T22:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1NTQwNw==", "url": "https://github.com/apache/storm/pull/3263#discussion_r424455407", "bodyText": "I took a closer look at what storm.worker and storm.topology really are. So in the original code, when the metric is registered using TopologyContext, it will prefix with storm.topology, everything else is storm.worker. And there are two formats for storm.worker, one with streamId, the other without streamId.\nHowever, storm.topology and storm.worker doesn't really mean anything.\nThe metric registered at TopologyContext is still task level metric, which corresponds to specific taskIds. And metrics prefixed with storm.worker, currently including\n\nJCQueue Metrics: executor-transfter-queue metric (executor level), worker-transfer-queue metric (worker level)\nTaskMetrics: __acker, __failed, etc, are all taskId + streamId level.\n\nSo these storm.worker and storm.topology don't really mean anything and keeping it will just cause confusion.\nIt is okay to not deal with it in this PR. But we shouldn't add prefix to old V1 metrics, which unnecessarily breaks backwards-compatibility.\nAnother issue is that we probably need to change the long name format to be something like\ntopoId.<topoId>.hostname.<hostname>...\nso a reporter can parse the metric into dimensions. Our current format of long metrics is not easy to parse. This can be a follow-up work.", "author": "Ethanlm", "createdAt": "2020-05-13T13:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4ODc3NA==", "url": "https://github.com/apache/storm/pull/3263#discussion_r424488774", "bodyText": "I will remove the prefixes for the short names for the purpose of this JIRA.", "author": "agresch", "createdAt": "2020-05-13T14:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk5OTc2Mw=="}], "type": "inlineReview"}, {"oid": "a3378c09fb0bf35ee20ddc1dd5a33ace8b576eda", "url": "https://github.com/apache/storm/commit/a3378c09fb0bf35ee20ddc1dd5a33ace8b576eda", "message": "STORM-3627 allow using short metric names for V2 metrics tick", "committedDate": "2020-05-13T15:20:23Z", "type": "commit"}, {"oid": "a3378c09fb0bf35ee20ddc1dd5a33ace8b576eda", "url": "https://github.com/apache/storm/commit/a3378c09fb0bf35ee20ddc1dd5a33ace8b576eda", "message": "STORM-3627 allow using short metric names for V2 metrics tick", "committedDate": "2020-05-13T15:20:23Z", "type": "forcePushed"}]}