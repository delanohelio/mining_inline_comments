{"pr_number": 10898, "pr_title": "[FLINK-15632][kubernetes] Make zookeeper HA service could work for active kubernetes integration", "pr_createdAt": "2020-01-19T09:26:13Z", "pr_url": "https://github.com/apache/flink/pull/10898", "timeline": [{"oid": "09c6c4e6068e7d01c7c6f14370b9fbc6b0bdce69", "url": "https://github.com/apache/flink/commit/09c6c4e6068e7d01c7c6f14370b9fbc6b0bdce69", "message": "[FLINK-15632][kubernetes] Make zookeeper HA service could work for active kubernetes integration\n\nThere will be the following differences if we want to support HA for active Kubernetes integration.\n1. The K8s service is designed for accessing the jobmanager out of K8s cluster. So Flink client will not use HA service to retrieve address of jobmanager. Instead, it always use Kubernetes service to contact with jobmanager via rest client.\n2. The Kubernetes DNS creates A and SRV records only for Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n\nAll other behaviors will be same as Zookeeper HA for standalone and Yarn.", "committedDate": "2020-01-19T09:28:49Z", "type": "forcePushed"}, {"oid": "88dc2a5835294f062651e85c9146aa91eeaf302e", "url": "https://github.com/apache/flink/commit/88dc2a5835294f062651e85c9146aa91eeaf302e", "message": "[FLINK-15632][kubernetes] Make zookeeper HA service could work for active kubernetes integration\n\nThere will be the following differences if we want to support HA for active Kubernetes integration.\n1. The K8s service is designed for accessing the jobmanager out of K8s cluster. So Flink client will not use HA service to retrieve address of jobmanager. Instead, it always use Kubernetes service to contact with jobmanager via rest client.\n2. The Kubernetes DNS creates A and SRV records only for Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n\nAll other behaviors will be same as Zookeeper HA for standalone and Yarn.", "committedDate": "2020-01-19T10:05:58Z", "type": "forcePushed"}, {"oid": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "url": "https://github.com/apache/flink/commit/93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "message": "[FLINK-15632][kubernetes] Make zookeeper HA service could work for active kubernetes integration\n\nThere will be the following differences if we want to support HA for active Kubernetes integration.\n1. The K8s service is designed for accessing the jobmanager out of K8s cluster. So Flink client will not use HA service to retrieve address of jobmanager. Instead, it always use Kubernetes service to contact with jobmanager via rest client.\n2. The Kubernetes DNS creates A and SRV records only for Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n\nAll other behaviors will be same as Zookeeper HA for standalone and Yarn.", "committedDate": "2020-01-19T10:13:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MjI0Ng==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368282246", "bodyText": "It's better to add a private constructor for this util class", "author": "zhuzhurk", "createdAt": "2020-01-19T10:16:40Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/entrypoint/KubernetesEntrypointUtils.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.kubernetes.entrypoint;\n+\n+import org.apache.flink.configuration.ConfigConstants;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.configuration.GlobalConfiguration;\n+import org.apache.flink.configuration.JobManagerOptions;\n+import org.apache.flink.configuration.RestOptions;\n+import org.apache.flink.kubernetes.utils.Constants;\n+import org.apache.flink.runtime.jobmanager.HighAvailabilityMode;\n+import org.apache.flink.util.Preconditions;\n+\n+/**\n+ * This class contains utility methods for the {@link KubernetesSessionClusterEntrypoint}.\n+ */\n+class KubernetesEntrypointUtils {", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDQxNw==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368290417", "bodyText": "Nice suggestion. I will fix it.", "author": "wangyang0918", "createdAt": "2020-01-19T12:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MjM3OQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368282379", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tfinal String ipAddress =  System.getenv().get(Constants.ENV_FLINK_POD_IP_ADDRESS);\n          \n          \n            \n            \t\t\tfinal String ipAddress = System.getenv().get(Constants.ENV_FLINK_POD_IP_ADDRESS);", "author": "zhuzhurk", "createdAt": "2020-01-19T10:18:19Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/entrypoint/KubernetesEntrypointUtils.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.kubernetes.entrypoint;\n+\n+import org.apache.flink.configuration.ConfigConstants;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.configuration.GlobalConfiguration;\n+import org.apache.flink.configuration.JobManagerOptions;\n+import org.apache.flink.configuration.RestOptions;\n+import org.apache.flink.kubernetes.utils.Constants;\n+import org.apache.flink.runtime.jobmanager.HighAvailabilityMode;\n+import org.apache.flink.util.Preconditions;\n+\n+/**\n+ * This class contains utility methods for the {@link KubernetesSessionClusterEntrypoint}.\n+ */\n+class KubernetesEntrypointUtils {\n+\n+\t/**\n+\t * For non-HA cluster, jobmanager rpc address has be set to Kubernetes service name on client side. So the TaskManager\n+\t * will use service address to connect with jobmanager.\n+\t * For HA cluster, jobmanager rpc address will be set to ip address. The TaskManager use Zookeeper or other\n+\t * high-availability service to find the address of jobmanager. The Kubernetes DNS creates A and SRV records only for\n+\t * Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n+\t *\n+\t * @return Updated configuration\n+\t */\n+\tstatic Configuration loadConfiguration() {\n+\t\tfinal String configDir = System.getenv(ConfigConstants.ENV_FLINK_CONF_DIR);\n+\t\tPreconditions.checkNotNull(\n+\t\t\tconfigDir,\n+\t\t\t\"Flink configuration directory (%s) in environment should not be null!\",\n+\t\t\tConfigConstants.ENV_FLINK_CONF_DIR);\n+\n+\t\tfinal Configuration configuration = GlobalConfiguration.loadConfiguration(configDir);\n+\n+\t\tif (HighAvailabilityMode.isHighAvailabilityModeActivated(configuration)) {\n+\t\t\tfinal String ipAddress =  System.getenv().get(Constants.ENV_FLINK_POD_IP_ADDRESS);", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MjU1Ng==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368282556", "bodyText": "useless withEnvFrom?", "author": "zhuzhurk", "createdAt": "2020-01-19T10:21:37Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/kubeclient/decorators/FlinkMasterDeploymentDecorator.java", "diffHunk": "@@ -138,13 +144,21 @@ private Container createJobManagerContainer(\n \t\t\t\tnew ContainerPortBuilder().withContainerPort(flinkConfig.getInteger(RestOptions.PORT)).build(),\n \t\t\t\tnew ContainerPortBuilder().withContainerPort(flinkConfig.getInteger(JobManagerOptions.PORT)).build(),\n \t\t\t\tnew ContainerPortBuilder().withContainerPort(blobServerPort).build()))\n-\t\t\t.withEnv(\n-\t\t\t\tBootstrapTools.getEnvironmentVariables(ResourceManagerOptions.CONTAINERIZED_MASTER_ENV_PREFIX, flinkConfig)\n-\t\t\t\t\t.entrySet()\n-\t\t\t\t\t.stream()\n-\t\t\t\t\t.map(kv -> new EnvVar(kv.getKey(), kv.getValue(), null))\n-\t\t\t\t\t.collect(Collectors.toList()))\n+\t\t\t.withEnv(buildEnvForContainer(flinkConfig)).withEnvFrom()", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDQ3NQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368290475", "bodyText": "Aha, i forget to remove it and will fix it.", "author": "wangyang0918", "createdAt": "2020-01-19T12:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MjU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4Mjg4NQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368282885", "bodyText": "This change seems to be unrelated? How about to do it in a separate commit?", "author": "zhuzhurk", "createdAt": "2020-01-19T10:26:51Z", "path": "flink-kubernetes/src/test/java/org/apache/flink/kubernetes/kubeclient/Fabric8ClientTest.java", "diffHunk": "@@ -189,7 +190,10 @@ public void testCreateFlinkMasterDeployment() {\n \t\t\tjmContainer.getVolumeMounts().get(0).getMountPath());\n \t\tassertEquals(FLINK_CONF_FILENAME, jmContainer.getVolumeMounts().get(0).getSubPath());\n \n-\t\tassertThat(jmContainer.getEnv(), Matchers.contains(new EnvVar(FLINK_MASTER_ENV_KEY, FLINK_MASTER_ENV_VALUE, null)));\n+\t\tEnvVar masterEnv = new EnvVar(FLINK_MASTER_ENV_KEY, FLINK_MASTER_ENV_VALUE, null);", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDQ4Nw==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368290487", "bodyText": "Make sense. I will put it into a separate commit.", "author": "wangyang0918", "createdAt": "2020-01-19T12:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4Mjg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzI2NA==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368283264", "bodyText": "How about to set it to IP in all cases to avoid confusion, namely, change how we set JobManagerOptions.ADDRESS in KubernetesClusterDescriptor#deployClusterInternal()?", "author": "zhuzhurk", "createdAt": "2020-01-19T10:32:16Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/entrypoint/KubernetesEntrypointUtils.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.kubernetes.entrypoint;\n+\n+import org.apache.flink.configuration.ConfigConstants;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.configuration.GlobalConfiguration;\n+import org.apache.flink.configuration.JobManagerOptions;\n+import org.apache.flink.configuration.RestOptions;\n+import org.apache.flink.kubernetes.utils.Constants;\n+import org.apache.flink.runtime.jobmanager.HighAvailabilityMode;\n+import org.apache.flink.util.Preconditions;\n+\n+/**\n+ * This class contains utility methods for the {@link KubernetesSessionClusterEntrypoint}.\n+ */\n+class KubernetesEntrypointUtils {\n+\n+\t/**\n+\t * For non-HA cluster, jobmanager rpc address has be set to Kubernetes service name on client side. So the TaskManager\n+\t * will use service address to connect with jobmanager.\n+\t * For HA cluster, jobmanager rpc address will be set to ip address. The TaskManager use Zookeeper or other\n+\t * high-availability service to find the address of jobmanager. The Kubernetes DNS creates A and SRV records only for\n+\t * Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n+\t *\n+\t * @return Updated configuration\n+\t */\n+\tstatic Configuration loadConfiguration() {\n+\t\tfinal String configDir = System.getenv(ConfigConstants.ENV_FLINK_CONF_DIR);\n+\t\tPreconditions.checkNotNull(\n+\t\t\tconfigDir,\n+\t\t\t\"Flink configuration directory (%s) in environment should not be null!\",\n+\t\t\tConfigConstants.ENV_FLINK_CONF_DIR);\n+\n+\t\tfinal Configuration configuration = GlobalConfiguration.loadConfiguration(configDir);\n+\n+\t\tif (HighAvailabilityMode.isHighAvailabilityModeActivated(configuration)) {\n+\t\t\tfinal String ipAddress =  System.getenv().get(Constants.ENV_FLINK_POD_IP_ADDRESS);\n+\t\t\tPreconditions.checkState(\n+\t\t\t\tipAddress != null,\n+\t\t\t\t\"JobManager ip address environment variable %s not set\",\n+\t\t\t\tConstants.ENV_FLINK_POD_IP_ADDRESS);\n+\t\t\tconfiguration.setString(JobManagerOptions.ADDRESS, ipAddress);", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MDc0OQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368290749", "bodyText": "In non-HA mode, we need to set the jobmanager rpc address to service name. So when the jobmanager failover, the taskmanager could register again.\nIn HA mode, the taskmanager uses zookeeper to retrieve the jobmanager address. And there will be multiple jobmanagers in the future. So we set the ip address instead of jobmanager rpc address.\nSo i think we could not always set JobManagerOptions.ADDRESS to ip address.", "author": "wangyang0918", "createdAt": "2020-01-19T12:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzY4OA==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368283688", "bodyText": "This might work. However, the way is a bit hack and add some dependency/assumption to the behavior of non-HA mode.\nIs there a clean way we let the client retrieve jobmanager address from k8s service no matter what the HA mode is?", "author": "zhuzhurk", "createdAt": "2020-01-19T10:38:01Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/KubernetesClusterDescriptor.java", "diffHunk": "@@ -84,6 +86,11 @@ public String getClusterDescription() {\n \t\t\tif (restEndpoint != null) {\n \t\t\t\tconfiguration.setString(RestOptions.ADDRESS, restEndpoint.getAddress());\n \t\t\t\tconfiguration.setInteger(RestOptions.PORT, restEndpoint.getPort());\n+\t\t\t\t// Flink client will not use HA service to retrieve address of jobmanager. Instead, it always use Kubernetes\n+\t\t\t\t// service to contact with jobmanager via rest client.\n+\t\t\t\tif (HighAvailabilityMode.isHighAvailabilityModeActivated(flinkConfig)) {", "originalCommit": "93fe86fa5b20c9ab53afc0fd3f664ac8af0383ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI5MzY5NA==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368293694", "bodyText": "I do not think it is a temporary hack.\nIn Kubernetes deployment, when we want to get a ClusterClient, we should not retrieve it from the ClientHAService. Instead, we retrieve the rest endpoint from Kubernetes service by FlinkKubeClient.getRestEndpoint(clusterId).\nMaybe removing the condition if (HighAvailabilityMode.isHighAvailabilityModeActivated(flinkConfig)) will look better.", "author": "wangyang0918", "createdAt": "2020-01-19T13:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1MTI5Mw==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368351293", "bodyText": "I have a serious consideration and will find a more clean way. Maybe adding a new construct method for RestClusterClient could work.", "author": "wangyang0918", "createdAt": "2020-01-20T02:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzY4OA=="}], "type": "inlineReview"}, {"oid": "84bb6a6ec1c0fe6d7c62e4fa68cabef6937954a8", "url": "https://github.com/apache/flink/commit/84bb6a6ec1c0fe6d7c62e4fa68cabef6937954a8", "message": "[FLINK-15632][kubernetes] Make zookeeper HA service could work for active kubernetes integration\n\nThere will be the following differences if we want to support HA for active Kubernetes integration.\n1. The K8s service is designed for accessing the jobmanager out of K8s cluster. So Flink client will not use HA service to retrieve address of jobmanager. Instead, it always use Kubernetes service to contact with jobmanager via rest client.\n2. The Kubernetes DNS creates A and SRV records only for Services. It doesn't generate pods' A records. So the ip address, not hostname, will be used as jobmanager address.\n\nAll other behaviors will be same as Zookeeper HA for standalone and Yarn.", "committedDate": "2020-01-19T13:34:25Z", "type": "forcePushed"}, {"oid": "46e510779736a390f71ac42f8294c81b6cbaa51c", "url": "https://github.com/apache/flink/commit/46e510779736a390f71ac42f8294c81b6cbaa51c", "message": "[FLINK-15632][kubernetes] Set JobManagerOptions#ADDRESS to the pod ip address when HA mode enabled\n\nFor non-HA cluster, JobManagerOptions#ADDRESS has be set to Kubernetes service name on client side. See KubernetesClusterDescriptor#deployClusterInternal. So the TaskManager will use service address to contact with JobManager.\nFor HA cluster, JobManagerOptions#ADDRESS will be set to the pod ip address. The TaskManager uses Zookeeper or other high-availability service to find the address of JobManager.", "committedDate": "2020-01-20T03:22:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyNTg1Mg==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368525852", "bodyText": "better to checkNotNull", "author": "zhuzhurk", "createdAt": "2020-01-20T12:37:03Z", "path": "flink-clients/src/main/java/org/apache/flink/client/program/rest/RestClusterClient.java", "diffHunk": "@@ -182,7 +206,7 @@ public RestClusterClient(Configuration config, T clusterId) throws Exception {\n \t\tthis.waitStrategy = checkNotNull(waitStrategy);\n \t\tthis.clusterId = checkNotNull(clusterId);\n \n-\t\tthis.clientHAServices = HighAvailabilityServicesUtils.createClientHAService(configuration);\n+\t\tthis.clientHAServices = clientHAServices;", "originalCommit": "46e510779736a390f71ac42f8294c81b6cbaa51c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NDQ3OA==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368554478", "bodyText": "Make sense.", "author": "wangyang0918", "createdAt": "2020-01-20T13:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyNTg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyOTE5Nw==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368529197", "bodyText": "What's the config overriding for?", "author": "zhuzhurk", "createdAt": "2020-01-20T12:45:40Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/KubernetesClusterDescriptor.java", "diffHunk": "@@ -168,6 +185,13 @@ public String getClusterDescription() {\n \t\tfinal String nameSpace = flinkConfig.getString(KubernetesConfigOptions.NAMESPACE);\n \t\tflinkConfig.setString(JobManagerOptions.ADDRESS, clusterId + \".\" + nameSpace);\n \n+\t\tif (HighAvailabilityMode.isHighAvailabilityModeActivated(flinkConfig)) {\n+\t\t\tflinkConfig.setString(HighAvailabilityOptions.HA_CLUSTER_ID, clusterId);", "originalCommit": "c9447fa3992503fa0248804f23538087a18660c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NjUzOA==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368556538", "bodyText": "We should update the HA_CLUSTER_ID since it will be used to contruct the zk path and ha storage path for the Flink cluster.\nYarn has the similar behavior in FlinkYarnSessionCli#applyCommandLineOptionsToConfiguration.", "author": "wangyang0918", "createdAt": "2020-01-20T13:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyOTE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4Mzk5NQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368783995", "bodyText": "So this change is not related to this commit?", "author": "zhuzhurk", "createdAt": "2020-01-21T02:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyOTE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4NDk5Ng==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368784996", "bodyText": "It is necessary when high-availability enabled. So do you mean to separate it to another commit?", "author": "wangyang0918", "createdAt": "2020-01-21T02:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyOTE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc5MTEwNQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368791105", "bodyText": "Yes. If it fixes another issue, we should make it a different commit.", "author": "zhuzhurk", "createdAt": "2020-01-21T02:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyOTE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzNDAwNQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368534005", "bodyText": "It would be better to leave a comment here for why we use StandaloneClientHAServices for k8s client.", "author": "zhuzhurk", "createdAt": "2020-01-20T12:57:50Z", "path": "flink-kubernetes/src/main/java/org/apache/flink/kubernetes/KubernetesClusterDescriptor.java", "diffHunk": "@@ -91,7 +104,11 @@ public String getClusterDescription() {\n \t\t\t}\n \n \t\t\ttry {\n-\t\t\t\treturn new RestClusterClient<>(configuration, clusterId);\n+\t\t\t\treturn new RestClusterClient<>(\n+\t\t\t\t\tconfiguration,\n+\t\t\t\t\tclusterId,\n+\t\t\t\t\tnew StandaloneClientHAServices(HighAvailabilityServicesUtils.getWebMonitorAddress(", "originalCommit": "46e510779736a390f71ac42f8294c81b6cbaa51c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NjcwNQ==", "url": "https://github.com/apache/flink/pull/10898#discussion_r368556705", "bodyText": "I will add some comments here.", "author": "wangyang0918", "createdAt": "2020-01-20T13:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzNDAwNQ=="}], "type": "inlineReview"}, {"oid": "69f28f72014de47081ad433675b42d62356bb116", "url": "https://github.com/apache/flink/commit/69f28f72014de47081ad433675b42d62356bb116", "message": "[FLINK-15632][kubernetes] Set JobManagerOptions#ADDRESS to the pod ip address when HA mode enabled\n\nFor non-HA cluster, JobManagerOptions#ADDRESS has be set to Kubernetes service name on client side. See KubernetesClusterDescriptor#deployClusterInternal. So the TaskManager will use service address to contact with JobManager.\nFor HA cluster, JobManagerOptions#ADDRESS will be set to the pod ip address. The TaskManager uses Zookeeper or other high-availability service to find the address of JobManager.", "committedDate": "2020-01-21T02:15:47Z", "type": "forcePushed"}, {"oid": "86fe40ba1c3256a47a001eb54399abfea8ef5598", "url": "https://github.com/apache/flink/commit/86fe40ba1c3256a47a001eb54399abfea8ef5598", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be fallback to the default value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T03:45:32Z", "type": "forcePushed"}, {"oid": "69eaf5504b554d201901f590f8222dd4e227ffa8", "url": "https://github.com/apache/flink/commit/69eaf5504b554d201901f590f8222dd4e227ffa8", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T03:53:31Z", "type": "forcePushed"}, {"oid": "a43bc2d6a72469aecc9c5b6dec1a70d14ea94fe7", "url": "https://github.com/apache/flink/commit/a43bc2d6a72469aecc9c5b6dec1a70d14ea94fe7", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T03:59:39Z", "type": "forcePushed"}, {"oid": "a68eb2b118a55d7ad994e4a9d5dad25bc436f737", "url": "https://github.com/apache/flink/commit/a68eb2b118a55d7ad994e4a9d5dad25bc436f737", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T06:38:49Z", "type": "forcePushed"}, {"oid": "3da241511d5030cf3120c9f3e381b21fef0b4347", "url": "https://github.com/apache/flink/commit/3da241511d5030cf3120c9f3e381b21fef0b4347", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T06:39:42Z", "type": "forcePushed"}, {"oid": "d4624a807cb6639b2c68646b9fdb933c7560d0a6", "url": "https://github.com/apache/flink/commit/d4624a807cb6639b2c68646b9fdb933c7560d0a6", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T07:58:30Z", "type": "forcePushed"}, {"oid": "dac85ecbe94c0b9bb04808e822ccbf8b1f4a2d1e", "url": "https://github.com/apache/flink/commit/dac85ecbe94c0b9bb04808e822ccbf8b1f4a2d1e", "message": "[hotfix][kubernetes] Only check the expected env vars in Fabric8ClientTest#testCreateFlinkMasterDeployment", "committedDate": "2020-01-21T15:53:11Z", "type": "commit"}, {"oid": "ffafa9908521a6b939a0c99ffcd82f86ab81424f", "url": "https://github.com/apache/flink/commit/ffafa9908521a6b939a0c99ffcd82f86ab81424f", "message": "[FLINK-15632][kubernetes] Make Flink client always uses Kubernetes service to contact with jobmanager via rest client\n\nThe K8s service is designed for accessing the jobmanager out of K8s cluster. So Flink client will not use HA service to retrieve address of jobmanager. Instead, it always uses Kubernetes service to contact with jobmanager via rest client. So firstly, we will get the RestOptions#ADDRESS and RestOptions#PORT from the Kubernetes service and set the values to configuration. Then we will use the updated configuration to construct a StandaloneClientHAServices for RestClusterClient.", "committedDate": "2020-01-21T15:53:11Z", "type": "commit"}, {"oid": "fb19b25f85613aeb2f3a86e0b7f5302e20daf81a", "url": "https://github.com/apache/flink/commit/fb19b25f85613aeb2f3a86e0b7f5302e20daf81a", "message": "[FLINK-15632][kubernetes] Set JobManagerOptions#ADDRESS to the pod ip address when HA mode enabled\n\nFor non-HA cluster, JobManagerOptions#ADDRESS has be set to Kubernetes service name on client side. See KubernetesClusterDescriptor#deployClusterInternal. So the TaskManager will use service address to contact with JobManager.\nFor HA cluster, JobManagerOptions#ADDRESS will be set to the pod ip address. The TaskManager uses Zookeeper or other high-availability service to find the address of JobManager.", "committedDate": "2020-01-21T15:53:11Z", "type": "commit"}, {"oid": "18df29c4c4e6b174cb5d206ca2e4878be1e5d5dd", "url": "https://github.com/apache/flink/commit/18df29c4c4e6b174cb5d206ca2e4878be1e5d5dd", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T15:53:11Z", "type": "commit"}, {"oid": "18df29c4c4e6b174cb5d206ca2e4878be1e5d5dd", "url": "https://github.com/apache/flink/commit/18df29c4c4e6b174cb5d206ca2e4878be1e5d5dd", "message": "[FLINK-15632][kubernetes] Update the cluster id and high-availability jobmanager port when HA enabled\n\nWhen HA enabled, the config option HighAvailabilityOptions.HA_CLUSTER_ID will be set to the user specified cluster id. And if the config option HighAvailabilityOptions.HA_JOB_MANAGER_PORT_RANGE is not set or with value 0, it will be updated to the value of JobManagerOptions.PORT.", "committedDate": "2020-01-21T15:53:11Z", "type": "forcePushed"}]}