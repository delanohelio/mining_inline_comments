{"pr_number": 12729, "pr_title": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "pr_createdAt": "2020-06-20T19:10:50Z", "pr_url": "https://github.com/apache/flink/pull/12729", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzMxNA==", "url": "https://github.com/apache/flink/pull/12729#discussion_r446643314", "bodyText": "should we set the global flag to true ? to enforce having only that limit throughout the channel ?\ni am worried if someone adds a functionality that say requires having multiple consumers on the same channel that then the preFetchCount would be per consumer and the preFetchCount set by the client would suddenly mean a completely different thing. But if enforced here to be per channel it will have the same effect for the user.\nAccording to the documentation  chan.basicQos(prefectchCount, boolean global) and the boolean global is:\nfalse | applied separately to each new consumer on the channel\ntrue  | shared across all consumers on the channel", "author": "senegalo", "createdAt": "2020-06-28T12:16:05Z", "path": "flink-connectors/flink-connector-rabbitmq/src/main/java/org/apache/flink/streaming/connectors/rabbitmq/RMQSource.java", "diffHunk": "@@ -141,6 +140,22 @@ protected Connection setupConnection() throws Exception {\n \t\treturn setupConnectionFactory().newConnection();\n \t}\n \n+\t/**\n+\t * Initializes the consumer's {@link Channel}. If a prefetch count has been set in {@link RMQConnectionConfig},\n+\t * the new channel will be use it for {@link Channel#basicQos(int)}.\n+\t *\n+\t * @param connection the consumer's {@link Connection}.\n+\t * @return the channel.\n+\t * @throws Exception if there is an issue creating or configuring the channel.\n+\t */\n+\tprotected Channel setupChannel(Connection connection) throws Exception {\n+\t\tChannel chan = connection.createChannel();\n+\t\tif (rmqConnectionConfig.getPrefetchCount().isPresent()) {\n+\t\t\tchan.basicQos(rmqConnectionConfig.getPrefetchCount().get());", "originalCommit": "99231d5b11dd2adced76b48996dfb252b5cc9fc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MDk5MA==", "url": "https://github.com/apache/flink/pull/12729#discussion_r446980990", "bodyText": "Thanks for going through this! That's a good point, I'm not sure what a good answer is. I've read in the Nodejs client I used that sending that flag to a RMQ cluster < version 3.3.0 will kill it entirely, but I haven't tested that out at all or seen it elsewhere. I'll put together a playground this week.\nWe're always reading off of one queue per source in our jobs, but our use case is pretty simple so I'm not sure I've got the best understanding of other RMQ users. What kinds of reasons do people have for sharing a channel?", "author": "austince", "createdAt": "2020-06-29T13:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4OTUyOA==", "url": "https://github.com/apache/flink/pull/12729#discussion_r447089528", "bodyText": "Hemm ... you're absolutely right i also have a very basic setup several independent brokers and we duplicate and deduplicate on the clients.\nTo keep life interesting, using the global flag with an RabbitMQ older than v3.3.0 will bring down the whole connection. \ud83e\udd23 okay then experimenting is the way to go !  do you need a helping hand ? i can spare a couple of hours next weekend if you need help.", "author": "senegalo", "createdAt": "2020-06-29T16:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMDQ4NA==", "url": "https://github.com/apache/flink/pull/12729#discussion_r447320484", "bodyText": "I'll let you know how it goes and thank you for the offer - I'll take you up on it if I can't find time this week! Moving this weekend, so it'll be busy over here..", "author": "austince", "createdAt": "2020-06-29T23:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI4MzQ1Mw==", "url": "https://github.com/apache/flink/pull/12729#discussion_r458283453", "bodyText": "Finally got around to this, sorry about the late reply! When I was putting together the example, I found that RMQ 3.3 is not even available on Docker hub and has been out of service since 2015 and the last patch was released in 2016, so I think we can safely just set the global flag and not care about that version. Here's the playground running this branch's code: https://github.com/austince/flink-rmq-playground", "author": "austince", "createdAt": "2020-07-21T17:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0MzMxNA=="}], "type": "inlineReview"}, {"oid": "ce89d0b66d61398909e82fd603181f4976351f48", "url": "https://github.com/apache/flink/commit/ce89d0b66d61398909e82fd603181f4976351f48", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-21T17:11:41Z", "type": "forcePushed"}, {"oid": "0208e794f8691c50a74caf13783806ced51b0ae9", "url": "https://github.com/apache/flink/commit/0208e794f8691c50a74caf13783806ced51b0ae9", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-21T17:57:26Z", "type": "forcePushed"}, {"oid": "765fcb8c6c01c00bb15a3ce256e2608dc1ffe7ca", "url": "https://github.com/apache/flink/commit/765fcb8c6c01c00bb15a3ce256e2608dc1ffe7ca", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-21T18:03:06Z", "type": "forcePushed"}, {"oid": "790ebc88d93408cba281d3836ea24e6f6bc4a866", "url": "https://github.com/apache/flink/commit/790ebc88d93408cba281d3836ea24e6f6bc4a866", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-22T13:58:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4OTIyNQ==", "url": "https://github.com/apache/flink/pull/12729#discussion_r462289225", "bodyText": "If I understand the RMQSource well, the reasons why setupConnection or setupConnectionFactory are protected is for assertions in tests. I see you managed to test it without using the setupChannel method. I think we can safely make it private.\nMoreover WDYT of annotating the other methods with VisibleForTesting?", "author": "dawidwys", "createdAt": "2020-07-29T13:16:20Z", "path": "flink-connectors/flink-connector-rabbitmq/src/main/java/org/apache/flink/streaming/connectors/rabbitmq/RMQSource.java", "diffHunk": "@@ -141,6 +140,25 @@ protected Connection setupConnection() throws Exception {\n \t\treturn setupConnectionFactory().newConnection();\n \t}\n \n+\t/**\n+\t * Initializes the consumer's {@link Channel}. If a prefetch count has been set in {@link RMQConnectionConfig},\n+\t * the new channel will be use it for {@link Channel#basicQos(int)}.\n+\t *\n+\t * @param connection the consumer's {@link Connection}.\n+\t * @return the channel.\n+\t * @throws Exception if there is an issue creating or configuring the channel.\n+\t */\n+\tprotected Channel setupChannel(Connection connection) throws Exception {", "originalCommit": "790ebc88d93408cba281d3836ea24e6f6bc4a866", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMxNTY0Mg==", "url": "https://github.com/apache/flink/pull/12729#discussion_r462315642", "bodyText": "I think both are great ideas, I'll implement those shortly.", "author": "austince", "createdAt": "2020-07-29T13:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4OTIyNQ=="}], "type": "inlineReview"}, {"oid": "491460bd0b5a9b2e67170d32ca2ffc3506950f65", "url": "https://github.com/apache/flink/commit/491460bd0b5a9b2e67170d32ca2ffc3506950f65", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-29T13:55:57Z", "type": "commit"}, {"oid": "491460bd0b5a9b2e67170d32ca2ffc3506950f65", "url": "https://github.com/apache/flink/commit/491460bd0b5a9b2e67170d32ca2ffc3506950f65", "message": "[FLINK-10195][connectors/rabbitmq] Allow setting QoS", "committedDate": "2020-07-29T13:55:57Z", "type": "forcePushed"}, {"oid": "5ffd02df057f21695027531e82e0ec717c2ddb91", "url": "https://github.com/apache/flink/commit/5ffd02df057f21695027531e82e0ec717c2ddb91", "message": "[FLINK-17529][connectors/rabbitmq] Upgrade com.rabbitmq:amqp-client to 5.9.0", "committedDate": "2020-07-29T15:36:41Z", "type": "commit"}]}