{"pr_number": 10887, "pr_title": "[FLINK-15150][tests] Prevent job from reaching terminal state", "pr_createdAt": "2020-01-17T14:23:11Z", "pr_url": "https://github.com/apache/flink/pull/10887", "timeline": [{"oid": "a14c99309223cb36f6da40429910247dba35e226", "url": "https://github.com/apache/flink/commit/a14c99309223cb36f6da40429910247dba35e226", "message": "[FLINK-15150][tests] Prevent job from reaching terminal state\n\nExplicitly enable restarts; this is necessary since the shutdown may result in the job failing and hence being removed from ZooKeeper.\nWhat happens to running jobs if the Dispatcher shuts down in an orderly fashion is undefined behavior.\nBy allowing restarts we prevent the job from reaching a globally terminal state, causing it to be recovered by the next Dispatcher.", "committedDate": "2020-01-17T14:13:34Z", "type": "commit"}, {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312", "url": "https://github.com/apache/flink/commit/7f91b3855bca5e7e2d2d9abf196cca861e122312", "message": "[hotfix][zookeeper] Log changes to SchedulingState", "committedDate": "2020-01-17T14:14:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369163346", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));\n          \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(100, Duration.ofMillis(100).toMillis()));", "author": "tillrohrmann", "createdAt": "2020-01-21T18:17:29Z", "path": "flink-tests/src/test/java/org/apache/flink/test/runtime/leaderelection/ZooKeeperLeaderElectionITCase.java", "diffHunk": "@@ -141,13 +144,23 @@ private DispatcherGateway getNextLeadingDispatcherGateway(TestingMiniCluster min\n \t\treturn miniCluster.getDispatcherGatewayFuture().get();\n \t}\n \n-\tprivate JobGraph createJobGraph(int parallelism) {\n+\tprivate JobGraph createJobGraph(int parallelism) throws IOException {\n \t\tBlockingOperator.isBlocking = true;\n \t\tfinal JobVertex vertex = new JobVertex(\"blocking operator\");\n \t\tvertex.setParallelism(parallelism);\n \t\tvertex.setInvokableClass(BlockingOperator.class);\n \n-\t\treturn new JobGraph(\"Blocking test job\", vertex);\n+\t\tJobGraph jobGraph = new JobGraph(\"Blocking test job\", vertex);\n+\n+\t\t// explicitly allow restarts; this is necessary since the shutdown may result in the job failing and hence being\n+\t\t// removed from ZooKeeper. What happens to running jobs if the Dispatcher shuts down in an orderly fashion\n+\t\t// is undefined behavior. By allowing restarts we prevent the job from reaching a globally terminal state,\n+\t\t// causing it to be recovered by the next Dispatcher.\n+\t\tExecutionConfig executionConfig = new ExecutionConfig();\n+\t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));", "originalCommit": "7f91b3855bca5e7e2d2d9abf196cca861e122312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE3MTQ1Mg==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369171452", "bodyText": "My idea here was to not have the job actually restart since it shouldn't be relevant to the test whether the job is running/restarting (just that it's not failed), and these state transitions add additional noise to the logs.", "author": "zentol", "createdAt": "2020-01-21T18:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NjA1NQ==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369546055", "bodyText": "Good point. Then ignore my comment.", "author": "tillrohrmann", "createdAt": "2020-01-22T13:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng=="}], "type": "inlineReview"}]}