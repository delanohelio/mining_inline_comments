{"pr_number": 12617, "pr_title": "[FLINK-18252][checkpointing] Fix savepoint overtaking output data.", "pr_createdAt": "2020-06-11T19:24:03Z", "pr_url": "https://github.com/apache/flink/pull/12617", "timeline": [{"oid": "1e534d1a704430e11761cab5d978608e33be6f1d", "url": "https://github.com/apache/flink/commit/1e534d1a704430e11761cab5d978608e33be6f1d", "message": "[FLINK-18252][checkpointing] Fix savepoint overtaking output data.\n\nCurrently, a checkpoint/savepoint barrier is always send as a priority events to the output partitions, where it overtakes data. After the fix a barrier is only a priority event iff it's unaligned.\nAlso CheckpointCoordinator only set unaligned flag if the barrier belongs to a checkpoint.\nUltimately, the unaligned checkpoint config option is not used by SubtaskCheckpointCoordinatorImpl except for initializing the channel state writer. The source of truth is now the CheckpointOptions.", "committedDate": "2020-06-11T19:27:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2NTgwMg==", "url": "https://github.com/apache/flink/pull/12617#discussion_r439065802", "bodyText": "\ud83d\udc4d", "author": "rkhachatryan", "createdAt": "2020-06-11T20:55:20Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -732,7 +732,7 @@ private void snapshotTaskState(\n \t\t\tprops.getCheckpointType(),\n \t\t\tcheckpointStorageLocation.getLocationReference(),\n \t\t\tisExactlyOnceMode,\n-\t\t\tunalignedCheckpointsEnabled);\n+\t\t\tprops.getCheckpointType() == CheckpointType.CHECKPOINT && unalignedCheckpointsEnabled);", "originalCommit": "1e534d1a704430e11761cab5d978608e33be6f1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2NzgxNQ==", "url": "https://github.com/apache/flink/pull/12617#discussion_r439067815", "bodyText": "\ud83d\udc4d", "author": "rkhachatryan", "createdAt": "2020-06-11T20:59:36Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorTest.java", "diffHunk": "@@ -119,10 +122,40 @@ public void testNotifyCheckpointComplete() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testSavepointNotResultingInPriorityEvents() throws Exception {\n+\t\tMockEnvironment mockEnvironment = MockEnvironment.builder().build();\n+\n+\t\tSubtaskCheckpointCoordinator coordinator = new MockSubtaskCheckpointCoordinatorBuilder()\n+\t\t\t\t.setUnalignedCheckpointEnabled(true)\n+\t\t\t\t.setEnvironment(mockEnvironment)\n+\t\t\t\t.build();\n+\n+\t\tAtomicReference<Boolean> broadcastedPriorityEvent = new AtomicReference<>(null);\n+\t\tfinal OperatorChain<?, ?> operatorChain = new OperatorChain(\n+\t\t\t\tnew MockStreamTaskBuilder(mockEnvironment).build(),\n+\t\t\t\tnew NonRecordWriter<>()) {\n+\t\t\t@Override\n+\t\t\tpublic void broadcastEvent(AbstractEvent event, boolean isPriorityEvent) throws IOException {\n+\t\t\t\tsuper.broadcastEvent(event, isPriorityEvent);\n+\t\t\t\tbroadcastedPriorityEvent.set(isPriorityEvent);\n+\t\t\t}\n+\t\t};\n+\n+\t\tcoordinator.checkpointState(\n+\t\t\t\tnew CheckpointMetaData(0, 0),\n+\t\t\t\tnew CheckpointOptions(SAVEPOINT, CheckpointStorageLocationReference.getDefault()),\n+\t\t\t\tnew CheckpointMetrics(),\n+\t\t\t\toperatorChain,\n+\t\t\t\t() -> false);\n+\n+\t\tassertEquals(false, broadcastedPriorityEvent.get());\n+\t}\n+\n \t@Test\n \tpublic void testSkipChannelStateForSavepoints() throws Exception {\n \t\tSubtaskCheckpointCoordinator coordinator = new MockSubtaskCheckpointCoordinatorBuilder()\n-\t\t\t.setUnalignedCheckpointEnabled(false)\n+\t\t\t.setUnalignedCheckpointEnabled(true)", "originalCommit": "1e534d1a704430e11761cab5d978608e33be6f1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2OTgxNg==", "url": "https://github.com/apache/flink/pull/12617#discussion_r439069816", "bodyText": "I like the idea of using barrier options instead of local task configuration.", "author": "rkhachatryan", "createdAt": "2020-06-11T21:03:59Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -253,7 +249,7 @@ public void checkpointState(\n \t\t// Step (2): Send the checkpoint barrier downstream\n \t\toperatorChain.broadcastEvent(\n \t\t\tnew CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),\n-\t\t\tunalignedCheckpointEnabled);\n+\t\t\toptions.isUnalignedCheckpoint());", "originalCommit": "1e534d1a704430e11761cab5d978608e33be6f1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5NzQ5MA==", "url": "https://github.com/apache/flink/pull/12617#discussion_r439197490", "bodyText": "nit: might seem more consistent if we either remove below #includeChannelState method or use that method in all the places.", "author": "zhijiangW", "createdAt": "2020-06-12T04:14:37Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/SubtaskCheckpointCoordinatorImpl.java", "diffHunk": "@@ -253,7 +249,7 @@ public void checkpointState(\n \t\t// Step (2): Send the checkpoint barrier downstream\n \t\toperatorChain.broadcastEvent(\n \t\t\tnew CheckpointBarrier(metadata.getCheckpointId(), metadata.getTimestamp(), options),\n-\t\t\tunalignedCheckpointEnabled);\n+\t\t\toptions.isUnalignedCheckpoint());", "originalCommit": "1e534d1a704430e11761cab5d978608e33be6f1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3NDUzMg==", "url": "https://github.com/apache/flink/pull/12617#discussion_r439274532", "bodyText": "inlined", "author": "AHeise", "createdAt": "2020-06-12T08:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE5NzQ5MA=="}], "type": "inlineReview"}, {"oid": "02e1afbacf0c41f4d5412eca02654fa00ca179ce", "url": "https://github.com/apache/flink/commit/02e1afbacf0c41f4d5412eca02654fa00ca179ce", "message": "[FLINK-18252][checkpointing] Fix savepoint overtaking output data.\n\nCurrently, a checkpoint/savepoint barrier is always send as a priority events to the output partitions, where it overtakes data. After the fix a barrier is only a priority event iff it's unaligned.\nAlso CheckpointCoordinator only set unaligned flag if the barrier belongs to a checkpoint.\nUltimately, the unaligned checkpoint config option is not used by SubtaskCheckpointCoordinatorImpl except for initializing the channel state writer. The source of truth is now the CheckpointOptions.", "committedDate": "2020-06-12T08:13:25Z", "type": "commit"}, {"oid": "02e1afbacf0c41f4d5412eca02654fa00ca179ce", "url": "https://github.com/apache/flink/commit/02e1afbacf0c41f4d5412eca02654fa00ca179ce", "message": "[FLINK-18252][checkpointing] Fix savepoint overtaking output data.\n\nCurrently, a checkpoint/savepoint barrier is always send as a priority events to the output partitions, where it overtakes data. After the fix a barrier is only a priority event iff it's unaligned.\nAlso CheckpointCoordinator only set unaligned flag if the barrier belongs to a checkpoint.\nUltimately, the unaligned checkpoint config option is not used by SubtaskCheckpointCoordinatorImpl except for initializing the channel state writer. The source of truth is now the CheckpointOptions.", "committedDate": "2020-06-12T08:13:25Z", "type": "forcePushed"}]}