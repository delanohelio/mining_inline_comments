{"pr_number": 11394, "pr_title": "[FLINK-16573] Ensure Kinesis RecordFetcher threads shutdown on cancel", "pr_createdAt": "2020-03-12T12:31:39Z", "pr_url": "https://github.com/apache/flink/pull/11394", "timeline": [{"oid": "56935c039fb7635784bcc76c9d5320c01dc28f25", "url": "https://github.com/apache/flink/commit/56935c039fb7635784bcc76c9d5320c01dc28f25", "message": "[FLINK-16573] Ensure Kinesis RecordFetcher threads shutdown on cancel\n\nThe threads may not shut down correctly because they do not check for the\nrunning flag in the inner loops. The threads also do not get interrupted because\nthey are not connected to the main task thread.\n\nThese threads keep lingering around after the job has shut down:\n\n```\nThread 23168: (state = BLOCKED)\n - java.lang.Object.wait(long) @bci=0 (Compiled frame; information may be imprecise)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.emitRecords() @bci=140, line=209 (Compiled frame)\n - org.apache.flink.streaming.connectors.kinesis.util.RecordEmitter.run() @bci=18, line=177 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=748 (Compiled frame)\n```", "committedDate": "2020-03-12T12:26:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1NTU4OQ==", "url": "https://github.com/apache/flink/pull/11394#discussion_r391855589", "bodyText": "This wouldn't be necessary if the thread was interrupted when the fetcher terminates. Once we confirm that this change has the intended effect, let's merge it and cherry-pick into the relevant release branches. I will take a look at improving the thread management in the fetcher as a follow-up.", "author": "tweise", "createdAt": "2020-03-12T19:53:23Z", "path": "flink-connectors/flink-connector-kinesis/src/main/java/org/apache/flink/streaming/connectors/kinesis/util/RecordEmitter.java", "diffHunk": "@@ -205,6 +205,10 @@ protected void emitRecords() {\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\tif (!running) {", "originalCommit": "56935c039fb7635784bcc76c9d5320c01dc28f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NTEwNA==", "url": "https://github.com/apache/flink/pull/11394#discussion_r391885104", "bodyText": "There is no connection between this thread and the task thread. Interrupts on the task thread by Flink won't interrupt the fetcher thread. This change is sufficient to stop it.\nGenerally, it would be smart if Flink itself interrupted not the thread but the thread group of the Flink task. Since all spawned threads are by default in the parent thread group this would automatically interrupt all of them.", "author": "mxm", "createdAt": "2020-03-12T20:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1NTU4OQ=="}], "type": "inlineReview"}]}