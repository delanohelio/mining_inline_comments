{"pr_number": 14140, "pr_title": "[FLINK-19864][tests] Fix unpredictable Thread.getState in StreamTaskTestHarness due to concurrent class loading", "pr_createdAt": "2020-11-19T14:31:39Z", "pr_url": "https://github.com/apache/flink/pull/14140", "timeline": [{"oid": "b3576e24be6fa62e1a942c408897fdf034cbb30d", "url": "https://github.com/apache/flink/commit/b3576e24be6fa62e1a942c408897fdf034cbb30d", "message": "[FLINK-19864][tests] Fix unpredictable Thread.getState in StreamTaskTestHarness due to concurrent class loading", "committedDate": "2020-11-19T14:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0Njg0Nw==", "url": "https://github.com/apache/flink/pull/14140#discussion_r527746847", "bodyText": "I think isDefaultActionUnavailable() is not the best choice here because suspension is a temporary state; some input may come after this check.\nWhat about using mailboxProcessor.isMailboxLoopRunning() instead?\nIt is updated on InputStatus.END_OF_INPUT which seems exactly what is needed here.", "author": "rkhachatryan", "createdAt": "2020-11-20T14:56:39Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTestHarness.java", "diffHunk": "@@ -401,20 +401,36 @@ public void waitForInputProcessing() throws Exception {\n \t\t\t}\n \t\t}\n \n-\t\t// then wait for the Task Thread to be in a blocked state\n-\t\t// Check whether the state is blocked, this should be the case if it cannot\n-\t\t// notifyNonEmpty more input, i.e. all currently available input has been processed.\n-\t\twhile (true) {\n-\t\t\tThread.State state = taskThread.getState();\n-\t\t\tif (state == Thread.State.BLOCKED || state == Thread.State.TERMINATED ||\n-\t\t\t\t\tstate == Thread.State.WAITING || state == Thread.State.TIMED_WAITING) {\n+\t\t// Wait for all currently available input has been processed.\n+\t\tfinal AtomicBoolean allInputProcessed = new AtomicBoolean();\n+\t\tfinal MailboxProcessor mailboxProcessor = taskThread.task.mailboxProcessor;\n+\t\tfinal MailboxExecutor mailboxExecutor = mailboxProcessor.getMainMailboxExecutor();\n+\t\twhile (taskThread.isAlive()) {\n+\t\t\ttry {\n+\t\t\t\tfinal CountDownLatch latch = new CountDownLatch(1);\n+\t\t\t\tmailboxExecutor.execute(() -> {\n+\t\t\t\t\tallInputProcessed.set(mailboxProcessor.isDefaultActionUnavailable());", "originalCommit": "b3576e24be6fa62e1a942c408897fdf034cbb30d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc2Mzc2Mg==", "url": "https://github.com/apache/flink/pull/14140#discussion_r527763762", "bodyText": "It may made wrong name for allInputProcessed, it should express all current available input has been processed, not end of input. What StreamTaskTestHarness.waitForInputProcessing does is waiting current available input processed, so that following up testing code could do post-process assertion.", "author": "kezhuw", "createdAt": "2020-11-20T15:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0Njg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0ODA4OA==", "url": "https://github.com/apache/flink/pull/14140#discussion_r527748088", "bodyText": "With this await, is the sleep below still necessary?", "author": "rkhachatryan", "createdAt": "2020-11-20T14:58:32Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTestHarness.java", "diffHunk": "@@ -401,20 +401,36 @@ public void waitForInputProcessing() throws Exception {\n \t\t\t}\n \t\t}\n \n-\t\t// then wait for the Task Thread to be in a blocked state\n-\t\t// Check whether the state is blocked, this should be the case if it cannot\n-\t\t// notifyNonEmpty more input, i.e. all currently available input has been processed.\n-\t\twhile (true) {\n-\t\t\tThread.State state = taskThread.getState();\n-\t\t\tif (state == Thread.State.BLOCKED || state == Thread.State.TERMINATED ||\n-\t\t\t\t\tstate == Thread.State.WAITING || state == Thread.State.TIMED_WAITING) {\n+\t\t// Wait for all currently available input has been processed.\n+\t\tfinal AtomicBoolean allInputProcessed = new AtomicBoolean();\n+\t\tfinal MailboxProcessor mailboxProcessor = taskThread.task.mailboxProcessor;\n+\t\tfinal MailboxExecutor mailboxExecutor = mailboxProcessor.getMainMailboxExecutor();\n+\t\twhile (taskThread.isAlive()) {\n+\t\t\ttry {\n+\t\t\t\tfinal CountDownLatch latch = new CountDownLatch(1);\n+\t\t\t\tmailboxExecutor.execute(() -> {\n+\t\t\t\t\tallInputProcessed.set(mailboxProcessor.isDefaultActionUnavailable());\n+\t\t\t\t\tlatch.countDown();\n+\t\t\t\t}, \"query-whether-processInput-has-suspend-itself\");\n+\t\t\t\t// Mail could be dropped due to task exception, so we do timed-await here.\n+\t\t\t\tlatch.await(1, TimeUnit.SECONDS);", "originalCommit": "b3576e24be6fa62e1a942c408897fdf034cbb30d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc4MTA4OQ==", "url": "https://github.com/apache/flink/pull/14140#discussion_r527781089", "bodyText": "This await has two purposes here:\n\nWait until post mail has been processed, so we can query allInputProcessed safely.\nIf post mail has been dropped due to task exception, break out indefinite wait.\n\nIt does not serve as sleeping to yield control to mailbox thread. Without sleep, testing thread and mailbox thread may do ping-pong game between process-one-element and execute-one-mail.\nI tend to keep it, it does not affect correctness at least.", "author": "kezhuw", "createdAt": "2020-11-20T15:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0ODA4OA=="}], "type": "inlineReview"}]}