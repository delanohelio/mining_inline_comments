{"pr_number": 13648, "pr_title": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "pr_createdAt": "2020-10-15T10:19:00Z", "pr_url": "https://github.com/apache/flink/pull/13648", "timeline": [{"oid": "b0e37cb424abe4e95ebf7ba3f7e2943cf1bbcd6f", "url": "https://github.com/apache/flink/commit/b0e37cb424abe4e95ebf7ba3f7e2943cf1bbcd6f", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-16T10:14:24Z", "type": "forcePushed"}, {"oid": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "url": "https://github.com/apache/flink/commit/d259609d97fa73cd79b3dd400e2868f6be1c5e89", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-16T10:30:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0NTczMA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507745730", "bodyText": "Can you please explain why this partition type is bounded?", "author": "rkhachatryan", "createdAt": "2020-10-19T13:28:31Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartitionType.java", "diffHunk": "@@ -71,7 +71,17 @@\n \t * <p>For batch jobs, it will be best to keep this unlimited ({@link #PIPELINED}) since there are\n \t * no checkpoint barriers.\n \t */\n-\tPIPELINED_BOUNDED(true, true, true, false);\n+\tPIPELINED_BOUNDED(true, true, true, false),\n+\n+\t/**\n+\t * Pipelined partitions with a bounded (local) buffer pool to support downstream task to\n+\t * continue consuming data after reconnection in Approximate Local-Recovery.\n+\t *\n+\t * <p>Pipelined results can be consumed only once by a single consumer at one time.\n+\t * {@link #PIPELINED_APPROXIMATE} is different from {@link #PIPELINED_BOUNDED} in that\n+\t * {@link #PIPELINED_APPROXIMATE} is not decomposed automatically after consumption.\n+\t */\n+\tPIPELINED_APPROXIMATE(true, true, true, true);", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzA4Mw==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508193083", "bodyText": "It is similar to bounded in Pipelined_Bounded: use a fixed limit on the buffer pool size", "author": "curcur", "createdAt": "2020-10-20T03:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0NTczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0OTUwMA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507749500", "bodyText": "I think this message should mention that a new view is being created.", "author": "rkhachatryan", "createdAt": "2020-10-19T13:33:34Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1NTI4MA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507755280", "bodyText": "The writes in this method should be done under a lock, right?\nBut I'm not sure that all execution paths do acquire this lock.\nShould we add synchronized (buffers) or checkState(Thread.holdsLock)?", "author": "rkhachatryan", "createdAt": "2020-10-19T13:41:16Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",\n+\t\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\t\t\t\treleaseView();\n+\t\t\t}\n+\n+\t\t\tLOG.debug(\"{}: Creating read view for subpartition {} of partition {}.\",\n+\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\n+\t\t\treadView = new PipelinedApproximateSubpartitionView(this, availabilityListener);\n+\t\t}\n+\n+\t\treturn readView;\n+\t}\n+\n+\t@Override\n+\tBuffer buildSliceBuffer(BufferConsumerWithPartialRecordLength buffer) {\n+\t\tif (isPartialBuffer) {\n+\t\t\tisPartialBuffer = !buffer.cleanupPartialRecord();\n+\t\t}\n+\n+\t\treturn buffer.build();\n+\t}\n+\n+\tvoid releaseView() {\n+\t\tLOG.info(\"Releasing view of subpartition {} of {}.\", getSubPartitionIndex(), parent.getPartitionId());\n+\t\treadView = null;", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzM5NQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508193395", "bodyText": "The creation and release all go through the netty server thread, so I do not think it needs a lock.", "author": "curcur", "createdAt": "2020-10-20T03:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1NTI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0NTQ5Ng==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508345496", "bodyText": "Can't this thread change upon reconnection?\nWhat about isBlockedByCheckpoint? It's read by other threads.\nAnd even if it would be safe today, leaving this method without even a check seems dangerous in the future.", "author": "rkhachatryan", "createdAt": "2020-10-20T09:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1NTI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3NDg1Mg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508374852", "bodyText": "Yes, that's so true upon reconnection. Good catch!", "author": "curcur", "createdAt": "2020-10-20T10:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1NTI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE5MTAwNQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r509191005", "bodyText": "added the lock.\ntwo netty threads may require the same view to release.", "author": "curcur", "createdAt": "2020-10-21T11:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1NTI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1OTcxMw==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507759713", "bodyText": "I couldn't find any differences from super.toString other than class name.\nCan we just replace in super \"PipelinedSubpartition with getSiimpleClassName instead of overriding?\nditto: view", "author": "rkhachatryan", "createdAt": "2020-10-19T13:47:10Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",\n+\t\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\t\t\t\treleaseView();\n+\t\t\t}\n+\n+\t\t\tLOG.debug(\"{}: Creating read view for subpartition {} of partition {}.\",\n+\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\n+\t\t\treadView = new PipelinedApproximateSubpartitionView(this, availabilityListener);\n+\t\t}\n+\n+\t\treturn readView;\n+\t}\n+\n+\t@Override\n+\tBuffer buildSliceBuffer(BufferConsumerWithPartialRecordLength buffer) {\n+\t\tif (isPartialBuffer) {\n+\t\t\tisPartialBuffer = !buffer.cleanupPartialRecord();\n+\t\t}\n+\n+\t\treturn buffer.build();\n+\t}\n+\n+\tvoid releaseView() {\n+\t\tLOG.info(\"Releasing view of subpartition {} of {}.\", getSubPartitionIndex(), parent.getPartitionId());\n+\t\treadView = null;\n+\t\tisPartialBuffer = true;\n+\t\tisBlockedByCheckpoint = false;\n+\t\tsequenceNumber = 0;\n+\t}\n+\n+\t@Override\n+\tpublic String toString() {", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzU0MQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508193541", "bodyText": "That's a good suggestion!! Thanks!", "author": "curcur", "createdAt": "2020-10-20T03:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1OTcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NTc5NQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507785795", "bodyText": "I think this method is called not only upon downstream RPC, but also on task shutdown and other cases.\nIf so, completely skipping of super.releaseAllResources can lead to resource leaks in those cases.\nWDYT?", "author": "rkhachatryan", "createdAt": "2020-10-19T14:17:01Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartitionView.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * View over a pipelined in-memory only subpartition allowing reconnecting.\n+ */\n+public class PipelinedApproximateSubpartitionView extends PipelinedSubpartitionView {\n+\n+\tPipelinedApproximateSubpartitionView(PipelinedApproximateSubpartition parent, BufferAvailabilityListener listener) {\n+\t\tsuper(parent, listener);\n+\t}\n+\n+\t@Override\n+\tpublic void releaseAllResources() {", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNDQxMg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508234412", "bodyText": "That's a good question, I probably should add some description somewhere to explain this.\nFor view release, the PipelinedSubpartitionView#releaseAllResources (the original one) notifies its parent's parent (the result partition) that the corresponding subpartition has already been consumed (able to release). If all its subpartitions are released, the result partition is released.\nIn PipelinedApproximateSubpartitionView#releaseAllResources, we only set the readView to null; The partition is set tracked in JobMasterPartitionTrackerImpl#startTrackingPartition . The change would be included in the next diff (draft PR 7d31593), with the failover strategy change altogether.\nIn that case, the result partition would be released in case of the job exit.\nIn task failure case, the produced partition would be released by its corresponding RecordWriter.", "author": "curcur", "createdAt": "2020-10-20T06:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NTc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0ODcxNA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508348714", "bodyText": "Thanks for the explanation.\nCan you please elaborate on\n\nIn task failure case, the produced partition would be released by its corresponding RecordWriter.\n\nI don't see any calls from RecordWriter to release its targetPartition. Do you mean they will be added in the next diff too?", "author": "rkhachatryan", "createdAt": "2020-10-20T09:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NTc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQwNTkzMw==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508405933", "bodyText": "In Task#releaseResources\n                        if (isCanceledOrFailed()) {\n\t\t\t\tpartitionWriter.fail(getFailureCause());\n\t\t\t}", "author": "curcur", "createdAt": "2020-10-20T10:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NTc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNzAzMA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r509537030", "bodyText": "Got it, thanks.", "author": "rkhachatryan", "createdAt": "2020-10-21T18:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NTc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5MjcyNg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507792726", "bodyText": "I think there is no point in adding explicit requireNonNull just before dereferencing it.", "author": "rkhachatryan", "createdAt": "2020-10-19T14:25:28Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedSubpartition.java", "diffHunk": "@@ -259,9 +260,10 @@ BufferAndBacklog pollBuffer() {\n \t\t\t}\n \n \t\t\twhile (!buffers.isEmpty()) {\n-\t\t\t\tBufferConsumer bufferConsumer = buffers.peek().getBufferConsumer();\n+\t\t\t\tBufferConsumerWithPartialRecordLength bufferConsumerWithPartialRecordLength = buffers.peek();\n+\t\t\t\tBufferConsumer bufferConsumer = requireNonNull(bufferConsumerWithPartialRecordLength).getBufferConsumer();", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNTc2OQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508235769", "bodyText": "add here to avoid IDE check warning.", "author": "curcur", "createdAt": "2020-10-20T06:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5MjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1MzcxMw==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508353713", "bodyText": "I think this IDE warning doesn't make sense here so.\nI'd prefer to alter IDE behavior rather than code (e.g. by adding @SuppressWarnings(\"ConstantConditions\")).", "author": "rkhachatryan", "createdAt": "2020-10-20T09:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5MjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIxMzk2Nw==", "url": "https://github.com/apache/flink/pull/13648#discussion_r509213967", "bodyText": "I agree, let's just remove it.", "author": "curcur", "createdAt": "2020-10-21T11:52:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5MjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNjcwMA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r509536700", "bodyText": "Thanks!", "author": "rkhachatryan", "createdAt": "2020-10-21T18:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5MjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5Mzg0NQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507793845", "bodyText": "nit: super.buildSliceBuffer ?", "author": "rkhachatryan", "createdAt": "2020-10-19T14:26:42Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",\n+\t\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\t\t\t\treleaseView();\n+\t\t\t}\n+\n+\t\t\tLOG.debug(\"{}: Creating read view for subpartition {} of partition {}.\",\n+\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\n+\t\t\treadView = new PipelinedApproximateSubpartitionView(this, availabilityListener);\n+\t\t}\n+\n+\t\treturn readView;\n+\t}\n+\n+\t@Override\n+\tBuffer buildSliceBuffer(BufferConsumerWithPartialRecordLength buffer) {\n+\t\tif (isPartialBuffer) {\n+\t\t\tisPartialBuffer = !buffer.cleanupPartialRecord();\n+\t\t}\n+\n+\t\treturn buffer.build();", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNjU4MA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508236580", "bodyText": "the build() method is a normal build method that is used in the normal build as well.\nprobably just keep it as it is?", "author": "curcur", "createdAt": "2020-10-20T06:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5Mzg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgwMTI5Mg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507801292", "bodyText": "nit: I'd prefer this simple ternary if in a loop:\nfor (int i = 0; i < subpartitions.length; i++) {\n    subpartitions[i] = type == ResultPartitionType.PIPELINED_APPROXIMATE ?\n        new PipelinedApproximateSubpartition(i, pipelinedPartition) :\n        new PipelinedSubpartition(i, pipelinedPartition);\n}", "author": "rkhachatryan", "createdAt": "2020-10-19T14:33:06Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/ResultPartitionFactory.java", "diffHunk": "@@ -130,8 +132,15 @@ public ResultPartition create(\n \t\t\t\tbufferCompressor,\n \t\t\t\tbufferPoolFactory);\n \n+\t\t\tBiFunction<Integer, PipelinedResultPartition, PipelinedSubpartition> factory;\n+\t\t\tif (type == ResultPartitionType.PIPELINED_APPROXIMATE) {\n+\t\t\t\tfactory = PipelinedApproximateSubpartition::new;\n+\t\t\t} else {\n+\t\t\t\tfactory = PipelinedSubpartition::new;\n+\t\t\t}\n+", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0ODEwNg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508248106", "bodyText": "LOL, I've changed from this version -> the fancy version based on Arvid's suggestion.", "author": "curcur", "createdAt": "2020-10-20T06:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgwMTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxMjI4NQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507812285", "bodyText": "The name isPartialBuffer is a bit misleading to me because it implies that partial buffer was emitted.\nBut in fact, this field reflects that the view was released.\nHow about isPartialBufferCleanupRequired?", "author": "rkhachatryan", "createdAt": "2020-10-19T14:45:40Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",\n+\t\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\t\t\t\treleaseView();\n+\t\t\t}\n+\n+\t\t\tLOG.debug(\"{}: Creating read view for subpartition {} of partition {}.\",\n+\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\n+\t\t\treadView = new PipelinedApproximateSubpartitionView(this, availabilityListener);\n+\t\t}\n+\n+\t\treturn readView;\n+\t}\n+\n+\t@Override\n+\tBuffer buildSliceBuffer(BufferConsumerWithPartialRecordLength buffer) {\n+\t\tif (isPartialBuffer) {\n+\t\t\tisPartialBuffer = !buffer.cleanupPartialRecord();\n+\t\t}\n+\n+\t\treturn buffer.build();\n+\t}\n+\n+\tvoid releaseView() {\n+\t\tLOG.info(\"Releasing view of subpartition {} of {}.\", getSubPartitionIndex(), parent.getPartitionId());\n+\t\treadView = null;\n+\t\tisPartialBuffer = true;", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0OTIwOQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508249209", "bodyText": "That a good name!", "author": "curcur", "createdAt": "2020-10-20T06:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxMjI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjMwNg==", "url": "https://github.com/apache/flink/pull/13648#discussion_r507822306", "bodyText": "I'm concerned about a potential race condition here (even with synchronized added).\nConsider a case:\nThread1: call subpartition.createReadView() - create view1\nThread2: obtain a reference to view1\nThread1: call subpartition.createReadView() - create view2\nThread2: call view1.releaseAllResources <-- nulls out subpartition.readView; view2 is now corrupt?\nWDYT?", "author": "rkhachatryan", "createdAt": "2020-10-19T14:57:58Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBuffer = false;\n+\n+\tPipelinedApproximateSubpartition(int index, ResultPartition parent) {\n+\t\tsuper(index, parent);\n+\t}\n+\n+\t@Override\n+\tpublic PipelinedSubpartitionView createReadView(BufferAvailabilityListener availabilityListener) {\n+\t\tsynchronized (buffers) {\n+\t\t\tcheckState(!isReleased);\n+\n+\t\t\t// if the view is not released yet\n+\t\t\tif (readView != null) {\n+\t\t\t\tLOG.info(\"{} ReadView for Subpartition {} of {} has not been released!\",\n+\t\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\t\t\t\treleaseView();\n+\t\t\t}\n+\n+\t\t\tLOG.debug(\"{}: Creating read view for subpartition {} of partition {}.\",\n+\t\t\t\tparent.getOwningTaskName(), getSubPartitionIndex(), parent.getPartitionId());\n+\n+\t\t\treadView = new PipelinedApproximateSubpartitionView(this, availabilityListener);\n+\t\t}\n+\n+\t\treturn readView;\n+\t}\n+\n+\t@Override\n+\tBuffer buildSliceBuffer(BufferConsumerWithPartialRecordLength buffer) {\n+\t\tif (isPartialBuffer) {\n+\t\t\tisPartialBuffer = !buffer.cleanupPartialRecord();\n+\t\t}\n+\n+\t\treturn buffer.build();\n+\t}\n+\n+\tvoid releaseView() {\n+\t\tLOG.info(\"Releasing view of subpartition {} of {}.\", getSubPartitionIndex(), parent.getPartitionId());\n+\t\treadView = null;", "originalCommit": "d259609d97fa73cd79b3dd400e2868f6be1c5e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1MDEyOQ==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508250129", "bodyText": "creation and release happen in the same netty server thread.\na view can be released multiple times before creation. The release behavior is idempotent.", "author": "curcur", "createdAt": "2020-10-20T06:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MjU0Ng==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508372546", "bodyText": "Is it the same netty thread after reconnection? (same question as above)\nAnd from the call hierarchy, I see it's called not only from the netty thread.\nIn either case, I think here it's easier to avoid concurrency issues than to investigate whether they can happen.", "author": "rkhachatryan", "createdAt": "2020-10-20T10:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4MjI0MA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508382240", "bodyText": "Would this possibly happen?\n\nThread1: call subpartition.createReadView() - create view1\nThread2: obtain a reference to view1\n\nIt is not possible to access to view1 through a different thread, unless downstream reconnects, meaning either thread1 releases the view upon disconnecting from downstream or a different thread (thread2) reconnects and release the view; that would be guarded by the buffer lock as you suggested.\n\nThread1: call subpartition.createReadView() - create view2\nThread2: call view1.releaseAllResources <-- nulls out subpartition.readView; view2 is now corrupt?\n\nsame as above.", "author": "curcur", "createdAt": "2020-10-20T10:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQwNDE5MA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r508404190", "bodyText": "But I can think of a possible case that might have a problem:\nThread1: create view\nThread2: release view, create view\nThread1: release view (the release is way too slow)\nLet me think of this tonight. In the worst case, we can always release view before create a new one.", "author": "curcur", "createdAt": "2020-10-20T10:55:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjMwNg=="}], "type": "inlineReview"}, {"oid": "1dcce3b9301d178ae2e3ab05888260b05f24b15a", "url": "https://github.com/apache/flink/commit/1dcce3b9301d178ae2e3ab05888260b05f24b15a", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-21T11:55:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAwOTI1OA==", "url": "https://github.com/apache/flink/pull/13648#discussion_r510009258", "bodyText": "@GuardedBy(\"buffers\") ?", "author": "rkhachatryan", "createdAt": "2020-10-22T09:18:59Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/PipelinedApproximateSubpartition.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.io.network.partition;\n+\n+import org.apache.flink.annotation.VisibleForTesting;\n+import org.apache.flink.runtime.io.network.buffer.Buffer;\n+import org.apache.flink.runtime.io.network.buffer.BufferConsumerWithPartialRecordLength;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+\n+/**\n+ * A pipelined in-memory only subpartition, which allows to reconnecting after failure.\n+ * Only one view is allowed at a time to read teh subpartition.\n+ */\n+public class PipelinedApproximateSubpartition extends PipelinedSubpartition {\n+\n+\tprivate static final Logger LOG = LoggerFactory.getLogger(PipelinedApproximateSubpartition.class);\n+\n+\tprivate boolean isPartialBufferCleanupRequired = false;", "originalCommit": "1dcce3b9301d178ae2e3ab05888260b05f24b15a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3709faf9515053ca9873382f5b0ce83c127ff2d", "url": "https://github.com/apache/flink/commit/d3709faf9515053ca9873382f5b0ce83c127ff2d", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-23T07:45:50Z", "type": "forcePushed"}, {"oid": "ff9581bc2381e224c042f954bac0a7d8c371845a", "url": "https://github.com/apache/flink/commit/ff9581bc2381e224c042f954bac0a7d8c371845a", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-27T03:26:45Z", "type": "forcePushed"}, {"oid": "ccacf6664b0f6ec3630a939f8dd155f53226e4b7", "url": "https://github.com/apache/flink/commit/ccacf6664b0f6ec3630a939f8dd155f53226e4b7", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-27T08:17:45Z", "type": "forcePushed"}, {"oid": "c306ae3258d3e27f22abafe3db27eeb413467dac", "url": "https://github.com/apache/flink/commit/c306ae3258d3e27f22abafe3db27eeb413467dac", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-30T09:21:45Z", "type": "forcePushed"}, {"oid": "40c0741086cd9cadd88165d58f59c3e3d04b3deb", "url": "https://github.com/apache/flink/commit/40c0741086cd9cadd88165d58f59c3e3d04b3deb", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-10-30T14:16:37Z", "type": "forcePushed"}, {"oid": "0a8a44c098ddafaa6b849fdcb418bfda907298c9", "url": "https://github.com/apache/flink/commit/0a8a44c098ddafaa6b849fdcb418bfda907298c9", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-11-02T03:04:13Z", "type": "commit"}, {"oid": "0a8a44c098ddafaa6b849fdcb418bfda907298c9", "url": "https://github.com/apache/flink/commit/0a8a44c098ddafaa6b849fdcb418bfda907298c9", "message": "[FLINK-19632] Introduce a new ResultPartitionType for Approximate Local Recovery", "committedDate": "2020-11-02T03:04:13Z", "type": "forcePushed"}]}