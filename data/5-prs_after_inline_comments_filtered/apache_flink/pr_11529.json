{"pr_number": 11529, "pr_title": "[FLINK-16806][operators] Add support for InputSelection to MultipleInputStreamOperator", "pr_createdAt": "2020-03-26T12:22:04Z", "pr_url": "https://github.com/apache/flink/pull/11529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NTcyMA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398665720", "bodyText": "Could we avoid 1 & allSelectedMask here? It feels like it should only be relevant for ALL. We could then eagerly apply allSelectedMask instead of setting ALL (new InputSelection(-1 & allSelectedMask)).", "author": "AHeise", "createdAt": "2020-03-26T15:30:36Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/MultipleInputSelectionHandler.java", "diffHunk": "@@ -112,7 +112,7 @@ int selectNextInputIndex(int lastReadInputIndex) {\n \t}\n \n \tboolean shouldSetAvailableForAnotherInput() {\n-\t\treturn availableInputsMask != allSelectedMask && inputSelection.areAllInputsSelected();\n+\t\treturn (inputSelection.getInputMask() & allSelectedMask & ~availableInputsMask) != 0;", "originalCommit": "0a282902f953ebc916e1769e2670dafbc4a066c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3Nzk2MA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399277960", "bodyText": "What's the problem? I think performance wise it doesn't matter, the & allSelectedMask would still need to be there somewhere on the critical path.\nFrom logic perspective, I actually prefer keeping ALL as valid value for the this.inputSelection and doing the & allSelectedMask here, as those extra bits are not an issue in general, but only for this particular line of code (!= 0 comparison).", "author": "pnowojski", "createdAt": "2020-03-27T13:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNjkyNg==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399316926", "bodyText": "What's the problem? I think performance wise it doesn't matter, the & allSelectedMask would still need to be there somewhere on the critical path.\n\nThe point is that it would be moved out of the critical path. You only need to do it once in the ctor.", "author": "AHeise", "createdAt": "2020-03-27T14:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMjE5NA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399332194", "bodyText": "Unfortunately no. We would still need to do this action once per record around here:\norg.apache.flink.streaming.runtime.io.MultipleInputSelectionHandler#nextSelection\n\tvoid nextSelection() {\n\t\tif (inputSelector == null) {\n\t\t\tinputSelection = InputSelection.ALL;\n\t\t} else {\n\t\t\tinputSelection = inputSelector.nextSelection();\n\t\t}\n\t}\n\n? And I would doubt that saving one bit operation would be visible anywhere, while as I wrote logically I think it's clearer to have this operation here.", "author": "pnowojski", "createdAt": "2020-03-27T15:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NTcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg5Nw==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399339897", "bodyText": "Okay then keep as is.", "author": "AHeise", "createdAt": "2020-03-27T15:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjI5Mg==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398666292", "bodyText": "meta note: it's really confusing to have inputSelection, InputSelectable, and inputSelector. Could you try to consolidate that?", "author": "AHeise", "createdAt": "2020-03-26T15:31:21Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/MultipleInputSelectionHandler.java", "diffHunk": "@@ -112,7 +112,7 @@ int selectNextInputIndex(int lastReadInputIndex) {\n \t}\n \n \tboolean shouldSetAvailableForAnotherInput() {", "originalCommit": "0a282902f953ebc916e1769e2670dafbc4a066c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3NDU2Ng==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399274566", "bodyText": "Do you have some proposal? InputSelectable is an interface for users to implement, to provide the chosen InputSelection. That gives as inputSelector from our perspective. Now we are wrapping some input selection handling logic into classes like MultipleInputSelectionHandler. How would you suggest to change it?", "author": "pnowojski", "createdAt": "2020-03-27T13:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNzg2MQ==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399317861", "bodyText": "Can't we keep the name of InputSelectable inputSelectable? It's especially tricky to distinguish inputSelector and inputSelection (edit distance 2).", "author": "AHeise", "createdAt": "2020-03-27T14:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0MDUwMw==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399340503", "bodyText": "then please have the extra commit and I will check if readability improves for me. I also got your point, but I was really confused initially.", "author": "AHeise", "createdAt": "2020-03-27T15:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM0MjM2Mw==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399342363", "bodyText": "Ops sorry, I deleted my comment and replaced it with just a thumb up, as I changed my mind. I like the inputSelectable name for this field better :) (I've already pushed the commit)", "author": "pnowojski", "createdAt": "2020-03-27T15:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2NjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2Nzc4Mg==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398667782", "bodyText": "Add a check what happens on selectionHandler.setAvailableInput(2)?", "author": "AHeise", "createdAt": "2020-03-26T15:33:13Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/MultipleInputSelectionHandlerTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.runtime.io;\n+\n+import org.apache.flink.streaming.api.operators.InputSelection;\n+\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Tests for {@link MultipleInputSelectionHandler}.\n+ */\n+public class MultipleInputSelectionHandlerTest {\n+\t@Test\n+\tpublic void testShouldSetAvailableForAnotherInput() {\n+\t\tInputSelection secondAndThird = new InputSelection.Builder().select(2).select(3).build();\n+\n+\t\tMultipleInputSelectionHandler selectionHandler = new MultipleInputSelectionHandler(() -> secondAndThird, 3);\n+\t\tselectionHandler.nextSelection();\n+\n+\t\tassertFalse(selectionHandler.shouldSetAvailableForAnotherInput());\n+\n+\t\tselectionHandler.setUnavailableInput(0);\n+\t\tassertFalse(selectionHandler.shouldSetAvailableForAnotherInput());\n+\n+\t\tselectionHandler.setUnavailableInput(2);\n+\t\tassertTrue(selectionHandler.shouldSetAvailableForAnotherInput());\n+", "originalCommit": "0a282902f953ebc916e1769e2670dafbc4a066c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3ODQzNA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399278434", "bodyText": "It's available by default, so the previous check covering that.", "author": "pnowojski", "createdAt": "2020-03-27T13:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2Nzc4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxODI0NA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399318244", "bodyText": "I was more suggesting to test the state change to go back to default.", "author": "AHeise", "createdAt": "2020-03-27T14:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY2Nzc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3NDEwOA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398674108", "bodyText": "Kind of replicates the checks. Would it make sense to have a boolean processSingleStep, where we can just execute a while(processSingleStep()) ;?", "author": "AHeise", "createdAt": "2020-03-26T15:41:03Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskMailboxTestHarness.java", "diffHunk": "@@ -122,6 +122,12 @@ private void maybeProcess() throws Exception {\n \n \tpublic void process() throws Exception {\n \t\twhile (streamTask.inputProcessor.isAvailable() && streamTask.mailboxProcessor.isMailboxLoopRunning()) {\n+\t\t\tprocessSingleStep();", "originalCommit": "0b0e3c9589525ab0979b89ac206032ecb865ba3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3NTMyMg==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398675322", "bodyText": "Not a big fan of the name. How about testInputSelection?", "author": "AHeise", "createdAt": "2020-03-26T15:42:29Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskMultipleInputSelectiveReadingTest.java", "diffHunk": "@@ -0,0 +1,365 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.runtime.tasks;\n+\n+import org.apache.flink.api.common.typeinfo.BasicTypeInfo;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorV2;\n+import org.apache.flink.streaming.api.operators.BoundedMultiInput;\n+import org.apache.flink.streaming.api.operators.Input;\n+import org.apache.flink.streaming.api.operators.InputSelectable;\n+import org.apache.flink.streaming.api.operators.InputSelection;\n+import org.apache.flink.streaming.api.operators.MultipleInputStreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.StreamOperatorParameters;\n+import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator.ToStringInput;\n+import org.apache.flink.streaming.util.TestSequentialMultipleInputStreamOperator;\n+import org.apache.flink.util.ExceptionUtils;\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Queue;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Test selective reading.\n+ */\n+public class StreamTaskMultipleInputSelectiveReadingTest {\n+\n+\t@Test\n+\tpublic void testAnyOrderedReading() throws Exception {\n+\t\tArrayDeque<Object> expectedOutput = new ArrayDeque<>();\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 4\"));\n+\n+\t\ttestBase(new TestAnyModeMultipleInputStreamOperator.Factory(), false, expectedOutput, true);\n+\t}\n+\n+\t@Test\n+\tpublic void testAnyUnorderedReading() throws Exception {\n+\t\tArrayDeque<Object> expectedOutput = new ArrayDeque<>();\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 4\"));\n+\n+\t\ttestBase(new TestAnyModeMultipleInputStreamOperator.Factory(), true, expectedOutput, false);\n+\t}\n+\n+\t@Test\n+\tpublic void testSequentialReading() throws Exception {\n+\t\tArrayDeque<Object> expectedOutput = new ArrayDeque<>();\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 4\"));\n+\n+\t\ttestBase(new TestSequentialMultipleInputStreamOperator.Factory(), true, expectedOutput, true);\n+\t}\n+\n+\t@Test\n+\tpublic void testSpecialRuleReading() throws Exception {\n+\t\tArrayDeque<Object> expectedOutput = new ArrayDeque<>();\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 4\"));\n+\n+\t\ttestBase(new SpecialRuleReadingStreamOperatorFactory(3, 4, 2), true, expectedOutput, true);\n+\t}\n+\n+\t@Test\n+\tpublic void testReadFinishedInput() throws Exception {\n+\t\ttry {\n+\t\t\ttestBase(new TestReadFinishedInputStreamOperatorFactory(), true, new ArrayDeque<>(), true);\n+\t\t\tfail(\"should throw an IOException\");\n+\t\t} catch (Exception t) {\n+\t\t\tif (!ExceptionUtils.findThrowableWithMessage(t, \"Can not make a progress: all selected inputs are already finished\").isPresent()) {\n+\t\t\t\tthrow t;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate void testBase(", "originalCommit": "0b0e3c9589525ab0979b89ac206032ecb865ba3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3OTM1OQ==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398679359", "bodyText": "Tests are pretty hard to follow as input is separated from output. I don't have a good solution other than replicating that in each test. You could also extract the input sequence as a constant (array). In this way, it's immediately visible when looking at the test (from top to bottom).", "author": "AHeise", "createdAt": "2020-03-26T15:47:27Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskMultipleInputSelectiveReadingTest.java", "diffHunk": "@@ -0,0 +1,365 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.runtime.tasks;\n+\n+import org.apache.flink.api.common.typeinfo.BasicTypeInfo;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorV2;\n+import org.apache.flink.streaming.api.operators.BoundedMultiInput;\n+import org.apache.flink.streaming.api.operators.Input;\n+import org.apache.flink.streaming.api.operators.InputSelectable;\n+import org.apache.flink.streaming.api.operators.InputSelection;\n+import org.apache.flink.streaming.api.operators.MultipleInputStreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.StreamOperatorParameters;\n+import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator.ToStringInput;\n+import org.apache.flink.streaming.util.TestSequentialMultipleInputStreamOperator;\n+import org.apache.flink.util.ExceptionUtils;\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Queue;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Test selective reading.\n+ */\n+public class StreamTaskMultipleInputSelectiveReadingTest {\n+\n+\t@Test\n+\tpublic void testAnyOrderedReading() throws Exception {", "originalCommit": "0b0e3c9589525ab0979b89ac206032ecb865ba3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MjE2OA==", "url": "https://github.com/apache/flink/pull/11529#discussion_r398682168", "bodyText": "It's again not easy to see what all the operators are doing. Would it be possible to have a generic operator, where you pass a InputSelectable, such that it is defined at the same place as the expected output?", "author": "AHeise", "createdAt": "2020-03-26T15:51:04Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskMultipleInputSelectiveReadingTest.java", "diffHunk": "@@ -0,0 +1,365 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.runtime.tasks;\n+\n+import org.apache.flink.api.common.typeinfo.BasicTypeInfo;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.AbstractStreamOperatorV2;\n+import org.apache.flink.streaming.api.operators.BoundedMultiInput;\n+import org.apache.flink.streaming.api.operators.Input;\n+import org.apache.flink.streaming.api.operators.InputSelectable;\n+import org.apache.flink.streaming.api.operators.InputSelection;\n+import org.apache.flink.streaming.api.operators.MultipleInputStreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperator;\n+import org.apache.flink.streaming.api.operators.StreamOperatorFactory;\n+import org.apache.flink.streaming.api.operators.StreamOperatorParameters;\n+import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator;\n+import org.apache.flink.streaming.util.TestAnyModeMultipleInputStreamOperator.ToStringInput;\n+import org.apache.flink.streaming.util.TestSequentialMultipleInputStreamOperator;\n+import org.apache.flink.util.ExceptionUtils;\n+\n+import org.junit.Test;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Queue;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Test selective reading.\n+ */\n+public class StreamTaskMultipleInputSelectiveReadingTest {\n+\n+\t@Test\n+\tpublic void testAnyOrderedReading() throws Exception {\n+\t\tArrayDeque<Object> expectedOutput = new ArrayDeque<>();\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 1\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 2\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[1]: Hello-3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 3\"));\n+\t\texpectedOutput.add(new StreamRecord<>(\"[2]: 4\"));\n+\n+\t\ttestBase(new TestAnyModeMultipleInputStreamOperator.Factory(), false, expectedOutput, true);", "originalCommit": "0b0e3c9589525ab0979b89ac206032ecb865ba3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MzE5Nw==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399283197", "bodyText": "Hmmm, I think that would be quite difficult to abstract. I get your point, but I'm not sure if it's worth it. (especially take a look at the logic inside SpecialRuleReadingStreamOperatorFactory).", "author": "pnowojski", "createdAt": "2020-03-27T13:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxOTczMg==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399319732", "bodyText": "Yes the logic would be hard to generalize. It may be worth just to do it partially for the easy cases.", "author": "AHeise", "createdAt": "2020-03-27T14:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTcyNw==", "url": "https://github.com/apache/flink/pull/11529#discussion_r399339727", "bodyText": "But TestAnyModeMultipleInputStreamOperator is the only easy case that can be easily generalised. Unifying it with TestSequentialMultipleInputStreamOperator would basically require to pass the whole operator here, via the generalised factory. I really don't think it makes sense And generalising just TestAnyModeMultipleInputStreamOperator also doesn't make sense, as that would just add code complexity?", "author": "pnowojski", "createdAt": "2020-03-27T15:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyMDczMQ==", "url": "https://github.com/apache/flink/pull/11529#discussion_r400120731", "bodyText": "Okay keep as is.", "author": "AHeise", "createdAt": "2020-03-30T11:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MjE2OA=="}], "type": "inlineReview"}, {"oid": "cb7b925a52d73bbf7c42f0e888067effc32d74f3", "url": "https://github.com/apache/flink/commit/cb7b925a52d73bbf7c42f0e888067effc32d74f3", "message": "[FLINK-16806][operators] Add support for InputSelection to MultipleInputStreamOperator", "committedDate": "2020-03-27T13:59:21Z", "type": "forcePushed"}, {"oid": "6faa42e306101e36d337dd5118dabe7259698c87", "url": "https://github.com/apache/flink/commit/6faa42e306101e36d337dd5118dabe7259698c87", "message": "[FLINK-16806][operators] Add support for InputSelection to MultipleInputStreamOperator", "committedDate": "2020-03-27T14:07:36Z", "type": "forcePushed"}, {"oid": "38747a939a45f454bd7fbf92332f9e24c60a5518", "url": "https://github.com/apache/flink/commit/38747a939a45f454bd7fbf92332f9e24c60a5518", "message": "[FLINK-16806][operators] Fix shouldSetAvailableForAnotherInput for MultipleInputStreamOperator", "committedDate": "2020-03-27T15:11:36Z", "type": "commit"}, {"oid": "36ce5bdcc05be46d17026a4107f8a53c9bbb5ecf", "url": "https://github.com/apache/flink/commit/36ce5bdcc05be46d17026a4107f8a53c9bbb5ecf", "message": "[FLINK-16806][operators] Add support for InputSelection to MultipleInputStreamOperator", "committedDate": "2020-03-27T15:11:36Z", "type": "commit"}, {"oid": "88951a0650749d85c246e5a06d262178a7278a7a", "url": "https://github.com/apache/flink/commit/88951a0650749d85c246e5a06d262178a7278a7a", "message": "[hotfix][operators] Rename InputSelectable inputSelector field to inputSelectable", "committedDate": "2020-03-27T15:18:34Z", "type": "commit"}, {"oid": "88951a0650749d85c246e5a06d262178a7278a7a", "url": "https://github.com/apache/flink/commit/88951a0650749d85c246e5a06d262178a7278a7a", "message": "[hotfix][operators] Rename InputSelectable inputSelector field to inputSelectable", "committedDate": "2020-03-27T15:18:34Z", "type": "forcePushed"}]}