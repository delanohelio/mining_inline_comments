{"pr_number": 11334, "pr_title": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI", "pr_createdAt": "2020-03-06T15:53:04Z", "pr_url": "https://github.com/apache/flink/pull/11334", "timeline": [{"oid": "3872cefa8859725fa3f51e0e73698e5d1e086e3b", "url": "https://github.com/apache/flink/commit/3872cefa8859725fa3f51e0e73698e5d1e086e3b", "message": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI", "committedDate": "2020-03-06T15:48:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r388988489", "bodyText": "Looks like we can not use UTF-8 length too...", "author": "JingsongLi", "createdAt": "2020-03-06T16:01:09Z", "path": "flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/cli/CliTableauResultViewTest.java", "diffHunk": "@@ -167,8 +177,9 @@ public void testBatchResult() {\n \t\t\t\t\"|   false | -2147483648 |  9223372036854775807 |                     (NULL) |    12345.06789 |    2020-03-01 18:39:14.123 |\\n\" +\n \t\t\t\t\"|    true |         100 | -9223372036854775808 |                 abcdefg111 |         (NULL) | 2020-03-01 18:39:14.123456 |\\n\" +\n \t\t\t\t\"|  (NULL) |          -1 |                   -1 | abcdefghijklmnopqrstuvwxyz |   -12345.06789 |                     (NULL) |\\n\" +\n+\t\t\t\t\"|  (NULL) |          -1 |                   -1 |         \u8fd9\u662f\u4e00\u6bb5\u4e2d\u6587 |   -12345.06789 |      2020-03-04 18:39:14.0 |\\n\"\t+", "originalCommit": "3872cefa8859725fa3f51e0e73698e5d1e086e3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAwNzY0MQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389007641", "bodyText": "Hi, Jingsongli,\nHere's right,  the String  '         \u8fd9\u662f\u4e00\u6bb5\u4e2d\u6587 '  has same length with 'abcdefghijklmnopqrstuvwxyz' and shows well  when print in terminal.\nYou can see the final view if you using  sql-client .", "author": "leonardBang", "createdAt": "2020-03-06T16:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyMDc1Mg==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389220752", "bodyText": "You sure about this? It doesn't look right when I print out the string via System.out.println in IDE", "author": "KurtYoung", "createdAt": "2020-03-07T02:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyMjA0NQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389222045", "bodyText": "It also doesn't seem right when I executed this test in my terminal by command line.", "author": "KurtYoung", "createdAt": "2020-03-07T03:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyMjY3NQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389222675", "bodyText": "I think Jingsong is right, we can't use String.getBytes().length here. For example, the result of \"\u8fd9\u662f\u4e00\u6bb5\u4e2d\u6587\".getBytes().length() is 18, but if we want the display correct, it should be 12.", "author": "KurtYoung", "createdAt": "2020-03-07T03:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMjc1Mg==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389232752", "bodyText": "The problem is that UTF-8 char's display width is different with UTF-8 char's bytes length. \"\u8fd9\u662f\u4e00\u6bb5\u4e2d\u6587\".getBytes().length() will return 18 because length of Chinese char is 3 in UTF-8 unicode\uff0chere we can use GBK unicode which Chinese char's length is 2.\nBut GBK is not common enough than UTF-8.", "author": "leonardBang", "createdAt": "2020-03-07T06:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMjk5Mw==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389232993", "bodyText": "Using GBK works well with Chinese,\n\nmy concern is other language like Japanese/Korean have same problem.", "author": "leonardBang", "createdAt": "2020-03-07T06:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDM0Mg==", "url": "https://github.com/apache/flink/pull/11334#discussion_r389234342", "bodyText": "It seems this is a full width / half width character issue, but not necessarily an encoding problem.", "author": "KurtYoung", "createdAt": "2020-03-07T07:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4ODQ4OQ=="}], "type": "inlineReview"}, {"oid": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "url": "https://github.com/apache/flink/commit/dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "message": "[FLINK-16464][sql-client]result-mode tableau may shift when content contains Chinese String in SQL CLI", "committedDate": "2020-03-09T15:35:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NTQ5NA==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390075494", "bodyText": "use COLUMN_TRUNCATED_FLAG.length() instead?", "author": "KurtYoung", "createdAt": "2020-03-10T03:22:49Z", "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -60,9 +61,9 @@\n \tprivate static final int NULL_COLUMN_WIDTH = CliStrings.NULL_COLUMN.length();\n \tprivate static final int MAX_COLUMN_WIDTH = 30;\n \tprivate static final int DEFAULT_COLUMN_WIDTH = 20;\n+\tprivate static final int COLUMN_TRUNCATED_FLAG_WIDTH = 3;", "originalCommit": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjIwMg==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390076202", "bodyText": "int displayWidth = getStringDisplayWidth(col)  would be more clear and accurate", "author": "KurtYoung", "createdAt": "2020-03-10T03:25:59Z", "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -276,13 +277,13 @@ private void printSingleRow(int[] colWidths, String[] cols) {\n \t\tsb.append(\"|\");\n \t\tint idx = 0;\n \t\tfor (String col : cols) {\n-\t\t\tbyte[] colBytes = getUTF8Bytes(col);\n \t\t\tsb.append(\" \");\n-\t\t\tif (colBytes.length <= colWidths[idx]) {\n-\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colBytes.length));\n+\t\t\tint colWidth = getStringWidth(col);", "originalCommit": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjQzNA==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390076434", "bodyText": "getFixedString => truncateString?", "author": "KurtYoung", "createdAt": "2020-03-10T03:27:01Z", "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliTableauResultView.java", "diffHunk": "@@ -276,13 +277,13 @@ private void printSingleRow(int[] colWidths, String[] cols) {\n \t\tsb.append(\"|\");\n \t\tint idx = 0;\n \t\tfor (String col : cols) {\n-\t\t\tbyte[] colBytes = getUTF8Bytes(col);\n \t\t\tsb.append(\" \");\n-\t\t\tif (colBytes.length <= colWidths[idx]) {\n-\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colBytes.length));\n+\t\t\tint colWidth = getStringWidth(col);\n+\t\t\tif (colWidth <= colWidths[idx]) {\n+\t\t\t\tsb.append(StringUtils.repeat(' ', colWidths[idx] - colWidth));\n \t\t\t\tsb.append(col);\n \t\t\t} else {\n-\t\t\t\tsb.append(subMaxString(col, colWidths[idx]));\n+\t\t\t\tsb.append(getFixedString(col, colWidths[idx]));", "originalCommit": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTE5Mw==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079193", "bodyText": "and second parameter can be replaced with colWidths[idx] - COLUMN_TRUNCATED_FLAG_WIDTH as targetLength", "author": "KurtYoung", "createdAt": "2020-03-10T03:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3NjQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTM1OQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079359", "bodyText": "please add unit tests for both newly added methods.", "author": "KurtYoung", "createdAt": "2020-03-10T03:40:40Z", "path": "flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/cli/CliUtils.java", "diffHunk": "@@ -111,4 +113,33 @@ public static void normalizeColumn(AttributedStringBuilder sb, String col, int m\n \t\t}\n \t\treturn typesAsString;\n \t}\n+\n+\tpublic static int getStringWidth(String str) {", "originalCommit": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTQ0MA==", "url": "https://github.com/apache/flink/pull/11334#discussion_r390079440", "bodyText": "what's this?", "author": "KurtYoung", "createdAt": "2020-03-10T03:41:00Z", "path": "flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/cli/CliTableauResultViewTest.java", "diffHunk": "@@ -156,19 +176,21 @@ public void testBatchResult() {\n \n \t\tview.displayBatchResults();\n \t\tview.close();\n-\n+\t\t// note: about", "originalCommit": "dbef90ead12cfccbb50a04b1f59d809df9b7fc40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAzNDg4NQ==", "url": "https://github.com/apache/flink/pull/11334#discussion_r391034885", "bodyText": "unused note, I'll clear it.\nThanks for your review,  I\u2019ll address soon.", "author": "leonardBang", "createdAt": "2020-03-11T14:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA3OTQ0MA=="}], "type": "inlineReview"}, {"oid": "8aa3b784db3bdd4b0c5bc455c96cfa59092cbe6f", "url": "https://github.com/apache/flink/commit/8aa3b784db3bdd4b0c5bc455c96cfa59092cbe6f", "message": "address comment", "committedDate": "2020-03-11T15:53:53Z", "type": "commit"}, {"oid": "71e99474dc27f501c2c512e80761edd2057c00d0", "url": "https://github.com/apache/flink/commit/71e99474dc27f501c2c512e80761edd2057c00d0", "message": "add license and unit tests", "committedDate": "2020-03-12T02:45:09Z", "type": "commit"}, {"oid": "b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a", "url": "https://github.com/apache/flink/commit/b3dea1922d35f3a023fd1f70e8dfe5a13fb3f14a", "message": "revert pom header format", "committedDate": "2020-03-13T05:06:39Z", "type": "commit"}]}