{"pr_number": 11651, "pr_title": "[FLINK-16995][table-common] Add new data structure interfaces in table-common", "pr_createdAt": "2020-04-07T03:05:59Z", "pr_url": "https://github.com/apache/flink/pull/11651", "timeline": [{"oid": "dc4b0c541f7d5c8443f85c5f1fa37c22a10e26fb", "url": "https://github.com/apache/flink/commit/dc4b0c541f7d5c8443f85c5f1fa37c22a10e26fb", "message": "[FLINK-16995][table-common] Add new data structure interfaces in table-common", "committedDate": "2020-04-09T02:09:31Z", "type": "commit"}, {"oid": "8431a5ea4621539a6a45b741006ae9a9bffc3553", "url": "https://github.com/apache/flink/commit/8431a5ea4621539a6a45b741006ae9a9bffc3553", "message": "checkstyle", "committedDate": "2020-04-09T02:09:34Z", "type": "commit"}, {"oid": "d13c6fac2cb9688d3c8577744d7a3279cf805491", "url": "https://github.com/apache/flink/commit/d13c6fac2cb9688d3c8577744d7a3279cf805491", "message": "Add GenericArrayData, GenericMapData, GenericRowData", "committedDate": "2020-04-09T03:19:05Z", "type": "commit"}, {"oid": "d13c6fac2cb9688d3c8577744d7a3279cf805491", "url": "https://github.com/apache/flink/commit/d13c6fac2cb9688d3c8577744d7a3279cf805491", "message": "Add GenericArrayData, GenericMapData, GenericRowData", "committedDate": "2020-04-09T03:19:05Z", "type": "forcePushed"}, {"oid": "f24fe42d98e90e7419aaba8c250f44f6e855e6a5", "url": "https://github.com/apache/flink/commit/f24fe42d98e90e7419aaba8c250f44f6e855e6a5", "message": "Improve terminology and consistency of JavaDocs", "committedDate": "2020-04-10T10:10:06Z", "type": "commit"}, {"oid": "6123b4f30f049238128d277a864a02caa96d8f31", "url": "https://github.com/apache/flink/commit/6123b4f30f049238128d277a864a02caa96d8f31", "message": "remove \"This data structure is immutable\" from Javadoc of StringData", "committedDate": "2020-04-10T13:12:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0Nzc1OQ==", "url": "https://github.com/apache/flink/pull/11651#discussion_r406747759", "bodyText": "BinaryStringData is mutable, because it is lazy (de)serialized. The binary is lazily materialized when needed, so it's not thread-safe.", "author": "wuchong", "createdAt": "2020-04-10T13:03:17Z", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/StringData.java", "diffHunk": "@@ -23,43 +23,48 @@\n import org.apache.flink.table.types.logical.VarCharType;\n \n /**\n- * {@link StringData} is an internal data structure represents data of {@link VarCharType}\n- * and {@link CharType} in Flink Table/SQL.\n+ * An internal data structure representing data of {@link CharType} and {@link VarCharType}.\n+ *\n+ * <p>This data structure is immutable.", "originalCommit": "f24fe42d98e90e7419aaba8c250f44f6e855e6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAyMDQ2NQ==", "url": "https://github.com/apache/flink/pull/11651#discussion_r408020465", "bodyText": "@wuchong What I meant with immutable is that it does not provide any setters. Because GenericRowData has setters. But I'm fine with removing it here.", "author": "twalthr", "createdAt": "2020-04-14T10:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0Nzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2NjAwMA==", "url": "https://github.com/apache/flink/pull/11651#discussion_r411966000", "bodyText": "Hi @wuchong , this is a wrong implementation here. Can you take https://issues.apache.org/jira/browse/FLINK-16922 and fix that?", "author": "JingsongLi", "createdAt": "2020-04-21T08:06:39Z", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/data/DecimalData.java", "diffHunk": "@@ -0,0 +1,260 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.table.data;\n+\n+import org.apache.flink.annotation.PublicEvolving;\n+import org.apache.flink.table.types.logical.DecimalType;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.math.RoundingMode;\n+\n+import static org.apache.flink.util.Preconditions.checkArgument;\n+\n+/**\n+ * An internal data structure representing data of {@link DecimalType}.\n+ *\n+ * <p>This data structure is immutable and might store decimal values in a compact representation (as\n+ * a long value) if values are small enough.\n+ */\n+@PublicEvolving\n+public final class DecimalData implements Comparable<DecimalData> {\n+\n+\t// member fields and static fields are package-visible,\n+\t// in order to be accessible for DecimalDataUtils\n+\n+\tstatic final int MAX_COMPACT_PRECISION = 18;\n+\n+\t/**\n+\t * Maximum number of decimal digits an Int can represent. (1e9 < Int.MaxValue < 1e10)\n+\t */\n+\tstatic final int MAX_INT_DIGITS = 9;\n+\n+\t/**\n+\t * Maximum number of decimal digits a Long can represent. (1e18 < Long.MaxValue < 1e19)\n+\t */\n+\tstatic final int MAX_LONG_DIGITS = 18;\n+\n+\tstatic final long[] POW10 = new long[MAX_COMPACT_PRECISION + 1];\n+\n+\tstatic {\n+\t\tPOW10[0] = 1;\n+\t\tfor (int i = 1; i < POW10.length; i++) {\n+\t\t\tPOW10[i] = 10 * POW10[i - 1];\n+\t\t}\n+\t}\n+\n+\t// The semantics of the fields are as follows:\n+\t//  - `precision` and `scale` represent the precision and scale of SQL decimal type\n+\t//  - If `decimalVal` is set, it represents the whole decimal value\n+\t//  - Otherwise, the decimal value is longVal/(10^scale).\n+\t//\n+\t// Note that the (precision, scale) must be correct.\n+\t// if precision > MAX_COMPACT_PRECISION,\n+\t//   `decimalVal` represents the value. `longVal` is undefined\n+\t// otherwise, (longVal, scale) represents the value\n+\t//   `decimalVal` may be set and cached\n+\n+\tfinal int precision;\n+\tfinal int scale;\n+\n+\tfinal long longVal;\n+\tBigDecimal decimalVal;\n+\n+\t// this constructor does not perform any sanity check.\n+\tDecimalData(int precision, int scale, long longVal, BigDecimal decimalVal) {\n+\t\tthis.precision = precision;\n+\t\tthis.scale = scale;\n+\t\tthis.longVal = longVal;\n+\t\tthis.decimalVal = decimalVal;\n+\t}\n+\n+\t// ------------------------------------------------------------------------------------------\n+\t// Public Interfaces\n+\t// ------------------------------------------------------------------------------------------\n+\n+\t/**\n+\t * Returns the <i>precision</i> of this {@link DecimalData}.\n+\t *\n+\t * <p>The precision is the number of digits in the unscaled value.\n+\t */\n+\tpublic int precision() {\n+\t\treturn precision;\n+\t}\n+\n+\t/**\n+\t * Returns the <i>scale</i> of this {@link DecimalData}.\n+\t */\n+\tpublic int scale() {\n+\t\treturn scale;\n+\t}\n+\n+\t/**\n+\t * Converts this {@link DecimalData} into an instance of {@link BigDecimal}.\n+\t */\n+\tpublic BigDecimal toBigDecimal() {\n+\t\tBigDecimal bd = decimalVal;\n+\t\tif (bd == null) {\n+\t\t\tdecimalVal = bd = BigDecimal.valueOf(longVal, scale);\n+\t\t}\n+\t\treturn bd;\n+\t}\n+\n+\t/**\n+\t * Returns a long describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @throws ArithmeticException if this {@link DecimalData} does not exactly fit in a long.\n+\t */\n+\tpublic long toUnscaledLong() {\n+\t\tif (isCompact()) {\n+\t\t\treturn longVal;\n+\t\t} else {\n+\t\t\treturn toBigDecimal().unscaledValue().longValueExact();\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Returns a byte array describing the <i>unscaled value</i> of this {@link DecimalData}.\n+\t *\n+\t * @return the unscaled byte array of this {@link DecimalData}.\n+\t */\n+\tpublic byte[] toUnscaledBytes() {\n+\t\tif (!isCompact()) {\n+\t\t\treturn toBigDecimal().unscaledValue().toByteArray();\n+\t\t}\n+\n+\t\t// big endian; consistent with BigInteger.toByteArray()\n+\t\tbyte[] bytes = new byte[8];", "originalCommit": "6123b4f30f049238128d277a864a02caa96d8f31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4MjkwNw==", "url": "https://github.com/apache/flink/pull/11651#discussion_r411982907", "bodyText": "OK. Will do that in FLINK-16996.", "author": "wuchong", "createdAt": "2020-04-21T08:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2NjAwMA=="}], "type": "inlineReview"}]}