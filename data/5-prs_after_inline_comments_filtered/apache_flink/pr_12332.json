{"pr_number": 12332, "pr_title": "[FLINK-17820][task][checkpointing] Respect fileSizeThreshold in FsCheckpointStateOutputStream.flush()", "pr_createdAt": "2020-05-26T06:56:46Z", "pr_url": "https://github.com/apache/flink/pull/12332", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTcwMg==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430231702", "bodyText": "Maybe extend this to if (stream != null || pos > localStateThreshold)?", "author": "StephanEwen", "createdAt": "2020-05-26T08:10:03Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/state/filesystem/FsCheckpointStreamFactory.java", "diffHunk": "@@ -266,6 +264,16 @@ public void flush() throws IOException {\n \t\t\t}\n \t\t}\n \n+\t\t/**\n+\t\t * Flush buffers to file if their size is above {@link #localStateThreshold}.\n+\t\t */\n+\t\t@Override\n+\t\tpublic void flush() throws IOException {\n+\t\t\tif (pos > localStateThreshold) {", "originalCommit": "bdc25159e69734b32bf88f72c6224dee235c1ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MzEzNA==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430263134", "bodyText": "Makes sense, expanded the condition.", "author": "rkhachatryan", "createdAt": "2020-05-26T09:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUxNzcxMQ==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430517711", "bodyText": "I guess the added condition of stream != null is not addressed yet?", "author": "zhijiangW", "createdAt": "2020-05-26T15:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU2OTA1Mw==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430569053", "bodyText": "I must have reverted it while updating the tests. Fixed.", "author": "rkhachatryan", "createdAt": "2020-05-26T17:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTc3MQ==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430231771", "bodyText": "We can make this public, let the tests call it directly.", "author": "StephanEwen", "createdAt": "2020-05-26T08:10:09Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/state/filesystem/FsCheckpointStreamFactory.java", "diffHunk": "@@ -247,15 +247,13 @@ public long getPos() throws IOException {\n \t\t\treturn pos + (outStream == null ? 0 : outStream.getPos());\n \t\t}\n \n-\t\t@Override\n-\t\tpublic void flush() throws IOException {\n+\t\tprivate void flushToFile() throws IOException {", "originalCommit": "bdc25159e69734b32bf88f72c6224dee235c1ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MzI2OQ==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430263269", "bodyText": "Done.", "author": "rkhachatryan", "createdAt": "2020-05-26T09:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzMTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzNDA5MA==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430234090", "bodyText": "If we type the exclusiveStream to FsCheckpointStateOutputStream, we could call flushToFile() directly.\nThen we don't implicitly rely on the threshold logic here as well.", "author": "StephanEwen", "createdAt": "2020-05-26T08:14:21Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/state/filesystem/FsCheckpointStorageTest.java", "diffHunk": "@@ -165,8 +165,7 @@ public void testDirectoriesForExclusiveAndSharedState() throws Exception {\n \t\tCheckpointStateOutputStream exclusiveStream =\n \t\t\t\tstorageLocation.createCheckpointStateOutputStream(CheckpointedStateScope.EXCLUSIVE);\n \n-\t\texclusiveStream.write(42);\n-\t\texclusiveStream.flush();", "originalCommit": "bdc25159e69734b32bf88f72c6224dee235c1ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MzU0OA==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430263548", "bodyText": "Good point!", "author": "rkhachatryan", "createdAt": "2020-05-26T09:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzNDA5MA=="}], "type": "inlineReview"}, {"oid": "c574198c34562970cc0939c57f750c6bac3530d5", "url": "https://github.com/apache/flink/commit/c574198c34562970cc0939c57f750c6bac3530d5", "message": "[FLINK-17820][task][checkpointing] Respect fileSizeThreshold in FsCheckpointStateOutputStream.flush()", "committedDate": "2020-05-26T08:50:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUxODM1MQ==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430518351", "bodyText": "nit: unnecessary formatting changes, I guess it was done automatically by IDE.", "author": "zhijiangW", "createdAt": "2020-05-26T15:48:33Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriterTest.java", "diffHunk": "@@ -95,12 +118,12 @@ public void flush() throws IOException {\n \n \t\tFlushRecorder dataStream = new FlushRecorder();\n \t\tfinal ChannelStateCheckpointWriter writer = new ChannelStateCheckpointWriter(\n-\t\t\t1L,\n-\t\t\tnew ChannelStateWriteResult(),\n-\t\t\tnew ChannelStateSerializerImpl(),\n-\t\t\tNO_OP_RUNNABLE,\n-\t\t\tnew MemoryCheckpointOutputStream(42),\n-\t\t\tdataStream\n+\t\t\t\t1L,", "originalCommit": "c574198c34562970cc0939c57f750c6bac3530d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU3MDQzNQ==", "url": "https://github.com/apache/flink/pull/12332#discussion_r430570435", "bodyText": "Yes, accidental change, reverted it.", "author": "rkhachatryan", "createdAt": "2020-05-26T17:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUxODM1MQ=="}], "type": "inlineReview"}, {"oid": "43ae9ff3a5df4e71d52b87c63beebbbad9967277", "url": "https://github.com/apache/flink/commit/43ae9ff3a5df4e71d52b87c63beebbbad9967277", "message": "[FLINK-17820][task][checkpointing] Respect fileSizeThreshold in FsCheckpointStateOutputStream.flush()", "committedDate": "2020-05-26T16:53:57Z", "type": "forcePushed"}, {"oid": "f08cd17559f206395e11f2a2e7f3dae093941f1d", "url": "https://github.com/apache/flink/commit/f08cd17559f206395e11f2a2e7f3dae093941f1d", "message": "[FLINK-17820][task][checkpointing] Respect fileSizeThreshold in FsCheckpointStateOutputStream.flush()", "committedDate": "2020-05-26T17:03:18Z", "type": "commit"}, {"oid": "f08cd17559f206395e11f2a2e7f3dae093941f1d", "url": "https://github.com/apache/flink/commit/f08cd17559f206395e11f2a2e7f3dae093941f1d", "message": "[FLINK-17820][task][checkpointing] Respect fileSizeThreshold in FsCheckpointStateOutputStream.flush()", "committedDate": "2020-05-26T17:03:18Z", "type": "forcePushed"}]}