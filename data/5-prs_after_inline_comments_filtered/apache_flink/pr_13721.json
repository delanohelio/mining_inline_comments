{"pr_number": 13721, "pr_title": "[FLINK-19694][table] Support Upsert ChangelogMode for ScanTableSource", "pr_createdAt": "2020-10-21T10:25:04Z", "pr_url": "https://github.com/apache/flink/pull/13721", "timeline": [{"oid": "fa0c87c737cee61fe6fd5b6655916eb97d18aaeb", "url": "https://github.com/apache/flink/commit/fa0c87c737cee61fe6fd5b6655916eb97d18aaeb", "message": "[FLINK-19694][table-runtime-blink] Support upsert ChangelogMode for ScanTableSource in runtime", "committedDate": "2020-10-22T04:18:07Z", "type": "forcePushed"}, {"oid": "d5e77b25de2f0446255b6faca7ed17afc438143c", "url": "https://github.com/apache/flink/commit/d5e77b25de2f0446255b6faca7ed17afc438143c", "message": "[FLINK-19694][table-runtime-blink] Support upsert ChangelogMode for ScanTableSource in runtime", "committedDate": "2020-10-22T09:30:25Z", "type": "forcePushed"}, {"oid": "b03cd2b69573ff31561807574f0d9d9f2af803b3", "url": "https://github.com/apache/flink/commit/b03cd2b69573ff31561807574f0d9d9f2af803b3", "message": "[FLINK-19694][table-runtime-blink] Support upsert ChangelogMode for ScanTableSource in runtime", "committedDate": "2020-10-23T08:38:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTYwNjk5NA==", "url": "https://github.com/apache/flink/pull/13721#discussion_r511606994", "bodyText": "which contains only UPDATE_AFTER, no UPDATE_BEFORE. ?", "author": "godfreyhe", "createdAt": "2020-10-25T14:52:08Z", "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/sources/DynamicSourceUtils.java", "diffHunk": "@@ -241,30 +241,31 @@ private static void validateScanSource(\n \t\tvalidateWatermarks(sourceIdentifier, schema);\n \n \t\tif (isStreamingMode) {\n-\t\t\tvalidateScanSourceForStreaming(sourceIdentifier, scanSource, changelogMode);\n+\t\t\tvalidateScanSourceForStreaming(sourceIdentifier, schema, scanSource, changelogMode);\n \t\t} else {\n \t\t\tvalidateScanSourceForBatch(sourceIdentifier, changelogMode, provider);\n \t\t}\n \t}\n \n \tprivate static void validateScanSourceForStreaming(\n \t\t\tObjectIdentifier sourceIdentifier,\n+\t\t\tTableSchema schema,\n \t\t\tScanTableSource scanSource,\n \t\t\tChangelogMode changelogMode) {\n \t\t// sanity check for produced ChangelogMode\n \t\tfinal boolean hasUpdateBefore = changelogMode.contains(RowKind.UPDATE_BEFORE);\n \t\tfinal boolean hasUpdateAfter = changelogMode.contains(RowKind.UPDATE_AFTER);\n \t\tif (!hasUpdateBefore && hasUpdateAfter) {\n \t\t\t// only UPDATE_AFTER\n-\t\t\tthrow new TableException(\n-\t\t\t\tString.format(\n-\t\t\t\t\t\"Unsupported source for table '%s'. Currently, a %s doesn't support a changelog which contains \" +\n-\t\t\t\t\t\t\"UPDATE_AFTER but no UPDATE_BEFORE. Please adapt the implementation of class '%s'.\",\n-\t\t\t\t\tsourceIdentifier.asSummaryString(),\n-\t\t\t\t\tScanTableSource.class.getSimpleName(),\n-\t\t\t\t\tscanSource.getClass().getName()\n-\t\t\t\t)\n-\t\t\t);\n+\t\t\tif (!schema.getPrimaryKey().isPresent()) {\n+\t\t\t\tthrow new TableException(\n+\t\t\t\t\tString.format(\n+\t\t\t\t\t\t\"Table '%s' produces a changelog stream contains UPDATE_AFTER no UPDATE_BEFORE, \" +", "originalCommit": "b03cd2b69573ff31561807574f0d9d9f2af803b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d2af46d1620a18ed438413e5288030e3725bb5e", "url": "https://github.com/apache/flink/commit/1d2af46d1620a18ed438413e5288030e3725bb5e", "message": "[FLINK-19694][table-planner-blink] Support upsert ChangelogMode for ScanTableSource in planner\n\nThis closes #13721", "committedDate": "2020-10-27T09:36:07Z", "type": "commit"}, {"oid": "f5eb931dc909e8585dc8326c42852ca0c9d77037", "url": "https://github.com/apache/flink/commit/f5eb931dc909e8585dc8326c42852ca0c9d77037", "message": "[FLINK-19694][table-planner-blink] Update MetadataHandlers for the new introduced StreamExecUpsertMaterialize node\n\nThis closes #13721", "committedDate": "2020-10-27T09:36:23Z", "type": "commit"}, {"oid": "5ee687b03b2e9cbc2369055ea935f54e8c38b9ed", "url": "https://github.com/apache/flink/commit/5ee687b03b2e9cbc2369055ea935f54e8c38b9ed", "message": "[FLINK-19694][table-runtime-blink] Support upsert ChangelogMode for ScanTableSource in runtime\n\nThis closes #13721", "committedDate": "2020-10-27T09:36:39Z", "type": "commit"}, {"oid": "5ee687b03b2e9cbc2369055ea935f54e8c38b9ed", "url": "https://github.com/apache/flink/commit/5ee687b03b2e9cbc2369055ea935f54e8c38b9ed", "message": "[FLINK-19694][table-runtime-blink] Support upsert ChangelogMode for ScanTableSource in runtime\n\nThis closes #13721", "committedDate": "2020-10-27T09:36:39Z", "type": "forcePushed"}]}