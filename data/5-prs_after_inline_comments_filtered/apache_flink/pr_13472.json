{"pr_number": 13472, "pr_title": "[FLINK-19291][Formats] Fix `SchemaParseException` when use `AvroSchemaConverter` converts flink logical type ", "pr_createdAt": "2020-09-24T07:13:26Z", "pr_url": "https://github.com/apache/flink/pull/13472", "timeline": [{"oid": "3e70b29f47767a4221cc15888d469e1e9d90d22e", "url": "https://github.com/apache/flink/commit/3e70b29f47767a4221cc15888d469e1e9d90d22e", "message": "[FLINK-19291][Formats] Fix `SchemaParseException` caused by the `rowTypeCounter` may be duplicate when there are multiple row types", "committedDate": "2020-09-23T11:42:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDc4NA==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502180784", "bodyText": "I think this will conflict if a field name is \"row_0\".", "author": "wuchong", "createdAt": "2020-10-09T04:18:51Z", "path": "flink-formats/flink-avro/src/main/java/org/apache/flink/formats/avro/typeutils/AvroSchemaConverter.java", "diffHunk": "@@ -297,10 +297,10 @@ private static DataType convertToDataType(Schema schema) {\n \t * @return Avro's {@link Schema} matching this logical type.\n \t */\n \tpublic static Schema convertToSchema(LogicalType logicalType) {\n-\t\treturn convertToSchema(logicalType, 0);\n+\t\treturn convertToSchema(logicalType, \"row_0\");", "originalCommit": "3e70b29f47767a4221cc15888d469e1e9d90d22e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2NDQ5Nw==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502364497", "bodyText": "Yeah, I think we can use \"row_\" append the current timestamp as default row name. Do you have any good idea?", "author": "V1ncentzzZ", "createdAt": "2020-10-09T11:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDk3NA==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502180974", "bodyText": "I think this doesn't work. Because field names may conflict. We may need to concat the parent row name and the field name as the child name.", "author": "wuchong", "createdAt": "2020-10-09T04:19:28Z", "path": "flink-formats/flink-avro/src/main/java/org/apache/flink/formats/avro/typeutils/AvroSchemaConverter.java", "diffHunk": "@@ -359,13 +359,13 @@ public static Schema convertToSchema(LogicalType logicalType, int rowTypeCounter\n \t\t\t\t// we have to make sure the record name is different in a Schema\n \t\t\t\tSchemaBuilder.FieldAssembler<Schema> builder = SchemaBuilder\n \t\t\t\t\t.builder()\n-\t\t\t\t\t.record(\"row_\" + rowTypeCounter)\n+\t\t\t\t\t.record(rowName)\n \t\t\t\t\t.fields();\n-\t\t\t\trowTypeCounter++;\n \t\t\t\tfor (int i = 0; i < rowType.getFieldCount(); i++) {\n+\t\t\t\t\tString fieldName = fieldNames.get(i);\n \t\t\t\t\tbuilder = builder\n-\t\t\t\t\t\t.name(fieldNames.get(i))\n-\t\t\t\t\t\t.type(convertToSchema(rowType.getTypeAt(i), rowTypeCounter))\n+\t\t\t\t\t\t.name(fieldName)\n+\t\t\t\t\t\t.type(convertToSchema(rowType.getTypeAt(i), fieldName))", "originalCommit": "3e70b29f47767a4221cc15888d469e1e9d90d22e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2NDgxNw==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502364817", "bodyText": "It works fine after test when the same field name in each different row type. Because fields in different namespaces.", "author": "V1ncentzzZ", "createdAt": "2020-10-09T11:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczNDY0Ng==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502734646", "bodyText": "However, if the parant field name is the same to the child name, there still will be an avro exception. For example, the following example is still failed:\n\t@Test\n\tpublic void test() {\n\t\tRowType rowType = (RowType) TableSchema.builder()\n\t\t\t.field(\"row1\", DataTypes.ROW(DataTypes.FIELD(\"a\", DataTypes.STRING())))\n\t\t\t.field(\"row2\", DataTypes.ROW(DataTypes.FIELD(\"b\", DataTypes.STRING())))\n\t\t\t.field(\"row3\", DataTypes.ROW(\n\t\t\t\tDataTypes.FIELD(\"row3\", DataTypes.ROW(DataTypes.FIELD(\"c\", DataTypes.STRING())))))\n\t\t\t.build().toRowDataType().getLogicalType();\n\t\tSchema schema = AvroSchemaConverter.convertToSchema(rowType);\n\t\tSystem.out.println(schema.toString(true));\n\t}\nThis can be fixed by concating parant and child name:\nString fieldName = rowName + \"_\" + fieldNames.get(i);", "author": "wuchong", "createdAt": "2020-10-10T02:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczODM2OA==", "url": "https://github.com/apache/flink/pull/13472#discussion_r502738368", "bodyText": "Okay, I will be update code to fix this problem by concating parant and child name. At the same time, i will update the test case also. Thanks!", "author": "V1ncentzzZ", "createdAt": "2020-10-10T03:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE4MDk3NA=="}], "type": "inlineReview"}, {"oid": "673132483e8def970c4e4ea44da5a761978a8106", "url": "https://github.com/apache/flink/commit/673132483e8def970c4e4ea44da5a761978a8106", "message": "[FLINK-19291][Formats] Updating test case to reproduce the problem.", "committedDate": "2020-10-10T02:52:59Z", "type": "commit"}, {"oid": "8f81fd9dbee3210951156366f041d45dae4301ed", "url": "https://github.com/apache/flink/commit/8f81fd9dbee3210951156366f041d45dae4301ed", "message": "[FLINK-19291][Formats] hot fix for code formats", "committedDate": "2020-10-10T03:00:04Z", "type": "commit"}, {"oid": "27a70ae047774c0474519bea4f7a95a25d40c371", "url": "https://github.com/apache/flink/commit/27a70ae047774c0474519bea4f7a95a25d40c371", "message": "[FLINK-19291][Formats] Updating test case and concat parent and child name as row name to fix this problem and set \"row_\" append current time millis as default row name", "committedDate": "2020-10-10T03:27:58Z", "type": "commit"}, {"oid": "a8b88bc4d52ac3d0aa6fe7a5681bd80a18501934", "url": "https://github.com/apache/flink/commit/a8b88bc4d52ac3d0aa6fe7a5681bd80a18501934", "message": "[FLINK-19291][Formats] Use \"record\" as top name and optimization test case", "committedDate": "2020-10-10T06:08:58Z", "type": "commit"}]}