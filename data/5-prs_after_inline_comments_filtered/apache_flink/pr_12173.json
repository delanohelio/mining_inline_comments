{"pr_number": 12173, "pr_title": "[FLINK-17727][task] don't create output stream with no channel state (unaligned checkpoints)", "pr_createdAt": "2020-05-15T13:11:25Z", "pr_url": "https://github.com/apache/flink/pull/12173", "timeline": [{"oid": "e6f16890240fdff4f06971effb2ebfec3a81d578", "url": "https://github.com/apache/flink/commit/e6f16890240fdff4f06971effb2ebfec3a81d578", "message": "[FLINK-17727][task] don't create output stream with no channel state (unaligned checkpoints)", "committedDate": "2020-05-15T12:49:51Z", "type": "commit"}, {"oid": "a05709a1296e952aa3ed65c92957fc039bd90fc0", "url": "https://github.com/apache/flink/commit/a05709a1296e952aa3ed65c92957fc039bd90fc0", "message": "[FLINK-17727][e2e] Re-enable \"[FLINK-17467][task][e2e] Modify existing upgrade test to verify aligned savepoints\" after a fix\n\nThis reverts commit 3af17562eb791e3f486c38dbd94dc3328309b262.", "committedDate": "2020-05-15T12:51:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0OTIxNg==", "url": "https://github.com/apache/flink/pull/12173#discussion_r425849216", "bodyText": "Don't we have to clean up/remove some empty file? I guess in this branch, dataStream will be empty and we have already created some file for it? In other words, won't this code leave a lingering empty files somewhere?", "author": "pnowojski", "createdAt": "2020-05-15T14:42:12Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/channel/ChannelStateCheckpointWriter.java", "diffHunk": "@@ -150,6 +151,12 @@ private void complete(boolean precondition, RunnableWithException complete) thro\n \t}\n \n \tprivate void finishWriteAndResult() throws IOException {\n+\t\tif (inputChannelOffsets.isEmpty() && resultSubpartitionOffsets.isEmpty()) {\n+\t\t\tdataStream.close();\n+\t\t\tresult.inputChannelStateHandles.complete(emptyList());\n+\t\t\tresult.resultSubpartitionStateHandles.complete(emptyList());\n+\t\t\treturn;\n+\t\t}", "originalCommit": "e6f16890240fdff4f06971effb2ebfec3a81d578", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1MTcxMg==", "url": "https://github.com/apache/flink/pull/12173#discussion_r425851712", "bodyText": "No, this is the contract of CheckpointStateOutputStream: closeAndGetHandle persists the data, while close removes the file.", "author": "rkhachatryan", "createdAt": "2020-05-15T14:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0OTIxNg=="}], "type": "inlineReview"}]}