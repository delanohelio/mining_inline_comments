{"pr_number": 13180, "pr_title": "[FLINK-18962][checkpointing] Improve logging when checkpoint declined", "pr_createdAt": "2020-08-17T16:22:01Z", "pr_url": "https://github.com/apache/flink/pull/13180", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MTUxNg==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472141516", "bodyText": "Isn't this is missing a pattern/format change? Also how would you like it to be logged? Just the message.getReason().toString()? Do we care about the stack trace?", "author": "pnowojski", "createdAt": "2020-08-18T12:32:16Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java", "diffHunk": "@@ -887,7 +887,8 @@ public void receiveDeclineMessage(DeclineCheckpoint message, String taskManagerL\n \t\t\t\t\tcheckpointId,\n \t\t\t\t\tmessage.getTaskExecutionId(),\n \t\t\t\t\tjob,\n-\t\t\t\t\ttaskManagerLocationInfo);\n+\t\t\t\t\ttaskManagerLocationInfo,\n+\t\t\t\t\tmessage.getReason());", "originalCommit": "b823669c9164f5a6d12f2fa4f42621958a1bdcc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIxMjczMw==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472212733", "bodyText": "No, this is a vararg, and the last argument is interpreted as Throwable.\nThe stacktrace is printed as I showed in the description.", "author": "rkhachatryan", "createdAt": "2020-08-18T13:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MTUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzNDQwMA==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472234400", "bodyText": "Good to know, I was not aware of that.", "author": "pnowojski", "createdAt": "2020-08-18T14:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MTUxNg=="}], "type": "inlineReview"}, {"oid": "0bcfb80835ebec1a8e4bd240515852a240631e83", "url": "https://github.com/apache/flink/commit/0bcfb80835ebec1a8e4bd240515852a240631e83", "message": "[FLINK-18962][checkpointing][task] Change log level from DEBUG fto INFO or async part errors\n\nNOTE: code change causes CancellationException to be logged at INFO level.\nTo prevent this from failing e2e tests, CancellationException is ignored in e2e error parsing script.", "committedDate": "2020-08-18T14:28:09Z", "type": "commit"}, {"oid": "64786549e36be42acbdfb4f63b071f9ded615ad9", "url": "https://github.com/apache/flink/commit/64786549e36be42acbdfb4f63b071f9ded615ad9", "message": "[FLINK-18962][checkpointing] Log checkpoint decline reason", "committedDate": "2020-08-18T14:30:24Z", "type": "commit"}, {"oid": "4aea992b6d30869cc742525b56225e3bcead1439", "url": "https://github.com/apache/flink/commit/4aea992b6d30869cc742525b56225e3bcead1439", "message": "[hotfix][tests] e2e/common.sh: add -type parameter to find\n\nThis prevents \"Is a directory\" error when running \"head\":\nChecking for exceptions...\nFound exception in log files; printing first 500 lines; see full logs for details:\nhead: error reading '/home/vsts/work/1/s/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/log/': Is a directory", "committedDate": "2020-08-18T14:30:24Z", "type": "commit"}, {"oid": "4aea992b6d30869cc742525b56225e3bcead1439", "url": "https://github.com/apache/flink/commit/4aea992b6d30869cc742525b56225e3bcead1439", "message": "[hotfix][tests] e2e/common.sh: add -type parameter to find\n\nThis prevents \"Is a directory\" error when running \"head\":\nChecking for exceptions...\nFound exception in log files; printing first 500 lines; see full logs for details:\nhead: error reading '/home/vsts/work/1/s/flink-dist/target/flink-1.12-SNAPSHOT-bin/flink-1.12-SNAPSHOT/log/': Is a directory", "committedDate": "2020-08-18T14:30:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472352387", "bodyText": "Won't this flood log with exceptions in some cases?\nThere was some relevant discussion about this when it was being introduced.\nCC @klion26 ?", "author": "pnowojski", "createdAt": "2020-08-18T17:10:05Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/AsyncCheckpointRunnable.java", "diffHunk": "@@ -129,12 +129,10 @@ public void run() {\n \t\t\t\t\tcheckpointMetaData.getCheckpointId());\n \t\t\t}\n \t\t} catch (Exception e) {\n-\t\t\tif (LOG.isDebugEnabled()) {\n-\t\t\t\tLOG.debug(\"{} - asynchronous part of checkpoint {} could not be completed.\",\n-\t\t\t\t\ttaskName,\n-\t\t\t\t\tcheckpointMetaData.getCheckpointId(),\n-\t\t\t\t\te);\n-\t\t\t}\n+\t\t\tLOG.info(\"{} - asynchronous part of checkpoint {} could not be completed.\",", "originalCommit": "0bcfb80835ebec1a8e4bd240515852a240631e83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwMzI0Mw==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472703243", "bodyText": "Yes, this was debug level because there would be flood log if use INFO or above log level. Currently, we support very frequent checkpoints.", "author": "klion26", "createdAt": "2020-08-19T05:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjgxODI0Ng==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472818246", "bodyText": "But will be reported only in exceptional situations, do they happen that frequently?", "author": "rkhachatryan", "createdAt": "2020-08-19T07:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk3OTYxMA==", "url": "https://github.com/apache/flink/pull/13180#discussion_r472979610", "bodyText": "@rkhachatryan I think in production it would not happen(I assume that users always configure checkpoint interval with minutes), but this may happen if we configure a very small checkpoint interval.", "author": "klion26", "createdAt": "2020-08-19T12:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAwNjY1NA==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473006654", "bodyText": "Even with a small checkpoint interval, failure frequency should be higher, otherwise, the job will fail.\nSo I don't think it poses any problem.\nWDYT?", "author": "rkhachatryan", "createdAt": "2020-08-19T12:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxMjgwMQ==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473012801", "bodyText": "I would also be surprised if it would fail frequently on a regular basis.\nOn the other hand: wouldn't this be forwarded to the checkpoint coordinator and reported there anyway? (but maybe we need this in both logs as many other things)", "author": "NicoK", "createdAt": "2020-08-19T13:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1MjQyOA==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473052428", "bodyText": "Yes, it will be forwarded in most cases, but this forward RPC can also fail (I think it can be helpful to have it in both logs).", "author": "rkhachatryan", "createdAt": "2020-08-19T14:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyMzEzOA==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473623138", "bodyText": "Honestly, I have not had this to me, I\u2019m not against this change here.\nAfter another look of CheckpointFailureManager, we have counted CHECKPOINT_EXPIRED in(we will count CHECKPOINT_EXPIRED and CHECKPOINT_DECLINED in now), before count CHECKPOINT_EXPIRED in, we may have expired checkpoints, and abort the ongoing the snapshot(this may print the log here) through notifyCheckpointAbort RPC.", "author": "klion26", "createdAt": "2020-08-20T05:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY4OTY0Mw==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473689643", "bodyText": "I think everything said above about failure frequency is also true for expirations (in fact, there is only one counter for all types of failures).", "author": "rkhachatryan", "createdAt": "2020-08-20T07:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgwMzY5Mw==", "url": "https://github.com/apache/flink/pull/13180#discussion_r473803693", "bodyText": "Honestly, I have not had this to me, I\u2019m not against this change here.\n\nOk, in that case let's not overthink it and let's try this out :) Thanks for your inputs @NicoK and @klion26 .", "author": "pnowojski", "createdAt": "2020-08-20T09:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM1MjM4Nw=="}], "type": "inlineReview"}]}