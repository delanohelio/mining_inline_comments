{"pr_number": 11796, "pr_title": "[FLINK-14258][table][filesystem] Integrate file system connector to streaming sink", "pr_createdAt": "2020-04-17T13:30:20Z", "pr_url": "https://github.com/apache/flink/pull/11796", "timeline": [{"oid": "4d98d46528fab8087fccf79b9184f27a6197c714", "url": "https://github.com/apache/flink/commit/4d98d46528fab8087fccf79b9184f27a6197c714", "message": "[FLINK-14258][table][filesystem] Integrate file system connector to streaming sink", "committedDate": "2020-04-24T03:58:57Z", "type": "commit"}, {"oid": "4d98d46528fab8087fccf79b9184f27a6197c714", "url": "https://github.com/apache/flink/commit/4d98d46528fab8087fccf79b9184f27a6197c714", "message": "[FLINK-14258][table][filesystem] Integrate file system connector to streaming sink", "committedDate": "2020-04-24T03:58:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1NzY2OQ==", "url": "https://github.com/apache/flink/pull/11796#discussion_r414557669", "bodyText": "please add param note", "author": "leonardBang", "createdAt": "2020-04-24T13:01:38Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableSink.java", "diffHunk": "@@ -75,14 +86,20 @@\n \t * @param formatProperties format properties.\n \t */\n \tpublic FileSystemTableSink(\n+\t\t\tboolean isBounded,", "originalCommit": "4d98d46528fab8087fccf79b9184f27a6197c714", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1Nzg2MA==", "url": "https://github.com/apache/flink/pull/11796#discussion_r414557860", "bodyText": "as above", "author": "leonardBang", "createdAt": "2020-04-24T13:01:55Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableSink.java", "diffHunk": "@@ -75,14 +86,20 @@\n \t * @param formatProperties format properties.\n \t */\n \tpublic FileSystemTableSink(\n+\t\t\tboolean isBounded,\n \t\t\tTableSchema schema,\n \t\t\tPath path,\n \t\t\tList<String> partitionKeys,\n \t\t\tString defaultPartName,\n+\t\t\tlong rollingFileSize,\n+\t\t\tlong rollingTimeInterval,\n \t\t\tMap<String, String> formatProperties) {\n+\t\tthis.isBounded = isBounded;\n \t\tthis.schema = schema;\n \t\tthis.path = path;\n \t\tthis.defaultPartName = defaultPartName;\n+\t\tthis.rollingFileSize = rollingFileSize;", "originalCommit": "4d98d46528fab8087fccf79b9184f27a6197c714", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1ODA1Ng==", "url": "https://github.com/apache/flink/pull/11796#discussion_r414558056", "bodyText": "as above", "author": "leonardBang", "createdAt": "2020-04-24T13:02:14Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableSink.java", "diffHunk": "@@ -75,14 +86,20 @@\n \t * @param formatProperties format properties.\n \t */\n \tpublic FileSystemTableSink(\n+\t\t\tboolean isBounded,\n \t\t\tTableSchema schema,\n \t\t\tPath path,\n \t\t\tList<String> partitionKeys,\n \t\t\tString defaultPartName,\n+\t\t\tlong rollingFileSize,\n+\t\t\tlong rollingTimeInterval,\n \t\t\tMap<String, String> formatProperties) {\n+\t\tthis.isBounded = isBounded;\n \t\tthis.schema = schema;\n \t\tthis.path = path;\n \t\tthis.defaultPartName = defaultPartName;\n+\t\tthis.rollingFileSize = rollingFileSize;\n+\t\tthis.rollingTimeInterval = rollingTimeInterval;", "originalCommit": "4d98d46528fab8087fccf79b9184f27a6197c714", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MDM2OA==", "url": "https://github.com/apache/flink/pull/11796#discussion_r414560368", "bodyText": "This note looks like strange,  I cannot the meaning..", "author": "leonardBang", "createdAt": "2020-04-24T13:06:02Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/FileSystemTableSink.java", "diffHunk": "@@ -284,4 +337,125 @@ public boolean configurePartitionGrouping(boolean supportsGrouping) {\n \t\tthis.dynamicGrouping = supportsGrouping;\n \t\treturn dynamicGrouping;\n \t}\n+\n+\t/**\n+\t * Table bucket assigner, wrap {@link PartitionComputer}.\n+\t */\n+\tprivate static class TableBucketAssigner implements BucketAssigner<BaseRow, String> {\n+\n+\t\tprivate final PartitionComputer<BaseRow> computer;\n+\n+\t\tprivate TableBucketAssigner(PartitionComputer<BaseRow> computer) {\n+\t\t\tthis.computer = computer;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic String getBucketId(BaseRow element, Context context) {\n+\t\t\ttry {\n+\t\t\t\treturn PartitionPathUtils.generatePartitionPath(\n+\t\t\t\t\t\tcomputer.generatePartValues(element));\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tthrow new RuntimeException(e);\n+\t\t\t}\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic SimpleVersionedSerializer<String> getSerializer() {\n+\t\t\treturn SimpleVersionedStringSerializer.INSTANCE;\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Table {@link RollingPolicy}, now it is a {@link CheckpointRollingPolicy}.\n+\t * Because partition commit is hard to support false.", "originalCommit": "4d98d46528fab8087fccf79b9184f27a6197c714", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5NzgxNw==", "url": "https://github.com/apache/flink/pull/11796#discussion_r415197817", "bodyText": "Sorry for out of date comments, should be:\nTable {@link RollingPolicy}, it extends {@link CheckpointRollingPolicy} for bulk writers.", "author": "JingsongLi", "createdAt": "2020-04-26T02:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MDM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MTY4MQ==", "url": "https://github.com/apache/flink/pull/11796#discussion_r414561681", "bodyText": "we can move the judgement to the begin to make the code path short", "author": "leonardBang", "createdAt": "2020-04-24T13:08:06Z", "path": "flink-table/flink-table-runtime-blink/src/main/java/org/apache/flink/table/filesystem/PartitionPathUtils.java", "diffHunk": "@@ -88,7 +88,9 @@ public static String generatePartitionPath(LinkedHashMap<String, String> partiti\n \t\t\tsuffixBuf.append(escapePathName(e.getValue()));\n \t\t\ti++;\n \t\t}\n-\t\tsuffixBuf.append(Path.SEPARATOR);\n+\t\tif (partitionSpec.size() > 0) {", "originalCommit": "4d98d46528fab8087fccf79b9184f27a6197c714", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE5ODExMg==", "url": "https://github.com/apache/flink/pull/11796#discussion_r415198112", "bodyText": "Good catch.\nif (partitionSpec.isEmpty()) {\n  return \"\";\n}", "author": "JingsongLi", "createdAt": "2020-04-26T02:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MTY4MQ=="}], "type": "inlineReview"}, {"oid": "17ecc0b37fc292c5f8fb70af8e6313ec9048bd45", "url": "https://github.com/apache/flink/commit/17ecc0b37fc292c5f8fb70af8e6313ec9048bd45", "message": "Fix comments", "committedDate": "2020-04-26T02:57:10Z", "type": "commit"}]}