{"pr_number": 14466, "pr_title": "[FLINK-20657][connectors/jdbc] Migrate jdbc InputFormat/LookupFunction to SimpleJdbcConnectionProvider for connection establishment", "pr_createdAt": "2020-12-22T14:53:54Z", "pr_url": "https://github.com/apache/flink/pull/14466", "timeline": [{"oid": "93f836cbe23b55502113b33a6ca08f613ed1a480", "url": "https://github.com/apache/flink/commit/93f836cbe23b55502113b33a6ca08f613ed1a480", "message": "[FLINK-20657][connectors/jdbc] Migrate jdbc InputFormat/LookupFunction to SimpleJdbcConnectionProvider for connection establishment", "committedDate": "2020-12-22T17:20:25Z", "type": "forcePushed"}, {"oid": "cdb692019548197320d8e058c386e177fa180495", "url": "https://github.com/apache/flink/commit/cdb692019548197320d8e058c386e177fa180495", "message": "[FLINK-20657][connectors/jdbc] Migrate jdbc InputFormat/LookupFunction to SimpleJdbcConnectionProvider for connection establishment", "committedDate": "2020-12-23T13:06:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyMzY4Mw==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548423683", "bodyText": "Maybe we don't need this method anymore, we can directly invoke connectionProvider.closeConnection in close().\nThe same to establishConnection.", "author": "wuchong", "createdAt": "2020-12-24T07:09:05Z", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/internal/AbstractJdbcOutputFormat.java", "diffHunk": "@@ -72,15 +70,7 @@ public void close() {\n \t}\n \n \tprivate void closeDbConnection() {", "originalCommit": "cdb692019548197320d8e058c386e177fa180495", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzc1OQ==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548527759", "bodyText": "closeDbConnection and establishConnection is removed in fixup commit.", "author": "kezhuw", "createdAt": "2020-12-24T13:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyMzY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDE4MA==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548424180", "bodyText": "What do you think about rename this method to getOrCreateConnection to make the create/establish behavior more explicitly?", "author": "wuchong", "createdAt": "2020-12-24T07:11:03Z", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/internal/connection/JdbcConnectionProvider.java", "diffHunk": "@@ -20,13 +20,40 @@\n import org.apache.flink.annotation.Internal;\n \n import java.sql.Connection;\n+import java.sql.SQLException;\n \n /**\n  * JDBC connection provider.\n  */\n @Internal\n public interface JdbcConnectionProvider {\n-\tConnection getConnection() throws Exception;\n+\t/**\n+\t * Get existing connection.\n+\t *\n+\t * @return existing connection\n+\t */\n+\tConnection getExistingConnection();\n \n-\tConnection reestablishConnection() throws Exception;\n+\t/**\n+\t * Get existing connection or establish an new one if there is none.\n+\t *\n+\t * @return existing connection or newly established connection\n+\t * @throws SQLException sql exception\n+\t * @throws ClassNotFoundException driver class not found\n+\t */\n+\tConnection getConnection() throws SQLException, ClassNotFoundException;", "originalCommit": "cdb692019548197320d8e058c386e177fa180495", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUxODkzMg==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548518932", "bodyText": "I had this tendence too and already had a fixup commit in local, I will push that commit soon.", "author": "kezhuw", "createdAt": "2020-12-24T12:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDM1NA==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548424354", "bodyText": "Is this method necessary? Can users use getConnection instead?", "author": "wuchong", "createdAt": "2020-12-24T07:11:46Z", "path": "flink-connectors/flink-connector-jdbc/src/main/java/org/apache/flink/connector/jdbc/internal/connection/JdbcConnectionProvider.java", "diffHunk": "@@ -20,13 +20,40 @@\n import org.apache.flink.annotation.Internal;\n \n import java.sql.Connection;\n+import java.sql.SQLException;\n \n /**\n  * JDBC connection provider.\n  */\n @Internal\n public interface JdbcConnectionProvider {\n-\tConnection getConnection() throws Exception;\n+\t/**\n+\t * Get existing connection.\n+\t *\n+\t * @return existing connection\n+\t */\n+\tConnection getExistingConnection();", "originalCommit": "cdb692019548197320d8e058c386e177fa180495", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzI1NQ==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548527255", "bodyText": "This method currently exist for reasons:\n\nBypass java checked exception restriction and serve as drop-in replacement for old connection field in migrating classes.\nTest access with no side effect to wrapped connection in JdbcInputFormat.getDbConn, AbstractJdbcOutputFormat.getConnection, JdbcLookupFunction.getDbConnection and JdbcRowDataLookupFunction.getDbConnection without resort to cast or additional VisibleForTesting.", "author": "kezhuw", "createdAt": "2020-12-24T13:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc3OTc5Mw==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548779793", "bodyText": "That makes sense. Then I would suggest to add @Nullable annotation on the return type or check null in the implementation.", "author": "wuchong", "createdAt": "2020-12-25T02:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg3MjUxNg==", "url": "https://github.com/apache/flink/pull/14466#discussion_r548872516", "bodyText": "@Nullable added.", "author": "kezhuw", "createdAt": "2020-12-25T13:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODQyNDM1NA=="}], "type": "inlineReview"}, {"oid": "cfb29832f3281af5b385f0ef87f17875224f474e", "url": "https://github.com/apache/flink/commit/cfb29832f3281af5b385f0ef87f17875224f474e", "message": "[FLINK-20657][connectors/jdbc] Migrate jdbc InputFormat/LookupFunction to SimpleJdbcConnectionProvider for connection establishment", "committedDate": "2020-12-25T13:22:14Z", "type": "commit"}, {"oid": "cfb29832f3281af5b385f0ef87f17875224f474e", "url": "https://github.com/apache/flink/commit/cfb29832f3281af5b385f0ef87f17875224f474e", "message": "[FLINK-20657][connectors/jdbc] Migrate jdbc InputFormat/LookupFunction to SimpleJdbcConnectionProvider for connection establishment", "committedDate": "2020-12-25T13:22:14Z", "type": "forcePushed"}]}