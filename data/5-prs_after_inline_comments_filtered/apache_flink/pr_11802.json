{"pr_number": 11802, "pr_title": "[FLINK-17197][runtime] switch ContinuousFileReaderOperator state to FAILED on error", "pr_createdAt": "2020-04-17T19:04:53Z", "pr_url": "https://github.com/apache/flink/pull/11802", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjQ5NA==", "url": "https://github.com/apache/flink/pull/11802#discussion_r410416494", "bodyText": "allows avoiding initializeState() which requires a lot of setup", "author": "rkhachatryan", "createdAt": "2020-04-17T19:05:45Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java", "diffHunk": "@@ -202,15 +212,15 @@ public void onNoMoreData(ContinuousFileReaderOperator<?> op) {\n \t * MUST only be changed via {@link #switchState(ReaderState) switchState}.\n \t */\n \tprivate transient ReaderState state = ReaderState.IDLE;\n-\tprivate transient PriorityQueue<TimestampedFileInputSplit> splits;\n+\tprivate transient PriorityQueue<TimestampedFileInputSplit> splits = new PriorityQueue<>();", "originalCommit": "1f63e9f1b9f77c0b16ce16a743de535333ba7fff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3a5ba58720be5eee04eb2b13cd265ed24144a90", "url": "https://github.com/apache/flink/commit/b3a5ba58720be5eee04eb2b13cd265ed24144a90", "message": "[FLINK-17197][runtime] switch ContinuousFileReaderOperator state to FAILED on error", "committedDate": "2020-04-20T08:12:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzNzY1NQ==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411437655", "bodyText": "Why have you created a separate class to add this unit test? There is already a similar test org.apache.flink.hdfstests.ContinuousFileProcessingTest#testExceptionHandling so definitely those two should be together.\nA good questions is why is the test for a class ContinuousFileReaderOperator named ContinuousFileProcessingTest but I guess that's a story for another time. (I would be +1 for renaming all ContinuousFileProcessing*** classes to ContinuousFileReaderOperator***)", "author": "pnowojski", "createdAt": "2020-04-20T14:45:45Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperatorTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.api.functions.source;\n+\n+import org.apache.flink.api.common.io.FileInputFormat;\n+import org.apache.flink.core.fs.FileInputSplit;\n+import org.apache.flink.core.fs.Path;\n+import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;\n+import org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor;\n+import org.apache.flink.streaming.runtime.tasks.TestProcessingTimeService;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.Mail;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.MailboxExecutorImpl;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.TaskMailboxImpl;\n+\n+import org.junit.Test;\n+\n+/**\n+ * {@link ContinuousFileReaderOperator} test.\n+ */\n+public class ContinuousFileReaderOperatorTest {", "originalCommit": "b3a5ba58720be5eee04eb2b13cd265ed24144a90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ4MTM1Ng==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411481356", "bodyText": "I added a unit test while ContinuousFileProcessingTest is an integration test. And it also resides in a different project (because of Hadoop dependencies).", "author": "rkhachatryan", "createdAt": "2020-04-20T15:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzNzY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MjQ0Mw==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411492443", "bodyText": "Hmmm, ok I see. I missed that it's in a different package. I think I would still slightly prefer to keep the tests together in the ContinuousFileProcessingTest class, and in the long run someone should reimplement those tests without relaying on Hadoop.\nBut if you would like to keep the unit tests closer to the actual class without doing/waiting for the refactor, in that case please also move ContinuousFileProcessingTest#testExceptionHandling to the new ContinuousFileReaderOperatorTest class.", "author": "pnowojski", "createdAt": "2020-04-20T15:54:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzNzY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0MzI0NQ==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411443245", "bodyText": "This test is violating the operator's contract here, by not calling open() and initializeState() methods. As it is know, it relays on the private implementation detail that those method are not doing anything important for this particular test case. It could lead to false positive errors if someone would add some valid logic to the ContinuousFileReaderOperator#processElement(), which would (legally) relay on any logic being done in those two methods.\nCouldn't you re-use pattern from org.apache.flink.hdfstests.ContinuousFileProcessingTest#testExceptionHandling?", "author": "pnowojski", "createdAt": "2020-04-20T14:52:37Z", "path": "flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperatorTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.streaming.api.functions.source;\n+\n+import org.apache.flink.api.common.io.FileInputFormat;\n+import org.apache.flink.core.fs.FileInputSplit;\n+import org.apache.flink.core.fs.Path;\n+import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;\n+import org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor;\n+import org.apache.flink.streaming.runtime.tasks.TestProcessingTimeService;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.Mail;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.MailboxExecutorImpl;\n+import org.apache.flink.streaming.runtime.tasks.mailbox.TaskMailboxImpl;\n+\n+import org.junit.Test;\n+\n+/**\n+ * {@link ContinuousFileReaderOperator} test.\n+ */\n+public class ContinuousFileReaderOperatorTest {\n+\n+\t@Test(expected = TestException.class)\n+\tpublic void testExceptionRethrown() throws Exception {\n+\t\tfinal TaskMailboxImpl mailbox = new TaskMailboxImpl();\n+\t\tfinal ContinuousFileReaderOperator<String> op = new ContinuousFileReaderOperator<>(\n+\t\t\t\tfailingFormat(),\n+\t\t\t\tnew TestProcessingTimeService(),\n+\t\t\t\tnew MailboxExecutorImpl(mailbox, 0, StreamTaskActionExecutor.IMMEDIATE)\n+\t\t);\n+\t\top.processElement(new StreamRecord<>(new TimestampedFileInputSplit(0L, 1, new Path(), 0L, 0L, new String[]{})));\n+\t\tfor (Mail m : mailbox.drain()) {\n+\t\t\tm.run();\n+\t\t}", "originalCommit": "b3a5ba58720be5eee04eb2b13cd265ed24144a90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwNTI3Mw==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411505273", "bodyText": "I agree about open() and initially I did provide no-op implementations of contexts and states.\nBut it piled up to just too much boilerplate so I opted for the risk of false-positives.\nHowever, I don't have a strong preference so I'll use the harness (which I also consider as a boilerplate).", "author": "rkhachatryan", "createdAt": "2020-04-20T16:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0MzI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0NDMyMg==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411444322", "bodyText": "nit: POSSIBLE_TRANSITIONS ?", "author": "pnowojski", "createdAt": "2020-04-20T14:53:52Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java", "diffHunk": "@@ -160,10 +169,11 @@ public boolean prepareToProcessRecord(ContinuousFileReaderOperator<?> op) {\n \t\tprivate static final Map<ReaderState, Set<ReaderState>> TRANSITIONS;", "originalCommit": "b3a5ba58720be5eee04eb2b13cd265ed24144a90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUwNjIyNg==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411506226", "bodyText": "How about VALID_TRANSITIONS ?", "author": "rkhachatryan", "createdAt": "2020-04-20T16:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0NDMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUxNzg3OA==", "url": "https://github.com/apache/flink/pull/11802#discussion_r411517878", "bodyText": "Even better :) (this rename should be a separate commit for this PR, so it's not mixing with the bug fix)", "author": "pnowojski", "createdAt": "2020-04-20T16:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ0NDMyMg=="}], "type": "inlineReview"}, {"oid": "b16e228c1e58ac87b2b67db6e8d12d3ba5578342", "url": "https://github.com/apache/flink/commit/b16e228c1e58ac87b2b67db6e8d12d3ba5578342", "message": "[FLINK-17197][runtime] switch ContinuousFileReaderOperator state to FAILED on error", "committedDate": "2020-04-20T17:10:08Z", "type": "commit"}, {"oid": "2ca30d10e0809e1e39d4733c49687920336aec97", "url": "https://github.com/apache/flink/commit/2ca30d10e0809e1e39d4733c49687920336aec97", "message": "[hotfix][runtime] move ContinuousFileReaderOperator unit test to the\nappropriate class and module", "committedDate": "2020-04-20T17:10:08Z", "type": "commit"}, {"oid": "b533af1f8c0e3c799ba11d614b638db11a907a0f", "url": "https://github.com/apache/flink/commit/b533af1f8c0e3c799ba11d614b638db11a907a0f", "message": "[hotfix][runtime] rename ContinuousFileReaderOperator.TRANSITIONS to VALID_TRANSITIONS", "committedDate": "2020-04-20T17:13:29Z", "type": "commit"}, {"oid": "b533af1f8c0e3c799ba11d614b638db11a907a0f", "url": "https://github.com/apache/flink/commit/b533af1f8c0e3c799ba11d614b638db11a907a0f", "message": "[hotfix][runtime] rename ContinuousFileReaderOperator.TRANSITIONS to VALID_TRANSITIONS", "committedDate": "2020-04-20T17:13:29Z", "type": "forcePushed"}]}