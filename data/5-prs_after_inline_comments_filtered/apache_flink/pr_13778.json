{"pr_number": 13778, "pr_title": "[FLINK-19791][network][test] Connect to an opened port instead of 8080", "pr_createdAt": "2020-10-23T18:29:21Z", "pr_url": "https://github.com/apache/flink/pull/13778", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDU1MQ==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511080551", "bodyText": "Couldn't you leave it as is and just request a ConnectionID from AwaitingNettyClient?", "author": "AHeise", "createdAt": "2020-10-23T18:48:23Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientFactoryTest.java", "diffHunk": "@@ -61,15 +61,23 @@\n \n \t@Test\n \tpublic void testInterruptsNotCached() throws Exception {\n-\t\tConnectionID connectionId = new ConnectionID(new InetSocketAddress(InetAddress.getLocalHost(), 8080), 0);\n-\t\ttry (AwaitingNettyClient nettyClient = new AwaitingNettyClient()) {\n+\t\tfinal NettyTestUtil.NettyServerAndClient nettyServerAndClient = createNettyServerAndClient();\n+\t\tConnectionID connectionId = new ConnectionID(new InetSocketAddress(\n+\t\t\tnettyServerAndClient.server().getConfig().getServerAddress(),\n+\t\t\tnettyServerAndClient.server().getConfig().getServerPort()),\n+\t\t\t0);\n+\t\ttry {\n+\t\t\tAwaitingNettyClient nettyClient = new AwaitingNettyClient(nettyServerAndClient.client());\n \t\t\tPartitionRequestClientFactory factory = new PartitionRequestClientFactory(nettyClient, 0);\n \n \t\t\tnettyClient.awaitForInterrupts = true;\n \t\t\tconnectAndInterrupt(factory, connectionId);\n \n \t\t\tnettyClient.awaitForInterrupts = false;\n \t\t\tfactory.createPartitionRequestClient(connectionId);\n+\t\t} finally {\n+\t\t\tnettyServerAndClient.client().shutdown();\n+\t\t\tnettyServerAndClient.server().shutdown();\n \t\t}", "originalCommit": "99697b47cb57cb5a848891bfc23adc3c36f0ff04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4NzE3OQ==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511087179", "bodyText": "I did it at first but it didn't look to me like a right abstraction (a client wrapping serverAndClient and exposing a ConnectionID).", "author": "rkhachatryan", "createdAt": "2020-10-23T19:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTYzMDc1MQ==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511630751", "bodyText": "Okay fair point. How about, keep as is, add some AwaitingNettyClient#getSocketAddress and use that to setup connectionId inside the try-with-resource block?", "author": "AHeise", "createdAt": "2020-10-25T18:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTYzOTA4MQ==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511639081", "bodyText": "The part \"client wrapping serverAndClient\"\nwould still hold (and I'd like to avoid it).\nWhy do you want to stick with the current way?", "author": "rkhachatryan", "createdAt": "2020-10-25T19:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0ODUxMw==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511748513", "bodyText": "I like the try-with-resource approach more - it makes the code cleaner and test easier to understand. But you'd have to move the AutoCloseable to NettyServerAndClient, which is probably out of scope here. I also now fully understand your argument.", "author": "AHeise", "createdAt": "2020-10-26T06:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MDg5Mw==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511080893", "bodyText": "Add this commit before the test fix? Then you can use the method directly.", "author": "AHeise", "createdAt": "2020-10-23T18:49:10Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/NettyTestUtil.java", "diffHunk": "@@ -19,6 +19,7 @@\n package org.apache.flink.runtime.io.network.netty;\n \n import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.runtime.io.network.ConnectionID;\n import org.apache.flink.util.NetUtils;", "originalCommit": "ee77c062d06463064d24b4c5469dfd5bf09f529c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4MTcwNA==", "url": "https://github.com/apache/flink/pull/13778#discussion_r511081704", "bodyText": "While the commit message is quite direct, it seems a bit clumsy.\nHow about [refactor][tests][network] Cleanup PartitionRequestClientFactoryTest?", "author": "AHeise", "createdAt": "2020-10-23T18:50:45Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/PartitionRequestClientFactoryTest.java", "diffHunk": "@@ -131,8 +129,6 @@ public void testNettyClientConnectRetryFailure() throws Exception {\n \n \t\t\tfactory.createPartitionRequestClient(serverAndClient.getConnectionID(0));", "originalCommit": "3881f36e07d498a9be32b0bd73c0838b8344dcb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ab78cc68f6af91be5af6c3ed1813cde2332c5eb", "url": "https://github.com/apache/flink/commit/3ab78cc68f6af91be5af6c3ed1813cde2332c5eb", "message": "[tests][network][refactor] Extract NettyServerAndClient.getConnectionID", "committedDate": "2020-10-23T19:06:10Z", "type": "commit"}, {"oid": "16653c9e6783e71cfbdd967f6eafcca5807b5d74", "url": "https://github.com/apache/flink/commit/16653c9e6783e71cfbdd967f6eafcca5807b5d74", "message": "[FLINK-19791][network][test] Connect to an opened port instead of 8080", "committedDate": "2020-10-23T19:06:10Z", "type": "commit"}, {"oid": "69c2228581c8c6b288d9a6e05f43a8f3287b57f8", "url": "https://github.com/apache/flink/commit/69c2228581c8c6b288d9a6e05f43a8f3287b57f8", "message": "[refactor][tests][network] Cleanup PartitionRequestClientFactoryTest", "committedDate": "2020-10-23T19:06:57Z", "type": "commit"}, {"oid": "69c2228581c8c6b288d9a6e05f43a8f3287b57f8", "url": "https://github.com/apache/flink/commit/69c2228581c8c6b288d9a6e05f43a8f3287b57f8", "message": "[refactor][tests][network] Cleanup PartitionRequestClientFactoryTest", "committedDate": "2020-10-23T19:06:57Z", "type": "forcePushed"}]}