{"pr_number": 12314, "pr_title": "[FLINK-17756][table-api-java] Drop table/view shouldn't take effect o\u2026", "pr_createdAt": "2020-05-25T05:43:20Z", "pr_url": "https://github.com/apache/flink/pull/12314", "timeline": [{"oid": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "url": "https://github.com/apache/flink/commit/b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "message": "[FLINK-17756][table-api-java] Drop table/view shouldn't take effect on each other", "committedDate": "2020-05-25T05:41:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NTI5MA==", "url": "https://github.com/apache/flink/pull/12314#discussion_r429745290", "bodyText": "Can you move this execute into if (filter.test(result.getTable()))?", "author": "JingsongLi", "createdAt": "2020-05-25T06:02:30Z", "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/catalog/CatalogManager.java", "diffHunk": "@@ -682,20 +682,60 @@ public void alterTable(CatalogBaseTable table, ObjectIdentifier objectIdentifier\n \t * Drops a table in a given fully qualified path.\n \t *\n \t * @param objectIdentifier The fully qualified path of the table to drop.\n-\t * @param ignoreIfNotExists If false exception will be thrown if the table or database or catalog to be altered\n+\t * @param ignoreIfNotExists If false exception will be thrown if the table to drop\n \t *                          does not exist.\n \t */\n \tpublic void dropTable(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n-\t\tif (temporaryTables.containsKey(objectIdentifier)) {\n-\t\t\tthrow new ValidationException(String.format(\n-\t\t\t\t\"Temporary table with identifier '%s' exists. Drop it first before removing the permanent table.\",\n-\t\t\t\tobjectIdentifier));\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogTable,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\t/**\n+\t * Drops a view in a given fully qualified path.\n+\t *\n+\t * @param objectIdentifier The fully qualified path of the view to drop.\n+\t * @param ignoreIfNotExists If false exception will be thrown if the view to drop\n+\t *                          does not exist.\n+\t */\n+\tpublic void dropView(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogView,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\tprivate void dropTableInternal(\n+\t\t\tObjectIdentifier objectIdentifier,\n+\t\t\tPredicate<CatalogBaseTable> filter,\n+\t\t\tboolean ignoreIfNotExists) {\n+\t\tfinal Optional<TableLookupResult> resultOpt = getTable(objectIdentifier);\n+\t\tif (resultOpt.isPresent()) {\n+\t\t\tfinal TableLookupResult result = resultOpt.get();\n+\t\t\tif (filter.test(result.getTable())) {\n+\t\t\t\tif (result.isTemporary()) {\n+\t\t\t\t\t// Same name temporary table or view exists.\n+\t\t\t\t\tthrow new ValidationException(String.format(\n+\t\t\t\t\t\t\t\"Temporary table or view with identifier '%s' exists. \"\n+\t\t\t\t\t\t\t\t\t+ \"Drop it first before removing the permanent table or view.\",\n+\t\t\t\t\t\t\tobjectIdentifier));\n+\t\t\t\t}\n+\t\t\t} else if (!ignoreIfNotExists) {\n+\t\t\t\t// To drop a table but the object identifier represents a view(or vise versa).\n+\t\t\t\tthrow new ValidationException(String.format(\n+\t\t\t\t\t\t\"Table or view with identifier '%s' does not exist.\",\n+\t\t\t\t\t\tobjectIdentifier.asSummaryString()));\n+\t\t\t} else {\n+\t\t\t\t// Table or view does not exist with ignoreIfNotExists true, do nothing.\n+\t\t\t\treturn;\n+\t\t\t}\n \t\t}\n \t\texecute(", "originalCommit": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NTUzOQ==", "url": "https://github.com/apache/flink/pull/12314#discussion_r429745539", "bodyText": "Why not just getPermanentTable? You can keep previous temporaryTables.containsKey(objectIdentifier)", "author": "JingsongLi", "createdAt": "2020-05-25T06:03:23Z", "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/catalog/CatalogManager.java", "diffHunk": "@@ -682,20 +682,60 @@ public void alterTable(CatalogBaseTable table, ObjectIdentifier objectIdentifier\n \t * Drops a table in a given fully qualified path.\n \t *\n \t * @param objectIdentifier The fully qualified path of the table to drop.\n-\t * @param ignoreIfNotExists If false exception will be thrown if the table or database or catalog to be altered\n+\t * @param ignoreIfNotExists If false exception will be thrown if the table to drop\n \t *                          does not exist.\n \t */\n \tpublic void dropTable(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n-\t\tif (temporaryTables.containsKey(objectIdentifier)) {\n-\t\t\tthrow new ValidationException(String.format(\n-\t\t\t\t\"Temporary table with identifier '%s' exists. Drop it first before removing the permanent table.\",\n-\t\t\t\tobjectIdentifier));\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogTable,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\t/**\n+\t * Drops a view in a given fully qualified path.\n+\t *\n+\t * @param objectIdentifier The fully qualified path of the view to drop.\n+\t * @param ignoreIfNotExists If false exception will be thrown if the view to drop\n+\t *                          does not exist.\n+\t */\n+\tpublic void dropView(ObjectIdentifier objectIdentifier, boolean ignoreIfNotExists) {\n+\t\tdropTableInternal(\n+\t\t\t\tobjectIdentifier,\n+\t\t\t\ttable -> table instanceof CatalogView,\n+\t\t\t\tignoreIfNotExists);\n+\t}\n+\n+\tprivate void dropTableInternal(\n+\t\t\tObjectIdentifier objectIdentifier,\n+\t\t\tPredicate<CatalogBaseTable> filter,\n+\t\t\tboolean ignoreIfNotExists) {\n+\t\tfinal Optional<TableLookupResult> resultOpt = getTable(objectIdentifier);", "originalCommit": "b7a68f0f07ab9bb2abc3182d72c0dc80ed59dda1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8180c3272155f8db184013ed79946db1571206e8", "url": "https://github.com/apache/flink/commit/8180c3272155f8db184013ed79946db1571206e8", "message": "Fix Jingsong's review comment address", "committedDate": "2020-05-25T12:15:11Z", "type": "commit"}, {"oid": "6d0fcabc96b33099fa8413428d30736c3b251fc7", "url": "https://github.com/apache/flink/commit/6d0fcabc96b33099fa8413428d30736c3b251fc7", "message": "Fix test faliures", "committedDate": "2020-05-25T13:39:35Z", "type": "commit"}]}