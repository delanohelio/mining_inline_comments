{"pr_number": 13000, "pr_title": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from StreamTask.invoke", "pr_createdAt": "2020-07-27T21:39:43Z", "pr_url": "https://github.com/apache/flink/pull/13000", "timeline": [{"oid": "fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "url": "https://github.com/apache/flink/commit/fd25ce73cad9903cd1d76b3fa84f8d0dd6b6df9c", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke", "committedDate": "2020-07-27T21:42:17Z", "type": "forcePushed"}, {"oid": "021d4da6003e5c381c25af6d7bf4697d65db6b0e", "url": "https://github.com/apache/flink/commit/021d4da6003e5c381c25af6d7bf4697d65db6b0e", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke", "committedDate": "2020-07-28T07:20:40Z", "type": "forcePushed"}, {"oid": "9cdd842c8447827394ea5dac56995574a532cde5", "url": "https://github.com/apache/flink/commit/9cdd842c8447827394ea5dac56995574a532cde5", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke", "committedDate": "2020-07-28T09:33:58Z", "type": "forcePushed"}, {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf", "url": "https://github.com/apache/flink/commit/4d946d97789255f15c8821dbdb9961dcbe325edf", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke", "committedDate": "2020-07-28T11:25:35Z", "type": "commit"}, {"oid": "4d946d97789255f15c8821dbdb9961dcbe325edf", "url": "https://github.com/apache/flink/commit/4d946d97789255f15c8821dbdb9961dcbe325edf", "message": "[FLINK-15467][task] Wait for sourceTaskThread to finish before exiting from invoke", "committedDate": "2020-07-28T11:25:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ==", "url": "https://github.com/apache/flink/pull/13000#discussion_r462090249", "bodyText": "Two questions:\n\nShould we not ignore the exception? Just in case of some unexpected exceptions/bugs/problems? I guess the expected exception is InterruptedException?\nShouldn't this be in a while (true) loop with ignoring interruptions?", "author": "pnowojski", "createdAt": "2020-07-29T07:19:55Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java", "diffHunk": "@@ -562,6 +567,7 @@ private void runMailboxLoop() throws Exception {\n \n \tprotected void afterInvoke() throws Exception {\n \t\tLOG.debug(\"Finished task {}\", getName());\n+\t\tgetCompletionFuture().exceptionally(unused -> null).join();", "originalCommit": "4d946d97789255f15c8821dbdb9961dcbe325edf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5ODYxNg==", "url": "https://github.com/apache/flink/pull/13000#discussion_r462098616", "bodyText": "Good questions,\n\nI think this future resulting exception shouldn't be reported here. It's already reported in SourceStreamTask.processInput using mailboxProcessor.reportThrowable\nCompletableFuture.join is not interruptible, so shouldn't be a problem.", "author": "rkhachatryan", "createdAt": "2020-07-29T07:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI4OTM3Mw==", "url": "https://github.com/apache/flink/pull/13000#discussion_r462289373", "bodyText": "It's already reported in SourceStreamTask.processInput using mailboxProcessor.reportThrowable\n\nI think you are right, it should be correct now.\nBut I would just rephrase it that \"it SHOULD be reported in...\". what about handling our bugs, when it won't be reported? Could we make it more error prone? For example make sure that no exceptions should ever reach StreamTask#getCompletionFuture().join()? And if something would reach it here, it would be equivalent of an IllegalStateException?\nMaybe SourceStreamTask#getCompletionFuture() could wrap the future somehow? SourceStreamTask is the owner of logic handling/forwarding the exceptions, so it would be a slightly better place to ignore exceptions compared to StreamTask?", "author": "pnowojski", "createdAt": "2020-07-29T13:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwNDUzNw==", "url": "https://github.com/apache/flink/pull/13000#discussion_r462304537", "bodyText": "So you suggest to\n\nmove .exceptionally(unused -> null) from StreamTask to SourceStreamTask (or wrap in some other way)\nin StreamTask, propagate failure as a programming error\n\nDid I get you right?\nIf so, I think it introduces an unnecessary contract that getCompletionFuture never completes exceptionally and actually makes the code less error-prone (think of other StreamTask subclasses).", "author": "rkhachatryan", "createdAt": "2020-07-29T13:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzMzkxNA==", "url": "https://github.com/apache/flink/pull/13000#discussion_r462333914", "bodyText": "ok, let's keep it as it is.", "author": "pnowojski", "createdAt": "2020-07-29T14:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA5MDI0OQ=="}], "type": "inlineReview"}]}