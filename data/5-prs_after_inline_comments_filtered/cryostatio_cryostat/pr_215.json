{"pr_number": 215, "pr_title": "Unify API responses to only contain JMX service URLs", "pr_createdAt": "2020-07-22T16:13:49Z", "pr_url": "https://github.com/cryostatio/cryostat/pull/215", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzA0NQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458967045", "bodyText": "The point of the change is to ensure that all PlatformClients report JMXServiceURLs, right? So, should the String connectUrl here perhaps be replaced by a JMXServiceURL?", "author": "andrewazores", "createdAt": "2020-07-22T17:37:25Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -49,16 +49,14 @@\n \n     private final String connectUrl;\n     private final String alias;\n-    private final int port;\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n+    public ServiceRef(String connectUrl) {\n+        this(connectUrl, connectUrl);\n     }\n \n-    public ServiceRef(String connectUrl, String alias, int port) {\n+    public ServiceRef(String connectUrl, String alias) {", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzE3Nw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458967177", "bodyText": "localhost probably isn't a valid JMXServiceURL", "author": "andrewazores", "createdAt": "2020-07-22T17:37:37Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/SelfDiscoveryPlatformClient.java", "diffHunk": "@@ -47,8 +47,7 @@\n \n class SelfDiscoveryPlatformClient implements PlatformClient {\n \n-    private static final ServiceRef VM_SELF_REF =\n-            new ServiceRef(\"localhost\", \"This ContainerJFR\", 0);\n+    private static final ServiceRef VM_SELF_REF = new ServiceRef(\"localhost\", \"This ContainerJFR\");", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzQwNA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458967404", "bodyText": "If the ServiceRef contains a service URL then the toString here can be removed", "author": "andrewazores", "createdAt": "2020-07-22T17:38:00Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/DefaultPlatformClient.java", "diffHunk": "@@ -67,7 +67,7 @@\n                         u -> {\n                             try {\n                                 return new ServiceRef(\n-                                        u.getJmxServiceUrl().toString(), u.getMainClass(), 0);\n+                                        u.getJmxServiceUrl().toString(), u.getMainClass());", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzU0OA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458967548", "bodyText": "The cluster IP is definitely not a service URL", "author": "andrewazores", "createdAt": "2020-07-22T17:38:16Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeApiPlatformClient.java", "diffHunk": "@@ -80,13 +80,7 @@\n                     .map(V1Service::getSpec)\n                     .peek(spec -> logger.trace(\"Service spec: \" + spec.toString()))\n                     .filter(s -> s.getPorts() != null)\n-                    .flatMap(\n-                            s ->\n-                                    s.getPorts().stream()\n-                                            .map(\n-                                                    p ->\n-                                                            new ServiceRef(\n-                                                                    s.getClusterIP(), p.getPort())))\n+                    .flatMap(s -> s.getPorts().stream().map(p -> new ServiceRef(s.getClusterIP())))", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MjA4NQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460172085", "bodyText": "Should be fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T16:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2Nzc0OQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458967749", "bodyText": "And the hostname is also not a fully-formed service URL", "author": "andrewazores", "createdAt": "2020-07-22T17:38:34Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeApiPlatformClient.java", "diffHunk": "@@ -105,7 +99,7 @@ private ServiceRef resolveServiceRefHostname(ServiceRef in) {\n         try {\n             String hostname = resolver.resolveCanonicalHostName(in.getConnectUrl());\n             logger.debug(String.format(\"Resolved %s to %s\", in.getConnectUrl(), hostname));\n-            return new ServiceRef(hostname, in.getPort());\n+            return new ServiceRef(hostname);", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2OTA3OQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458969079", "bodyText": "Same here - the form of these environment variables looks like REDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11 ( https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables ) , so this will be a raw IP address.", "author": "andrewazores", "createdAt": "2020-07-22T17:40:42Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeEnvPlatformClient.java", "diffHunk": "@@ -76,7 +76,6 @@ private static ServiceRef envToServiceRef(Map.Entry<String, String> entry) {\n             return null;\n         }\n         String alias = matcher.group(1).toLowerCase();\n-        int port = Integer.parseInt(matcher.group(2));\n-        return new ServiceRef(entry.getValue(), alias, port);\n+        return new ServiceRef(entry.getValue(), alias);", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2OTIyNw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r458969227", "bodyText": "Also a raw IP address", "author": "andrewazores", "createdAt": "2020-07-22T17:40:58Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/openshift/OpenShiftPlatformClient.java", "diffHunk": "@@ -101,12 +101,7 @@ private boolean isCompatiblePort(EndpointPort port) {\n \n     private List<ServiceRef> createServiceRefs(EndpointSubset subset, EndpointPort port) {\n         return subset.getAddresses().stream()\n-                .map(\n-                        addr ->\n-                                new ServiceRef(\n-                                        addr.getIp(),\n-                                        addr.getTargetRef().getName(),\n-                                        port.getPort()))\n+                .map(addr -> new ServiceRef(addr.getIp(), addr.getTargetRef().getName()))", "originalCommit": "6ad5569c3c672815be86fe51129a9f305e85f118", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMDE1MQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r459700151", "bodyText": "This doesn't seem right. Why would a null entry to added to the list in this case?", "author": "andrewazores", "createdAt": "2020-07-23T20:11:03Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/SelfDiscoveryPlatformClient.java", "diffHunk": "@@ -45,21 +45,28 @@\n import java.util.Collections;\n import java.util.List;\n \n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+\n class SelfDiscoveryPlatformClient implements PlatformClient {\n \n-    private static final ServiceRef VM_SELF_REF =\n-            new ServiceRef(\"localhost\", \"This ContainerJFR\", 0);\n+    private static ServiceRef VM_SELF_REF;\n     private final PlatformClient client;\n \n     SelfDiscoveryPlatformClient(PlatformClient client) {\n         this.client = client;\n     }\n \n     @Override\n-    public List<ServiceRef> listDiscoverableServices() {\n+    public List<ServiceRef> listDiscoverableServices(Logger logger) {\n         List<ServiceRef> list = new ArrayList<>();\n+        try {\n+            VM_SELF_REF = new ServiceRef(\"localhost\", \"This ContainerJFR\", 0);\n+        } catch (Exception e) {\n+            logger.info(e);\n+            VM_SELF_REF = null;", "originalCommit": "a8129e419c6f0254c8f8491a33946cc6a483b0f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MjM2Nw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460172367", "bodyText": "should be fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T16:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMDE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMDU1Mw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r459700553", "bodyText": "It doesn't seem very useful to use the URL itself as the alias (which is intended to be a human-friendly identifier) for the URL. This is, in hindsight, a mistake of the old implementation, so let's clean it up here. Rather, perhaps the alias should be an Optional.", "author": "andrewazores", "createdAt": "2020-07-23T20:11:53Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -41,36 +41,37 @@\n  */\n package com.redhat.rhjmc.containerjfr.platform;\n \n+import javax.management.remote.JMXServiceURL;\n+\n import org.apache.commons.lang.builder.EqualsBuilder;\n import org.apache.commons.lang.builder.HashCodeBuilder;\n import org.apache.commons.lang3.builder.ToStringBuilder;\n \n public class ServiceRef {\n \n-    private final String connectUrl;\n+    private final JMXServiceURL JMXServiceURL;\n     private final String alias;\n-    private final int port;\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n+    public ServiceRef(JMXServiceURL JMXServiceURL) {\n+        this(JMXServiceURL, JMXServiceURL.toString());", "originalCommit": "a8129e419c6f0254c8f8491a33946cc6a483b0f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3Mjc3Ng==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460172776", "bodyText": "Should be fixed, haven't tested yet if the Optional gets serialized properly, I will do that next.", "author": "Alexjsenn", "createdAt": "2020-07-24T16:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMDU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTk3MA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r459701970", "bodyText": "host/alias/port feels like an unnatural ordering of these params IMO. Maybe host/port/alias? Or alias/host/port? I think the host/port should be adjacent to each other.", "author": "andrewazores", "createdAt": "2020-07-23T20:14:54Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -41,36 +41,37 @@\n  */\n package com.redhat.rhjmc.containerjfr.platform;\n \n+import javax.management.remote.JMXServiceURL;\n+\n import org.apache.commons.lang.builder.EqualsBuilder;\n import org.apache.commons.lang.builder.HashCodeBuilder;\n import org.apache.commons.lang3.builder.ToStringBuilder;\n \n public class ServiceRef {\n \n-    private final String connectUrl;\n+    private final JMXServiceURL JMXServiceURL;\n     private final String alias;\n-    private final int port;\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n+    public ServiceRef(JMXServiceURL JMXServiceURL) {\n+        this(JMXServiceURL, JMXServiceURL.toString());\n     }\n \n-    public ServiceRef(String connectUrl, String alias, int port) {\n-        this.connectUrl = connectUrl;\n+    public ServiceRef(JMXServiceURL JMXServiceURL, String alias) {\n+        this.JMXServiceURL = JMXServiceURL;\n         this.alias = alias;\n-        this.port = port;\n     }\n \n-    public String getConnectUrl() {\n-        return connectUrl;\n+    public ServiceRef(String host, String alias, int port) throws Exception {", "originalCommit": "a8129e419c6f0254c8f8491a33946cc6a483b0f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MjkxNg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460172916", "bodyText": "fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T16:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMjU0MA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r459702540", "bodyText": "This goes for all of these new logger statements - maybe a Warning level message would be more appropriate?", "author": "andrewazores", "createdAt": "2020-07-23T20:15:58Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeEnvPlatformClient.java", "diffHunk": "@@ -57,26 +58,33 @@\n     private static final Pattern SERVICE_ENV_PATTERN =\n             Pattern.compile(\"([\\\\S]+)_PORT_([\\\\d]+)_TCP_ADDR\");\n     private final Environment env;\n+    private final Logger logger;\n \n-    KubeEnvPlatformClient(Environment env) {\n+    KubeEnvPlatformClient(Environment env, Logger logger) {\n         this.env = env;\n+        this.logger = logger;\n     }\n \n     @Override\n-    public List<ServiceRef> listDiscoverableServices() {\n+    public List<ServiceRef> listDiscoverableServices(Logger logger) {\n         return env.getEnv().entrySet().stream()\n-                .map(KubeEnvPlatformClient::envToServiceRef)\n+                .map(this::envToServiceRef)\n                 .filter(Objects::nonNull)\n                 .collect(Collectors.toList());\n     }\n \n-    private static ServiceRef envToServiceRef(Map.Entry<String, String> entry) {\n+    private ServiceRef envToServiceRef(Map.Entry<String, String> entry) {\n         Matcher matcher = SERVICE_ENV_PATTERN.matcher(entry.getKey());\n         if (!matcher.matches()) {\n             return null;\n         }\n         String alias = matcher.group(1).toLowerCase();\n         int port = Integer.parseInt(matcher.group(2));\n-        return new ServiceRef(entry.getValue(), alias, port);\n+        try {\n+            return new ServiceRef(entry.getValue(), alias, port);\n+        } catch (Exception e) {\n+            logger.info(e);", "originalCommit": "a8129e419c6f0254c8f8491a33946cc6a483b0f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MzAwNA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460173004", "bodyText": "fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T16:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMjU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMzIzNA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r459703234", "bodyText": "This seems wrong. Why does the Logger need to be provided as an argument to this method? I would expect it to be dependency injected into the PlatformClient implementations' constructors.", "author": "andrewazores", "createdAt": "2020-07-23T20:17:16Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/PlatformClient.java", "diffHunk": "@@ -43,6 +43,8 @@\n \n import java.util.List;\n \n+import com.redhat.rhjmc.containerjfr.core.log.Logger;\n+\n public interface PlatformClient {\n-    List<ServiceRef> listDiscoverableServices();\n+    List<ServiceRef> listDiscoverableServices(Logger logger);", "originalCommit": "a8129e419c6f0254c8f8491a33946cc6a483b0f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MzEyMw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460173123", "bodyText": "I removed it!", "author": "Alexjsenn", "createdAt": "2020-07-24T16:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMzIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3NzM5Mg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460177392", "bodyText": "For robustness, maybe this should be Optional.ofNullable()? Optional.of(null) throws an exception IIRC, which we could avoid by just using ofNullable which produces an empty Optional if passed null.", "author": "andrewazores", "createdAt": "2020-07-24T17:01:38Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -41,36 +41,39 @@\n  */\n package com.redhat.rhjmc.containerjfr.platform;\n \n+import java.util.Optional;\n+\n+import javax.management.remote.JMXServiceURL;\n+\n import org.apache.commons.lang.builder.EqualsBuilder;\n import org.apache.commons.lang.builder.HashCodeBuilder;\n import org.apache.commons.lang3.builder.ToStringBuilder;\n \n public class ServiceRef {\n \n-    private final String connectUrl;\n-    private final String alias;\n-    private final int port;\n+    private final JMXServiceURL JMXServiceURL;\n+    private Optional<String> alias = Optional.empty();\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n+    public ServiceRef(JMXServiceURL JMXServiceURL) {\n+        this.JMXServiceURL = JMXServiceURL;\n     }\n \n-    public ServiceRef(String connectUrl, String alias, int port) {\n-        this.connectUrl = connectUrl;\n-        this.alias = alias;\n-        this.port = port;\n+    public ServiceRef(JMXServiceURL JMXServiceURL, String alias) {\n+        this.JMXServiceURL = JMXServiceURL;\n+        this.alias = Optional.of(alias);", "originalCommit": "69e4447e7da811462af12bd703a2e173cd7f1c24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5NTcyMg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460195722", "bodyText": "Fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T17:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3NzM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3ODIwOQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460178209", "bodyText": "Just a style thing but the constructor param should be named like jmxServiceUrl or jmxServiceURL, not JMXServiceURL.\nAlso if the other constructor has a throws declaration, they probably all should. In fact, this constructor should be the \"primary\" one, and the others should defer to it, ex:\npublic ServiceRef(JMXServiceURL jmxServiceUrl) {\n  this(jmxServiceUrl, null);\n}\n\nThat way as much logic is shared as possible.", "author": "andrewazores", "createdAt": "2020-07-24T17:03:24Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -41,36 +41,39 @@\n  */\n package com.redhat.rhjmc.containerjfr.platform;\n \n+import java.util.Optional;\n+\n+import javax.management.remote.JMXServiceURL;\n+\n import org.apache.commons.lang.builder.EqualsBuilder;\n import org.apache.commons.lang.builder.HashCodeBuilder;\n import org.apache.commons.lang3.builder.ToStringBuilder;\n \n public class ServiceRef {\n \n-    private final String connectUrl;\n-    private final String alias;\n-    private final int port;\n+    private final JMXServiceURL JMXServiceURL;\n+    private Optional<String> alias = Optional.empty();\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n+    public ServiceRef(JMXServiceURL JMXServiceURL) {\n+        this.JMXServiceURL = JMXServiceURL;\n     }\n \n-    public ServiceRef(String connectUrl, String alias, int port) {\n-        this.connectUrl = connectUrl;\n-        this.alias = alias;\n-        this.port = port;\n+    public ServiceRef(JMXServiceURL JMXServiceURL, String alias) {", "originalCommit": "69e4447e7da811462af12bd703a2e173cd7f1c24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTc4Mw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460179783", "bodyText": "Makes sense!", "author": "Alexjsenn", "createdAt": "2020-07-24T17:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3ODIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5NTg5MQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460195891", "bodyText": "fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T17:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3ODIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTQ3OQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460179479", "bodyText": "Is this intended to be removed? The point of this method was to map IP addresses to more readable hostnames for the entry aliases, since the IP address itself isn't likely to be meaningful to a human reader without them having to go look at their cluster configuration and cross-reference the addresses. A hostname is more likely to give some telling information about what the user is looking at.", "author": "andrewazores", "createdAt": "2020-07-24T17:05:55Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeApiPlatformClient.java", "diffHunk": "@@ -100,15 +107,16 @@\n             return Collections.emptyList();\n         }\n     }\n-\n+    /*\n     private ServiceRef resolveServiceRefHostname(ServiceRef in) {\n         try {\n-            String hostname = resolver.resolveCanonicalHostName(in.getConnectUrl());\n-            logger.debug(String.format(\"Resolved %s to %s\", in.getConnectUrl(), hostname));\n-            return new ServiceRef(hostname, in.getPort());\n+            String hostname = resolver.resolveCanonicalHostName(in.getJMXServiceUrl());\n+            logger.debug(String.format(\"Resolved %s to %s\", in.getJMXServiceUrl(), hostname));\n+            return new ServiceRef(hostname);\n         } catch (Exception e) {\n             logger.debug(e);\n             return null;\n         }\n     }\n+    */", "originalCommit": "69e4447e7da811462af12bd703a2e173cd7f1c24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4NDIyNQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460184225", "bodyText": "Yeah no, I couldn't figure it out so I had temprarily removed it. Is the resolveCanonicalHostName only important for the alias? Because I could just incorporate it when Im creating the serviceRef above, and insert the resolved hostname as alias?", "author": "Alexjsenn", "createdAt": "2020-07-24T17:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4NjkyMQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460186921", "bodyText": "Yes, that's all it does is use a reverse DNS lookup to turn an InetAddress into a hostname string (under the hood it's just https://docs.oracle.com/javase/7/docs/api/java/net/InetAddress.html#getCanonicalHostName()), ex. 127.0.0.1 -> localhost.local or 123.45.6.7 -> someProductionService.cluster.local.\nUsing the actual IP to construct the JMXServiceURL makes sense, since if that URL used the hostname then it would need to do another DNS lookup back in the other direction to resolve the IP anyway (whoops - that's how it used to work, re-reading this). But that reverse-lookup-resolved hostname should be kept around for use as the alias as I said above.\nWhat part did you have trouble figuring out? Was it the stream mapping that was also commented out above?", "author": "andrewazores", "createdAt": "2020-07-24T17:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwNTc1Ng==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460205756", "bodyText": "I tried reducing it given that there was no point in creating the serviceRef and then making a new one again, im not sure if I should add back in the log message?", "author": "Alexjsenn", "createdAt": "2020-07-24T17:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNzQ3MQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460227471", "bodyText": "I think it's fine to remove it.", "author": "andrewazores", "createdAt": "2020-07-24T18:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDIzMw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460180233", "bodyText": "Since there is a possible return null in this chain, there should also be a corresponding filter to remove null entries, like the KubeEnv client has for example.", "author": "andrewazores", "createdAt": "2020-07-24T17:07:29Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/openshift/OpenShiftPlatformClient.java", "diffHunk": "@@ -99,14 +100,21 @@ private boolean isCompatiblePort(EndpointPort port) {\n         return \"jfr-jmx\".equals(port.getName()) || 9091 == port.getPort();\n     }\n \n-    private List<ServiceRef> createServiceRefs(EndpointSubset subset, EndpointPort port) {\n+    private List<ServiceRef> createServiceRefs(\n+            Logger logger, EndpointSubset subset, EndpointPort port) {\n         return subset.getAddresses().stream()\n                 .map(\n-                        addr ->\n-                                new ServiceRef(\n+                        addr -> {\n+                            try {\n+                                return new ServiceRef(\n                                         addr.getIp(),\n-                                        addr.getTargetRef().getName(),\n-                                        port.getPort()))\n+                                        port.getPort(),\n+                                        addr.getTargetRef().getName());\n+                            } catch (Exception e) {\n+                                logger.warn(e);\n+                                return null;", "originalCommit": "69e4447e7da811462af12bd703a2e173cd7f1c24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5NTk5Mg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r460195992", "bodyText": "Fixed.", "author": "Alexjsenn", "createdAt": "2020-07-24T17:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzMxMQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461207311", "bodyText": "This method isn't static, so I don't think it needs the logger instance passed as a parameter, does it?", "author": "andrewazores", "createdAt": "2020-07-27T22:30:43Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/openshift/OpenShiftPlatformClient.java", "diffHunk": "@@ -99,14 +101,22 @@ private boolean isCompatiblePort(EndpointPort port) {\n         return \"jfr-jmx\".equals(port.getName()) || 9091 == port.getPort();\n     }\n \n-    private List<ServiceRef> createServiceRefs(EndpointSubset subset, EndpointPort port) {\n+    private List<ServiceRef> createServiceRefs(", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMDEzNw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461610137", "bodyText": "No, you're right!", "author": "Alexjsenn", "createdAt": "2020-07-28T14:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzgxNw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461207817", "bodyText": "Could you inject a Logger instance here and pass it to new GsonJmxServiceUrlAdapter(logger)?", "author": "andrewazores", "createdAt": "2020-07-27T22:32:03Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/MainModule.java", "diffHunk": "@@ -85,7 +87,11 @@ static Logger provideLogger() {\n     @Provides\n     @Singleton\n     public static Gson provideGson() {", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwMzI1Mw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461703253", "bodyText": "could I just inject the logger into the GsonJmxServiceUrlAdapter? I had trouble figuring out how to inject into the static method provideGson()", "author": "Alexjsenn", "createdAt": "2020-07-28T16:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3NTU3OA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461775578", "bodyText": "All you do is add the Logger to the parameter list of this method. Since it's part of a Dagger module and has the @Provides annotation, Dagger will see that and inject the logger instance into this method.", "author": "andrewazores", "createdAt": "2020-07-28T18:09:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Nzg3OQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461777879", "bodyText": "Just scroll down a few lines within this file for an example.\n    @Provides\n    static Path provideSavedRecordingsPath(Logger logger, Environment env) {\n      ...\n    }\n\nThis is a cleaned-up version of the next method down, which has two injected dependencies.", "author": "andrewazores", "createdAt": "2020-07-28T18:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3ODY1Mw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461778653", "bodyText": "If you want to inject the Logger directly into the TypeAdapter then that's also an option, but then rather than directly new-ing it here, you will have to add an @Provides or @Binds method to some module to allow the adapter to have dependencies injected, and to allow the adapter itself to be injected into other places.", "author": "andrewazores", "createdAt": "2020-07-28T18:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzk2NA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461207964", "bodyText": "With the injected Logger instance, this exception can be logged (at warning level).", "author": "andrewazores", "createdAt": "2020-07-27T22:32:28Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/util/GsonJmxServiceUrlAdapter.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*-\n+ * #%L\n+ * Container JFR\n+ * %%\n+ * Copyright (C) 2020 Red Hat, Inc.\n+ * %%\n+ * The Universal Permissive License (UPL), Version 1.0\n+ *\n+ * Subject to the condition set forth below, permission is hereby granted to any\n+ * person obtaining a copy of this software, associated documentation and/or data\n+ * (collectively the \"Software\"), free of charge and under any and all copyright\n+ * rights in the Software, and any and all patent rights owned or freely\n+ * licensable by each licensor hereunder covering either (i) the unmodified\n+ * Software as contributed to or provided by such licensor, or (ii) the Larger\n+ * Works (as defined below), to deal in both\n+ *\n+ * (a) the Software, and\n+ * (b) any piece of software and/or hardware listed in the lrgrwrks.txt file if\n+ * one is included with the Software (each a \"Larger Work\" to which the Software\n+ * is contributed by such licensors),\n+ *\n+ * without restriction, including without limitation the rights to copy, create\n+ * derivative works of, display, perform, and distribute the Software and make,\n+ * use, sell, offer for sale, import, export, have made, and have sold the\n+ * Software and the Larger Work(s), and to sublicense the foregoing rights on\n+ * either these or other terms.\n+ *\n+ * This license is subject to the following condition:\n+ * The above copyright notice and either this complete permission notice or at\n+ * a minimum a reference to the UPL must be included in all copies or\n+ * substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ * #L%\n+ */\n+package com.redhat.rhjmc.containerjfr.util;\n+\n+import java.io.IOException;\n+\n+import javax.management.remote.JMXServiceURL;\n+\n+import com.google.gson.TypeAdapter;\n+import com.google.gson.stream.JsonReader;\n+import com.google.gson.stream.JsonWriter;\n+\n+public class GsonJmxServiceUrlAdapter extends TypeAdapter<JMXServiceURL> {\n+\n+    @Override\n+    public JMXServiceURL read(JsonReader reader) throws IOException {\n+        String url = reader.nextString();\n+        JMXServiceURL jmxUrl;\n+        try {\n+            jmxUrl = new JMXServiceURL(url);\n+        } catch (Exception e) {\n+            jmxUrl = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3Njc5Mg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461776792", "bodyText": "I don't think this was resolved. The @Inject annotation on the Logger field you added doesn't seem right, or it's at least not usual DI practice. Nothing in the Dagger dependency graph knows how to construct and inject an instance of this class, because no module includes it and there is no @Provides or @Binds method that directs Dagger on how to make one of these adapters available. As it is I believe the logger field will always be null, and so if an exception is thrown, you'll just end up with another exception (a NullPointerException) when you try to log it. And that NPE won't even get caught.", "author": "andrewazores", "createdAt": "2020-07-28T18:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMTcwMA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461831700", "bodyText": "ok, this should work now.", "author": "Alexjsenn", "createdAt": "2020-07-28T19:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNzk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODM4OA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208388", "bodyText": "This exception should never actually be thrown though, right? I think we can skip trying to handle it here and just add a throws-declaration to this test utility method.", "author": "andrewazores", "createdAt": "2020-07-27T22:33:38Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/commands/internal/ScanTargetsCommandTest.java", "diffHunk": "@@ -139,9 +139,19 @@ void shouldExecuteAndReturnExceptionOutputIfPlatformClientThrows() throws Except\n     }\n \n     List<ServiceRef> getMockServices() {\n-        ServiceRef mockA = new ServiceRef(\"aHost\", \"Host A\", 1);\n-        ServiceRef mockB = new ServiceRef(\"bHost\", \"Host B\", 2);\n-        ServiceRef mockC = new ServiceRef(\"cHost\", \"Host C\", 3);\n+        ServiceRef mockA;\n+        ServiceRef mockB;\n+        ServiceRef mockC;\n+        try {\n+            mockA = new ServiceRef(\"aHost\", 0, \"Host A\");\n+            mockB = new ServiceRef(\"bHost\", 0, \"Host B\");\n+            mockC = new ServiceRef(\"cHost\", 0, \"Host C\");\n+        } catch (Exception e) {", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODY2MQ==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208661", "bodyText": "Same here, just add a throws-declaration to the method and let it fail right away if somehow the test ServiceRef construction fails.", "author": "andrewazores", "createdAt": "2020-07-27T22:34:17Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/net/web/handlers/TargetsGetHandlerTest.java", "diffHunk": "@@ -90,7 +90,12 @@ void shouldHandleCorrectPath() {\n \n     @Test\n     void shouldReturnListOfTargets() {\n-        ServiceRef target = new ServiceRef(\"foo\", 1);\n+        ServiceRef target;\n+        try {\n+            target = new ServiceRef(\"foo\", 1, \"foo\");\n+        } catch (Exception e) {\n+            target = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODcxNw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208717", "bodyText": "Same as above", "author": "andrewazores", "createdAt": "2020-07-27T22:34:27Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeApiPlatformClientTest.java", "diffHunk": "@@ -153,12 +153,21 @@ void discoversAndResolvesServices() throws ApiException, UnknownHostException {\n \n             List<ServiceRef> result = client.listDiscoverableServices();\n \n-            assertThat(\n-                    result,\n-                    Matchers.contains(\n-                            new ServiceRef(\"ServiceA.local\", 123),\n-                            new ServiceRef(\"ServiceA.local\", 456),\n-                            new ServiceRef(\"b-service.example.com\", 7899)));\n+            ServiceRef serv1;\n+            ServiceRef serv2;\n+            ServiceRef serv3;\n+            try {\n+                serv1 = new ServiceRef(\"127.0.0.1\", 123, \"ServiceA.local\");\n+                serv2 = new ServiceRef(\"127.0.0.1\", 456, \"ServiceA.local\");\n+                serv3 = new ServiceRef(\"10.0.0.1\", 7899, \"b-service.example.com\");\n+            } catch (Exception e) {\n+                serv1 = null;\n+                serv2 = null;\n+                serv3 = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODc2Mw==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208763", "bodyText": "Here too", "author": "andrewazores", "createdAt": "2020-07-27T22:34:35Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeApiPlatformClientTest.java", "diffHunk": "@@ -211,11 +220,16 @@ void ignoresUnresolveableServices() throws ApiException, UnknownHostException {\n \n             List<ServiceRef> result = client.listDiscoverableServices();\n \n-            assertThat(\n-                    result,\n-                    Matchers.contains(\n-                            new ServiceRef(\"ServiceA.local\", 123),\n-                            new ServiceRef(\"ServiceA.local\", 456)));\n+            ServiceRef serv1;\n+            ServiceRef serv2;\n+            try {\n+                serv1 = new ServiceRef(\"127.0.0.1\", 123, \"ServiceA.local\");\n+                serv2 = new ServiceRef(\"127.0.0.1\", 456, \"ServiceA.local\");\n+            } catch (Exception e) {\n+                serv1 = null;\n+                serv2 = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODg3Mg==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208872", "bodyText": "And here", "author": "andrewazores", "createdAt": "2020-07-27T22:34:51Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/platform/internal/KubeEnvPlatformClientTest.java", "diffHunk": "@@ -97,11 +99,18 @@ void shouldDiscoverServicesByEnv() {\n                                     \"BAR_PORT_9999_TCP_ADDR\", \"1.2.3.4\",\n                                     \"BAZ_PORT_9876_UDP_ADDR\", \"5.6.7.8\"));\n             List<ServiceRef> services = client.listDiscoverableServices();\n-            MatcherAssert.assertThat(\n-                    services,\n-                    Matchers.containsInAnyOrder(\n-                            new ServiceRef(\"127.0.0.1\", \"foo\", 1234),\n-                            new ServiceRef(\"1.2.3.4\", \"bar\", 9999)));\n+\n+            ServiceRef serv1;\n+            ServiceRef serv2;\n+            try {\n+                serv1 = new ServiceRef(\"127.0.0.1\", 1234, \"foo\");\n+                serv2 = new ServiceRef(\"1.2.3.4\", 9999, \"bar\");\n+            } catch (Exception e) {\n+                serv1 = null;\n+                serv2 = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODk1Ng==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r461208956", "bodyText": "And finally, here :-)", "author": "andrewazores", "createdAt": "2020-07-27T22:35:02Z", "path": "src/test/java/com/redhat/rhjmc/containerjfr/platform/openshift/OpenShiftPlatformClientTest.java", "diffHunk": "@@ -173,23 +173,26 @@ void shouldReturnListOfMatchingEndpointRefs() throws Exception {\n         Mockito.when(mockListable.getItems()).thenReturn(Collections.singletonList(endpoint));\n \n         List<ServiceRef> result = platformClient.listDiscoverableServices();\n+        ServiceRef serv1;\n+        ServiceRef serv2;\n+        ServiceRef serv3;\n+        try {\n+            serv1 =\n+                    new ServiceRef(\n+                            address2.getIp(), port2.getPort(), address2.getTargetRef().getName());\n+            serv2 =\n+                    new ServiceRef(\n+                            address3.getIp(), port2.getPort(), address3.getTargetRef().getName());\n+            serv3 =\n+                    new ServiceRef(\n+                            address4.getIp(), port3.getPort(), address4.getTargetRef().getName());\n+        } catch (Exception e) {\n+            serv1 = null;\n+            serv2 = null;\n+            serv3 = null;", "originalCommit": "12e13648c625312a6deac9be90397b2e2c98e6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f6a16452a44b586b62aa9eace0edabb70b8cf076", "url": "https://github.com/cryostatio/cryostat/commit/f6a16452a44b586b62aa9eace0edabb70b8cf076", "message": "Unify API responses by only having JMX service URLs. Remove port var from serviceRef", "committedDate": "2020-07-28T21:22:25Z", "type": "commit"}, {"oid": "edf9752489e5c6fc7b50fac3b7e15d0db0286aa8", "url": "https://github.com/cryostatio/cryostat/commit/edf9752489e5c6fc7b50fac3b7e15d0db0286aa8", "message": "modify serviceRef constructors to accept JMX urls, and modify platform clients accordingly", "committedDate": "2020-07-28T21:28:18Z", "type": "commit"}, {"oid": "05ceb2d564ae3878eb88ac5dcde4ffff97378f5b", "url": "https://github.com/cryostatio/cryostat/commit/05ceb2d564ae3878eb88ac5dcde4ffff97378f5b", "message": "Modify order of paramters in some serviceRef constructors, remove logger parameter from listDiscoverableServices()", "committedDate": "2020-07-28T21:30:57Z", "type": "commit"}, {"oid": "7d7937a8fd31db2a448db0d298b0d69aaae74abb", "url": "https://github.com/cryostatio/cryostat/commit/7d7937a8fd31db2a448db0d298b0d69aaae74abb", "message": "minor fixes, change order of serviceRef constructors, filter out null objects in openShiftPlatformClient", "committedDate": "2020-07-28T21:31:02Z", "type": "commit"}, {"oid": "0088925725a2a363d75854f52b9ef91ede916959", "url": "https://github.com/cryostatio/cryostat/commit/0088925725a2a363d75854f52b9ef91ede916959", "message": "add resolveCanonicalHostName as alias of serviceRef, in KubeApiPlatformClient", "committedDate": "2020-07-28T21:31:02Z", "type": "commit"}, {"oid": "394b7fe3bc2df733a43307dc36ce6e375154a696", "url": "https://github.com/cryostatio/cryostat/commit/394b7fe3bc2df733a43307dc36ce6e375154a696", "message": "Update tests to work with new serviceRef constructors", "committedDate": "2020-07-28T21:31:54Z", "type": "commit"}, {"oid": "c574d3f48e5e7dca97188deb8c6d232ae76bbecb", "url": "https://github.com/cryostatio/cryostat/commit/c574d3f48e5e7dca97188deb8c6d232ae76bbecb", "message": "Add custom Gson adapter for JMXServiceURLs", "committedDate": "2020-07-28T21:31:59Z", "type": "commit"}, {"oid": "3ca7c07a2a1262dace66e55ab88b26ea2c31d810", "url": "https://github.com/cryostatio/cryostat/commit/3ca7c07a2a1262dace66e55ab88b26ea2c31d810", "message": "Change api response to closely follow previous format", "committedDate": "2020-07-28T21:31:59Z", "type": "commit"}, {"oid": "e007042470650f2816163ec290e7ea6f1107fde5", "url": "https://github.com/cryostatio/cryostat/commit/e007042470650f2816163ec290e7ea6f1107fde5", "message": "fix basicCommandChannelIT test", "committedDate": "2020-07-28T21:32:48Z", "type": "commit"}, {"oid": "75897fb1a52300b508f987e3fb127fc6a3251716", "url": "https://github.com/cryostatio/cryostat/commit/75897fb1a52300b508f987e3fb127fc6a3251716", "message": "minor changes to tests and add logger to custom jmx url adapter", "committedDate": "2020-07-28T21:32:56Z", "type": "commit"}, {"oid": "8431b6af09f02529a26951d899531befcc46a698", "url": "https://github.com/cryostatio/cryostat/commit/8431b6af09f02529a26951d899531befcc46a698", "message": "apply spotless", "committedDate": "2020-07-28T21:32:56Z", "type": "commit"}, {"oid": "3d03a80820053a5a52318055befe6fa312988b23", "url": "https://github.com/cryostatio/cryostat/commit/3d03a80820053a5a52318055befe6fa312988b23", "message": "fix logger problem (incorrect injection)", "committedDate": "2020-07-28T21:32:56Z", "type": "commit"}, {"oid": "ee2cb5e892aadfaafcda6d518599e2e78867b3bf", "url": "https://github.com/cryostatio/cryostat/commit/ee2cb5e892aadfaafcda6d518599e2e78867b3bf", "message": "fix integration test", "committedDate": "2020-07-29T19:49:24Z", "type": "commit"}, {"oid": "ee2cb5e892aadfaafcda6d518599e2e78867b3bf", "url": "https://github.com/cryostatio/cryostat/commit/ee2cb5e892aadfaafcda6d518599e2e78867b3bf", "message": "fix integration test", "committedDate": "2020-07-29T19:49:24Z", "type": "forcePushed"}, {"oid": "34e2f7040ef835688c34d9f21a9fac7c55d68e92", "url": "https://github.com/cryostatio/cryostat/commit/34e2f7040ef835688c34d9f21a9fac7c55d68e92", "message": "modify jmx service url protocol to rmi", "committedDate": "2020-08-04T14:36:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxMzQxNA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r465913414", "bodyText": "Ah, tiny nitpick here - your format specifier has two %s tokens, but you pass in a string (%s) and an int (%d). This will still work because casting the port to a string still comes out the same in the formatted string, but I think it's still worth correcting.", "author": "andrewazores", "createdAt": "2020-08-05T18:14:03Z", "path": "src/main/java/com/redhat/rhjmc/containerjfr/platform/ServiceRef.java", "diffHunk": "@@ -41,36 +41,45 @@\n  */\n package com.redhat.rhjmc.containerjfr.platform;\n \n+import java.net.MalformedURLException;\n+import java.util.Optional;\n+\n+import javax.management.remote.JMXServiceURL;\n+\n import org.apache.commons.lang.builder.EqualsBuilder;\n import org.apache.commons.lang.builder.HashCodeBuilder;\n import org.apache.commons.lang3.builder.ToStringBuilder;\n+import com.google.gson.annotations.SerializedName;\n \n public class ServiceRef {\n \n-    private final String connectUrl;\n-    private final String alias;\n-    private final int port;\n+    @SerializedName(\"connectUrl\")\n+    private final JMXServiceURL JMXServiceURL;\n \n-    public ServiceRef(String connectUrl, int port) {\n-        this(connectUrl, connectUrl, port);\n-    }\n+    private final String alias; // nullable\n \n-    public ServiceRef(String connectUrl, String alias, int port) {\n-        this.connectUrl = connectUrl;\n+    public ServiceRef(JMXServiceURL jmxServiceUrl, String alias) throws MalformedURLException {\n+        this.JMXServiceURL = jmxServiceUrl;\n         this.alias = alias;\n-        this.port = port;\n     }\n \n-    public String getConnectUrl() {\n-        return connectUrl;\n+    public ServiceRef(JMXServiceURL jmxServiceUrl) throws MalformedURLException {\n+        this(jmxServiceUrl, null);\n+    }\n+\n+    public ServiceRef(String host, int port, String alias) throws MalformedURLException {\n+        this(\n+                new JMXServiceURL(\n+                        \"rmi\", \"\", 0, String.format(\"/jndi/rmi://%s:%s/jmxrmi\", host, port)),", "originalCommit": "34e2f7040ef835688c34d9f21a9fac7c55d68e92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxOTM5MA==", "url": "https://github.com/cryostatio/cryostat/pull/215#discussion_r465919390", "bodyText": "Ah true, Ill fix it!", "author": "Alexjsenn", "createdAt": "2020-08-05T18:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxMzQxNA=="}], "type": "inlineReview"}, {"oid": "a3d31b73cf33422f8ae40bdb3d4b5a2ad761d89c", "url": "https://github.com/cryostatio/cryostat/commit/a3d31b73cf33422f8ae40bdb3d4b5a2ad761d89c", "message": "modify string formatting in serviceRef", "committedDate": "2020-08-05T18:50:39Z", "type": "commit"}]}