{"pr_number": 4156, "pr_title": "Don't attempt to stop location updates if GoogleAPIClient is not already connected", "pr_createdAt": "2020-10-07T11:19:13Z", "pr_url": "https://github.com/getodk/collect/pull/4156", "timeline": [{"oid": "a3aea167792492b2e3e43ea80d51c5614f29df72", "url": "https://github.com/getodk/collect/commit/a3aea167792492b2e3e43ea80d51c5614f29df72", "message": "Fixed bugs in GoogleFusedLocationClient", "committedDate": "2020-10-07T11:06:31Z", "type": "commit"}, {"oid": "33228e2a7e483668900cb6f63b018c802636ec01", "url": "https://github.com/getodk/collect/commit/33228e2a7e483668900cb6f63b018c802636ec01", "message": "Added tests", "committedDate": "2020-10-07T11:06:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r500932725", "bodyText": "This is a fix for another issue https://console.firebase.google.com/u/0/project/api-project-322300403941/crashlytics/app/android:org.odk.collect.android/issues/8bf1ac2f771699358e0237615316760d?time=last-seven-days&versions=v1.28.1%20(3923)&sessionEventKey=5F7C02C1035300012FE4B899DA981953_1458846445087682870", "author": "grzesiek2010", "createdAt": "2020-10-07T11:20:06Z", "path": "collect_app/src/main/java/org/odk/collect/android/location/client/GoogleFusedLocationClient.java", "diffHunk": "@@ -141,7 +141,7 @@ public void stopLocationUpdates() {\n     public Location getLastLocation() {\n         // We need to block if the Client isn't already connected:\n         if (!googleApiClient.isConnected()) {\n-            googleApiClient.blockingConnect();\n+            new Thread(googleApiClient::blockingConnect).start();", "originalCommit": "33228e2a7e483668900cb6f63b018c802636ec01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3MTE0OQ==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r500971149", "bodyText": "I'm a little concerned about this. If the client isn't connected, and we spin up a new thread to connect could that cause problems for the call to getLastLocation (as it might happen before the client is connected)?\nAlso, it's likely the testing of this in GoogleFusedLocationClientTest (using a timeout) will be flakey as the call to blockingConnect is now async (and make the behaviour of the method indeterminate).\nCould we maybe pull this fix out of the PR and look at it as a part of a different PR?", "author": "seadowg", "createdAt": "2020-10-07T12:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NTg0NA==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r500975844", "bodyText": "I tested it hardcoding googleApiClient.disconnect(); just before if (!googleApiClient.isConnected()) { and it didn't cause any crashes. @lognaturel what do you think should we exclude this fix?", "author": "grzesiek2010", "createdAt": "2020-10-07T12:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMTA2Mw==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501131063", "bodyText": "If we can't block the UI thread, then this code structure doesn't makes sense. That is, like @seadowg says, if you're doing it in a different thread, that thread is blocked, but you still attempt to getLastLocation on the UI thread which could fail if the connection isn't instant. I think you could use CoroutineAndWorkManagerScheduler.immediate(background, foreground). Splitting it off to another PR sounds best to me.", "author": "lognaturel", "createdAt": "2020-10-07T16:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNjAyNA==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501306024", "bodyText": "Ok I revoked that change.", "author": "grzesiek2010", "createdAt": "2020-10-07T20:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMjcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExODQ3Mw==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501118473", "bodyText": "I think it's possible for a locationListener to be set and googleApiClient not to be connected. In that case, locationListener would not be set to null. I think that's not a good state to be in. Just to be safe, I'd wrap only the removeLocationUpdates call.", "author": "lognaturel", "createdAt": "2020-10-07T15:45:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/location/client/GoogleFusedLocationClient.java", "diffHunk": "@@ -120,15 +120,15 @@ public void stop() {\n \n     @SuppressLint(\"MissingPermission\") // Permission checks for location services handled in widgets\n     public void requestLocationUpdates(@NonNull LocationListener locationListener) {\n-        if (!isMonitoringLocation()) {\n+        if (!isMonitoringLocation() && googleApiClient.isConnected()) {\n             fusedLocationProviderApi.requestLocationUpdates(googleApiClient, createLocationRequest(), this);\n         }\n \n         this.locationListener = locationListener;\n     }\n \n     public void stopLocationUpdates() {\n-        if (!isMonitoringLocation()) {\n+        if (!isMonitoringLocation() || !googleApiClient.isConnected()) {", "originalCommit": "a3aea167792492b2e3e43ea80d51c5614f29df72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEyMjk4Nw==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501122987", "bodyText": "Ah you mean that locationListener won't be cleared in such a case?", "author": "grzesiek2010", "createdAt": "2020-10-07T15:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE1MjYwNQ==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501152605", "bodyText": "Whoops, missed this. Yes, exactly. That means isMonitoringLocation() would evaluate to true even after stopLocationUpdates has been called. I don't know if that really matters currently because I think we only stopLocationUpdates when we're closing out activities but I'd rather not risk it.", "author": "lognaturel", "createdAt": "2020-10-07T16:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNTY4OQ==", "url": "https://github.com/getodk/collect/pull/4156#discussion_r501305689", "bodyText": "Fixed.", "author": "grzesiek2010", "createdAt": "2020-10-07T20:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExODQ3Mw=="}], "type": "inlineReview"}, {"oid": "821915f497935503ed1c07f6c805e5b21db42e67", "url": "https://github.com/getodk/collect/commit/821915f497935503ed1c07f6c805e5b21db42e67", "message": "Improvements", "committedDate": "2020-10-07T20:56:56Z", "type": "commit"}, {"oid": "821915f497935503ed1c07f6c805e5b21db42e67", "url": "https://github.com/getodk/collect/commit/821915f497935503ed1c07f6c805e5b21db42e67", "message": "Improvements", "committedDate": "2020-10-07T20:56:56Z", "type": "forcePushed"}]}