{"pr_number": 3997, "pr_title": "Make sure Automatic Download setting makes sense for Form Update mode", "pr_createdAt": "2020-07-30T13:52:28Z", "pr_url": "https://github.com/getodk/collect/pull/3997", "timeline": [{"oid": "65ce012e6f0c823fde77935ba33d4e7984d48d55", "url": "https://github.com/getodk/collect/commit/65ce012e6f0c823fde77935ba33d4e7984d48d55", "message": "Shared settings change handler between prefs framework and importer", "committedDate": "2020-08-03T10:48:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1Nzk4MA==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r464657980", "bodyText": "How very American.", "author": "lognaturel", "createdAt": "2020-08-03T20:56:58Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/ServerSettingsTest.java", "diffHunk": "@@ -90,4 +75,14 @@ public void selectingGoogleAccount_showsGoogleAccountSettings() {\n                 .assertText(R.string.selected_google_account_text)\n                 .assertText(R.string.google_sheets_url);\n     }\n+\n+    @Test\n+    public void selectingGoogleAccount_disablesAutomaticUpdates() {\n+        MainMenuPage mainMenu = new MainMenuPage(rule).assertOnPage()\n+                .enablePreviouslyDownloadedOnlyUpdates();\n+        assertThat(testDependencies.scheduler.getDeferredTasks().size(), is(1));\n+\n+        mainMenu.setGoogleDriveAccount(\"steph@curry.basket\");", "originalCommit": "65ce012e6f0c823fde77935ba33d4e7984d48d55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3MzA2NQ==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r464873065", "bodyText": "Heh. I'm enjoying the NBA restart but missing my team.", "author": "seadowg", "createdAt": "2020-08-04T08:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1Nzk4MA=="}], "type": "inlineReview"}, {"oid": "416827bad171f5baea5b697b7e3f05a7ded62e63", "url": "https://github.com/getodk/collect/commit/416827bad171f5baea5b697b7e3f05a7ded62e63", "message": "Make sure background work isn't scheduled every time a pref changes", "committedDate": "2020-08-04T16:16:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NzQzMQ==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465187431", "bodyText": "Iterating through ALL the keys is future proofing really but it felt weird for SettingsImporter to just pass one through knowing it would do the right thing.", "author": "seadowg", "createdAt": "2020-08-04T16:45:10Z", "path": "collect_app/src/main/java/org/odk/collect/android/configure/SettingsImporter.java", "diffHunk": "@@ -62,7 +62,13 @@ public boolean fromJSON(@NonNull String json) {\n         loadDefaults(generalSharedPrefs, generalDefaults);\n         loadDefaults(adminSharedPrefs, adminDefaults);\n \n-        settingsChangedHandler.onSettingsChanged();\n+        for (String key: generalSharedPrefs.getAll().keySet()) {", "originalCommit": "416827bad171f5baea5b697b7e3f05a7ded62e63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyOTQ2Ng==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465329466", "bodyText": "One weirdness about this is that the behavior will be different depending on how the form update settings are ordered relative to the server URL and credential settings in the key set. Perhaps this can be considered at the same time as #4011.", "author": "lognaturel", "createdAt": "2020-08-04T21:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4NzQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMzQyMw==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465323423", "bodyText": "This is where I was getting confused when we were talking about the most recent changes. I think the split you're making is things that need to happen any time that a preference is updated even if the user is not anywhere near preferences in the app go to the custom handler which is always called by the base preference fragment. On the other hand, changes that only need to happen if the user is sitting in preferences at the moment are locally handled. Typically it would just be inline like with guidance hints but in this case since there are two keys that do the same thing, that ends up in onSharedPreferenceChanged. Does that sound right? I probably would have introduced a method to wrap the work that happens when either KEY_FORM_UPDATE_MODE or KEY_PERIODIC_FORM_UPDATES_CHECK changes and also defined handlers for those inline to avoid overriding onSharedPreferenceChanged but this is ok too.\nNow that this structure is in place, I think there are things we should move from inline handlers to CollectSettingsChangeHandler like sending an analytics event for a server URL change, for example. Something to file an issue for v1.29 about?", "author": "lognaturel", "createdAt": "2020-08-04T20:52:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -77,40 +84,59 @@ public void onCreate(Bundle savedInstanceState) {\n         setupFormUpdateMode();\n     }\n \n+    @Override\n+    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {\n+        super.onSharedPreferenceChanged(sharedPreferences, key);\n+\n+        if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {", "originalCommit": "416827bad171f5baea5b697b7e3f05a7ded62e63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4MTExOA==", "url": "https://github.com/getodk/collect/pull/3997#discussion_r465581118", "bodyText": "Yeah I think we could use this for a lot more. Analytics is a great shout as it would let us capture more from the imports. I'd like to take a proper pass over some of these preference screens again as I was avoiding too many changes due to the AndroidX stuff being in flight. I'll add a note to my project backlog.\nAs to the split feeling a little weird: I agree. It might be that local changes like that are just better handles using the individual preference listeners.", "author": "seadowg", "createdAt": "2020-08-05T09:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMzQyMw=="}], "type": "inlineReview"}, {"oid": "e7baf4f139bb425f1271e5b14cb081bdf3c92785", "url": "https://github.com/getodk/collect/commit/e7baf4f139bb425f1271e5b14cb081bdf3c92785", "message": "Move prefs testing to fragment", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "ce7c15eb8984ce1a02777a9a5f5bb281a386dc42", "url": "https://github.com/getodk/collect/commit/ce7c15eb8984ce1a02777a9a5f5bb281a386dc42", "message": "Make sure automatic download updates with form mode updates", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "bc963bc183d11a6619211267572959c2b4701542", "url": "https://github.com/getodk/collect/commit/bc963bc183d11a6619211267572959c2b4701542", "message": "Use AndroidX lifecycle in prefs fragments", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "d103d829a842951e2d2a69990964de3d67131057", "url": "https://github.com/getodk/collect/commit/d103d829a842951e2d2a69990964de3d67131057", "message": "Make sure switching to google drive disables updates", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "73bfa978734e60613372b53c054b3a877c141cf8", "url": "https://github.com/getodk/collect/commit/73bfa978734e60613372b53c054b3a877c141cf8", "message": "Shared settings change handler between prefs framework and importer", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "2190cea588835b1cc9e9ff921232dc2e64c06160", "url": "https://github.com/getodk/collect/commit/2190cea588835b1cc9e9ff921232dc2e64c06160", "message": "Make sure background work isn't scheduled every time a pref changes", "committedDate": "2020-08-05T16:30:34Z", "type": "commit"}, {"oid": "2190cea588835b1cc9e9ff921232dc2e64c06160", "url": "https://github.com/getodk/collect/commit/2190cea588835b1cc9e9ff921232dc2e64c06160", "message": "Make sure background work isn't scheduled every time a pref changes", "committedDate": "2020-08-05T16:30:34Z", "type": "forcePushed"}]}