{"pr_number": 4320, "pr_title": "Catch exceptions that might take place during opening uris", "pr_createdAt": "2020-12-16T21:24:06Z", "pr_url": "https://github.com/getodk/collect/pull/4320", "timeline": [{"oid": "4b65141ab6e9e07ff697af990dedec623872491f", "url": "https://github.com/getodk/collect/commit/4b65141ab6e9e07ff697af990dedec623872491f", "message": "Catch exceptions that might take place during opening uris", "committedDate": "2020-12-16T21:04:50Z", "type": "commit"}, {"oid": "d2e9e073628a26179d2bb1856e01ded66f55205d", "url": "https://github.com/getodk/collect/commit/d2e9e073628a26179d2bb1856e01ded66f55205d", "message": "Normalize uri before using it", "committedDate": "2020-12-16T21:45:05Z", "type": "commit"}, {"oid": "4554e198affbe9c926941557a96c337026c8f3b3", "url": "https://github.com/getodk/collect/commit/4554e198affbe9c926941557a96c337026c8f3b3", "message": "Added tests", "committedDate": "2020-12-16T22:06:00Z", "type": "commit"}, {"oid": "4d4dde37e52d037c1834b2dd4a9479dc5da7cfb3", "url": "https://github.com/getodk/collect/commit/4d4dde37e52d037c1834b2dd4a9479dc5da7cfb3", "message": "Fixed code style", "committedDate": "2020-12-16T22:06:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA3MDYxNg==", "url": "https://github.com/getodk/collect/pull/4320#discussion_r545070616", "bodyText": "Don't think this needs to extend TestCase.", "author": "seadowg", "createdAt": "2020-12-17T12:58:33Z", "path": "collect_app/src/test/java/org/odk/collect/android/utilities/CustomTabHelperTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package org.odk.collect.android.utilities;\n+\n+import android.net.Uri;\n+\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import junit.framework.TestCase;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class CustomTabHelperTest extends TestCase {", "originalCommit": "4d4dde37e52d037c1834b2dd4a9479dc5da7cfb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5MzY1NA==", "url": "https://github.com/getodk/collect/pull/4320#discussion_r545093654", "bodyText": "Right, I generated the test class and it was added automatically. Fixed.", "author": "grzesiek2010", "createdAt": "2020-12-17T13:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA3MDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4NDQ0MQ==", "url": "https://github.com/getodk/collect/pull/4320#discussion_r545084441", "bodyText": "This verifies that normalizedScheme() is called but there's no guarantee that we'll use the result of that call in our ACTION_VIEW intent. So here I could change uri = uri.normalizeScheme(); in CustomTabHelper to just uri.normalizeScheme(); and the test would still pass.\nWe could test this without the spy by passing in a Uri that would get normalized (like HTTP://www.android.com) and then verifying that we see a normalized version in the resulting intent (using shadowOf(application).getNextStartedActivity()). The complexity here is that we'd need to have the openUriInChromeTabs route fail, so we fall through into the path we want to check. For this we'd need to pull out a component to represent that we could set up to fail.\nThat all seems like a lot of work, but I'd generally say that if something is hard to test it's a sign it needs rework. I'm also not clear on what's happening with the Chrome tab stuff here and why we're doing it.\nAll that said this is a crash fix, so it'd be nice to get into the release, so I don't want my pretentiousness to get in the way too much \ud83d\ude09. Maybe we open another PR for the test, and we can discuss/tweak there?", "author": "seadowg", "createdAt": "2020-12-17T13:20:54Z", "path": "collect_app/src/test/java/org/odk/collect/android/utilities/CustomTabHelperTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package org.odk.collect.android.utilities;\n+\n+import android.net.Uri;\n+\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import junit.framework.TestCase;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class CustomTabHelperTest extends TestCase {\n+\n+    @Test\n+    public void uriShouldBeNormalized() {\n+        CustomTabHelper customTabHelper = spy(new CustomTabHelper());\n+        doNothing().when(customTabHelper).openUriInChromeTabs(any(), any());\n+        doNothing().when(customTabHelper).openUriInWebView(any(), any());\n+        doNothing().when(customTabHelper).openUriInExternalBrowser(any(), any());\n+\n+        Uri uri = mock(Uri.class);\n+        customTabHelper.openUri(ApplicationProvider.getApplicationContext(), uri);\n+        verify(uri).normalizeScheme();", "originalCommit": "4d4dde37e52d037c1834b2dd4a9479dc5da7cfb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5NjE5Ng==", "url": "https://github.com/getodk/collect/pull/4320#discussion_r545096196", "bodyText": "Right it's a silly test but yeah maybe we can improve it later in a separate pr.", "author": "grzesiek2010", "createdAt": "2020-12-17T13:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4NDQ0MQ=="}], "type": "inlineReview"}, {"oid": "5e34c36726c7412ad25359df3bb0688d228dfdc7", "url": "https://github.com/getodk/collect/commit/5e34c36726c7412ad25359df3bb0688d228dfdc7", "message": "Do not extend TestCase in CustomTabHelperTest", "committedDate": "2020-12-17T13:34:47Z", "type": "commit"}]}