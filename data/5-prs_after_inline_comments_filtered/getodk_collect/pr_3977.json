{"pr_number": 3977, "pr_title": "Revise Form Management for Match Exactly", "pr_createdAt": "2020-07-21T10:20:07Z", "pr_url": "https://github.com/getodk/collect/pull/3977", "timeline": [{"oid": "956b6e9bd6887e78e41d086cd1b29b76297f4dd3", "url": "https://github.com/getodk/collect/commit/956b6e9bd6887e78e41d086cd1b29b76297f4dd3", "message": "Seperate out core flow smoke test from ServerSettingsTest", "committedDate": "2020-07-21T10:15:25Z", "type": "commit"}, {"oid": "180b9894c438b551d268576ddce0c6e02e2ea9aa", "url": "https://github.com/getodk/collect/commit/180b9894c438b551d268576ddce0c6e02e2ea9aa", "message": "Add failing tests for setting up manual mode", "committedDate": "2020-07-21T10:15:25Z", "type": "commit"}, {"oid": "a478157d0aef9f160af9e33b5e0f6c287701bc84", "url": "https://github.com/getodk/collect/commit/a478157d0aef9f160af9e33b5e0f6c287701bc84", "message": "Add manual update forms mode", "committedDate": "2020-07-21T10:15:25Z", "type": "commit"}, {"oid": "342dd5c8d72ad83c4dba9d7a401c66ab48048f68", "url": "https://github.com/getodk/collect/commit/342dd5c8d72ad83c4dba9d7a401c66ab48048f68", "message": "Add initial tests for previously downloaded mode", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "24a556f48c440aebae949c9e217cfbe6e97c27a7", "url": "https://github.com/getodk/collect/commit/24a556f48c440aebae949c9e217cfbe6e97c27a7", "message": "Use form update setting to enable match exactly", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "19283f41d6b2f1877bbc8ff37560d0eb13f90e28", "url": "https://github.com/getodk/collect/commit/19283f41d6b2f1877bbc8ff37560d0eb13f90e28", "message": "Rename Scheduler methods based on Android docs", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "cbb187b4e3010369eb02be1a03afc9f5db73b7f9", "url": "https://github.com/getodk/collect/commit/cbb187b4e3010369eb02be1a03afc9f5db73b7f9", "message": "Allow match exactly frequency to be customized", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "eb598da652c87f904d900e9012a944ae8877246a", "url": "https://github.com/getodk/collect/commit/eb598da652c87f904d900e9012a944ae8877246a", "message": "Make sure correct settings are enabled for manual form update mode", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "4789ecd281f209280576917a69be3e9d44cb3569", "url": "https://github.com/getodk/collect/commit/4789ecd281f209280576917a69be3e9d44cb3569", "message": "Make sure correct prefs show when previously downloaded enabled", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "c11f7ba390304d4326df9153ed550be05feabe7d", "url": "https://github.com/getodk/collect/commit/c11f7ba390304d4326df9153ed550be05feabe7d", "message": "Use Scheduler for auto update work", "committedDate": "2020-07-21T10:15:26Z", "type": "commit"}, {"oid": "efd288ff8f45d15954a4b0b48cffcca230ef7398", "url": "https://github.com/getodk/collect/commit/efd288ff8f45d15954a4b0b48cffcca230ef7398", "message": "Fix concurrent modification exception in ServerPollingJob", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "9e3c3c02c14f710a19c70bd579f6fb88aa7f425d", "url": "https://github.com/getodk/collect/commit/9e3c3c02c14f710a19c70bd579f6fb88aa7f425d", "message": "Introduce rule for notification drawer", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "62d584c17313bd7eb039b7e0683af36a25f919c6", "url": "https://github.com/getodk/collect/commit/62d584c17313bd7eb039b7e0683af36a25f919c6", "message": "Allow setting auto update frequency", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "1dfac443ae0a93247ee6aa94b1c34d64a7de9672", "url": "https://github.com/getodk/collect/commit/1dfac443ae0a93247ee6aa94b1c34d64a7de9672", "message": "Add test for auto download", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "eb83360a4576ca4066869a15cada45a16f0e8675", "url": "https://github.com/getodk/collect/commit/eb83360a4576ca4066869a15cada45a16f0e8675", "message": "Make it easier to set up standard test deps", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "13eda1c080f3c0fed7a5fdd69635ebeb32297e48", "url": "https://github.com/getodk/collect/commit/13eda1c080f3c0fed7a5fdd69635ebeb32297e48", "message": "Optimize imports", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "ccf83f4c7e54ad08c7b633e16ec23c35d921bd2a", "url": "https://github.com/getodk/collect/commit/ccf83f4c7e54ad08c7b633e16ec23c35d921bd2a", "message": "Fix notification tests on devices without CLEAR ALL button", "committedDate": "2020-07-21T10:15:27Z", "type": "commit"}, {"oid": "63b435ee7f58191030af5db0a3c468c0c708e516", "url": "https://github.com/getodk/collect/commit/63b435ee7f58191030af5db0a3c468c0c708e516", "message": "Add enum for form update mode", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "6b15195dfbaf4143981fd73a0b9557f7b01a32dc", "url": "https://github.com/getodk/collect/commit/6b15195dfbaf4143981fd73a0b9557f7b01a32dc", "message": "Delete unused strings", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "6d746d46114011a1789985191bb3d5d1ba0f467f", "url": "https://github.com/getodk/collect/commit/6d746d46114011a1789985191bb3d5d1ba0f467f", "message": "Remove Evernote Job framework", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "302c9146d7784c6e5f14d6a4aeb12d8d64aa0e33", "url": "https://github.com/getodk/collect/commit/302c9146d7784c6e5f14d6a4aeb12d8d64aa0e33", "message": "Make sure disabling previously downloaded cancels background work", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "b4fd5d3ea7274b4b96fe23edcbb3f42a4960fc2c", "url": "https://github.com/getodk/collect/commit/b4fd5d3ea7274b4b96fe23edcbb3f42a4960fc2c", "message": "Rework ServerPollingJob to be TaskSpec", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "b9f8858a625705c06c8c309af34d7c6af0ac749a", "url": "https://github.com/getodk/collect/commit/b9f8858a625705c06c8c309af34d7c6af0ac749a", "message": "Isolate FormsDao interactions to inner repository class in AutoUpdateTaskSpec", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "728833186e93fa219f7a288d508b18c3e7c1bdff", "url": "https://github.com/getodk/collect/commit/728833186e93fa219f7a288d508b18c3e7c1bdff", "message": "Pull dependency construction out of AutoUpdateTaskSpec as much as possible", "committedDate": "2020-07-21T10:15:28Z", "type": "commit"}, {"oid": "23206a6f9da5cac4fd277969b7722345d1cc07df", "url": "https://github.com/getodk/collect/commit/23206a6f9da5cac4fd277969b7722345d1cc07df", "message": "Extract method object for notifying fo form updates", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "5004e12b51f7d6b1480429ef6568872932889ff2", "url": "https://github.com/getodk/collect/commit/5004e12b51f7d6b1480429ef6568872932889ff2", "message": "Extract notifier from task spec", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "455f0b0adc33a7a6c107c5ed35d3e344764ac1a6", "url": "https://github.com/getodk/collect/commit/455f0b0adc33a7a6c107c5ed35d3e344764ac1a6", "message": "Move auto download logic out of use case", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "410d53312d0dd4fa865b1879553f7efc62226e88", "url": "https://github.com/getodk/collect/commit/410d53312d0dd4fa865b1879553f7efc62226e88", "message": "Use FormRepository instead of NotificationRepository", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "6d0421dc70abd4084096d2a13204750b1284d536", "url": "https://github.com/getodk/collect/commit/6d0421dc70abd4084096d2a13204750b1284d536", "message": "Add tests for ServerFormUpdatesChecker", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "e538bda4bfc576b1f904af35da70db9109e8ccc2", "url": "https://github.com/getodk/collect/commit/e538bda4bfc576b1f904af35da70db9109e8ccc2", "message": "Revise migrator interface", "committedDate": "2020-07-21T10:15:29Z", "type": "commit"}, {"oid": "ff6c3bab1d55345788cbdaa1cb69e9efe0179414", "url": "https://github.com/getodk/collect/commit/ff6c3bab1d55345788cbdaa1cb69e9efe0179414", "message": "Add migration for previously downloaded settings", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "5a3fe7bb7e820e1051a8a08119d29382fe87466b", "url": "https://github.com/getodk/collect/commit/5a3fe7bb7e820e1051a8a08119d29382fe87466b", "message": "Create new migration type", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "121497dcba57a5d0f73f6348e0e3b481caefa6fa", "url": "https://github.com/getodk/collect/commit/121497dcba57a5d0f73f6348e0e3b481caefa6fa", "message": "Make sure key extractor migration works properly on second run", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "54eea3c2f4b6fbf26125fe7be3e85d921833717e", "url": "https://github.com/getodk/collect/commit/54eea3c2f4b6fbf26125fe7be3e85d921833717e", "message": "Set manual form update mode for Google Drive users on upgrade", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "82a1f91077344ccd74021ae10c44955e40bb4660", "url": "https://github.com/getodk/collect/commit/82a1f91077344ccd74021ae10c44955e40bb4660", "message": "Set form update mode to manual when switching to Google Drive", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "247211b7a1ed6e2989f431c2aa655f636f9fe525", "url": "https://github.com/getodk/collect/commit/247211b7a1ed6e2989f431c2aa655f636f9fe525", "message": "Hide form mode setting when disabled by admin", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "bf412f27a8480250fe371f237dd7290e06ebedcc", "url": "https://github.com/getodk/collect/commit/bf412f27a8480250fe371f237dd7290e06ebedcc", "message": "Make enums representing arrays consistent", "committedDate": "2020-07-21T10:15:30Z", "type": "commit"}, {"oid": "b056529c05c1916185cd0437616b9544b4b9ac7e", "url": "https://github.com/getodk/collect/commit/b056529c05c1916185cd0437616b9544b4b9ac7e", "message": "make sure background work is setup when settings are imported", "committedDate": "2020-07-21T10:15:31Z", "type": "commit"}, {"oid": "578158fbcab108a6e71953a234d29eb538cf4c3b", "url": "https://github.com/getodk/collect/commit/578158fbcab108a6e71953a234d29eb538cf4c3b", "message": "Revise interface around background work", "committedDate": "2020-07-21T10:15:31Z", "type": "commit"}, {"oid": "5d18746a455a48c3dd960f40bf186b79d10e72ff", "url": "https://github.com/getodk/collect/commit/5d18746a455a48c3dd960f40bf186b79d10e72ff", "message": "Move background tasks to background package", "committedDate": "2020-07-21T10:15:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwMDA0Mg==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458000042", "bodyText": "I think really we just need a shared \"lock\" in the app that stops things that make changes running at the same time as here we have to care about multiple things, not everything is covered and there is no real thread safety. I've noted this down and I want to work on it later once we've added error handling for match exactly.", "author": "seadowg", "createdAt": "2020-07-21T10:35:51Z", "path": "collect_app/src/main/java/org/odk/collect/android/storage/migration/StorageMigrator.java", "diffHunk": "@@ -104,11 +107,11 @@ public StorageMigrationResult migrate() {\n     }\n \n     private boolean isFormUploaderRunning() {\n-        return backgroundWorkManager.isFormUploaderRunning();\n+        return formSubmitManager.isSubmitRunning();", "originalCommit": "5d18746a455a48c3dd960f40bf186b79d10e72ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4c1a88878519a1f847d74ef89a400a58393d944", "url": "https://github.com/getodk/collect/commit/d4c1a88878519a1f847d74ef89a400a58393d944", "message": "Optimize imports", "committedDate": "2020-07-21T10:36:42Z", "type": "commit"}, {"oid": "e0308072f82c407733e1d14cb56ba376d0a60ad7", "url": "https://github.com/getodk/collect/commit/e0308072f82c407733e1d14cb56ba376d0a60ad7", "message": "Use FormUpdateMode in viewmodels", "committedDate": "2020-07-21T10:59:35Z", "type": "commit"}, {"oid": "4f370faf0b47361b4e64bfb3e4bb7b79a3c6df6b", "url": "https://github.com/getodk/collect/commit/4f370faf0b47361b4e64bfb3e4bb7b79a3c6df6b", "message": "Fix broken test code", "committedDate": "2020-07-21T12:04:36Z", "type": "commit"}, {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "url": "https://github.com/getodk/collect/commit/f79e92399f693f60d4cea87834e65af7b1ee12a4", "message": "Make sure task spec adapter constructor is public", "committedDate": "2020-07-21T12:30:00Z", "type": "commit"}, {"oid": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "url": "https://github.com/getodk/collect/commit/f79e92399f693f60d4cea87834e65af7b1ee12a4", "message": "Make sure task spec adapter constructor is public", "committedDate": "2020-07-21T12:30:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNDA0Nw==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458404047", "bodyText": "Additionally, I think the checkbox should be selected to make it clear that updates always happen automatically in match exactly mode. If the mode changes from match exactly to one of the other modes, the checkbox should be unchecked to indicate that automatic downloads aren't applicable to manual mode or are not on by default for updates to existing forms.\nI think it's ok for the value for the update frequency to stay whatever it was last set to in the case of manual update but I find the disabled automatic download option to be confusing.", "author": "lognaturel", "createdAt": "2020-07-21T21:39:07Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/settings/FormManagementSettingsTest.java", "diffHunk": "@@ -51,6 +51,29 @@ public Scheduler providesScheduler(WorkManager workManager) {\n             .around(new IdlingResourceRule(new SchedulerIdlingResource(testScheduler)))\n             .around(rule);\n \n+    @Test\n+    public void whenManualUpdatesEnabled_disablesPrefs() {\n+        rule.mainMenu()\n+                .clickOnMenu()\n+                .clickGeneralSettings()\n+                .clickFormManagement()\n+                .clickUpdateForms()\n+                .clickOption(R.string.manually)\n+                .assertDisabled(R.string.form_update_frequency_title)\n+                .assertDisabled(R.string.automatic_download);\n+    }\n+\n+    @Test\n+    public void whenMatchExactlyEnabled_disablesPrefs() {\n+        rule.mainMenu()\n+                .clickOnMenu()\n+                .clickGeneralSettings()\n+                .clickFormManagement()\n+                .clickUpdateForms()\n+                .clickOption(R.string.match_exactly)\n+                .assertDisabled(R.string.automatic_download);", "originalCommit": "eb598da652c87f904d900e9012a944ae8877246a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYyOTA3Nw==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458629077", "bodyText": "Oh that's a really nice touch. Good thinking.", "author": "seadowg", "createdAt": "2020-07-22T08:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNDA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5Mjk0Mg==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458692942", "bodyText": "I think we should create an issue for this. Testing this is going to be really hard without converting the fragment to androidx and I think we're just going to end up with conflicts with #3923. What do you think?\nI'll put a note for QA to target that PR next as it'd be really helpful to get that in.", "author": "seadowg", "createdAt": "2020-07-22T10:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNDA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMzA1Ng==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459223056", "bodyText": "Ok, all sounds good!", "author": "lognaturel", "createdAt": "2020-07-23T05:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQwNDA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODYwNQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458448605", "bodyText": "I don't understand the changes here. Why not pass in all the SharedPreferences on initialization? It seems they're always available on initialization or it would be more consistent to pass everything in on migration. I thought it was for testing but the one test that uses it does construction and migration on the same line.", "author": "lognaturel", "createdAt": "2020-07-21T23:35:32Z", "path": "collect_app/src/main/java/org/odk/collect/android/application/initialization/MetaPreferenceMigrator.java", "diffHunk": "@@ -32,26 +31,22 @@\n /**\n  * Migrates old preference keys and values to new ones.\n  */\n-public class CollectPreferenceMigrator implements PreferenceMigrator {\n+public class MetaPreferenceMigrator implements PreferenceMigrator {", "originalCommit": "e538bda4bfc576b1f904af35da70db9109e8ccc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzMjIxMw==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458632213", "bodyText": "Not for testing it's just me playing with the interface. I've flipped-flopped on this a few times. I guess my thinking here is that in the SettingsImporter we're actively dealing with general and admin preferences so it's weird that we then just call migrate. There w know what we're trying to migrate we just don't care about the detail (and we also don't know that the meta prefs exist).\nI think it's also me not being able to escape from the discussions about having profiles in the future. In that world you'd have different general and shared prefs but one shared meta prefs.\nAny of that make sense or you still hate it?", "author": "seadowg", "createdAt": "2020-07-22T08:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjY4NQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459572685", "bodyText": "The rationale for passing in general and admin preferences to migrate makes sense to me now, thanks. The name still really bothers me. CollectPreferenceMigrator or SharedPrefsMigrator or something that implies it can migrate all the prefs would make a lot more sense to me. Even if it doesn't keep track of general and admin preferences, it still knows how to migrate all the relevant preferences.", "author": "lognaturel", "createdAt": "2020-07-23T16:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3ODA1MQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459578051", "bodyText": "Yeah that's very fair. I'll rework the name.", "author": "seadowg", "createdAt": "2020-07-23T16:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMjM3MA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458522370", "bodyText": "And what about the actually does something case?", "author": "lognaturel", "createdAt": "2020-07-22T04:09:35Z", "path": "collect_app/src/test/java/org/odk/collect/android/application/initialization/migration/KeyExtractorTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.odk.collect.android.application.initialization.migration;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import static androidx.test.core.app.ApplicationProvider.getApplicationContext;\n+import static org.odk.collect.android.application.initialization.migration.MigrationUtils.extractNewKey;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.assertPrefs;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.assertPrefsEmpty;\n+import static org.odk.collect.android.application.initialization.migration.SharedPreferenceUtils.initPrefs;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class KeyExtractorTest {\n+\n+    private SharedPreferences prefs;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        prefs = getApplicationContext().getSharedPreferences(\"test\", Context.MODE_PRIVATE);\n+    }\n+\n+    @Test\n+    public void whenNewKeyExists_doesNothing() {\n+        initPrefs(prefs,\n+                \"oldKey\", \"oldBlah\",\n+                \"newKey\", \"existing\"\n+        );\n+\n+        extractNewKey(\"newKey\").fromKey(\"oldKey\")\n+                .fromValue(\"oldBlah\").toValue(\"newBlah\")\n+                .apply(prefs);\n+\n+        assertPrefs(prefs,\n+                \"oldKey\", \"oldBlah\",\n+                \"newKey\", \"existing\"\n+        );\n+    }\n+\n+    @Test\n+    public void whenOldKeyMissing_doesNothing() {\n+        initPrefs(prefs);\n+\n+        extractNewKey(\"newKey\").fromKey(\"oldKey\")\n+                .fromValue(\"oldBlah\").toValue(\"newBlah\")\n+                .apply(prefs);\n+\n+        assertPrefsEmpty(prefs);\n+    }", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzNDk2Ng==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458634966", "bodyText": "Ha. This is my very hippie TDD style: I never needed to write that test to get the behaviour in there as it was driven out by the MetaPreferencesMigratorTest (which I wrote first).\nI think you're right that we should have the test for the actual behaviour though as these migrations are being treated like a framework - we'd want to have confidence that each one is tested outside in isolation.", "author": "seadowg", "createdAt": "2020-07-22T08:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyMjM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNjg1Nw==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458526857", "bodyText": "Since you're replacing with a single line that now has very clear behavior, maybe get rid of this method?\nI think the TODO should be moved to an issue. Yes, I would expect that if auto send is turned on, that immediately attempts to send all pending submissions or enqueues the work if no connection is available. If you're ok with all that I can file the (very much not urgent) issue.", "author": "lognaturel", "createdAt": "2020-07-22T04:27:34Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2484,16 +2480,7 @@ public void next() {\n      * TODO: if the user changes auto-send settings, should an auto-send job immediately be enqueued?\n      */\n     private void requestAutoSend() {\n-        Constraints constraints = new Constraints.Builder()\n-                .setRequiredNetworkType(NetworkType.CONNECTED)\n-                .build();\n-        OneTimeWorkRequest autoSendWork =\n-                new OneTimeWorkRequest.Builder(AutoSendWorker.class)\n-                        .addTag(AutoSendWorker.TAG)\n-                        .setConstraints(constraints)\n-                        .build();\n-        workManager.beginUniqueWork(AutoSendWorker.TAG,\n-                ExistingWorkPolicy.KEEP, autoSendWork).enqueue();\n+        formSubmitManager.scheduleSubmit();", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzMjYzMA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458632630", "bodyText": "Yeah that sounds like a good way forward!", "author": "seadowg", "createdAt": "2020-07-22T08:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNjg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0NDUzMA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458644530", "bodyText": "Created an issue: #3980", "author": "seadowg", "createdAt": "2020-07-22T09:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyNjg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyOTcyNA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458529724", "bodyText": "Seems either this should cancel submission as well or should be renamed.", "author": "lognaturel", "createdAt": "2020-07-22T04:39:15Z", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/SchedulerFormUpdateAndSubmitManager.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package org.odk.collect.android.backgroundwork;\n+\n+import android.app.Application;\n+import android.content.SharedPreferences;\n+\n+import androidx.work.Constraints;\n+import androidx.work.ExistingWorkPolicy;\n+import androidx.work.NetworkType;\n+import androidx.work.OneTimeWorkRequest;\n+import androidx.work.WorkManager;\n+\n+import org.odk.collect.android.formmanagement.FormUpdateMode;\n+import org.odk.collect.android.upload.AutoSendWorker;\n+import org.odk.collect.async.Scheduler;\n+\n+import static org.odk.collect.android.backgroundwork.BackgroundWorkUtils.getPeriodInMilliseconds;\n+import static org.odk.collect.android.preferences.GeneralKeys.KEY_FORM_UPDATE_MODE;\n+import static org.odk.collect.android.preferences.GeneralKeys.KEY_PERIODIC_FORM_UPDATES_CHECK;\n+\n+public class SchedulerFormUpdateAndSubmitManager implements FormUpdateManager, FormSubmitManager {\n+\n+    private static final String MATCH_EXACTLY_SYNC_TAG = \"match_exactly\";\n+    public static final String AUTO_UPDATE_TAG = \"serverPollingJob\";\n+\n+    private final Scheduler scheduler;\n+    private final SharedPreferences sharedPreferences;\n+    private final Application application;\n+\n+    @Deprecated // Should use Scheduler instance instead\n+    private final WorkManager workManager;\n+\n+    public SchedulerFormUpdateAndSubmitManager(Scheduler scheduler, SharedPreferences sharedPreferences, Application application, WorkManager workManager) {\n+        this.scheduler = scheduler;\n+        this.sharedPreferences = sharedPreferences;\n+        this.application = application;\n+        this.workManager = workManager;\n+    }\n+\n+    @Override\n+    public void scheduleUpdates() {\n+        cancelWork();\n+\n+        String newValue = sharedPreferences.getString(KEY_FORM_UPDATE_MODE, null);\n+        String period = sharedPreferences.getString(KEY_PERIODIC_FORM_UPDATES_CHECK, null);\n+\n+        switch (FormUpdateMode.parse(application, newValue)) {\n+            case MANUAL:\n+                break;\n+            case PREVIOUSLY_DOWNLOADED_ONLY:\n+                scheduleAutoUpdate(getPeriodInMilliseconds(period));\n+                break;\n+            case MATCH_EXACTLY:\n+                scheduleMatchExactlySync(getPeriodInMilliseconds(period));\n+                break;\n+        }\n+    }\n+\n+    private void scheduleMatchExactlySync(long repeatPeriod) {\n+        scheduler.networkDeferred(MATCH_EXACTLY_SYNC_TAG, new SyncFormsTaskSpec(), repeatPeriod);\n+    }\n+\n+    private void scheduleAutoUpdate(long repeatPeriod) {\n+        scheduler.networkDeferred(AUTO_UPDATE_TAG, new AutoUpdateTaskSpec(), repeatPeriod);\n+    }\n+\n+    private void cancelWork() {", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzNTQ3OQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458635479", "bodyText": "Yeah good point. I think I'll rename for the moment.", "author": "seadowg", "createdAt": "2020-07-22T08:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUyOTcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDQyMA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458530420", "bodyText": "I think whenPreviouslyDownloadedOnlyDisabled_stopsCheckingForUpdates verifies that if the mode is changed to manual after being one of the automatic ones, automatic work is cancelled. However, I can't find code for that. Are you sure this line doesn't need to be outside the if to guarantee that a change to manual cancels work?", "author": "lognaturel", "createdAt": "2020-07-22T04:42:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormManagementPreferences.java", "diffHunk": "@@ -145,4 +168,22 @@ public boolean onPreferenceChange(Preference preference, Object newValue) {\n         });\n     }\n \n+    @Override\n+    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {\n+        if (key.equals(KEY_FORM_UPDATE_MODE) || key.equals(KEY_PERIODIC_FORM_UPDATES_CHECK)) {\n+            formUpdateManager.scheduleUpdates();", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYzNzg2NQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458637865", "bodyText": "SchedulerFormUpdateAndSubmitManager#scheduleUpdates cancels any existing deferred work and then sets it back up again. The if here is just making sure we only do that when the relevant settings change (as this will fire for any changes).", "author": "seadowg", "createdAt": "2020-07-22T08:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMjA1MQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459222051", "bodyText": "Ohhh, hah. Of course, that makes a lot more sense. I was going too quickly and interpreted it as if we go into match exactly or update downloaded modes.", "author": "lognaturel", "createdAt": "2020-07-23T05:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMDQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTQ2Mg==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458531462", "bodyText": "As more of these simple enums get introduced, maybe we should consider constants with typedef annotations? https://developer.android.com/studio/write/annotations.html#enum-annotations It's not a huge amount of memory but it does add up and I think constants/typedef is just as nice.", "author": "lognaturel", "createdAt": "2020-07-22T04:46:23Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/Protocol.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.odk.collect.android.preferences;\n+\n+import android.content.Context;\n+\n+import org.odk.collect.android.R;\n+\n+public enum Protocol {", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYyNDk1MQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458624951", "bodyText": "I had it in my mind that the enum problem wasn't a big deal any more. I managed to find this post from Chet Haase that goes through optimizations they've made in R8 for enums but also says:\n\nYes, we used to talk about avoiding enums\u2026 but that was many years and an entire runtime ago \u2014 enums are fine\n\nI think maybe to side step the typedef stuff we could consider switching enum definitons and their calling code candidates for switching to Kotlin where we could be using sealed classes.", "author": "seadowg", "createdAt": "2020-07-22T08:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMjU5OQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459222599", "bodyText": "Ah, great! I'm pretty sure I saw the \"avoid enum\" thing in Android docs recently but maybe I'm remembering wrong. Let's leave it for now. I'm not super excited about peppering Kotlin around but we should discuss.", "author": "lognaturel", "createdAt": "2020-07-23T05:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMTQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzMzNg==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458533336", "bodyText": "Nit: lastDetectedHash?", "author": "lognaturel", "createdAt": "2020-07-22T04:53:52Z", "path": "collect_app/src/main/java/org/odk/collect/android/forms/DatabaseFormRepository.java", "diffHunk": "@@ -48,4 +49,32 @@ public void save(Form form) {\n     public void delete(Long id) {\n         new FormsDao().deleteFormsFromIDs(new String[]{id.toString()});\n     }\n+\n+    @Override\n+    public void setLastDetectedUpdated(String jrFormId, String formHash, String manifestHash) {\n+        String formVersionHash = MultiFormDownloader.getMd5Hash(formHash) + manifestHash;\n+\n+        ContentValues values = new ContentValues();\n+        values.put(LAST_DETECTED_FORM_VERSION_HASH, formVersionHash);\n+        new FormsDao().updateForm(values, JR_FORM_ID + \"=?\", new String[]{jrFormId});\n+    }\n+\n+    @Override\n+    public Form getByLastDetectedUpdate(String formHash, String manifestHash) {", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYxNjU0OQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458616549", "bodyText": "I was actually trying to abstract away from the \"hash\" here. In the cases we're using it we want to know if this \"update\" or \"version\" of the form exists on the device. We don't need to hash anything to do that (it could have just stored the manifest hash rather than hashing it with the form hash) so to me this felt closer to what the intention was while hiding the implementation detail. Does that feel ok?", "author": "seadowg", "createdAt": "2020-07-22T08:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIyMjE1Mg==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459222152", "bodyText": "Fair enough, thanks for the explanation.", "author": "lognaturel", "createdAt": "2020-07-23T05:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzMzMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458537034", "bodyText": "What's the point of the single retry?", "author": "lognaturel", "createdAt": "2020-07-22T05:07:57Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/previouslydownloaded/ServerFormsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.odk.collect.android.formmanagement.previouslydownloaded;\n+\n+import org.jetbrains.annotations.Nullable;\n+import org.odk.collect.android.formmanagement.ServerFormDetails;\n+import org.odk.collect.android.formmanagement.ServerFormsDetailsFetcher;\n+import org.odk.collect.android.forms.FormRepository;\n+import org.odk.collect.android.openrosa.api.FormApiException;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+public class ServerFormsUpdateChecker {\n+\n+    private final ServerFormsDetailsFetcher serverFormsDetailsFetcher;\n+    private final FormRepository formRepository;\n+\n+    public ServerFormsUpdateChecker(ServerFormsDetailsFetcher serverFormsDetailsFetcher, FormRepository formRepository) {\n+        this.serverFormsDetailsFetcher = serverFormsDetailsFetcher;\n+        this.formRepository = formRepository;\n+    }\n+\n+    public List<ServerFormDetails> check() {\n+        try {\n+            List<ServerFormDetails> updatedForms = fetchUpdatedForms();\n+            List<ServerFormDetails> newUpdates = new ArrayList<>();\n+\n+            for (ServerFormDetails serverFormDetails : updatedForms) {\n+                String formHash = serverFormDetails.getHash();\n+                String manifestFileHash = serverFormDetails.getManifestFileHash() != null ? serverFormDetails.getManifestFileHash() : \"\";\n+\n+                if (formRepository.getByLastDetectedUpdate(formHash, manifestFileHash) == null) {\n+                    newUpdates.add(serverFormDetails);\n+                    formRepository.setLastDetectedUpdated(serverFormDetails.getFormId(), formHash, manifestFileHash);\n+                }\n+            }\n+\n+            return newUpdates;\n+        } catch (FormApiException e) {\n+            return emptyList();\n+        }\n+    }\n+\n+    @Nullable\n+    @SuppressWarnings(\"PMD.AvoidRethrowingException\")\n+    private List<ServerFormDetails> fetchUpdatedForms() throws FormApiException {\n+        List<ServerFormDetails> formList = null;\n+\n+        try {\n+            formList = serverFormsDetailsFetcher.fetchFormDetails();\n+        } catch (FormApiException e) {\n+            switch (e.getType()) {\n+                case AUTH_REQUIRED:\n+                    try {\n+                        serverFormsDetailsFetcher.fetchFormDetails();", "originalCommit": "f79e92399f693f60d4cea87834e65af7b1ee12a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYxNDczOQ==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r458614739", "bodyText": "This is the existing behaviour (see here). I'd actually meant to ask about this as it felt really weird. I'm thinking we can just get rid of it? Otherwise, we should write a test to keep it in (and hopefully describe what it's about).", "author": "seadowg", "createdAt": "2020-07-22T08:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3Mzg5OA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459573898", "bodyText": "Wondered whether that might be old stuff. Hmm. In the foreground usage could it be giving an opportunity to show the dialog or something?", "author": "lognaturel", "createdAt": "2020-07-23T16:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3OTUzNw==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459579537", "bodyText": "Yeah that'd make more sense. Probably want to view that as another issue/feature though. I think for the moment I'm happy for this to merge in like this if we add an issue around making the auto update prompt the user for creds if there is an auth error (like Manual and Match Exactly both will). How does that sound?", "author": "seadowg", "createdAt": "2020-07-23T16:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5NTM1MA==", "url": "https://github.com/getodk/collect/pull/3977#discussion_r459595350", "bodyText": "Issue filed: #3983", "author": "seadowg", "createdAt": "2020-07-23T17:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNzAzNA=="}], "type": "inlineReview"}, {"oid": "cd5ade6bfe03314f0c41ab6a6f83e8f181b95b70", "url": "https://github.com/getodk/collect/commit/cd5ade6bfe03314f0c41ab6a6f83e8f181b95b70", "message": "Use one form mode title", "committedDate": "2020-07-22T08:52:09Z", "type": "commit"}, {"oid": "12b7cfcf16eb0662c1087f4c52a6d3cd982da3e6", "url": "https://github.com/getodk/collect/commit/12b7cfcf16eb0662c1087f4c52a6d3cd982da3e6", "message": "Add main path test for KeyExtractor", "committedDate": "2020-07-22T08:55:27Z", "type": "commit"}, {"oid": "0c357c9fc3c2fa8dc379cf3cb635e74b9d629cb9", "url": "https://github.com/getodk/collect/commit/0c357c9fc3c2fa8dc379cf3cb635e74b9d629cb9", "message": "Remove private method", "committedDate": "2020-07-22T08:56:46Z", "type": "commit"}, {"oid": "c6815be2f29327e6d787e8cbea0d629dcbc50686", "url": "https://github.com/getodk/collect/commit/c6815be2f29327e6d787e8cbea0d629dcbc50686", "message": "Move TODO to issue https://github.com/getodk/collect/issues/3980", "committedDate": "2020-07-22T09:01:00Z", "type": "commit"}, {"oid": "ae96b5830618d941dd2a68e1d0bf8abe51e9fc42", "url": "https://github.com/getodk/collect/commit/ae96b5830618d941dd2a68e1d0bf8abe51e9fc42", "message": "Rename prefs migrator", "committedDate": "2020-07-23T16:44:03Z", "type": "commit"}]}