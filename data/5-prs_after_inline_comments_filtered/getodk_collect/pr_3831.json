{"pr_number": 3831, "pr_title": "Rewriting URL widget", "pr_createdAt": "2020-05-14T12:00:12Z", "pr_url": "https://github.com/getodk/collect/pull/3831", "timeline": [{"oid": "4644a29dd28745eb42f5543e1ae62ddfcd28cd44", "url": "https://github.com/getodk/collect/commit/4644a29dd28745eb42f5543e1ae62ddfcd28cd44", "message": "added test and verified that it is green", "committedDate": "2020-05-14T08:17:23Z", "type": "commit"}, {"oid": "a2e2dad0a2c83b19d3924a2aed5d0407754b6165", "url": "https://github.com/getodk/collect/commit/a2e2dad0a2c83b19d3924a2aed5d0407754b6165", "message": "craeted url_widget_answer.xml", "committedDate": "2020-05-14T08:51:26Z", "type": "commit"}, {"oid": "5eee5b061ed1f38f4e9d1e9c14fe434083b21866", "url": "https://github.com/getodk/collect/commit/5eee5b061ed1f38f4e9d1e9c14fe434083b21866", "message": "updated URL widget java class", "committedDate": "2020-05-14T09:24:36Z", "type": "commit"}, {"oid": "5b920eaa404271504f94abc23ee051c5a2ffa7f7", "url": "https://github.com/getodk/collect/commit/5b920eaa404271504f94abc23ee051c5a2ffa7f7", "message": "fixed margin and padding", "committedDate": "2020-05-14T09:32:30Z", "type": "commit"}, {"oid": "f1374418078cb1ec611611b49fed18cf59c07875", "url": "https://github.com/getodk/collect/commit/f1374418078cb1ec611611b49fed18cf59c07875", "message": "added tests and code refactor", "committedDate": "2020-05-29T07:53:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NjQ1Ng==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432376456", "bodyText": "I would rename this whenPromptHasAnswer_displaysAnswer and the below one to whenPromptAnswerDoesNotHaveAnswer_displayEmptyString.", "author": "seadowg", "createdAt": "2020-05-29T09:47:56Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -22,14 +33,74 @@\n @RunWith(RobolectricTestRunner.class)\n public class UrlWidgetTest {\n \n+    private CustomTabHelper customTabHelper;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n         UrlWidget widget = createWidget(promptWithReadOnly());\n         Button urlButton = widget.findViewById(R.id.url_button);\n         assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n     }\n \n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_setsCorrectAnswer() {", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NjY3NQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432376675", "bodyText": "This can just be clickingButton... as it's the \"normal\" case!", "author": "seadowg", "createdAt": "2020-05-29T09:48:21Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -22,14 +33,74 @@\n @RunWith(RobolectricTestRunner.class)\n public class UrlWidgetTest {\n \n+    private CustomTabHelper customTabHelper;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n         UrlWidget widget = createWidget(promptWithReadOnly());\n         Button urlButton = widget.findViewById(R.id.url_button);\n         assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n     }\n \n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_setsCorrectAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_setsNullValue() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsNotEmpty_callsCorrectMethods() {", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzMzNw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432377337", "bodyText": "I'd not bother with times here. I'd usually only use it when something happens more than once but I expect a dependency to only get called once in that case (maybe when testing caching or something).", "author": "seadowg", "createdAt": "2020-05-29T09:49:39Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -22,14 +33,74 @@\n @RunWith(RobolectricTestRunner.class)\n public class UrlWidgetTest {\n \n+    private CustomTabHelper customTabHelper;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n         UrlWidget widget = createWidget(promptWithReadOnly());\n         Button urlButton = widget.findViewById(R.id.url_button);\n         assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n     }\n \n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_setsCorrectAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_setsNullValue() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsNotEmpty_callsCorrectMethods() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        TextView textView = widget.findViewById(R.id.url_answer_text);\n+        urlButton.performClick();\n+\n+        assertThat(textView.getText().toString(), equalTo(\"blah\"));\n+        verify(customTabHelper, times(1)).bindCustomTabsService(widget.getContext(), null);", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5NjI2Ng==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432496266", "bodyText": "Oh okay thanks. I will keep it in mind.", "author": "SaumiaSinghal", "createdAt": "2020-05-29T13:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzY1Mw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432377653", "bodyText": "Nice change!", "author": "seadowg", "createdAt": "2020-05-29T09:50:11Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -48,9 +48,9 @@\n     private TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5NjYwMw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432496603", "bodyText": "Thank you!", "author": "SaumiaSinghal", "createdAt": "2020-05-29T13:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzcyMQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432377721", "bodyText": "Good catch!", "author": "seadowg", "createdAt": "2020-05-29T09:50:20Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -22,14 +33,74 @@\n @RunWith(RobolectricTestRunner.class)\n public class UrlWidgetTest {\n \n+    private CustomTabHelper customTabHelper;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n         UrlWidget widget = createWidget(promptWithReadOnly());\n         Button urlButton = widget.findViewById(R.id.url_button);\n         assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n     }\n \n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_setsCorrectAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_setsNullValue() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3OTMzNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r432379335", "bodyText": "This can move into the XML layout.", "author": "seadowg", "createdAt": "2020-05-29T09:53:09Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -42,31 +44,42 @@\n public class UrlWidget extends QuestionWidget implements ButtonWidget {\n \n     private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n+    private Button openUrlButton;\n+    private TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> {\n+                if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {\n+                    onButtonClick(openUrlButton.getId());\n+                }\n+            });\n+        }\n+\n+        stringAnswer.setTextColor(new ThemeUtils(context).getColorOnSurface());", "originalCommit": "f1374418078cb1ec611611b49fed18cf59c07875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a10f13e7387b31492c8c2430b4c5936e6ca203ba", "url": "https://github.com/getodk/collect/commit/a10f13e7387b31492c8c2430b4c5936e6ca203ba", "message": "change test names", "committedDate": "2020-05-29T13:53:44Z", "type": "commit"}, {"oid": "28cc22129b2c634646b2271a1f2eaa156c40903f", "url": "https://github.com/getodk/collect/commit/28cc22129b2c634646b2271a1f2eaa156c40903f", "message": "update url_widget_answer.xml", "committedDate": "2020-05-29T14:02:45Z", "type": "commit"}, {"oid": "e74b9ca5ba40520744f1534f91f5f130c6b9859b", "url": "https://github.com/getodk/collect/commit/e74b9ca5ba40520744f1534f91f5f130c6b9859b", "message": "added tests for longClick and cancelLongPress", "committedDate": "2020-05-31T19:24:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1ODEwNw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433158107", "bodyText": "I don't think this or the test below are correct. I think my question around writing tests for setOnLongClickListener and cancelLongPress was confusing though now I look at it. Lets breakdown what we need for each method:\n\nsetOnLongClickListener: usually this needs to call setOnLongClickListener on any child views in the widget so that when I long press on anything in the widget I see the \"Edit Prompt\" pop up menu. Here you'll see that setOnLongClickListener is empty so that long pressing on the URL button won't do anything - it's clickable so it consumes the long press event. We need to write a test that makes sure long pressing on the url button will call any listener passed to the widget's setOnLongClickListener.\ncancelLongPress: this makes sure that any long press cancellation (usually the user scrolling around) works properly. I don't think there is a way to test that, so I think we should just make sure to review this method and make sure any views in the widget have the call propagated to them.", "author": "seadowg", "createdAt": "2020-06-01T10:29:55Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -1,46 +1,123 @@\n package org.odk.collect.android.widgets;\n \n+import android.net.Uri;\n import android.view.View;\n-\n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import android.widget.Button;\n+import android.widget.TextView;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.utilities.CustomTabHelper;\n+import org.robolectric.RobolectricTestRunner;\n \n+import static android.view.KeyEvent.ACTION_UP;\n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n-import static org.mockito.Mockito.when;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n /**\n  * @author James Knight\n  */\n \n-public class UrlWidgetTest extends QuestionWidgetTest<UrlWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public UrlWidget createWidget() {\n-        return new UrlWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+@RunWith(RobolectricTestRunner.class)\n+public class UrlWidgetTest {\n+\n+    private CustomTabHelper customTabHelper;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(RandomString.make());\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n     }\n \n-    @Override\n-    public void callingClearShouldRemoveTheExistingAnswer() {\n-        // The widget is ReadOnly, clear shouldn't do anything.\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n+        UrlWidget widget = createWidget(promptWithReadOnly());\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n     }\n \n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n-        when(formEntryPrompt.isReadOnly()).thenReturn(true);\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_displaysAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_displayEmptyString() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButton_callsCorrectMethods() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper).bindCustomTabsService(widget.getContext(), null);\n+        verify(customTabHelper).openUri(widget.getContext(), Uri.parse(\"blah\"));\n+    }\n+\n+    @Test\n+    public void onLongPressButton_doesNotCallOpenUri() {", "originalCommit": "e74b9ca5ba40520744f1534f91f5f130c6b9859b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1ODg2Nw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433158867", "bodyText": "One tip by the way for checking the coverage you have for an object is to use Android Studio's \"Run with coverage\" feature. If you use the green \u25b6\ufe0f icon to run the test file (in this case URLWidgetTest) and then hit \"Run X with Coverage\" you'll see green and red highligting in the URLWidget file for what lines are covered by tests and what ones aren't.", "author": "seadowg", "createdAt": "2020-06-01T10:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1ODEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MDgzNg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433160836", "bodyText": "Thank you so much for the suggestion. I will modify the tests.", "author": "SaumiaSinghal", "createdAt": "2020-06-01T10:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1ODEwNw=="}], "type": "inlineReview"}, {"oid": "1266f50abab2a96918d29988eea255e695603812", "url": "https://github.com/getodk/collect/commit/1266f50abab2a96918d29988eea255e695603812", "message": "modify test for long click and remove cancel long press test", "committedDate": "2020-06-01T12:20:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MjA3OQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433272079", "bodyText": "Here's you're extending URLWidget for the test and then using that. That means your test is now of TestURLWidget not URLWidget. We shouldn't use fakes, mocks or stubs of the objects we're testing as this means we're not really testing the object itself!\nI'm not sure why you created this as you could just call setOnLongClickListener on the widget in the test.", "author": "seadowg", "createdAt": "2020-06-01T14:36:08Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -98,26 +106,23 @@ public void clickingButton_callsCorrectMethods() {\n     }\n \n     @Test\n-    public void onLongPressButton_doesNotCallOpenUri() {\n+    public void clickingButtonForLong_callsLongClickListener() {\n         UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n         Button urlButton = widget.findViewById(R.id.url_button);\n         urlButton.performLongClick();\n \n-        verify(customTabHelper, never()).bindCustomTabsService(widget.getContext(), null);\n-        verify(customTabHelper, never()).openUri(widget.getContext(), Uri.parse(\"blah\"));\n+        assertThat(listener.onLongClick(urlButton), equalTo(true));\n     }\n \n-    @Test\n-    public void textViewShouldIgnoreLongPress() {\n-        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n-        TextView textView = widget.findViewById(R.id.url_answer_text);\n-\n-        textView.onEditorAction(ACTION_UP);\n-        assertThat(textView.hasFocus(), equalTo(false));\n+    private TestUrlWidget createWidget(FormEntryPrompt prompt) {\n+        return new TestUrlWidget(widgetTestActivity(), new QuestionDetails(prompt, \"formAnalyticsID\"), customTabHelper, listener);\n     }\n \n+    private static class TestUrlWidget extends UrlWidget {\n \n-    private UrlWidget createWidget(FormEntryPrompt prompt) {\n-        return new UrlWidget(widgetTestActivity(), new QuestionDetails(prompt, \"formAnalyticsID\"), customTabHelper);\n+        public TestUrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper, OnLongClickListener listener) {", "originalCommit": "1266f50abab2a96918d29988eea255e695603812", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433273357", "bodyText": "I think a better way to test this is to pass a mock(Listener.class) to the Widget's OnLongClickListener and then check that it is called (using when) after you call urlButton.performLongClick(). Does that make sense? That would make sure the listener the URL button has and the listener the widget has are definitely the same", "author": "seadowg", "createdAt": "2020-06-01T14:38:14Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -98,26 +106,23 @@ public void clickingButton_callsCorrectMethods() {\n     }\n \n     @Test\n-    public void onLongPressButton_doesNotCallOpenUri() {\n+    public void clickingButtonForLong_callsLongClickListener() {\n         UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n         Button urlButton = widget.findViewById(R.id.url_button);\n         urlButton.performLongClick();\n \n-        verify(customTabHelper, never()).bindCustomTabsService(widget.getContext(), null);\n-        verify(customTabHelper, never()).openUri(widget.getContext(), Uri.parse(\"blah\"));\n+        assertThat(listener.onLongClick(urlButton), equalTo(true));", "originalCommit": "1266f50abab2a96918d29988eea255e695603812", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzOTczMA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433339730", "bodyText": "This is much better! But sorry I lead you down a slightly wrong path there. I think instead of using when to set up a result and then verifying it later (lines 108 and 111) you could just do verify(listener).onLongClick(urlButton). Does that make more sense?", "author": "seadowg", "createdAt": "2020-06-01T16:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1OTQ4Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433359482", "bodyText": "I wrote the test like this initially:\n        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n        Button urlButton = widget.findViewById(R.id.url_button);\n        widget.setOnLongClickListener(listener);\n        urlButton.performLongClick();\n        verify(listener).onLongClick(urlButton);\n\nBut this test does not pass.", "author": "SaumiaSinghal", "createdAt": "2020-06-01T16:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2MTE2Nw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433361167", "bodyText": "Right but I think that's a correctly failing test: URLWidget#setOnLongClickListener doesn't do anything at the moment so I'd expect that test to be red. If you try long clicking on the URL button in the app at the moment right now you'll see it doesn't show the \"Edit Prompt\" pop up.", "author": "seadowg", "createdAt": "2020-06-01T16:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2MjM3Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433362372", "bodyText": "It says Wanted but not invoked and Actually, there were zero interactions with this mock. I do not understand.", "author": "SaumiaSinghal", "createdAt": "2020-06-01T16:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NDQwNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433364405", "bodyText": "Right that means that the onLongClick on the listener was never called. It might be worth reading some docs at https://site.mockito.org/ if you're confused by this message. If you look at URLWidget#setOnLongClickListener you'll see it's empty so that test should fail in the way you're seeing. You have a red test that you can now make green!", "author": "seadowg", "createdAt": "2020-06-01T16:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNjY4Ng==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433406686", "bodyText": "Hi! I'm sorry. I didn't refresh the page and so kept adding comments without reading your second last comment. I understand it now.", "author": "SaumiaSinghal", "createdAt": "2020-06-01T18:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMDk2Mw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433410963", "bodyText": "@SaumiaSinghal hah I've made exactly the same mistake before!", "author": "seadowg", "createdAt": "2020-06-01T18:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMjU0MA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433412540", "bodyText": "\ud83d\ude25", "author": "SaumiaSinghal", "createdAt": "2020-06-01T18:30:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3MzM1Nw=="}], "type": "inlineReview"}, {"oid": "78d2691e85b30059e52c299cb01a99171fa263d2", "url": "https://github.com/getodk/collect/commit/78d2691e85b30059e52c299cb01a99171fa263d2", "message": "update longClickListener test", "committedDate": "2020-06-01T15:34:02Z", "type": "commit"}, {"oid": "d8e3880183cb06fce571364d0bd210dc8129117d", "url": "https://github.com/getodk/collect/commit/d8e3880183cb06fce571364d0bd210dc8129117d", "message": "move marginBottom to the TextView", "committedDate": "2020-06-01T15:38:57Z", "type": "commit"}, {"oid": "a8f89b975f226a7f6c4f6c9322ff130cd82dedf8", "url": "https://github.com/getodk/collect/commit/a8f89b975f226a7f6c4f6c9322ff130cd82dedf8", "message": "add test for onDetachedFromWindow() and update onLongClick test", "committedDate": "2020-06-01T18:16:07Z", "type": "commit"}, {"oid": "e1278c50c1b2b79b2595b8cc455e1551ac67ab3e", "url": "https://github.com/getodk/collect/commit/e1278c50c1b2b79b2595b8cc455e1551ac67ab3e", "message": "make longClickListener test pass", "committedDate": "2020-06-02T00:31:24Z", "type": "commit"}, {"oid": "0c1e24eff5d3467faa945cca70b01660018308a6", "url": "https://github.com/getodk/collect/commit/0c1e24eff5d3467faa945cca70b01660018308a6", "message": "add cancelLongPressTest and refactor code", "committedDate": "2020-06-02T10:14:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NzkyMA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433857920", "bodyText": "Is this an accidental change? I can't see a reason for it.", "author": "seadowg", "createdAt": "2020-06-02T13:04:07Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/CustomTabHelper.java", "diffHunk": "@@ -24,7 +24,7 @@\n public class CustomTabHelper {\n     public static final String OPEN_URL = \"url\";\n     private static final String CUSTOM_TAB_PACKAGE_NAME = \"com.android.chrome\";\n-    private CustomTabsClient customTabsClient;\n+    public CustomTabsClient customTabsClient;", "originalCommit": "e1278c50c1b2b79b2595b8cc455e1551ac67ab3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzODg1MA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r433938850", "bodyText": "Oh Sorry, I was trying something in onDetachedFromWindow test.", "author": "SaumiaSinghal", "createdAt": "2020-06-02T14:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NzkyMA=="}], "type": "inlineReview"}, {"oid": "7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "url": "https://github.com/getodk/collect/commit/7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "message": "revret change in CustomTabHelper", "committedDate": "2020-06-02T14:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NzI3Mw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r434997273", "bodyText": "Extra 't' in whenServiceConnectionIstNull", "author": "lognaturel", "createdAt": "2020-06-04T05:16:50Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -1,46 +1,146 @@\n package org.odk.collect.android.widgets;\n \n+import android.net.Uri;\n import android.view.View;\n+import android.view.View.OnLongClickListener;\n+import android.widget.Button;\n+import android.widget.TextView;\n \n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import androidx.browser.customtabs.CustomTabsServiceConnection;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.utilities.CustomTabHelper;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n /**\n  * @author James Knight\n  */\n \n-public class UrlWidgetTest extends QuestionWidgetTest<UrlWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public UrlWidget createWidget() {\n-        return new UrlWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+@RunWith(RobolectricTestRunner.class)\n+public class UrlWidgetTest {\n+\n+    private CustomTabHelper customTabHelper;\n+    private CustomTabsServiceConnection serviceConnection;\n+    private OnLongClickListener listener;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+        serviceConnection = mock(CustomTabsServiceConnection.class);\n+        listener = mock(OnLongClickListener.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n+        UrlWidget widget = createWidget(promptWithReadOnly());\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n+    }\n+\n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_displaysAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_displayEmptyString() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButton_callsCorrectMethods() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper).bindCustomTabsService(widget.getContext(), null);\n+        verify(customTabHelper).openUri(widget.getContext(), Uri.parse(\"blah\"));\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(RandomString.make());\n+    @Test\n+    public void clickingButtonForLong_callsLongClickListener() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        widget.setOnLongClickListener(listener);\n+        urlButton.performLongClick();\n+        verify(listener).onLongClick(urlButton);\n     }\n \n-    @Override\n-    public void callingClearShouldRemoveTheExistingAnswer() {\n-        // The widget is ReadOnly, clear shouldn't do anything.\n+    @Test\n+    public void cancelLongPress_callsCancelLongPressForButtonAndTextView() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        widget.openUrlButton = mock(Button.class);\n+        widget.stringAnswer = mock(TextView.class);\n+        widget.cancelLongPress();\n+\n+        verify(widget.openUrlButton).cancelLongPress();\n+        verify(widget.stringAnswer).cancelLongPress();\n     }\n \n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n-        when(formEntryPrompt.isReadOnly()).thenReturn(true);\n+    public void detachingFromWindow_disconnectsService_whenServiceConnectionIsNotNull() {\n+        when(customTabHelper.getServiceConnection()).thenReturn(serviceConnection);\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        widget.onDetachedFromWindow();\n+        verify(serviceConnection).onServiceDisconnected(null);\n+    }\n+\n+    @Test\n+    public void detachingFromWindow_doesNotCallOnServiceDisconnected_whenServiceConnectionIstNull() {", "originalCommit": "7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5NjIxNw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r435096217", "bodyText": "Ahh.. sorry for the typo.", "author": "SaumiaSinghal", "createdAt": "2020-06-04T08:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NzI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NzQ1NQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r434997455", "bodyText": "This test and the following seem to me like they should be part of CustomTabHelper's tests, not the tests for a specific widget.", "author": "lognaturel", "createdAt": "2020-06-04T05:17:31Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -1,46 +1,146 @@\n package org.odk.collect.android.widgets;\n \n+import android.net.Uri;\n import android.view.View;\n+import android.view.View.OnLongClickListener;\n+import android.widget.Button;\n+import android.widget.TextView;\n \n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import androidx.browser.customtabs.CustomTabsServiceConnection;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.utilities.CustomTabHelper;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n /**\n  * @author James Knight\n  */\n \n-public class UrlWidgetTest extends QuestionWidgetTest<UrlWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public UrlWidget createWidget() {\n-        return new UrlWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+@RunWith(RobolectricTestRunner.class)\n+public class UrlWidgetTest {\n+\n+    private CustomTabHelper customTabHelper;\n+    private CustomTabsServiceConnection serviceConnection;\n+    private OnLongClickListener listener;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+        serviceConnection = mock(CustomTabsServiceConnection.class);\n+        listener = mock(OnLongClickListener.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n+        UrlWidget widget = createWidget(promptWithReadOnly());\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n+    }\n+\n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_displaysAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_displayEmptyString() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButton_callsCorrectMethods() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper).bindCustomTabsService(widget.getContext(), null);\n+        verify(customTabHelper).openUri(widget.getContext(), Uri.parse(\"blah\"));\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(RandomString.make());\n+    @Test\n+    public void clickingButtonForLong_callsLongClickListener() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        widget.setOnLongClickListener(listener);\n+        urlButton.performLongClick();\n+        verify(listener).onLongClick(urlButton);\n     }\n \n-    @Override\n-    public void callingClearShouldRemoveTheExistingAnswer() {\n-        // The widget is ReadOnly, clear shouldn't do anything.\n+    @Test\n+    public void cancelLongPress_callsCancelLongPressForButtonAndTextView() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        widget.openUrlButton = mock(Button.class);\n+        widget.stringAnswer = mock(TextView.class);\n+        widget.cancelLongPress();\n+\n+        verify(widget.openUrlButton).cancelLongPress();\n+        verify(widget.stringAnswer).cancelLongPress();\n     }\n \n     @Test\n-    public void usingReadOnlyOptionShouldMakeAllClickableElementsDisabled() {\n-        when(formEntryPrompt.isReadOnly()).thenReturn(true);\n+    public void detachingFromWindow_disconnectsService_whenServiceConnectionIsNotNull() {", "originalCommit": "7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM2MjkzNg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437362936", "bodyText": "Hi @lognaturel! I updated the tests and used  spy(widgetTestActicity()) instead to verify unbindService() is called.", "author": "SaumiaSinghal", "createdAt": "2020-06-09T12:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NzQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5NzcwNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r434997705", "bodyText": "I think this could be _opensUri instead of _callsCorrectMethods so that the intended behavior is clear.", "author": "lognaturel", "createdAt": "2020-06-04T05:18:15Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/UrlWidgetTest.java", "diffHunk": "@@ -1,46 +1,146 @@\n package org.odk.collect.android.widgets;\n \n+import android.net.Uri;\n import android.view.View;\n+import android.view.View.OnLongClickListener;\n+import android.widget.Button;\n+import android.widget.TextView;\n \n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import androidx.browser.customtabs.CustomTabsServiceConnection;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.utilities.CustomTabHelper;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n /**\n  * @author James Knight\n  */\n \n-public class UrlWidgetTest extends QuestionWidgetTest<UrlWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public UrlWidget createWidget() {\n-        return new UrlWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+@RunWith(RobolectricTestRunner.class)\n+public class UrlWidgetTest {\n+\n+    private CustomTabHelper customTabHelper;\n+    private CustomTabsServiceConnection serviceConnection;\n+    private OnLongClickListener listener;\n+\n+    @Before\n+    public void setUp() {\n+        customTabHelper = mock(CustomTabHelper.class);\n+        serviceConnection = mock(CustomTabsServiceConnection.class);\n+        listener = mock(OnLongClickListener.class);\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void usingReadOnlyOption_makeAllClickableElementsDisabled() {\n+        UrlWidget widget = createWidget(promptWithReadOnly());\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        assertThat(urlButton.getVisibility(), equalTo(View.GONE));\n+    }\n+\n+    @Test\n+    public void clearAnswer_doesNotClearWidgetAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptHasAnswer_displaysAnswer() {\n+        UrlWidget widget = createWidget(promptWithAnswer(new StringData(\"blah\")));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"blah\"));\n+    }\n+\n+    @Test\n+    public void whenPromptAnswerDoesNotHaveAnswer_displayEmptyString() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(((TextView) widget.findViewById(R.id.url_answer_text)).getText().toString(), equalTo(\"\"));\n+    }\n+\n+    @Test\n+    public void clickingButtonWhenUrlIsEmpty_doesNotCallOpenUri() {\n+        UrlWidget widget = createWidget(promptWithAnswer(null));\n+        Button urlButton = widget.findViewById(R.id.url_button);\n+        urlButton.performClick();\n+\n+        verify(customTabHelper, never()).bindCustomTabsService(null, null);\n+        verify(customTabHelper, never()).openUri(null, null);\n+    }\n+\n+    @Test\n+    public void clickingButton_callsCorrectMethods() {", "originalCommit": "7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r434998262", "bodyText": "Since we're going to be touching every widget, should we consider using view binding?", "author": "lognaturel", "createdAt": "2020-06-04T05:20:31Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -41,32 +42,43 @@\n @SuppressLint(\"ViewConstructor\")\n public class UrlWidget extends QuestionWidget implements ButtonWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);", "originalCommit": "7525a9aeefe3604d0c94c03c4c6d0a19f5248c54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA5NDg4OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r435094888", "bodyText": "Yes, actually. I didn't realize I can directly use them without view binding. And as a lot of tests have to be added, this is a better option.", "author": "SaumiaSinghal", "createdAt": "2020-06-04T08:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQxNzkwOQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r435417909", "bodyText": "Just a small wording correction, you're actually using the view binding feature now rather than explicitly binding your views. I know, it's confusing. Speaking of confusing, where is view binding turned on, @seadowg? I'm confused about not seeing it in the build.gradle file.", "author": "lognaturel", "createdAt": "2020-06-04T17:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIzNDQxNw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437234417", "bodyText": "I'm also confused. It looks like @SaumiaSinghal is just using findViewById with protected fields. @lognaturel just to be clear are you saying we should move to using the new View Binding feature before we accept this PR? I'd be in favour of that if so.", "author": "seadowg", "createdAt": "2020-06-09T08:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NjI1NQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437286255", "bodyText": "Yes @seadowg :/ I was. I fixed that.", "author": "SaumiaSinghal", "createdAt": "2020-06-09T09:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyMTA3Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r440921072", "bodyText": "Sorry, now I'm really confused, too! Yes, @seadowg, that's what I was requesting. I was expecting not to see any more explicit findViewById in the final code but they're still there.", "author": "lognaturel", "createdAt": "2020-06-16T15:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk5ODI2Mg=="}], "type": "inlineReview"}, {"oid": "e622a281b2216aee38d9a9f62a441d73904bc5db", "url": "https://github.com/getodk/collect/commit/e622a281b2216aee38d9a9f62a441d73904bc5db", "message": "add textAppearance for TextView", "committedDate": "2020-06-04T08:55:03Z", "type": "commit"}, {"oid": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "url": "https://github.com/getodk/collect/commit/a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "message": "use view binding", "committedDate": "2020-06-04T19:43:17Z", "type": "commit"}, {"oid": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "url": "https://github.com/getodk/collect/commit/a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "message": "use view binding", "committedDate": "2020-06-04T19:43:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4MzU2OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437283568", "bodyText": "Does that still make sense to implement ButtonWidget? That was created in order to use WidgetViewUtils.createSimpleButton() - one method used in widgets for generating a button but if we are going to use xml files instead of creating those buttons programmatically we probably can get rid of it right?", "author": "grzesiek2010", "createdAt": "2020-06-09T09:47:39Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -41,32 +42,43 @@\n @SuppressLint(\"ViewConstructor\")\n public class UrlWidget extends QuestionWidget implements ButtonWidget {", "originalCommit": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5OTgxNg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437299816", "bodyText": "I do think having a separate method onButtonClick() is redundant. We can have all the functionality in setOnClickListener() instead of explicitly calling onButtonClick() from there. Should I remove it?", "author": "SaumiaSinghal", "createdAt": "2020-06-09T10:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4MzU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMjY0Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437302642", "bodyText": "I'm not talking about removing that method you can keep since you call it in https://github.com/getodk/collect/pull/3831/files#diff-a5c152dc7425469015c19b7a29b8da07R69\nbut implementing the interface and using @Override above the method doesn't make sense because this method is no longer called like before (using interface from WidgetViewUtils.createSimpleButton()) you do that directly from the same widget (the line I attached).", "author": "grzesiek2010", "createdAt": "2020-06-09T10:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4MzU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMwMzgwOQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437303809", "bodyText": "Oh okay I understand. Thanks for explaining.", "author": "SaumiaSinghal", "createdAt": "2020-06-09T10:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4MzU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NDQyMQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437284421", "bodyText": "I would move this check to onButtonClick() then this expression will look simpler.", "author": "grzesiek2010", "createdAt": "2020-06-09T09:49:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -41,32 +42,43 @@\n @SuppressLint(\"ViewConstructor\")\n public class UrlWidget extends QuestionWidget implements ButtonWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> {\n+                if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {", "originalCommit": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NzM4OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437287388", "bodyText": "Please change this name we still have such one-char names in our codebase.", "author": "grzesiek2010", "createdAt": "2020-06-09T09:54:11Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -41,32 +42,43 @@\n @SuppressLint(\"ViewConstructor\")\n public class UrlWidget extends QuestionWidget implements ButtonWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> {\n+                if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {\n+                    onButtonClick(openUrlButton.getId());\n+                }\n+            });\n+        }\n+\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String s = prompt.getAnswerText();", "originalCommit": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MjUyMg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437292522", "bodyText": "What do you think about such comments? Even on master (before this big change) there is no single line crated by Yaw (every single line has been edited) of course the whole project exists thanks to Yaw but isn't git enough?", "author": "grzesiek2010", "createdAt": "2020-06-09T10:02:48Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,22 +17,23 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n \n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n-\n /**\n  * Widget that allows user to open URLs from within the form", "originalCommit": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3MDY2NA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437470664", "bodyText": "It was a question more to @lognaturel", "author": "grzesiek2010", "createdAt": "2020-06-09T14:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkyMjY4OQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r440922689", "bodyText": "I think in this case it makes sense to remove the whole header comment since it doesn't add much. I also know for sure that @yanokwa doesn't like @author tags and is happy for history to be in git.\nFor those who use @author tags, the rule is supposed to be that anyone who touches the file adds their name and names are never removed. For that reason I don't typically remove author tags from people I don't know.", "author": "lognaturel", "createdAt": "2020-06-16T15:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2NjE2OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r441466168", "bodyText": "Great! so @SaumiaSinghal please remove it.", "author": "grzesiek2010", "createdAt": "2020-06-17T11:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MjUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5NzQxMQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437297411", "bodyText": "The same here when it comes to naming.", "author": "grzesiek2010", "createdAt": "2020-06-09T10:11:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -41,32 +42,43 @@\n @SuppressLint(\"ViewConstructor\")\n public class UrlWidget extends QuestionWidget implements ButtonWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> {\n+                if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {\n+                    onButtonClick(openUrlButton.getId());\n+                }\n+            });\n+        }\n+\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String s = prompt.getAnswerText();\n         if (s != null) {", "originalCommit": "a68ff91d562d27d0e12fe4e1c5dc1c946433a4da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea089e852cf60dbb6a46fc57d125890027391a40", "url": "https://github.com/getodk/collect/commit/ea089e852cf60dbb6a46fc57d125890027391a40", "message": "change variable name", "committedDate": "2020-06-09T10:19:15Z", "type": "commit"}, {"oid": "33aa0281be2967799d169ec504597d67678c5225", "url": "https://github.com/getodk/collect/commit/33aa0281be2967799d169ec504597d67678c5225", "message": "remove implementation of the interface ButtonWidget", "committedDate": "2020-06-09T10:26:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NzA1NA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437347054", "bodyText": "You can simplify this: openUrlButton.setOnClickListener(v ->  onButtonClick());", "author": "grzesiek2010", "createdAt": "2020-06-09T11:49:08Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,56 +17,65 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n+\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> {", "originalCommit": "33aa0281be2967799d169ec504597d67678c5225", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d868a5904497215cfea63a483c386ca036c05f6", "url": "https://github.com/getodk/collect/commit/1d868a5904497215cfea63a483c386ca036c05f6", "message": "use spyActivity to verify unbindService() is called on detached from window", "committedDate": "2020-06-09T12:16:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437377105", "bodyText": "This check will be needed in case of every single widget button. If so it would be better to create our own WidgetButton class that will extend com.google.android.material.button.MaterialButton (then you can use it in your layout file). In such a class we can then override:\n    @Override\n    public boolean performClick() {\n        if (MultiClickGuard.allowClick(getClass().getName())) {\n            return super.performClick();\n        } else {\n            return false;\n        }\n    }\n\nwhat do you think about this approach?", "author": "grzesiek2010", "createdAt": "2020-06-09T12:34:48Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -105,13 +113,14 @@ protected void onDetachedFromWindow() {\n         }\n     }\n \n-    @Override\n-    public void onButtonClick(int buttonId) {\n-        if (!isUrlEmpty(stringAnswer)) {\n-            customTabHelper.bindCustomTabsService(getContext(), null);\n-            customTabHelper.openUri(getContext(), uri);\n-        } else {\n-            Toast.makeText(getContext(), \"No URL set\", Toast.LENGTH_SHORT).show();\n+    public void onButtonClick() {\n+        if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {", "originalCommit": "1d868a5904497215cfea63a483c386ca036c05f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwMzg0NA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437403844", "bodyText": "Yes, that would be great. I can create WidgetButton class in the material package?", "author": "SaumiaSinghal", "createdAt": "2020-06-09T13:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNjE3OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437406178", "bodyText": "Maybe later, we can shift more common functionality to the WidgetButton class.", "author": "SaumiaSinghal", "createdAt": "2020-06-09T13:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzMTQyNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437431425", "bodyText": "I can create WidgetButton class in the material package?\n\nI'm not sure that package contains implementations for elements that don't exist the Material Components framework in this case it's about customizing not implementing so maybe our main dir would be a better choice what do you think @seadowg", "author": "grzesiek2010", "createdAt": "2020-06-09T13:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1MTA4OQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437451089", "bodyText": "Yeah the material module is mostly for implementations of Material Components like @grzesiek2010 suggests. I'd say we could make a MulticlickSafeButton that extends MaterialButton and just lives in the org.odk.collect.android.views seeing as it's just a general view. If it seems like like we want one just for widgets it could live in the widgets package.", "author": "seadowg", "createdAt": "2020-06-09T14:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYzODc0MA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r438638740", "bodyText": "@seadowg @grzesiek2010, Should I go ahead and make MulticlickSafeButton in the org.odk.collect.android.views package?", "author": "SaumiaSinghal", "createdAt": "2020-06-11T08:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMTk1Ng==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r438721956", "bodyText": "Yes please go ahead you will need it in other widgets either way so I think it's a good idea", "author": "grzesiek2010", "createdAt": "2020-06-11T11:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3NzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3OTIyMA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437379220", "bodyText": "I would get rid of this field. this is used in just one place onButtonClick() so it would be better to add a method like:\n    private Uri getUri() {\n        return Uri.parse(stringAnswer.getText().toString());\n    }", "author": "grzesiek2010", "createdAt": "2020-06-09T12:38:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,56 +17,63 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n+    private Uri uri;", "originalCommit": "1d868a5904497215cfea63a483c386ca036c05f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "url": "https://github.com/getodk/collect/commit/e245eeacbc776adebdf4b2dff704a99ff8b1605b", "message": "remove uri variable", "committedDate": "2020-06-09T13:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzOTc1Mg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437439752", "bodyText": "Do we need this check? I'm pretty sure we can call setText(null) and it's safe. Could you check and remove it if not needed?", "author": "grzesiek2010", "createdAt": "2020-06-09T13:54:11Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,78 +17,88 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n-        if (s != null) {\n-            stringAnswer.setText(s);\n-            uri = Uri.parse(stringAnswer.getText().toString());\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> onButtonClick());\n         }\n \n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(openUrlButton);\n-        answerLayout.addView(stringAnswer);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String answerText = prompt.getAnswerText();\n+        if (answerText != null) {", "originalCommit": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MjQ0Nw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437442447", "bodyText": "Please move this method to the bottom of the class since it's private and used only by onButtonClick().", "author": "grzesiek2010", "createdAt": "2020-06-09T13:57:01Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,78 +17,88 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n-        if (s != null) {\n-            stringAnswer.setText(s);\n-            uri = Uri.parse(stringAnswer.getText().toString());\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> onButtonClick());\n         }\n \n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(openUrlButton);\n-        answerLayout.addView(stringAnswer);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String answerText = prompt.getAnswerText();\n+        if (answerText != null) {\n+            stringAnswer.setText(answerText);\n+        }\n \n-        customTabHelper = new CustomTabHelper();\n+        return answerView;\n     }\n \n     private boolean isUrlEmpty(TextView stringAnswer) {", "originalCommit": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MzE2Mw==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437443163", "bodyText": "The same with getUri()", "author": "grzesiek2010", "createdAt": "2020-06-09T13:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MjQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0NTk0NA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437445944", "bodyText": "Please add @OverRide I know it's not required but if we do that for all the other methods let's keep consistency.", "author": "grzesiek2010", "createdAt": "2020-06-09T14:00:58Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -105,13 +115,14 @@ protected void onDetachedFromWindow() {\n         }", "originalCommit": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0NzkwNQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437447905", "bodyText": "We have ToastUtils class which we use for displaying toast so we should use it here as well.", "author": "grzesiek2010", "createdAt": "2020-06-09T14:03:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -105,13 +115,14 @@ protected void onDetachedFromWindow() {\n         }\n     }\n \n-    @Override\n-    public void onButtonClick(int buttonId) {\n-        if (!isUrlEmpty(stringAnswer)) {\n-            customTabHelper.bindCustomTabsService(getContext(), null);\n-            customTabHelper.openUri(getContext(), uri);\n-        } else {\n-            Toast.makeText(getContext(), \"No URL set\", Toast.LENGTH_SHORT).show();\n+    public void onButtonClick() {\n+        if (MultiClickGuard.allowClick(QuestionWidget.class.getName())) {\n+            if (!isUrlEmpty(stringAnswer)) {\n+                customTabHelper.bindCustomTabsService(getContext(), null);\n+                customTabHelper.openUri(getContext(), getUri());\n+            } else {\n+                Toast.makeText(getContext(), \"No URL set\", Toast.LENGTH_SHORT).show();", "originalCommit": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0ODA2OA==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437448068", "bodyText": "We have ToastUtils class which we use for displaying toast so we should use it here as well.", "author": "grzesiek2010", "createdAt": "2020-06-09T14:03:48Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,78 +17,88 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n-        if (s != null) {\n-            stringAnswer.setText(s);\n-            uri = Uri.parse(stringAnswer.getText().toString());\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> onButtonClick());\n         }\n \n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(openUrlButton);\n-        answerLayout.addView(stringAnswer);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String answerText = prompt.getAnswerText();\n+        if (answerText != null) {\n+            stringAnswer.setText(answerText);\n+        }\n \n-        customTabHelper = new CustomTabHelper();\n+        return answerView;\n     }\n \n     private boolean isUrlEmpty(TextView stringAnswer) {\n         return stringAnswer == null || stringAnswer.getText() == null\n                 || stringAnswer.getText().toString().isEmpty();\n     }\n \n+    private Uri getUri() {\n+        return Uri.parse(stringAnswer.getText().toString());\n+    }\n+\n     @Override\n     public void clearAnswer() {\n         Toast.makeText(getContext(), \"URL is readonly\", Toast.LENGTH_SHORT).show();", "originalCommit": "e245eeacbc776adebdf4b2dff704a99ff8b1605b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ca22e0ed2d0710b628347b1a0135ed4e1c80cef", "url": "https://github.com/getodk/collect/commit/8ca22e0ed2d0710b628347b1a0135ed4e1c80cef", "message": "code refactor", "committedDate": "2020-06-09T14:14:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MjUwMQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437462501", "bodyText": "Even lower please :) both are called only by onButtonClick() so it looks better if we have them below. Sorry for being picky but if you are rebuilding the widget it's good do fix even such small things.", "author": "grzesiek2010", "createdAt": "2020-06-09T14:22:44Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -108,20 +97,30 @@ public void cancelLongPress() {\n         stringAnswer.cancelLongPress();\n     }\n \n+    @Override\n     protected void onDetachedFromWindow() {\n         super.onDetachedFromWindow();\n         if (customTabHelper.getServiceConnection() != null) {\n             getContext().unbindService(customTabHelper.getServiceConnection());\n         }\n     }\n \n+    private boolean isUrlEmpty(TextView stringAnswer) {", "originalCommit": "8ca22e0ed2d0710b628347b1a0135ed4e1c80cef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2NzY1OQ==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437467659", "bodyText": "Oh no that's okay! It's good if we have all these things fixed.", "author": "SaumiaSinghal", "createdAt": "2020-06-09T14:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2MjUwMQ=="}], "type": "inlineReview"}, {"oid": "eb24e058e43aad3a382145dd0ebe377b6405094c", "url": "https://github.com/getodk/collect/commit/eb24e058e43aad3a382145dd0ebe377b6405094c", "message": "code refactor", "committedDate": "2020-06-09T14:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk0MTEzMg==", "url": "https://github.com/getodk/collect/pull/3831#discussion_r437941132", "bodyText": "I think now you can get rid of this variable and just call stringAnswer.setText(prompt.getAnswerText()); below, it won't be a long or unclear expression.", "author": "grzesiek2010", "createdAt": "2020-06-10T08:12:16Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/UrlWidget.java", "diffHunk": "@@ -17,78 +17,77 @@\n import android.annotation.SuppressLint;\n import android.content.Context;\n import android.net.Uri;\n+import android.util.TypedValue;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n import android.widget.Button;\n-import android.widget.LinearLayout;\n import android.widget.TextView;\n-import android.widget.Toast;\n \n import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.formentry.questions.WidgetViewUtils;\n import org.odk.collect.android.utilities.CustomTabHelper;\n-import org.odk.collect.android.widgets.interfaces.ButtonWidget;\n-\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.createSimpleButton;\n-import static org.odk.collect.android.formentry.questions.WidgetViewUtils.getCenteredAnswerTextView;\n+import org.odk.collect.android.utilities.MultiClickGuard;\n+import org.odk.collect.android.utilities.ToastUtils;\n \n /**\n  * Widget that allows user to open URLs from within the form\n  *\n  * @author Yaw Anokwa (yanokwa@gmail.com)\n  */\n @SuppressLint(\"ViewConstructor\")\n-public class UrlWidget extends QuestionWidget implements ButtonWidget {\n+public class UrlWidget extends QuestionWidget {\n \n-    private Uri uri;\n-    final Button openUrlButton;\n-    final TextView stringAnswer;\n     private final CustomTabHelper customTabHelper;\n \n-    public UrlWidget(Context context, QuestionDetails questionDetails) {\n+    protected Button openUrlButton;\n+    protected TextView stringAnswer;\n+\n+    public UrlWidget(Context context, QuestionDetails questionDetails, CustomTabHelper customTabHelper) {\n         super(context, questionDetails);\n+        this.customTabHelper = customTabHelper;\n+    }\n \n-        openUrlButton = createSimpleButton(getContext(), getFormEntryPrompt().isReadOnly(), context.getString(R.string.open_url), getAnswerFontSize(), this);\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        ViewGroup answerView = (ViewGroup) LayoutInflater.from(context).inflate(R.layout.url_widget_answer, null);\n \n-        stringAnswer = getCenteredAnswerTextView(getContext(), getAnswerFontSize());\n+        openUrlButton = answerView.findViewById(R.id.url_button);\n+        stringAnswer = answerView.findViewById(R.id.url_answer_text);\n \n-        String s = questionDetails.getPrompt().getAnswerText();\n-        if (s != null) {\n-            stringAnswer.setText(s);\n-            uri = Uri.parse(stringAnswer.getText().toString());\n+        if (prompt.isReadOnly()) {\n+            openUrlButton.setVisibility(GONE);\n+        } else {\n+            openUrlButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            openUrlButton.setOnClickListener(v -> onButtonClick());\n         }\n \n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(openUrlButton);\n-        answerLayout.addView(stringAnswer);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n+        stringAnswer.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+        String answerText = prompt.getAnswerText();", "originalCommit": "eb24e058e43aad3a382145dd0ebe377b6405094c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9388b004f379cf70ae2347759748b5039270ae9", "url": "https://github.com/getodk/collect/commit/e9388b004f379cf70ae2347759748b5039270ae9", "message": "remove answerTest variable", "committedDate": "2020-06-10T13:42:36Z", "type": "commit"}, {"oid": "33a27cee1a8876e771c0f6f7e7aa2b1dc6b60ae2", "url": "https://github.com/getodk/collect/commit/33a27cee1a8876e771c0f6f7e7aa2b1dc6b60ae2", "message": "create MultiClickSafeButton class in views", "committedDate": "2020-06-11T19:12:30Z", "type": "commit"}, {"oid": "c62b83c135fe9541156393049f7984586fc57cb1", "url": "https://github.com/getodk/collect/commit/c62b83c135fe9541156393049f7984586fc57cb1", "message": "unit tests refactor", "committedDate": "2020-06-11T22:06:25Z", "type": "commit"}, {"oid": "dfa3f6d05e79e8a3154b12a57401bcbb1ef2ee76", "url": "https://github.com/getodk/collect/commit/dfa3f6d05e79e8a3154b12a57401bcbb1ef2ee76", "message": "use view binding", "committedDate": "2020-06-17T00:27:20Z", "type": "commit"}, {"oid": "3e7099591b84afbc0b53d9eb0840997fb317f234", "url": "https://github.com/getodk/collect/commit/3e7099591b84afbc0b53d9eb0840997fb317f234", "message": "fix pmd", "committedDate": "2020-06-17T09:47:16Z", "type": "commit"}, {"oid": "b0a06037b95a1805335843dc089e59a42983ffa3", "url": "https://github.com/getodk/collect/commit/b0a06037b95a1805335843dc089e59a42983ffa3", "message": "enable checkGeneratedSources in lintOptions", "committedDate": "2020-06-17T10:45:36Z", "type": "commit"}, {"oid": "819b010277a11d886434c9a0a20dac685160790b", "url": "https://github.com/getodk/collect/commit/819b010277a11d886434c9a0a20dac685160790b", "message": "remove author header comment", "committedDate": "2020-06-17T11:47:52Z", "type": "commit"}]}