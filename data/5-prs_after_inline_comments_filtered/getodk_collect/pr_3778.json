{"pr_number": 3778, "pr_title": "Provide submission summary when tapping a submission on the form map", "pr_createdAt": "2020-04-16T08:01:39Z", "pr_url": "https://github.com/getodk/collect/pull/3778", "timeline": [{"oid": "529df4835c73f47a6785cb32290e818e3233a957", "url": "https://github.com/getodk/collect/commit/529df4835c73f47a6785cb32290e818e3233a957", "message": "Fixed bug - open read_only form only for review", "committedDate": "2020-05-06T12:35:10Z", "type": "forcePushed"}, {"oid": "0659df5e20dbf0cb50040763e48f893e735cc4f7", "url": "https://github.com/getodk/collect/commit/0659df5e20dbf0cb50040763e48f893e735cc4f7", "message": "Reverted redundant changes", "committedDate": "2020-05-11T18:49:07Z", "type": "forcePushed"}, {"oid": "6a283df8be4f761a83fb48f1bedbfcea73210228", "url": "https://github.com/getodk/collect/commit/6a283df8be4f761a83fb48f1bedbfcea73210228", "message": "Reverted redundant changes", "committedDate": "2020-05-11T18:50:22Z", "type": "forcePushed"}, {"oid": "fa046b9dc02956e0b2ff7550a733d67821f36bed", "url": "https://github.com/getodk/collect/commit/fa046b9dc02956e0b2ff7550a733d67821f36bed", "message": "Reverted redundant changes", "committedDate": "2020-05-11T18:52:59Z", "type": "forcePushed"}, {"oid": "f577f4ef7cfce2022415383eab4f27b89d0bcbd8", "url": "https://github.com/getodk/collect/commit/f577f4ef7cfce2022415383eab4f27b89d0bcbd8", "message": "Added submission_summary_layout", "committedDate": "2020-05-12T12:37:52Z", "type": "commit"}, {"oid": "a8462b91570cf3e806e2cd6564c0497058f3fb29", "url": "https://github.com/getodk/collect/commit/a8462b91570cf3e806e2cd6564c0497058f3fb29", "message": "Improved instance_map_layout", "committedDate": "2020-05-12T12:37:52Z", "type": "commit"}, {"oid": "70030276c7bd4795e6cbf0ea9ec59c08af35f09a", "url": "https://github.com/getodk/collect/commit/70030276c7bd4795e6cbf0ea9ec59c08af35f09a", "message": "Improved submission_summary_layout", "committedDate": "2020-05-12T12:37:52Z", "type": "commit"}, {"oid": "839c6e9a74792d1f246a3baed7592aff45a2c4d2", "url": "https://github.com/getodk/collect/commit/839c6e9a74792d1f246a3baed7592aff45a2c4d2", "message": "Added required icons", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "46a4c7024bcea38622973b264b15b849f2212714", "url": "https://github.com/getodk/collect/commit/46a4c7024bcea38622973b264b15b849f2212714", "message": "Show bottom sheet after clicking on a marker", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "58df006cd7a6cd2237ad19a5cd7a3f82ee32445c", "url": "https://github.com/getodk/collect/commit/58df006cd7a6cd2237ad19a5cd7a3f82ee32445c", "message": "Center the selected marker", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "79413390da05235b9707aa27ac82e7a83292379e", "url": "https://github.com/getodk/collect/commit/79413390da05235b9707aa27ac82e7a83292379e", "message": "Removed unused import", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "24aae6d010c5333c465d0207a4d72aad8e0040fc", "url": "https://github.com/getodk/collect/commit/24aae6d010c5333c465d0207a4d72aad8e0040fc", "message": "Display date and status in one row like we do in lists of instances", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "68d2d48901305e0512717af1e05c001804053890", "url": "https://github.com/getodk/collect/commit/68d2d48901305e0512717af1e05c001804053890", "message": "Replaced FAB with a Chip", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "90838f629e010cc54793b2a8a4a9be3c44778be7", "url": "https://github.com/getodk/collect/commit/90838f629e010cc54793b2a8a4a9be3c44778be7", "message": "Fixed bug - open read_only form only for review", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "ba7242f842212f6ece2ac332ca508a6973d02073", "url": "https://github.com/getodk/collect/commit/ba7242f842212f6ece2ac332ca508a6973d02073", "message": "Added missing test props", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "b422ab5c986d8df9000ddd7097e70f0b8d88d82a", "url": "https://github.com/getodk/collect/commit/b422ab5c986d8df9000ddd7097e70f0b8d88d82a", "message": "Fixed naming bug", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "31b9af53c74baecf1306fd7a5d5bcd36e3d95a11", "url": "https://github.com/getodk/collect/commit/31b9af53c74baecf1306fd7a5d5bcd36e3d95a11", "message": "Improved submission_summary_layout", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "c275496e1ae723016e22fcc07f6a83451b941f31", "url": "https://github.com/getodk/collect/commit/c275496e1ae723016e22fcc07f6a83451b941f31", "message": "Refactored BottomSheet to BottomSheetDialog", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "a9367b2c776b608b52eb491a169fceb35e535a89", "url": "https://github.com/getodk/collect/commit/a9367b2c776b608b52eb491a169fceb35e535a89", "message": "Fixed tests", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "772049cd53f17ef6fd4687bc58eea5978c8f604d", "url": "https://github.com/getodk/collect/commit/772049cd53f17ef6fd4687bc58eea5978c8f604d", "message": "Fixed code style", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "d5526e5fa47369d0df393dfa0789c6359b57fb2c", "url": "https://github.com/getodk/collect/commit/d5526e5fa47369d0df393dfa0789c6359b57fb2c", "message": "Reverted redundant changes", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "99ab7fe9121c11e5cb5df43abe922eee169a1b43", "url": "https://github.com/getodk/collect/commit/99ab7fe9121c11e5cb5df43abe922eee169a1b43", "message": "Added displeying the summary dialog for encrypted and deleted forms ans well to keep consistency", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "7e8b28ecf43ebb8e9fb7be8303a6a20a5793b221", "url": "https://github.com/getodk/collect/commit/7e8b28ecf43ebb8e9fb7be8303a6a20a5793b221", "message": "Dismiss dialog after opening a form", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "bae9c24945565cd1fe16cfcfdc266a66fcf7afaa", "url": "https://github.com/getodk/collect/commit/bae9c24945565cd1fe16cfcfdc266a66fcf7afaa", "message": "Code improvements", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "6c78309938b7ad2a2eb8a71ff9b55e2d1441ff23", "url": "https://github.com/getodk/collect/commit/6c78309938b7ad2a2eb8a71ff9b55e2d1441ff23", "message": "Code improvements in order to use FormMapViewModel in InstanceSummaryDialogFragment", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "d82268ee7acf208e0bf5554a34245656b0dcf7c0", "url": "https://github.com/getodk/collect/commit/d82268ee7acf208e0bf5554a34245656b0dcf7c0", "message": "Fixed comment", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "0b7079d5c1049e7681ce284dc0e645da51542999", "url": "https://github.com/getodk/collect/commit/0b7079d5c1049e7681ce284dc0e645da51542999", "message": "Factored out getSubmissionSummaryStatusIcon to IconUtils", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "f40e57d282fbf0842cafad2ed81f0e5b83e33e05", "url": "https://github.com/getodk/collect/commit/f40e57d282fbf0842cafad2ed81f0e5b83e33e05", "message": "Code improvements", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "c09cb2c1af0775e69b12171e9352c87225a4ace9", "url": "https://github.com/getodk/collect/commit/c09cb2c1af0775e69b12171e9352c87225a4ace9", "message": "Use showIfNotShowing to display InstanceSummaryDialogFragment", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "395958e5eebc9ec6bf72fa98a7587e551931771d", "url": "https://github.com/getodk/collect/commit/395958e5eebc9ec6bf72fa98a7587e551931771d", "message": "Fixed status icon size", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "835ed3ed3bcd0de80efa8231999e03f16af90abd", "url": "https://github.com/getodk/collect/commit/835ed3ed3bcd0de80efa8231999e03f16af90abd", "message": "Code improvements - use just instanceId in InstanceSummaryDialogFragment to build it", "committedDate": "2020-05-12T12:42:31Z", "type": "commit"}, {"oid": "16fb8755013e77f051ccf0c4f607465ee543a2cf", "url": "https://github.com/getodk/collect/commit/16fb8755013e77f051ccf0c4f607465ee543a2cf", "message": "Layout improvements", "committedDate": "2020-05-12T12:54:41Z", "type": "commit"}, {"oid": "16fb8755013e77f051ccf0c4f607465ee543a2cf", "url": "https://github.com/getodk/collect/commit/16fb8755013e77f051ccf0c4f607465ee543a2cf", "message": "Layout improvements", "committedDate": "2020-05-12T12:54:41Z", "type": "forcePushed"}, {"oid": "54702100a73b76ffcfca67d730e4f4b7b743881c", "url": "https://github.com/getodk/collect/commit/54702100a73b76ffcfca67d730e4f4b7b743881c", "message": "Fixed tests", "committedDate": "2020-05-12T16:29:55Z", "type": "commit"}, {"oid": "54702100a73b76ffcfca67d730e4f4b7b743881c", "url": "https://github.com/getodk/collect/commit/54702100a73b76ffcfca67d730e4f4b7b743881c", "message": "Fixed tests", "committedDate": "2020-05-12T16:29:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MTU5Mw==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424151593", "bodyText": "It doesn't make sense to have both onFeatureClicked and showSummary since they have the same parameters and showSummary is only called from here. I'd keep onFeatureClicked and move the code here but you could also rename it to showSummary if you think that's clearer.", "author": "lognaturel", "createdAt": "2020-05-13T03:24:50Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormMapActivity.java", "diffHunk": "@@ -223,47 +216,10 @@ public void onLocationChanged(MapPoint point) {\n     }\n \n     /**\n-     * Reacts to a tap on a feature by showing a toast or switching activities to view or edit a form.\n+     * Reacts to a tap on a feature by showing a submission summary.\n      */\n     public void onFeatureClicked(int featureId) {\n-        MappableFormInstance instance = instancesByFeatureId.get(featureId);\n-        ClickAction clickAction = instance == null ? FormMapViewModel.ClickAction.NONE : instance.getClickAction();\n-\n-        boolean canEditSaved = (Boolean) AdminSharedPreferences.getInstance().get(AdminKeys.KEY_EDIT_SAVED);\n-\n-        switch (clickAction) {\n-            case DELETED_TOAST:\n-                String deletedTime = getString(R.string.deleted_on_date_at_time);\n-                String disabledMessage = new SimpleDateFormat(deletedTime,\n-                        Locale.getDefault()).format(viewModel.getDeletedDateOf(instance.getDatabaseId()));\n-\n-                ToastUtils.showLongToast(disabledMessage);\n-                break;\n-            case NOT_VIEWABLE_TOAST:\n-                ToastUtils.showLongToast(R.string.cannot_edit_completed_form);\n-                break;\n-            case OPEN_READ_ONLY:\n-                startActivity(getViewOnlyFormInstanceIntentFor(featureId));\n-                break;\n-            case OPEN_EDIT:\n-                if (canEditSaved) {\n-                    startActivity(getEditFormInstanceIntentFor(featureId));\n-                } else {\n-                    startActivity(getViewOnlyFormInstanceIntentFor(featureId));\n-                }\n-                break;\n-        }\n-    }\n-\n-    private Intent getEditFormInstanceIntentFor(int featureId) {\n-        Uri uri = ContentUris.withAppendedId(InstanceColumns.CONTENT_URI, instancesByFeatureId.get(featureId).getDatabaseId());\n-        return new Intent(Intent.ACTION_EDIT, uri);\n-    }\n-\n-    private Intent getViewOnlyFormInstanceIntentFor(int featureId) {\n-        Intent intent = getEditFormInstanceIntentFor(featureId);\n-        intent.putExtra(ApplicationConstants.BundleKeys.FORM_MODE, ApplicationConstants.FormModes.VIEW_SENT);\n-        return intent;\n+        showSummary(featureId);", "originalCommit": "54702100a73b76ffcfca67d730e4f4b7b743881c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3Mjk2MA==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424472960", "bodyText": "Fixed.", "author": "grzesiek2010", "createdAt": "2020-05-13T14:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MTU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1Mjk5NA==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424152994", "bodyText": "This is much better and I guess that if truly only necessary data is being saved continuing to use onSaveInstanceState is not so bad.", "author": "lognaturel", "createdAt": "2020-05-13T03:31:25Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/InstanceSummaryDialogFragment.java", "diffHunk": "@@ -0,0 +1,144 @@\n+package org.odk.collect.android.fragments.dialogs;\n+\n+import android.content.ContentUris;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.net.Uri;\n+import android.os.Bundle;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.ImageView;\n+import android.widget.TextView;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.core.content.ContextCompat;\n+import androidx.lifecycle.ViewModelProviders;\n+\n+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;\n+import com.google.android.material.chip.Chip;\n+\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.viewmodels.FormMapViewModel;\n+import org.odk.collect.android.preferences.AdminKeys;\n+import org.odk.collect.android.preferences.AdminSharedPreferences;\n+import org.odk.collect.android.provider.InstanceProvider;\n+import org.odk.collect.android.provider.InstanceProviderAPI;\n+import org.odk.collect.android.utilities.ApplicationConstants;\n+import org.odk.collect.android.utilities.IconUtils;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.Locale;\n+\n+import butterknife.BindView;\n+import butterknife.ButterKnife;\n+\n+public class InstanceSummaryDialogFragment extends BottomSheetDialogFragment {\n+    public static final String INSTANCE_ID = \"instanceId\";\n+\n+    private long instanceId;\n+\n+    private FormMapViewModel viewModel;\n+\n+    @BindView(R.id.submission_name)\n+    public TextView submissionName;\n+\n+    @BindView(R.id.status_icon)\n+    public ImageView statusIcon;\n+\n+    @BindView(R.id.status_text)\n+    public TextView statusText;\n+\n+    @BindView(R.id.info)\n+    public TextView infoText;\n+\n+    @BindView(R.id.openFormChip)\n+    public Chip openFormChip;\n+\n+    @Override\n+    public void onAttach(@NonNull Context context) {\n+        super.onAttach(context);\n+        viewModel = ViewModelProviders.of(requireActivity()).get(FormMapViewModel.class);\n+    }\n+\n+    @Nullable\n+    @Override\n+    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {\n+        View view = inflater.inflate(R.layout.submission_summary_layout, container, false);\n+        ButterKnife.bind(this, view);\n+        return view;\n+    }\n+\n+    @Override\n+    public void onSaveInstanceState(Bundle outState) {\n+        outState.putLong(INSTANCE_ID, instanceId);", "originalCommit": "54702100a73b76ffcfca67d730e4f4b7b743881c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MjQwOQ==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424472409", "bodyText": "This class no longer exists.", "author": "grzesiek2010", "createdAt": "2020-05-13T14:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1Mjk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MzM5Mw==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424153393", "bodyText": "Doing a sequential search here could be slow if there are lots of instances. I might have considered saving the database id to make this lookup fast. It's probably not that important to do now but wanted to flag it for future consideration.", "author": "lognaturel", "createdAt": "2020-05-13T03:33:17Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/viewmodels/FormMapViewModel.java", "diffHunk": "@@ -99,6 +102,15 @@ private void initializeFormInstances() {\n         return mappableFormInstances;\n     }\n \n+    public MappableFormInstance getInstanceById(long instanceId) {\n+        for (MappableFormInstance mappableFormInstance : mappableFormInstances) {", "originalCommit": "54702100a73b76ffcfca67d730e4f4b7b743881c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MjEyOQ==", "url": "https://github.com/getodk/collect/pull/3778#discussion_r424472129", "bodyText": "It is removed after removing BottomSheetDialogFragment", "author": "grzesiek2010", "createdAt": "2020-05-13T14:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE1MzM5Mw=="}], "type": "inlineReview"}, {"oid": "7421e589f4312131509518c941523f730608adbe", "url": "https://github.com/getodk/collect/commit/7421e589f4312131509518c941523f730608adbe", "message": "Removed redundant method", "committedDate": "2020-05-13T08:15:17Z", "type": "commit"}, {"oid": "471a4d8351aba5eb99c3d860ce0efb55b12f65f6", "url": "https://github.com/getodk/collect/commit/471a4d8351aba5eb99c3d860ce0efb55b12f65f6", "message": "Converted BottomSheetDialogFragment to BottomSheetBehavior", "committedDate": "2020-05-13T09:38:54Z", "type": "commit"}, {"oid": "471a4d8351aba5eb99c3d860ce0efb55b12f65f6", "url": "https://github.com/getodk/collect/commit/471a4d8351aba5eb99c3d860ce0efb55b12f65f6", "message": "Converted BottomSheetDialogFragment to BottomSheetBehavior", "committedDate": "2020-05-13T09:38:54Z", "type": "forcePushed"}, {"oid": "d055c812842a0c15d443eef5844982743bcb5577", "url": "https://github.com/getodk/collect/commit/d055c812842a0c15d443eef5844982743bcb5577", "message": "Fixed tests", "committedDate": "2020-05-13T10:23:23Z", "type": "commit"}, {"oid": "8871e9aaf5f14c38a3f974551e2b6d28e577c6ea", "url": "https://github.com/getodk/collect/commit/8871e9aaf5f14c38a3f974551e2b6d28e577c6ea", "message": "Added tests", "committedDate": "2020-05-13T12:26:02Z", "type": "commit"}, {"oid": "abd9bd561384cdef7cd467999cdd3f561d2ab203", "url": "https://github.com/getodk/collect/commit/abd9bd561384cdef7cd467999cdd3f561d2ab203", "message": "Enable animation when centering map after tapping on a marker", "committedDate": "2020-05-13T12:29:20Z", "type": "commit"}, {"oid": "42a972114fd8b1d8e47f52677384f289bc923526", "url": "https://github.com/getodk/collect/commit/42a972114fd8b1d8e47f52677384f289bc923526", "message": "Hide the bottomSheet after opening a form", "committedDate": "2020-05-13T14:19:59Z", "type": "commit"}]}