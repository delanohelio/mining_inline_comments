{"pr_number": 3843, "pr_title": "Add Progress Bar in the Blank Forms Fragment in 'Delete Saved Forms'", "pr_createdAt": "2020-05-18T17:10:27Z", "pr_url": "https://github.com/getodk/collect/pull/3843", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0NzE4MQ==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r429847181", "bodyText": "We shouldn't be using ProgressDialog any longer as it's deprecated. Annoyingly the warning doesn't show in Android Studio for some reason!\nIdeally there would be a different progress indicator that doesn't block the user. Here I don't want to get into that redesign though so for the moment we should just use a ProgressDialogFragment.", "author": "seadowg", "createdAt": "2020-05-25T09:56:23Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/FormManagerList.java", "diffHunk": "@@ -153,13 +156,24 @@ public void onClick(DialogInterface dialog, int i) {\n         alertDialog.show();\n     }\n \n+    @Override\n+    public void progressUpdate(int progress, int total) {\n+        String message = String.format(getResources().getString(R.string.deleting_form_dialog_update_message), progress, total);\n+        progressDialog.setMessage(message);\n+    }\n     /**\n      * Deletes the selected files.First from the database then from the file\n      * system\n      */\n     private void deleteSelectedForms() {\n         // only start if no other task is running\n         if (backgroundTasks.deleteFormsTask == null) {\n+            progressDialog = new ProgressDialog(getContext());", "originalCommit": "2464d92672f00ec4d2903835f1510f14580b8fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5OTU3NQ==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r430399575", "bodyText": "Hi @seadowg! We also use ProgressDialog in Delete Saved Forms fragment. Should we remove ProgressDialog from there too? Also, I found that the UI would look better if layout_centerVertical is set to true in the progress_dialog.xml file.", "author": "SaumiaSinghal", "createdAt": "2020-05-26T13:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg0ODAzNg==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r429848036", "bodyText": "I don't think we need to add the progress update functionality. It is extra complexity that we could add later if we feel we really need it. For the moment the dialog could just have the message \"Deleting...\".", "author": "seadowg", "createdAt": "2020-05-25T09:58:08Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/FormManagerList.java", "diffHunk": "@@ -153,13 +156,24 @@ public void onClick(DialogInterface dialog, int i) {\n         alertDialog.show();\n     }\n \n+    @Override\n+    public void progressUpdate(int progress, int total) {", "originalCommit": "2464d92672f00ec4d2903835f1510f14580b8fe3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1NDg0OA==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r433854848", "bodyText": "Like in the other PR this should use DialogUtils.showIfNotShowing and DialogUtils.dismissDialog. That way you also don't need to hold a reference to the dialog like you do here. In fact, it's important to realize you shouldn't ever hold a reference to a Fragment instead. This is because if the Activity is recreated (like during a rotation) the Fragment will be recreated as well and the instance you have a reference to will not be the instance that is actually displayed. This causes a memory leak (holding a reference to an object that could have been garbage collected) and also might lead to bugs.", "author": "seadowg", "createdAt": "2020-06-02T12:59:10Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/FormManagerList.java", "diffHunk": "@@ -160,6 +163,10 @@ public void onClick(DialogInterface dialog, int i) {\n     private void deleteSelectedForms() {\n         // only start if no other task is running\n         if (backgroundTasks.deleteFormsTask == null) {\n+            dialogFragment.setMessage(getResources().getString(R.string.form_delete_message));\n+            dialogFragment.setCancelable(false);\n+            dialogFragment.show(getActivity().getSupportFragmentManager(), ProgressDialogFragment.COLLECT_PROGRESS_DIALOG_TAG);", "originalCommit": "acd54309c3fed034390f4bfff19ac93537b3bb6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bba4869c7aca6250b7682dc4206695647c52f747", "url": "https://github.com/getodk/collect/commit/bba4869c7aca6250b7682dc4206695647c52f747", "message": "make unit tests pass", "committedDate": "2020-06-04T19:49:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNDI4Nw==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437224287", "bodyText": "You can just do putBoolean here which will be easier on the other side!", "author": "seadowg", "createdAt": "2020-06-09T08:22:13Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/FormManagerList.java", "diffHunk": "@@ -160,6 +163,12 @@ public void onClick(DialogInterface dialog, int i) {\n     private void deleteSelectedForms() {\n         // only start if no other task is running\n         if (backgroundTasks.deleteFormsTask == null) {\n+\n+            Bundle args = new Bundle();\n+            args.putSerializable(ProgressDialogFragment.MESSAGE, getResources().getString(R.string.form_delete_message));\n+            args.putSerializable(ProgressDialogFragment.CANCELABLE, \"true\");", "originalCommit": "bba4869c7aca6250b7682dc4206695647c52f747", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNDc5MA==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437224790", "bodyText": "Also could you add a test for this new functionality to ProgressDialogFragment? I think before adding/changing functionality like this to a reusable component you should try adding a test. This ensures you actually have coverage and also gives you an opportunity to think about the interface you're adding/changing.", "author": "seadowg", "createdAt": "2020-06-09T08:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4NDQ1Mg==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437284452", "bodyText": "Yes that would be great! I'll add tests. Also, I wanted to ask, should we use ProgressDialogFragment in DeleteSavedForms Fragment, as well?", "author": "SaumiaSinghal", "createdAt": "2020-06-09T09:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNDI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MjI1MQ==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437492251", "bodyText": "@SaumiaSinghal probably a good idea down the line but no need to do it as part of this PR", "author": "seadowg", "createdAt": "2020-06-09T15:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNDI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5NDQ3NA==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437494474", "bodyText": "I don't think this is right. Did you try commenting out your code to check this test passes and fails when you'd expect?\nClosing the activity might not \"cancel\" the dialog but it definitely wouldn't be on screen anymore so this test doesn't really make sense to me. You should be able to check whether the dialog is cancellable or not by calling isCancellable on it.", "author": "seadowg", "createdAt": "2020-06-09T15:03:37Z", "path": "collect_app/src/test/java/org/odk/collect/android/fragments/dialogs/ProgressDialogFragmentTest.java", "diffHunk": "@@ -106,6 +106,26 @@ public void setMessage_beforeDialogExists_setsMessageWhenDialogShown() {\n         });\n     }\n \n+    @Test\n+    public void setCancellable_makesTheDialogNotCancellable() {\n+        activityScenario.onActivity(activity -> {\n+            ProgressDialogFragment fragment = new ProgressDialogFragment();\n+\n+            Bundle args = new Bundle();\n+            args.putBoolean(ProgressDialogFragment.CANCELABLE, false);\n+            fragment.setArguments(args);\n+            fragment.show(activity.getSupportFragmentManager(), \"TAG\");\n+            shadowOf(getMainLooper()).idle();\n+\n+            AlertDialog dialog = (AlertDialog) fragment.getDialog();\n+\n+            activity.finish();", "originalCommit": "d8466400b5ecfc4e2e5d1705bba1b9c440ebb244", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5NTY1Ng==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r437495656", "bodyText": "I think this could just be:\nif (getArguments() != null) {\n    dialog.setCancelable(getArguments().getBoolean(CANCELABLE), true));\n}\n\nIs that right?", "author": "seadowg", "createdAt": "2020-06-09T15:05:09Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/ProgressDialogFragment.java", "diffHunk": "@@ -104,6 +108,10 @@ private void setupView(@NonNull AlertDialog dialog) {\n             ((TextView) dialogView.findViewById(R.id.message)).setText(getArguments().getString(MESSAGE));\n         }\n \n+        if (getArguments() != null && Objects.equals(getArguments().getBoolean(CANCELABLE), false)) {", "originalCommit": "d8466400b5ecfc4e2e5d1705bba1b9c440ebb244", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "010ce99ce079cbef8484224db202d98c5b9ceea1", "url": "https://github.com/getodk/collect/commit/010ce99ce079cbef8484224db202d98c5b9ceea1", "message": "added progress dialog", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "502fa8bf8b7d6f7e9b0605ec1be8ff1f9c63198f", "url": "https://github.com/getodk/collect/commit/502fa8bf8b7d6f7e9b0605ec1be8ff1f9c63198f", "message": "updated deleteFormsTask", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "ab190729da43024b7ba9b9ccb0b10935ccc8bd11", "url": "https://github.com/getodk/collect/commit/ab190729da43024b7ba9b9ccb0b10935ccc8bd11", "message": "replaced progress dialog with progress dialog fragment", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "c787eb8b305f39a06dcca30d531fef2f2c4ae31c", "url": "https://github.com/getodk/collect/commit/c787eb8b305f39a06dcca30d531fef2f2c4ae31c", "message": "removed progress update method", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "54671e0a5400a3fadf392bcbdd47c8545a8cbb0f", "url": "https://github.com/getodk/collect/commit/54671e0a5400a3fadf392bcbdd47c8545a8cbb0f", "message": "fixed pmd", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "fb6e28fce63f29acb527eb7763c9eed0e7b5a726", "url": "https://github.com/getodk/collect/commit/fb6e28fce63f29acb527eb7763c9eed0e7b5a726", "message": "remove publishProgress from DeleteFormsTask", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "83d48b88f9ebf124ac9a6fd409d2357fc0f90b8d", "url": "https://github.com/getodk/collect/commit/83d48b88f9ebf124ac9a6fd409d2357fc0f90b8d", "message": "replace dialog.show() and dialog.dismiss() by DialogUtils method", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "0ca67603207327c5a86c4965ec87c8d5b97972bd", "url": "https://github.com/getodk/collect/commit/0ca67603207327c5a86c4965ec87c8d5b97972bd", "message": "make unit tests pass", "committedDate": "2020-06-30T05:48:54Z", "type": "commit"}, {"oid": "1ddf2e7a218f303728eee70319a30dce01276905", "url": "https://github.com/getodk/collect/commit/1ddf2e7a218f303728eee70319a30dce01276905", "message": "refactor code and add unit test", "committedDate": "2020-06-30T05:48:55Z", "type": "commit"}, {"oid": "cfea78a9dc2a24bbec8c717fa2b97c3fbdc58cbd", "url": "https://github.com/getodk/collect/commit/cfea78a9dc2a24bbec8c717fa2b97c3fbdc58cbd", "message": "fix pmd", "committedDate": "2020-06-30T05:48:55Z", "type": "commit"}, {"oid": "7ee6a81ff5203795e8c76d1df5e978b9f8126a1c", "url": "https://github.com/getodk/collect/commit/7ee6a81ff5203795e8c76d1df5e978b9f8126a1c", "message": "update unit test", "committedDate": "2020-06-30T05:48:55Z", "type": "commit"}, {"oid": "07b80b5cb7d6aa421c2269c4d283c609de4c0320", "url": "https://github.com/getodk/collect/commit/07b80b5cb7d6aa421c2269c4d283c609de4c0320", "message": "fix unit test", "committedDate": "2020-06-30T05:53:54Z", "type": "commit"}, {"oid": "07b80b5cb7d6aa421c2269c4d283c609de4c0320", "url": "https://github.com/getodk/collect/commit/07b80b5cb7d6aa421c2269c4d283c609de4c0320", "message": "fix unit test", "committedDate": "2020-06-30T05:53:54Z", "type": "forcePushed"}, {"oid": "be641cb6e605f3b37b610c9eb1826d9bee98db72", "url": "https://github.com/getodk/collect/commit/be641cb6e605f3b37b610c9eb1826d9bee98db72", "message": "fix pmd", "committedDate": "2020-06-30T06:03:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5NDUxNQ==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r447494515", "bodyText": "Did you have to set this on the dialog and the fragment? I'm wondering if we maybe only need it on one of them.\nI find this really confusing with DialogFragment \ud83d\ude15. I don't understand why the Fragment and the Dialog both have ther dialog interface (like setCancellable)...", "author": "seadowg", "createdAt": "2020-06-30T08:10:55Z", "path": "collect_app/src/main/java/org/odk/collect/android/fragments/dialogs/ProgressDialogFragment.java", "diffHunk": "@@ -104,6 +106,11 @@ private void setupView(@NonNull AlertDialog dialog) {\n             ((TextView) dialogView.findViewById(R.id.message)).setText(getArguments().getString(MESSAGE));\n         }\n \n+        if (getArguments() != null) {\n+            dialog.setCancelable(getArguments().getBoolean(CANCELABLE));", "originalCommit": "be641cb6e605f3b37b610c9eb1826d9bee98db72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMTU3Nw==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r447501577", "bodyText": "Thanks @seadowg for pointing it out. We need it only on the Fragment. The Dialog is shown as part of the Fragment, so we need to be concerned about the fragment instead of the dialog. I found it has been mentioned here in the docs as well.", "author": "SaumiaSinghal", "createdAt": "2020-06-30T08:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5NDUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNTA1OQ==", "url": "https://github.com/getodk/collect/pull/3843#discussion_r447505059", "bodyText": "Ah cool. Nice find in the docs. That makes sense!", "author": "seadowg", "createdAt": "2020-06-30T08:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5NDUxNQ=="}], "type": "inlineReview"}, {"oid": "d806bf3e95afd6c5cbc24913abf8a65c085b2ba0", "url": "https://github.com/getodk/collect/commit/d806bf3e95afd6c5cbc24913abf8a65c085b2ba0", "message": "code refactor", "committedDate": "2020-06-30T08:18:59Z", "type": "commit"}, {"oid": "d311315acfbef948d9c06d04c2f1ebeee82a2ea4", "url": "https://github.com/getodk/collect/commit/d311315acfbef948d9c06d04c2f1ebeee82a2ea4", "message": "publish progress in Progress bar", "committedDate": "2020-07-09T22:09:47Z", "type": "commit"}, {"oid": "684644365373c645886d403286e6e69595a4398e", "url": "https://github.com/getodk/collect/commit/684644365373c645886d403286e6e69595a4398e", "message": "fix pmd", "committedDate": "2020-07-09T22:17:14Z", "type": "commit"}, {"oid": "f5ce0ae56c40e39657782d7799e603989e2a28ce", "url": "https://github.com/getodk/collect/commit/f5ce0ae56c40e39657782d7799e603989e2a28ce", "message": "dismiss dialog fragment onResume()", "committedDate": "2020-07-14T19:40:27Z", "type": "commit"}, {"oid": "49bd4f263d369d1425260499a5a652c986ca471e", "url": "https://github.com/getodk/collect/commit/49bd4f263d369d1425260499a5a652c986ca471e", "message": "code refactor", "committedDate": "2020-07-14T20:52:31Z", "type": "commit"}]}