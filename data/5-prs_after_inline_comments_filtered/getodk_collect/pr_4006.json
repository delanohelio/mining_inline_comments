{"pr_number": 4006, "pr_title": "Reworking Audio widget", "pr_createdAt": "2020-08-04T07:05:22Z", "pr_url": "https://github.com/getodk/collect/pull/4006", "timeline": [{"oid": "289cc79436c56c8369d5a07d653ff0d82852ed5f", "url": "https://github.com/getodk/collect/commit/289cc79436c56c8369d5a07d653ff0d82852ed5f", "message": "code refactor", "committedDate": "2020-08-04T09:25:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4NzY0NQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465787645", "bodyText": "I think better to just have the values inline (destinationPath) rather than defined anywhere. Easier to see in the test that the value is just a string.", "author": "seadowg", "createdAt": "2020-08-05T14:54:36Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/AudioWidgetTest.java", "diffHunk": "@@ -1,117 +1,188 @@\n package org.odk.collect.android.widgets;\n \n-import android.content.Context;\n-import android.content.Intent;\n-import android.net.Uri;\n-import android.provider.MediaStore;\n+import android.media.MediaPlayer;\n import android.view.View;\n \n-import androidx.annotation.NonNull;\n-\n-import net.bytebuddy.utility.RandomString;\n+import androidx.core.view.ViewCompat;\n+import androidx.fragment.app.FragmentActivity;\n+import androidx.lifecycle.LifecycleOwner;\n \n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n import org.junit.Test;\n-import org.mockito.Mock;\n-import org.odk.collect.android.R;\n+import org.junit.runner.RunWith;\n import org.odk.collect.android.audio.AudioControllerView;\n+import org.odk.collect.android.audio.AudioHelper;\n+import org.odk.collect.android.audio.Clip;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.odk.collect.android.support.FakeLifecycleOwner;\n+import org.odk.collect.android.support.FakeScheduler;\n+import org.odk.collect.android.support.TestScreenContextActivity;\n import org.odk.collect.android.utilities.FileUtil;\n import org.odk.collect.android.utilities.MediaUtil;\n-import org.odk.collect.android.widgets.base.FileWidgetTest;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n import org.odk.collect.android.widgets.support.FakeWaitingForDataRegistry;\n+import org.odk.collect.async.Scheduler;\n+import org.robolectric.RobolectricTestRunner;\n \n import java.io.File;\n+import java.util.function.Supplier;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n-import static org.mockito.ArgumentMatchers.any;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n \n-/**\n- * @author James Knight\n- */\n-public class AudioWidgetTest extends FileWidgetTest<AudioWidget> {\n-\n-    @Mock\n-    Uri uri;\n+@RunWith(RobolectricTestRunner.class)\n+public class AudioWidgetTest {\n+    private final String destinationPath = \"blah\";\n \n-    @Mock\n-    MediaUtil mediaUtil;\n+    private final MediaPlayer mediaPlayer = new MediaPlayer();\n+    private final FakeScheduler fakeScheduler = new FakeScheduler();\n \n-    @Mock\n-    FileUtil fileUtil;\n+    private TestScreenContextActivity widgetActivity;\n+    private AudioControllerView audioController;\n+    private FileUtil fileUtil;\n+    private MediaUtil mediaUtil;\n+    private AudioHelper audioHelper;\n \n-    @Mock\n-    AudioControllerView audioController;\n+    @Before\n+    public void setUp() {\n+        widgetActivity = widgetTestActivity();\n \n-    private String destinationName;\n+        audioController = mock(AudioControllerView.class);\n+        fileUtil = mock(FileUtil.class);\n+        mediaUtil = mock(MediaUtil.class);\n \n-    @NonNull\n-    @Override\n-    public AudioWidget createWidget() {\n-        return new AudioWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"), fileUtil, mediaUtil, audioController, new FakeWaitingForDataRegistry());\n+        audioHelper = new FakeAudioHelper(widgetActivity, new FakeLifecycleOwner(), fakeScheduler, () -> mediaPlayer);\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(destinationName);\n+    @Test\n+    public void usingReadOnlyOption_doesNotShowCaptureAndChooseButtons() {\n+        AudioWidget widget = createWidget(promptWithReadOnly());\n+\n+        assertThat(widget.captureButton.getVisibility(), equalTo(View.GONE));\n+        assertThat(widget.chooseButton.getVisibility(), equalTo(View.GONE));\n     }\n \n-    @Override\n-    public Object createBinaryData(StringData answerData) {\n-        return uri;\n+    @Test\n+    public void getAnswer_whenPromptDoesNotHaveAnswer_returnsNull() {\n+        AudioWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(widget.getAnswer(), nullValue());\n     }\n \n-    @Override\n-    public void setUp() throws Exception {\n-        super.setUp();\n-        destinationName = RandomString.make();\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        AudioWidget widget = createWidget(promptWithAnswer(new StringData(destinationPath)));", "originalCommit": "b2bb6bf4ec6f1021f2fa63cc13152c19be8e7031", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5MzQzNw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465793437", "bodyText": "Not sure the naming is right here. It's not really a \"listener\". Maybe the interface is QuestionMediaManager and the implementation is something else?", "author": "seadowg", "createdAt": "2020-08-05T15:02:19Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/interfaces/MediaManagerListener.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package org.odk.collect.android.widgets.interfaces;\n+\n+public interface MediaManagerListener {", "originalCommit": "53f46a777e8a5ffe159b4ebf557a5031462274f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0MjgwNw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465842807", "bodyText": "Yes right the implementation mostly concerns with the deletion or replacing the file at the current index. But I think I might need to extend this implementation for working on other widgets", "author": "SaumiaSinghal", "createdAt": "2020-08-05T16:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5MzQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465796413", "bodyText": "Feels like the button text should just live in a layout?", "author": "seadowg", "createdAt": "2020-08-05T15:06:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/AudioWidget.java", "diffHunk": "@@ -101,24 +98,33 @@ public AudioWidget(Context context, QuestionDetails prompt, WaitingForDataRegist\n         this.waitingForDataRegistry = waitingForDataRegistry;\n         this.mediaManagerListener = mediaManagerListener;\n \n-        captureButton = createSimpleButton(getContext(), R.id.capture_audio, getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.capture_audio), getAnswerFontSize(), this);\n-\n-        chooseButton = createSimpleButton(getContext(), R.id.choose_sound, getFormEntryPrompt().isReadOnly(), getContext().getString(R.string.choose_sound), getAnswerFontSize(), this);\n-\n-        // finish complex layout\n-        LinearLayout answerLayout = new LinearLayout(getContext());\n-        answerLayout.setOrientation(LinearLayout.VERTICAL);\n-        answerLayout.addView(captureButton);\n-        answerLayout.addView(chooseButton);\n-        answerLayout.addView(audioController);\n-        addAnswerView(answerLayout, WidgetViewUtils.getStandardMargin(context));\n-\n         hideButtonsIfNeeded();\n \n         binaryName = questionDetails.getPrompt().getAnswerText();\n         updatePlayerMedia();\n     }\n \n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = AudioWidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+\n+        if (prompt.isReadOnly()) {\n+            binding.captureButton.widgetButton.setVisibility(View.GONE);\n+            binding.chooseButton.widgetButton.setVisibility(View.GONE);\n+        } else {\n+            binding.captureButton.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+            binding.chooseButton.widgetButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+            binding.captureButton.widgetButton.setText(getContext().getString(R.string.capture_audio));", "originalCommit": "a1beed3da777311fc8bdba2eca7f261ca0b35986", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0MTg0Mg==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465841842", "bodyText": "I use\n`\n\n<include\n    android:id=\"@+id/choose_button\"\n    layout=\"@layout/widget_button\"/>`\n\nin audio_widget.xml file. So I have added the button text here.", "author": "SaumiaSinghal", "createdAt": "2020-08-05T16:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0NDAxNQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465844015", "bodyText": "I think I'd be happier duplicating the layout here than having hardcoded text set programmatically. My thinking is that it's good to be able to see the layout as it will appear (with the text) in the design preview for it.", "author": "seadowg", "createdAt": "2020-08-05T16:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0NTgwNg==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465845806", "bodyText": "For the other file widgets, I was using the same widget_button.xml layout. So, I should have a separate layout for all of them too?", "author": "SaumiaSinghal", "createdAt": "2020-08-05T16:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0NzMzOQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465847339", "bodyText": "I think instead of sharing an include maybe we could create a custom button class with the shared values. Or, create a style that can be shared. These would let us avoid duplication but avoid having to set the text programmatically (which I'd like to avoid as much as possible).", "author": "seadowg", "createdAt": "2020-08-05T16:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NjQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5ODY3MQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465798671", "bodyText": "We want a test for this change.", "author": "seadowg", "createdAt": "2020-08-05T15:09:45Z", "path": "collect_app/src/main/java/org/odk/collect/android/audio/AudioPlayerViewModel.java", "diffHunk": "@@ -178,16 +178,14 @@ public void errorDisplayed() {\n     }\n \n     private void schedulePositionUpdates() {\n-        if (positionUpdatesCancellable == null) {\n-            positionUpdatesCancellable = scheduler.repeat(() -> {\n-                CurrentlyPlaying currentlyPlaying = this.currentlyPlaying.getValue();\n+        positionUpdatesCancellable = scheduler.repeat(() -> {", "originalCommit": "9c5a37fd4995edaa6d051eaa4787608a09c0a18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk2MDA1MQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r465960051", "bodyText": "I verified playMultipleClips_updatesProgress_forAllClips() and playInOrder_playsClipsOneAfterTheOther_andUpdatesProgress fails on master.", "author": "SaumiaSinghal", "createdAt": "2020-08-05T19:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5ODY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyNjUyNg==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r466426526", "bodyText": "I like what's happening here but I think the variable/method should be named something more related to the scheduler than the test here. Maybe isRepeatRunning?", "author": "seadowg", "createdAt": "2020-08-06T13:50:05Z", "path": "collect_app/src/test/java/org/odk/collect/android/support/FakeScheduler.java", "diffHunk": "@@ -13,6 +13,7 @@\n     private Runnable foregroundTask;\n     private Runnable backgroundTask;\n     private Boolean cancelled = false;\n+    private Boolean isProgressUpdating = false;", "originalCommit": "f4d859d8ca3a4cb691d3e15bf611cc690dd93749", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NDE2NQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r467854165", "bodyText": "I don't think this is quite right after a second look. As much as we can we want to avoid static singletons. If there is some state that we want to keep shared at an application level (i.e. between multiple activities or services) then we should use Dagger to setup and inject a singleton (using @Singleton).\nIn this case I don't believe the state needs to persist outside of form entry so it really only needs to last as long as the Activity.  This means we could confuse ourselves by ending up with state hanging around between form entry \"sessions\". A good way to share state like this would be to use a view model where the ViewModelProvider uses the activity as its owner. Does that make sense as a way forward?", "author": "seadowg", "createdAt": "2020-08-10T11:57:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/MediaManager.java", "diffHunk": "@@ -24,7 +24,7 @@\n  * remember an original media file answer (no matter how many times this answer is replaced), in order\n  * to be able to restore the original answer in case of ignoring changes.\n  */\n-public enum MediaManager {\n+public enum MediaManager implements QuestionMediaManager {", "originalCommit": "466e31dd54f2a6c426ecbc1c780c7091970d9e62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NTk1NA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r467855954", "bodyText": "If so, it might be good to discuss the plans/approach here so we can come up with something that makes sense as it's a little awkward I think!", "author": "seadowg", "createdAt": "2020-08-10T12:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NDE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg2NjcwOQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r467866709", "bodyText": "@seadowg If I use the ViewModel then I would be creating it using the widget context, and it will be there for all the widgets on the screen?\nI feel like avoiding using QuestionMediaManager too and using the previous implementation. That would mean there would be additional unit tests for the widgets. Will that be fine?", "author": "SaumiaSinghal", "createdAt": "2020-08-10T12:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NDE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxODIxNw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r468018217", "bodyText": "I think if that's simpler to do right now that's a good plan. Maybe we can move the logic to a viewmodel in the future.", "author": "seadowg", "createdAt": "2020-08-10T16:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1NDE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNDUzNw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469914537", "bodyText": "Maybe this hasn't come through in previous comments and conversations but I'm very against the MediaManager being a singleton. Just to make it very clear I think the MediaManager should be a class (not an enum) and that this line should be:\nreturn (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics, new MediaManager());\nAs we talked about before we could get in trouble with the enum singleton implementation as its state will be carried between different instances of the FormEntryActivity. Also in tests the singleton would not be recreated for each test (as the static state is retained throughout the process) so any state in the MediaManager set up in one test might inadvertently affect another.", "author": "seadowg", "createdAt": "2020-08-13T12:29:24Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -370,7 +377,7 @@ public Factory(Analytics analytics) {\n         @NonNull\n         @Override\n         public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {\n-            return (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics);\n+            return (T) new FormSaveViewModel(System::currentTimeMillis, new DiskFormSaver(), analytics, MediaManager.INSTANCE);", "originalCommit": "fc611fcad1d2dd0f71457606251ff67bae652fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzMjE1OA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469932158", "bodyText": "Oh right! I didn't think about it. It will cause problems when writing tests for other file widgets.", "author": "SaumiaSinghal", "createdAt": "2020-08-13T12:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNDUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNTgzOQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469915839", "bodyText": "You shouldn't need to do this as each test will get a new instance of TestWidgetActivity.", "author": "seadowg", "createdAt": "2020-08-13T12:31:40Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/AudioWidgetTest.java", "diffHunk": "@@ -98,6 +102,12 @@ public void setUp() {\n         when(activityAvailability.isActivityAvailable(any())).thenReturn(true);\n     }\n \n+    @After\n+    public void tearDown() {\n+        widgetActivity.originalFiles.clear();", "originalCommit": "fc611fcad1d2dd0f71457606251ff67bae652fa1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkyNDM1Nw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469924357", "bodyText": "I think we're getting close with the structure but I don't like that the FormEntryActivity implements the QuestionMediaManager. I think instead:\n\nthe AudioWidget should take a QuestionMediaManager in as a dependency at it's constructor rather than casting the context to one.\nthe WidgetFactory should also take a QuestionMediaManager in as one of the args to createWidgetFromPrompt so it can pass it to any widget that needs it.\nFormSaveViewModel#getMediaManager should return a QuestionMediaManager not a MediaManager\nFormSaveViewModel#getMediaManager should be passed as the QuestionMediaManager argument to WidgetFactory#createWidgetFromPrompt\nQuitFormDialogFragment  should call viewModel.getMediaManager().revertChanges rather than relying on the static singleton instance\n\nI'm not sure if I like that currently the QuestionMediaManager is simply owned by the FromSaveViewModel and then exposes it. I'm thinking that potentially the FormSaveViewModel could implement the QuestionMediaManager interface and then there would be no need for the MediaManager class. In that world the \"revert\" call (in QuiteFormDialogFragment could just be part of the logic FormSaveViewModel#removeTempInstance.", "author": "seadowg", "createdAt": "2020-08-13T12:46:38Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -2674,6 +2675,16 @@ public void onCancelFormLoading() {\n         finish();\n     }\n \n+    @Override\n+    public void deleteOriginalFile(String questionIndex, String fileName) {", "originalCommit": "fc611fcad1d2dd0f71457606251ff67bae652fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MDU5Ng==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r469980596", "bodyText": "Nice idea @seadowg, and Thanks for explaining so well. I implemented all the functionality of MediaManager in FormSaveViewModel, as you said if we have the FormSaveViewModel implements QuestionMediaManager, then MediaManager class is no longer required.", "author": "SaumiaSinghal", "createdAt": "2020-08-13T14:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkyNDM1Nw=="}], "type": "inlineReview"}, {"oid": "fcfb6b9f3bbd0efac9908dca71b34fbe1fa5a23d", "url": "https://github.com/getodk/collect/commit/fcfb6b9f3bbd0efac9908dca71b34fbe1fa5a23d", "message": "fix unit tests", "committedDate": "2020-08-13T15:50:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470557438", "bodyText": "Do we need to do this in onCleared() as well? Have you played around with the behaviour when \"Don't save activities\" is enabled? It might be good to give that a go and see if we need to handle the case when we leave the app, Android kills the process, and then we return to the app. Would files get left undeleted but on in the form in this case? Would things break?\nLet me know if you have questions about trying that out!", "author": "seadowg", "createdAt": "2020-08-14T11:00:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -126,6 +127,7 @@ public void removeTempInstance() {\n                 FileUtils.purgeMediaPath(instanceFolder);\n             }\n         }\n+        releaseMediaManager();", "originalCommit": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwNzM3NQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470607375", "bodyText": "This is an interesting case. I will try that out with all the media widgets.", "author": "SaumiaSinghal", "createdAt": "2020-08-14T12:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYyMDY1OA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470620658", "bodyText": "I tried clearing the originalFiles and recentFiles HashMap in onCleared(), when Don't keep activities is turned on. I didn't find any anomaly in saving answers to the widgets, as I think, the answer is already saved with the widget, so clearing the files won't cause any break. Am I missing some test case here?", "author": "SaumiaSinghal", "createdAt": "2020-08-14T13:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzNzQ0OA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r472137448", "bodyText": "Here's the problem I found:\n\nEnabled \"Don't keep activities\"\nOpen the \"All widgets form\"\nGo to the file widget\nSelect a file\nSelect a different file\nGo to the hierarchy view with the arrow button\nPress \"Go To End\"\nSave and exit the form\n\nIf you now go to the \"Device File Explorer\" and check the instance dir (sdcard/odk/instances and then the newest dir) you'll see both the files you've selected are still in the directory. I'm guessing this is because when the activity is killed the view model state is wiped with the activity and the originalFiles list will be empty when we return to the FormEntryActivity from the hierarchy screen. Before (on master) this worked because the MediaManager was a process level singleton and so state would be retained.\nIt feels to me like it would be a lot nicer if when the form was saved or (or ignore changes is hit) it just deleted any files not being used in the form but that could require a lot of rework. I'm thinking we should use the new Saved State module to persist originalFiles between activity instances (as opposed to going back to a process singleton) and then file an issue around carrying out the rework.\nI'd like to pull in @lognaturel and @grzesiek2010 for sanity checks here though!", "author": "seadowg", "createdAt": "2020-08-18T12:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4OTEwOA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r473489108", "bodyText": "This case does seem possible if someone needs to get clarification on what file to attach, for example. Certainly it'd be best not to have a known regression in behavior.\nWe haven't used the saved state module yet. It might be simpler to use onSavedInstanceState. But yes, saving originalFiles between activity instances for now seems good.", "author": "lognaturel", "createdAt": "2020-08-20T00:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU1NzYwMA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r470557600", "bodyText": "Hmmm. Little worried about the viewmodel being passed into an async task here... It's another awkward change but I think really what should happen here is that a list of files to save should get passed into the save task. Does that make sense? In that world we wouldn't need saveChanges (as it would be handled in DiskFormSaver.", "author": "seadowg", "createdAt": "2020-08-14T11:00:53Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -171,7 +173,7 @@ public String getReason() {\n     }\n \n     private void saveToDisk(SaveRequest saveRequest) {\n-        saveTask = new SaveTask(saveRequest, formSaver, formController, mediaManager, new SaveTask.Listener() {\n+        saveTask = new SaveTask(saveRequest, formSaver, formController, this, new SaveTask.Listener() {", "originalCommit": "2008cb2b2f01e6fa6f5b56d3210b4b038c485c6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e06f97083a6bbb9982919e3755da4a69aa9bd9a2", "url": "https://github.com/getodk/collect/commit/e06f97083a6bbb9982919e3755da4a69aa9bd9a2", "message": "pass collection files to asynctask", "committedDate": "2020-08-19T09:45:12Z", "type": "forcePushed"}, {"oid": "d8705c9c05a922eb8b2fbb0c4e36febeaee9e35b", "url": "https://github.com/getodk/collect/commit/d8705c9c05a922eb8b2fbb0c4e36febeaee9e35b", "message": "add unit tests", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "41ea8a171ca60cf08b410763264e609068df75bd", "url": "https://github.com/getodk/collect/commit/41ea8a171ca60cf08b410763264e609068df75bd", "message": "add unit tests for Audio Widget", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "d5db506088f66018eea4d6782eae15841dddb28e", "url": "https://github.com/getodk/collect/commit/d5db506088f66018eea4d6782eae15841dddb28e", "message": "craete audio_widget_answer.xml", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "bad75cb39b6e4cef96c8e767bb5eb650871111f4", "url": "https://github.com/getodk/collect/commit/bad75cb39b6e4cef96c8e767bb5eb650871111f4", "message": "update AudioWidget class", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "0896029b905cafdd43ba6e5009793bbeb0fa3f02", "url": "https://github.com/getodk/collect/commit/0896029b905cafdd43ba6e5009793bbeb0fa3f02", "message": "update unit tests", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "c35a3713c79ee58226ed0635bbcb5d554a1d5d7e", "url": "https://github.com/getodk/collect/commit/c35a3713c79ee58226ed0635bbcb5d554a1d5d7e", "message": "add unit tests", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "0fe63b1b81c99e61a4aa87404c8de0519de352e0", "url": "https://github.com/getodk/collect/commit/0fe63b1b81c99e61a4aa87404c8de0519de352e0", "message": "code refactor", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "5bdd4ae8dc2b7e4451306d29050e9ce5ac593f67", "url": "https://github.com/getodk/collect/commit/5bdd4ae8dc2b7e4451306d29050e9ce5ac593f67", "message": "refactor MediaManagerListener", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "f2ce6ea1d8404ab8f4ea86d5b9adb6b4809d1933", "url": "https://github.com/getodk/collect/commit/f2ce6ea1d8404ab8f4ea86d5b9adb6b4809d1933", "message": "fix #4005", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "70e43ec5b5ae376db5087dfe061c3f7d51e45dca", "url": "https://github.com/getodk/collect/commit/70e43ec5b5ae376db5087dfe061c3f7d51e45dca", "message": "fix #4008", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "f60b09af11fa47d8e4257436fed84af8a11632a8", "url": "https://github.com/getodk/collect/commit/f60b09af11fa47d8e4257436fed84af8a11632a8", "message": "craete a new style Collect.Button.Layout", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "682fdb2ca0dc99732c99f2e558370f8abe43d158", "url": "https://github.com/getodk/collect/commit/682fdb2ca0dc99732c99f2e558370f8abe43d158", "message": "update unit tests", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "b569c455f95ab015b4211056a11cd373e8a58cb6", "url": "https://github.com/getodk/collect/commit/b569c455f95ab015b4211056a11cd373e8a58cb6", "message": "refactor button style", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "a7104f0781ecb984bb75b64705a80bf55f13df83", "url": "https://github.com/getodk/collect/commit/a7104f0781ecb984bb75b64705a80bf55f13df83", "message": "add unit tests for progress update for AudioPlayerViewModel", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "e8bbd94f8defe4cfd7807a95751254aeb88498b9", "url": "https://github.com/getodk/collect/commit/e8bbd94f8defe4cfd7807a95751254aeb88498b9", "message": "code refactor", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "12cd8f35b3b56f889ff5a9674d519e6a5f27b847", "url": "https://github.com/getodk/collect/commit/12cd8f35b3b56f889ff5a9674d519e6a5f27b847", "message": "remove QuestionMediaManager", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "f1d5a3f611beb65263a373a0e628262e59fe5ac6", "url": "https://github.com/getodk/collect/commit/f1d5a3f611beb65263a373a0e628262e59fe5ac6", "message": "use formsaveviewmodel to access MediaManager", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "356f6e15a5e842321e4b0cf3cfbdab0cd93ba1df", "url": "https://github.com/getodk/collect/commit/356f6e15a5e842321e4b0cf3cfbdab0cd93ba1df", "message": "convert MediaManager to class", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "4538677195fb3deb685d07793de2992249055562", "url": "https://github.com/getodk/collect/commit/4538677195fb3deb685d07793de2992249055562", "message": "delete MediaManager class", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "a0ee45dd2bab877779659b2597c3cec6467506cb", "url": "https://github.com/getodk/collect/commit/a0ee45dd2bab877779659b2597c3cec6467506cb", "message": "fix unit tests", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "62b6fac8d863b9f1120f4c809cd582ac5e4dfe8e", "url": "https://github.com/getodk/collect/commit/62b6fac8d863b9f1120f4c809cd582ac5e4dfe8e", "message": "pass collection files to asynctask", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "9650495f75e4643076ab868012009114bbd1495e", "url": "https://github.com/getodk/collect/commit/9650495f75e4643076ab868012009114bbd1495e", "message": "use SavedStateHandle", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "a0f4ef962bf2e044db7eb2be04a752e281fcc7e2", "url": "https://github.com/getodk/collect/commit/a0f4ef962bf2e044db7eb2be04a752e281fcc7e2", "message": "fix SavedStateHandle error", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "35225c3250a70e5771ee61e1bbb71df30dc06731", "url": "https://github.com/getodk/collect/commit/35225c3250a70e5771ee61e1bbb71df30dc06731", "message": "add unit tests for formSaveViewModel", "committedDate": "2020-08-25T11:22:35Z", "type": "commit"}, {"oid": "35225c3250a70e5771ee61e1bbb71df30dc06731", "url": "https://github.com/getodk/collect/commit/35225c3250a70e5771ee61e1bbb71df30dc06731", "message": "add unit tests for formSaveViewModel", "committedDate": "2020-08-25T11:22:35Z", "type": "forcePushed"}, {"oid": "677af1bbebfc8e3f554555969d1164efaef19ebc", "url": "https://github.com/getodk/collect/commit/677af1bbebfc8e3f554555969d1164efaef19ebc", "message": "fix unit tests", "committedDate": "2020-08-25T11:39:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3Mzc4Mw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476373783", "bodyText": "This could still be set in the constructor right? Could the constructor not just call super then assign the field?", "author": "seadowg", "createdAt": "2020-08-25T11:25:56Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -398,20 +420,21 @@ protected void onPostExecute(SaveToDiskResult saveToDiskResult) {\n         }\n     }\n \n-    public static class Factory implements ViewModelProvider.Factory {\n-\n-        private final Analytics analytics;\n+    public static class Factory extends AbstractSavedStateViewModelFactory {\n+        private Analytics analytics;\n \n+        public Factory(@NonNull SavedStateRegistryOwner owner, @Nullable Bundle defaultArgs) {\n+            super(owner, defaultArgs);\n+        }\n \n-        public Factory(Analytics analytics) {\n+        public void setAnalytics(Analytics analytics) {", "originalCommit": "9650495f75e4643076ab868012009114bbd1495e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MDM4MA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476440380", "bodyText": "I forgot to change this. I changed the structure when I was trying different things.", "author": "SaumiaSinghal", "createdAt": "2020-08-25T13:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3Mzc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTc5Nw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476375797", "bodyText": "Do we need to do this if we're also handling it in markOriginalFileOrDelete (same for the RECENT_FILES)?", "author": "seadowg", "createdAt": "2020-08-25T11:30:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -85,7 +84,9 @@ public FormSaveViewModel(SavedStateHandle stateHandle, Clock clock, FormSaver fo\n \n     @Override\n     protected void onCleared() {\n-        releaseMediaManager();\n+        originalFiles.clear();\n+        recentFiles.clear();\n+\n         stateHandle.set(ORIGINAL_FILES, originalFiles);", "originalCommit": "a0f4ef962bf2e044db7eb2be04a752e281fcc7e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MjUxNQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476442515", "bodyText": "Hi @seadowg! Do you mean if I need the onCleared method or not?", "author": "SaumiaSinghal", "createdAt": "2020-08-25T13:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDI1Nw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476564257", "bodyText": "I don't think we need anything in here.", "author": "seadowg", "createdAt": "2020-08-25T16:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNjcxMA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476416710", "bodyText": "It looks like all these new tests are mainly there to drive out the use of SavedStateHandle. I think a better way to test it would be more functionally by checking that if I call the methods that set state then use that saved state to create another view model then I get the behaviour I expect (probably that save or ignore do the right thing). This checks that the values are loaded from save state as well as written to it and also means we probably just need one test.", "author": "seadowg", "createdAt": "2020-08-25T12:41:11Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -368,6 +395,47 @@ public void resumeFormEntry_clearsSaveResult() {\n         assertThat(saveResult.getValue(), equalTo(null));\n     }\n \n+    @Test\n+    public void markOriginalFileOrDelete_whenFileNameIsEmpty_doesNotSaveFileForDelete() {", "originalCommit": "35225c3250a70e5771ee61e1bbb71df30dc06731", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "url": "https://github.com/getodk/collect/commit/205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "message": "code refactor", "committedDate": "2020-08-25T14:01:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MTQwMQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476561401", "bodyText": "I think this should check that the files are deleted etc (so check the correct calls are made to mediaUtils) rather than checking the savedStateHandle).", "author": "seadowg", "createdAt": "2020-08-25T16:01:18Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -353,6 +353,24 @@ public void whenFormSaverFinishes_mediaManagerIsCleared() {\n         assertThat(recentFiles.isEmpty(), equalTo(true));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_onRecreatingFormSaveViewModel_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        FormSaveViewModel restoredViewModel = new FormSaveViewModel(savedStateHandle, () -> CURRENT_TIME, formSaver, mediaUtils, null);\n+        restoredViewModel.formLoaded(formController);\n+\n+        restoredViewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", false);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));", "originalCommit": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MjExMA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476562110", "bodyText": "Actually so maybe we only need markOriginalFileOrDelete_whenQuestionIndexHasAnswer_onRecreatingViewModel_deletesFile? Unless there are reasons to check savedStateHandle directly.", "author": "seadowg", "createdAt": "2020-08-25T16:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MTQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2NDAzMg==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r476564032", "bodyText": "I don't think we need to clear these variables out here. They are part of the ViewModel which will be removed from memory.", "author": "seadowg", "createdAt": "2020-08-25T16:05:06Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -26,37 +29,66 @@\n import org.odk.collect.android.tasks.SaveToDiskResult;\n import org.odk.collect.android.utilities.FileUtils;\n import org.odk.collect.android.utilities.MediaUtils;\n+import org.odk.collect.android.utilities.QuestionMediaManager;\n import org.odk.collect.utilities.Clock;\n \n import java.io.File;\n \n import timber.log.Timber;\n+\n+import java.util.Collection;\n import java.util.HashMap;\n+import java.util.Map;\n \n import static org.odk.collect.android.tasks.SaveFormToDisk.SAVED;\n import static org.odk.collect.android.tasks.SaveFormToDisk.SAVED_AND_EXIT;\n import static org.odk.collect.android.utilities.StringUtils.isBlank;\n \n-public class FormSaveViewModel extends ViewModel implements ProgressDialogFragment.Cancellable, RequiresFormController {\n+public class FormSaveViewModel extends ViewModel implements ProgressDialogFragment.Cancellable, RequiresFormController, QuestionMediaManager {\n+    public static final String ORIGINAL_FILES = \"originalFiles\";\n+    public static final String RECENT_FILES = \"recentFiles\";\n \n+    private final SavedStateHandle stateHandle;\n     private final Clock clock;\n     private final FormSaver formSaver;\n+    private final MediaUtils mediaUtils;\n \n-    private String reason = \"\";\n     private final MutableLiveData<SaveResult> saveResult = new MutableLiveData<>(null);\n+    private String reason = \"\";\n+\n+    private Map<String, String> originalFiles = new HashMap<>();\n+    private Map<String, String> recentFiles = new HashMap<>();\n \n     @Nullable\n     private FormController formController;\n \n     @Nullable\n-    private AsyncTask saveTask;\n+    private AsyncTask<Void, String, SaveToDiskResult> saveTask;\n \n     private final Analytics analytics;\n \n-    public FormSaveViewModel(Clock clock, FormSaver formSaver, Analytics analytics) {\n+    public FormSaveViewModel(SavedStateHandle stateHandle, Clock clock, FormSaver formSaver, MediaUtils mediaUtils, Analytics analytics) {\n+        this.stateHandle = stateHandle;\n         this.clock = clock;\n         this.formSaver = formSaver;\n+        this.mediaUtils = mediaUtils;\n         this.analytics = analytics;\n+\n+        if (stateHandle.get(ORIGINAL_FILES) != null) {\n+            originalFiles = stateHandle.get(ORIGINAL_FILES);\n+        }\n+        if (stateHandle.get(RECENT_FILES) != null) {\n+            recentFiles = stateHandle.get(RECENT_FILES);\n+        }\n+    }\n+\n+    @Override\n+    protected void onCleared() {\n+        originalFiles.clear();", "originalCommit": "205686892a07dd9ff9eee2a1fb0737bbabbafc2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "88e97298c0cd228f145490c5763455721eba737d", "url": "https://github.com/getodk/collect/commit/88e97298c0cd228f145490c5763455721eba737d", "message": "code refactor", "committedDate": "2020-08-25T17:41:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjMwNA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477412304", "bodyText": "I'm not sure you need this test and whenFormSaverFinishes_mediaManagerIsCleared. Could you explain it or do you think we should just delete this one?", "author": "seadowg", "createdAt": "2020-08-26T15:59:06Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -325,6 +338,39 @@ public void whenFormSaverFinishes_isSaving_returnsFalse() {\n         assertThat(viewModel.isSaving(), equalTo(false));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", true);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));\n+        assertThat(recentFiles.isEmpty(), equalTo(true));\n+    }\n+\n+    @Test\n+    public void whenFormSaverFinishes_onRecreatingFormSaveViewModel_mediaManagerIsCleared() {", "originalCommit": "88e97298c0cd228f145490c5763455721eba737d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ3MDgwMQ==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477470801", "bodyText": "I think we can delete whenFormSaverFinishes_mediaManagerIsCleared. We do not have any other test to check whether mediaManager is released when form save finishes. I'm not sure is it is really important to check whether all files get deleted when form save task is finished.", "author": "SaumiaSinghal", "createdAt": "2020-08-26T17:32:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ3NDEyNg==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477474126", "bodyText": "Yup I agree. I think my comment below lays out one test that would capture what whenFormSaverFinishes_mediaManagerIsCleared is trying to test.", "author": "seadowg", "createdAt": "2020-08-26T17:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMjMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477413973", "bodyText": "Instead of verifying the files here I think this test should run saveForm again and check that deleteImageFileFromMediaProvider is only called the first time. Does that make sense? Again, this is to test the intended behaviour rather than an implementation detail of that behaviour.", "author": "seadowg", "createdAt": "2020-08-26T16:01:20Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -325,6 +338,39 @@ public void whenFormSaverFinishes_isSaving_returnsFalse() {\n         assertThat(viewModel.isSaving(), equalTo(false));\n     }\n \n+    @Test\n+    public void whenFormSaverFinishes_mediaManagerIsCleared() {\n+        viewModel.markOriginalFileOrDelete(\"index\", \"blah\");\n+        viewModel.replaceRecentFileForQuestion(\"index\", \"blah\");\n+\n+        viewModel.saveForm(Uri.parse(\"file://form\"), true, \"\", true);\n+        whenFormSaverFinishes(SaveFormToDisk.SAVED);\n+\n+        Map<String, String> originalFiles = savedStateHandle.get(FormSaveViewModel.ORIGINAL_FILES);\n+        Map<String, String> recentFiles = savedStateHandle.get(FormSaveViewModel.RECENT_FILES);\n+\n+        assertThat(originalFiles.isEmpty(), equalTo(true));", "originalCommit": "88e97298c0cd228f145490c5763455721eba737d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4MjUwOA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477482508", "bodyText": "To verify calls to deleteImageFileFromMediaProvider(), I should use actual new DisFormSaver() instead of FormSaver, right?", "author": "SaumiaSinghal", "createdAt": "2020-08-26T17:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxMzY2Nw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477513667", "bodyText": "Oh I just meant like you did in the other test and call saveForm on the view model. Does that make sense. The test is to verify that if we call save once and then call save again then we don't try and delete the files from the first save. That's my understanding anyway. Does that make sense?", "author": "seadowg", "createdAt": "2020-08-26T18:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNDgyOA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477514828", "bodyText": "So pseudo code would be:\n\nset up files to be deleted/saved\ncall save on view model\ncheck files are saved/deleted correctly (using mock of MediaUtils)\ncall save again\ncheck no files are saved/deleted (you can pass once() to verify to check it method has only been called once)", "author": "seadowg", "createdAt": "2020-08-26T18:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyNjU0MA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r478326540", "bodyText": "Hi! the unit test saveForm_runsWith_correctFiles() is failing. Sorry I meant to name it saveForm_savesCorrectFiles(). I confirmed the failure is bacause of calling clearMediaFiles() in OnComplete, but that should not effect the FakeFormSaver, right?", "author": "SaumiaSinghal", "createdAt": "2020-08-27T10:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxNDM3Mw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477414373", "bodyText": "It looks like you don't need these 4 lines for anything?", "author": "seadowg", "createdAt": "2020-08-26T16:01:58Z", "path": "collect_app/src/test/java/org/odk/collect/android/formentry/audit/FormSaveViewModelTest.java", "diffHunk": "@@ -59,12 +65,19 @@ public void setup() {\n         formController = mock(FormController.class);\n         logger = mock(AuditEventLogger.class);\n         formSaver = mock(FormSaver.class);\n+        mediaUtils = mock(MediaUtils.class);\n         Analytics analytics = mock(Analytics.class);\n \n         when(formController.getAuditEventLogger()).thenReturn(logger);\n         when(logger.isChangeReasonRequired()).thenReturn(false);\n \n-        viewModel = new FormSaveViewModel(() -> CURRENT_TIME, formSaver, analytics);\n+        Map<String, String> originalFiles = new HashMap<>();", "originalCommit": "88e97298c0cd228f145490c5763455721eba737d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxOTgyOA==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r477519828", "bodyText": "When saveToDisk() task is complete, I just call clearMediaFiles() . So when I try to verify call to mediaUtils.deleteImageFileFromMediaProvider(), the test fails.", "author": "SaumiaSinghal", "createdAt": "2020-08-26T18:59:45Z", "path": "collect_app/src/main/java/org/odk/collect/android/formentry/saving/FormSaveViewModel.java", "diffHunk": "@@ -253,8 +279,35 @@ public AuditEventLogger getAuditEventLogger() {\n         return formController.getAuditEventLogger();\n     }\n \n-    public static class SaveResult {\n+    @Override\n+    public void markOriginalFileOrDelete(String questionIndex, String fileName) {\n+        if (questionIndex != null && fileName != null) {\n+            if (originalFiles.containsKey(questionIndex)) {\n+                mediaUtils.deleteImageFileFromMediaProvider(fileName);\n+            } else {\n+                originalFiles.put(questionIndex, fileName);\n+                stateHandle.set(ORIGINAL_FILES, originalFiles);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void replaceRecentFileForQuestion(String questionIndex, String fileName) {\n+        if (questionIndex != null && fileName != null) {\n+            if (recentFiles.containsKey(questionIndex)) {\n+                mediaUtils.deleteImageFileFromMediaProvider(recentFiles.get(questionIndex));\n+            }\n+            recentFiles.put(questionIndex, fileName);\n+            stateHandle.set(RECENT_FILES, recentFiles);\n+        }\n+    }\n \n+    private void clearMediaFiles() {", "originalCommit": "88e97298c0cd228f145490c5763455721eba737d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0Nzc3Mw==", "url": "https://github.com/getodk/collect/pull/4006#discussion_r478247773", "bodyText": "Ah sorry because the formSaver is mocked! My bad. The way to verify things are set up correctly then is to assert on the files passed to the fromSaver (as part of verify) instead of the call the mediaUtils.", "author": "seadowg", "createdAt": "2020-08-27T08:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxOTgyOA=="}], "type": "inlineReview"}, {"oid": "a4970b42ce39921cf72a7819547da4917ae50d1e", "url": "https://github.com/getodk/collect/commit/a4970b42ce39921cf72a7819547da4917ae50d1e", "message": "craete FakeFormSaver", "committedDate": "2020-08-27T10:42:37Z", "type": "commit"}, {"oid": "2bd32012affbea012d927138a1d08affc83b5858", "url": "https://github.com/getodk/collect/commit/2bd32012affbea012d927138a1d08affc83b5858", "message": "fix unit tests", "committedDate": "2020-08-27T12:59:37Z", "type": "commit"}]}