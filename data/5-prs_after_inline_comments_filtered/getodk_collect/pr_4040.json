{"pr_number": 4040, "pr_title": "Isolate MultiFormDownloader", "pr_createdAt": "2020-08-24T16:45:00Z", "pr_url": "https://github.com/getodk/collect/pull/4040", "timeline": [{"oid": "5b835c850eaf074a92b890da694d6dc5d213932f", "url": "https://github.com/getodk/collect/commit/5b835c850eaf074a92b890da694d6dc5d213932f", "message": "Remoge ignores", "committedDate": "2020-09-01T15:03:41Z", "type": "forcePushed"}, {"oid": "e52141307a27671b2e28089dbb8ab1f298117541", "url": "https://github.com/getodk/collect/commit/e52141307a27671b2e28089dbb8ab1f298117541", "message": "Remoge ignores", "committedDate": "2020-09-01T15:54:15Z", "type": "forcePushed"}, {"oid": "54219105a7cd0326844b6bc98d66476959408bd8", "url": "https://github.com/getodk/collect/commit/54219105a7cd0326844b6bc98d66476959408bd8", "message": "Extract open rosa code from android package", "committedDate": "2020-09-03T08:56:14Z", "type": "forcePushed"}, {"oid": "6ee7a0987ab13b5f6f9e5f5f3bb4ea2b76d6896f", "url": "https://github.com/getodk/collect/commit/6ee7a0987ab13b5f6f9e5f5f3bb4ea2b76d6896f", "message": "Use InterruptedException rather than RuntimeException", "committedDate": "2020-09-09T15:15:27Z", "type": "forcePushed"}, {"oid": "36f862ff929e980fde9e8b1dd8b10c9cc9e74d42", "url": "https://github.com/getodk/collect/commit/36f862ff929e980fde9e8b1dd8b10c9cc9e74d42", "message": "Separate module and app tests", "committedDate": "2020-09-10T14:42:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU4NjExNQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r487586115", "bodyText": "@seadowg and I briefly talked about whether the use of the ODK cache directory could have any significance. All files are eventually cleaned up and I don't see any reason why any particular directory has to be used. Passing in the base cache directory, whatever it is, is certainly an improvement.\nAm I understanding correctly that you've kept using storagePathProvider.getDirPath(StorageSubdirectory.CACHE) but create an enclosing directory for each form's files so that can be deleted on cancel rather than having to touch individual files? That seems fine, as would using the Android scoped cache directory.", "author": "lognaturel", "createdAt": "2020-09-13T22:38:42Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "diffHunk": "@@ -339,13 +354,13 @@ FileResult downloadXform(String formName, String url, FormDownloaderListener sta\n          * SurveyCTO: The file is saved into a temp folder and is moved to the final place if everything\n          * is okay, so that garbage is not left over on cancel.\n          */\n-        private void writeFile(File file, FormDownloaderListener stateListener, InputStream inputStream)\n+        private void writeFile(File file, FormDownloaderListener stateListener, InputStream inputStream, File tempDir)\n                 throws IOException, InterruptedException {\n \n             File tempFile = File.createTempFile(\n                     file.getName(),\n                     TEMP_DOWNLOAD_EXTENSION,\n-                    new File(storagePathProvider.getDirPath(StorageSubdirectory.CACHE))", "originalCommit": "0368fa57029f6b0027f86b668872be522b244308", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4OTMxNA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r487789314", "bodyText": "Yeah that's right! I think going one step further and use the Android cache directory (directly) in the dependency declaration (AppDependencyModule) would be nice as well.", "author": "seadowg", "createdAt": "2020-09-14T09:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU4NjExNQ=="}], "type": "inlineReview"}, {"oid": "32073d0f0a61f191b613adb595ebad3ace5d5e75", "url": "https://github.com/getodk/collect/commit/32073d0f0a61f191b613adb595ebad3ace5d5e75", "message": "Remove usage of cache dir from ServerFormDownloader", "committedDate": "2020-09-21T14:22:02Z", "type": "forcePushed"}, {"oid": "9861587500f9d1726afa3364aab771227c4355c4", "url": "https://github.com/getodk/collect/commit/9861587500f9d1726afa3364aab771227c4355c4", "message": "Remove usage of cache dir from ServerFormDownloader", "committedDate": "2020-09-24T17:24:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2NTE4OQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r497465189", "bodyText": "This is now covered in the ServerFormDownloaderTest", "author": "seadowg", "createdAt": "2020-09-30T12:22:34Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formmanagement/DeleteBlankFormTest.java", "diffHunk": "@@ -63,36 +63,6 @@ public void deletingAForm_whenThereFilledForms_removesFormFromBlankFormList_butA\n                 .clickSaveAndExit();\n     }\n \n-    @Test\n-    public void afterFillingAForm_andDeletingIt_allowsFormToBeReDownloaded() {", "originalCommit": "d8fee5efaf9495812223eb4514d39bb0d0ac7dcf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3Mzc0MA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r497473740", "bodyText": "This was begging to be pulled out", "author": "seadowg", "createdAt": "2020-09-30T12:36:40Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/FormMetadataParser.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import org.javarosa.core.reference.ReferenceManager;\n+import org.javarosa.core.reference.RootTranslator;\n+import org.odk.collect.android.logic.FileReferenceFactory;\n+import org.odk.collect.android.utilities.FileUtils;\n+\n+import java.io.File;\n+import java.nio.charset.Charset;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.odk.collect.android.utilities.FileUtils.LAST_SAVED_FILENAME;\n+import static org.odk.collect.android.utilities.FileUtils.STUB_XML;\n+import static org.odk.collect.android.utilities.FileUtils.write;\n+\n+public class FormMetadataParser {", "originalCommit": "72546652d59309d3129bf1854709d2d5c32532bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NDM5Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r497474396", "bodyText": "We now just always include the manifest as part of the form details so logic that deals with it can be simpler (and doesn't end up fetching the manifest when it doesn't need to).", "author": "seadowg", "createdAt": "2020-09-30T12:37:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDetails.java", "diffHunk": "@@ -28,22 +28,22 @@\n     private final String formID;\n     private final String formVersion;\n     private final String hash;\n-    private final String manifestFileHash;\n     private final boolean isNotOnDevice;\n     private final boolean isUpdated;\n+    private final ManifestFile manifest;\n \n     public ServerFormDetails(String formName, String downloadUrl, String manifestUrl, String formID,\n-                             String formVersion, String hash, String manifestFileHash,\n-                             boolean isNotOnDevice, boolean isUpdated) {\n+                             String formVersion, String hash,\n+                             boolean isNotOnDevice, boolean isUpdated, ManifestFile manifest) {", "originalCommit": "72546652d59309d3129bf1854709d2d5c32532bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NTI5MA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r497475290", "bodyText": "The MultiFormDownloader lives on in here as pulling it apart entirely is going to be pretty time-consuming and we've already hit the core goal of getting rid of any references to it in the rest of the code.", "author": "seadowg", "createdAt": "2020-09-30T12:38:57Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "diffHunk": "@@ -1,30 +1,538 @@\n package org.odk.collect.android.formmanagement;\n \n+import android.net.Uri;\n+\n+import org.javarosa.core.reference.ReferenceManager;\n import org.odk.collect.android.R;\n import org.odk.collect.android.application.Collect;\n-import org.odk.collect.android.utilities.MultiFormDownloader;\n+import org.odk.collect.android.listeners.FormDownloaderListener;\n+import org.odk.collect.android.provider.FormsProviderAPI;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.FormNameUtils;\n+import org.odk.collect.android.utilities.Validator;\n+import org.odk.collect.forms.Form;\n+import org.odk.collect.forms.FormsRepository;\n+import org.odk.collect.server.FormApiException;\n+import org.odk.collect.server.FormListApi;\n+import org.odk.collect.server.MediaFile;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.function.Supplier;\n+\n+import javax.annotation.Nullable;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n+import timber.log.Timber;\n+\n+import static org.apache.commons.io.FileUtils.deleteDirectory;\n+import static org.odk.collect.utilities.PathUtils.getAbsoluteFilePath;\n \n /**\n- * Provides a sarcophagus for {@link org.odk.collect.android.utilities.MultiFormDownloader} so it\n+ * Provides a sarcophagus for {@link MultiFormDownloader} so it\n  * can eventually be disposed of.\n  */\n public class ServerFormDownloader implements FormDownloader {\n \n     private final MultiFormDownloader multiFormDownloader;", "originalCommit": "72546652d59309d3129bf1854709d2d5c32532bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3ODM2MQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r497478361", "bodyText": "It was clear when working with ServerFormDownloader that this part of the interface feels like too much as the provider becomes responsible for calculations that are based on it's state but have logic (calculating a relative or absolute path) that can live separately. All the extra helpers increase the coupling on whatever object is using it.", "author": "seadowg", "createdAt": "2020-09-30T12:43:52Z", "path": "collect_app/src/main/java/org/odk/collect/android/storage/StoragePathProvider.java", "diffHunk": "@@ -96,10 +99,6 @@ public String getFormDbPath(String filePath) {\n         return getDbPath(getDirPath(StorageSubdirectory.FORMS), filePath);\n     }\n \n-    public String getAbsoluteFormFilePath(String filePath) {", "originalCommit": "f96fcdd1ecd26e18d9d5e626b2fa1622b21aaa2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f20268809fac008e2cd3eb08dded83242fd1cefc", "url": "https://github.com/getodk/collect/commit/f20268809fac008e2cd3eb08dded83242fd1cefc", "message": "Remove complexity around booting an HTTPS MockWebServer\n\nThe structure of the code at this point means that we don't need to\nactually execute HTTPS requests in tests. The core logic we're testing\nis that the behaviour is different for different schemes and we can set\nthat up in the test by simply passing http or https in", "committedDate": "2020-10-06T11:13:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwMjQyNg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500602426", "bodyText": "What made you want this package change? It's kind of a weird one because it's for the preferences part of the formmanagement feature. Curious to know how you make that decision as we move more towards feature-based packages.", "author": "lognaturel", "createdAt": "2020-10-06T21:19:50Z", "path": "collect_app/src/main/java/org/odk/collect/android/preferences/FormUpdateMode.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package org.odk.collect.android.formmanagement;\n+package org.odk.collect.android.preferences;", "originalCommit": "1f9b3c3791e7b0635febdffeaab5152624aaad92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3OTE2Mg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500979162", "bodyText": "I think I bounced around on this a few times. For me it was that the actual setting of the mode is a settings/preference concern and then other parts of the app ask about it. I'm starting to think about settings as its own section of the app that provides config for everything else. In that way (in my head) it makes sense that it owns the domain objects/data models associated with it. Does that make sense?", "author": "seadowg", "createdAt": "2020-10-07T12:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwMjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNTI1NQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500605255", "bodyText": "I think this changes behavior. Previously, the presence of media updates was only checked if we didn't already know new XML was available. Now, if media files are available, we ignore whether or not new XML is available and only do an update if new media is available. I think the enclosing condition can be changed to !isNewerFormVersionAvailable && manifestFile != null -- we only care to check media for updates if we already know there isn't new XML.\n    @Test\n    public void whenAFormExists_andIsUpdatedOnServer_andDoesNotHaveNewMedia_isUpdated() throws Exception {\n        formsRepository.save(new Form.Builder()\n                .id(2L)\n                .jrFormId(\"form-2\")\n                .md5Hash(\"form-2-hash-old\")\n                .build());\n\n        File localMediaFile = File.createTempFile(\"blah\", \".csv\");\n        writeToFile(localMediaFile, \"blah\");\n        when(mediaFileRepository.getAll(\"form-2\", \"server\")).thenReturn(asList(localMediaFile));\n\n        List<ServerFormDetails> serverFormDetails = fetcher.fetchFormDetails();\n        assertThat(serverFormDetails.get(1).isUpdated(), is(true));\n    }", "author": "lognaturel", "createdAt": "2020-10-06T21:25:46Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormsDetailsFetcher.java", "diffHunk": "@@ -71,13 +70,13 @@ public void updateFormListApi(String url, WebCredentialsUtils webCredentialsUtil\n \n             boolean thisFormAlreadyDownloaded = !formsRepository.getByJrFormIdNotDeleted(listItem.getFormID()).isEmpty();\n             if (thisFormAlreadyDownloaded) {\n-                isNewerFormVersionAvailable = isNewerFormVersionAvailable(getMd5HashWithoutPrefix(listItem.getHashWithPrefix()));\n+                isNewerFormVersionAvailable = isNewerFormVersionAvailable(listItem);\n \n                 if (manifestFile != null) {\n                     List<MediaFile> newMediaFiles = manifestFile.getMediaFiles();\n \n                     if (newMediaFiles != null && !newMediaFiles.isEmpty()) {\n-                        areNewerMediaFilesAvailable = areNewerMediaFilesAvailable(listItem.getFormID(), listItem.getVersion(), newMediaFiles);\n+                        isNewerFormVersionAvailable = areNewerMediaFilesAvailable(listItem.getFormID(), listItem.getVersion(), newMediaFiles);", "originalCommit": "306dc0d8e20a6458b6615058a01e062e940091c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4NjgwMg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500986802", "bodyText": "Ah nice. So many points for communicating the problem with a failing test.", "author": "seadowg", "createdAt": "2020-10-07T12:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNTI1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNzA1NA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500607054", "bodyText": "Just showing \"Failure\" rather than any more specific message was already part of the match exactly changes, right? So this doesn't change behavior?", "author": "lognaturel", "createdAt": "2020-10-06T21:29:18Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DownloadFormsTask.java", "diffHunk": "@@ -67,7 +67,7 @@ public DownloadFormsTask(FormDownloader formDownloader) {\n \n                 results.put(serverFormDetails, Collect.getInstance().getString(R.string.success));\n             } catch (FormDownloadException e) {\n-                results.put(serverFormDetails, e.getMessage());\n+                results.put(serverFormDetails, Collect.getInstance().getString(R.string.failure));", "originalCommit": "a3625660fbb352099cb9408fe3760bb9827586a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4NzMyNA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500987324", "bodyText": "Yeah I think this might be a mistake I made during a rebase... Will fix.", "author": "seadowg", "createdAt": "2020-10-07T12:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNzA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAxODc4Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501018786", "bodyText": "No wait sorry this looks right I read the diff in reverse.", "author": "seadowg", "createdAt": "2020-10-07T13:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNzA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0OTE1Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500649156", "bodyText": "Really, I think we should be using Paths and relativize. For some other time.", "author": "lognaturel", "createdAt": "2020-10-06T23:20:05Z", "path": "collect_app/src/main/java/org/odk/collect/utilities/PathUtils.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.odk.collect.utilities;\n+\n+import java.io.File;\n+\n+public class PathUtils {\n+\n+    private PathUtils() {\n+\n+    }\n+\n+    public static String getRelativeFilePath(String dirPath, String filePath) {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3OTcxNA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500979714", "bodyText": "huh. Yeah probably!", "author": "seadowg", "createdAt": "2020-10-07T12:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0OTE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0OTQ3Mg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500649472", "bodyText": "Path.resolve", "author": "lognaturel", "createdAt": "2020-10-06T23:21:12Z", "path": "collect_app/src/main/java/org/odk/collect/utilities/PathUtils.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.odk.collect.utilities;\n+\n+import java.io.File;\n+\n+public class PathUtils {\n+\n+    private PathUtils() {\n+\n+    }\n+\n+    public static String getRelativeFilePath(String dirPath, String filePath) {\n+        return filePath.startsWith(dirPath)\n+                ? filePath.substring(dirPath.length() + 1)\n+                : filePath;\n+    }\n+\n+    public static String getAbsoluteFilePath(String dirPath, String filePath) {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1ODkzMA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500658930", "bodyText": "Somehow I haven't noticed this signature. Why is the first param ArrayList<ServerFormDetails> rather than just ServerFormDetails? Feels unusual that doInBackground needs to access the 0th element. Did this change at some point or has it always been like this?", "author": "lognaturel", "createdAt": "2020-10-06T23:52:03Z", "path": "collect_app/src/main/java/org/odk/collect/android/tasks/DownloadFormsTask.java", "diffHunk": "@@ -33,32 +38,51 @@\n  * @author carlhartung\n  */\n public class DownloadFormsTask extends\n-        AsyncTask<ArrayList<ServerFormDetails>, String, HashMap<ServerFormDetails, String>> implements FormDownloaderListener {\n+        AsyncTask<ArrayList<ServerFormDetails>, String, Map<ServerFormDetails, String>> {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4MjgxNw==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500982817", "bodyText": "Ah it's weirdness with AsyncTask where execute takes a varargs of Params. Generally to avoid how consfusing this ends up looking I'd leave Params as Void and pass anything I need into the constructor (as you can't reuse an AsyncTask anyway). I think we can leave this for the moment as it's existing and ideally we want to just get rid of the AsyncTask rather than improve it.", "author": "seadowg", "createdAt": "2020-10-07T12:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY1ODkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MjY0NA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500662644", "bodyText": "This is not actually possible through the UI, is it? If it is, shouldn't the status for forms that did download be updated?", "author": "lognaturel", "createdAt": "2020-10-07T00:04:23Z", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/AutoUpdateTaskSpec.java", "diffHunk": "@@ -77,8 +80,18 @@\n                     if (preferencesProvider.getGeneralSharedPreferences().getBoolean(KEY_AUTOMATIC_UPDATE, false)) {\n                         changeLock.withLock(acquiredLock -> {\n                             if (acquiredLock) {\n-                                final HashMap<ServerFormDetails, String> result = multiFormDownloader.downloadForms(updatedForms, null);\n-                                notifier.onUpdatesDownloaded(result);\n+                                HashMap<ServerFormDetails, String> results = new HashMap<>();\n+                                for (ServerFormDetails serverFormDetails : updatedForms) {\n+                                    try {\n+                                        formDownloader.downloadForm(serverFormDetails, null, null);\n+                                        results.put(serverFormDetails, Collect.getInstance().getString(R.string.success));\n+                                    } catch (FormDownloadException e) {\n+                                        results.put(serverFormDetails, e.getMessage());\n+                                    } catch (InterruptedException e) {\n+                                        return null;", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyMjg3NQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501022875", "bodyText": "Yeah. This should really just be a break I think?", "author": "seadowg", "createdAt": "2020-10-07T13:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMjMyMA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501102320", "bodyText": "Yes, break sounds right.", "author": "lognaturel", "createdAt": "2020-10-07T15:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MzQwMw==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500663403", "bodyText": "There will never be a message for this. I believe the only place that exception is thrown is at https://github.com/getodk/collect/pull/4040/files?file-filters%5B%5D=.gradle&file-filters%5B%5D=.java&file-filters%5B%5D=.xml#diff-8ae847a7cbae59b9a61bd5868b5c6514R65. Is the client robust to nulls? Should this maybe be the failure message?", "author": "lognaturel", "createdAt": "2020-10-07T00:07:01Z", "path": "collect_app/src/main/java/org/odk/collect/android/backgroundwork/AutoUpdateTaskSpec.java", "diffHunk": "@@ -77,8 +80,18 @@\n                     if (preferencesProvider.getGeneralSharedPreferences().getBoolean(KEY_AUTOMATIC_UPDATE, false)) {\n                         changeLock.withLock(acquiredLock -> {\n                             if (acquiredLock) {\n-                                final HashMap<ServerFormDetails, String> result = multiFormDownloader.downloadForms(updatedForms, null);\n-                                notifier.onUpdatesDownloaded(result);\n+                                HashMap<ServerFormDetails, String> results = new HashMap<>();\n+                                for (ServerFormDetails serverFormDetails : updatedForms) {\n+                                    try {\n+                                        formDownloader.downloadForm(serverFormDetails, null, null);\n+                                        results.put(serverFormDetails, Collect.getInstance().getString(R.string.success));\n+                                    } catch (FormDownloadException e) {\n+                                        results.put(serverFormDetails, e.getMessage());", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyMzI0Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501023246", "bodyText": "Yeah I think this should just be the failure message.", "author": "seadowg", "createdAt": "2020-10-07T13:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MzQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2NzkyMQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500667921", "bodyText": "Canceled -> Cancelled", "author": "lognaturel", "createdAt": "2020-10-07T00:22:29Z", "path": "collect_app/src/main/java/org/odk/collect/android/formmanagement/ServerFormDownloader.java", "diffHunk": "@@ -1,31 +1,532 @@\n package org.odk.collect.android.formmanagement;\n \n+import android.net.Uri;\n+\n+import org.javarosa.core.reference.ReferenceManager;\n import org.odk.collect.android.R;\n import org.odk.collect.android.application.Collect;\n-import org.odk.collect.android.utilities.MultiFormDownloader;\n-import org.odk.collect.android.utilities.TranslationHandler;\n+import org.odk.collect.android.listeners.FormDownloaderListener;\n+import org.odk.collect.android.provider.FormsProviderAPI;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.FormNameUtils;\n+import org.odk.collect.android.utilities.Validator;\n+import org.odk.collect.forms.Form;\n+import org.odk.collect.forms.FormsRepository;\n+import org.odk.collect.server.FormApiException;\n+import org.odk.collect.server.FormListApi;\n+import org.odk.collect.server.MediaFile;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.function.Supplier;\n+\n+import javax.annotation.Nullable;\n \n-import java.util.Collections;\n-import java.util.HashMap;\n+import timber.log.Timber;\n+\n+import static org.apache.commons.io.FileUtils.deleteDirectory;\n+import static org.odk.collect.utilities.PathUtils.getAbsoluteFilePath;\n \n-/**\n- * Provides a sarcophagus for {@link org.odk.collect.android.utilities.MultiFormDownloader} so it\n- * can eventually be disposed of.\n- */\n public class ServerFormDownloader implements FormDownloader {\n \n     private final MultiFormDownloader multiFormDownloader;\n+    private final FormsRepository formsRepository;\n+    private final File cacheDir;\n+    private final String formsDirPath;\n \n-    public ServerFormDownloader(MultiFormDownloader multiFormDownloader) {\n-        this.multiFormDownloader = multiFormDownloader;\n+    public ServerFormDownloader(FormListApi formListApi, FormsRepository formsRepository, File cacheDir, String formsDirPath) {\n+        this.cacheDir = cacheDir;\n+        this.formsDirPath = formsDirPath;\n+        this.multiFormDownloader = new MultiFormDownloader(formsRepository, formListApi);\n+        this.formsRepository = formsRepository;\n     }\n \n     @Override\n-    public void downloadForm(ServerFormDetails form) throws FormDownloadException {\n-        HashMap<ServerFormDetails, String> results = multiFormDownloader.downloadForms(Collections.singletonList(form), null);\n-        boolean failure = results.values().stream().anyMatch(s -> !s.equals(TranslationHandler.getString(Collect.getInstance(), R.string.success)));\n-        if (failure) {\n-            throw new FormDownloadException();\n+    public void downloadForm(ServerFormDetails form, @Nullable ProgressReporter progressReporter, @Nullable Supplier<Boolean> isCancelled) throws FormDownloadException, InterruptedException {\n+        Form formOnDevice = formsRepository.get(form.getFormId(), form.getFormVersion());\n+        if (formOnDevice != null && formOnDevice.isDeleted()) {\n+            formsRepository.restore(formOnDevice.getId());\n+        }\n+\n+        File tempDir = new File(cacheDir, \"download-\" + UUID.randomUUID().toString());\n+        tempDir.mkdirs();\n+\n+        try {\n+            FormDownloaderListener stateListener = new ProgressReporterAndSupplierStateListener(progressReporter, isCancelled);\n+            boolean result = multiFormDownloader.processOneForm(form, stateListener, tempDir, formsDirPath);\n+\n+            if (!result) {\n+                throw new FormDownloadException();\n+            }\n+        } finally {\n+            try {\n+                deleteDirectory(tempDir);\n+            } catch (IOException ignored) {\n+                // ignored\n+            }\n+        }\n+    }\n+\n+    private static class ProgressReporterAndSupplierStateListener implements FormDownloaderListener {\n+        private final ProgressReporter progressReporter;\n+        private final Supplier<Boolean> isCancelled;\n+\n+        ProgressReporterAndSupplierStateListener(ProgressReporter progressReporter, Supplier<Boolean> isCancelled) {\n+            this.progressReporter = progressReporter;\n+            this.isCancelled = isCancelled;\n+        }\n+\n+        @Override\n+        public void progressUpdate(String currentFile, String progress, String total) {\n+            if (progressReporter != null) {\n+                progressReporter.onDownloadingMediaFile(Integer.parseInt(progress));\n+            }\n+        }\n+\n+        @Override\n+        public boolean isTaskCanceled() {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczMzc2OQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500733769", "bodyText": "Expected?", "author": "lognaturel", "createdAt": "2020-10-07T04:42:18Z", "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/ServerFormDownloaderTest.java", "diffHunk": "@@ -0,0 +1,349 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import com.google.common.io.Files;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.support.InMemFormsRepository;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.WebCredentialsUtils;\n+import org.odk.collect.forms.Form;\n+import org.odk.collect.forms.FormsRepository;\n+import org.odk.collect.server.FormApiException;\n+import org.odk.collect.server.FormListApi;\n+import org.odk.collect.server.FormListItem;\n+import org.odk.collect.server.ManifestFile;\n+import org.odk.collect.server.MediaFile;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+import static java.util.Arrays.asList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.support.FormUtils.buildForm;\n+import static org.odk.collect.android.support.FormUtils.createXForm;\n+import static org.odk.collect.android.utilities.FileUtils.read;\n+import static org.odk.collect.utilities.PathUtils.getAbsoluteFilePath;\n+\n+@SuppressWarnings(\"PMD.DoubleBraceInitialization\")\n+public class ServerFormDownloaderTest {\n+\n+    private final FormsRepository formsRepository = new InMemFormsRepository();\n+\n+    private File cacheDir;\n+    private File formsDir;\n+\n+    @Before\n+    public void setup() {\n+        cacheDir = Files.createTempDir();\n+        formsDir = Files.createTempDir();\n+    }\n+\n+    @Test\n+    public void downloadsAndSavesForm() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                null);\n+\n+        FormListApi formListApi = mock(FormListApi.class);\n+        when(formListApi.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(xform.getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+        downloader.downloadForm(serverFormDetails, null, null);\n+\n+        List<Form> allForms = formsRepository.getAll();\n+        assertThat(allForms.size(), is(1));\n+        Form form = allForms.get(0);\n+        assertThat(form.getJrFormId(), is(\"id\"));\n+\n+        File formFile = new File(getAbsoluteFilePath(formsDir.getAbsolutePath(), form.getFormFilePath()));\n+        assertThat(formFile.exists(), is(true));\n+        assertThat(new String(read(formFile)), is(xform));\n+    }\n+\n+    @Test\n+    public void whenFormHasMediaFiles_downloadsAndSavesFormAndMediaFiles() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                new ManifestFile(\"\", asList(\n+                        new MediaFile(\"file1\", \"hash-1\", \"http://file1\"),\n+                        new MediaFile(\"file2\", \"hash-2\", \"http://file2\")\n+                )));\n+\n+        FormListApi formListApi = mock(FormListApi.class);\n+        when(formListApi.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(xform.getBytes()));\n+        when(formListApi.fetchMediaFile(\"http://file1\")).thenReturn(new ByteArrayInputStream(\"contents1\".getBytes()));\n+        when(formListApi.fetchMediaFile(\"http://file2\")).thenReturn(new ByteArrayInputStream(\"contents2\".getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+        downloader.downloadForm(serverFormDetails, null, null);\n+\n+        List<Form> allForms = formsRepository.getAll();\n+        assertThat(allForms.size(), is(1));\n+        Form form = allForms.get(0);\n+        assertThat(form.getJrFormId(), is(\"id\"));\n+\n+        File formFile = new File(getAbsoluteFilePath(formsDir.getAbsolutePath(), form.getFormFilePath()));\n+        assertThat(formFile.exists(), is(true));\n+        assertThat(new String(read(formFile)), is(xform));\n+\n+        File mediaFile1 = new File(form.getFormMediaPath() + \"/file1\");\n+        assertThat(mediaFile1.exists(), is(true));\n+        assertThat(new String(read(mediaFile1)), is(\"contents1\"));\n+\n+        File mediaFile2 = new File(form.getFormMediaPath() + \"/file2\");\n+        assertThat(mediaFile2.exists(), is(true));\n+        assertThat(new String(read(mediaFile2)), is(\"contents2\"));\n+    }\n+\n+    @Test\n+    public void afterDownloadingXForm_cancelling_throwsInterruptedExceptionAndDoesNotSaveAnything() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                null);\n+\n+        CancelAfterFormDownloadFormListApi formListApi = new CancelAfterFormDownloadFormListApi(xform);\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+\n+        try {\n+            downloader.downloadForm(serverFormDetails, null, formListApi);\n+            fail(\"Excepted exception\");", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczMzg5Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500733896", "bodyText": "Add test for media file progress?", "author": "lognaturel", "createdAt": "2020-10-07T04:42:51Z", "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/ServerFormDownloaderTest.java", "diffHunk": "@@ -0,0 +1,349 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import com.google.common.io.Files;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.support.InMemFormsRepository;\n+import org.odk.collect.android.utilities.FileUtils;\n+import org.odk.collect.android.utilities.WebCredentialsUtils;\n+import org.odk.collect.forms.Form;\n+import org.odk.collect.forms.FormsRepository;\n+import org.odk.collect.server.FormApiException;\n+import org.odk.collect.server.FormListApi;\n+import org.odk.collect.server.FormListItem;\n+import org.odk.collect.server.ManifestFile;\n+import org.odk.collect.server.MediaFile;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.InputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+import static java.util.Arrays.asList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.support.FormUtils.buildForm;\n+import static org.odk.collect.android.support.FormUtils.createXForm;\n+import static org.odk.collect.android.utilities.FileUtils.read;\n+import static org.odk.collect.utilities.PathUtils.getAbsoluteFilePath;\n+\n+@SuppressWarnings(\"PMD.DoubleBraceInitialization\")\n+public class ServerFormDownloaderTest {\n+\n+    private final FormsRepository formsRepository = new InMemFormsRepository();\n+\n+    private File cacheDir;\n+    private File formsDir;\n+\n+    @Before\n+    public void setup() {\n+        cacheDir = Files.createTempDir();\n+        formsDir = Files.createTempDir();\n+    }\n+\n+    @Test\n+    public void downloadsAndSavesForm() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                null);\n+\n+        FormListApi formListApi = mock(FormListApi.class);\n+        when(formListApi.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(xform.getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+        downloader.downloadForm(serverFormDetails, null, null);\n+\n+        List<Form> allForms = formsRepository.getAll();\n+        assertThat(allForms.size(), is(1));\n+        Form form = allForms.get(0);\n+        assertThat(form.getJrFormId(), is(\"id\"));\n+\n+        File formFile = new File(getAbsoluteFilePath(formsDir.getAbsolutePath(), form.getFormFilePath()));\n+        assertThat(formFile.exists(), is(true));\n+        assertThat(new String(read(formFile)), is(xform));\n+    }\n+\n+    @Test\n+    public void whenFormHasMediaFiles_downloadsAndSavesFormAndMediaFiles() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                new ManifestFile(\"\", asList(\n+                        new MediaFile(\"file1\", \"hash-1\", \"http://file1\"),\n+                        new MediaFile(\"file2\", \"hash-2\", \"http://file2\")\n+                )));\n+\n+        FormListApi formListApi = mock(FormListApi.class);\n+        when(formListApi.fetchForm(\"http://downloadUrl\")).thenReturn(new ByteArrayInputStream(xform.getBytes()));\n+        when(formListApi.fetchMediaFile(\"http://file1\")).thenReturn(new ByteArrayInputStream(\"contents1\".getBytes()));\n+        when(formListApi.fetchMediaFile(\"http://file2\")).thenReturn(new ByteArrayInputStream(\"contents2\".getBytes()));\n+\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+        downloader.downloadForm(serverFormDetails, null, null);\n+\n+        List<Form> allForms = formsRepository.getAll();\n+        assertThat(allForms.size(), is(1));\n+        Form form = allForms.get(0);\n+        assertThat(form.getJrFormId(), is(\"id\"));\n+\n+        File formFile = new File(getAbsoluteFilePath(formsDir.getAbsolutePath(), form.getFormFilePath()));\n+        assertThat(formFile.exists(), is(true));\n+        assertThat(new String(read(formFile)), is(xform));\n+\n+        File mediaFile1 = new File(form.getFormMediaPath() + \"/file1\");\n+        assertThat(mediaFile1.exists(), is(true));\n+        assertThat(new String(read(mediaFile1)), is(\"contents1\"));\n+\n+        File mediaFile2 = new File(form.getFormMediaPath() + \"/file2\");\n+        assertThat(mediaFile2.exists(), is(true));\n+        assertThat(new String(read(mediaFile2)), is(\"contents2\"));\n+    }\n+\n+    @Test\n+    public void afterDownloadingXForm_cancelling_throwsInterruptedExceptionAndDoesNotSaveAnything() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                null);\n+\n+        CancelAfterFormDownloadFormListApi formListApi = new CancelAfterFormDownloadFormListApi(xform);\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+\n+        try {\n+            downloader.downloadForm(serverFormDetails, null, formListApi);\n+            fail(\"Excepted exception\");\n+        } catch (InterruptedException e) {\n+            assertThat(formsRepository.getAll(), is(empty()));\n+            assertThat(asList(new File(getCacheFilesPath()).listFiles()), is(empty()));\n+            assertThat(asList(new File(getFormFilesPath()).listFiles()), is(empty()));\n+        }\n+    }\n+\n+    @Test\n+    public void afterDownloadingMediaFile_cancelling_throwsInterruptedExceptionAndDoesNotSaveAnything() throws Exception {\n+        String xform = createXForm(\"id\", \"version\");\n+        ServerFormDetails serverFormDetails = new ServerFormDetails(\n+                \"Form\",\n+                \"http://downloadUrl\",\n+                \"http://manifestUrl\",\n+                \"id\",\n+                \"version\",\n+                \"md5:\" + FileUtils.getMd5Hash(new ByteArrayInputStream(xform.getBytes())),\n+                true,\n+                false,\n+                new ManifestFile(\"\", asList(\n+                        new MediaFile(\"file1\", \"hash-1\", \"http://file1\"),\n+                        new MediaFile(\"file2\", \"hash-2\", \"http://file2\")\n+                )));\n+\n+        CancelAfterMediaFileDownloadFormListApi formListApi = new CancelAfterMediaFileDownloadFormListApi(xform);\n+        ServerFormDownloader downloader = new ServerFormDownloader(formListApi, formsRepository, cacheDir, formsDir.getAbsolutePath());\n+\n+        try {\n+            downloader.downloadForm(serverFormDetails, null, formListApi);\n+            fail(\"Excepted exception\");\n+        } catch (InterruptedException e) {\n+            assertThat(formsRepository.getAll(), is(empty()));\n+            assertThat(asList(new File(getCacheFilesPath()).listFiles()), is(empty()));\n+\n+            // The media directory is created early for some reason\n+            assertThat(asList(new File(getFormFilesPath()).listFiles()), contains(new File(getFormFilesPath() + \"/Form-media\")));\n+        }\n+    }\n+\n+    @Test\n+    public void beforeDownloadingMediaFile_reportsProgress() throws Exception {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4Mzg3MA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500983870", "bodyText": "I'm pretty sure I ended up not needing another test to drive that out (I basically used commenting/deleting to work out adding tests). You're right that from a documentation and regression standpoint though it would be nice to have the test.", "author": "seadowg", "createdAt": "2020-10-07T12:48:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczMzg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExNjUwMw==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501116503", "bodyText": "Wait looking back at this I'm not sure what test you think is missing here? I thought I was missing media file progress but I think this test is just badly named as it covers that?", "author": "seadowg", "createdAt": "2020-10-07T15:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczMzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDg2Ng==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500734866", "bodyText": "I think this case should get coverage somewhere. I think the CSV case can be skipped but the last-saved one should also be captured.", "author": "lognaturel", "createdAt": "2020-10-07T04:46:42Z", "path": "collect_app/src/test/java/org/odk/collect/android/utilities/MultiFormDownloaderTest.java", "diffHunk": "@@ -1,414 +0,0 @@\n-package org.odk.collect.android.utilities;\n-\n-import org.junit.Rule;\n-import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.kxml2.io.KXmlParser;\n-import org.kxml2.kdom.Document;\n-import org.mockito.Mock;\n-import org.mockito.junit.MockitoJUnit;\n-import org.mockito.junit.MockitoRule;\n-import org.odk.collect.android.formmanagement.ServerFormDetails;\n-import org.odk.collect.android.openrosa.OpenRosaXmlFetcher;\n-import org.robolectric.RobolectricTestRunner;\n-import org.xmlpull.v1.XmlPullParser;\n-\n-import java.io.BufferedWriter;\n-import java.io.ByteArrayInputStream;\n-import java.io.File;\n-import java.io.FileWriter;\n-import java.io.InputStream;\n-import java.io.InputStreamReader;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-\n-import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.CoreMatchers.is;\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.ArgumentMatchers.anyInt;\n-import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.spy;\n-import static org.mockito.Mockito.when;\n-\n-@RunWith(RobolectricTestRunner.class)\n-public class MultiFormDownloaderTest {\n-    @Rule\n-    public MockitoRule mockitoRule = MockitoJUnit.rule();\n-\n-    @Mock\n-    OpenRosaXmlFetcher openRosaXMLFetcher;\n-\n-    /**\n-     * Verifies that a form without media can successfully go through the download process. Regression\n-     * test for https://github.com/getodk/collect/issues/3535.\n-     *\n-     * The focus of this test is the form parsing behavior triggered by a download and how it\n-     * relates to a media folder that may or may not have been created. The downloading of forms and\n-     * saving of parsed form  values are mocked (and those concerns should be separated).\n-     */\n-    @Test\n-    public void downloadingFormWithoutMedia_Succeeds() throws Exception {\n-        String basicNoMedia = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\">\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic\\\">\\n\" +\n-                \"                    <q1/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <bind nodeset=\\\"/data/q1\\\" type=\\\"string\\\"/>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <input ref=\\\"/data/q1\\\">\\n\" +\n-                \"            <label>Question</label>\\n\" +\n-                \"        </input>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicNoMedia\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicNoMedia);\n-        out.close();\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails serverFormDetails = new ServerFormDetails(\"No media\", \"https://testserver/no-media.xml\",\n-                null, \"basic\", \"2019121201\",\n-                \"hash\", null, false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(serverFormDetails.getFormName(), serverFormDetails.getDownloadUrl(), null);\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(serverFormDetails);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(serverFormDetails), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Companion to downloading form without media.\n-     *\n-     * The focus of this test is the form parsing behavior triggered by a download and how it\n-     * relates to a media folder that may or may not have been created. The form downloading, media\n-     * downloading and saving of parsed form values are mocked.\n-     *\n-     * Note: what's important in this test is that the manifestURL in the FormDetails object is set.\n-     * It doesn't really matter that the form definition uses media but that's included to better\n-     * match reality.\n-     */\n-    @Test\n-    public void downloadingFormWithMedia_Succeeds() throws Exception {\n-        String basicMedia = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\">\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic-media</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic-media\\\">\\n\" +\n-                \"                    <q1/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <bind nodeset=\\\"/data/q1\\\" type=\\\"string\\\"/>\\n\" +\n-                \"            <itext> \\n\" +\n-                \"                <translation default=\\\"true()\\\" lang=\\\"English\\\">\\n\" +\n-                \"                    <text id=\\\"/data/q1:label\\\"><value form=\\\"image\\\">jr://images/b.jpg</value></text>\\n\" +\n-                \"                </translation>\\n\" +\n-                \"            </itext>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <input ref=\\\"/data/q1\\\">\\n\" +\n-                \"            <label>Question</label>\\n\" +\n-                \"        </input>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicMedia\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicMedia);\n-        out.close();\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails serverFormDetails = new ServerFormDetails(\"Media\", \"https://testserver/media.xml\",\n-                \"https://testserver/media-manifest.xml\", \"media\", \"2019121201\",\n-                \"hash\", \"manifestHash\", false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(serverFormDetails.getFormName(), serverFormDetails.getDownloadUrl(), null);\n-        doReturn(\"\").when(downloader).downloadManifestAndMediaFiles(any(), any(), any(), anyInt(), anyInt(), any());\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(serverFormDetails);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(serverFormDetails), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Forms with references to external secondary instance need to have the secondary instance\n-     * available at time of form parse.\n-     *\n-     * See https://github.com/getodk/collect/issues/3635\n-     */\n-    @Test\n-    public void downloadingFormWithXmlExternalSecondaryInstance_Succeeds() throws Exception {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4NDE5NQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500984195", "bodyText": "Same as the media file progress test I think. Didn't need it but I think you're right we should add it in any way.", "author": "seadowg", "createdAt": "2020-10-07T12:49:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA5OTY0Mg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501099642", "bodyText": "It's not the same. Only external secondary instances will actually use the ReferenceManager configured by FormMetadataParser. It's really easy for code there to get removed or modified (as it had been before).", "author": "lognaturel", "createdAt": "2020-10-07T15:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTExMTI4NQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501111285", "bodyText": "Sorry I mean \"same story\", not \"same code\".", "author": "seadowg", "createdAt": "2020-10-07T15:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDk4NA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500734984", "bodyText": "I think this edge case is also important to capture somewhere.", "author": "lognaturel", "createdAt": "2020-10-07T04:47:10Z", "path": "collect_app/src/test/java/org/odk/collect/android/utilities/MultiFormDownloaderTest.java", "diffHunk": "@@ -1,414 +0,0 @@\n-package org.odk.collect.android.utilities;\n-\n-import org.junit.Rule;\n-import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.kxml2.io.KXmlParser;\n-import org.kxml2.kdom.Document;\n-import org.mockito.Mock;\n-import org.mockito.junit.MockitoJUnit;\n-import org.mockito.junit.MockitoRule;\n-import org.odk.collect.android.formmanagement.ServerFormDetails;\n-import org.odk.collect.android.openrosa.OpenRosaXmlFetcher;\n-import org.robolectric.RobolectricTestRunner;\n-import org.xmlpull.v1.XmlPullParser;\n-\n-import java.io.BufferedWriter;\n-import java.io.ByteArrayInputStream;\n-import java.io.File;\n-import java.io.FileWriter;\n-import java.io.InputStream;\n-import java.io.InputStreamReader;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-\n-import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.CoreMatchers.is;\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.ArgumentMatchers.anyInt;\n-import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.spy;\n-import static org.mockito.Mockito.when;\n-\n-@RunWith(RobolectricTestRunner.class)\n-public class MultiFormDownloaderTest {\n-    @Rule\n-    public MockitoRule mockitoRule = MockitoJUnit.rule();\n-\n-    @Mock\n-    OpenRosaXmlFetcher openRosaXMLFetcher;\n-\n-    /**\n-     * Verifies that a form without media can successfully go through the download process. Regression\n-     * test for https://github.com/getodk/collect/issues/3535.\n-     *\n-     * The focus of this test is the form parsing behavior triggered by a download and how it\n-     * relates to a media folder that may or may not have been created. The downloading of forms and\n-     * saving of parsed form  values are mocked (and those concerns should be separated).\n-     */\n-    @Test\n-    public void downloadingFormWithoutMedia_Succeeds() throws Exception {\n-        String basicNoMedia = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\">\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic\\\">\\n\" +\n-                \"                    <q1/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <bind nodeset=\\\"/data/q1\\\" type=\\\"string\\\"/>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <input ref=\\\"/data/q1\\\">\\n\" +\n-                \"            <label>Question</label>\\n\" +\n-                \"        </input>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicNoMedia\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicNoMedia);\n-        out.close();\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails serverFormDetails = new ServerFormDetails(\"No media\", \"https://testserver/no-media.xml\",\n-                null, \"basic\", \"2019121201\",\n-                \"hash\", null, false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(serverFormDetails.getFormName(), serverFormDetails.getDownloadUrl(), null);\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(serverFormDetails);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(serverFormDetails), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Companion to downloading form without media.\n-     *\n-     * The focus of this test is the form parsing behavior triggered by a download and how it\n-     * relates to a media folder that may or may not have been created. The form downloading, media\n-     * downloading and saving of parsed form values are mocked.\n-     *\n-     * Note: what's important in this test is that the manifestURL in the FormDetails object is set.\n-     * It doesn't really matter that the form definition uses media but that's included to better\n-     * match reality.\n-     */\n-    @Test\n-    public void downloadingFormWithMedia_Succeeds() throws Exception {\n-        String basicMedia = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\">\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic-media</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic-media\\\">\\n\" +\n-                \"                    <q1/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <bind nodeset=\\\"/data/q1\\\" type=\\\"string\\\"/>\\n\" +\n-                \"            <itext> \\n\" +\n-                \"                <translation default=\\\"true()\\\" lang=\\\"English\\\">\\n\" +\n-                \"                    <text id=\\\"/data/q1:label\\\"><value form=\\\"image\\\">jr://images/b.jpg</value></text>\\n\" +\n-                \"                </translation>\\n\" +\n-                \"            </itext>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <input ref=\\\"/data/q1\\\">\\n\" +\n-                \"            <label>Question</label>\\n\" +\n-                \"        </input>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicMedia\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicMedia);\n-        out.close();\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails serverFormDetails = new ServerFormDetails(\"Media\", \"https://testserver/media.xml\",\n-                \"https://testserver/media-manifest.xml\", \"media\", \"2019121201\",\n-                \"hash\", \"manifestHash\", false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(serverFormDetails.getFormName(), serverFormDetails.getDownloadUrl(), null);\n-        doReturn(\"\").when(downloader).downloadManifestAndMediaFiles(any(), any(), any(), anyInt(), anyInt(), any());\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(serverFormDetails);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(serverFormDetails), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Forms with references to external secondary instance need to have the secondary instance\n-     * available at time of form parse.\n-     *\n-     * See https://github.com/getodk/collect/issues/3635\n-     */\n-    @Test\n-    public void downloadingFormWithXmlExternalSecondaryInstance_Succeeds() throws Exception {\n-        String basicLastSaved = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\" >\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic-external-xml-instance</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic-external-xml-instance\\\">\\n\" +\n-                \"                    <first/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <instance id=\\\"external-xml\\\" src=\\\"jr://file/external-data.xml\\\" />\\n\" +\n-                \"            <bind nodeset=\\\"/data/first\\\" type=\\\"select1\\\"/>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <select1 ref=\\\"/data/first\\\">\\n\" +\n-                \"            <label>First</label>\\n\" +\n-                \"            <itemset nodeset=\\\"instance('external-xml')/root/item[first='']\\\">\\n\" +\n-                \"                <value ref=\\\"name\\\"/>\\n\" +\n-                \"                <label ref=\\\"label\\\"/>\\n\" +\n-                \"            </itemset>\\n\" +\n-                \"        </select1>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicExternalXmlInstance\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicLastSaved);\n-        out.close();\n-\n-        when(openRosaXMLFetcher.getXML(\"https://testserver/manifest.xml\")).thenReturn(buildManifestFetchResult(\"external-data.xml\"));\n-        when(openRosaXMLFetcher.getFile(\"https://testserver/external-data.xml\",\n-                null)).thenReturn(buildXmlExternalInstanceFetchResult());\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails test1 = new ServerFormDetails(\"basic-external-xml-instance\", \"https://testserver/form.xml\",\n-                \"https://testserver/manifest.xml\", \"basic-external-xml-instance\", \"20200101\",\n-                \"hash\", \"manifestHash\", false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(test1.getFormName(), test1.getDownloadUrl(), null);\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(test1);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(test1), is(\"Success\"));\n-    }\n-\n-    @Test\n-    public void downloadingFormWithCsvExternalSecondaryInstance_Succeeds() throws Exception {\n-        String basicLastSaved = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\" >\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic-external-csv-instance</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic-external-csv-instance\\\">\\n\" +\n-                \"                    <first/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <instance id=\\\"external-csv\\\" src=\\\"jr://file-csv/external-data.csv\\\" />\\n\" +\n-                \"            <bind nodeset=\\\"/data/first\\\" type=\\\"select1\\\"/>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <select1 ref=\\\"/data/first\\\">\\n\" +\n-                \"            <label>First</label>\\n\" +\n-                \"            <itemset nodeset=\\\"instance('external-csv')/root/item[first='']\\\">\\n\" +\n-                \"                <value ref=\\\"name\\\"/>\\n\" +\n-                \"                <label ref=\\\"label\\\"/>\\n\" +\n-                \"            </itemset>\\n\" +\n-                \"        </select1>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicExternalCsvInstance\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicLastSaved);\n-        out.close();\n-\n-        when(openRosaXMLFetcher.getXML(\"https://testserver/manifest.xml\")).thenReturn(buildManifestFetchResult(\"external-data.csv\"));\n-        when(openRosaXMLFetcher.getFile(\"https://testserver/external-data.csv\",\n-                null)).thenReturn(buildCsvExternalInstanceFetchResult());\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails test1 = new ServerFormDetails(\"basic-external-csv-instance\", \"https://testserver/form.xml\",\n-                \"https://testserver/manifest.xml\", \"basic-external-csv-instance\", \"20200101\",\n-                \"hash\", \"manifestHash\", false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(test1.getFormName(), test1.getDownloadUrl(), null);\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(test1);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(test1), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Forms with last-saved references are a special case of external secondary instances because\n-     * last-saved doesn't come from the remote server but is generated locally.\n-     */\n-    @Test\n-    public void downloadingFormWithLastSavedReference_Succeeds() throws Exception {\n-        String basicLastSaved = \"<h:html xmlns=\\\"http://www.w3.org/2002/xforms\\\" xmlns:h=\\\"http://www.w3.org/1999/xhtml\\\">\\n\" +\n-                \"    <h:head>\\n\" +\n-                \"        <h:title>basic-last-saved</h:title>\\n\" +\n-                \"        <model>\\n\" +\n-                \"            <instance>\\n\" +\n-                \"                <data id=\\\"basic-last-saved\\\">\\n\" +\n-                \"                    <q1/>\\n\" +\n-                \"                </data>\\n\" +\n-                \"            </instance>\\n\" +\n-                \"            <instance id=\\\"__last-saved\\\" src=\\\"jr://instance/last-saved\\\"/>\\n\" +\n-                \"            <bind nodeset=\\\"/data/q1\\\" type=\\\"string\\\"/>\\n\" +\n-                \"           <setvalue event=\\\"odk-instance-first-load\\\" ref=\\\"/data/q1\\\" value=\\\" instance('__last-saved')/data/q1 \\\"/>\\n\" +\n-                \"        </model>\\n\" +\n-                \"    </h:head>\\n\" +\n-                \"    <h:body>\\n\" +\n-                \"        <input ref=\\\"/data/q1\\\">\\n\" +\n-                \"            <label>Question</label>\\n\" +\n-                \"        </input>\\n\" +\n-                \"    </h:body>\\n\" +\n-                \"</h:html>\";\n-        File formXml = File.createTempFile(\"basicLastSaved\", \".xml\");\n-        formXml.deleteOnExit();\n-\n-        BufferedWriter out = new BufferedWriter(new FileWriter(formXml));\n-        out.write(basicLastSaved);\n-        out.close();\n-\n-        MultiFormDownloader downloader = spy(new MultiFormDownloader(openRosaXMLFetcher));\n-        ServerFormDetails test1 = new ServerFormDetails(\"Last Saved\", \"https://testserver/media.xml\",\n-                \"https://testserver/media-manifest.xml\", \"basic-last-saved\", \"20200101\",\n-                \"hash\", \"manifestHash\", false, false);\n-        MultiFormDownloader.FileResult result = new MultiFormDownloader.FileResult(formXml, true);\n-        doReturn(result).when(downloader).downloadXform(test1.getFormName(), test1.getDownloadUrl(), null);\n-        doReturn(\"\").when(downloader).downloadManifestAndMediaFiles(any(), any(), any(), anyInt(), anyInt(), any());\n-        doReturn(true).when(downloader).installEverything(any(), any(), any());\n-\n-        List<ServerFormDetails> forms = new ArrayList<>();\n-        forms.add(test1);\n-\n-        HashMap<ServerFormDetails, String> messages = downloader.downloadForms(forms, null);\n-        assertThat(messages.get(test1), is(\"Success\"));\n-    }\n-\n-    /**\n-     * Edge case: a form could have an attachment with filename last-saved.xml. This will get\n-     * replaced immediately on download and this test documents that behavior. We could let it go\n-     * through but let's replace it immediately to help a user who tries this troubleshoot.\n-     * Otherwise it would only be replaced when an instance is saved so a user could think everything\n-     * is ok if they only try launching the form once.\n-     *\n-     * This is an unfortunate side effect of using the form media folder to store the contents that\n-     * jr://instance/last-saved resolves to.\n-     *\n-     * Additionally, immediately replacing a secondary instance with name last-saved.xml avoid users\n-     * exploiting this current implementation quirk as a feature to preload defaults for the first\n-     * instance.\n-     * */\n-    @Test\n-    public void downloadingFormWithExternalSecondaryInstanceNamedLastSavedXml_Succeeds() throws Exception {", "originalCommit": "f20268809fac008e2cd3eb08dded83242fd1cefc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4NDI0MA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r500984240", "bodyText": "Same as the media file progress test I think. Didn't need it but I think you're right we should add it in any way.", "author": "seadowg", "createdAt": "2020-10-07T12:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEwMDM5Nw==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r501100397", "bodyText": "The comment is the most important part, I think. But I think it's also important to have a test around which last-saved external secondary instance gets used in that specific case.", "author": "lognaturel", "createdAt": "2020-10-07T15:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDczNDk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4Njk4NA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r502586984", "bodyText": "YES. Hadn't thought of this one. Great case to have.", "author": "lognaturel", "createdAt": "2020-10-09T17:53:13Z", "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/FormMetadataParserTest.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package org.odk.collect.android.formmanagement;\n+\n+import com.google.common.io.Files;\n+\n+import org.javarosa.core.reference.InvalidReferenceException;\n+import org.javarosa.core.reference.ReferenceManager;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.odk.collect.android.utilities.FileUtils;\n+\n+import java.io.File;\n+import java.util.Map;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.fail;\n+\n+public class FormMetadataParserTest {\n+\n+    private File mediaDir;\n+    private ReferenceManager referenceManager;\n+\n+    @Before\n+    public void setup() {\n+        referenceManager = ReferenceManager.instance();\n+        referenceManager.reset();\n+\n+        mediaDir = Files.createTempDir();\n+    }\n+\n+    @Test\n+    public void canParseFormWithExternalSecondaryInstance() throws Exception {\n+        File formXml = File.createTempFile(\"form\", \".xml\");\n+        FileUtils.write(formXml, EXTERNAL_SECONDARY_INSTANCE.getBytes());\n+\n+        File externalInstance = new File(mediaDir, \"external-data.xml\");\n+        FileUtils.write(externalInstance, EXTERNAL_INSTANCE.getBytes());\n+\n+        FormMetadataParser formMetadataParser = new FormMetadataParser(referenceManager);\n+        Map<String, String> metaData = formMetadataParser.parse(formXml, mediaDir);\n+        assertThat(metaData.get(FileUtils.FORMID), is(\"basic-external-xml-instance\"));\n+    }\n+\n+    @Test\n+    public void canParseFormWithCSVExternalSecondaryInstance() throws Exception {\n+        File formXml = File.createTempFile(\"form\", \".xml\");\n+        FileUtils.write(formXml, CSV_EXTERNAL_SECONDARY_INSTANCE.getBytes());\n+\n+        File externalInstance = new File(mediaDir, \"external-data.csv\");\n+        FileUtils.write(externalInstance, CSV_EXTERNAL_INSTANCE.getBytes());\n+\n+        FormMetadataParser formMetadataParser = new FormMetadataParser(referenceManager);\n+        Map<String, String> metaData = formMetadataParser.parse(formXml, mediaDir);\n+        assertThat(metaData.get(FileUtils.FORMID), is(\"basic-external-csv-instance\"));\n+    }\n+\n+    @Test\n+    public void canParseFormWithLastSaved() throws Exception {\n+        File formXml = File.createTempFile(\"form\", \".xml\");\n+        FileUtils.write(formXml, LAST_SAVED.getBytes());\n+\n+        FormMetadataParser formMetadataParser = new FormMetadataParser(referenceManager);\n+        Map<String, String> metaData = formMetadataParser.parse(formXml, mediaDir);\n+        assertThat(metaData.get(FileUtils.FORMID), is(\"basic-last-saved\"));\n+    }\n+\n+    @Test\n+    public void doesNotLeaveFilesInMediaDir() throws Exception {\n+        File formXml = File.createTempFile(\"form\", \".xml\");\n+        FileUtils.write(formXml, LAST_SAVED.getBytes());\n+\n+        FormMetadataParser formMetadataParser = new FormMetadataParser(referenceManager);\n+        formMetadataParser.parse(formXml, mediaDir);\n+\n+        assertThat(mediaDir.listFiles().length, is(0));\n+    }\n+\n+    @Test\n+    @SuppressWarnings(\"PMD.JUnitUseExpected\")\n+    public void cleansUpReferenceManager() throws Exception {", "originalCommit": "85d83e14805f55c5917b38ccda54620c338f4475", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTEyOQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r502589129", "bodyText": "That's not the behavior I'd expect! The media file should be ignored and the last-saved instance should be used.", "author": "lognaturel", "createdAt": "2020-10-09T17:57:32Z", "path": "collect_app/src/test/java/org/odk/collect/android/formmanagement/FormMetadataParserTest.java", "diffHunk": "@@ -64,6 +65,32 @@ public void canParseFormWithLastSaved() throws Exception {\n         assertThat(metaData.get(FileUtils.FORMID), is(\"basic-last-saved\"));\n     }\n \n+    /**\n+     * Edge case: a form could have an attachment with filename last-saved.xml. This will get\n+     * replaced immediately on download and this test documents that behavior. We could let it go\n+     * through but let's replace it immediately to help a user who tries this troubleshoot.\n+     * Otherwise it would only be replaced when an instance is saved so a user could think everything\n+     * is ok if they only try launching the form once.\n+     *\n+     * This is an unfortunate side effect of using the form media folder to store the contents that\n+     * jr://instance/last-saved resolves to.\n+     *\n+     * Additionally, immediately replacing a secondary instance with name last-saved.xml avoid users\n+     * exploiting this current implementation quirk as a feature to preload defaults for the first\n+     * instance.\n+     * */\n+    @Test(expected = XFormParseException.class)", "originalCommit": "95d46d8a23b7e2253acd86064dfd8dd6181e8b79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE1MTgxNw==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r503151817", "bodyText": "If you look at the previous test does this not match that behaviour? The test name agrees with you but the test itself doesn't as far as I can see (it ends with assertThat(messages.get(serverFormDetails), containsString(\"Failure\")))", "author": "seadowg", "createdAt": "2020-10-12T09:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ1ODUzMg==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r503458532", "bodyText": "Oh, that's confusing, I'm sorry! Because the external file named last-saved.xml and the primary instance have different shapes AND because the references for a dynamic select get validated at parse time, the parse crashes. So if the form definition had a different kind of query on the instance, there might not be a crash. Phew, that's clever/diabolical. You could add another comment above the parse call about how it's going to crash because the last-saved virtual instance doesn't have /root/item/name and /root/item/label paths to avoid going through this again. But maybe it's just confusing no matter what.", "author": "lognaturel", "createdAt": "2020-10-12T18:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MTI0OQ==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r503461249", "bodyText": "Looks like your IntelliJ settings aren't set to alphabetize imports. Would be great to revert changes to files where this is the only change so they don't get touched by this PR.", "author": "lognaturel", "createdAt": "2020-10-12T18:18:35Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/FormEntryActivity.java", "diffHunk": "@@ -101,7 +101,6 @@\n import org.odk.collect.android.formentry.repeats.DeleteRepeatDialogFragment;\n import org.odk.collect.android.formentry.saving.FormSaveViewModel;\n import org.odk.collect.android.formentry.saving.SaveFormProgressDialogFragment;\n-import org.odk.collect.android.forms.FormsRepository;", "originalCommit": "1c033294d0d873c648ce8c533cab937912adb349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1NTc3MA==", "url": "https://github.com/getodk/collect/pull/4040#discussion_r503755770", "bodyText": "Looks like that's default it's just that Studio doesn't do that when you move code between packages. Optimizing imports fixes it. Annoying!", "author": "seadowg", "createdAt": "2020-10-13T08:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MTI0OQ=="}], "type": "inlineReview"}, {"oid": "2c6d8d0be0a67ed7de3b0b354665e78319bda5f4", "url": "https://github.com/getodk/collect/commit/2c6d8d0be0a67ed7de3b0b354665e78319bda5f4", "message": "Use unit test to drive out restoring deleted form on download", "committedDate": "2020-10-13T17:28:41Z", "type": "commit"}, {"oid": "6be79f67c65f5727ef0a75922fa395d92e5a4662", "url": "https://github.com/getodk/collect/commit/6be79f67c65f5727ef0a75922fa395d92e5a4662", "message": "Remove download manifest progress call", "committedDate": "2020-10-13T17:28:41Z", "type": "commit"}, {"oid": "71345649e9921a3c3e11258c812f097ef2050cbb", "url": "https://github.com/getodk/collect/commit/71345649e9921a3c3e11258c812f097ef2050cbb", "message": "Include media files in ServerFormDetails", "committedDate": "2020-10-13T17:28:41Z", "type": "commit"}, {"oid": "a17655f1ad65a336a1099bdb2f2f72b630b21607", "url": "https://github.com/getodk/collect/commit/a17655f1ad65a336a1099bdb2f2f72b630b21607", "message": "Appease PMD", "committedDate": "2020-10-13T17:28:41Z", "type": "commit"}, {"oid": "fab2ebcdd2079b00283af6c3c5299cf2dc6204ec", "url": "https://github.com/getodk/collect/commit/fab2ebcdd2079b00283af6c3c5299cf2dc6204ec", "message": "Report media file progress from form downloader", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "078ab0f28b6ce0bcd0cc1cb7ce9ede0a70a2b27c", "url": "https://github.com/getodk/collect/commit/078ab0f28b6ce0bcd0cc1cb7ce9ede0a70a2b27c", "message": "Remove MultiFormDownloader from Dagger", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "971431648978678db8bffce361e41ff167db93d0", "url": "https://github.com/getodk/collect/commit/971431648978678db8bffce361e41ff167db93d0", "message": "Make sure form download can be cancelled between file downloads", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "4ba8d34bcfd47202432343afa0f1698b8ee9df89", "url": "https://github.com/getodk/collect/commit/4ba8d34bcfd47202432343afa0f1698b8ee9df89", "message": "Display progress when downloading forms", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "c4458fb8a100c0fd25a0ac78c6338214bccec0c2", "url": "https://github.com/getodk/collect/commit/c4458fb8a100c0fd25a0ac78c6338214bccec0c2", "message": "Add basic case tests for ServerFormDownloader", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "8c649b2c9e54343c8d52885680753fcc11e4c69d", "url": "https://github.com/getodk/collect/commit/8c649b2c9e54343c8d52885680753fcc11e4c69d", "message": "Remoge ignores", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "99abb506865c79514dafaa52491619050b29f087", "url": "https://github.com/getodk/collect/commit/99abb506865c79514dafaa52491619050b29f087", "message": "Move MultiFormDownloader into ServerFormDownloader", "committedDate": "2020-10-13T17:28:42Z", "type": "commit"}, {"oid": "49782591f402ead41bd46f201528ea72e333e0a1", "url": "https://github.com/getodk/collect/commit/49782591f402ead41bd46f201528ea72e333e0a1", "message": "Move FormUpdateMode", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "4e4a70d4b5b0b8ef45c89aa30ab3a0b9829d9ea1", "url": "https://github.com/getodk/collect/commit/4e4a70d4b5b0b8ef45c89aa30ab3a0b9829d9ea1", "message": "Add style checks to submodules", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "a967fcdcc79af53d2d14537456a710e45f3d8e84", "url": "https://github.com/getodk/collect/commit/a967fcdcc79af53d2d14537456a710e45f3d8e84", "message": "Remove StoragePathProvider from Form", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "01082219362e69f01265be7a72ced680391116fa", "url": "https://github.com/getodk/collect/commit/01082219362e69f01265be7a72ced680391116fa", "message": "Move non android code out of android package", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "93ca4e5e28fc7940854068c2e44383916065835a", "url": "https://github.com/getodk/collect/commit/93ca4e5e28fc7940854068c2e44383916065835a", "message": "Remove unused variables", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "de477443650e3d624ec06f294dc71b94231402d3", "url": "https://github.com/getodk/collect/commit/de477443650e3d624ec06f294dc71b94231402d3", "message": "(Hopefully) make update calculation clearer", "committedDate": "2020-10-13T17:28:43Z", "type": "commit"}, {"oid": "679e89ced142271c743884935e72610cf71030de", "url": "https://github.com/getodk/collect/commit/679e89ced142271c743884935e72610cf71030de", "message": "Fix null manifest case", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "2c5557a42ba357886f9bcaa8f2696d6b63b2b96a", "url": "https://github.com/getodk/collect/commit/2c5557a42ba357886f9bcaa8f2696d6b63b2b96a", "message": "Extract open rosa code from android package", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "61ab720f7455ff3b03d15f97e172a9b28de7d211", "url": "https://github.com/getodk/collect/commit/61ab720f7455ff3b03d15f97e172a9b28de7d211", "message": "Add StoragePathProvider as dependency for ServerFormDownloader", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "27b7861249cbe3a924815c567b4cdf6533d4e0ad", "url": "https://github.com/getodk/collect/commit/27b7861249cbe3a924815c567b4cdf6533d4e0ad", "message": "Only throw explicit exceptions from methods", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "0b5fa3c28490abf6f074ea33d2ac59ae86d719bf", "url": "https://github.com/getodk/collect/commit/0b5fa3c28490abf6f074ea33d2ac59ae86d719bf", "message": "Use InterruptedException rather than RuntimeException", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "1a41789ebf02557e10c12dd59d66113b8a22a203", "url": "https://github.com/getodk/collect/commit/1a41789ebf02557e10c12dd59d66113b8a22a203", "message": "Remove TaskCancellationException", "committedDate": "2020-10-13T17:28:44Z", "type": "commit"}, {"oid": "f231363e56cd65fc6e0e550d34e6d9358861f218", "url": "https://github.com/getodk/collect/commit/f231363e56cd65fc6e0e550d34e6d9358861f218", "message": "Extract form metadata parsing logic", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "89c63ec46e32554c9bd763f28f4f60cd4108f9c9", "url": "https://github.com/getodk/collect/commit/89c63ec46e32554c9bd763f28f4f60cd4108f9c9", "message": "Separate module and app tests", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "17d9592d4e04e86861fc691bb66a78033c7e9453", "url": "https://github.com/getodk/collect/commit/17d9592d4e04e86861fc691bb66a78033c7e9453", "message": "Remove usage of cache dir from ServerFormDownloader", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "3f8cd5cbe10683163dd11491bdcd9e95058f8b77", "url": "https://github.com/getodk/collect/commit/3f8cd5cbe10683163dd11491bdcd9e95058f8b77", "message": "Pull stateless helpers out of StoragePathProvider to reduce dependencies on it", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "7528ad464da13df688f993a98b4f60b010746689", "url": "https://github.com/getodk/collect/commit/7528ad464da13df688f993a98b4f60b010746689", "message": "Remove StoragePathProvider from ServerFormDownloader", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "9c79a8e09c35d529b148f2430af25bd1788e8ad1", "url": "https://github.com/getodk/collect/commit/9c79a8e09c35d529b148f2430af25bd1788e8ad1", "message": "Remove Robolectric from ServerFormDownloaderTest", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "903fa9aaa187800a53cd8dcd1b068880a857c4ed", "url": "https://github.com/getodk/collect/commit/903fa9aaa187800a53cd8dcd1b068880a857c4ed", "message": "Optimize imports", "committedDate": "2020-10-13T17:28:45Z", "type": "commit"}, {"oid": "26d649495d084b24b11d23c3c41979b0b00c6218", "url": "https://github.com/getodk/collect/commit/26d649495d084b24b11d23c3c41979b0b00c6218", "message": "Remove unused constructor", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "4d8600059e66a04ea89a4c67616a236d3786bcf2", "url": "https://github.com/getodk/collect/commit/4d8600059e66a04ea89a4c67616a236d3786bcf2", "message": "Remove references to ReferenceManager singleton in parser", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "980edf9d4822074d07e6f3969669cd571d3e4ab4", "url": "https://github.com/getodk/collect/commit/980edf9d4822074d07e6f3969669cd571d3e4ab4", "message": "Remove out of date comment", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "980fc632e9d1e63bcb27b571e7b44784ae4123bb", "url": "https://github.com/getodk/collect/commit/980fc632e9d1e63bcb27b571e7b44784ae4123bb", "message": "Remove complexity around booting an HTTPS MockWebServer\n\nThe structure of the code at this point means that we don't need to\nactually execute HTTPS requests in tests. The core logic we're testing\nis that the behaviour is different for different schemes and we can set\nthat up in the test by simply passing http or https in", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "372b4f6a02b289344ff61aeacccf2343c1b93684", "url": "https://github.com/getodk/collect/commit/372b4f6a02b289344ff61aeacccf2343c1b93684", "message": "Account for case where form is updated but media files haven't changed", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "8bcd717c929e42b6a24ac49038249f90d5efbe32", "url": "https://github.com/getodk/collect/commit/8bcd717c929e42b6a24ac49038249f90d5efbe32", "message": "Fix typos", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "6a2fa6cbe565d40751fe20c64e7bf3d7799db204", "url": "https://github.com/getodk/collect/commit/6a2fa6cbe565d40751fe20c64e7bf3d7799db204", "message": "Still show status of downloaded forms if cancelled in background", "committedDate": "2020-10-13T17:28:46Z", "type": "commit"}, {"oid": "fc29ec3c0e3cb99e4ad1b593575f855533059eed", "url": "https://github.com/getodk/collect/commit/fc29ec3c0e3cb99e4ad1b593575f855533059eed", "message": "Rename test to make intent clearer", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "4afab3a7320856ddef1df250f2948ea3f7f0ca30", "url": "https://github.com/getodk/collect/commit/4afab3a7320856ddef1df250f2948ea3f7f0ca30", "message": "Add tests to ensure last-saved and external secondary instances can be parsed", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "c9655042d91efdf25540e5115d6c934122fc6ab8", "url": "https://github.com/getodk/collect/commit/c9655042d91efdf25540e5115d6c934122fc6ab8", "message": "Add test to check media files are downloaded before parsing form", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "f9d68a22a5a7c58e895e37fe2574cbfda646f902", "url": "https://github.com/getodk/collect/commit/f9d68a22a5a7c58e895e37fe2574cbfda646f902", "message": "Use cleaner failure message for auto update", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "51ecdb3806a118a6533d7e1fe2c0d362db1854e6", "url": "https://github.com/getodk/collect/commit/51ecdb3806a118a6533d7e1fe2c0d362db1854e6", "message": "Add test to check parsing form with last-saved.xml external secondary instance fails", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "50bb1a2b407c12e9a7a1ac2650c468b664d099aa", "url": "https://github.com/getodk/collect/commit/50bb1a2b407c12e9a7a1ac2650c468b664d099aa", "message": "Move openrosa back to android", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "1d159ec40bb6c0ef8e4d5071d7fd6b1cf819ad20", "url": "https://github.com/getodk/collect/commit/1d159ec40bb6c0ef8e4d5071d7fd6b1cf819ad20", "message": "Renamed FormListApi to FormSource", "committedDate": "2020-10-13T17:28:47Z", "type": "commit"}, {"oid": "d49d311a5eb558b28c49e2696c4cb67899a69b51", "url": "https://github.com/getodk/collect/commit/d49d311a5eb558b28c49e2696c4cb67899a69b51", "message": "Move other packages back to android", "committedDate": "2020-10-13T17:28:48Z", "type": "commit"}, {"oid": "1255299afd7a489f8ea24a16aaf9d3728d89e044", "url": "https://github.com/getodk/collect/commit/1255299afd7a489f8ea24a16aaf9d3728d89e044", "message": "FormSource code into forms package", "committedDate": "2020-10-13T17:28:48Z", "type": "commit"}, {"oid": "4d84aa3bbfd5063f4a6f6319c88be6c8638932b1", "url": "https://github.com/getodk/collect/commit/4d84aa3bbfd5063f4a6f6319c88be6c8638932b1", "message": "Add some JavaDoc to FormSource", "committedDate": "2020-10-13T17:28:48Z", "type": "commit"}, {"oid": "0fdc0d3c4b5e01eae24a658fb067549d08faaeac", "url": "https://github.com/getodk/collect/commit/0fdc0d3c4b5e01eae24a658fb067549d08faaeac", "message": "Optimize imports", "committedDate": "2020-10-13T17:28:48Z", "type": "commit"}, {"oid": "1b5d1a6155b43a124085b59f0eaf7b61a6ce899f", "url": "https://github.com/getodk/collect/commit/1b5d1a6155b43a124085b59f0eaf7b61a6ce899f", "message": "Fix crash on downloading forms in Android 7", "committedDate": "2020-10-13T17:31:43Z", "type": "commit"}, {"oid": "7f07fbc8be102923f661bd82f266080d97c24ffb", "url": "https://github.com/getodk/collect/commit/7f07fbc8be102923f661bd82f266080d97c24ffb", "message": "Fix strict mode warning", "committedDate": "2020-10-13T17:31:44Z", "type": "commit"}, {"oid": "c8257dc8ac9c3b13186888259bb3a1b5eff57f80", "url": "https://github.com/getodk/collect/commit/c8257dc8ac9c3b13186888259bb3a1b5eff57f80", "message": "Format code", "committedDate": "2020-10-13T17:31:44Z", "type": "commit"}, {"oid": "c8257dc8ac9c3b13186888259bb3a1b5eff57f80", "url": "https://github.com/getodk/collect/commit/c8257dc8ac9c3b13186888259bb3a1b5eff57f80", "message": "Format code", "committedDate": "2020-10-13T17:31:44Z", "type": "forcePushed"}]}