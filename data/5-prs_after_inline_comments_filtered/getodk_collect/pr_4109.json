{"pr_number": 4109, "pr_title": "Restore soft deleted forms that have been re added to the forms folder", "pr_createdAt": "2020-09-22T13:16:55Z", "pr_url": "https://github.com/getodk/collect/pull/4109", "timeline": [{"oid": "35f6e33cdbe0dc7067969db44811046d3796dda0", "url": "https://github.com/getodk/collect/commit/35f6e33cdbe0dc7067969db44811046d3796dda0", "message": "Move test to correct package", "committedDate": "2020-09-22T08:48:25Z", "type": "commit"}, {"oid": "4c75abc8f07505baffc1a412f428035b410c8b23", "url": "https://github.com/getodk/collect/commit/4c75abc8f07505baffc1a412f428035b410c8b23", "message": "Add test that fails when trying to copy deleted form manually", "committedDate": "2020-09-22T09:40:04Z", "type": "commit"}, {"oid": "b809a235a5987b8f3684d87cafa29bb11b8706a0", "url": "https://github.com/getodk/collect/commit/b809a235a5987b8f3684d87cafa29bb11b8706a0", "message": "Use date to track soft deleted forms\n\nThis will \"undelete\" soft deleted forms on devices with the current beta\ninstalled", "committedDate": "2020-09-22T12:19:25Z", "type": "commit"}, {"oid": "d31baab75aaad64a526347e5eb01e079911ea153", "url": "https://github.com/getodk/collect/commit/d31baab75aaad64a526347e5eb01e079911ea153", "message": "Restore forms when added via adb after being soft deleted", "committedDate": "2020-09-22T12:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMjM0MQ==", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492732341", "bodyText": "It would be nice to have this tested at a lower level but the disk sync code is definitely not ready for that. For another day.\nHonestly it feels like getting a disk (and Google Drive) based  implementation of FormApi together would solve a lot of problems. Then code to add and sync forms could be shared between all these sources. I've added a note to STATE.md about this.", "author": "seadowg", "createdAt": "2020-09-22T13:27:27Z", "path": "collect_app/src/androidTest/java/org/odk/collect/android/feature/formmanagement/DeleteBlankFormTest.java", "diffHunk": "@@ -89,4 +92,25 @@ public void afterFillingAForm_andDeletingIt_allowsFormToBeReDownloaded() {\n                 .clickOK(new MainMenuPage(rule))\n                 .startBlankForm(\"One Question\");\n     }\n+\n+    @Test\n+    public void afterFillingAForm_andDeletingIt_allowsFormToBeReloadedDirectly() {", "originalCommit": "d31baab75aaad64a526347e5eb01e079911ea153", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNTgyNg==", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492735826", "bodyText": "My thinking is we need a migration here as we already have version 9 of the database out in the wild.", "author": "seadowg", "createdAt": "2020-09-22T13:32:13Z", "path": "collect_app/src/main/java/org/odk/collect/android/database/DatabaseConstants.java", "diffHunk": "@@ -3,7 +3,7 @@\n public class DatabaseConstants {\n \n     public static final String FORMS_TABLE_NAME = \"forms\";\n-    public static final int FORMS_DATABASE_VERSION = 9;\n+    public static final int FORMS_DATABASE_VERSION = 10;", "originalCommit": "d31baab75aaad64a526347e5eb01e079911ea153", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NDUyMw==", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492794523", "bodyText": "Yes, absolutely.", "author": "lognaturel", "createdAt": "2020-09-22T14:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNTgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNjYwMQ==", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492736601", "bodyText": "This migration won't actually carry over the state from the old deleted column. My assumption is that it's ok for beta users to have their form \"restored\" if they'd already soft deleted it when they install the update.", "author": "seadowg", "createdAt": "2020-09-22T13:33:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/database/FormDatabaseMigrator.java", "diffHunk": "@@ -223,6 +225,17 @@ private void upgradeToVersion9(SQLiteDatabase db) {\n         SQLiteUtils.dropTable(db, temporaryTable);\n     }\n \n+    private void upgradeToVersion10(SQLiteDatabase db) {\n+        String temporaryTable = FORMS_TABLE_NAME + \"_tmp\";", "originalCommit": "d31baab75aaad64a526347e5eb01e079911ea153", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NTg1MA==", "url": "https://github.com/getodk/collect/pull/4109#discussion_r492795850", "bodyText": "Yes, fine by me. @opendatakit/testers note that this is expected.", "author": "lognaturel", "createdAt": "2020-09-22T14:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczNjYwMQ=="}], "type": "inlineReview"}, {"oid": "9f017f5dcca6b30a58bd65a40dae392967371c5c", "url": "https://github.com/getodk/collect/commit/9f017f5dcca6b30a58bd65a40dae392967371c5c", "message": "Update STATE.md", "committedDate": "2020-09-22T13:37:49Z", "type": "commit"}]}