{"pr_number": 3813, "pr_title": "Remove KEYS_WE_SHOULD_NOT_RESET", "pr_createdAt": "2020-05-06T10:21:49Z", "pr_url": "https://github.com/getodk/collect/pull/3813", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMwOTMyMw==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r421309323", "bodyText": "It's unused so we can remove it.", "author": "grzesiek2010", "createdAt": "2020-05-07T07:54:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/SplashScreenActivity.java", "diffHunk": "@@ -63,14 +61,23 @@\n     @Inject\n     Analytics analytics;\n \n+    @Inject\n+    ApplicationInitializer applicationInitializer;", "originalCommit": "e246f6bc0767f3ae609fcb3d7f78390692d3461f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxMzkwNw==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r421313907", "bodyText": "Why this or registering receivers or setupOSMDroid() is not a part of applicationInitializer?", "author": "grzesiek2010", "createdAt": "2020-05-07T08:01:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/application/Collect.java", "diffHunk": "@@ -148,41 +131,14 @@ public void onCreate() {\n         singleton = this;\n \n         setupDagger();\n-\n-        NotificationUtils.createNotificationChannel(singleton);\n+        applicationInitializer.initializePreferences();\n+        applicationInitializer.initializeFrameworks();\n+        applicationInitializer.initializeLocale();\n \n         registerReceiver(new SmsSentBroadcastReceiver(), new IntentFilter(SMS_SEND_ACTION));\n         registerReceiver(new SmsNotificationReceiver(), new IntentFilter(SMS_NOTIFICATION_ACTION));\n \n-        try {\n-            JobManager\n-                    .create(this)\n-                    .addJobCreator(collectJobCreator);\n-        } catch (JobManagerCreateException e) {\n-            Timber.e(e);\n-        }\n-\n-        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);\n-        FormMetadataMigrator.migrate(prefs);\n-        PrefMigrator.migrateSharedPrefs();\n-        AutoSendPreferenceMigrator.migrate();\n-\n-        reloadSharedPreferences();\n-\n-        AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);\n-        JodaTimeAndroid.init(this);\n-\n-        defaultSysLanguage = Locale.getDefault().getLanguage();\n-        new LocaleHelper().updateLocale(this);\n-\n         initializeJavaRosa();", "originalCommit": "e246f6bc0767f3ae609fcb3d7f78390692d3461f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2Nzc0MQ==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r421667741", "bodyText": "Oh I'd meant to come back to these! JavaRosa is a little complex as initializeJavaRosa is called in lots of places but I think we should be able to include OSMDroid at least. I'll look at this again.", "author": "seadowg", "createdAt": "2020-05-07T17:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxMzkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA0ODY2OQ==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r423048669", "bodyText": "OK moved the map stuff in (the OSM problem we were seeing in Robolectric before has apparently gone now which is nice). I decided to keep the receivers and the JavaRosa in onCreate. For the former it's because they are directly linked to the application object itself. For the latter it's because that method is called in many places and I think that's a rework for another time \ud83d\ude01", "author": "seadowg", "createdAt": "2020-05-11T13:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxMzkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM1MDQzMA==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r421350430", "bodyText": "I think it would be good to factor out more methods here like initializeTimber/initializeJobManager etc. It might be strange to create separate methods for those one line initializations so it's ok to keep them in one method.", "author": "grzesiek2010", "createdAt": "2020-05-07T09:01:01Z", "path": "collect_app/src/main/java/org/odk/collect/android/application/initialization/ApplicationInitializer.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.odk.collect.android.application.initialization;\n+\n+import android.app.Application;\n+import android.content.SharedPreferences;\n+import android.util.Log;\n+\n+import androidx.appcompat.app.AppCompatDelegate;\n+\n+import com.crashlytics.android.Crashlytics;\n+import com.evernote.android.job.JobManager;\n+import com.evernote.android.job.JobManagerCreateException;\n+\n+import net.danlew.android.joda.JodaTimeAndroid;\n+\n+import org.odk.collect.android.BuildConfig;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.jobs.CollectJobCreator;\n+import org.odk.collect.android.preferences.AdminSharedPreferences;\n+import org.odk.collect.android.preferences.AutoSendPreferenceMigrator;\n+import org.odk.collect.android.preferences.GeneralSharedPreferences;\n+import org.odk.collect.android.utilities.LocaleHelper;\n+import org.odk.collect.android.utilities.NotificationUtils;\n+\n+import java.util.Locale;\n+\n+import timber.log.Timber;\n+\n+public class ApplicationInitializer {\n+\n+    private final Application context;\n+    private final CollectJobCreator collectJobCreator;\n+    private final SharedPreferences metaSharedPreferences;\n+    private final GeneralSharedPreferences generalSharedPreferences;\n+    private final AdminSharedPreferences adminSharedPreferences;\n+\n+    public ApplicationInitializer(Application context, CollectJobCreator collectJobCreator, SharedPreferences metaSharedPreferences) {\n+        this.context = context;\n+        this.collectJobCreator = collectJobCreator;\n+        this.metaSharedPreferences = metaSharedPreferences;\n+\n+        generalSharedPreferences = GeneralSharedPreferences.getInstance();\n+        adminSharedPreferences = AdminSharedPreferences.getInstance();\n+    }\n+\n+    public void initializePreferences() {\n+        performMigrations();\n+        reloadSharedPreferences();\n+    }\n+\n+    public void initializeFrameworks() {", "originalCommit": "e246f6bc0767f3ae609fcb3d7f78390692d3461f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY3MTgzNA==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r421671834", "bodyText": "I think you're right it's pretty hard to read that method!", "author": "seadowg", "createdAt": "2020-05-07T17:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM1MDQzMA=="}], "type": "inlineReview"}, {"oid": "8b760c76b06f2db7940759ba79a483445d1146ac", "url": "https://github.com/getodk/collect/commit/8b760c76b06f2db7940759ba79a483445d1146ac", "message": "Move map inits to ApplicationInitializer", "committedDate": "2020-05-11T13:38:03Z", "type": "forcePushed"}, {"oid": "5f5553ee14d84dca7d34fc8d19d4cac0cfdfb558", "url": "https://github.com/getodk/collect/commit/5f5553ee14d84dca7d34fc8d19d4cac0cfdfb558", "message": "Move map inits to ApplicationInitializer", "committedDate": "2020-05-12T14:10:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5ODI4MA==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r424998280", "bodyText": "It is unused now.", "author": "grzesiek2010", "createdAt": "2020-05-14T09:28:15Z", "path": "collect_app/src/main/java/org/odk/collect/android/application/Collect.java", "diffHunk": "@@ -88,7 +70,7 @@\n     UserAgentProvider userAgentProvider;", "originalCommit": "5f5553ee14d84dca7d34fc8d19d4cac0cfdfb558", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0NDQyNg==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r426544426", "bodyText": "Ah nice catch. I really dislike that Dagger's generated code sometimes fools Android Studio into thinking a field is used.", "author": "seadowg", "createdAt": "2020-05-18T11:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5ODI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5OTQ1NQ==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r424999455", "bodyText": "Is there any reason you unpacked this? I mean having it in a separate method like initializeMaps or initializeMapProviders seems more elegant.", "author": "grzesiek2010", "createdAt": "2020-05-14T09:30:08Z", "path": "collect_app/src/main/java/org/odk/collect/android/application/initialization/ApplicationInitializer.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package org.odk.collect.android.application.initialization;\n+\n+import android.app.Application;\n+import android.content.SharedPreferences;\n+import android.util.Log;\n+\n+import androidx.appcompat.app.AppCompatDelegate;\n+\n+import com.crashlytics.android.Crashlytics;\n+import com.evernote.android.job.JobManager;\n+import com.evernote.android.job.JobManagerCreateException;\n+\n+import net.danlew.android.joda.JodaTimeAndroid;\n+\n+import org.odk.collect.android.BuildConfig;\n+import org.odk.collect.android.application.Collect;\n+import org.odk.collect.android.geo.MapboxUtils;\n+import org.odk.collect.android.jobs.CollectJobCreator;\n+import org.odk.collect.android.preferences.AdminSharedPreferences;\n+import org.odk.collect.android.preferences.AutoSendPreferenceMigrator;\n+import org.odk.collect.android.preferences.GeneralSharedPreferences;\n+import org.odk.collect.android.utilities.LocaleHelper;\n+import org.odk.collect.android.utilities.NotificationUtils;\n+import org.odk.collect.utilities.UserAgentProvider;\n+\n+import java.util.Locale;\n+\n+import timber.log.Timber;\n+\n+public class ApplicationInitializer {\n+\n+    private final Application context;\n+    private final CollectJobCreator collectJobCreator;\n+    private final SharedPreferences metaSharedPreferences;\n+    private final UserAgentProvider userAgentProvider;\n+    private final GeneralSharedPreferences generalSharedPreferences;\n+    private final AdminSharedPreferences adminSharedPreferences;\n+\n+    public ApplicationInitializer(Application context, CollectJobCreator collectJobCreator, SharedPreferences metaSharedPreferences, UserAgentProvider userAgentProvider) {\n+        this.context = context;\n+        this.collectJobCreator = collectJobCreator;\n+        this.metaSharedPreferences = metaSharedPreferences;\n+        this.userAgentProvider = userAgentProvider;\n+\n+        generalSharedPreferences = GeneralSharedPreferences.getInstance();\n+        adminSharedPreferences = AdminSharedPreferences.getInstance();\n+    }\n+\n+    public void initializePreferences() {\n+        performMigrations();\n+        reloadSharedPreferences();\n+    }\n+\n+    public void initializeFrameworks() {\n+        NotificationUtils.createNotificationChannel(context);\n+        initializeJobManager();\n+        JodaTimeAndroid.init(context);\n+        initializeLogging();\n+        AppCompatDelegate.setCompatVectorFromResourcesEnabled(true);\n+\n+        new com.google.android.gms.maps.MapView(context).onCreate(null);", "originalCommit": "5f5553ee14d84dca7d34fc8d19d4cac0cfdfb558", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU1MzI3Mg==", "url": "https://github.com/getodk/collect/pull/3813#discussion_r426553272", "bodyText": "It felt fine to have them in the initializeFrameworks to me but I don't have any strong feelings on it. I'll put the method back but call it from the same place.", "author": "seadowg", "createdAt": "2020-05-18T11:20:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5OTQ1NQ=="}], "type": "inlineReview"}, {"oid": "fcaf86fbb7186fc2a39b1d3a00d5ecf65b603309", "url": "https://github.com/getodk/collect/commit/fcaf86fbb7186fc2a39b1d3a00d5ecf65b603309", "message": "Extract map framework initialization", "committedDate": "2020-05-18T12:09:39Z", "type": "forcePushed"}, {"oid": "4b899b237443274b1ff81ed2abf4c5d6237946e6", "url": "https://github.com/getodk/collect/commit/4b899b237443274b1ff81ed2abf4c5d6237946e6", "message": "Migrate mapbox initialization key", "committedDate": "2020-05-25T10:54:23Z", "type": "forcePushed"}, {"oid": "87bdbe8e09c8ebe97dec8c3b20f6033c3c8cdd35", "url": "https://github.com/getodk/collect/commit/87bdbe8e09c8ebe97dec8c3b20f6033c3c8cdd35", "message": "Migrate mapbox initialization key", "committedDate": "2020-06-03T12:46:24Z", "type": "forcePushed"}, {"oid": "d1b66390ece27b4cb738c4d86cc81485f634a18e", "url": "https://github.com/getodk/collect/commit/d1b66390ece27b4cb738c4d86cc81485f634a18e", "message": "Rename ResetUtility", "committedDate": "2020-06-05T08:34:25Z", "type": "commit"}, {"oid": "3700477d47697dc0cb37c6a23c6cd54fb23a223d", "url": "https://github.com/getodk/collect/commit/3700477d47697dc0cb37c6a23c6cd54fb23a223d", "message": "Move application initialization to a dedicated use case object", "committedDate": "2020-06-05T08:34:25Z", "type": "commit"}, {"oid": "d02d55d336283ce1e3b332b5451e1c6312bc7656", "url": "https://github.com/getodk/collect/commit/d02d55d336283ce1e3b332b5451e1c6312bc7656", "message": "Use Meta shared preferences for last_version and first_run", "committedDate": "2020-06-05T08:34:26Z", "type": "commit"}, {"oid": "4ded5e9524360c1f3ccc7a11b1ad50a2f6110b19", "url": "https://github.com/getodk/collect/commit/4ded5e9524360c1f3ccc7a11b1ad50a2f6110b19", "message": "Pull migration code into its own package", "committedDate": "2020-06-05T09:02:46Z", "type": "commit"}, {"oid": "ffa0ad6605188e9d641bb00502710aae35f32bc0", "url": "https://github.com/getodk/collect/commit/ffa0ad6605188e9d641bb00502710aae35f32bc0", "message": "Pull migration tests out to their own classes\n\nSome notes on why there isn't as many tests:\n\n* Key \"splitting\" for translator is covered by `whenKeyHasUnknownValue_doesNotDoAnything` and `canTranslateMultipleValues`\n* Key \"merging\" for translator is also covered by the above", "committedDate": "2020-06-05T09:09:22Z", "type": "commit"}, {"oid": "95c5281916749aab7a2f027c74be6477add5ad64", "url": "https://github.com/getodk/collect/commit/95c5281916749aab7a2f027c74be6477add5ad64", "message": "Add KeyMover migration", "committedDate": "2020-06-05T09:09:24Z", "type": "commit"}, {"oid": "485685684a6c5f968455e524646d51becedc837c", "url": "https://github.com/getodk/collect/commit/485685684a6c5f968455e524646d51becedc837c", "message": "Migrate first run and last version pref keys", "committedDate": "2020-06-05T09:16:59Z", "type": "commit"}, {"oid": "d865493d9f56c9d39fbbbe04e2b0ca4dbaa0165f", "url": "https://github.com/getodk/collect/commit/d865493d9f56c9d39fbbbe04e2b0ca4dbaa0165f", "message": "Remove last version and first run general keys", "committedDate": "2020-06-05T09:17:01Z", "type": "commit"}, {"oid": "3100e66d3a81a07000c16f433c4af78a35a06ac4", "url": "https://github.com/getodk/collect/commit/3100e66d3a81a07000c16f433c4af78a35a06ac4", "message": "Replace SplashScreenActivity Espresso test with Robolectric", "committedDate": "2020-06-05T09:17:01Z", "type": "commit"}, {"oid": "2ba5f1e7197f6b1dda16b1757a1e7d708aa506d6", "url": "https://github.com/getodk/collect/commit/2ba5f1e7197f6b1dda16b1757a1e7d708aa506d6", "message": "Add tests for splash screen behaviour", "committedDate": "2020-06-05T09:17:02Z", "type": "commit"}, {"oid": "25f751d297a522b746d2aceb6f962db35ce35a3e", "url": "https://github.com/getodk/collect/commit/25f751d297a522b746d2aceb6f962db35ce35a3e", "message": "Replace custom threading with handler", "committedDate": "2020-06-05T09:17:02Z", "type": "commit"}, {"oid": "85ce4ac86dd616e350439259488976af84589031", "url": "https://github.com/getodk/collect/commit/85ce4ac86dd616e350439259488976af84589031", "message": "Stop showing splash screen on first run when not enabled", "committedDate": "2020-06-05T09:18:43Z", "type": "commit"}, {"oid": "42ec8f02e5d96932bcc0bf11ebdf00eedd422f98", "url": "https://github.com/getodk/collect/commit/42ec8f02e5d96932bcc0bf11ebdf00eedd422f98", "message": "Move install ID key to MetaKeys", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "ab735d5bca9f5ee181696e6c0d59f760143bc1ce", "url": "https://github.com/getodk/collect/commit/ab735d5bca9f5ee181696e6c0d59f760143bc1ce", "message": "Move storage migration key to meta shared preferences", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "5e288c7e0e9f182f9d58e039fd049b9c02376b6a", "url": "https://github.com/getodk/collect/commit/5e288c7e0e9f182f9d58e039fd049b9c02376b6a", "message": "Add migration for SCOPED_STORAGE_USED", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "0ad846d5f3ff0564218dd38797decb8d3a51bcec", "url": "https://github.com/getodk/collect/commit/0ad846d5f3ff0564218dd38797decb8d3a51bcec", "message": "Remove FormMetadataMigration\n\nThis copied values from server settings to the form metadata preferences\nback when that was needed. Was only really needed to be kept around for a\nshort while after but had managed to hide itself in the code!", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "c37cfa5f2ad8b629b8e6f8ea5f59fd9ed528cefa", "url": "https://github.com/getodk/collect/commit/c37cfa5f2ad8b629b8e6f8ea5f59fd9ed528cefa", "message": "Remove keys not to reset", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "15b531c0897fe581d9de5f1e7acc2720fcde5f88", "url": "https://github.com/getodk/collect/commit/15b531c0897fe581d9de5f1e7acc2720fcde5f88", "message": "Remove unused field", "committedDate": "2020-06-05T09:19:02Z", "type": "commit"}, {"oid": "b091adeb6cdfe5491cbb8763f29abf4fd7061ff9", "url": "https://github.com/getodk/collect/commit/b091adeb6cdfe5491cbb8763f29abf4fd7061ff9", "message": "Pull lengthy initialization into their own methods", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "bacc3fb52111de25d01896d25f222bd7e3ee5238", "url": "https://github.com/getodk/collect/commit/bacc3fb52111de25d01896d25f222bd7e3ee5238", "message": "Move map inits to ApplicationInitializer", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "decc3804bce913ef71ae7c829b7d3d041b8d2d2e", "url": "https://github.com/getodk/collect/commit/decc3804bce913ef71ae7c829b7d3d041b8d2d2e", "message": "Remove unused field", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "cde986d1d3f1411a4a2691a85ddeb3d86bd41612", "url": "https://github.com/getodk/collect/commit/cde986d1d3f1411a4a2691a85ddeb3d86bd41612", "message": "Extract map framework initialization", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "55bb2b5671cde299d9b3e63f70a4aae76c49096f", "url": "https://github.com/getodk/collect/commit/55bb2b5671cde299d9b3e63f70a4aae76c49096f", "message": "Use meta shared preferences for mapbox initialization", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "328841a3b83c70e113a48a8d2565899120bfaaa3", "url": "https://github.com/getodk/collect/commit/328841a3b83c70e113a48a8d2565899120bfaaa3", "message": "Migrate mapbox initialization key", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "ca441fb1d41f9bcbba1ffa949514e9d4ce90ef14", "url": "https://github.com/getodk/collect/commit/ca441fb1d41f9bcbba1ffa949514e9d4ce90ef14", "message": "Correct splash screen test", "committedDate": "2020-06-05T09:19:03Z", "type": "commit"}, {"oid": "ca441fb1d41f9bcbba1ffa949514e9d4ce90ef14", "url": "https://github.com/getodk/collect/commit/ca441fb1d41f9bcbba1ffa949514e9d4ce90ef14", "message": "Correct splash screen test", "committedDate": "2020-06-05T09:19:03Z", "type": "forcePushed"}]}