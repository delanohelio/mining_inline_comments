{"pr_number": 3922, "pr_title": "Reworking GeoShape and GeoTraceWidget", "pr_createdAt": "2020-06-12T14:27:59Z", "pr_url": "https://github.com/getodk/collect/pull/3922", "timeline": [{"oid": "2be76989c2c53a5603bb2f7360f16e8149bacf93", "url": "https://github.com/getodk/collect/commit/2be76989c2c53a5603bb2f7360f16e8149bacf93", "message": "code refactor", "committedDate": "2020-07-21T13:44:30Z", "type": "forcePushed"}, {"oid": "56bd15577b7c7c9bd1ece87acd6a30ad23db9b45", "url": "https://github.com/getodk/collect/commit/56bd15577b7c7c9bd1ece87acd6a30ad23db9b45", "message": "delete BaseGeoWidget and BaseGeoWidgetTest class", "committedDate": "2020-07-21T19:04:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQzNjkxMQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r459436911", "bodyText": "For all the four GeoWidgets, I call static method onButtonClick, when geoButton is clicked. In the corresponding test, I was thinking just verifying the method call, and checking different cases later on in unit tests for GeoWidgetUtils.", "author": "SaumiaSinghal", "createdAt": "2020-07-23T13:11:10Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/GeoPointWidget.java", "diffHunk": "@@ -17,153 +17,111 @@\n import android.annotation.SuppressLint;\n import android.app.Activity;\n import android.content.Context;\n-import android.content.Intent;\n+import android.os.Bundle;\n+import android.util.TypedValue;\n+import android.view.View;\n \n-import org.javarosa.core.model.data.GeoPointData;\n+import org.javarosa.core.model.QuestionDef;\n import org.javarosa.core.model.data.IAnswerData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n import org.odk.collect.android.activities.GeoPointActivity;\n-import org.odk.collect.android.activities.GeoPointMapActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.geo.MapProvider;\n+import org.odk.collect.android.widgets.interfaces.BinaryDataReceiver;\n import org.odk.collect.android.widgets.utilities.GeoWidgetUtils;\n+import org.odk.collect.android.widgets.utilities.WaitingForDataRegistry;\n \n-import static org.odk.collect.android.utilities.ApplicationConstants.RequestCodes;\n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.MAPS;\n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.PLACEMENT_MAP;\n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.hasAppearance;\n+import static org.odk.collect.android.utilities.ApplicationConstants.RequestCodes.LOCATION_CAPTURE;\n \n-/**\n- * GeoPointWidget is the widget that allows the user to get GPS readings.\n- *\n- * @author Carl Hartung (carlhartung@gmail.com)\n- * @author Yaw Anokwa (yanokwa@gmail.com)\n- * @author Jon Nordling (jonnordling@gmail.com)\n- */\n @SuppressLint(\"ViewConstructor\")\n-public class GeoPointWidget extends BaseGeoWidget {\n-    public static final String LOCATION = \"gp\";\n-    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n-    public static final String READ_ONLY = \"readOnly\";\n-    public static final String DRAGGABLE_ONLY = \"draggable\";\n-\n-    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n-    private boolean useMap;\n-    private double accuracyThreshold;\n-    private boolean draggable = true;\n+public class GeoPointWidget extends QuestionWidget implements BinaryDataReceiver {\n+    GeoWidgetAnswerBinding binding;\n+\n+    private final WaitingForDataRegistry waitingForDataRegistry;\n+    private final double accuracyThreshold;\n+\n+    private boolean readOnly;\n     private String stringAnswer;\n \n-    public GeoPointWidget(Context context, QuestionDetails questionDetails) {\n+    public GeoPointWidget(Context context, QuestionDetails questionDetails, QuestionDef questionDef, WaitingForDataRegistry waitingForDataRegistry) {\n         super(context, questionDetails);\n-        determineMapProperties();\n-    }\n+        this.waitingForDataRegistry = waitingForDataRegistry;\n+        accuracyThreshold = GeoWidgetUtils.getAccuracyThreshold(questionDef);\n \n-    private void determineMapProperties() {\n-        // Determine the accuracy threshold to use.\n-        String acc = getFormEntryPrompt().getQuestion().getAdditionalAttribute(null, ACCURACY_THRESHOLD);\n-        accuracyThreshold = acc != null && !acc.isEmpty() ? Double.parseDouble(acc) : DEFAULT_LOCATION_ACCURACY;\n-\n-        // Determine whether to use the map and whether the point should be draggable.\n-        if (MapProvider.getConfigurator().isAvailable(getContext())) {\n-            if (hasAppearance(getFormEntryPrompt(), PLACEMENT_MAP)) {\n-                draggable = true;\n-                useMap = true;\n-            } else if (hasAppearance(getFormEntryPrompt(), MAPS)) {\n-                draggable = false;\n-                useMap = true;\n-            }\n+        stringAnswer = getFormEntryPrompt().getAnswerText();\n+        boolean dataAvailable = false;\n+        if (stringAnswer != null && !stringAnswer.isEmpty()) {\n+            dataAvailable = true;\n+            setBinaryData(stringAnswer);\n         }\n+        updateButtonLabelsAndVisibility(dataAvailable);\n     }\n \n-    public void updateButtonLabelsAndVisibility(boolean dataAvailable) {\n-        if (useMap) {\n-            if (readOnly) {\n-                startGeoButton.setText(R.string.geopoint_view_read_only);\n-            } else {\n-                startGeoButton.setText(\n-                    dataAvailable ? R.string.view_change_location : R.string.get_point);\n-            }\n+    @Override\n+    protected View onCreateAnswerView(Context context, FormEntryPrompt prompt, int answerFontSize) {\n+        binding = GeoWidgetAnswerBinding.inflate(((Activity) context).getLayoutInflater());\n+        View answerView = binding.getRoot();\n+\n+        binding.geoAnswerText.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+        readOnly = prompt.isReadOnly();\n+        if (readOnly) {\n+            binding.simpleButton.setVisibility(GONE);\n         } else {\n-            if (!readOnly) {\n-                startGeoButton.setText(\n-                    dataAvailable ? R.string.change_location : R.string.get_point);\n-            }\n+            binding.simpleButton.setText(getDefaultButtonLabel());\n+            binding.simpleButton.setTextSize(TypedValue.COMPLEX_UNIT_DIP, answerFontSize);\n+\n+            binding.simpleButton.setOnClickListener(v -> {\n+                Bundle bundle = GeoWidgetUtils.getGeoPointBundle(stringAnswer, accuracyThreshold, null, null);\n+                GeoWidgetUtils.onButtonClick(context, prompt, getPermissionUtils(), null,", "originalCommit": "8fbd7696aa59382b1a465ae6cf9916c25fde734d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ0NTc3NQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r459445775", "bodyText": "I think given you want to test the shared behaviour it's good to try and think hard about what the responsibility of onButtonClick really is here. For me what it does is ask for geo data for the widget. It feels to me like there could be an interface called something like GeoDataRequester or GeoDataFetcher with methods like requestPoint, requestShape etc:\nbinding.simpleButton.setOnClickListener(v -> {\n    geoDataRequester.requestPoint(promp);\n});\n\nIn each of the different geo widgets you can have a test that the requestPoint or whatever is called and then those methods can be tested for some implementation of the interface (ActivityGeoDataRequester).\nJust to detail my questions here the though process I'm going through is:\n\nI have shared code used in multiple places does it make sense to just test the behaviour in each place?\nIf not, what is the shared code responsible for? Is there some kind of interface/object/entity that could be responsible for that?", "author": "seadowg", "createdAt": "2020-07-23T13:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQzNjkxMQ=="}], "type": "inlineReview"}, {"oid": "cfb940e669e086f5da8bceb036645b8aa13ad180", "url": "https://github.com/getodk/collect/commit/cfb940e669e086f5da8bceb036645b8aa13ad180", "message": "code improvements", "committedDate": "2020-07-23T20:14:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAzODQ2NQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470038465", "bodyText": "Won't this already be taken care of by the call on updateUi? I think you might be able to remove it.", "author": "lognaturel", "createdAt": "2020-08-13T15:29:30Z", "path": "collect_app/src/main/java/org/odk/collect/android/activities/GeoPolyActivity.java", "diffHunk": "@@ -230,10 +234,16 @@ public void initMap(MapFragment newMapFragment) {\n         }\n         featureId = map.addDraggablePoly(points, outputMode == OutputMode.GEOSHAPE);\n \n-        if (inputActive) {\n+        if (inputActive && !intentReadOnly) {\n             startInput();\n         }\n \n+        if (intentReadOnly) {", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0NTQyOA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470045428", "bodyText": "Why keep this static method? It's not called directly so can be removed (and the contents moved to onButtonClicked).", "author": "lognaturel", "createdAt": "2020-08-13T15:40:05Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoWidgetUtils.java", "diffHunk": "@@ -1,17 +1,127 @@\n package org.odk.collect.android.widgets.utilities;\n \n+import android.app.Activity;\n import android.content.Context;\n+import android.content.Intent;\n import android.location.Location;\n+import android.os.Bundle;\n \n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n+import org.odk.collect.android.geo.MapConfigurator;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoWidgetListener;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-public class GeoWidgetUtils {\n+import static android.view.View.GONE;\n \n-    private GeoWidgetUtils() {\n+public class GeoWidgetUtils implements GeoWidgetListener {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n+\n+    @Override\n+    public void onButtonClicked(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,\n+                                WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        onButtonClick(context, index, permissionUtils, mapConfigurator, waitingForDataRegistry, activityClass, bundle, requestCode);\n+    }\n+\n+    @Override\n+    public void setButtonLabelAndVisibility(GeoWidgetAnswerBinding binding, boolean readOnly, boolean dataAvailable,\n+                                            int buttonTextReadOnly, int buttonTextDataAvailable, int defaultButtonText) {\n+        updateButtonLabelAndVisibility(binding, readOnly, dataAvailable, buttonTextReadOnly, buttonTextDataAvailable, defaultButtonText);\n+    }\n+\n+    public static double getAccuracyThreshold(QuestionDef questionDef) {\n+        // Determine the accuracy threshold to use.\n+        String acc = questionDef.getAdditionalAttribute(null, ACCURACY_THRESHOLD);\n+        return acc != null && !acc.isEmpty() ? Double.parseDouble(acc) : DEFAULT_LOCATION_ACCURACY;\n+    }\n+\n+    public static String getAnswerToDisplay(Context context, String answer) {\n+        try {\n+            if (answer != null && !answer.isEmpty()) {\n+                String[] parts = answer.split(\" \");\n+                return context.getString(\n+                        R.string.gps_result,\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[0]), \"lat\"),\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[1]), \"lon\"),\n+                        GeoWidgetUtils.truncateDouble(parts[2]),\n+                        GeoWidgetUtils.truncateDouble(parts[3])\n+                );\n+            }\n+        } catch (NumberFormatException e) {\n+            return \"\";\n+        }\n+        return \"\";\n+    }\n+\n+    public static Bundle getGeoPointBundle(String stringAnswer, double accuracyThreshold, Boolean readOnly, Boolean draggable) {\n+        final Bundle bundle = new Bundle();\n+        if (stringAnswer != null && !stringAnswer.isEmpty()) {\n+            bundle.putDoubleArray(LOCATION, GeoWidgetUtils.getLocationParamsFromStringAnswer(stringAnswer));\n+        }\n+        bundle.putDouble(ACCURACY_THRESHOLD, accuracyThreshold);\n+        if (readOnly != null && draggable != null) {\n+            bundle.putBoolean(READ_ONLY, readOnly);\n+            bundle.putBoolean(DRAGGABLE_ONLY, draggable);\n+        }\n+        return bundle;\n+    }\n+\n+    public static Bundle getGeoPolyBundle(String stringAnswer, GeoPolyActivity.OutputMode outputMode, boolean readOnly) {\n+        final Bundle bundle = new Bundle();\n+        bundle.putString(GeoPolyActivity.ANSWER_KEY, stringAnswer);\n+        bundle.putSerializable(GeoPolyActivity.OUTPUT_MODE_KEY, outputMode);\n+        bundle.putBoolean(READ_ONLY, readOnly);\n+        return bundle;\n+    }\n+\n+    private static void onButtonClick(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0NjM1OA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470046358", "bodyText": "Move contents to caller.", "author": "lognaturel", "createdAt": "2020-08-13T15:41:27Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoWidgetUtils.java", "diffHunk": "@@ -1,17 +1,127 @@\n package org.odk.collect.android.widgets.utilities;\n \n+import android.app.Activity;\n import android.content.Context;\n+import android.content.Intent;\n import android.location.Location;\n+import android.os.Bundle;\n \n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n+import org.odk.collect.android.geo.MapConfigurator;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoWidgetListener;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-public class GeoWidgetUtils {\n+import static android.view.View.GONE;\n \n-    private GeoWidgetUtils() {\n+public class GeoWidgetUtils implements GeoWidgetListener {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n+\n+    @Override\n+    public void onButtonClicked(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,\n+                                WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        onButtonClick(context, index, permissionUtils, mapConfigurator, waitingForDataRegistry, activityClass, bundle, requestCode);\n+    }\n+\n+    @Override\n+    public void setButtonLabelAndVisibility(GeoWidgetAnswerBinding binding, boolean readOnly, boolean dataAvailable,\n+                                            int buttonTextReadOnly, int buttonTextDataAvailable, int defaultButtonText) {\n+        updateButtonLabelAndVisibility(binding, readOnly, dataAvailable, buttonTextReadOnly, buttonTextDataAvailable, defaultButtonText);\n+    }\n+\n+    public static double getAccuracyThreshold(QuestionDef questionDef) {\n+        // Determine the accuracy threshold to use.\n+        String acc = questionDef.getAdditionalAttribute(null, ACCURACY_THRESHOLD);\n+        return acc != null && !acc.isEmpty() ? Double.parseDouble(acc) : DEFAULT_LOCATION_ACCURACY;\n+    }\n+\n+    public static String getAnswerToDisplay(Context context, String answer) {\n+        try {\n+            if (answer != null && !answer.isEmpty()) {\n+                String[] parts = answer.split(\" \");\n+                return context.getString(\n+                        R.string.gps_result,\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[0]), \"lat\"),\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[1]), \"lon\"),\n+                        GeoWidgetUtils.truncateDouble(parts[2]),\n+                        GeoWidgetUtils.truncateDouble(parts[3])\n+                );\n+            }\n+        } catch (NumberFormatException e) {\n+            return \"\";\n+        }\n+        return \"\";\n+    }\n+\n+    public static Bundle getGeoPointBundle(String stringAnswer, double accuracyThreshold, Boolean readOnly, Boolean draggable) {\n+        final Bundle bundle = new Bundle();\n+        if (stringAnswer != null && !stringAnswer.isEmpty()) {\n+            bundle.putDoubleArray(LOCATION, GeoWidgetUtils.getLocationParamsFromStringAnswer(stringAnswer));\n+        }\n+        bundle.putDouble(ACCURACY_THRESHOLD, accuracyThreshold);\n+        if (readOnly != null && draggable != null) {\n+            bundle.putBoolean(READ_ONLY, readOnly);\n+            bundle.putBoolean(DRAGGABLE_ONLY, draggable);\n+        }\n+        return bundle;\n+    }\n+\n+    public static Bundle getGeoPolyBundle(String stringAnswer, GeoPolyActivity.OutputMode outputMode, boolean readOnly) {\n+        final Bundle bundle = new Bundle();\n+        bundle.putString(GeoPolyActivity.ANSWER_KEY, stringAnswer);\n+        bundle.putSerializable(GeoPolyActivity.OUTPUT_MODE_KEY, outputMode);\n+        bundle.putBoolean(READ_ONLY, readOnly);\n+        return bundle;\n+    }\n+\n+    private static void onButtonClick(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,\n+                                      WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        permissionUtils.requestLocationPermissions((Activity) context, new PermissionListener() {\n+            @Override\n+            public void granted() {\n+                waitingForDataRegistry.waitForData(index);\n+                if (mapConfigurator == null || mapConfigurator.isAvailable(context)) {\n+                    GeoWidgetUtils.startGeoActivity(context, activityClass, bundle, requestCode);\n+                } else {\n+                    mapConfigurator.showUnavailableMessage(context);\n+                }\n+            }\n+\n+            @Override\n+            public void denied() {\n+            }\n+        });\n+    }\n+\n+    private static void startGeoActivity(Context context, Class activityClass, Bundle bundle, int requestCode) {\n+        Intent intent = new Intent(context, activityClass);\n+        intent.putExtras(bundle);\n+        ((Activity) context).startActivityForResult(intent, requestCode);\n+    }\n+\n+    private static void updateButtonLabelAndVisibility(GeoWidgetAnswerBinding binding, boolean readOnly, boolean dataAvailable,", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0NzE2OA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470047168", "bodyText": "What's the advantage of putting this here rather than directly in GeoPointWidget? I don't see how it's implementing shared behavior.", "author": "lognaturel", "createdAt": "2020-08-13T15:42:36Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoWidgetUtils.java", "diffHunk": "@@ -1,17 +1,127 @@\n package org.odk.collect.android.widgets.utilities;\n \n+import android.app.Activity;\n import android.content.Context;\n+import android.content.Intent;\n import android.location.Location;\n+import android.os.Bundle;\n \n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n+import org.odk.collect.android.geo.MapConfigurator;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoWidgetListener;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-public class GeoWidgetUtils {\n+import static android.view.View.GONE;\n \n-    private GeoWidgetUtils() {\n+public class GeoWidgetUtils implements GeoWidgetListener {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n+\n+    @Override\n+    public void onButtonClicked(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,\n+                                WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        onButtonClick(context, index, permissionUtils, mapConfigurator, waitingForDataRegistry, activityClass, bundle, requestCode);\n+    }\n+\n+    @Override\n+    public void setButtonLabelAndVisibility(GeoWidgetAnswerBinding binding, boolean readOnly, boolean dataAvailable,\n+                                            int buttonTextReadOnly, int buttonTextDataAvailable, int defaultButtonText) {\n+        updateButtonLabelAndVisibility(binding, readOnly, dataAvailable, buttonTextReadOnly, buttonTextDataAvailable, defaultButtonText);\n+    }\n+\n+    public static double getAccuracyThreshold(QuestionDef questionDef) {\n+        // Determine the accuracy threshold to use.\n+        String acc = questionDef.getAdditionalAttribute(null, ACCURACY_THRESHOLD);\n+        return acc != null && !acc.isEmpty() ? Double.parseDouble(acc) : DEFAULT_LOCATION_ACCURACY;\n+    }\n+\n+    public static String getAnswerToDisplay(Context context, String answer) {\n+        try {\n+            if (answer != null && !answer.isEmpty()) {\n+                String[] parts = answer.split(\" \");\n+                return context.getString(\n+                        R.string.gps_result,\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[0]), \"lat\"),\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[1]), \"lon\"),\n+                        GeoWidgetUtils.truncateDouble(parts[2]),\n+                        GeoWidgetUtils.truncateDouble(parts[3])\n+                );\n+            }\n+        } catch (NumberFormatException e) {\n+            return \"\";\n+        }\n+        return \"\";\n+    }\n+\n+    public static Bundle getGeoPointBundle(String stringAnswer, double accuracyThreshold, Boolean readOnly, Boolean draggable) {", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0ODM2NA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470048364", "bodyText": "This is short enough that I don't think there's huge advantage to it being shared. Each poly widget could build its own bundle.", "author": "lognaturel", "createdAt": "2020-08-13T15:44:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoWidgetUtils.java", "diffHunk": "@@ -1,17 +1,127 @@\n package org.odk.collect.android.widgets.utilities;\n \n+import android.app.Activity;\n import android.content.Context;\n+import android.content.Intent;\n import android.location.Location;\n+import android.os.Bundle;\n \n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n+import org.odk.collect.android.geo.MapConfigurator;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoWidgetListener;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-public class GeoWidgetUtils {\n+import static android.view.View.GONE;\n \n-    private GeoWidgetUtils() {\n+public class GeoWidgetUtils implements GeoWidgetListener {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n+\n+    @Override\n+    public void onButtonClicked(Context context, FormIndex index, PermissionUtils permissionUtils, MapConfigurator mapConfigurator,\n+                                WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        onButtonClick(context, index, permissionUtils, mapConfigurator, waitingForDataRegistry, activityClass, bundle, requestCode);\n+    }\n+\n+    @Override\n+    public void setButtonLabelAndVisibility(GeoWidgetAnswerBinding binding, boolean readOnly, boolean dataAvailable,\n+                                            int buttonTextReadOnly, int buttonTextDataAvailable, int defaultButtonText) {\n+        updateButtonLabelAndVisibility(binding, readOnly, dataAvailable, buttonTextReadOnly, buttonTextDataAvailable, defaultButtonText);\n+    }\n+\n+    public static double getAccuracyThreshold(QuestionDef questionDef) {\n+        // Determine the accuracy threshold to use.\n+        String acc = questionDef.getAdditionalAttribute(null, ACCURACY_THRESHOLD);\n+        return acc != null && !acc.isEmpty() ? Double.parseDouble(acc) : DEFAULT_LOCATION_ACCURACY;\n+    }\n+\n+    public static String getAnswerToDisplay(Context context, String answer) {\n+        try {\n+            if (answer != null && !answer.isEmpty()) {\n+                String[] parts = answer.split(\" \");\n+                return context.getString(\n+                        R.string.gps_result,\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[0]), \"lat\"),\n+                        GeoWidgetUtils.convertCoordinatesIntoDegreeFormat(context, Double.parseDouble(parts[1]), \"lon\"),\n+                        GeoWidgetUtils.truncateDouble(parts[2]),\n+                        GeoWidgetUtils.truncateDouble(parts[3])\n+                );\n+            }\n+        } catch (NumberFormatException e) {\n+            return \"\";\n+        }\n+        return \"\";\n+    }\n+\n+    public static Bundle getGeoPointBundle(String stringAnswer, double accuracyThreshold, Boolean readOnly, Boolean draggable) {\n+        final Bundle bundle = new Bundle();\n+        if (stringAnswer != null && !stringAnswer.isEmpty()) {\n+            bundle.putDoubleArray(LOCATION, GeoWidgetUtils.getLocationParamsFromStringAnswer(stringAnswer));\n+        }\n+        bundle.putDouble(ACCURACY_THRESHOLD, accuracyThreshold);\n+        if (readOnly != null && draggable != null) {\n+            bundle.putBoolean(READ_ONLY, readOnly);\n+            bundle.putBoolean(DRAGGABLE_ONLY, draggable);\n+        }\n+        return bundle;\n+    }\n+\n+    public static Bundle getGeoPolyBundle(String stringAnswer, GeoPolyActivity.OutputMode outputMode, boolean readOnly) {", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0OTkzOQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r470049939", "bodyText": "In general, the Utils suffix is a red flag because it implies \"I didn't really know where to put this stuff so I put it here.\" It would be good to aim for clean abstractions that have meaningful names and specific responsibilities (e.g. GeoDataRequester as @seadowg suggested at #3922 (comment)).", "author": "lognaturel", "createdAt": "2020-08-13T15:46:49Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoWidgetUtils.java", "diffHunk": "@@ -1,17 +1,127 @@\n package org.odk.collect.android.widgets.utilities;\n \n+import android.app.Activity;\n import android.content.Context;\n+import android.content.Intent;\n import android.location.Location;\n+import android.os.Bundle;\n \n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.databinding.GeoWidgetAnswerBinding;\n+import org.odk.collect.android.geo.MapConfigurator;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoWidgetListener;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-public class GeoWidgetUtils {\n+import static android.view.View.GONE;\n \n-    private GeoWidgetUtils() {\n+public class GeoWidgetUtils implements GeoWidgetListener {", "originalCommit": "34a331caca9aa9a1508b56dd21b7d6108dfd30ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "40e065f077bab25076a7d53c2a30218e10a15ea9", "url": "https://github.com/getodk/collect/commit/40e065f077bab25076a7d53c2a30218e10a15ea9", "message": "create widget button and widget answer text view style", "committedDate": "2020-08-19T10:28:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ1ODMwMQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r478458301", "bodyText": "I think this interface should really be called the GeoDataRequester as that's what the widgets use it for. They do that on a button click but that's a detail of the widget.  It should also hide anything to do with the geo activity classes from the widget. The widget doesn't care how the geo data is acquired right? It just wants to get it in setBinaryData somehow.\nThat being the case it probably makes sense to have different methods like requestGeoPoint, requestGeoShape etc and then have the implementation control what activity it launches in each case. The implementation should also take responsibility for building the Bundle and the requestCode.\nGiven all that I think the implementation should probably be called something like ActivityGeoDataRequester as it's an activity based implementation of the request geo data.", "author": "seadowg", "createdAt": "2020-08-27T14:23:31Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/interfaces/GeoButtonClickListener.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package org.odk.collect.android.widgets.interfaces;\n+\n+import android.content.Context;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.utilities.WaitingForDataRegistry;\n+\n+public interface GeoButtonClickListener {", "originalCommit": "f9d281de465d8b6f661f6d224c31cc13411fbe02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU4NDc4Mw==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r478584783", "bodyText": "I renamed GeoDataRequester class back to GeoWidgetUtils, as I thought it also has methods to convert answer string to geo data etc. I renamed the interface as ActivirtyGeoDatarequester, which has methods requesGeoPoint, requestGeoShape, requestGeoTrace and requestGeoIntent. Also, I am testing the interface separately in the GeoWidgetUtilsTest.", "author": "SaumiaSinghal", "createdAt": "2020-08-27T17:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ1ODMwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQwMjMyMw==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r479402323", "bodyText": "Might be worth reading my comment again as I don't think that's what I was getting at. I don't think the GeoWidgetUtils should implement the GeoDataRequester interface (it should just be a non construtable utils class with helper methods) and I don't think the interface should be named ActivityGeoDataRequester, that was a suggested name for the implementation. Also, if it wasn't clear I was thinking you would get rid of requestGeoIntent and just have the three methods requesGeoPoint, requestGeoShape, requestGeoTrace which would all be void.\nVery happy to discuss more if it's helpful!", "author": "seadowg", "createdAt": "2020-08-28T16:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ1ODMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ1ODg0OA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r478458848", "bodyText": "permissionUtils could probably be a field of this class and come in at the constructor rather than be passed in as a method argument.", "author": "seadowg", "createdAt": "2020-08-27T14:24:16Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/GeoDataRequester.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.app.Activity;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.location.Location;\n+import android.os.Bundle;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n+import org.odk.collect.android.R;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoButtonClickListener;\n+\n+import java.text.DecimalFormat;\n+\n+import timber.log.Timber;\n+\n+public class GeoDataRequester implements GeoButtonClickListener {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+    public static final double DEFAULT_LOCATION_ACCURACY = 5.0;\n+\n+    @Override\n+    public void requestGeoIntent(Context context, FormIndex index, PermissionUtils permissionUtils,\n+                                 WaitingForDataRegistry waitingForDataRegistry, Class activityClass, Bundle bundle, int requestCode) {\n+        permissionUtils.requestLocationPermissions((Activity) context, new PermissionListener() {", "originalCommit": "f9d281de465d8b6f661f6d224c31cc13411fbe02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1f9392f5a3804fbe61955c03c4856e447912c60", "url": "https://github.com/getodk/collect/commit/a1f9392f5a3804fbe61955c03c4856e447912c60", "message": "code refactor", "committedDate": "2020-08-27T17:28:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MzY4MA==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481153680", "bodyText": "I think the static helper methods should stay in the GeoWidgetUtils class. There's no reason as far as I can see for them to live in ActivityGeoDataRequester and having them there creates a dependency between the widgets and the implementation of GeoDataRequester which isn't ideal.", "author": "seadowg", "createdAt": "2020-09-01T13:52:16Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/ActivityGeoDataRequester.java", "diffHunk": "@@ -6,24 +6,23 @@\n import android.location.Location;\n import android.os.Bundle;\n \n-import org.javarosa.core.model.FormIndex;\n import org.javarosa.core.model.QuestionDef;\n import org.javarosa.form.api.FormEntryPrompt;\n import org.odk.collect.android.R;\n+import org.odk.collect.android.activities.GeoPointActivity;\n+import org.odk.collect.android.activities.GeoPointMapActivity;\n import org.odk.collect.android.activities.GeoPolyActivity;\n import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.ApplicationConstants;\n import org.odk.collect.android.utilities.PermissionUtils;\n-import org.odk.collect.android.widgets.interfaces.ActivityGeoDataRequester;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n+import org.odk.collect.android.widgets.interfaces.GeoDataRequester;\n \n import java.text.DecimalFormat;\n \n import timber.log.Timber;\n \n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.MAPS;\n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.PLACEMENT_MAP;\n-import static org.odk.collect.android.utilities.WidgetAppearanceUtils.hasAppearance;\n-\n-public class GeoWidgetUtils implements ActivityGeoDataRequester {", "originalCommit": "75e38f28d333d5b2c2ae1c2035e3a246f8e2d2e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63506e07c9f41107ab2c4e31e403cc197fcef529", "url": "https://github.com/getodk/collect/commit/63506e07c9f41107ab2c4e31e403cc197fcef529", "message": "implement GeoWidgetUtils and ActivityDataRequester", "committedDate": "2020-09-01T14:24:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjk2OQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481916969", "bodyText": "This should still implement the interface so that the widget depends on an abstraction rather than an implementation.", "author": "seadowg", "createdAt": "2020-09-02T09:05:37Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/ActivityGeoDataRequester.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.app.Activity;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.os.Bundle;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.activities.GeoPointActivity;\n+import org.odk.collect.android.activities.GeoPointMapActivity;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.ApplicationConstants;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n+\n+public class ActivityGeoDataRequester {", "originalCommit": "d249bbde5eb7aa72ba0a0e2af149449bd07dd6e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0ODMzNw==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481948337", "bodyText": "I misinterpreted the last comment. The interface would be good here.", "author": "SaumiaSinghal", "createdAt": "2020-09-02T09:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxODIwOQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481918209", "bodyText": "I don't think we should have this constructor. The WidgetFactory can construct a PermissionUtils object to pass in.", "author": "seadowg", "createdAt": "2020-09-02T09:07:01Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/utilities/ActivityGeoDataRequester.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.app.Activity;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.os.Bundle;\n+\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.odk.collect.android.activities.GeoPointActivity;\n+import org.odk.collect.android.activities.GeoPointMapActivity;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.listeners.PermissionListener;\n+import org.odk.collect.android.utilities.ApplicationConstants;\n+import org.odk.collect.android.utilities.PermissionUtils;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n+\n+public class ActivityGeoDataRequester {\n+    public static final String LOCATION = \"gp\";\n+    public static final String ACCURACY_THRESHOLD = \"accuracyThreshold\";\n+    public static final String READ_ONLY = \"readOnly\";\n+    public static final String DRAGGABLE_ONLY = \"draggable\";\n+\n+    private final PermissionUtils permissionUtils;\n+\n+    public ActivityGeoDataRequester() {", "originalCommit": "d249bbde5eb7aa72ba0a0e2af149449bd07dd6e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzNzA0NQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481937045", "bodyText": "I think all the widgets are missing tests to check that setBinaryData actually updates the widget answer (getAnswer). It looks like right now the wigets are broken and don't save answers (just display them).", "author": "seadowg", "createdAt": "2020-09-02T09:36:04Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/GeoPointWidgetTest.java", "diffHunk": "@@ -1,212 +1,151 @@\n package org.odk.collect.android.widgets;\n \n-import android.content.ComponentName;\n-import android.content.Intent;\n-import android.os.Bundle;\n import android.view.View;\n \n-import org.javarosa.core.model.QuestionDef;\n import org.javarosa.core.model.data.GeoPointData;\n-import org.javarosa.core.model.data.StringData;\n import org.javarosa.form.api.FormEntryPrompt;\n import org.junit.Before;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.odk.collect.android.R;\n-import org.odk.collect.android.activities.GeoPointActivity;\n-import org.odk.collect.android.fakes.FakePermissionUtils;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.odk.collect.android.widgets.utilities.ActivityGeoDataRequester;\n import org.odk.collect.android.widgets.utilities.GeoWidgetUtils;\n import org.odk.collect.android.widgets.utilities.WaitingForDataRegistry;\n import org.robolectric.RobolectricTestRunner;\n \n-import java.util.Random;\n-\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.equalTo;\n-import static org.hamcrest.Matchers.nullValue;\n+import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNull;\n-import static org.mockito.ArgumentMatchers.anyString;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n-import static org.odk.collect.android.widgets.GeoPointMapWidget.ACCURACY_THRESHOLD;\n-import static org.odk.collect.android.widgets.GeoPointMapWidget.DEFAULT_LOCATION_ACCURACY;\n-import static org.odk.collect.android.widgets.GeoPointMapWidget.LOCATION;\n+import static org.odk.collect.android.widgets.support.GeoWidgetHelpers.getRandomDoubleArray;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n-import static org.robolectric.Shadows.shadowOf;\n-\n-/**\n- * @author James Knight\n- */\n \n @RunWith(RobolectricTestRunner.class)\n public class GeoPointWidgetTest {", "originalCommit": "d249bbde5eb7aa72ba0a0e2af149449bd07dd6e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0ODY5Mw==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481948693", "bodyText": "I thought that the answers must be getting saved by calling widgetValueChanged", "author": "SaumiaSinghal", "createdAt": "2020-09-02T09:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzNzA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzOTIwNQ==", "url": "https://github.com/getodk/collect/pull/3922#discussion_r481939205", "bodyText": "These three tests should be broken into multiple tests for the different calls to the methods under tests (for readOnly mode and different appearances for example). Otherwise, it's hard to read the test and if one fails it'll be harder to see what exactly has failed.", "author": "seadowg", "createdAt": "2020-09-02T09:39:45Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/utilities/ActivityGeoDataRequesterTest.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package org.odk.collect.android.widgets.utilities;\n+\n+import android.content.ComponentName;\n+import android.content.Intent;\n+\n+import org.javarosa.core.model.FormIndex;\n+import org.javarosa.core.model.QuestionDef;\n+import org.javarosa.core.model.data.GeoPointData;\n+import org.javarosa.form.api.FormEntryPrompt;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.odk.collect.android.activities.GeoPointActivity;\n+import org.odk.collect.android.activities.GeoPointMapActivity;\n+import org.odk.collect.android.activities.GeoPolyActivity;\n+import org.odk.collect.android.fakes.FakePermissionUtils;\n+import org.odk.collect.android.support.TestScreenContextActivity;\n+import org.odk.collect.android.utilities.WidgetAppearanceUtils;\n+import org.odk.collect.android.widgets.support.FakeWaitingForDataRegistry;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.shadows.ShadowActivity;\n+\n+import static junit.framework.TestCase.assertEquals;\n+import static junit.framework.TestCase.assertTrue;\n+import static org.junit.Assert.assertNull;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.odk.collect.android.utilities.ApplicationConstants.RequestCodes.GEOSHAPE_CAPTURE;\n+import static org.odk.collect.android.utilities.ApplicationConstants.RequestCodes.GEOTRACE_CAPTURE;\n+import static org.odk.collect.android.utilities.ApplicationConstants.RequestCodes.LOCATION_CAPTURE;\n+import static org.odk.collect.android.widgets.support.GeoWidgetHelpers.assertGeoPointBundleArgumentEquals;\n+import static org.odk.collect.android.widgets.support.GeoWidgetHelpers.assertGeoPolyBundleArgumentEquals;\n+import static org.odk.collect.android.widgets.support.GeoWidgetHelpers.getRandomDoubleArray;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n+import static org.odk.collect.android.widgets.utilities.ActivityGeoDataRequester.ACCURACY_THRESHOLD;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class ActivityGeoDataRequesterTest {\n+    private final FakePermissionUtils permissionUtils = new FakePermissionUtils();\n+    private final ActivityGeoDataRequester activityGeoDataRequester = new ActivityGeoDataRequester(permissionUtils);\n+    private final FakeWaitingForDataRegistry waitingForDataRegistry = new FakeWaitingForDataRegistry();\n+    private final GeoPointData answer = new GeoPointData(getRandomDoubleArray());\n+\n+    private TestScreenContextActivity testActivity;\n+    private ShadowActivity shadowActivity;\n+    private FormEntryPrompt prompt;\n+    private FormIndex formIndex;\n+    private QuestionDef questionDef;\n+\n+    @Before\n+    public void setUp() {\n+        testActivity = widgetTestActivity();\n+        shadowActivity = shadowOf(testActivity);\n+\n+        prompt = promptWithReadOnly();\n+        formIndex = mock(FormIndex.class);\n+        questionDef = mock(QuestionDef.class);\n+\n+        permissionUtils.setPermissionGranted(true);\n+        when(prompt.getQuestion()).thenReturn(questionDef);\n+        when(prompt.getIndex()).thenReturn(formIndex);\n+    }\n+\n+    @Test\n+    public void whenPermissionIsNotGranted_requestGeoPoint_doesNotLaunchAnyIntent() {\n+        permissionUtils.setPermissionGranted(false);\n+        activityGeoDataRequester.requestGeoPoint(testActivity, prompt, waitingForDataRegistry);\n+\n+        assertNull(shadowActivity.getNextStartedActivity());\n+        assertTrue(waitingForDataRegistry.waiting.isEmpty());\n+    }\n+\n+    @Test\n+    public void whenPermissionIsNotGranted_requestGeoShape_doesNotLaunchAnyIntent() {\n+        permissionUtils.setPermissionGranted(false);\n+        activityGeoDataRequester.requestGeoShape(testActivity, prompt, waitingForDataRegistry);\n+\n+        assertNull(shadowActivity.getNextStartedActivity());\n+        assertTrue(waitingForDataRegistry.waiting.isEmpty());\n+    }\n+\n+    @Test\n+    public void whenPermissionIsNotGranted_requestGeoTrace_doesNotLaunchAnyIntent() {\n+        permissionUtils.setPermissionGranted(false);\n+        activityGeoDataRequester.requestGeoTrace(testActivity, prompt, waitingForDataRegistry);\n+\n+        assertNull(shadowActivity.getNextStartedActivity());\n+        assertTrue(waitingForDataRegistry.waiting.isEmpty());\n+    }\n+\n+    @Test\n+    public void whenPermissionIGranted_requestGeoPoint_launchCorrectIntent_andSetsFormIndexWaitingForData() {", "originalCommit": "d249bbde5eb7aa72ba0a0e2af149449bd07dd6e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "604a9d4e462f5a2134ba85dcf3c5cdaee9ee74a6", "url": "https://github.com/getodk/collect/commit/604a9d4e462f5a2134ba85dcf3c5cdaee9ee74a6", "message": "fix getAnswer in widgets", "committedDate": "2020-10-09T10:18:12Z", "type": "forcePushed"}, {"oid": "00dc337c20941a8ce9d0e85d3065b74a6d0b13f0", "url": "https://github.com/getodk/collect/commit/00dc337c20941a8ce9d0e85d3065b74a6d0b13f0", "message": "add unit tests", "committedDate": "2020-10-13T01:43:04Z", "type": "commit"}, {"oid": "0e32fa29e652dde4b6d9300ce6b67214dcdd272e", "url": "https://github.com/getodk/collect/commit/0e32fa29e652dde4b6d9300ce6b67214dcdd272e", "message": "revert accidental change in build.gradle", "committedDate": "2020-10-13T01:43:13Z", "type": "commit"}, {"oid": "c453021591c47382e9119453f60ee8e57b7af897", "url": "https://github.com/getodk/collect/commit/c453021591c47382e9119453f60ee8e57b7af897", "message": "code refactor", "committedDate": "2020-10-13T01:44:30Z", "type": "commit"}, {"oid": "49b0cc6a650a3db44910751520c272ab96dc1a9a", "url": "https://github.com/getodk/collect/commit/49b0cc6a650a3db44910751520c272ab96dc1a9a", "message": "code refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "a7f4039e339267c6f0c86989f7039014201c21a0", "url": "https://github.com/getodk/collect/commit/a7f4039e339267c6f0c86989f7039014201c21a0", "message": "add unit tests for geoshape widget", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "77ba4338636cd686833223de431671690a78c625", "url": "https://github.com/getodk/collect/commit/77ba4338636cd686833223de431671690a78c625", "message": "update GeoShapeWidget", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "a492ec858f9ce30ea993ec2fc97e917c6c910079", "url": "https://github.com/getodk/collect/commit/a492ec858f9ce30ea993ec2fc97e917c6c910079", "message": "code refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "29e1b7aa29992f898287a96d9c2899967ab7b16c", "url": "https://github.com/getodk/collect/commit/29e1b7aa29992f898287a96d9c2899967ab7b16c", "message": "add unit tests for GeoTraceWidget", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "cf543a5eb4ca92cd7e317adb06d6a7ec01ce61b6", "url": "https://github.com/getodk/collect/commit/cf543a5eb4ca92cd7e317adb06d6a7ec01ce61b6", "message": "update GeoTraceWidget", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "03eecc699bbec954f0d1c8ecaa330db04fd9da01", "url": "https://github.com/getodk/collect/commit/03eecc699bbec954f0d1c8ecaa330db04fd9da01", "message": "add unit tests for GeoTraceWidget", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "1c9d33434cfc3677df8ab903bc295b2348881d19", "url": "https://github.com/getodk/collect/commit/1c9d33434cfc3677df8ab903bc295b2348881d19", "message": "resolve conflicts", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "293af151bf4d743c5674943e5d2cf07f080700b4", "url": "https://github.com/getodk/collect/commit/293af151bf4d743c5674943e5d2cf07f080700b4", "message": "code improvements", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "5b5489e9ba080b2b1446fa6cd86b648ad6df3b4e", "url": "https://github.com/getodk/collect/commit/5b5489e9ba080b2b1446fa6cd86b648ad6df3b4e", "message": "code refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "d0d2e4d11b58ac829a01d5eee0535bbd01e42aad", "url": "https://github.com/getodk/collect/commit/d0d2e4d11b58ac829a01d5eee0535bbd01e42aad", "message": "unit tests refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "2fc2338ba3b5521389f5e4820717dc558ac69fe4", "url": "https://github.com/getodk/collect/commit/2fc2338ba3b5521389f5e4820717dc558ac69fe4", "message": "code improvements", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "84a2d3ef86f46ee8fa9cdc3e813a68204b1d4c14", "url": "https://github.com/getodk/collect/commit/84a2d3ef86f46ee8fa9cdc3e813a68204b1d4c14", "message": "revert accidentendal change in build.gradle file", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "05cae55f854e13f099b57fac8d2466680ca52d9e", "url": "https://github.com/getodk/collect/commit/05cae55f854e13f099b57fac8d2466680ca52d9e", "message": "refactor GeoButtonClickListener", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "88070633e48bbe760b66778efce31b0a756287e2", "url": "https://github.com/getodk/collect/commit/88070633e48bbe760b66778efce31b0a756287e2", "message": "show geoshape and geotrace button when prompt is readonly and data is available", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "51c9549e9886d1c12769663e6d073d7eb34a4e9a", "url": "https://github.com/getodk/collect/commit/51c9549e9886d1c12769663e6d073d7eb34a4e9a", "message": "code refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "c45742657e909a9847aa6b1666a438885e23b55b", "url": "https://github.com/getodk/collect/commit/c45742657e909a9847aa6b1666a438885e23b55b", "message": "update unit tests", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "8c5f4aa5e9f6ff9c3b9cfd3c0fec5d798a9e1fa9", "url": "https://github.com/getodk/collect/commit/8c5f4aa5e9f6ff9c3b9cfd3c0fec5d798a9e1fa9", "message": "add unit tests for GeoWidgetUtils", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "82206b1e60ad9da27c55f92b47f654c066b6e212", "url": "https://github.com/getodk/collect/commit/82206b1e60ad9da27c55f92b47f654c066b6e212", "message": " refactor GeoWidgetUtils", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "5fa58d048f69530b3c30498f2cb5ede09c6541f6", "url": "https://github.com/getodk/collect/commit/5fa58d048f69530b3c30498f2cb5ede09c6541f6", "message": "refactor unit tests", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "95c542c7d1fe3d71faf91bf9254f92f5dfea6dd3", "url": "https://github.com/getodk/collect/commit/95c542c7d1fe3d71faf91bf9254f92f5dfea6dd3", "message": "create widget button and widget answer text view style", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "19b53dda9d1c772971527208d7b2fc9c78314bf2", "url": "https://github.com/getodk/collect/commit/19b53dda9d1c772971527208d7b2fc9c78314bf2", "message": "fix #3979", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "1fc3b41abb951bd17c016c903f6cc4a4cd7a8fd3", "url": "https://github.com/getodk/collect/commit/1fc3b41abb951bd17c016c903f6cc4a4cd7a8fd3", "message": "create widget button and widget answer text view style", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "14e2f1d72d1d20965430b3f57ef92ebe5e203d48", "url": "https://github.com/getodk/collect/commit/14e2f1d72d1d20965430b3f57ef92ebe5e203d48", "message": "code refactor", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "e433ab5d6f1d453cb663e8f57f28effa9c2102e8", "url": "https://github.com/getodk/collect/commit/e433ab5d6f1d453cb663e8f57f28effa9c2102e8", "message": "implement GeoWidgetUtils and ActivityDataRequester", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "fb19b5073e05ab17df37db0dc82cf0269cdeaeca", "url": "https://github.com/getodk/collect/commit/fb19b5073e05ab17df37db0dc82cf0269cdeaeca", "message": "fix unit tests", "committedDate": "2020-10-13T01:44:35Z", "type": "commit"}, {"oid": "6da6f5e74bf9ae1b98a9bc77c7865d16f0d65da0", "url": "https://github.com/getodk/collect/commit/6da6f5e74bf9ae1b98a9bc77c7865d16f0d65da0", "message": "implement abstarction using GeoDataRequester interface", "committedDate": "2020-10-13T01:45:20Z", "type": "commit"}, {"oid": "797bb40a3a3d82bdf76e763abf5b05bbceba4526", "url": "https://github.com/getodk/collect/commit/797bb40a3a3d82bdf76e763abf5b05bbceba4526", "message": "fix getAnswer in widgets", "committedDate": "2020-10-13T01:45:26Z", "type": "commit"}, {"oid": "70fd88bfa46df285050d6f23ae9d2e8d60d9bebf", "url": "https://github.com/getodk/collect/commit/70fd88bfa46df285050d6f23ae9d2e8d60d9bebf", "message": "fix unit tests", "committedDate": "2020-10-13T01:50:34Z", "type": "commit"}, {"oid": "70fd88bfa46df285050d6f23ae9d2e8d60d9bebf", "url": "https://github.com/getodk/collect/commit/70fd88bfa46df285050d6f23ae9d2e8d60d9bebf", "message": "fix unit tests", "committedDate": "2020-10-13T01:50:34Z", "type": "forcePushed"}, {"oid": "7d60c0b1ac99a23f0b3f85a7bc689d9924fc18fd", "url": "https://github.com/getodk/collect/commit/7d60c0b1ac99a23f0b3f85a7bc689d9924fc18fd", "message": "fix sending data to intent", "committedDate": "2020-10-13T02:41:44Z", "type": "commit"}, {"oid": "a4497ee076600043fbd8c55cefe3b3dff1845edf", "url": "https://github.com/getodk/collect/commit/a4497ee076600043fbd8c55cefe3b3dff1845edf", "message": "add unit tests", "committedDate": "2020-10-13T07:04:39Z", "type": "commit"}, {"oid": "3593c61e10f5eab78375fd6f770a5ba21f47c020", "url": "https://github.com/getodk/collect/commit/3593c61e10f5eab78375fd6f770a5ba21f47c020", "message": "fix unit test", "committedDate": "2020-10-13T07:28:14Z", "type": "commit"}]}