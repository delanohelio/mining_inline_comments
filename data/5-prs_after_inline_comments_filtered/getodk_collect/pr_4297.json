{"pr_number": 4297, "pr_title": "Do not ask for storage permissions when it's a fresh installation", "pr_createdAt": "2020-12-11T17:11:14Z", "pr_url": "https://github.com/getodk/collect/pull/4297", "timeline": [{"oid": "4289b3afdcdaf2d791628e90a5c2735bec5c5d35", "url": "https://github.com/getodk/collect/commit/4289b3afdcdaf2d791628e90a5c2735bec5c5d35", "message": "Fixed tests", "committedDate": "2021-01-07T13:38:32Z", "type": "forcePushed"}, {"oid": "fc3b134af98850da7b66907a5c4e56307ea4222e", "url": "https://github.com/getodk/collect/commit/fc3b134af98850da7b66907a5c4e56307ea4222e", "message": "Fixed tests", "committedDate": "2021-01-07T13:52:11Z", "type": "forcePushed"}, {"oid": "cfa08fecd502652135d71cd0d513212903d987ee", "url": "https://github.com/getodk/collect/commit/cfa08fecd502652135d71cd0d513212903d987ee", "message": "Reuse PermissionsProvider injected to CollectAbstractActivity", "committedDate": "2021-01-11T13:09:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njg0MjIzMw==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r556842233", "bodyText": "This should be true so that the last assertion is true!", "author": "lognaturel", "createdAt": "2021-01-13T21:26:07Z", "path": "collect_app/src/test/java/org/odk/collect/android/permissions/PermissionsProviderTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.odk.collect.android.permissions;\n+\n+import android.Manifest;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import org.odk.collect.android.storage.StorageStateProvider;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class PermissionsProviderTest {\n+    private PermissionsChecker permissionsChecker;\n+    private StorageStateProvider storageStateProvider;\n+    private PermissionsProvider permissionsProvider;\n+\n+    @Before\n+    public void setup() {\n+        permissionsChecker = mock(PermissionsChecker.class);\n+        storageStateProvider = mock(StorageStateProvider.class);\n+    }\n+\n+    @Test\n+    public void whenStoragePermissionsGrantedAndScopedStorageNotUsed_shouldAreStoragePermissionsGrantedReturnTrue() {\n+        when(permissionsChecker.isPermissionGranted(Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.WRITE_EXTERNAL_STORAGE)).thenReturn(true);\n+        when(storageStateProvider.isScopedStorageUsed()).thenReturn(false);\n+        permissionsProvider = new PermissionsProvider(permissionsChecker, storageStateProvider);\n+\n+        assertThat(permissionsProvider.areStoragePermissionsGranted(), is(true));\n+    }\n+\n+    @Test\n+    public void whenStoragePermissionsGrantedAndScopedStorageUsed_shouldAreStoragePermissionsGrantedReturnTrue() {\n+        when(permissionsChecker.isPermissionGranted(Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.WRITE_EXTERNAL_STORAGE)).thenReturn(true);\n+        when(storageStateProvider.isScopedStorageUsed()).thenReturn(true);\n+        permissionsProvider = new PermissionsProvider(permissionsChecker, storageStateProvider);\n+\n+        assertThat(permissionsProvider.areStoragePermissionsGranted(), is(true));\n+    }\n+\n+    @Test\n+    public void whenStoragePermissionsNotGrantedAndScopedStorageNotUsed_shouldAreStoragePermissionsGrantedReturnFalse() {\n+        when(permissionsChecker.isPermissionGranted(Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.WRITE_EXTERNAL_STORAGE)).thenReturn(false);\n+        when(storageStateProvider.isScopedStorageUsed()).thenReturn(false);\n+        permissionsProvider = new PermissionsProvider(permissionsChecker, storageStateProvider);\n+\n+        assertThat(permissionsProvider.areStoragePermissionsGranted(), is(false));\n+    }\n+\n+    @Test\n+    public void whenStoragePermissionsNotGrantedAndScopedStorageUsed_shouldAreStoragePermissionsGrantedReturnTrue() {\n+        when(permissionsChecker.isPermissionGranted(Manifest.permission.READ_EXTERNAL_STORAGE, Manifest.permission.WRITE_EXTERNAL_STORAGE)).thenReturn(false);\n+        when(storageStateProvider.isScopedStorageUsed()).thenReturn(false);", "originalCommit": "cfa08fecd502652135d71cd0d513212903d987ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzI4ODg1MA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r557288850", "bodyText": "Ahh good catch, thanks!", "author": "grzesiek2010", "createdAt": "2021-01-14T10:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njg0MjIzMw=="}], "type": "inlineReview"}, {"oid": "a59690ce0f7125558de50ee98effe3d3283c9534", "url": "https://github.com/getodk/collect/commit/a59690ce0f7125558de50ee98effe3d3283c9534", "message": "Implemented AppStateProvider", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "34667887d6d5bbe7529eb669887a3c2b7cc822ba", "url": "https://github.com/getodk/collect/commit/34667887d6d5bbe7529eb669887a3c2b7cc822ba", "message": "Enable scoped storage for fresh installs", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "f154afd15404c7c1e49f28c34ab4ef24cf995882", "url": "https://github.com/getodk/collect/commit/f154afd15404c7c1e49f28c34ab4ef24cf995882", "message": "Don't ask for storage permission if scoped storage is used", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "f519e6763008e5f7d62fc5a7143c2b8c294765e5", "url": "https://github.com/getodk/collect/commit/f519e6763008e5f7d62fc5a7143c2b8c294765e5", "message": "Use injected permissionUtils", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "c34f2fa990eb77c529b582cb6549bf68e5416a3b", "url": "https://github.com/getodk/collect/commit/c34f2fa990eb77c529b582cb6549bf68e5416a3b", "message": "Pass storageStateProvider to PermissionUtils", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "ab274f1a5ff6a04b6199cd8d4455673530f23d7b", "url": "https://github.com/getodk/collect/commit/ab274f1a5ff6a04b6199cd8d4455673530f23d7b", "message": "Use storageStateProvider object to determine if should ask for storage permission", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "0bafab9f8abba68354f70c2c62f2e09516a4d450", "url": "https://github.com/getodk/collect/commit/0bafab9f8abba68354f70c2c62f2e09516a4d450", "message": "areStoragePermissionsGranted() shoul not be static", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "0040fea4d959528f8ec176d17160e861e219b950", "url": "https://github.com/getodk/collect/commit/0040fea4d959528f8ec176d17160e861e219b950", "message": "Fixed areStoragePermissionsGranted()", "committedDate": "2021-01-14T10:19:28Z", "type": "commit"}, {"oid": "9cbb76aec5d76be83c8c0df03593e15539030faf", "url": "https://github.com/getodk/collect/commit/9cbb76aec5d76be83c8c0df03593e15539030faf", "message": "Removed redundant code from providers", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "662430b2c3dc754313e272c562850fb6bc61f0d8", "url": "https://github.com/getodk/collect/commit/662430b2c3dc754313e272c562850fb6bc61f0d8", "message": "Fixed tests", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "b72331ce0ceedf83e04a35c0921eabd099df9be3", "url": "https://github.com/getodk/collect/commit/b72331ce0ceedf83e04a35c0921eabd099df9be3", "message": "Call Dexter.withContext instead of deprecated withActivity", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "65705f9b5e13633965b9b55be00337231ec63537", "url": "https://github.com/getodk/collect/commit/65705f9b5e13633965b9b55be00337231ec63537", "message": "Removed redundant finishAllActivities() method from PermissionUtils", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "bbd812e91debb1045e4bae3164f28fd5146ed602", "url": "https://github.com/getodk/collect/commit/bbd812e91debb1045e4bae3164f28fd5146ed602", "message": "Got rid of static methods in PermissionUtils class", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "d00b793072eba812f0cc1f207aad3a836a78eddd", "url": "https://github.com/getodk/collect/commit/d00b793072eba812f0cc1f207aad3a836a78eddd", "message": "Implemented PermissionsChecker", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "0c5b50d4fba3f1c514ece62f4c427594a1064269", "url": "https://github.com/getodk/collect/commit/0c5b50d4fba3f1c514ece62f4c427594a1064269", "message": "Do not pass dialogTheme to PermissionUtils constructor", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "265c183e8343092e89ec8d0c2ae47c9c22cd5119", "url": "https://github.com/getodk/collect/commit/265c183e8343092e89ec8d0c2ae47c9c22cd5119", "message": "Moved permissionUtils class to permissions package", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "e7d97823a196718baf07a48ef8ced5e6211dc991", "url": "https://github.com/getodk/collect/commit/e7d97823a196718baf07a48ef8ced5e6211dc991", "message": "Renamed PermissionUtils -> PermissionsProvider", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "2ca5372b002457291e4fd604860bb2818a7a5aa7", "url": "https://github.com/getodk/collect/commit/2ca5372b002457291e4fd604860bb2818a7a5aa7", "message": "Removed duplicated AlwaysGrantStoragePermissionsPermissionsProvider class", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "d1aa0d3a3a74117f1af39b1158284ff3b2a3a1c4", "url": "https://github.com/getodk/collect/commit/d1aa0d3a3a74117f1af39b1158284ff3b2a3a1c4", "message": "Added tests", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "1a7d363f6f771bdfd8071fb38ae0a863ae45da11", "url": "https://github.com/getodk/collect/commit/1a7d363f6f771bdfd8071fb38ae0a863ae45da11", "message": "Reuse PermissionsProvider injected to CollectAbstractActivity", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "513b64b2f59138815709826295554bd64ebb2539", "url": "https://github.com/getodk/collect/commit/513b64b2f59138815709826295554bd64ebb2539", "message": "Fixed bugs in tests", "committedDate": "2021-01-14T10:20:18Z", "type": "commit"}, {"oid": "513b64b2f59138815709826295554bd64ebb2539", "url": "https://github.com/getodk/collect/commit/513b64b2f59138815709826295554bd64ebb2539", "message": "Fixed bugs in tests", "committedDate": "2021-01-14T10:20:18Z", "type": "forcePushed"}, {"oid": "643a492125862b541024926ea440e41b5db463f3", "url": "https://github.com/getodk/collect/commit/643a492125862b541024926ea440e41b5db463f3", "message": "Use Storage Access Framework to access files in MediaLoadingTask", "committedDate": "2021-01-19T18:42:18Z", "type": "commit"}, {"oid": "3cb8c9bc6bd33ae369c9f0b2d5778fce3d0cfe4f", "url": "https://github.com/getodk/collect/commit/3cb8c9bc6bd33ae369c9f0b2d5778fce3d0cfe4f", "message": "All widgets that use files should use the same code to load them", "committedDate": "2021-01-19T19:10:23Z", "type": "commit"}, {"oid": "702d409c5198973a27016faeddf7d6f8afe7c46e", "url": "https://github.com/getodk/collect/commit/702d409c5198973a27016faeddf7d6f8afe7c46e", "message": "Removed unused code", "committedDate": "2021-01-19T19:10:24Z", "type": "commit"}, {"oid": "de50836e8a120f26458827601f79f56d674ad1d7", "url": "https://github.com/getodk/collect/commit/de50836e8a120f26458827601f79f56d674ad1d7", "message": "Fixed custom splash screen image", "committedDate": "2021-01-19T20:04:34Z", "type": "commit"}, {"oid": "32734194499287365954afcc86f08840f1a04600", "url": "https://github.com/getodk/collect/commit/32734194499287365954afcc86f08840f1a04600", "message": "Remove unused code", "committedDate": "2021-01-19T20:58:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMzg5OA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560603898", "bodyText": "This happens to work for some common types like image/jpeg but the subtype name is not guaranteed to be the extension. For example the SVG MIME type is image/svg+xml but its extension is .svg. Or audio/amr-wb and .amr. I think you have to use MimeTypeMap#getExtensionFromMimeType.", "author": "lognaturel", "createdAt": "2021-01-20T01:04:12Z", "path": "collect_app/src/main/java/org/odk/collect/android/dao/helpers/ContentResolverHelper.java", "diffHunk": "@@ -76,20 +73,8 @@ public static String getFormPath(Uri uri) {\n         return formPath;\n     }\n \n-    /**\n-     * Using contentResolver to get a file's extension by the uri\n-     *\n-     * @param fileUri Whose name we want to get\n-     * @return The file's extension without a dot eg. \"mp3\" not \".mp3\"\n-     */\n-    public static String getFileExtensionFromUri(Context context, Uri fileUri) {\n-        String fileName = new MediaUtils().getFileNameFromUri(context, fileUri);\n-        if (fileName != null && fileName.contains(\".\")) {\n-            return fileName.substring(fileName.lastIndexOf('.') + 1);\n-        } else {\n-            return fileUri.getScheme() != null && fileUri.getScheme().equals(ContentResolver.SCHEME_CONTENT)\n-                    ? MimeTypeMap.getSingleton().getExtensionFromMimeType(context.getContentResolver().getType(fileUri))\n-                    : MimeTypeMap.getFileExtensionFromUrl(fileUri.toString());\n-        }\n+    public static String getFileExtensionFromUri(Uri fileUri) {\n+        String mimeType = getContentResolver().getType(fileUri);\n+        return mimeType.substring(mimeType.lastIndexOf(\"/\") + 1);", "originalCommit": "32734194499287365954afcc86f08840f1a04600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDgzNjk2OQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560836969", "bodyText": "Generally you are right and I tried it but in some cases (which seem pretty obvious) it returns null those cases are like:\n\naudio/mp3\ntext/csv\n\nHere https://stackoverflow.com/questions/12473851/how-i-can-get-the-mime-type-of-a-file-having-its-uri/12473985 where that solution is marked as accepted people also complain about the same.\nMaybe I should use what you mentioned first and then in case of null my: mimeType.substring(mimeType.lastIndexOf(\"/\") + 1);\nor better yet (as a second step) I can read filename that should contain file extension:\n        Cursor cursor = getContentResolver().query(fileUri, null, null, null, null);\n        if (cursor != null && cursor.moveToFirst()) {\n            name = cursor.getString(cursor.getColumnIndex(MediaStore.MediaColumns.DISPLAY_NAME));\n        }\n        String extension = name != null ? name.substring(name.lastIndexOf(\".\") + 1) : \"\";\n\nthis is what this library does https://github.com/anggrayudi/SimpleStorage. I know it's new and didn't gain traction yet but i ran into it through this topic https://stackoverflow.com/questions/63080879/get-file-extension-using-android-storage-access-framework.\nWhat do you think?", "author": "grzesiek2010", "createdAt": "2021-01-20T10:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMzg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEzMTUxNQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561131515", "bodyText": "ANDROID! Why must it always make simple things hard. Good catch on MimeTypeMap#getExtensionFromMimeType not actually working all the time.\nDoing that first and then falling back seems good. I think you might actually want to have both fallbacks since neither is perfect -- MediaStore.MediaColumns.DISPLAY_NAME is not necessarily a file name. Maybe first use MimeTypeMap#getExtensionFromMimeType, then try the display column and then use the subtype?", "author": "lognaturel", "createdAt": "2021-01-20T17:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMzg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTIwOTQzOA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561209438", "bodyText": "Ok I did it I even added another fourth aproach since I noticed that in case of selfie video only that last approach works well \ud83d\ude31", "author": "grzesiek2010", "createdAt": "2021-01-20T19:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMzg5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTIxMTA0NA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561211044", "bodyText": "Yikes! Is that maybe because selfie video gives back a file URI (not a content URI) without a MIME type set? Maybe that's worth looking at again after this PR.", "author": "lognaturel", "createdAt": "2021-01-20T19:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwMzg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwODA5Mg==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560608092", "bodyText": "I think this can all go away once we don't support files in /sdcard/odk/ anymore but at the moment, removing it could result in a crash if someone's migration failed, they haven't yet granted permissions, and they try to access forms from an external app, right?", "author": "lognaturel", "createdAt": "2021-01-20T01:16:34Z", "path": "collect_app/src/main/java/org/odk/collect/android/provider/FormsProvider.java", "diffHunk": "@@ -87,12 +86,6 @@ public static void releaseDatabaseHelper() {\n \n     @Override\n     public boolean onCreate() {\n-\n-        if (!areStoragePermissionsGranted(getContext())) {", "originalCommit": "32734194499287365954afcc86f08840f1a04600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0ODcxMw==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560948713", "bodyText": "I tested it using collectTester app and:\n\nif you open list of blank form everything is fine, you are asked to grant permissions\nif you open list of saved forms as above\nif you open list of forms to submit as above\nif you open list of sent forms as above\nif you download forms passing ids as above\nif you upload forms passing ids as above\n\nIt only crashes if an external app tries to get list of forms or instances.\nThe problem was with injecting objects in content providers which are initialized before other app components but finally I fixed this issue thanks to https://stackoverflow.com/questions/23521083/inject-database-in-a-contentprovider-with-dagger\n0c1ff84", "author": "grzesiek2010", "createdAt": "2021-01-20T13:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwODA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEzMzc0NA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561133744", "bodyText": "Makes sense!", "author": "lognaturel", "createdAt": "2021-01-20T17:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwODA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwODIyMQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560608221", "bodyText": "Same question as for FormsProvider.", "author": "lognaturel", "createdAt": "2021-01-20T01:16:58Z", "path": "collect_app/src/main/java/org/odk/collect/android/provider/InstanceProvider.java", "diffHunk": "@@ -87,11 +86,6 @@ public static void releaseDatabaseHelper() {\n \n     @Override\n     public boolean onCreate() {\n-        if (!areStoragePermissionsGranted(getContext())) {", "originalCommit": "32734194499287365954afcc86f08840f1a04600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk0OTQ5Ng==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560949496", "bodyText": "As above in case of FormsProvider", "author": "grzesiek2010", "createdAt": "2021-01-20T13:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYwODIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxMjk2NA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560612964", "bodyText": "This seems unnecessary and likely to fail. It should be possible to use FileProvider#getType.", "author": "lognaturel", "createdAt": "2021-01-20T01:30:15Z", "path": "collect_app/src/main/java/org/odk/collect/android/utilities/MediaUtils.java", "diffHunk": "@@ -82,362 +60,8 @@ public void openFile(Context context, File file) {\n         }\n     }\n \n-    public String getMimeType(String url) {\n+    private String getMimeType(String url) {", "originalCommit": "32734194499287365954afcc86f08840f1a04600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk5MDM4MQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560990381", "bodyText": "Done.", "author": "grzesiek2010", "createdAt": "2021-01-20T14:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxMjk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTIzMTI4NQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561231285", "bodyText": "I'm rolling back this. I tested that way and it doesn't work in all cases but the old one does at leas for the cases I tested. Oh Android you are so funny!\nI added some fallbacks just in case like in getFileExtensionFromUri() above.", "author": "grzesiek2010", "createdAt": "2021-01-20T19:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxMjk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560617277", "bodyText": "FormSaveViewModel.createAnswerFile returns a LiveData<Result<String>> used to set the data from a file name. Have you tried this change with internal recording?", "author": "lognaturel", "createdAt": "2021-01-20T01:43:20Z", "path": "collect_app/src/main/java/org/odk/collect/android/widgets/AudioWidget.java", "diffHunk": "@@ -144,40 +144,25 @@ public IAnswerData getAnswer() {\n         }\n     }\n \n-    /**", "originalCommit": "32734194499287365954afcc86f08840f1a04600", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk2NTkwNQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r560965905", "bodyText": "I tested the demo form with internal recording and everything seems fine.", "author": "grzesiek2010", "createdAt": "2021-01-20T13:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEzMjk5OQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561132999", "bodyText": "Interesting! @seadowg, would be good for you to at least see this change happening since it's to very recent audio code.", "author": "lognaturel", "createdAt": "2021-01-20T17:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTczMDYyNQ==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r561730625", "bodyText": "Looks like @lognaturel is right as AudioRecordingTest and AudioWidgetTest are failing. From debugging, it looks like AudioWidget#setData is still passed a String.", "author": "seadowg", "createdAt": "2021-01-21T09:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMzA0Nw==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562023047", "bodyText": "Do you remember whether there was a specific reason you wanted to use a String, @seadowg? Looks like using a LiveData<Result<File>> works fine but want to make sure there isn't a strong reason against it.", "author": "lognaturel", "createdAt": "2021-01-21T16:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyOTEzNg==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562029136", "bodyText": "Yeah I have just turned it into files so please answer if there was any reason.", "author": "grzesiek2010", "createdAt": "2021-01-21T16:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA2MzQ2Nw==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562063467", "bodyText": "I don't think it needs to be a String. It was just because it didn't need to be a file as the the other side could just use getAnswerFile with the name (the String) to access the actual file. I think if File is more consistent we can go with that!", "author": "seadowg", "createdAt": "2021-01-21T17:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxNzI3Nw=="}], "type": "inlineReview"}, {"oid": "0c1ff84374c4ca7dc7c83067cea384473fcb1767", "url": "https://github.com/getodk/collect/commit/0c1ff84374c4ca7dc7c83067cea384473fcb1767", "message": "Protect the app from crashes when ContentProviders are used from external apps", "committedDate": "2021-01-20T13:11:08Z", "type": "commit"}, {"oid": "0c1ff84374c4ca7dc7c83067cea384473fcb1767", "url": "https://github.com/getodk/collect/commit/0c1ff84374c4ca7dc7c83067cea384473fcb1767", "message": "Protect the app from crashes when ContentProviders are used from external apps", "committedDate": "2021-01-20T13:11:08Z", "type": "forcePushed"}, {"oid": "484d006515792d6d64664ebdfb4c86cb73167029", "url": "https://github.com/getodk/collect/commit/484d006515792d6d64664ebdfb4c86cb73167029", "message": "Fixed getMimeType() method", "committedDate": "2021-01-20T13:52:16Z", "type": "commit"}, {"oid": "692c702cac3b5575ff4446b34468397bf642ae77", "url": "https://github.com/getodk/collect/commit/692c702cac3b5575ff4446b34468397bf642ae77", "message": "Removed unused methods from FileUtil class", "committedDate": "2021-01-20T13:53:57Z", "type": "commit"}, {"oid": "17f71d23762d4e3d2b5b4c03d9851dc4fea95f21", "url": "https://github.com/getodk/collect/commit/17f71d23762d4e3d2b5b4c03d9851dc4fea95f21", "message": "Fixed bugs", "committedDate": "2021-01-20T14:09:54Z", "type": "commit"}, {"oid": "094c81c742d4a21dda05fa1d58a995b8ad1a3701", "url": "https://github.com/getodk/collect/commit/094c81c742d4a21dda05fa1d58a995b8ad1a3701", "message": "Improved VideoWidget and opening files", "committedDate": "2021-01-20T14:31:59Z", "type": "commit"}, {"oid": "e3e436ed0fdfc9ece9fa63bd101e6db400786b97", "url": "https://github.com/getodk/collect/commit/e3e436ed0fdfc9ece9fa63bd101e6db400786b97", "message": "Improved getFileExtensionFromUri() method", "committedDate": "2021-01-20T18:49:34Z", "type": "commit"}, {"oid": "9acae2277aea888be2c36d8775e56d601a9d1dcf", "url": "https://github.com/getodk/collect/commit/9acae2277aea888be2c36d8775e56d601a9d1dcf", "message": "Fixed bug in MediaUtils#openFile() method", "committedDate": "2021-01-20T19:09:48Z", "type": "commit"}, {"oid": "9acae2277aea888be2c36d8775e56d601a9d1dcf", "url": "https://github.com/getodk/collect/commit/9acae2277aea888be2c36d8775e56d601a9d1dcf", "message": "Fixed bug in MediaUtils#openFile() method", "committedDate": "2021-01-20T19:09:48Z", "type": "forcePushed"}, {"oid": "4a62f094a2da89faaae0c9a9e8fbb9896b4f0822", "url": "https://github.com/getodk/collect/commit/4a62f094a2da89faaae0c9a9e8fbb9896b4f0822", "message": "Improved getFileExtensionFromUri() method", "committedDate": "2021-01-20T19:20:58Z", "type": "commit"}, {"oid": "f702b0b7cd82a52749a028dfe3043b6c22127b25", "url": "https://github.com/getodk/collect/commit/f702b0b7cd82a52749a028dfe3043b6c22127b25", "message": "Fixed getMimeType()", "committedDate": "2021-01-20T19:43:45Z", "type": "forcePushed"}, {"oid": "768b62b9fdbc193a4212726bd5ff682dfdb48289", "url": "https://github.com/getodk/collect/commit/768b62b9fdbc193a4212726bd5ff682dfdb48289", "message": "Fixed getMimeType()", "committedDate": "2021-01-21T10:37:04Z", "type": "commit"}, {"oid": "333fc9fec7e0f73a1f7dfd5590a454b9f47dbcf6", "url": "https://github.com/getodk/collect/commit/333fc9fec7e0f73a1f7dfd5590a454b9f47dbcf6", "message": "Fixed pmd", "committedDate": "2021-01-21T10:42:25Z", "type": "commit"}, {"oid": "0d66f2240fcd39f9babec8d0e6b71801e969cb2f", "url": "https://github.com/getodk/collect/commit/0d66f2240fcd39f9babec8d0e6b71801e969cb2f", "message": "Improved saveAnswerFileFromUri method", "committedDate": "2021-01-21T11:10:28Z", "type": "commit"}, {"oid": "889404636a05331d9d83d1dff5ffca97411ecb77", "url": "https://github.com/getodk/collect/commit/889404636a05331d9d83d1dff5ffca97411ecb77", "message": "Improved getFileExtensionFromUri() methdo", "committedDate": "2021-01-21T11:11:54Z", "type": "commit"}, {"oid": "ecbf1d5a1754de75064fd83d115911308a7619ee", "url": "https://github.com/getodk/collect/commit/ecbf1d5a1754de75064fd83d115911308a7619ee", "message": "Fixed pmd", "committedDate": "2021-01-21T11:14:20Z", "type": "commit"}, {"oid": "ecbf1d5a1754de75064fd83d115911308a7619ee", "url": "https://github.com/getodk/collect/commit/ecbf1d5a1754de75064fd83d115911308a7619ee", "message": "Fixed pmd", "committedDate": "2021-01-21T11:14:20Z", "type": "forcePushed"}, {"oid": "08e3c9ed26a0d2ff17017c7d045d72c70c4faf27", "url": "https://github.com/getodk/collect/commit/08e3c9ed26a0d2ff17017c7d045d72c70c4faf27", "message": "Fixed ArbitraryFileWidgetTest", "committedDate": "2021-01-21T12:30:32Z", "type": "commit"}, {"oid": "c6f335cfcddabc0576ae0e67286e87ff11d087d3", "url": "https://github.com/getodk/collect/commit/c6f335cfcddabc0576ae0e67286e87ff11d087d3", "message": "Fixed VideoWidgetTest", "committedDate": "2021-01-21T13:19:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMTM5Ng==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562021396", "bodyText": "Wouldn't we always be dealing with content URIs here? In what cases would we have file URIs?", "author": "lognaturel", "createdAt": "2021-01-21T16:30:51Z", "path": "collect_app/src/main/java/org/odk/collect/android/dao/helpers/ContentResolverHelper.java", "diffHunk": "@@ -76,20 +79,43 @@ public static String getFormPath(Uri uri) {\n         return formPath;\n     }\n \n-    /**\n-     * Using contentResolver to get a file's extension by the uri\n-     *\n-     * @param fileUri Whose name we want to get\n-     * @return The file's extension without a dot eg. \"mp3\" not \".mp3\"\n-     */\n-    public static String getFileExtensionFromUri(Context context, Uri fileUri) {\n-        String fileName = new MediaUtils().getFileNameFromUri(context, fileUri);\n-        if (fileName != null && fileName.contains(\".\")) {\n-            return fileName.substring(fileName.lastIndexOf('.') + 1);\n-        } else {\n-            return fileUri.getScheme() != null && fileUri.getScheme().equals(ContentResolver.SCHEME_CONTENT)\n-                    ? MimeTypeMap.getSingleton().getExtensionFromMimeType(context.getContentResolver().getType(fileUri))\n-                    : MimeTypeMap.getFileExtensionFromUrl(fileUri.toString());\n+    public static String getFileExtensionFromUri(Uri fileUri) {\n+        String mimeType = getContentResolver().getType(fileUri);\n+\n+        String extension = fileUri.getScheme() != null && fileUri.getScheme().equals(ContentResolver.SCHEME_CONTENT)", "originalCommit": "714a264d9334378dc499b51d8a9edbe836d97269", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMTc4MA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562021780", "bodyText": "Or was that the selfie video case again?", "author": "lognaturel", "createdAt": "2021-01-21T16:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMTM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA0MzcyMg==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562043722", "bodyText": "This was the fix added for a crash some time ago f98b98d so I wanted to keep it just in case seeing how other cases might be tricky.", "author": "grzesiek2010", "createdAt": "2021-01-21T16:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMTM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA2MzU0MA==", "url": "https://github.com/getodk/collect/pull/4297#discussion_r562063540", "bodyText": "Got it. Would be great to follow up with #2834 because this method has gone through lots of big changes during this PR that probably would have been avoided with tests.", "author": "lognaturel", "createdAt": "2021-01-21T17:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAyMTM5Ng=="}], "type": "inlineReview"}, {"oid": "d23c73d536891d04f8401d8b80fd12f735f25c9b", "url": "https://github.com/getodk/collect/commit/d23c73d536891d04f8401d8b80fd12f735f25c9b", "message": "Fixed AudioWidget", "committedDate": "2021-01-21T16:33:29Z", "type": "commit"}, {"oid": "d23c73d536891d04f8401d8b80fd12f735f25c9b", "url": "https://github.com/getodk/collect/commit/d23c73d536891d04f8401d8b80fd12f735f25c9b", "message": "Fixed AudioWidget", "committedDate": "2021-01-21T16:33:29Z", "type": "forcePushed"}, {"oid": "bdfce87fdfb29cf4b5343a312c9755b7a3d036f7", "url": "https://github.com/getodk/collect/commit/bdfce87fdfb29cf4b5343a312c9755b7a3d036f7", "message": "Check Uri permission before accesing it", "committedDate": "2021-01-25T12:53:29Z", "type": "commit"}, {"oid": "57909eb117e74aa77a3a0937aec068bfe9359975", "url": "https://github.com/getodk/collect/commit/57909eb117e74aa77a3a0937aec068bfe9359975", "message": "Check Uri permission before accesing it in ODKView", "committedDate": "2021-01-25T13:05:55Z", "type": "commit"}, {"oid": "cb1a1a616e8e59202c988f179a1f02e8aa3cb1bf", "url": "https://github.com/getodk/collect/commit/cb1a1a616e8e59202c988f179a1f02e8aa3cb1bf", "message": "Improved tests for intent group", "committedDate": "2021-01-25T13:12:02Z", "type": "commit"}, {"oid": "7f9a90a485292516c13cf0213f243419d993e396", "url": "https://github.com/getodk/collect/commit/7f9a90a485292516c13cf0213f243419d993e396", "message": "Moved the new message about not granted file permission to strings", "committedDate": "2021-01-25T13:17:03Z", "type": "commit"}, {"oid": "8ace0bfad0a015240e4ff7b820a511610a040e96", "url": "https://github.com/getodk/collect/commit/8ace0bfad0a015240e4ff7b820a511610a040e96", "message": "Added tests to PermissionsProviderTest", "committedDate": "2021-01-25T13:23:04Z", "type": "commit"}, {"oid": "67b416cd70c356723dfb34e14c07109ceb4ad5ea", "url": "https://github.com/getodk/collect/commit/67b416cd70c356723dfb34e14c07109ceb4ad5ea", "message": "Improved isReadUriPermissionGranted() method", "committedDate": "2021-01-26T12:22:39Z", "type": "forcePushed"}, {"oid": "bb23041a24e96e57c6f8b331a0a91ca3220f167b", "url": "https://github.com/getodk/collect/commit/bb23041a24e96e57c6f8b331a0a91ca3220f167b", "message": "Improved isReadUriPermissionGranted() method", "committedDate": "2021-01-26T12:50:15Z", "type": "commit"}, {"oid": "bb23041a24e96e57c6f8b331a0a91ca3220f167b", "url": "https://github.com/getodk/collect/commit/bb23041a24e96e57c6f8b331a0a91ca3220f167b", "message": "Improved isReadUriPermissionGranted() method", "committedDate": "2021-01-26T12:50:15Z", "type": "forcePushed"}]}