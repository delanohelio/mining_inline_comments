{"pr_number": 3645, "pr_title": "Define new Widget \"framework\"", "pr_createdAt": "2020-02-18T17:02:48Z", "pr_url": "https://github.com/getodk/collect/pull/3645", "timeline": [{"oid": "2be7c8b1a8e375cd9c89c24c45a5dd0821fbebc6", "url": "https://github.com/getodk/collect/commit/2be7c8b1a8e375cd9c89c24c45a5dd0821fbebc6", "message": "Revise TriggerWidgetTest", "committedDate": "2020-02-19T10:53:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI3NTc1NQ==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r381275755", "bodyText": "I've chosen to not extend the QuestionWidgetTest. From looking at a lot of our tests, although this pattern initially makes sense to me, it seems we run into problems with widgets having different behaviours for some of the common methods. I thought trying to build out helpers QuestionWidgetHelpers would be a more flexible approach - make the tests easy to write rather than making the tests hard to change.\nAdditionally it feels like the hierarchical nature of the widgets has only really caused problems (unpicking StringWidget common code for example) and I think using test extension here feeds into that problem as well.\nInterested to see what others think of this however!", "author": "seadowg", "createdAt": "2020-02-19T13:03:00Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/TriggerWidgetTest.java", "diffHunk": "@@ -1,67 +1,98 @@\n package org.odk.collect.android.widgets;\n \n-import androidx.annotation.NonNull;\n-\n import android.view.View;\n import android.widget.CheckBox;\n \n-import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNull;\n-import static org.junit.Assert.assertTrue;\n-import static org.mockito.Mockito.when;\n-\n-/**\n- * @author James Knight\n- */\n-\n-public class TriggerWidgetTest extends QuestionWidgetTest<TriggerWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public TriggerWidget createWidget() {\n-        return new TriggerWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.verify;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class TriggerWidgetTest {", "originalCommit": "d314e5aba5ba6d3eb86acf12203213d4c9da9577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1ODM5NA==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r385258394", "bodyText": "On one hand it's too bad that we'll end up with a bunch of trivial duplicated tests. But on the other they're really easy to write and there is value to having each widget considered independently so that they can more easily be refactored to suit their specific needs as you say. We just have to be careful to make sure all the same edge cases are considered.", "author": "lognaturel", "createdAt": "2020-02-27T17:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI3NTc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjIyMQ==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r385252221", "bodyText": "Huh, I didn't know this was possible. I guess this makes the resulting form entry prompt more of a spy.", "author": "lognaturel", "createdAt": "2020-02-27T17:16:14Z", "path": "collect_app/src/test/java/org/odk/collect/android/support/MockFormEntryPromptBuilder.java", "diffHunk": "@@ -91,4 +91,11 @@ public MockFormEntryPromptBuilder withAnswerDisplayText(String text) {\n \n         return this;\n     }\n+\n+    public MockFormEntryPromptBuilder withAnswer(IAnswerData answer) {\n+        when(prompt.getAnswerValue()).thenReturn(answer);\n+        when(prompt.getAnswerText()).thenCallRealMethod();", "originalCommit": "427718ee410a5db4d8b8170b2405c058bb716c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2MzU3Nw==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r385263577", "bodyText": "Yeah I'm not a fan of this. Ideally this would just setup a real FormEntryPrompt but it's really hard to build one. The getAnswerText method definitely feels like a \"decorator\" that shouldn't really be on the FormEntryPrompt as well.", "author": "seadowg", "createdAt": "2020-02-27T17:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI1MjIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2MTEyMw==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r385261123", "bodyText": "This makes me so angry. Why \"OK\"?! Everything about this trigger widget is objectionable starting from the fact that trigger is a well-defined concept in W3C XForms and that this is something else entirely.\nNo action to take, just venting. \ud83d\ude3e", "author": "lognaturel", "createdAt": "2020-02-27T17:30:33Z", "path": "collect_app/src/test/java/org/odk/collect/android/widgets/TriggerWidgetTest.java", "diffHunk": "@@ -1,67 +1,98 @@\n package org.odk.collect.android.widgets;\n \n-import androidx.annotation.NonNull;\n-\n import android.view.View;\n import android.widget.CheckBox;\n \n-import org.javarosa.core.model.data.IAnswerData;\n import org.javarosa.core.model.data.StringData;\n+import org.javarosa.form.api.FormEntryPrompt;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n import org.odk.collect.android.formentry.questions.QuestionDetails;\n-import org.odk.collect.android.widgets.base.QuestionWidgetTest;\n+import org.odk.collect.android.listeners.WidgetValueChangedListener;\n+import org.robolectric.RobolectricTestRunner;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.is;\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNull;\n-import static org.junit.Assert.assertTrue;\n-import static org.mockito.Mockito.when;\n-\n-/**\n- * @author James Knight\n- */\n-\n-public class TriggerWidgetTest extends QuestionWidgetTest<TriggerWidget, StringData> {\n-    @NonNull\n-    @Override\n-    public TriggerWidget createWidget() {\n-        return new TriggerWidget(activity, new QuestionDetails(formEntryPrompt, \"formAnalyticsID\"));\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.verify;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.mockValueChangedListener;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithAnswer;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.promptWithReadOnly;\n+import static org.odk.collect.android.widgets.support.QuestionWidgetHelpers.widgetTestActivity;\n+\n+@RunWith(RobolectricTestRunner.class)\n+public class TriggerWidgetTest {\n+\n+    @Test\n+    public void getAnswer_whenPromptAnswerDoesNotHaveAnswer_returnsNull() {\n+        assertThat(createWidget(promptWithAnswer(null)).getAnswer(), nullValue());\n+    }\n+\n+    @Test\n+    public void getAnswer_whenPromptHasAnswer_returnsAnswer() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(new StringData(\"OK\")));\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"OK\"));\n+    }\n+\n+    @Test\n+    public void clearAnswer_clearsWidgetAnswer() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(new StringData(\"OK\")));\n+\n+        widget.clearAnswer();\n+        assertThat(widget.getAnswer(), nullValue());\n     }\n \n-    @NonNull\n-    @Override\n-    public StringData getNextAnswer() {\n-        return new StringData(TriggerWidget.OK_TEXT);\n+    @Test\n+    public void clearAnswer_callsValueChangeListeners() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(null));\n+        WidgetValueChangedListener valueChangedListener = mockValueChangedListener(widget);\n+\n+        widget.clearAnswer();\n+        verify(valueChangedListener).widgetValueChanged(widget);\n     }\n \n-    @Override\n-    public void getAnswerShouldReturnExistingAnswerIfPromptHasExistingAnswer() {\n-        super.getAnswerShouldReturnExistingAnswerIfPromptHasExistingAnswer();\n-        assertTrue(getWidget().getTriggerButton().isChecked());\n+    @Test\n+    public void usingReadOnlyOption_makesAllClickableElementsDisabled() {\n+        TriggerWidget widget = createWidget(promptWithReadOnly());\n+        assertThat(widget.getCheckBox().getVisibility(), equalTo(View.VISIBLE));\n+        assertThat(widget.getCheckBox().isEnabled(), equalTo(Boolean.FALSE));\n     }\n \n     @Test\n-    public void checkingTheTriggerBoxShouldSetTheAnswer() {\n-        TriggerWidget widget = getWidget();\n-        assertNull(widget.getAnswer());\n+    public void whenPromptAnswerDoesNotHaveAnswer_checkboxIsUnchecked() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(null));\n+        assertThat(widget.getCheckBox().isChecked(), equalTo(false));\n+    }\n \n-        CheckBox triggerButton = widget.getTriggerButton();\n-        assertFalse(triggerButton.isChecked());\n+    @Test\n+    public void whenPromptHasAnswer_checkboxIsChecked() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(new StringData(\"OK\")));\n+        assertThat(widget.getCheckBox().isChecked(), equalTo(true));\n+    }\n+\n+    @Test\n+    public void checkingCheckbox_setsAnswer() {\n+        TriggerWidget widget = createWidget(promptWithAnswer(null));\n+        CheckBox triggerButton = widget.getCheckBox();\n \n         triggerButton.setChecked(true);\n-        triggerButton.callOnClick();\n+        assertThat(widget.getAnswer().getDisplayText(), equalTo(\"OK\"));", "originalCommit": "427718ee410a5db4d8b8170b2405c058bb716c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2MzkwMA==", "url": "https://github.com/getodk/collect/pull/3645#discussion_r385263900", "bodyText": "\ud83d\udd25", "author": "seadowg", "createdAt": "2020-02-27T17:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2MTEyMw=="}], "type": "inlineReview"}, {"oid": "bc860ec31669a129812cf0b8c4b22552025a42bd", "url": "https://github.com/getodk/collect/commit/bc860ec31669a129812cf0b8c4b22552025a42bd", "message": "Use onCreateAnswerView in trigger widget", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "d9c460337ffb719d65393b1fd7bfa33a086b740b", "url": "https://github.com/getodk/collect/commit/d9c460337ffb719d65393b1fd7bfa33a086b740b", "message": "Add docs for widgets", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "e694ab6ca51776c8881dde78fea1445608ae1631", "url": "https://github.com/getodk/collect/commit/e694ab6ca51776c8881dde78fea1445608ae1631", "message": "Link to widget docs", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "91898b53d03a29b315ffd66554995b52a5a743c9", "url": "https://github.com/getodk/collect/commit/91898b53d03a29b315ffd66554995b52a5a743c9", "message": "Update comments in QuestionWidget", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "9f4c5daf32775283ce74de8e8d2a405e2185b816", "url": "https://github.com/getodk/collect/commit/9f4c5daf32775283ce74de8e8d2a405e2185b816", "message": "Add note about questions to STATE.md", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "2ac110a99e4c0c82714156505bb91bb732c165ea", "url": "https://github.com/getodk/collect/commit/2ac110a99e4c0c82714156505bb91bb732c165ea", "message": "Correct typos", "committedDate": "2020-02-27T17:40:14Z", "type": "commit"}, {"oid": "b8ef79552dcf1909b4e7505e040d4472fc8cbf8e", "url": "https://github.com/getodk/collect/commit/b8ef79552dcf1909b4e7505e040d4472fc8cbf8e", "message": "Revise TriggerWidgetTest", "committedDate": "2020-02-27T17:40:15Z", "type": "commit"}, {"oid": "99660c99a36fa4572ba65f8675ecf42737192a63", "url": "https://github.com/getodk/collect/commit/99660c99a36fa4572ba65f8675ecf42737192a63", "message": "Add widget testing docs", "committedDate": "2020-02-27T17:40:15Z", "type": "commit"}, {"oid": "5d79f038fb65307bcc19c184f721f5987aa59a46", "url": "https://github.com/getodk/collect/commit/5d79f038fb65307bcc19c184f721f5987aa59a46", "message": "Correct widget helper name", "committedDate": "2020-02-27T17:40:15Z", "type": "commit"}, {"oid": "a3f5b64219679d7e46be768de609d80d865727bb", "url": "https://github.com/getodk/collect/commit/a3f5b64219679d7e46be768de609d80d865727bb", "message": "Fix trigger widget for API 21 min", "committedDate": "2020-02-28T09:14:30Z", "type": "commit"}, {"oid": "a3f5b64219679d7e46be768de609d80d865727bb", "url": "https://github.com/getodk/collect/commit/a3f5b64219679d7e46be768de609d80d865727bb", "message": "Fix trigger widget for API 21 min", "committedDate": "2020-02-28T09:14:30Z", "type": "forcePushed"}]}