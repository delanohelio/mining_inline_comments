{"pr_number": 2638, "pr_title": "1876 infinite loop fix ", "pr_createdAt": "2020-02-24T15:34:52Z", "pr_url": "https://github.com/odpi/egeria/pull/2638", "timeline": [{"oid": "2f59feefa4563f615206695d9aeb3b93da1af5a2", "url": "https://github.com/odpi/egeria/commit/2f59feefa4563f615206695d9aeb3b93da1af5a2", "message": "merge conflicts\n\nSigned-off-by: William Bittles <wbittles@uk.ibm.com>", "committedDate": "2020-02-24T15:54:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3OTQxNg==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r383379416", "bodyText": "Though this occurs at shutdown, could it occur in other situations too?\nFor example another thread could use wakeup() against this thread - though I think we do?\nI'm wondering if we should pause and retry ... though at shutdown I'd be concerned we wait too long\nIf we really only think wakeup will be at shutdown then this handling is ok-ish, but it's one route out of the method where we don't log an audit message at all, which probably would be desirable?", "author": "planetf1", "createdAt": "2020-02-24T16:41:09Z", "path": "open-metadata-implementation/adapters/open-connectors/event-bus-connectors/open-metadata-topic-connectors/kafka-open-metadata-topic-connector/src/main/java/org/odpi/openmetadata/adapters/eventbus/topic/kafka/KafkaOpenMetadataEventProducer.java", "diffHunk": "@@ -97,58 +96,97 @@ private void publishEvent(String event) throws ConnectorCheckedException\n     {\n         final String methodName = \"publishEvent\";\n \n-        try\n-        {\n-            log.debug(\"Sending message {0}\" + event);\n-            ProducerRecord<String, String> record = new ProducerRecord<>(topicName, localServerId, event);\n-            producer.send(record).get();\n-            messageSendCount++;\n-        }\n-        catch (ExecutionException | CancellationException | InterruptedException error)\n-        {\n-        /*\n-         * Issue #1876 moved the retry logic into the kafka producer\n-         */\n-            log.debug(\"Kafka had trouble sending event: \" + event + \"exception message is \" + error.getMessage());\n-            KafkaOpenMetadataTopicConnectorAuditCode auditCode;\n-            auditCode = KafkaOpenMetadataTopicConnectorAuditCode.EVENT_SEND_IN_ERROR_LOOP;\n-            auditLog.logRecord(methodName,\n-                              auditCode.getLogMessageId(),\n-                              auditCode.getSeverity(),\n-                              auditCode.getFormattedLogMessage(topicName,\n-                                                                Long.toString(messageSendCount),\n-                                                                Long.toString(this.getSendBufferSize()),\n-                                                                error.getMessage()),\n-                                                                null,\n-                                                                auditCode.getSystemAction(),\n-                                                                auditCode.getUserAction());\n-        }\n-        catch (WakeupException error)\n-        {\n-            log.error(\"Wake up for shut down \" + error.toString());\n-        }\n-        catch (Throwable error)\n-        {\n-            log.error(\"Exception in sendEvent \" + error.toString());\n-            KafkaOpenMetadataTopicConnectorErrorCode errorCode = KafkaOpenMetadataTopicConnectorErrorCode.ERROR_SENDING_EVENT;\n-            String errorMessage = errorCode.getErrorMessageId() + errorCode.getFormattedErrorMessage(error.getClass().getName(),\n-                                                                                                     topicName,\n-                                                                                                     error.getMessage());\n-\n-            throw new ConnectorCheckedException(errorCode.getHTTPErrorCode(),\n-                                                this.getClass().getName(),\n-                                                methodName,\n-                                                errorMessage,\n-                                                errorCode.getSystemAction(),\n-                                                errorCode.getUserAction(),\n-                                                error);\n-        }\n-        finally\n+        boolean                  eventSent = false;\n+        long                     eventRetryCount = 0;\n+\n+        while (!eventSent)\n         {\n-            /*\n-             * Producers have a thread and an in memory buffer\n-             */\n-            producer.flush();\n+            try\n+            {\n+                log.debug(\"Sending message {0}\" + event);\n+                ProducerRecord<String, String> record = new ProducerRecord<>(topicName, localServerId, event);\n+                producer.send(record).get();\n+                eventSent = true;\n+                messageSendCount++;\n+            }\n+            catch (ExecutionException error)\n+            {\n+                /*\n+                 * This may be a simple timeout or something else more\n+                 */\n+                log.debug(\"Kafka had trouble sending event: \" + event + \"exception message is \" + error.getMessage());\n+\n+                if( !isExceptionRetryable(error)) {\n+                    /* kafka thinks this isn't a retryable problem */\n+                    /* so let the caller try */\n+                    log.error(\"Exception in sendEvent \" + error.toString());\n+                    KafkaOpenMetadataTopicConnectorErrorCode errorCode = KafkaOpenMetadataTopicConnectorErrorCode.ERROR_SENDING_EVENT;\n+                    String errorMessage = errorCode.getErrorMessageId() + errorCode.getFormattedErrorMessage(error.getClass().getName(),\n+                            topicName,\n+                            error.getMessage());\n+\n+                    throw new ConnectorCheckedException(errorCode.getHTTPErrorCode(),\n+                            this.getClass().getName(),\n+                            methodName,\n+                            errorMessage,\n+                            errorCode.getSystemAction(),\n+                            errorCode.getUserAction(),\n+                            error);\n+                }\n+                if (eventRetryCount == 10)\n+                {\n+                    /* we've retried now let the caller retry */\n+                    break;\n+                }\n+                else\n+                {\n+                    if (eventRetryCount == 0)\n+                    {\n+                        KafkaOpenMetadataTopicConnectorAuditCode auditCode;\n+\n+                        auditCode = KafkaOpenMetadataTopicConnectorAuditCode.EVENT_SEND_IN_ERROR_LOOP;\n+                        auditLog.logRecord(methodName,\n+                                           auditCode.getLogMessageId(),\n+                                           auditCode.getSeverity(),\n+                                           auditCode.getFormattedLogMessage(topicName,\n+                                                                            Long.toString(messageSendCount),\n+                                                                            Long.toString(this.getSendBufferSize()),\n+                                                                            error.getMessage()),\n+                                           null,\n+                                           auditCode.getSystemAction(),\n+                                           auditCode.getUserAction());\n+                    }\n+\n+                    eventRetryCount++;\n+                }\n+            }\n+            catch (WakeupException error)", "originalCommit": "2f59feefa4563f615206695d9aeb3b93da1af5a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwMjc1NQ==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r383902755", "bodyText": "@planetf1 This code is actually original code that was removed as part of this first attempt to fix this issue. I put the behaviour back after getting feedback on the first fix. There is nothing the producer is doing that would cause kafka to throw this.", "author": "wbittles", "createdAt": "2020-02-25T14:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3OTQxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MDk0OQ==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r387690949", "bodyText": "Good to stick with this for our immediate kafka fix - can consider revisiting with a new connector implementation", "author": "planetf1", "createdAt": "2020-03-04T14:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3OTQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MTgzMg==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r383381832", "bodyText": "I noticed in this method we are using time in 2 different units - around line 39. Seconds for recoverytime, milliseconds for regular sleep time. though handled correctly would be better to use consistent units?", "author": "planetf1", "createdAt": "2020-02-24T16:45:13Z", "path": "open-metadata-implementation/adapters/open-connectors/event-bus-connectors/open-metadata-topic-connectors/kafka-open-metadata-topic-connector/src/main/java/org/odpi/openmetadata/adapters/eventbus/topic/kafka/KafkaOpenMetadataEventProducer.java", "diffHunk": "@@ -206,11 +244,19 @@ public void run()\n             catch (Throwable   error)\n             {\n                 log.error(\"Bad exception from sending events \" + error.getMessage());\n-                this.recoverAfterError();\n+\n+                if( isExceptionRetryable(error) ) {\n+                    this.recoverAfterError();", "originalCommit": "2f59feefa4563f615206695d9aeb3b93da1af5a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwMzM0NA==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r383903344", "bodyText": "@planetf1 again this code was there , but I'm happy to change it if Mandy agrees.", "author": "wbittles", "createdAt": "2020-02-25T14:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MTgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MTIwNg==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r387691206", "bodyText": "Good to stick with this for our immediate kafka fix - can consider revisiting with a new connector implementation", "author": "planetf1", "createdAt": "2020-03-04T14:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4NDQxMA==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r383384410", "bodyText": "I notice the text for this event says the message isn't sent. True in terms of this connector's responsibility, but if queueing occurs further up the stack the message is confusing to the audit log reviewer", "author": "planetf1", "createdAt": "2020-02-24T16:49:13Z", "path": "open-metadata-implementation/adapters/open-connectors/event-bus-connectors/open-metadata-topic-connectors/kafka-open-metadata-topic-connector/src/main/java/org/odpi/openmetadata/adapters/eventbus/topic/kafka/KafkaOpenMetadataEventProducer.java", "diffHunk": "@@ -97,58 +96,97 @@ private void publishEvent(String event) throws ConnectorCheckedException\n     {\n         final String methodName = \"publishEvent\";\n \n-        try\n-        {\n-            log.debug(\"Sending message {0}\" + event);\n-            ProducerRecord<String, String> record = new ProducerRecord<>(topicName, localServerId, event);\n-            producer.send(record).get();\n-            messageSendCount++;\n-        }\n-        catch (ExecutionException | CancellationException | InterruptedException error)\n-        {\n-        /*\n-         * Issue #1876 moved the retry logic into the kafka producer\n-         */\n-            log.debug(\"Kafka had trouble sending event: \" + event + \"exception message is \" + error.getMessage());\n-            KafkaOpenMetadataTopicConnectorAuditCode auditCode;\n-            auditCode = KafkaOpenMetadataTopicConnectorAuditCode.EVENT_SEND_IN_ERROR_LOOP;\n-            auditLog.logRecord(methodName,\n-                              auditCode.getLogMessageId(),\n-                              auditCode.getSeverity(),\n-                              auditCode.getFormattedLogMessage(topicName,\n-                                                                Long.toString(messageSendCount),\n-                                                                Long.toString(this.getSendBufferSize()),\n-                                                                error.getMessage()),\n-                                                                null,\n-                                                                auditCode.getSystemAction(),\n-                                                                auditCode.getUserAction());\n-        }\n-        catch (WakeupException error)\n-        {\n-            log.error(\"Wake up for shut down \" + error.toString());\n-        }\n-        catch (Throwable error)\n-        {\n-            log.error(\"Exception in sendEvent \" + error.toString());\n-            KafkaOpenMetadataTopicConnectorErrorCode errorCode = KafkaOpenMetadataTopicConnectorErrorCode.ERROR_SENDING_EVENT;\n-            String errorMessage = errorCode.getErrorMessageId() + errorCode.getFormattedErrorMessage(error.getClass().getName(),\n-                                                                                                     topicName,\n-                                                                                                     error.getMessage());\n-\n-            throw new ConnectorCheckedException(errorCode.getHTTPErrorCode(),\n-                                                this.getClass().getName(),\n-                                                methodName,\n-                                                errorMessage,\n-                                                errorCode.getSystemAction(),\n-                                                errorCode.getUserAction(),\n-                                                error);\n-        }\n-        finally\n+        boolean                  eventSent = false;\n+        long                     eventRetryCount = 0;\n+\n+        while (!eventSent)\n         {\n-            /*\n-             * Producers have a thread and an in memory buffer\n-             */\n-            producer.flush();\n+            try\n+            {\n+                log.debug(\"Sending message {0}\" + event);\n+                ProducerRecord<String, String> record = new ProducerRecord<>(topicName, localServerId, event);\n+                producer.send(record).get();\n+                eventSent = true;\n+                messageSendCount++;\n+            }\n+            catch (ExecutionException error)\n+            {\n+                /*\n+                 * This may be a simple timeout or something else more\n+                 */\n+                log.debug(\"Kafka had trouble sending event: \" + event + \"exception message is \" + error.getMessage());\n+\n+                if( !isExceptionRetryable(error)) {\n+                    /* kafka thinks this isn't a retryable problem */\n+                    /* so let the caller try */\n+                    log.error(\"Exception in sendEvent \" + error.toString());\n+                    KafkaOpenMetadataTopicConnectorErrorCode errorCode = KafkaOpenMetadataTopicConnectorErrorCode.ERROR_SENDING_EVENT;", "originalCommit": "2f59feefa4563f615206695d9aeb3b93da1af5a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5MTA1OA==", "url": "https://github.com/odpi/egeria/pull/2638#discussion_r387691058", "bodyText": "Good to stick with this for our immediate kafka fix - can consider revisiting with a new connector implementation", "author": "planetf1", "createdAt": "2020-03-04T14:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4NDQxMA=="}], "type": "inlineReview"}, {"oid": "144aae98179f1f98836da5e834e83bcb286b006a", "url": "https://github.com/odpi/egeria/commit/144aae98179f1f98836da5e834e83bcb286b006a", "message": "merge conflicts\n\nSigned-off-by: William Bittles <wbittles@uk.ibm.com>", "committedDate": "2020-02-24T16:57:46Z", "type": "forcePushed"}, {"oid": "7fd18ccf1d528bc8c5aa33e4f3185a1d32d4ef9f", "url": "https://github.com/odpi/egeria/commit/7fd18ccf1d528bc8c5aa33e4f3185a1d32d4ef9f", "message": "Revert \"#1876 Fix issue of infinite loop\"\n\nThis reverts commit 0321cbd1c4062706bfb0349445b2640d48c6ae3c.\n\nSigned-off-by: William Bittles <wbittles@uk.ibm.com>", "committedDate": "2020-03-04T16:05:54Z", "type": "commit"}, {"oid": "2d4d873356c6a8e5f3c79466dd8c55a31e19a21b", "url": "https://github.com/odpi/egeria/commit/2d4d873356c6a8e5f3c79466dd8c55a31e19a21b", "message": "fix infinite loop while sending message #1876\n\nSigned-off-by: William Bittles <wbittles@uk.ibm.com>", "committedDate": "2020-03-04T16:09:25Z", "type": "commit"}, {"oid": "5d0711f6054fd254855c46dc7cff01d5485341cc", "url": "https://github.com/odpi/egeria/commit/5d0711f6054fd254855c46dc7cff01d5485341cc", "message": "Merge branch 'master' of https://github.com/odpi/egeria into it-infrastructure", "committedDate": "2020-03-04T16:19:52Z", "type": "commit"}, {"oid": "5d0711f6054fd254855c46dc7cff01d5485341cc", "url": "https://github.com/odpi/egeria/commit/5d0711f6054fd254855c46dc7cff01d5485341cc", "message": "Merge branch 'master' of https://github.com/odpi/egeria into it-infrastructure", "committedDate": "2020-03-04T16:19:52Z", "type": "forcePushed"}, {"oid": "b0082ef1b8a7e5d43f71be9fff059b02999bfe65", "url": "https://github.com/odpi/egeria/commit/b0082ef1b8a7e5d43f71be9fff059b02999bfe65", "message": "Merge branch 'master' into it-infrastructure", "committedDate": "2020-03-05T22:26:59Z", "type": "commit"}]}