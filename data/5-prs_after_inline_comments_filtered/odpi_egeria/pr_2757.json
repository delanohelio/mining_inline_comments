{"pr_number": 2757, "pr_title": "Governance Engine OMAS - Refactoring", "pr_createdAt": "2020-03-18T22:11:09Z", "pr_url": "https://github.com/odpi/egeria/pull/2757", "timeline": [{"oid": "901e3292281c899150046d336a4b25901695facf", "url": "https://github.com/odpi/egeria/commit/901e3292281c899150046d336a4b25901695facf", "message": "Governance Engine OMAS - Refactoring\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-17T21:57:52Z", "type": "commit"}, {"oid": "95accfbbf4d9c7b75fef5dc3817a46d22e02403b", "url": "https://github.com/odpi/egeria/commit/95accfbbf4d9c7b75fef5dc3817a46d22e02403b", "message": "Governance Engine OMAS - unit tests for spring module\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T18:53:23Z", "type": "commit"}, {"oid": "b69d8d00ddf6445b1210ac534949484e5dd3148b", "url": "https://github.com/odpi/egeria/commit/b69d8d00ddf6445b1210ac534949484e5dd3148b", "message": "Governance Engine OMAS - removed unused error codes\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T18:58:48Z", "type": "commit"}, {"oid": "5fdd24517b9e5c8a28913433febc02f2b469f251", "url": "https://github.com/odpi/egeria/commit/5fdd24517b9e5c8a28913433febc02f2b469f251", "message": "Governance Engine OMAS - renamaned the model pkt from api\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T19:08:09Z", "type": "commit"}, {"oid": "095eec930504a5d5a204a00dc03d4afcb47ec1f3", "url": "https://github.com/odpi/egeria/commit/095eec930504a5d5a204a00dc03d4afcb47ec1f3", "message": "Governance Engine OMAS - removed unused imported\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T19:08:42Z", "type": "commit"}, {"oid": "4cdee318f777a61c0762bf2a1a86902f85378c0a", "url": "https://github.com/odpi/egeria/commit/4cdee318f777a61c0762bf2a1a86902f85378c0a", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-18T19:09:58Z", "type": "commit"}, {"oid": "61d58a8eb640260ae2aaf61fb5354cf1abe94a5a", "url": "https://github.com/odpi/egeria/commit/61d58a8eb640260ae2aaf61fb5354cf1abe94a5a", "message": "Governance Engine OMAS - client tests\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T20:33:37Z", "type": "commit"}, {"oid": "10e29fb11370b8bc311249a6fffd40228e30b455", "url": "https://github.com/odpi/egeria/commit/10e29fb11370b8bc311249a6fffd40228e30b455", "message": "Governance Engine OMAS - server tests for rest\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T21:05:25Z", "type": "commit"}, {"oid": "c2af67b9655e75d85046cb0960e9a25b5b71f059", "url": "https://github.com/odpi/egeria/commit/c2af67b9655e75d85046cb0960e9a25b5b71f059", "message": "Governance Engine OMAS - pom updated\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T21:11:42Z", "type": "commit"}, {"oid": "1e1feecd3ba9c69338da90cd6be60c94b2d6fce5", "url": "https://github.com/odpi/egeria/commit/1e1feecd3ba9c69338da90cd6be60c94b2d6fce5", "message": "Governance Engine OMAS - test for server handler\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-18T22:08:06Z", "type": "commit"}, {"oid": "9641d3f7c66a2c4ddc4140dcdeb64f1e5235e50a", "url": "https://github.com/odpi/egeria/commit/9641d3f7c66a2c4ddc4140dcdeb64f1e5235e50a", "message": "Governance Engine OMAS - merged + conflict resolved\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-19T13:01:49Z", "type": "commit"}, {"oid": "500c66f7f0f3472b2a151d3530982bb3daec4bb5", "url": "https://github.com/odpi/egeria/commit/500c66f7f0f3472b2a151d3530982bb3daec4bb5", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-19T13:03:03Z", "type": "commit"}, {"oid": "a1b55de0ffbbdd863c79d414f81c28fb04b71adf", "url": "https://github.com/odpi/egeria/commit/a1b55de0ffbbdd863c79d414f81c28fb04b71adf", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-20T08:07:23Z", "type": "commit"}, {"oid": "fc1280aa8723353faa1885f7e4669aeea67dcb0b", "url": "https://github.com/odpi/egeria/commit/fc1280aa8723353faa1885f7e4669aeea67dcb0b", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-20T08:23:42Z", "type": "commit"}, {"oid": "3de75e654354257df2ddaf1ece12b566f70b00d7", "url": "https://github.com/odpi/egeria/commit/3de75e654354257df2ddaf1ece12b566f70b00d7", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-20T12:40:43Z", "type": "commit"}, {"oid": "3b4bcc9678c0e24c9cbef753c0bd6eb0423130cf", "url": "https://github.com/odpi/egeria/commit/3b4bcc9678c0e24c9cbef753c0bd6eb0423130cf", "message": "versions should only be in dependencyManagement in our top level pom - removed spring core version\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-20T12:42:37Z", "type": "commit"}, {"oid": "fc65f9f2079f5c455f11be12eaf296f75649694d", "url": "https://github.com/odpi/egeria/commit/fc65f9f2079f5c455f11be12eaf296f75649694d", "message": "Merge branch 'master' into ge-omas", "committedDate": "2020-03-20T13:02:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEzNTExOA==", "url": "https://github.com/odpi/egeria/pull/2757#discussion_r396135118", "bodyText": "debug log is OK but e Exception should be logged with error level or thrown", "author": "bogdan-sava", "createdAt": "2020-03-22T20:05:31Z", "path": "open-metadata-implementation/access-services/governance-engine/governance-engine-server/src/main/java/org/odpi/openmetadata/accessservices/governanceengine/server/publisher/GovernanceEnginePublisher.java", "diffHunk": "@@ -2,187 +2,49 @@\n /* Copyright Contributors to the ODPi Egeria project. */\n package org.odpi.openmetadata.accessservices.governanceengine.server.publisher;\n \n-import org.odpi.openmetadata.accessservices.governanceengine.server.processor.GovernanceEngineEventProcessor;\n-import org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.EntityDetail;\n-import org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.InstanceGraph;\n-import org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.InstanceProvenanceType;\n-import org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.instances.Relationship;\n-import org.odpi.openmetadata.repositoryservices.connectors.stores.metadatacollectionstore.properties.typedefs.TypeDefSummary;\n-import org.odpi.openmetadata.repositoryservices.events.OMRSInstanceEvent;\n-import org.odpi.openmetadata.repositoryservices.events.OMRSInstanceEventProcessor;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.EntityNotKnownException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.EntityProxyOnlyException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.FunctionNotSupportedException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.InvalidParameterException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.PagingErrorException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.PropertyErrorException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.RepositoryErrorException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.TypeDefNotKnownException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.TypeErrorException;\n-import org.odpi.openmetadata.repositoryservices.ffdc.exception.UserNotAuthorizedException;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.odpi.openmetadata.accessservices.governanceengine.api.events.GovernanceEngineEvent;\n+import org.odpi.openmetadata.frameworks.auditlog.AuditLog;\n+import org.odpi.openmetadata.frameworks.connectors.ffdc.ConnectorCheckedException;\n+import org.odpi.openmetadata.repositoryservices.connectors.openmetadatatopic.OpenMetadataTopicConnector;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n /**\n  * GovernanceEnginePublisher is responsible for publishing events about governed asset components .  It is called\n  * when an interesting OMRS Event is added to the Enterprise OMRS Topic.\n  */\n-public class GovernanceEnginePublisher extends OMRSInstanceEventProcessor {\n-\n-    private static final String eventPublisherName = \"Governance Engine OMAS Event Publisher\";\n+public class GovernanceEnginePublisher {\n \n     private static final Logger log = LoggerFactory.getLogger(GovernanceEnginePublisher.class);\n-    private GovernanceEngineEventProcessor governanceEngineEventProcessor;\n-\n-    public GovernanceEnginePublisher(GovernanceEngineEventProcessor governanceEngineEventProcessor) {\n-        super(eventPublisherName);\n-\n-        this.governanceEngineEventProcessor = governanceEngineEventProcessor;\n-    }\n-\n-    @Override\n-    public void sendInstanceEvent(String sourceName, OMRSInstanceEvent instanceEvent) {\n-    }\n-\n-    @Override\n-    public void processNewEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail entity) {\n-    }\n+    private OpenMetadataTopicConnector connector;\n+    private AuditLog auditLog;\n \n-    @Override\n-    public void processUpdatedEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail oldEntity, EntityDetail newEntity) {\n+    public GovernanceEnginePublisher(OpenMetadataTopicConnector openMetadataTopicConnector, AuditLog auditLog) {\n+        this.connector = openMetadataTopicConnector;\n+        this.auditLog = auditLog;\n     }\n \n-    @Override\n-    public void processUndoneEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail entity) {\n-    }\n-\n-    @Override\n-    public void processClassifiedEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail entity) {\n-        log.info(\"GE Process Classified Entity\");\n-\n-        try {\n-            governanceEngineEventProcessor.processClassifiedEntity(entity);\n-        } catch (RepositoryErrorException | EntityProxyOnlyException | InvalidParameterException | UserNotAuthorizedException | PagingErrorException | TypeDefNotKnownException | EntityNotKnownException | PropertyErrorException | FunctionNotSupportedException | TypeErrorException e) {\n-            log.debug(\"Governance Engine OMAS is unable to process a Classified Entity event\");\n-        }\n-    }\n-\n-    @Override\n-    public void processDeclassifiedEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail entity) {\n-        log.info(\"GE Process De-Classified Entity\");\n-\n+    public void publishEvent(GovernanceEngineEvent event) {\n         try {\n-            governanceEngineEventProcessor.processDeclassifiedEntityEvent(entity);\n-        } catch (EntityProxyOnlyException | RepositoryErrorException | InvalidParameterException | UserNotAuthorizedException | PagingErrorException | TypeDefNotKnownException | EntityNotKnownException | PropertyErrorException | FunctionNotSupportedException | TypeErrorException e) {\n-            log.debug(\"Governance Engine OMAS is unable to process Declassified Entity event\");\n+            connector.sendEvent(eventToString(event));\n+            log.info(\"[Governance Engine]event send\");\n+        } catch (ConnectorCheckedException e) {\n+            log.error(\"[Governance Engine] Unable to send event {}\", event);\n         }\n     }\n \n-    @Override\n-    public void processReclassifiedEntityEvent(String sourceName, String originatorMetadataCollectionId, String originatorServerName, String originatorServerType, String originatorOrganizationName, EntityDetail entity) {\n-        log.info(\"GE Process Re-Classified Entity\");\n+    private String eventToString(GovernanceEngineEvent engineEvent) {\n+        ObjectMapper mapper = new ObjectMapper();\n \n         try {\n-            governanceEngineEventProcessor.processReclassifiedEntity(entity);\n-        } catch (EntityProxyOnlyException | RepositoryErrorException | InvalidParameterException | UserNotAuthorizedException | PagingErrorException | TypeDefNotKnownException | EntityNotKnownException | PropertyErrorException | FunctionNotSupportedException | TypeErrorException e) {\n-            log.debug(\"Governance Engine OMAS is unable to process a Re-Classified Entity event\");\n+            return mapper.writeValueAsString(engineEvent);\n+        } catch (JsonProcessingException e) {\n+            log.debug(\"[Governance Engine] Unable to map the event {} to string.\", engineEvent);", "originalCommit": "fc65f9f2079f5c455f11be12eaf296f75649694d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEzNTQ4OA==", "url": "https://github.com/odpi/egeria/pull/2757#discussion_r396135488", "bodyText": "same here, exception should be logged with error level or thrown\ndebug message might  not be shown and is not very helpful without more info about request", "author": "bogdan-sava", "createdAt": "2020-03-22T20:09:33Z", "path": "open-metadata-implementation/governance-servers/security-sync-services/security-sync-services-server/src/main/java/org/odpi/openmetadata/securitysyncservices/processor/SecuritySyncEventProcessor.java", "diffHunk": "@@ -168,7 +168,7 @@ private GovernedAssetListAPIResponse getGovernedAssets() {\n         try {\n \n             ResponseEntity<String> result = restTemplate.exchange(governanceEngineURL, HttpMethod.GET, entity, String.class);\n-            return (GovernedAssetListAPIResponse) mapToObject(result, GovernedAssetListAPIResponse.class);\n+            return (GovernedAssetListResponse) mapToObject(result, GovernedAssetListResponse.class);\n         } catch (HttpStatusCodeException exception) {\n             log.debug(\"Unable to get the governed assets!\");", "originalCommit": "fc65f9f2079f5c455f11be12eaf296f75649694d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9329b39c947c39f5c7ec9bf0e437f08d59cbda5", "url": "https://github.com/odpi/egeria/commit/b9329b39c947c39f5c7ec9bf0e437f08d59cbda5", "message": "fix the error logging\n\nSigned-off-by: Daniela Otelea <daniela-valentina.otelea@ing.com>", "committedDate": "2020-03-22T21:58:15Z", "type": "commit"}]}