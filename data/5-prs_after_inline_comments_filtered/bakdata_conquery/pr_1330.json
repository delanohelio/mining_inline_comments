{"pr_number": 1330, "pr_title": "Remove all data-structures from Entity.", "pr_createdAt": "2020-08-27T14:29:00Z", "pr_url": "https://github.com/bakdata/conquery/pull/1330", "timeline": [{"oid": "29d5ba7b3d83c14ddaab156d9a8288ede4c8eff1", "url": "https://github.com/bakdata/conquery/commit/29d5ba7b3d83c14ddaab156d9a8288ede4c8eff1", "message": "Remove datastructures that are not needed", "committedDate": "2020-08-04T13:52:04Z", "type": "commit"}, {"oid": "58eb27ac678ea771bdcb9305927d06bcead5269c", "url": "https://github.com/bakdata/conquery/commit/58eb27ac678ea771bdcb9305927d06bcead5269c", "message": "WIP towards removing CBlocks from Entity", "committedDate": "2020-08-05T12:40:51Z", "type": "commit"}, {"oid": "bc3be882e3754fbe024f6837c2375914ee3d3318", "url": "https://github.com/bakdata/conquery/commit/bc3be882e3754fbe024f6837c2375914ee3d3318", "message": "some comments", "committedDate": "2020-08-06T09:10:18Z", "type": "commit"}, {"oid": "22c403b84c846ab4169259ab380811a9b9b34daa", "url": "https://github.com/bakdata/conquery/commit/22c403b84c846ab4169259ab380811a9b9b34daa", "message": "Sketch of Entity without datastructures", "committedDate": "2020-08-27T13:37:10Z", "type": "commit"}, {"oid": "cba4f2de6143ec2df8947db8a9bb4c87d1f402cb", "url": "https://github.com/bakdata/conquery/commit/cba4f2de6143ec2df8947db8a9bb4c87d1f402cb", "message": "Bump kryo from 5.0.0-RC7 to 5.0.0-RC8\n\nBumps [kryo](https://github.com/EsotericSoftware/kryo) from 5.0.0-RC7 to 5.0.0-RC8.\n- [Release notes](https://github.com/EsotericSoftware/kryo/releases)\n- [Commits](https://github.com/EsotericSoftware/kryo/compare/kryo-parent-5.0.0-RC7...kryo-parent-5.0.0-RC8)\n\nSigned-off-by: dependabot-preview[bot] <support@dependabot.com>", "committedDate": "2020-08-27T14:24:07Z", "type": "commit"}, {"oid": "4df08e824877df216f9d955064db476786b28242", "url": "https://github.com/bakdata/conquery/commit/4df08e824877df216f9d955064db476786b28242", "message": "ConceptCondition checking if a column has a value", "committedDate": "2020-08-27T14:24:08Z", "type": "commit"}, {"oid": "4324ed362d868ad4de70a9ac3503e7222989c898", "url": "https://github.com/bakdata/conquery/commit/4324ed362d868ad4de70a9ac3503e7222989c898", "message": "automatic update to docs", "committedDate": "2020-08-27T14:24:08Z", "type": "commit"}, {"oid": "bc17f8786c522626d0271b29195825df1e44bbd6", "url": "https://github.com/bakdata/conquery/commit/bc17f8786c522626d0271b29195825df1e44bbd6", "message": "Bump fastutil from 8.4.0 to 8.4.1\n\nBumps [fastutil](https://github.com/vigna/fastutil) from 8.4.0 to 8.4.1.\n- [Release notes](https://github.com/vigna/fastutil/releases)\n- [Changelog](https://github.com/vigna/fastutil/blob/master/CHANGES)\n- [Commits](https://github.com/vigna/fastutil/compare/8.4.0...8.4.1)\n\nSigned-off-by: dependabot-preview[bot] <support@dependabot.com>", "committedDate": "2020-08-27T14:24:08Z", "type": "commit"}, {"oid": "37edd71f79f55bbe82d87d990a47b9c96ab1ca72", "url": "https://github.com/bakdata/conquery/commit/37edd71f79f55bbe82d87d990a47b9c96ab1ca72", "message": "pull ClusterConfig::getEntityBucketSize up into creation and only pass it down, this has been causing bugs in the test pipeline", "committedDate": "2020-08-27T14:24:08Z", "type": "commit"}, {"oid": "45454c56c6f20350319da12ed2eeefaa98117ac4", "url": "https://github.com/bakdata/conquery/commit/45454c56c6f20350319da12ed2eeefaa98117ac4", "message": "fix usage of entityBucketSize in Workers", "committedDate": "2020-08-27T14:24:08Z", "type": "commit"}, {"oid": "ba65287987ac99f81db755dd2e90639cbdf12ff6", "url": "https://github.com/bakdata/conquery/commit/ba65287987ac99f81db755dd2e90639cbdf12ff6", "message": "Merge branch 'develop' into feature/no-data-in-Entity", "committedDate": "2020-08-27T14:29:16Z", "type": "commit"}, {"oid": "e8c2bd34e4e7307f27f43c3f2c34d3454a047b48", "url": "https://github.com/bakdata/conquery/commit/e8c2bd34e4e7307f27f43c3f2c34d3454a047b48", "message": "automatic update to docs", "committedDate": "2020-08-27T14:31:24Z", "type": "commit"}, {"oid": "350bb78c7afcd40ce3e01f6604a4c31bda3d7c30", "url": "https://github.com/bakdata/conquery/commit/350bb78c7afcd40ce3e01f6604a4c31bda3d7c30", "message": "Fix not registering imports on reload", "committedDate": "2020-08-27T16:30:18Z", "type": "commit"}, {"oid": "c4ea53d4edda7369f3308f991c1b64c9faa8f9c1", "url": "https://github.com/bakdata/conquery/commit/c4ea53d4edda7369f3308f991c1b64c9faa8f9c1", "message": "use other data structures for QueryPlan indices", "committedDate": "2020-08-28T09:47:50Z", "type": "commit"}, {"oid": "cc59208f883785be9e989f09d1b2f814ca98dca1", "url": "https://github.com/bakdata/conquery/commit/cc59208f883785be9e989f09d1b2f814ca98dca1", "message": "cleanup ConceptNode::isOfInterest", "committedDate": "2020-08-28T09:58:27Z", "type": "commit"}, {"oid": "b374d08492f8c0ad9a2a33926cca2d8e3c56ac3a", "url": "https://github.com/bakdata/conquery/commit/b374d08492f8c0ad9a2a33926cca2d8e3c56ac3a", "message": "fix not initializing queries", "committedDate": "2020-08-28T15:25:17Z", "type": "commit"}, {"oid": "3426aca5062885248e532f59b422d4d06d48076d", "url": "https://github.com/bakdata/conquery/commit/3426aca5062885248e532f59b422d4d06d48076d", "message": "remove test logging", "committedDate": "2020-08-31T10:59:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2OTI4Ng==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481069286", "bodyText": "Ich w\u00fcrde den Cache ganz wegnehmen und auf das vorhandene Keyset zugreifen.\nDer Rechenaufwand ist denke ich vollkommen im Rahmen hierf\u00fcr.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic Collection<ImportId> getTableImports(TableId tableId) {\n          \n          \n            \n            \t\treturn this.tableImports.get(tableId);\n          \n          \n            \n            \t}\n          \n          \n            \n            \t\tpublic Collection<ImportId> getTableImports(TableId tableId) {\n          \n          \n            \n            \t\treturn imports.getAllKeys().stream()\n          \n          \n            \n            \t\t\t.map(ImportId.class::cast)\n          \n          \n            \n            \t\t\t.filter(i -> i.getTable().equals(tableId))\n          \n          \n            \n            \t\t\t.collect(Collectors.toSet());\n          \n          \n            \n            \t}", "author": "thoniTUB", "createdAt": "2020-09-01T11:31:46Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/WorkerStorageImpl.java", "diffHunk": "@@ -138,12 +146,40 @@ public void removeConcept(ConceptId id) {\n \t\t}\n \t}\n \n+\n+\t@Override\n+\tpublic void addImport(Import imp) throws JSONException {\n+\t\tsuper.addImport(imp);\n+\n+\t\tregisterTableImport(imp.getId());\n+\t}\n+\n+\t@Override\n+\tpublic void updateImport(Import imp) throws JSONException {\n+\t\tsuper.updateImport(imp);\n+\t}\n+\n \t@Override\n \tpublic void removeImport(ImportId id){\n-\t\timports.remove(id);\n+\t\tsuper.removeImport(id);\n+\n+\t\tunregisterTableImport(id);\n \n \t\tif (bucketManager != null){\n \t\t\tbucketManager.removeImport(id);\n \t\t}\n \t}\n+\n+\tpublic void registerTableImport(ImportId impId) {\n+\t\ttableImports.put(impId.getTable(),impId);\n+\t}\n+\n+\tpublic void unregisterTableImport(ImportId impId) {\n+\t\ttableImports.remove(impId.getTable(), impId);\n+\t}\n+\n+\tpublic Collection<ImportId> getTableImports(TableId tableId) {\n+\t\treturn this.tableImports.get(tableId);\n+\t}", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NjEwMw==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481256103", "bodyText": "Wir k\u00f6nnen es gerne Profilen aber ich denke schon, dass die Caches Vorteile haben", "author": "awildturtok", "createdAt": "2020-09-01T16:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA2OTI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMTY1NQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481121655", "bodyText": "Info ist hier denke ich immer noch angebracht", "author": "thoniTUB", "createdAt": "2020-09-01T13:05:04Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/stores/SerializingStore.java", "diffHunk": "@@ -359,7 +359,7 @@ private static void dumpToFile(@NonNull ByteIterable obj, @NonNull String keyOfD\n \t\t}\n \t\t// Write dump\n \t\ttry {\n-\t\t\tlog.info(\"Dumping value of key {} to {} (because it cannot be deserialized anymore).\", keyOfDump, dumpfile.getCanonicalPath());\n+\t\t\tlog.warn(\"Dumping value of key {} to {} (because it cannot be deserialized anymore).\", keyOfDump, dumpfile.getCanonicalPath());", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMjU1NA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481122554", "bodyText": "Interessant, dann sollte values final werden/sein.", "author": "thoniTUB", "createdAt": "2020-09-01T13:06:29Z", "path": "backend/src/main/java/com/bakdata/conquery/models/concepts/conditions/EqualCondition.java", "diffHunk": "@@ -3,20 +3,20 @@\n import java.util.HashSet;\n import java.util.Map;\n \n-import org.hibernate.validator.constraints.NotEmpty;\n-\n import com.bakdata.conquery.io.cps.CPSType;\n import com.bakdata.conquery.util.CalculatedValue;\n-\n import lombok.Getter;\n import lombok.Setter;\n+import org.hibernate.validator.constraints.NotEmpty;\n \n /**\n  * This condition requires each value to be exactly as given in the list.\n  */\n @CPSType(id=\"EQUAL\", base=CTCondition.class)\n public class EqualCondition implements CTCondition {\n \n+\t// TODO: 06.08.2020 FK: @JsonCreator that uses different Sets for different applications. eg Collections.singleton or ArraySet (for small sets)", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1NTQzNQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481255435", "bodyText": "Habe ich daf\u00fcr keinen PR gestellt? das war ez aber noch keinen Speicherverbrauch getracket", "author": "awildturtok", "createdAt": "2020-09-01T16:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMjU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzMzAyOA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r491833028", "bodyText": "Ich habe mit den PR angeschaut, den du meinst", "author": "thoniTUB", "createdAt": "2020-09-21T07:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMjU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyNTYxMQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481125611", "bodyText": "Warum wird die entityBucketSize auf `0 gesetzt? Was ist so besonders am Preprocessing?", "author": "thoniTUB", "createdAt": "2020-09-01T13:11:24Z", "path": "backend/src/main/java/com/bakdata/conquery/models/datasets/Import.java", "diffHunk": "@@ -148,7 +157,7 @@ private String applyTemplate(String templateName) {\n \t}\n \n \tpublic static Import createForPreprocessing(String table, String tag, PPColumn[] columns) {\n-\t\tImport imp = new Import();\n+\t\tImport imp = new Import(0);", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0ODc2MA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481248760", "bodyText": "Das wird hier nicht verwendet aber da sollte dann ein Kommentar hin", "author": "awildturtok", "createdAt": "2020-09-01T15:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyNTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0ODkwNQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481248905", "bodyText": "Oder die Klassen besser getrennt werden", "author": "awildturtok", "createdAt": "2020-09-01T15:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyNTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzMTE3OQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481131179", "bodyText": "Die Methode w\u00fcrde ich umkrempeln und in den BucketManager schieben, um Indirektion einzusparen.", "author": "thoniTUB", "createdAt": "2020-09-01T13:19:48Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/entity/Entity.java", "diffHunk": "@@ -28,58 +16,21 @@\n public class Entity {\n \t@Getter\n \tprivate final int id;\n-\tprivate final ListMultimap<TableId, Bucket> buckets = ArrayListMultimap.create();\n-\tprivate final HashBasedTable<ConnectorId, BucketId, EntityRow> cBlocks = HashBasedTable.create();\n-\n-\tpublic void addBucket(TableId id, Bucket bucket) {\n-\t\tbuckets.put(id, bucket);\n-\t}\n \n-\tpublic void addCBlock(Connector con, Import imp, Table table, Bucket bucket, CBlock cBlock) {\n-\t\tif (cBlocks.put(con.getId(), bucket.getId(), new EntityRow(bucket, cBlock, con, imp, table)) != null) {\n-\t\t\tthrow new IllegalStateException(\"multiple CBlocks for block \" + bucket + \" & connector \" + con);\n-\t\t}\n-\t}\n \n \t/**\n-\t * Test if there is any known associated data to the Entity.\n+\t * Test if there is any known associated data to the Entity in the {@link BucketManager}\n+\t * @param bucketManager\n \t */\n-\tpublic boolean isEmpty() {\n-\t\treturn cBlocks.isEmpty() && buckets.isEmpty();\n+\tpublic boolean isEmpty(BucketManager bucketManager) {\n+\t\treturn !bucketManager.hasBucket(getBucket(id, bucketManager.getBucketSize()));\n \t}", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNjA1MA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481136050", "bodyText": "Das ist dann f\u00fcr einen n\u00e4chsten PR oder wolltest du das nochmachen?", "author": "thoniTUB", "createdAt": "2020-09-01T13:26:57Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/entity/EntityRow.java", "diffHunk": "@@ -1,19 +1,11 @@\n package com.bakdata.conquery.models.query.entity;\n \n-import com.bakdata.conquery.models.concepts.Connector;\n-import com.bakdata.conquery.models.datasets.Import;\n-import com.bakdata.conquery.models.datasets.Table;\n-import com.bakdata.conquery.models.events.Bucket;\n import com.bakdata.conquery.models.events.CBlock;\n import lombok.Data;\n import lombok.RequiredArgsConstructor;\n \n @Data @RequiredArgsConstructor\n public class EntityRow {\n \t//TODO Only the CBlock is used, remove this class.", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MDYxMw==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481140613", "bodyText": "Doku", "author": "thoniTUB", "createdAt": "2020-09-01T13:33:45Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/QPNode.java", "diffHunk": "@@ -19,12 +18,9 @@\n \tprotected QueryExecutionContext context;\n \tprotected Entity entity;\n \n-\tpublic void init(Entity entity) {\n-\t\tthis.entity = entity;\n-\t\tinit();\n-\t}\n-\n-\tprotected void init() {\n+\tpublic void init(Entity entity, QueryExecutionContext context) {", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxMDk2Mg==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481210962", "bodyText": "warum gibt es hier den member entity, der letztendlich in execute nicht benutzt wird.", "author": "thoniTUB", "createdAt": "2020-09-01T15:05:06Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/ConceptQueryPlan.java", "diffHunk": "@@ -81,9 +81,9 @@ protected void checkRequiredTables(WorkerStorage storage) {\n \t\t}\n \t}\n \n-\tpublic void init(Entity entity) {\n+\tpublic void init(Entity entity, QueryExecutionContext ctx) {\n \t\tthis.entity = entity;", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI1MzcyNQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481253725", "bodyText": "Das ist diese misch-masch OOP Implementierung aller QueryEngine Objekte, aber guter Punkt, muss mal schauen, wie man die smarter setzen kann, wird ja schon benutzt", "author": "awildturtok", "createdAt": "2020-09-01T16:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxMDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2MDEyNg==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r482860126", "bodyText": "Habe gerade versucht die init vor den execute schritt zu schieben, aber da gibt es echt viele abh\u00e4ngigkeiten vA in den Formularen, dass das am Ende echt nur uneinheitlicher als jetzt ist", "author": "awildturtok", "createdAt": "2020-09-03T10:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxMDk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxNDEzNg==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481214136", "bodyText": "@OverRide", "author": "thoniTUB", "createdAt": "2020-09-01T15:07:54Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/SecondaryIdQueryPlan.java", "diffHunk": "@@ -56,39 +57,47 @@ private Column findSecondaryIdColumn(TableId tableId, NamespacedStorage storage)\n \t */\n \tprivate ConceptQueryPlan createChild(Object key, QueryExecutionContext currentContext, Bucket currentBucket) {\n \t\tConceptQueryPlan plan = query.clone(new CloneContext(currentContext.getStorage()));\n-\t\tplan.init(query.getEntity());\n+\t\tplan.init(query.getEntity(), currentContext);\n \t\tplan.nextTable(currentContext, currentSecondaryIdColumn.getId().getTable());\n \t\tplan.isOfInterest(currentBucket);\n \t\tplan.nextBlock(currentBucket);\n \t\treturn plan;\n \t}\n-\t\n+\n+\tpublic void init(QueryExecutionContext ctx, Entity entity) {", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2MDU4MQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r482860581", "bodyText": "ist keine ConceptQueryPlan, also klappt das nicht", "author": "awildturtok", "createdAt": "2020-09-03T10:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxNDEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxODQ4OA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481218488", "bodyText": "Hier vermischt du init- und execution-Phase von diesem Object. Da beide die selben Parameter bekommen, sollte man \u00fcberlegen ob die Init-Phase noch etwas besonderes macht oder weggelassen werden kann.", "author": "thoniTUB", "createdAt": "2020-09-01T15:11:44Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/SecondaryIdQueryPlan.java", "diffHunk": "@@ -56,39 +57,47 @@ private Column findSecondaryIdColumn(TableId tableId, NamespacedStorage storage)\n \t */\n \tprivate ConceptQueryPlan createChild(Object key, QueryExecutionContext currentContext, Bucket currentBucket) {\n \t\tConceptQueryPlan plan = query.clone(new CloneContext(currentContext.getStorage()));\n-\t\tplan.init(query.getEntity());\n+\t\tplan.init(query.getEntity(), currentContext);\n \t\tplan.nextTable(currentContext, currentSecondaryIdColumn.getId().getTable());\n \t\tplan.isOfInterest(currentBucket);\n \t\tplan.nextBlock(currentBucket);\n \t\treturn plan;\n \t}\n-\t\n+\n+\tpublic void init(QueryExecutionContext ctx, Entity entity) {\n+\t\tquery.init(entity, ctx);\n+\t}\n+\n \t/**\n \t * This is the same execution as a typical ConceptQueryPlan. The difference\n \t * is that this method will create a new cloned child for each distinct\n \t * secondaryId it encounters during iteration.\n \t */\n \t@Override\n \tpublic EntityResult execute(QueryExecutionContext ctx, Entity entity) {\n-\t\tif(!query.isOfInterest(entity)){\n+\n+\n+\t\tinit(ctx, entity);", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxOTY3MA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481219670", "bodyText": "Wieder das Vermischen. query sollte schon initializiert sein.", "author": "thoniTUB", "createdAt": "2020-09-01T15:12:41Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/SecondaryIdQueryPlan.java", "diffHunk": "@@ -56,39 +57,47 @@ private Column findSecondaryIdColumn(TableId tableId, NamespacedStorage storage)\n \t */\n \tprivate ConceptQueryPlan createChild(Object key, QueryExecutionContext currentContext, Bucket currentBucket) {\n \t\tConceptQueryPlan plan = query.clone(new CloneContext(currentContext.getStorage()));\n-\t\tplan.init(query.getEntity());\n+\t\tplan.init(query.getEntity(), currentContext);\n \t\tplan.nextTable(currentContext, currentSecondaryIdColumn.getId().getTable());\n \t\tplan.isOfInterest(currentBucket);\n \t\tplan.nextBlock(currentBucket);\n \t\treturn plan;\n \t}\n-\t\n+\n+\tpublic void init(QueryExecutionContext ctx, Entity entity) {\n+\t\tquery.init(entity, ctx);\n+\t}\n+\n \t/**\n \t * This is the same execution as a typical ConceptQueryPlan. The difference\n \t * is that this method will create a new cloned child for each distinct\n \t * secondaryId it encounters during iteration.\n \t */\n \t@Override\n \tpublic EntityResult execute(QueryExecutionContext ctx, Entity entity) {\n-\t\tif(!query.isOfInterest(entity)){\n+\n+\n+\t\tinit(ctx, entity);\n+\n+\t\tif (!query.isOfInterest(entity)) {\n \t\t\treturn EntityResult.notContained();\n \t\t}\n \n \t\tquery.checkRequiredTables(ctx.getStorage());\n-\t\tquery.init(entity);\n+\t\tquery.init(entity, ctx);", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyNTE5Mw==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r489325193", "bodyText": "war hier tats\u00e4chlich falsch", "author": "awildturtok", "createdAt": "2020-09-16T10:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxOTY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481229928", "bodyText": "Sollte hier nicht ein Error geworfen werden? Das w\u00e4re doch ein IllegalState, oder?", "author": "thoniTUB", "createdAt": "2020-09-01T15:26:34Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/queryplan/specific/DateRestrictingNode.java", "diffHunk": "@@ -55,8 +54,7 @@ public void nextTable(QueryExecutionContext ctx, TableId currentTable) {\n \n \t@Override\n \tpublic boolean isOfInterest(Bucket bucket) {\n-\t\tEntityRow currentRow = Objects.requireNonNull(preCurrentRow.get(bucket.getId()));\n-\t\tCBlock cBlock = currentRow.getCBlock();\n+\t\tCBlock cBlock = Objects.requireNonNull(preCurrentRow.get(bucket.getId()));\n \t\tint localId = bucket.toLocal(entity.getId());\n \t\tif(cBlock.getMinDate()[localId] > cBlock.getMaxDate()[localId]) {\n \t\t\treturn false;", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2MTU2MA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r482861560", "bodyText": "Ist doch hier eine NullPointerException dann?", "author": "awildturtok", "createdAt": "2020-09-03T10:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzMzQxMg==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r491833412", "bodyText": "Ich meinte das if(cBlock.getMinDate()[localId] > cBlock.getMaxDate()[localId])", "author": "thoniTUB", "createdAt": "2020-09-21T07:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg1MTQxNA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r491851414", "bodyText": "ah, das sieht nach einem bug aus D:", "author": "awildturtok", "createdAt": "2020-09-21T07:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc4MTg2NQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r492781865", "bodyText": "nein, dh, dass sie nicht included sind.", "author": "awildturtok", "createdAt": "2020-09-22T14:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc4MjExOA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r492782118", "bodyText": "com.bakdata.conquery.models.events.CBlock#initIndizes", "author": "awildturtok", "createdAt": "2020-09-22T14:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzOTYzOQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481239639", "bodyText": "entityBucketSize sollte in der WorkerInformation stecken, das wird auf dem release-Branch deutlicher. Dort existiert die WorkerInformation nur noch im WorkerStorage und bleibt so konsistent f\u00fcr den Worker sollte sich die entityBucketSize zwischen neustarts \u00e4ndern.", "author": "thoniTUB", "createdAt": "2020-09-01T15:40:52Z", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Worker.java", "diffHunk": "@@ -34,12 +34,12 @@\n \t@Getter\n \tprivate final ExecutorService executorService;\n \t\n-\tpublic Worker(WorkerInformation info, JobManager jobManager, WorkerStorage storage, QueryExecutor queryExecutor, ExecutorService executorService) {\n+\tpublic Worker(WorkerInformation info, JobManager jobManager, WorkerStorage storage, QueryExecutor queryExecutor, ExecutorService executorService, int entityBucketSize) {", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0MTc3NA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481241774", "bodyText": "Hier hast du masterCommand.getConfig() und ConqueryConfig.getInstance().getCluster().getEntityBucketSize()", "author": "thoniTUB", "createdAt": "2020-09-01T15:44:01Z", "path": "backend/src/main/java/com/bakdata/conquery/resources/admin/AdminServlet.java", "diffHunk": "@@ -81,12 +82,14 @@ public void register(MasterCommand masterCommand, AuthorizationController contro\n \t\tjerseyConfig.register(new ViewMessageBodyWriter(masterCommand.getEnvironment().metrics(), Collections.singleton(freemarker)));\n \n \t\tadminProcessor = new AdminProcessor(\n-\t\t\tmasterCommand.getConfig(),\n-\t\t\tmasterCommand.getStorage(),\n-\t\t\tmasterCommand.getNamespaces(),\n-\t\t\tmasterCommand.getJobManager(),\n-\t\t\tmasterCommand.getMaintenanceService(),\n-\t\t\tmasterCommand.getValidator());\n+\t\t\t\tmasterCommand.getConfig(),\n+\t\t\t\tmasterCommand.getStorage(),\n+\t\t\t\tmasterCommand.getNamespaces(),\n+\t\t\t\tmasterCommand.getJobManager(),\n+\t\t\t\tmasterCommand.getMaintenanceService(),\n+\t\t\t\tmasterCommand.getValidator(),\n+\t\t\t\tConqueryConfig.getInstance().getCluster().getEntityBucketSize()\n+\t\t);", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0Mjc3NQ==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481242775", "bodyText": "\ud83d\ude04", "author": "thoniTUB", "createdAt": "2020-09-01T15:45:26Z", "path": "backend/src/test/java/com/bakdata/conquery/integration/tests/RestartTest.java", "diffHunk": "@@ -49,13 +52,13 @@ public void execute(String name, TestConquery testConquery) throws Exception {\n \n \t\tMasterCommand master = testConquery.getStandaloneCommand().getMaster();\n \t\tAdminProcessor adminProcessor = new AdminProcessor(\n-\n \t\t\t\tmaster.getConfig(),\n \t\t\t\tmaster.getStorage(),\n \t\t\t\tmaster.getNamespaces(),\n \t\t\t\tmaster.getJobManager(),\n \t\t\t\tmaster.getMaintenanceService(),\n-\t\t\t\tmaster.getValidator()\n+\t\t\t\tmaster.getValidator(),\n+\t\t\t\tentityBucketSize // todo this is unhealthy", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0MzA4Ng==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r481243086", "bodyText": "Exsistiert der jetzt noch?", "author": "thoniTUB", "createdAt": "2020-09-01T15:45:54Z", "path": "backend/src/test/java/com/bakdata/conquery/integration/tests/RestartTest.java", "diffHunk": "@@ -115,7 +118,7 @@ public void execute(String name, TestConquery testConquery) throws Exception {\n \t\t}\n \n \t\t// TODO: 21.07.2020 FK: This is temporary logging for finding a bug in CI.", "originalCommit": "3426aca5062885248e532f59b422d4d06d48076d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b306125709c3cc2b43428a37fb87966c9b0e7146", "url": "https://github.com/bakdata/conquery/commit/b306125709c3cc2b43428a37fb87966c9b0e7146", "message": "Code review cleanup", "committedDate": "2020-09-02T14:00:32Z", "type": "commit"}, {"oid": "ef985a012b9b0c77f163e5156717ef2cde008692", "url": "https://github.com/bakdata/conquery/commit/ef985a012b9b0c77f163e5156717ef2cde008692", "message": "cleanup SecondaryIdQueryPlan#init", "committedDate": "2020-09-03T10:03:40Z", "type": "commit"}, {"oid": "cc5d8c7ddaaffd533024ca24fea501ef68eb487c", "url": "https://github.com/bakdata/conquery/commit/cc5d8c7ddaaffd533024ca24fea501ef68eb487c", "message": "cleanup for merge", "committedDate": "2020-09-16T10:31:05Z", "type": "commit"}, {"oid": "5570cb56764634e89fa2ea030ae7dbf2bcec9b1c", "url": "https://github.com/bakdata/conquery/commit/5570cb56764634e89fa2ea030ae7dbf2bcec9b1c", "message": "Merge remote-tracking branch 'origin/develop' into feature/no-data-in-Entity\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/worker/Worker.java\n#\tbackend/src/main/java/com/bakdata/conquery/models/worker/Workers.java\n#\tbackend/src/test/java/com/bakdata/conquery/integration/json/AbstractQueryEngineTest.java", "committedDate": "2020-09-16T13:28:32Z", "type": "commit"}, {"oid": "fc46b375978992e3704ece39d665671d7b23eab5", "url": "https://github.com/bakdata/conquery/commit/fc46b375978992e3704ece39d665671d7b23eab5", "message": "post merge fix", "committedDate": "2020-09-16T13:31:00Z", "type": "commit"}, {"oid": "ac852519e971f8c67aed0d74bfe3be4d9ee4a4be", "url": "https://github.com/bakdata/conquery/commit/ac852519e971f8c67aed0d74bfe3be4d9ee4a4be", "message": "cleanup is of interest", "committedDate": "2020-09-17T10:10:25Z", "type": "commit"}, {"oid": "648f7be0b12b53a7fe8107b107de1167853ac4cf", "url": "https://github.com/bakdata/conquery/commit/648f7be0b12b53a7fe8107b107de1167853ac4cf", "message": "fix FormQueryPlan not returning all given entities", "committedDate": "2020-09-17T10:31:40Z", "type": "commit"}, {"oid": "2c051729b3d46e11baf493e54cb9fc9550dff930", "url": "https://github.com/bakdata/conquery/commit/2c051729b3d46e11baf493e54cb9fc9550dff930", "message": "code style feedback", "committedDate": "2020-09-22T14:31:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwMDgxOA==", "url": "https://github.com/bakdata/conquery/pull/1330#discussion_r492800818", "bodyText": "In C ist das nicht gerne gesehen, bei Java kann ich mir sowas auch vorstellen, weil man sowas produzieren kann:\nprivate int minDate, maxDate []; oder private int [] minDate, maxDate;\nDann ist auf den ersten Blick nicht ganz klar was gemeint ist, wenn nicht eine Zeile pro Deklaration verwendet wird.", "author": "thoniTUB", "createdAt": "2020-09-22T14:53:26Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/CBlock.java", "diffHunk": "@@ -43,8 +43,7 @@\n \t * Statistic for fast lookup if entity is of interest.\n \t * Int array for memory performance.\n \t */\n-\tprivate int[] minDate;\n-\tprivate int[] maxDate;\n+\tprivate int[] minDate, maxDate;", "originalCommit": "2c051729b3d46e11baf493e54cb9fc9550dff930", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9784f8b8be19dfb442ad97b11210a7ff800fcbb", "url": "https://github.com/bakdata/conquery/commit/c9784f8b8be19dfb442ad97b11210a7ff800fcbb", "message": "Merge remote-tracking branch 'origin/develop' into feature/no-data-in-Entity\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/concepts/conditions/EqualCondition.java\n#\tbackend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n#\tbackend/src/main/java/com/bakdata/conquery/models/worker/Worker.java\n#\tbackend/src/main/java/com/bakdata/conquery/resources/admin/AdminServlet.java\n#\tbackend/src/main/java/com/bakdata/conquery/resources/admin/rest/AdminProcessor.java\n#\tbackend/src/test/java/com/bakdata/conquery/integration/tests/RestartTest.java\n#\tdocs/Concept JSONs.md", "committedDate": "2020-09-23T11:11:28Z", "type": "commit"}, {"oid": "9338d39f7175b02b1e852f214d520cec04b53bac", "url": "https://github.com/bakdata/conquery/commit/9338d39f7175b02b1e852f214d520cec04b53bac", "message": "Merge remote-tracking branch 'origin/develop' into feature/no-data-in-Entity\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/query/queryplan/specific/ConceptNode.java\n#\tbackend/src/main/java/com/bakdata/conquery/models/query/queryplan/specific/DateRestrictingNode.java", "committedDate": "2020-09-29T13:15:50Z", "type": "commit"}, {"oid": "28d53faebff608dd79d4a6abe5efe057746b6253", "url": "https://github.com/bakdata/conquery/commit/28d53faebff608dd79d4a6abe5efe057746b6253", "message": "Merge branch 'develop' into feature/no-data-in-Entity", "committedDate": "2020-09-29T13:54:26Z", "type": "commit"}, {"oid": "8d8c7525cf823b09f1d95785acef6eb2b6701801", "url": "https://github.com/bakdata/conquery/commit/8d8c7525cf823b09f1d95785acef6eb2b6701801", "message": "Merge branch 'develop' into feature/no-data-in-Entity", "committedDate": "2020-09-30T08:08:48Z", "type": "commit"}, {"oid": "ddfe6a423a203d9509a8506083353803abc2b06a", "url": "https://github.com/bakdata/conquery/commit/ddfe6a423a203d9509a8506083353803abc2b06a", "message": "fix post merge dupe", "committedDate": "2020-09-30T11:52:13Z", "type": "commit"}, {"oid": "37cea5c867c5860e43bfab858fc140637cbaece0", "url": "https://github.com/bakdata/conquery/commit/37cea5c867c5860e43bfab858fc140637cbaece0", "message": "Merge branch 'feature/no-data-in-Entity' of https://github.com/bakdata/conquery into feature/no-data-in-Entity", "committedDate": "2020-09-30T11:55:43Z", "type": "commit"}]}