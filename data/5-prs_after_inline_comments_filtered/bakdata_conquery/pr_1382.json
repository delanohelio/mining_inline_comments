{"pr_number": 1382, "pr_title": "Feature/clean up bucket manager", "pr_createdAt": "2020-10-06T11:37:09Z", "pr_url": "https://github.com/bakdata/conquery/pull/1382", "timeline": [{"oid": "0912ee9d89c62d4070d3ad17ac16548aa7138991", "url": "https://github.com/bakdata/conquery/commit/0912ee9d89c62d4070d3ad17ac16548aa7138991", "message": "revert of some change", "committedDate": "2020-10-06T14:42:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIyMjU1Ng==", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r500222556", "bodyText": "W\u00fcrde ich nicht im Konstruktor machen", "author": "awildturtok", "createdAt": "2020-10-06T12:08:34Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -40,37 +39,50 @@\n \tprivate final IdMutex<ConnectorId> cBlockLocks = new IdMutex<>();\n \tprivate final JobManager jobManager;\n \tprivate final WorkerStorage storage;\n-\tprivate final IdMap<ConceptId, Concept<?>> concepts = new IdMap<>();\n-\tprivate final IdMap<BucketId, Bucket> buckets = new IdMap<>();\n-\tprivate final IdMap<CBlockId, CBlock> cBlocks = new IdMap<>();\n \t@Getter\n \tprivate final Int2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\tprivate final WorkerInformation workerInformation;\n+\tprivate final Worker worker;\n \n-\tpublic BucketManager(JobManager jobManager, WorkerStorage storage, WorkerInformation workerInformation) {\n+\tpublic BucketManager(JobManager jobManager, WorkerStorage storage, Worker worker) {\n \t\tthis.jobManager = jobManager;\n \t\tthis.storage = storage;\n-\t\tthis.concepts.addAll(storage.getAllConcepts());\n-\t\tthis.buckets.addAll(storage.getAllBuckets());\n-\t\tthis.cBlocks.addAll(storage.getAllCBlocks());\n-\t\tthis.workerInformation = workerInformation;\n+\t\tthis.worker = worker;\n+\t\t\n+\t\tIntArrayList requiredBuckets = worker.getInfo().getIncludedBuckets().clone();\n+\t\tlog.trace(\"Trying to load these buckets: {}\", requiredBuckets);", "originalCommit": "f718594397271648de9e93c24fb5b4fa546e56b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA3NTQ0NQ==", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501075445", "bodyText": "Doku", "author": "awildturtok", "createdAt": "2020-10-07T14:49:26Z", "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/WorkerStorageRetrivalDelegate.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.bakdata.conquery.io.xodus;\n+\n+import java.io.File;\n+import java.util.Collection;\n+\n+import javax.validation.Validator;\n+\n+import com.bakdata.conquery.models.concepts.Concept;\n+import com.bakdata.conquery.models.datasets.Dataset;\n+import com.bakdata.conquery.models.datasets.Import;\n+import com.bakdata.conquery.models.dictionary.Dictionary;\n+import com.bakdata.conquery.models.dictionary.DirectDictionary;\n+import com.bakdata.conquery.models.events.Bucket;\n+import com.bakdata.conquery.models.events.CBlock;\n+import com.bakdata.conquery.models.identifiable.CentralRegistry;\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.CBlockId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ConceptId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.DictionaryId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n+import com.bakdata.conquery.models.worker.WorkerInformation;\n+import jetbrains.exodus.env.Environment;\n+import lombok.RequiredArgsConstructor;\n+\n+@RequiredArgsConstructor\n+public class WorkerStorageRetrivalDelegate {", "originalCommit": "115cabce043bc0896625ce70ff6d152fad5a07f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3fca89ad85896815dcb239746c683599f1a4a178", "url": "https://github.com/bakdata/conquery/commit/3fca89ad85896815dcb239746c683599f1a4a178", "message": "puts annotation on the right line", "committedDate": "2020-10-07T15:56:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3NzE5Ng==", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501677196", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @implNote These numbers are estimates, we could make them configurable, though they aren't very important.", "author": "awildturtok", "createdAt": "2020-10-08T12:23:06Z", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -43,36 +43,52 @@\n  * @implNote This class is only used per {@link Worker}. And NOT in the ManagerNode.\n  */\n @Slf4j\n+@RequiredArgsConstructor\n public class BucketManager {\n \n-\t@Getter\n-\tprivate final int bucketSize;\n-\n \tprivate final IdMutex<ConnectorId> cBlockLocks = new IdMutex<>();\n \tprivate final JobManager jobManager;\n \tprivate final WorkerStorage storage;\n-\tprivate final IdMap<ConceptId, Concept<?>> concepts = new IdMap<>();\n-\tprivate final IdMap<BucketId, Bucket> buckets = new IdMap<>();\n-\tprivate final IdMap<CBlockId, CBlock> cBlocks = new IdMap<>();\n-\t@Getter\n-\tprivate final Int2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\n \t//Backreference\n \tprivate final Worker worker;\n+\t@Getter\n+\tprivate final Int2ObjectMap<Entity> entities;\n+\t\n+\t/**\n+\t * Connector -> Bucket -> [CBlock]\n+\t * @implNote These numbers are estimates, we could make them configurable, though they aren't very important.", "originalCommit": "7828b2e5c043f06412edbaafe9c7d2cd8c47e8c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3ODM4NA==", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501678384", "bodyText": "mlady -- \ud83c\udfa9", "author": "awildturtok", "createdAt": "2020-10-08T12:25:09Z", "path": "backend/src/main/java/com/bakdata/conquery/models/query/QueryPlanContext.java", "diffHunk": "@@ -1,6 +1,6 @@\n package com.bakdata.conquery.models.query;\n \n-import com.bakdata.conquery.io.xodus.WorkerStorage;\n+import com.bakdata.conquery.io.xodus.ModificationShieldedWorkerStorage;", "originalCommit": "7828b2e5c043f06412edbaafe9c7d2cd8c47e8c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba129af140740b82cad13a6292bf2a0049fddff4", "url": "https://github.com/bakdata/conquery/commit/ba129af140740b82cad13a6292bf2a0049fddff4", "message": "remove IdMaps from BucketManager", "committedDate": "2020-10-08T13:55:59Z", "type": "commit"}, {"oid": "3fb84b35110dffc892adfd4c8e2fbc7e493d4629", "url": "https://github.com/bakdata/conquery/commit/3fb84b35110dffc892adfd4c8e2fbc7e493d4629", "message": "fix wrong comparison in test", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "a81ee089db508d910a72199fb6056e6344c07f6b", "url": "https://github.com/bakdata/conquery/commit/a81ee089db508d910a72199fb6056e6344c07f6b", "message": "don't throw in storage if concept was not found", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "09d5599e1660fb76b02066e5cca4cfb896fe1337", "url": "https://github.com/bakdata/conquery/commit/09d5599e1660fb76b02066e5cca4cfb896fe1337", "message": "adds missing remove of storage when namespace is removed", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "321e3e2376b2ebf40114957756511dfecf203ef7", "url": "https://github.com/bakdata/conquery/commit/321e3e2376b2ebf40114957756511dfecf203ef7", "message": "fixes direct deletion of import", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "7f5726ad42153db74e1a33738e7c244976082ebd", "url": "https://github.com/bakdata/conquery/commit/7f5726ad42153db74e1a33738e7c244976082ebd", "message": "adds consistency test", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "818ae113126caa78ea8f7806d1ad491f375e5439", "url": "https://github.com/bakdata/conquery/commit/818ae113126caa78ea8f7806d1ad491f375e5439", "message": "fixes of rebase conflicts", "committedDate": "2020-10-08T13:56:00Z", "type": "commit"}, {"oid": "62e4c10a68579b91524fdb9cbac949d9e0658684", "url": "https://github.com/bakdata/conquery/commit/62e4c10a68579b91524fdb9cbac949d9e0658684", "message": "revert of some change", "committedDate": "2020-10-08T13:56:01Z", "type": "commit"}, {"oid": "614dda6682999cde6f781c80aaa9d047389dd6d4", "url": "https://github.com/bakdata/conquery/commit/614dda6682999cde6f781c80aaa9d047389dd6d4", "message": "remove commented function", "committedDate": "2020-10-08T13:56:01Z", "type": "commit"}, {"oid": "56d77bfa93b1a96f4420836057b28510872942fc", "url": "https://github.com/bakdata/conquery/commit/56d77bfa93b1a96f4420836057b28510872942fc", "message": "review changes", "committedDate": "2020-10-08T13:56:01Z", "type": "commit"}, {"oid": "0c63af029cf26a7ecb1fc723dc9c8679c2d5ca8e", "url": "https://github.com/bakdata/conquery/commit/0c63af029cf26a7ecb1fc723dc9c8679c2d5ca8e", "message": "puts annotation on the right line", "committedDate": "2020-10-08T13:56:01Z", "type": "commit"}, {"oid": "f67c026cfe28f3c701dd9ef06645c06d5b977f1a", "url": "https://github.com/bakdata/conquery/commit/f67c026cfe28f3c701dd9ef06645c06d5b977f1a", "message": "fix rebase issues", "committedDate": "2020-10-08T13:56:01Z", "type": "commit"}, {"oid": "dea7d8453d057376bc87dd8c735ddbf193993a3c", "url": "https://github.com/bakdata/conquery/commit/dea7d8453d057376bc87dd8c735ddbf193993a3c", "message": "fixes compile errors", "committedDate": "2020-10-08T13:56:02Z", "type": "commit"}, {"oid": "f851e88747e10e8a366a8ebf4e1a81bad9305166", "url": "https://github.com/bakdata/conquery/commit/f851e88747e10e8a366a8ebf4e1a81bad9305166", "message": "Update backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\nCo-authored-by: awildturtok <1553491+awildturtok@users.noreply.github.com>", "committedDate": "2020-10-08T13:56:02Z", "type": "commit"}, {"oid": "f851e88747e10e8a366a8ebf4e1a81bad9305166", "url": "https://github.com/bakdata/conquery/commit/f851e88747e10e8a366a8ebf4e1a81bad9305166", "message": "Update backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\nCo-authored-by: awildturtok <1553491+awildturtok@users.noreply.github.com>", "committedDate": "2020-10-08T13:56:02Z", "type": "forcePushed"}]}