{"pr_number": 1292, "pr_title": "oidc resource owner password credential grant", "pr_createdAt": "2020-07-22T15:07:25Z", "pr_url": "https://github.com/bakdata/conquery/pull/1292", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NzM4Mg==", "url": "https://github.com/bakdata/conquery/pull/1292#discussion_r458867382", "bodyText": "Konstante", "author": "awildturtok", "createdAt": "2020-07-22T15:11:24Z", "path": "backend/src/main/java/com/bakdata/conquery/models/auth/oidc/passwordflow/OIDCResourceOwnerPasswordCredeantialRealm.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package com.bakdata.conquery.models.auth.oidc.passwordflow;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationInfo;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationRealm;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler.JwtToken;\n+import com.bakdata.conquery.models.auth.basic.UsernamePasswordChecker;\n+import com.bakdata.conquery.models.auth.entities.User;\n+import com.bakdata.conquery.models.auth.util.SkippingCredentialsMatcher;\n+import com.bakdata.conquery.models.identifiable.ids.specific.UserId;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthAdminUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthApiUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.LoginResource;\n+import com.bakdata.conquery.resources.unprotected.TokenResource;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.nimbusds.oauth2.sdk.AccessTokenResponse;\n+import com.nimbusds.oauth2.sdk.AuthorizationGrant;\n+import com.nimbusds.oauth2.sdk.ParseException;\n+import com.nimbusds.oauth2.sdk.ResourceOwnerPasswordCredentialsGrant;\n+import com.nimbusds.oauth2.sdk.Scope;\n+import com.nimbusds.oauth2.sdk.TokenErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionRequest;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionSuccessResponse;\n+import com.nimbusds.oauth2.sdk.TokenRequest;\n+import com.nimbusds.oauth2.sdk.TokenResponse;\n+import com.nimbusds.oauth2.sdk.auth.ClientAuthentication;\n+import com.nimbusds.oauth2.sdk.auth.ClientSecretBasic;\n+import com.nimbusds.oauth2.sdk.auth.Secret;\n+import com.nimbusds.oauth2.sdk.id.ClientID;\n+import com.nimbusds.oauth2.sdk.token.AccessToken;\n+import com.nimbusds.oauth2.sdk.token.TypelessAccessToken;\n+import io.dropwizard.jersey.DropwizardResourceConfig;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.keycloak.authorization.client.AuthzClient;\n+\n+@Slf4j\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class OIDCResourceOwnerPasswordCredeantialRealm extends ConqueryAuthenticationRealm implements AuthApiUnprotectedResourceProvider, AuthAdminUnprotectedResourceProvider, UsernamePasswordChecker {\n+\n+\tprivate static final Class<? extends AuthenticationToken> TOKEN_CLASS = JwtToken.class;\n+\t\n+\tprivate final MasterMetaStorage storage;\n+\tprivate final OIDCResourceOwnerPasswordCredeantialRealmFactory config;\n+\t\n+\tprivate ClientAuthentication clientAuthentication;\n+\tprivate AuthzClient authzClient;\n+\t\n+\tprivate LoadingCache<JwtToken, TokenIntrospectionSuccessResponse> tokenCache = CacheBuilder.newBuilder()\n+\t\t.expireAfterWrite(10, TimeUnit.MINUTES)\n+\t\t.build(new TokenValidator());\n+\t\n+\t@Override\n+\tprotected void onInit() {\n+\t\tsuper.onInit();\n+\t\tthis.setCredentialsMatcher(new SkippingCredentialsMatcher());\n+\t\tthis.setAuthenticationTokenClass(TOKEN_CLASS);\n+\t\tthis.clientAuthentication = new ClientSecretBasic(new ClientID(config.getResource()), new Secret((String)config.getCredentials().get(\"secret\")));\n+\t\t\n+\t\tauthzClient = AuthzClient.create(config);\n+\t}\n+\t\n+\t@Override\n+\t@SneakyThrows\n+\tprotected ConqueryAuthenticationInfo doGetConqueryAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+\t\t\n+\t\tTokenIntrospectionSuccessResponse successResponse = tokenCache.get((JwtToken) token);\n+\n+\t\tString username = successResponse.getUsername();\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tusername = successResponse.getStringParameter(\"preferred_username\");\n+\t\t}\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve a user identifier from validated token. Dismissing the token.\");\n+\t\t}\n+\t\t\n+\t\tUserId userId = new UserId(username);\n+\t\tUser user = storage.getUser(userId);\n+\t\t// try to construct a new User if none could be found in the storage\n+\t\tif (user == null) {\n+\t\t\tString userLabel = successResponse.getStringParameter(\"name\");\n+\t\t\tuser = new User(username, userLabel != null ?  userLabel : username);\n+\t\t\tstorage.addUser(user);\n+\t\t\tlog.info(\n+\t\t\t\t\"Created new user: {}\",\n+\t\t\t\tuser);\n+\t\t}\n+\n+\t\treturn new ConqueryAuthenticationInfo(user.getId(), token, this, false);\n+\t}\n+\n+\tprivate TokenIntrospectionSuccessResponse validateToken(AuthenticationToken token) throws URISyntaxException, MalformedURLException, ParseException, IOException {\n+\t\tURI tokenIntrospectEndpoint =  new URL(new URL(config.getAuthServerUrl()),\"realms/EVA/protocol/openid-connect/token/introspect\").toURI();", "originalCommit": "795c115f6a10d54c80d32adeecd55794f517167c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2Nzk0OQ==", "url": "https://github.com/bakdata/conquery/pull/1292#discussion_r458867949", "bodyText": "Format", "author": "awildturtok", "createdAt": "2020-07-22T15:12:14Z", "path": "backend/src/main/java/com/bakdata/conquery/models/auth/oidc/passwordflow/OIDCResourceOwnerPasswordCredeantialRealm.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package com.bakdata.conquery.models.auth.oidc.passwordflow;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationInfo;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationRealm;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler.JwtToken;\n+import com.bakdata.conquery.models.auth.basic.UsernamePasswordChecker;\n+import com.bakdata.conquery.models.auth.entities.User;\n+import com.bakdata.conquery.models.auth.util.SkippingCredentialsMatcher;\n+import com.bakdata.conquery.models.identifiable.ids.specific.UserId;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthAdminUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthApiUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.LoginResource;\n+import com.bakdata.conquery.resources.unprotected.TokenResource;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.nimbusds.oauth2.sdk.AccessTokenResponse;\n+import com.nimbusds.oauth2.sdk.AuthorizationGrant;\n+import com.nimbusds.oauth2.sdk.ParseException;\n+import com.nimbusds.oauth2.sdk.ResourceOwnerPasswordCredentialsGrant;\n+import com.nimbusds.oauth2.sdk.Scope;\n+import com.nimbusds.oauth2.sdk.TokenErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionRequest;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionSuccessResponse;\n+import com.nimbusds.oauth2.sdk.TokenRequest;\n+import com.nimbusds.oauth2.sdk.TokenResponse;\n+import com.nimbusds.oauth2.sdk.auth.ClientAuthentication;\n+import com.nimbusds.oauth2.sdk.auth.ClientSecretBasic;\n+import com.nimbusds.oauth2.sdk.auth.Secret;\n+import com.nimbusds.oauth2.sdk.id.ClientID;\n+import com.nimbusds.oauth2.sdk.token.AccessToken;\n+import com.nimbusds.oauth2.sdk.token.TypelessAccessToken;\n+import io.dropwizard.jersey.DropwizardResourceConfig;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.keycloak.authorization.client.AuthzClient;\n+\n+@Slf4j\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class OIDCResourceOwnerPasswordCredeantialRealm extends ConqueryAuthenticationRealm implements AuthApiUnprotectedResourceProvider, AuthAdminUnprotectedResourceProvider, UsernamePasswordChecker {\n+\n+\tprivate static final Class<? extends AuthenticationToken> TOKEN_CLASS = JwtToken.class;\n+\t\n+\tprivate final MasterMetaStorage storage;\n+\tprivate final OIDCResourceOwnerPasswordCredeantialRealmFactory config;\n+\t\n+\tprivate ClientAuthentication clientAuthentication;\n+\tprivate AuthzClient authzClient;\n+\t\n+\tprivate LoadingCache<JwtToken, TokenIntrospectionSuccessResponse> tokenCache = CacheBuilder.newBuilder()\n+\t\t.expireAfterWrite(10, TimeUnit.MINUTES)\n+\t\t.build(new TokenValidator());\n+\t\n+\t@Override\n+\tprotected void onInit() {\n+\t\tsuper.onInit();\n+\t\tthis.setCredentialsMatcher(new SkippingCredentialsMatcher());\n+\t\tthis.setAuthenticationTokenClass(TOKEN_CLASS);\n+\t\tthis.clientAuthentication = new ClientSecretBasic(new ClientID(config.getResource()), new Secret((String)config.getCredentials().get(\"secret\")));\n+\t\t\n+\t\tauthzClient = AuthzClient.create(config);\n+\t}\n+\t\n+\t@Override\n+\t@SneakyThrows\n+\tprotected ConqueryAuthenticationInfo doGetConqueryAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+\t\t\n+\t\tTokenIntrospectionSuccessResponse successResponse = tokenCache.get((JwtToken) token);\n+\n+\t\tString username = successResponse.getUsername();\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tusername = successResponse.getStringParameter(\"preferred_username\");\n+\t\t}\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve a user identifier from validated token. Dismissing the token.\");\n+\t\t}\n+\t\t\n+\t\tUserId userId = new UserId(username);\n+\t\tUser user = storage.getUser(userId);\n+\t\t// try to construct a new User if none could be found in the storage\n+\t\tif (user == null) {\n+\t\t\tString userLabel = successResponse.getStringParameter(\"name\");\n+\t\t\tuser = new User(username, userLabel != null ?  userLabel : username);\n+\t\t\tstorage.addUser(user);\n+\t\t\tlog.info(", "originalCommit": "795c115f6a10d54c80d32adeecd55794f517167c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2OTQ5Mg==", "url": "https://github.com/bakdata/conquery/pull/1292#discussion_r458869492", "bodyText": "hat der response typ keine bessere info f\u00fcr success/fail?", "author": "awildturtok", "createdAt": "2020-07-22T15:14:16Z", "path": "backend/src/main/java/com/bakdata/conquery/models/auth/oidc/passwordflow/OIDCResourceOwnerPasswordCredeantialRealm.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package com.bakdata.conquery.models.auth.oidc.passwordflow;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationInfo;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationRealm;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler.JwtToken;\n+import com.bakdata.conquery.models.auth.basic.UsernamePasswordChecker;\n+import com.bakdata.conquery.models.auth.entities.User;\n+import com.bakdata.conquery.models.auth.util.SkippingCredentialsMatcher;\n+import com.bakdata.conquery.models.identifiable.ids.specific.UserId;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthAdminUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthApiUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.LoginResource;\n+import com.bakdata.conquery.resources.unprotected.TokenResource;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.nimbusds.oauth2.sdk.AccessTokenResponse;\n+import com.nimbusds.oauth2.sdk.AuthorizationGrant;\n+import com.nimbusds.oauth2.sdk.ParseException;\n+import com.nimbusds.oauth2.sdk.ResourceOwnerPasswordCredentialsGrant;\n+import com.nimbusds.oauth2.sdk.Scope;\n+import com.nimbusds.oauth2.sdk.TokenErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionRequest;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionSuccessResponse;\n+import com.nimbusds.oauth2.sdk.TokenRequest;\n+import com.nimbusds.oauth2.sdk.TokenResponse;\n+import com.nimbusds.oauth2.sdk.auth.ClientAuthentication;\n+import com.nimbusds.oauth2.sdk.auth.ClientSecretBasic;\n+import com.nimbusds.oauth2.sdk.auth.Secret;\n+import com.nimbusds.oauth2.sdk.id.ClientID;\n+import com.nimbusds.oauth2.sdk.token.AccessToken;\n+import com.nimbusds.oauth2.sdk.token.TypelessAccessToken;\n+import io.dropwizard.jersey.DropwizardResourceConfig;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.keycloak.authorization.client.AuthzClient;\n+\n+@Slf4j\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class OIDCResourceOwnerPasswordCredeantialRealm extends ConqueryAuthenticationRealm implements AuthApiUnprotectedResourceProvider, AuthAdminUnprotectedResourceProvider, UsernamePasswordChecker {\n+\n+\tprivate static final Class<? extends AuthenticationToken> TOKEN_CLASS = JwtToken.class;\n+\t\n+\tprivate final MasterMetaStorage storage;\n+\tprivate final OIDCResourceOwnerPasswordCredeantialRealmFactory config;\n+\t\n+\tprivate ClientAuthentication clientAuthentication;\n+\tprivate AuthzClient authzClient;\n+\t\n+\tprivate LoadingCache<JwtToken, TokenIntrospectionSuccessResponse> tokenCache = CacheBuilder.newBuilder()\n+\t\t.expireAfterWrite(10, TimeUnit.MINUTES)\n+\t\t.build(new TokenValidator());\n+\t\n+\t@Override\n+\tprotected void onInit() {\n+\t\tsuper.onInit();\n+\t\tthis.setCredentialsMatcher(new SkippingCredentialsMatcher());\n+\t\tthis.setAuthenticationTokenClass(TOKEN_CLASS);\n+\t\tthis.clientAuthentication = new ClientSecretBasic(new ClientID(config.getResource()), new Secret((String)config.getCredentials().get(\"secret\")));\n+\t\t\n+\t\tauthzClient = AuthzClient.create(config);\n+\t}\n+\t\n+\t@Override\n+\t@SneakyThrows\n+\tprotected ConqueryAuthenticationInfo doGetConqueryAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+\t\t\n+\t\tTokenIntrospectionSuccessResponse successResponse = tokenCache.get((JwtToken) token);\n+\n+\t\tString username = successResponse.getUsername();\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tusername = successResponse.getStringParameter(\"preferred_username\");\n+\t\t}\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve a user identifier from validated token. Dismissing the token.\");\n+\t\t}\n+\t\t\n+\t\tUserId userId = new UserId(username);\n+\t\tUser user = storage.getUser(userId);\n+\t\t// try to construct a new User if none could be found in the storage\n+\t\tif (user == null) {\n+\t\t\tString userLabel = successResponse.getStringParameter(\"name\");\n+\t\t\tuser = new User(username, userLabel != null ?  userLabel : username);\n+\t\t\tstorage.addUser(user);\n+\t\t\tlog.info(\n+\t\t\t\t\"Created new user: {}\",\n+\t\t\t\tuser);\n+\t\t}\n+\n+\t\treturn new ConqueryAuthenticationInfo(user.getId(), token, this, false);\n+\t}\n+\n+\tprivate TokenIntrospectionSuccessResponse validateToken(AuthenticationToken token) throws URISyntaxException, MalformedURLException, ParseException, IOException {\n+\t\tURI tokenIntrospectEndpoint =  new URL(new URL(config.getAuthServerUrl()),\"realms/EVA/protocol/openid-connect/token/introspect\").toURI();\n+\t\tTokenIntrospectionRequest request = new TokenIntrospectionRequest(tokenIntrospectEndpoint , clientAuthentication, new TypelessAccessToken((String) token.getCredentials()));\n+\t\t\n+\t\tTokenIntrospectionResponse response = TokenIntrospectionResponse.parse(request.toHTTPRequest().send());\n+\t\t\n+\t\tif (response instanceof TokenIntrospectionErrorResponse) {", "originalCommit": "795c115f6a10d54c80d32adeecd55794f517167c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2OTYwMQ==", "url": "https://github.com/bakdata/conquery/pull/1292#discussion_r458869601", "bodyText": "inline", "author": "awildturtok", "createdAt": "2020-07-22T15:14:25Z", "path": "backend/src/main/java/com/bakdata/conquery/models/auth/oidc/passwordflow/OIDCResourceOwnerPasswordCredeantialRealm.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package com.bakdata.conquery.models.auth.oidc.passwordflow;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationInfo;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationRealm;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler.JwtToken;\n+import com.bakdata.conquery.models.auth.basic.UsernamePasswordChecker;\n+import com.bakdata.conquery.models.auth.entities.User;\n+import com.bakdata.conquery.models.auth.util.SkippingCredentialsMatcher;\n+import com.bakdata.conquery.models.identifiable.ids.specific.UserId;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthAdminUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthApiUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.LoginResource;\n+import com.bakdata.conquery.resources.unprotected.TokenResource;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.nimbusds.oauth2.sdk.AccessTokenResponse;\n+import com.nimbusds.oauth2.sdk.AuthorizationGrant;\n+import com.nimbusds.oauth2.sdk.ParseException;\n+import com.nimbusds.oauth2.sdk.ResourceOwnerPasswordCredentialsGrant;\n+import com.nimbusds.oauth2.sdk.Scope;\n+import com.nimbusds.oauth2.sdk.TokenErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionRequest;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionSuccessResponse;\n+import com.nimbusds.oauth2.sdk.TokenRequest;\n+import com.nimbusds.oauth2.sdk.TokenResponse;\n+import com.nimbusds.oauth2.sdk.auth.ClientAuthentication;\n+import com.nimbusds.oauth2.sdk.auth.ClientSecretBasic;\n+import com.nimbusds.oauth2.sdk.auth.Secret;\n+import com.nimbusds.oauth2.sdk.id.ClientID;\n+import com.nimbusds.oauth2.sdk.token.AccessToken;\n+import com.nimbusds.oauth2.sdk.token.TypelessAccessToken;\n+import io.dropwizard.jersey.DropwizardResourceConfig;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.keycloak.authorization.client.AuthzClient;\n+\n+@Slf4j\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class OIDCResourceOwnerPasswordCredeantialRealm extends ConqueryAuthenticationRealm implements AuthApiUnprotectedResourceProvider, AuthAdminUnprotectedResourceProvider, UsernamePasswordChecker {\n+\n+\tprivate static final Class<? extends AuthenticationToken> TOKEN_CLASS = JwtToken.class;\n+\t\n+\tprivate final MasterMetaStorage storage;\n+\tprivate final OIDCResourceOwnerPasswordCredeantialRealmFactory config;\n+\t\n+\tprivate ClientAuthentication clientAuthentication;\n+\tprivate AuthzClient authzClient;\n+\t\n+\tprivate LoadingCache<JwtToken, TokenIntrospectionSuccessResponse> tokenCache = CacheBuilder.newBuilder()\n+\t\t.expireAfterWrite(10, TimeUnit.MINUTES)\n+\t\t.build(new TokenValidator());\n+\t\n+\t@Override\n+\tprotected void onInit() {\n+\t\tsuper.onInit();\n+\t\tthis.setCredentialsMatcher(new SkippingCredentialsMatcher());\n+\t\tthis.setAuthenticationTokenClass(TOKEN_CLASS);\n+\t\tthis.clientAuthentication = new ClientSecretBasic(new ClientID(config.getResource()), new Secret((String)config.getCredentials().get(\"secret\")));\n+\t\t\n+\t\tauthzClient = AuthzClient.create(config);\n+\t}\n+\t\n+\t@Override\n+\t@SneakyThrows\n+\tprotected ConqueryAuthenticationInfo doGetConqueryAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+\t\t\n+\t\tTokenIntrospectionSuccessResponse successResponse = tokenCache.get((JwtToken) token);\n+\n+\t\tString username = successResponse.getUsername();\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tusername = successResponse.getStringParameter(\"preferred_username\");\n+\t\t}\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve a user identifier from validated token. Dismissing the token.\");\n+\t\t}\n+\t\t\n+\t\tUserId userId = new UserId(username);\n+\t\tUser user = storage.getUser(userId);\n+\t\t// try to construct a new User if none could be found in the storage\n+\t\tif (user == null) {\n+\t\t\tString userLabel = successResponse.getStringParameter(\"name\");\n+\t\t\tuser = new User(username, userLabel != null ?  userLabel : username);\n+\t\t\tstorage.addUser(user);\n+\t\t\tlog.info(\n+\t\t\t\t\"Created new user: {}\",\n+\t\t\t\tuser);\n+\t\t}\n+\n+\t\treturn new ConqueryAuthenticationInfo(user.getId(), token, this, false);\n+\t}\n+\n+\tprivate TokenIntrospectionSuccessResponse validateToken(AuthenticationToken token) throws URISyntaxException, MalformedURLException, ParseException, IOException {\n+\t\tURI tokenIntrospectEndpoint =  new URL(new URL(config.getAuthServerUrl()),\"realms/EVA/protocol/openid-connect/token/introspect\").toURI();\n+\t\tTokenIntrospectionRequest request = new TokenIntrospectionRequest(tokenIntrospectEndpoint , clientAuthentication, new TypelessAccessToken((String) token.getCredentials()));\n+\t\t\n+\t\tTokenIntrospectionResponse response = TokenIntrospectionResponse.parse(request.toHTTPRequest().send());\n+\t\t\n+\t\tif (response instanceof TokenIntrospectionErrorResponse) {\n+\t\t\tlog.error(((TokenIntrospectionErrorResponse) response).getErrorObject().toString());\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve access token from auth server.\");\n+\t\t}\n+\t\telse if (!(response instanceof TokenIntrospectionSuccessResponse)) {\n+\t\t\tlog.error(\"Unknown token response {}.\", response.getClass().getName());\n+\t\t\tthrow new IllegalStateException(\"Unknown token response. See log.\");\n+\t\t}\n+\n+\t\tTokenIntrospectionSuccessResponse successResponse = (TokenIntrospectionSuccessResponse) response;\n+\t\treturn successResponse;", "originalCommit": "795c115f6a10d54c80d32adeecd55794f517167c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2OTg1Mw==", "url": "https://github.com/bakdata/conquery/pull/1292#discussion_r458869853", "bodyText": "Konstante", "author": "awildturtok", "createdAt": "2020-07-22T15:14:45Z", "path": "backend/src/main/java/com/bakdata/conquery/models/auth/oidc/passwordflow/OIDCResourceOwnerPasswordCredeantialRealm.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package com.bakdata.conquery.models.auth.oidc.passwordflow;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationInfo;\n+import com.bakdata.conquery.models.auth.ConqueryAuthenticationRealm;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler;\n+import com.bakdata.conquery.models.auth.basic.TokenHandler.JwtToken;\n+import com.bakdata.conquery.models.auth.basic.UsernamePasswordChecker;\n+import com.bakdata.conquery.models.auth.entities.User;\n+import com.bakdata.conquery.models.auth.util.SkippingCredentialsMatcher;\n+import com.bakdata.conquery.models.identifiable.ids.specific.UserId;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthAdminUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.AuthServlet.AuthApiUnprotectedResourceProvider;\n+import com.bakdata.conquery.resources.unprotected.LoginResource;\n+import com.bakdata.conquery.resources.unprotected.TokenResource;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import com.nimbusds.oauth2.sdk.AccessTokenResponse;\n+import com.nimbusds.oauth2.sdk.AuthorizationGrant;\n+import com.nimbusds.oauth2.sdk.ParseException;\n+import com.nimbusds.oauth2.sdk.ResourceOwnerPasswordCredentialsGrant;\n+import com.nimbusds.oauth2.sdk.Scope;\n+import com.nimbusds.oauth2.sdk.TokenErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionErrorResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionRequest;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionResponse;\n+import com.nimbusds.oauth2.sdk.TokenIntrospectionSuccessResponse;\n+import com.nimbusds.oauth2.sdk.TokenRequest;\n+import com.nimbusds.oauth2.sdk.TokenResponse;\n+import com.nimbusds.oauth2.sdk.auth.ClientAuthentication;\n+import com.nimbusds.oauth2.sdk.auth.ClientSecretBasic;\n+import com.nimbusds.oauth2.sdk.auth.Secret;\n+import com.nimbusds.oauth2.sdk.id.ClientID;\n+import com.nimbusds.oauth2.sdk.token.AccessToken;\n+import com.nimbusds.oauth2.sdk.token.TypelessAccessToken;\n+import io.dropwizard.jersey.DropwizardResourceConfig;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.shiro.authc.AuthenticationException;\n+import org.apache.shiro.authc.AuthenticationToken;\n+import org.keycloak.authorization.client.AuthzClient;\n+\n+@Slf4j\n+@Getter\n+@Setter\n+@RequiredArgsConstructor\n+public class OIDCResourceOwnerPasswordCredeantialRealm extends ConqueryAuthenticationRealm implements AuthApiUnprotectedResourceProvider, AuthAdminUnprotectedResourceProvider, UsernamePasswordChecker {\n+\n+\tprivate static final Class<? extends AuthenticationToken> TOKEN_CLASS = JwtToken.class;\n+\t\n+\tprivate final MasterMetaStorage storage;\n+\tprivate final OIDCResourceOwnerPasswordCredeantialRealmFactory config;\n+\t\n+\tprivate ClientAuthentication clientAuthentication;\n+\tprivate AuthzClient authzClient;\n+\t\n+\tprivate LoadingCache<JwtToken, TokenIntrospectionSuccessResponse> tokenCache = CacheBuilder.newBuilder()\n+\t\t.expireAfterWrite(10, TimeUnit.MINUTES)\n+\t\t.build(new TokenValidator());\n+\t\n+\t@Override\n+\tprotected void onInit() {\n+\t\tsuper.onInit();\n+\t\tthis.setCredentialsMatcher(new SkippingCredentialsMatcher());\n+\t\tthis.setAuthenticationTokenClass(TOKEN_CLASS);\n+\t\tthis.clientAuthentication = new ClientSecretBasic(new ClientID(config.getResource()), new Secret((String)config.getCredentials().get(\"secret\")));\n+\t\t\n+\t\tauthzClient = AuthzClient.create(config);\n+\t}\n+\t\n+\t@Override\n+\t@SneakyThrows\n+\tprotected ConqueryAuthenticationInfo doGetConqueryAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {\n+\t\t\n+\t\tTokenIntrospectionSuccessResponse successResponse = tokenCache.get((JwtToken) token);\n+\n+\t\tString username = successResponse.getUsername();\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tusername = successResponse.getStringParameter(\"preferred_username\");\n+\t\t}\n+\t\tif(StringUtils.isBlank(username)) {\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve a user identifier from validated token. Dismissing the token.\");\n+\t\t}\n+\t\t\n+\t\tUserId userId = new UserId(username);\n+\t\tUser user = storage.getUser(userId);\n+\t\t// try to construct a new User if none could be found in the storage\n+\t\tif (user == null) {\n+\t\t\tString userLabel = successResponse.getStringParameter(\"name\");\n+\t\t\tuser = new User(username, userLabel != null ?  userLabel : username);\n+\t\t\tstorage.addUser(user);\n+\t\t\tlog.info(\n+\t\t\t\t\"Created new user: {}\",\n+\t\t\t\tuser);\n+\t\t}\n+\n+\t\treturn new ConqueryAuthenticationInfo(user.getId(), token, this, false);\n+\t}\n+\n+\tprivate TokenIntrospectionSuccessResponse validateToken(AuthenticationToken token) throws URISyntaxException, MalformedURLException, ParseException, IOException {\n+\t\tURI tokenIntrospectEndpoint =  new URL(new URL(config.getAuthServerUrl()),\"realms/EVA/protocol/openid-connect/token/introspect\").toURI();\n+\t\tTokenIntrospectionRequest request = new TokenIntrospectionRequest(tokenIntrospectEndpoint , clientAuthentication, new TypelessAccessToken((String) token.getCredentials()));\n+\t\t\n+\t\tTokenIntrospectionResponse response = TokenIntrospectionResponse.parse(request.toHTTPRequest().send());\n+\t\t\n+\t\tif (response instanceof TokenIntrospectionErrorResponse) {\n+\t\t\tlog.error(((TokenIntrospectionErrorResponse) response).getErrorObject().toString());\n+\t\t\tthrow new IllegalStateException(\"Unable to retrieve access token from auth server.\");\n+\t\t}\n+\t\telse if (!(response instanceof TokenIntrospectionSuccessResponse)) {\n+\t\t\tlog.error(\"Unknown token response {}.\", response.getClass().getName());\n+\t\t\tthrow new IllegalStateException(\"Unknown token response. See log.\");\n+\t\t}\n+\n+\t\tTokenIntrospectionSuccessResponse successResponse = (TokenIntrospectionSuccessResponse) response;\n+\t\treturn successResponse;\n+\t}\n+\n+\t@Override\n+\tpublic AuthenticationToken extractToken(ContainerRequestContext request) {\n+\t\treturn TokenHandler.extractToken(request);\n+\t}\n+\t\n+\t@Override\n+\tpublic void registerAdminUnprotectedAuthenticationResources(DropwizardResourceConfig jerseyConfig) {\n+\t\tjerseyConfig.register(new TokenResource(this));\n+\t\tjerseyConfig.register(LoginResource.class);\n+\t}\n+\n+\t@Override\n+\tpublic void registerApiUnprotectedAuthenticationResources(DropwizardResourceConfig jerseyConfig) {\n+\t\tjerseyConfig.register(new TokenResource(this));\n+\t}\n+\n+\t@Override\n+\t@SneakyThrows\n+\tpublic String checkCredentialsAndCreateJWT(String username, char[] password) {\n+\t\tSecret passwordSecret = new Secret(new String(password));\n+\n+\t\tAuthorizationGrant  grant = new ResourceOwnerPasswordCredentialsGrant(username, passwordSecret);\n+\t\t\t\t\n+\t\tURI tokenEndpoint =  new URL(new URL(config.getAuthServerUrl()),\"realms/EVA/protocol/openid-connect/token\").toURI();", "originalCommit": "795c115f6a10d54c80d32adeecd55794f517167c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f21d19cf65bd7db9a46d12e5e7b756798211d1f", "url": "https://github.com/bakdata/conquery/commit/6f21d19cf65bd7db9a46d12e5e7b756798211d1f", "message": "get URIs from well-known endpoint", "committedDate": "2020-07-23T16:15:03Z", "type": "forcePushed"}, {"oid": "cba6ec5227f297d46a2e25805f10916e82e45177", "url": "https://github.com/bakdata/conquery/commit/cba6ec5227f297d46a2e25805f10916e82e45177", "message": "checkout source branch first before pushing docs", "committedDate": "2020-07-24T09:27:57Z", "type": "forcePushed"}, {"oid": "ad28e9dbeab5801c3a8b11861714ad98031bcbfb", "url": "https://github.com/bakdata/conquery/commit/ad28e9dbeab5801c3a8b11861714ad98031bcbfb", "message": "Merge branch 'feature/fix-autodoc-ci-merge' into feature/oicd-Resource-Owner-Password-Credential-Grant", "committedDate": "2020-07-24T09:44:20Z", "type": "forcePushed"}, {"oid": "e2ea0dab1b4bc45cf879fa90e433f5ec6d93095b", "url": "https://github.com/bakdata/conquery/commit/e2ea0dab1b4bc45cf879fa90e433f5ec6d93095b", "message": "uses more specific authentication exception type", "committedDate": "2020-07-27T12:57:38Z", "type": "forcePushed"}, {"oid": "993c53a034137937d93fe9307fb8d8214093fb7a", "url": "https://github.com/bakdata/conquery/commit/993c53a034137937d93fe9307fb8d8214093fb7a", "message": "authenticates user through keycloak", "committedDate": "2020-07-27T16:24:16Z", "type": "commit"}, {"oid": "fa120748c486899bcbf746e4c1cc4adb98bfadc0", "url": "https://github.com/bakdata/conquery/commit/fa120748c486899bcbf746e4c1cc4adb98bfadc0", "message": "comment out failing authz lib statement", "committedDate": "2020-07-27T16:24:16Z", "type": "commit"}, {"oid": "ecbd5102294e72f80e6bceed3dd9164c5b81dec8", "url": "https://github.com/bakdata/conquery/commit/ecbd5102294e72f80e6bceed3dd9164c5b81dec8", "message": "update to new method interface", "committedDate": "2020-07-27T16:24:16Z", "type": "commit"}, {"oid": "9e5adc74afd4fd80ef37d9f7c78b4b63f02f5b57", "url": "https://github.com/bakdata/conquery/commit/9e5adc74afd4fd80ef37d9f7c78b4b63f02f5b57", "message": "trying keycloak lib", "committedDate": "2020-07-27T16:24:16Z", "type": "commit"}, {"oid": "b0868a157dda6cfbc514763ebdcb44ec4fc60468", "url": "https://github.com/bakdata/conquery/commit/b0868a157dda6cfbc514763ebdcb44ec4fc60468", "message": "sets hideUserLogout flag", "committedDate": "2020-07-27T16:24:16Z", "type": "commit"}, {"oid": "1dae3efaebc96958ba48f6e229027b0a34806f14", "url": "https://github.com/bakdata/conquery/commit/1dae3efaebc96958ba48f6e229027b0a34806f14", "message": "caches validated tokens", "committedDate": "2020-07-27T16:24:17Z", "type": "commit"}, {"oid": "ed44c493d269ba206f7f3923da15f2a4deab8607", "url": "https://github.com/bakdata/conquery/commit/ed44c493d269ba206f7f3923da15f2a4deab8607", "message": "automatic update to docs", "committedDate": "2020-07-27T16:24:17Z", "type": "commit"}, {"oid": "f8e27c86b0f04bb630eeb2078be6fa020fda63a2", "url": "https://github.com/bakdata/conquery/commit/f8e27c86b0f04bb630eeb2078be6fa020fda63a2", "message": "negate internal meaning of logout flag", "committedDate": "2020-07-27T16:24:17Z", "type": "commit"}, {"oid": "919341776f8bf94f321af0261ed613d1c7150ec0", "url": "https://github.com/bakdata/conquery/commit/919341776f8bf94f321af0261ed613d1c7150ec0", "message": "get URIs from well-known endpoint", "committedDate": "2020-07-27T16:24:17Z", "type": "commit"}, {"oid": "0cea3dad1f1d8a5e37028fd77bbbda6b8864a039", "url": "https://github.com/bakdata/conquery/commit/0cea3dad1f1d8a5e37028fd77bbbda6b8864a039", "message": "fixes typo", "committedDate": "2020-07-27T16:24:17Z", "type": "commit"}, {"oid": "e41d787e7070473aebfd94a03179cf9ed3dc41d3", "url": "https://github.com/bakdata/conquery/commit/e41d787e7070473aebfd94a03179cf9ed3dc41d3", "message": "automatic update to docs", "committedDate": "2020-07-27T16:24:18Z", "type": "commit"}, {"oid": "54ae2247a95aa05210d80a8bfbe105dfb3eefa07", "url": "https://github.com/bakdata/conquery/commit/54ae2247a95aa05210d80a8bfbe105dfb3eefa07", "message": "check expiration of cached token", "committedDate": "2020-07-27T16:24:18Z", "type": "commit"}, {"oid": "832ac48d46abaa343235fa12d2567ba1d11ddf7a", "url": "https://github.com/bakdata/conquery/commit/832ac48d46abaa343235fa12d2567ba1d11ddf7a", "message": "uses more specific authentication exception type", "committedDate": "2020-07-27T16:24:18Z", "type": "commit"}, {"oid": "832ac48d46abaa343235fa12d2567ba1d11ddf7a", "url": "https://github.com/bakdata/conquery/commit/832ac48d46abaa343235fa12d2567ba1d11ddf7a", "message": "uses more specific authentication exception type", "committedDate": "2020-07-27T16:24:18Z", "type": "forcePushed"}]}