{"pr_number": 1060, "pr_title": "Task deleting old queries", "pr_createdAt": "2020-02-28T17:10:09Z", "pr_url": "https://github.com/bakdata/conquery/pull/1060", "timeline": [{"oid": "804895170c8721bde2aa1f1e5ff58c5992c4821b", "url": "https://github.com/bakdata/conquery/commit/804895170c8721bde2aa1f1e5ff58c5992c4821b", "message": "Initial impl of QueryCleanup", "committedDate": "2020-02-27T15:31:27Z", "type": "commit"}, {"oid": "c0aabaf7fb3377e7a00c1fb4f01ad151a961336e", "url": "https://github.com/bakdata/conquery/commit/c0aabaf7fb3377e7a00c1fb4f01ad151a961336e", "message": "Test and fixes for QueryCleanupTask", "committedDate": "2020-02-28T16:26:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM2MzA2NA==", "url": "https://github.com/bakdata/conquery/pull/1060#discussion_r386363064", "bodyText": "Gut gel\u00f6st :)", "author": "thoniTUB", "createdAt": "2020-03-02T12:26:55Z", "path": "backend/src/main/java/com/bakdata/conquery/tasks/QueryCleanupTask.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.bakdata.conquery.tasks;\n+\n+import java.io.PrintWriter;\n+import java.time.LocalDate;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.execution.ManagedExecution;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ManagedExecutionId;\n+import com.bakdata.conquery.models.query.ManagedQuery;\n+import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n+import com.bakdata.conquery.util.QueryUtils;\n+import com.google.common.collect.ImmutableMultimap;\n+import io.dropwizard.servlets.tasks.Task;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.ArrayUtils;\n+\n+/**\n+ * Dropwizard Task deleting queries that are not used anymore. Defined as:\n+ * \t- not named\n+ * \t- older than 30 days\n+ * \t- is not shared\n+ * \t- no tags\n+ * \t- not referenced by other queries\n+ */\n+@Slf4j\n+public class QueryCleanupTask extends Task {\n+\n+\tMasterMetaStorage storage;\n+\n+\tpublic QueryCleanupTask(MasterMetaStorage storage) {\n+\t\tsuper(\"query-cleanup\");\n+\t\tthis.storage = storage;\n+\t}\n+\n+\t@Override\n+\tpublic void execute(ImmutableMultimap<String, String> parameters, PrintWriter output) throws Exception {\n+\n+\t\t// Iterate for as long as no changes are needed (this is because queries can be referenced by other queries)", "originalCommit": "c0aabaf7fb3377e7a00c1fb4f01ad151a961336e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ed1b0979489557c1d77770bf0274ed27749bff0", "url": "https://github.com/bakdata/conquery/commit/1ed1b0979489557c1d77770bf0274ed27749bff0", "message": "Merge remote-tracking branch 'origin/develop' into feature/delete-old-queries\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/execution/ManagedExecution.java", "committedDate": "2020-03-16T14:15:47Z", "type": "commit"}, {"oid": "91ebced799092470d29fd9eb1cc5d6d65913de2b", "url": "https://github.com/bakdata/conquery/commit/91ebced799092470d29fd9eb1cc5d6d65913de2b", "message": "Merge remote-tracking branch 'origin/develop' into feature/delete-old-queries\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/execution/ManagedExecution.java", "committedDate": "2020-03-16T14:39:44Z", "type": "commit"}, {"oid": "8ef8eb48d786d31fb346d8a3de350271700d2653", "url": "https://github.com/bakdata/conquery/commit/8ef8eb48d786d31fb346d8a3de350271700d2653", "message": "Fixed failing QueryCleanupTaskTest: LocalDateTime::until expects LocalDateTime", "committedDate": "2020-03-16T15:03:38Z", "type": "commit"}, {"oid": "45cce5a795f73f22f114c1dc4f4d7bcd03bfee6b", "url": "https://github.com/bakdata/conquery/commit/45cce5a795f73f22f114c1dc4f4d7bcd03bfee6b", "message": "Merge branch 'develop' into feature/delete-old-queries", "committedDate": "2020-03-16T15:57:57Z", "type": "commit"}]}