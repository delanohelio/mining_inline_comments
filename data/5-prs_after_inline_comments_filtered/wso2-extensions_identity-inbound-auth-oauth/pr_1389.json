{"pr_number": 1389, "pr_title": "Implement OAuth data deletion on Tenant Deletion", "pr_createdAt": "2020-06-02T06:56:39Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389", "timeline": [{"oid": "b800019929045af135094527274c2beb8896768e", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/b800019929045af135094527274c2beb8896768e", "message": "Implement OAuth data deletion on Tenant Deletion", "committedDate": "2020-06-02T06:58:14Z", "type": "forcePushed"}, {"oid": "5326ccdfd73f4b4af501d20fd764d692a55f02f4", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/5326ccdfd73f4b4af501d20fd764d692a55f02f4", "message": "Implement OAuth data deletion on Tenant Deletion", "committedDate": "2020-06-02T07:00:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTkzNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r440829937", "bodyText": "What about the applications cached?", "author": "mefarazath", "createdAt": "2020-06-16T13:00:21Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -865,6 +865,22 @@ public void removeOAuthApplicationData(String consumerKey) throws IdentityOAuthA\n \n     }\n \n+    /**\n+     * Remove all OAuth consumer applications of a tenant.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityOAuthAdminException\n+     */\n+    public void removeAllOAuthApplicationData(int tenantId) throws IdentityOAuthAdminException {\n+\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"Deleting all OAuth Application data of the tenant: \" + tenantId);\n+        }\n+\n+        OAuthAppDAO dao = new OAuthAppDAO();\n+        dao.removeConsumerApplicationsByTenantId(tenantId);", "originalCommit": "5326ccdfd73f4b4af501d20fd764d692a55f02f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzMDcyMg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r440830722", "bodyText": "Also, we need to check what happens to the OAuth app -> Service Provider associations with this delete.", "author": "mefarazath", "createdAt": "2020-06-16T13:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0NTYyMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r442745623", "bodyText": "Do we need to separately delete OAuth apps?  OAuth apps should be auto-deleted when we delete the Service Providers. So, This step is not required.\n@mefarazath WDYT?", "author": "IsuraD", "createdAt": "2020-06-19T09:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc2MDAyOQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r442760029", "bodyText": "I think, there we only delete from SP tables. Thus let's keep this.  As Farasath mentioned, we have to delete the associations too.", "author": "IsuraD", "createdAt": "2020-06-19T10:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyOTkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA3Njk3OQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r442076979", "bodyText": "these 2 try blocks can be combined.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T09:00:16Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/dao/OAuthAppDAO.java", "diffHunk": "@@ -695,6 +695,32 @@ public void removeConsumerApplication(String consumerKey) throws IdentityOAuthAd\n         }\n     }\n \n+    /**\n+     * Delete all consumer applications of a given tenant.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws IdentityOAuthAdminException\n+     */\n+    public void removeConsumerApplicationsByTenantId(int tenantId) throws IdentityOAuthAdminException {\n+\n+        try (Connection connection = IdentityDatabaseUtil.getDBConnection(false)) {\n+            try (PreparedStatement prepStmt = connection", "originalCommit": "5326ccdfd73f4b4af501d20fd764d692a55f02f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc0NDY0Ng==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r442744646", "bodyText": "Can't we reuse the TenantCreationEventListener?", "author": "IsuraD", "createdAt": "2020-06-19T09:52:25Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/IdentityOAuthTenantMgtListener.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.wso2.carbon.identity.oauth.IdentityOAuthAdminException;\n+import org.wso2.carbon.identity.oauth2.internal.OAuth2ServiceComponentHolder;\n+import org.wso2.carbon.stratos.common.beans.TenantInfoBean;\n+import org.wso2.carbon.stratos.common.exception.StratosException;\n+import org.wso2.carbon.stratos.common.listeners.TenantMgtListener;\n+\n+/**\n+ * Identity OAuth Tenant Management Listener.\n+ */\n+public class IdentityOAuthTenantMgtListener implements TenantMgtListener {", "originalCommit": "5326ccdfd73f4b4af501d20fd764d692a55f02f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "accbe641d1dc4e0d37dee36749b878fdbee28ced", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/accbe641d1dc4e0d37dee36749b878fdbee28ced", "message": "Implement OAuth data deletion on Tenant Deletion", "committedDate": "2020-06-21T19:58:07Z", "type": "forcePushed"}, {"oid": "06e35f24144a964762575993bcb87d4789e43b02", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/06e35f24144a964762575993bcb87d4789e43b02", "message": "Implement OAuth data deletion on Tenant Deletion", "committedDate": "2020-06-24T08:23:09Z", "type": "commit"}, {"oid": "06e35f24144a964762575993bcb87d4789e43b02", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/06e35f24144a964762575993bcb87d4789e43b02", "message": "Implement OAuth data deletion on Tenant Deletion", "committedDate": "2020-06-24T08:23:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI1MDU2Mg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r544250562", "bodyText": "Change this as follows:\nAnd check this throughout the PR\n@param tenantId of the tenant", "author": "Kanapriya", "createdAt": "2020-12-16T12:14:34Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/OAuthAdminServiceImpl.java", "diffHunk": "@@ -865,6 +865,22 @@ public void removeOAuthApplicationData(String consumerKey) throws IdentityOAuthA\n \n     }\n \n+    /**\n+     * Remove all OAuth consumer applications of a tenant.\n+     *\n+     * @param tenantId Id of the tenant", "originalCommit": "06e35f24144a964762575993bcb87d4789e43b02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkzNDM2MQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1389#discussion_r552934361", "bodyText": "I have placed it there as, tenantId is the parameter name and Id of the tenant is the description. Hope that's fine.", "author": "sumedhe", "createdAt": "2021-01-06T20:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI1MDU2Mg=="}], "type": "inlineReview"}]}