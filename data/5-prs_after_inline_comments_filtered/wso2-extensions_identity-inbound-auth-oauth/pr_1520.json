{"pr_number": 1520, "pr_title": "Add token to session mapping and revoke token when session is terminated by api", "pr_createdAt": "2020-12-18T05:25:14Z", "pr_url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520", "timeline": [{"oid": "a0b21691ae66750b4962859b73677ab434ddd324", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/a0b21691ae66750b4962859b73677ab434ddd324", "message": "Add ability revoke tokens when session is removed via session termination API", "committedDate": "2020-12-18T05:26:46Z", "type": "forcePushed"}, {"oid": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "message": "Add ability revoke tokens when session is removed via session termination API", "committedDate": "2020-12-18T06:34:48Z", "type": "commit"}, {"oid": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "message": "Add ability revoke tokens when session is removed via session termination API", "committedDate": "2020-12-18T06:34:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNDgyNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546624827", "bodyText": "Change it to DEFAULT", "author": "piraveena", "createdAt": "2020-12-21T10:23:07Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/AccessTokenDAOImpl.java", "diffHunk": "@@ -941,13 +942,65 @@ private void setTokenBindingToAccessTokenDO(AccessTokenDO dataDO, Connection con\n             tokenBindingPreparedStatement.setString(1, tokenId);\n             try (ResultSet tokenBindingResultSet = tokenBindingPreparedStatement.executeQuery()) {\n                 if (tokenBindingResultSet.next()) {\n-                    TokenBinding tokenBinding = new TokenBinding();\n-                    tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n-                    tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n-                    tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n-                    dataDO.setTokenBinding(tokenBinding);\n+                    if (!StringUtils.equals(\"commonauth\", tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"))) {\n+                        TokenBinding tokenBinding = new TokenBinding();\n+                        tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n+                        tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n+                        tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n+                        dataDO.setTokenBinding(tokenBinding);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void storeTokenToSessionMapping(String sessionContextIdentifier, String tokenId, int tenantId)\n+            throws IdentityOAuth2Exception {\n+\n+        if (isNotBlank(sessionContextIdentifier)) {\n+            Connection connection = IdentityDatabaseUtil.getDBConnection(false);\n+            try (PreparedStatement preparedStatement = connection.prepareStatement(STORE_TOKEN_BINDING)) {\n+                preparedStatement.setString(1, tokenId);\n+                preparedStatement.setString(2, \"commonauth\");", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNjAzNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546626034", "bodyText": "OAuthEventInterceptorListener -> OAuthTokenSessionMappingEventHandler", "author": "piraveena", "createdAt": "2020-12-21T10:25:29Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/internal/OAuthServiceComponent.java", "diffHunk": "@@ -88,6 +89,8 @@ protected void activate(ComponentContext context) {\n \n             OAuthComponentServiceHolder.getInstance().setOAuthAdminService(oauthAdminService);\n             OAuth2ServiceComponentHolder.getInstance().setOAuthAdminService(oauthAdminService);\n+            context.getBundleContext().registerService(OAuthEventInterceptor.class, new OAuthEventInterceptorListener(),", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNjE4OA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546626188", "bodyText": "add a debug logs for this", "author": "piraveena", "createdAt": "2020-12-21T10:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNjAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNjU4Nw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546626587", "bodyText": "add more context info to debug logs", "author": "piraveena", "createdAt": "2020-12-21T10:26:34Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/OAuthEventInterceptorListener.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCache;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheEntry;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheKey;\n+import org.wso2.carbon.identity.oauth.event.AbstractOAuthEventInterceptor;\n+import org.wso2.carbon.identity.oauth2.IdentityOAuth2Exception;\n+import org.wso2.carbon.identity.oauth2.authz.OAuthAuthzReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.dao.OAuthTokenPersistenceFactory;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenReqDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenRespDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AuthorizeRespDTO;\n+import org.wso2.carbon.identity.oauth2.model.AccessTokenDO;\n+import org.wso2.carbon.identity.oauth2.token.OAuthTokenReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.util.OAuth2Util;\n+\n+import java.util.Map;\n+\n+import static org.apache.commons.lang.StringUtils.isNotBlank;\n+\n+/**\n+ * This class extends OAuthEventInterceptor and listen to oauth related events.\n+ */\n+public class OAuthEventInterceptorListener extends AbstractOAuthEventInterceptor {\n+\n+    private static final Log log = LogFactory.getLog(OAuthEventInterceptorListener.class);\n+\n+    @Override\n+    public void onPostTokenIssue(OAuth2AccessTokenReqDTO tokenReqDTO, OAuth2AccessTokenRespDTO tokenRespDTO,\n+                                 OAuthTokenReqMessageContext tokReqMsgCtx, Map<String, Object> params) throws\n+            IdentityOAuth2Exception {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Listening to the post token issue event\");", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNjc2NA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546626764", "bodyText": "have method comments", "author": "piraveena", "createdAt": "2020-12-21T10:26:53Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/OAuthEventInterceptorListener.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCache;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheEntry;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheKey;\n+import org.wso2.carbon.identity.oauth.event.AbstractOAuthEventInterceptor;\n+import org.wso2.carbon.identity.oauth2.IdentityOAuth2Exception;\n+import org.wso2.carbon.identity.oauth2.authz.OAuthAuthzReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.dao.OAuthTokenPersistenceFactory;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenReqDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenRespDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AuthorizeRespDTO;\n+import org.wso2.carbon.identity.oauth2.model.AccessTokenDO;\n+import org.wso2.carbon.identity.oauth2.token.OAuthTokenReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.util.OAuth2Util;\n+\n+import java.util.Map;\n+\n+import static org.apache.commons.lang.StringUtils.isNotBlank;\n+\n+/**\n+ * This class extends OAuthEventInterceptor and listen to oauth related events.\n+ */\n+public class OAuthEventInterceptorListener extends AbstractOAuthEventInterceptor {\n+\n+    private static final Log log = LogFactory.getLog(OAuthEventInterceptorListener.class);\n+\n+    @Override\n+    public void onPostTokenIssue(OAuth2AccessTokenReqDTO tokenReqDTO, OAuth2AccessTokenRespDTO tokenRespDTO,", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyOTMyMA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546629320", "bodyText": "simplify methods", "author": "piraveena", "createdAt": "2020-12-21T10:32:22Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/OAuthEventInterceptorListener.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCache;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheEntry;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheKey;\n+import org.wso2.carbon.identity.oauth.event.AbstractOAuthEventInterceptor;\n+import org.wso2.carbon.identity.oauth2.IdentityOAuth2Exception;\n+import org.wso2.carbon.identity.oauth2.authz.OAuthAuthzReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.dao.OAuthTokenPersistenceFactory;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenReqDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenRespDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AuthorizeRespDTO;\n+import org.wso2.carbon.identity.oauth2.model.AccessTokenDO;\n+import org.wso2.carbon.identity.oauth2.token.OAuthTokenReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.util.OAuth2Util;\n+\n+import java.util.Map;\n+\n+import static org.apache.commons.lang.StringUtils.isNotBlank;\n+\n+/**\n+ * This class extends OAuthEventInterceptor and listen to oauth related events.\n+ */\n+public class OAuthEventInterceptorListener extends AbstractOAuthEventInterceptor {\n+\n+    private static final Log log = LogFactory.getLog(OAuthEventInterceptorListener.class);\n+\n+    @Override\n+    public void onPostTokenIssue(OAuth2AccessTokenReqDTO tokenReqDTO, OAuth2AccessTokenRespDTO tokenRespDTO,\n+                                 OAuthTokenReqMessageContext tokReqMsgCtx, Map<String, Object> params) throws\n+            IdentityOAuth2Exception {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Listening to the post token issue event\");\n+        }\n+        String tokenId = tokenRespDTO.getTokenId();\n+        String code = tokenReqDTO.getAuthorizationCode();\n+        String sessionContextId = null;\n+        if (StringUtils.isBlank(code)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Since Authorization code is null, couldn't find session context identifier \" +\n+                        \"for the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        sessionContextId = getSessionContextIdentifier(code);\n+        String tenantDomain = tokenReqDTO.getTenantDomain();\n+        if (StringUtils.isBlank(tenantDomain)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the tenant domain of the application: \" + tokenReqDTO.getClientId());", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMDE0MA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546630140", "bodyText": "add a audit log when session to token mapping  is revoked", "author": "piraveena", "createdAt": "2020-12-21T10:34:11Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/token/bindings/handlers/TokenBindingExpiryEventHandler.java", "diffHunk": "@@ -78,6 +86,11 @@ public void handleEvent(Event event) throws IdentityEventException {\n                 .EventProperty.CONTEXT);\n         try {\n             if (request == null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"HttpServletRequest object is null. Hence getting the session related information from \" +\n+                            \"event and revoking the access tokens bound to sso-session binding\");\n+                }\n+                revokeAccessTokensMappedForSessions(event);", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEyMzMxMQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r547123311", "bodyText": "We have audit logs for each oauth related events in this repo https://github.com/wso2-extensions/identity-data-publisher-oauth/tree/02681715805e8d6375cee67c289e502f0df9ed43/components/org.wso2.carbon.identity.data.publisher.oauth/src/main/java/org/wso2/carbon/identity/data/publisher/oauth/listener. We have token revocationaudit logger as well. So that can have this logging part. We don't need the explicitly handle it", "author": "piraveena", "createdAt": "2020-12-22T07:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzY0Njk5Ng==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r547646996", "bodyText": "Got to know that the audit logs from these components don't have detailed context information such as action/event what caused the token revocation. Check the possibility of adding an audit log with the information about the session termination event.", "author": "ayshsandu", "createdAt": "2020-12-23T05:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMDE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcwMTYxOQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r547701619", "bodyText": "tracked with wso2/product-is#10843", "author": "piraveena", "createdAt": "2020-12-23T06:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMDE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMTIwNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546631204", "bodyText": "read it from config in identity.xml to disable or enable it", "author": "piraveena", "createdAt": "2020-12-21T10:36:26Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth/listener/OAuthEventInterceptorListener.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * WSO2 Inc. licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.wso2.carbon.identity.oauth.listener;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCache;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheEntry;\n+import org.wso2.carbon.identity.oauth.cache.AuthorizationGrantCacheKey;\n+import org.wso2.carbon.identity.oauth.event.AbstractOAuthEventInterceptor;\n+import org.wso2.carbon.identity.oauth2.IdentityOAuth2Exception;\n+import org.wso2.carbon.identity.oauth2.authz.OAuthAuthzReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.dao.OAuthTokenPersistenceFactory;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenReqDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AccessTokenRespDTO;\n+import org.wso2.carbon.identity.oauth2.dto.OAuth2AuthorizeRespDTO;\n+import org.wso2.carbon.identity.oauth2.model.AccessTokenDO;\n+import org.wso2.carbon.identity.oauth2.token.OAuthTokenReqMessageContext;\n+import org.wso2.carbon.identity.oauth2.util.OAuth2Util;\n+\n+import java.util.Map;\n+\n+import static org.apache.commons.lang.StringUtils.isNotBlank;\n+\n+/**\n+ * This class extends OAuthEventInterceptor and listen to oauth related events.\n+ */\n+public class OAuthEventInterceptorListener extends AbstractOAuthEventInterceptor {\n+\n+    private static final Log log = LogFactory.getLog(OAuthEventInterceptorListener.class);\n+\n+    @Override\n+    public void onPostTokenIssue(OAuth2AccessTokenReqDTO tokenReqDTO, OAuth2AccessTokenRespDTO tokenRespDTO,\n+                                 OAuthTokenReqMessageContext tokReqMsgCtx, Map<String, Object> params) throws\n+            IdentityOAuth2Exception {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Listening to the post token issue event\");\n+        }\n+        String tokenId = tokenRespDTO.getTokenId();\n+        String code = tokenReqDTO.getAuthorizationCode();\n+        String sessionContextId = null;\n+        if (StringUtils.isBlank(code)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Since Authorization code is null, couldn't find session context identifier \" +\n+                        \"for the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        sessionContextId = getSessionContextIdentifier(code);\n+        String tenantDomain = tokenReqDTO.getTenantDomain();\n+        if (StringUtils.isBlank(tenantDomain)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the tenant domain of the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        if (StringUtils.isBlank(sessionContextId)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the session context identifier for the application: \" +\n+                        tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        persistTokenToSessionMapping(sessionContextId, tokenId, OAuth2Util.getTenantId(tenantDomain));\n+    }\n+\n+    @Override\n+    public void onPostTokenRenewal(OAuth2AccessTokenReqDTO tokenReqDTO, OAuth2AccessTokenRespDTO tokenRespDTO,\n+                                   OAuthTokenReqMessageContext tokReqMsgCtx, Map<String, Object> params) throws\n+            IdentityOAuth2Exception {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Listening to the token renewal event\");\n+        }\n+        String tokenId = tokenRespDTO.getTokenId();\n+        if (StringUtils.isBlank(tokenId)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the tokenId of the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        String accessToken = tokenRespDTO.getAccessToken();\n+        if (StringUtils.isBlank(accessToken)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Since the accesstoken is invalid, couldn't find session context identifier \" +\n+                        \"for the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        String sessionContextId = getSessionContextIdentifier(accessToken);\n+        if (StringUtils.isBlank(sessionContextId)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the session context identifier for the application: \" +\n+                        tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        String tenantDomain = tokenReqDTO.getTenantDomain();\n+        if (StringUtils.isBlank(tenantDomain)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the tenant domain of the application: \" + tokenReqDTO.getClientId());\n+            }\n+            return;\n+        }\n+        int tenantId = OAuth2Util.getTenantId(tenantDomain);\n+        persistTokenToSessionMapping(sessionContextId, tokenId, tenantId);\n+    }\n+\n+    @Override\n+    public void onPostTokenIssue(OAuthAuthzReqMessageContext oauthAuthzMsgCtx, AccessTokenDO tokenDO,\n+                                 OAuth2AuthorizeRespDTO respDTO, Map<String, Object> params)\n+            throws IdentityOAuth2Exception {\n+\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Listening to the token renewal event\");\n+        }\n+        String sessionContextId = oauthAuthzMsgCtx.getAuthorizationReqDTO().getIdpSessionIdentifier();\n+        if (StringUtils.isBlank(sessionContextId)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the session context identifier for the application: \" +\n+                        tokenDO.getConsumerKey());\n+            }\n+            return;\n+        }\n+        String tokenId = tokenDO.getTokenId();\n+        if (StringUtils.isBlank(tokenId)) {\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Could not find the tokenId of the application: \" + tokenDO.getConsumerKey());\n+            }\n+            return;\n+        }\n+        int tenantId = tokenDO.getTenantID();\n+        persistTokenToSessionMapping(sessionContextId, tokenId, tenantId);\n+    }\n+\n+    public boolean isEnabled() {\n+        return true;", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMzU2Ng==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546633566", "bodyText": "if it is not added, it should be enabled.\nif it is added and enabled ->. enabled\nif it is added and no property ->. enabled", "author": "piraveena", "createdAt": "2020-12-21T10:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzMTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNDkzNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546634934", "bodyText": "rename commonauth", "author": "piraveena", "createdAt": "2020-12-21T10:44:18Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/AccessTokenDAOImpl.java", "diffHunk": "@@ -941,13 +942,65 @@ private void setTokenBindingToAccessTokenDO(AccessTokenDO dataDO, Connection con\n             tokenBindingPreparedStatement.setString(1, tokenId);\n             try (ResultSet tokenBindingResultSet = tokenBindingPreparedStatement.executeQuery()) {\n                 if (tokenBindingResultSet.next()) {\n-                    TokenBinding tokenBinding = new TokenBinding();\n-                    tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n-                    tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n-                    tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n-                    dataDO.setTokenBinding(tokenBinding);\n+                    if (!StringUtils.equals(\"commonauth\", tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"))) {", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNTg4Mg==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546635882", "bodyText": "check for tokenId as well", "author": "piraveena", "createdAt": "2020-12-21T10:46:12Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/AccessTokenDAOImpl.java", "diffHunk": "@@ -941,13 +942,65 @@ private void setTokenBindingToAccessTokenDO(AccessTokenDO dataDO, Connection con\n             tokenBindingPreparedStatement.setString(1, tokenId);\n             try (ResultSet tokenBindingResultSet = tokenBindingPreparedStatement.executeQuery()) {\n                 if (tokenBindingResultSet.next()) {\n-                    TokenBinding tokenBinding = new TokenBinding();\n-                    tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n-                    tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n-                    tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n-                    dataDO.setTokenBinding(tokenBinding);\n+                    if (!StringUtils.equals(\"commonauth\", tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"))) {\n+                        TokenBinding tokenBinding = new TokenBinding();\n+                        tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n+                        tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n+                        tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n+                        dataDO.setTokenBinding(tokenBinding);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void storeTokenToSessionMapping(String sessionContextIdentifier, String tokenId, int tenantId)\n+            throws IdentityOAuth2Exception {\n+\n+        if (isNotBlank(sessionContextIdentifier)) {", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNjAwNQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546636005", "bodyText": "add some context info", "author": "piraveena", "createdAt": "2020-12-21T10:46:29Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/AccessTokenDAOImpl.java", "diffHunk": "@@ -941,13 +942,65 @@ private void setTokenBindingToAccessTokenDO(AccessTokenDO dataDO, Connection con\n             tokenBindingPreparedStatement.setString(1, tokenId);\n             try (ResultSet tokenBindingResultSet = tokenBindingPreparedStatement.executeQuery()) {\n                 if (tokenBindingResultSet.next()) {\n-                    TokenBinding tokenBinding = new TokenBinding();\n-                    tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n-                    tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n-                    tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n-                    dataDO.setTokenBinding(tokenBinding);\n+                    if (!StringUtils.equals(\"commonauth\", tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"))) {\n+                        TokenBinding tokenBinding = new TokenBinding();\n+                        tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n+                        tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n+                        tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n+                        dataDO.setTokenBinding(tokenBinding);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void storeTokenToSessionMapping(String sessionContextIdentifier, String tokenId, int tenantId)\n+            throws IdentityOAuth2Exception {\n+\n+        if (isNotBlank(sessionContextIdentifier)) {\n+            Connection connection = IdentityDatabaseUtil.getDBConnection(false);\n+            try (PreparedStatement preparedStatement = connection.prepareStatement(STORE_TOKEN_BINDING)) {\n+                preparedStatement.setString(1, tokenId);\n+                preparedStatement.setString(2, \"commonauth\");\n+                preparedStatement.setString(3,\n+                        OAuth2Util.getTokenBindingReference(sessionContextIdentifier));\n+                preparedStatement.setString(4, sessionContextIdentifier);\n+                preparedStatement.setInt(5, tenantId);\n+                preparedStatement.execute();\n+            } catch (SQLException e) {\n+                String errorMsg = \"Error while persisting token to session mapping\";", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNjgzNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546636837", "bodyText": "can be more tokenId for a same sessionId. need to handle it", "author": "piraveena", "createdAt": "2020-12-21T10:48:15Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/AccessTokenDAOImpl.java", "diffHunk": "@@ -941,13 +942,65 @@ private void setTokenBindingToAccessTokenDO(AccessTokenDO dataDO, Connection con\n             tokenBindingPreparedStatement.setString(1, tokenId);\n             try (ResultSet tokenBindingResultSet = tokenBindingPreparedStatement.executeQuery()) {\n                 if (tokenBindingResultSet.next()) {\n-                    TokenBinding tokenBinding = new TokenBinding();\n-                    tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n-                    tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n-                    tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n-                    dataDO.setTokenBinding(tokenBinding);\n+                    if (!StringUtils.equals(\"commonauth\", tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"))) {\n+                        TokenBinding tokenBinding = new TokenBinding();\n+                        tokenBinding.setBindingType(tokenBindingResultSet.getString(\"TOKEN_BINDING_TYPE\"));\n+                        tokenBinding.setBindingReference(tokenBindingResultSet.getString(\"TOKEN_BINDING_REF\"));\n+                        tokenBinding.setBindingValue(tokenBindingResultSet.getString(\"TOKEN_BINDING_VALUE\"));\n+                        dataDO.setTokenBinding(tokenBinding);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void storeTokenToSessionMapping(String sessionContextIdentifier, String tokenId, int tenantId)\n+            throws IdentityOAuth2Exception {\n+\n+        if (isNotBlank(sessionContextIdentifier)) {\n+            Connection connection = IdentityDatabaseUtil.getDBConnection(false);\n+            try (PreparedStatement preparedStatement = connection.prepareStatement(STORE_TOKEN_BINDING)) {\n+                preparedStatement.setString(1, tokenId);\n+                preparedStatement.setString(2, \"commonauth\");\n+                preparedStatement.setString(3,\n+                        OAuth2Util.getTokenBindingReference(sessionContextIdentifier));\n+                preparedStatement.setString(4, sessionContextIdentifier);\n+                preparedStatement.setInt(5, tenantId);\n+                preparedStatement.execute();\n+            } catch (SQLException e) {\n+                String errorMsg = \"Error while persisting token to session mapping\";\n+                if (log.isDebugEnabled()) {\n+                    log.debug(errorMsg);\n                 }\n+                throw new IdentityOAuth2Exception(errorMsg, e);\n+            } finally {\n+                IdentityDatabaseUtil.closeConnection(connection);\n+            }\n+        }\n+    }\n+\n+    public String getTokenIdByBindingRef(String bindingRef) throws IdentityOAuth2Exception {\n+\n+        String sql = SQLQueries.RETRIEVE_TOKEN_BINDING_BY_TOKEN_REF;\n+        Connection connection = IdentityDatabaseUtil.getDBConnection(false);\n+        PreparedStatement prepStmt = null;", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwNjY4MA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r547106680", "bodyText": "handled it when we persist into the db https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520/files#diff-696a59cde0cb0f5ea0aa4addcfbafa14d3c3743a0ddf6424b2d44ad3e0517216R213", "author": "piraveena", "createdAt": "2020-12-22T07:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNjgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNzAwNA==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546637004", "bodyText": "we need to make tokenId+type+ref as a unique key in the script", "author": "piraveena", "createdAt": "2020-12-21T10:48:39Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/dao/SQLQueries.java", "diffHunk": "@@ -1214,6 +1214,9 @@\n     public static final String RETRIEVE_TOKEN_BINDING_BY_TOKEN_ID = \"SELECT TOKEN_BINDING_TYPE, \"\n             + \"TOKEN_BINDING_REF, TOKEN_BINDING_VALUE FROM IDN_OAUTH2_TOKEN_BINDING WHERE TOKEN_ID = ?\";\n \n+    public static final String RETRIEVE_TOKEN_BINDING_BY_TOKEN_REF = \"SELECT TOKEN_ID FROM IDN_OAUTH2_TOKEN_BINDING \" +\n+            \"WHERE TOKEN_BINDING_REF = ?\";", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNzE1OQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546637159", "bodyText": "capture the migration impact", "author": "piraveena", "createdAt": "2020-12-21T10:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNzAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzcwMTUyNw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r547701527", "bodyText": "tracked with wso2/product-is#10843", "author": "piraveena", "createdAt": "2020-12-23T06:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNzAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzODUzMw==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546638533", "bodyText": "remove this sso binding check. no need to handle it separately", "author": "piraveena", "createdAt": "2020-12-21T10:52:14Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/token/bindings/handlers/TokenBindingExpiryEventHandler.java", "diffHunk": "@@ -100,6 +113,143 @@ public void handleEvent(Event event) throws IdentityEventException {\n         }\n     }\n \n+    /**\n+     * This method will get the application information from session context and revoke access tokens of the\n+     * applications bound to that session. This method can be used when token binding information is not found in the\n+     * request.\n+     *\n+     * @param event Event.\n+     * @throws IdentityOAuth2Exception\n+     * @throws InvalidOAuthClientException\n+     */\n+    private void revokeAccessTokensMappedForSessions(Event event)\n+            throws IdentityOAuth2Exception, InvalidOAuthClientException {\n+\n+        String sessionContextIdentifier = getSessionIdentifier(event);\n+        Map<String, Object> eventProperties = event.getEventProperties();\n+        if (StringUtils.isNotBlank(sessionContextIdentifier)) {\n+            SessionContext sessionContext = (SessionContext) eventProperties.get(IdentityEventConstants\n+                    .EventProperty.SESSION_CONTEXT);\n+            if (sessionContext != null) {\n+                Map<String, SequenceConfig> authenticatedSequences = sessionContext.getAuthenticatedSequences();\n+                if (MapUtils.isEmpty(authenticatedSequences)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Could not find the authenticated sequence config map in the session context \" +\n+                                \"corresponding to the context identifier: \" + sessionContextIdentifier);\n+                    }\n+                    return;\n+                }\n+                AuthenticatedUser user = (AuthenticatedUser) sessionContext\n+                        .getProperty(FrameworkConstants.AUTHENTICATED_USER);\n+                if (user == null) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Authenticated user is not found in the session context \" +\n+                                \"corresponding to the context identifier: \" + sessionContextIdentifier);\n+                    }\n+                    return;\n+                }\n+                String tenantDomain = user.getTenantDomain();\n+                if (StringUtils.isBlank(tenantDomain)) {\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Could not find the tenant domain of the user: \" + user.getUserName());\n+                    }\n+                    return;\n+                }\n+                for (Map.Entry<String, SequenceConfig> sequenceConfigEntry : authenticatedSequences.entrySet()) {\n+                    String applicationName = sequenceConfigEntry.getValue().getApplicationId();\n+                    String clientId = getClientIdFromApplicationName(applicationName, tenantDomain);\n+                    if (StringUtils.isBlank(clientId)) {\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(String.format(\"Client id of the application: %s is not valid\", applicationName));\n+                        }\n+                        return;\n+                    }\n+                    String bindingType = OAuth2Util.getAppInformationByClientId(clientId).getTokenBindingType();\n+                    if (OAuth2Constants.TokenBinderType.SSO_SESSION_BASED_TOKEN_BINDER.equals(bindingType)) {\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(String.format(\"Application: %s has sso-session binding. Hence revoking the access\"", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzOTU2NQ==", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/pull/1520#discussion_r546639565", "bodyText": "no need to pass user here", "author": "piraveena", "createdAt": "2020-12-21T10:54:24Z", "path": "components/org.wso2.carbon.identity.oauth/src/main/java/org/wso2/carbon/identity/oauth2/token/bindings/handlers/TokenBindingExpiryEventHandler.java", "diffHunk": "@@ -197,28 +347,61 @@ private void revokeTokensOfBindingRef(AuthenticatedUser user, String tokenBindin\n         if (StringUtils.isBlank(tokenBindingReference) || user == null) {\n             return;\n         }\n-\n         Set<AccessTokenDO> boundTokens = OAuthTokenPersistenceFactory.getInstance().getAccessTokenDAO()\n                 .getAccessTokensByBindingRef(user, tokenBindingReference);\n-\n         for (AccessTokenDO accessTokenDO : boundTokens) {\n-\n             String consumerKey = accessTokenDO.getConsumerKey();\n+            revokeTokens(consumerKey, accessTokenDO, tokenBindingReference);\n+        }\n+    }\n \n-            if (OAuth2Util.getAppInformationByClientId(consumerKey)\n-                    .isTokenRevocationWithIDPSessionTerminationEnabled()) {\n-\n-                OAuthUtil.clearOAuthCache(consumerKey, accessTokenDO.getAuthzUser(), OAuth2Util.buildScopeString\n-                        (accessTokenDO.getScope()), tokenBindingReference);\n-                OAuthUtil.clearOAuthCache(consumerKey, accessTokenDO.getAuthzUser(), OAuth2Util.buildScopeString\n-                        (accessTokenDO.getScope()));\n-                OAuthUtil.clearOAuthCache(consumerKey, accessTokenDO.getAuthzUser());\n-                OAuthUtil.clearOAuthCache(accessTokenDO.getAccessToken());\n-                OAuthUtil.invokePreRevocationBySystemListeners(accessTokenDO, Collections.emptyMap());\n-                OAuthTokenPersistenceFactory.getInstance().getAccessTokenDAO()\n-                        .revokeAccessTokens(new String[]{accessTokenDO.getAccessToken()}, OAuth2Util.isHashEnabled());\n-                OAuthUtil.invokePostRevocationBySystemListeners(accessTokenDO, Collections.emptyMap());\n+    /**\n+     * Get the access tokens mapped for the session identifier and revoke those tokens.\n+     *\n+     * @param user               Authenticated user.\n+     * @param sessionIdReference Hashed value of the session context identifier.\n+     * @throws IdentityOAuth2Exception\n+     */\n+    private void revokeTokensMappedToSession(AuthenticatedUser user, String sessionIdReference) throws", "originalCommit": "990ec7fa9dc66a29f4a7adfa3f8ba9052cc51f84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e388b43270fb8fbda9e509a2dacccf66e50072c8", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/e388b43270fb8fbda9e509a2dacccf66e50072c8", "message": "Refactor", "committedDate": "2020-12-21T14:02:39Z", "type": "forcePushed"}, {"oid": "e1a19c5cca5b2e89d782128181107961a191ae7c", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/e1a19c5cca5b2e89d782128181107961a191ae7c", "message": "Refactor", "committedDate": "2020-12-22T07:09:06Z", "type": "forcePushed"}, {"oid": "1d3b3bc60067aa567e6df79e8c85cee59dac9bee", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1d3b3bc60067aa567e6df79e8c85cee59dac9bee", "message": "Refactor", "committedDate": "2020-12-22T08:00:27Z", "type": "commit"}, {"oid": "1d3b3bc60067aa567e6df79e8c85cee59dac9bee", "url": "https://github.com/wso2-extensions/identity-inbound-auth-oauth/commit/1d3b3bc60067aa567e6df79e8c85cee59dac9bee", "message": "Refactor", "committedDate": "2020-12-22T08:00:27Z", "type": "forcePushed"}]}