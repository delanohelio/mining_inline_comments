{"pr_number": 8145, "pr_title": "Add input selection for StreamRuleForm", "pr_createdAt": "2020-05-18T11:01:14Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8145", "timeline": [{"oid": "94981df0805ad7e8607d435b6b51078e6e044bc4", "url": "https://github.com/Graylog2/graylog2-server/commit/94981df0805ad7e8607d435b6b51078e6e044bc4", "message": "Fix web linter", "committedDate": "2020-05-18T13:29:34Z", "type": "forcePushed"}, {"oid": "3429f4bf2ceb5348a0db5011c3456dd11104b6e7", "url": "https://github.com/Graylog2/graylog2-server/commit/3429f4bf2ceb5348a0db5011c3456dd11104b6e7", "message": "Add validation for selected input", "committedDate": "2020-06-08T14:00:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MDQyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r446860426", "bodyText": "IMO we can do a case-insensitive check in here, as afaics input IDs should be unique regarding the case.", "author": "dennisoelkers", "createdAt": "2020-06-29T08:34:14Z", "path": "graylog2-server/src/main/java/org/graylog2/streams/matchers/MatchInput.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.streams.matchers;\n+\n+import org.graylog2.plugin.Message;\n+import org.graylog2.plugin.streams.StreamRule;\n+\n+public class MatchInput implements StreamRuleMatcher {\n+\n+    @Override\n+    public boolean match(Message msg, StreamRule rule) {\n+       if(msg.getField(Message.FIELD_GL2_SOURCE_INPUT) == null) {\n+           return rule.getInverted();\n+       }\n+        final String value = msg.getField(Message.FIELD_GL2_SOURCE_INPUT).toString();\n+        return rule.getInverted() ^ value.trim().equals(rule.getValue());", "originalCommit": "3429f4bf2ceb5348a0db5011c3456dd11104b6e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MTIxNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r446861214", "bodyText": "The rules list should be ordered by matching complexity of the rules (ascending), so the match input rules should be before or after exactRules.", "author": "dennisoelkers", "createdAt": "2020-06-29T08:35:35Z", "path": "graylog2-server/src/main/java/org/graylog2/streams/StreamRouterEngine.java", "diffHunk": "@@ -135,6 +139,7 @@ public StreamRouterEngine(@Assisted List<Stream> streams,\n         this.rulesList.addAll(smallerRules);\n         this.rulesList.addAll(containsRules);\n         this.rulesList.addAll(regexRules);\n+        this.rulesList.addAll(matchInputRules);", "originalCommit": "3429f4bf2ceb5348a0db5011c3456dd11104b6e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg2MzUwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r448863509", "bodyText": "I moved it below contains rule. Since it is just that.", "author": "kmerz", "createdAt": "2020-07-02T09:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MTIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NTM1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r451395350", "bodyText": "It should be after the exactRules, as it does not do a contains check, but an equals check.", "author": "dennisoelkers", "createdAt": "2020-07-08T09:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MTIxNA=="}], "type": "inlineReview"}, {"oid": "7c8e8ade7024201c8fb363da04a49b49deff1f6d", "url": "https://github.com/Graylog2/graylog2-server/commit/7c8e8ade7024201c8fb363da04a49b49deff1f6d", "message": "Fix suggestions from @dennisoelkers", "committedDate": "2020-07-02T09:19:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDk1MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r451394950", "bodyText": "The naming scheme for matchers is <Type>Matcher, so it should be InputMatcher for this one.", "author": "dennisoelkers", "createdAt": "2020-07-08T09:05:03Z", "path": "graylog2-server/src/main/java/org/graylog2/streams/matchers/MatchInput.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.streams.matchers;\n+\n+import org.graylog2.plugin.Message;\n+import org.graylog2.plugin.streams.StreamRule;\n+\n+public class MatchInput implements StreamRuleMatcher {", "originalCommit": "b17c069d4eae077bbb372bbaca49adac1a612646", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NjUyNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8145#discussion_r451396524", "bodyText": "Instead of message-id-... we should use input-id-... in the tests to make the intention clearer.", "author": "dennisoelkers", "createdAt": "2020-07-08T09:07:46Z", "path": "graylog2-server/src/test/java/org/graylog2/streams/matchers/MatchInputTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.streams.matchers;\n+\n+import org.graylog2.plugin.Message;\n+import org.graylog2.plugin.streams.StreamRule;\n+import org.graylog2.plugin.streams.StreamRuleType;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+public class MatchInputTest extends MatcherTest {\n+\n+    @Test\n+    public void testSuccessfulMatch() {\n+        StreamRule rule = getSampleRule();\n+        rule.setValue(\"message-id-beef\");\n+\n+        Message msg = getSampleMessage();\n+        msg.addField(Message.FIELD_GL2_SOURCE_INPUT, \"message-id-beef\");\n+\n+        StreamRuleMatcher matcher = getMatcher(rule);\n+        assertTrue(matcher.match(msg, rule));\n+    }\n+\n+    @Test\n+    public void testUnsuccessfulMatch() {\n+        StreamRule rule = getSampleRule();\n+        rule.setValue(\"message-id-dead\");\n+\n+        Message msg = getSampleMessage();\n+        msg.addField(Message.FIELD_GL2_SOURCE_INPUT, \"message-id-beef\");\n+\n+        StreamRuleMatcher matcher = getMatcher(rule);\n+        assertFalse(matcher.match(msg, rule));\n+    }\n+\n+    @Test\n+    public void testUnsuccessfulMatchWhenMissing() {\n+        StreamRule rule = getSampleRule();\n+        rule.setValue(\"message-id-dead\");\n+\n+        Message msg = getSampleMessage();\n+\n+        StreamRuleMatcher matcher = getMatcher(rule);\n+        assertFalse(matcher.match(msg, rule));\n+    }\n+\n+    @Test\n+    public void testSuccessfulMatchInverted() {\n+        StreamRule rule = getSampleRule();\n+        rule.setValue(\"message-id-beef\");\n+        rule.setInverted(true);\n+\n+        Message msg = getSampleMessage();\n+        msg.addField(Message.FIELD_GL2_SOURCE_INPUT, \"message-id-beef\");\n+\n+        StreamRuleMatcher matcher = getMatcher(rule);\n+        assertFalse(matcher.match(msg, rule));\n+    }\n+\n+    @Test\n+    public void testUnsuccessfulMatchInverted() {\n+        StreamRule rule = getSampleRule();\n+        rule.setValue(\"message-id-dead\");", "originalCommit": "b17c069d4eae077bbb372bbaca49adac1a612646", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "917f2b2b1fa709129d482d798df0d3b95716b9ce", "url": "https://github.com/Graylog2/graylog2-server/commit/917f2b2b1fa709129d482d798df0d3b95716b9ce", "message": "Fix really good annotations from @dennisoelkers", "committedDate": "2020-07-09T17:34:40Z", "type": "forcePushed"}, {"oid": "7b759aa8c72efeea5a3411dce8f0f65a6fc2688c", "url": "https://github.com/Graylog2/graylog2-server/commit/7b759aa8c72efeea5a3411dce8f0f65a6fc2688c", "message": "Add backend logic to match streams based on an input", "committedDate": "2020-07-16T06:53:32Z", "type": "commit"}, {"oid": "ea068a22762629a3ec2e422ae057750e998758da", "url": "https://github.com/Graylog2/graylog2-server/commit/ea068a22762629a3ec2e422ae057750e998758da", "message": "Add frontend logic and add fixes to backend", "committedDate": "2020-07-16T06:53:32Z", "type": "commit"}, {"oid": "51fdb921e5060226ebfc4a0df32767533de4ba5d", "url": "https://github.com/Graylog2/graylog2-server/commit/51fdb921e5060226ebfc4a0df32767533de4ba5d", "message": "Add MatchInput tests", "committedDate": "2020-07-16T06:53:33Z", "type": "commit"}, {"oid": "f2fc1b2b5ada86ae5fe0b587368a15018329033b", "url": "https://github.com/Graylog2/graylog2-server/commit/f2fc1b2b5ada86ae5fe0b587368a15018329033b", "message": "Add flow annotation", "committedDate": "2020-07-16T06:53:33Z", "type": "commit"}, {"oid": "55508c61eb0ecaaf1b97d4b74d6e69bf8830cef5", "url": "https://github.com/Graylog2/graylog2-server/commit/55508c61eb0ecaaf1b97d4b74d6e69bf8830cef5", "message": "Add some basic test", "committedDate": "2020-07-16T06:53:33Z", "type": "commit"}, {"oid": "89a7d60a081b936d24b5d1336c8a8f3aec0f2626", "url": "https://github.com/Graylog2/graylog2-server/commit/89a7d60a081b936d24b5d1336c8a8f3aec0f2626", "message": "Add missing license headers", "committedDate": "2020-07-16T06:53:34Z", "type": "commit"}, {"oid": "7ffc170d71f9d040e8a104315ec3be22f22b362f", "url": "https://github.com/Graylog2/graylog2-server/commit/7ffc170d71f9d040e8a104315ec3be22f22b362f", "message": "Fix web linter", "committedDate": "2020-07-16T06:53:34Z", "type": "commit"}, {"oid": "b88f54388fe0de932e5246b783c7d64405383dfb", "url": "https://github.com/Graylog2/graylog2-server/commit/b88f54388fe0de932e5246b783c7d64405383dfb", "message": "Fix human readable stream rule", "committedDate": "2020-07-16T06:53:34Z", "type": "commit"}, {"oid": "7797f37e7dc1aeb01439e03491524fc613bd2619", "url": "https://github.com/Graylog2/graylog2-server/commit/7797f37e7dc1aeb01439e03491524fc613bd2619", "message": "Add validation for selected input", "committedDate": "2020-07-16T06:53:35Z", "type": "commit"}, {"oid": "7bc467c32e0731a32d824061edb84456a25358da", "url": "https://github.com/Graylog2/graylog2-server/commit/7bc467c32e0731a32d824061edb84456a25358da", "message": "Fix suggestions from @dennisoelkers", "committedDate": "2020-07-16T06:53:35Z", "type": "commit"}, {"oid": "a0110a880f7b9bf547717d1061e865a3fcc1ced8", "url": "https://github.com/Graylog2/graylog2-server/commit/a0110a880f7b9bf547717d1061e865a3fcc1ced8", "message": "Fix linter warnings", "committedDate": "2020-07-16T06:53:35Z", "type": "commit"}, {"oid": "a76a51e8acd1f1e9975aa87cb17a3d1f8a106972", "url": "https://github.com/Graylog2/graylog2-server/commit/a76a51e8acd1f1e9975aa87cb17a3d1f8a106972", "message": "Fix linter and build", "committedDate": "2020-07-16T06:53:36Z", "type": "commit"}, {"oid": "cacee30e33cb34ea1727f1c97f6c2f98bb48b7f1", "url": "https://github.com/Graylog2/graylog2-server/commit/cacee30e33cb34ea1727f1c97f6c2f98bb48b7f1", "message": "Fix linter warning", "committedDate": "2020-07-16T06:53:36Z", "type": "commit"}, {"oid": "459db861e4cc9a364c57b6fd61e8279e562a87b9", "url": "https://github.com/Graylog2/graylog2-server/commit/459db861e4cc9a364c57b6fd61e8279e562a87b9", "message": "Fix snapshot tests", "committedDate": "2020-07-16T06:53:36Z", "type": "commit"}, {"oid": "6d55b6558d98c1c9842d1d6bc900364830283194", "url": "https://github.com/Graylog2/graylog2-server/commit/6d55b6558d98c1c9842d1d6bc900364830283194", "message": "Fix really good annotations from @dennisoelkers", "committedDate": "2020-07-16T06:53:37Z", "type": "commit"}, {"oid": "6609946c340fa3cc9b1e985b61fd3ca1f6da7ce8", "url": "https://github.com/Graylog2/graylog2-server/commit/6609946c340fa3cc9b1e985b61fd3ca1f6da7ce8", "message": "Fix snapshot tests", "committedDate": "2020-07-16T06:53:37Z", "type": "commit"}, {"oid": "ffd7f12ae9bb842f2e5d8bffb5edea869a4a2035", "url": "https://github.com/Graylog2/graylog2-server/commit/ffd7f12ae9bb842f2e5d8bffb5edea869a4a2035", "message": "Fix annotations from @dennisoelkers", "committedDate": "2020-07-16T07:03:28Z", "type": "commit"}, {"oid": "ffd7f12ae9bb842f2e5d8bffb5edea869a4a2035", "url": "https://github.com/Graylog2/graylog2-server/commit/ffd7f12ae9bb842f2e5d8bffb5edea869a4a2035", "message": "Fix annotations from @dennisoelkers", "committedDate": "2020-07-16T07:03:28Z", "type": "forcePushed"}, {"oid": "4b31bc4881b545aa707b98da596ebbf79df0abeb", "url": "https://github.com/Graylog2/graylog2-server/commit/4b31bc4881b545aa707b98da596ebbf79df0abeb", "message": "Update snapshots", "committedDate": "2020-07-16T07:44:39Z", "type": "commit"}, {"oid": "1201868e8b4aecb2e4e82fc402bdb2bc2886325c", "url": "https://github.com/Graylog2/graylog2-server/commit/1201868e8b4aecb2e4e82fc402bdb2bc2886325c", "message": "Update graylog2-web-interface/src/components/streamrules/StreamRulesEditor.jsx\n\nCo-authored-by: Kyle Knight <kyle@graylog.com>", "committedDate": "2020-07-16T07:47:52Z", "type": "commit"}]}