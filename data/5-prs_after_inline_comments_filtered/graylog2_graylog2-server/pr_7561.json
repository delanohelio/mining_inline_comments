{"pr_number": 7561, "pr_title": "Add API integration tests", "pr_createdAt": "2020-02-26T15:21:19Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7561", "timeline": [{"oid": "eb54fd26a490ae6dd2e860064248b5accc9e9abc", "url": "https://github.com/Graylog2/graylog2-server/commit/eb54fd26a490ae6dd2e860064248b5accc9e9abc", "message": "Add explanatory comments for permissions workarounds", "committedDate": "2020-02-28T13:47:19Z", "type": "forcePushed"}, {"oid": "fce2eb3ed5ed848f78abc454db895c170a30a17c", "url": "https://github.com/Graylog2/graylog2-server/commit/fce2eb3ed5ed848f78abc454db895c170a30a17c", "message": "Move full backend test to separate module\n\n- Created new module full-backend-tests\n- Run all tests in module with failsafe, not surefire,\n  to ensure that they only run on `mvn verify`.\n  This allows running `mvn package` without running\n  these slow tests.", "committedDate": "2020-03-03T11:48:42Z", "type": "forcePushed"}, {"oid": "94c8149430077297f6cecdf3c8fe1f4cf22fd023", "url": "https://github.com/Graylog2/graylog2-server/commit/94c8149430077297f6cecdf3c8fe1f4cf22fd023", "message": "Disable failsafe integration tests on travis explicitly\n\n`-Dmaven.test.skip=true` was not enough in the second `after_success` step.", "committedDate": "2020-03-03T16:15:43Z", "type": "forcePushed"}, {"oid": "432ed5d89a81356a84f5d4c5018a29b8b452ecc2", "url": "https://github.com/Graylog2/graylog2-server/commit/432ed5d89a81356a84f5d4c5018a29b8b452ecc2", "message": "Avoid recreating containers for GraylogBackend per test class\n\nConverted GraylogBackend to singleton. This ensures that images\nand containers can reused globally.", "committedDate": "2020-03-04T14:52:37Z", "type": "forcePushed"}, {"oid": "41ddabab41031bb117d02e0c9a43668df10a681d", "url": "https://github.com/Graylog2/graylog2-server/commit/41ddabab41031bb117d02e0c9a43668df10a681d", "message": "Allow remote debugging of graylog server\n\nThis allows to attach a remote debugger to the server container.\nThe biggest caveat is that the dynamic port to which the debugger can be\nattached is only known after starting the container. Hence one would\nhave to set a breakpoint after the container start to pause execution,\nidentify the debug port and start the remote debugger with it.\n\n- Added debug toggle via env var GRAYLOG_IT_DEBUG_SERVER\n- Added optional debug build arg to container\n- Added logging of debug port, if debugging is enabled\n- Extracted building the container to NodeContainerFactory", "committedDate": "2020-03-06T15:36:43Z", "type": "forcePushed"}, {"oid": "3e83b02aeb2488aeb1d3badd359d3cd0f7eac41b", "url": "https://github.com/Graylog2/graylog2-server/commit/3e83b02aeb2488aeb1d3badd359d3cd0f7eac41b", "message": "Added param object NodeContainerConfig", "committedDate": "2020-03-09T13:32:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMTYyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r395731626", "bodyText": "This assumption is not correct, unfortunately. On some occasions the Graylog node will stop when MongoDB is not available.", "author": "bernd", "createdAt": "2020-03-20T15:55:29Z", "path": "graylog2-server/src/test/java/org/graylog/testing/completebackend/GraylogBackend.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.completebackend;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import org.graylog.testing.elasticsearch.ElasticsearchInstance;\n+import org.graylog.testing.graylognode.NodeInstance;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.Network;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.FutureTask;\n+\n+public class GraylogBackend {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(GraylogBackend.class);\n+    private final ElasticsearchInstance es;\n+    private final MongoDBInstance mongodb;\n+    private final NodeInstance node;\n+\n+    private static GraylogBackend instance;\n+\n+    public static GraylogBackend createStarted() {\n+        if (instance == null)\n+            instance = createStartedBackend();\n+        else {\n+            instance.fullReset();\n+            LOG.info(\"Reusing running backend\");\n+        }\n+\n+        return instance;\n+    }\n+\n+    // Assuming that parallel start works, because\n+    // - mongodb and es are independent\n+    // - node will retry connections to mongodb and es until they are there", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjUzOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r395732538", "bodyText": "We usually use {} around if statements.", "author": "bernd", "createdAt": "2020-03-20T15:56:52Z", "path": "graylog2-server/src/test/java/org/graylog/testing/completebackend/GraylogBackendExtension.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.completebackend;\n+\n+import com.google.common.base.Stopwatch;\n+import org.junit.jupiter.api.extension.AfterEachCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.extension.ParameterContext;\n+import org.junit.jupiter.api.extension.ParameterResolutionException;\n+import org.junit.jupiter.api.extension.ParameterResolver;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.jupiter.api.extension.ExtensionContext.Namespace;\n+\n+\n+public class GraylogBackendExtension implements AfterEachCallback, BeforeAllCallback, ParameterResolver {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(GraylogBackendExtension.class);\n+    private static final Namespace NAMESPACE = Namespace.create(GraylogBackendExtension.class);\n+\n+    private GraylogBackend backend;\n+    private Lifecycle lifecycle;\n+\n+    @Override\n+    public void beforeAll(ExtensionContext context) {\n+        Stopwatch sw = Stopwatch.createStarted();\n+\n+        lifecycle = Lifecycle.from(context);\n+\n+        backend = GraylogBackend.createStarted();\n+\n+        context.getStore(NAMESPACE).put(context.getRequiredTestClass().getName(), backend);\n+\n+        sw.stop();\n+\n+        LOG.info(\"Backend started after \" + sw.elapsed(TimeUnit.SECONDS) + \" seconds\");\n+    }\n+\n+    @Override\n+    public void afterEach(ExtensionContext context) {\n+        if (context.getExecutionException().isPresent())", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczODEwOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r395738108", "bodyText": "We usually add {} around all if statements.", "author": "bernd", "createdAt": "2020-03-20T16:05:33Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/NodeContainerFactory.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.graylog.testing.PropertyLoader;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.graylog.testing.graylognode.ResourceUtil.resourceToTmpFile;\n+\n+public class NodeContainerFactory {\n+    private static final Logger LOG = LoggerFactory.getLogger(NodeContainerFactory.class);\n+\n+    @SuppressWarnings(\"OctalInteger\")\n+    private static final int EXECUTABLE_MODE = 0100755;\n+    private static final String ADMIN_PW_SHA2 = \"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918\";\n+    private static final int API_PORT = 9000;\n+    private static final int DEBUG_PORT = 5005;\n+\n+    public static GenericContainer<?> buildContainer(NodeContainerConfig config) {\n+        if (!config.skipPackaging)\n+            MavenPackager.packageJarIfNecessary(property(\"server_project_dir\"));\n+        else\n+            LOG.info(\"Skipping packaging\");\n+\n+        ImageFromDockerfile image = createImage(config);\n+\n+        return createRunningContainer(config, image);\n+    }\n+\n+    private static ImageFromDockerfile createImage(NodeContainerConfig config) {\n+        // testcontainers only allows passing permissions if you pass a `File`\n+        File entrypointScript = resourceToTmpFile(\"org/graylog/testing/graylognode/docker-entrypoint.sh\");\n+\n+        ImageFromDockerfile image = new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", \"org/graylog/testing/graylognode/Dockerfile\")\n+                // set mode here explicitly, because file system permissions can get lost when executing from maven\n+                .withFileFromFile(\"docker-entrypoint.sh\", entrypointScript, EXECUTABLE_MODE)\n+                .withFileFromPath(\"graylog.conf\", pathTo(\"graylog_config\"))\n+                .withFileFromClasspath(\"log4j2.xml\", \"log4j2.xml\")\n+                .withFileFromPath(\"sigar\", pathTo(\"sigar_dir\"));\n+        if (config.enableDebugging)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyOTY4NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397229684", "bodyText": "Please use braces {} in conditional statements, thanks! \ud83d\ude04", "author": "bernd", "createdAt": "2020-03-24T15:11:58Z", "path": "graylog2-server/src/test/java/org/graylog/testing/completebackend/GraylogBackend.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.completebackend;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import org.graylog.testing.elasticsearch.ElasticsearchInstance;\n+import org.graylog.testing.graylognode.NodeInstance;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.Network;\n+\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.FutureTask;\n+\n+public class GraylogBackend {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(GraylogBackend.class);\n+    private final ElasticsearchInstance es;\n+    private final MongoDBInstance mongodb;\n+    private final NodeInstance node;\n+\n+    private static GraylogBackend instance;\n+\n+    public static GraylogBackend createStarted() {\n+        if (instance == null)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMjIyNw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397232227", "bodyText": "How about using .basePath() and .baseUri() here? That would allow us to use .get(\"/system/plugins\") in the test without having to use string concatenation all the time.", "author": "bernd", "createdAt": "2020-03-24T15:15:11Z", "path": "full-backend-tests/src/test/java/org/graylog/testing/fullbackend/BackendStartupIT.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.fullbackend;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.google.common.collect.ImmutableSet;\n+import io.restassured.RestAssured;\n+import io.restassured.builder.RequestSpecBuilder;\n+import org.graylog.plugins.views.search.Query;\n+import org.graylog.plugins.views.search.Search;\n+import org.graylog.plugins.views.search.elasticsearch.ElasticsearchQueryString;\n+import org.graylog.plugins.views.search.searchtypes.MessageList;\n+import org.graylog.testing.completebackend.ApiIntegrationTest;\n+import org.graylog.testing.completebackend.GraylogBackend;\n+import org.graylog2.plugin.indexer.searches.timeranges.AbsoluteRange;\n+import org.graylog2.plugin.indexer.searches.timeranges.InvalidRangeParametersException;\n+import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+import static io.restassured.RestAssured.given;\n+import static io.restassured.RestAssured.when;\n+import static io.restassured.http.ContentType.JSON;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.graylog.testing.completebackend.Lifecycle.CLASS;\n+\n+\n+@ApiIntegrationTest(serverLifecycle = CLASS)\n+class BackendStartupIT {\n+\n+    private final GraylogBackend sut;\n+\n+    public BackendStartupIT(GraylogBackend sut) {\n+        this.sut = sut;\n+    }\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        RestAssured.enableLoggingOfRequestAndResponseIfValidationFails();\n+        RestAssured.requestSpecification =\n+                new RequestSpecBuilder().build()\n+                        .accept(JSON)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyNDY1OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397824659", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T12:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMjIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzODQyNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397238426", "bodyText": "I think this could use some javadoc. \ud83d\ude04 I guess this is one of the classes/annontations that test writers will lookup a lot.", "author": "bernd", "createdAt": "2020-03-24T15:23:03Z", "path": "graylog2-server/src/test/java/org/graylog/testing/completebackend/ApiIntegrationTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.completebackend;\n+\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+@Target({TYPE, METHOD})\n+@ExtendWith(GraylogBackendExtension.class)\n+@Retention(RUNTIME)\n+@Tag(\"integration\")\n+public @interface ApiIntegrationTest {", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzNTE1Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397835157", "bodyText": "Ok, I'm adding something. I'm unsure how much detail is necessary, but we can clarify that in the next review round.", "author": "alex-konn", "createdAt": "2020-03-25T13:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzODQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzOTk5Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397239992", "bodyText": "Same as for the ApiIntegrationTest class, I think we should document the different enum values here and describe what they are doing.", "author": "bernd", "createdAt": "2020-03-24T15:25:00Z", "path": "graylog2-server/src/test/java/org/graylog/testing/completebackend/Lifecycle.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.completebackend;\n+\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.util.Optional;\n+\n+public enum Lifecycle {", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg0MzU3NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397843575", "bodyText": ":+1", "author": "alex-konn", "createdAt": "2020-03-25T13:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzOTk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MjM2Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397242366", "bodyText": "Excluding the javadoc build might improve performance a tiny bit: (not tested yet)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";\n          \n          \n            \n                private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true -Dmaven.javadoc.skip=true\";", "author": "bernd", "createdAt": "2020-03-24T15:27:57Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/MavenPackager.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import com.google.common.base.Stopwatch;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MavenPackager {\n+    private static final Logger LOG = LoggerFactory.getLogger(MavenPackager.class);\n+    private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3MjIwNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397872206", "bodyText": "Well, at least it doesn't hurt! \ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MjM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MjgyOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397242828", "bodyText": "Can you please add a small comment why this indicates that we are running from maven? Thanks!", "author": "bernd", "createdAt": "2020-03-24T15:28:36Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/MavenPackager.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import com.google.common.base.Stopwatch;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MavenPackager {\n+    private static final Logger LOG = LoggerFactory.getLogger(MavenPackager.class);\n+    private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";\n+\n+    static void packageJarIfNecessary(String projectDir) {\n+        if (isRunFromMaven()) {\n+            LOG.info(\"Running from Maven. Assuming jars are current.\");\n+        } else {\n+            LOG.info(\"Running from outside Maven. Packaging server jar now...\");\n+            MavenPackager.packageJar(projectDir);\n+        }\n+    }\n+\n+    private static boolean isRunFromMaven() {\n+        return System.getProperty(\"surefire.test.class.path\") != null;", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3MzE3OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397873178", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MjgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NDAyMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397244022", "bodyText": "Nitpick: you could use value placeholder to avoid string concatenation\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.info(\"Finished packaging after \" + sw.elapsed(TimeUnit.SECONDS) + \" seconds\");\n          \n          \n            \n                    LOG.info(\"Finished packaging after {} seconds\", sw.elapsed(TimeUnit.SECONDS));", "author": "bernd", "createdAt": "2020-03-24T15:30:04Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/MavenPackager.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import com.google.common.base.Stopwatch;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MavenPackager {\n+    private static final Logger LOG = LoggerFactory.getLogger(MavenPackager.class);\n+    private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";\n+\n+    static void packageJarIfNecessary(String projectDir) {\n+        if (isRunFromMaven()) {\n+            LOG.info(\"Running from Maven. Assuming jars are current.\");\n+        } else {\n+            LOG.info(\"Running from outside Maven. Packaging server jar now...\");\n+            MavenPackager.packageJar(projectDir);\n+        }\n+    }\n+\n+    private static boolean isRunFromMaven() {\n+        return System.getProperty(\"surefire.test.class.path\") != null;\n+    }\n+\n+    static void packageJar(String pomDir) {\n+        Process p = startProcess(pomDir);\n+\n+        Stopwatch sw = Stopwatch.createStarted();\n+\n+        int exitCode = waitForExit(p);\n+\n+        sw.stop();\n+        LOG.info(\"Finished packaging after \" + sw.elapsed(TimeUnit.SECONDS) + \" seconds\");", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg3MjU3MA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397872570", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NDAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NDk5Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397244997", "bodyText": "What do you think about adding the MVN_COMMAND to the error message? Could be useful for debugging.", "author": "bernd", "createdAt": "2020-03-24T15:31:18Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/MavenPackager.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import com.google.common.base.Stopwatch;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MavenPackager {\n+    private static final Logger LOG = LoggerFactory.getLogger(MavenPackager.class);\n+    private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";\n+\n+    static void packageJarIfNecessary(String projectDir) {\n+        if (isRunFromMaven()) {\n+            LOG.info(\"Running from Maven. Assuming jars are current.\");\n+        } else {\n+            LOG.info(\"Running from outside Maven. Packaging server jar now...\");\n+            MavenPackager.packageJar(projectDir);\n+        }\n+    }\n+\n+    private static boolean isRunFromMaven() {\n+        return System.getProperty(\"surefire.test.class.path\") != null;\n+    }\n+\n+    static void packageJar(String pomDir) {\n+        Process p = startProcess(pomDir);\n+\n+        Stopwatch sw = Stopwatch.createStarted();\n+\n+        int exitCode = waitForExit(p);\n+\n+        sw.stop();\n+        LOG.info(\"Finished packaging after \" + sw.elapsed(TimeUnit.SECONDS) + \" seconds\");\n+\n+        ensureZeroExitCode(p, exitCode);\n+    }\n+\n+    private static int waitForExit(Process p) {\n+        try {\n+            return p.waitFor();\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(\"Process for mvn package was interrupted\", e);\n+        }\n+    }\n+\n+    private static Process startProcess(String pomDir) {\n+        try {\n+            return new ProcessBuilder().command(\"sh\", \"-c\", MVN_COMMAND).directory(new File(pomDir)).start();\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Failed to start process for mvn package\", e);", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg1MjkzMA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397852930", "bodyText": "Good idea! \ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NDk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NTM0OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397245348", "bodyText": "What do you think about adding the MVN_COMMAND to the error message? Could be useful for debugging.", "author": "bernd", "createdAt": "2020-03-24T15:31:49Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/MavenPackager.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import com.google.common.base.Stopwatch;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.util.concurrent.TimeUnit;\n+\n+public class MavenPackager {\n+    private static final Logger LOG = LoggerFactory.getLogger(MavenPackager.class);\n+    private static final String MVN_COMMAND = \"mvn package -DskipTests -Dskip.web.build -Dforbiddenapis.skip=true\";\n+\n+    static void packageJarIfNecessary(String projectDir) {\n+        if (isRunFromMaven()) {\n+            LOG.info(\"Running from Maven. Assuming jars are current.\");\n+        } else {\n+            LOG.info(\"Running from outside Maven. Packaging server jar now...\");\n+            MavenPackager.packageJar(projectDir);\n+        }\n+    }\n+\n+    private static boolean isRunFromMaven() {\n+        return System.getProperty(\"surefire.test.class.path\") != null;\n+    }\n+\n+    static void packageJar(String pomDir) {\n+        Process p = startProcess(pomDir);\n+\n+        Stopwatch sw = Stopwatch.createStarted();\n+\n+        int exitCode = waitForExit(p);\n+\n+        sw.stop();\n+        LOG.info(\"Finished packaging after \" + sw.elapsed(TimeUnit.SECONDS) + \" seconds\");\n+\n+        ensureZeroExitCode(p, exitCode);\n+    }\n+\n+    private static int waitForExit(Process p) {\n+        try {\n+            return p.waitFor();\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(\"Process for mvn package was interrupted\", e);\n+        }\n+    }\n+\n+    private static Process startProcess(String pomDir) {\n+        try {\n+            return new ProcessBuilder().command(\"sh\", \"-c\", MVN_COMMAND).directory(new File(pomDir)).start();\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Failed to start process for mvn package\", e);\n+        }\n+    }\n+\n+    private static void ensureZeroExitCode(Process p, int exitCode) {\n+        if (exitCode > 0) {\n+            new BufferedReader(new InputStreamReader(p.getInputStream(), Charset.defaultCharset())).lines()\n+                    .forEach(System.out::println);\n+\n+            throw new RuntimeException(\"mvn package exited with \" + exitCode);", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg1MzAwOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397853008", "bodyText": "Good idea! \ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NTM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NjY2Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397246666", "bodyText": "We usually use braces {} around conditionals.", "author": "bernd", "createdAt": "2020-03-24T15:33:22Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/NodeContainerFactory.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.graylog.testing.PropertyLoader;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.graylog.testing.graylognode.ResourceUtil.resourceToTmpFile;\n+\n+public class NodeContainerFactory {\n+    private static final Logger LOG = LoggerFactory.getLogger(NodeContainerFactory.class);\n+\n+    @SuppressWarnings(\"OctalInteger\")\n+    private static final int EXECUTABLE_MODE = 0100755;\n+    private static final String ADMIN_PW_SHA2 = \"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918\";\n+    private static final int API_PORT = 9000;\n+    private static final int DEBUG_PORT = 5005;\n+\n+    public static GenericContainer<?> buildContainer(NodeContainerConfig config) {\n+        if (!config.skipPackaging)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0ODE1NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397248155", "bodyText": "Do we want to use API_PORT here instead of hardcoding the port?", "author": "bernd", "createdAt": "2020-03-24T15:35:14Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/NodeContainerFactory.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.graylog.testing.PropertyLoader;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.graylog.testing.graylognode.ResourceUtil.resourceToTmpFile;\n+\n+public class NodeContainerFactory {\n+    private static final Logger LOG = LoggerFactory.getLogger(NodeContainerFactory.class);\n+\n+    @SuppressWarnings(\"OctalInteger\")\n+    private static final int EXECUTABLE_MODE = 0100755;\n+    private static final String ADMIN_PW_SHA2 = \"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918\";\n+    private static final int API_PORT = 9000;\n+    private static final int DEBUG_PORT = 5005;\n+\n+    public static GenericContainer<?> buildContainer(NodeContainerConfig config) {\n+        if (!config.skipPackaging)\n+            MavenPackager.packageJarIfNecessary(property(\"server_project_dir\"));\n+        else\n+            LOG.info(\"Skipping packaging\");\n+\n+        ImageFromDockerfile image = createImage(config);\n+\n+        return createRunningContainer(config, image);\n+    }\n+\n+    private static ImageFromDockerfile createImage(NodeContainerConfig config) {\n+        // testcontainers only allows passing permissions if you pass a `File`\n+        File entrypointScript = resourceToTmpFile(\"org/graylog/testing/graylognode/docker-entrypoint.sh\");\n+\n+        ImageFromDockerfile image = new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", \"org/graylog/testing/graylognode/Dockerfile\")\n+                // set mode here explicitly, because file system permissions can get lost when executing from maven\n+                .withFileFromFile(\"docker-entrypoint.sh\", entrypointScript, EXECUTABLE_MODE)\n+                .withFileFromPath(\"graylog.conf\", pathTo(\"graylog_config\"))\n+                .withFileFromClasspath(\"log4j2.xml\", \"log4j2.xml\")\n+                .withFileFromPath(\"sigar\", pathTo(\"sigar_dir\"));\n+        if (config.enableDebugging)\n+            image.withBuildArg(\"DEBUG_OPTS\", \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:5005\");\n+\n+        return image;\n+    }\n+\n+    private static GenericContainer<?> createRunningContainer(NodeContainerConfig config, ImageFromDockerfile image) {\n+        String graylogHome = \"/usr/share/graylog\";\n+\n+        GenericContainer<?> container = new GenericContainer<>(image)\n+                .withFileSystemBind(property(\"server_jar\"), graylogHome + \"/graylog.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"aws_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-aws.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"threatintel_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-threatintel.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"collector_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-collector.jar\", BindMode.READ_ONLY)\n+                .withNetwork(config.network)\n+                .withEnv(\"GRAYLOG_MONGODB_URI\", config.mongoDbUri)\n+                .withEnv(\"GRAYLOG_ELASTICSEARCH_HOSTS\", config.elasticsearchUri)\n+                .withEnv(\"GRAYLOG_PASSWORD_SECRET\", \"M4lteserKreuzHerrStrack?\")\n+                .withEnv(\"GRAYLOG_NODE_ID_FILE\", \"data/config/node-id\")\n+                .withEnv(\"GRAYLOG_HTTP_BIND_ADDRESS\", \"0.0.0.0:9000\")", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyODk4Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397828986", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T12:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0ODE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2MTI2NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397261265", "bodyText": "Can you please write down the plain text password in a comment? Could be useful for debugging.", "author": "bernd", "createdAt": "2020-03-24T15:51:36Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/NodeContainerFactory.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.graylog.testing.PropertyLoader;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.graylog.testing.graylognode.ResourceUtil.resourceToTmpFile;\n+\n+public class NodeContainerFactory {\n+    private static final Logger LOG = LoggerFactory.getLogger(NodeContainerFactory.class);\n+\n+    @SuppressWarnings(\"OctalInteger\")\n+    private static final int EXECUTABLE_MODE = 0100755;\n+    private static final String ADMIN_PW_SHA2 = \"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918\";", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyNTMyOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397825329", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T12:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2MTI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2NDY1Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397264653", "bodyText": "We can add GRAYLOG_LB_RECOGNITION_PERIOD_SECONDS=0 here. That saves 3 seconds on each server shutdown. \ud83d\ude04", "author": "bernd", "createdAt": "2020-03-24T15:55:48Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/NodeContainerFactory.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.graylog.testing.PropertyLoader;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.images.builder.ImageFromDockerfile;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.graylog.testing.graylognode.ResourceUtil.resourceToTmpFile;\n+\n+public class NodeContainerFactory {\n+    private static final Logger LOG = LoggerFactory.getLogger(NodeContainerFactory.class);\n+\n+    @SuppressWarnings(\"OctalInteger\")\n+    private static final int EXECUTABLE_MODE = 0100755;\n+    private static final String ADMIN_PW_SHA2 = \"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918\";\n+    private static final int API_PORT = 9000;\n+    private static final int DEBUG_PORT = 5005;\n+\n+    public static GenericContainer<?> buildContainer(NodeContainerConfig config) {\n+        if (!config.skipPackaging)\n+            MavenPackager.packageJarIfNecessary(property(\"server_project_dir\"));\n+        else\n+            LOG.info(\"Skipping packaging\");\n+\n+        ImageFromDockerfile image = createImage(config);\n+\n+        return createRunningContainer(config, image);\n+    }\n+\n+    private static ImageFromDockerfile createImage(NodeContainerConfig config) {\n+        // testcontainers only allows passing permissions if you pass a `File`\n+        File entrypointScript = resourceToTmpFile(\"org/graylog/testing/graylognode/docker-entrypoint.sh\");\n+\n+        ImageFromDockerfile image = new ImageFromDockerfile()\n+                .withFileFromClasspath(\"Dockerfile\", \"org/graylog/testing/graylognode/Dockerfile\")\n+                // set mode here explicitly, because file system permissions can get lost when executing from maven\n+                .withFileFromFile(\"docker-entrypoint.sh\", entrypointScript, EXECUTABLE_MODE)\n+                .withFileFromPath(\"graylog.conf\", pathTo(\"graylog_config\"))\n+                .withFileFromClasspath(\"log4j2.xml\", \"log4j2.xml\")\n+                .withFileFromPath(\"sigar\", pathTo(\"sigar_dir\"));\n+        if (config.enableDebugging)\n+            image.withBuildArg(\"DEBUG_OPTS\", \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:5005\");\n+\n+        return image;\n+    }\n+\n+    private static GenericContainer<?> createRunningContainer(NodeContainerConfig config, ImageFromDockerfile image) {\n+        String graylogHome = \"/usr/share/graylog\";\n+\n+        GenericContainer<?> container = new GenericContainer<>(image)\n+                .withFileSystemBind(property(\"server_jar\"), graylogHome + \"/graylog.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"aws_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-aws.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"threatintel_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-threatintel.jar\", BindMode.READ_ONLY)\n+                .withFileSystemBind(property(\"collector_plugin_jar\"), graylogHome + \"/plugin/graylog-plugin-collector.jar\", BindMode.READ_ONLY)\n+                .withNetwork(config.network)\n+                .withEnv(\"GRAYLOG_MONGODB_URI\", config.mongoDbUri)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2NTE3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397265179", "bodyText": "We should also add GRAYLOG_VERSIONCHECKS=false to make sure the test server doesn't call out to our versioncheck API service.", "author": "bernd", "createdAt": "2020-03-24T15:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2NDY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyODQ5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397828499", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T12:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2NDY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI2NzY3NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397267675", "bodyText": "Please use braces {} around conditionals. Thanks!", "author": "bernd", "createdAt": "2020-03-24T15:59:31Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/ResourceUtil.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.apache.commons.io.FileUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Paths;\n+import java.util.UUID;\n+\n+public class ResourceUtil {\n+    static File resourceToTmpFile(@SuppressWarnings(\"SameParameterValue\") String resourceName) {\n+\n+        InputStream resource = ResourceUtil.class.getClassLoader().getResourceAsStream(resourceName);\n+\n+        if (resource == null)", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI3MTIxMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397271211", "bodyText": "Let's use File.createTempFile() here and File#deleteOnExit() to make sure we clean it up afterwards.\nLet's also use a descriptive name for the tempfile so people know what it is when seeing strange files in /tmp. \ud83d\ude09", "author": "bernd", "createdAt": "2020-03-24T16:03:57Z", "path": "graylog2-server/src/test/java/org/graylog/testing/graylognode/ResourceUtil.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog.testing.graylognode;\n+\n+import org.apache.commons.io.FileUtils;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Paths;\n+import java.util.UUID;\n+\n+public class ResourceUtil {\n+    static File resourceToTmpFile(@SuppressWarnings(\"SameParameterValue\") String resourceName) {\n+\n+        InputStream resource = ResourceUtil.class.getClassLoader().getResourceAsStream(resourceName);\n+\n+        if (resource == null)\n+            throw new RuntimeException(\"Couldn't load resource \" + resourceName);\n+\n+        File f = new File(\"/tmp/\" + UUID.randomUUID().toString() + \"-\" + Paths.get(resourceName).getFileName());", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg2OTM1OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r397869358", "bodyText": "\ud83d\udc4d", "author": "alex-konn", "createdAt": "2020-03-25T13:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI3MTIxMQ=="}], "type": "inlineReview"}, {"oid": "197c9ba78d2b6c6f5e0bab54b58a9e44224bcb59", "url": "https://github.com/Graylog2/graylog2-server/commit/197c9ba78d2b6c6f5e0bab54b58a9e44224bcb59", "message": "Adding first spike with ngnix dummy\n\n`GraylogBackendExtension` should later control all involved containers,\nincluding graylog node(s), mongodb, and elasticsearch.\nFor now it controls only a dummy container as a placeholder for the a\ngraylog node.", "committedDate": "2020-03-25T15:04:39Z", "type": "commit"}, {"oid": "a38e53907b4a42d59420aea966103b6ceee1c69e", "url": "https://github.com/Graylog2/graylog2-server/commit/a38e53907b4a42d59420aea966103b6ceee1c69e", "message": "Copied Dockerfile from https://github.com/Graylog2/graylog-docker", "committedDate": "2020-03-25T15:04:40Z", "type": "commit"}, {"oid": "192c926109cd43b7acbd713f281410ea330a9b5e", "url": "https://github.com/Graylog2/graylog2-server/commit/192c926109cd43b7acbd713f281410ea330a9b5e", "message": "Start actual server in container\n\n- Manually unpacked tarball to local directory. This is a workaround to\n  enable focussing on container orchestration in JUnit for now. Will be\n  fixed later\n- Copied graylog.conf and log4j2.xml from\n  https://github.com/Graylog2/graylog-docker", "committedDate": "2020-03-25T15:04:40Z", "type": "commit"}, {"oid": "732f51d4b172ad714d8f00c90097ec939b16154f", "url": "https://github.com/Graylog2/graylog2-server/commit/732f51d4b172ad714d8f00c90097ec939b16154f", "message": "Add MongoDB", "committedDate": "2020-03-25T15:04:41Z", "type": "commit"}, {"oid": "553c6108a587f86bb55c011b9ef62c3bc4a25a32", "url": "https://github.com/Graylog2/graylog2-server/commit/553c6108a587f86bb55c011b9ef62c3bc4a25a32", "message": "Add ElasticSearch", "committedDate": "2020-03-25T15:04:41Z", "type": "commit"}, {"oid": "2e8fdc8e33e5d7225e045ade275789091cd83d4d", "url": "https://github.com/Graylog2/graylog2-server/commit/2e8fdc8e33e5d7225e045ade275789091cd83d4d", "message": "Fix ElasticsearchInstance so that existing IT still work", "committedDate": "2020-03-25T15:04:41Z", "type": "commit"}, {"oid": "d4966ccd005a1f992cd23fc0da75937c358e44be", "url": "https://github.com/Graylog2/graylog2-server/commit/d4966ccd005a1f992cd23fc0da75937c358e44be", "message": "Start containers in parallel to reduce startup time\n\nStartup time is now limited by the time it takes the server container to start. That can be optimized later.", "committedDate": "2020-03-25T15:04:42Z", "type": "commit"}, {"oid": "ef374226b0ab37b69f8dcb281724ed3992b660ee", "url": "https://github.com/Graylog2/graylog2-server/commit/ef374226b0ab37b69f8dcb281724ed3992b660ee", "message": "Moved container instances into GraylogBackend\n\nThis leads to a clean separation between managing containers (GraylogBackend)\nand junit integration (GraylogBackendExtension).", "committedDate": "2020-03-25T15:04:42Z", "type": "commit"}, {"oid": "cf9304c70de8faf2c54f9c5a3a0935e1e221d942", "url": "https://github.com/Graylog2/graylog2-server/commit/cf9304c70de8faf2c54f9c5a3a0935e1e221d942", "message": "Use real artifacts instead of relying on manually created ones\n\n- Take server jar from target folder\n- Take sigar lib from lib folder", "committedDate": "2020-03-25T15:04:42Z", "type": "commit"}, {"oid": "f7b19900e8827aae5014305d7634f1dc551cb097", "url": "https://github.com/Graylog2/graylog2-server/commit/f7b19900e8827aae5014305d7634f1dc551cb097", "message": "Load default plugins\n\nThe definition of plugin jars in api-it-tests.properties is a bit verbose,\nbut I decided to leave it like this, because I think it's easier to understand\nthan dynamic generation of jar file locations in code.\nWe might still decide to make it more dynamic when enabling additional plugins.", "committedDate": "2020-03-25T15:04:43Z", "type": "commit"}, {"oid": "dfb7b0b9aca1fae5f794560e658d581da821034d", "url": "https://github.com/Graylog2/graylog2-server/commit/dfb7b0b9aca1fae5f794560e658d581da821034d", "message": "Fix forbiddenapis errors", "committedDate": "2020-03-25T15:04:43Z", "type": "commit"}, {"oid": "da3e791595f228a9fa88eaa76fc38a1762d5389d", "url": "https://github.com/Graylog2/graylog2-server/commit/da3e791595f228a9fa88eaa76fc38a1762d5389d", "message": "Set permissions for docker-entrypoint.sh explicitly\n\nLocal filesystem permissions don't seem to be retained reliably", "committedDate": "2020-03-25T15:04:43Z", "type": "commit"}, {"oid": "636b66667b2e16a4dcfd945b338b56c1e2824b86", "url": "https://github.com/Graylog2/graylog2-server/commit/636b66667b2e16a4dcfd945b338b56c1e2824b86", "message": "Fix dumb mistake in NodeInstance#getApiAddress", "committedDate": "2020-03-25T15:04:43Z", "type": "commit"}, {"oid": "3f93203230375147714ef9cfc864106bf8d0a22f", "url": "https://github.com/Graylog2/graylog2-server/commit/3f93203230375147714ef9cfc864106bf8d0a22f", "message": "Use URI instead of filename\n\n...because forbiddenapis says so.", "committedDate": "2020-03-25T15:04:44Z", "type": "commit"}, {"oid": "b353eca3e77fd1f95409bb049e7ff7a281266316", "url": "https://github.com/Graylog2/graylog2-server/commit/b353eca3e77fd1f95409bb049e7ff7a281266316", "message": "Mvn package server when executing tests from Intellij", "committedDate": "2020-03-25T15:04:44Z", "type": "commit"}, {"oid": "97e4fae25662c808e1d7dc03d32a405cea1cbe56", "url": "https://github.com/Graylog2/graylog2-server/commit/97e4fae25662c808e1d7dc03d32a405cea1cbe56", "message": "Move new integration tests to existing module\n\n- Moved the test class\n- Deactivated all old tests\n- Changed how docker-entrypoint.sh resource is converted to file\n  Before it went via URI, which doesn't work when executing tests\n  from a different module. Write resource to temp file instead,", "committedDate": "2020-03-25T15:04:44Z", "type": "commit"}, {"oid": "4df569f35218ac912d5ddbbe789b39c1e06c2f70", "url": "https://github.com/Graylog2/graylog2-server/commit/4df569f35218ac912d5ddbbe789b39c1e06c2f70", "message": "Add explanatory comments for permissions workarounds", "committedDate": "2020-03-25T15:04:45Z", "type": "commit"}, {"oid": "f7b93e87d97fedeb5f41d810c229680880cdecd9", "url": "https://github.com/Graylog2/graylog2-server/commit/f7b93e87d97fedeb5f41d810c229680880cdecd9", "message": "Mount jars into container instead of building into image", "committedDate": "2020-03-25T15:04:45Z", "type": "commit"}, {"oid": "7029b3fcc87cf7f1e32979da8b9d301afefaa72f", "url": "https://github.com/Graylog2/graylog2-server/commit/7029b3fcc87cf7f1e32979da8b9d301afefaa72f", "message": "Move full backend test to separate module\n\n- Created new module full-backend-tests\n- Run all tests in module with failsafe, not surefire,\n  to ensure that they only run on `mvn verify`.\n  This allows running `mvn package` without running\n  these slow tests.", "committedDate": "2020-03-25T15:04:45Z", "type": "commit"}, {"oid": "2633a62394f03342b33e8beb30dfabe523287304", "url": "https://github.com/Graylog2/graylog2-server/commit/2633a62394f03342b33e8beb30dfabe523287304", "message": "Run only mvn package on travis\n\nTravis doesn't package plugins, so extra steps would  be needed to\nrun full backend tests.\nIt should be sufficient to run these tests only in the jenkins build", "committedDate": "2020-03-25T15:04:46Z", "type": "commit"}, {"oid": "49eb1d1757e1bcabdde367c05a229d7cd7b9afff", "url": "https://github.com/Graylog2/graylog2-server/commit/49eb1d1757e1bcabdde367c05a229d7cd7b9afff", "message": "Disable failsafe integration tests on travis explicitly\n\n`-Dmaven.test.skip=true` was not enough in the second `after_success` step.", "committedDate": "2020-03-25T15:04:46Z", "type": "commit"}, {"oid": "7f1a211882042f2e93fdd63129911a88d161be43", "url": "https://github.com/Graylog2/graylog2-server/commit/7f1a211882042f2e93fdd63129911a88d161be43", "message": "Add CLASS and METHOD lifecycle for backend\n\n- Added serverLifecycle property to ApiIntegrationTest annotation\n- default to METHOD where server is restarted after each test", "committedDate": "2020-03-25T15:04:46Z", "type": "commit"}, {"oid": "93c35eca8151b7367e3e3a590b5aab04f3dfd01a", "url": "https://github.com/Graylog2/graylog2-server/commit/93c35eca8151b7367e3e3a590b5aab04f3dfd01a", "message": "Avoid recreating containers for GraylogBackend per test class\n\nConverted GraylogBackend to singleton. This ensures that images\nand containers can reused globally.", "committedDate": "2020-03-25T15:04:47Z", "type": "commit"}, {"oid": "c5aa46c79f195d6d637fe91138d8129f89284ba8", "url": "https://github.com/Graylog2/graylog2-server/commit/c5aa46c79f195d6d637fe91138d8129f89284ba8", "message": "Add license headers", "committedDate": "2020-03-25T15:04:47Z", "type": "commit"}, {"oid": "9ef0b0485cdcf85ecbf78e805f915957f1854cf8", "url": "https://github.com/Graylog2/graylog2-server/commit/9ef0b0485cdcf85ecbf78e805f915957f1854cf8", "message": "Use project graylog.conf instead of copy", "committedDate": "2020-03-25T15:04:47Z", "type": "commit"}, {"oid": "3d423e7017dd8783642f2cec8b30914e7ec2e96a", "url": "https://github.com/Graylog2/graylog2-server/commit/3d423e7017dd8783642f2cec8b30914e7ec2e96a", "message": "Use project log4j2.xml instead of copy", "committedDate": "2020-03-25T15:04:48Z", "type": "commit"}, {"oid": "4b003683534a8afccddea7e5c768ad00578550a3", "url": "https://github.com/Graylog2/graylog2-server/commit/4b003683534a8afccddea7e5c768ad00578550a3", "message": "Package jars when not running in Maven\n\n...instead of when running in Intellij explicitly", "committedDate": "2020-03-25T15:04:48Z", "type": "commit"}, {"oid": "40ec25197946a728701064ef2a9532d267afd0f0", "url": "https://github.com/Graylog2/graylog2-server/commit/40ec25197946a728701064ef2a9532d267afd0f0", "message": "Extract tmp file creation from NodeInstance\n\n- Added separate class ResourceUtil to extract this\n  detail from NodeInstance", "committedDate": "2020-03-25T15:04:48Z", "type": "commit"}, {"oid": "a727ed213cfb86ece26c28e8a7c657d1ecdda685", "url": "https://github.com/Graylog2/graylog2-server/commit/a727ed213cfb86ece26c28e8a7c657d1ecdda685", "message": "Allow setting env var to skip packaging\n\n- Use existing jars, if env var GRAYLOG_IT_SKIP_PACKAGING\n  is set to \"true\" (ignoring case)", "committedDate": "2020-03-25T15:04:49Z", "type": "commit"}, {"oid": "1d8ba38f8c3c6e2f57e90769bf4631ca58d8e70b", "url": "https://github.com/Graylog2/graylog2-server/commit/1d8ba38f8c3c6e2f57e90769bf4631ca58d8e70b", "message": "Upgrade rest-assured to 4.2.0", "committedDate": "2020-03-25T15:04:49Z", "type": "commit"}, {"oid": "845644f75d94af8dc9b6bd806e8db08c552bfc56", "url": "https://github.com/Graylog2/graylog2-server/commit/845644f75d94af8dc9b6bd806e8db08c552bfc56", "message": "Allow remote debugging of graylog server\n\nThis allows to attach a remote debugger to the server container.\nThe biggest caveat is that the dynamic port to which the debugger can be\nattached is only known after starting the container. Hence one would\nhave to set a breakpoint after the container start to pause execution,\nidentify the debug port and start the remote debugger with it.\n\n- Added debug toggle via env var GRAYLOG_IT_DEBUG_SERVER\n- Added optional debug build arg to container\n- Added logging of debug port, if debugging is enabled\n- Extracted building the container to NodeContainerFactory", "committedDate": "2020-03-25T15:04:49Z", "type": "commit"}, {"oid": "45cb5b52661cbf0930d9b54c6891ec1e13e5cb11", "url": "https://github.com/Graylog2/graylog2-server/commit/45cb5b52661cbf0930d9b54c6891ec1e13e5cb11", "message": "Add license headers", "committedDate": "2020-03-25T15:04:50Z", "type": "commit"}, {"oid": "c45df27f456d3911ec77fde7f2312605df709a6e", "url": "https://github.com/Graylog2/graylog2-server/commit/c45df27f456d3911ec77fde7f2312605df709a6e", "message": "Disable purging data for Lifecycle.CLASS\n\nDoesn't work, because you can't wipe the mongodb from underneath a running server.\nTests failed, because all permissions were gone. But there would probably have been\neven more issues like that.\nSo when Lifecycle.CLASS is chosen, all data remains in the DBs across tests.", "committedDate": "2020-03-25T15:04:50Z", "type": "commit"}, {"oid": "c59dedf5850b1aaf43a1e20fc73759cf6eeba6eb", "url": "https://github.com/Graylog2/graylog2-server/commit/c59dedf5850b1aaf43a1e20fc73759cf6eeba6eb", "message": "Enable Elasticsearch fixtures", "committedDate": "2020-03-25T15:04:50Z", "type": "commit"}, {"oid": "421b514ab2faafa26ed9c2c7cda8ba87dd2ba8b0", "url": "https://github.com/Graylog2/graylog2-server/commit/421b514ab2faafa26ed9c2c7cda8ba87dd2ba8b0", "message": "Refactored BackendStartupIT#importsElasticsearchFixtures\n\n... tomake it easier to understand", "committedDate": "2020-03-25T15:04:51Z", "type": "commit"}, {"oid": "c977af8044c1b9ef573b0d768afc72e26d353b49", "url": "https://github.com/Graylog2/graylog2-server/commit/c977af8044c1b9ef573b0d768afc72e26d353b49", "message": "Cleanup", "committedDate": "2020-03-25T15:04:51Z", "type": "commit"}, {"oid": "7e40c2bc2b22a126380f800d16aea23398aff090", "url": "https://github.com/Graylog2/graylog2-server/commit/7e40c2bc2b22a126380f800d16aea23398aff090", "message": "Added param object NodeContainerConfig", "committedDate": "2020-03-25T15:04:51Z", "type": "commit"}, {"oid": "ccaf2f66705d673d62e66e78d681e1a3ac07335e", "url": "https://github.com/Graylog2/graylog2-server/commit/ccaf2f66705d673d62e66e78d681e1a3ac07335e", "message": "Added README explaining local config options\n\nPlaced it in the `testing.completebackend` package in lack of a better\nidea where to put it. Can be moved somewhere else after the contents\nhave been reviewed.", "committedDate": "2020-03-25T15:04:51Z", "type": "commit"}, {"oid": "b48e5a8dbe241a39855ff1a4d7a7be5cafe03df1", "url": "https://github.com/Graylog2/graylog2-server/commit/b48e5a8dbe241a39855ff1a4d7a7be5cafe03df1", "message": "Reduce docker-entrypoint.sh to necessary parts\n\n- Deleted unnecessary code from docker-entrypoint.sh\n  (was originally copied from https://github.com/Graylog2/graylog-docker)\n- Created contentpacks dir also in Dockerfile\n  Dir creation was actually redundant in Dockerfile and docker-entrypoint.sh.\n  The contentpacks dur was the only one missing in Dockerfile.", "committedDate": "2020-03-25T15:04:52Z", "type": "commit"}, {"oid": "9299ccef56a9582d3b9dc4127f3273f29c632734", "url": "https://github.com/Graylog2/graylog2-server/commit/9299ccef56a9582d3b9dc4127f3273f29c632734", "message": "Skip forbiddenapis check in MavenPackager", "committedDate": "2020-03-25T15:04:52Z", "type": "commit"}, {"oid": "07194b398d92276aa836f562bcd93a633305c008", "url": "https://github.com/Graylog2/graylog2-server/commit/07194b398d92276aa836f562bcd93a633305c008", "message": "Add braces around one-line conditional blocks\n\n...to comply with coding standards.", "committedDate": "2020-03-25T15:04:53Z", "type": "commit"}, {"oid": "d1c9fa7daa9f382ca19c858007bd051725e22699", "url": "https://github.com/Graylog2/graylog2-server/commit/d1c9fa7daa9f382ca19c858007bd051725e22699", "message": "Start mongodb and node in sequence\n\n...because starting them in parallel is not safe, as @bernd\npointed out in a review.", "committedDate": "2020-03-25T15:04:53Z", "type": "commit"}, {"oid": "02f6e1e35d6ca0974d840d6a5f9d1b81349fbd52", "url": "https://github.com/Graylog2/graylog2-server/commit/02f6e1e35d6ca0974d840d6a5f9d1b81349fbd52", "message": "Move configuration of RequestSpecification to GraylogBackendExtension\n\n- Make RestAssured RequestSpecification injectable to allow reuse\n- Configure baseUri, port, and basePath to avoid having to concat\n  the api path in every test", "committedDate": "2020-03-25T15:04:53Z", "type": "commit"}, {"oid": "0232fa0a86c604178cec5fb6678fc77c670c91b5", "url": "https://github.com/Graylog2/graylog2-server/commit/0232fa0a86c604178cec5fb6678fc77c670c91b5", "message": "Set additional env vars in NodeContainerFactory\n\n- GRAYLOG_LB_RECOGNITION_PERIOD_SECONDS: save time on server shutdown\n- GRAYLOG_VERSIONCHECKS: avoid contacting version check service\n- add explanatory comment for ADMIN_PW_SHA2", "committedDate": "2020-03-25T15:04:54Z", "type": "commit"}, {"oid": "ae681503d003da8775b7b7c51215351343a375d9", "url": "https://github.com/Graylog2/graylog2-server/commit/ae681503d003da8775b7b7c51215351343a375d9", "message": "Use constant for GRAYLOG_HTTP_BIND_ADDRESS", "committedDate": "2020-03-25T15:04:54Z", "type": "commit"}, {"oid": "b5572e2c0372c48db0eef1699f61e8d6de45b22e", "url": "https://github.com/Graylog2/graylog2-server/commit/b5572e2c0372c48db0eef1699f61e8d6de45b22e", "message": "Add JavaDocs to explain the ApiIntegrationTest annotation", "committedDate": "2020-03-25T15:04:55Z", "type": "commit"}, {"oid": "344d5da1c210fee9e099b14bad1cbdb52170d3e9", "url": "https://github.com/Graylog2/graylog2-server/commit/344d5da1c210fee9e099b14bad1cbdb52170d3e9", "message": "Log Maven command when packaging fails", "committedDate": "2020-03-25T15:04:55Z", "type": "commit"}, {"oid": "cd9c795c0b579e146748b194293a70ab9b68880d", "url": "https://github.com/Graylog2/graylog2-server/commit/cd9c795c0b579e146748b194293a70ab9b68880d", "message": "Improve temp file creation\n\n- More descriptive filename\n- Use `File.createTempFile` explicitly\n- Delete on exit", "committedDate": "2020-03-25T15:04:56Z", "type": "commit"}, {"oid": "9be0ee18d93263d7efbbd166f5ccadd0d7be79be", "url": "https://github.com/Graylog2/graylog2-server/commit/9be0ee18d93263d7efbbd166f5ccadd0d7be79be", "message": "Reset skip flag for old integration tests to \"true\"\n\nSetting it to \"false\" slipped in when investigating how difficult it would\nbe to port them to the new solution.", "committedDate": "2020-03-25T15:04:56Z", "type": "commit"}, {"oid": "3794b9be5ae8a466d7dd5a1ab671f04889448313", "url": "https://github.com/Graylog2/graylog2-server/commit/3794b9be5ae8a466d7dd5a1ab671f04889448313", "message": "Use explicit Locale for String.format\n\n...as required by our forbiddenapis check", "committedDate": "2020-03-25T15:04:56Z", "type": "commit"}, {"oid": "3794b9be5ae8a466d7dd5a1ab671f04889448313", "url": "https://github.com/Graylog2/graylog2-server/commit/3794b9be5ae8a466d7dd5a1ab671f04889448313", "message": "Use explicit Locale for String.format\n\n...as required by our forbiddenapis check", "committedDate": "2020-03-25T15:04:56Z", "type": "forcePushed"}, {"oid": "7c3b14608d49727f778142029ee6fcc24fba4c4d", "url": "https://github.com/Graylog2/graylog2-server/commit/7c3b14608d49727f778142029ee6fcc24fba4c4d", "message": "Add check for Maven executable\n\nDuring his review @kmerz had the issue that the Maven executable\ncouldn't be found and the resulting error message was not very\nhelpful for him.\nThis should make that error more explicit for the user.", "committedDate": "2020-03-25T15:53:24Z", "type": "commit"}, {"oid": "8798fea9f696ae6d6788cd550624928938e2d19b", "url": "https://github.com/Graylog2/graylog2-server/commit/8798fea9f696ae6d6788cd550624928938e2d19b", "message": "Fix maven command\n\nAccidentally left in \"echo $PATH\" after debugging. :/", "committedDate": "2020-03-25T16:55:38Z", "type": "commit"}, {"oid": "3f6a9fb6d3d2c9363ad1338ed45ef29a12dd51fc", "url": "https://github.com/Graylog2/graylog2-server/commit/3f6a9fb6d3d2c9363ad1338ed45ef29a12dd51fc", "message": "Added alternative check for failing maven command\n\n...to see which one triggers on @kmerz's system.\nWill remove one of them afterwards.", "committedDate": "2020-03-25T16:56:42Z", "type": "commit"}, {"oid": "701983a742f6ccfdcf7b3936ff27d4b68b3a5c31", "url": "https://github.com/Graylog2/graylog2-server/commit/701983a742f6ccfdcf7b3936ff27d4b68b3a5c31", "message": "Warn about ~ in PATH when mvn executable not found\n\n- Extracted check for executable to own class\n- Added explicit warning about ~ in PATH to exception message\n- Added a note to the Readme, pointing out the directory for mvn in PATH\n  must not contain a ~", "committedDate": "2020-03-26T10:00:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NzY2Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7561#discussion_r396987662", "bodyText": "This file is completly outdated and can be deleted!", "author": "kmerz", "createdAt": "2020-03-24T08:51:31Z", "path": "integration-tests/src/test/java/integration/system/bundles/ContentPackStreamsTest.java", "diffHunk": "@@ -17,18 +17,20 @@\n package integration.system.bundles;\n \n import com.google.common.net.HttpHeaders;\n-import com.jayway.restassured.response.ValidatableResponse;\n import integration.BaseRestTest;\n import integration.RequiresAuthentication;\n import integration.RequiresVersion;\n+import io.restassured.response.ValidatableResponse;\n+import org.junit.Ignore;\n import org.junit.Test;\n \n import java.net.URI;\n \n-import static com.jayway.restassured.RestAssured.given;\n+import static io.restassured.RestAssured.given;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.hamcrest.CoreMatchers.notNullValue;\n \n+@Ignore(\"legacy test that should be converted or deleted\")", "originalCommit": "87bc2b6011cbb7bbd0f185e4ebd093c7152f8104", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}