{"pr_number": 8488, "pr_title": "Implement `SearchesAdapter` for ES7.", "pr_createdAt": "2020-07-06T10:21:12Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8488", "timeline": [{"oid": "76a9197e635fec4ed45c66d4955e40b8204ee089", "url": "https://github.com/Graylog2/graylog2-server/commit/76a9197e635fec4ed45c66d4955e40b8204ee089", "message": "Wrapping scroll request in multi search to avoid 4k limit.", "committedDate": "2020-07-06T11:56:18Z", "type": "forcePushed"}, {"oid": "f740966e2241a42f67d205dad679bb204367e193", "url": "https://github.com/Graylog2/graylog2-server/commit/f740966e2241a42f67d205dad679bb204367e193", "message": "Adding safeguard for scroll id extraction.", "committedDate": "2020-07-06T15:26:06Z", "type": "forcePushed"}, {"oid": "75785dc7de7c065eec6fa8adbe442619e2f711e6", "url": "https://github.com/Graylog2/graylog2-server/commit/75785dc7de7c065eec6fa8adbe442619e2f711e6", "message": "Implementing scroll result limiting for ES6.", "committedDate": "2020-07-09T08:07:41Z", "type": "forcePushed"}, {"oid": "b7492b6a7efbb2158ec1d32204e494987f5f47d7", "url": "https://github.com/Graylog2/graylog2-server/commit/b7492b6a7efbb2158ec1d32204e494987f5f47d7", "message": "Implementing scroll result limiting for ES6.", "committedDate": "2020-07-09T11:00:33Z", "type": "forcePushed"}, {"oid": "afa50a0b047199c5dddd9ecf6683312a01a6811d", "url": "https://github.com/Graylog2/graylog2-server/commit/afa50a0b047199c5dddd9ecf6683312a01a6811d", "message": "Implement `SearchesAdapter` for ES7.\n\nThis change is implementing the `SearchesAdapter` for ES7, creates bindings and implements the abstract integration test for it. It also includes the required classes to generate `ScrollResult` & `ScrollResult.ScrollChunk` instances.", "committedDate": "2020-07-14T14:48:32Z", "type": "commit"}, {"oid": "8b401b6626278c53730940c923c16ad6aff9c2f5", "url": "https://github.com/Graylog2/graylog2-server/commit/8b401b6626278c53730940c923c16ad6aff9c2f5", "message": "Removing unneeded intermediate method.", "committedDate": "2020-07-14T14:48:34Z", "type": "commit"}, {"oid": "1a595a5daca06a0027f517d16c22578a823773b8", "url": "https://github.com/Graylog2/graylog2-server/commit/1a595a5daca06a0027f517d16c22578a823773b8", "message": "Adding safeguard for scroll id extraction.", "committedDate": "2020-07-14T14:48:34Z", "type": "commit"}, {"oid": "c87faeaaff99aae3fe4e7bb1fc5418381f535e1d", "url": "https://github.com/Graylog2/graylog2-server/commit/c87faeaaff99aae3fe4e7bb1fc5418381f535e1d", "message": "Implementing scroll result limiting for ES7, adding test case.", "committedDate": "2020-07-14T14:48:34Z", "type": "commit"}, {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "url": "https://github.com/Graylog2/graylog2-server/commit/a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "message": "Implementing scroll result limiting for ES6.", "committedDate": "2020-07-14T14:48:34Z", "type": "commit"}, {"oid": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "url": "https://github.com/Graylog2/graylog2-server/commit/a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "message": "Implementing scroll result limiting for ES6.", "committedDate": "2020-07-14T14:48:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0Mzg5Mw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r454943893", "bodyText": "I think we should use a constant somewhere instead of the magic number -1", "author": "alex-konn", "createdAt": "2020-07-15T10:13:44Z", "path": "graylog-storage-elasticsearch6/src/main/java/org/graylog/storage/elasticsearch6/SearchesAdapterES6.java", "diffHunk": "@@ -100,7 +100,8 @@ public ScrollResult scroll(ScrollCommand scrollCommand) {\n                 () -> \"Unable to perform scroll search\",\n                 searchQuery,\n                 DEFAULT_SCROLLTIME,\n-                scrollCommand.fields()\n+                scrollCommand.fields(),\n+                scrollCommand.limit().orElse(-1)", "originalCommit": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MTkxMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455071913", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-07-15T13:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0Mzg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNDEwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455024109", "bodyText": "AGG_FILTER is unused. On purpose?", "author": "alex-konn", "createdAt": "2020-07-15T12:47:30Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/SearchesAdapterES7.java", "diffHunk": "@@ -0,0 +1,213 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import com.google.common.collect.Streams;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchRequest;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.action.search.SearchResponse;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.AggregationBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.Cardinality;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ExtendedStats;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.aggregations.metrics.ValueCount;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog2.indexer.ranges.IndexRange;\n+import org.graylog2.indexer.results.CountResult;\n+import org.graylog2.indexer.results.FieldStatsResult;\n+import org.graylog2.indexer.results.ResultMessage;\n+import org.graylog2.indexer.results.ScrollResult;\n+import org.graylog2.indexer.results.SearchResult;\n+import org.graylog2.indexer.searches.ScrollCommand;\n+import org.graylog2.indexer.searches.SearchesAdapter;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.inject.Inject;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+\n+public class SearchesAdapterES7 implements SearchesAdapter {\n+    private static final String AGG_CARDINALITY = \"gl2_field_cardinality\";\n+    private static final String AGG_EXTENDED_STATS = \"gl2_extended_stats\";\n+    private static final String AGG_FILTER = \"gl2_filter\";", "originalCommit": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MzUzNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455073535", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-07-15T13:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNDEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNzM4OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455027389", "bodyText": "I find the name Search a bit too broad here. I think this class deserves an abomination of a name like SearchRequestFactory or something to communicate more precisely what its role is in performing a search.", "author": "alex-konn", "createdAt": "2020-07-15T12:52:54Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/Search.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package org.graylog.storage.elasticsearch7;\n+\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.BoolQueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.graylog.shaded.elasticsearch7.org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;\n+import org.graylog2.indexer.searches.SearchesConfig;\n+import org.graylog2.indexer.searches.Sorting;\n+import org.graylog2.plugin.indexer.searches.timeranges.TimeRange;\n+\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+import static org.graylog.shaded.elasticsearch7.org.elasticsearch.index.query.QueryBuilders.queryStringQuery;\n+\n+public class Search {", "originalCommit": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3NjcxNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455076715", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-07-15T14:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyNzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1NjUzOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455056538", "bodyText": "As discussed with @dennisoelkers, this method should get a more precise name (and possibly an explanatory comment - maybe even be marked as @Deprecated) to indicate that it's only necessary to be compatible with existing handling of IOExceptions in scrolling-related code.", "author": "alex-konn", "createdAt": "2020-07-15T13:36:22Z", "path": "graylog-storage-elasticsearch7/src/main/java/org/graylog/storage/elasticsearch7/ElasticsearchClient.java", "diffHunk": "@@ -86,6 +90,16 @@ private SearchResponse firstResponseFrom(MultiSearchResponse result, String erro\n         }\n     }\n \n+    public <R> R executeUnsafe(ThrowingBiFunction<RestHighLevelClient, RequestOptions, R, IOException> fn, String errorMessage) throws IOException {", "originalCommit": "a78a5ed5cc6a7f907c9af9fcd1e39d65e14a9925", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3ODYwMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455078601", "bodyText": "\u2714\ufe0f", "author": "dennisoelkers", "createdAt": "2020-07-15T14:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1NjUzOA=="}], "type": "inlineReview"}, {"oid": "03eec4ecb131a6f5c839c7e2125894a2d911d276", "url": "https://github.com/Graylog2/graylog2-server/commit/03eec4ecb131a6f5c839c7e2125894a2d911d276", "message": "Removing unused constant.", "committedDate": "2020-07-15T13:56:51Z", "type": "commit"}, {"oid": "6d78bba6357021583b869a0a66064b9090e97761", "url": "https://github.com/Graylog2/graylog2-server/commit/6d78bba6357021583b869a0a66064b9090e97761", "message": "Extracting constant.", "committedDate": "2020-07-15T13:59:25Z", "type": "commit"}, {"oid": "8c52ca57ea706096e28faac1283e68b1c4d26760", "url": "https://github.com/Graylog2/graylog2-server/commit/8c52ca57ea706096e28faac1283e68b1c4d26760", "message": "Giving `Search` class a better name.", "committedDate": "2020-07-15T14:03:29Z", "type": "commit"}, {"oid": "7c8dde4605e3d4f97c591b8b6603dec3d02856c8", "url": "https://github.com/Graylog2/graylog2-server/commit/7c8dde4605e3d4f97c591b8b6603dec3d02856c8", "message": "Giving method a better name.", "committedDate": "2020-07-15T14:05:35Z", "type": "commit"}, {"oid": "01cb4c19a2db3cf26e022dce10788d522f26da64", "url": "https://github.com/Graylog2/graylog2-server/commit/01cb4c19a2db3cf26e022dce10788d522f26da64", "message": "Reusing `NO_LIMIT`, introducing `NO_BATCHSIZE`.", "committedDate": "2020-07-15T14:33:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyNDM1NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8488#discussion_r455124354", "bodyText": "NO_BATCHSIZE, NO_LIMIT, NO_GOD. I like it.", "author": "alex-konn", "createdAt": "2020-07-15T15:04:46Z", "path": "graylog2-server/src/main/java/org/graylog2/indexer/searches/ScrollCommand.java", "diffHunk": "@@ -31,6 +31,9 @@\n @AutoValue\n @JsonAutoDetect\n public abstract class ScrollCommand {\n+    public static final int NO_BATCHSIZE = -1;\n+    public static final int NO_LIMIT = -1;", "originalCommit": "01cb4c19a2db3cf26e022dce10788d522f26da64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}