{"pr_number": 7199, "pr_title": "Add support to dump the current ProcessBuffer state", "pr_createdAt": "2020-01-16T10:14:37Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/7199", "timeline": [{"oid": "9b9260b0f75a7f119ed435c103a001ba0c661881", "url": "https://github.com/Graylog2/graylog2-server/commit/9b9260b0f75a7f119ed435c103a001ba0c661881", "message": "Add support to dump the current ProcessBuffer state\n\nIntroduce a new API call that returns the messages\nthat are currently processed in each ProcessBufferProcessor.\n\nThis is useful to debug cases where message processing got stuck.\nThe most common case is the use of an inefficient regular expression\nin extractors or pipeline rules.\nUnderstanding which regular expression caused the problem can be\ndifficult, without knowing which message triggered the problem.\n\nExample:\n\n- Set up pipeline rule with an evil backtracking regex like `/(x+x+)+y/`\n- Send message that spends hours in processing.\n\n- GET https://172.16.1.1:9000/api/system/processbufferdump\n\n```\n{\n  \"processbuffer_dump\": {\n    \"ProcessBufferProcessor #4\": \"idle\",\n    \"ProcessBufferProcessor #2\": \"MessageEvent{raw=null, message=source: t480 | message: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx { application_name: mpf | level: 5 | gl2_remote_ip: 127.0.0.1 | timestamp: 2020-01-16T11:00:48.296+01:00 } [...] }\",\n    \"ProcessBufferProcessor #3\": \"idle\",\n    \"ProcessBufferProcessor #0\": \"idle\",\n    \"ProcessBufferProcessor #1\": \"idle\"\n  }\n}\n```", "committedDate": "2020-01-16T10:12:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwODYxOA==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367408618", "bodyText": "I think we should make this variable volatile to ensure cross-thread visibility.", "author": "bernd", "createdAt": "2020-01-16T13:12:22Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/buffers/processors/ProcessBufferProcessor.java", "diffHunk": "@@ -56,6 +57,7 @@\n     private final ULID ulid;\n     private final DecodingProcessor decodingProcessor;\n     private final Provider<Stream> defaultStreamProvider;\n+    private MessageEvent currentEvent;", "originalCommit": "9b9260b0f75a7f119ed435c103a001ba0c661881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MDE5OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367450199", "bodyText": "Good catch \ud83d\udc4d", "author": "mpfz0r", "createdAt": "2020-01-16T14:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwODYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxNDU3OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367414579", "bodyText": "How about setting (and clearing) this in #dispatchMessage() instead? That way we only get the single message. The MessageEvent could contain one or more messages.", "author": "bernd", "createdAt": "2020-01-16T13:25:41Z", "path": "graylog2-server/src/main/java/org/graylog2/shared/buffers/processors/ProcessBufferProcessor.java", "diffHunk": "@@ -75,11 +77,13 @@ public ProcessBufferProcessor(MetricRegistry metricRegistry,\n         incomingMessages = metricRegistry.meter(name(ProcessBufferProcessor.class, \"incomingMessages\"));\n         outgoingMessages = metricRegistry.meter(name(ProcessBufferProcessor.class, \"outgoingMessages\"));\n         processTime = metricRegistry.timer(name(ProcessBufferProcessor.class, \"processTime\"));\n+        currentEvent = null;\n     }\n \n     @Override\n     public void onEvent(MessageEvent event) throws Exception {\n         try {\n+            currentEvent = event;", "originalCommit": "9b9260b0f75a7f119ed435c103a001ba0c661881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MTc2NQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367451765", "bodyText": "I agree. The downside is that we wouldn't see problems within a DecodingProcessor but that's less unlikely.", "author": "mpfz0r", "createdAt": "2020-01-16T14:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxNDU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODkwMg==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367418902", "bodyText": "What do you think about adding another endpoint that returns the dumps for all nodes? That would make it way easier to use. We have ProxiedResource#getForAllNodes() for that. Example:\n\n  \n    \n      graylog2-server/graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterSystemJobResource.java\n    \n    \n         Line 74\n      in\n      cb33786\n    \n    \n    \n    \n\n        \n          \n           return getForAllNodes(RemoteSystemJobResource::list, createRemoteInterfaceProvider(RemoteSystemJobResource.class));", "author": "bernd", "createdAt": "2020-01-16T13:34:39Z", "path": "graylog2-server/src/main/java/org/graylog2/rest/resources/cluster/ClusterSystemResource.java", "diffHunk": "@@ -116,5 +117,26 @@ public SystemThreadDumpResponse threadDump(@ApiParam(name = \"nodeId\", value = \"T\n             throw new WebApplicationException(response.message(), BAD_GATEWAY);\n         }\n     }\n+\n+    @GET\n+    @Timed\n+    @ApiOperation(value = \"Get a process buffer dump of the given node\")\n+    @RequiresPermissions(RestPermissions.PROCESSBUFFER_DUMP)\n+    @Path(\"{nodeId}/processbufferdump\")", "originalCommit": "9b9260b0f75a7f119ed435c103a001ba0c661881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2OTEyMw==", "url": "https://github.com/Graylog2/graylog2-server/pull/7199#discussion_r367469123", "bodyText": "Nice. Thanks. BTW, I think we should also add this to get all metrics (org.) from the cluster", "author": "mpfz0r", "createdAt": "2020-01-16T15:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQxODkwMg=="}], "type": "inlineReview"}, {"oid": "2a7ea6ff6c72716fd095125791578fdcbb075793", "url": "https://github.com/Graylog2/graylog2-server/commit/2a7ea6ff6c72716fd095125791578fdcbb075793", "message": "Only keep track of single Messages\n\nThe MessageEvent can contain multiple messages.\n\nAlso declare currentMessage as volatile, to avoid visibility problems on\nmultiple threads.", "committedDate": "2020-01-16T14:37:00Z", "type": "commit"}, {"oid": "325583070a020c3d28f277b38b6213587bc4dfbc", "url": "https://github.com/Graylog2/graylog2-server/commit/325583070a020c3d28f277b38b6213587bc4dfbc", "message": "Add support to get process buffer dump of all cluster nodes", "committedDate": "2020-01-16T14:55:50Z", "type": "commit"}, {"oid": "dad6fe3b0e3a94f56c566fe72d5aeea7fa8ba83c", "url": "https://github.com/Graylog2/graylog2-server/commit/dad6fe3b0e3a94f56c566fe72d5aeea7fa8ba83c", "message": "Merge branch 'master' into processbuffer-dumper", "committedDate": "2020-01-22T13:58:52Z", "type": "commit"}, {"oid": "4b987cf5af9215db5718dc3c8a6279f23c6cdc59", "url": "https://github.com/Graylog2/graylog2-server/commit/4b987cf5af9215db5718dc3c8a6279f23c6cdc59", "message": "Simplify ProcessBuffer#getDump() (approved my mpfz0r)", "committedDate": "2020-01-22T15:13:04Z", "type": "commit"}, {"oid": "566773a52063a916986d48bef82c86d575f850d1", "url": "https://github.com/Graylog2/graylog2-server/commit/566773a52063a916986d48bef82c86d575f850d1", "message": "Add UI for process-buffer dumps similar to the thread dump UI", "committedDate": "2020-01-22T16:15:51Z", "type": "commit"}]}