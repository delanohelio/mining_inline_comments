{"pr_number": 1547, "pr_title": "JBTM-3243 Use PostConstruct/PreDestroy for ApplicationScoped bean (instead of Observer)", "pr_createdAt": "2020-01-09T19:28:00Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1547", "timeline": [{"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "url": "https://github.com/jbosstm/narayana/commit/747b0537818d2ff43e4d15c5a16b1c6e99612f48", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event", "committedDate": "2020-01-10T16:32:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNDQ5Nw==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365324497", "bodyText": "I guess this is separate to the core JBTM in this PR?", "author": "tomjenkinson", "createdAt": "2020-01-10T16:39:40Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -62,7 +61,7 @@\n     private Map<URI, Transaction> recoveringLRAs = new ConcurrentHashMap<>();\n     private Map<URI, ReentrantLock> locks = new ConcurrentHashMap<>();\n \n-    private static Map<String, String> participants = new ConcurrentHashMap<>();\n+    private Map<String, String> participants = new ConcurrentHashMap<>();", "originalCommit": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0Nzc3Mw==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365347773", "bodyText": "Well the bean is ApplicationScoped so using a static makes little difference.", "author": "mmusgrov", "createdAt": "2020-01-10T17:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0ODQ3NA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365348474", "bodyText": "Agreed, it looks right not to be static but is it related to https://issues.redhat.com/browse/JBTM-3243 is what I was getting at.", "author": "tomjenkinson", "createdAt": "2020-01-10T17:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MzY4OQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365383689", "bodyText": "Well I think so since the PR is all about getting the semantics of an ApplicationScoped bean correct and using statics in such a bean is counter intuitive.", "author": "mmusgrov", "createdAt": "2020-01-10T19:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTQxNg==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365325416", "bodyText": "I note that this is currently a no-op but I wonder if a separate JBTM should be removing from the RecordTypeManager to reverse the install?", "author": "tomjenkinson", "createdAt": "2020-01-10T16:41:31Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -410,18 +404,18 @@ void enableRecovery(@Observes @Initialized(ApplicationScoped.class) Object init)\n \n     /**\n      * When the deployment is unloaded unregister for recovery\n-     *\n-     * @param init a javax.servlet.ServletContext\n      */\n-    void disableRecovery(@Observes @Destroyed(ApplicationScoped.class) Object init) {\n-        assert lraRecoveryModule != null;\n+    @PreDestroy\n+    void disableRecovery() {\n+        if (lraRecoveryModule != null) {\n \n-        Implementations.uninstall();\n-        RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n-        lraRecoveryModule = null;\n+            Implementations.uninstall();", "originalCommit": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1NDYwOA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365354608", "bodyText": "I provided an implementation for Implementations.uninstall()", "author": "mmusgrov", "createdAt": "2020-01-10T17:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTkyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365325925", "bodyText": "I am not sure what the %n refers to here. I think it would be fine to correct the typo given it is debug statement and is being edited in this PR", "author": "tomjenkinson", "createdAt": "2020-01-10T16:42:31Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -410,18 +404,18 @@ void enableRecovery(@Observes @Initialized(ApplicationScoped.class) Object init)\n \n     /**\n      * When the deployment is unloaded unregister for recovery\n-     *\n-     * @param init a javax.servlet.ServletContext\n      */\n-    void disableRecovery(@Observes @Destroyed(ApplicationScoped.class) Object init) {\n-        assert lraRecoveryModule != null;\n+    @PreDestroy\n+    void disableRecovery() {\n+        if (lraRecoveryModule != null) {\n \n-        Implementations.uninstall();\n-        RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n-        lraRecoveryModule = null;\n+            Implementations.uninstall();\n+            RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n+            lraRecoveryModule = null;\n \n-        if (LRALogger.logger.isDebugEnabled()) {\n-            LRALogger.logger.debugf(\"LRAServicve.disableRecovery%n\");\n+            if (LRALogger.logger.isDebugEnabled()) {\n+                LRALogger.logger.debugf(\"LRAServicve.disableRecovery%n\");", "originalCommit": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0ODg3OA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365348878", "bodyText": "It wasn't introduced by the PR but I agree it's a good opportunity to correct it.", "author": "mmusgrov", "createdAt": "2020-01-10T17:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365330264", "bodyText": "was this part a general tidy up or was it related to JBTM-3243? if general I think it needs a separate issue?", "author": "tomjenkinson", "createdAt": "2020-01-10T16:51:49Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -189,13 +188,9 @@ public void remove(String state, URI lraId) {\n             lras.remove(lraId);\n         }\n \n-        if (recoveringLRAs.containsKey(lraId)) {\n-            recoveringLRAs.remove(lraId);\n-        }\n+        recoveringLRAs.remove(lraId);", "originalCommit": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0OTYxOQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365349619", "bodyText": "Really! Perhaps if I remember I will include it in a general tidy up sometime.", "author": "mmusgrov", "createdAt": "2020-01-10T17:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MDI3MA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365350270", "bodyText": "It's not caused by https://issues.redhat.com/browse/JBTM-3243 is it? But as our LRA implementation is not complete perhaps just a separate commit would suffice?", "author": "tomjenkinson", "createdAt": "2020-01-10T17:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MDU4OQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365350589", "bodyText": "The problem with having to raise a JBTM against every trivial issue on a code base that is tracking an evolving pre-release spec is that is slows down progress to delivering a first cut of the s/w", "author": "mmusgrov", "createdAt": "2020-01-10T17:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MTEzNA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365351134", "bodyText": "yeah, I tend to agree for the tidy up stuff. a separate commit though would be reasonable as it's not accurate to include it in a commit for a JBTM which does not apply, WDYT?", "author": "tomjenkinson", "createdAt": "2020-01-10T17:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQzMTAwOQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365431009", "bodyText": "Sure, a separate commit in the same PR would work for me (not in this one though since I reverted the change).", "author": "mmusgrov", "createdAt": "2020-01-10T21:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDMyMQ==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365330321", "bodyText": "was this part a general tidy up or was it related to JBTM-3243? if general I think it needs a separate issue?", "author": "tomjenkinson", "createdAt": "2020-01-10T16:51:55Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -189,13 +188,9 @@ public void remove(String state, URI lraId) {\n             lras.remove(lraId);\n         }\n \n-        if (recoveringLRAs.containsKey(lraId)) {\n-            recoveringLRAs.remove(lraId);\n-        }\n+        recoveringLRAs.remove(lraId);\n \n-        if (locks.containsKey(lraId)) {\n-            locks.remove(lraId);\n-        }\n+        locks.remove(lraId);", "originalCommit": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MDY0OA==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365350648", "bodyText": "ditto", "author": "mmusgrov", "createdAt": "2020-01-10T17:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MTc2Nw==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365351767", "bodyText": "I have revised on #1547 (comment)", "author": "tomjenkinson", "createdAt": "2020-01-10T17:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDMyMQ=="}], "type": "inlineReview"}, {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2", "url": "https://github.com/jbosstm/narayana/commit/e73ab4356a22f08c54dfd381596e65571eab07d2", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event", "committedDate": "2020-01-10T17:51:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4NTMzMg==", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365385332", "bodyText": "@tomjenkinson This is the implementation for Implementations.uninstall()", "author": "mmusgrov", "createdAt": "2020-01-10T19:05:38Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/internal/Implementations.java", "diffHunk": "@@ -48,17 +48,20 @@ public int getType() {\n \n public class Implementations {\n \n-    private static boolean _added = false;\n+    private static LRACompensatorMap typeMap;\n \n     public static synchronized void install() {\n-        if (!_added) {\n-            RecordTypeManager.manager().add(new LRACompensatorMap());\n-\n-            _added = true;\n+        if (typeMap == null) {\n+            typeMap = new LRACompensatorMap();\n+            RecordTypeManager.manager().add(typeMap);\n         }\n     }\n \n     public static synchronized void uninstall() {\n+        if (typeMap != null) {", "originalCommit": "e73ab4356a22f08c54dfd381596e65571eab07d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "809a8a9648396875de85a2b2a4b3ae7cf40260e6", "url": "https://github.com/jbosstm/narayana/commit/809a8a9648396875de85a2b2a4b3ae7cf40260e6", "message": "JBTM-3243 Use PostConstruct/PreDestroy for ApplicationScoped bean (instead of Observer)", "committedDate": "2020-01-10T21:11:23Z", "type": "forcePushed"}, {"oid": "792cdfaf0c11d68ac12475bd7b6e8c82f37bc074", "url": "https://github.com/jbosstm/narayana/commit/792cdfaf0c11d68ac12475bd7b6e8c82f37bc074", "message": "JBTM-3243 Use PostConstruct and PreDestroy to detect LRA application lifecycle", "committedDate": "2020-01-13T16:02:26Z", "type": "commit"}, {"oid": "e817f63a7ca38a3966586a65203ea25779a51ea1", "url": "https://github.com/jbosstm/narayana/commit/e817f63a7ca38a3966586a65203ea25779a51ea1", "message": "tidyup whilst fixing JBTM-3243", "committedDate": "2020-01-13T16:03:42Z", "type": "commit"}, {"oid": "e817f63a7ca38a3966586a65203ea25779a51ea1", "url": "https://github.com/jbosstm/narayana/commit/e817f63a7ca38a3966586a65203ea25779a51ea1", "message": "tidyup whilst fixing JBTM-3243", "committedDate": "2020-01-13T16:03:42Z", "type": "forcePushed"}]}