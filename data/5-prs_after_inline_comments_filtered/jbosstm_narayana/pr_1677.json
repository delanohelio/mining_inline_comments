{"pr_number": 1677, "pr_title": "JBTM-3349 Replace Apache HttpClient with JAX-RS client in LRA modules ", "pr_createdAt": "2020-09-30T09:37:15Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1677", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NjIxNQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r497476215", "bodyText": "For internationalization purposes we are used to use the error messages defined in i18Logger (ie. LRALogger.i18NLogger.*). Would be possible to change it that way?\n(I understand that it was not done so in the code before but as I hit this in the diff I think it could be good to be changed.)", "author": "ochaloup", "createdAt": "2020-09-30T12:40:19Z", "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -569,9 +562,14 @@ public LRAStatus getStatus(URI uri) throws WebApplicationException {\n         }\n \n         try {\n-            response = getTarget().path(getLRAId(lraId.toString())).path(\"status\")\n-                    .request()\n-                    .get();\n+            response = coordinatorClient.getLRAStatus(getLRAId(lraId.toString()));\n+        } catch (WebApplicationException wae) {\n+            Response waeResponse = wae.getResponse();\n+            if (waeResponse.getStatus() == Response.Status.NOT_FOUND.getStatusCode()) {\n+                String responseContent = waeResponse.readEntity(String.class);\n+                throw new NotFoundException(\"Failed to get status of LRA id \" + lraId", "originalCommit": "a651fbf53f35bebf867b6c56a326301a966426e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2MDM3Nw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r498060377", "bodyText": "I would suggest a new JBTM for this as this is not affecting only this code.", "author": "xstefank", "createdAt": "2020-10-01T08:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NjIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwODY0MQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r498208641", "bodyText": "+1", "author": "ochaloup", "createdAt": "2020-10-01T12:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NjIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3OTIxOA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r497479218", "bodyText": "I don't understand the purpose of the change here. The LRAData was intentionally made immutable. Why is needed this to be changed?", "author": "ochaloup", "createdAt": "2020-09-30T12:45:00Z", "path": "rts/lra/lra-service-base/src/main/java/io/narayana/lra/LRAData.java", "diffHunk": "@@ -8,14 +8,16 @@\n  * for JSON response creation when LRA info is asked for.\n  */\n public class LRAData {\n-    private final String lraId;\n-    private final String clientId;\n-    private final LRAStatus status;\n-    private final boolean isTopLevel;\n-    private final boolean isRecovering;\n-    private final long startTime;\n-    private final long finishTime;\n-    private final int httpStatus;\n+    private String lraId;", "originalCommit": "a651fbf53f35bebf867b6c56a326301a966426e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2MDkxMA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r498060910", "bodyText": "Used for the JSON (fasterxml) exchanges. FasterXML works with a default constructor and setters/getters still :)", "author": "xstefank", "createdAt": "2020-10-01T08:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwOTI1Nw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r498209257", "bodyText": "Ok, I see. I was thinking there will be some reason just I haven't got it from the context. Then this is fine.", "author": "ochaloup", "createdAt": "2020-10-01T12:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3OTIxOA=="}], "type": "inlineReview"}, {"oid": "3c191622d7ccda6c782f43f2504982c8864f6a2b", "url": "https://github.com/jbosstm/narayana/commit/3c191622d7ccda6c782f43f2504982c8864f6a2b", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-01T10:41:32Z", "type": "forcePushed"}, {"oid": "6d1fa33a85710dad640dd49cc1e54b575bb6160b", "url": "https://github.com/jbosstm/narayana/commit/6d1fa33a85710dad640dd49cc1e54b575bb6160b", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-05T07:15:54Z", "type": "forcePushed"}, {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "url": "https://github.com/jbosstm/narayana/commit/fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-05T08:17:16Z", "type": "forcePushed"}, {"oid": "1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "url": "https://github.com/jbosstm/narayana/commit/1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-07T08:33:59Z", "type": "forcePushed"}, {"oid": "788e0c203989b7b7cefaa226190a06e893950277", "url": "https://github.com/jbosstm/narayana/commit/788e0c203989b7b7cefaa226190a06e893950277", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-07T11:08:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501639398", "bodyText": "You can't just ignore code.\nAre there any other places in this PR where you have removed stuff that's required?", "author": "mmusgrov", "createdAt": "2020-10-08T11:14:39Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +234,8 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)", "originalCommit": "788e0c203989b7b7cefaa226190a06e893950277", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0MjQyNA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501642424", "bodyText": "This was something that I actually thought was an oversight as this code calls the same method as the other if branch (L235) just through JAX-RS invocation which doesn't make sense if the parent LRA id is not found. Would you prefer I take this in a new JBTM?", "author": "xstefank", "createdAt": "2020-10-08T11:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2NTAwMg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501665002", "bodyText": "The if part of the statement is a local invocation.\nThe else part of the statement is a remote invocation.\nie they execute different behaviours so you can't just remove the else part (we need to interact with remote coordinators since this is not a centralised service - we're operating in distributed microservices based environment.\nI am not aware of any bug in the original code so there's no need for a JBTM, unless you have a test case that shows there is a problem with it.", "author": "mmusgrov", "createdAt": "2020-10-08T12:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NTE3NA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501695174", "bodyText": "I vaguely recall either a demo or a quickstart that relied on multiple coordinators. Check the quickstarts (in fact I think you or someone else needs to verify that the quickstarts still run with these updates before we attempt merging them).", "author": "mmusgrov", "createdAt": "2020-10-08T12:52:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5ODIwMw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501698203", "bodyText": "In particular the quickstarts rely on thorntail. As we discussed earlier replacing ApacheHttp client calls with JAX-RS thorntail does not work without your ForkJoinClassLoading fix. But running the quickstarts would validate that fix.", "author": "mmusgrov", "createdAt": "2020-10-08T12:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA=="}], "type": "inlineReview"}, {"oid": "73b67965869963f7314db468c27db7a8332d760b", "url": "https://github.com/jbosstm/narayana/commit/73b67965869963f7314db468c27db7a8332d760b", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client", "committedDate": "2020-10-08T12:47:02Z", "type": "forcePushed"}, {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d", "url": "https://github.com/jbosstm/narayana/commit/f16dde974e7dda093485c55721af40b4a7b8688d", "message": "Replace MP REST client with JAX-RS client in lra-client module", "committedDate": "2020-10-12T13:49:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504671322", "bodyText": "newClient is a very expensive resource. Can you move the Client construction code to a separate method so that we can cache it in the future (you don't need to cache it in this PR but we should be doing so in the future). Similarly for other calls to newClient in this PR.", "author": "mmusgrov", "createdAt": "2020-10-14T13:21:12Z", "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIzMDAxNA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505230014", "bodyText": "thanks, in NarayanaLRAClient this is possible to cache.\nI'll just note that I've found it difficult to cache the client in the LRARecords as they are persisted and recovered from ObjectStore this is kind of difficult. I would like to investigate more in the future.", "author": "xstefank", "createdAt": "2020-10-15T06:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM2MzI0OQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505363249", "bodyText": "So it's not, probably just synchronization issues and the same client is used concurrently in different enlistments for instance. Worth investigating. But I'll move it into a separate method as requested.", "author": "xstefank", "createdAt": "2020-10-15T08:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxNjY5OA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505416698", "bodyText": "My comment was\n\n\"Can you move the Client construction code to a separate method so that we can cache it in the future (you don't need to cache it in this PR but we should be doing so in the future)\"\n\nie I am not asking you to cache the client in this PR.", "author": "mmusgrov", "createdAt": "2020-10-15T09:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3NDE4Mg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r506174182", "bodyText": "Since my comments do not effect the functionality I am resolving this conversation.", "author": "mmusgrov", "createdAt": "2020-10-16T08:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NDMwMQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504674301", "bodyText": "I don't think failure to contact a coordinator is an error condition (at most I would log it at debug or trace and leave it up to the application/caller to report noteworthy events). Similarly for other logging at error level.", "author": "mmusgrov", "createdAt": "2020-10-14T13:25:24Z", "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();\n+            Response response = client.target(base)\n+                .request()\n+                .get();\n+\n+            if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                LRALogger.i18NLogger.error_getAllLRAs(response.getStatus());", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504676092", "bodyText": "See previous comment (close is an expensive resource).", "author": "mmusgrov", "createdAt": "2020-10-14T13:27:50Z", "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();\n+            Response response = client.target(base)\n+                .request()\n+                .get();\n+\n+            if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                LRALogger.i18NLogger.error_getAllLRAs(response.getStatus());\n+                throw new WebApplicationException(response);\n+            }\n+\n+            return response.readEntity(new GenericType<List<LRAData>>() {});\n+        } finally {\n+            if (client != null) {\n+                client.close();", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4MTU5Nw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505481597", "bodyText": "@mmusgrov sorry, but I would prefer to keep this for now and really investigate the TCK hangs with Client caching in new JBTM. Would that be ok with you?", "author": "xstefank", "createdAt": "2020-10-15T11:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUxODUyNw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505518527", "bodyText": "You did half of what I asked (getClient()) but not the other half. You either need both changes or neither. The reason I asked to get the client via a method is so that we can cache it in the future. The finally block needs to call a method so that any future strategy for caching the connection will be in one place.", "author": "mmusgrov", "createdAt": "2020-10-15T12:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU2ODA0MA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505568040", "bodyText": "Which hangs? I am talking about opening and closing clients using a single method. The reason is as follows:\nThe docs (https://docs.oracle.com/javaee/7/api/javax/ws/rs/client/package-summary.html) say \"... Client instances - configurable, heavy-weight objects that manage the underlying communication infrastructure ...\".\nThat indicates to me that we need to be configuring a fixed minimal set of clients and we then share them thus avoiding the set up and tear down costs. If we put the relevant logic behind a method call then we can more easily decide how we want to do that. The original code (that this PR is reinstating) was already doing that (see pr/1515).", "author": "mmusgrov", "createdAt": "2020-10-15T14:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3MDAwMg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r506170002", "bodyText": "The change I am requesting is a structural change as opposed to a functional one so I am resolving this conversation.", "author": "mmusgrov", "createdAt": "2020-10-16T08:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NzA0OQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504687049", "bodyText": "Who adds the header (normally it would be done by ClientLRARequestFilter but I cannot see where that gets added)?", "author": "mmusgrov", "createdAt": "2020-10-14T13:42:46Z", "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -358,16 +383,25 @@ public URI joinLRA(URI lraId, Long timelimit,\n     }\n \n     public void leaveLRA(URI lraId, String body) throws WebApplicationException {\n-        ResponseHolder response = null;\n+        Client client = null;\n+        Response response = null;\n \n-        response = getTarget().path(String.format(leaveFormat, getLRAId(lraId.toString())))\n+        try {\n+            client = ClientBuilder.newClient();\n+\n+            response = client.target(base)\n+                .path(String.format(LEAVE_PATH, getLRAId(lraId.toString())))\n                 .request()\n-                .header(LRA_HTTP_CONTEXT_HEADER, lraId)", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4MjYwMw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505482603", "bodyText": "The header is not consumed on the coordinator, the LRA id is parsed from the path directly.", "author": "xstefank", "createdAt": "2020-10-15T11:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NzA0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3NDcwMQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r506174701", "bodyText": "Well spotted.", "author": "mmusgrov", "createdAt": "2020-10-16T08:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NzA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwNTY1Nw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504705657", "bodyText": "This error code seems a bit random. The method signature is already handling it (ie it throws WebApplicationException). Also we don't need to log anything here (see my previous comments about logging errors). If you really did want to log it at trace level then just re-throw the WebApplicationException.", "author": "mmusgrov", "createdAt": "2020-10-14T14:05:24Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +239,34 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)\n+                LRALogger.i18NLogger.error_parentLRANotFound(parentLRAUrl);\n+\n+                Client client = null;\n+                Response response = null;\n+\n+                try {\n+                    client = ClientBuilder.newClient();\n+                    response = client.target(parentLRAUrl)\n                         .request()\n-                        .async(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS)\n-                        .put(compensatorUrl, MediaType.TEXT_PLAIN);\n-                if (resp.getStatus() != Response.Status.OK.getStatusCode()) {\n-                    return Response.status(resp.getStatus()).build(); // TODO include reason\n+                        .async()\n+                        .put(Entity.text(compensatorUrl))\n+                        .get(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n+\n+                    if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                        String errMessage = String.format(\"The coordinator at %s returned an unexpected response: %d\",\n+                            parentLRAUrl, response.getStatus());\n+                        return Response.status(response.getStatus()).entity(errMessage).build();\n+                    }\n+                } catch (Exception e) {\n+                    LRALogger.logger.errorf(\"Cannot contact the LRA Coordinator at %s\", parentLRA);\n+                    return Response.status(PRECONDITION_FAILED).entity(e.getMessage()).build();", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4MzIyNg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505483226", "bodyText": "+1", "author": "xstefank", "createdAt": "2020-10-15T11:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwNTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504709562", "bodyText": "WebApplicationException is the exception of choice here - since we are using JAX-RS.", "author": "mmusgrov", "createdAt": "2020-10-14T14:10:32Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -419,17 +432,21 @@ private boolean afterLRARequest(URI target, String payload) {\n                 builder.header(LRA.LRA_HTTP_CONTEXT_HEADER, lra.getId().toASCIIString());\n             }\n \n-            builder.async(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n-\n-            ResponseHolder response = target.equals(forgetURI) ? builder.delete() : builder.put(payload, MediaType.TEXT_PLAIN);\n+            Future<Response> responseFuture =  target.equals(forgetURI) ? builder.async().delete()\n+                : builder.async().put(Entity.text(payload));\n+            Response response = responseFuture.get(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n \n             if (response.getStatus() == 200) {\n                 return true;\n             }\n-        } catch (WebApplicationException e) {\n+        } catch (Exception e) {", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4Mzc0OQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505483749", "bodyText": "The other exceptions come from the Future.get call.", "author": "xstefank", "createdAt": "2020-10-15T12:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUyMjA1Ng==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505522056", "bodyText": "Yes I know but the WebApplicationException will include the jax-rs error even for the Future.get call.", "author": "mmusgrov", "createdAt": "2020-10-15T13:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUyNDM0Mg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505524342", "bodyText": "not sure what you are proposing. The e.getMessage() will contain all the info from WebApplicationException in case. Or do you propose to throw WebApplicationException here?", "author": "xstefank", "createdAt": "2020-10-15T13:04:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3OTUwMQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505579501", "bodyText": "My point is that the original code was fine as it was.", "author": "mmusgrov", "createdAt": "2020-10-15T14:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3MTMxMw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r506171313", "bodyText": "I will leave this thread unresolved since I still argue that the original code was fine.", "author": "mmusgrov", "createdAt": "2020-10-16T08:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIyMQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504714221", "bodyText": "Similar comment as above. We are using JAX-RS so we need to use the WebApplicationException since that will already hold the relevant status code.", "author": "mmusgrov", "createdAt": "2020-10-14T14:16:27Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -718,8 +745,14 @@ boolean forget() {\n                     forgetURI, e.getMessage());\n                 // TODO write a test to ensure that recovery only retries the forget request\n                 return false; // force recovery to keep retrying\n+            } catch (Exception e) {", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4NDU2MA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505484560", "bodyText": "here the WebApplicationException is caught in the previous catch block.", "author": "xstefank", "createdAt": "2020-10-15T12:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUzMDIwMA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505530200", "bodyText": "The WebTarget, Invocation.Builder, AsyncInvoker and get on Future methods we are using all ultimately return a Response object to the caller so you don't need to catch checked exceptions.", "author": "mmusgrov", "createdAt": "2020-10-15T13:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3MTk0OQ==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r506171949", "bodyText": "I will leave this thread unresolved since you don't need to catch checked exceptions.", "author": "mmusgrov", "createdAt": "2020-10-16T08:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNjIzNw==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504716237", "bodyText": "I would use debug here (failure to contact a participant is not particularly noteworthy since it is often an expected outcome in a distributed system).", "author": "mmusgrov", "createdAt": "2020-10-14T14:18:59Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -718,8 +745,14 @@ boolean forget() {\n                     forgetURI, e.getMessage());\n                 // TODO write a test to ensure that recovery only retries the forget request\n                 return false; // force recovery to keep retrying\n+            } catch (Exception e) {\n+                LRALogger.logger.infof(\"LRARecord.forget at '%s' could not reach participant: %s\",", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4NDk1Ng==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r505484956", "bodyText": "ok", "author": "xstefank", "createdAt": "2020-10-15T12:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNjIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxODUwNA==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504718504", "bodyText": "I like it, good find :-)", "author": "mmusgrov", "createdAt": "2020-10-14T14:21:58Z", "path": "rts/lra/lra-coordinator-thorntail/src/main/java/ForkJoinClassLoading.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2020, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+import org.jboss.logging.Logger;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Initialized;\n+import javax.enterprise.event.Observes;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Originally copied from https://github.com/quarkusio/quarkus/blob/1.8.1.Final/core/deployment/src/main/java/io/quarkus/runner/bootstrap/ForkJoinClassLoading.java\n+ */\n+@ApplicationScoped\n+public class ForkJoinClassLoading {", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMzEyNg==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504723126", "bodyText": "Failure to find a resource in a distributed system is not an error (in fact it is a common occurrence).", "author": "mmusgrov", "createdAt": "2020-10-14T14:27:40Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +239,34 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)\n+                LRALogger.i18NLogger.error_parentLRANotFound(parentLRAUrl);", "originalCommit": "f16dde974e7dda093485c55721af40b4a7b8688d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg1NDg2Ng==", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504854866", "bodyText": "But I do notice that if the LRA cannot be registered with the parent then we should be closing the one that was just started on the previous line. I will raise an issue to get that fixed.", "author": "mmusgrov", "createdAt": "2020-10-14T17:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMzEyNg=="}], "type": "inlineReview"}, {"oid": "a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "url": "https://github.com/jbosstm/narayana/commit/a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "message": "Replace Apache HttpClient with JAX-RS client in LRA modules", "committedDate": "2020-10-15T12:18:05Z", "type": "forcePushed"}, {"oid": "f199e5388b7d4c9977038d322d773eb1bf8f0954", "url": "https://github.com/jbosstm/narayana/commit/f199e5388b7d4c9977038d322d773eb1bf8f0954", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA", "committedDate": "2020-10-15T12:20:25Z", "type": "forcePushed"}, {"oid": "fce240983b02982cdc3c52325f118def71b7b7db", "url": "https://github.com/jbosstm/narayana/commit/fce240983b02982cdc3c52325f118def71b7b7db", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA", "committedDate": "2020-10-15T12:37:43Z", "type": "forcePushed"}, {"oid": "4fa4ce2db63d134ac88fc28a70853650497fe20d", "url": "https://github.com/jbosstm/narayana/commit/4fa4ce2db63d134ac88fc28a70853650497fe20d", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA", "committedDate": "2020-10-15T12:44:31Z", "type": "forcePushed"}, {"oid": "dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "url": "https://github.com/jbosstm/narayana/commit/dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA", "committedDate": "2020-10-16T09:33:58Z", "type": "commit"}, {"oid": "dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "url": "https://github.com/jbosstm/narayana/commit/dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA", "committedDate": "2020-10-16T09:33:58Z", "type": "forcePushed"}]}