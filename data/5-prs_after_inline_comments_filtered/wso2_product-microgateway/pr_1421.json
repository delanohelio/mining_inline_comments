{"pr_number": 1421, "pr_title": "Add caching capability for JWT Token validation.", "pr_createdAt": "2020-09-25T13:00:44Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1421", "timeline": [{"oid": "fab5b7abf2825f241f70911f703087425b529a44", "url": "https://github.com/wso2/product-microgateway/commit/fab5b7abf2825f241f70911f703087425b529a44", "message": "Add token caching", "committedDate": "2020-09-25T12:51:13Z", "type": "commit"}, {"oid": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "url": "https://github.com/wso2/product-microgateway/commit/542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "message": "Correct formatting issues", "committedDate": "2020-09-25T12:54:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA3NDE2MQ==", "url": "https://github.com/wso2/product-microgateway/pull/1421#discussion_r495074161", "bodyText": "Lets read this from environment variable, so we can run perf without code changes for cache enable and disable cases", "author": "Rajith90", "createdAt": "2020-09-25T15:42:51Z", "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -33,14 +33,43 @@\n import java.util.Base64;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n import com.nimbusds.jose.JOSEException;\n import com.nimbusds.jose.JWSHeader;\n import com.nimbusds.jwt.JWTClaimsSet;\n import com.nimbusds.jwt.JWTParser;\n import com.nimbusds.jwt.SignedJWT;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n \n public class JWTValidator{\n     private static RSAPublicKey publicKey = readPublicKey();\n+    private static JWSVerifier jwsVerifier = new RSASSAVerifier(publicKey);\n+    private static boolean enableCache = true;", "originalCommit": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA3NDcxNA==", "url": "https://github.com/wso2/product-microgateway/pull/1421#discussion_r495074714", "bodyText": "Lets remove the logs(sout), in order to run the perf tests. Check other places as well", "author": "Rajith90", "createdAt": "2020-09-25T15:43:51Z", "path": "java-filter-chain/src/main/java/org/wso2/mgw/filterchain/JWTValidator/JWTValidator.java", "diffHunk": "@@ -81,11 +110,38 @@ public static boolean validateSignature(String jwtToken, String signature){\n         JWTClaimsSet payload = null;\n         SignedJWT parsedJWTToken;\n         boolean isVerified = false;\n-        try{\n-            parsedJWTToken = (SignedJWT) JWTParser.parse(jwtToken);\n-            isVerified = verifyTokenSignature(parsedJWTToken);\n-        }catch (ParseException e) {\n-            System.out.println(\"Invalid JWT token. Failed to decode the token.\");\n+        try {\n+            if (enableCache) {\n+                if(GatewayApiKeyCache.get(signature) != JWTConstants.UNAVAILABLE){\n+                    System.out.println(\"Api Key retrieved from the Api Key cache.\");", "originalCommit": "542c3c214b761e8cc2c3c4d0f2fc75ebc00db865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5088d76a9b98edc9402375345efb70c881c43556", "url": "https://github.com/wso2/product-microgateway/commit/5088d76a9b98edc9402375345efb70c881c43556", "message": "Add changes to read a variable from environment variable", "committedDate": "2020-09-28T05:57:52Z", "type": "commit"}]}