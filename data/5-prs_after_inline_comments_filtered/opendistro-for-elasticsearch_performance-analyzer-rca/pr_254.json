{"pr_number": 254, "pr_title": "Add required mutual auth to gRPC Server/Client", "pr_createdAt": "2020-06-23T00:12:12Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MTE1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r445751157", "bodyText": "This is awesome. Thanks for adding UTs around it", "author": "yojs", "createdAt": "2020-06-25T18:21:06Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.net;", "originalCommit": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc5NTk1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r446795956", "bodyText": "Let's not force this on our customers to use the same cert as both server and client certs. They can have different certs for client and server authentication, so lets make this configurable.", "author": "ktkrg", "createdAt": "2020-06-29T06:20:33Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -145,12 +149,14 @@ private ManagedChannel buildInsecureChannel(final String remoteHost) {\n \n   private ManagedChannel buildSecureChannel(final String remoteHost) {\n     try {\n+      File certFile = CertificateUtils.getCertificateFile();\n+      File pkeyFile = CertificateUtils.getPrivateKeyFile();\n       return NettyChannelBuilder.forAddress(remoteHost, Util.RPC_PORT)\n                                 .sslContext(\n                                     GrpcSslContexts.forClient()\n-                                                   .trustManager(\n-                                                       InsecureTrustManagerFactory.INSTANCE)\n-                                                   .build())\n+                                            .trustManager(InsecureTrustManagerFactory.INSTANCE)\n+                                            .keyManager(certFile, pkeyFile)", "originalCommit": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzk0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r448523941", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-07-01T17:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc5NTk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyNDk3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r446824976", "bodyText": "Are you sure you tested this change? We don't want to stop the server, it'll kill perftop and the ability to query metrics as well. If you want to change the behavior, I'd suggest we create a new issue and address this the right way in a new PR.\nFor the short term, you can consider renaming the method to removeRcaHandlers() or something like that.", "author": "ktkrg", "createdAt": "2020-06-29T07:28:48Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -234,5 +246,14 @@ public void stop() {\n     // Remove handlers.\n     sendDataHandler = null;\n     subscribeHandler = null;\n+\n+    if (server != null) {\n+      server.shutdown();\n+      try {\n+        server.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {\n+        server.shutdownNow();\n+      }\n+    }", "originalCommit": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNDgxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r448524818", "bodyText": "This is inside the stop method. I'm surprised that the stop method doesn't actually stop the server. Just in case we're relying on stop not to stop the server, I've removed the logic from stop() and added a shutdown() method which actually shuts everything down.", "author": "sidheart", "createdAt": "2020-07-01T17:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyNDk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYwODgxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454608817", "bodyText": "nit: whitespace off by one.", "author": "ktkrg", "createdAt": "2020-07-14T19:59:07Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -140,26 +171,26 @@ private ManagedChannel buildChannelForHost(final String remoteHost) {\n   }\n \n   private ManagedChannel buildInsecureChannel(final String remoteHost) {\n-    return ManagedChannelBuilder.forAddress(remoteHost, Util.RPC_PORT).usePlaintext().build();\n+    return ManagedChannelBuilder.forAddress(remoteHost, this.port).usePlaintext().build();\n   }\n \n-  private ManagedChannel buildSecureChannel(final String remoteHost) {\n-    try {\n-      return NettyChannelBuilder.forAddress(remoteHost, Util.RPC_PORT)\n-                                .sslContext(\n-                                    GrpcSslContexts.forClient()\n-                                                   .trustManager(\n-                                                       InsecureTrustManagerFactory.INSTANCE)\n-                                                   .build())\n-                                .build();\n-    } catch (SSLException e) {\n-      LOG.error(\"Unable to build an SSL gRPC client. Exception: {}\", e.getMessage());\n-      e.printStackTrace();\n-\n-      // Wrap the SSL Exception in a generic RTE and re-throw.\n-      throw new RuntimeException(e);\n-    }\n-  }\n+   private ManagedChannel buildSecureChannel(final String remoteHost) {\n+     try {\n+       SslContextBuilder sslContextBuilder = GrpcSslContexts.forClient().keyManager(certFile, pkeyFile);\n+       if (trustedCasFile != null) {\n+         sslContextBuilder.trustManager(trustedCasFile);\n+       }\n+       return NettyChannelBuilder.forAddress(remoteHost, this.port)\n+               .sslContext(sslContextBuilder.build())\n+               .build();\n+     } catch (SSLException e) {\n+       LOG.error(\"Unable to build an SSL gRPC client. Exception: {}\", e.getMessage());\n+       e.printStackTrace();\n+\n+       // Wrap the SSL Exception in a generic RTE and re-throw.\n+       throw new RuntimeException(e);\n+     }\n+   }", "originalCommit": "4b13b629f440275c9eb01562ba41decebb01404b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNjIwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454626204", "bodyText": "Fixed", "author": "sidheart", "createdAt": "2020-07-14T20:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYwODgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxNDYyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454614621", "bodyText": "You need to propagate the interrupted status when catching an InterruptedException by calling Thread.currentThread().interrupt() after channel.shutdownNow();", "author": "ktkrg", "createdAt": "2020-07-14T20:10:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -177,7 +208,15 @@ private void removeAllStubs() {\n   private void terminateAllConnections() {\n     for (Map.Entry<String, AtomicReference<ManagedChannel>> entry : perHostChannelMap.entrySet()) {\n       LOG.debug(\"shutting down connection to host: {}\", entry.getKey());\n-      entry.getValue().get().shutdownNow();\n+      ManagedChannel channel = entry.getValue().get();\n+      channel.shutdownNow();\n+      try {\n+        channel.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {", "originalCommit": "4b13b629f440275c9eb01562ba41decebb01404b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNjI2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454626262", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-07-14T20:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxNDYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTc2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454619765", "bodyText": "Same comment as above. You need to propagate the interrupted status by calling Thread.currentThread().interrupt();", "author": "ktkrg", "createdAt": "2020-07-14T20:20:18Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -235,4 +254,17 @@ public void stop() {\n     sendDataHandler = null;\n     subscribeHandler = null;\n   }\n+\n+  public void shutdown() {\n+    stop();\n+    // Actually stop the server\n+    if (server != null) {\n+      server.shutdown();\n+      try {\n+        server.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {\n+        server.shutdownNow();", "originalCommit": "4b13b629f440275c9eb01562ba41decebb01404b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNjQ4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454626482", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-07-14T20:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTc2NQ=="}], "type": "inlineReview"}, {"oid": "784dce09527833f70be14466d8f61f0472bb8b81", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/784dce09527833f70be14466d8f61f0472bb8b81", "message": "Add required mutual auth to gRPC Server/Client\n\nPreviously we had 1 sided TLS on the server side. Data between the\nclient and server was send over an encrypted channel, but any client\ncould make requests to the server.\n\nThis commit changes the behavior so that only clients with the matching\ncertificates can make requests to the server when TLS is enabled. This\ncommit does NOT add support for installing a trust manager. That must be\nadded in the future.", "committedDate": "2020-07-14T20:27:54Z", "type": "commit"}, {"oid": "c0313e315b586e4cf6f1eee64b53841282221bd6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c0313e315b586e4cf6f1eee64b53841282221bd6", "message": "Add full mutual auth to gRPC client/server and augment tests", "committedDate": "2020-07-14T20:27:54Z", "type": "commit"}, {"oid": "73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "message": "Address PR comments", "committedDate": "2020-07-14T20:29:39Z", "type": "commit"}, {"oid": "73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "message": "Address PR comments", "committedDate": "2020-07-14T20:29:39Z", "type": "forcePushed"}, {"oid": "710e229eb49029e602ea2295f1140d362983352f", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/710e229eb49029e602ea2295f1140d362983352f", "message": "Make GRPCTest work with a testing port", "committedDate": "2020-07-14T20:39:01Z", "type": "commit"}, {"oid": "87e18e3c30fb1b1e3768a804a5f6f6cf13c83305", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/87e18e3c30fb1b1e3768a804a5f6f6cf13c83305", "message": "Increase nonTLSGetMetricsFails() timeout", "committedDate": "2020-07-14T20:49:10Z", "type": "commit"}]}