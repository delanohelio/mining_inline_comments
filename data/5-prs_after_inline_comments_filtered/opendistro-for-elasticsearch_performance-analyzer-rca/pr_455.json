{"pr_number": 455, "pr_title": "Adding the Support of Retrieving Actions Persisted via an API", "pr_createdAt": "2020-10-06T02:44:43Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455", "timeline": [{"oid": "3c73550649845dc365e6bf2f4e673fe4a6c093e8", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3c73550649845dc365e6bf2f4e673fe4a6c093e8", "message": "Adding the Support of Retrieving Actions Persisted via an API", "committedDate": "2020-10-06T18:19:12Z", "type": "commit"}, {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "message": "Fixing SpotBugs Errors", "committedDate": "2020-10-06T18:19:12Z", "type": "commit"}, {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "message": "Fixing SpotBugs Errors", "committedDate": "2020-10-06T18:19:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4NjA0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r500586044", "bodyText": "This exchange.close() should be outside the else {} so that we close the object for all requests. Please change this for QueryRcaRequestHandler as well.", "author": "vigyasharma", "createdAt": "2020-10-06T20:47:49Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+            exchange.close();", "originalCommit": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3NzI2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r501377268", "bodyText": "done", "author": "aditjind", "createdAt": "2020-10-08T00:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4NjA0NA=="}], "type": "inlineReview"}, {"oid": "f5d4f81b3acf9088ee0f49361caea1e5bd622370", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f5d4f81b3acf9088ee0f49361caea1e5bd622370", "message": "Adding the Support for Action Set to have same Time Stamp and retrieve support for the latest time stamp", "committedDate": "2020-10-08T00:00:31Z", "type": "commit"}, {"oid": "17b3c2545292b4926a088e1a2f0a518528146566", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/17b3c2545292b4926a088e1a2f0a518528146566", "message": "Fixing CheckStyle Errors", "committedDate": "2020-10-08T00:03:58Z", "type": "commit"}, {"oid": "aa15808f318e731ccd209843f72fc496e92839db", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/aa15808f318e731ccd209843f72fc496e92839db", "message": "Addressing Checkstyle Errors", "committedDate": "2020-10-08T00:07:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NTI3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r501395276", "bodyText": "Should we change the name as readLast or latest or something indicating as such ?", "author": "yojs", "createdAt": "2020-10-08T01:15:00Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/Persistable.java", "diffHunk": "@@ -67,6 +67,22 @@\n   <T> @Nullable T read(Class<T> clz)\n       throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException;\n \n+\n+  /**\n+   * This API reads all the rows from the table for the latest timestamp corresponding to the Object.\n+   * @param clz The Class whose Object is desired.\n+   * @param <T> The generic type of the class\n+   * @return An instantiated Object of the class with the fields populated with the data from the latest row in the table and other\n+   *     referenced tables or null if the table does not exist yet.\n+   * @throws NoSuchMethodException If the expected setter does not exist.\n+   * @throws IllegalAccessException If the setter is not Public\n+   * @throws InvocationTargetException If invoking the setter by reflection threw an exception.\n+   * @throws InstantiationException Creating an Object of the class failed for some reason.\n+   * @throws DataAccessException Thrown by the DB layer.\n+   */\n+  <T> @Nullable List<T> readForTimestamp(Class<T> clz)", "originalCommit": "aa15808f318e731ccd209843f72fc496e92839db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MDcyMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r501990722", "bodyText": "Changed it to readLatestGroup", "author": "aditjind", "createdAt": "2020-10-08T20:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NTI3Ng=="}], "type": "inlineReview"}, {"oid": "b878968bd6113c8f8a771e14cdcfb79539340292", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b878968bd6113c8f8a771e14cdcfb79539340292", "message": "Renaming Variables", "committedDate": "2020-10-08T20:23:18Z", "type": "commit"}, {"oid": "ce1d532877ad5590c2b2b1ad8c41f075863f94ea", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ce1d532877ad5590c2b2b1ad8c41f075863f94ea", "message": "Added WaitFor() in UTs", "committedDate": "2020-10-08T20:41:08Z", "type": "commit"}, {"oid": "e6e757b70b99ad64705955d451a7d9327cd2acc5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e6e757b70b99ad64705955d451a7d9327cd2acc5", "message": "Fixing CheckStyle", "committedDate": "2020-10-08T20:44:59Z", "type": "commit"}, {"oid": "0f727dcddbbc895ceb20977e2a81775c90a1ad02", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0f727dcddbbc895ceb20977e2a81775c90a1ad02", "message": "Fix UT", "committedDate": "2020-10-08T23:44:53Z", "type": "commit"}, {"oid": "9b28671d7eb9f62de6cd934dd9a60dc085c0fcfd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9b28671d7eb9f62de6cd934dd9a60dc085c0fcfd", "message": "Adding UTs", "committedDate": "2020-10-09T02:47:29Z", "type": "commit"}, {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d062b112b1e976dc872b385f5a43a78b20539e47", "message": "Fixing CheckStyle", "committedDate": "2020-10-09T02:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3Njc3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502676773", "bodyText": "Can you create an issue to add this new URL to the readme with some documentation ?", "author": "yojs", "createdAt": "2020-10-09T21:21:44Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/core/Util.java", "diffHunk": "@@ -27,6 +27,7 @@\n   private static final Logger LOG = LogManager.getLogger(Util.class);\n   public static final String METRICS_QUERY_URL = \"/_opendistro/_performanceanalyzer/metrics\";\n   public static final String RCA_QUERY_URL = \"/_opendistro/_performanceanalyzer/rca\";\n+  public static final String ACTIONS_QUERY_URL = \"/_opendistro/_performanceanalyzer/actions\";", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0Nzc0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502747741", "bodyText": "Added the Documentation.", "author": "aditjind", "createdAt": "2020-10-10T05:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3Njc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3ODUyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502678525", "bodyText": "I am thinking if we should just keep it simple and join them with comma as delimiter ?", "author": "yojs", "createdAt": "2020-10-09T21:26:46Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -41,33 +42,35 @@ public PublisherEventsPersistor(final Persistable persistable) {\n         this.persistable = persistable;\n     }\n \n-    public void persistAction(final Action action) {\n+    public void persistAction(final List<Action> actionsPublished) {\n         long timestamp = Instant.now().toEpochMilli();\n-        LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n-        PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n-                RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n-        if (action.impactedNodes() != null) {\n-            final String nodeIds = action.impactedNodes().stream()\n-                                           .map(n -> n.getNodeId().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final String nodeIps = action.impactedNodes().stream()\n-                                           .map(n -> n.getHostAddress().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final PersistedAction actionsSummary = new PersistedAction();\n-            actionsSummary.setActionName(action.name());\n-            actionsSummary.setNodeIds(nodeIds);\n-            actionsSummary.setNodeIps(nodeIps);\n-            actionsSummary.setActionable(action.isActionable());\n-            actionsSummary.setCoolOffPeriod(action.coolOffPeriodInMillis());\n-            actionsSummary.setMuted(action.isMuted());\n-            actionsSummary.setSummary(action.summary());\n-            actionsSummary.setTimestamp(timestamp);\n-            try {\n-                persistable.write(actionsSummary);\n-            } catch (Exception e) {\n-                LOG.error(\"Unable to write publisher events to sqlite\", e);\n-                PerformanceAnalyzerApp.ERRORS_AND_EXCEPTIONS_AGGREGATOR.updateStat(\n-                        ExceptionsAndErrors.EXCEPTION_IN_PERSIST, action.name(), 1);\n+        for (Action action : actionsPublished) {\n+            LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n+            PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n+                    RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n+            if (action.impactedNodes() != null) {\n+                final String nodeIds = action.impactedNodes().stream()\n+                        .map(n -> n.getNodeId().toString())\n+                        .collect(Collectors.joining(\",\", \"{\", \"}\"));", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0Nzc2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502747768", "bodyText": "Done", "author": "aditjind", "createdAt": "2020-10-10T05:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3ODUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDAwMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502680003", "bodyText": "Should we call it action group ?", "author": "yojs", "createdAt": "2020-10-09T21:30:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MDIxMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502690210", "bodyText": "This API seems generic and not specific to actions. we could call it readLatestEntrySet ?", "author": "vigyasharma", "createdAt": "2020-10-09T22:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NzgwMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502747800", "bodyText": "Renamed it to readAllForMaxField; timeStamp in our case.", "author": "aditjind", "createdAt": "2020-10-10T05:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDg0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502680846", "bodyText": "There is no order by desc clause. Can you explain how the sorting is happening ?", "author": "yojs", "createdAt": "2020-10-09T21:33:20Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+          throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n+    String tableName = getTableNameFromClassName(clz);\n+    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n+    List<Record> maxTimeStampRecordList;\n+\n+    try {\n+      // Fetch the latest rows with the last timestamp.\n+      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MTUyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502691529", "bodyText": "+1, i didn't understand how this query is working - why is it doing a group by on actionName? where/how did it pick the latest TS value?\ncan you (for our understanding) provide the SQL counterpart for this query?", "author": "vigyasharma", "createdAt": "2020-10-09T22:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NzgyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502747825", "bodyText": "Thanks folks. This query addition is a part of testing failure on multiple fronts.\nThere was a bug in UT which was not catching this. I was clearing the action set before adding the values to the table. The docker testing was also not catching this bug as while adding mock values I was adding the same set of actions with different timestamps. Therefore while grouping on actions it was returning the only set of the actions which happened to be the set for the last time stamp as well. It failed when I added a partial overlapping action set actions for different timestamps.\nModified the UT and updated the mock in the docker testing as well.", "author": "aditjind", "createdAt": "2020-10-10T05:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MTYzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502681633", "bodyText": "Is this still a todo ? We are taking care of it at persistence layer, right ?", "author": "yojs", "createdAt": "2020-10-09T21:35:38Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+        }\n+        exchange.close();\n+    }\n+\n+    private void handleActionRequest(HttpExchange exchange)\n+            throws IOException {\n+        //check if we are querying from elected master\n+        if (!validNodeRole()) {\n+            JsonObject errResponse = new JsonObject();\n+            errResponse.addProperty(\"error\", \"Node being queried is not elected master.\");\n+            sendResponse(exchange, errResponse.toString(),\n+                    HttpURLConnection.HTTP_BAD_REQUEST);\n+            return;\n+        }\n+\n+        String response = getActionData(persistable).toString();\n+        sendResponse(exchange, response, HttpURLConnection.HTTP_OK);\n+    }\n+\n+    private JsonObject getActionData(Persistable persistable) {\n+        LOG.debug(\"Action: in getActionData\");\n+        JsonObject result = new JsonObject();\n+        if (persistable != null) {\n+            try {\n+                // TODO: Read Last suggested Action Set", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0NzgzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502747835", "bodyText": "Removed.", "author": "aditjind", "createdAt": "2020-10-10T05:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MTYzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0OTkzOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502749938", "bodyText": "Thats right, removed.", "author": "aditjind", "createdAt": "2020-10-10T05:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MTYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MjE4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502692187", "bodyText": "This exchange.close() is also needed in the QueryRcaRequestHandler I think. Can you change it there as well?", "author": "vigyasharma", "createdAt": "2020-10-09T22:22:25Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+        }\n+        exchange.close();", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0OTk1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502749953", "bodyText": "Right, I have added it.", "author": "aditjind", "createdAt": "2020-10-10T05:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MjE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5NTY4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502695681", "bodyText": "Can we check that the table itself had 4 action entries at this point with 2 different sets of timestamps?", "author": "vigyasharma", "createdAt": "2020-10-09T22:35:18Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistorTest.java", "diffHunk": "@@ -47,23 +47,68 @@ public void cleanup() throws IOException {\n     }\n \n     @Test\n-    public void actionPublished() throws InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException {\n-        final MockAction mockAction = new MockAction();\n-\n-        publisherEventsPersistor.persistAction(mockAction);\n-\n-        PersistedAction actionsSummary = persistable.read(PersistedAction.class);\n+    public void actionPublished() throws Exception {\n+        final MockAction mockAction1 = new MockAction(\"MockAction1\", new ArrayList<String>() {\n+            {\n+                add(\"1\");\n+                add(\"11\");\n+            }});\n+        final MockAction mockAction2 = new MockAction(\"MockAction2\", new ArrayList<String>() {\n+            {\n+                add(\"2\");\n+                add(\"33\");\n+            }});\n+        List<Action> mockActions = new ArrayList<>();\n+        mockActions.add(mockAction1);\n+        mockActions.add(mockAction2);\n+        mockActions.clear();\n+\n+        publisherEventsPersistor.persistAction(mockActions);\n+\n+        final MockAction mockAction3 = new MockAction(\"MockAction3\",new ArrayList<String>() {\n+            {\n+                add(\"3\");\n+                add(\"33\");\n+            }});\n+        final MockAction mockAction4 = new MockAction(\"MockAction4\",new ArrayList<String>() {\n+            {\n+                add(\"4\");\n+                add(\"44\");\n+            }});\n+        mockActions.add(mockAction3);\n+        mockActions.add(mockAction4);\n+\n+        publisherEventsPersistor.persistAction(mockActions);\n+\n+        WaitFor.waitFor(() -> persistable.readLatestGroup(PersistedAction.class).size() == 2, 5,\n+                TimeUnit.SECONDS);\n+        List<PersistedAction> actionsSummary = persistable.readLatestGroup(PersistedAction.class);\n         Assert.assertNotNull(actionsSummary);\n-        Assert.assertEquals(actionsSummary.getActionName(), mockAction.name());\n-        Assert.assertEquals(actionsSummary.getNodeIds(), \"{1,2}\");\n-        Assert.assertEquals(actionsSummary.getNodeIps(), \"{1.1.1.1,2.2.2.2}\");\n-        Assert.assertEquals(actionsSummary.isActionable(), mockAction.isActionable());\n-        Assert.assertEquals(actionsSummary.getCoolOffPeriod(), mockAction.coolOffPeriodInMillis());\n-        Assert.assertEquals(actionsSummary.isMuted(), mockAction.isMuted());\n-        Assert.assertEquals(actionsSummary.getSummary(), mockAction.summary());\n+        Assert.assertEquals(actionsSummary.size(), 2);", "originalCommit": "d062b112b1e976dc872b385f5a43a78b20539e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0ODUyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502748521", "bodyText": "Thats right, Vigya, the bug in the UT was I was clearing the actionSummary before it was writing in the table. Updated the UT.", "author": "aditjind", "createdAt": "2020-10-10T05:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5NTY4MQ=="}], "type": "inlineReview"}, {"oid": "1e65336f6f2ac242aa4784867c159f9291b7b2a8", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1e65336f6f2ac242aa4784867c159f9291b7b2a8", "message": "Addressing CR Comments", "committedDate": "2020-10-10T05:14:49Z", "type": "commit"}, {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f09657b2794ffbb6e33843a2ccc05b384fba80e0", "message": "Making API Generic", "committedDate": "2020-10-10T05:54:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NjU3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502996570", "bodyText": "Since you are trying to keep this fn generic (not specific to latest timestamp), this variable should also not be timestamp specific. Maybe something on the lines of recordsWithMaxFieldValue", "author": "vigyasharma", "createdAt": "2020-10-12T01:28:11Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -263,15 +265,15 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n   }\n \n   @Override\n-  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+  public synchronized <T, E> @org.checkerframework.checker.nullness.qual.Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)\n           throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n     String tableName = getTableNameFromClassName(clz);\n-    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n     List<Record> maxTimeStampRecordList;\n \n     try {\n       // Fetch the latest rows with the last timestamp.\n-      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();\n+      maxTimeStampRecordList = create.select().from(tableName).where(DSL.field(field)", "originalCommit": "f09657b2794ffbb6e33843a2ccc05b384fba80e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5OTI3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502999270", "bodyText": "We should also test the generality by adding a UT for some other (non-timestamp) field and checking that we get all fields with max value.\nFWIW, I think it's also ok to make this function only timestamp specific and get all records with the latest timestamp value instead of a generic max-field value.", "author": "vigyasharma", "createdAt": "2020-10-12T01:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NjU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU1Mzg4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r503553883", "bodyText": "Made the API generic to address future use-cases whatsoever. Added the UTs as well.", "author": "aditjind", "createdAt": "2020-10-12T21:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5ODI4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502998287", "bodyText": "For the sake of testing sql query correctness, can we also add some out of order actions, i.e. publish another set of actions with an older timestamp after this one. We don't expect the publisher code to do that right now, but since these are unit tests, it will validate the sql query against any unexpected future changes.", "author": "vigyasharma", "createdAt": "2020-10-12T01:38:15Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistorTest.java", "diffHunk": "@@ -78,20 +78,23 @@ public void actionPublished() throws Exception {\n         mockActions.add(mockAction3);\n         mockActions.add(mockAction4);\n \n-        publisherEventsPersistor.persistAction(mockActions);\n+        publisherEventsPersistor.persistAction(mockActions, 987654321);", "originalCommit": "f09657b2794ffbb6e33843a2ccc05b384fba80e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU1MzU3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r503553576", "bodyText": "Added UTs where we have entries with earlier timestamp with an increasing ID. Added the UTs to test the SQL query against a field other than the timestamp.", "author": "aditjind", "createdAt": "2020-10-12T21:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5ODI4Nw=="}], "type": "inlineReview"}, {"oid": "f4b2a9cda152cf3d46edba658c99d172f78ef58d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f4b2a9cda152cf3d46edba658c99d172f78ef58d", "message": "Adding UTs for generic API", "committedDate": "2020-10-12T21:49:11Z", "type": "commit"}, {"oid": "9322b2ed5db31cb76a7cb0e731b7a4f37858b333", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9322b2ed5db31cb76a7cb0e731b7a4f37858b333", "message": "CheckStyle Errors", "committedDate": "2020-10-12T21:58:43Z", "type": "commit"}, {"oid": "795e598b735b1005b0ec7a588be11a40ed91b52c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/795e598b735b1005b0ec7a588be11a40ed91b52c", "message": "Modified UTs", "committedDate": "2020-10-12T22:35:06Z", "type": "commit"}, {"oid": "a8465c9b9993e83512ecdb4674e63404f1316390", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a8465c9b9993e83512ecdb4674e63404f1316390", "message": "Modifying API DOC", "committedDate": "2020-10-12T22:42:21Z", "type": "commit"}, {"oid": "b18425c19b8ff91bb742a85905212fadbd9cc80a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b18425c19b8ff91bb742a85905212fadbd9cc80a", "message": "API Doc", "committedDate": "2020-10-12T22:45:34Z", "type": "commit"}, {"oid": "2b7f1e3d84c6d6460293ade9ad147f27c756601b", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2b7f1e3d84c6d6460293ade9ad147f27c756601b", "message": "Removing Changes from README", "committedDate": "2020-10-13T01:01:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjE5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504286192", "bodyText": "I don't have a strong opinion either way - i think the old format was also ok.\nBut this format is expected by multiple integ tests. Are they passing with your changes? Please confirm and update any breaking ITs.", "author": "vigyasharma", "createdAt": "2020-10-13T22:07:18Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -41,33 +41,34 @@ public PublisherEventsPersistor(final Persistable persistable) {\n         this.persistable = persistable;\n     }\n \n-    public void persistAction(final Action action) {\n-        long timestamp = Instant.now().toEpochMilli();\n-        LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n-        PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n-                RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n-        if (action.impactedNodes() != null) {\n-            final String nodeIds = action.impactedNodes().stream()\n-                                           .map(n -> n.getNodeId().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final String nodeIps = action.impactedNodes().stream()\n-                                           .map(n -> n.getHostAddress().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));", "originalCommit": "2b7f1e3d84c6d6460293ade9ad147f27c756601b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTk4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504321984", "bodyText": "While I agree the new format might be simpler. But reverting to old format to reduce the effort of modifying ITs and push it to prod for release purposes. Updated the local build pass message in the PR description.", "author": "aditjind", "createdAt": "2020-10-13T23:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjE5Mg=="}], "type": "inlineReview"}, {"oid": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "message": "Reverting to Old Format", "committedDate": "2020-10-13T22:52:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMzgwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504323805", "bodyText": "I am unsure if we want to write an error log with full stack trace here because jooq can throw DataAccessException if a user queries for a table that does not exist.", "author": "yojs", "createdAt": "2020-10-13T23:57:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +261,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T, E> @org.checkerframework.checker.nullness.qual.Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)\n+          throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n+    String tableName = getTableNameFromClassName(clz);\n+    List<Record> recordsWithMaxFieldValue;\n+\n+    try {\n+      // Fetch the latest rows with the last timestamp.\n+      recordsWithMaxFieldValue = create.select().from(tableName).where(DSL.field(field)\n+              .eq(create.select(max(field)).from(tableName))).fetch();\n+    } catch (DataAccessException dex) {\n+      LOG.error(\"Error querying table {}\", tableName, dex);", "originalCommit": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM4NjA3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504386079", "bodyText": "I have populated the behavior of the API when the Persisted Actions table is not present in the rca.sqllite file in the PR description. We have an empty list of actions for the key LastSuggestedActionSet. I think this empty list should suffice for the purpose of this API when no table is present.", "author": "aditjind", "createdAt": "2020-10-14T03:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMzgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyNDc5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504324793", "bodyText": "This method is called from the RestHandler class. For that class to construct a Field and send it over, couples the request handler with the schema on the persistence layer, moreover with jooq, the library. Can we have them specify the name of the field and we convert the name to Field in the implementer of this method ?", "author": "yojs", "createdAt": "2020-10-14T00:00:55Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/Persistable.java", "diffHunk": "@@ -67,6 +68,22 @@\n   <T> @Nullable T read(Class<T> clz)\n       throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException;\n \n+\n+  /**\n+   * This API reads all the rows from the table corresponding to the maximum value in the field Object.\n+   * @param clz The Class whose Object is desired.\n+   * @param <T> The generic type of the class.\n+   * @param field DSL field for which the maximum value is desired.\n+   * @return A List of instantiated Objects of the class with the fields populated with the data from the corresponding rows in the table.\n+   * @throws NoSuchMethodException If the expected setter does not exist.\n+   * @throws IllegalAccessException If the setter is not Public\n+   * @throws InvocationTargetException If invoking the setter by reflection threw an exception.\n+   * @throws InstantiationException Creating an Object of the class failed for some reason.\n+   * @throws DataAccessException Thrown by the DB layer.\n+   */\n+  <T, E> @Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)", "originalCommit": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM4MjEyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504382121", "bodyText": "I have separated the Handler and the persistence layer and removed the dependency of Jooq from the Request Handler.", "author": "aditjind", "createdAt": "2020-10-14T03:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyNDc5Mw=="}], "type": "inlineReview"}, {"oid": "2adc61df133c3382310edbeda6298d12588b5a76", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2adc61df133c3382310edbeda6298d12588b5a76", "message": "Separating the Request Handler layer and the persistance layer", "committedDate": "2020-10-14T03:11:33Z", "type": "commit"}, {"oid": "98093587038a62290e53c1a6cae55aaeaf6e2378", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/98093587038a62290e53c1a6cae55aaeaf6e2378", "message": "CheckStyle Again", "committedDate": "2020-10-14T03:33:43Z", "type": "commit"}]}