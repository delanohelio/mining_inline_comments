{"pr_number": 389, "pr_title": "Use absolute path for configFilePath", "pr_createdAt": "2020-08-20T02:25:02Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/389", "timeline": [{"oid": "1425cb3680f487713fe3a02c3aa03a9cc1b7e873", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1425cb3680f487713fe3a02c3aa03a9cc1b7e873", "message": "Use absolute path for configFilePath", "committedDate": "2020-08-20T00:35:54Z", "type": "commit"}, {"oid": "6f20fd778a53626f6436eebf801a50641f67f2af", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6f20fd778a53626f6436eebf801a50641f67f2af", "message": "Disable pa with invalid config", "committedDate": "2020-08-20T02:21:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY1NDEzOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/389#discussion_r473654138", "bodyText": "Does the process also exit with error at this point or is it just stalled? We should exit with error.", "author": "vigyasharma", "createdAt": "2020-08-20T06:39:55Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerApp.java", "diffHunk": "@@ -107,21 +107,26 @@ public static void main(String[] args) {\n         (MetricsConfiguration.CONFIG_MAP.get(StatsCollector.class).samplingInterval) / 2,\n         TimeUnit.MILLISECONDS);\n     PluginSettings settings = PluginSettings.instance();\n-    StatsCollector.STATS_TYPE = \"agent-stats-metadata\";\n-    METRIC_COLLECTOR_EXECUTOR.addScheduledMetricCollector(StatsCollector.instance());\n-    StatsCollector.instance().addDefaultExceptionCode(StatExceptionCode.READER_RESTART_PROCESSING);\n-    METRIC_COLLECTOR_EXECUTOR.setEnabled(true);\n-    METRIC_COLLECTOR_EXECUTOR.start();\n-\n-    final GRPCConnectionManager connectionManager = new GRPCConnectionManager(\n-        settings.getHttpsEnabled());\n-    final ClientServers clientServers = createClientServers(connectionManager, appContext);\n-    startErrorHandlingThread(THREAD_PROVIDER, exceptionQueue);\n-\n-    startReaderThread(appContext, THREAD_PROVIDER);\n-    startGrpcServerThread(clientServers.getNetServer(), THREAD_PROVIDER);\n-    startWebServerThread(clientServers.getHttpServer(), THREAD_PROVIDER);\n-    startRcaTopLevelThread(clientServers, connectionManager, appContext, THREAD_PROVIDER);\n+    if (ConfigStatus.INSTANCE.haveValidConfig()) {\n+      StatsCollector.STATS_TYPE = \"agent-stats-metadata\";\n+      METRIC_COLLECTOR_EXECUTOR.addScheduledMetricCollector(StatsCollector.instance());\n+      StatsCollector.instance()\n+          .addDefaultExceptionCode(StatExceptionCode.READER_RESTART_PROCESSING);\n+      METRIC_COLLECTOR_EXECUTOR.setEnabled(true);\n+      METRIC_COLLECTOR_EXECUTOR.start();\n+\n+      final GRPCConnectionManager connectionManager =\n+          new GRPCConnectionManager(settings.getHttpsEnabled());\n+      final ClientServers clientServers = createClientServers(connectionManager, appContext);\n+      startErrorHandlingThread(THREAD_PROVIDER, exceptionQueue);\n+\n+      startReaderThread(appContext, THREAD_PROVIDER);\n+      startGrpcServerThread(clientServers.getNetServer(), THREAD_PROVIDER);\n+      startWebServerThread(clientServers.getHttpServer(), THREAD_PROVIDER);\n+      startRcaTopLevelThread(clientServers, connectionManager, appContext, THREAD_PROVIDER);\n+    } else {\n+      LOG.error(\"Performance analyzer app stopped due to invalid config status.\");", "originalCommit": "6f20fd778a53626f6436eebf801a50641f67f2af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1MjI0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/389#discussion_r474952243", "bodyText": "PerformanceAnalyzerApp exists with error.", "author": "sruti1312", "createdAt": "2020-08-21T20:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY1NDEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NjU3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/389#discussion_r474146574", "bodyText": "Move lines 105-108 into it if (ConfigStatus...) block so that we don't start any threads if we don't have a valid config. Can you also return -1 or some error code in that case and verify that the program exits when the config is invalid?\nYou should be able to do this with a simple test that executes PerformanceAnalyzerApp.main(...) and checks that the return code is the error code.", "author": "sidheart", "createdAt": "2020-08-20T17:13:28Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerApp.java", "diffHunk": "@@ -107,21 +107,26 @@ public static void main(String[] args) {\n         (MetricsConfiguration.CONFIG_MAP.get(StatsCollector.class).samplingInterval) / 2,\n         TimeUnit.MILLISECONDS);", "originalCommit": "6f20fd778a53626f6436eebf801a50641f67f2af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MDI2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/389#discussion_r474970266", "bodyText": "Right, added a simple test to cover this. Also moved lines inside the if (thanks!)", "author": "sruti1312", "createdAt": "2020-08-21T21:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NjU3NA=="}], "type": "inlineReview"}, {"oid": "46ed2ee68bb070c90910bf5ff44df804c41adc2a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/46ed2ee68bb070c90910bf5ff44df804c41adc2a", "message": "Address PR comments", "committedDate": "2020-08-21T20:59:33Z", "type": "commit"}, {"oid": "234c7b58f8e065573c8966c78337b0cea494491c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/234c7b58f8e065573c8966c78337b0cea494491c", "message": "Log to StatsCollector", "committedDate": "2020-08-21T21:04:38Z", "type": "commit"}]}