{"pr_number": 436, "pr_title": "Publish Shard State Metrics", "pr_createdAt": "2020-09-25T06:21:31Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436", "timeline": [{"oid": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b67a6b49949d64c82c80e92b4f5487a626e7290d", "message": "Publish Shard State Metrics", "committedDate": "2020-09-25T06:13:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMzU3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495123574", "bodyText": "Because the writer only emits the node local metrics, the node name is implicit. This is the reason we don't have it here. When we gather the metrics from all the nodes, it can be added. Because it is the same for all the metrics, we don't want to store it as it will save us bytes on the disk (as not having the SQLIte column) and bytes on the heap when we read the table into memory.", "author": "yojs", "createdAt": "2020-09-25T17:11:40Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metrics/AllMetrics.java", "diffHunk": "@@ -1100,4 +1100,50 @@ public String toString() {\n       public static final String PACKET_PER_SEC_VALUE = \"packets/s\";\n     }\n   }\n+\n+  public enum ShardStateDimension implements MetricDimension {\n+    SHARD_ID(CommonDimension.SHARD_ID.toString()),\n+    INDEX_NAME(CommonDimension.INDEX_NAME.toString()),\n+    SHARD_TYPE(Constants.SHARD_TYPE),\n+    NODE_NAME(Constants.NODE_NAME);", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNTQ1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495125453", "bodyText": "Although we are pretty bad at it as you can see from here :) , but in case it is possible, we try to follow this convention -\n<ResourceName(capitalized camel case)>_<stat name in Capitalized camel case>. SO for example, Shard_State_Unassigned->Shard_StateUnassigned`.", "author": "yojs", "createdAt": "2020-09-25T17:15:34Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metrics/AllMetrics.java", "diffHunk": "@@ -1100,4 +1100,50 @@ public String toString() {\n       public static final String PACKET_PER_SEC_VALUE = \"packets/s\";\n     }\n   }\n+\n+  public enum ShardStateDimension implements MetricDimension {\n+    SHARD_ID(CommonDimension.SHARD_ID.toString()),\n+    INDEX_NAME(CommonDimension.INDEX_NAME.toString()),\n+    SHARD_TYPE(Constants.SHARD_TYPE),\n+    NODE_NAME(Constants.NODE_NAME);\n+\n+    private final String value;\n+\n+    ShardStateDimension(String value) {\n+      this.value = value;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return value;\n+    }\n+\n+    public static class Constants {\n+      public static final String NODE_NAME = \"NodeName\";\n+      public static final String SHARD_TYPE = \"ShardType\";\n+    }\n+  }\n+\n+  public enum ShardStateValue implements MetricValue {\n+    SHARD_STATE_UNASSIGNED(Constants.SHARD_STATE_UNASSIGNED),\n+    SHARD_STATE_ACTIVE(Constants.SHARD_STATE_ACTIVE),\n+    SHARD_STATE_INITIALIZING(Constants.SHARD_STATE_INITIALIZING);\n+\n+    private final String value;\n+\n+    ShardStateValue(String value) {\n+      this.value = value;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return value;\n+    }\n+\n+    public static class Constants {\n+      public static final String SHARD_STATE_UNASSIGNED = \"Shard_State_Unassigned\";\n+      public static final String SHARD_STATE_ACTIVE = \"Shard_State_Active\";\n+      public static final String SHARD_STATE_INITIALIZING = \"Shard_State_Initializing\";", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3MjMxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503672316", "bodyText": "Changed name to Shard_State", "author": "amathur1893", "createdAt": "2020-10-13T05:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNjY2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495126669", "bodyText": "It might be good to add a javadoc comment with a sample metric emitted in the writer files.", "author": "yojs", "createdAt": "2020-09-25T17:17:54Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/MetricsEmitter.java", "diffHunk": "@@ -810,4 +810,199 @@ public static void emitNodeMetrics(\n           \"Total time taken for writing {} metrics metricsdb: {}\", tableName, mFinalT - mCurrT);\n     }\n   }\n+\n+  public static void emitShardStateMetric(", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTQ2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503675461", "bodyText": "Added", "author": "amathur1893", "createdAt": "2020-10-13T05:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNjY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyOTQxOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495129419", "bodyText": "We will consume a lot of bytes on heap if we keep 4 snapshots around. Maybe 2 is good enough.", "author": "yojs", "createdAt": "2020-09-25T17:23:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -71,8 +71,10 @@\n   private NavigableMap<Long, HttpRequestMetricsSnapshot> httpRqMetricsMap;\n   private NavigableMap<Long, MasterEventMetricsSnapshot> masterEventMetricsMap;\n   private Map<AllMetrics.MetricName, NavigableMap<Long, MemoryDBSnapshot>> nodeMetricsMap;\n+  private NavigableMap<Long, ShardStateMetricsSnapshot> shardStateMetricsMap;\n   private static final int MAX_DATABASES = 2;\n   private static final int OS_SNAPSHOTS = 4;\n+  private static final int SHARD_STATE_SNAPSHOTS = 4;", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTU3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503675571", "bodyText": "Changed the value to 2", "author": "amathur1893", "createdAt": "2020-10-13T05:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyOTQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMDM4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495130389", "bodyText": "I am thinking if we can save on bytes by only accounting for unassigned and initializing shards (leaving out the active shards). What remains are the active shards and the happy case.", "author": "yojs", "createdAt": "2020-09-25T17:25:15Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/MetricsEmitter.java", "diffHunk": "@@ -810,4 +810,199 @@ public static void emitNodeMetrics(\n           \"Total time taken for writing {} metrics metricsdb: {}\", tableName, mFinalT - mCurrT);\n     }\n   }\n+\n+  public static void emitShardStateMetric(\n+          MetricsDB metricsDB, ShardStateMetricsSnapshot shardStateMetricsSnapshot) {\n+    long mCurrT = System.currentTimeMillis();\n+    Result<Record> shardStateMetrics = shardStateMetricsSnapshot.fetchAggregatedShardStateMetrics();\n+\n+    List<String> dims =\n+            new ArrayList<String>() {\n+              {\n+                this.add(AllMetrics.ShardStateDimension.INDEX_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_ID.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_TYPE.toString());\n+                this.add(AllMetrics.ShardStateDimension.NODE_NAME.toString());\n+              }\n+            };\n+\n+    emitActiveShardStateMetric(metricsDB, shardStateMetrics, dims);\n+    emitInitializingShardStateMetric(metricsDB, shardStateMetrics, dims);\n+    emitUnassignedShardStateMetric(metricsDB, shardStateMetrics, dims);\n+\n+    long mFinalT = System.currentTimeMillis();\n+    LOG.debug(\n+            \"Total time taken for writing shard state event queue metrics metricsdb: {}\", mFinalT - mCurrT);\n+  }\n+\n+  public static void emitActiveShardStateMetric(MetricsDB metricsDB, Result<Record> res, List<String> dims) {\n+    metricsDB.createMetric(", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTQxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503675414", "bodyText": "Published all shard states except Active", "author": "amathur1893", "createdAt": "2020-10-13T05:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMDM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMjY4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495132683", "bodyText": "We can add a doc comment stating how a sample line looks like, what values we are expecting and so on ?", "author": "yojs", "createdAt": "2020-09-25T17:29:40Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsProcessor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.PerformanceAnalyzerMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader_writer_shared.Event;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.NavigableMap;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.BatchBindStep;\n+\n+public class ShardStateMetricsProcessor implements EventProcessor {\n+    private static final Logger LOG = LogManager.getLogger(ShardStateMetricsProcessor.class);\n+    private ShardStateMetricsSnapshot shardStateMetricsSnapshot;\n+    private BatchBindStep handle;\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final TypeReference<HashMap<String, String>> TYPE_REF = new TypeReference<HashMap<String, String>>() {};\n+\n+    private ShardStateMetricsProcessor(ShardStateMetricsSnapshot snapshot) {\n+        this.shardStateMetricsSnapshot = snapshot;\n+    }\n+\n+    static ShardStateMetricsProcessor buildShardStateMetricEventsProcessor(\n+            long currWindowStartTime,\n+            Connection conn,\n+            NavigableMap<Long, ShardStateMetricsSnapshot> shardStateEventMetricsMap) {\n+        ShardStateMetricsSnapshot shardStateSnap = shardStateEventMetricsMap.get(currWindowStartTime);\n+        if (shardStateSnap == null) {\n+            shardStateSnap = new ShardStateMetricsSnapshot(conn, currWindowStartTime);\n+            shardStateEventMetricsMap.put(currWindowStartTime, shardStateSnap);\n+        }\n+        return new ShardStateMetricsProcessor(shardStateSnap);\n+    }\n+\n+    @Override\n+    public void initializeProcessing(long startTime, long endTime) {\n+        this.handle = shardStateMetricsSnapshot.startBatchPut();\n+    }\n+\n+    @Override\n+    public void finalizeProcessing() {\n+        if (handle.size() > 0) {\n+            handle.execute();\n+        }\n+        LOG.debug(\"Final ShardStateEvents metrics {}\", shardStateMetricsSnapshot.fetchAll());\n+    }\n+\n+    @Override\n+    public void processEvent(Event event) {\n+        String[] lines = event.value.split(System.lineSeparator());\n+        for (String line : lines) {\n+            Map<String, String> shardStateMap = extractEntryData(line);\n+            if (!shardStateMap.containsKey(PerformanceAnalyzerMetrics.METRIC_CURRENT_TIME)) {\n+                handle.bind(\n+                        shardStateMap.get(AllMetrics.ShardStateDimension.INDEX_NAME.toString()),\n+                        shardStateMap.get(AllMetrics.ShardStateDimension.SHARD_ID.toString()),\n+                        shardStateMap.get(AllMetrics.ShardStateDimension.SHARD_TYPE.toString()),\n+                        shardStateMap.get(AllMetrics.ShardStateDimension.NODE_NAME.toString()),\n+                        Integer.parseInt(shardStateMap.get(AllMetrics.ShardStateValue.SHARD_STATE_ACTIVE.toString())),\n+                        Integer.parseInt(shardStateMap.get(AllMetrics.ShardStateValue.SHARD_STATE_INITIALIZING.toString())),\n+                        Integer.parseInt(shardStateMap.get(AllMetrics.ShardStateValue.SHARD_STATE_UNASSIGNED.toString())));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean shouldProcessEvent(Event event) {\n+        return event.key.contains(PerformanceAnalyzerMetrics.sShardStatePath);\n+    }\n+\n+    @Override\n+    public void commitBatchIfRequired() {\n+        if (handle.size() > BATCH_LIMIT) {\n+            handle.execute();\n+            handle = shardStateMetricsSnapshot.startBatchPut();\n+        }\n+    }\n+\n+    static Map<String, String> extractEntryData(String line) {", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTY2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503675667", "bodyText": "Done", "author": "amathur1893", "createdAt": "2020-10-13T05:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMjY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMzM0OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495133348", "bodyText": "I am thinking, maybe we can statically load this as it is all constants ?", "author": "yojs", "createdAt": "2020-09-25T17:30:51Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsSnapshot.java", "diffHunk": "@@ -0,0 +1,286 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.DBUtils;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import java.sql.Connection;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.BatchBindStep;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.SQLDialect;\n+import org.jooq.SelectField;\n+import org.jooq.impl.DSL;\n+\n+public class ShardStateMetricsSnapshot implements Removable {\n+    private static final Logger LOG = LogManager.getLogger(ShardStateMetricsSnapshot.class);\n+    private final DSLContext create;\n+    private final String tableName;\n+    private static final Long EXPIRE_AFTER = 1200000L;\n+    private List<Field<?>> columns;\n+\n+    public ShardStateMetricsSnapshot(Connection conn, Long windowStartTime) {\n+        this.create = DSL.using(conn, SQLDialect.SQLITE);\n+        this.tableName = \"shard_state_\" + windowStartTime;\n+\n+        this.columns =\n+                new ArrayList<Field<?>>() {", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTg3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r503675878", "bodyText": "Done", "author": "amathur1893", "createdAt": "2020-10-13T05:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzNDEyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r495134127", "bodyText": "nit: new line in the end ?", "author": "yojs", "createdAt": "2020-09-25T17:32:21Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsSnapshotTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import org.jooq.BatchBindStep;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ShardStateMetricsSnapshotTest {\n+    private static final String DB_URL = \"jdbc:sqlite:\";\n+    private Connection conn;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        Class.forName(\"org.sqlite.JDBC\");\n+        System.setProperty(\"java.io.tmpdir\", \"/tmp\");\n+        conn = DriverManager.getConnection(DB_URL);\n+    }\n+\n+    @Test\n+    public void testPutMetrics() {\n+        ShardStateMetricsSnapshot shardStateMetricsSnapshot =\n+                new ShardStateMetricsSnapshot(conn, 1535065195000L);\n+        BatchBindStep handle = shardStateMetricsSnapshot.startBatchPut();\n+\n+        handle.bind(\"indexName\", \"shardId\", \"primary\",\"nodeName\", 1, 0, 0);\n+        handle.execute();\n+        Result<Record> rt = shardStateMetricsSnapshot.fetchAggregatedShardStateMetrics();\n+\n+        assertEquals(1, rt.size());\n+        Double shard_active = Double.parseDouble(rt.get(0).get(\"sum_\" + AllMetrics.ShardStateValue.SHARD_STATE_ACTIVE\n+                .toString()).toString());\n+        assertEquals(\n+                1.0, shard_active.doubleValue(),0);\n+        assertEquals(\n+                \"indexName\", rt.get(0).get(AllMetrics.ShardStateDimension.INDEX_NAME.toString()));\n+        assertEquals(\n+                \"shardId\",\n+                rt.get(0).get(AllMetrics.ShardStateDimension.SHARD_ID.toString()));\n+        assertEquals(\n+                \"primary\",\n+                rt.get(0).get(AllMetrics.ShardStateDimension.SHARD_TYPE.toString()));\n+        assertEquals(\n+                \"nodeName\",\n+                rt.get(0).get(AllMetrics.ShardStateDimension.NODE_NAME.toString()));\n+    }\n+}", "originalCommit": "b67a6b49949d64c82c80e92b4f5487a626e7290d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c136ab82123459296efd161e281c65ea0eaa169", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4c136ab82123459296efd161e281c65ea0eaa169", "message": "Publish Shard State Metrics2", "committedDate": "2020-10-13T12:13:14Z", "type": "commit"}, {"oid": "0f2821abe1f364da51c12533ec2fbf34c9ff1950", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0f2821abe1f364da51c12533ec2fbf34c9ff1950", "message": "Publish Fault Detection Metrics3", "committedDate": "2020-10-15T11:38:46Z", "type": "commit"}, {"oid": "d85ad58c6bb8dbddb94ce4c41eb79389e63e666f", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d85ad58c6bb8dbddb94ce4c41eb79389e63e666f", "message": "Resolving merge conflicts", "committedDate": "2020-10-19T19:22:31Z", "type": "commit"}, {"oid": "d59004072522d90f307aebf1bf0b4df4619b5744", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d59004072522d90f307aebf1bf0b4df4619b5744", "message": "Publish Fault Detection Metrics", "committedDate": "2020-10-19T19:42:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1NTEyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508055126", "bodyText": "can we change this to a metric ?", "author": "yojs", "createdAt": "2020-10-19T20:52:48Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collectors/PerformanceAnalyzerMetricsCollector.java", "diffHunk": "@@ -65,6 +66,7 @@ public void run() {\n           () -> StatExceptionCode.OTHER_COLLECTION_ERROR.toString());\n       StatsCollector.instance().logException(StatExceptionCode.OTHER_COLLECTION_ERROR);\n     } finally {\n+      LOG.debug(\"{} took {} time to execute\", collectorName, System.nanoTime() - startTime);", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2MDA5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508060090", "bodyText": "+1, it would be good to have a \"timetook\" metric to indicate the time taken for metric collection.", "author": "khushbr", "createdAt": "2020-10-19T21:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1NTEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNTkzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508215935", "bodyText": "Already made the change in PA PR - opendistro-for-elasticsearch/performance-analyzer#212", "author": "amathur1893", "createdAt": "2020-10-20T05:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1NTEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2MjEzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508062133", "bodyText": "Can we add some documentation here? For example CacheConfigDimension :\n  /*\n   * column names of Cache_MaxSize table\n   * cache type | sum | avg | max | min |\n   *\n   * <p>Example:\n   * Field Data Cache|26214400.0|26214400.0|26214400.0|26214400.0\n   * Shard Request Cache|80181985.0|80181985.0|80181985.0|80181985.0\n   */", "author": "khushbr", "createdAt": "2020-10-19T21:06:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metrics/AllMetrics.java", "diffHunk": "@@ -1154,6 +1154,50 @@ public String toString() {\n     }\n   }\n \n+  public enum ShardStateDimension implements MetricDimension {", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIyMjQ2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508222466", "bodyText": "Done", "author": "amathur1893", "createdAt": "2020-10-20T05:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2MjEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2Mzg2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508063865", "bodyText": "I am wondering if a better place for these constants will be an enum within AllMetrics.java", "author": "khushbr", "createdAt": "2020-10-19T21:09:38Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metrics/PerformanceAnalyzerMetrics.java", "diffHunk": "@@ -60,6 +61,8 @@\n   public static final String MASTER_CURRENT = \"current\";\n   public static final String MASTER_META_DATA = \"metadata\";\n   public static final String METRIC_CURRENT_TIME = \"current_time\";\n+  public static final String SHARD_PRIMARY = \"p\";\n+  public static final String SHARD_REPLICA = \"r\";", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNTUyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508235525", "bodyText": "Changed it to AllMetrics", "author": "amathur1893", "createdAt": "2020-10-20T06:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2Mzg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2NDE5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508064194", "bodyText": "Indentation looks off from line 344", "author": "khushbr", "createdAt": "2020-10-19T21:10:16Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/model/MetricsModel.java", "diffHunk": "@@ -340,6 +340,11 @@\n         new MetricAttributes(\n             MetricUnits.MILLISECOND.toString(), AllMetrics.MasterMetricDimensions.values()));\n \n+    allMetricsInitializer.put(\n+            AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+            new MetricAttributes(\n+                    MetricUnits.COUNT.toString(), AllMetrics.ShardStateDimension.values()));\n+", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNjU2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508236567", "bodyText": "Done", "author": "amathur1893", "createdAt": "2020-10-20T06:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2NDE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2ODM4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508068380", "bodyText": "dims can be made a static variable rather than initializing an array list on each emitShardStateMetric execution.\nRefer this", "author": "khushbr", "createdAt": "2020-10-19T21:18:26Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/MetricsEmitter.java", "diffHunk": "@@ -847,4 +847,79 @@ public static void emitNodeMetrics(\n           \"Total time taken for writing {} metrics metricsdb: {}\", tableName, mFinalT - mCurrT);\n     }\n   }\n+\n+\n+  public static void emitShardStateMetric(\n+          MetricsDB metricsDB, ShardStateMetricsSnapshot shardStateMetricsSnapshot) {\n+    long mCurrT = System.currentTimeMillis();\n+    Result<Record> shardStateMetrics = shardStateMetricsSnapshot.fetchAggregatedShardStateMetrics();\n+    List<String> dims =\n+            new ArrayList<String>() {\n+              {\n+                this.add(AllMetrics.ShardStateDimension.INDEX_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_ID.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_TYPE.toString());\n+                this.add(AllMetrics.ShardStateDimension.NODE_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_STATE.toString());\n+              }\n+            };", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNzE3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508237179", "bodyText": "done", "author": "amathur1893", "createdAt": "2020-10-20T06:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA2ODM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MDIyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508070226", "bodyText": "Trying to understand why this is relevant or required. The shard states as I understand are enum/string values and we are trying to find an sum/avg/min/max over this string values ?", "author": "khushbr", "createdAt": "2020-10-19T21:22:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/MetricsEmitter.java", "diffHunk": "@@ -847,4 +847,79 @@ public static void emitNodeMetrics(\n           \"Total time taken for writing {} metrics metricsdb: {}\", tableName, mFinalT - mCurrT);\n     }\n   }\n+\n+\n+  public static void emitShardStateMetric(\n+          MetricsDB metricsDB, ShardStateMetricsSnapshot shardStateMetricsSnapshot) {\n+    long mCurrT = System.currentTimeMillis();\n+    Result<Record> shardStateMetrics = shardStateMetricsSnapshot.fetchAggregatedShardStateMetrics();\n+    List<String> dims =\n+            new ArrayList<String>() {\n+              {\n+                this.add(AllMetrics.ShardStateDimension.INDEX_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_ID.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_TYPE.toString());\n+                this.add(AllMetrics.ShardStateDimension.NODE_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_STATE.toString());\n+              }\n+            };\n+    metricsDB.createMetric(\n+            new Metric<Double>(AllMetrics.ShardStateValue.SHARD_STATE.toString(), 0d),\n+            dims);\n+\n+    BatchBindStep handle =\n+            metricsDB.startBatchPut(\n+                    new Metric<Double>(AllMetrics.ShardStateValue.SHARD_STATE.toString(), 0d),\n+                    dims);\n+\n+    for (Record r : shardStateMetrics) {\n+\n+      Double sumShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.SUM))\n+                              .toString());\n+\n+      Double avgShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.AVG))\n+                              .toString());\n+\n+      Double minShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.MIN))\n+                              .toString());\n+\n+      Double maxShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.MAX))\n+                              .toString());", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MDUxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508070514", "bodyText": "Let's add a metric here.", "author": "khushbr", "createdAt": "2020-10-19T21:22:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/MetricsEmitter.java", "diffHunk": "@@ -847,4 +847,79 @@ public static void emitNodeMetrics(\n           \"Total time taken for writing {} metrics metricsdb: {}\", tableName, mFinalT - mCurrT);\n     }\n   }\n+\n+\n+  public static void emitShardStateMetric(\n+          MetricsDB metricsDB, ShardStateMetricsSnapshot shardStateMetricsSnapshot) {\n+    long mCurrT = System.currentTimeMillis();\n+    Result<Record> shardStateMetrics = shardStateMetricsSnapshot.fetchAggregatedShardStateMetrics();\n+    List<String> dims =\n+            new ArrayList<String>() {\n+              {\n+                this.add(AllMetrics.ShardStateDimension.INDEX_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_ID.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_TYPE.toString());\n+                this.add(AllMetrics.ShardStateDimension.NODE_NAME.toString());\n+                this.add(AllMetrics.ShardStateDimension.SHARD_STATE.toString());\n+              }\n+            };\n+    metricsDB.createMetric(\n+            new Metric<Double>(AllMetrics.ShardStateValue.SHARD_STATE.toString(), 0d),\n+            dims);\n+\n+    BatchBindStep handle =\n+            metricsDB.startBatchPut(\n+                    new Metric<Double>(AllMetrics.ShardStateValue.SHARD_STATE.toString(), 0d),\n+                    dims);\n+\n+    for (Record r : shardStateMetrics) {\n+\n+      Double sumShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.SUM))\n+                              .toString());\n+\n+      Double avgShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.AVG))\n+                              .toString());\n+\n+      Double minShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.MIN))\n+                              .toString());\n+\n+      Double maxShardState =\n+              Double.parseDouble(\n+                      r.get(\n+                              DBUtils.getAggFieldName(\n+                                      AllMetrics.ShardStateValue.SHARD_STATE.toString(),\n+                                      MetricsDB.MAX))\n+                              .toString());\n+\n+      handle.bind(\n+              r.get(AllMetrics.ShardStateDimension.INDEX_NAME.toString()).toString(),\n+              r.get(AllMetrics.ShardStateDimension.SHARD_ID.toString()).toString(),\n+              r.get(AllMetrics.ShardStateDimension.SHARD_TYPE.toString()).toString(),\n+              r.get(AllMetrics.ShardStateDimension.NODE_NAME.toString()).toString(),\n+              r.get(AllMetrics.ShardStateDimension.SHARD_STATE.toString()).toString(),\n+              sumShardState,\n+              avgShardState,\n+              minShardState,\n+              maxShardState);\n+    }\n+    handle.execute();\n+    long mFinalT = System.currentTimeMillis();\n+    LOG.debug(\n+            \"Total time taken for writing shard state event queue metrics metricsdb: {}\", mFinalT - mCurrT);", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MTU0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508071546", "bodyText": "Missing License information from beginning of file.", "author": "khushbr", "createdAt": "2020-10-19T21:25:00Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/metrics/WriterMetrics.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics;", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MTY0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508071642", "bodyText": "Missing License information from beginning of file.", "author": "khushbr", "createdAt": "2020-10-19T21:25:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsProcessor.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MTkwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508071906", "bodyText": "Missing License information from beginning of file.", "author": "khushbr", "createdAt": "2020-10-19T21:25:41Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsSnapshotTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNjMxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508336315", "bodyText": "Added", "author": "amathur1893", "createdAt": "2020-10-20T09:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MTkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MjIyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508072223", "bodyText": "Missing License information from beginning of file.", "author": "khushbr", "createdAt": "2020-10-19T21:26:18Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsSnapshot.java", "diffHunk": "@@ -0,0 +1,158 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNjQwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508336406", "bodyText": "Added", "author": "amathur1893", "createdAt": "2020-10-20T09:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MjIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjc0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508072745", "bodyText": "unused variable ?", "author": "khushbr", "createdAt": "2020-10-19T21:27:27Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsSnapshot.java", "diffHunk": "@@ -0,0 +1,158 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.DBUtils;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import java.sql.Connection;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.BatchBindStep;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.SQLDialect;\n+import org.jooq.SelectField;\n+import org.jooq.impl.DSL;\n+\n+public class ShardStateMetricsSnapshot implements Removable {\n+    private static final Logger LOG = LogManager.getLogger(ShardStateMetricsSnapshot.class);\n+    private final DSLContext create;\n+    private final String tableName;\n+    private static final Long EXPIRE_AFTER = 1200000L;", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNjQ1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508336456", "bodyText": "Removed", "author": "amathur1893", "createdAt": "2020-10-20T09:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3NTI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508075278", "bodyText": "nit: Move ShardStateMetricsSnapshot> shardStateEventMetricsMap) to next line.", "author": "khushbr", "createdAt": "2020-10-19T21:32:42Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsProcessor.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.PerformanceAnalyzerMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader_writer_shared.Event;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.NavigableMap;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.BatchBindStep;\n+import org.jooq.tools.StringUtils;\n+\n+public class ShardStateMetricsProcessor implements EventProcessor {\n+    private static final Logger LOG = LogManager.getLogger(ShardStateMetricsProcessor.class);\n+    private ShardStateMetricsSnapshot shardStateMetricsSnapshot;\n+    private BatchBindStep handle;\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final TypeReference<HashMap<String, String>> TYPE_REF = new TypeReference<HashMap<String, String>>() {};\n+\n+    private ShardStateMetricsProcessor(ShardStateMetricsSnapshot snapshot) {\n+        this.shardStateMetricsSnapshot = snapshot;\n+    }\n+\n+    static ShardStateMetricsProcessor buildShardStateMetricEventsProcessor(\n+            long currWindowStartTime,\n+            Connection conn,\n+            NavigableMap<Long, ShardStateMetricsSnapshot> shardStateEventMetricsMap) {", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNjUxMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508336510", "bodyText": "Done", "author": "amathur1893", "createdAt": "2020-10-20T09:09:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3NTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3NzI4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508077283", "bodyText": "The function arguments startTime and endTime arent used anywhere in the function. We can do 2 things here:\n\nAdd a new method public void initializeProcessing() within EventProcessor\nInitialize startTime and endTime  within this function.\n\nLet's go with 2 for now.", "author": "khushbr", "createdAt": "2020-10-19T21:36:57Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ShardStateMetricsProcessor.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.reader;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.PerformanceAnalyzerMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader_writer_shared.Event;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.NavigableMap;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.BatchBindStep;\n+import org.jooq.tools.StringUtils;\n+\n+public class ShardStateMetricsProcessor implements EventProcessor {\n+    private static final Logger LOG = LogManager.getLogger(ShardStateMetricsProcessor.class);\n+    private ShardStateMetricsSnapshot shardStateMetricsSnapshot;\n+    private BatchBindStep handle;\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final TypeReference<HashMap<String, String>> TYPE_REF = new TypeReference<HashMap<String, String>>() {};\n+\n+    private ShardStateMetricsProcessor(ShardStateMetricsSnapshot snapshot) {\n+        this.shardStateMetricsSnapshot = snapshot;\n+    }\n+\n+    static ShardStateMetricsProcessor buildShardStateMetricEventsProcessor(\n+            long currWindowStartTime,\n+            Connection conn,\n+            NavigableMap<Long, ShardStateMetricsSnapshot> shardStateEventMetricsMap) {\n+        ShardStateMetricsSnapshot shardStateSnap = shardStateEventMetricsMap.get(currWindowStartTime);\n+        if (shardStateSnap == null) {\n+            shardStateSnap = new ShardStateMetricsSnapshot(conn, currWindowStartTime);\n+            shardStateEventMetricsMap.put(currWindowStartTime, shardStateSnap);\n+        }\n+        return new ShardStateMetricsProcessor(shardStateSnap);\n+    }\n+\n+    @Override\n+    public void initializeProcessing(long startTime, long endTime) {", "originalCommit": "d59004072522d90f307aebf1bf0b4df4619b5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODMzNjYzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/436#discussion_r508336633", "bodyText": "Initialised", "author": "amathur1893", "createdAt": "2020-10-20T09:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3NzI4Mw=="}], "type": "inlineReview"}, {"oid": "36c69dc57d6b945933bffe04705d21e4c44ded19", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/36c69dc57d6b945933bffe04705d21e4c44ded19", "message": "Publish Shard State Metrics", "committedDate": "2020-10-20T09:10:08Z", "type": "commit"}, {"oid": "1b4f742330ba3456459df6c6611ad073c88e1a90", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1b4f742330ba3456459df6c6611ad073c88e1a90", "message": "Publish Shard State Metrics", "committedDate": "2020-10-20T09:14:57Z", "type": "commit"}, {"oid": "2f6200caee9464843908e755da240928421640c9", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2f6200caee9464843908e755da240928421640c9", "message": "Publish Shard State Metrics", "committedDate": "2020-10-20T09:26:21Z", "type": "commit"}]}