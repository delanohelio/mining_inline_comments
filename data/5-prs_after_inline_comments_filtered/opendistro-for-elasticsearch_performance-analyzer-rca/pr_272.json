{"pr_number": 272, "pr_title": "Implement cool off handling for the Publisher", "pr_createdAt": "2020-07-14T00:24:03Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272", "timeline": [{"oid": "a8f17f2fdbcbb0898d195cd0fd462c8ab8af979d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a8f17f2fdbcbb0898d195cd0fd462c8ab8af979d", "message": "Implement cool off handling for the Publisher\n\nThe Publisher shouldn't spam the same action over and over again. It\nshould wait for a specified period of time before repeating an action.\n\nThis commit implements this logic.", "committedDate": "2020-07-14T00:20:45Z", "type": "commit"}, {"oid": "f0bbc397acadee3e8605a426d131a4493be7bbd3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f0bbc397acadee3e8605a426d131a4493be7bbd3", "message": "Fixup Javadoc styling for Publisher", "committedDate": "2020-07-14T00:34:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwMTg5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454101891", "bodyText": "Do you want milliseconds or microseconds?", "author": "vigyasharma", "createdAt": "2020-07-14T05:01:47Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -30,7 +30,7 @@\n public class ModifyQueueCapacityAction implements Action {\n \n   public static final String NAME = \"modify_queue_capacity\";\n-  public static final int COOL_OFF_PERIOD_IN_SECONDS = 300;\n+  public static final long COOL_OFF_PERIOD_IN_MILLIS = 300 * 1_000_000;", "originalCommit": "f0bbc397acadee3e8605a426d131a4493be7bbd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODM1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454218357", "bodyText": "Fixed", "author": "sidheart", "createdAt": "2020-07-14T09:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwMTg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwMzYyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454103623", "bodyText": "Minor: Let's add a debug log around time remaining for cool-off to complete.", "author": "vigyasharma", "createdAt": "2020-07-14T05:06:50Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,59 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n+    this.actionToExecutionTime = new ConcurrentHashMap<>();\n+    initTime = Instant.now().toEpochMilli();\n+  }\n+\n+  /**\n+   * Returns true if a given {@link Action}'s last execution time was > {@link Action#coolOffPeriodInMillis()} ago\n+   *\n+   * <p>If this Publisher has never executed the action, the last execution time is defined as the time that the publisher\n+   * object was constructed.\n+   *\n+   * @param action The {@link Action} to test\n+   * @return true if a given {@link Action}'s last execution time was > {@link Action#coolOffPeriodInMillis()} ago\n+   */\n+  public boolean isCooledOff(Action action) {\n+    long lastExecution = actionToExecutionTime.getOrDefault(action.name(), initTime);\n+    long now = Instant.now().toEpochMilli();\n+    return now - lastExecution > action.coolOffPeriodInMillis();\n   }\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Pass through implementation, need to add dampening, cool-off, action flip-flop\n+    // TODO: Pass through implementation, need to add dampening, action flip-flop\n     // avoidance, state persistence etc.\n-\n     Decision decision = collator.getFlowUnits().get(0);\n     for (Action action : decision.getActions()) {\n-      LOG.info(\"Executing action: [{}]\", action.name());\n-      action.execute();\n+      if (isCooledOff(action)) { // Only execute actions which have passed their cool off period\n+        LOG.info(\"Executing action: [{}]\", action.name());\n+        action.execute();\n+        actionToExecutionTime.put(action.name(), Instant.now().toEpochMilli());\n+      }", "originalCommit": "f0bbc397acadee3e8605a426d131a4493be7bbd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODUzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454218537", "bodyText": "Added to isCooledOff()", "author": "sidheart", "createdAt": "2020-07-14T09:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwMzYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNzAyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454107027", "bodyText": "In its current form, the test requires (human) readers to keep a track of expectedExecutions and notice when it is not incremented, which makes impacts readability.\nWhile it is functionally correct, please consider using reset on the mock object and explicitly calling expected number of counts for each invocation verification e.g.\nMockito.verify(action, Mockito.times(0)).execute();\n...\nMockito.reset(action);\n...\nMockito.verify(action, Mockito.times(1)).execute();", "author": "vigyasharma", "createdAt": "2020-07-14T05:18:07Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/PublisherTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.time.Instant;\n+import java.util.List;\n+\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+\n+public class PublisherTest {\n+    private static final int EVAL_INTERVAL_S = 5;\n+    private static Publisher publisher;\n+\n+    // Mock objects\n+    @Mock\n+    private Collator collator;\n+\n+    @Mock\n+    private Decision decision;\n+\n+    @Mock\n+    private Action action;\n+\n+    private static class TestDecider extends Decider {\n+        public TestDecider(long evalIntervalSeconds, int decisionFrequency) {\n+            super(evalIntervalSeconds, decisionFrequency);\n+        }\n+\n+        @Override\n+        public String name() {\n+            return getClass().getSimpleName();\n+        }\n+\n+        @Override\n+        public Decision operate() {\n+            return null;\n+        }\n+    }\n+\n+    @BeforeClass\n+    public static void setupClass() {\n+    }\n+\n+    @Before\n+    public void setup() {\n+        MockitoAnnotations.initMocks(this);\n+        publisher = new Publisher(EVAL_INTERVAL_S, collator);\n+    }\n+\n+    @Test\n+    public void testIsCooledOff() throws Exception {\n+        int expectedExecutions = 0;\n+        List<Decision> decisionList = Lists.newArrayList(decision);\n+        Mockito.when(collator.getFlowUnits()).thenReturn(decisionList);\n+        Mockito.when(decision.getActions()).thenReturn(Lists.newArrayList(action));\n+        Mockito.when(action.name()).thenReturn(\"testIsCooledOffAction\");\n+        Mockito.when(action.coolOffPeriodInMillis()).thenReturn(100_000L);\n+        // Verify that a newly initialized publisher doesn't execute an action until the publisher object\n+        // has been alive for longer than the action's cool off period\n+        publisher.operate();\n+        Mockito.verify(action, Mockito.times(expectedExecutions)).execute();\n+        Mockito.when(action.coolOffPeriodInMillis()).thenReturn(Instant.now().toEpochMilli()\n+                - publisher.getInitTime() - 1000L);\n+        publisher.operate();\n+        expectedExecutions++;", "originalCommit": "f0bbc397acadee3e8605a426d131a4493be7bbd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODYyMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454218620", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-07-14T09:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNzAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNzUwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454107506", "bodyText": "Do we need a concurrent hash map here? Isn't it a single thread being scheduled to call it every 5 seconds?", "author": "vigyasharma", "createdAt": "2020-07-14T05:19:34Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,59 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n+    this.actionToExecutionTime = new ConcurrentHashMap<>();", "originalCommit": "f0bbc397acadee3e8605a426d131a4493be7bbd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODc4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454218781", "bodyText": "Changed to HashMap", "author": "sidheart", "createdAt": "2020-07-14T09:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEwNzUwNg=="}], "type": "inlineReview"}, {"oid": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/855611f64ba9df4ef7dda207e5fc24ecb72f4778", "message": "Address PR comments for Publisher cool off", "committedDate": "2020-07-14T09:14:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NjUyMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454556520", "bodyText": "can we set this in rca.conf and make this configurable", "author": "rguo-aws", "createdAt": "2020-07-14T18:24:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -30,7 +30,7 @@\n public class ModifyQueueCapacityAction implements Action {\n \n   public static final String NAME = \"modify_queue_capacity\";\n-  public static final int COOL_OFF_PERIOD_IN_SECONDS = 300;\n+  public static final long COOL_OFF_PERIOD_IN_MILLIS = 300 * 1_000;", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0NzMzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454647336", "bodyText": "Good idea, but out of scope for this commit. The only reason I changed this line is that we're going from s units to ms", "author": "sidheart", "createdAt": "2020-07-14T21:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NjUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NzA4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454557086", "bodyText": "any specific reason to replace system with Instant.now() ?", "author": "rguo-aws", "createdAt": "2020-07-14T18:25:32Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,65 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n+    this.actionToExecutionTime = new HashMap<>();\n+    initTime = Instant.now().toEpochMilli();\n+  }\n+\n+  /**\n+   * Returns true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   *\n+   * <p>If this Publisher has never executed the action, the last execution time is defined as the time that the publisher\n+   * object was constructed.\n+   *\n+   * @param action The {@link Action} to test\n+   * @return true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   */\n+  public boolean isCooledOff(Action action) {\n+    long lastExecution = actionToExecutionTime.getOrDefault(action.name(), initTime);\n+    long elapsed = Instant.now().toEpochMilli() - lastExecution;\n+    if (elapsed >= action.coolOffPeriodInMillis()) {\n+      return true;\n+    } else {\n+      LOG.debug(\"Action {} still has {} ms left in its cool off period\", action.name(),\n+              action.coolOffPeriodInMillis() - elapsed);\n+      return false;\n+    }\n   }\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Pass through implementation, need to add dampening, cool-off, action flip-flop\n+    // TODO: Pass through implementation, need to add dampening, action flip-flop\n     // avoidance, state persistence etc.\n-\n     Decision decision = collator.getFlowUnits().get(0);\n     for (Action action : decision.getActions()) {\n-      LOG.info(\"Executing action: [{}]\", action.name());\n-      action.execute();\n+      if (isCooledOff(action)) { // Only execute actions which have passed their cool off period\n+        LOG.info(\"Executing action: [{}]\", action.name());\n+        action.execute();\n+        actionToExecutionTime.put(action.name(), Instant.now().toEpochMilli());\n+      }\n     }\n \n-    return new EmptyFlowUnit(System.currentTimeMillis());\n+    return new EmptyFlowUnit(Instant.now().toEpochMilli());", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0NzY1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454647658", "bodyText": "Yes, see https://www.baeldung.com/java-measure-elapsed-time", "author": "sidheart", "createdAt": "2020-07-14T21:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1NzA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzc2NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454557764", "bodyText": "Can we use Action itself as the key ?", "author": "rguo-aws", "createdAt": "2020-07-14T18:26:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,65 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0OTA3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454649071", "bodyText": "We could, but we'd have to implement hashCode() and equals() for all Actions. I asked Vigya, and he said it was a safe assumption that Action names are unique, so it should suffice as a key.", "author": "sidheart", "createdAt": "2020-07-14T21:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDU3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454560570", "bodyText": "Let's keep the logging format consistent within RCA package. Let's add the \"Publisher: \" at the front of this log", "author": "rguo-aws", "createdAt": "2020-07-14T18:31:29Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,65 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n+    this.actionToExecutionTime = new HashMap<>();\n+    initTime = Instant.now().toEpochMilli();\n+  }\n+\n+  /**\n+   * Returns true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   *\n+   * <p>If this Publisher has never executed the action, the last execution time is defined as the time that the publisher\n+   * object was constructed.\n+   *\n+   * @param action The {@link Action} to test\n+   * @return true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   */\n+  public boolean isCooledOff(Action action) {\n+    long lastExecution = actionToExecutionTime.getOrDefault(action.name(), initTime);\n+    long elapsed = Instant.now().toEpochMilli() - lastExecution;\n+    if (elapsed >= action.coolOffPeriodInMillis()) {\n+      return true;\n+    } else {\n+      LOG.debug(\"Action {} still has {} ms left in its cool off period\", action.name(),", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1Mjk2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454652962", "bodyText": "I'm against this because it's an anti-pattern in the log4j context. If we want to include class info in logging lines we should update our logging pattern to include %c{1.} for example. See https://logging.apache.org/log4j/2.x/manual/layouts.html\nDoes anyone else have thoughts on this?", "author": "sidheart", "createdAt": "2020-07-14T21:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5NDExNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r456594117", "bodyText": "I added this in for now", "author": "sidheart", "createdAt": "2020-07-17T18:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDY5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454560691", "bodyText": "same as above", "author": "rguo-aws", "createdAt": "2020-07-14T18:31:40Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,65 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+\n+import java.time.Instant;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n \n   private static final Logger LOG = LogManager.getLogger(Publisher.class);\n+  private final long initTime;\n \n   private Collator collator;\n   private boolean isMuted = false;\n+  private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n+    this.actionToExecutionTime = new HashMap<>();\n+    initTime = Instant.now().toEpochMilli();\n+  }\n+\n+  /**\n+   * Returns true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   *\n+   * <p>If this Publisher has never executed the action, the last execution time is defined as the time that the publisher\n+   * object was constructed.\n+   *\n+   * @param action The {@link Action} to test\n+   * @return true if a given {@link Action}'s last execution time was >= {@link Action#coolOffPeriodInMillis()} ago\n+   */\n+  public boolean isCooledOff(Action action) {\n+    long lastExecution = actionToExecutionTime.getOrDefault(action.name(), initTime);\n+    long elapsed = Instant.now().toEpochMilli() - lastExecution;\n+    if (elapsed >= action.coolOffPeriodInMillis()) {\n+      return true;\n+    } else {\n+      LOG.debug(\"Action {} still has {} ms left in its cool off period\", action.name(),\n+              action.coolOffPeriodInMillis() - elapsed);\n+      return false;\n+    }\n   }\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Pass through implementation, need to add dampening, cool-off, action flip-flop\n+    // TODO: Pass through implementation, need to add dampening, action flip-flop\n     // avoidance, state persistence etc.\n-\n     Decision decision = collator.getFlowUnits().get(0);\n     for (Action action : decision.getActions()) {\n-      LOG.info(\"Executing action: [{}]\", action.name());\n-      action.execute();\n+      if (isCooledOff(action)) { // Only execute actions which have passed their cool off period\n+        LOG.info(\"Executing action: [{}]\", action.name());", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MzEzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454653131", "bodyText": "also same as above, I'd like to hear people's thoughts on this", "author": "sidheart", "createdAt": "2020-07-14T21:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5NDE4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r456594186", "bodyText": "done", "author": "sidheart", "createdAt": "2020-07-17T18:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDY5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2Mjk1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r454562954", "bodyText": "remove this line ?", "author": "rguo-aws", "createdAt": "2020-07-14T18:35:41Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -18,33 +18,65 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+", "originalCommit": "855611f64ba9df4ef7dda207e5fc24ecb72f4778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5MzkwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/272#discussion_r456593904", "bodyText": "Removed", "author": "sidheart", "createdAt": "2020-07-17T18:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2Mjk1NA=="}], "type": "inlineReview"}, {"oid": "f13f105c82b03f108507d97eaf1c4013b4f4a9ed", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f13f105c82b03f108507d97eaf1c4013b4f4a9ed", "message": "Respond to PR comments", "committedDate": "2020-07-17T18:00:40Z", "type": "commit"}, {"oid": "4ff8c9e6c337aba7468f95b8ebb62790786326aa", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4ff8c9e6c337aba7468f95b8ebb62790786326aa", "message": "Merge branch 'master' into publisher-cooloff", "committedDate": "2020-07-21T17:24:36Z", "type": "commit"}]}