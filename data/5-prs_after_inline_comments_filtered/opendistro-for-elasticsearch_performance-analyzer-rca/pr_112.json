{"pr_number": 112, "pr_title": "remove list of list in MetricFlowunit", "pr_createdAt": "2020-02-29T00:53:02Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/112", "timeline": [{"oid": "89728540b71cfb439a8721f7c2bb93adf71d560d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/89728540b71cfb439a8721f7c2bb93adf71d560d", "message": "remove list of list in MetricFlowunit", "committedDate": "2020-02-29T00:44:35Z", "type": "commit"}, {"oid": "e8a5d9f68ea1cb1f7fb6e96194f415d0ce86131e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e8a5d9f68ea1cb1f7fb6e96194f415d0ce86131e", "message": "remove dead code", "committedDate": "2020-02-29T00:49:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4OTcyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/112#discussion_r386589726", "bodyText": "Can we add an assert here, so that the test fails if this happens?", "author": "ditac", "createdAt": "2020-03-02T19:06:13Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/HighCpuSymptomTest.java", "diffHunk": "@@ -79,53 +80,39 @@ public SymptomFlowUnit operate() {\n       boolean shouldReportOperation = false;\n \n       MetricFlowUnit cpuMetric = cpuMetrics.get(0);\n-      List<List<String>> allData = cpuMetric.getData();\n-      List<String> cols = allData.get(0);\n-      int shardIDIdx = -1;\n-      int maxColIdx = -1;\n-\n-      // Get the index of the shardID column.\n-      for (int i = 0; i < cols.size(); i++) {\n-        if (cols.get(i).equals(OSMetricHelper.getDims().get(0))) {\n-          shardIDIdx = i;\n-          break;\n-        }\n-      }\n-\n-      // Get the index of the max column.\n-      for (int i = 0; i < cols.size(); i++) {\n-        if (cols.get(i).equals(MetricsDB.MAX)) {\n-          maxColIdx = i;\n-          break;\n-        }\n-      }\n-\n       Map<String, MovingAverage> averageMap = new HashMap<>();\n       final double HIGH_CPU_THRESHOLD = 90.0;\n       List<List<String>> ret = new ArrayList<>();\n-      // The first row is the column names, so we start from the row 1.\n-      for (int i = 1; i < allData.size(); i++) {\n-        List<String> row = allData.get(i);\n-        String shardId = row.get(shardIDIdx);\n-        MovingAverage entry = averageMap.get(shardId);\n-        if (null == entry) {\n-          entry = new MovingAverage(3);\n-          averageMap.put(shardId, entry);\n-        }\n-        double val = entry.next(Double.parseDouble(row.get(maxColIdx)));\n-        if (val > HIGH_CPU_THRESHOLD) {\n-          List<String> dataRow = Collections.singletonList(shardId);\n-          // context.put(\"threshold\", String.valueOf(HIGH_CPU_THRESHOLD));\n-          // context.put(\"actual\", String.valueOf(val));\n-          ret.add(dataRow);\n-          System.out.println(\n-              String.format(\n-                  \"Shard %s is hot. Average max CPU (%f) above: %f\",\n-                  shardId, val, HIGH_CPU_THRESHOLD));\n-          shouldReportOperation = true;\n+      if (cpuMetric.getData() != null) {\n+        for (Record record : cpuMetric.getData()) {\n+          try {\n+            String shardId = record.getValue(SHARD_ID.toString(), String.class);\n+            double data = record.getValue(MetricsDB.MAX, Double.class);\n+            MovingAverage entry = averageMap.get(shardId);\n+            if (null == entry) {\n+              entry = new MovingAverage(3);\n+              averageMap.put(shardId, entry);\n+            }\n+            double val = entry.next(data);\n+            if (val > HIGH_CPU_THRESHOLD) {\n+              List<String> dataRow = Collections.singletonList(shardId);\n+              // context.put(\"threshold\", String.valueOf(HIGH_CPU_THRESHOLD));\n+              // context.put(\"actual\", String.valueOf(val));\n+              ret.add(dataRow);\n+              System.out.println(\n+                  String.format(\n+                      \"Shard %s is hot. Average max CPU (%f) above: %f\",\n+                      shardId, val, HIGH_CPU_THRESHOLD));\n+              shouldReportOperation = true;\n+            }\n+          }\n+          catch (Exception e) {\n+            System.out.println(", "originalCommit": "e8a5d9f68ea1cb1f7fb6e96194f415d0ce86131e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5MDA2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/112#discussion_r386590067", "bodyText": "Good to avoid logs in test, unless the test fails.", "author": "ditac", "createdAt": "2020-03-02T19:06:52Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/HighCpuSymptomTest.java", "diffHunk": "@@ -79,53 +80,39 @@ public SymptomFlowUnit operate() {\n       boolean shouldReportOperation = false;\n \n       MetricFlowUnit cpuMetric = cpuMetrics.get(0);\n-      List<List<String>> allData = cpuMetric.getData();\n-      List<String> cols = allData.get(0);\n-      int shardIDIdx = -1;\n-      int maxColIdx = -1;\n-\n-      // Get the index of the shardID column.\n-      for (int i = 0; i < cols.size(); i++) {\n-        if (cols.get(i).equals(OSMetricHelper.getDims().get(0))) {\n-          shardIDIdx = i;\n-          break;\n-        }\n-      }\n-\n-      // Get the index of the max column.\n-      for (int i = 0; i < cols.size(); i++) {\n-        if (cols.get(i).equals(MetricsDB.MAX)) {\n-          maxColIdx = i;\n-          break;\n-        }\n-      }\n-\n       Map<String, MovingAverage> averageMap = new HashMap<>();\n       final double HIGH_CPU_THRESHOLD = 90.0;\n       List<List<String>> ret = new ArrayList<>();\n-      // The first row is the column names, so we start from the row 1.\n-      for (int i = 1; i < allData.size(); i++) {\n-        List<String> row = allData.get(i);\n-        String shardId = row.get(shardIDIdx);\n-        MovingAverage entry = averageMap.get(shardId);\n-        if (null == entry) {\n-          entry = new MovingAverage(3);\n-          averageMap.put(shardId, entry);\n-        }\n-        double val = entry.next(Double.parseDouble(row.get(maxColIdx)));\n-        if (val > HIGH_CPU_THRESHOLD) {\n-          List<String> dataRow = Collections.singletonList(shardId);\n-          // context.put(\"threshold\", String.valueOf(HIGH_CPU_THRESHOLD));\n-          // context.put(\"actual\", String.valueOf(val));\n-          ret.add(dataRow);\n-          System.out.println(\n-              String.format(\n-                  \"Shard %s is hot. Average max CPU (%f) above: %f\",\n-                  shardId, val, HIGH_CPU_THRESHOLD));\n-          shouldReportOperation = true;\n+      if (cpuMetric.getData() != null) {\n+        for (Record record : cpuMetric.getData()) {\n+          try {\n+            String shardId = record.getValue(SHARD_ID.toString(), String.class);\n+            double data = record.getValue(MetricsDB.MAX, Double.class);\n+            MovingAverage entry = averageMap.get(shardId);\n+            if (null == entry) {\n+              entry = new MovingAverage(3);\n+              averageMap.put(shardId, entry);\n+            }\n+            double val = entry.next(data);\n+            if (val > HIGH_CPU_THRESHOLD) {\n+              List<String> dataRow = Collections.singletonList(shardId);\n+              // context.put(\"threshold\", String.valueOf(HIGH_CPU_THRESHOLD));\n+              // context.put(\"actual\", String.valueOf(val));\n+              ret.add(dataRow);\n+              System.out.println(\n+                  String.format(", "originalCommit": "e8a5d9f68ea1cb1f7fb6e96194f415d0ce86131e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}