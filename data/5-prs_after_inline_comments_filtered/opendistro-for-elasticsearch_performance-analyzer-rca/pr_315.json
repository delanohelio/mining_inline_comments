{"pr_number": 315, "pr_title": "Batch Metrics API", "pr_createdAt": "2020-07-28T21:12:09Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315", "timeline": [{"oid": "d4e6c36398e80875424d9b3e81dca19e72f35dec", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d4e6c36398e80875424d9b3e81dca19e72f35dec", "message": "Fix spotbugs issues", "committedDate": "2020-08-04T22:41:24Z", "type": "forcePushed"}, {"oid": "4d6c11e5fa86b5b26cd3db950d9de1bae1ac34a6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4d6c11e5fa86b5b26cd3db950d9de1bae1ac34a6", "message": "Add unit tests and associated code changes", "committedDate": "2020-08-13T17:18:19Z", "type": "forcePushed"}, {"oid": "6e19eceb8c42f5bde9277943873dba8445105e1f", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6e19eceb8c42f5bde9277943873dba8445105e1f", "message": "Add batch metrics api (untested)", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "8ff9c24bd8b2ac5997af87ba13e8a673572054d6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8ff9c24bd8b2ac5997af87ba13e8a673572054d6", "message": "Read retention period from settings file", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "96b327d1f2fc7abb387deaf2e345b7a9edebe4f7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/96b327d1f2fc7abb387deaf2e345b7a9edebe4f7", "message": "Handle empty batch metrics set", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "a3b273e474fc6556aeb867897c657fd960f10682", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a3b273e474fc6556aeb867897c657fd960f10682", "message": "Remove table name from batch metrics fields", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "b4f0bd6cc79d8eb5bbd954864d42b7896a4e7407", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b4f0bd6cc79d8eb5bbd954864d42b7896a4e7407", "message": "Retain an extra metricsdb file", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "003f8b20ebd21fa8cd24e97a60e6ecf6c159bb3d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/003f8b20ebd21fa8cd24e97a60e6ecf6c159bb3d", "message": "Store retention period as minutes", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "f129ae0ffc68bae4689d1913b3a2f673a39b12f2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f129ae0ffc68bae4689d1913b3a2f673a39b12f2", "message": "Update starttime and endtime use\n\n- Reverse the role of starttime and endttime.\n- Check that starttime and endtime are within the retention period.", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "f0380d056decd22b74b6d30da98820c53f3dafe3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f0380d056decd22b74b6d30da98820c53f3dafe3", "message": "Rename period to samplingperiod", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "748a3adfef319703c4aea8bc540eb3d287c53bb4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/748a3adfef319703c4aea8bc540eb3d287c53bb4", "message": "Remove maxdatapoints parameter", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "f03684f47ce3e995e6b5a89098eb20278e1b2a2a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f03684f47ce3e995e6b5a89098eb20278e1b2a2a", "message": "Limit batch metrics retention period", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "158bac0adf3319d0b165c30cf9568e36b5e87608", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/158bac0adf3319d0b165c30cf9568e36b5e87608", "message": "Limit batch metrics sampling period", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "4b11c98ff0f3fa61d532fc7e70d65584619b74a1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4b11c98ff0f3fa61d532fc7e70d65584619b74a1", "message": "Remove unnecessary exception catching", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "01eec9c933ac3b4d7c908f1f32a005475c2b947e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/01eec9c933ac3b4d7c908f1f32a005475c2b947e", "message": "Fix spotbugs issues", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "f46b43eb6d28543a7f2840b1cd7496939b15d642", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f46b43eb6d28543a7f2840b1cd7496939b15d642", "message": "Fix checkstyle issues", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "74933f9a57ce33f391fdaedac0875c5058587995", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/74933f9a57ce33f391fdaedac0875c5058587995", "message": "Add unit tests and associated code changes", "committedDate": "2020-08-13T20:19:22Z", "type": "commit"}, {"oid": "74933f9a57ce33f391fdaedac0875c5058587995", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/74933f9a57ce33f391fdaedac0875c5058587995", "message": "Add unit tests and associated code changes", "committedDate": "2020-08-13T20:19:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODA5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470358094", "bodyText": "Please change the README accordingly to document the new url and details for this", "author": "yojs", "createdAt": "2020-08-14T01:12:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerApp.java", "diffHunk": "@@ -66,6 +67,7 @@\n \n   private static final int EXCEPTION_QUEUE_LENGTH = 1;\n   public static final String QUERY_URL = \"/_opendistro/_performanceanalyzer/metrics\";\n+  public static final String BATCH_METRICS_URL = \"/_opendistro/_performanceanalyzer/batch\";", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA4NjU0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r476086543", "bodyText": "Agreed, documentation has been added to the README in the performance-analyzer repository.", "author": "ricardolstephen", "createdAt": "2020-08-25T02:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODUzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470358530", "bodyText": "Can we add the time unit in the variable name such as\nBATCH_METRICS_RETENTION_PERIOD_DEFAULT_MINS and so on ?", "author": "yojs", "createdAt": "2020-08-14T01:13:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -44,6 +45,9 @@\n   private static final int DELETION_INTERVAL_MAX = 60;\n   private static final String HTTPS_ENABLED = \"https-enabled\";\n   private static final String WRITER_QUEUE_SIZE = \"writer-queue-size\";\n+  private static final String BATCH_METRICS_RETENTION_PERIOD = \"batch-metrics-retention-period\";\n+  private static final long BATCH_METRICS_RETENTION_PERIOD_DEFAULT = 7;  // 7 minutes of metrics\n+  private static final long BATCH_METRICS_RETENTION_PERIOD_LIMIT = 60;", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2OTE0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475769149", "bodyText": "Yes, that would be a good idea.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODY2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470358663", "bodyText": "Also can we add javadoc comments describing the variables ?", "author": "yojs", "createdAt": "2020-08-14T01:14:00Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -44,6 +45,9 @@\n   private static final int DELETION_INTERVAL_MAX = 60;\n   private static final String HTTPS_ENABLED = \"https-enabled\";\n   private static final String WRITER_QUEUE_SIZE = \"writer-queue-size\";\n+  private static final String BATCH_METRICS_RETENTION_PERIOD = \"batch-metrics-retention-period\";\n+  private static final long BATCH_METRICS_RETENTION_PERIOD_DEFAULT = 7;  // 7 minutes of metrics", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2ODc3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475768772", "bodyText": "Will add this documentation to the batchMetricsRetentionPeriod variable (this is what was done for the other parameters also).", "author": "ricardolstephen", "createdAt": "2020-08-24T17:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODczNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470358734", "bodyText": "Please add the timeunit as the variable name", "author": "yojs", "createdAt": "2020-08-14T01:14:22Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -59,6 +63,8 @@\n   private Properties settings;\n   private final String configFilePath;\n \n+  private long batchMetricsRetentionPeriod;", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3MDAxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475770018", "bodyText": "Yes", "author": "ricardolstephen", "createdAt": "2020-08-24T17:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1ODczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1OTA0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470359044", "bodyText": "Let's add the unit here as well, so that it is reflected in the logs", "author": "yojs", "createdAt": "2020-08-14T01:15:34Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -156,11 +178,12 @@ private PluginSettings(String cfPath) {\n     }\n     LOG.info(\n         \"Config: metricsLocation: {}, metricsDeletionInterval: {}, httpsEnabled: {},\"\n-            + \" cleanup-metrics-db-files: {}\",\n+            + \" cleanup-metrics-db-files: {}, batch-metrics-retention-period: {}\",", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3MDI1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475770255", "bodyText": "Yes", "author": "ricardolstephen", "createdAt": "2020-08-24T17:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1OTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470361171", "bodyText": "We are throwing an exception here but maybe we should just log an error and use default values ?", "author": "yojs", "createdAt": "2020-08-14T01:24:51Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -271,4 +294,26 @@ private void loadMetricsDBFilesCleanupEnabled() {\n       shouldCleanupMetricsDBFiles = true;\n     }\n   }\n+\n+  private void loadBatchMetricsRetentionPeriodFromConfig() {\n+    if (!settings.containsKey(BATCH_METRICS_RETENTION_PERIOD)) {\n+      return;\n+    }\n+\n+    long parsedRetentionPeriod;\n+    try {\n+      parsedRetentionPeriod = Long.parseLong(settings.getProperty(BATCH_METRICS_RETENTION_PERIOD));\n+      if (parsedRetentionPeriod <= 0 || parsedRetentionPeriod > BATCH_METRICS_RETENTION_PERIOD_LIMIT) {\n+        throw new InvalidParameterException();", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NTc5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474155796", "bodyText": "Sruti has a PR out,#389 that prevents the Reader from starting if the parsed config is invalid. You can set this to 0 and call ConfigStatus.INSTANCE.setConfigurationInvalid()", "author": "sidheart", "createdAt": "2020-08-20T17:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzMTQxMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475931413", "bodyText": "Joydeep, if any exception is thrown here, the batchMetricsRetentionPeriodMinutes value will not have been modified (since it is in the last line of the try block), and so the default value will be retained. Additionally, the method itself catches the thrown Exception and logs it.", "author": "ricardolstephen", "createdAt": "2020-08-24T22:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzMjIwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475932204", "bodyText": "Sid, Sruti's pr is only about disabling the reader if the config file cannot be found. It was not about disabling the reader if values cannot be correctly parsed from the config file -- using the default value for these cases is the desired behavior.", "author": "ricardolstephen", "createdAt": "2020-08-24T22:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTYyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470361626", "bodyText": "same here. Log error and then we should just use the defaults.\nAlso you can log error simply as:\nLOG.error(\"my error message: {}\", myParam)", "author": "yojs", "createdAt": "2020-08-14T01:26:40Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -271,4 +294,26 @@ private void loadMetricsDBFilesCleanupEnabled() {\n       shouldCleanupMetricsDBFiles = true;\n     }\n   }\n+\n+  private void loadBatchMetricsRetentionPeriodFromConfig() {\n+    if (!settings.containsKey(BATCH_METRICS_RETENTION_PERIOD)) {\n+      return;\n+    }\n+\n+    long parsedRetentionPeriod;\n+    try {\n+      parsedRetentionPeriod = Long.parseLong(settings.getProperty(BATCH_METRICS_RETENTION_PERIOD));\n+      if (parsedRetentionPeriod <= 0 || parsedRetentionPeriod > BATCH_METRICS_RETENTION_PERIOD_LIMIT) {\n+        throw new InvalidParameterException();\n+      }\n+      batchMetricsRetentionPeriod = parsedRetentionPeriod;\n+    } catch (NumberFormatException | InvalidParameterException e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"Invalid batch-metrics-retention-period. Using default value {}.\", batchMetricsRetentionPeriod),\n+              e);", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NjkzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474156935", "bodyText": "^ but LOG.error(\"my error message: {}\", myParam, e) so that you get the exception stacktrace (note that the stacktrace doesn't need a {} string)", "author": "sidheart", "createdAt": "2020-08-20T17:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEyNjc5OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r476126798", "bodyText": "Agreed, updated the error logging call.", "author": "ricardolstephen", "createdAt": "2020-08-25T03:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MzUxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470363515", "bodyText": "The new changes should not crash the system. we should handle this gracefully.\nAlso, can we add javadoc comments to public methods ?", "author": "yojs", "createdAt": "2020-08-14T01:34:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -84,6 +85,15 @@ public MetricsDB(long windowStartTime) throws Exception {\n     create = DSL.using(conn, SQLDialect.SQLITE);\n   }\n \n+  public static MetricsDB fetchExisting(long windowStartTime) throws Exception {\n+    String filePath = PluginSettings.instance()\n+            .getSettingValue(DB_FILE_PREFIX_PATH_CONF_NAME, DB_FILE_PREFIX_PATH_DEFAULT) + windowStartTime;\n+    if (!(new File(filePath)).exists()) {\n+      throw new FileNotFoundException(String.format(\"MetricsDB file %s could not be found.\", filePath));", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4NTU2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475785569", "bodyText": "This change would not crash the system. The QueryBatchRequestHandler (the only place where this is used) catches it exception and handles it appropriately. Also, this code here isn't introducing any new error cases -- it has the same abstraction of throwing an error if there is any issue accessing the file or creating a jdbc connection to it as the MetricsDB constructor.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2MzkxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475863916", "bodyText": "Agreed about the javadocs.", "author": "ricardolstephen", "createdAt": "2020-08-24T20:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MzUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MzczOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470363738", "bodyText": "Can we return empty Object instead of null ?", "author": "yojs", "createdAt": "2020-08-14T01:35:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -239,6 +249,21 @@ public void putMetric(Metric<Double> metric, Dimensions dimensions, long windowS\n     return create.select().from(DSL.table(metric)).fetch();\n   }\n \n+  public Result<Record> queryMetric(String metric, Collection<String> dimensions, int limit) {\n+    if (!DBUtils.checkIfTableExists(create, metric)) {\n+      return null;", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NjQzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r472546430", "bodyText": "We return a null here to stay consistent with the other queryMetric method:\npublic Result queryMetric(List metrics, List aggregations, List dimensions) throws Exception", "author": "ricardolstephen", "createdAt": "2020-08-18T23:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MzczOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2Mzk0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470363949", "bodyText": "This is too late to validate if the limit is negative. Maybe we should do it up in the call handling stack ?", "author": "yojs", "createdAt": "2020-08-14T01:36:38Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -239,6 +249,21 @@ public void putMetric(Metric<Double> metric, Dimensions dimensions, long windowS\n     return create.select().from(DSL.table(metric)).fetch();\n   }\n \n+  public Result<Record> queryMetric(String metric, Collection<String> dimensions, int limit) {\n+    if (!DBUtils.checkIfTableExists(create, metric)) {\n+      return null;\n+    }\n+    if (limit < 0) {\n+      throw new IllegalArgumentException(\"Limit must be non-negative\");", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NDMyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r472544328", "bodyText": "Such a check is enforced multiple times in QueryBatchRequestHandler. The check is also included here in MetricsDB since adding this function expands the API of MetricsDB, and such a check is required for the new expanded API.", "author": "ricardolstephen", "createdAt": "2020-08-18T23:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2Mzk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NzY3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474157674", "bodyText": "call getDBFilePath()", "author": "sidheart", "createdAt": "2020-08-20T17:33:27Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -84,6 +85,15 @@ public MetricsDB(long windowStartTime) throws Exception {\n     create = DSL.using(conn, SQLDialect.SQLITE);\n   }\n \n+  public static MetricsDB fetchExisting(long windowStartTime) throws Exception {\n+    String filePath = PluginSettings.instance()", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MTY3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475781673", "bodyText": "getDBFilePath can't be called from a static context -- it's an instance method that depends on the windowStartTime field.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NzY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNjA3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r479436074", "bodyText": "The way you have it now, the same logic is in 2 different places. Change getDBFilePath to call a function like\nstatic String getActualFilePath(long windowStartTime) {\n// PluginSettings.instance().getSettingValue(...)\n}\nhave getDBFilePath and fetchExisting call this method", "author": "sidheart", "createdAt": "2020-08-28T17:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NzY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2MDMxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481460315", "bodyText": "Sounds reasonable", "author": "ricardolstephen", "createdAt": "2020-09-01T22:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1NzY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1OTcxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474159715", "bodyText": "getDBFilePath()", "author": "sidheart", "createdAt": "2020-08-20T17:36:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -259,6 +284,19 @@ public void deleteOnDiskFile() {\n     }\n   }\n \n+  public static void deleteOnDiskFile(long windowStartTime) {\n+    String dbFilePath = PluginSettings.instance()\n+            .getSettingValue(DB_FILE_PREFIX_PATH_CONF_NAME, DB_FILE_PREFIX_PATH_DEFAULT) + windowStartTime;", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4NjE1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475786157", "bodyText": "getDBFilePath can't be called from a static context -- it's an instance method that depends on the windowStartTime field.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1OTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNzMwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r479437304", "bodyText": "See above", "author": "sidheart", "createdAt": "2020-08-28T17:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE1OTcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE2OTY3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474169678", "bodyText": "Just initialize batchMetricsEnabled to false instead of having 2 variables", "author": "sidheart", "createdAt": "2020-08-20T17:55:19Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -71,6 +82,11 @@\n   private final AppContext appContext;\n   private final ConfigOverridesApplier configOverridesApplier;\n \n+  public static final String BATCH_METRICS_ENABLED_CONF_FILE = \"batch_metrics_enabled.conf\";\n+  private boolean batchMetricsEnabled;\n+  private boolean defaultBatchMetricsEnabled = false;", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3Mzg4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474173881", "bodyText": "by lowest do you mean oldest?", "author": "sidheart", "createdAt": "2020-08-20T18:02:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,41 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    if (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> lowestEntry = metricsDBMap.pollFirstEntry();", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4ODc1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475788758", "bodyText": "Yes, will change the variable names to reflect this.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3Mzg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MDU3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474180571", "bodyText": "This logic should be placed into the trimDatabases function", "author": "sidheart", "createdAt": "2020-08-20T18:15:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,41 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    if (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> lowestEntry = metricsDBMap.pollFirstEntry();\n+      if (lowestEntry != null) {\n+        Long key = lowestEntry.getKey();\n+        MetricsDB value = lowestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5MzY5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475793690", "bodyText": "trimDatabases currently doesn't accept a parameter that would allow us to retain the db if it is in batchMetricsDBSet. trimDatabases could be modified to include such logic. However, such a change wouldn't really contribute much, as trimDatabases is only used in timOldSnapshots. Moving it out of trimOldSnapshots would also not even help with testing, as there are two other different trimming-related procedures in trimOldSnapshots.", "author": "ricardolstephen", "createdAt": "2020-08-24T17:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MDU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDYxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474184616", "bodyText": "Add a comment about why you're using 12 b/c of the 5s snapshots. Also make it evident that the retention period is in minutes", "author": "sidheart", "createdAt": "2020-08-20T18:22:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -696,6 +750,24 @@ public void deleteDBs() throws Exception {\n     }\n   }\n \n+  /**\n+   * This is called by operations outside of the ReaderMetricsProcessor.\n+   *\n+   * @return A list of the timestamps associated with MetricsDB files. The oldest of the MetricsDB files typically\n+   *     have a lifetime of ~SAMPLING_INTERVAL seconds (no less than SAMPLING_INTERVAL/2 seconds). Null if batch\n+   *     metrics is disabled.\n+   */\n+  public NavigableSet<Long> getBatchMetrics() {\n+    if (batchMetricsEnabled) {\n+      TreeSet<Long> batchMetricsDBSetCopy = new TreeSet<>(batchMetricsDBSet.clone());\n+      while (batchMetricsDBSetCopy.size() > PluginSettings.instance().getBatchMetricsRetentionPeriod() * 12) {", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgwMzE5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475803192", "bodyText": "An understanding of the 5s snapshots should be known to the reader of this code. The connection to the 12 should be pretty readily understood.\nAgreed on the minutes unit for the retention period -- the method itself will be renamed to say \"Minutes\". This should further make the connection for the first part obvious.", "author": "ricardolstephen", "createdAt": "2020-08-24T18:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NjcyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474186726", "bodyText": "This should be a while loop", "author": "sidheart", "createdAt": "2020-08-20T18:26:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,41 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    if (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> lowestEntry = metricsDBMap.pollFirstEntry();\n+      if (lowestEntry != null) {\n+        Long key = lowestEntry.getKey();\n+        MetricsDB value = lowestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();\n+        }\n+      }\n+    }\n+    // Flush any tracking batch metrics if batch metrics is disabled. Note, in order to ensure that batch metrics\n+    // consumers have had at least one cycle to use any metrics they may be holding, this flush is done before\n+    // re-reading the config file to update the state of the batch metrics feature.\n+    if (!batchMetricsEnabled && !batchMetricsDBSet.isEmpty()) {\n+      if (deleteDBFiles) {\n+        for (Long timestamp : batchMetricsDBSet) {\n+          if (!metricsDBMap.containsKey(timestamp)) {\n+            MetricsDB.deleteOnDiskFile(timestamp);\n+          }\n+        }\n+      }\n+      batchMetricsDBSet.clear();\n+    }\n+    readBatchMetricsEnabledFromConf();\n+    // The (retentionPeriod * 12 + 1)'th database can be safely removed, since getBatchMetrics never returns more than\n+    // the (retentionPeriod * 12) freshest metrics files.\n+    if (batchMetricsDBSet.size() > PluginSettings.instance().getBatchMetricsRetentionPeriod() * 12 + 1) {\n+      Long timestamp = batchMetricsDBSet.pollFirst();\n+      if (deleteDBFiles && !metricsDBMap.containsKey(timestamp)) {\n+        MetricsDB.deleteOnDiskFile(timestamp);\n+      }", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5NTI2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475795269", "bodyText": "Agreed", "author": "ricardolstephen", "createdAt": "2020-08-24T17:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NzAxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r474187014", "bodyText": "This should be a while loop", "author": "sidheart", "createdAt": "2020-08-20T18:27:15Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,41 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    if (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> lowestEntry = metricsDBMap.pollFirstEntry();\n+      if (lowestEntry != null) {\n+        Long key = lowestEntry.getKey();\n+        MetricsDB value = lowestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();\n+        }\n+      }", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc5NTE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r475795171", "bodyText": "Agreed", "author": "ricardolstephen", "createdAt": "2020-08-24T17:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NzAxNA=="}], "type": "inlineReview"}, {"oid": "078693bb1f3744c0d1d7e2f1eec5cb6a9002c5ed", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/078693bb1f3744c0d1d7e2f1eec5cb6a9002c5ed", "message": "Add time unit to the batch-metrics-retention-period variable", "committedDate": "2020-08-24T17:22:27Z", "type": "commit"}, {"oid": "dc1e23735ec9dde2468070dd47cd24891718eb29", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dc1e23735ec9dde2468070dd47cd24891718eb29", "message": "Add more documentation", "committedDate": "2020-08-24T20:05:09Z", "type": "commit"}, {"oid": "23d3e1c35c47104b2b90dedad5f2dfae903d22c7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/23d3e1c35c47104b2b90dedad5f2dfae903d22c7", "message": "Use while loops in trimOldSnapshots", "committedDate": "2020-08-24T20:05:42Z", "type": "commit"}, {"oid": "f732e1398fddf965273b61ed7704fed0544f567a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f732e1398fddf965273b61ed7704fed0544f567a", "message": "Use default batch metrics enabled value if unable to read the conf file", "committedDate": "2020-08-24T22:24:01Z", "type": "commit"}, {"oid": "8ae238206d3db960c8d4ce28c1dfa6ef2fdeaeaf", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8ae238206d3db960c8d4ce28c1dfa6ef2fdeaeaf", "message": "Cleanup declaration of parsedRetentionPeriod", "committedDate": "2020-08-24T22:30:46Z", "type": "commit"}, {"oid": "9bc6a141d7bc7f68957da3016a175a924a67f263", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9bc6a141d7bc7f68957da3016a175a924a67f263", "message": "Fix error string for when max datapoints is exceeded", "committedDate": "2020-08-25T02:56:54Z", "type": "commit"}, {"oid": "e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "message": "Cleanup error logging call", "committedDate": "2020-08-25T03:44:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NDIwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r479454205", "bodyText": "Your documentation says we round down, but this is rounding up right? I don't care which you go with, but make it consistent.", "author": "sidheart", "createdAt": "2020-08-28T17:55:24Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD = 5000;  // Must be a multiple of 5000\n+\n+  public QueryBatchRequestHandler(NetClient netClient, MetricsRestUtil metricsRestUtil) {\n+    this.netClient = netClient;\n+    this.metricsRestUtil = metricsRestUtil;\n+  }\n+\n+  @Override\n+  public void handle(HttpExchange exchange) throws IOException {\n+    String requestMethod = exchange.getRequestMethod();\n+    if (!requestMethod.equalsIgnoreCase(\"GET\")) {\n+      exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+      exchange.close();\n+      return;\n+    }\n+\n+    ReaderMetricsProcessor mp = ReaderMetricsProcessor.getInstance();\n+    if (mp == null) {\n+      sendResponse(\n+          exchange,\n+          \"{\\\"error\\\":\\\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\\\"}\",\n+          HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    NavigableSet<Long> batchMetrics = mp.getBatchMetrics();\n+    long currentTime = System.currentTimeMillis();\n+    if (batchMetrics == null) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"The batch metrics api has not been enabled for this node.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"The batch metrics api has not been enabled for this node.\");\n+      return;\n+    }\n+    if (batchMetrics.isEmpty()) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"There are no metrics databases. The reader has run into an issue or has just started.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"There are no metrics databases. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+    Map<String, String> params = getParamsMap(exchange.getRequestURI().getQuery());\n+\n+    try {\n+      // Parse and validate parameters\n+      String[] validParamsTmp = {\"\", \"metrics\", \"starttime\", \"endtime\", \"samplingperiod\", \"maxdatapoints\"};\n+      Set<String> validParams = new HashSet<>(Arrays.asList(validParamsTmp));\n+      for (String param : params.keySet()) {\n+        if (!validParams.contains(param)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid parameter\", param));\n+        }\n+      }\n+\n+      List<String> metrics = metricsRestUtil.parseArrayParam(params, \"metrics\", false);\n+      String startTimeParam = params.get(\"starttime\");\n+      String endTimeParam = params.get(\"endtime\");\n+      String samplingPeriodParam = params.get(\"samplingperiod\");\n+\n+      for (String metric : metrics) {\n+        if (!MetricsModel.ALL_METRICS.containsKey(metric)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid metric\", metric));\n+        }\n+      }\n+\n+      if (startTimeParam == null || startTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"starttime parameter must be set\");\n+      }\n+      long startTime;\n+      try {\n+        startTime = Long.parseUnsignedLong(startTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid starttime\", startTimeParam));\n+      }\n+\n+      if (endTimeParam == null || endTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"endtime parameter must be set\");\n+      }\n+      long endTime;\n+      try {\n+        endTime = Long.parseUnsignedLong(endTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid endtime\", endTimeParam));\n+      }\n+\n+      long samplingPeriod = DEFAULT_SAMPLING_PERIOD;\n+      if (samplingPeriodParam != null && !samplingPeriodParam.isEmpty()) {\n+        samplingPeriod = Long.parseLong(samplingPeriodParam);\n+        if (samplingPeriod < 5 || samplingPeriod % 5 != 0) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid sampling period\", samplingPeriodParam));\n+        }\n+        if (samplingPeriod >= PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60) {\n+          throw new InvalidParameterException(\"sampling period must be less than the retention period\");\n+        }\n+        samplingPeriod *= 1000;\n+      }\n+\n+      if (startTime >= endTime) {\n+        throw new InvalidParameterException(\"starttime must be less than the endtime\");\n+      }\n+      startTime -= startTime % samplingPeriod;\n+      endTime -= endTime % samplingPeriod;\n+      if (startTime == endTime) {\n+        throw new InvalidParameterException(\"starttime and endtime cannot be equal when rounded down to the nearest sampling period\");\n+      }\n+      if (endTime > currentTime) {\n+        throw new InvalidParameterException(\"endtime can be no greater than the system time at the node\");\n+      }\n+      if (startTime < currentTime - PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60 * 1000) {\n+        throw new InvalidParameterException(\"starttime must be within the retention period\");\n+      }\n+\n+      String queryResponse = queryFromBatchMetrics(batchMetrics, metrics, startTime, endTime, samplingPeriod,\n+              DEFAULT_MAX_DATAPOINTS);\n+      sendResponse(exchange, queryResponse, HttpURLConnection.HTTP_OK);\n+    } catch (InvalidParameterException e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \".\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+    } catch (Exception e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  public int appendMetrics(Long timestamp, List<String> metrics, StringBuilder builder, int maxDatapoints) throws Exception {\n+    maxDatapoints += 1;\n+    builder.append(\"\\\"\");\n+    builder.append(timestamp);\n+    builder.append(\"\\\":{\");\n+    MetricsDB db = MetricsDB.fetchExisting(timestamp);\n+    for (int metricIndex = 0, numMetrics = metrics.size(); metricIndex < numMetrics; metricIndex++) {\n+      String metric = metrics.get(metricIndex);\n+      Result<Record> results = db.queryMetric(metric, MetricsModel.ALL_METRICS.get(metric).dimensionNames, maxDatapoints);\n+      if (results != null) {\n+        maxDatapoints -= results.size();\n+        if (maxDatapoints == 0) {\n+          throw new InvalidParameterException(String.format(\"requested data exceeds the %d datapoints limit\", DEFAULT_MAX_DATAPOINTS));\n+        }\n+        builder.append(\"\\\"\");\n+        builder.append(metric);\n+        builder.append(\"\\\":\");\n+        builder.append(results.formatJSON());\n+        for (metricIndex += 1; metricIndex < numMetrics; metricIndex++) {\n+          metric = metrics.get(metricIndex);\n+          results = db.queryMetric(metric, MetricsModel.ALL_METRICS.get(metric).dimensionNames, maxDatapoints);\n+          if (results != null) {\n+            maxDatapoints -= results.size();\n+            if (maxDatapoints == 0) {\n+              throw new InvalidParameterException(String.format(\"requested data exceeds the %d datapoints limit\", DEFAULT_MAX_DATAPOINTS));\n+            }\n+            builder.append(\",\\\"\");\n+            builder.append(metric);\n+            builder.append(\"\\\":\");\n+            builder.append(results.formatJSON());\n+          }\n+        }\n+      }\n+    }\n+    builder.append(\"}\");\n+    db.remove();\n+    return maxDatapoints - 1;\n+  }\n+\n+  /**\n+   * Requires non-empty batchMetrics, valid non-empty metrics, valid startTime, valid endTime,\n+   * valid samplingPeriod (in milliseconds), and non-negative maxDatapoints.\n+   */\n+  @VisibleForTesting\n+  public String queryFromBatchMetrics(NavigableSet<Long> batchMetrics, List<String> metrics, long startTime,\n+                                      long endTime, long samplingPeriod, int maxDatapoints) throws Exception {\n+    StringBuilder responseJson = new StringBuilder();\n+    responseJson.append(\"{\");\n+    Long metricsTimestamp = batchMetrics.ceiling(startTime);\n+    if (metricsTimestamp != null && metricsTimestamp < endTime) {\n+      maxDatapoints = appendMetrics(metricsTimestamp, metrics, responseJson, maxDatapoints);\n+      metricsTimestamp = metricsTimestamp - metricsTimestamp % samplingPeriod + samplingPeriod;\n+      metricsTimestamp = batchMetrics.ceiling(metricsTimestamp);\n+      while (metricsTimestamp != null && metricsTimestamp < endTime) {\n+        responseJson.append(\",\");\n+        maxDatapoints = appendMetrics(metricsTimestamp, metrics, responseJson, maxDatapoints);\n+        metricsTimestamp = metricsTimestamp - metricsTimestamp % samplingPeriod + samplingPeriod;\n+        metricsTimestamp = batchMetrics.ceiling(metricsTimestamp);", "originalCommit": "e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTE1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481469158", "bodyText": "This is round down.", "author": "ricardolstephen", "createdAt": "2020-09-01T22:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUyODI5OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481528298", "bodyText": "If metricsTimestamp is 1 with a samplingPeriod of 5 then the new metricsTimestamp becomes 5 and you return all metrics with a timestamp bigger than 5. How is that rounding down? Is this what you intended?", "author": "sidheart", "createdAt": "2020-09-02T01:29:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NDIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM2MTA1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483361058", "bodyText": "The starttime and enddtime's supplied by the user are rounded down in line 193-194. The code here is for when you're calculating all the timestamps you want to collect data from.\nThis is what the code here does:\n\nmetricsTimestamp = 0, samplingperiod = 30\nLine 292 -> metricsTimestamp = 30\nLine 293 -> metricsTimestamp = 65 (imagine the data between 30-60 is missing).\nNext cycle\nLine 292 -> metricsTimestamp = 90\n...", "author": "ricardolstephen", "createdAt": "2020-09-04T03:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NDIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r479539027", "bodyText": "I've already commented on this to Ricardo. I think it's better to avoid tight coupling between the JSON response construction and the actual sampling and querying of the metrics.\nHowever, since today there are no components that would actually need the batching logic outside of the REST layer, and since this is an L0 solution, I've said that I'd note my concern here and +1.", "author": "sidheart", "createdAt": "2020-08-28T21:18:49Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD = 5000;  // Must be a multiple of 5000\n+\n+  public QueryBatchRequestHandler(NetClient netClient, MetricsRestUtil metricsRestUtil) {\n+    this.netClient = netClient;\n+    this.metricsRestUtil = metricsRestUtil;\n+  }\n+\n+  @Override\n+  public void handle(HttpExchange exchange) throws IOException {\n+    String requestMethod = exchange.getRequestMethod();\n+    if (!requestMethod.equalsIgnoreCase(\"GET\")) {\n+      exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+      exchange.close();\n+      return;\n+    }\n+\n+    ReaderMetricsProcessor mp = ReaderMetricsProcessor.getInstance();\n+    if (mp == null) {\n+      sendResponse(\n+          exchange,\n+          \"{\\\"error\\\":\\\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\\\"}\",\n+          HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    NavigableSet<Long> batchMetrics = mp.getBatchMetrics();\n+    long currentTime = System.currentTimeMillis();\n+    if (batchMetrics == null) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"The batch metrics api has not been enabled for this node.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"The batch metrics api has not been enabled for this node.\");\n+      return;\n+    }\n+    if (batchMetrics.isEmpty()) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"There are no metrics databases. The reader has run into an issue or has just started.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"There are no metrics databases. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+    Map<String, String> params = getParamsMap(exchange.getRequestURI().getQuery());\n+\n+    try {\n+      // Parse and validate parameters\n+      String[] validParamsTmp = {\"\", \"metrics\", \"starttime\", \"endtime\", \"samplingperiod\", \"maxdatapoints\"};\n+      Set<String> validParams = new HashSet<>(Arrays.asList(validParamsTmp));\n+      for (String param : params.keySet()) {\n+        if (!validParams.contains(param)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid parameter\", param));\n+        }\n+      }\n+\n+      List<String> metrics = metricsRestUtil.parseArrayParam(params, \"metrics\", false);\n+      String startTimeParam = params.get(\"starttime\");\n+      String endTimeParam = params.get(\"endtime\");\n+      String samplingPeriodParam = params.get(\"samplingperiod\");\n+\n+      for (String metric : metrics) {\n+        if (!MetricsModel.ALL_METRICS.containsKey(metric)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid metric\", metric));\n+        }\n+      }\n+\n+      if (startTimeParam == null || startTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"starttime parameter must be set\");\n+      }\n+      long startTime;\n+      try {\n+        startTime = Long.parseUnsignedLong(startTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid starttime\", startTimeParam));\n+      }\n+\n+      if (endTimeParam == null || endTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"endtime parameter must be set\");\n+      }\n+      long endTime;\n+      try {\n+        endTime = Long.parseUnsignedLong(endTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid endtime\", endTimeParam));\n+      }\n+\n+      long samplingPeriod = DEFAULT_SAMPLING_PERIOD;\n+      if (samplingPeriodParam != null && !samplingPeriodParam.isEmpty()) {\n+        samplingPeriod = Long.parseLong(samplingPeriodParam);\n+        if (samplingPeriod < 5 || samplingPeriod % 5 != 0) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid sampling period\", samplingPeriodParam));\n+        }\n+        if (samplingPeriod >= PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60) {\n+          throw new InvalidParameterException(\"sampling period must be less than the retention period\");\n+        }\n+        samplingPeriod *= 1000;\n+      }\n+\n+      if (startTime >= endTime) {\n+        throw new InvalidParameterException(\"starttime must be less than the endtime\");\n+      }\n+      startTime -= startTime % samplingPeriod;\n+      endTime -= endTime % samplingPeriod;\n+      if (startTime == endTime) {\n+        throw new InvalidParameterException(\"starttime and endtime cannot be equal when rounded down to the nearest sampling period\");\n+      }\n+      if (endTime > currentTime) {\n+        throw new InvalidParameterException(\"endtime can be no greater than the system time at the node\");\n+      }\n+      if (startTime < currentTime - PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60 * 1000) {\n+        throw new InvalidParameterException(\"starttime must be within the retention period\");\n+      }\n+\n+      String queryResponse = queryFromBatchMetrics(batchMetrics, metrics, startTime, endTime, samplingPeriod,\n+              DEFAULT_MAX_DATAPOINTS);\n+      sendResponse(exchange, queryResponse, HttpURLConnection.HTTP_OK);\n+    } catch (InvalidParameterException e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \".\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+    } catch (Exception e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  public int appendMetrics(Long timestamp, List<String> metrics, StringBuilder builder, int maxDatapoints) throws Exception {\n+    maxDatapoints += 1;\n+    builder.append(\"\\\"\");\n+    builder.append(timestamp);\n+    builder.append(\"\\\":{\");\n+    MetricsDB db = MetricsDB.fetchExisting(timestamp);\n+    for (int metricIndex = 0, numMetrics = metrics.size(); metricIndex < numMetrics; metricIndex++) {\n+      String metric = metrics.get(metricIndex);\n+      Result<Record> results = db.queryMetric(metric, MetricsModel.ALL_METRICS.get(metric).dimensionNames, maxDatapoints);\n+      if (results != null) {\n+        maxDatapoints -= results.size();\n+        if (maxDatapoints == 0) {\n+          throw new InvalidParameterException(String.format(\"requested data exceeds the %d datapoints limit\", DEFAULT_MAX_DATAPOINTS));\n+        }\n+        builder.append(\"\\\"\");\n+        builder.append(metric);\n+        builder.append(\"\\\":\");\n+        builder.append(results.formatJSON());\n+        for (metricIndex += 1; metricIndex < numMetrics; metricIndex++) {\n+          metric = metrics.get(metricIndex);\n+          results = db.queryMetric(metric, MetricsModel.ALL_METRICS.get(metric).dimensionNames, maxDatapoints);\n+          if (results != null) {\n+            maxDatapoints -= results.size();\n+            if (maxDatapoints == 0) {\n+              throw new InvalidParameterException(String.format(\"requested data exceeds the %d datapoints limit\", DEFAULT_MAX_DATAPOINTS));\n+            }\n+            builder.append(\",\\\"\");\n+            builder.append(metric);", "originalCommit": "e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTE1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r479539154", "bodyText": "Does anyone else have a strong opinion on this? @yojs @vigyasharma", "author": "sidheart", "createdAt": "2020-08-28T21:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyNjAzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r480226039", "bodyText": "+1. why do we have to manually construct the json? Can't we just have a Batch Metrics Response object and use libraries to parse it into json strings?", "author": "vigyasharma", "createdAt": "2020-08-31T15:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3Mjg5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481472890", "bodyText": "If we find a use for such decoupling, perhaps we can modify the implementation with such changes. However, for now, this approach will work, and it removes the need for additional investigation (for example, this would increase processing time, and stringifying a Batch Metrics Response object would double the peak memory usage of this component).", "author": "ricardolstephen", "createdAt": "2020-09-01T22:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NjM3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485076375", "bodyText": "Constructing Json by hand is tedious and error prone. Maybe you can look at HotNodeSummary::toJson() to get a feel for the library that can help you do it much easily.", "author": "yojs", "createdAt": "2020-09-08T17:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMDI1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485230259", "bodyText": "I agree with joydeep and sid. There are standard tested libraries that we should leverage. Can move to a separate PR as a follow up.", "author": "vigyasharma", "createdAt": "2020-09-08T22:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxODI3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485718271", "bodyText": "Sure, will raise a new enhancement issue about it #416", "author": "ricardolstephen", "createdAt": "2020-09-09T15:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUzOTAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyMDcyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r480220723", "bodyText": "nit: indicate this is in millis", "author": "vigyasharma", "createdAt": "2020-08-31T15:46:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD = 5000;  // Must be a multiple of 5000", "originalCommit": "e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3Mzg2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481473868", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-01T22:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyMDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyNDcyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r480224728", "bodyText": "Can results.size() be > maxDatapoints ? Can DEFAULT_MAX_DATAPOINTS be overridden by any config (in which case we should use the derived limit in msg or simply maxDatapoints) ?", "author": "vigyasharma", "createdAt": "2020-08-31T15:53:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD = 5000;  // Must be a multiple of 5000\n+\n+  public QueryBatchRequestHandler(NetClient netClient, MetricsRestUtil metricsRestUtil) {\n+    this.netClient = netClient;\n+    this.metricsRestUtil = metricsRestUtil;\n+  }\n+\n+  @Override\n+  public void handle(HttpExchange exchange) throws IOException {\n+    String requestMethod = exchange.getRequestMethod();\n+    if (!requestMethod.equalsIgnoreCase(\"GET\")) {\n+      exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+      exchange.close();\n+      return;\n+    }\n+\n+    ReaderMetricsProcessor mp = ReaderMetricsProcessor.getInstance();\n+    if (mp == null) {\n+      sendResponse(\n+          exchange,\n+          \"{\\\"error\\\":\\\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\\\"}\",\n+          HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    NavigableSet<Long> batchMetrics = mp.getBatchMetrics();\n+    long currentTime = System.currentTimeMillis();\n+    if (batchMetrics == null) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"The batch metrics api has not been enabled for this node.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"The batch metrics api has not been enabled for this node.\");\n+      return;\n+    }\n+    if (batchMetrics.isEmpty()) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"There are no metrics databases. The reader has run into an issue or has just started.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"There are no metrics databases. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+    Map<String, String> params = getParamsMap(exchange.getRequestURI().getQuery());\n+\n+    try {\n+      // Parse and validate parameters\n+      String[] validParamsTmp = {\"\", \"metrics\", \"starttime\", \"endtime\", \"samplingperiod\", \"maxdatapoints\"};\n+      Set<String> validParams = new HashSet<>(Arrays.asList(validParamsTmp));\n+      for (String param : params.keySet()) {\n+        if (!validParams.contains(param)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid parameter\", param));\n+        }\n+      }\n+\n+      List<String> metrics = metricsRestUtil.parseArrayParam(params, \"metrics\", false);\n+      String startTimeParam = params.get(\"starttime\");\n+      String endTimeParam = params.get(\"endtime\");\n+      String samplingPeriodParam = params.get(\"samplingperiod\");\n+\n+      for (String metric : metrics) {\n+        if (!MetricsModel.ALL_METRICS.containsKey(metric)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid metric\", metric));\n+        }\n+      }\n+\n+      if (startTimeParam == null || startTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"starttime parameter must be set\");\n+      }\n+      long startTime;\n+      try {\n+        startTime = Long.parseUnsignedLong(startTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid starttime\", startTimeParam));\n+      }\n+\n+      if (endTimeParam == null || endTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"endtime parameter must be set\");\n+      }\n+      long endTime;\n+      try {\n+        endTime = Long.parseUnsignedLong(endTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid endtime\", endTimeParam));\n+      }\n+\n+      long samplingPeriod = DEFAULT_SAMPLING_PERIOD;\n+      if (samplingPeriodParam != null && !samplingPeriodParam.isEmpty()) {\n+        samplingPeriod = Long.parseLong(samplingPeriodParam);\n+        if (samplingPeriod < 5 || samplingPeriod % 5 != 0) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid sampling period\", samplingPeriodParam));\n+        }\n+        if (samplingPeriod >= PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60) {\n+          throw new InvalidParameterException(\"sampling period must be less than the retention period\");\n+        }\n+        samplingPeriod *= 1000;\n+      }\n+\n+      if (startTime >= endTime) {\n+        throw new InvalidParameterException(\"starttime must be less than the endtime\");\n+      }\n+      startTime -= startTime % samplingPeriod;\n+      endTime -= endTime % samplingPeriod;\n+      if (startTime == endTime) {\n+        throw new InvalidParameterException(\"starttime and endtime cannot be equal when rounded down to the nearest sampling period\");\n+      }\n+      if (endTime > currentTime) {\n+        throw new InvalidParameterException(\"endtime can be no greater than the system time at the node\");\n+      }\n+      if (startTime < currentTime - PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60 * 1000) {\n+        throw new InvalidParameterException(\"starttime must be within the retention period\");\n+      }\n+\n+      String queryResponse = queryFromBatchMetrics(batchMetrics, metrics, startTime, endTime, samplingPeriod,\n+              DEFAULT_MAX_DATAPOINTS);\n+      sendResponse(exchange, queryResponse, HttpURLConnection.HTTP_OK);\n+    } catch (InvalidParameterException e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \".\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+    } catch (Exception e) {\n+      LOG.error(\n+              (Supplier<?>)\n+                      () ->\n+                              new ParameterizedMessage(\n+                                      \"QueryException {} ExceptionCode: {}.\",\n+                                      e.toString(),\n+                                      StatExceptionCode.REQUEST_ERROR.toString()),\n+              e);\n+      StatsCollector.instance().logException(StatExceptionCode.REQUEST_ERROR);\n+      String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+      sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  public int appendMetrics(Long timestamp, List<String> metrics, StringBuilder builder, int maxDatapoints) throws Exception {\n+    maxDatapoints += 1;\n+    builder.append(\"\\\"\");\n+    builder.append(timestamp);\n+    builder.append(\"\\\":{\");\n+    MetricsDB db = MetricsDB.fetchExisting(timestamp);\n+    for (int metricIndex = 0, numMetrics = metrics.size(); metricIndex < numMetrics; metricIndex++) {\n+      String metric = metrics.get(metricIndex);\n+      Result<Record> results = db.queryMetric(metric, MetricsModel.ALL_METRICS.get(metric).dimensionNames, maxDatapoints);\n+      if (results != null) {\n+        maxDatapoints -= results.size();\n+        if (maxDatapoints == 0) {\n+          throw new InvalidParameterException(String.format(\"requested data exceeds the %d datapoints limit\", DEFAULT_MAX_DATAPOINTS));\n+        }", "originalCommit": "e2f856bf687d4749dc4d3ebec026aa0a6b06c2ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3ODE3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r481478176", "bodyText": "results.size() cannot be  cannot be > maxDatapoints, since maxDatapoints is supplied as the limit when invoking db.queryMetric.\nDEFAULT_MAX_DATAPOINTS cannot be overridden. It is an internal safeguard to ensure that the user does not break their system by exceeding a memory limit. Even if we allowed the user to configure the max datapoints, we would still need an internal limit to ensure no excessive values are supplied. Until more clear internal limits are identified, we ought to leave configurability off the table in favor of safety. Additionally, these changes may further be obviated if pagination is introduced in the future.", "author": "ricardolstephen", "createdAt": "2020-09-01T23:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyNDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyOTI0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485229246", "bodyText": "What I meant was that if (maxDatapoints == 0) is a very exact check. We might want <= instead?", "author": "vigyasharma", "createdAt": "2020-09-08T22:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyNDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MzY3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485253678", "bodyText": "Logically, maxDatapoints should never be less than zero. But, sure.", "author": "ricardolstephen", "createdAt": "2020-09-08T23:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIyNDcyOA=="}], "type": "inlineReview"}, {"oid": "f1008f0ef3b58433b9fd77ab95e3c4a8a70fae31", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f1008f0ef3b58433b9fd77ab95e3c4a8a70fae31", "message": "Add a common method for getting MetricsDB file paths", "committedDate": "2020-09-01T22:16:55Z", "type": "commit"}, {"oid": "e687a8cddadaea9f70b700688d18e9b9360eae51", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e687a8cddadaea9f70b700688d18e9b9360eae51", "message": "Rename DEFAULT_SAMPLING_PERIOD to include MILLIS", "committedDate": "2020-09-01T22:47:25Z", "type": "commit"}, {"oid": "563905e58200952a10e150dc5956112d2a502fe6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/563905e58200952a10e150dc5956112d2a502fe6", "message": "Remove maxdatapoints query parameter", "committedDate": "2020-09-04T02:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NTYxOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r470365619", "bodyText": "Looks like this is only being called from methods that are themselves marked as VisibleForTesting. Can we mark this as such as well ?", "author": "yojs", "createdAt": "2020-08-14T01:44:03Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -84,6 +85,15 @@ public MetricsDB(long windowStartTime) throws Exception {\n     create = DSL.using(conn, SQLDialect.SQLITE);\n   }\n \n+  public static MetricsDB fetchExisting(long windowStartTime) throws Exception {", "originalCommit": "74933f9a57ce33f391fdaedac0875c5058587995", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MjQyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483862429", "bodyText": "We only marked those other callers as \"VisibleForTesting\" because we expanded their visibility from private to public simply for the sake of testing. However, even if they were private, this method would have to have public visibility for them to be able to access it.", "author": "ricardolstephen", "createdAt": "2020-09-04T22:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3OTIyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485079226", "bodyText": "That might be misleading. That method should not be called from anywhere in the code other than tests. For your usecase, you can make that protected and then have a wrapper Test class that exposes it over a public interface for tests only ?", "author": "yojs", "createdAt": "2020-09-08T17:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgxMjI0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485812246", "bodyText": "Will address this by making the target methods private and exposing them via VisibleForTesting shims.", "author": "ricardolstephen", "createdAt": "2020-09-09T18:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNjMxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483836315", "bodyText": "I think that we should log error and use the default in this case. I would think of it as should I bail out of PA if someone configures a wrong value for batch metric retention period ?", "author": "yojs", "createdAt": "2020-09-04T20:43:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -271,4 +295,21 @@ private void loadMetricsDBFilesCleanupEnabled() {\n       shouldCleanupMetricsDBFiles = true;\n     }\n   }\n+\n+  private void loadBatchMetricsRetentionPeriodMinutesFromConfig() {\n+    if (!settings.containsKey(BATCH_METRICS_RETENTION_PERIOD_MINUTES)) {\n+      return;\n+    }\n+\n+    try {\n+      long parsedRetentionPeriod = Long.parseLong(settings.getProperty(BATCH_METRICS_RETENTION_PERIOD_MINUTES));\n+      if (parsedRetentionPeriod <= 0 || parsedRetentionPeriod > BATCH_METRICS_RETENTION_PERIOD_MINUTES_LIMIT) {\n+        throw new InvalidParameterException();", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MjkzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483862930", "bodyText": "That is what this code does. batchMetricsRetentionPeriodMinutes was assigned a default value in the ctor. The code here only updates that value if it was able to properly parse a new valid value from the properties file.", "author": "ricardolstephen", "createdAt": "2020-09-04T22:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MDU2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485080568", "bodyText": "Right, so you don't need to throw a InvalidParameterException, you can simple return ?", "author": "yojs", "createdAt": "2020-09-08T17:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5OTg1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485099854", "bodyText": "I am throwing an InvalidParameterException so I can catch it (along with the NumberFormatException that may be thrown by Long.parseLong) and log the error.", "author": "ricardolstephen", "createdAt": "2020-09-08T17:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNjMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExMjcyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485112725", "bodyText": "But yeah, it seems like it might be more appropriate to just give more user-friendly information about the value being out of range, like loadMetricsDeletionIntervalFromConfig is.", "author": "ricardolstephen", "createdAt": "2020-09-08T18:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgzNjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0MzM1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483843353", "bodyText": "can we please make all method names camelCase ?", "author": "yojs", "createdAt": "2020-09-04T21:04:32Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandlerTest.java", "diffHunk": "@@ -0,0 +1,516 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor.BATCH_METRICS_ENABLED_CONF_FILE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.core.Util;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsConfiguration;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.Dimensions;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.sun.net.httpserver.Headers;\n+import com.sun.net.httpserver.HttpExchange;\n+\n+import java.io.File;\n+import java.io.FilenameFilter;\n+import java.io.IOException;\n+import java.net.HttpURLConnection;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.InvalidParameterException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.NavigableSet;\n+import java.util.TreeSet;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.mockito.ArgumentMatchers;\n+import org.mockito.Mockito;\n+\n+public class QueryBatchRequestHandlerTest {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MzY0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483863645", "bodyText": "The naming here makes use of the conventions outlined here:\nhttps://google.github.io/styleguide/javaguide.html#s5.2.3-method-names\nThere is also precedence here:\nhttps://github.com/opendistro-for-elasticsearch/performance-analyzer/blob/master/src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/http_action/config/PerformanceAnalyzerResourceProviderTest.java", "author": "ricardolstephen", "createdAt": "2020-09-04T22:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0MzM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MjIzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483852233", "bodyText": "Will calling it the latest metricDB file be more appropriate ?", "author": "yojs", "createdAt": "2020-09-04T21:33:41Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -84,6 +89,21 @@ public MetricsDB(long windowStartTime) throws Exception {\n     create = DSL.using(conn, SQLDialect.SQLITE);\n   }\n \n+  /**\n+   * Returns a MetricsDB handle associated with an existing metricsdb file.", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2ODQ1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483868452", "bodyText": "It would not. There may be 30 metricsdb files on disk. The user would call this method with the timestamp associated with one of them, and this method would return a MetricsDB handle to that file.", "author": "ricardolstephen", "createdAt": "2020-09-04T22:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MjIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1Mjg4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483852883", "bodyText": "It might be more appropriate to say throws FileNotFoundException instead of throws Exception. Thoughts ?", "author": "yojs", "createdAt": "2020-09-04T21:35:48Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -84,6 +89,21 @@ public MetricsDB(long windowStartTime) throws Exception {\n     create = DSL.using(conn, SQLDialect.SQLITE);\n   }\n \n+  /**\n+   * Returns a MetricsDB handle associated with an existing metricsdb file.\n+   *\n+   * @param windowStartTime the timestamp associated with an existing metricsdb file\n+   * @return a MetricsDB handle associated with the metricsdb file\n+   * @throws Exception if the metricsdb file does not exist or is invalid\n+   */\n+  public static MetricsDB fetchExisting(long windowStartTime) throws Exception {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2ODcwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483868701", "bodyText": "It would not. This method makes use of the MetricsDB ctor, which throws an Exception if there is some issue creating a connection to that file (like if the file is corrupt or something).", "author": "ricardolstephen", "createdAt": "2020-09-04T22:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1Mjg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MzIyMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483853220", "bodyText": "All SQLite queries can throw DataExcessException. We might want to add it to the method signature ?", "author": "yojs", "createdAt": "2020-09-04T21:36:50Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -235,10 +255,39 @@ public void putMetric(Metric<Double> metric, Dimensions dimensions, long windowS\n     return create.select(allFields).from(finalTable).groupBy(groupByFields).fetch();\n   }\n \n+  /**\n+   * Queries all the data associated with the given metric.\n+   *\n+   * @param metric the desired metric\n+   * @return the result of the query\n+   */\n   public Result<Record> queryMetric(String metric) {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MDMwMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483880300", "bodyText": "That method is not part of this PR. Just some additional documentation was added. Will open a new ticket about it: #412", "author": "ricardolstephen", "createdAt": "2020-09-04T23:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MzQyNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483853424", "bodyText": "In this case we might want to also check before querying the SQL if the metric is a valid metric name.", "author": "yojs", "createdAt": "2020-09-04T21:37:38Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -235,10 +255,39 @@ public void putMetric(Metric<Double> metric, Dimensions dimensions, long windowS\n     return create.select(allFields).from(finalTable).groupBy(groupByFields).fetch();\n   }\n \n+  /**\n+   * Queries all the data associated with the given metric.\n+   *\n+   * @param metric the desired metric\n+   * @return the result of the query\n+   */\n   public Result<Record> queryMetric(String metric) {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MDQ4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483880486", "bodyText": "That method is not part of this PR. Just some additional documentation was added. Will open a new ticket about it: #412", "author": "ricardolstephen", "createdAt": "2020-09-04T23:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MzQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1Mzg4OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483853888", "bodyText": "throws DataAccessException ?", "author": "yojs", "createdAt": "2020-09-04T21:39:19Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -235,10 +255,39 @@ public void putMetric(Metric<Double> metric, Dimensions dimensions, long windowS\n     return create.select(allFields).from(finalTable).groupBy(groupByFields).fetch();\n   }\n \n+  /**\n+   * Queries all the data associated with the given metric.\n+   *\n+   * @param metric the desired metric\n+   * @return the result of the query\n+   */\n   public Result<Record> queryMetric(String metric) {\n     return create.select().from(DSL.table(metric)).fetch();\n   }\n \n+  /**\n+   * Queries all the data associated with a given metric.\n+   *\n+   * @param metric the desired metric\n+   * @param dimensions the dimensions we want to return for the given metric\n+   * @param limit the maximum number of records to return\n+   * @return the result of the query\n+   */\n+  public Result<Record> queryMetric(String metric, Collection<String> dimensions, int limit) {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MDc3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483880772", "bodyText": "Agreed.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1Mzg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483855252", "bodyText": "Before calling delete, it might be good idea to check for the existence of the file itself or we can call deleteIfExists?", "author": "yojs", "createdAt": "2020-09-04T21:44:14Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -259,6 +308,23 @@ public void deleteOnDiskFile() {\n     }\n   }\n \n+  /**\n+   * Deletes the metricsdb file associated with the given timestamp if it exists.\n+   *\n+   * @param windowStartTime the timestamp associated with an existing metricsdb file\n+   */\n+  public static void deleteOnDiskFile(long windowStartTime) {\n+    String dbFilePath = getDBFilePath(windowStartTime);\n+    File dbFile = new File(dbFilePath);", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MTgxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483881811", "bodyText": "Such a check for the existence of the file is unnecessary -- perhaps after the check the file may not be there. That is why the delete operation itself takes care of all of that.\nWe should keep it's name as \"deleteOnDiskFile\" to stay consistent with current \"deleteOnDiskFile\". Both files to do the same thing, it's just this new version is static and accepts a windowStartTime argument.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NTg3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485085878", "bodyText": "In that case use Files.delete() and catch the exception if one is thrown  for understanding why it could not be deleted. The error message here is not helpful", "author": "yojs", "createdAt": "2020-09-08T17:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwODMwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485108305", "bodyText": "Files.delete() is the preferred method in the new IO APIs", "author": "vigyasharma", "createdAt": "2020-09-08T18:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE1ODM2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485158365", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-08T19:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMTM4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485231389", "bodyText": "it's just this new version is static and accepts a windowStartTime argument.\n\nwhy do we need a separate static instance of the same method, instead of overloading public void deleteOnDiskFile() ?", "author": "vigyasharma", "createdAt": "2020-09-08T22:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4ODgxMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485988813", "bodyText": "There's two separate abstractions we want. 1. Given a MetricsDB instance, we want to be able to delete it's on-disk file (the non-static version). 2. We want to be able to able to delete arbitrary metrcsdb files without creating an instance (the static version). Creating an instance would have the cost of setting up a sql connection to it... which itself could actually fail (that's why the ctor throws an Exception).", "author": "ricardolstephen", "createdAt": "2020-09-10T00:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTYyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483855626", "bodyText": "can we make this final ?", "author": "yojs", "createdAt": "2020-09-04T21:45:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -71,6 +82,11 @@\n   private final AppContext appContext;\n   private final ConfigOverridesApplier configOverridesApplier;\n \n+  public static final String BATCH_METRICS_ENABLED_CONF_FILE = \"batch_metrics_enabled.conf\";\n+  private boolean batchMetricsEnabled;\n+  private boolean defaultBatchMetricsEnabled = false;", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MjE1MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483882150", "bodyText": "We should keep it as-is to remain consistent with rcaEnabledDefaultValue. Additionally, this value might change, so we shouldn't make it final.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NzE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485087171", "bodyText": "Can you explain how can a default change ?", "author": "yojs", "createdAt": "2020-09-08T17:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwOTA5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485109094", "bodyText": "Why don't we go with default = enabled?", "author": "vigyasharma", "createdAt": "2020-09-08T18:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxOTEyNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485219124", "bodyText": "When I mentioned \"this value might change\", I meant that we may choose to make it true by default. But yeah, since this comment, my notion of constants has changed. Will change it to be private static final.", "author": "ricardolstephen", "createdAt": "2020-09-08T21:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1NTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483859484", "bodyText": "We should keep methods marked as VisiableForTesting restricted to getters and setters. Anything else that is required should be done in a test helper method.\nin this case though, this method is called from within trimOldSnapshots. So we should not have the annotation ?", "author": "yojs", "createdAt": "2020-09-04T21:52:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -754,6 +828,28 @@ public void emitNodeMetrics(long currWindowStartTime, MetricsDB metricsDB) throw\n     }\n   }\n \n+  @VisibleForTesting\n+  public void readBatchMetricsEnabledFromConf() {", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MjgwNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483882807", "bodyText": "VisibleForTesting \"Annotates a program element that exists, or is more widely visible than otherwise necessary, only for use in test code\". This method would be private if we only needed it in trimOldSnapshots. However, we need it for testing purposes, so we make it VisibleForTesting.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5NDUwMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485094500", "bodyText": "One of the ways to avoid it, if we at all want to test private methods, would be to encapsulate all such methods, in a wrapper class of your own. Then make the methods inside the wrapper as public and hence testable. The wrapper can be used in the main class as private or its getters/setters as visible for testing.", "author": "yojs", "createdAt": "2020-09-08T17:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MDYzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485790631", "bodyText": "Will address this by making the target methods private and exposing them via VisibleForTesting shims.", "author": "ricardolstephen", "createdAt": "2020-09-09T17:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTY4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483859689", "bodyText": "We are already logging the error, so e.printStackTrace(); can be removed ?", "author": "yojs", "createdAt": "2020-09-04T21:53:35Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -754,6 +828,28 @@ public void emitNodeMetrics(long currWindowStartTime, MetricsDB metricsDB) throw\n     }\n   }\n \n+  @VisibleForTesting\n+  public void readBatchMetricsEnabledFromConf() {\n+    Path filePath = Paths.get(Util.DATA_DIR, BATCH_METRICS_ENABLED_CONF_FILE);\n+\n+    Util.invokePrivileged(\n+            () -> {\n+              try (Scanner sc = new Scanner(filePath)) {\n+                String nextLine = sc.nextLine();\n+                boolean oldValue = batchMetricsEnabled;\n+                boolean newValue = Boolean.parseBoolean(nextLine);\n+                if (oldValue != newValue) {\n+                  batchMetricsEnabled = newValue;\n+                  LOG.info(\"Batch metrics enabled changed from {} to {}\", oldValue, newValue);\n+                }\n+              } catch (IOException e) {\n+                LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e);\n+                e.printStackTrace();", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4Mjk3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483882970", "bodyText": "We should keep this as-is to stay consistent with readRcaEnabledFromConf.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5NTQ5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485095491", "bodyText": "We may not want to do everything for consistency as much as we want to do the right thing. :) This may be redundant as the stack will already be captured in the logs.", "author": "yojs", "createdAt": "2020-09-08T17:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDIwNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485214207", "bodyText": "Sure, will just remove it.", "author": "ricardolstephen", "createdAt": "2020-09-08T21:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483861278", "bodyText": "If we delete the trimDatabases above, then the method definition is no longer required and the method can be removed ?", "author": "yojs", "createdAt": "2020-09-04T21:59:40Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,43 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTU3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483861575", "bodyText": "The better way might be to move lines 223 to 258 in the trimDatabase method. what do you think ?", "author": "yojs", "createdAt": "2020-09-04T22:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MzU0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483883543", "bodyText": "We should keep trimDatabases for now. It's been pretty well tested and it is public. The codebase itself can use some cleanup, so this can be taken care of with that. However, we should retain the code for now in case we want to make use of it down the road.\nSee #315 (comment)", "author": "ricardolstephen", "createdAt": "2020-09-04T23:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4ODUzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485088530", "bodyText": "If we are removing the usage in the code, we should remove the method. Git takes care of preserving history. So, if it is required in future, we can resurrect it.", "author": "yojs", "createdAt": "2020-09-08T17:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNjYyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485216628", "bodyText": "Sure, will remove it.", "author": "ricardolstephen", "createdAt": "2020-09-08T21:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2MTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2Mzk4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483863980", "bodyText": "Above we have gone through all the metricsDBMap and would have deleted all files but the two most recent ones. Can you add code comment explaining why are we doing this again ?", "author": "yojs", "createdAt": "2020-09-04T22:10:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,43 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    while (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> oldestEntry = metricsDBMap.pollFirstEntry();\n+      if (oldestEntry != null) {\n+        Long key = oldestEntry.getKey();\n+        MetricsDB value = oldestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();\n+        }\n+      }\n+    }\n+    // Flush any tracking batch metrics if batch metrics is disabled. Note, in order to ensure that batch metrics\n+    // consumers have had at least one cycle to use any metrics they may be holding, this flush is done before\n+    // re-reading the config file to update the state of the batch metrics feature.\n+    if (!batchMetricsEnabled && !batchMetricsDBSet.isEmpty()) {\n+      if (deleteDBFiles) {\n+        for (Long timestamp : batchMetricsDBSet) {\n+          if (!metricsDBMap.containsKey(timestamp)) {\n+            MetricsDB.deleteOnDiskFile(timestamp);", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4NTg2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483885862", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-05T00:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2Mzk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDM1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483864354", "bodyText": "This sounds like this call may not belong here or the name of the enclosing method trimOldSnapshots might be changed to something more relevant indicating that the config is re-read here ?", "author": "yojs", "createdAt": "2020-09-04T22:11:49Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,43 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    while (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> oldestEntry = metricsDBMap.pollFirstEntry();\n+      if (oldestEntry != null) {\n+        Long key = oldestEntry.getKey();\n+        MetricsDB value = oldestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();\n+        }\n+      }\n+    }\n+    // Flush any tracking batch metrics if batch metrics is disabled. Note, in order to ensure that batch metrics\n+    // consumers have had at least one cycle to use any metrics they may be holding, this flush is done before\n+    // re-reading the config file to update the state of the batch metrics feature.\n+    if (!batchMetricsEnabled && !batchMetricsDBSet.isEmpty()) {\n+      if (deleteDBFiles) {\n+        for (Long timestamp : batchMetricsDBSet) {\n+          if (!metricsDBMap.containsKey(timestamp)) {\n+            MetricsDB.deleteOnDiskFile(timestamp);\n+          }\n+        }\n+      }\n+      batchMetricsDBSet.clear();\n+    }\n+    readBatchMetricsEnabledFromConf();", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4NDkyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483884927", "bodyText": "This call does belong here (see the comment above it). The method name does not need to be renamed -- the same abstraction is achieved at the end. Additionally, this is complexity that cannot be avoided. The comments are here to help explain the complexity to the reader.", "author": "ricardolstephen", "createdAt": "2020-09-05T00:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5MDEzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485090136", "bodyText": "Sorry, for the confusion, by not belong here, I meant in terms of the name of the method. So please change the name to reflect that ?", "author": "yojs", "createdAt": "2020-09-08T17:40:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgxMzMwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485813306", "bodyText": "Sure, will separate out into a trimOldSnapshots method and a trimOldMetricsDBFiles method.", "author": "ricardolstephen", "createdAt": "2020-09-09T18:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NjgxOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483866819", "bodyText": "SO we store the snapshot everytime we emit metrics, at query time we clone the snapshot (so we double the snapshot) and then we trim it. This is very memory intensive. We might just want to read the files directly from disk when the API is called ?", "author": "yojs", "createdAt": "2020-09-04T22:22:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -289,6 +342,9 @@ private void emitMetrics(long currWindowStartTime) throws Exception {\n \n     metricsDB.commit();\n     metricsDBMap.put(prevWindowStartTime, metricsDB);\n+    if (batchMetricsEnabled) {\n+      batchMetricsDBSet.add(prevWindowStartTime);", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2Nzg3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483867878", "bodyText": "We do not clone the snapshot at query time. We read the file itself. We use the batchMetricsDBSet to keep track of the timestamps of all the available dbs we have on disk, and then when we want to make use of these files during query handling, we call MetricsDB.fetchExisting, which simply creates a new connection to that on-disk database.", "author": "ricardolstephen", "createdAt": "2020-09-04T22:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NjgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4NDUyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r483884523", "bodyText": "This is not what we do. We add just the timestamp to a set. Then, the query handler uses the timestamps from this set to call fetchExisting. fetchExisting creates an additional connection to an already existing database (we do not clone the snapshot), and we access the data via that connection.", "author": "ricardolstephen", "createdAt": "2020-09-04T23:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NjgxOQ=="}], "type": "inlineReview"}, {"oid": "1e744b8e637292e9e3277e28d1ec9e9bd53bf705", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1e744b8e637292e9e3277e28d1ec9e9bd53bf705", "message": "Add DataAccessException to queryMetric signature", "committedDate": "2020-09-04T23:35:42Z", "type": "commit"}, {"oid": "89f1e2d6ecb059e9ef0968028d5826664d373a32", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/89f1e2d6ecb059e9ef0968028d5826664d373a32", "message": "Add documentation to trimOldSnapshots", "committedDate": "2020-09-05T00:07:37Z", "type": "commit"}, {"oid": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ce9e155ff2cf4984d791844dda3dac4261e1baf7", "message": "Merge branch 'master' into batch-metrics-api-v3", "committedDate": "2020-09-07T04:24:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTQ3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485081477", "bodyText": "Do we need the stack trace here ?\nAnd as this is logged for both NumberFormatException and InvalidParameterException, it might make sense to print (settings.getProperty(BATCH_METRICS_RETENTION_PERIOD_MINUTES) to understand which of the two it was by just looking at the logs ?", "author": "yojs", "createdAt": "2020-09-08T17:24:46Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/PluginSettings.java", "diffHunk": "@@ -271,4 +295,21 @@ private void loadMetricsDBFilesCleanupEnabled() {\n       shouldCleanupMetricsDBFiles = true;\n     }\n   }\n+\n+  private void loadBatchMetricsRetentionPeriodMinutesFromConfig() {\n+    if (!settings.containsKey(BATCH_METRICS_RETENTION_PERIOD_MINUTES)) {\n+      return;\n+    }\n+\n+    try {\n+      long parsedRetentionPeriod = Long.parseLong(settings.getProperty(BATCH_METRICS_RETENTION_PERIOD_MINUTES));\n+      if (parsedRetentionPeriod <= 0 || parsedRetentionPeriod > BATCH_METRICS_RETENTION_PERIOD_MINUTES_LIMIT) {\n+        throw new InvalidParameterException();\n+      }\n+      batchMetricsRetentionPeriodMinutes = parsedRetentionPeriod;\n+    } catch (NumberFormatException | InvalidParameterException e) {\n+      LOG.error(\"Invalid batch-metrics-retention-period-minutes. Using default value {}.\",\n+              batchMetricsRetentionPeriodMinutes, e);", "originalCommit": "563905e58200952a10e150dc5956112d2a502fe6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMjQ1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485102454", "bodyText": "Wouldn't Log.error have the stack trace to help identify the exception raised?", "author": "vigyasharma", "createdAt": "2020-09-08T18:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTExMzA4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485113082", "bodyText": "Sure will get rid of the exception log and doing something like this.", "author": "ricardolstephen", "createdAt": "2020-09-08T18:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTQ3Nw=="}], "type": "inlineReview"}, {"oid": "79be926a5095b441c840ab3c6c5b9dc9870d1b39", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/79be926a5095b441c840ab3c6c5b9dc9870d1b39", "message": "More user-friendly handling of invalid batch metrics retention period", "committedDate": "2020-09-08T18:20:28Z", "type": "commit"}, {"oid": "0a45e2d74e021b678e50e4f7933bc513fc444668", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0a45e2d74e021b678e50e4f7933bc513fc444668", "message": "Use more helpful error logging in deleteOnDiskFile", "committedDate": "2020-09-08T19:48:21Z", "type": "commit"}, {"oid": "17142723fe88bec83f7b89a6e5c2a82fcd49c0a2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/17142723fe88bec83f7b89a6e5c2a82fcd49c0a2", "message": "Removing unnecessary print stack trace", "committedDate": "2020-09-08T21:48:09Z", "type": "commit"}, {"oid": "dbf4cccbae28b3b78140012b2b8076c12931dfbd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dbf4cccbae28b3b78140012b2b8076c12931dfbd", "message": "Remove stale trimDatabases method", "committedDate": "2020-09-08T21:51:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwOTA4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485209085", "bodyText": "We have a few things going on here:\n\ncleaning up in-memory snapshots\ncleaning up on-disk files if batch metrics is disabled.\nre-reading config\nAnd cleaning up metrics db files so that we always have a fixed number of them around.\n\nLet's move the in-memory cleanup and on disk cleanups into separate methods of their own", "author": "yojs", "createdAt": "2020-09-08T21:35:07Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,46 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    // Cleanup all but the 2 most recent metricsDB files from metricsDBMap. The most recent metricsDB files needs to be\n+    // retained for future metrics query handling, the second most recent metricsDB file needs to be retained in case", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc3Nzc2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485777761", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-09T16:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwOTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMDUwMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485210503", "bodyText": "Although we are playing safe here by not reading the config before, but I don't think we are completely avoiding the race here. Say, if reading all the files in the retention period is taking too long, (multiple iterations of this call), then there is still a chance that the API read thread tries to read a file that has been deleted. So, we should definitely handle that exception, in any case.", "author": "yojs", "createdAt": "2020-09-08T21:38:25Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -201,8 +219,46 @@ public void trimOldSnapshots() throws Exception {\n     trimMap(shardRqMetricsMap, RQ_SNAPSHOTS);\n     trimMap(httpRqMetricsMap, HTTP_RQ_SNAPSHOTS);\n     trimMap(masterEventMetricsMap, MASTER_EVENT_SNAPSHOTS);\n-    trimDatabases(\n-        metricsDBMap, MAX_DATABASES, PluginSettings.instance().shouldCleanupMetricsDBFiles());\n+\n+    boolean deleteDBFiles = PluginSettings.instance().shouldCleanupMetricsDBFiles();\n+    // Cleanup all but the 2 most recent metricsDB files from metricsDBMap. The most recent metricsDB files needs to be\n+    // retained for future metrics query handling, the second most recent metricsDB file needs to be retained in case\n+    // any metrics query handler just got access to it right before the most recent metricsDB file was available.\n+    while (metricsDBMap.size() > MAX_DATABASES) {\n+      Map.Entry<Long, MetricsDB> oldestEntry = metricsDBMap.pollFirstEntry();\n+      if (oldestEntry != null) {\n+        Long key = oldestEntry.getKey();\n+        MetricsDB value = oldestEntry.getValue();\n+        value.remove();\n+        if (deleteDBFiles && !batchMetricsDBSet.contains(key)) {\n+          value.deleteOnDiskFile();\n+        }\n+      }\n+    }\n+    // Flush any tracking batch metrics if batch metrics is disabled. Note, in order to ensure that batch metrics\n+    // consumers have had at least one cycle to use any metrics they may be holding, this flush is done before\n+    // re-reading the config file to update the state of the batch metrics feature.\n+    if (!batchMetricsEnabled && !batchMetricsDBSet.isEmpty()) {\n+      if (deleteDBFiles) {\n+        for (Long timestamp : batchMetricsDBSet) {\n+          if (!metricsDBMap.containsKey(timestamp)) {\n+            MetricsDB.deleteOnDiskFile(timestamp);\n+          }\n+        }\n+      }\n+      batchMetricsDBSet.clear();\n+    }\n+    readBatchMetricsEnabledFromConf();", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyOTc3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485729775", "bodyText": "Right, the metrics processor code gives the query handler's a ~5s grace period before deleting stale metricsdb files (see the javadoc on getBatchMetrics). For the typical case (when batch metrics is not about to be disabled), this will not be an issue since the batch metrics query handler reads data from the older files first. For the case when batch metrics is about to be disabled, even newer files are at risk of deletion. However, this disabling of batch metrics is not expected to be a use case, there is a 100,800 datapoints limit on the query handler, there's not much data to say that this grace period will be an issue given the datapoint limit, and the query handler properly handles missing files.", "author": "ricardolstephen", "createdAt": "2020-09-09T16:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMDUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzk4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485213980", "bodyText": "PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 12\nThis is a call we are making on each iteration of the loop. Can we store it in a local variable as it does not change over the loop iterations ?", "author": "yojs", "createdAt": "2020-09-08T21:46:04Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -696,6 +755,24 @@ public void deleteDBs() throws Exception {\n     }\n   }\n \n+  /**\n+   * This is called by operations outside of the ReaderMetricsProcessor.\n+   *\n+   * @return A list of the timestamps associated with MetricsDB files. The oldest of the MetricsDB files typically\n+   *     have a lifetime of ~SAMPLING_INTERVAL seconds (no less than SAMPLING_INTERVAL/2 seconds). Null if batch\n+   *     metrics is disabled.\n+   */\n+  public NavigableSet<Long> getBatchMetrics() {\n+    if (batchMetricsEnabled) {\n+      TreeSet<Long> batchMetricsDBSetCopy = new TreeSet<>(batchMetricsDBSet.clone());\n+      while (batchMetricsDBSetCopy.size() > PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 12) {", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NDg3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485244876", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-08T23:12:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNTE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485215171", "bodyText": "Let's add a comment here saying that this datastructure can be modified by the writer/cleanup thread while being read by the other thread trying to batch metrics. And therefore, it needs to be ConcurrentSkipListSet", "author": "yojs", "createdAt": "2020-09-08T21:48:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -71,6 +82,11 @@\n   private final AppContext appContext;\n   private final ConfigOverridesApplier configOverridesApplier;\n \n+  public static final String BATCH_METRICS_ENABLED_CONF_FILE = \"batch_metrics_enabled.conf\";\n+  private boolean batchMetricsEnabled;\n+  private boolean defaultBatchMetricsEnabled = false;\n+  private ConcurrentSkipListSet<Long> batchMetricsDBSet;", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0MDMxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485240317", "bodyText": "Sure", "author": "ricardolstephen", "createdAt": "2020-09-08T22:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNTE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNjM3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485216370", "bodyText": "Let's also add the reason for the numbers here ?", "author": "yojs", "createdAt": "2020-09-08T21:51:49Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD_MILLIS = 5000;  // Must be a multiple of 5000", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyNTI3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485225279", "bodyText": "Max datapoints was capped to prevent excessive memory consumption. Will note that in README and design docs. However, I don't see the need to note anything about DEFAULT_SAMPLING_PERIOD_MILLIS.", "author": "ricardolstephen", "createdAt": "2020-09-08T22:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNjM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODUxMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485218513", "bodyText": "batchMetricsDBSet holds the key to the castle and it is an in-memory structure. In case PA starts crashing say every 15 seconds, or so. So, we will not be cleaning up files that were generated in the last run as this structure is always initialized to an empty set !", "author": "yojs", "createdAt": "2020-09-08T21:57:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -71,6 +82,11 @@\n   private final AppContext appContext;\n   private final ConfigOverridesApplier configOverridesApplier;\n \n+  public static final String BATCH_METRICS_ENABLED_CONF_FILE = \"batch_metrics_enabled.conf\";\n+  private boolean batchMetricsEnabled;\n+  private boolean defaultBatchMetricsEnabled = false;\n+  private ConcurrentSkipListSet<Long> batchMetricsDBSet;\n+", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwOTYyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485709628", "bodyText": "This is true. Will file this as an enhancement. #415", "author": "ricardolstephen", "createdAt": "2020-09-09T15:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMTY2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485801669", "bodyText": "So, if the reader keeps crashing every 15 seconds, there will not be much impact since the rmp waits for a I believe ~30s or longer before actually producing metricsDB files. However, I believe the issue you mention actually raises the bigger concern that metricsdb files are never cleaned up -- whether they are collected for metrics or batch metrics. As a result, if the reader crashes with the same periodicity as the metricsdb retention period (10s with just metrics processing and no batch metrics, or a peak of 60min with batch metrics) then the cluster will just accumulate a large number of metricsdb files that aren't cleaned up.", "author": "ricardolstephen", "createdAt": "2020-09-09T17:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxODg1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485918854", "bodyText": "yes, 15 or whatever is just a number, I was hinting at the edge case of the disk resident files not being cleaned at all and accumulating over time.", "author": "yojs", "createdAt": "2020-09-09T20:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NzQ1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485987452", "bodyText": "For this initial pr, we can just cleanup any files that were found. However, we will only close ticket #415 once we've implemented initializing the batch metrics set with the available files found on startup.", "author": "ricardolstephen", "createdAt": "2020-09-10T00:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxODUxMw=="}], "type": "inlineReview"}, {"oid": "4c2ce23d8560591005e5a79ccfca6cb41e695ab0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4c2ce23d8560591005e5a79ccfca6cb41e695ab0", "message": "Make defaultBatchMetricsEnabled private static final", "committedDate": "2020-09-08T21:59:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyNzIyNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485227224", "bodyText": "nit: should we reword as something on the lines of - \"Start time and end time should be at least sampling period apart\".? It may be confusing in its current form.", "author": "vigyasharma", "createdAt": "2020-09-08T22:21:27Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD_MILLIS = 5000;  // Must be a multiple of 5000\n+\n+  public QueryBatchRequestHandler(NetClient netClient, MetricsRestUtil metricsRestUtil) {\n+    this.netClient = netClient;\n+    this.metricsRestUtil = metricsRestUtil;\n+  }\n+\n+  @Override\n+  public void handle(HttpExchange exchange) throws IOException {\n+    String requestMethod = exchange.getRequestMethod();\n+    if (!requestMethod.equalsIgnoreCase(\"GET\")) {\n+      exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+      exchange.close();\n+      return;\n+    }\n+\n+    ReaderMetricsProcessor mp = ReaderMetricsProcessor.getInstance();\n+    if (mp == null) {\n+      sendResponse(\n+          exchange,\n+          \"{\\\"error\\\":\\\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\\\"}\",\n+          HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    NavigableSet<Long> batchMetrics = mp.getBatchMetrics();\n+    long currentTime = System.currentTimeMillis();\n+    if (batchMetrics == null) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"The batch metrics api has not been enabled for this node.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"The batch metrics api has not been enabled for this node.\");\n+      return;\n+    }\n+    if (batchMetrics.isEmpty()) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"There are no metrics databases. The reader has run into an issue or has just started.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"There are no metrics databases. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+    Map<String, String> params = getParamsMap(exchange.getRequestURI().getQuery());\n+\n+    try {\n+      // Parse and validate parameters\n+      String[] validParamsTmp = {\"\", \"metrics\", \"starttime\", \"endtime\", \"samplingperiod\"};\n+      Set<String> validParams = new HashSet<>(Arrays.asList(validParamsTmp));\n+      for (String param : params.keySet()) {\n+        if (!validParams.contains(param)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid parameter\", param));\n+        }\n+      }\n+\n+      List<String> metrics = metricsRestUtil.parseArrayParam(params, \"metrics\", false);\n+      String startTimeParam = params.get(\"starttime\");\n+      String endTimeParam = params.get(\"endtime\");\n+      String samplingPeriodParam = params.get(\"samplingperiod\");\n+\n+      for (String metric : metrics) {\n+        if (!MetricsModel.ALL_METRICS.containsKey(metric)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid metric\", metric));\n+        }\n+      }\n+\n+      if (startTimeParam == null || startTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"starttime parameter must be set\");\n+      }\n+      long startTime;\n+      try {\n+        startTime = Long.parseUnsignedLong(startTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid starttime\", startTimeParam));\n+      }\n+\n+      if (endTimeParam == null || endTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"endtime parameter must be set\");\n+      }\n+      long endTime;\n+      try {\n+        endTime = Long.parseUnsignedLong(endTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid endtime\", endTimeParam));\n+      }\n+\n+      long samplingPeriod = DEFAULT_SAMPLING_PERIOD_MILLIS;\n+      if (samplingPeriodParam != null && !samplingPeriodParam.isEmpty()) {\n+        samplingPeriod = Long.parseLong(samplingPeriodParam);\n+        if (samplingPeriod < 5 || samplingPeriod % 5 != 0) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid sampling period\", samplingPeriodParam));\n+        }\n+        if (samplingPeriod >= PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60) {\n+          throw new InvalidParameterException(\"sampling period must be less than the retention period\");\n+        }\n+        samplingPeriod *= 1000;\n+      }\n+\n+      if (startTime >= endTime) {\n+        throw new InvalidParameterException(\"starttime must be less than the endtime\");\n+      }\n+      startTime -= startTime % samplingPeriod;\n+      endTime -= endTime % samplingPeriod;\n+      if (startTime == endTime) {\n+        throw new InvalidParameterException(\"starttime and endtime cannot be equal when rounded down to the nearest sampling period\");", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0OTEyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485249121", "bodyText": "Agreed", "author": "ricardolstephen", "createdAt": "2020-09-08T23:26:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyNzIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyNzYxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485227616", "bodyText": "Minor: System time at node should not matter, right? Since startTime and endTime are provided as utc epoch timestamp values. We can just mention something like expected value is utc seconds since epoch timestamp and provided value is in future.", "author": "vigyasharma", "createdAt": "2020-09-08T22:22:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryBatchRequestHandler.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatsCollector;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.config.PluginSettings;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.MetricsRestUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.model.MetricsModel;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ReaderMetricsProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * Request handler that supports querying batch metrics from an EC2 instance\n+ *\n+ * <p>Return 1 minute of CPU_Utilization metrics sampled at a 5s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization&starttime=1566413975000&endtime=1566413980000\"\n+ *\n+ * <p>Return 1 minute of CPU_Utilization and Latency metrics sampled at a 10s sampling period:\n+ * \"http://localhost:9600/_opendistro/_performanceanalyzer/batch?metrics=CPU_Utilization,Latency&starttime=1566413975000&endtime=1566413980000&samplingperiod=10\"\n+ *\n+ * <p>Return format:\n+ * {\n+ *   \"1594412650000\": {\n+ *     \"CPU_Utilization\": {\n+ *       \"fields\": [\n+ *         {\n+ *           \"name: \"IndexName\",\n+ *           \"type\": \"VARCHAR\"\n+ *         },\n+ *         <...>\n+ *       ]\n+ *       \"records\": [\n+ *         [\n+ *           \"pmc\",\n+ *           <...>\n+ *         ],\n+ *         <...>\n+ *       ]\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class QueryBatchRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueryBatchRequestHandler.class);\n+\n+  private static final int TIME_OUT_VALUE = 2;\n+  private static final TimeUnit TIME_OUT_UNIT = TimeUnit.SECONDS;\n+  private NetClient netClient;\n+  MetricsRestUtil metricsRestUtil;\n+\n+  public static final int DEFAULT_MAX_DATAPOINTS = 100800;  // Must be non-negative\n+  public static final long DEFAULT_SAMPLING_PERIOD_MILLIS = 5000;  // Must be a multiple of 5000\n+\n+  public QueryBatchRequestHandler(NetClient netClient, MetricsRestUtil metricsRestUtil) {\n+    this.netClient = netClient;\n+    this.metricsRestUtil = metricsRestUtil;\n+  }\n+\n+  @Override\n+  public void handle(HttpExchange exchange) throws IOException {\n+    String requestMethod = exchange.getRequestMethod();\n+    if (!requestMethod.equalsIgnoreCase(\"GET\")) {\n+      exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+      exchange.close();\n+      return;\n+    }\n+\n+    ReaderMetricsProcessor mp = ReaderMetricsProcessor.getInstance();\n+    if (mp == null) {\n+      sendResponse(\n+          exchange,\n+          \"{\\\"error\\\":\\\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\\\"}\",\n+          HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"Metrics Processor is not initialized. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    NavigableSet<Long> batchMetrics = mp.getBatchMetrics();\n+    long currentTime = System.currentTimeMillis();\n+    if (batchMetrics == null) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"The batch metrics api has not been enabled for this node.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"The batch metrics api has not been enabled for this node.\");\n+      return;\n+    }\n+    if (batchMetrics.isEmpty()) {\n+      sendResponse(\n+              exchange,\n+              \"{\\\"error\\\":\\\"There are no metrics databases. The reader has run into an issue or has just started.\\\"}\",\n+              HttpURLConnection.HTTP_UNAVAILABLE);\n+      LOG.warn(\"There are no metrics databases. The reader has run into an issue or has just started.\");\n+      return;\n+    }\n+\n+    exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+    Map<String, String> params = getParamsMap(exchange.getRequestURI().getQuery());\n+\n+    try {\n+      // Parse and validate parameters\n+      String[] validParamsTmp = {\"\", \"metrics\", \"starttime\", \"endtime\", \"samplingperiod\"};\n+      Set<String> validParams = new HashSet<>(Arrays.asList(validParamsTmp));\n+      for (String param : params.keySet()) {\n+        if (!validParams.contains(param)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid parameter\", param));\n+        }\n+      }\n+\n+      List<String> metrics = metricsRestUtil.parseArrayParam(params, \"metrics\", false);\n+      String startTimeParam = params.get(\"starttime\");\n+      String endTimeParam = params.get(\"endtime\");\n+      String samplingPeriodParam = params.get(\"samplingperiod\");\n+\n+      for (String metric : metrics) {\n+        if (!MetricsModel.ALL_METRICS.containsKey(metric)) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid metric\", metric));\n+        }\n+      }\n+\n+      if (startTimeParam == null || startTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"starttime parameter must be set\");\n+      }\n+      long startTime;\n+      try {\n+        startTime = Long.parseUnsignedLong(startTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid starttime\", startTimeParam));\n+      }\n+\n+      if (endTimeParam == null || endTimeParam.isEmpty()) {\n+        throw new InvalidParameterException(\"endtime parameter must be set\");\n+      }\n+      long endTime;\n+      try {\n+        endTime = Long.parseUnsignedLong(endTimeParam);\n+      } catch (NumberFormatException e) {\n+        throw new InvalidParameterException(String.format(\"%s is an invalid endtime\", endTimeParam));\n+      }\n+\n+      long samplingPeriod = DEFAULT_SAMPLING_PERIOD_MILLIS;\n+      if (samplingPeriodParam != null && !samplingPeriodParam.isEmpty()) {\n+        samplingPeriod = Long.parseLong(samplingPeriodParam);\n+        if (samplingPeriod < 5 || samplingPeriod % 5 != 0) {\n+          throw new InvalidParameterException(String.format(\"%s is an invalid sampling period\", samplingPeriodParam));\n+        }\n+        if (samplingPeriod >= PluginSettings.instance().getBatchMetricsRetentionPeriodMinutes() * 60) {\n+          throw new InvalidParameterException(\"sampling period must be less than the retention period\");\n+        }\n+        samplingPeriod *= 1000;\n+      }\n+\n+      if (startTime >= endTime) {\n+        throw new InvalidParameterException(\"starttime must be less than the endtime\");\n+      }\n+      startTime -= startTime % samplingPeriod;\n+      endTime -= endTime % samplingPeriod;\n+      if (startTime == endTime) {\n+        throw new InvalidParameterException(\"starttime and endtime cannot be equal when rounded down to the nearest sampling period\");\n+      }\n+      if (endTime > currentTime) {\n+        throw new InvalidParameterException(\"endtime can be no greater than the system time at the node\");", "originalCommit": "ce9e155ff2cf4984d791844dda3dac4261e1baf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MzAwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r485253004", "bodyText": "I use the phrase \"system time\" because we determine current time using System.currentTimeMillis, which in turn uses methods from the operating system. And I believe machines can be setup to indicate whatever timestamp the owner wants -- like, I could setup a computer today with a current time of January 1, 1970. So, I expose this additional detail in the error message to help anyone who might be having problems, while keeping the readme and design doc at the abstraction of utc for the standard use case.", "author": "ricardolstephen", "createdAt": "2020-09-08T23:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIyNzYxNg=="}], "type": "inlineReview"}, {"oid": "ace75f930857242a31e5780f28c937df54826c28", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ace75f930857242a31e5780f28c937df54826c28", "message": "Add comment about concurrent access of batchMetricsDBSet", "committedDate": "2020-09-08T22:47:40Z", "type": "commit"}, {"oid": "bc52cc2b9942cbc39d4208fa2e93d31957ed9095", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/bc52cc2b9942cbc39d4208fa2e93d31957ed9095", "message": "Cache limit on number of batch metrics files", "committedDate": "2020-09-08T23:11:47Z", "type": "commit"}, {"oid": "8d764a9b897d8a0a9d4bb2f268928f527ede00e9", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8d764a9b897d8a0a9d4bb2f268928f527ede00e9", "message": "Address minor nits in QueryBatchRequestHandler", "committedDate": "2020-09-09T16:39:12Z", "type": "commit"}, {"oid": "61cf265349445e5cab8e921583c85e30cd897042", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/61cf265349445e5cab8e921583c85e30cd897042", "message": "Separate out snapshot and metricsdb trimming", "committedDate": "2020-09-09T16:58:49Z", "type": "commit"}, {"oid": "a6b344e4cab46708d01ed458f4f5fb7f540fa4b8", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a6b344e4cab46708d01ed458f4f5fb7f540fa4b8", "message": "Replace use of VisibleForTesting with shims", "committedDate": "2020-09-09T17:21:09Z", "type": "commit"}, {"oid": "057291923ecebe6d750f127b3d79e065267039d7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/057291923ecebe6d750f127b3d79e065267039d7", "message": "Rename trimMetricsDBFiles to trimOldMetricsDBFiles", "committedDate": "2020-09-09T19:48:52Z", "type": "commit"}, {"oid": "314306f821cd1be9477cf44e083635b2c4df3e73", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/314306f821cd1be9477cf44e083635b2c4df3e73", "message": "Purge metricsdb files on startup", "committedDate": "2020-09-10T00:09:27Z", "type": "commit"}, {"oid": "0f935aead0f2bab3dbd912328d3f4a63ccbabae1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0f935aead0f2bab3dbd912328d3f4a63ccbabae1", "message": "Address checkstyle issue", "committedDate": "2020-09-10T00:32:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxNDExOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/315#discussion_r486014118", "bodyText": "We might skip the overhead of regex compiling by stripping off the parentPath from the prefix -  the remainder is what we are looking for in the directory.", "author": "yojs", "createdAt": "2020-09-10T01:47:14Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metricsdb/MetricsDB.java", "diffHunk": "@@ -327,6 +331,36 @@ public static void deleteOnDiskFile(long windowStartTime) {\n     }\n   }\n \n+  /**\n+   * Returns the timestamps associated with on-disk files.\n+   *\n+   * @return the timestamps associated with on-disk files\n+   */\n+  public static Set<Long> listOnDiskFiles() {\n+    String prefix = PluginSettings.instance().getSettingValue(DB_FILE_PREFIX_PATH_CONF_NAME, DB_FILE_PREFIX_PATH_DEFAULT);\n+    Path prefixPath = Paths.get(prefix);\n+    Path parentPath = prefixPath.getParent();\n+    Set<Long> found = new HashSet<Long>();\n+    try (Stream<Path> paths = Files.list(parentPath)) {\n+      PathMatcher matcher = FileSystems.getDefault().getPathMatcher(\"regex:\" + prefix + \"\\\\d+\");", "originalCommit": "0f935aead0f2bab3dbd912328d3f4a63ccbabae1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "333d757314e923b6a18931ae320ae0178377a483", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/333d757314e923b6a18931ae320ae0178377a483", "message": "Ignore incorrect spotbugs issue", "committedDate": "2020-09-10T02:38:22Z", "type": "commit"}]}