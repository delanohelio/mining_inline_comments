{"pr_number": 294, "pr_title": "Common changes needed to support dynamic en/disabling of config overrides", "pr_createdAt": "2020-07-20T18:35:26Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294", "timeline": [{"oid": "37be24362522aae4ffe3c15daef4bb361269c156", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/37be24362522aae4ffe3c15daef4bb361269c156", "message": "Common changes needed to support dynamic en/disabling of config overrides", "committedDate": "2020-07-20T18:30:55Z", "type": "commit"}, {"oid": "570286bbdc222fbd947f7662155034df3c959be2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/570286bbdc222fbd947f7662155034df3c959be2", "message": "Separate serialize/deserialize methods into own helper", "committedDate": "2020-07-24T17:26:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0NTk2MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r460245960", "bodyText": "nit: Missing License information.", "author": "khushbr", "createdAt": "2020-07-24T19:25:41Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/overrides/ConfigOverrides.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.config.overrides;", "originalCommit": "570286bbdc222fbd947f7662155034df3c959be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNTUwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461015501", "bodyText": "Thanks for noticing it! Added them.", "author": "ktkrg", "createdAt": "2020-07-27T16:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0NTk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0Njk1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r460246952", "bodyText": "nit: Would help if we add a javadoc string explaining that currently we are supporting the rcas, deciders and actions under Overrides and this is supposed to be extensible for other logical parts of graph.", "author": "khushbr", "createdAt": "2020-07-24T19:27:51Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/overrides/ConfigOverrides.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.config.overrides;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * POJO for config overrides.\n+ */\n+public class ConfigOverrides {\n+    private Overrides enable;\n+    private Overrides disable;\n+\n+    public ConfigOverrides() {\n+        this.enable = new Overrides();\n+        this.disable = new Overrides();\n+    }\n+\n+    public Overrides getEnable() {\n+        return enable;\n+    }\n+\n+    public void setEnable(Overrides enable) {\n+        this.enable = enable;\n+    }\n+\n+    public Overrides getDisable() {\n+        return disable;\n+    }\n+\n+    public void setDisable(Overrides disable) {\n+        this.disable = disable;\n+    }\n+\n+    public static class Overrides {\n+        private List<String> rcas;\n+        private List<String> deciders;\n+        private List<String> actions;\n+\n+        public Overrides() {\n+            this.rcas = new ArrayList<>();\n+            this.deciders = new ArrayList<>();\n+            this.actions = new ArrayList<>();", "originalCommit": "570286bbdc222fbd947f7662155034df3c959be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNTYwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461015609", "bodyText": "Added javadoc.", "author": "ktkrg", "createdAt": "2020-07-27T16:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0Njk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMTIwMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r460301200", "bodyText": "Do we also want to add a metric here ?", "author": "khushbr", "createdAt": "2020-07-24T21:43:54Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/overrides/ConfigOverridesHelper.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.config.overrides;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+/**\n+ * Class that helps with operations concerning {@link ConfigOverrides}s\n+ */\n+public class ConfigOverridesHelper {\n+\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+  /**\n+   * Serializes a {@link ConfigOverrides} instance to its JSON representation.\n+   *\n+   * @param overrides The {@link ConfigOverrides} instance.\n+   * @return String in JSON format representing the serialized equivalent.\n+   * @throws IOException if conversion runs into an IOException.\n+   */\n+  public static String serialize(final ConfigOverrides overrides) throws IOException {\n+    final IOException[] exception = new IOException[1];\n+    final String serializedOverrides = AccessController.doPrivileged((PrivilegedAction<String>) () -> {\n+      try {\n+        return MAPPER.writeValueAsString(overrides);\n+      } catch (IOException e) {\n+        exception[0] = e;\n+      }\n+      return \"\";\n+    });\n+\n+    if (serializedOverrides.isEmpty() && exception[0] != null) {\n+      throw exception[0];\n+    }\n+\n+    return serializedOverrides;\n+  }\n+\n+  /**\n+   * Deserializes a JSON representation of the config overrides into a {@link ConfigOverrides} instance.\n+   *\n+   * @param overrides The JSON string representing config overrides.\n+   * @return A {@link ConfigOverrides} instance if the JSON is valid.\n+   * @throws IOException if conversion runs into an IOException.\n+   */\n+  public static ConfigOverrides deserialize(final String overrides) throws IOException {\n+    final IOException[] exception = new IOException[1];\n+    final ConfigOverrides configOverrides = AccessController.doPrivileged((PrivilegedAction<ConfigOverrides>) () -> {\n+      try {\n+        return MAPPER.readValue(overrides, ConfigOverrides.class);\n+      } catch (IOException ioe) {\n+        exception[0] = ioe;\n+      }\n+      return null;\n+    });\n+\n+    if (configOverrides == null && exception[0] != null) {\n+      // re throw the exception that was consumed while deserializing.", "originalCommit": "570286bbdc222fbd947f7662155034df3c959be2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjAyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461016028", "bodyText": "I've added the metric where we call deserialize() in ClusterDetailsEventProcessor, I'll send the PR after this gets merged as that PR depends on this change.", "author": "ktkrg", "createdAt": "2020-07-27T16:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMTIwMA=="}], "type": "inlineReview"}, {"oid": "a795e6d8ac1063942153193341c725830956da86", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a795e6d8ac1063942153193341c725830956da86", "message": "Add licence header to new files", "committedDate": "2020-07-27T16:28:11Z", "type": "commit"}, {"oid": "43f194e7a80b39ee8c22ec3348265974a7c99cec", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/43f194e7a80b39ee8c22ec3348265974a7c99cec", "message": "Merge branch 'master' into ktkrg-en-disable", "committedDate": "2020-07-27T17:41:48Z", "type": "commit"}, {"oid": "b0adabd76d6e3f6c50316191ce918af36c9fc9d5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b0adabd76d6e3f6c50316191ce918af36c9fc9d5", "message": "Update licence year to 2020", "committedDate": "2020-07-27T18:08:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NDgxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461074816", "bodyText": "Can you explain if this is a one element array, why does it needs to be an array, can't it just be a single reference ?", "author": "yojs", "createdAt": "2020-07-27T18:08:32Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/overrides/ConfigOverridesHelper.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.config.overrides;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+/**\n+ * Class that helps with operations concerning {@link ConfigOverrides}s\n+ */\n+public class ConfigOverridesHelper {\n+\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+  /**\n+   * Serializes a {@link ConfigOverrides} instance to its JSON representation.\n+   *\n+   * @param overrides The {@link ConfigOverrides} instance.\n+   * @return String in JSON format representing the serialized equivalent.\n+   * @throws IOException if conversion runs into an IOException.\n+   */\n+  public static String serialize(final ConfigOverrides overrides) throws IOException {\n+    final IOException[] exception = new IOException[1];\n+    final String serializedOverrides = AccessController.doPrivileged((PrivilegedAction<String>) () -> {\n+      try {\n+        return MAPPER.writeValueAsString(overrides);\n+      } catch (IOException e) {\n+        exception[0] = e;\n+      }\n+      return \"\";\n+    });\n+\n+    if (serializedOverrides.isEmpty() && exception[0] != null) {\n+      throw exception[0];\n+    }\n+\n+    return serializedOverrides;\n+  }\n+\n+  /**\n+   * Deserializes a JSON representation of the config overrides into a {@link ConfigOverrides} instance.\n+   *\n+   * @param overrides The JSON string representing config overrides.\n+   * @return A {@link ConfigOverrides} instance if the JSON is valid.\n+   * @throws IOException if conversion runs into an IOException.\n+   */\n+  public static ConfigOverrides deserialize(final String overrides) throws IOException {\n+    final IOException[] exception = new IOException[1];", "originalCommit": "43f194e7a80b39ee8c22ec3348265974a7c99cec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEwNDYwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461104608", "bodyText": "We can't use a local variable inside the lambda because it needs to be effectively final so we need a one element array(or any wrapper around the exception) to fish the exception out of the lambda into the calling code. I've added this as a javadoc comment as well.", "author": "ktkrg", "createdAt": "2020-07-27T19:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NDgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NzE5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461077190", "bodyText": "This is a static final object. Some of the decider actions are node level. I don't think this will work with the RCA-IT framework if we just have a static object mapper here, unless the Overrides object haves nodeId as a parameter, in my opinion.", "author": "yojs", "createdAt": "2020-07-27T18:12:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/config/overrides/ConfigOverridesHelper.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.config.overrides;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.IOException;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+\n+/**\n+ * Class that helps with operations concerning {@link ConfigOverrides}s\n+ */\n+public class ConfigOverridesHelper {\n+\n+  private static final ObjectMapper MAPPER = new ObjectMapper();", "originalCommit": "43f194e7a80b39ee8c22ec3348265974a7c99cec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5ODA5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/294#discussion_r461098099", "bodyText": "This is only to help deserialize the string from ClusterDetailsEventProcessor into the override object. It's then updated in the RcaConf. This change will come in the next PR. This PR is only introducing the common classes needed by both the reader and the writer.\nEdit:\nIt's used only as a helper, and it didn't make sense to create an instance of the helper object and pass it around to serialize and deserialize the overrides so decided to make it static. It does not mutate any state and works only on the arguments supplied.\nThe ClusterDetailsEventProcessor calls ConfigOverridesHelper.deserialize(lines[1]) in its processEvent method passing in whatever the writer has written as overrides through the NodeDetailsCollector.", "author": "ktkrg", "createdAt": "2020-07-27T18:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NzE5MA=="}], "type": "inlineReview"}, {"oid": "6efceb31aa660d3c22b6c13e09701d42251a3a26", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6efceb31aa660d3c22b6c13e09701d42251a3a26", "message": "Add javadoc explaining one element array", "committedDate": "2020-07-27T19:01:41Z", "type": "commit"}, {"oid": "14358c49aa5ea980567185a6e6e84bbd6834003d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/14358c49aa5ea980567185a6e6e84bbd6834003d", "message": "Merge branch 'master' into ktkrg-en-disable", "committedDate": "2020-07-27T22:20:44Z", "type": "commit"}, {"oid": "fdbf2c95de96f9d6bdb46508f829e14a656bd4a6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/fdbf2c95de96f9d6bdb46508f829e14a656bd4a6", "message": "Synchronize serialize and deserialize methods", "committedDate": "2020-07-28T06:13:16Z", "type": "commit"}]}