{"pr_number": 465, "pr_title": "Using to buckets to suppress queue length increase action", "pr_createdAt": "2020-10-13T19:06:18Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465", "timeline": [{"oid": "2ad2a9b97f2475e74685004c9a70feb5d903e41a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2ad2a9b97f2475e74685004c9a70feb5d903e41a", "message": "Using to buckets to suppress queue length increase action", "committedDate": "2020-10-13T19:14:58Z", "type": "forcePushed"}, {"oid": "37ead39926dec9f497c2fede0f449b2c24a0111d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/37ead39926dec9f497c2fede0f449b2c24a0111d", "message": "Using to buckets to suppress queue length increase action", "committedDate": "2020-10-13T19:56:54Z", "type": "forcePushed"}, {"oid": "426f97d391b709be5f1e1b31913ee969f1cb508a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/426f97d391b709be5f1e1b31913ee969f1cb508a", "message": "Using to buckets to suppress queue length increase action", "committedDate": "2020-10-13T20:34:21Z", "type": "commit"}, {"oid": "426f97d391b709be5f1e1b31913ee969f1cb508a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/426f97d391b709be5f1e1b31913ee969f1cb508a", "message": "Using to buckets to suppress queue length increase action", "committedDate": "2020-10-13T20:34:21Z", "type": "forcePushed"}, {"oid": "4bf1d70f1d4e4b5fb5eda1d7ac662f3c59f23e07", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4bf1d70f1d4e4b5fb5eda1d7ac662f3c59f23e07", "message": "adding bucketization for cache deciders", "committedDate": "2020-10-13T22:07:17Z", "type": "commit"}, {"oid": "9d3f37cb4365f30353799a1de866682540768cf5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9d3f37cb4365f30353799a1de866682540768cf5", "message": "Adding a default bucketization values if not in rca.conf", "committedDate": "2020-10-13T22:32:32Z", "type": "commit"}, {"oid": "270464e69460d6bea3afc33b2a574cc2fe58ee49", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/270464e69460d6bea3afc33b2a574cc2fe58ee49", "message": "checkstyle fix", "committedDate": "2020-10-13T22:47:12Z", "type": "commit"}, {"oid": "76aee26238ecd2e82f6b5d3bd884d3fe59f6a8bc", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/76aee26238ecd2e82f6b5d3bd884d3fe59f6a8bc", "message": "Adding the ignore for RCAIt log errors", "committedDate": "2020-10-13T23:38:01Z", "type": "commit"}, {"oid": "820f20d4f85f95c32b2c6ca15b3da5693681e600", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/820f20d4f85f95c32b2c6ca15b3da5693681e600", "message": "Added a unit test", "committedDate": "2020-10-14T01:41:51Z", "type": "commit"}, {"oid": "202181b61e320858bdeb54a06270e1823c2828fd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/202181b61e320858bdeb54a06270e1823c2828fd", "message": "rename a variable", "committedDate": "2020-10-14T02:01:47Z", "type": "commit"}, {"oid": "2bf2312861078e724aede3c4966c678176eae54c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2bf2312861078e724aede3c4966c678176eae54c", "message": "Log error message ignore", "committedDate": "2020-10-14T02:50:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNTI5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504905299", "bodyText": "I am wondering if we should also add a log statement here in addition to the metric. Thoughts?", "author": "khushbr", "createdAt": "2020-10-14T19:01:20Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/CacheHealthDecider.java", "diffHunk": "@@ -130,7 +134,14 @@ private void configureModifyCacheActionPriority() {\n    * signals going forward.\n    */\n   private Action computeBestAction(final NodeKey esNode, final ResourceEnum cacheType) {\n-    return getAction(ModifyCacheMaxSizeAction.NAME, esNode, cacheType, true);\n+    Action action = null;\n+    if (canUseMoreHeap(esNode)) {\n+      action = getAction(ModifyCacheMaxSizeAction.NAME, esNode, cacheType, true);\n+    } else {\n+      PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MDQ4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504960487", "bodyText": "We don't want to emit the log continuously and in a cluster with jvm pressure, we will emit it quite a few times.", "author": "yojs", "createdAt": "2020-10-14T20:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwODgyMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504908822", "bodyText": "should the check instead be  clusterSummary.getSummary() ?", "author": "khushbr", "createdAt": "2020-10-14T19:07:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/HeapBasedDecider.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BasicBucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.UsageBucket;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.HighHeapUsageClusterRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public abstract class HeapBasedDecider extends Decider {\n+  private static final Logger LOG = LogManager.getLogger(HeapBasedDecider.class);\n+  private static final String OLD_GEN_TUNABLE_KEY = \"old-gen\";\n+  private static final ResourceEnum DECIDING_HEAP_RESOURCE_TYPE = ResourceEnum.OLD_GEN;\n+  public static final ImmutableMap<UsageBucket, Double> DEFAULT_HEAP_USAGE_THRESHOLDS = ImmutableMap.<UsageBucket, Double>builder()\n+      .put(UsageBucket.UNDER_UTILIZED, 10.0)\n+      .put(UsageBucket.HEALTHY_WITH_BUFFER, 60.0)\n+      .put(UsageBucket.HEALTHY, 80.0)\n+      .build();\n+\n+  private HighHeapUsageClusterRca highHeapUsageClusterRca;\n+\n+  public HeapBasedDecider(long evalIntervalSeconds, int decisionFrequency, HighHeapUsageClusterRca highHeapUsageClusterRca) {\n+    super(evalIntervalSeconds, decisionFrequency);\n+    this.highHeapUsageClusterRca = highHeapUsageClusterRca;\n+  }\n+\n+  /**\n+   * The Queue and Cache deciders should only be able to suggest increase of the queue size or increase of cache size if the Java heap can\n+   * sustain more live objects in it without de-gradation. What is an acceptable heap usage limit to determine this, comes from the\n+   * bucketization object in rca.conf. We compare the oldGen usage percent reported by the HighHeapUsage RCA to determine that.\n+   *\n+   * @param esNode The EsNode we are trying to make a decision for.\n+   * @return return if the OldGen heap is under-utilized or healthy and yet more can be consumed, return true; or false otherwise.\n+   */\n+  protected boolean canUseMoreHeap(NodeKey esNode) {\n+    // we add action only if heap is under-utilized or healthy and yet more can be consumed.\n+    for (ResourceFlowUnit<HotClusterSummary> clusterSummary : highHeapUsageClusterRca.getFlowUnits()) {\n+      if (clusterSummary.hasResourceSummary()) {", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk1OTM5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504959394", "bodyText": "hasSummary is that check. It checks if the summary is null.", "author": "yojs", "createdAt": "2020-10-14T20:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwODgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMjQ2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504912467", "bodyText": "There are multiple level of nesting here with for-if-for-if, can we break down this function into two or more or use lambda ?", "author": "khushbr", "createdAt": "2020-10-14T19:14:31Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/HeapBasedDecider.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BasicBucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.UsageBucket;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.HighHeapUsageClusterRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public abstract class HeapBasedDecider extends Decider {\n+  private static final Logger LOG = LogManager.getLogger(HeapBasedDecider.class);\n+  private static final String OLD_GEN_TUNABLE_KEY = \"old-gen\";\n+  private static final ResourceEnum DECIDING_HEAP_RESOURCE_TYPE = ResourceEnum.OLD_GEN;\n+  public static final ImmutableMap<UsageBucket, Double> DEFAULT_HEAP_USAGE_THRESHOLDS = ImmutableMap.<UsageBucket, Double>builder()\n+      .put(UsageBucket.UNDER_UTILIZED, 10.0)\n+      .put(UsageBucket.HEALTHY_WITH_BUFFER, 60.0)\n+      .put(UsageBucket.HEALTHY, 80.0)\n+      .build();\n+\n+  private HighHeapUsageClusterRca highHeapUsageClusterRca;\n+\n+  public HeapBasedDecider(long evalIntervalSeconds, int decisionFrequency, HighHeapUsageClusterRca highHeapUsageClusterRca) {\n+    super(evalIntervalSeconds, decisionFrequency);\n+    this.highHeapUsageClusterRca = highHeapUsageClusterRca;\n+  }\n+\n+  /**\n+   * The Queue and Cache deciders should only be able to suggest increase of the queue size or increase of cache size if the Java heap can\n+   * sustain more live objects in it without de-gradation. What is an acceptable heap usage limit to determine this, comes from the\n+   * bucketization object in rca.conf. We compare the oldGen usage percent reported by the HighHeapUsage RCA to determine that.\n+   *\n+   * @param esNode The EsNode we are trying to make a decision for.\n+   * @return return if the OldGen heap is under-utilized or healthy and yet more can be consumed, return true; or false otherwise.\n+   */\n+  protected boolean canUseMoreHeap(NodeKey esNode) {\n+    // we add action only if heap is under-utilized or healthy and yet more can be consumed.\n+    for (ResourceFlowUnit<HotClusterSummary> clusterSummary : highHeapUsageClusterRca.getFlowUnits()) {\n+      if (clusterSummary.hasResourceSummary()) {\n+        for (HotNodeSummary nodeSummary : clusterSummary.getSummary().getHotNodeSummaryList()) {\n+          NodeKey thisNode = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+          if (thisNode.equals(esNode)) {\n+            for (HotResourceSummary hotResourceSummary : nodeSummary.getHotResourceSummaryList()) {\n+              Resource resource = hotResourceSummary.getResource();\n+              if (resource.getResourceEnum() == DECIDING_HEAP_RESOURCE_TYPE) {\n+                double oldGenUsedRatio = hotResourceSummary.getValue();\n+                double oldGenUsedPercent = oldGenUsedRatio * 100;\n+                BucketCalculator bucketCalculator;\n+                try {\n+                  bucketCalculator = rcaConf.getBucketizationSettings(OLD_GEN_TUNABLE_KEY);\n+                } catch (Exception jsonEx) {\n+                  bucketCalculator = new BasicBucketCalculator(DEFAULT_HEAP_USAGE_THRESHOLDS);\n+                  LOG.debug(\"rca.conf does not have bucketization limits specified. Using default map.\");\n+                }\n+                UsageBucket bucket = bucketCalculator.compute(oldGenUsedPercent);\n+                LOG.debug(\"Value ({}) bucketized to {}, using {}\", oldGenUsedPercent, bucket.toString(), bucketCalculator.toString());\n+                if (bucket == UsageBucket.UNDER_UTILIZED || bucket == UsageBucket.HEALTHY_WITH_BUFFER) {\n+                  return true;\n+                } else {\n+                  return false;\n+                }\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    return true;", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4OTUzOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504989538", "bodyText": "I have broken the function into two. I will keep thinking about making the loop nicer to look at if I find one. We may not block on that though.", "author": "yojs", "createdAt": "2020-10-14T21:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMjQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNTY3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504915670", "bodyText": "Indentation looks wrong here.", "author": "khushbr", "createdAt": "2020-10-14T19:20:25Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -93,13 +99,16 @@ private void configureActionPriority() {\n    */\n   private Action computeBestAction(NodeKey esNode, ResourceEnum threadPool) {\n     Action action = null;\n-\n-    for (String actionName : actionsByUserPriority) {\n-      action =\n-        getAction(actionName, esNode, threadPool, true);\n-      if (action != null) {\n-        break;\n+    if (canUseMoreHeap(esNode)) {", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NzE1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504967151", "bodyText": "private Action computeBestAction(NodeKey esNode, ResourceEnum threadPool) {\n    Action action = null;\n    if (canUseMoreHeap(esNode)) {\n      for (String actionName : actionsByUserPriority) {\n        action = getAction(actionName, esNode, threadPool, true);\n        if (action != null) {\n          break;\n        }\n      }\n    } else {\n      PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n          RcaRuntimeMetrics.NO_INCREASE_ACTION_SUGGESTED, NAME + \":\" + esNode.getHostAddress(), 1);\n    }\n    return action;\n  }", "author": "yojs", "createdAt": "2020-10-14T20:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNTY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2Nzg4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504967880", "bodyText": "I think the deletion and addition makes it look like it in the diff. This is code as it copied here. Can you check if the indentation looks right to you ?", "author": "yojs", "createdAt": "2020-10-14T20:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNTY3MA=="}], "type": "inlineReview"}, {"oid": "15f62b57536f481e4ca7ec0e5b23bd2e29eece93", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/15f62b57536f481e4ca7ec0e5b23bd2e29eece93", "message": "Extracted some part into another method for readability", "committedDate": "2020-10-14T21:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3OTczNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504979737", "bodyText": "Should we differentiate between an increase in the QueueIncreaseAction and Cache Increase Action?", "author": "aditjind", "createdAt": "2020-10-14T21:22:20Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -93,13 +99,16 @@ private void configureActionPriority() {\n    */\n   private Action computeBestAction(NodeKey esNode, ResourceEnum threadPool) {\n     Action action = null;\n-\n-    for (String actionName : actionsByUserPriority) {\n-      action =\n-        getAction(actionName, esNode, threadPool, true);\n-      if (action != null) {\n-        break;\n+    if (canUseMoreHeap(esNode)) {\n+      for (String actionName : actionsByUserPriority) {\n+        action = getAction(actionName, esNode, threadPool, true);\n+        if (action != null) {\n+          break;\n+        }\n       }\n+    } else {\n+      PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n+          RcaRuntimeMetrics.NO_INCREASE_ACTION_SUGGESTED, NAME + \":\" + esNode.getHostAddress(), 1);", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5NTI2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504995268", "bodyText": "Right, the NAME  part does that.", "author": "yojs", "createdAt": "2020-10-14T21:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3OTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NDExMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504984110", "bodyText": "Do we really need this extra variable oldGenUsedRatio?", "author": "aditjind", "createdAt": "2020-10-14T21:31:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/HeapBasedDecider.java", "diffHunk": "@@ -0,0 +1,77 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BasicBucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.BucketCalculator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.bucket.UsageBucket;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.HighHeapUsageClusterRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public abstract class HeapBasedDecider extends Decider {\n+  private static final Logger LOG = LogManager.getLogger(HeapBasedDecider.class);\n+  private static final String OLD_GEN_TUNABLE_KEY = \"old-gen\";\n+  private static final ResourceEnum DECIDING_HEAP_RESOURCE_TYPE = ResourceEnum.OLD_GEN;\n+  public static final ImmutableMap<UsageBucket, Double> DEFAULT_HEAP_USAGE_THRESHOLDS = ImmutableMap.<UsageBucket, Double>builder()\n+      .put(UsageBucket.UNDER_UTILIZED, 10.0)\n+      .put(UsageBucket.HEALTHY_WITH_BUFFER, 60.0)\n+      .put(UsageBucket.HEALTHY, 80.0)\n+      .build();\n+\n+  private HighHeapUsageClusterRca highHeapUsageClusterRca;\n+\n+  public HeapBasedDecider(long evalIntervalSeconds, int decisionFrequency, HighHeapUsageClusterRca highHeapUsageClusterRca) {\n+    super(evalIntervalSeconds, decisionFrequency);\n+    this.highHeapUsageClusterRca = highHeapUsageClusterRca;\n+  }\n+\n+  /**\n+   * The Queue and Cache deciders should only be able to suggest increase of the queue size or increase of cache size if the Java heap can\n+   * sustain more live objects in it without de-gradation. What is an acceptable heap usage limit to determine this, comes from the\n+   * bucketization object in rca.conf. We compare the oldGen usage percent reported by the HighHeapUsage RCA to determine that.\n+   *\n+   * @param esNode The EsNode we are trying to make a decision for.\n+   * @return return if the OldGen heap is under-utilized or healthy and yet more can be consumed, return true; or false otherwise.\n+   */\n+  protected boolean canUseMoreHeap(NodeKey esNode) {\n+    // we add action only if heap is under-utilized or healthy and yet more can be consumed.\n+    for (ResourceFlowUnit<HotClusterSummary> clusterSummary : highHeapUsageClusterRca.getFlowUnits()) {\n+      if (clusterSummary.hasResourceSummary()) {\n+        for (HotNodeSummary nodeSummary : clusterSummary.getSummary().getHotNodeSummaryList()) {\n+          NodeKey thisNode = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+          if (thisNode.equals(esNode)) {\n+            for (HotResourceSummary hotResourceSummary : nodeSummary.getHotResourceSummaryList()) {\n+              Resource resource = hotResourceSummary.getResource();\n+              if (resource.getResourceEnum() == DECIDING_HEAP_RESOURCE_TYPE) {\n+                double oldGenUsedRatio = hotResourceSummary.getValue();\n+                double oldGenUsedPercent = oldGenUsedRatio * 100;", "originalCommit": "2bf2312861078e724aede3c4966c678176eae54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5MjA0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/465#discussion_r504992041", "bodyText": "I was thinking about that but in the end I added that for readability. Stack variables are cheap anyways.", "author": "yojs", "createdAt": "2020-10-14T21:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NDExMA=="}], "type": "inlineReview"}]}