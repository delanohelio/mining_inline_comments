{"pr_number": 135, "pr_title": "Added unit tests for rca.samplers and rca.util", "pr_createdAt": "2020-04-07T20:30:14Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5NTMxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r406495311", "bodyText": "I would suggest we don't use static classes or initializes as much as possible.\nThe thing is your UT framework initializes once. If you set something in a static object in one of the tests, it stays there (unless explicitly reset after the tests pass). This can cause weird behaviors in your tests based on the order they execute etc.\nIf we can remove them, it will be great.", "author": "yojs", "createdAt": "2020-04-09T21:44:29Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/ControllerUtil.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca;\n+\n+/**\n+ * ControllerUtil is a singleton which provides visibility into {@link RcaController}'s state\n+ */\n+public class ControllerUtil {\n+    public static final ControllerUtil API = new ControllerUtil();", "originalCommit": "70c92cf809c7c0399a4e760bdec5d00f5fec4f63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUwMjM1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r406502354", "bodyText": "I also want to avoid static classes / members where possible. That was the intent here. rcaEnabled previously was a static member of the RcaController that could only be set via a file read through a controller method. This causes issues for the reason you mentioned in your comment: testing with static classes/methods/members sucks. That's why I extracted the read/write logic for isRcaEnabled into the singleton class here. I did this in a few other places so that I could avoid static classes and bytecode hijacking via PowerMock.", "author": "sidheart", "createdAt": "2020-04-09T22:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5NTMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM2NTMyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r408365328", "bodyText": "I removed the ControllerUtil, the RcaController can be refactored at a future time", "author": "sidheart", "createdAt": "2020-04-14T18:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5NTMxMQ=="}], "type": "inlineReview"}, {"oid": "ae79386ecc6188920a62005b558d3c68f1cb7bbe", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ae79386ecc6188920a62005b558d3c68f1cb7bbe", "message": "Added unit tests for the rca.util package\n\nThis required a few structural changes:\n- ClusterDetailsEventProcessor and ClusterUtils are now singletons\ninstead of exposing logic through static methods\n- Classes affected by the changes above have been modified and their\nunit tests have been updated.", "committedDate": "2020-04-14T18:43:15Z", "type": "forcePushed"}, {"oid": "027277c1a6b563ebb6dceafe922d28fde78b266e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/027277c1a6b563ebb6dceafe922d28fde78b266e", "message": "Added unit tests for the rca.util package\n\nThis required a few structural changes:\n- ClusterDetailsEventProcessor and ClusterUtils are now singletons\ninstead of exposing logic through static methods\n- Classes affected by the changes above have been modified and their\nunit tests have been updated.", "committedDate": "2020-04-21T20:54:43Z", "type": "forcePushed"}, {"oid": "136ae39c8aede3b1fa001e2869a27ade948f7404", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/136ae39c8aede3b1fa001e2869a27ade948f7404", "message": "Added unit tests for the rca.util package\n\nThis required a few structural changes:\n- ClusterDetailsEventProcessor and ClusterUtils are now singletons\ninstead of exposing logic through static methods\n- Classes affected by the changes above have been modified and their\nunit tests have been updated.", "committedDate": "2020-04-21T21:11:13Z", "type": "forcePushed"}, {"oid": "f0bfef0e01245d3fa4a8b6a49a464c6e5236150e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f0bfef0e01245d3fa4a8b6a49a464c6e5236150e", "message": "Added unit tests for the rca.util package\n\nThis required a few structural changes:\n- ClusterDetailsEventProcessor and ClusterUtils are now singletons\ninstead of exposing logic through static methods\n- Classes affected by the changes above have been modified and their\nunit tests have been updated.", "committedDate": "2020-04-21T21:40:55Z", "type": "forcePushed"}, {"oid": "6cea02050caa4e979bff98d52453ee5d13aec746", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6cea02050caa4e979bff98d52453ee5d13aec746", "message": "Added unit tests for the rca.util package\n\nThis required a few structural changes:\n- ClusterDetailsEventProcessor and ClusterUtils are now singletons\ninstead of exposing logic through static methods\n- Classes affected by the changes above have been modified and their\nunit tests have been updated.", "committedDate": "2020-04-21T21:51:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyNzEzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413227134", "bodyText": "We don't need to add a constructor specifically for testing purpose. you can work around this by using a utility function API provided by another unit test. (createNodeDetailsMetrics)", "author": "rguo-aws", "createdAt": "2020-04-22T18:40:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -125,11 +132,27 @@ public static NodeDetails getCurrentNodeDetails() {\n \n   public static class NodeDetails {\n \n-    private String id;\n-    private String hostAddress;\n-    private String role;\n+    private final String id;\n+    private final String hostAddress;\n+    private final String role;\n     private Boolean isMasterNode;\n \n+    /**\n+     * This constructor is provided expressly for testing purposes. In general, NodeDetails should only be\n+     * retrieved through method calls such as {@link ClusterDetailsEventProcessor#getCurrentNodeDetails()}\n+     * @param id The node's id\n+     * @param hostAddress The host's address\n+     * @param role The node's role e.g. data-node\n+     * @param isMasterNode Whether or not the node is a master node\n+     */\n+    @VisibleForTesting\n+    public NodeDetails(String id, String hostAddress, String role, Boolean isMasterNode) {", "originalCommit": "6cea02050caa4e979bff98d52453ee5d13aec746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI5OTQzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413299433", "bodyText": "Great catch! I've improved the design as you suggested and will remember this pattern for the future.", "author": "sidheart", "createdAt": "2020-04-22T20:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyNzEzNA=="}], "type": "inlineReview"}, {"oid": "a9a1668b4b30cc2a76b366a52f065b4d0569f550", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a9a1668b4b30cc2a76b366a52f065b4d0569f550", "message": "Added unit tests for the rca.util and rca.samplers packages", "committedDate": "2020-04-22T20:09:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODE1MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413358150", "bodyText": "should we make all the arguments final ?", "author": "yojs", "createdAt": "2020-04-22T21:51:40Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessorTestHelper.java", "diffHunk": "@@ -33,6 +34,11 @@ public void addNodeDetails(String nodeId, String address, boolean isMasterNode)\n     nodeDetails.add(createNodeDetailsMetrics(nodeId, address, isMasterNode));\n   }\n \n+  public static ClusterDetailsEventProcessor.NodeDetails newNodeDetails(String nodeId, String address,", "originalCommit": "a9a1668b4b30cc2a76b366a52f065b4d0569f550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxOTIyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413519223", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-04-23T05:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODQ5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413358490", "bodyText": "We added this, but are we using this ?", "author": "yojs", "createdAt": "2020-04-22T21:52:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -20,6 +20,7 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.RcaControllerHelper;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader_writer_shared.Event;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.util.JsonConverter;\n+import com.google.common.annotations.VisibleForTesting;", "originalCommit": "a9a1668b4b30cc2a76b366a52f065b4d0569f550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxOTMzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413519331", "bodyText": "Removed", "author": "sidheart", "createdAt": "2020-04-23T05:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODcwMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413358700", "bodyText": "Maybe we can remove this file from change list ?", "author": "yojs", "createdAt": "2020-04-22T21:52:51Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -29,6 +30,7 @@\n import java.util.Set;\n import java.util.stream.Collectors;\n import javax.annotation.Nullable;\n+", "originalCommit": "a9a1668b4b30cc2a76b366a52f065b4d0569f550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxOTQ3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413519479", "bodyText": "Removed", "author": "sidheart", "createdAt": "2020-04-23T05:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1ODcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1OTkyMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413359920", "bodyText": "I would expect this to return a boolean :)", "author": "yojs", "createdAt": "2020-04-22T21:55:21Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/samplers/RcaEnabledSampler.java", "diffHunk": "@@ -29,12 +30,12 @@ public void sample(SampleAggregator sampleCollector) {\n     sampleCollector.updateStat(RcaRuntimeMetrics.RCA_ENABLED, \"\", isRcaEnabled());\n   }\n \n-  private int isRcaEnabled() {\n+  @VisibleForTesting\n+  int isRcaEnabled() {", "originalCommit": "a9a1668b4b30cc2a76b366a52f065b4d0569f550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxOTUzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/135#discussion_r413519531", "bodyText": "Done", "author": "sidheart", "createdAt": "2020-04-23T05:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1OTkyMA=="}], "type": "inlineReview"}, {"oid": "37662c45d9b24ada0bda9b3d390ef901d564432c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/37662c45d9b24ada0bda9b3d390ef901d564432c", "message": "Added unit tests for the rca.util and rca.samplers packages", "committedDate": "2020-04-23T05:26:04Z", "type": "commit"}, {"oid": "37662c45d9b24ada0bda9b3d390ef901d564432c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/37662c45d9b24ada0bda9b3d390ef901d564432c", "message": "Added unit tests for the rca.util and rca.samplers packages", "committedDate": "2020-04-23T05:26:04Z", "type": "forcePushed"}]}