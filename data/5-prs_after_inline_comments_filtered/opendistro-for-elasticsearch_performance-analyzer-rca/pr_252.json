{"pr_number": 252, "pr_title": "Add NodeConfigCollector to collect node configs(threadpool capacity etc.) from ES", "pr_createdAt": "2020-06-18T22:48:07Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252", "timeline": [{"oid": "026498d317577295d15e6229792f0967b520f26f", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/026498d317577295d15e6229792f0967b520f26f", "message": "Add NodeConfigurationRca to collect threadpool config settings from each node", "committedDate": "2020-06-18T22:24:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MjMxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r445752318", "bodyText": "Please add a javadoc for this class", "author": "yojs", "createdAt": "2020-06-25T18:23:12Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/remediation/NodeConfigurationRca.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.remediation;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension.THREAD_POOL_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.NodeConfiguration;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class NodeConfigurationRca extends Rca<ResourceFlowUnit<HotNodeSummary>> {", "originalCommit": "026498d317577295d15e6229792f0967b520f26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0ODY2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r447348668", "bodyText": "added", "author": "rguo-aws", "createdAt": "2020-06-30T01:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MjMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1Mjc2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r445752761", "bodyText": "Let's add a javadoc stating how we are operating on the FlowUnits", "author": "yojs", "createdAt": "2020-06-25T18:24:02Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/remediation/NodeConfigurationRca.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.remediation;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension.THREAD_POOL_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.NodeConfiguration;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class NodeConfigurationRca extends Rca<ResourceFlowUnit<HotNodeSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeConfigurationRca.class);\n+  private final Metric threadPool_queueCapacity;\n+  private final int rcaPeriod;\n+  private int counter;\n+  private int writeQueueCapacity;\n+  private int searchQueueCapacity;\n+\n+  public <M extends Metric> NodeConfigurationRca(int rcaPeriod, M threadPool_queueCapacity) {\n+    super(5);\n+    this.threadPool_queueCapacity = threadPool_queueCapacity;\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.writeQueueCapacity = -1;\n+    this.searchQueueCapacity = -1;\n+  }\n+\n+  private void collectQueueCapacity(MetricFlowUnit flowUnit) {\n+    double writeQueueCapacity = SQLParsingUtil.readDataFromSqlResult(flowUnit.getData(),\n+        THREAD_POOL_TYPE.getField(), ThreadPoolType.WRITE.toString(), MetricsDB.MAX);\n+    if (!Double.isNaN(writeQueueCapacity)) {\n+      this.writeQueueCapacity = (int) writeQueueCapacity;\n+    }\n+    double searchQueueCapacity = SQLParsingUtil.readDataFromSqlResult(flowUnit.getData(),\n+        THREAD_POOL_TYPE.getField(), ThreadPoolType.SEARCH.toString(), MetricsDB.MAX);\n+    if (!Double.isNaN(searchQueueCapacity)) {\n+      this.searchQueueCapacity = (int) searchQueueCapacity;\n+    }\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotNodeSummary> operate() {", "originalCommit": "026498d317577295d15e6229792f0967b520f26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0ODY1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r447348651", "bodyText": "javadoc added", "author": "rguo-aws", "createdAt": "2020-06-30T01:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1Mjc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1NDMzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r445754331", "bodyText": "Can you briefly describe the rationale of using an RCA node for this ? Do you think it would be cleaner if we add a new node type called ESConfigNode ?", "author": "yojs", "createdAt": "2020-06-25T18:26:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/remediation/NodeConfigurationRca.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.remediation;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension.THREAD_POOL_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.NodeConfiguration;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class NodeConfigurationRca extends Rca<ResourceFlowUnit<HotNodeSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeConfigurationRca.class);\n+  private final Metric threadPool_queueCapacity;\n+  private final int rcaPeriod;\n+  private int counter;\n+  private int writeQueueCapacity;\n+  private int searchQueueCapacity;\n+\n+  public <M extends Metric> NodeConfigurationRca(int rcaPeriod, M threadPool_queueCapacity) {", "originalCommit": "026498d317577295d15e6229792f0967b520f26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5NDc1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r446394756", "bodyText": "@yojs are you suggesting that this should be different kind a NonLeafNode and not extend from RCA. With a FlowUnit that is more tuned to node configurations?\nI think that is cleaner in general. Will need changes to PersistorBase logic which needs to be refactored anyway to work with non flow units that are not from RCAs. It can be picked separately.", "author": "vigyasharma", "createdAt": "2020-06-26T20:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1NDMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0ODgwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r447348808", "bodyText": "Created a new type of node EsConfigNode and extend the class as PerformanceControllerConfigCollector", "author": "rguo-aws", "createdAt": "2020-06-30T01:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1NDMzMQ=="}], "type": "inlineReview"}, {"oid": "52bc51a25c562b1a5d574bd8e65508dd1f6665d3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/52bc51a25c562b1a5d574bd8e65508dd1f6665d3", "message": "Create a separate node type EsConfigNode to collect ES config settings", "committedDate": "2020-06-30T00:52:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTk0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r448075943", "bodyText": "I was actually thinking of having a custom flow unit for this type of node. It doesn't really fit into the nested HotNodeSummary and HotResourceSummary lists - the terms healthy/unhealthy do not apply to a given queue capacity conf. The new flow unit could be simply have resource and values for those resources (for each node).", "author": "vigyasharma", "createdAt": "2020-07-01T02:08:18Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/EsConfigNode.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.PerformanceAnalyzerApp;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.ExceptionsAndErrors;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaGraphMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * this is a base class for node(vertex) in RCA graph that reads configuration settings from ES.\n+ */\n+public abstract class EsConfigNode extends NonLeafNode<ResourceFlowUnit<HotNodeSummary>> {", "originalCommit": "52bc51a25c562b1a5d574bd8e65508dd1f6665d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA4NDE4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r448084181", "bodyText": "Agree. that is actually what I am planing to do. but that requires refactoring in base cluster RCA. (i.e. need to create a base node level summary and extend it to something like EsConfigFlowunit). At this moment, we still have to add this to the HotNodeSummary so that it can be parsed by the cluster level RCA.  I will create an issue and refactor it altogether.", "author": "rguo-aws", "createdAt": "2020-07-01T02:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUwOTU3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r457509570", "bodyText": "Add NodeConfigFlowUnit as a new type of Flowunit to carry node config settings across RCA graph", "author": "rguo-aws", "createdAt": "2020-07-20T15:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NTk0Mw=="}], "type": "inlineReview"}, {"oid": "310f0c019cbc4b9058861bda809862cd6b416bfb", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/310f0c019cbc4b9058861bda809862cd6b416bfb", "message": "Merge remote-tracking branch 'origin' into rguo-capacity-rca", "committedDate": "2020-07-02T00:06:10Z", "type": "commit"}, {"oid": "b1eb04d53e292e7062b5eaad98f0b9063c2f883c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b1eb04d53e292e7062b5eaad98f0b9063c2f883c", "message": "Add NodeConfigFlowunit", "committedDate": "2020-07-17T20:01:53Z", "type": "commit"}, {"oid": "9334886a81a116a676e0eac7b548acb199580e57", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9334886a81a116a676e0eac7b548acb199580e57", "message": "Merge remote-tracking branch 'origin' into rguo-capacity-rca", "committedDate": "2020-07-17T20:02:38Z", "type": "commit"}, {"oid": "6505ff79fabbfec9163474908e654faedadf1714", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6505ff79fabbfec9163474908e654faedadf1714", "message": "Fix bugs and add UTs", "committedDate": "2020-07-17T23:30:27Z", "type": "commit"}, {"oid": "97238e9b2a76c53df8f0b9b44a608006abac0f45", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/97238e9b2a76c53df8f0b9b44a608006abac0f45", "message": "remove unnecessary code", "committedDate": "2020-07-19T19:01:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwMDQ3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r457600472", "bodyText": "Shouldn't the NodeConfig use its own summary such as NodeConfigSummary ?", "author": "yojs", "createdAt": "2020-07-20T18:13:18Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/flow_units/NodeConfigFlowUnit.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage.SummaryOneofCase;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.HotNodeSummaryMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+\n+/**\n+ * a flowunit type to carry ES node configurations (queue/cache capacities, etc.)\n+ */\n+public class NodeConfigFlowUnit extends ResourceFlowUnit<HotNodeSummary> {", "originalCommit": "97238e9b2a76c53df8f0b9b44a608006abac0f45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzOTg2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/252#discussion_r457639863", "bodyText": "the problem of creating its own summary is this summary needs to be sent over to gRPC so we have to create a separate protobuf message for that. It would be better to keep the protobuf message as is to avoid duplicated code and create a new flowunit type as a wrapper to read/write config settings", "author": "rguo-aws", "createdAt": "2020-07-20T19:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwMDQ3Mg=="}], "type": "inlineReview"}]}