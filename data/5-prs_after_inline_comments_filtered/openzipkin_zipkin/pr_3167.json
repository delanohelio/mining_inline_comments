{"pr_number": 3167, "pr_title": "Update Armeria and Netty dependencies", "pr_createdAt": "2020-08-06T08:47:15Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3167", "timeline": [{"oid": "e8192d1a062d8bfac84d06e7e7bbda72613de49d", "url": "https://github.com/openzipkin/zipkin/commit/e8192d1a062d8bfac84d06e7e7bbda72613de49d", "message": "Update Armeria and Netty dependencies\nArmeria 0.99.8 -> 0.99.9\nNetty 4.1.50.Final -> 4.1.51.Final", "committedDate": "2020-08-06T08:44:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI0NzQ0MA==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466247440", "bodyText": "Don't we have try / resources now?", "author": "anuraaga", "createdAt": "2020-08-06T08:50:46Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/ZipkinHttpCollector.java", "diffHunk": "@@ -168,7 +159,7 @@ HttpResponse validateAndStoreSpans(SpanBytesDecoder decoder, ServiceRequestConte\n           return null;\n         }\n       } finally {\n-        ReferenceCountUtil.release(content);\n+        PooledObjects.close(content);", "originalCommit": "e8192d1a062d8bfac84d06e7e7bbda72613de49d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI1Mzg0Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466253843", "bodyText": "Ah let me use that. Thanks!", "author": "minwoox", "createdAt": "2020-08-06T09:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI0NzQ0MA=="}], "type": "inlineReview"}, {"oid": "f49d31665b662130ac26ab14a8711a7f019f2dc3", "url": "https://github.com/openzipkin/zipkin/commit/f49d31665b662130ac26ab14a8711a7f019f2dc3", "message": "Address the comment by @anuraaga", "committedDate": "2020-08-06T11:32:36Z", "type": "commit"}, {"oid": "7a8494c4483178c5c85b6f65088f8eb40d350b0e", "url": "https://github.com/openzipkin/zipkin/commit/7a8494c4483178c5c85b6f65088f8eb40d350b0e", "message": "Fix imports", "committedDate": "2020-08-06T11:34:36Z", "type": "commit"}, {"oid": "06d71b89f30ff9afc023274dba9a75b282351be6", "url": "https://github.com/openzipkin/zipkin/commit/06d71b89f30ff9afc023274dba9a75b282351be6", "message": "Remove arbitraliry add empty lines", "committedDate": "2020-08-06T11:38:44Z", "type": "commit"}, {"oid": "7061ac8e1f44a229bc41f58e589c89cab5b25de7", "url": "https://github.com/openzipkin/zipkin/commit/7061ac8e1f44a229bc41f58e589c89cab5b25de7", "message": "Fix tests", "committedDate": "2020-08-06T12:53:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjA3Nw==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466392077", "bodyText": "Is there any better string that only exposed by prometheus?\nWe have changed the meter tags to contain method and service name.\nFor example scrape() contains method=getHealth and service=server.internal.health.ITzipkinHealth which made this test failed. \ud83d\ude13", "author": "minwoox", "createdAt": "2020-08-06T12:57:40Z", "path": "zipkin-server/src/test/java/zipkin2/server/internal/health/ITZipkinHealth.java", "diffHunk": "@@ -73,7 +73,7 @@\n \n     // ensure we don't track health in prometheus\n     assertThat(scrape())\n-      .doesNotContain(\"health\");\n+      .doesNotContain(\"health_check\");", "originalCommit": "7061ac8e1f44a229bc41f58e589c89cab5b25de7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0ODA1Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466748052", "bodyText": "but isn't this possibly a correct positive? why would we be adding metrics for the scrape endpoint? Maybe you can dump the actual contents here.", "author": "codefromthecrypt", "createdAt": "2020-08-07T00:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjM0NQ==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466392345", "bodyText": "This one as well. Any better suggestion please?", "author": "minwoox", "createdAt": "2020-08-06T12:58:08Z", "path": "zipkin-server/src/test/java/zipkin2/server/internal/prometheus/ITZipkinMetrics.java", "diffHunk": "@@ -77,7 +77,7 @@\n \n     // ensure we don't track prometheus, UI requests in prometheus\n     assertThat(scrape())\n-      .doesNotContain(\"prometheus\")\n+      .doesNotContain(\"prometheus_notifications\")", "originalCommit": "7061ac8e1f44a229bc41f58e589c89cab5b25de7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0ODM5Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466748392", "bodyText": "similarly we intentionally shouldn't see any meta stats about prometheus. Possibly this is a correct glitch and something else we need to disable now. Stats cost money (especially in SaaS) and we don't want to blanket add things especially monitoring the monitor without being conscious about it.", "author": "codefromthecrypt", "createdAt": "2020-08-07T00:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3NDM1MA==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466774350", "bodyText": "The metric contains service=\"zipkin2.server.internal.prometheus.ZipkinMetricsController\" so it's the problem. \ud83d\ude04\nHere's the story.\nWe fixed to add FQCN of the service name for HTTP services as a metric tag in 0.99.7. line/armeria#2780\nSo if the call is made to ZipkinMetricsController.fetchMetricsFromMicrometer(),\none of the metric recorded is ...method=\"fetchMetricsFromMicrometer\",service=\"zipkin2.server.internal.prometheus.ZipkinMetricsController\",quantile=\"0.0\"...\nBut we had a bug in 0.99.8 that the MetricCollectingService is not automatically added.\nIf Armeria server is created using spring boot integration and ArmeriaSettings.isEnableMetric() returns true, MetricCollectingService is added by default.\nhttps://github.com/line/armeria/pull/2898/files#diff-58a90bb70d1f88b9c2f45ee9bddd4468R126\nhttps://github.com/line/armeria/pull/2898/files#diff-58a90bb70d1f88b9c2f45ee9bddd4468R148\nSo from 0.99.9 we add MetricCollectingService the Server so all the requests and responses are recorded by default.\nNow, metricsIsOK() is executed before prometheusIsOK() is executed during the test which records the metric about service=\"zipkin2.server.internal.prometheus.ZipkinMetricsController\" which contains prometheus that make the test fails.", "author": "minwoox", "createdAt": "2020-08-07T01:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3NTMwNA==", "url": "https://github.com/openzipkin/zipkin/pull/3167#discussion_r466775304", "bodyText": "So it's better not to add MetricCollectingService by default using ArmeriaSettings? \ud83e\udd14", "author": "minwoox", "createdAt": "2020-08-07T01:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5MjM0NQ=="}], "type": "inlineReview"}, {"oid": "e1de66ec204b74e3ea72372e8c4447c1edd64f41", "url": "https://github.com/openzipkin/zipkin/commit/e1de66ec204b74e3ea72372e8c4447c1edd64f41", "message": "Fix license year", "committedDate": "2020-08-06T14:50:17Z", "type": "commit"}, {"oid": "f5d477c8d0216f7c081f944820be160e0eafbec7", "url": "https://github.com/openzipkin/zipkin/commit/f5d477c8d0216f7c081f944820be160e0eafbec7", "message": "Disable `ArmeriaSettings.enableMetrics`", "committedDate": "2020-08-07T02:20:30Z", "type": "commit"}]}