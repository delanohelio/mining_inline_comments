{"pr_number": 3136, "pr_title": "Refactors DelayLimiter in preparation of re-use in cassandra v1", "pr_createdAt": "2020-07-05T01:22:24Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3136", "timeline": [{"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "url": "https://github.com/openzipkin/zipkin/commit/f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "message": "Refactors DelayLimiter in preparation of re-use in cassandra v1\n\nThis refactors code relating to DelayLimiter so that it is easier to\nreuse later. What will happen in a separate PR (or what will be\nattempted) is change the limiter so that it can run a predicate instead\nof an exact match. For example Cassandra v1's Indexer currently mutes\nindex insertions which are logically equivalent to data already written.\n\nConcretely, a service name that appears 3 times in the same trace,\nresults in two writes (earliest and latest). If it appears again, and\nbetween those timestamps, that write is muted as it is redundant.", "committedDate": "2020-07-05T01:16:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTg5Ng==", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819896", "bodyText": "changes like this, just strangle guava usages to be replaced by DelayLimiter into one place", "author": "codefromthecrypt", "createdAt": "2020-07-05T01:23:21Z", "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CassandraSpanConsumer.java", "diffHunk": "@@ -14,7 +14,6 @@\n package zipkin2.storage.cassandra.v1;\n \n import com.datastax.driver.core.Session;\n-import com.google.common.cache.CacheBuilderSpec;", "originalCommit": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTkwMg==", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819902", "bodyText": "later, this code will change to DelayLimiter (or an extension of it)", "author": "codefromthecrypt", "createdAt": "2020-07-05T01:23:44Z", "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CompositeIndexer.java", "diffHunk": "@@ -27,19 +27,21 @@\n   private final Set<Indexer> indexers;\n   // Shared across all threads as updates can come from any thread.\n   // Shared for all indexes to make data management easier (ex. maximumSize)\n-  private final ConcurrentMap<PartitionKeyToTraceId, Pair> sharedState;\n+  private final Map<PartitionKeyToTraceId, Pair> sharedState;\n \n-  CompositeIndexer(CassandraStorage storage, CacheBuilderSpec spec, int indexTtl) {\n-    this.sharedState = CacheBuilder.from(spec).<PartitionKeyToTraceId, Pair>build().asMap();\n+  CompositeIndexer(CassandraStorage storage, int indexTtl) {\n+    sharedState = CacheBuilder.newBuilder()", "originalCommit": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTk1MQ==", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819951", "bodyText": "this parameter changed because the units are different. Ex the index mutes are second granularity", "author": "codefromthecrypt", "createdAt": "2020-07-05T01:24:25Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchSpanConsumer.java", "diffHunk": "@@ -46,13 +46,13 @@\n     this.indexTypeDelimiter = es.indexTypeDelimiter();\n     this.searchEnabled = es.searchEnabled();\n     this.delayLimiter = DelayLimiter.newBuilder()\n-      .ttl(es.autocompleteTtl())\n+      .ttl(es.autocompleteTtl(), TimeUnit.MILLISECONDS)", "originalCommit": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTk4NQ==", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819985", "bodyText": "these defaults and the factory method were not used except in the benchmarks.", "author": "codefromthecrypt", "createdAt": "2020-07-05T01:25:07Z", "path": "zipkin/src/main/java/zipkin2/internal/DelayLimiter.java", "diffHunk": "@@ -21,67 +21,52 @@\n /** Limits invocations of a given context to at most once per period. */\n // this is a dependency-free variant formerly served by an expiring guava cache\n public final class DelayLimiter<C> {\n-\n-  public static <C> DelayLimiter<C> create() {\n-    return new Builder().build();\n-  }\n-\n   public static Builder newBuilder() {\n     return new Builder();\n   }\n \n   public static final class Builder {\n-    Ticker ticker = new Ticker();\n-    long ttlNanos = TimeUnit.HOURS.toNanos(1); // legacy default from cassandra", "originalCommit": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}