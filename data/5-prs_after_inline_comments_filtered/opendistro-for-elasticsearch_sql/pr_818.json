{"pr_number": 818, "pr_title": "Support CASE clause in new engine", "pr_createdAt": "2020-11-11T22:59:18Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818", "timeline": [{"oid": "df822cd4d0f75ebd74c9610f3356c2cf49b30517", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/df822cd4d0f75ebd74c9610f3356c2cf49b30517", "message": "Change grammar and UT", "committedDate": "2020-11-09T21:15:38Z", "type": "commit"}, {"oid": "3c70956a51caf95076990b2989ca759504f30528", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3c70956a51caf95076990b2989ca759504f30528", "message": "Add case expression", "committedDate": "2020-11-09T21:15:39Z", "type": "commit"}, {"oid": "2db99d08216b133f913414c16ab049de4556f7b4", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2db99d08216b133f913414c16ab049de4556f7b4", "message": "Pass jacoco in sql module", "committedDate": "2020-11-09T21:15:39Z", "type": "commit"}, {"oid": "86c8be9252ed71b1cb7191a12dc06f68bc3fa1d4", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/86c8be9252ed71b1cb7191a12dc06f68bc3fa1d4", "message": "Pass jacoco in core module and refactor when clause", "committedDate": "2020-11-10T23:43:26Z", "type": "commit"}, {"oid": "f40cf474ea947e37dec99cb7da32d9fa65be0354", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f40cf474ea947e37dec99cb7da32d9fa65be0354", "message": "Fix broken IT and add javadoc", "committedDate": "2020-11-11T02:15:21Z", "type": "commit"}, {"oid": "7890d56f49a24365246cfa73ae6fb5b58e963acf", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7890d56f49a24365246cfa73ae6fb5b58e963acf", "message": "Add comparison test for basic case", "committedDate": "2020-11-11T02:25:16Z", "type": "commit"}, {"oid": "7dbb36ebb350eba8e980548a7c41f8635a328df4", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7dbb36ebb350eba8e980548a7c41f8635a328df4", "message": "Add comparison test for complex case", "committedDate": "2020-11-11T02:29:55Z", "type": "commit"}, {"oid": "05fdfea64d5d528a0eb5110a248b7b5dd5eacef8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/05fdfea64d5d528a0eb5110a248b7b5dd5eacef8", "message": "Add doctest", "committedDate": "2020-11-11T21:32:38Z", "type": "commit"}, {"oid": "59d52b198c81b751a58413d9fb69fd63d3c16edf", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/59d52b198c81b751a58413d9fb69fd63d3c16edf", "message": "Add type check", "committedDate": "2020-11-11T22:50:23Z", "type": "commit"}, {"oid": "509c64835044066c663871ff2e423bf8e0204c40", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/509c64835044066c663871ff2e423bf8e0204c40", "message": "Prepare PR", "committedDate": "2020-11-11T23:27:54Z", "type": "commit"}, {"oid": "abd8a7c45bf985426cd52229dfc3d876d41560db", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/abd8a7c45bf985426cd52229dfc3d876d41560db", "message": "Prepare PR", "committedDate": "2020-11-11T23:50:27Z", "type": "commit"}, {"oid": "0e25a2308b21bf001509229939056f2781ab65bf", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0e25a2308b21bf001509229939056f2781ab65bf", "message": "Merge branch 'develop' into support-case-statement-in-new-engine", "committedDate": "2020-11-13T21:06:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDE2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#discussion_r523264169", "bodyText": "Can we merge two different case...when logic in the AstBuilder?", "author": "penghuo", "createdAt": "2020-11-13T22:22:22Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/analysis/ExpressionAnalyzer.java", "diffHunk": "@@ -163,6 +169,43 @@ public Expression visitCompare(Compare node, AnalysisContext context) {\n         repository.compile(functionName, Arrays.asList(left, right));\n   }\n \n+  @Override\n+  public Expression visitCase(Case node, AnalysisContext context) {\n+    List<WhenClause> whens = new ArrayList<>();\n+    for (When when : node.getWhenClauses()) {\n+      if (node.getCaseValue() == null) {\n+        whens.add((WhenClause) analyze(when, context));\n+      } else {\n+        // Merge case value and condition (compare value) into a single equal condition\n+        whens.add((WhenClause) analyze(\n+            new When(\n+                new Function(\"=\", Arrays.asList(node.getCaseValue(), when.getCondition())),\n+                when.getResult()\n+            ), context));\n+      }", "originalCommit": "0e25a2308b21bf001509229939056f2781ab65bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2Mjc0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#discussion_r524462741", "bodyText": "yeah, we can, but I was thinking make AST close to original form and do this equivalent transform and type check in analyzer together.", "author": "dai-chen", "createdAt": "2020-11-16T17:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDE2OQ=="}], "type": "inlineReview"}, {"oid": "c3aec2c8cef61d9933fe86b3835537dc713bb1ae", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c3aec2c8cef61d9933fe86b3835537dc713bb1ae", "message": "Address PR comments", "committedDate": "2020-11-16T21:09:31Z", "type": "commit"}]}