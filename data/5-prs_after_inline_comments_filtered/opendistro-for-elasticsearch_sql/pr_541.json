{"pr_number": 541, "pr_title": "Support aggregations min, max", "pr_createdAt": "2020-06-30T16:55:41Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541", "timeline": [{"oid": "2a82d3a6edb0180828a04913b9bc70621f2ca849", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2a82d3a6edb0180828a04913b9bc70621f2ca849", "message": "Support aggregations min, max", "committedDate": "2020-06-30T02:19:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NjM4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r447846389", "bodyText": "So if any field is NULL, then null is returned as result? Are we following some spec here? I checked MySQL and ANSI SQL, it seems \"All aggregate functions except COUNT(*) will ignore NULL values when computing their results.\" Unless all fields are null, result won't be null eventually.\nFor example, the result is 2 for the following test data and query.\nCREATE TABLE Test(age INT);\n\nINSERT INTO Test VALUES(1);\nINSERT INTO Test VALUES(null);\nINSERT INTO Test VALUES(2);\n\nSELECT MAX(age) FROM Test", "author": "dai-chen", "createdAt": "2020-06-30T17:10:10Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/MinAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.aggregation;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.doubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.floatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getDoubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getFloatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getIntegerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getLongValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.integerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.longValue;\n+import static com.amazon.opendistroforelasticsearch.sql.utils.ExpressionUtils.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprNullValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.BuiltinFunctionName;\n+import com.amazon.opendistroforelasticsearch.sql.storage.bindingtuple.BindingTuple;\n+import java.util.List;\n+\n+/**\n+ * The minimum aggregator aggregate the value evaluated by the expression.\n+ * If the expression evaluated result is NULL or MISSING, then the result is NULL.\n+ */\n+public class MinAggregator extends Aggregator<MinAggregator.MinState> {\n+\n+  public MinAggregator(List<Expression> arguments, ExprType returnType) {\n+    super(BuiltinFunctionName.MIN.getName(), arguments, returnType);\n+  }\n+\n+\n+  @Override\n+  public MinState create() {\n+    return new MinState(returnType);\n+  }\n+\n+  @Override\n+  public MinState iterate(BindingTuple tuple, MinState state) {\n+    Expression expression = getArguments().get(0);\n+    ExprValue value = expression.valueOf(tuple);\n+    if (value.isNull() || value.isMissing()) {\n+      state.isNullResult = true;\n+    } else {\n+      state.min(value);\n+    }\n+    return state;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return String.format(\"min(%s)\", format(getArguments()));\n+  }\n+\n+  protected class MinState implements AggregationState {\n+    private final ExprType type;\n+    private ExprValue minResult;\n+    private boolean isNullResult;\n+\n+    public MinState(ExprType type) {\n+      this.type = type;\n+      minResult = doubleValue(Double.MAX_VALUE);\n+      isNullResult = false;\n+    }\n+\n+    public void min(ExprValue value) {\n+      switch (type) {\n+        case INTEGER:\n+          minResult = integerValue(Math.min(getIntegerValue(minResult), getIntegerValue(value)));\n+          break;\n+        case LONG:\n+          minResult = longValue(Math.min(getLongValue(minResult), getLongValue(value)));\n+          break;\n+        case FLOAT:\n+          minResult = floatValue(Math.min(getFloatValue(minResult), getFloatValue(value)));\n+          break;\n+        case DOUBLE:\n+          minResult = doubleValue(Math.min(getDoubleValue(minResult), getDoubleValue(value)));\n+          break;\n+        default:\n+          throw new ExpressionEvaluationException(\n+              String.format(\"unexpected type [%s] in min aggregation\", type));\n+      }\n+    }\n+\n+    @Override\n+    public ExprValue result() {\n+      return isNullResult ? ExprNullValue.of() : minResult;", "originalCommit": "2a82d3a6edb0180828a04913b9bc70621f2ca849", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2MzIzMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r448063230", "bodyText": "+1, we should follow https://asterixdb.apache.org/docs/0.9.3/sqlpp/manual.html#Aggregation_functions ARRAY_XXXX\nOur previous implementation of SUM, AVG, COUNT also need to be changed.", "author": "penghuo", "createdAt": "2020-07-01T01:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NjM4OQ=="}], "type": "inlineReview"}, {"oid": "300619098fe15a176161331a34b00f94dc2f26b0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/300619098fe15a176161331a34b00f94dc2f26b0", "message": "update", "committedDate": "2020-07-10T22:46:10Z", "type": "commit"}, {"oid": "58a50826b20c11a2a4c88f8cb6167a5e26e25738", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/58a50826b20c11a2a4c88f8cb6167a5e26e25738", "message": "support string in max and min", "committedDate": "2020-07-17T17:55:29Z", "type": "commit"}, {"oid": "0828ef1abaa35a7244cb2fcce8beeadbc05eb28c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0828ef1abaa35a7244cb2fcce8beeadbc05eb28c", "message": "Merge remote-tracking branch 'upstream/develop' into agg\n\n# Conflicts:\n#\tcore/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/SumAggregator.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/AvgAggregatorTest.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/SumAggregatorTest.java", "committedDate": "2020-07-17T18:04:17Z", "type": "commit"}, {"oid": "68556f8b7510421addcb94b68d898538d9387fcc", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/68556f8b7510421addcb94b68d898538d9387fcc", "message": "update", "committedDate": "2020-07-17T18:57:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzczNQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r458377735", "bodyText": "Can this isEmptyCollection be replaced by count == 0? Because I notice count already represents the count of non-null/missing value only. Same question for all other aggregators.", "author": "dai-chen", "createdAt": "2020-07-21T20:47:06Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/AvgAggregator.java", "diffHunk": "@@ -63,19 +62,19 @@ public String toString() {\n   /**\n    * Average State.\n    */\n-  protected class AvgState implements AggregationState {\n+  protected static class AvgState implements AggregationState {\n     private int count;\n     private double total;\n-    private boolean isNullResult = false;\n+    private boolean isEmptyCollection = true;\n \n-    public AvgState() {\n+    AvgState() {\n       this.count = 0;\n       this.total = 0d;\n     }\n \n     @Override\n     public ExprValue result() {\n-      return isNullResult ? ExprNullValue.of() : ExprValueUtils.doubleValue(total / count);\n+      return isEmptyCollection ? ExprNullValue.of() : ExprValueUtils.doubleValue(total / count);", "originalCommit": "68556f8b7510421addcb94b68d898538d9387fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY3Nzk4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r478677981", "bodyText": "made this change in avg/count/sum, but for min and max, we don't have to count the number so still using isEmptyCollection.", "author": "chloe-zh", "createdAt": "2020-08-27T20:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4MjY2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r458382666", "bodyText": "Just a thought: if we see more aggregate functions like MIN and MAX later (ex. window functions), probably we can consider using a single class for generalization. Because I notice only several lines different between MinAggregator and MaxAggregator.", "author": "dai-chen", "createdAt": "2020-07-21T20:56:26Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/MinAggregator.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.aggregation;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_NULL;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.doubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.floatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getDoubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getFloatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getIntegerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getLongValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getStringValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.integerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.longValue;\n+import static com.amazon.opendistroforelasticsearch.sql.utils.ExpressionUtils.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprNullValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.BuiltinFunctionName;\n+import com.amazon.opendistroforelasticsearch.sql.storage.bindingtuple.BindingTuple;\n+import java.util.List;\n+\n+/**\n+ * The minimum aggregator aggregate the value evaluated by the expression.\n+ * If the expression evaluated result is NULL or MISSING, then the result is NULL.\n+ */\n+public class MinAggregator extends Aggregator<MinAggregator.MinState> {", "originalCommit": "68556f8b7510421addcb94b68d898538d9387fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9796b096ec56491b670b9f24ba793e14c9180020", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9796b096ec56491b670b9f24ba793e14c9180020", "message": "Merge remote-tracking branch 'upstream/develop' into agg\n\n# Conflicts:\n#\tcore/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/BuiltinFunctionName.java", "committedDate": "2020-07-31T21:11:56Z", "type": "commit"}, {"oid": "0cb7af213c465f2018c1d9f93acc2c79e1b7360c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0cb7af213c465f2018c1d9f93acc2c79e1b7360c", "message": "update", "committedDate": "2020-08-03T21:04:49Z", "type": "commit"}, {"oid": "6ff06f23f69e68248b8f6bec67f8f9e29afd3bad", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ff06f23f69e68248b8f6bec67f8f9e29afd3bad", "message": "Merge remote-tracking branch 'upstream/develop' into agg\n\n# Conflicts:\n#\tinteg-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/StatsCommandIT.java", "committedDate": "2020-08-27T19:25:40Z", "type": "commit"}, {"oid": "6ec824fc0edfe49bb885fcde6b9ab2f895fd4c9f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ec824fc0edfe49bb885fcde6b9ab2f895fd4c9f", "message": "added min/max support for date, datetime, time, timestamp types", "committedDate": "2020-08-27T20:26:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDg3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r478724873", "bodyText": "np: could you add parentheses or split it into multi-line?", "author": "dai-chen", "createdAt": "2020-08-27T22:13:25Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/MinAggregator.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.aggregation;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_NULL;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.doubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.floatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getDoubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getFloatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getIntegerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getLongValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getStringValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.integerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.longValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.DOUBLE;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.FLOAT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.LONG;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.SHORT;\n+import static com.amazon.opendistroforelasticsearch.sql.utils.ExpressionUtils.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprNullValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.BuiltinFunctionName;\n+import com.amazon.opendistroforelasticsearch.sql.storage.bindingtuple.BindingTuple;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * The minimum aggregator aggregate the value evaluated by the expression.\n+ * If the expression evaluated result is NULL or MISSING, then the result is NULL.\n+ */\n+public class MinAggregator extends Aggregator<MinAggregator.MinState> {\n+\n+  public MinAggregator(List<Expression> arguments, ExprCoreType returnType) {\n+    super(BuiltinFunctionName.MIN.getName(), arguments, returnType);\n+  }\n+\n+\n+  @Override\n+  public MinState create() {\n+    return new MinState(returnType);\n+  }\n+\n+  @Override\n+  public MinState iterate(BindingTuple tuple, MinState state) {\n+    Expression expression = getArguments().get(0);\n+    ExprValue value = expression.valueOf(tuple);\n+    if (!(value.isNull() || value.isMissing())) {\n+      state.isEmptyCollection = false;\n+      state.min(value);\n+    }\n+    return state;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return String.format(\"min(%s)\", format(getArguments()));\n+  }\n+\n+  protected static class MinState implements AggregationState {\n+    private ExprValue minResult;\n+    private boolean isEmptyCollection;\n+\n+    MinState(ExprCoreType type) {\n+      minResult = isNumber(type) ? doubleValue(Double.MAX_VALUE) : LITERAL_NULL;\n+      isEmptyCollection = true;\n+    }\n+\n+    public void min(ExprValue value) {\n+      minResult = minResult.isNull() ? value : minResult.compareTo(value) < 0 ? minResult : value;", "originalCommit": "6ec824fc0edfe49bb885fcde6b9ab2f895fd4c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3NjAyNA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r493976024", "bodyText": "Done, thanks!", "author": "chloe-zh", "createdAt": "2020-09-24T00:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNjAyMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r478726020", "bodyText": "Trying to understand why we need different initial values for minResult. Can we just use literal null?", "author": "dai-chen", "createdAt": "2020-08-27T22:16:28Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/MinAggregator.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.aggregation;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_NULL;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.doubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.floatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getDoubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getFloatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getIntegerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getLongValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getStringValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.integerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.longValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.DOUBLE;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.FLOAT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.LONG;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.SHORT;\n+import static com.amazon.opendistroforelasticsearch.sql.utils.ExpressionUtils.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprNullValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.BuiltinFunctionName;\n+import com.amazon.opendistroforelasticsearch.sql.storage.bindingtuple.BindingTuple;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * The minimum aggregator aggregate the value evaluated by the expression.\n+ * If the expression evaluated result is NULL or MISSING, then the result is NULL.\n+ */\n+public class MinAggregator extends Aggregator<MinAggregator.MinState> {\n+\n+  public MinAggregator(List<Expression> arguments, ExprCoreType returnType) {\n+    super(BuiltinFunctionName.MIN.getName(), arguments, returnType);\n+  }\n+\n+\n+  @Override\n+  public MinState create() {\n+    return new MinState(returnType);\n+  }\n+\n+  @Override\n+  public MinState iterate(BindingTuple tuple, MinState state) {\n+    Expression expression = getArguments().get(0);\n+    ExprValue value = expression.valueOf(tuple);\n+    if (!(value.isNull() || value.isMissing())) {\n+      state.isEmptyCollection = false;\n+      state.min(value);\n+    }\n+    return state;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return String.format(\"min(%s)\", format(getArguments()));\n+  }\n+\n+  protected static class MinState implements AggregationState {\n+    private ExprValue minResult;\n+    private boolean isEmptyCollection;\n+\n+    MinState(ExprCoreType type) {\n+      minResult = isNumber(type) ? doubleValue(Double.MAX_VALUE) : LITERAL_NULL;", "originalCommit": "6ec824fc0edfe49bb885fcde6b9ab2f895fd4c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MTUwOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r479471508", "bodyText": "Yes sounds good", "author": "chloe-zh", "createdAt": "2020-08-28T18:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNjAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNzE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r478727171", "bodyText": "So isEmptyCollection is true only when minResult is not updated initially right? Could we remove this flag and just return minResult?", "author": "dai-chen", "createdAt": "2020-08-27T22:19:40Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/aggregation/MinAggregator.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.aggregation;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.LITERAL_NULL;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.doubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.floatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getDoubleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getFloatValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getIntegerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getLongValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.getStringValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.integerValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.longValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.DOUBLE;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.FLOAT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.LONG;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.SHORT;\n+import static com.amazon.opendistroforelasticsearch.sql.utils.ExpressionUtils.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprNullValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.BuiltinFunctionName;\n+import com.amazon.opendistroforelasticsearch.sql.storage.bindingtuple.BindingTuple;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * The minimum aggregator aggregate the value evaluated by the expression.\n+ * If the expression evaluated result is NULL or MISSING, then the result is NULL.\n+ */\n+public class MinAggregator extends Aggregator<MinAggregator.MinState> {\n+\n+  public MinAggregator(List<Expression> arguments, ExprCoreType returnType) {\n+    super(BuiltinFunctionName.MIN.getName(), arguments, returnType);\n+  }\n+\n+\n+  @Override\n+  public MinState create() {\n+    return new MinState(returnType);\n+  }\n+\n+  @Override\n+  public MinState iterate(BindingTuple tuple, MinState state) {\n+    Expression expression = getArguments().get(0);\n+    ExprValue value = expression.valueOf(tuple);\n+    if (!(value.isNull() || value.isMissing())) {\n+      state.isEmptyCollection = false;\n+      state.min(value);\n+    }\n+    return state;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return String.format(\"min(%s)\", format(getArguments()));\n+  }\n+\n+  protected static class MinState implements AggregationState {\n+    private ExprValue minResult;\n+    private boolean isEmptyCollection;\n+\n+    MinState(ExprCoreType type) {\n+      minResult = isNumber(type) ? doubleValue(Double.MAX_VALUE) : LITERAL_NULL;\n+      isEmptyCollection = true;\n+    }\n+\n+    public void min(ExprValue value) {\n+      minResult = minResult.isNull() ? value : minResult.compareTo(value) < 0 ? minResult : value;\n+    }\n+\n+    @Override\n+    public ExprValue result() {\n+      return isEmptyCollection ? ExprNullValue.of() : minResult;", "originalCommit": "6ec824fc0edfe49bb885fcde6b9ab2f895fd4c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3MTU3NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/541#discussion_r479471574", "bodyText": "Done, thanks!", "author": "chloe-zh", "createdAt": "2020-08-28T18:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNzE3MQ=="}], "type": "inlineReview"}, {"oid": "fcb3d24b5e817df9c7446ab7d7390e6eeb99ff62", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fcb3d24b5e817df9c7446ab7d7390e6eeb99ff62", "message": "address comments", "committedDate": "2020-08-28T18:33:53Z", "type": "commit"}, {"oid": "d01d6d683da6674e7e61da68238a56a0b8da5ec7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d01d6d683da6674e7e61da68238a56a0b8da5ec7", "message": "update", "committedDate": "2020-08-28T19:34:39Z", "type": "commit"}, {"oid": "a2586b00153d8f1663ce5f76767932d49ed8aee3", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a2586b00153d8f1663ce5f76767932d49ed8aee3", "message": "Merge remote-tracking branch 'upstream/develop' into agg\n\n# Conflicts:\n#\tinteg-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/StatsCommandIT.java\n#\tsql/src/main/antlr/OpenDistroSQLParser.g4", "committedDate": "2020-09-24T00:28:37Z", "type": "commit"}, {"oid": "ccad2cc1257e0c0efb7e09be20846ff3d6560fa1", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ccad2cc1257e0c0efb7e09be20846ff3d6560fa1", "message": "update", "committedDate": "2020-09-24T00:40:30Z", "type": "commit"}, {"oid": "a3b0b43c8cc7bff59f8d73658b8af841d04c856d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a3b0b43c8cc7bff59f8d73658b8af841d04c856d", "message": "address comment", "committedDate": "2020-09-24T00:43:45Z", "type": "commit"}, {"oid": "4ea7ad294ada58f1320d9094f95266c06829cbae", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4ea7ad294ada58f1320d9094f95266c06829cbae", "message": "add comparison tests", "committedDate": "2020-09-24T18:52:20Z", "type": "commit"}, {"oid": "ec1423b86fd787c1cab4a4b7da44ef2ef9e662be", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ec1423b86fd787c1cab4a4b7da44ef2ef9e662be", "message": "Merge remote-tracking branch 'upstream/develop' into agg", "committedDate": "2020-09-28T20:51:03Z", "type": "commit"}, {"oid": "2fa0af8ed7c66cfcb83115e83e759cbda27c479b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2fa0af8ed7c66cfcb83115e83e759cbda27c479b", "message": "update", "committedDate": "2020-09-29T19:24:47Z", "type": "commit"}, {"oid": "4de4f1461f1945b5c19320a6735377ca8e70d45e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4de4f1461f1945b5c19320a6735377ca8e70d45e", "message": "added doc", "committedDate": "2020-09-30T20:09:49Z", "type": "commit"}]}