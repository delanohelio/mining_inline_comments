{"pr_number": 374, "pr_title": "Integration test with external ES cluster", "pr_createdAt": "2020-03-05T01:25:11Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374", "timeline": [{"oid": "84a43814c97d49821c8bb231782a01e1b72b7b6a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/84a43814c97d49821c8bb231782a01e1b72b7b6a", "message": "Fix build issue by migrating to RestTestCase", "committedDate": "2020-02-29T02:00:34Z", "type": "commit"}, {"oid": "65099b8a1c1d50556876c8943ab3116eae6594e8", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/65099b8a1c1d50556876c8943ab3116eae6594e8", "message": "Fix query IT", "committedDate": "2020-03-03T00:12:21Z", "type": "commit"}, {"oid": "bf0ecf8de2e6288db3b0c4728e5fc16dc62bdba2", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bf0ecf8de2e6288db3b0c4728e5fc16dc62bdba2", "message": "Fix subquery IT", "committedDate": "2020-03-03T00:21:25Z", "type": "commit"}, {"oid": "a288fcf6abfe297c0bcc27693796297d468babe0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a288fcf6abfe297c0bcc27693796297d468babe0", "message": "Fix csv formatter and SQL functions IT", "committedDate": "2020-03-03T01:07:34Z", "type": "commit"}, {"oid": "c1fd82e10ed2cc997d605557b6b9dea0bbe8b4d7", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c1fd82e10ed2cc997d605557b6b9dea0bbe8b4d7", "message": "Fix aggregation and delete IT", "committedDate": "2020-03-03T01:21:54Z", "type": "commit"}, {"oid": "6efc9998fd168443c74cf029f34c15de4866e525", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6efc9998fd168443c74cf029f34c15de4866e525", "message": "Fix date IT", "committedDate": "2020-03-03T19:10:18Z", "type": "commit"}, {"oid": "44a949ada0f7002998647b13167203a0d34a631a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/44a949ada0f7002998647b13167203a0d34a631a", "message": "Fix jdbc IT", "committedDate": "2020-03-03T23:35:59Z", "type": "commit"}, {"oid": "98692513b6d3651027b425b9abe4774aba0c3973", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/98692513b6d3651027b425b9abe4774aba0c3973", "message": "Fix show and metadata IT", "committedDate": "2020-03-04T00:54:01Z", "type": "commit"}, {"oid": "d699c18e9c0ad80725f6d69f0dd55f2c8cf05d97", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d699c18e9c0ad80725f6d69f0dd55f2c8cf05d97", "message": "Fix subquery IT", "committedDate": "2020-03-04T16:25:49Z", "type": "commit"}, {"oid": "aa0df3a5862e11e59ede0c6e18094d07eae478df", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/aa0df3a5862e11e59ede0c6e18094d07eae478df", "message": "Fix date functions UT", "committedDate": "2020-03-04T22:15:20Z", "type": "commit"}, {"oid": "3cc5c10d451bf28a14eafea577897f781a690d68", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3cc5c10d451bf28a14eafea577897f781a690d68", "message": "Fix test data setup and cleanup issue", "committedDate": "2020-03-04T23:58:38Z", "type": "commit"}, {"oid": "56fe234449ea655c53ac6f253b495e908cd3cd2a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/56fe234449ea655c53ac6f253b495e908cd3cd2a", "message": "Fix correctness IT", "committedDate": "2020-03-05T00:33:05Z", "type": "commit"}, {"oid": "941e7ae8d3395db48eb70f8305abf2bb8165c76a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/941e7ae8d3395db48eb70f8305abf2bb8165c76a", "message": "Fix doctest IT", "committedDate": "2020-03-05T01:02:02Z", "type": "commit"}, {"oid": "3507e3783a9d87004b51069ae88924fcb5f53bfb", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3507e3783a9d87004b51069ae88924fcb5f53bfb", "message": "Merge branch 'master' into integ-test-migration", "committedDate": "2020-03-05T01:02:43Z", "type": "commit"}, {"oid": "74aa82cc49bbaca6f67275f36697420316e97c3d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/74aa82cc49bbaca6f67275f36697420316e97c3d", "message": "Add JavaDoc on base class", "committedDate": "2020-03-05T19:25:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyODMwMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388528300", "bodyText": "What is the reason to change this? Aren't we loosing the assertion.", "author": "abbashus", "createdAt": "2020-03-05T19:55:36Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/MetaDataQueriesIT.java", "diffHunk": "@@ -256,7 +256,7 @@ public void showWildcardIndex() throws IOException {\n \n         String pattern = String.format(\"%s.*\", TestsConstants.TEST_INDEX);\n         JSONArray dataRows = getDataRows(response);\n-        assertThat(dataRows.length(), equalTo(3));\n+        assertThat(dataRows.length(), greaterThan(0));", "originalCommit": "3507e3783a9d87004b51069ae88924fcb5f53bfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMzYxNw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388533617", "bodyText": "Good catch! I didn't figure out how to do index clean up after each set of class with the new base class. This caused this SHOW TABLE got more than the tables it use. The cleanup works now so I'm reverting this line of change. Thanks!", "author": "dai-chen", "createdAt": "2020-03-05T20:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyODMwMA=="}], "type": "inlineReview"}, {"oid": "677f46e847b95666f1a9875993c14aa0add439f0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/677f46e847b95666f1a9875993c14aa0add439f0", "message": "Address PR comments", "committedDate": "2020-03-05T20:09:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzOTQxMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388539410", "bodyText": "What is this change about?", "author": "abbashus", "createdAt": "2020-03-05T20:17:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/maker/AggMaker.java", "diffHunk": "@@ -555,6 +555,9 @@ private DateHistogramAggregationBuilder dateHistogram(MethodField field) throws\n                     case \"interval\":\n                         dateHistogram.dateHistogramInterval(new DateHistogramInterval(kv.value.toString()));\n                         break;\n+                    case \"fixed_interval\":\n+                        dateHistogram.fixedInterval(new DateHistogramInterval(kv.value.toString()));\n+                        break;", "originalCommit": "677f46e847b95666f1a9875993c14aa0add439f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MTU3OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388541578", "bodyText": "Changes regarding ES and painless API are due to the old ones we used are deprecated. The previous testing with internal cluster didn't complain about this but it became problem now with external cluster.", "author": "dai-chen", "createdAt": "2020-03-05T20:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzOTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MDQ5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388540492", "bodyText": "Sorry, not very clear about this change. Can you give an example how this affects things.", "author": "abbashus", "createdAt": "2020-03-05T20:19:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -530,9 +536,14 @@ private static String quoteParams(String... params) {\n         }\n     }\n \n+    /** Explicitly pass in name used to generate variable ID because methodName is not always valid */\n+    private Tuple<String, String> dateFunctionTemplate(String name, String methodName, SQLExpr field) {\n+        String id = nextId(name);\n+        return new Tuple<>(id, def(id, doc(field) + \".value.\" + methodName));\n+    }\n+", "originalCommit": "677f46e847b95666f1a9875993c14aa0add439f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MzcyOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388543728", "bodyText": "Sorry for confusion. Basically this is caused by the painless API changes above, for example:\nfunctionStr = dateFunctionTemplate(\"weekOfWeekyear\",\n                                   \"get(WeekFields.ISO.weekOfWeekBasedYear())\",\n                                   (SQLExpr) paramers.get(0).value);\n\nThe old dateFunctionTemplate(methodName, field) passes get(WeekFields.ISO.weekOfWeekBasedYear()) to nextId() which generates an invalid variable name in painless script. Will add a little more elaboration in JavaDoc.", "author": "dai-chen", "createdAt": "2020-03-05T20:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MDQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0NTg1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388545857", "bodyText": "Thanks, clear now.", "author": "abbashus", "createdAt": "2020-03-05T20:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MDQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0Njk3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388546976", "bodyText": "Cool. Thanks!", "author": "dai-chen", "createdAt": "2020-03-05T20:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MDQ5Mg=="}], "type": "inlineReview"}, {"oid": "64911605fbd54786b40e4269ea5c5a26ccb92127", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/64911605fbd54786b40e4269ea5c5a26ccb92127", "message": "Address PR comments", "committedDate": "2020-03-05T20:26:18Z", "type": "commit"}]}