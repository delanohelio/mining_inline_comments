{"pr_number": 870, "pr_title": "Add CSV formatter in new engine", "pr_createdAt": "2020-12-01T20:04:16Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870", "timeline": [{"oid": "04d503603fbb6b7f418d750e0d20e1b9d6b74d09", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/04d503603fbb6b7f418d750e0d20e1b9d6b74d09", "message": "support csv format in new engine", "committedDate": "2020-12-01T19:50:00Z", "type": "commit"}, {"oid": "489ac8996a42ab72071ab196e0d795c6d0d346ac", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/489ac8996a42ab72071ab196e0d795c6d0d346ac", "message": "skipped some IT cases that are not applicable in new engine", "committedDate": "2020-12-03T00:05:10Z", "type": "commit"}, {"oid": "5299e6e28e965268632e2d73d57bbe7407e39d7f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5299e6e28e965268632e2d73d57bbe7407e39d7f", "message": "udpate", "committedDate": "2020-12-03T01:08:02Z", "type": "commit"}, {"oid": "9c518d58b0b88828c954798e00b9b7bc6cdd454c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9c518d58b0b88828c954798e00b9b7bc6cdd454c", "message": "added escape option", "committedDate": "2020-12-04T05:34:42Z", "type": "commit"}, {"oid": "fc45e073563e83ee8fa3bc163f4ec5fa327a2a16", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fc45e073563e83ee8fa3bc163f4ec5fa327a2a16", "message": "added test for Format", "committedDate": "2020-12-04T19:57:15Z", "type": "commit"}, {"oid": "d96b19f7e8eac54c3ffafd22fc55618793e00bf0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d96b19f7e8eac54c3ffafd22fc55618793e00bf0", "message": "update", "committedDate": "2020-12-04T20:22:54Z", "type": "commit"}, {"oid": "6e6d58e847ece406edaa105abc6cd6e6bc5e6e8f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6e6d58e847ece406edaa105abc6cd6e6bc5e6e8f", "message": "update", "committedDate": "2020-12-07T19:50:33Z", "type": "commit"}, {"oid": "27e7dcf1f05cfe7556fd325671ae62728907bbe6", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/27e7dcf1f05cfe7556fd325671ae62728907bbe6", "message": "Merge remote-tracking branch 'upstream/develop' into csv-formatter\n\n# Conflicts:\n#\tlegacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "committedDate": "2020-12-08T18:30:02Z", "type": "commit"}, {"oid": "e6d24ff22b00f3c79343c5efddab0afdd1bd7a48", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e6d24ff22b00f3c79343c5efddab0afdd1bd7a48", "message": "added IT for ppl", "committedDate": "2020-12-08T19:29:50Z", "type": "commit"}, {"oid": "1b158985f066e76e0c2ac0c4b7685635f0e6db0b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1b158985f066e76e0c2ac0c4b7685635f0e6db0b", "message": "added IT for ppl", "committedDate": "2020-12-08T19:43:05Z", "type": "commit"}, {"oid": "8d37cba009d8e4b0fabda776c849f99f09224f30", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8d37cba009d8e4b0fabda776c849f99f09224f30", "message": "added IT for ppl", "committedDate": "2020-12-08T19:43:27Z", "type": "commit"}, {"oid": "66a6b1c102d4f4b9aa7feec0a727e63fbbf91c41", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/66a6b1c102d4f4b9aa7feec0a727e63fbbf91c41", "message": "update", "committedDate": "2020-12-08T19:47:28Z", "type": "commit"}, {"oid": "8e8656d5a2ba105d2f47884898ad4e91687eaf58", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8e8656d5a2ba105d2f47884898ad4e91687eaf58", "message": "added license header", "committedDate": "2020-12-08T19:48:52Z", "type": "commit"}, {"oid": "558b3ea7a51467132f00a4538fd687215b430594", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/558b3ea7a51467132f00a4538fd687215b430594", "message": "added test for sql", "committedDate": "2020-12-08T20:32:47Z", "type": "commit"}, {"oid": "99271a0b86d411def80e82f98e44d734c7c29682", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/99271a0b86d411def80e82f98e44d734c7c29682", "message": "added example in protocol doc", "committedDate": "2020-12-09T18:24:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1OTIzMw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539559233", "bodyText": "Could we pass this formatter object to create listener method directly without need to make formatter a global field?", "author": "dai-chen", "createdAt": "2020-12-09T18:48:37Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -109,6 +121,13 @@ public RestChannelConsumer prepareRequest(SQLQueryRequest request, NodeClient no\n       return NOT_SUPPORTED_YET;\n     }\n \n+    Format format = request.format();\n+    if (format.equals(Format.CSV)) {\n+      formatter = new CsvResponseFormatter(request.escape());\n+    } else {\n+      formatter = new JdbcResponseFormatter(PRETTY);\n+    }", "originalCommit": "99271a0b86d411def80e82f98e44d734c7c29682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNDc3MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539724770", "bodyText": "Ok, but in this case I extracted another property request: SqlRequest in RestSQLQueryAction to pass the sql request properties (including the format and sanitize option) to the listener", "author": "chloe-zh", "createdAt": "2020-12-09T23:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1OTIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczNjM0MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539736340", "bodyText": "I just realized this formatter is actually only required by createQueryResponseListener instead of both execute and explain. In this case, how about we just pass request and create specific formatter in createQueryResponseListener?", "author": "dai-chen", "createdAt": "2020-12-09T23:52:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1OTIzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc0ODQ0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539748441", "bodyText": "Yes that's also what I'm thinking about, the changes are done", "author": "chloe-zh", "createdAt": "2020-12-10T00:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1OTIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2MDg3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539560879", "bodyText": "Could we pass request params to SQLQueryRequest and hide all these request parsing logic in the query request class?", "author": "dai-chen", "createdAt": "2020-12-09T18:51:04Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSqlAction.java", "diffHunk": "@@ -154,6 +154,10 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n                                                                     sqlRequest.getSql(),\n                                                                     request.path(),\n                                                                     format.getFormatName());\n+                // set escape option if csv format\n+                if (format.equals(Format.CSV)) {\n+                    newSqlRequest.escape(SqlRequestParam.getEscapeOption(request.params()));\n+                }", "originalCommit": "99271a0b86d411def80e82f98e44d734c7c29682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNDg3NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539724874", "bodyText": "Sure, will do", "author": "chloe-zh", "createdAt": "2020-12-09T23:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2MDg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5MTg1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539591853", "bodyText": "Could you double check in CSV should we use JDK's platform independent separator or not? https://stackoverflow.com/questions/207947/how-do-i-get-a-platform-dependent-new-line-character", "author": "dai-chen", "createdAt": "2020-12-09T19:38:33Z", "path": "protocol/src/main/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/CsvResponseFormatter.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.protocol.response.QueryResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Singular;\n+\n+@RequiredArgsConstructor\n+public class CsvResponseFormatter implements ResponseFormatter<QueryResult> {\n+  private static final String INLINE_SEPARATOR = \",\";\n+  private static final String INTERLINE_SEPARATOR = \"\\n\";", "originalCommit": "99271a0b86d411def80e82f98e44d734c7c29682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNTI2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r539725267", "bodyText": "Good point, will do!", "author": "chloe-zh", "createdAt": "2020-12-09T23:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5MTg1Mw=="}], "type": "inlineReview"}, {"oid": "248dfec283734e30d3b00d6ddcb03906bfd1b04c", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/248dfec283734e30d3b00d6ddcb03906bfd1b04c", "message": "addressed comments", "committedDate": "2020-12-10T00:19:45Z", "type": "commit"}, {"oid": "81c94aa8a1130728e9926271f76a52fa63bc4e40", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/81c94aa8a1130728e9926271f76a52fa63bc4e40", "message": "added responseParams override method to sql and ppl stats actions", "committedDate": "2020-12-10T01:08:52Z", "type": "commit"}, {"oid": "ea62f08c2c75bae3a682e3e9d7cbfdef78bb5343", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ea62f08c2c75bae3a682e3e9d7cbfdef78bb5343", "message": "added unit test cases", "committedDate": "2020-12-10T20:03:43Z", "type": "commit"}, {"oid": "4c628a94694e12122185c335376947069a75ef1e", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4c628a94694e12122185c335376947069a75ef1e", "message": "update", "committedDate": "2020-12-10T20:26:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5OTIxMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r540599210", "bodyText": "Just curious why not just pass this request to createQueryResponseListener()? Any reason it has to be a class field?", "author": "dai-chen", "createdAt": "2020-12-11T00:24:18Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -93,6 +105,7 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient nod\n    * @return            channel consumer\n    */\n   public RestChannelConsumer prepareRequest(SQLQueryRequest request, NodeClient nodeClient) {\n+    this.request = request;", "originalCommit": "4c628a94694e12122185c335376947069a75ef1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2a502479814f8bbe780b099248a213e1b422242", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a2a502479814f8bbe780b099248a213e1b422242", "message": "addressed comment", "committedDate": "2020-12-11T02:48:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NjYxOA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r540676618", "bodyText": "In case we already have CsvResult abstraction. Could we make the  code like following\nCsvResult result = new CsvResult(response)\nreturn result.getCsv()", "author": "penghuo", "createdAt": "2020-12-11T04:10:02Z", "path": "protocol/src/main/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/CsvResponseFormatter.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.protocol.response.QueryResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Singular;\n+\n+@RequiredArgsConstructor\n+public class CsvResponseFormatter implements ResponseFormatter<QueryResult> {\n+  private static final String INLINE_SEPARATOR = \",\";\n+  private static final String INTERLINE_SEPARATOR = System.lineSeparator();\n+  private static final Set<String> SENSITIVE_CHAR = ImmutableSet.of(\"=\", \"+\", \"-\", \"@\");\n+\n+  private final boolean sanitize;\n+\n+  public CsvResponseFormatter() {\n+    this.sanitize = true;\n+  }\n+\n+  @Override\n+  public String format(QueryResult response) {", "originalCommit": "a2a502479814f8bbe780b099248a213e1b422242", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY3NzEwNw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/870#discussion_r540677107", "bodyText": "could we simply the logic as\nStream<String> headerAndData = (?);\nheaderAndData.stream().collect(Collectors.joining(INTERLINE_SEPARATOR))", "author": "penghuo", "createdAt": "2020-12-11T04:11:35Z", "path": "protocol/src/main/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/CsvResponseFormatter.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.protocol.response.QueryResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Singular;\n+\n+@RequiredArgsConstructor\n+public class CsvResponseFormatter implements ResponseFormatter<QueryResult> {\n+  private static final String INLINE_SEPARATOR = \",\";\n+  private static final String INTERLINE_SEPARATOR = System.lineSeparator();\n+  private static final Set<String> SENSITIVE_CHAR = ImmutableSet.of(\"=\", \"+\", \"-\", \"@\");\n+\n+  private final boolean sanitize;\n+\n+  public CsvResponseFormatter() {\n+    this.sanitize = true;\n+  }\n+\n+  @Override\n+  public String format(QueryResult response) {\n+    CsvResult result = buildCsvResult(response);\n+    String headers = String.join(INLINE_SEPARATOR, result.getHeaders());\n+    ImmutableList.Builder<String> dataLines = new ImmutableList.Builder<>();\n+    result.getData().forEach(line -> dataLines.add(String.join(INLINE_SEPARATOR, line)));\n+    return String.join(\n+        INTERLINE_SEPARATOR, headers, String.join(INTERLINE_SEPARATOR, dataLines.build()));", "originalCommit": "a2a502479814f8bbe780b099248a213e1b422242", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84f6f844fbfa5f814435851cb135aeeacb764a4d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/84f6f844fbfa5f814435851cb135aeeacb764a4d", "message": "addressed comments", "committedDate": "2020-12-11T19:25:40Z", "type": "commit"}]}