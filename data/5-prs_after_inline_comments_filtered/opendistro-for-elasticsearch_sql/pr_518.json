{"pr_number": 518, "pr_title": "[PPL] Support expression and boolean operators", "pr_createdAt": "2020-06-11T17:45:27Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518", "timeline": [{"oid": "c851c018bef2500dc282dd2f8b583fa92c02f728", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c851c018bef2500dc282dd2f8b583fa92c02f728", "message": "support expression in syntax and parser", "committedDate": "2020-06-10T04:42:59Z", "type": "commit"}, {"oid": "c7034f08b8996ac3b3ff92af3daad826825d6e56", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c7034f08b8996ac3b3ff92af3daad826825d6e56", "message": "Support nested expression in syntax", "committedDate": "2020-06-11T04:09:50Z", "type": "commit"}, {"oid": "e23ffb55529f7548f64c039a47c364bf91a40be0", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e23ffb55529f7548f64c039a47c364bf91a40be0", "message": "Support <, <=, >, >= in expression;\nCorrected column names for functions/operators;\nAdded unit tests for <, <=, >, >=.", "committedDate": "2020-06-11T17:41:23Z", "type": "commit"}, {"oid": "66b845ac921f9d8cf47f443ea6cd812603918edf", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/66b845ac921f9d8cf47f443ea6cd812603918edf", "message": "Merge branch 'expr/operator' of github.com:chloe-zh/sql into expr/operator", "committedDate": "2020-06-11T17:48:44Z", "type": "commit"}, {"oid": "202b235dbe83385fea75199a6ac8fe9bfd78ed50", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/202b235dbe83385fea75199a6ac8fe9bfd78ed50", "message": "Added tests", "committedDate": "2020-06-11T22:48:31Z", "type": "commit"}, {"oid": "5f4a171b1b3d1ed3cad70c2a19cf1b06c8b38fd9", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5f4a171b1b3d1ed3cad70c2a19cf1b06c8b38fd9", "message": "Merge remote-tracking branch 'upstream/develop' into expr/operator", "committedDate": "2020-06-11T23:40:45Z", "type": "commit"}, {"oid": "68d06edf445a92da9a86d69b0ffb7069f16d8062", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/68d06edf445a92da9a86d69b0ffb7069f16d8062", "message": "Supported NOT, XOR operators in analyzer;\nAdded integration test cases.", "committedDate": "2020-06-12T03:33:47Z", "type": "commit"}, {"oid": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d86a1cce00f1ef781e25abce40af80b9f7a95284", "message": "Support NOTEQUAL(!=)", "committedDate": "2020-06-12T20:34:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5NzE3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440297172", "bodyText": "when should we use plan text comparsion? when shoud with use matchers like verifyColumn?", "author": "penghuo", "createdAt": "2020-06-15T16:24:42Z", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/StatsCommandIT.java", "diffHunk": "@@ -81,4 +80,22 @@ public void testStatsCount() throws IOException {\n   }\n \n   // TODO: each stats aggregate function should be tested here when implemented\n+\n+  @Test\n+  public void testStatsNested() throws IOException {\n+    String result =\n+        executeQueryToString(\n+            String.format(\"source=%s | stats avg(abs(age)*2) as AGE\", TEST_INDEX_ACCOUNT));\n+    assertEquals(", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1MjA5NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r443852094", "bodyText": "To my understanding, we can use verifyColumn like matchers in most of time, but some cases that some other content other than columns and datarows are also important to veriy, so we can flexibly choose text comparison. For example, to verify the formats, or verify the explain results etc.\nAs for the case this comment referred to, I would like to verify schema, column names, result set of the aggregation, so I chose to compare text.", "author": "chloe-zh", "createdAt": "2020-06-22T22:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5NzE3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5OTYzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440299631", "bodyText": "where age %s 32 = 0 ? Moudlo? age % 32", "author": "penghuo", "createdAt": "2020-06-15T16:28:49Z", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/OperatorIT.java", "diffHunk": "@@ -0,0 +1,225 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.ppl;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.legacy.TestsConstants.TEST_INDEX_BANK;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+\n+import java.io.IOException;\n+import org.json.JSONObject;\n+import org.junit.Ignore;\n+import org.junit.jupiter.api.Test;\n+\n+public class OperatorIT extends PPLIntegTestCase {\n+  @Override\n+  public void init() throws IOException {\n+    loadIndex(Index.BANK);\n+  }\n+\n+  @Test\n+  public void testAddOperator() throws IOException {\n+    JSONObject result =\n+        executeQuery(\n+            String.format(\n+                \"source=%s | where age = 31 + 1 | fields age\",\n+                TEST_INDEX_BANK));\n+    verifyDataRows(result, rows(32));\n+  }\n+\n+  @Test\n+  public void testSubtractOperator() throws IOException {\n+    JSONObject result =\n+        executeQuery(\n+            String.format(\n+                \"source=%s | where age = 33 - 1 | fields age\",\n+                TEST_INDEX_BANK));\n+    verifyDataRows(result, rows(32));\n+  }\n+\n+  @Test\n+  public void testMultiplyOperator() throws IOException {\n+    JSONObject result =\n+        executeQuery(\n+            String.format(\n+                \"source=%s | where age = 16 * 2 | fields age\",\n+                TEST_INDEX_BANK));\n+    verifyDataRows(result, rows(32));\n+  }\n+\n+  @Test\n+  public void testDivideOperator() throws IOException {\n+    JSONObject result =\n+        executeQuery(\n+            String.format(\n+                \"source=%s | where age / 2 = 16 | fields age\",\n+                TEST_INDEX_BANK));\n+    verifyDataRows(result, rows(32), rows(33));\n+  }\n+\n+  @Test\n+  public void testModuleOperator() throws IOException {\n+    JSONObject result =\n+        executeQuery(\n+            String.format(\n+                \"source=%s | where age %s 32 = 0 | fields age\",", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5ODI4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440498282", "bodyText": "To escape % character", "author": "chloe-zh", "createdAt": "2020-06-15T23:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5OTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMDU4MA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440300580", "bodyText": "consider to add null and missing related test cases.", "author": "penghuo", "createdAt": "2020-06-15T16:30:23Z", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/OperatorIT.java", "diffHunk": "@@ -0,0 +1,225 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.ppl;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.legacy.TestsConstants.TEST_INDEX_BANK;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+\n+import java.io.IOException;\n+import org.json.JSONObject;\n+import org.junit.Ignore;\n+import org.junit.jupiter.api.Test;\n+\n+public class OperatorIT extends PPLIntegTestCase {", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5ODM1NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440498354", "bodyText": "Ok sure, will do.", "author": "chloe-zh", "createdAt": "2020-06-15T23:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMDU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMTc2NA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440301764", "bodyText": "why remove this IT? it should fail syntax check, right?", "author": "penghuo", "createdAt": "2020-06-15T16:32:27Z", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/ppl/QueryAnalysisIT.java", "diffHunk": "@@ -86,12 +85,6 @@ public void evalCommandShouldPassSemanticCheck() {\n   /**\n    * Commands that fail semantic analysis should throw {@link SemanticCheckException}.\n    */\n-  @Test", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5ODg0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440498847", "bodyText": "yes it will fails syntax since I removed unsupported stats functions from grammar file.", "author": "chloe-zh", "createdAt": "2020-06-15T23:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MTQ2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r441281461", "bodyText": "Created another PR to add syntax check: #523", "author": "chloe-zh", "createdAt": "2020-06-17T05:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMTc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxMTIzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440311231", "bodyText": "The comments is not very related to the valueComparisonTable defined in here. If there is no special handling for NULL and MISSING, the behavior should follow the generic rule defined in here. https://asterixdb.apache.org/docs/0.9.3/sqlpp/manual.html#Operator_expressions", "author": "penghuo", "createdAt": "2020-06-15T16:48:43Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/operator/predicate/BinaryPredicateOperator.java", "diffHunk": "@@ -163,6 +168,49 @@ public static void register(BuiltinFunctionRepository repository) {\n           .put(LITERAL_MISSING, LITERAL_MISSING, LITERAL_TRUE)\n           .build();\n \n+  /**\n+   * The notEqualTo logic.\n+   * A       B       A != B\n+   * NULL    NULL    FALSE\n+   * NULL    MISSING TRUE\n+   * MISSING NULL    TRUE\n+   * MISSING MISSING FALSE\n+   */\n+  private static Table<ExprValue, ExprValue, ExprValue> notEqualTable =\n+      new ImmutableTable.Builder<ExprValue, ExprValue, ExprValue>()\n+          .put(LITERAL_NULL, LITERAL_NULL, LITERAL_FALSE)\n+          .put(LITERAL_NULL, LITERAL_MISSING, LITERAL_TRUE)\n+          .put(LITERAL_MISSING, LITERAL_NULL, LITERAL_TRUE)\n+          .put(LITERAL_MISSING, LITERAL_MISSING, LITERAL_FALSE)\n+          .build();\n+\n+  /**", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5OTkxMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440499910", "bodyText": "Looks good, I will refer to this manual and make corresponding changes, thanks!", "author": "chloe-zh", "createdAt": "2020-06-15T23:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxMTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNDQwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440314409", "bodyText": "could we define notEqual as the combination of not(equal)", "author": "penghuo", "createdAt": "2020-06-15T16:54:15Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/operator/predicate/BinaryPredicateOperator.java", "diffHunk": "@@ -210,8 +260,85 @@ private static FunctionResolver equal() {\n     );\n   }\n \n-  private static Map<FunctionSignature, FunctionBuilder> predicateFunction(\n+  private static FunctionResolver notEqual() {", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MTc4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r441281785", "bodyText": "I was also thinking about it didn't figure it out yet", "author": "chloe-zh", "createdAt": "2020-06-17T05:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNDk4OA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r440314988", "bodyText": "How does this interface been used?", "author": "penghuo", "createdAt": "2020-06-15T16:55:15Z", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprValue.java", "diffHunk": "@@ -31,6 +31,11 @@\n    */\n   ExprType type();\n \n+  /**\n+   * Compare the Object value of itself to the ExprValue v.\n+   */\n+  int compareTo(ExprValue v);", "originalCommit": "d86a1cce00f1ef781e25abce40af80b9f7a95284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4NTQwMg==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/518#discussion_r441285402", "bodyText": "To compare the values of instances of the ExprValue subclasses exactly like basic java objects, for example, the comparison betweenExprIntegerValue instances like\nExprIntegerValue v1 = new ExprIntegerValue(1);\nExprIntegerValue v2 = new ExprIntegerValue(2);\n\nThen the comparison between v1 and v2 has the same behavior of the comparison between integers 1 and 2, aka:\nv1.compareTo(v2) -> -1\nv2.compareTo(v1) -> 1\nv1.compareTo(v1) -> 0", "author": "chloe-zh", "createdAt": "2020-06-17T05:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMxNDk4OA=="}], "type": "inlineReview"}, {"oid": "4ed82914520d23aa464f1f3d020503f892f06cff", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4ed82914520d23aa464f1f3d020503f892f06cff", "message": "Merge remote-tracking branch 'upstream/develop' into expr/operator", "committedDate": "2020-06-17T03:33:59Z", "type": "commit"}, {"oid": "660600268b70bb5216ccb216e7c63f82b8de336b", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/660600268b70bb5216ccb216e7c63f82b8de336b", "message": "Removed the value compare table respect to null and missing fields", "committedDate": "2020-06-17T04:12:55Z", "type": "commit"}, {"oid": "ed1c64c8935e8a3cdf832bbe2bfb44fa6f58cc0f", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ed1c64c8935e8a3cdf832bbe2bfb44fa6f58cc0f", "message": "Added syntax check exception", "committedDate": "2020-06-17T04:48:11Z", "type": "commit"}, {"oid": "9a0bd8573bea7a78baad6035218a2060c4ad98ff", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9a0bd8573bea7a78baad6035218a2060c4ad98ff", "message": "Merge remote-tracking branch 'upstream/develop' into expr/operator", "committedDate": "2020-06-22T21:10:56Z", "type": "commit"}, {"oid": "a1ce803fd5230fcfa21c5c50102d9086bd48c502", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a1ce803fd5230fcfa21c5c50102d9086bd48c502", "message": "address comments", "committedDate": "2020-06-23T04:09:58Z", "type": "commit"}, {"oid": "db50ad4b0a174afacd325b94def234debb28b377", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/db50ad4b0a174afacd325b94def234debb28b377", "message": "update", "committedDate": "2020-06-23T05:06:28Z", "type": "commit"}, {"oid": "e1b3b5d38d93e21860c1e241d3bb3955db85590a", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e1b3b5d38d93e21860c1e241d3bb3955db85590a", "message": "Removed compareTo method from ExprValue interface", "committedDate": "2020-06-25T02:47:50Z", "type": "commit"}, {"oid": "a2a8ccd053de803df771cc627b29b6037bbbc619", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a2a8ccd053de803df771cc627b29b6037bbbc619", "message": "update", "committedDate": "2020-06-26T00:20:51Z", "type": "commit"}, {"oid": "604541b7e4138684d6f33d034aaafa4b2c1a2a4d", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/604541b7e4138684d6f33d034aaafa4b2c1a2a4d", "message": "update", "committedDate": "2020-06-26T00:37:43Z", "type": "commit"}]}