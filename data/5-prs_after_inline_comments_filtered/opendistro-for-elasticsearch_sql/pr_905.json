{"pr_number": 905, "pr_title": "Added metrics for SQL query requests in new engine", "pr_createdAt": "2020-12-10T02:04:27Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905", "timeline": [{"oid": "502e1508f2585e3b5d75fc5a301d8c54687d2ffc", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/502e1508f2585e3b5d75fc5a301d8c54687d2ffc", "message": "added metrics in sql new engine query action when errors occur during query execution", "committedDate": "2020-12-10T01:06:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NjA4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r540356089", "bodyText": "As I understand, SQLService will execute/explain the request by ElasticsearchExecutionEngine which delegates to ES worker thread. In this case, this try-catch won't capture the exception (if I recall right ES's listener will intercepts and writes response so control flow won't come back here).\nIn my opinion, we should create a metric collector that implements ResponseListener. The metric collector and response formatter forms a chain which is passed to execution engine and handles response/error in Chain of Responsibility style.", "author": "dai-chen", "createdAt": "2020-12-10T17:24:58Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -109,10 +124,15 @@ public RestChannelConsumer prepareRequest(SQLQueryRequest request, NodeClient no\n       return NOT_SUPPORTED_YET;\n     }\n \n-    if (request.isExplainRequest()) {\n-      return channel -> sqlService.explain(plan, createExplainResponseListener(channel));\n+    try {\n+      if (request.isExplainRequest()) {\n+        return channel -> sqlService.explain(plan, createExplainResponseListener(channel));\n+      }\n+      return channel -> sqlService.execute(plan, createQueryResponseListener(channel));\n+    } catch (Exception e) {", "originalCommit": "502e1508f2585e3b5d75fc5a301d8c54687d2ffc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NzQ0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r540357443", "bodyText": "Because this is in new engine, exceptions like SqlParseException, ParserException and some others won't happen. Probably only SyntaxCheckException and QueryEngineException are required same as here: \n  \n    \n      sql/protocol/src/main/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatter.java\n    \n    \n         Line 104\n      in\n      85202b6\n    \n    \n    \n    \n\n        \n          \n           return (t instanceof SyntaxCheckException", "author": "dai-chen", "createdAt": "2020-12-10T17:26:54Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -179,4 +199,33 @@ private void sendResponse(RestChannel channel, RestStatus status, String content\n         status, \"application/json; charset=UTF-8\", content));\n   }\n \n+  private void reportError(RestChannel channel, Exception e, RestStatus status) {\n+    sendResponse(\n+        channel, status, ErrorMessageFactory.createErrorMessage(e, status.getStatus()).toString());\n+  }\n+\n+  private static void logAndPublishMetrics(Exception e) {\n+    if (isClientError(e)) {\n+      LOG.error(LogUtils.getRequestId() + \" Client side error during query execution\", e);\n+      Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+    } else {\n+      LOG.error(LogUtils.getRequestId() + \" Server side error during query execution\", e);\n+      Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+    }\n+  }\n+\n+  private static boolean isClientError(Exception e) {\n+    return e instanceof NullPointerException // NPE is hard to differentiate but more likely caused by bad query\n+        || e instanceof SqlParseException\n+        || e instanceof ParserException\n+        || e instanceof SQLFeatureNotSupportedException\n+        || e instanceof SQLFeatureDisabledException\n+        || e instanceof IllegalArgumentException\n+        || e instanceof IndexNotFoundException\n+        || e instanceof VerificationException\n+        || e instanceof SqlAnalysisException\n+        || e instanceof SyntaxCheckException\n+        || e instanceof SemanticCheckException;", "originalCommit": "502e1508f2585e3b5d75fc5a301d8c54687d2ffc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM2MjM5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r540362396", "bodyText": "Another thought: since earlier we've already passed \"compiling process\" in new engine, all exception occurs in execution engine should be treated as server error?", "author": "dai-chen", "createdAt": "2020-12-10T17:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NzQ0Mw=="}], "type": "inlineReview"}, {"oid": "24d86c14a7386c0ca32be67ba0af150c756e4739", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/24d86c14a7386c0ca32be67ba0af150c756e4739", "message": "addressed comments", "committedDate": "2020-12-10T22:04:15Z", "type": "commit"}, {"oid": "ec592eb7c923084e49a30e76c7dffcbdfa51ce39", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ec592eb7c923084e49a30e76c7dffcbdfa51ce39", "message": "update", "committedDate": "2020-12-11T00:07:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY0MjIyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r540642225", "bodyText": "I'm thinking should we publish server error metrics always in this method? Because at this point we've passed parsing, analyzing and planning, I assume any exception occurred should be treated as server error.\nBut this seems not true from the SELECT DATE('0') example in PR description. The semantic error can also be thrown here?", "author": "dai-chen", "createdAt": "2020-12-11T02:24:17Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -179,4 +197,17 @@ private void sendResponse(RestChannel channel, RestStatus status, String content\n         status, \"application/json; charset=UTF-8\", content));\n   }\n \n+  private static void logAndPublishMetrics(Exception e) {", "originalCommit": "ec592eb7c923084e49a30e76c7dffcbdfa51ce39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNTAwMA==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r541425000", "bodyText": "+1, after analyer/parser, all the execption should be treat as SYS error. The example like is DATE('0') may throw through runtim execption, but it is hard to know it is because of CUS error or data issue. I think it should be fine to treat it as SYS error.", "author": "penghuo", "createdAt": "2020-12-11T23:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY0MjIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY1MzU4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r540653586", "bodyText": "(Assuming this check is necessary as discussed above) I think this method should be isClientError() { return e is SyntaxCheckException or SemanticCheckException}? Otherwise like the SELECT DATE('0') example in PR description, semantic error is counted as server error.", "author": "dai-chen", "createdAt": "2020-12-11T02:57:25Z", "path": "legacy/src/main/java/com/amazon/opendistroforelasticsearch/sql/legacy/plugin/RestSQLQueryAction.java", "diffHunk": "@@ -179,4 +197,17 @@ private void sendResponse(RestChannel channel, RestStatus status, String content\n         status, \"application/json; charset=UTF-8\", content));\n   }\n \n+  private static void logAndPublishMetrics(Exception e) {\n+    if (isServerError(e)) {\n+      LOG.error(LogUtils.getRequestId() + \" Server side error during query execution\", e);\n+      Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+    } else {\n+      LOG.error(LogUtils.getRequestId() + \" Client side error during query execution\", e);\n+      Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+    }\n+  }\n+\n+  private static boolean isServerError(Exception e) {\n+    return e instanceof QueryEngineException;", "originalCommit": "ec592eb7c923084e49a30e76c7dffcbdfa51ce39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxMzYzNw==", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/905#discussion_r541213637", "bodyText": "I think it's ambiguous in the definition query engine exception now, since it consists of semantic check and expression evaluation, but we are treating semantic check exception as client error", "author": "chloe-zh", "createdAt": "2020-12-11T19:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY1MzU4Ng=="}], "type": "inlineReview"}, {"oid": "40a0bb6a95aec5fd0ea62182e27f4ed553b26452", "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/40a0bb6a95aec5fd0ea62182e27f4ed553b26452", "message": "take all errors from new query engine as server errors", "committedDate": "2020-12-14T19:16:41Z", "type": "commit"}]}