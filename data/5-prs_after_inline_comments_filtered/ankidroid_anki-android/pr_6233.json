{"pr_number": 6233, "pr_title": "clean code of the undo button", "pr_createdAt": "2020-05-20T20:26:15Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6233", "timeline": [{"oid": "79b76ab0457d27a62a9354216c2656f23152b751", "url": "https://github.com/ankidroid/Anki-Android/commit/79b76ab0457d27a62a9354216c2656f23152b751", "message": "NF: comments undo button", "committedDate": "2020-05-20T22:18:43Z", "type": "commit"}, {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "url": "https://github.com/ankidroid/Anki-Android/commit/14c9f6af08f3c6fc9b814c5be8636613b5a21496", "message": "Disable undo if slow block", "committedDate": "2020-05-20T22:22:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429151354", "bodyText": "Nit: could we use AOSP naming (m Prefix), and move these variables to the top of the class?\nAside: I don't like Hungarian Notation, but it's best to be consistent.", "author": "david-allison-1", "createdAt": "2020-05-22T09:48:53Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;\n+        boolean undoEnabled;", "originalCommit": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NjQ2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429156463", "bodyText": "Nit: Do these need to be members, or can these be function scoped?", "author": "david-allison-1", "createdAt": "2020-05-22T09:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMTUwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429401508", "bodyText": "\"these\" ? I don't know what you are referring to.\nI don't believe that there is any interest in having undoEnabled as a member of the class. It's quite easy right now to get this information from the undoEmpty and undoAvailable function. If we wanted to keep this information as a method, the code change would get bigger as it means we would need to ensure that this variable is changed each time the collection/whiteboard undo list is changed", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMzA5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429403092", "bodyText": "Are there other variables you want to move to the class level ?", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxMDY2Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429410662", "bodyText": "Disregard this, the spacing inside GitHub implied that these were member variables.", "author": "david-allison-1", "createdAt": "2020-05-22T19:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTY4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429151684", "bodyText": "nit/personal preference: isEmpty()", "author": "david-allison-1", "createdAt": "2020-05-22T09:49:36Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Whiteboard.java", "diffHunk": "@@ -402,5 +407,9 @@ public void apply() {\n             }\n             invalidate();\n         }\n+\n+        public boolean empty() {", "originalCommit": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMjMyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429402324", "bodyText": "I wanted to stay consistent with the method name of Stack. After all, UndoStack is essentially a Stack, so keeping name as consistent as possible with the Stack class seems better. After all, that is already what occurs with add, clear, size and pop.", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMjg3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429402878", "bodyText": "So I currently stick with my choice here, unless a second person share your preference", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1ODAwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429158009", "bodyText": "Could you change the title of the PR if there's a functional change mixed in", "author": "david-allison-1", "createdAt": "2020-05-22T10:03:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;\n+        boolean undoEnabled;\n+        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n+            // Whiteboard is here and strokes have been added at some point\n+            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n+            undoEnabled = !mWhiteboard.undoEmpty();\n         } else {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n+            // We can arrive here even if `mShowWhiteboard &&\n+            // mWhiteboard != null` if no stroke had ever been made\n+            undoIcon = R.drawable.ic_undo_white_24dp;\n+            undoEnabled = (colIsOpen() && getCol().undoAvailable());\n+        }\n+        int alpha;\n+        if (getControlBlocked() == ControlBlock.SLOW || !undoEnabled) {", "originalCommit": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMjQwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429402405", "bodyText": "Sorry, I thought I already did it. My bad", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1ODAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2Mjk5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429162993", "bodyText": "Nit: @DrawableRes if this needs to exist", "author": "david-allison-1", "createdAt": "2020-05-22T10:15:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;", "originalCommit": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMjY0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429402648", "bodyText": "Thanks. I didn't know this annotation", "author": "Arthur-Milchior", "createdAt": "2020-05-22T18:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2Mjk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2MzIzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429163239", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** @return Whethere there are strokes to undo */\n          \n          \n            \n                /** @return Whether there are strokes to undo */", "author": "david-allison-1", "createdAt": "2020-05-22T10:15:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Whiteboard.java", "diffHunk": "@@ -218,6 +218,11 @@ public int undoSize() {\n         return mUndo.size();\n     }\n \n+    /** @return Whethere there are strokes to undo */", "originalCommit": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "500a421fd53021424407cb6fc519b47d2792521a", "url": "https://github.com/ankidroid/Anki-Android/commit/500a421fd53021424407cb6fc519b47d2792521a", "message": "NF: factorize undoEnabled", "committedDate": "2020-05-22T18:51:12Z", "type": "forcePushed"}, {"oid": "c432c854a77f728bdec36e23c06f69fc02cc276a", "url": "https://github.com/ankidroid/Anki-Android/commit/c432c854a77f728bdec36e23c06f69fc02cc276a", "message": "NF: factorize undoIcon", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "4df47eb1e552de1918c80651163b11efe103c10f", "url": "https://github.com/ankidroid/Anki-Android/commit/4df47eb1e552de1918c80651163b11efe103c10f", "message": "NF: Factorize undoEnabled", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "2ce9d1bd6d39e24167496c73981e94b9fa614699", "url": "https://github.com/ankidroid/Anki-Android/commit/2ce9d1bd6d39e24167496c73981e94b9fa614699", "message": "NF: Factorize undoIcon", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "f741531f20a1adc0989ebc078c502802e18b10df", "url": "https://github.com/ankidroid/Anki-Android/commit/f741531f20a1adc0989ebc078c502802e18b10df", "message": "NF: Factorize undoEnabled", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "961752b37709879baf096e59839cc809791e80a6", "url": "https://github.com/ankidroid/Anki-Android/commit/961752b37709879baf096e59839cc809791e80a6", "message": "UndoStack.empty()", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "5b805e62975071b7436f1eefc9ac17d771bc93eb", "url": "https://github.com/ankidroid/Anki-Android/commit/5b805e62975071b7436f1eefc9ac17d771bc93eb", "message": "whiteboard: undoEmpty", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "180011e78b8ea800f39377a521fbef622cea0c59", "url": "https://github.com/ankidroid/Anki-Android/commit/180011e78b8ea800f39377a521fbef622cea0c59", "message": "NF: Factorize whiteboard undos\n\nNote that !mWhiteboard.undoEmpty() implies\nmWhiteboard.isUndoModeActive(), so the code actions is not changed\n\nThere are four cases to consider:\n\n* Either there is no white board shown; in which case we go to the\n\"else\" part of the code, as before\n* Either there is a whiteboard, but no stroke has ever been made. In\n  the previous code, both condition fails. In the new code, the first\n  condition fails. In both case, we go to the else part of the code.\n* Either there is some actions to undo; in which case in the previous\n  code, the first condition is satisfied; in the new code the first\n  and the second conditions are satisfied; so in both case we execute:\n  ```\n            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n            undoEnabled = true;\n```\n* Either strokes have been made, and all have been undone. In this\ncase, in the previous code the first condition fail and the second\nsuceed. In the new code the first condition succeed and the second\nfail. In both case, we execute:\n```\n            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n            undoEnabled = false;\n```", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "9072e73998718d4563bea3859fc52fe43d0befce", "url": "https://github.com/ankidroid/Anki-Android/commit/9072e73998718d4563bea3859fc52fe43d0befce", "message": "NF: factorize undoIcon", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "a12a4c8a5138295576be3a2849af1737ff0a2891", "url": "https://github.com/ankidroid/Anki-Android/commit/a12a4c8a5138295576be3a2849af1737ff0a2891", "message": "NF: factorize undoEnabled", "committedDate": "2020-05-22T19:28:55Z", "type": "commit"}, {"oid": "a12a4c8a5138295576be3a2849af1737ff0a2891", "url": "https://github.com/ankidroid/Anki-Android/commit/a12a4c8a5138295576be3a2849af1737ff0a2891", "message": "NF: factorize undoEnabled", "committedDate": "2020-05-22T19:28:55Z", "type": "forcePushed"}]}