{"pr_number": 5855, "pr_title": "Add File Space Warning before Check Database", "pr_createdAt": "2020-03-23T12:22:20Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5855", "timeline": [{"oid": "55af1539e78875b07afcf43c2f05aca71750409e", "url": "https://github.com/ankidroid/Anki-Android/commit/55af1539e78875b07afcf43c2f05aca71750409e", "message": "Extract: performIntegrityCheck\n\nWe want to add in a dialog box under certain circumstances, this is the\nfirst step, as it allows us to conditionally call the 'meat' of the\nmethod without changing the public signature", "committedDate": "2020-03-23T00:07:08Z", "type": "commit"}, {"oid": "0abdf288e00a924ba5f106742ed0556ef21efafe", "url": "https://github.com/ankidroid/Anki-Android/commit/0abdf288e00a924ba5f106742ed0556ef21efafe", "message": "Extract method: getFreeDiscSpace", "committedDate": "2020-03-23T02:03:31Z", "type": "commit"}, {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "url": "https://github.com/ankidroid/Anki-Android/commit/34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "message": "Check Database: File Space warning\n\nWe are having problems with users performing check database with\ninsufficient file space. This causes a crash.\n\nTo remedy this, we discourage the user from performing check database\nwithout enough file space.", "committedDate": "2020-03-23T12:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NTE4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396455188", "bodyText": "this comment is too cryptic for me \ud83e\udd23", "author": "mikehardy", "createdAt": "2020-03-23T13:37:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */", "originalCommit": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2MTE1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396461156", "bodyText": "Will fix.", "author": "david-allison-1", "createdAt": "2020-03-23T13:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NTE4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NzY0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396457645", "bodyText": "I have to admit I don't like the wtf's. Timber says \"log an assert message\", but what does that mean? Are these all going to change behavior unexpectedly and stop effectively mapping to error / start actually being a hard crash assert when the new Android Studio 4 de-sugaring comes in? I'd rather stick with Timber.d through Timber.e", "author": "mikehardy", "createdAt": "2020-03-23T13:40:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */\n+    public static class CollectionIntegrityCheckStatus {\n+\n+        @Nullable\n+        private final String mErrorMessage;\n+\n+        //OR:\n+        @Nullable\n+        private final Long mRequiredSpace;\n+        @Nullable\n+        private final Long mFreeSpace;\n+\n+        private CollectionIntegrityCheckStatus(long requiredSpace, long freeSpace) {\n+            this.mFreeSpace = freeSpace;\n+            this.mRequiredSpace = requiredSpace;\n+            this.mErrorMessage = null;\n+        }\n+\n+        private CollectionIntegrityCheckStatus(@NonNull String errorMessage) {\n+            this.mRequiredSpace = null;\n+            this.mFreeSpace = null;\n+            this.mErrorMessage = errorMessage;\n+        }\n+\n+        private static CollectionIntegrityCheckStatus fromError(String errorMessage) {\n+            return new CollectionIntegrityCheckStatus(errorMessage);\n+        }\n+\n+        public static CollectionIntegrityCheckStatus createInstance(Context context) {\n+\n+            Long maybeCurrentCollectionSizeInBytes = getCollectionSize(context);\n+            if (maybeCurrentCollectionSizeInBytes == null) {\n+                return fromError(context.getResources().getString(R.string.integrity_check_error_colection_load_failed));\n+            }\n+\n+            // This means that when VACUUMing a database, as much as twice the size of the original database file is\n+            // required in free disk space. - https://www.sqlite.org/lang_vacuum.html\n+            long requiredSpaceInBytes = maybeCurrentCollectionSizeInBytes * 2;\n+\n+            // We currently use the same directory as the collection for VACUUM/ANALYZE due to the SQLite APIs\n+            File collectionFile = new File(getCollectionPath(context));\n+            long freeSpace = FileUtil.getFreeDiskSpace(collectionFile, -1);\n+\n+            if (freeSpace == -1) {\n+                String readableFileSize  = Formatter.formatFileSize(context, requiredSpaceInBytes);\n+                return fromError(context.getResources().getString(R.string.integrity_check_error_remaining_filesystem_size_failed, readableFileSize));\n+            }\n+\n+            return new CollectionIntegrityCheckStatus(requiredSpaceInBytes, freeSpace);\n+        }\n+\n+        public boolean shouldWarnOnIntegrityCheck() {\n+            return this.mErrorMessage != null || fileSystemDoesNotHaveSpaceForBackup();\n+        }\n+\n+        private boolean fileSystemDoesNotHaveSpaceForBackup() {\n+            //only to be called when mErrorMessage == null\n+            if (mFreeSpace == null || mRequiredSpace == null) {\n+                Timber.wtf(\"fileSystemDoesNotHaveSpaceForBackup called in invalid state.\");", "originalCommit": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1ODc5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396458791", "bodyText": "The name is CollectionIntegrityCheckStatus but the logic is all \"do I have space for fix integrity\", should it be CollectionIntegrityStorageCheck\" or something else similar that bakes the idea it's all storage-related into it, instead of sounding like it's more general?", "author": "mikehardy", "createdAt": "2020-03-23T13:42:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */\n+    public static class CollectionIntegrityCheckStatus {", "originalCommit": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e95dd48b9906ac3c5584cc7b92ec77076721b724", "url": "https://github.com/ankidroid/Anki-Android/commit/e95dd48b9906ac3c5584cc7b92ec77076721b724", "message": "NF: Rename CollectionIntegrityStorageCheck", "committedDate": "2020-03-23T13:47:08Z", "type": "commit"}, {"oid": "315f30c07997140bed7799c762b35afc39bc4fc4", "url": "https://github.com/ankidroid/Anki-Android/commit/315f30c07997140bed7799c762b35afc39bc4fc4", "message": "NF: Improve comment", "committedDate": "2020-03-23T13:49:19Z", "type": "commit"}, {"oid": "d3f7e463dcb20ab318acd5ba6bc01502b2fb3316", "url": "https://github.com/ankidroid/Anki-Android/commit/d3f7e463dcb20ab318acd5ba6bc01502b2fb3316", "message": "Timber.wtf -> Timber.e", "committedDate": "2020-03-23T13:49:51Z", "type": "commit"}, {"oid": "5334b203db7402b09d62cb5e9998a1d6afa8c155", "url": "https://github.com/ankidroid/Anki-Android/commit/5334b203db7402b09d62cb5e9998a1d6afa8c155", "message": "Reduced string constants in Integrity Check\n\nFactored out default into code", "committedDate": "2020-03-23T14:16:10Z", "type": "commit"}, {"oid": "89a7f6450c506f9c445516c05ee0c89b0d459f11", "url": "https://github.com/ankidroid/Anki-Android/commit/89a7f6450c506f9c445516c05ee0c89b0d459f11", "message": "Dialog for Confirm Database check on upgrade\n\nWe added in a dialog to warn about file size if someone performs a check\ndatabase without space. This can come up unexpectedly when a user\nperforms check database, so we want to let a user know what is\nhappening first.", "committedDate": "2020-03-23T15:59:01Z", "type": "commit"}, {"oid": "0e1015f871c77b1907a520246a93235a4cc800c8", "url": "https://github.com/ankidroid/Anki-Android/commit/0e1015f871c77b1907a520246a93235a4cc800c8", "message": "Update content for check database\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-03-23T17:06:49Z", "type": "commit"}, {"oid": "acc715e8f255977bf56d4419279fceff51b33b9e", "url": "https://github.com/ankidroid/Anki-Android/commit/acc715e8f255977bf56d4419279fceff51b33b9e", "message": "Refactor: Change translation to use concat", "committedDate": "2020-03-23T17:22:06Z", "type": "commit"}, {"oid": "fdda9d086b38c73f398ca33c36a3a48695cbbb11", "url": "https://github.com/ankidroid/Anki-Android/commit/fdda9d086b38c73f398ca33c36a3a48695cbbb11", "message": "NF: Added additional logging", "committedDate": "2020-03-23T19:51:24Z", "type": "commit"}]}