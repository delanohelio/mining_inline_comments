{"pr_number": 5848, "pr_title": "#5740 - Add Welcome Dialog Explaining Permissions", "pr_createdAt": "2020-03-21T15:24:08Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5848", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzUxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396007515", "bodyText": "not sure if it's best practice to set our member variable prior to asking the system to go off and do something, but I think it might be?", "author": "mikehardy", "createdAt": "2020-03-21T16:40:53Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -454,11 +460,28 @@ private boolean firstCollectionOpen() {\n         if (CollectionHelper.hasStorageAccessPermission(this)) {\n             // Show error dialog if collection could not be opened\n             return CollectionHelper.getInstance().getColSafe(this) != null;\n-        } else {\n-            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+        } else if (mClosedWelcomeMessage) {\n+            // DEFECT #5847: This fails if the activity is killed.\n+            //Even if the dialog is showing, we want to show it again.\n             ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n                     REQUEST_STORAGE_PERMISSION);\n             return false;\n+        } else {\n+            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+            new MaterialDialog.Builder(this)\n+                    .title(R.string.collection_load_welcome_request_permissions_title)\n+                    .titleGravity(GravityEnum.CENTER)\n+                    .content(R.string.collection_load_welcome_request_permissions_details)\n+                    .positiveText(R.string.dialog_ok)\n+                    .onPositive((innerDialog, innerWhich) -> {\n+                        ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n+                                REQUEST_STORAGE_PERMISSION);\n+                        this.mClosedWelcomeMessage = true;", "originalCommit": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwODU4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396008587", "bodyText": "I'm not sure I understand this one. We're tracking whether welcome has been closed (which is done inside the lambda at first opportunity).\nEDIT: It doesn't matter much as it's executed async, but lets do it anyway.", "author": "david-allison-1", "createdAt": "2020-03-21T16:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzUxNQ=="}], "type": "inlineReview"}, {"oid": "d073c5cfd7c72c265ad7173519d888e86773882c", "url": "https://github.com/ankidroid/Anki-Android/commit/d073c5cfd7c72c265ad7173519d888e86773882c", "message": "#5740 - Add Dialog Requesting Permissions\n\nSome users din't feel comfortable about us requiring access to\nexternal storage.\n\nWe explain that we don't perform any malicious activities with this\nin order to hopefully alleviate concerns.", "committedDate": "2020-03-21T17:40:09Z", "type": "commit"}, {"oid": "d073c5cfd7c72c265ad7173519d888e86773882c", "url": "https://github.com/ankidroid/Anki-Android/commit/d073c5cfd7c72c265ad7173519d888e86773882c", "message": "#5740 - Add Dialog Requesting Permissions\n\nSome users din't feel comfortable about us requiring access to\nexternal storage.\n\nWe explain that we don't perform any malicious activities with this\nin order to hopefully alleviate concerns.", "committedDate": "2020-03-21T17:40:09Z", "type": "forcePushed"}]}