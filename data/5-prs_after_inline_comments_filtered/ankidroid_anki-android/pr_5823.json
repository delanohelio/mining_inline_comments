{"pr_number": 5823, "pr_title": "#5708 Fix Dynamic Deck with Options defined", "pr_createdAt": "2020-03-16T10:30:56Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5823", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkxNzc3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392917770", "bodyText": "Note: This is just used for logging, so it's fine to not internationalise.", "author": "david-allison-1", "createdAt": "2020-03-16T10:31:33Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);\n+                        }\n+                    }\n+                    if (fixCount > 0) {\n+                        mDecks.save();\n+                        problems.add(String.format(Locale.US, \"%d dynamic deck(s) had deck options.\", fixCount));", "originalCommit": "2198209fe3257ebe922f89faf699cf8b27c4767f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkxODE5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392918197", "bodyText": "This is fine to log and ignore", "author": "david-allison-1", "createdAt": "2020-03-16T10:32:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);", "originalCommit": "2198209fe3257ebe922f89faf699cf8b27c4767f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NzUwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392947502", "bodyText": "This doesn't touch the database, jut marks it as dirty.", "author": "david-allison-1", "createdAt": "2020-03-16T11:22:31Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);\n+                        }\n+                    }\n+                    if (fixCount > 0) {\n+                        mDecks.save();", "originalCommit": "2198209fe3257ebe922f89faf699cf8b27c4767f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72", "url": "https://github.com/ankidroid/Anki-Android/commit/2633c445be7b99eff4e757ed91851f6e26b03e72", "message": "#5708 Fix Dynamic Deck with Options defined\n\nA dynamic deck with \"conf\" (Deck Options) defined will crash the\nreviewer.\n\nThis adds a task to \"Check Database\" to remove Deck Options from any\ndynamic decks.\n\nWe also set CHECK_DB_AT_VERSION, so we automatically apply this fix.", "committedDate": "2020-03-18T15:37:59Z", "type": "commit"}, {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72", "url": "https://github.com/ankidroid/Anki-Android/commit/2633c445be7b99eff4e757ed91851f6e26b03e72", "message": "#5708 Fix Dynamic Deck with Options defined\n\nA dynamic deck with \"conf\" (Deck Options) defined will crash the\nreviewer.\n\nThis adds a task to \"Check Database\" to remove Deck Options from any\ndynamic decks.\n\nWe also set CHECK_DB_AT_VERSION, so we automatically apply this fix.", "committedDate": "2020-03-18T15:37:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MDQ4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394540485", "bodyText": "nit: should remove the counts from the comment as they will skew as they have now\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    int totalTasks = (mModels.all().size() * 4) + 21; // 4 things are in all-models loops, 20 things are one-offs\n          \n          \n            \n                    int totalTasks = (mModels.all().size() * 4) + 21; // a few fixes are in all-models loops, the rest are one-offs", "author": "mikehardy", "createdAt": "2020-03-18T18:01:32Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1606,7 +1607,7 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n         ArrayList<String> problems = new ArrayList<>();\n         long oldSize = file.length();\n         int currentTask = 1;\n-        int totalTasks = (mModels.all().size() * 4) + 20; // 4 things are in all-models loops, 20 things are one-offs\n+        int totalTasks = (mModels.all().size() * 4) + 21; // 4 things are in all-models loops, 20 things are one-offs", "originalCommit": "2633c445be7b99eff4e757ed91851f6e26b03e72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MTEzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394541138", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f just did 50, next is 51 sorry\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final int CHECK_DB_AT_VERSION = 21000150;\n          \n          \n            \n                public static final int CHECK_DB_AT_VERSION = 21000151;", "author": "mikehardy", "createdAt": "2020-03-18T18:02:38Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java", "diffHunk": "@@ -157,7 +157,7 @@\n      * collections being upgraded to (or after) this version must run an integrity check as it will contain fixes that\n      * all collections should have.\n      */\n-    public static final int CHECK_DB_AT_VERSION = 20900148;\n+    public static final int CHECK_DB_AT_VERSION = 21000150;", "originalCommit": "2633c445be7b99eff4e757ed91851f6e26b03e72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MjU2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394542568", "bodyText": "none of the other ones have their own block scope - they could maybe use a newline between each fix, but they don't have independent scopes", "author": "mikehardy", "createdAt": "2020-03-18T18:04:59Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {", "originalCommit": "2633c445be7b99eff4e757ed91851f6e26b03e72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU2MDA0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394560049", "bodyText": "Block scope gives you the ability to define more concise names (fixCount). I like it in this situation, as they are independent operations which ideally shouldn't be in a large function.\nWould you prefer I removed it?", "author": "david-allison-1", "createdAt": "2020-03-18T18:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MjU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU4MzI2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394583266", "bodyText": "ok - I'll go with implementor's choice ;-)", "author": "mikehardy", "createdAt": "2020-03-18T19:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MjU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MzE4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394543180", "bodyText": "maybe dynDeckFixCount? - just a more specific name so I don't think of this as global fixes", "author": "mikehardy", "createdAt": "2020-03-18T18:06:02Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;", "originalCommit": "2633c445be7b99eff4e757ed91851f6e26b03e72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff70da6263e65b0e8fb97c1a74965828ef72b5af", "url": "https://github.com/ankidroid/Anki-Android/commit/ff70da6263e65b0e8fb97c1a74965828ef72b5af", "message": "Review: Fix comment\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-03-18T18:28:26Z", "type": "commit"}, {"oid": "6d11418d667ab23ad7be4d1c9a2fd4fca0789bbc", "url": "https://github.com/ankidroid/Anki-Android/commit/6d11418d667ab23ad7be4d1c9a2fd4fca0789bbc", "message": "Fix DB Check version due to alpha upgrade\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-03-18T18:31:57Z", "type": "commit"}]}