{"pr_number": 6675, "pr_title": "Harden ReminderService response to Collection disappearing", "pr_createdAt": "2020-07-14T18:59:05Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6675", "timeline": [{"oid": "732deac14ca6dcdcd5ed526efcd5fa39cda97031", "url": "https://github.com/ankidroid/Anki-Android/commit/732deac14ca6dcdcd5ed526efcd5fa39cda97031", "message": "NF: CollectionHelper override for easier null testing\n\nThis is a much-improved way than previous attempt at testing how\nobjects handle null collections", "committedDate": "2020-07-14T18:48:40Z", "type": "commit"}, {"oid": "8d5253dc2019a8a309f4442cfc85572cd50cf697", "url": "https://github.com/ankidroid/Anki-Android/commit/8d5253dc2019a8a309f4442cfc85572cd50cf697", "message": "NF: CardBrowserTest use parent class for note addition\n\nNo need to reinvent the wheel in the sub-class test", "committedDate": "2020-07-14T18:49:06Z", "type": "commit"}, {"oid": "a59297baffb3bd42b55a49b31f2724af313bb539", "url": "https://github.com/ankidroid/Anki-Android/commit/a59297baffb3bd42b55a49b31f2724af313bb539", "message": "NF: test that demonstrates issue #6666 with null collection\n\nAlso verifies a fair bit of reminder functionality, which is a nice add", "committedDate": "2020-07-14T18:50:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NDkxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454584911", "bodyText": "This is the actual crash fix", "author": "mikehardy", "createdAt": "2020-07-14T19:15:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -70,10 +70,17 @@ public void onReceive(Context context, Intent intent) {\n         // 0 is not a valid dconf id.\n         final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n         if (dConfId == 0) {\n+            Timber.w(\"onReceive - dConfId 0, returning\");\n+            return;\n+        }\n+\n+        Collection col = CollectionHelper.getInstance().getCol(context);\n+        if (null == col || !CollectionHelper.getInstance().colIsOpen()) {", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NTMwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454585302", "bodyText": "this method has pokemon handling, nothing will come out except maybe a null return", "author": "mikehardy", "createdAt": "2020-07-14T19:15:49Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -88,11 +95,13 @@ public void onReceive(Context context, Intent intent) {\n \n         final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n         if (!notificationManager.areNotificationsEnabled()) {\n+            Timber.v(\"onReceive - notifications disabled, returning\");\n             return;\n         }\n-        List<AbstractSched.DeckDueTreeNode> decksDue = getDeckOptionDue(context, dConfId, true);\n+        List<AbstractSched.DeckDueTreeNode> decksDue = getDeckOptionDue(col, dConfId, true);", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NTU1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454585558", "bodyText": "turns out we can avoid accessing collection here entirely, the deck due node has the name", "author": "mikehardy", "createdAt": "2020-07-14T19:16:15Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -114,7 +124,7 @@ public void onReceive(Context context, Intent intent) {\n                         .setContentText(context.getResources().getQuantityString(\n                                 R.plurals.reminder_text,\n                                 total,\n-                                CollectionHelper.getInstance().getCol(context).getDecks().name(deckId),\n+                                deckDue.getFullDeckName(),", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NjIzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454586232", "bodyText": "I don't have the CollectionHelper here so I can't ask isClosed, however the db gets nulled on close, so this check should be equivalent and the col.getDecks should succeed", "author": "mikehardy", "createdAt": "2020-07-14T19:17:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -140,20 +151,19 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n     // getDeckOptionDue information, will recur one time to workaround collection close if recur is true\n     @Nullable\n-    private List<AbstractSched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n+    private List<AbstractSched.DeckDueTreeNode> getDeckOptionDue(Collection col, long dConfId, boolean recur) {\n \n-        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck option group is deleted while we\n         // are working\n-        if (col.getDecks().getConf(dConfId) == null) {\n-            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n+        if (col.getDb() != null && col.getDecks().getConf(dConfId) == null) {", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MTYxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454581617", "bodyText": "I believe getCol can throw due to permissions exceptions", "author": "david-allison-1", "createdAt": "2020-07-14T19:09:04Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -70,10 +70,17 @@ public void onReceive(Context context, Intent intent) {\n         // 0 is not a valid dconf id.\n         final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n         if (dConfId == 0) {\n+            Timber.w(\"onReceive - dConfId 0, returning\");\n+            return;\n+        }\n+\n+        Collection col = CollectionHelper.getInstance().getCol(context);", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU5MzA5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454593098", "bodyText": "I think might be right. Okay, I'll go \"full hardening\" then, not just the stuff I can easily demonstrate with the unit test I posted up", "author": "mikehardy", "createdAt": "2020-07-14T19:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MTYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU5NjE2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454596169", "bodyText": "We do have a getColSafe, but that sends an exception report. I worked around this previously in BootService", "author": "david-allison-1", "createdAt": "2020-07-14T19:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MTYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYwMDE4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454600187", "bodyText": "For ReminderService - which I never ever ever ever want to block anything else from functioning - I like the idea of complete and total hardening so I just catch throwable here. ReminderService should just never crash, it's so ancillary", "author": "mikehardy", "createdAt": "2020-07-14T19:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MTYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MjIzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454582235", "bodyText": "Nit: consolidate .getInstance to a variable", "author": "david-allison-1", "createdAt": "2020-07-14T19:10:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -70,10 +70,17 @@ public void onReceive(Context context, Intent intent) {\n         // 0 is not a valid dconf id.\n         final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n         if (dConfId == 0) {\n+            Timber.w(\"onReceive - dConfId 0, returning\");\n+            return;\n+        }\n+\n+        Collection col = CollectionHelper.getInstance().getCol(context);\n+        if (null == col || !CollectionHelper.getInstance().colIsOpen()) {", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MzMyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454583326", "bodyText": "Note: Don't think this matters as we only list the top level", "author": "david-allison-1", "createdAt": "2020-07-14T19:12:11Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -114,7 +124,7 @@ public void onReceive(Context context, Intent intent) {\n                         .setContentText(context.getResources().getQuantityString(\n                                 R.plurals.reminder_text,\n                                 total,\n-                                CollectionHelper.getInstance().getCol(context).getDecks().name(deckId),\n+                                deckDue.getFullDeckName(),", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU5NDgzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454594830", "bodyText": "While true, I wanted it to be NF just swapping in the member var access vs full-fetch-from-decks and this was I think the analogous name.", "author": "mikehardy", "createdAt": "2020-07-14T19:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4MzMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4Mzk1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454583957", "bodyText": "If the database is null, then this case is not hit. Should this be an == null OR", "author": "david-allison-1", "createdAt": "2020-07-14T19:13:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -140,20 +151,19 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n     // getDeckOptionDue information, will recur one time to workaround collection close if recur is true\n     @Nullable\n-    private List<AbstractSched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n+    private List<AbstractSched.DeckDueTreeNode> getDeckOptionDue(Collection col, long dConfId, boolean recur) {\n \n-        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck option group is deleted while we\n         // are working\n-        if (col.getDecks().getConf(dConfId) == null) {\n-            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n+        if (col.getDb() != null && col.getDecks().getConf(dConfId) == null) {", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU5NTEzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454595139", "bodyText": "Absolutely right, crucial error. Fixing", "author": "mikehardy", "createdAt": "2020-07-14T19:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4Mzk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NTgwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454585802", "bodyText": "Just for fun:\nI think this could be isCollectionWithSize or isEmptyCollection or is(empty())", "author": "david-allison-1", "createdAt": "2020-07-14T19:16:42Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/services/ReminderServiceTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.ichi2.anki.services;\n+\n+import android.app.NotificationManager;\n+import android.content.Context;\n+import android.content.Intent;\n+\n+import com.ichi2.anki.RobolectricTest;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.shadows.ShadowNotificationManager;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static com.ichi2.anki.services.ReminderService.EXTRA_DECK_ID;\n+import static com.ichi2.anki.services.ReminderService.EXTRA_DECK_OPTION_ID;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class ReminderServiceTest extends RobolectricTest {\n+\n+    @Test\n+    public void testReminderServiceNothingDue() {\n+        buildDefaultDeckReminders();\n+        assertThat(\"No notifications exist\", getNotificationManagerShadow().size() == 0);\n+    }\n+\n+\n+    @Test\n+    public void testReminderServiceReviewsDue() {\n+        addNoteUsingBasicModel(\"test front\", \"test back\");\n+        assertThat(\"No notifications exist\", getNotificationManagerShadow().size() == 0);", "originalCommit": "dd71cc28e0285c1452ae4472fd769a024c78f7a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU5NTYzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6675#discussion_r454595634", "bodyText": "true, but don't those expected notification counts line up so beautifully on the right? \ud83e\udd29  - I'm going to leave it", "author": "mikehardy", "createdAt": "2020-07-14T19:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU4NTgwMg=="}], "type": "inlineReview"}, {"oid": "a6141f19b7d22ec7c88976b58d85e7aa875af2c4", "url": "https://github.com/ankidroid/Anki-Android/commit/a6141f19b7d22ec7c88976b58d85e7aa875af2c4", "message": "Handle null collections in ReminderService\n\nin general much more careful access of the collection, and less fetching\nas well\n\nFixes #6666", "committedDate": "2020-07-14T19:36:54Z", "type": "commit"}, {"oid": "a6141f19b7d22ec7c88976b58d85e7aa875af2c4", "url": "https://github.com/ankidroid/Anki-Android/commit/a6141f19b7d22ec7c88976b58d85e7aa875af2c4", "message": "Handle null collections in ReminderService\n\nin general much more careful access of the collection, and less fetching\nas well\n\nFixes #6666", "committedDate": "2020-07-14T19:36:54Z", "type": "forcePushed"}]}