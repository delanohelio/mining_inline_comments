{"pr_number": 6104, "pr_title": "Improve \"Error Saving Note\" and block adding empty Cloze Deletions.", "pr_createdAt": "2020-05-04T16:30:20Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6104", "timeline": [{"oid": "75ec36f24f9d4f92646c8789ca543b8df92812d7", "url": "https://github.com/ankidroid/Anki-Android/commit/75ec36f24f9d4f92646c8789ca543b8df92812d7", "message": "NF NoteEditor: Extract isClozeType", "committedDate": "2020-05-04T15:12:29Z", "type": "commit"}, {"oid": "56ba9addf35424f733647044046264ea0249c801", "url": "https://github.com/ankidroid/Anki-Android/commit/56ba9addf35424f733647044046264ea0249c801", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T16:37:49Z", "type": "forcePushed"}, {"oid": "a7d0ba7faa7f87fbb8627b4f23863dfc76fa115c", "url": "https://github.com/ankidroid/Anki-Android/commit/a7d0ba7faa7f87fbb8627b4f23863dfc76fa115c", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T16:44:02Z", "type": "forcePushed"}, {"oid": "e6dd7c23a5407b4ba1a17371266fc8281caaa870", "url": "https://github.com/ankidroid/Anki-Android/commit/e6dd7c23a5407b4ba1a17371266fc8281caaa870", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T16:50:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYwNzY3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419607675", "bodyText": "I thought all of these were changed to com.ichi2.anki JSON classes to avoid the try/catch since we just throw RuntimException anyway? #5550", "author": "mikehardy", "createdAt": "2020-05-04T17:36:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1710,6 +1703,18 @@ public void onDestroyActionMode(ActionMode mode) {\n         }\n     }\n \n+\n+    private boolean isClozeType() {\n+        int noteModelType;\n+        try {\n+            noteModelType = getCurrentlySelectedModel().getInt(\"type\");\n+        } catch (JSONException e) {", "originalCommit": "75ec36f24f9d4f92646c8789ca543b8df92812d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMjYyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419612626", "bodyText": "Extracted, unchanged code, will fix. Good catch!", "author": "david-allison-1", "createdAt": "2020-05-04T17:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYwNzY3NQ=="}], "type": "inlineReview"}, {"oid": "f912a53b2ac1cb382f04ea09369aa26a03d60bb0", "url": "https://github.com/ankidroid/Anki-Android/commit/f912a53b2ac1cb382f04ea09369aa26a03d60bb0", "message": "Refactor isClozeType() - remove exception\n\nReview comment: JSONException is no longer checked, so we can optimise", "committedDate": "2020-05-04T17:46:46Z", "type": "commit"}, {"oid": "94577e5f9a2cd5740f60705fec16225fc27c814f", "url": "https://github.com/ankidroid/Anki-Android/commit/94577e5f9a2cd5740f60705fec16225fc27c814f", "message": "NF NoteEditor: Extract getCurrentFieldText\n\nSignificantly reduces lint warnings in the file", "committedDate": "2020-05-04T17:46:49Z", "type": "commit"}, {"oid": "b8343a27c5f0726713a97425055298245a040ee3", "url": "https://github.com/ankidroid/Anki-Android/commit/b8343a27c5f0726713a97425055298245a040ee3", "message": "NF: Extract getNextClozeIndex", "committedDate": "2020-05-04T17:46:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMjI1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419612254", "bodyText": "could reference these I suppose https://github.com/ankidroid/Anki-Android/blob/master/AnkiDroid/src/main/java/com/ichi2/libanki/Consts.java#L73 but your backtofront one is not represented", "author": "mikehardy", "createdAt": "2020-05-04T17:44:11Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/NoteEditorTest.java", "diffHunk": "@@ -45,22 +108,78 @@ private void enterTextIntoField(NoteEditor n, int i, String newText) {\n         n.setFieldValueFromUi(i, newText);\n     }\n \n+    private <T extends NoteEditor> T getNoteEditorAddingNote(FromScreen from, Class<T> clazz) {\n+        Intent i = new Intent();\n+        if (from == FromScreen.REVIEWER) {\n+            i.putExtra(NoteEditor.EXTRA_CALLER, NoteEditor.CALLER_REVIEWER_ADD);\n+        } else {\n+            throw new IllegalStateException(\" unhandled\");\n+        }\n \n-    private NoteEditor getNoteEditorEditingExistingBasicNote(String front, String back, FromScreen reviewer) {\n+        return super.startActivityNormallyOpenCollectionWithIntent(clazz, i);\n+    }\n+\n+    private NoteEditor getNoteEditorEditingExistingBasicNote(String front, String back, FromScreen from) {\n         Note n = super.addNoteUsingBasicModel(front, back);\n+        return getNoteEditorEditingExistingBasicNote(n, from, NoteEditor.class);\n+    }\n+\n+    private <T extends NoteEditor> T getNoteEditorEditingExistingBasicNote(Note n, FromScreen from, Class<T> clazz) {\n \n         Intent i = new Intent();\n-        if (reviewer == FromScreen.REVIEWER) {\n+        if (from == FromScreen.REVIEWER) {\n             i.putExtra(NoteEditor.EXTRA_CALLER, NoteEditor.CALLER_REVIEWER);\n             AbstractFlashcardViewer.setEditorCard(n.cards().get(0));\n         } else {\n-            throw new IllegalStateException(reviewer.toString() + \" unhandled\");\n+            throw new IllegalStateException(from.toString() + \" unhandled\");\n         }\n \n-        return super.startActivityNormallyOpenCollectionWithIntent(NoteEditor.class, i);\n+        return super.startActivityNormallyOpenCollectionWithIntent(clazz, i);\n     }\n \n     private enum FromScreen {\n         REVIEWER\n     }\n+\n+    private enum NoteType {\n+        BASIC,", "originalCommit": "70e6c17e34295af65c0950f1eaa654d1a586cc35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxNDc4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419614785", "bodyText": "I'd prefer not do so to allow future users to define their own note types (as mentioned). I'll add a comment here", "author": "david-allison-1", "createdAt": "2020-05-04T17:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMjI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYyMDA5NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419620095", "bodyText": "yeah I figured :-), resolving", "author": "mikehardy", "createdAt": "2020-05-04T17:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMjI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMzMyMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419613321", "bodyText": "Just curious for you if this actually throws for you. With reference to one of the testing failures in CardTemplateEditor I don't think the schemaMod check will ever throw in testing unless the collection is actually synchronized, so I'm expecting this to not throw and coverage to indicate the catch is never hit, but I'm curious for your direct experience", "author": "mikehardy", "createdAt": "2020-05-04T17:45:54Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -103,15 +104,44 @@ protected JSONObject getCurrentDatabaseModelCopy(String modelName) throws JSONEx\n     }\n \n     protected Note addNoteUsingBasicModel(String front, String back) {\n-        JSONObject basicModel = getCol().getModels().byName(\"Basic\");\n+        return addNoteUsingModelName(\"Basic\", front, back);\n+    }\n+\n+    protected Note addNoteUsingModelName(String name, String... fields) {\n+        JSONObject model = getCol().getModels().byName(name);\n         //PERF: if we modify newNote(), we can return the card and return a Pair<Note, Card> here.\n         //Saves a database trip afterwards.\n-        Note n = getCol().newNote(basicModel);\n-        n.setField(0, front);\n-        n.setField(1, back);\n+        Note n = getCol().newNote(model);\n+        for(int i = 0; i < fields.length; i++) {\n+            n.setField(i, fields[i]);\n+        }\n         if (getCol().addNote(n) != 1) {\n-            throw new IllegalStateException(String.format(\"Could not add note: {'%s', '%s'}\", front, back));\n+            throw new IllegalStateException(String.format(\"Could not add note: {%s}\", String.join(\", \", fields)));\n         }\n         return n;\n     }\n+\n+\n+    protected String addNonClozeModel(String name, String[] fields, String qfmt, String afmt) {\n+        JSONObject model = getCol().getModels().newModel(name);\n+        for (int i = 0; i < fields.length; i++) {\n+            addField(model, fields[i]);\n+        }\n+        model.put(FlashCardsContract.CardTemplate.QUESTION_FORMAT, qfmt);\n+        model.put(FlashCardsContract.CardTemplate.ANSWER_FORMAT, afmt);\n+        getCol().getModels().add(model);\n+        getCol().getModels().flush();\n+        return name;\n+    }\n+\n+\n+    private void addField(JSONObject model, String name) {\n+        Models models = getCol().getModels();\n+\n+        try {\n+            models.addField(model, models.newField(name));\n+        } catch (ConfirmModSchemaException e) {", "originalCommit": "70e6c17e34295af65c0950f1eaa654d1a586cc35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxNTA1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419615050", "bodyText": "Doesn't throw. But required as it's checked.", "author": "david-allison-1", "createdAt": "2020-05-04T17:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMzMyMQ=="}], "type": "inlineReview"}, {"oid": "1c2710639df29fa8a4584e6f6d4a40097a145671", "url": "https://github.com/ankidroid/Anki-Android/commit/1c2710639df29fa8a4584e6f6d4a40097a145671", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T17:46:50Z", "type": "forcePushed"}, {"oid": "c2430d34cfa9323fd0ce90792b7cebe455db14df", "url": "https://github.com/ankidroid/Anki-Android/commit/c2430d34cfa9323fd0ce90792b7cebe455db14df", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T17:58:27Z", "type": "forcePushed"}, {"oid": "544680a0af989653cde03b6ecf90d850c8d204c2", "url": "https://github.com/ankidroid/Anki-Android/commit/544680a0af989653cde03b6ecf90d850c8d204c2", "message": "Improve \"Error Saving Note\" message\n\nRelated: #5839\n\nThis could occur due to 3 reasons, we fix two of them, and the third is\nfixed in a later pull request which blocks cloze deletions with no cards", "committedDate": "2020-05-04T19:19:39Z", "type": "commit"}, {"oid": "7dff9a458bcc2a7b9fd4ac63b865ac0c3f8d8a9d", "url": "https://github.com/ankidroid/Anki-Android/commit/7dff9a458bcc2a7b9fd4ac63b865ac0c3f8d8a9d", "message": "Block adding Cloze notes with no deletions\n\nRelated: #5839\n\nAnki displays a dialog asking if the user wants to proceed, from a UX\nperspective, I'd much rater block the action, even though it is\ncurrently permitted by libAnki", "committedDate": "2020-05-04T19:19:46Z", "type": "commit"}, {"oid": "bff7b0dbe0f925f9986ed194c784ce4af277333d", "url": "https://github.com/ankidroid/Anki-Android/commit/bff7b0dbe0f925f9986ed194c784ce4af277333d", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T19:19:46Z", "type": "commit"}, {"oid": "bff7b0dbe0f925f9986ed194c784ce4af277333d", "url": "https://github.com/ankidroid/Anki-Android/commit/bff7b0dbe0f925f9986ed194c784ce4af277333d", "message": "NF: Mark bug on hasClozeDeletions()", "committedDate": "2020-05-04T19:19:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY3MTQzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6104#discussion_r419671439", "bodyText": "Issue found: Avoid throwing raw exception types.", "author": "timrae", "createdAt": "2020-05-04T19:23:05Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -103,15 +104,44 @@ protected JSONObject getCurrentDatabaseModelCopy(String modelName) throws JSONEx\n     }\n \n     protected Note addNoteUsingBasicModel(String front, String back) {\n-        JSONObject basicModel = getCol().getModels().byName(\"Basic\");\n+        return addNoteUsingModelName(\"Basic\", front, back);\n+    }\n+\n+    protected Note addNoteUsingModelName(String name, String... fields) {\n+        JSONObject model = getCol().getModels().byName(name);\n         //PERF: if we modify newNote(), we can return the card and return a Pair<Note, Card> here.\n         //Saves a database trip afterwards.\n-        Note n = getCol().newNote(basicModel);\n-        n.setField(0, front);\n-        n.setField(1, back);\n+        Note n = getCol().newNote(model);\n+        for(int i = 0; i < fields.length; i++) {\n+            n.setField(i, fields[i]);\n+        }\n         if (getCol().addNote(n) != 1) {\n-            throw new IllegalStateException(String.format(\"Could not add note: {'%s', '%s'}\", front, back));\n+            throw new IllegalStateException(String.format(\"Could not add note: {%s}\", String.join(\", \", fields)));\n         }\n         return n;\n     }\n+\n+\n+    protected String addNonClozeModel(String name, String[] fields, String qfmt, String afmt) {\n+        JSONObject model = getCol().getModels().newModel(name);\n+        for (int i = 0; i < fields.length; i++) {\n+            addField(model, fields[i]);\n+        }\n+        model.put(FlashCardsContract.CardTemplate.QUESTION_FORMAT, qfmt);\n+        model.put(FlashCardsContract.CardTemplate.ANSWER_FORMAT, afmt);\n+        getCol().getModels().add(model);\n+        getCol().getModels().flush();\n+        return name;\n+    }\n+\n+\n+    private void addField(JSONObject model, String name) {\n+        Models models = getCol().getModels();\n+\n+        try {\n+            models.addField(model, models.newField(name));\n+        } catch (ConfirmModSchemaException e) {\n+            throw new RuntimeException(e);", "originalCommit": "bff7b0dbe0f925f9986ed194c784ce4af277333d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}