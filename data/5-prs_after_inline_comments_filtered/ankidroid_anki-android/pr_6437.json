{"pr_number": 6437, "pr_title": "sync: fix media sync with trailing slash on media sync url", "pr_createdAt": "2020-06-11T20:39:58Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6437", "timeline": [{"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "url": "https://github.com/ankidroid/Anki-Android/commit/dc1861d12593105dbc12777bc1083c7e452cd5b1", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url", "committedDate": "2020-06-14T15:30:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjAzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846031", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    AlertDialog.Builder builder = new AlertDialog.Builder(this);\n          \n          \n            \n                                    builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n          \n          \n            \n                                    builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n          \n          \n            \n                                    new AlertDialog.Builder(this)\n          \n          \n            \n                                        .setTitle(R.string.custom_sync_server_base_url_invalid);\n          \n          \n            \n                                        .setPositiveButton(R.string.dialog_ok, null)\n          \n          \n            \n                                        .show();", "author": "mikehardy", "createdAt": "2020-06-14T16:25:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "originalCommit": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjEwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846103", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "author": "mikehardy", "createdAt": "2020-06-14T16:26:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "originalCommit": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjExNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846116", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "author": "mikehardy", "createdAt": "2020-06-14T16:26:38Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    return true;\n+                });\n+                mSyncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "originalCommit": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjEyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846128", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "author": "mikehardy", "createdAt": "2020-06-14T16:26:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    return true;\n+                });\n+                mSyncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "originalCommit": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjMzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846330", "bodyText": "If the URIUtil already says it is valid, why are we checking something else? It is valid or not, isn't it?\nShould the URIUtil be extended to do the complete check, or is the second check unnecessary? (this comment applies to the other instance as well", "author": "mikehardy", "createdAt": "2020-06-14T16:29:15Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {", "originalCommit": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1ODMxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439858315", "bodyText": "Edit: The first check with URIUtil is a general check whether the uri is valid. That check catches for example https;// instead of https://. URIUtil.isValid does not care if the uri ends with a slash or not.\nNevertheless I removed the second check with the regex and instead reused the code from HttpSyncer::syncUrl() in the req() method of the HttpSyncer to build the url.\nWith the line Uri.parse(syncURL()).buildUpon().appendPath(method) it does not matter if syncURL() returns a string ending with a slash or not, the url will be correct.", "author": "kalehmann", "createdAt": "2020-06-14T19:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjMzMA=="}], "type": "inlineReview"}, {"oid": "de980370963f7d7a5d47168d562e486eb0951737", "url": "https://github.com/ankidroid/Anki-Android/commit/de980370963f7d7a5d47168d562e486eb0951737", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url", "committedDate": "2020-06-14T18:56:04Z", "type": "forcePushed"}, {"oid": "0173a162bcf0de570edeccf60b11f417d2c1b994", "url": "https://github.com/ankidroid/Anki-Android/commit/0173a162bcf0de570edeccf60b11f417d2c1b994", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url", "committedDate": "2020-06-14T19:01:15Z", "type": "forcePushed"}, {"oid": "709732d5630c6184ed0871aa85131f194405fd42", "url": "https://github.com/ankidroid/Anki-Android/commit/709732d5630c6184ed0871aa85131f194405fd42", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url", "committedDate": "2020-06-14T19:07:28Z", "type": "commit"}, {"oid": "709732d5630c6184ed0871aa85131f194405fd42", "url": "https://github.com/ankidroid/Anki-Android/commit/709732d5630c6184ed0871aa85131f194405fd42", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url", "committedDate": "2020-06-14T19:07:28Z", "type": "forcePushed"}]}