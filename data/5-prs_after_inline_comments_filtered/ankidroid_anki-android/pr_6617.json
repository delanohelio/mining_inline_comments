{"pr_number": 6617, "pr_title": "Parents uses array", "pr_createdAt": "2020-07-04T22:10:03Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6617", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzM3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449813374", "bodyText": "Have you tested this?\nI believe that Arrays.asList crashes when .add is called.", "author": "david-allison-1", "createdAt": "2020-07-04T23:24:56Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -306,7 +307,7 @@ protected int _deckNewLimit(long did, LimitMethod fn) {\n         if (fn == null) {\n             fn = (g -> _deckNewLimitSingle(g));\n         }\n-        List<JSONObject> decks = mCol.getDecks().parents(did);\n+        List<JSONObject> decks = Arrays.asList(mCol.getDecks().parents(did));", "originalCommit": "d8a4089b09a57ff271c241a95d6aea55a189b0ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTA5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449815096", "bodyText": "I'm adding it to my merge.\nSeems you're right. I didn't even know list can refuse to add elements. The remaining commits still seems of interest to me", "author": "Arthur-Milchior", "createdAt": "2020-07-04T23:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTQ0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449815444", "bodyText": "Optional: Any chance we can get some trivial unit test coverage to stop it happening again?", "author": "david-allison-1", "createdAt": "2020-07-05T00:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzM3NA=="}], "type": "inlineReview"}, {"oid": "f4b129a48c323b26b3c155294faeb3071dc8bc21", "url": "https://github.com/ankidroid/Anki-Android/commit/f4b129a48c323b26b3c155294faeb3071dc8bc21", "message": "NF: remove useless asList", "committedDate": "2020-07-04T23:59:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTUzNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449815537", "bodyText": "This is more clear using parts.length", "author": "david-allison-1", "createdAt": "2020-07-05T00:04:24Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -1038,19 +1038,17 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n      */\n     public List<JSONObject> parents(long did) {\n         // get parent and grandparent names\n+        String[] parts = path(get(did).getString(\"name\"));\n+        int nbParts = parts.length;\n         List<String> parents = new ArrayList<>();\n-        List<String> parts = Arrays.asList(path(get(did).getString(\"name\")));\n-        for (int i = 0; i < parts.size() - 1; i++) {\n-            String part = parts.get(i);\n-            if (parents.size() == 0) {\n-                parents.add(part);\n-            } else {\n-                parents.add(parents.get(parents.size() - 1) + \"::\" + part);\n-            }\n+        parents.add(parts[0]);\n+        for (int i = 1; i < nbParts - 1; i++) {", "originalCommit": "f4b129a48c323b26b3c155294faeb3071dc8bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNzYwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449817608", "bodyText": "Reverted then", "author": "Arthur-Milchior", "createdAt": "2020-07-05T00:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTUzNw=="}], "type": "inlineReview"}, {"oid": "c9e8dac327f3f2c426db79096ad1fa0193b15ba5", "url": "https://github.com/ankidroid/Anki-Android/commit/c9e8dac327f3f2c426db79096ad1fa0193b15ba5", "message": "NF: initialize list with size", "committedDate": "2020-07-05T00:41:31Z", "type": "forcePushed"}, {"oid": "c0d7f3c284953132b504aea52e79871c131c49ee", "url": "https://github.com/ankidroid/Anki-Android/commit/c0d7f3c284953132b504aea52e79871c131c49ee", "message": "NF: avoid a if in a loop", "committedDate": "2020-07-05T02:28:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMzQ1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449823458", "bodyText": "Shouldn't these be parents?", "author": "david-allison-1", "createdAt": "2020-07-05T02:33:49Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -1038,19 +1038,16 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n      */\n     public List<JSONObject> parents(long did) {\n         // get parent and grandparent names\n-        List<String> parents = new ArrayList<>();\n-        List<String> parts = Arrays.asList(path(get(did).getString(\"name\")));\n-        for (int i = 0; i < parts.size() - 1; i++) {\n-            String part = parts.get(i);\n-            if (parents.size() == 0) {\n-                parents.add(part);\n-            } else {\n-                parents.add(parents.get(parents.size() - 1) + \"::\" + part);\n-            }\n+        String[] parts = path(get(did).getString(\"name\"));\n+        List<String> parents = new ArrayList<>(parts.length - 1);\n+        parents.add(parts[0]);\n+        for (int i = 1; i < parts.length - 1; i++) {\n+            String part = parts[i];\n+            parents.add(parents.get(parents.size() - 1) + \"::\" + part);\n         }\n         // convert to objects\n-        List<JSONObject> oParents = new ArrayList<>();\n-        for (int i = 0; i < parents.size(); i++) {\n+        List<JSONObject> oParents = new ArrayList<>(parts.length - 1);", "originalCommit": "c0d7f3c284953132b504aea52e79871c131c49ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMzcyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449823728", "bodyText": "It would make the code more complex.\nFor top level decks, the list parts contain a single element. Using parts.length in the loop ensure that the list is empty (and using it in constructor ensure consistency)\nThe list parents has size min(parts.length - 1, 1). Previously it had size parts.length - 1 by using a special case for length 1. I believe that this new version is more easy to read because\u00a0I'm not testing inside the loop whether we are currently dealing with the first iteration of the loop.\nI simply do the first iteration separately and then do the normal part of the loop without test in the loop.\nThe downside being that the first iteration is always done, even when the loop used not to be run at all.", "author": "Arthur-Milchior", "createdAt": "2020-07-05T02:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMzQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyNDU2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449824560", "bodyText": "Done again in a simpler way (according to me), keeping parents.size()", "author": "Arthur-Milchior", "createdAt": "2020-07-05T02:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMzQ1OA=="}], "type": "inlineReview"}, {"oid": "90a3331f0b5f7a22a86a2b80948c1fd25d3c7b1a", "url": "https://github.com/ankidroid/Anki-Android/commit/90a3331f0b5f7a22a86a2b80948c1fd25d3c7b1a", "message": "NF: parentsNames", "committedDate": "2020-07-05T02:52:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDMzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449860334", "bodyText": "This doesn't set parentsNames[0]. This seems to differ from the previous logic", "author": "david-allison-1", "createdAt": "2020-07-05T10:20:21Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -1032,26 +1032,32 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n         return childMap;\n     }\n \n+    /**\n+     * @return Names of ancestors of parents of name.\n+     */\n+    private String[] parentsNames(String name) {\n+        String[] parts = path(name);\n+        String[] parentsNames = new String[parts.length - 1];\n+        if (parts.length == 1) {\n+            return parentsNames;", "originalCommit": "90a3331f0b5f7a22a86a2b80948c1fd25d3c7b1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDQ1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449860451", "bodyText": "And it's probably best to not special-case the early return as it complicates the code and probably slows it down.", "author": "david-allison-1", "createdAt": "2020-07-05T10:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxMTg3OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449911879", "bodyText": "You are perfectly right.\nIn the previous version, for a top level name (i.e. without \"::\"), I was setting \"parents\" to a wrong value.\nNow that \"parentsNames\" is a function, I really need it to return the correct value. I.e. the empty list if there is no parent.\nI don't see how making the if before the loop makes the code slower than making the if inside the loop. However, code optimization could be so surprising that I can't be surprised anymore if my intuition was wrong here.", "author": "Arthur-Milchior", "createdAt": "2020-07-05T19:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkyODY4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6617#discussion_r449928684", "bodyText": "Method documentation would be useful in this case", "author": "david-allison-1", "createdAt": "2020-07-05T23:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg2MDMzNA=="}], "type": "inlineReview"}, {"oid": "60841a235d820556a8acb3f7f15737e749360b27", "url": "https://github.com/ankidroid/Anki-Android/commit/60841a235d820556a8acb3f7f15737e749360b27", "message": "NF: parentsNames", "committedDate": "2020-07-05T19:44:58Z", "type": "forcePushed"}, {"oid": "060255dd80e53b5ef39179b80caa5fbcbcc4d276", "url": "https://github.com/ankidroid/Anki-Android/commit/060255dd80e53b5ef39179b80caa5fbcbcc4d276", "message": "NF: parentsNames", "committedDate": "2020-07-05T23:01:22Z", "type": "forcePushed"}, {"oid": "f3d5891eb2c34cc19596bca488af39ba7d6e78df", "url": "https://github.com/ankidroid/Anki-Android/commit/f3d5891eb2c34cc19596bca488af39ba7d6e78df", "message": "NF: parentsNames", "committedDate": "2020-07-05T23:14:04Z", "type": "forcePushed"}, {"oid": "3d197ecc94c6200bb2e000eb1943cb06e11d6b31", "url": "https://github.com/ankidroid/Anki-Android/commit/3d197ecc94c6200bb2e000eb1943cb06e11d6b31", "message": "NF: parentsNames", "committedDate": "2020-07-05T23:16:43Z", "type": "forcePushed"}, {"oid": "273fa0f2aa0fb80773761c55a9769894b0567087", "url": "https://github.com/ankidroid/Anki-Android/commit/273fa0f2aa0fb80773761c55a9769894b0567087", "message": "NF: parentsNames", "committedDate": "2020-07-05T23:29:51Z", "type": "commit"}, {"oid": "273fa0f2aa0fb80773761c55a9769894b0567087", "url": "https://github.com/ankidroid/Anki-Android/commit/273fa0f2aa0fb80773761c55a9769894b0567087", "message": "NF: parentsNames", "committedDate": "2020-07-05T23:29:51Z", "type": "forcePushed"}]}