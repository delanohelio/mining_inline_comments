{"pr_number": 6694, "pr_title": "Fix Audio Whitespace Handling", "pr_createdAt": "2020-07-18T14:30:18Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6694", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5OTk5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6694#discussion_r456799996", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    while (newLength > 0 && Character.isWhitespace(s.charAt(newLength - 1))) {\n          \n          \n            \n                    while (newLength >= 0 && Character.isWhitespace(s.charAt(newLength - 1))) {\n          \n      \n    \n    \n  \n\n'>=' ? Just thinking, an rTrim of a fully whitespace string should return the empty string, so it should be valid to go all the way to zero? It appears substring only throws if endIndex is less than beginIndex so equal index values should work and empty string should be valid\nhttps://docs.oracle.com/javase/7/docs/api/java/lang/String.html#substring(int,%20int)", "author": "mikehardy", "createdAt": "2020-07-18T15:24:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/StringUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+ */\n+\n+package com.ichi2.utils;\n+\n+import org.jetbrains.annotations.Contract;\n+\n+import androidx.annotation.Nullable;\n+\n+public class StringUtil {\n+\n+    /** Trims from the right hand side of a string */\n+    @Nullable\n+    @Contract(\"null -> null; !null -> !null\")\n+    public static String trimRight(@Nullable String s) {\n+        if (s == null) {\n+            return null;\n+        }\n+\n+        int newLength = s.length();\n+        while (newLength > 0 && Character.isWhitespace(s.charAt(newLength - 1))) {", "originalCommit": "e8b222a044d209500934a6b923be0b73b440d4f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwMjg0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6694#discussion_r456802843", "bodyText": "No, if the newLength is 0, then .charAt(newLength - 1) will crash, and the decrement operation will take the length to -1.\nBut, I'll add tests to prove it.", "author": "david-allison-1", "createdAt": "2020-07-18T15:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5OTk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwMzYwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6694#discussion_r456803604", "bodyText": "Done and re-pushed, No code changes in StringUtil", "author": "david-allison-1", "createdAt": "2020-07-18T16:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5OTk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwMzYyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6694#discussion_r456803625", "bodyText": "oh of course - I was mentally trying to do the index (zero-based) vs length shifts but reasoned through it incorrectly. If newLength goes through at 1 and it's whitespace it will go to 0 in the loop, break the loop then substring 0 0 - I can see it", "author": "mikehardy", "createdAt": "2020-07-18T16:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5OTk5Ng=="}], "type": "inlineReview"}, {"oid": "c30e041b61d6f2ebdb4f842d542b3e14f53fa3a4", "url": "https://github.com/ankidroid/Anki-Android/commit/c30e041b61d6f2ebdb4f842d542b3e14f53fa3a4", "message": "Fix Audio Whitespace Handling\n\nIn Anki, whitespace before a filename matters, whereas whitespace after a file\nis ignored.\n\nThis is visible in the following decks:\n\nhttps://ankiweb.net/shared/info/1616679068\n\"GENKI I Grammar Deck with native speaker audio and images\"\n\nhttps://ankiweb.net/shared/info/1833515795\n\"GENKI II Grammar Deck with native speaker audio and images\"\n\nOne defines \"5.mp3\", and the other defines \" 5.mp3\".\n\nThis works in Anki Desktop.\n\nAnki Desktop behaviour relating to trailing spaces being ignored was confirmed.\n\nWe fix this by only performing a trim on the right hand side, and only if the\nstring is not a URI\n\nFixes 6693", "committedDate": "2020-07-18T16:05:44Z", "type": "commit"}, {"oid": "c30e041b61d6f2ebdb4f842d542b3e14f53fa3a4", "url": "https://github.com/ankidroid/Anki-Android/commit/c30e041b61d6f2ebdb4f842d542b3e14f53fa3a4", "message": "Fix Audio Whitespace Handling\n\nIn Anki, whitespace before a filename matters, whereas whitespace after a file\nis ignored.\n\nThis is visible in the following decks:\n\nhttps://ankiweb.net/shared/info/1616679068\n\"GENKI I Grammar Deck with native speaker audio and images\"\n\nhttps://ankiweb.net/shared/info/1833515795\n\"GENKI II Grammar Deck with native speaker audio and images\"\n\nOne defines \"5.mp3\", and the other defines \" 5.mp3\".\n\nThis works in Anki Desktop.\n\nAnki Desktop behaviour relating to trailing spaces being ignored was confirmed.\n\nWe fix this by only performing a trim on the right hand side, and only if the\nstring is not a URI\n\nFixes 6693", "committedDate": "2020-07-18T16:05:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwMzczNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6694#discussion_r456803736", "bodyText": "This is a questionable test as it tests implementation - but I think it's reasonable to assert to ensure there's no performance regressions", "author": "david-allison-1", "createdAt": "2020-07-18T16:08:00Z", "path": "AnkiDroid/src/test/java/com/ichi2/utils/StringUtilTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.utils;\n+\n+import org.junit.Test;\n+\n+import static com.ichi2.utils.StringUtil.trimRight;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.hamcrest.Matchers.sameInstance;\n+\n+public class StringUtilTest {\n+\n+    @Test\n+    public void trimRightNullIsSetToNull() {\n+        assertThat(trimRight(null), is(nullValue()));\n+    }\n+\n+    @Test\n+    public void trimRightWhiteSpaceIsBlankString() {\n+        assertThat(trimRight(\" \"), is(\"\"));\n+    }\n+\n+    @Test\n+    public void trimRightOnlyTrimsRight() {\n+        assertThat(trimRight(\" a \"), is(\" a\"));\n+    }\n+\n+    @Test\n+    public void trimRightDoesNothingOnTrimmedString() {\n+        String input = \" foo\";\n+        assertThat(trimRight(input), sameInstance(input));", "originalCommit": "c30e041b61d6f2ebdb4f842d542b3e14f53fa3a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}