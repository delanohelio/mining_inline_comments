{"pr_number": 7271, "pr_title": "Always generate a card", "pr_createdAt": "2020-09-24T04:48:55Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7271", "timeline": [{"oid": "940918bc93fed43d66258ae0591417452e0d9954", "url": "https://github.com/ankidroid/Anki-Android/commit/940918bc93fed43d66258ae0591417452e0d9954", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-09-25T06:49:17Z", "type": "forcePushed"}, {"oid": "23d4897636c65d187e0a31e8425d2deaf1ac76d9", "url": "https://github.com/ankidroid/Anki-Android/commit/23d4897636c65d187e0a31e8425d2deaf1ac76d9", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-09-25T11:44:55Z", "type": "forcePushed"}, {"oid": "9b6cdc1021d13fe259073cdeb470a2ddd90a1858", "url": "https://github.com/ankidroid/Anki-Android/commit/9b6cdc1021d13fe259073cdeb470a2ddd90a1858", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-09-29T06:14:47Z", "type": "forcePushed"}, {"oid": "71ee3d28d4e0dce885c7ffc127df25d0a3ec238c", "url": "https://github.com/ankidroid/Anki-Android/commit/71ee3d28d4e0dce885c7ffc127df25d0a3ec238c", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-09-29T22:28:28Z", "type": "forcePushed"}, {"oid": "ad6c4cd02d2660310f43e944f8029a4661804cf3", "url": "https://github.com/ankidroid/Anki-Android/commit/ad6c4cd02d2660310f43e944f8029a4661804cf3", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-10-23T11:58:27Z", "type": "forcePushed"}, {"oid": "1b37dd8d176e9eddfd57dd69c66993d78e9727b3", "url": "https://github.com/ankidroid/Anki-Android/commit/1b37dd8d176e9eddfd57dd69c66993d78e9727b3", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-10-23T20:18:47Z", "type": "forcePushed"}, {"oid": "7432a3b788174103bcac123bf6fedc2a2d21aa39", "url": "https://github.com/ankidroid/Anki-Android/commit/7432a3b788174103bcac123bf6fedc2a2d21aa39", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-10-24T17:48:08Z", "type": "forcePushed"}, {"oid": "06652b4a3c1f3c9bb63cb5d5bec7677515540ab5", "url": "https://github.com/ankidroid/Anki-Android/commit/06652b4a3c1f3c9bb63cb5d5bec7677515540ab5", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-10-24T18:44:57Z", "type": "forcePushed"}, {"oid": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84", "url": "https://github.com/ankidroid/Anki-Android/commit/97a9f7199cf5eb8f98e9b09505388b70f88b4d84", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-10-24T19:28:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAwOTE1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538009151", "bodyText": "This code isn't used, what is the intention when a user is previewing?", "author": "david-allison-1", "createdAt": "2020-12-08T03:37:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -892,7 +893,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n \t    ArrayList<JSONObject> cms;\n \t    switch (type) {\n             case ADD:\n-    \t        cms = findTemplates(note);\n+                // Don't show empty card, so it's clear during preview that no cards are generated\n+    \t        cms = findTemplates(note, false);", "originalCommit": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA0ODg0Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538048846", "bodyText": "I just answered in #7842 . In particular I explained what the method does (since there is no comment).\u00a0I am confident that this change is consistent with the function goal. However, since I can't imagine we'll need this function, as we currently have a working previewer, I suggest to delete the method instead of finding the correct change to do", "author": "Arthur-Milchior", "createdAt": "2020-12-08T05:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAwOTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMDMwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538010300", "bodyText": "We've moved from _availClozeOrds(.., true) to _availClozeOrds(.., variable), is this correct? Can this ever be false in Anki Desktop?", "author": "david-allison-1", "createdAt": "2020-12-08T03:40:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1111,16 +1110,21 @@ public static boolean emptyStandardCard(String type, JSONArray req, String[] tri\n     /**\n      * @param m A model\n      * @param sfld Fields of a note\n+     * @param allowEmpty whether to always return an ord, even if all cards are actually empty\n      * @return The index of the cards that are generated. For cloze cards, if no card is generated, then {0} */\n-    public static ArrayList<Integer> availOrds(Model m, String[] sfld) {\n+    public static ArrayList<Integer> availOrds(Model m, String[] sfld, boolean allowEmpty) {\n         if (m.getInt(\"type\") == Consts.MODEL_CLOZE) {\n-            return _availClozeOrds(m, sfld);\n+            return _availClozeOrds(m, sfld, allowEmpty);", "originalCommit": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA0ODkxMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538048910", "bodyText": "I believe it is correct. As the PR state, my goal is to change a single thing: a note will always generate a card. In particular this will ensure that using \"Empty card\" and \"Check Database\" does not risk to delete cards by accident.\nHowever, there remains plenty of differences that I did not port between 2.1.27 and 2.1.28. For example, anki now allows to add notes even when they does not generate a card. It shows a warning but register the note correctly. It is not clear to me why it does that, but it does. I have read that this feature was asked for a usecase I can't remember. My goal was not to port this change to AnkiDroid. First because if we do so, it should be in a separate PR I believe. Secondly because this would be a disaster until the UI is changed. Indeed, AnkiDroid does not have a way to access recently created card the way than anki does with the \"History\" button. Accepting note without cards is okay in Anki, because you can easily go back and edit it. It would not be okay in ankidroid without a way to edit the card recently added.\nThis mean that currently, we want \"allow empty\" to be false when we create a note (so that we don't allow to create notes that generate no card), but we want it to be true when using \"Empty cards\" in order to ensure we don't delete notes by accident. This is note something that exists upstream because they changed the way they deal with creation of card and my goal was not to change it.", "author": "Arthur-Milchior", "createdAt": "2020-12-08T05:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMDMwMA=="}], "type": "inlineReview"}, {"oid": "f07fff417da5a90a0ef897d7ff019cce88b95e69", "url": "https://github.com/ankidroid/Anki-Android/commit/f07fff417da5a90a0ef897d7ff019cce88b95e69", "message": "NF: Do not delete note with no card\n\nThis port a change from Anki 2.1.28.\n\nUpstream allow to generate note with no card. I can't easily do it as it requires UI change. I do the minimal part,\nwhich is accepting to import note with no card and correct \"check card\" so that it does not delete note with no card", "committedDate": "2020-12-11T06:15:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r561605637", "bodyText": "This should always be false now", "author": "david-allison-1", "createdAt": "2021-01-21T05:08:25Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "diffHunk": "@@ -376,7 +376,7 @@ private boolean processFields(ForeignNote note, @Nullable String[] fields) {\n             }\n         }\n         note.fieldsStr = joinFields(fields);\n-        ArrayList<Integer> ords = Models.availOrds(mModel, fields);\n+        ArrayList<Integer> ords = Models.availOrds(mModel, fields, true);\n         if (ords.isEmpty()) {", "originalCommit": "f07fff417da5a90a0ef897d7ff019cce88b95e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY5MTMyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r561691328", "bodyText": "On the opposite. If for some reason the note generate no card, we still want to allow it to be imported and saved in the collection, so allowEmpty should be true.", "author": "Arthur-Milchior", "createdAt": "2021-01-21T08:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIzMTY4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r562231684", "bodyText": "ords.isEmpty() surely should always return false now, unless I'm misunderstanding the code.\nCloze should always generate a card, now a normal note should also generate ord 0?", "author": "david-allison-1", "createdAt": "2021-01-21T22:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjEyOTY1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r566129658", "bodyText": "@Arthur-Milchior / @david-allison-1 is this point resolved? It seems like this is close, I'd still really like to land it :-)", "author": "mikehardy", "createdAt": "2021-01-28T14:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}], "type": "inlineReview"}, {"oid": "2cc454292c3d1f3af4d84f5bc5ae05b2bd99b348", "url": "https://github.com/ankidroid/Anki-Android/commit/2cc454292c3d1f3af4d84f5bc5ae05b2bd99b348", "message": "NF: regression test, first card of cloze type is empty", "committedDate": "2021-01-21T08:23:06Z", "type": "commit"}, {"oid": "1ece13a6ae03290fc70c6ef97fec80aef7444c3e", "url": "https://github.com/ankidroid/Anki-Android/commit/1ece13a6ae03290fc70c6ef97fec80aef7444c3e", "message": "genCards ensure each note have a card\n\nThis ensure that note with no card can still be corrected and are not deleted. This follow 2.1.28.", "committedDate": "2021-01-21T11:13:26Z", "type": "forcePushed"}, {"oid": "23b8fb32696394a8204171212b5d6e33a1a989b6", "url": "https://github.com/ankidroid/Anki-Android/commit/23b8fb32696394a8204171212b5d6e33a1a989b6", "message": "NF: Add options to control adding note with only empty card\n\nNothing is changed here, however it will help the next commit to follow anki 2.1.28", "committedDate": "2021-01-21T12:01:41Z", "type": "commit"}, {"oid": "ef04471c6a6d9c3d69634cb5bb3507ff88f3a38e", "url": "https://github.com/ankidroid/Anki-Android/commit/ef04471c6a6d9c3d69634cb5bb3507ff88f3a38e", "message": "Notes are imported even if they don't generate cards\n\nThis will allow to import buggy deck and correct them. It also follows 2.1.28", "committedDate": "2021-01-21T12:01:41Z", "type": "commit"}, {"oid": "d97b0cffab270df6dbcb1cb15a6c412ee10ed1f4", "url": "https://github.com/ankidroid/Anki-Android/commit/d97b0cffab270df6dbcb1cb15a6c412ee10ed1f4", "message": "genCards ensure each note have a card\n\nThis ensure that note with no card can still be corrected and are not deleted. This follow 2.1.28.", "committedDate": "2021-01-21T12:01:42Z", "type": "commit"}, {"oid": "d97b0cffab270df6dbcb1cb15a6c412ee10ed1f4", "url": "https://github.com/ankidroid/Anki-Android/commit/d97b0cffab270df6dbcb1cb15a6c412ee10ed1f4", "message": "genCards ensure each note have a card\n\nThis ensure that note with no card can still be corrected and are not deleted. This follow 2.1.28.", "committedDate": "2021-01-21T12:01:42Z", "type": "forcePushed"}]}