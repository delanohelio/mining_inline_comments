{"pr_number": 6191, "pr_title": "#6184 Fix - Handle massive images in DeckPicker Background", "pr_createdAt": "2020-05-15T21:03:50Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6191", "timeline": [{"oid": "3a4a301da3dca4f6a44edef2193988bed15316ad", "url": "https://github.com/ankidroid/Anki-Android/commit/3a4a301da3dca4f6a44edef2193988bed15316ad", "message": "Add files via upload", "committedDate": "2020-03-14T09:50:07Z", "type": "commit"}, {"oid": "3e57c4ceca25bb1fec92ca743eaa98700966108f", "url": "https://github.com/ankidroid/Anki-Android/commit/3e57c4ceca25bb1fec92ca743eaa98700966108f", "message": "Update card.js", "committedDate": "2020-03-15T09:39:50Z", "type": "commit"}, {"oid": "e7e91bc09a085ffc129535442af8456f97f6dc80", "url": "https://github.com/ankidroid/Anki-Android/commit/e7e91bc09a085ffc129535442af8456f97f6dc80", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T09:41:29Z", "type": "commit"}, {"oid": "366610142dc2b93fd4a54958878b9205a9d59f52", "url": "https://github.com/ankidroid/Anki-Android/commit/366610142dc2b93fd4a54958878b9205a9d59f52", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T15:52:38Z", "type": "commit"}, {"oid": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "url": "https://github.com/ankidroid/Anki-Android/commit/7c5ec74a43504d5357e66dfec9b329a64c88c04f", "message": "Update card.js", "committedDate": "2020-03-15T15:55:06Z", "type": "commit"}, {"oid": "f8041a93bb3249736811d14659250d93a9c76ca4", "url": "https://github.com/ankidroid/Anki-Android/commit/f8041a93bb3249736811d14659250d93a9c76ca4", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:25:09Z", "type": "commit"}, {"oid": "f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "url": "https://github.com/ankidroid/Anki-Android/commit/f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:36:30Z", "type": "commit"}, {"oid": "2f4df32f4fe9551691ebe4117059d301c55fd9b4", "url": "https://github.com/ankidroid/Anki-Android/commit/2f4df32f4fe9551691ebe4117059d301c55fd9b4", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-03-15T18:36:57Z", "type": "commit"}, {"oid": "7bd146c9a8a58c5b01b73bae5400734b4e940f5b", "url": "https://github.com/ankidroid/Anki-Android/commit/7bd146c9a8a58c5b01b73bae5400734b4e940f5b", "message": "Merge pull request #1 from ankidroid/master\n\nUpdate Ankidroid forked repo - DONE", "committedDate": "2020-03-17T12:05:33Z", "type": "commit"}, {"oid": "38ccf485e82e8413146a979176eed3819481439d", "url": "https://github.com/ankidroid/Anki-Android/commit/38ccf485e82e8413146a979176eed3819481439d", "message": "Added localhost domain-config", "committedDate": "2020-04-01T06:36:27Z", "type": "commit"}, {"oid": "2b6bcf3dc2e58fa384cc9a55c701c7f942e115ca", "url": "https://github.com/ankidroid/Anki-Android/commit/2b6bcf3dc2e58fa384cc9a55c701c7f942e115ca", "message": "Merge pull request #2 from ankidroid/master\n\nUpdating Fork", "committedDate": "2020-05-07T11:39:18Z", "type": "commit"}, {"oid": "465b0a20c6a12b8cae48c4825dcad000aba38688", "url": "https://github.com/ankidroid/Anki-Android/commit/465b0a20c6a12b8cae48c4825dcad000aba38688", "message": "Anki", "committedDate": "2020-05-07T18:41:31Z", "type": "commit"}, {"oid": "30863ff6ccd14c27375a786629d48a0175b991b6", "url": "https://github.com/ankidroid/Anki-Android/commit/30863ff6ccd14c27375a786629d48a0175b991b6", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-05-07T18:41:47Z", "type": "commit"}, {"oid": "7df6d450273f46b457b846f3a7daf7a19f61b52c", "url": "https://github.com/ankidroid/Anki-Android/commit/7df6d450273f46b457b846f3a7daf7a19f61b52c", "message": "Merge pull request #3 from ankidroid/master\n\nRevert \"don't put \"undo\" to color enabled\"", "committedDate": "2020-05-07T18:45:03Z", "type": "commit"}, {"oid": "e3045d9c618e2f3dc0cfe4f322b9b64d6de3498c", "url": "https://github.com/ankidroid/Anki-Android/commit/e3045d9c618e2f3dc0cfe4f322b9b64d6de3498c", "message": "Update", "committedDate": "2020-05-07T18:57:46Z", "type": "commit"}, {"oid": "955285abd863193bf0c70ab1436ba7d9ec70c770", "url": "https://github.com/ankidroid/Anki-Android/commit/955285abd863193bf0c70ab1436ba7d9ec70c770", "message": "Update Preferences.java", "committedDate": "2020-05-07T19:00:37Z", "type": "commit"}, {"oid": "a9ef4310bd195d21efbc9be8dd419cc4122a682a", "url": "https://github.com/ankidroid/Anki-Android/commit/a9ef4310bd195d21efbc9be8dd419cc4122a682a", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-05-07T19:01:55Z", "type": "commit"}, {"oid": "91574092619fc3adc061e147930a4d565638d8ec", "url": "https://github.com/ankidroid/Anki-Android/commit/91574092619fc3adc061e147930a4d565638d8ec", "message": "Update preferences_appearance.xml", "committedDate": "2020-05-07T19:03:35Z", "type": "commit"}, {"oid": "46d7fc5616561e625e72ee3164edfd27a7c19669", "url": "https://github.com/ankidroid/Anki-Android/commit/46d7fc5616561e625e72ee3164edfd27a7c19669", "message": "update", "committedDate": "2020-05-07T19:36:11Z", "type": "commit"}, {"oid": "ae832792d6acce358da70329161103ba215cc98f", "url": "https://github.com/ankidroid/Anki-Android/commit/ae832792d6acce358da70329161103ba215cc98f", "message": "update", "committedDate": "2020-05-08T05:52:44Z", "type": "commit"}, {"oid": "25aac571d064bb849f01cfd59e895c2d8b13ce2c", "url": "https://github.com/ankidroid/Anki-Android/commit/25aac571d064bb849f01cfd59e895c2d8b13ce2c", "message": "Update DeckPicker.java", "committedDate": "2020-05-08T06:02:46Z", "type": "commit"}, {"oid": "333008cf0e4b7eaa73c02d013f12e24e096e835e", "url": "https://github.com/ankidroid/Anki-Android/commit/333008cf0e4b7eaa73c02d013f12e24e096e835e", "message": "Background Image", "committedDate": "2020-05-08T12:35:00Z", "type": "commit"}, {"oid": "5871b34b2f930a78e7146bdd4915eb5d2231e037", "url": "https://github.com/ankidroid/Anki-Android/commit/5871b34b2f930a78e7146bdd4915eb5d2231e037", "message": "Update DeckPicker.java", "committedDate": "2020-05-08T12:38:11Z", "type": "commit"}, {"oid": "47a1c6f60e968142e6365f8438da3b7855d0234c", "url": "https://github.com/ankidroid/Anki-Android/commit/47a1c6f60e968142e6365f8438da3b7855d0234c", "message": "Update Preferences.java", "committedDate": "2020-05-08T12:44:09Z", "type": "commit"}, {"oid": "829d14f4ae422a1a45a04980735caf75147a153a", "url": "https://github.com/ankidroid/Anki-Android/commit/829d14f4ae422a1a45a04980735caf75147a153a", "message": "Update DeckPicker.java", "committedDate": "2020-05-08T12:48:30Z", "type": "commit"}, {"oid": "5e7d40de9633ad992bdc271f68857515ec934d2b", "url": "https://github.com/ankidroid/Anki-Android/commit/5e7d40de9633ad992bdc271f68857515ec934d2b", "message": "Update 03-dialogs.xml\n\nPrefrences.java\n03-dialogs.xml\nUpdated", "committedDate": "2020-05-08T13:00:59Z", "type": "commit"}, {"oid": "f5a04d4e6144e98ebbae8fa816752aa0f0231ac4", "url": "https://github.com/ankidroid/Anki-Android/commit/f5a04d4e6144e98ebbae8fa816752aa0f0231ac4", "message": "Update Preferences.java", "committedDate": "2020-05-08T13:07:57Z", "type": "commit"}, {"oid": "60a4ff0790aff50a34b21fb2ea498854e55574c3", "url": "https://github.com/ankidroid/Anki-Android/commit/60a4ff0790aff50a34b21fb2ea498854e55574c3", "message": "Update Preferences.java", "committedDate": "2020-05-08T13:58:32Z", "type": "commit"}, {"oid": "f1d46028367f813c99febe0d3c13b4e87dad030b", "url": "https://github.com/ankidroid/Anki-Android/commit/f1d46028367f813c99febe0d3c13b4e87dad030b", "message": "Update DeckPicker.java", "committedDate": "2020-05-09T14:54:08Z", "type": "commit"}, {"oid": "e60944353d6b9fc10ea86360db4ca4c9dbc6b7f7", "url": "https://github.com/ankidroid/Anki-Android/commit/e60944353d6b9fc10ea86360db4ca4c9dbc6b7f7", "message": "deckpicker background image", "committedDate": "2020-05-09T22:05:49Z", "type": "commit"}, {"oid": "3dc19a5c833b782c107e408aa239b13ab71d995a", "url": "https://github.com/ankidroid/Anki-Android/commit/3dc19a5c833b782c107e408aa239b13ab71d995a", "message": "update Deckpicker.java", "committedDate": "2020-05-09T22:52:51Z", "type": "commit"}, {"oid": "e2ceb64bcc0ab6a6dbc4c2002976e7320845a2ae", "url": "https://github.com/ankidroid/Anki-Android/commit/e2ceb64bcc0ab6a6dbc4c2002976e7320845a2ae", "message": "update 03-dialogs.xml", "committedDate": "2020-05-09T23:11:58Z", "type": "commit"}, {"oid": "cabb8a314b16f550369db9e7cd203911655334ef", "url": "https://github.com/ankidroid/Anki-Android/commit/cabb8a314b16f550369db9e7cd203911655334ef", "message": "Update Preferences.java", "committedDate": "2020-05-15T20:06:58Z", "type": "commit"}, {"oid": "32c28a1a8112c2706eee554efdfcefbe2e0aa283", "url": "https://github.com/ankidroid/Anki-Android/commit/32c28a1a8112c2706eee554efdfcefbe2e0aa283", "message": "Update Fork", "committedDate": "2020-05-15T20:31:05Z", "type": "commit"}, {"oid": "b0841b85d6ea0e3b5506c9e3f50f7c23d480a347", "url": "https://github.com/ankidroid/Anki-Android/commit/b0841b85d6ea0e3b5506c9e3f50f7c23d480a347", "message": "Merge pull request #6 from ankidroid/master\n\nFork Update", "committedDate": "2020-05-15T20:35:12Z", "type": "commit"}, {"oid": "1d93e935edcad218651be9576fad70b30f11652e", "url": "https://github.com/ankidroid/Anki-Android/commit/1d93e935edcad218651be9576fad70b30f11652e", "message": "Update Preferences.java", "committedDate": "2020-05-15T20:37:41Z", "type": "commit"}, {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "url": "https://github.com/ankidroid/Anki-Android/commit/81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-05-15T20:38:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NDIxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426054215", "bodyText": "Can you generalize this function and put it in BitmapUtils, like this one? https://github.com/ankidroid/Anki-Android/blob/master/AnkiDroid/src/main/java/com/ichi2/utils/BitmapUtil.java#L40\nEspecially important to pay attention to the error handling there, anything opened should be closed in a finally, for instance - also, is this potentially crunching the image too much? I actually have the blue marble as my desktop background and if I had selected that but then it got JPEG-blocked out with an overzealous crunch that I couldn't configure, I'd be less happy with it personally", "author": "mikehardy", "createdAt": "2020-05-15T21:25:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1ODUyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426058522", "bodyText": "Can we put limit on file size? ( For ex: only image size less than 10 mb allowed)\nUsing this.\nFile file = new File(filepath);\nlong length = file.length();", "author": "infinyte7", "createdAt": "2020-05-15T21:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NDIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1OTg0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426059840", "bodyText": "Is our issue the filesize, or the size of the bitmap in memory? This'll fix 99.9% of the crashes, but if we don't know the conditions that cause the issue then bugs may remain\nI'd be happy with ~10MB, that should be enough for anyone without hopefully causing too many crashes, until proven otherwise", "author": "david-allison-1", "createdAt": "2020-05-15T21:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NDIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTIwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049202", "bodyText": "use try with resources", "author": "david-allison-1", "createdAt": "2020-05-15T21:11:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTM5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049391", "bodyText": "Could we get a comment explaining the variable (what units?) Surely not pixels", "author": "david-allison-1", "createdAt": "2020-05-15T21:12:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTUxNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049516", "bodyText": "This is a complex procedure, could you explain what it does, and why it does it in a comment (some at the call site, some inside the method)?", "author": "david-allison-1", "createdAt": "2020-05-15T21:12:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDE3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050175", "bodyText": "A toast is showed twice, once here, and once when null is returned", "author": "david-allison-1", "createdAt": "2020-05-15T21:14:31Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);\n+\n+            Bitmap selectedBitmap = BitmapFactory.decodeStream(inputStream, null, bitmap2);\n+            inputStream.close();\n+\n+            file.createNewFile();\n+\n+            FileOutputStream outputStream = new FileOutputStream(file);\n+\n+            selectedBitmap.compress(Bitmap.CompressFormat.JPEG, 100 , outputStream);\n+\n+            return file;\n+        } catch (Exception e) {\n+            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDQxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050411", "bodyText": "try with resources here as well", "author": "david-allison-1", "createdAt": "2020-05-15T21:15:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDU4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050589", "bodyText": "Also catch OutOfMemoryError here", "author": "david-allison-1", "createdAt": "2020-05-15T21:15:31Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);\n+\n+            Bitmap selectedBitmap = BitmapFactory.decodeStream(inputStream, null, bitmap2);\n+            inputStream.close();\n+\n+            file.createNewFile();\n+\n+            FileOutputStream outputStream = new FileOutputStream(file);\n+\n+            selectedBitmap.compress(Bitmap.CompressFormat.JPEG, 100 , outputStream);\n+\n+            return file;\n+        } catch (Exception e) {", "originalCommit": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05bec673418481cd410d69c862de0b18222e8525", "url": "https://github.com/ankidroid/Anki-Android/commit/05bec673418481cd410d69c862de0b18222e8525", "message": "Update Preferences.java", "committedDate": "2020-05-15T23:13:32Z", "type": "commit"}, {"oid": "a92f1b79babe2513417d1e02372d883ca2e1c2f2", "url": "https://github.com/ankidroid/Anki-Android/commit/a92f1b79babe2513417d1e02372d883ca2e1c2f2", "message": "Update 03-dialogs.xml", "committedDate": "2020-05-16T04:08:11Z", "type": "commit"}, {"oid": "9ec5c80b5b361260a3516de3cf82b61b3bea166f", "url": "https://github.com/ankidroid/Anki-Android/commit/9ec5c80b5b361260a3516de3cf82b61b3bea166f", "message": "Update 03-dialogs.xml", "committedDate": "2020-05-16T04:13:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3NzY0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426177648", "bodyText": "consider moving this to a private static final String variable", "author": "david-allison-1", "createdAt": "2020-05-16T18:15:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -421,21 +421,30 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     String imgPathString = cursor.getString(columnIndex);\n                     File sourceFile = new File(imgPathString);\n \n+                    // file size in MB\n+                    long fileLength = sourceFile.length() / (1024 * 1024);\n+\n                     String currentAnkiDroidDirectory = CollectionHelper.getCurrentAnkiDroidDirectory(this);\n                     String imageName = \"DeckPickerBackground.png\";", "originalCommit": "9ec5c80b5b361260a3516de3cf82b61b3bea166f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9d0b1d608e184048ac7baae6423accf2cbec87f", "url": "https://github.com/ankidroid/Anki-Android/commit/e9d0b1d608e184048ac7baae6423accf2cbec87f", "message": "update preferences.java, 03-dialog.xml", "committedDate": "2020-05-17T03:05:56Z", "type": "commit"}]}