{"pr_number": 6372, "pr_title": "Browser: Don't compute question/answer unless they are required", "pr_createdAt": "2020-06-05T17:47:43Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6372", "timeline": [{"oid": "08079357133713802642b321ba05b24232e9c5e5", "url": "https://github.com/ankidroid/Anki-Android/commit/08079357133713802642b321ba05b24232e9c5e5", "message": "NF: don't compute question/answer if it's not used", "committedDate": "2020-06-05T17:56:18Z", "type": "forcePushed"}, {"oid": "e3db36ce813c304ae96e4e0136fc10be2c8760bf", "url": "https://github.com/ankidroid/Anki-Android/commit/e3db36ce813c304ae96e4e0136fc10be2c8760bf", "message": "NF: don't compute question/answer if it's not used", "committedDate": "2020-06-06T13:41:56Z", "type": "forcePushed"}, {"oid": "38accedd2bb5dec66e2603c8c6db9f6075acd560", "url": "https://github.com/ankidroid/Anki-Android/commit/38accedd2bb5dec66e2603c8c6db9f6075acd560", "message": "NF: CardCache have hash and equals\n\nThe comparison is based only on ids", "committedDate": "2020-06-06T19:42:01Z", "type": "forcePushed"}, {"oid": "5cf9981e008232f65d7dc25120bd2b3453c2f0b2", "url": "https://github.com/ankidroid/Anki-Android/commit/5cf9981e008232f65d7dc25120bd2b3453c2f0b2", "message": "NF: CardCache have hash and equals\n\nThe comparison is based only on ids", "committedDate": "2020-06-06T20:08:42Z", "type": "forcePushed"}, {"oid": "ac300e38efc942ff253ad54088b9cc1a2565d8a3", "url": "https://github.com/ankidroid/Anki-Android/commit/ac300e38efc942ff253ad54088b9cc1a2565d8a3", "message": "NF: use empty instead of size", "committedDate": "2020-06-06T22:00:47Z", "type": "forcePushed"}, {"oid": "10bf7817eed39982792988a72a38d575dea614fa", "url": "https://github.com/ankidroid/Anki-Android/commit/10bf7817eed39982792988a72a38d575dea614fa", "message": "NF: use empty instead of size", "committedDate": "2020-06-07T23:43:36Z", "type": "forcePushed"}, {"oid": "bd34b7d9c7a10b81c3e7c596161cbc1d592fff8e", "url": "https://github.com/ankidroid/Anki-Android/commit/bd34b7d9c7a10b81c3e7c596161cbc1d592fff8e", "message": "NF: use empty instead of size", "committedDate": "2020-06-08T14:32:35Z", "type": "forcePushed"}, {"oid": "b26ede33e1b567a46a027e44d8b2bc42358b02f7", "url": "https://github.com/ankidroid/Anki-Android/commit/b26ede33e1b567a46a027e44d8b2bc42358b02f7", "message": "NF: use empty instead of size", "committedDate": "2020-06-08T19:04:37Z", "type": "forcePushed"}, {"oid": "7d21e677194a0898946a9a30770977e204709592", "url": "https://github.com/ankidroid/Anki-Android/commit/7d21e677194a0898946a9a30770977e204709592", "message": "NF: use empty instead of size", "committedDate": "2020-06-13T23:55:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MzY4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r436073688", "bodyText": "I don't understand this method - shouldn't it be static?", "author": "david-allison-1", "createdAt": "2020-06-05T17:52:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2109,11 +1996,180 @@ private void onSelectionChanged() {\n     private long[] getAllCardIds() {\n         long[] l = new long[mCards.size()];\n         for (int i = 0; i < mCards.size(); i++) {\n-            l[i] = Long.parseLong(mCards.get(i).get(ID));\n+            l[i] = mCards.get(i).getId();\n         }\n         return l;\n     }\n \n+    public class CardCache {\n+        private long mId;\n+        private Card mCard = null;\n+        private boolean mLoaded = false;\n+        private Pair<String, String> mQa = null;\n+\n+        public CardCache(long id) {\n+            mId = id;\n+        }\n+\n+        public long getId() {\n+            return mId;\n+        }\n+\n+        /** clear all values except ID.*/\n+        public void reload() {\n+            mCard = null;\n+            mLoaded = false;\n+            mQa = null;\n+        }\n+\n+        public Card getCard() {\n+            if (mCard == null) {\n+                mCard = getCol().getCard(mId);\n+            }\n+            return mCard;\n+        }\n+\n+        /**\n+         * Get the background color of items in the card list based on the Card\n+         * @return index into TypedArray specifying the background color\n+         */\n+        private int getColor() {\n+            int flag = getCard().getUserFlag();\n+            switch (flag) {\n+                case 1:\n+                    return R.attr.flagRed;\n+                case 2:\n+                    return R.attr.flagOrange;\n+                case 3:\n+                    return R.attr.flagGreen;\n+                case 4:\n+                    return R.attr.flagBlue;\n+                default:\n+                    if (getCard().note().hasTag(\"marked\")) {\n+                        return R.attr.markedColor;\n+                    } else {\n+                        if (getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED) {\n+                            return R.attr.suspendedColor;\n+                        } else {\n+                            return android.R.attr.colorBackground;\n+                        }\n+                    }\n+            }\n+        }\n+\n+        public String content(Column key) {\n+            switch (key) {\n+            case FLAGS:\n+                return (new Integer(getCard().getUserFlag())).toString();\n+            case SUSPENDED:\n+                return getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED ? \"True\": \"False\";\n+            case MARKED:\n+                return getCard().note().hasTag(\"marked\") ? \"marked\" : null;\n+            case SFLD:\n+                return getCard().note().getSFld();\n+            case DECK:\n+                return getCol().getDecks().name(getCard().getDid());\n+            case TAGS:\n+                return getCard().note().stringTags();\n+            case CARD:\n+                return getCard().template().optString(\"name\");\n+            case DUE:\n+                return getCard().getDueString();\n+            case EASE:\n+                if (getCard().getType() == Consts.CARD_TYPE_NEW) {\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_ease_new_card);\n+                } else {\n+                    return (getCard().getFactor()/10)+\"%\";\n+                }\n+            case CHANGED:\n+                return LanguageUtil.getShortDateFormatFromS(getCard().getMod());\n+            case CREATED:\n+                return LanguageUtil.getShortDateFormatFromMs(getCard().note().getId());\n+            case EDITED:\n+                return LanguageUtil.getShortDateFormatFromS(getCard().note().getMod());\n+            case INTERVAL:\n+                switch (getCard().getType()) {\n+                case Consts.CARD_TYPE_NEW:\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_interval_new_card);\n+                case Consts.CARD_TYPE_LRN :\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_interval_learning_card);\n+                default:\n+                    return Utils.roundedTimeSpanUnformatted(AnkiDroidApp.getInstance(), getCard().getIvl()*86400);\n+                }\n+            case LAPSES:\n+                return Integer.toString(getCard().getLapses());\n+            case NOTE:\n+                return getCard().model().optString(\"name\");\n+            case REVIEWS:\n+                return Integer.toString(getCard().getReps());\n+            case QUESTION:\n+                updateSearchItemQA();\n+                return mQa.first;\n+            case ANSWER:\n+                updateSearchItemQA();\n+                return mQa.second;\n+            default:\n+                return null;\n+            }\n+        }\n+\n+        /** pre compute the note and question/answer.  It can safely\n+            be called twice without doing extra work. */\n+        public void load(boolean reload) {\n+            if (reload) {\n+                reload();\n+            }\n+            getCard().note();\n+            if (COLUMN1_KEYS[mColumn1Index] == QUESTION ||\n+                COLUMN1_KEYS[mColumn1Index] == ANSWER ||\n+                COLUMN2_KEYS[mColumn2Index] == QUESTION ||\n+                COLUMN2_KEYS[mColumn2Index] == ANSWER) {\n+                updateSearchItemQA();\n+            }\n+            mLoaded = true;\n+        }\n+\n+        public boolean isLoaded() {\n+            return mLoaded;\n+        }\n+\n+        /**\n+           Reload question and answer. Use browser format. If it's empty\n+           uses non-browser format. If answer starts by question, remove\n+           question.\n+        */\n+        public void updateSearchItemQA() {\n+            if (mQa != null) {\n+                return;\n+            }\n+            // render question and answer\n+            Map<String, String> qa = getCard()._getQA(true, true);\n+            // Render full question / answer if the bafmt (i.e. \"browser appearance\") setting forced blank result\n+            if (\"\".equals(qa.get(\"q\")) || \"\".equals(qa.get(\"a\"))) {\n+                HashMap<String, String> qaFull = getCard()._getQA(true, false);\n+                if (\"\".equals(qa.get(\"q\"))) {\n+                    qa.put(\"q\", qaFull.get(\"q\"));\n+                }\n+                if (\"\".equals(qa.get(\"a\"))) {\n+                    qa.put(\"a\", qaFull.get(\"a\"));\n+                }\n+            }\n+            // update the original hash map to include rendered question & answer\n+            String q = qa.get(\"q\");\n+            String a = qa.get(\"a\");\n+            // remove the question from the start of the answer if it exists\n+            if (a.startsWith(q)) {\n+                a = a.replaceFirst(Pattern.quote(q), \"\");\n+            }\n+            a = formatQA(a, AnkiDroidApp.getInstance());\n+            q = formatQA(q, AnkiDroidApp.getInstance());\n+            mQa = new Pair<>(q, a);\n+        }\n+    }\n+\n+    public CardCache getCardCache(long id) {\n+        return new CardCache(id);", "originalCommit": "3ff19e4812aa256822b22c87bae9fa510e432a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NTIyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446555228", "bodyText": "this method does not exists anymore. The point used to be that I wanted my CardCache to have access to the card browser, and I didn't know how to do \"cb.new CardCache\"", "author": "Arthur-Milchior", "createdAt": "2020-06-27T18:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MzY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzA1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r436317056", "bodyText": "card.getNid() would be good - I'm not a fan of the strict application of the law of demeter, but it'd be useful to have another more efficient backing store here.", "author": "david-allison-1", "createdAt": "2020-06-07T02:07:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -386,10 +390,10 @@ private boolean hasSelectedSingleNoteId() {\n             return false;\n         }\n         //copy to array to ensure threadsafe iteration\n-        Integer[] checkedPositions = mCheckedCardPositions.toArray(new Integer[0]);\n-        HashSet<String> notes = new HashSet<>();\n-        for (Integer position : checkedPositions) {\n-            String noteId = mCards.get(position).get(NOTE);\n+        CardCache[] checkedPositions = mCheckedCard.toArray(new CardCache[0]);\n+        HashSet<Long> notes = new HashSet<>();\n+        for (CardCache card : checkedPositions) {\n+            long noteId = card.getCard().getNid();", "originalCommit": "ac300e38efc942ff253ad54088b9cc1a2565d8a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NTYwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446555600", "bodyText": "I don't see any getCard().getNid anymore, so I'm going toi ignore this. I still see getCard().getNote(), but I like the fact that it is not cached. Indeed, this ensure that each time the card object is set back to null, the note object is note accessible anymore and has to be reloaded too", "author": "Arthur-Milchior", "createdAt": "2020-06-27T18:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NzI2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446557268", "bodyText": "Removing the access to Card here allows us to switch to a more efficient implementation later on. No caching required for the change.", "author": "david-allison-1", "createdAt": "2020-06-27T19:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU2MTc0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446561744", "bodyText": "I guess it would make sens. But we are commenting an outdated part of the code which no longer exists", "author": "Arthur-Milchior", "createdAt": "2020-06-27T19:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTcwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439811706", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (! idToRemove.contains(card.getId())) {\n          \n          \n            \n                        if (!idToRemove.contains(card.getId())) {", "author": "david-allison-1", "createdAt": "2020-06-14T09:51:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1582,10 +1516,10 @@ private void removeNotesView(java.util.Collection<Long> cardsIds, boolean reorde\n             }\n         }\n \n-        List<Map<String, String>> newMCards = new ArrayList<Map<String, String>>();\n-        for (Map<String, String> cardProperties: oldMCards) {\n-            if (! idToRemove.contains(Long.parseLong(cardProperties.get(ID)))) {\n-                newMCards.add(cardProperties);\n+        List<CardCache> newMCards = new ArrayList<>();\n+        for (CardCache card: oldMCards) {\n+            if (! idToRemove.contains(card.getId())) {", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NTY0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446555647", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-27T18:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTc0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439811740", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (! firstLoaded || ! lastLoaded) {\n          \n          \n            \n                            if (!firstLoaded || !lastLoaded) {", "author": "david-allison-1", "createdAt": "2020-06-14T09:52:21Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1831,10 +1765,10 @@ public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCoun\n             int lastVisibleItem = firstVisibleItem + visibleItemCount;\n             int size = getCardCount();\n             if ((size > 0) && (firstVisibleItem < size) && ((lastVisibleItem - 1) < size)) {\n-                String firstAns = getCards().get(firstVisibleItem).get(ANSWER);\n+                boolean firstLoaded = getCards().get(firstVisibleItem).isLoaded();\n                 // Note: max value of lastVisibleItem is totalItemCount, so need to subtract 1\n-                String lastAns = getCards().get(lastVisibleItem - 1).get(ANSWER);\n-                if (firstAns == null || lastAns == null) {\n+                boolean lastLoaded = getCards().get(lastVisibleItem - 1).isLoaded();\n+                if (! firstLoaded || ! lastLoaded) {", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NTczMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446555730", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-27T18:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTg1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439811854", "bodyText": "design: I'm not sure content is the best word. getColumnText springs to mind, but I still think it could be better.", "author": "david-allison-1", "createdAt": "2020-06-14T09:53:41Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1905,23 +1839,23 @@ public View getView(int position, View convertView, ViewGroup parent) {\n         private void bindView(final int position, final View v) {\n             // Draw the content in the columns\n             View[] columns = (View[]) v.getTag();\n-            final Map<String, String> card = getCards().get(position);\n+            final CardCache card = getCards().get(position);\n             for (int i = 0; i < mToIds.length; i++) {\n                 TextView col = (TextView) columns[i];\n                 // set font for column\n                 setFont(col);\n                 // set text for column\n-                col.setText(card.get(mFromKeys[i]));\n+                col.setText(card.content(mFromKeys[i]));", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU1NTcyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446555722", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-27T18:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTkyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439811928", "bodyText": "mCheckedCards", "author": "david-allison-1", "createdAt": "2020-06-14T09:54:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -198,7 +202,7 @@\n     private TextView mActionBarTitle;\n     private boolean mReloadRequired = false;\n     private boolean mInMultiSelectMode = false;\n-    private Set<Integer> mCheckedCardPositions = Collections.synchronizedSet(new LinkedHashSet<>());\n+    private Set<CardCache> mCheckedCard = Collections.synchronizedSet(new LinkedHashSet<>());", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NjA3OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446446079", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-26T23:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTk5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439811994", "bodyText": "Can this be cached, or are the callers optimised to only call this once?", "author": "david-allison-1", "createdAt": "2020-06-14T09:55:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2099,11 +1985,201 @@ private void onSelectionChanged() {\n     private long[] getAllCardIds() {\n         long[] l = new long[mCards.size()];\n         for (int i = 0; i < mCards.size(); i++) {\n-            l[i] = Long.parseLong(mCards.get(i).get(ID));\n+            l[i] = mCards.get(i).getId();\n         }\n         return l;\n     }\n \n+    public class CardCache {\n+        private long mId;\n+        private Card mCard = null;\n+        private boolean mLoaded = false;\n+        private Pair<String, String> mQa = null;\n+        private int mPosition;\n+\n+        public CardCache(long id, int position) {\n+            mId = id;\n+            mPosition = position;\n+        }\n+\n+        public long getId() {\n+            return mId;\n+        }\n+\n+        public int getPosition() {\n+            return mPosition;\n+        }\n+\n+        /** clear all values except ID.*/\n+        public void reload() {\n+            mCard = null;\n+            mLoaded = false;\n+            mQa = null;\n+        }\n+\n+        public Card getCard() {\n+            if (mCard == null) {\n+                mCard = getCol().getCard(mId);\n+            }\n+            return mCard;\n+        }\n+\n+        /**\n+         * Get the background color of items in the card list based on the Card\n+         * @return index into TypedArray specifying the background color\n+         */\n+        private int getColor() {\n+            int flag = getCard().getUserFlag();\n+            switch (flag) {\n+                case 1:\n+                    return R.attr.flagRed;\n+                case 2:\n+                    return R.attr.flagOrange;\n+                case 3:\n+                    return R.attr.flagGreen;\n+                case 4:\n+                    return R.attr.flagBlue;\n+                default:\n+                    if (getCard().note().hasTag(\"marked\")) {\n+                        return R.attr.markedColor;\n+                    } else {\n+                        if (getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED) {\n+                            return R.attr.suspendedColor;\n+                        } else {\n+                            return android.R.attr.colorBackground;\n+                        }\n+                    }\n+            }\n+        }\n+\n+        public String content(Column key) {", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NTQ3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446445475", "bodyText": "The method updateSearchItemQA starts by checking whether questiond and answer are computed in\n            if (mQa != null) {\n                return;\n            }\n\nIf it is already computed, then it will not compute it again. So the function called immediately returns. Does it answer your question ? I would expect \"content\" to be the caller, but I expect your question being about the function which is called, so it's not clear to me here what it means.", "author": "Arthur-Milchior", "createdAt": "2020-06-26T23:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMTk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjIwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439812205", "bodyText": "Could you add a quick comment stating that column1 can't be an answer", "author": "david-allison-1", "createdAt": "2020-06-14T09:58:13Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2099,11 +1985,201 @@ private void onSelectionChanged() {\n     private long[] getAllCardIds() {\n         long[] l = new long[mCards.size()];\n         for (int i = 0; i < mCards.size(); i++) {\n-            l[i] = Long.parseLong(mCards.get(i).get(ID));\n+            l[i] = mCards.get(i).getId();\n         }\n         return l;\n     }\n \n+    public class CardCache {\n+        private long mId;\n+        private Card mCard = null;\n+        private boolean mLoaded = false;\n+        private Pair<String, String> mQa = null;\n+        private int mPosition;\n+\n+        public CardCache(long id, int position) {\n+            mId = id;\n+            mPosition = position;\n+        }\n+\n+        public long getId() {\n+            return mId;\n+        }\n+\n+        public int getPosition() {\n+            return mPosition;\n+        }\n+\n+        /** clear all values except ID.*/\n+        public void reload() {\n+            mCard = null;\n+            mLoaded = false;\n+            mQa = null;\n+        }\n+\n+        public Card getCard() {\n+            if (mCard == null) {\n+                mCard = getCol().getCard(mId);\n+            }\n+            return mCard;\n+        }\n+\n+        /**\n+         * Get the background color of items in the card list based on the Card\n+         * @return index into TypedArray specifying the background color\n+         */\n+        private int getColor() {\n+            int flag = getCard().getUserFlag();\n+            switch (flag) {\n+                case 1:\n+                    return R.attr.flagRed;\n+                case 2:\n+                    return R.attr.flagOrange;\n+                case 3:\n+                    return R.attr.flagGreen;\n+                case 4:\n+                    return R.attr.flagBlue;\n+                default:\n+                    if (getCard().note().hasTag(\"marked\")) {\n+                        return R.attr.markedColor;\n+                    } else {\n+                        if (getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED) {\n+                            return R.attr.suspendedColor;\n+                        } else {\n+                            return android.R.attr.colorBackground;\n+                        }\n+                    }\n+            }\n+        }\n+\n+        public String content(Column key) {\n+            switch (key) {\n+            case FLAGS:\n+                return (new Integer(getCard().getUserFlag())).toString();\n+            case SUSPENDED:\n+                return getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED ? \"True\": \"False\";\n+            case MARKED:\n+                return getCard().note().hasTag(\"marked\") ? \"marked\" : null;\n+            case SFLD:\n+                return getCard().note().getSFld();\n+            case DECK:\n+                return getCol().getDecks().name(getCard().getDid());\n+            case TAGS:\n+                return getCard().note().stringTags();\n+            case CARD:\n+                return getCard().template().optString(\"name\");\n+            case DUE:\n+                return getCard().getDueString();\n+            case EASE:\n+                if (getCard().getType() == Consts.CARD_TYPE_NEW) {\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_ease_new_card);\n+                } else {\n+                    return (getCard().getFactor()/10)+\"%\";\n+                }\n+            case CHANGED:\n+                return LanguageUtil.getShortDateFormatFromS(getCard().getMod());\n+            case CREATED:\n+                return LanguageUtil.getShortDateFormatFromMs(getCard().note().getId());\n+            case EDITED:\n+                return LanguageUtil.getShortDateFormatFromS(getCard().note().getMod());\n+            case INTERVAL:\n+                switch (getCard().getType()) {\n+                case Consts.CARD_TYPE_NEW:\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_interval_new_card);\n+                case Consts.CARD_TYPE_LRN :\n+                    return AnkiDroidApp.getInstance().getString(R.string.card_browser_interval_learning_card);\n+                default:\n+                    return Utils.roundedTimeSpanUnformatted(AnkiDroidApp.getInstance(), getCard().getIvl()*86400);\n+                }\n+            case LAPSES:\n+                return Integer.toString(getCard().getLapses());\n+            case NOTE_TYPE:\n+                return getCard().model().optString(\"name\");\n+            case REVIEWS:\n+                return Integer.toString(getCard().getReps());\n+            case QUESTION:\n+                updateSearchItemQA();\n+                return mQa.first;\n+            case ANSWER:\n+                updateSearchItemQA();\n+                return mQa.second;\n+            default:\n+                return null;\n+            }\n+        }\n+\n+        /** pre compute the note and question/answer.  It can safely\n+            be called twice without doing extra work. */\n+        public void load(boolean reload) {\n+            if (reload) {\n+                reload();\n+            }\n+            getCard().note();\n+            if (\n+                COLUMN1_KEYS[mColumn1Index] == QUESTION ||\n+                COLUMN2_KEYS[mColumn2Index] == QUESTION ||\n+                COLUMN2_KEYS[mColumn2Index] == ANSWER) {", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NDg5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446444899", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-26T23:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjI5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439812291", "bodyText": "No longer relevant comment", "author": "david-allison-1", "createdAt": "2020-06-14T09:59:56Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -103,33 +103,37 @@\n \n import timber.log.Timber;\n \n+import static com.ichi2.anki.CardBrowser.Column.*;\n+\n public class CardBrowser extends NavigationDrawerActivity implements\n         DeckDropDownAdapter.SubtitleListener {\n \n     // Properties in mCards. this is a stringly typed map for speed.", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjcxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r439812714", "bodyText": "This (temporarily) leaks an activity reference, is there a better way to do this (extracting CardCache[] into a data structure for example)?", "author": "david-allison-1", "createdAt": "2020-06-14T10:05:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -910,19 +910,19 @@ private TaskData doInBackgroundSearchCards(TaskData... params) {\n         String query = (String) params[0].getObjArray()[0];\n         Boolean order = (Boolean) params[0].getObjArray()[1];\n         int numCardsToRender = (int) params[0].getObjArray()[2];\n+        CardBrowser cb = (CardBrowser) params[0].getObjArray()[3];", "originalCommit": "7d21e677194a0898946a9a30770977e204709592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MDY2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446450669", "bodyText": "A CardCache object needs to have access to the cardbrowser in order to get access to:\n\ngetCol\nmColumn1Index and mColumn2Index\n\nThe collection could easily be given as a parameter. However, it really needs to know current columns for optimization purpose, and also need to have access to it when the column change. I could ask the card browser to propagate this cahnge to the card cache, but that seems more error-prone. there seems to be little reason to do a loop over card cache to tell all of them.\nOf course, CardCache could call a method from CardBrowser instead of a direct access to the variable, but it still means it would need to access the CardBrowser, and so the CardCache would still contains an access to the CardBrowser.\nThe main trouble is that, since CardCache has access to CardBrowser, when CardCache is sent in background (i.e. in updateSearchItemQA) in order to precompute its value question/answer, it'll also send a reference to the CardBrowser. And I don't really know how to avoid that.\nI guess I may just give the two column index directly to updateSearchItemQA, but it will need mode refactorization", "author": "Arthur-Milchior", "createdAt": "2020-06-26T23:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1Njc4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r446656785", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-28T14:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxMjcxNA=="}], "type": "inlineReview"}, {"oid": "e9866b86609d36ac9155265671636ffbc1923b7e", "url": "https://github.com/ankidroid/Anki-Android/commit/e9866b86609d36ac9155265671636ffbc1923b7e", "message": "NF: use empty instead of size", "committedDate": "2020-06-26T22:58:48Z", "type": "forcePushed"}, {"oid": "ac0955a50df91ec8b7fd21516ca152cb204c2b5e", "url": "https://github.com/ankidroid/Anki-Android/commit/ac0955a50df91ec8b7fd21516ca152cb204c2b5e", "message": "NF: use empty instead of size", "committedDate": "2020-06-26T23:07:55Z", "type": "forcePushed"}, {"oid": "e293c043b3b551347ffd2dc4c0f9497339d66d14", "url": "https://github.com/ankidroid/Anki-Android/commit/e293c043b3b551347ffd2dc4c0f9497339d66d14", "message": "NF: Avoiding to leak Card Browser Activity", "committedDate": "2020-06-27T18:59:41Z", "type": "forcePushed"}, {"oid": "3dbad652d6ccb694b22501bdbb0e7da3a76f91e7", "url": "https://github.com/ankidroid/Anki-Android/commit/3dbad652d6ccb694b22501bdbb0e7da3a76f91e7", "message": "NF: use empty instead of size", "committedDate": "2020-06-27T20:26:00Z", "type": "forcePushed"}, {"oid": "53c59bfcbb16132b5c95b3380970539dfd765de0", "url": "https://github.com/ankidroid/Anki-Android/commit/53c59bfcbb16132b5c95b3380970539dfd765de0", "message": "NF: use empty instead of size", "committedDate": "2020-07-04T17:23:12Z", "type": "forcePushed"}, {"oid": "0f28d195d25b5bc21211621ca0328e42e24508fa", "url": "https://github.com/ankidroid/Anki-Android/commit/0f28d195d25b5bc21211621ca0328e42e24508fa", "message": "NF: use empty instead of size", "committedDate": "2020-07-04T17:24:37Z", "type": "forcePushed"}, {"oid": "5916a5467f0fc159fc5ea3a1fcb91063b2795931", "url": "https://github.com/ankidroid/Anki-Android/commit/5916a5467f0fc159fc5ea3a1fcb91063b2795931", "message": "NF: use empty instead of size", "committedDate": "2020-07-04T17:25:10Z", "type": "forcePushed"}, {"oid": "4d28ef1aaef0476aaf752f4157cf3eba13e92a81", "url": "https://github.com/ankidroid/Anki-Android/commit/4d28ef1aaef0476aaf752f4157cf3eba13e92a81", "message": "NF: use empty instead of size", "committedDate": "2020-07-05T23:10:44Z", "type": "forcePushed"}, {"oid": "f01cbb2eb3f64b1d1cbf57a4b66339977d3cfa57", "url": "https://github.com/ankidroid/Anki-Android/commit/f01cbb2eb3f64b1d1cbf57a4b66339977d3cfa57", "message": "NF: use empty instead of size", "committedDate": "2020-07-05T23:47:25Z", "type": "forcePushed"}, {"oid": "9e829667621150942b680aa19286327d6b348b48", "url": "https://github.com/ankidroid/Anki-Android/commit/9e829667621150942b680aa19286327d6b348b48", "message": "NF: use empty instead of size", "committedDate": "2020-07-22T00:14:58Z", "type": "forcePushed"}, {"oid": "9bb14ef1ae041ee2c87bfc3f7e3508889fa6c880", "url": "https://github.com/ankidroid/Anki-Android/commit/9bb14ef1ae041ee2c87bfc3f7e3508889fa6c880", "message": "NF: use empty instead of size", "committedDate": "2020-07-22T05:14:24Z", "type": "forcePushed"}, {"oid": "9463b840589e4645a77c1661f4dd53c75c779f0b", "url": "https://github.com/ankidroid/Anki-Android/commit/9463b840589e4645a77c1661f4dd53c75c779f0b", "message": "NF: use empty instead of size", "committedDate": "2020-07-24T11:11:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNzY4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460037686", "bodyText": "We shouldn't need the array copy now we're iterating over the same collection", "author": "david-allison-1", "createdAt": "2020-07-24T13:01:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -373,11 +374,11 @@ private void onSearch() {\n \n     private long[] getSelectedCardIds() {\n         //copy to array to ensure threadsafe iteration\n-        Integer[] checkedPositions = mCheckedCardPositions.toArray(new Integer[0]);\n-        long[] ids = new long[checkedPositions.length];\n+        CardCache[] checkedCards = mCheckedCards.toArray(new CardCache[0]);\n+        long[] ids = new long[checkedCards.length];\n         int count = 0;\n-        for (int cardPosition : checkedPositions) {\n-            ids[count++] = Long.valueOf(mCards.get(cardPosition).get(ID));\n+        for (CardCache cardPosition : checkedCards) {", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1MjY5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460052690", "bodyText": "I don't know why the copy was there. I just tried to stay close to previous code. If you feel it's safe, I'll add a commit deleting it", "author": "Arthur-Milchior", "createdAt": "2020-07-24T13:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2NTE0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460065145", "bodyText": "This is also a translation from CardCache to card id. It seems to be useful, because at some points, the card IDs are given to background tasks that are not fit to receive CardCache, so I think I should keep it.", "author": "Arthur-Milchior", "createdAt": "2020-07-24T13:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2NzYzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460067631", "bodyText": "The method's fine, but the checkedCards variable shouldn't need to be created", "author": "david-allison-1", "createdAt": "2020-07-24T13:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNzY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NzA4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460097089", "bodyText": "Oh okay.\u00a0I wasn't looking at the righ line", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNzY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzODk1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460038958", "bodyText": "I don't get how this could occur, could you explain the change more?", "author": "david-allison-1", "createdAt": "2020-07-24T13:04:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -562,10 +563,10 @@ public void onItemSelected(AdapterView<?> parent, View view, int pos, long id) {\n                     mColumn2Index = pos;\n                     AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance().getBaseContext()).edit()\n                             .putInt(\"cardBrowserColumn2\", mColumn2Index).commit();\n-                    String[] fromMap = mCardsAdapter.getFromMapping();\n+                    Column[] fromMap = mCardsAdapter.getFromMapping();\n                     fromMap[1] = COLUMN2_KEYS[mColumn2Index];\n                     if (fromMap[1] == null) {", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1Mzg1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460053851", "bodyText": "No reason to still check it. I just didn't re read every line.", "author": "Arthur-Milchior", "createdAt": "2020-07-24T13:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzODk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA2NjIwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460066200", "bodyText": "I don't even know how it was possible before", "author": "Arthur-Milchior", "createdAt": "2020-07-24T13:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzODk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzOTQwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460039400", "bodyText": "Again, I don't think this can be null any more, is this logic retained?", "author": "david-allison-1", "createdAt": "2020-07-24T13:05:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -579,9 +580,9 @@ public void onNothingSelected(AdapterView<?> parent) {\n         // get the font and font size from the preferences\n         int sflRelativeFontSize = preferences.getInt(\"relativeCardBrowserFontSize\", DEFAULT_FONT_SIZE_RATIO);\n         String sflCustomFont = preferences.getString(\"browserEditorFont\", \"\");\n-        String[] columnsContent = {COLUMN1_KEYS[mColumn1Index], COLUMN2_KEYS[mColumn2Index]};\n+        Column[] columnsContent = {COLUMN1_KEYS[mColumn1Index], COLUMN2_KEYS[mColumn2Index]};\n         if (columnsContent[1] == null) {", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0MzA0Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460043042", "bodyText": "I think we want to ensure that we're using the same instance from  getCards() throughout this procedure", "author": "david-allison-1", "createdAt": "2020-07-24T13:12:35Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1406,30 +1416,13 @@ public void onPostExecute(TaskData result) {\n     private void updateCardsInList(List<Card> cards, Map<Long, String> updatedCardTags) {\n         Map<Long, Integer> idToPos = getPositionMap(getCards());\n         for (Card c : cards) {\n-            Note note = c.note();\n             // get position in the mCards search results HashMap\n             int pos = idToPos.containsKey(c.getId()) ? idToPos.get(c.getId()) : -1;\n             if (pos < 0 || pos >= getCardCount()) {\n                 continue;\n             }\n-            Map<String, String> card = getCards().get(pos);\n-            // update tags\n-            card.put(MARKED, (c.note().hasTag(\"marked\")) ? \"marked\" : null);\n-            if (updatedCardTags != null) {\n-                card.put(TAGS, updatedCardTags.get(c.getNid()));\n-            }\n-            // update sfld\n-            String sfld = note.getSFld();\n-            card.put(SFLD, sfld);\n             // update Q & A etc\n-            updateSearchItemQA(getBaseContext(), card, c, getCol());\n-            // update deck\n-            String deckName;\n-            deckName = getCol().getDecks().get(c.getDid()).getString(\"name\");\n-            card.put(DECK, deckName);\n-            // update flags (marked / suspended / etc) which determine color\n-            card.put(SUSPENDED, c.getQueue() == Consts.QUEUE_TYPE_SUSPENDED ? \"True\": \"False\");\n-            card.put(FLAGS, (new Integer(c.userFlag())).toString());\n+            getCards().get(pos).load(true, mColumn1Index, mColumn2Index);", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3Mzg5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460073892", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0MzA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NDU2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460044561", "bodyText": "getColumnHeaderText?", "author": "david-allison-1", "createdAt": "2020-07-24T13:15:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1927,23 +1860,23 @@ public View getView(int position, View convertView, ViewGroup parent) {\n         private void bindView(final int position, final View v) {\n             // Draw the content in the columns\n             View[] columns = (View[]) v.getTag();\n-            final Map<String, String> card = getCards().get(position);\n+            final CardCache card = getCards().get(position);\n             for (int i = 0; i < mToIds.length; i++) {\n                 TextView col = (TextView) columns[i];\n                 // set font for column\n                 setFont(col);\n                 // set text for column\n-                col.setText(card.get(mFromKeys[i]));\n+                col.setText(card.getColumnText(mFromKeys[i]));", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1NjkzNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460056936", "bodyText": "Ok", "author": "Arthur-Milchior", "createdAt": "2020-07-24T13:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NDU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTQ5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460045494", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    mActionBarTitle.setText(String.valueOf(mCheckedCards.size()));\n          \n          \n            \n                    mActionBarTitle.setText(String.valueOf(checkedCardCount()));", "author": "david-allison-1", "createdAt": "2020-07-24T13:17:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2177,7 +2257,7 @@ private void loadMultiSelectMode() {\n         mInMultiSelectMode = true;\n         // show title and hide spinner\n         mActionBarTitle.setVisibility(View.VISIBLE);\n-        mActionBarTitle.setText(String.valueOf(mCheckedCardPositions.size()));\n+        mActionBarTitle.setText(String.valueOf(mCheckedCards.size()));", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTU5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460045592", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @VisibleForTesting", "author": "david-allison-1", "createdAt": "2020-07-24T13:17:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2205,7 +2285,7 @@ private void endMultiSelectMode() {\n \n     @VisibleForTesting", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3NTU2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460075563", "bodyText": "Why ? There is still no reason appart from testing, to set it to public", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MDYxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460090613", "bodyText": "Further suggestions use the method", "author": "david-allison-1", "createdAt": "2020-07-24T14:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NjcwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460096701", "bodyText": "Yes, but it is used only in the current class. So there would still be no reason to let it be public instead of private", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NTc0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460045745", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return mCheckedCards.size() >= getCardCount(); //must handle 0.\n          \n          \n            \n                    return checkedCardCount() >= getCardCount(); //must handle 0.", "author": "david-allison-1", "createdAt": "2020-07-24T13:17:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -877,11 +879,11 @@ private void updateMultiselectMenu() {\n \n \n     private boolean hasSelectedCards() {\n-        return mCheckedCardPositions.size() > 0;\n+        return !mCheckedCards.isEmpty();\n     }\n \n     private boolean hasSelectedAllCards() {\n-        return mCheckedCardPositions.size() >= getCardCount(); //must handle 0.\n+        return mCheckedCards.size() >= getCardCount(); //must handle 0.", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NjEwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460046109", "bodyText": "Maybe extract to hasCheckedCards() or similar", "author": "david-allison-1", "createdAt": "2020-07-24T13:18:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1051,13 +1053,13 @@ public void onClick(DialogInterface dialog, int which) {\n \n             case R.id.action_preview: {\n                 Intent previewer = new Intent(CardBrowser.this, Previewer.class);\n-                if (mInMultiSelectMode && mCheckedCardPositions.size() > 1) {\n+                if (mInMultiSelectMode && mCheckedCards.size() > 1) {", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3NzY4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460077685", "bodyText": "I don't see the point. There is a single instance.\nFurthermore, we are checking whether they are at least two checked cards. The name would not make it clear", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NjEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MDg4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460090882", "bodyText": "Damn, you're right", "author": "david-allison-1", "createdAt": "2020-07-24T14:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NjEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NjM0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460046347", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                int startIndex = mCheckedCards.isEmpty() ? 0: mCheckedCards.iterator().next().getPosition();\n          \n          \n            \n                                int startIndex = mCheckedCards.isEmpty() ? 0 : mCheckedCards.iterator().next().getPosition();", "author": "david-allison-1", "createdAt": "2020-07-24T13:18:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1051,13 +1053,13 @@ public void onClick(DialogInterface dialog, int which) {\n \n             case R.id.action_preview: {\n                 Intent previewer = new Intent(CardBrowser.this, Previewer.class);\n-                if (mInMultiSelectMode && mCheckedCardPositions.size() > 1) {\n+                if (mInMultiSelectMode && mCheckedCards.size() > 1) {\n                     // Multiple cards have been explicitly selected, so preview only those cards\n                     previewer.putExtra(\"index\", 0);\n                     previewer.putExtra(\"cardList\", getSelectedCardIds());\n                 } else {\n                     // Preview all cards, starting from the one that is currently selected\n-                    int startIndex = mCheckedCardPositions.isEmpty() ? 0: mCheckedCardPositions.iterator().next();\n+                    int startIndex = mCheckedCards.isEmpty() ? 0: mCheckedCards.iterator().next().getPosition();", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3ODMyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460078322", "bodyText": "Right....\nto be honest, I don't usually check the syntax of the code I didn't change. In this case, the 0: was already here previously", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NjM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0Njc0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460046743", "bodyText": "``\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        mActionBarTitle.setText(Integer.toString(mCheckedCards.size()));\n          \n          \n            \n                        mActionBarTitle.setText(Integer.toString(checkedCardCount()));", "author": "david-allison-1", "createdAt": "2020-07-24T13:19:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2105,13 +1990,13 @@ private void onSelectionChanged() {\n             }\n \n             updateMultiselectMenu();\n-            mActionBarTitle.setText(Integer.toString(mCheckedCardPositions.size()));\n+            mActionBarTitle.setText(Integer.toString(mCheckedCards.size()));", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NzQyMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460047423", "bodyText": "@Nullable", "author": "david-allison-1", "createdAt": "2020-07-24T13:20:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -2121,11 +2006,206 @@ private void onSelectionChanged() {\n     private long[] getAllCardIds() {\n         long[] l = new long[mCards.size()];\n         for (int i = 0; i < mCards.size(); i++) {\n-            l[i] = Long.parseLong(mCards.get(i).get(ID));\n+            l[i] = mCards.get(i).getId();\n         }\n         return l;\n     }\n \n+    public static class CardCache {\n+        private long mId;\n+        private Collection mCol;\n+        private Card mCard = null;\n+        private boolean mLoaded = false;\n+        private Pair<String, String> mQa = null;\n+        private int mPosition;\n+\n+        public CardCache(long id, Collection col, int position) {\n+            mId = id;\n+            mCol = col;\n+            mPosition = position;\n+        }\n+\n+        public long getId() {\n+            return mId;\n+        }\n+\n+        public int getPosition() {\n+            return mPosition;\n+        }\n+\n+        /** clear all values except ID.*/\n+        public void reload() {\n+            mCard = null;\n+            mLoaded = false;\n+            mQa = null;\n+        }\n+\n+        public Card getCard() {\n+            if (mCard == null) {\n+                mCard = mCol.getCard(mId);\n+            }\n+            return mCard;\n+        }\n+\n+        /**\n+         * Get the background color of items in the card list based on the Card\n+         * @return index into TypedArray specifying the background color\n+         */\n+        private int getColor() {\n+            int flag = getCard().userFlag();\n+            switch (flag) {\n+                case 1:\n+                    return R.attr.flagRed;\n+                case 2:\n+                    return R.attr.flagOrange;\n+                case 3:\n+                    return R.attr.flagGreen;\n+                case 4:\n+                    return R.attr.flagBlue;\n+                default:\n+                    if (getCard().note().hasTag(\"marked\")) {\n+                        return R.attr.markedColor;\n+                    } else {\n+                        if (getCard().getQueue() == Consts.QUEUE_TYPE_SUSPENDED) {\n+                            return R.attr.suspendedColor;\n+                        } else {\n+                            return android.R.attr.colorBackground;\n+                        }\n+                    }\n+            }\n+        }\n+\n+        public String getColumnText(Column key) {", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3OTI0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460079243", "bodyText": "Are you sure ?\u00a0In theory, it should never return nulls. It occurs only if the theoretical case where no element of switch is satisfied and the default occurs. Normally, that should not occurs", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NzQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MTM0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460091344", "bodyText": "Hmm... that's difficult. Let's leave it as it is", "author": "david-allison-1", "createdAt": "2020-07-24T14:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0NzQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1MTIyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460051228", "bodyText": "Having CardCache contain position can lead to bugs, as removing or adding from the list will cause inconsistent data. Is there a way to have the data structure keep track of this?", "author": "david-allison-1", "createdAt": "2020-07-24T13:27:24Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -968,17 +968,19 @@ private TaskData doInBackgroundSearchCards(TaskData... params) {\n         String query = (String) params[0].getObjArray()[0];\n         Boolean order = (Boolean) params[0].getObjArray()[1];\n         int numCardsToRender = (int) params[0].getObjArray()[2];\n-        List<Long> searchResult_ = col.findCards(query, order, this);\n         if (isCancelled()) {\n             Timber.d(\"doInBackgroundSearchCards was cancelled so return null\");\n             return null;\n         }\n+        int column1Index = (Integer) params[0].getObjArray()[3];\n+        int column2Index = (Integer) params[0].getObjArray()[4];\n+        List<Long> searchResult_ = col.findCards(query, order, this);\n         int resultSize = searchResult_.size();\n-        List<Map<String,String>> searchResult = new ArrayList<>(resultSize);\n+        List<CardBrowser.CardCache> searchResult = new ArrayList<>(resultSize);\n         Timber.d(\"The search found %d cards\", resultSize);\n+        int position = 0;\n         for (Long cid: searchResult_) {\n-            Map<String, String> card = new HashMap<>();\n-            card.put(CardBrowser.ID, cid.toString());\n+            CardBrowser.CardCache card = new CardBrowser.CardCache(cid, col, position++);", "originalCommit": "9463b840589e4645a77c1661f4dd53c75c779f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA4Nzg5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6372#discussion_r460087898", "bodyText": "The list is never modified. I added a note stating that if the list is modified, the position should be modified too.\nThe only change right now is when elements are deleted, a new list is created. I ensured that even in this card, the position are correct", "author": "Arthur-Milchior", "createdAt": "2020-07-24T14:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1MTIyOA=="}], "type": "inlineReview"}, {"oid": "ff45236566a225367144f9e6c8e0f2aa1750f363", "url": "https://github.com/ankidroid/Anki-Android/commit/ff45236566a225367144f9e6c8e0f2aa1750f363", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-07-24T14:26:05Z", "type": "forcePushed"}, {"oid": "8bfcc94e4a61f413376b93d938054bcb025a1e7a", "url": "https://github.com/ankidroid/Anki-Android/commit/8bfcc94e4a61f413376b93d938054bcb025a1e7a", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-07-24T14:28:59Z", "type": "forcePushed"}, {"oid": "abdaecc8b0814c3bdac85cb81fa62a3e36515baa", "url": "https://github.com/ankidroid/Anki-Android/commit/abdaecc8b0814c3bdac85cb81fa62a3e36515baa", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-04T19:26:52Z", "type": "forcePushed"}, {"oid": "81cd8fc09eb9f3511a699c10397b2950a9915f29", "url": "https://github.com/ankidroid/Anki-Android/commit/81cd8fc09eb9f3511a699c10397b2950a9915f29", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-07T23:18:03Z", "type": "forcePushed"}, {"oid": "f8d48b819586b79bf4085fb010de08e409bf50e5", "url": "https://github.com/ankidroid/Anki-Android/commit/f8d48b819586b79bf4085fb010de08e409bf50e5", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-07T23:29:06Z", "type": "forcePushed"}, {"oid": "29b8174bc4abe92d48c25ed45ea0ebf9f386f96e", "url": "https://github.com/ankidroid/Anki-Android/commit/29b8174bc4abe92d48c25ed45ea0ebf9f386f96e", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-07T23:43:43Z", "type": "forcePushed"}, {"oid": "5a330c9fbd791fe6c4810d7c56069c67a41526d1", "url": "https://github.com/ankidroid/Anki-Android/commit/5a330c9fbd791fe6c4810d7c56069c67a41526d1", "message": "NF: remove unused setter setCards", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "9b2a68c2a79f2aa132d8c63f85aa43569ab9e280", "url": "https://github.com/ankidroid/Anki-Android/commit/9b2a68c2a79f2aa132d8c63f85aa43569ab9e280", "message": "NF: create type cardCache", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "43a37f4ca2106fdef6de2ea21a2d320e95482218", "url": "https://github.com/ankidroid/Anki-Android/commit/43a37f4ca2106fdef6de2ea21a2d320e95482218", "message": "NF: replace ID by \"id\".\n\nID represents a browser column. In this case \"id\" represents a JSON\nentry. The same constant should not be used.", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "8a794df8a6c18d430764362dea7f6cf9796a9b1a", "url": "https://github.com/ankidroid/Anki-Android/commit/8a794df8a6c18d430764362dea7f6cf9796a9b1a", "message": "NF: \"id\" to ID\n\nThose \"id\" are referring to elements of a CardCache", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "fe9e653a666779f476344ae7f1816544145a58d4", "url": "https://github.com/ankidroid/Anki-Android/commit/fe9e653a666779f476344ae7f1816544145a58d4", "message": "NF: reload in CardCache", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "ee4c36a18630e246a5cc3fbc134e4686c6502d4d", "url": "https://github.com/ankidroid/Anki-Android/commit/ee4c36a18630e246a5cc3fbc134e4686c6502d4d", "message": "NF: reload CardCache in updateCardsInList", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "908d1fc8298520298e4471ad3cee8fa8052c32a3", "url": "https://github.com/ankidroid/Anki-Android/commit/908d1fc8298520298e4471ad3cee8fa8052c32a3", "message": "NF: id in CardCache\n\nConstructor always take a long, not a Long, not a String. So no\nworries about missing values or non parsable string. This part of the\ncode can be removed", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "ab971e646f0fd1de0f5f0332fab18e4607a28b46", "url": "https://github.com/ankidroid/Anki-Android/commit/ab971e646f0fd1de0f5f0332fab18e4607a28b46", "message": "NF: CardClass has card accessor\n\nThis save the card object in memory. It is acceptable because it is\ndone only for cards selected, card displayed and card near the card\ndisplayed. So the amount of memory used is limited. Furthermore, it\navoids extra database access to get the card object later in the execution.", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "ca90303ced6471bac5bf3c632c354b1b615d71c9", "url": "https://github.com/ankidroid/Anki-Android/commit/ca90303ced6471bac5bf3c632c354b1b615d71c9", "message": "NF: move getFlagOrDefault in CardClass", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "d2db1ffb2c403e11719470eceb94781f68a0f051", "url": "https://github.com/ankidroid/Anki-Android/commit/d2db1ffb2c403e11719470eceb94781f68a0f051", "message": "NF: getColor, get variable when needed", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "690d07f40eb2335949e287248ee7aedf54b61214", "url": "https://github.com/ankidroid/Anki-Android/commit/690d07f40eb2335949e287248ee7aedf54b61214", "message": "NF: simplify flag", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "e3fd297ad6bfbea7e0b486b913f2d59a7155b6ac", "url": "https://github.com/ankidroid/Anki-Android/commit/e3fd297ad6bfbea7e0b486b913f2d59a7155b6ac", "message": "NF: simplify getFlagOrDefault to use card", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "0f22f0c14b2353cefc2a8c107315daa6f9cc979a", "url": "https://github.com/ankidroid/Anki-Android/commit/0f22f0c14b2353cefc2a8c107315daa6f9cc979a", "message": "NF: remove getFlagOrDefault", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "6c2472c34d0b2b260df929ca92e485fcea88c5df", "url": "https://github.com/ankidroid/Anki-Android/commit/6c2472c34d0b2b260df929ca92e485fcea88c5df", "message": "NF: getColor in CardClass", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "54abc7a8493e5e193242fe580d6f31977751ab96", "url": "https://github.com/ankidroid/Anki-Android/commit/54abc7a8493e5e193242fe580d6f31977751ab96", "message": "NF: uses card feature in color", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "c941451e7bf050d6e8cfb038c46bfe493ac063c3", "url": "https://github.com/ankidroid/Anki-Android/commit/c941451e7bf050d6e8cfb038c46bfe493ac063c3", "message": "NF: cardProperties renamed to card", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "ac8266e84680d217a238a2e3c30b54b85040514f", "url": "https://github.com/ankidroid/Anki-Android/commit/ac8266e84680d217a238a2e3c30b54b85040514f", "message": "NF: introduce variable text_for_column in bindView", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "9c355ece958cf4848e2a8c6d0b9ca0ba38c44f50", "url": "https://github.com/ankidroid/Anki-Android/commit/9c355ece958cf4848e2a8c6d0b9ca0ba38c44f50", "message": "NF: uses content instead than setText", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "16a3081d7f3e162bedf2833d138c4052f9419dcd", "url": "https://github.com/ankidroid/Anki-Android/commit/16a3081d7f3e162bedf2833d138c4052f9419dcd", "message": "NF: CardCache deal with loading\n\nLoading fetch note and question/answer. This is not entirely efficient\nsince question/answer is not necessarily needed, it should be improved\nsomeplace else.\n\nInstead of checking for question/answer value, we check if loading did\noccur. We also simply states the card to load when we want to\nprecompute it in background.\n\nIt can be indicated to reload the value, if we expect the note to have\nchanged (tag, fields...)", "committedDate": "2020-08-13T17:44:36Z", "type": "commit"}, {"oid": "77daaca9b65534ca44f41670177be4f9373a9ecf", "url": "https://github.com/ankidroid/Anki-Android/commit/77daaca9b65534ca44f41670177be4f9373a9ecf", "message": "NF: FLAGS in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "c44d8d1c9b2d33885392ed79ee15eda9e0b20cf7", "url": "https://github.com/ankidroid/Anki-Android/commit/c44d8d1c9b2d33885392ed79ee15eda9e0b20cf7", "message": "NF: SUSPENDED in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "4a4795feed353bf84dc958df611682b40d89c553", "url": "https://github.com/ankidroid/Anki-Android/commit/4a4795feed353bf84dc958df611682b40d89c553", "message": "NF: MARKED in Content\n\nTwo deleted lines have different content. Theoretically they should\nhave been the same. However, the regexp matches also:\n* notmarkedatall\nwhile the hasTag matches\n* MARKED\n\nI kept the one which mades more sens.", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "24373e796b0e331e43ebff441b2417f9d5594459", "url": "https://github.com/ankidroid/Anki-Android/commit/24373e796b0e331e43ebff441b2417f9d5594459", "message": "NF: remove unused sMarkedPattern", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "65f77793c1d135440df1c5d2182f59ae7418abd6", "url": "https://github.com/ankidroid/Anki-Android/commit/65f77793c1d135440df1c5d2182f59ae7418abd6", "message": "NF: SFLD in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "98614e5a9c00ab35f7ea28de87ec514e1f5a4223", "url": "https://github.com/ankidroid/Anki-Android/commit/98614e5a9c00ab35f7ea28de87ec514e1f5a4223", "message": "NF: DECK in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "c105dc2e1b4177cd43a3ba923834e4552bea6e67", "url": "https://github.com/ankidroid/Anki-Android/commit/c105dc2e1b4177cd43a3ba923834e4552bea6e67", "message": "NF: TAGS in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "1c37eb925fcc4fba81709edb5b67a7805b0d4c80", "url": "https://github.com/ankidroid/Anki-Android/commit/1c37eb925fcc4fba81709edb5b67a7805b0d4c80", "message": "NF: CARD in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "7a02081e2132b07162082f815a9c95b0d2b01b40", "url": "https://github.com/ankidroid/Anki-Android/commit/7a02081e2132b07162082f815a9c95b0d2b01b40", "message": "NF: DUE in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "015d7600a8d822354ea9891a752f0eca7b79f7fd", "url": "https://github.com/ankidroid/Anki-Android/commit/015d7600a8d822354ea9891a752f0eca7b79f7fd", "message": "NF: EASE in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "a08bd2a223f7fe8e2de50c5aa75207019829d7f6", "url": "https://github.com/ankidroid/Anki-Android/commit/a08bd2a223f7fe8e2de50c5aa75207019829d7f6", "message": "NF: CHANGED in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "28f734d71ba4c8e170da0cab7a8f0150ba409ef9", "url": "https://github.com/ankidroid/Anki-Android/commit/28f734d71ba4c8e170da0cab7a8f0150ba409ef9", "message": "NF: CREATED in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "ce00082bebaed0fd20cc209ef42dbd7fdb864557", "url": "https://github.com/ankidroid/Anki-Android/commit/ce00082bebaed0fd20cc209ef42dbd7fdb864557", "message": "NF: EDITED in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "4f5206d23ce128e634862c048554b62cd13ee70d", "url": "https://github.com/ankidroid/Anki-Android/commit/4f5206d23ce128e634862c048554b62cd13ee70d", "message": "NF: INTERVAL in Content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "a3514f5574a591733957a7eedc62df25f1096eca", "url": "https://github.com/ankidroid/Anki-Android/commit/a3514f5574a591733957a7eedc62df25f1096eca", "message": "NF: LAPSES in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "7ac3dbad9d0597d42c5438e380abf1cde8b7c095", "url": "https://github.com/ankidroid/Anki-Android/commit/7ac3dbad9d0597d42c5438e380abf1cde8b7c095", "message": "NF: NOTE_TYPE in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "4515bf076d0a5e34f4a8cb22bfdaff37c1b95076", "url": "https://github.com/ankidroid/Anki-Android/commit/4515bf076d0a5e34f4a8cb22bfdaff37c1b95076", "message": "NF: REVIEWS in content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "3b2b2d2ad5e428534e51c610d929340bd4fe1c40", "url": "https://github.com/ankidroid/Anki-Android/commit/3b2b2d2ad5e428534e51c610d929340bd4fe1c40", "message": "NF: remove unused paramater, varilable and comment", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "3fbcfa07b46527e758cc30a7740bf6630c2bdee7", "url": "https://github.com/ankidroid/Anki-Android/commit/3fbcfa07b46527e758cc30a7740bf6630c2bdee7", "message": "NF: context is got directly in updateSearchItemQA", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "ea18eae5a900fc916aeb6feb0d211b03fd663f73", "url": "https://github.com/ankidroid/Anki-Android/commit/ea18eae5a900fc916aeb6feb0d211b03fd663f73", "message": "NF: updateSearchItemQA don't take card, but get it from CardCache", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "8c51428eb0905f262c64a9c92588b5f80119188a", "url": "https://github.com/ankidroid/Anki-Android/commit/8c51428eb0905f262c64a9c92588b5f80119188a", "message": "NF: Question/Answer in Content", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "0f116a296f8732f6b3b7b55f262df75214767e52", "url": "https://github.com/ankidroid/Anki-Android/commit/0f116a296f8732f6b3b7b55f262df75214767e52", "message": "NF: To get card browser value, uses only .content\n\nThere is nothing anymore in the map", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "8131713ff79549cbe154c400eca2165a288cd602", "url": "https://github.com/ankidroid/Anki-Android/commit/8131713ff79549cbe154c400eca2165a288cd602", "message": "NF: CardCache deal with loading\n\nLoading fetch note and question/answer. This is not entirely efficient\nsince question/answer is not necessarily needed, it should be improved\nsomeplace else.\n\nInstead of checking for question/answer value, we check if loading did\noccur. We also simply states the card to load when we want to\nprecompute it in background.\n\nIt can be indicated to reload the value, if we expect the note to have\nchanged (tag, fields...)", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "bf93dc66afe87b0e4355f25e4e8c2c66555c3a2a", "url": "https://github.com/ankidroid/Anki-Android/commit/bf93dc66afe87b0e4355f25e4e8c2c66555c3a2a", "message": "NF: simplify slightly code", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "84dfdca81148445da44cad2f2cf87aa594659e2a", "url": "https://github.com/ankidroid/Anki-Android/commit/84dfdca81148445da44cad2f2cf87aa594659e2a", "message": "NF: CardCache does not inherits HashMap", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "bfce76537dd723d2d24137b61ae9b5ca2a3f49f4", "url": "https://github.com/ankidroid/Anki-Android/commit/bfce76537dd723d2d24137b61ae9b5ca2a3f49f4", "message": "NF: use enum for column", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "5d76026f5cfa66d5d6c4204623bed9021c875102", "url": "https://github.com/ankidroid/Anki-Android/commit/5d76026f5cfa66d5d6c4204623bed9021c875102", "message": "NF: don't compute question/answer if it's not used", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "0258c11a3f351cc8c8c3903722813f37df6fd92c", "url": "https://github.com/ankidroid/Anki-Android/commit/0258c11a3f351cc8c8c3903722813f37df6fd92c", "message": "NF: CardCache have hash and equals\n\nThe comparison is based only on ids", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "d82e34d70ee545027638be71c1e02471da83d13b", "url": "https://github.com/ankidroid/Anki-Android/commit/d82e34d70ee545027638be71c1e02471da83d13b", "message": "NF: cardCache constructor takes position", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "229067e095d2c43ed9dffecf600903e2bf9f7c89", "url": "https://github.com/ankidroid/Anki-Android/commit/229067e095d2c43ed9dffecf600903e2bf9f7c89", "message": "NF: throw exception before adding to set\n\nSince it's used only in test and raise an exception, it's NF", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "e9b4743011a732dd5e33b6a46e9676f3c2c31aa2", "url": "https://github.com/ankidroid/Anki-Android/commit/e9b4743011a732dd5e33b6a46e9676f3c2c31aa2", "message": "NF: mCheckedCardPositions becomes a list of CardCache", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "b2969df3cd606bb1b48df7ab735b8bf2c0272481", "url": "https://github.com/ankidroid/Anki-Android/commit/b2969df3cd606bb1b48df7ab735b8bf2c0272481", "message": "NF: uses checkedCardCount when possible", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "31519b2a5c5142368cc48e7eccaf396c2fbc49a1", "url": "https://github.com/ankidroid/Anki-Android/commit/31519b2a5c5142368cc48e7eccaf396c2fbc49a1", "message": "NF: remove unused parameter cards", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "19c556b423788b28716cc6cb08c55e63547fe97d", "url": "https://github.com/ankidroid/Anki-Android/commit/19c556b423788b28716cc6cb08c55e63547fe97d", "message": "NF: remove unused variable col", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "784e494d5d55d59821a74c5673809ac56de61ee0", "url": "https://github.com/ankidroid/Anki-Android/commit/784e494d5d55d59821a74c5673809ac56de61ee0", "message": "NF: use empty instead of size", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "312f5d25286cd6a2e374bef8fc873d1045827591", "url": "https://github.com/ankidroid/Anki-Android/commit/312f5d25286cd6a2e374bef8fc873d1045827591", "message": "NF: remove an always false condition", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "5e53977b480f437b664bc41ef56be7cbb4aba431", "url": "https://github.com/ankidroid/Anki-Android/commit/5e53977b480f437b664bc41ef56be7cbb4aba431", "message": "NF: updateCardsInList more clear\n\nAs .get() returns null, no need to check whether the elements belong to the set before accessing it.", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "72d271afa8cbd528a6b705c4032acd2024d986d8", "url": "https://github.com/ankidroid/Anki-Android/commit/72d271afa8cbd528a6b705c4032acd2024d986d8", "message": "NF: indicates that getPositionMap is static\n\nThis way, it's clear that it only consider the list given as input, and not current card list", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "4664884898ea45c879699fd4a2b06e07a2a04ea0", "url": "https://github.com/ankidroid/Anki-Android/commit/4664884898ea45c879699fd4a2b06e07a2a04ea0", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-13T17:44:37Z", "type": "commit"}, {"oid": "4664884898ea45c879699fd4a2b06e07a2a04ea0", "url": "https://github.com/ankidroid/Anki-Android/commit/4664884898ea45c879699fd4a2b06e07a2a04ea0", "message": "NF: ensure updateCardsInList iterate on a single list of card", "committedDate": "2020-08-13T17:44:37Z", "type": "forcePushed"}]}