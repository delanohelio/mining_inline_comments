{"pr_number": 5774, "pr_title": "Feature/reviewer add mic tool bar", "pr_createdAt": "2020-02-25T14:36:11Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5774", "timeline": [{"oid": "ad8aee0f6dee722e514070aec6a80646493ee498", "url": "https://github.com/ankidroid/Anki-Android/commit/ad8aee0f6dee722e514070aec6a80646493ee498", "message": "BUG: Must stop recorder when closing viewer", "committedDate": "2020-03-02T10:38:53Z", "type": "forcePushed"}, {"oid": "89741a6ca261fb37265a7b022b753592e3f38583", "url": "https://github.com/ankidroid/Anki-Android/commit/89741a6ca261fb37265a7b022b753592e3f38583", "message": "BUG: Must stop recorder when closing viewer", "committedDate": "2020-04-06T18:34:40Z", "type": "forcePushed"}, {"oid": "563de4d05a25aa40392efd28fdc700e1f7ae52ce", "url": "https://github.com/ankidroid/Anki-Android/commit/563de4d05a25aa40392efd28fdc700e1f7ae52ce", "message": "Refactor audio temporary file generation for further mutual use.", "committedDate": "2020-06-06T09:04:35Z", "type": "commit"}, {"oid": "52df4127d649bce6858af2db132f74705d9398ab", "url": "https://github.com/ankidroid/Anki-Android/commit/52df4127d649bce6858af2db132f74705d9398ab", "message": "Add mic tool bar into reviewer menu", "committedDate": "2020-06-06T09:11:05Z", "type": "commit"}, {"oid": "2580b6b5a4e47057784a6fcc8dbf2d838372e3f8", "url": "https://github.com/ankidroid/Anki-Android/commit/2580b6b5a4e47057784a6fcc8dbf2d838372e3f8", "message": "Remove unused import", "committedDate": "2020-06-06T09:11:08Z", "type": "commit"}, {"oid": "15c919213fe0b9ae9db2f93f61eba0ca93298295", "url": "https://github.com/ankidroid/Anki-Android/commit/15c919213fe0b9ae9db2f93f61eba0ca93298295", "message": "BUG: Must stop recorder when closing viewer", "committedDate": "2020-06-06T09:14:39Z", "type": "commit"}, {"oid": "d65affda2d59130044bb0bffe23863b6e13b097f", "url": "https://github.com/ankidroid/Anki-Android/commit/d65affda2d59130044bb0bffe23863b6e13b097f", "message": "Unused import correction", "committedDate": "2020-06-06T09:22:52Z", "type": "commit"}, {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "url": "https://github.com/ankidroid/Anki-Android/commit/a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "message": "Correct merge issue", "committedDate": "2020-06-06T10:47:37Z", "type": "commit"}, {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "url": "https://github.com/ankidroid/Anki-Android/commit/a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "message": "Correct merge issue", "committedDate": "2020-06-06T10:47:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjQyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262422", "bodyText": "Could you revert changes to additional files", "author": "david-allison-1", "createdAt": "2020-06-06T11:50:28Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DeckPickerExportCompleteDialog.java", "diffHunk": "@@ -5,10 +5,8 @@\n import android.os.Message;\n \n import com.afollestad.materialdialogs.MaterialDialog;\n-import com.ichi2.anki.CollectionHelper;\n import com.ichi2.anki.DeckPicker;", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDEyOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280129", "bodyText": "Yes, done, merge issue from my side.", "author": "dgeranton", "createdAt": "2020-06-06T16:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjU4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262581", "bodyText": "I understand that this is copy/pasted, but we'll want to confirm that the media directory is better than the cache for these files. I think the cache directory (context.getCacheDir()) would be better", "author": "david-allison-1", "createdAt": "2020-06-06T11:52:30Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/AudioView.java", "diffHunk": "@@ -72,6 +76,19 @@ public static AudioView createRecorderInstance(Context context, int resPlay, int\n         return new AudioView(context, resPlay, resPause, resStop, resRecord, resRecordStop, audioPath);\n     }\n \n+    public static String generateTempAudioFile(Context context) {\n+        String tempAudioPath;\n+        try {\n+            Collection col = CollectionHelper.getInstance().getCol(context);\n+            File storingDirectory = new File(col.getMedia().dir());", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDE5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280198", "bodyText": "Yes, this is to avoid copy/pasted code. You right cache dir is better that media directory. I have changed it.", "author": "dgeranton", "createdAt": "2020-06-06T16:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjY4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262680", "bodyText": "Could you prefix this variable with an m\nCode conventions for ref: https://github.com/ankidroid/Anki-Android/tree/master/docs/code_conventions", "author": "david-allison-1", "createdAt": "2020-06-06T11:53:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -320,6 +321,10 @@\n \n     private long mUseTimerDynamicMS;\n \n+    /** File of the temporary mic record **/\n+    protected AudioView mMicToolBar;\n+    protected String tempAudioPath;", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDIyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280226", "bodyText": "Yes, done, I stupidly used the initial local variable name.", "author": "dgeranton", "createdAt": "2020-06-06T16:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262701", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if( mMicToolBar != null ) {\n          \n          \n            \n                    if (mMicToolBar != null) {", "author": "david-allison-1", "createdAt": "2020-06-06T11:54:12Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDI0Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280242", "bodyText": "Yes, done, catch the pattern.", "author": "dgeranton", "createdAt": "2020-06-06T16:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262722", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if( tempAudioPath != null ) {\n          \n          \n            \n                    if (tempAudioPath != null) {", "author": "david-allison-1", "createdAt": "2020-06-06T11:54:28Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {\n+            mMicToolBar.notifyStopRecord();\n+        }\n+        // Remove the temporary audio file\n+        if( tempAudioPath != null ) {", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDI0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280245", "bodyText": "Yes, done, catch the pattern.", "author": "dgeranton", "createdAt": "2020-06-06T16:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjgwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262807", "bodyText": "nit: could you add braces around the if in One-True Brace style", "author": "david-allison-1", "createdAt": "2020-06-06T11:55:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {\n+            mMicToolBar.notifyStopRecord();\n+        }\n+        // Remove the temporary audio file\n+        if( tempAudioPath != null ) {\n+            File tempAudioPathToDelete = new File(tempAudioPath);\n+            if (tempAudioPathToDelete.exists()) tempAudioPathToDelete.delete();", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDUxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280515", "bodyText": "Yes, done.", "author": "dgeranton", "createdAt": "2020-06-06T16:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjg2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262869", "bodyText": "!Permissions.canRecordAudio(this)", "author": "david-allison-1", "createdAt": "2020-06-06T11:56:09Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -280,6 +286,18 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 playSounds(true);\n                 break;\n \n+            case R.id.action_toggle_mic_tool_bar:\n+                Timber.i(\"Reviewer:: Record mic\");\n+                // Check permission to record and request if not granted\n+                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.RECORD_AUDIO) !=", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDUwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280501", "bodyText": "Yes, done, I did not know that useful function, thx.", "author": "dgeranton", "createdAt": "2020-06-06T16:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjkxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262913", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ( mMicToolBar == null ) {\n          \n          \n            \n                    if (mMicToolBar == null) {", "author": "david-allison-1", "createdAt": "2020-06-06T11:56:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDI1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280251", "bodyText": "Yes, done, catch the pattern.", "author": "dgeranton", "createdAt": "2020-06-06T16:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262953", "bodyText": "Could you wrap this in a try..catch and display a toast and send an exception report on failure, we don't want to crash the app if the toolbar fails to init.", "author": "david-allison-1", "createdAt": "2020-06-06T11:57:40Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDQ2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280463", "bodyText": "I have put a try ... catch into the AudioView.createRecorderInstance tool that is used some where else to mutualize the error management.", "author": "dgeranton", "createdAt": "2020-06-06T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262978", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if( mMicToolBar.getVisibility() != View.VISIBLE) {\n          \n          \n            \n                        if (mMicToolBar.getVisibility() != View.VISIBLE) {", "author": "david-allison-1", "createdAt": "2020-06-06T11:57:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {\n+            // Record mic tool bar does not exist yet\n+            tempAudioPath = AudioView.generateTempAudioFile(this);\n+            mMicToolBar = AudioView.createRecorderInstance(this, R.drawable.av_play, R.drawable.av_pause,\n+                    R.drawable.av_stop, R.drawable.av_rec, R.drawable.av_rec_stop, tempAudioPath);\n+            FrameLayout.LayoutParams lp2 = new FrameLayout.LayoutParams(\n+                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);\n+            mMicToolBar.setLayoutParams(lp2);\n+            LinearLayout micToolBarLayer = findViewById(R.id.mic_tool_bar_layer);\n+            micToolBarLayer.addView(mMicToolBar);\n+        } else {\n+            // It exists swap visibility status\n+            if( mMicToolBar.getVisibility() != View.VISIBLE) {", "originalCommit": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDI2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436280260", "bodyText": "Yes, done, catch the pattern.", "author": "dgeranton", "createdAt": "2020-06-06T16:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk3OA=="}], "type": "inlineReview"}, {"oid": "c22edb3c33cbb33b47687541d04425940a319c55", "url": "https://github.com/ankidroid/Anki-Android/commit/c22edb3c33cbb33b47687541d04425940a319c55", "message": "Add new strings ressources in all language", "committedDate": "2020-06-06T15:56:27Z", "type": "commit"}, {"oid": "d73e9262ce285dae1f514e1dd2f55e26b8197929", "url": "https://github.com/ankidroid/Anki-Android/commit/d73e9262ce285dae1f514e1dd2f55e26b8197929", "message": "Revert Project.xml to original", "committedDate": "2020-06-06T15:59:10Z", "type": "commit"}, {"oid": "8b9a9598553232398e3b42817c83c5072e94b377", "url": "https://github.com/ankidroid/Anki-Android/commit/8b9a9598553232398e3b42817c83c5072e94b377", "message": "Apply correction according to code review", "committedDate": "2020-06-06T16:05:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDYwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340605", "bodyText": "Could you mark this with\n\n@Nullable (place the string above public),\nMark context as @NonNull - place before the word Context", "author": "david-allison-1", "createdAt": "2020-06-07T08:51:31Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/AudioView.java", "diffHunk": "@@ -69,7 +75,27 @@\n \n     public static AudioView createRecorderInstance(Context context, int resPlay, int resPause, int resStop,\n             int resRecord, int resRecordStop, String audioPath) {\n+        try {\n         return new AudioView(context, resPlay, resPause, resStop, resRecord, resRecordStop, audioPath);\n+        } catch(Exception e) {\n+            Timber.e(e);\n+            AnkiDroidApp.sendExceptionReport(e, \"Unable to create recorder tool bar\");\n+            UIUtils.showThemedToast(context,\n+                    context.getText(R.string.multimedia_editor_audio_view_create_failed).toString(), true);\n+            return null;\n+        }\n+    }\n+\n+    public static String generateTempAudioFile(Context context) {", "originalCommit": "8b9a9598553232398e3b42817c83c5072e94b377", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDY5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340699", "bodyText": "Consider inverting this if (this can be done by placing your cursor over the if and pressing Alt+Enter", "author": "david-allison-1", "createdAt": "2020-06-07T08:52:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,43 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if (mMicToolBar == null) {", "originalCommit": "8b9a9598553232398e3b42817c83c5072e94b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM1OTgwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436359806", "bodyText": "Ok, done. But why ? Is it not allowed to have a == null statement ?", "author": "dgeranton", "createdAt": "2020-06-07T12:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM2MTk2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436361961", "bodyText": "It's a minor case of the Pyramid of Doom: https://en.wikipedia.org/wiki/Pyramid_of_doom_(programming). Having an early return should increase readability for the main operation of the function.", "author": "david-allison-1", "createdAt": "2020-06-07T13:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDc0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340748", "bodyText": "I believe this can fail if the activity is in the process of being destroyed.", "author": "david-allison-1", "createdAt": "2020-06-07T08:53:39Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,43 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if (mMicToolBar == null) {\n+            // Record mic tool bar does not exist yet\n+            mTempAudioPath = AudioView.generateTempAudioFile(this);\n+            if (mTempAudioPath == null) {\n+                return;\n+            }\n+            mMicToolBar = AudioView.createRecorderInstance(this, R.drawable.av_play, R.drawable.av_pause,\n+                        R.drawable.av_stop, R.drawable.av_rec, R.drawable.av_rec_stop, mTempAudioPath);\n+            if (mMicToolBar == null) {\n+                mTempAudioPath = null;\n+                return;\n+            }\n+            FrameLayout.LayoutParams lp2 = new FrameLayout.LayoutParams(\n+                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);\n+            mMicToolBar.setLayoutParams(lp2);\n+            LinearLayout micToolBarLayer = findViewById(R.id.mic_tool_bar_layer);\n+            micToolBarLayer.addView(mMicToolBar);\n+        } else {\n+            // It exists swap visibility status\n+            if (mMicToolBar.getVisibility() != View.VISIBLE) {\n+                mMicToolBar.setVisibility(View.VISIBLE);\n+            } else {\n+                mMicToolBar.setVisibility(View.GONE);\n+            }\n+        }\n+    }\n+\n+    public void onRequestPermissionsResult (int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {\n+        if ( (requestCode == REQUEST_AUDIO_PERMISSION) &&\n+                (permissions.length >= 1) && (grantResults[0] == PackageManager.PERMISSION_GRANTED)) {\n+            // Get get audio record permission, so we can create the record tool bar\n+            toggleMicToolBar();", "originalCommit": "8b9a9598553232398e3b42817c83c5072e94b377", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM2MDExMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436360111", "bodyText": "Hum, I am not sure to understand.\nDo you mean that some condition must be added ?\nIf the process us being destroyed, it is not an issue if the permission is not granted, no ?", "author": "dgeranton", "createdAt": "2020-06-07T12:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM2MzU2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436363560", "bodyText": "I believe I'm mistaken. I've had a look through the docs, and it seems that View.addView won't throw under these circumstances.\nAndroid has the concept of Activities. In AnkiDroid, each activity represents a screen. and an activity has a lifecycle outside of the process.\nhttps://developer.android.com/reference/android/app/Activity\nIn some cases (mostly fragments), performing UI-based actions after Activity.onDestroy() will throw an exception. Our default exception handler is set to log and kill the process, so we want to avoid and recover from exceptions whenever possible.", "author": "david-allison-1", "createdAt": "2020-06-07T13:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDc0OA=="}], "type": "inlineReview"}, {"oid": "962b3ba51e0e45ffe2dbab372a2d0bbe114e420b", "url": "https://github.com/ankidroid/Anki-Android/commit/962b3ba51e0e45ffe2dbab372a2d0bbe114e420b", "message": "Revert \"Add new strings ressources in all language\"\n\nThis reverts commit c22edb3c33cbb33b47687541d04425940a319c55.", "committedDate": "2020-06-07T12:27:05Z", "type": "commit"}, {"oid": "e6f2ecb47bf25567d8566c2162fcee2460837eb9", "url": "https://github.com/ankidroid/Anki-Android/commit/e6f2ecb47bf25567d8566c2162fcee2460837eb9", "message": "CodeReview: Add annotation around generateTempAudioFile", "committedDate": "2020-06-07T12:42:22Z", "type": "commit"}, {"oid": "6ad5283ea6d1bf0bf8b4f1b1c33647a35f6c0044", "url": "https://github.com/ankidroid/Anki-Android/commit/6ad5283ea6d1bf0bf8b4f1b1c33647a35f6c0044", "message": "CodeReview: Invert if statement in toggleMicToolBar", "committedDate": "2020-06-07T12:46:15Z", "type": "commit"}, {"oid": "ebe17f20397a5bfeb0097ab571fde06a97fe3ca5", "url": "https://github.com/ankidroid/Anki-Android/commit/ebe17f20397a5bfeb0097ab571fde06a97fe3ca5", "message": "CodeReview: Add toggle mic tool bar button into to custom button menu.", "committedDate": "2020-06-07T13:17:39Z", "type": "commit"}, {"oid": "f72a748963f1386f36f252f07a9b61ae86d029fe", "url": "https://github.com/ankidroid/Anki-Android/commit/f72a748963f1386f36f252f07a9b61ae86d029fe", "message": "CodeReview: Change menu text to \"Check Pronunciation\"", "committedDate": "2020-06-07T13:21:28Z", "type": "commit"}, {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "url": "https://github.com/ankidroid/Anki-Android/commit/99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "message": "CodeReview: Center the mic tool bar", "committedDate": "2020-06-07T13:50:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3Mjk1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436372957", "bodyText": "I think once these additional files are removed from the commit, we're good to go. This looks awesome!!", "author": "david-allison-1", "createdAt": "2020-06-07T15:09:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/ImportDialog.java", "diffHunk": "@@ -8,7 +8,6 @@\n import com.ichi2.anki.CollectionHelper;\n import com.ichi2.anki.R;\n import com.ichi2.anki.UIUtils;\n-import com.ichi2.anki.analytics.AnalyticsDialogFragment;", "originalCommit": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM4NjMwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436386305", "bodyText": "I am not sure, but do you mean that I must revert the remove of that unused import ?", "author": "dgeranton", "createdAt": "2020-06-07T17:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3Mjk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3MzE5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436373197", "bodyText": "Nitpick - Same", "author": "david-allison-1", "createdAt": "2020-06-07T15:11:47Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/ClozeTest.java", "diffHunk": "@@ -3,19 +3,15 @@\n import android.content.Context;\n \n import com.ichi2.anki.RobolectricTest;\n-import com.ichi2.libanki.template.Template;\n ", "originalCommit": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3MzIxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436373217", "bodyText": "Nitpick - same", "author": "david-allison-1", "createdAt": "2020-06-07T15:11:59Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/MathJaxClozeTest.java", "diffHunk": "@@ -5,18 +5,14 @@\n import com.ichi2.anki.RobolectricTest;\n import com.ichi2.libanki.Card;\n import com.ichi2.libanki.Collection;\n-import com.ichi2.libanki.Models;\n import com.ichi2.libanki.Note;", "originalCommit": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDA2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436374066", "bodyText": "nit - same", "author": "david-allison-1", "createdAt": "2020-06-07T15:21:26Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/MathJaxClozeTest.java", "diffHunk": "@@ -5,18 +5,14 @@\n import com.ichi2.anki.RobolectricTest;\n import com.ichi2.libanki.Card;\n import com.ichi2.libanki.Collection;\n-import com.ichi2.libanki.Models;\n import com.ichi2.libanki.Note;\n import com.ichi2.libanki.template.Template;\n \n import org.junit.Test;\n import org.junit.runner.RunWith;\n \n import java.util.ArrayList;", "originalCommit": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDUyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436374528", "bodyText": "We need to be consistent with this.\n\nPreferences show \"ifRoom\", here shows \"never\".\n\nI'd be tempted to use \"never\" and change the preferences/layout.xml. Users can increase the priority if they desire.\n@mikehardy - does this seem sensible?", "author": "david-allison-1", "createdAt": "2020-06-07T15:26:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/reviewer/ActionButtonStatus.java", "diffHunk": "@@ -59,6 +59,7 @@ public void setup(SharedPreferences preferences) {\n         setupButton(preferences, R.id.action_suspend, \"customButtonSuspend\", SHOW_AS_ACTION_NEVER);\n         setupButton(preferences, R.id.action_mark_card, \"customButtonMarkCard\", SHOW_AS_ACTION_IF_ROOM);\n         setupButton(preferences, R.id.action_delete, \"customButtonDelete\", SHOW_AS_ACTION_NEVER);\n+        setupButton(preferences, R.id.action_toggle_mic_tool_bar, \"customButtonToggleMicToolBar\", SHOW_AS_ACTION_NEVER);", "originalCommit": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3Njg1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436376853", "bodyText": "Good catch - they definitely need to match, 'never' for new features is the correct default on the app bar buttons - it makes the new feature opt-in. That reminds me - can you propose an edit here https://github.com/ankidroid/ankidroiddocs/blob/master/manual.asc#action-bar-2 to match? We don't do a great job of keeping the manual up to date because we forget mostly \ud83d\ude05  - this is a cool feature though and this might be the only way people find out about it", "author": "mikehardy", "createdAt": "2020-06-07T15:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM4NjI1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436386257", "bodyText": "Ok, so if I understand well, I keep SHOW_AS_ACTION_NEVER.\nHere is a text proposition for the manual:\nCheck Pronunciation\nThis action enables or disables the temporary audio recorder tool bar at the top of the card. This feature allows you to record your voice and replay it. It is useful to self checks your own pronunciation. This tool bar is composed of three buttons to : play, stop playing and record audio from microphone. This tool can be used at any time either during question side or than answer side.", "author": "dgeranton", "createdAt": "2020-06-07T17:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDUyOA=="}], "type": "inlineReview"}, {"oid": "dfb7b8e4436af3f84f7d5bda807a7aaa18936143", "url": "https://github.com/ankidroid/Anki-Android/commit/dfb7b8e4436af3f84f7d5bda807a7aaa18936143", "message": "CodeReview: Revert remove unused import", "committedDate": "2020-06-07T17:36:45Z", "type": "commit"}, {"oid": "d492cb5bfe99ec4e58f8dcfbb6696e14311cce86", "url": "https://github.com/ankidroid/Anki-Android/commit/d492cb5bfe99ec4e58f8dcfbb6696e14311cce86", "message": "Update AnkiDroid/src/main/res/xml/preferences_custom_buttons.xml\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>", "committedDate": "2020-06-09T12:19:57Z", "type": "commit"}, {"oid": "3d59523437be0c711bc01ad8dc2f203afd0767fa", "url": "https://github.com/ankidroid/Anki-Android/commit/3d59523437be0c711bc01ad8dc2f203afd0767fa", "message": "Update AnkiDroid/src/main/res/menu/reviewer.xml\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>", "committedDate": "2020-06-09T12:20:17Z", "type": "commit"}]}