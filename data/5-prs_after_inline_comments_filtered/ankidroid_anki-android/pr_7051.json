{"pr_number": 7051, "pr_title": "Improve File Import: Error Handling for Zip Validation ", "pr_createdAt": "2020-09-10T00:41:27Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7051", "timeline": [{"oid": "ddc4cc0535aa347ddb9a5757965ed3a852db727c", "url": "https://github.com/ankidroid/Anki-Android/commit/ddc4cc0535aa347ddb9a5757965ed3a852db727c", "message": "NF: Encapsulate ImportUtils return value\n\nThis will let us handle the exception data and values to provide\nbetter exception messages to the user.", "committedDate": "2020-09-10T00:35:13Z", "type": "commit"}, {"oid": "42cba02be2e51f7036e7dc6e59e4d679e6b99765", "url": "https://github.com/ankidroid/Anki-Android/commit/42cba02be2e51f7036e7dc6e59e4d679e6b99765", "message": "Import: Fail on invalid schema", "committedDate": "2020-09-10T00:35:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5NzEyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7051#discussion_r485997124", "bodyText": "I was ambivalent on this - but it's better as an Optional, I'll fix", "author": "david-allison-1", "createdAt": "2020-09-10T00:42:47Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -151,51 +155,51 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n                 } else {\n                     Timber.e(\"Could not retrieve filename from ContentProvider or read content as ZipFile\");\n                     AnkiDroidApp.sendExceptionReport(new RuntimeException(\"Could not import apkg from ContentProvider\"), \"IntentHandler.java\", \"apkg import failed\");\n-                    return AnkiDroidApp.getAppResources().getString(R.string.import_error_content_provider, AnkiDroidApp.getManualUrl() + \"#importing\");\n+                    return ImportResult.fromErrorString(AnkiDroidApp.getAppResources().getString(R.string.import_error_content_provider, AnkiDroidApp.getManualUrl() + \"#importing\"));\n                 }\n             }\n \n             if (!isValidPackageName(filename)) {\n                 if (isAnkiDatabase(filename)) {\n                     //.anki2 files aren't supported by Anki Desktop, we should eventually support them, because we can\n                     //but for now, show a \"nice\" error.\n-                    return context.getResources().getString(R.string.import_error_load_imported_database);\n+                    return ImportResult.fromErrorString(context.getResources().getString(R.string.import_error_load_imported_database));\n                 } else {\n                     // Don't import if file doesn't have an Anki package extension\n-                    return context.getResources().getString(R.string.import_error_not_apkg_extension, filename);\n+                    return ImportResult.fromErrorString(context.getResources().getString(R.string.import_error_not_apkg_extension, filename));\n                 }\n             } else {\n                 // Copy to temporary file\n                 filename = ensureValidLength(filename);\n                 String tempOutDir = Uri.fromFile(new File(context.getCacheDir(), filename)).getEncodedPath();\n-                errorMessage = copyFileToCache(context, data, tempOutDir) ? null : context.getString(R.string.import_error_copy_file_to_cache);\n+                String errorMessage = copyFileToCache(context, data, tempOutDir) ? null : context.getString(R.string.import_error_copy_file_to_cache);\n                 // Show import dialog\n                 if (errorMessage != null) {\n                     AnkiDroidApp.sendExceptionReport(new RuntimeException(\"Error importing apkg file\"), \"IntentHandler.java\", \"apkg import failed\");\n-                    return errorMessage;\n+                    return ImportResult.fromErrorString(errorMessage);\n                 }\n \n-                errorMessage = validateZipFile(context, tempOutDir);\n-                if (errorMessage != null) {\n+                ImportResult validateZipResult = validateZipFile(context, tempOutDir);\n+                if (!validateZipResult.isSuccess()) {\n                     //noinspection ResultOfMethodCallIgnored\n                     new File(tempOutDir).delete();\n-                    return errorMessage;\n+                    return validateZipResult;\n                 }\n \n                 sendShowImportFileDialogMsg(tempOutDir);\n-                return null;\n+                return ImportResult.fromSuccess();\n             }\n         }\n \n-\n-        protected String validateZipFile(Context context, String filePath) {\n+        @NonNull\n+        protected ImportResult validateZipFile(Context ctx, String filePath) {", "originalCommit": "33b3de8787138e8524b046c2e2456d0dc2b653f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25fe93df243ded027aa4e0d05d2c47e238abb7df", "url": "https://github.com/ankidroid/Anki-Android/commit/25fe93df243ded027aa4e0d05d2c47e238abb7df", "message": "Import: send silent exception if validation fails\n\nWe want to improve this error UX, to do this we need exception reports.", "committedDate": "2020-09-10T00:47:27Z", "type": "commit"}, {"oid": "09486a2aa8170b70e44c21d8874d12649064b8bb", "url": "https://github.com/ankidroid/Anki-Android/commit/09486a2aa8170b70e44c21d8874d12649064b8bb", "message": "Import: Improve error on corrupt files\n\nFixes 7050: User requested support so we make the exception more explicit", "committedDate": "2020-09-10T00:47:29Z", "type": "commit"}, {"oid": "09486a2aa8170b70e44c21d8874d12649064b8bb", "url": "https://github.com/ankidroid/Anki-Android/commit/09486a2aa8170b70e44c21d8874d12649064b8bb", "message": "Import: Improve error on corrupt files\n\nFixes 7050: User requested support so we make the exception more explicit", "committedDate": "2020-09-10T00:47:29Z", "type": "forcePushed"}]}