{"pr_number": 5841, "pr_title": "Fix permission handling in Multimedia editor", "pr_createdAt": "2020-03-20T19:47:41Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5841", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzM0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396043341", "bodyText": "Not strictly necessary, but I suppose you could refactor the storage permission check to this style?", "author": "mikehardy", "createdAt": "2020-03-22T00:58:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/utils/Permissions.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.ichi2.anki.multimediacard.utils;\n+\n+import android.Manifest;\n+import android.content.Context;\n+import android.content.pm.PackageManager;\n+\n+import androidx.annotation.NonNull;\n+import androidx.core.content.ContextCompat;\n+\n+public class Permissions {\n+    private Permissions() { }\n+\n+    public static boolean canUseCamera(@NonNull Context context) {\n+        return hasPermission(context, Manifest.permission.CAMERA);\n+    }\n+\n+    public static boolean canRecordAudio(@NonNull Context context) {\n+        return hasPermission(context, Manifest.permission.RECORD_AUDIO);\n+    }\n+", "originalCommit": "3f0b7a54d28c1c8b11b0ea79431dc15a2435c9dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjAyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396052027", "bodyText": "Can do, but will also want to move to a more general package rather than one under the multimedia editor.\nI've been burned before by tacking mostly unrelated refactorings into a change as they get much less (if any) testing effort. Breaking storage permissioning would be fatal.\nWill get this one done though. Extract method barely breaks.", "author": "david-allison-1", "createdAt": "2020-03-22T04:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzQ3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396043476", "bodyText": "If we're going to have a Permissions object, could we encapsulate the requests in there too?", "author": "mikehardy", "createdAt": "2020-03-22T01:00:39Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -96,55 +101,80 @@ protected void onCreate(Bundle savedInstanceState) {\n \n         mFieldIndex = this.getIntent().getIntExtra(EXTRA_FIELD_INDEX, 0);\n \n-        recreateEditingUi();\n+        recreateEditingUi(ChangeUIRequest.init(mField));\n     }\n \n \n     private void finishCancel() {\n+        Timber.d(\"Completing activity via finishCancel()\");\n         Intent resultData = new Intent();\n         setResult(RESULT_CANCELED, resultData);\n         finishWithoutAnimation();\n     }\n \n+    private boolean performPermissionRequest(IField field) {\n+        // Request permission to record if audio field\n+        if (field instanceof AudioRecordingField && !Permissions.canRecordAudio(this)) {\n+            ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.RECORD_AUDIO},\n+                    REQUEST_AUDIO_PERMISSION);\n+            return true;\n+        }\n+\n+        // Request permission to use the camera if image field\n+        if (field instanceof ImageField && !Permissions.canUseCamera(this)) {\n+            ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.CAMERA},\n+                    REQUEST_CAMERA_PERMISSION);", "originalCommit": "3f0b7a54d28c1c8b11b0ea79431dc15a2435c9dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MTAwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396051002", "bodyText": "I thought about it, but each screen has an associated tag with permission, and it felt like we shouldn't mix local and global data.\nIit makes it much harder if for instance we want to request microphone and audio at once later on for a more advanced editor", "author": "david-allison-1", "createdAt": "2020-03-22T03:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MzI5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396053296", "bodyText": "that one in particular is the first that will show up with ./gradlew clean uninstallDebug installDebug and a test click-around, which is the first thing I do for stable releases, so no worries", "author": "mikehardy", "createdAt": "2020-03-22T04:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NTY4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396075683", "bodyText": "I assume the above was desired for the above comment. I'll do that, but will leave this unresolved, will get it done if you still feel it's an issue on review 2", "author": "david-allison-1", "createdAt": "2020-03-22T10:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5MjQ1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396092453", "bodyText": "I assume the above was desired for the above comment. I'll do that, but will leave this unresolved, will get it done if you still feel it's an issue on review 2\n\nYes that was intended for the storage permission refactor - not sure how github flubbed the comment attribution but you got it", "author": "mikehardy", "createdAt": "2020-03-22T13:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0MzQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NDYwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396044608", "bodyText": "This is basically a guaranteed crash right? To be avoided at all costs, it's just making future work. A toast and a fall back to the note editor or anything is better than throwing a RuntimeException if we can avoid it", "author": "mikehardy", "createdAt": "2020-03-22T01:23:30Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -305,19 +318,21 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n \n \n     public void onRequestPermissionsResult (int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {\n+        if (mCurrentChangeRequest == null) {\n+            throw new IllegalStateException(\"mCurrentChangeRequest should be set before using cached request\");", "originalCommit": "b885022d2b3d5baec090872d93ea0ec322aaca32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NTAyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396045025", "bodyText": "I have to admit I'm a fan of Timber.d's for things like this, dumping all pertinent internal state to the logs if it's possible", "author": "mikehardy", "createdAt": "2020-03-22T01:31:36Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -390,4 +414,29 @@ int getState() {\n             return state;\n         }\n     }\n-}\n+\n+    /**\n+     * Class to contain logic relating to decisions made when recreating a UI.\n+     * Can later be converted to a non-static class to allow testing of the logic.\n+     * */\n+    private static final class UIRecreationLogic {\n+\n+        static void onRequiredPermissionDenied(ChangeUIRequest request, MultimediaEditFieldActivity activity) {\n+            switch (request.state)", "originalCommit": "057488d2583d29d924a6fa7822a8243145651032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NTE2Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396045162", "bodyText": "The property accessors are non-standard, can we just do get/set?", "author": "mikehardy", "createdAt": "2020-03-22T01:34:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -410,6 +414,14 @@ static ChangeUIRequest fieldChange(IField field) {\n             return new ChangeUIRequest(field, EXTERNAL_FIELD_CHANGE);\n         }\n \n+        boolean doesRequirePermissionCheck() {", "originalCommit": "e591dd5340d54c4345b194fec6ff708c77d7d2be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3MzU1OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396073559", "bodyText": "I'm not familiar with Java naming conventions. Is it \"always use get\", or are \"is/has/does\" ever acceptable for booleans?\nWill fix", "author": "david-allison-1", "createdAt": "2020-03-22T09:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NTE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5MjI5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396092292", "bodyText": "get/set is the gold standard, for booleans you may alter to isXXX but get/set is easiest. Lots of Java things use inspection and the JavaBeans spec specified this so that you easily take an unknown object and inspect it and (likely) know how to operate it", "author": "mikehardy", "createdAt": "2020-03-22T13:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NTE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA0NTM4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396045381", "bodyText": "similarly Timber.d's here and in the other onXXXFailed methods would be nice", "author": "mikehardy", "createdAt": "2020-03-22T01:38:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/activity/MultimediaEditFieldActivity.java", "diffHunk": "@@ -433,6 +427,50 @@ int getState() {\n      * */\n     private static final class UIRecreationLogic {\n \n+        /** Raised just before the field controller is replaced */\n+        static void onPreFieldControllerReplacement(IFieldController previousFieldController) {\n+            //on init, we don't need to do anything", "originalCommit": "47bf7fe4d83f78a7ee36ca4cb49370c0b17aab46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "614eff0f64daacdd097e4b1740777ccb059246cc", "url": "https://github.com/ankidroid/Anki-Android/commit/614eff0f64daacdd097e4b1740777ccb059246cc", "message": "NF: Extract Permissions to Class", "committedDate": "2020-03-22T10:32:59Z", "type": "commit"}, {"oid": "f0682a4b3466fe956107b8ffc3dd7ef7c8c7b578", "url": "https://github.com/ankidroid/Anki-Android/commit/f0682a4b3466fe956107b8ffc3dd7ef7c8c7b578", "message": "Ensure we have permissions before audio recording\n\nWe can get to the AudioView screen from the pronunciation screen,\nthis is a one-way transition, and should succeed, even if we can't\nuse the screen to record audio.", "committedDate": "2020-03-22T10:33:19Z", "type": "commit"}, {"oid": "7860f4ff824ad2ff10f781f09fd76700c7e4bad5", "url": "https://github.com/ankidroid/Anki-Android/commit/7860f4ff824ad2ff10f781f09fd76700c7e4bad5", "message": "NF: Extract method: performPermissionRequest", "committedDate": "2020-03-22T10:33:26Z", "type": "commit"}, {"oid": "f35b3d1cd0dfe49568f78e659453ee397b02af4a", "url": "https://github.com/ankidroid/Anki-Android/commit/f35b3d1cd0dfe49568f78e659453ee397b02af4a", "message": "NF: Extract method: setupUIController", "committedDate": "2020-03-22T10:33:26Z", "type": "commit"}, {"oid": "28b1dd0a832416e07a101a989629be9f950ab15c", "url": "https://github.com/ankidroid/Anki-Android/commit/28b1dd0a832416e07a101a989629be9f950ab15c", "message": "MultimediaEditor: Delay changing field", "committedDate": "2020-03-22T10:33:26Z", "type": "commit"}, {"oid": "de4ec31a873ff15ebcebf119dfda29d5034b13d2", "url": "https://github.com/ankidroid/Anki-Android/commit/de4ec31a873ff15ebcebf119dfda29d5034b13d2", "message": "Multimedia: Only rerender on permission success\n\nPreviously, we would get into a loop of asking for permissions if\nthe user ticked \"deny & remember\".\n\nNow we close the dialog and cancel the activity.\n\nWe now only try and redraw if we were successful.\n\nFixes #5407", "committedDate": "2020-03-22T10:33:27Z", "type": "commit"}, {"oid": "a49bfab0cdc2d3a7e6a27cf7a62d7a9c6bb3ddff", "url": "https://github.com/ankidroid/Anki-Android/commit/a49bfab0cdc2d3a7e6a27cf7a62d7a9c6bb3ddff", "message": "Multimedia: Stop second permission check\n\nIf we went through the permission check once, we don't need to go\nthrough it again", "committedDate": "2020-03-22T10:33:28Z", "type": "commit"}, {"oid": "e1b604dd07fbe1142b740b6e619d700d6f84a85c", "url": "https://github.com/ankidroid/Anki-Android/commit/e1b604dd07fbe1142b740b6e619d700d6f84a85c", "message": "Multimedia: Only kill previous UI if successful\n\nPreviously, onLostFocus would kill the previous activity. If we fail\nnavigation due to permissions, then we had nowhere to go\n\nNow, we only perform this if we have permission and can create a\nfield controller", "committedDate": "2020-03-22T10:33:28Z", "type": "commit"}, {"oid": "dacbc44290808023ac298898a15155b32537c58e", "url": "https://github.com/ankidroid/Anki-Android/commit/dacbc44290808023ac298898a15155b32537c58e", "message": "Review: Made access modifiers explicit", "committedDate": "2020-03-22T10:33:29Z", "type": "commit"}, {"oid": "00f08007e0efd1a65c4774bf4bc22257cb9c1755", "url": "https://github.com/ankidroid/Anki-Android/commit/00f08007e0efd1a65c4774bf4bc22257cb9c1755", "message": "Review: Rename Class", "committedDate": "2020-03-22T10:33:29Z", "type": "commit"}, {"oid": "4c675c3df2b5bd28b99510921672abce2f877a19", "url": "https://github.com/ankidroid/Anki-Android/commit/4c675c3df2b5bd28b99510921672abce2f877a19", "message": "NF: Fix spacing", "committedDate": "2020-03-22T10:33:30Z", "type": "commit"}, {"oid": "42f042de3bb72ab405578c698431dd15cd343067", "url": "https://github.com/ankidroid/Anki-Android/commit/42f042de3bb72ab405578c698431dd15cd343067", "message": "Review: Fix Advanced Editor Strings\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-03-22T10:33:30Z", "type": "commit"}, {"oid": "fbdd22fbf6d262758a1d6fc2a8a1dce39e7ba0b1", "url": "https://github.com/ankidroid/Anki-Android/commit/fbdd22fbf6d262758a1d6fc2a8a1dce39e7ba0b1", "message": "Review: Improve Advanced Editor strings\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-03-22T10:33:31Z", "type": "commit"}, {"oid": "c3357de5b464e57f843fa213ccf42499b5fb102c", "url": "https://github.com/ankidroid/Anki-Android/commit/c3357de5b464e57f843fa213ccf42499b5fb102c", "message": "Review change: Rename method", "committedDate": "2020-03-22T10:46:18Z", "type": "commit"}, {"oid": "484bda71ecddd84c900d534086be96a58ee95dcd", "url": "https://github.com/ankidroid/Anki-Android/commit/484bda71ecddd84c900d534086be96a58ee95dcd", "message": "Review change: Added Logging", "committedDate": "2020-03-22T10:52:31Z", "type": "commit"}, {"oid": "670107ff7c2a1636d6822c2d846523f9876f9fd0", "url": "https://github.com/ankidroid/Anki-Android/commit/670107ff7c2a1636d6822c2d846523f9876f9fd0", "message": "Review change: Assertion Failure", "committedDate": "2020-03-22T11:05:55Z", "type": "commit"}, {"oid": "d089cd285a9fb26e186751a91a2dbe4f23f4e927", "url": "https://github.com/ankidroid/Anki-Android/commit/d089cd285a9fb26e186751a91a2dbe4f23f4e927", "message": "Review change: Moved Permissions file", "committedDate": "2020-03-22T11:13:02Z", "type": "commit"}, {"oid": "c22db4f6b55c17c01f22b3ee06e6b12b1504b7ac", "url": "https://github.com/ankidroid/Anki-Android/commit/c22db4f6b55c17c01f22b3ee06e6b12b1504b7ac", "message": "Review change: Extract hasStorageAccessPermission", "committedDate": "2020-03-22T11:14:51Z", "type": "commit"}, {"oid": "93da7f53c3c4246b88871d793cc1affdc4dcaaca", "url": "https://github.com/ankidroid/Anki-Android/commit/93da7f53c3c4246b88871d793cc1affdc4dcaaca", "message": "Refactor: use canUseCamera", "committedDate": "2020-03-22T11:16:28Z", "type": "commit"}, {"oid": "d3315addc51b594ed59f55859a3d48f1c355a06e", "url": "https://github.com/ankidroid/Anki-Android/commit/d3315addc51b594ed59f55859a3d48f1c355a06e", "message": "Refactor: extract canUseWakeLock", "committedDate": "2020-03-22T11:18:41Z", "type": "commit"}, {"oid": "dc6615bf01479b65f2b96967c192e0d08844c442", "url": "https://github.com/ankidroid/Anki-Android/commit/dc6615bf01479b65f2b96967c192e0d08844c442", "message": "Refactor: Improve permissions check", "committedDate": "2020-03-22T11:19:37Z", "type": "commit"}, {"oid": "dc6615bf01479b65f2b96967c192e0d08844c442", "url": "https://github.com/ankidroid/Anki-Android/commit/dc6615bf01479b65f2b96967c192e0d08844c442", "message": "Refactor: Improve permissions check", "committedDate": "2020-03-22T11:19:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4MjI0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5841#discussion_r396082247", "bodyText": "Issue found: The utility class name 'Permissions' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper)'", "author": "timrae", "createdAt": "2020-03-22T11:24:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/Permissions.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.ichi2.utils;\n+\n+import android.Manifest;\n+import android.content.Context;\n+import android.content.pm.PackageManager;\n+\n+import androidx.annotation.NonNull;\n+import androidx.core.content.ContextCompat;\n+\n+public class Permissions {", "originalCommit": "dc6615bf01479b65f2b96967c192e0d08844c442", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}