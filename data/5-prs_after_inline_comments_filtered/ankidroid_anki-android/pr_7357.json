{"pr_number": 7357, "pr_title": "Iterate json", "pr_createdAt": "2020-10-06T11:15:00Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7357", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIyODIwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7357#discussion_r500228204", "bodyText": "This is causing a lot of test failures", "author": "david-allison-1", "createdAt": "2020-10-06T12:18:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -951,8 +950,8 @@ public void checkIntegrity() {\n     public LinkedList<Long> active() {\n         JSONArray activeDecks = mCol.getConf().getJSONArray(\"activeDecks\");\n         LinkedList<Long> result = new LinkedList<>();\n-        for (int i = 0; i < activeDecks.length(); i++) {\n-            result.add(activeDecks.getLong(i));\n+        for (Long l: activeDecks.<Long>iterable()) {", "originalCommit": "94e0f8579ea4bfa788b92741523f786e94f1debb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bfcde149bb63d1310f92d6de2f6a117575904780", "url": "https://github.com/ankidroid/Anki-Android/commit/bfcde149bb63d1310f92d6de2f6a117575904780", "message": "NF: iterate on JSONArray\n\nThis is not trivial since it can contains different kind of value in a single array. In practice, it contains a single\ntype, so most iteration can be simplified", "committedDate": "2020-10-06T09:41:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3NzYwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7357#discussion_r500677606", "bodyText": "This moves from i = 1 to i = 0.", "author": "david-allison-1", "createdAt": "2020-10-07T00:59:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java", "diffHunk": "@@ -257,8 +255,7 @@ private static void _upgradeClozeModel(Collection col, Model m) throws ConfirmMo\n         // delete non-cloze cards for the model\n         JSONArray tmpls = m.getJSONArray(\"tmpls\");\n         ArrayList<JSONObject> rem = new ArrayList<>();\n-        for (int i = 1; i < tmpls.length(); i++) {\n-            JSONObject ta = tmpls.getJSONObject(i);\n+        for (JSONObject ta: tmpls.jsonObjectIterable()) {", "originalCommit": "bfcde149bb63d1310f92d6de2f6a117575904780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkxMTUzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7357#discussion_r500911532", "bodyText": "This seems to be multiple issues together.\nI had to go back look at older code to see what is done upstream, and there is a mistake in the first place. Upstream uses \"qfmt\" while we use \"afmt\". This means that this whole method has been broken since 2012. 0326c38\nSince this method update the collection from version 3 to 4, I suspect it rarely runs anymore. I'd be okay with writting regression test, but I honestly don't know what is the expected outcome, because it seems that the outcome produced by this method is not even valid anymore according to today's data structure", "author": "Arthur-Milchior", "createdAt": "2020-10-07T10:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3NzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1NTg2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7357#discussion_r500955860", "bodyText": "No point in testing - let's fix it/flag it and move on", "author": "david-allison-1", "createdAt": "2020-10-07T12:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3NzYwNg=="}], "type": "inlineReview"}, {"oid": "1977bc5582fda7240d6213985206aa05c0aa63ff", "url": "https://github.com/ankidroid/Anki-Android/commit/1977bc5582fda7240d6213985206aa05c0aa63ff", "message": "NF: iterate on JSONArray\n\nThis is not trivial since it can contains different kind of value in a single array. In practice, it contains a single\ntype, so most iteration can be simplified", "committedDate": "2020-10-07T14:28:03Z", "type": "forcePushed"}, {"oid": "f30ccce083d7aaa4e8b2ffbbbca133a346c442fd", "url": "https://github.com/ankidroid/Anki-Android/commit/f30ccce083d7aaa4e8b2ffbbbca133a346c442fd", "message": "NF: iterate on JSONArray\n\nThis is not trivial since it can contains different kind of value in a single array. In practice, it contains a single\ntype, so most iteration can be simplified", "committedDate": "2020-10-07T22:04:02Z", "type": "forcePushed"}, {"oid": "848720a92b930c9445a881890ff6cc6e39aa0234", "url": "https://github.com/ankidroid/Anki-Android/commit/848720a92b930c9445a881890ff6cc6e39aa0234", "message": "NF: iterate on JSONArray\n\nThis is not trivial since it can contains different kind of value in a single array. In practice, it contains a single\ntype, so most iteration can be simplified", "committedDate": "2020-10-07T23:25:44Z", "type": "commit"}, {"oid": "848720a92b930c9445a881890ff6cc6e39aa0234", "url": "https://github.com/ankidroid/Anki-Android/commit/848720a92b930c9445a881890ff6cc6e39aa0234", "message": "NF: iterate on JSONArray\n\nThis is not trivial since it can contains different kind of value in a single array. In practice, it contains a single\ntype, so most iteration can be simplified", "committedDate": "2020-10-07T23:25:44Z", "type": "forcePushed"}]}