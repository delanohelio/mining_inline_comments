{"pr_number": 5988, "pr_title": "Extract BrowserAppearance and delete abstractions", "pr_createdAt": "2020-04-12T18:48:17Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5988", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzODU0Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5988#discussion_r407238546", "bodyText": "This is concerning, I didn't consider the fact that SMP chars would be problematic and the exact problem isn't specified.\nI might need to perform a 2-way mapping, but it'd be good to get a concrete example of the issue.", "author": "david-allison-1", "createdAt": "2020-04-12T18:55:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/cardviewer/CardAppearance.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.ichi2.anki.cardviewer;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.reviewer.ReviewerCustomFonts;\n+import com.ichi2.themes.Themes;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import androidx.annotation.CheckResult;\n+\n+/** Responsible for calculating CSS and element styles and modifying content on a flashcard */\n+public class CardAppearance {\n+\n+    /** Max size of the font for dynamic calculation of font size */\n+    private static final int DYNAMIC_FONT_MAX_SIZE = 14;\n+\n+    /** Min size of the font for dynamic calculation of font size */\n+    private static final int DYNAMIC_FONT_MIN_SIZE = 3;\n+    private static final int DYNAMIC_FONT_FACTOR = 5;\n+\n+    /** Constant for class attribute signaling answer */\n+    public static final String ANSWER_CLASS = \"\\\"answer\\\"\";\n+\n+    /** Constant for class attribute signaling question */\n+    public static final String QUESTION_CLASS = \"\\\"question\\\"\";\n+\n+    private final int mCardZoom;\n+    private final int mImageZoom;\n+    private final boolean mNightMode;\n+    private final boolean mCenterVertically;\n+    private final ReviewerCustomFonts mCustomFonts;\n+\n+    public CardAppearance(ReviewerCustomFonts customFonts, int cardZoom, int imageZoom, boolean nightMode, boolean centerVertically) {\n+        this.mCustomFonts = customFonts;\n+        this.mCardZoom = cardZoom;\n+        this.mImageZoom = imageZoom;\n+        this.mNightMode = nightMode;\n+        this.mCenterVertically = centerVertically;\n+    }\n+\n+    public boolean isNightMode() {\n+        return mNightMode;\n+    }\n+\n+    public static CardAppearance create(ReviewerCustomFonts customFonts, SharedPreferences preferences) {\n+        int cardZoom = preferences.getInt(\"cardZoom\", 100);\n+        int imageZoom = preferences.getInt(\"imageZoom\", 100);\n+        boolean nightMode = preferences.getBoolean(\"invertedColors\", false);\n+        boolean centerVertically = preferences.getBoolean(\"centerVertically\", false);\n+        return new CardAppearance(customFonts, cardZoom, imageZoom, nightMode, centerVertically);\n+    }\n+\n+\n+    public static String fixBoldStyle(String content) {\n+        // In order to display the bold style correctly, we have to change\n+        // font-weight to 700\n+        return content.replace(\"font-weight:600;\", \"font-weight:700;\");\n+    }\n+\n+    /**\n+     * Converts characters in Unicode Supplementary Multilingual Plane (SMP) to their equivalent Html Entities. This is\n+     * done because webview has difficulty displaying these characters.\n+     *\n+     * @param text the text co convert to HTML Entities\n+     * @return The resultant text with SMP characters converted to entities\n+     */\n+    public static String convertSmpToHtmlEntity(String text) {", "originalCommit": "a9007eb3a00a3ce03165474e4f499075cf5340e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1MDMxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5988#discussion_r407250314", "bodyText": "You might look to the git blame / history on this one - I thought the same thing as I read this. I wonder if it is a problem anymore? I mean, when AnkiDroid first started it was API1, and now the WebView is Chrome, so...could be this should either be deleted already or sunsetted with a Compat implementation and an API cutoff where we know it's okay (and I'd think any API number that has access to current Chrome WebView at least would be okay, if this was just a historical thing)", "author": "mikehardy", "createdAt": "2020-04-12T20:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzODU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1MjI0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5988#discussion_r407252245", "bodyText": "Anki desktop fails to handle SMP characters.\nBut, the Visual Editor without the code seems to display it without problems \ud80c\udc07.", "author": "david-allison-1", "createdAt": "2020-04-12T21:06:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzODU0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzODU5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5988#discussion_r407238596", "bodyText": "Mind if I extract this pattern into a local variable?", "author": "david-allison-1", "createdAt": "2020-04-12T18:56:24Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/cardviewer/CardAppearance.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.ichi2.anki.cardviewer;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.reviewer.ReviewerCustomFonts;\n+import com.ichi2.themes.Themes;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import androidx.annotation.CheckResult;\n+\n+/** Responsible for calculating CSS and element styles and modifying content on a flashcard */\n+public class CardAppearance {\n+\n+    /** Max size of the font for dynamic calculation of font size */\n+    private static final int DYNAMIC_FONT_MAX_SIZE = 14;\n+\n+    /** Min size of the font for dynamic calculation of font size */\n+    private static final int DYNAMIC_FONT_MIN_SIZE = 3;\n+    private static final int DYNAMIC_FONT_FACTOR = 5;\n+\n+    /** Constant for class attribute signaling answer */\n+    public static final String ANSWER_CLASS = \"\\\"answer\\\"\";\n+\n+    /** Constant for class attribute signaling question */\n+    public static final String QUESTION_CLASS = \"\\\"question\\\"\";\n+\n+    private final int mCardZoom;\n+    private final int mImageZoom;\n+    private final boolean mNightMode;\n+    private final boolean mCenterVertically;\n+    private final ReviewerCustomFonts mCustomFonts;\n+\n+    public CardAppearance(ReviewerCustomFonts customFonts, int cardZoom, int imageZoom, boolean nightMode, boolean centerVertically) {\n+        this.mCustomFonts = customFonts;\n+        this.mCardZoom = cardZoom;\n+        this.mImageZoom = imageZoom;\n+        this.mNightMode = nightMode;\n+        this.mCenterVertically = centerVertically;\n+    }\n+\n+    public boolean isNightMode() {\n+        return mNightMode;\n+    }\n+\n+    public static CardAppearance create(ReviewerCustomFonts customFonts, SharedPreferences preferences) {\n+        int cardZoom = preferences.getInt(\"cardZoom\", 100);\n+        int imageZoom = preferences.getInt(\"imageZoom\", 100);\n+        boolean nightMode = preferences.getBoolean(\"invertedColors\", false);\n+        boolean centerVertically = preferences.getBoolean(\"centerVertically\", false);\n+        return new CardAppearance(customFonts, cardZoom, imageZoom, nightMode, centerVertically);\n+    }\n+\n+\n+    public static String fixBoldStyle(String content) {\n+        // In order to display the bold style correctly, we have to change\n+        // font-weight to 700\n+        return content.replace(\"font-weight:600;\", \"font-weight:700;\");\n+    }\n+\n+    /**\n+     * Converts characters in Unicode Supplementary Multilingual Plane (SMP) to their equivalent Html Entities. This is\n+     * done because webview has difficulty displaying these characters.\n+     *\n+     * @param text the text co convert to HTML Entities\n+     * @return The resultant text with SMP characters converted to entities\n+     */\n+    public static String convertSmpToHtmlEntity(String text) {\n+        StringBuffer sb = new StringBuffer();\n+        Matcher m = Pattern.compile(\"([^\\u0000-\\uFFFF])\").matcher(text);", "originalCommit": "a9007eb3a00a3ce03165474e4f499075cf5340e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1MDQzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5988#discussion_r407250432", "bodyText": "I'm more interested in whether we need it or could Compat-sunset it. A local variable used once is not interesting to me it is actually hard to read because you have to find the reference", "author": "mikehardy", "createdAt": "2020-04-12T20:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIzODU5Ng=="}], "type": "inlineReview"}, {"oid": "db8a7ed79665e1e992ee19cd0f7a26c923b4791a", "url": "https://github.com/ankidroid/Anki-Android/commit/db8a7ed79665e1e992ee19cd0f7a26c923b4791a", "message": "Extract BrowserAppearance and delete abstractions\n\nMostly for use in the Visual Editor\n\nDelete ReviewerExtRegistry and implementations - only contained one\nclass", "committedDate": "2020-04-13T16:49:19Z", "type": "commit"}, {"oid": "13424dd1f6255d5c6a4e96e67f7badb56c5294c1", "url": "https://github.com/ankidroid/Anki-Android/commit/13424dd1f6255d5c6a4e96e67f7badb56c5294c1", "message": "REVIEW: Deprecate convertSmpToHtmlEntity\n\nThis code existed before auto-updating WebViews, and appears\nunnecessary.\n\nWe gate the feature to < API 21 to determine if it's still required.", "committedDate": "2020-04-13T16:49:36Z", "type": "commit"}, {"oid": "13424dd1f6255d5c6a4e96e67f7badb56c5294c1", "url": "https://github.com/ankidroid/Anki-Android/commit/13424dd1f6255d5c6a4e96e67f7badb56c5294c1", "message": "REVIEW: Deprecate convertSmpToHtmlEntity\n\nThis code existed before auto-updating WebViews, and appears\nunnecessary.\n\nWe gate the feature to < API 21 to determine if it's still required.", "committedDate": "2020-04-13T16:49:36Z", "type": "forcePushed"}]}