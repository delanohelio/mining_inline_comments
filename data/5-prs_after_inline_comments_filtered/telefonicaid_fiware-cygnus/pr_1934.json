{"pr_number": 1934, "pr_title": "Task/sql upsert (for postgis)", "pr_createdAt": "2020-09-24T13:05:33Z", "pr_url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934", "timeline": [{"oid": "7a723cae7f79906f52f2360a41a6763fe31f0e30", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/7a723cae7f79906f52f2360a41a6763fe31f0e30", "message": "squash! add flag to enable last value", "committedDate": "2020-09-22T11:52:14Z", "type": "commit"}, {"oid": "0bfa57726613e97ae83ac694dff665dcc9d79c4b", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0bfa57726613e97ae83ac694dff665dcc9d79c4b", "message": "disassemble date parser function", "committedDate": "2020-09-22T11:52:50Z", "type": "commit"}, {"oid": "67198a6da54b5bc8a12e33cb36671dc7cfd9f9f4", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/67198a6da54b5bc8a12e33cb36671dc7cfd9f9f4", "message": "process last data collection", "committedDate": "2020-09-22T11:53:20Z", "type": "commit"}, {"oid": "76fc9a95d5f9dad36725984dccedf3ea36cf5957", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/76fc9a95d5f9dad36725984dccedf3ea36cf5957", "message": "update last value algorithm", "committedDate": "2020-09-22T14:46:39Z", "type": "commit"}, {"oid": "d64b96a997de16bf7c9d32c8ef3a57d8434f7238", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d64b96a997de16bf7c9d32c8ef3a57d8434f7238", "message": "rename last data function flag", "committedDate": "2020-09-23T10:21:39Z", "type": "commit"}, {"oid": "479cea3a80cb2438f789fec89a1078b2c38b65de", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/479cea3a80cb2438f789fec89a1078b2c38b65de", "message": "update javadoc", "committedDate": "2020-09-23T10:21:59Z", "type": "commit"}, {"oid": "f0b5320342ff6be31ba6011b0fe8fe046b4ea4f2", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/f0b5320342ff6be31ba6011b0fe8fe046b4ea4f2", "message": "add getconnection function for SQL driver", "committedDate": "2020-09-23T10:22:25Z", "type": "commit"}, {"oid": "1412e9173fd3da5bab1e0e5e846fdedfb7fb1c75", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/1412e9173fd3da5bab1e0e5e846fdedfb7fb1c75", "message": "add sql utils class", "committedDate": "2020-09-23T10:23:29Z", "type": "commit"}, {"oid": "80428cfe78d9d3aec529e799d128d774569ab4a8", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/80428cfe78d9d3aec529e799d128d774569ab4a8", "message": "String optimization", "committedDate": "2020-09-23T10:50:58Z", "type": "commit"}, {"oid": "d50d6ffc5438e1bdee232e8a15e5d52d3c80cf14", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d50d6ffc5438e1bdee232e8a15e5d52d3c80cf14", "message": "create upsertStatement", "committedDate": "2020-09-23T11:09:47Z", "type": "commit"}, {"oid": "44269f9f2546ad1602e4b0851afdf6e1dc3e59c6", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/44269f9f2546ad1602e4b0851afdf6e1dc3e59c6", "message": "create execute statement method", "committedDate": "2020-09-23T11:21:18Z", "type": "commit"}, {"oid": "72c66a8304a6cdca887af805dddaf1f338015a85", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/72c66a8304a6cdca887af805dddaf1f338015a85", "message": "query fixes", "committedDate": "2020-09-23T15:33:32Z", "type": "commit"}, {"oid": "c40e6d12bae880f967c9c58c8e56a47e34edbc20", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c40e6d12bae880f967c9c58c8e56a47e34edbc20", "message": "add tests", "committedDate": "2020-09-23T15:34:59Z", "type": "commit"}, {"oid": "4c80d1d812ee8d5294f203f7b29d16c78c403fc7", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/4c80d1d812ee8d5294f203f7b29d16c78c403fc7", "message": "logging and cleanning", "committedDate": "2020-09-24T08:01:26Z", "type": "commit"}, {"oid": "0f6293bd25e42429ab6a99262c5025893366ea7f", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0f6293bd25e42429ab6a99262c5025893366ea7f", "message": "execute upsert when enabled and not row aggregation", "committedDate": "2020-09-24T08:02:04Z", "type": "commit"}, {"oid": "691d45132813b3d6080424ca0e9de20296dc43b8", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/691d45132813b3d6080424ca0e9de20296dc43b8", "message": "add validations", "committedDate": "2020-09-24T08:25:50Z", "type": "commit"}, {"oid": "50a66f87dddba0860d9b624e49ab77dc39752deb", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/50a66f87dddba0860d9b624e49ab77dc39752deb", "message": "timestamp formating optimization", "committedDate": "2020-09-24T09:13:15Z", "type": "commit"}, {"oid": "e43ba0bf01cfa34781631878c43878b8b05382a2", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e43ba0bf01cfa34781631878c43878b8b05382a2", "message": "add last data function to postgresql sink", "committedDate": "2020-09-24T09:23:19Z", "type": "commit"}, {"oid": "2dda112ae28d07d8b489c723c8a5b30a8a3ec8f9", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2dda112ae28d07d8b489c723c8a5b30a8a3ec8f9", "message": "add last data documentation", "committedDate": "2020-09-24T11:29:01Z", "type": "commit"}, {"oid": "4663202c589d60f06723e968c8e35d6718a2375b", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/4663202c589d60f06723e968c8e35d6718a2375b", "message": "add last data test", "committedDate": "2020-09-24T11:46:57Z", "type": "commit"}, {"oid": "c4ad42552ed94ceb38bf060aba4eae2a7942d9bb", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c4ad42552ed94ceb38bf060aba4eae2a7942d9bb", "message": "update docs", "committedDate": "2020-09-24T13:01:47Z", "type": "commit"}, {"oid": "6c74ba93bbe93515cd3c65e2bbcd971e0316c7bf", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/6c74ba93bbe93515cd3c65e2bbcd971e0316c7bf", "message": "add java doc", "committedDate": "2020-09-24T13:06:58Z", "type": "commit"}, {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "message": "Merge branch 'master' into task/sql_upsert", "committedDate": "2020-09-24T13:07:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0OTUwNw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494349507", "bodyText": "CNR entry corresponding to this PR should be added.", "author": "fgalan", "createdAt": "2020-09-24T14:07:26Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLBackendImpl.java", "diffHunk": "@@ -38,6 +38,9 @@\n import java.util.Date;", "originalCommit": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5NTcxNg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494395716", "bodyText": "Fixed in 155a1ab", "author": "IvanHdzC", "createdAt": "2020-09-24T15:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0OTUwNw=="}], "type": "inlineReview"}, {"oid": "236b96219af56ca45195def0feafa4f411677677", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/236b96219af56ca45195def0feafa4f411677677", "message": "Update NGSIGenericColumnAggregator.java", "committedDate": "2020-09-24T14:56:14Z", "type": "commit"}, {"oid": "155a1ab4d2f52093e588f85d399ec32690ad4402", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/155a1ab4d2f52093e588f85d399ec32690ad4402", "message": "add CNR", "committedDate": "2020-09-24T15:00:37Z", "type": "commit"}, {"oid": "5dcf5bfdd5c0bc07ba58850025f4902c32acc756", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/5dcf5bfdd5c0bc07ba58850025f4902c32acc756", "message": "Merge branch 'task/sql_upsert' of https://github.com/telefonicaid/fiware-cygnus into task/sql_upsert", "committedDate": "2020-09-24T15:00:47Z", "type": "commit"}, {"oid": "3be56543ed106087a647eac3cb71c863780a03fb", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3be56543ed106087a647eac3cb71c863780a03fb", "message": "list sinks where upsert function is available", "committedDate": "2020-09-24T15:02:43Z", "type": "commit"}, {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "message": "update mkdocs", "committedDate": "2020-09-24T15:06:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwOTY5NQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494409695", "bodyText": "License header missing", "author": "fgalan", "createdAt": "2020-09-24T15:26:04Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/utils/NGSISQLUtils.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.telefonica.iot.cygnus.utils;", "originalCommit": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMzQ0Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494413446", "bodyText": "Fixed in 527c45f", "author": "IvanHdzC", "createdAt": "2020-09-24T15:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwOTY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMDA1Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494410056", "bodyText": "License header missing", "author": "fgalan", "createdAt": "2020-09-24T15:26:32Z", "path": "cygnus-ngsi/src/test/java/com/telefonica/iot/cygnus/utils/NGSISQLUtilsTest.java", "diffHunk": "@@ -0,0 +1,379 @@\n+package com.telefonica.iot.cygnus.utils;", "originalCommit": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMzUyNg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494413526", "bodyText": "Fixed in 527c45f", "author": "IvanHdzC", "createdAt": "2020-09-24T15:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMDA1Ng=="}], "type": "inlineReview"}, {"oid": "527c45fe9eb4d2a49441ed9532fa068876872000", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/527c45fe9eb4d2a49441ed9532fa068876872000", "message": "add license header", "committedDate": "2020-09-24T15:30:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNTA3Mg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494305072", "bodyText": "Maybe add a comment with the link doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md ?", "author": "AlvaroVega", "createdAt": "2020-09-24T13:12:45Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/aggregation/NGSIGenericColumnAggregator.java", "diffHunk": "@@ -149,6 +150,35 @@ public void aggregate(NGSIEvent event) {\n             } // if\n         } // for\n         setAggregation(aggregation);\n+        if (isEnableLastData()) {", "originalCommit": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5NTM2Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494395366", "bodyText": "Including both (postgresql and postgis) ?", "author": "AlvaroVega", "createdAt": "2020-09-24T15:06:49Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/utils/NGSISQLUtils.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.telefonica.iot.cygnus.utils;\n+\n+import com.google.gson.JsonElement;\n+import com.telefonica.iot.cygnus.log.CygnusLogger;\n+\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Set;\n+\n+/**\n+ * The type Ngsisql utils.\n+ */\n+public class NGSISQLUtils {\n+\n+    private static final CygnusLogger LOGGER = new CygnusLogger(NGSISQLUtils.class);\n+\n+    private static final String POSTGRES_FIELDS_MARK = \"\";\n+    private static final String MYSQL_FIELDS_MARK = \"'\";\n+    private static final String SEPARATION_MARK = \",\";\n+\n+    /**\n+     * Upsert statement prepared statement.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @param connection      the connection\n+     * @param attrNativeTypes the attr native types\n+     * @return the prepared statement\n+     * @throws SQLException the sql exception\n+     */\n+    public static PreparedStatement upsertStatement (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                            LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                            String tableName,\n+                                            String tableSuffix,\n+                                            String uniqueKey,\n+                                            String timestampKey,\n+                                            String timestampFormat,\n+                                            String sqlInstance,\n+                                            String destination,\n+                                            Connection connection,\n+                                            boolean attrNativeTypes) throws SQLException {\n+\n+\n+        String query = sqlUpsertQuery(aggregation,\n+                lastData,\n+                tableName,\n+                tableSuffix,\n+                uniqueKey,\n+                timestampKey,\n+                timestampFormat,\n+                sqlInstance,\n+                destination).toString();\n+\n+        PreparedStatement previousStatement = connection.prepareStatement(query);\n+        PreparedStatement preparedStatement = null;\n+        try {\n+            preparedStatement = addJsonValues(previousStatement,\n+                    lastData,\n+                    attrNativeTypes);\n+        } catch (SQLException e) {\n+            LOGGER.error(sqlInstance + \" SQLEXCEPTION Error creating upsert statement \" + e);\n+        } catch (Exception e) {\n+            LOGGER.error(sqlInstance + \" GENERICEXCEPTION Error creating upsert statement \" + e);\n+        }\n+        LOGGER.info(\"[NGSISQLUtils.upsertStatement] PreparedStatement for upsert created successfully, all batches added. \" + query);\n+        return preparedStatement;\n+\n+    }\n+\n+    /**\n+     * Sql upsert query string buffer.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @return the string buffer\n+     */\n+    protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                              LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                              String tableName,\n+                                              String tableSuffix,\n+                                              String uniqueKey,\n+                                              String timestampKey,\n+                                              String timestampFormat,\n+                                              String sqlInstance,\n+                                              String destination) {\n+\n+        StringBuffer fieldsForInsert;\n+        StringBuffer valuesForInsert = sqlQuestionValues(lastData.keySet());\n+        StringBuffer updateSet = new StringBuffer();\n+        StringBuffer postgisTempReference = new StringBuffer(\"EXCLUDED\");\n+        StringBuffer postgisDestination = new StringBuffer(destination).append(\".\").append(tableName).append(tableSuffix);\n+        StringBuffer query = new StringBuffer();\n+        boolean first = true;\n+\n+        for (String key : lastData.keySet()) {\n+            if (!key.equals(uniqueKey) && first) {\n+                updateSet.append(key).append(\"=\").append(postgisTempReference).append(\".\").append(key);\n+                first = false;\n+            } else if (!key.equals(uniqueKey)) {\n+                updateSet.append(\", \").append(key).append(\"=\").append(postgisTempReference).append(\".\").append(key);\n+            }\n+        }\n+\n+        if (sqlInstance.equals(\"postgresql\")) {", "originalCommit": "3be56543ed106087a647eac3cb71c863780a03fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkwNzgwNQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494907805", "bodyText": "That's correct. In both cases this String sqlInstance is provided by the sink. In Postgis and PostgreSQL is handled as postgresql . This is because the driver used to connect to the database is the same one.", "author": "IvanHdzC", "createdAt": "2020-09-25T10:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5NTM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwNDU3NA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494804574", "bodyText": "some few comments are welcome", "author": "AlvaroVega", "createdAt": "2020-09-25T07:38:43Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/aggregation/NGSIGenericColumnAggregator.java", "diffHunk": "@@ -149,6 +150,35 @@ public void aggregate(NGSIEvent event) {\n             } // if\n         } // for\n         setAggregation(aggregation);\n+        if (isEnableLastData()) { // More detail in doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md\n+            boolean updateLastData = false;", "originalCommit": "527c45fe9eb4d2a49441ed9532fa068876872000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84ecd81133e369c62aa6d8eb29a8da5f73b65d42", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/84ecd81133e369c62aa6d8eb29a8da5f73b65d42", "message": "Merge branch 'master' into task/sql_upsert", "committedDate": "2020-09-28T14:17:08Z", "type": "commit"}]}