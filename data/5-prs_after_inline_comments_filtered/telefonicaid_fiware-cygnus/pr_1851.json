{"pr_number": 1851, "pr_title": "fix persistence error mongo authentication", "pr_createdAt": "2020-04-01T18:51:48Z", "pr_url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851", "timeline": [{"oid": "e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "message": "fix persistence error mongo authentication", "committedDate": "2020-04-01T17:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwNTk0NA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402205944", "bodyText": "There is no need to overload the costructor in this case, since mongoAuthSource has a not null validation on getDatabase.", "author": "IvanHdzC", "createdAt": "2020-04-02T10:19:32Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/mongo/MongoBackendImpl.java", "diffHunk": "@@ -72,6 +73,25 @@ public MongoBackendImpl(String mongoHosts, String mongoUsername, String mongoPas\n         this.mongoHosts = mongoHosts;\n         this.mongoUsername = mongoUsername;\n         this.mongoPassword = mongoPassword;\n+        this.mongoAuthSource = \"\";\n+        this.dataModel = dataModel;\n+    } // MongoBackendImpl\n+\n+    /**\n+     * Constructor.\n+     * @param mongoHosts\n+     * @param mongoUsername\n+     * @param mongoPassword\n+     * @param mongoAuthSource\n+     * @param dataModel\n+     */\n+    public MongoBackendImpl(String mongoHosts, String mongoUsername, String mongoPassword,", "originalCommit": "e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzcxOQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402223719", "bodyText": "From my point of view it is better to have this new constructor to avoid side effect and maintain the backward compatibility. There is no problem to have 2 constructors in OOP and it is common to do it allowing to initialize and/or construct objects with different parameters depending of the use cases and future needs and maintaining the interface.", "author": "srrspace", "createdAt": "2020-04-02T10:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwNTk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMDY1OA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402230658", "bodyText": "I agree, but the constructor is actually only used in NGSIMongoBaseSink and in tests, so there is no need to have both.", "author": "IvanHdzC", "createdAt": "2020-04-02T11:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwNTk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxNjMzOA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402416338", "bodyText": "I agree with @IvanHdzC . The constructor is only used in one point of the code, so lest's adapt constructor and calling code better than adding a second constructor. In addition, the lesser constructor we have, the easier it would be to have good code coverage in tests.", "author": "fgalan", "createdAt": "2020-04-02T15:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwNTk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwODU4MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402208581", "bodyText": "I thing it's more usuall that the default authSource is \"admin\". It would be better if the default value of mongo_auth_source is \"admin\".", "author": "IvanHdzC", "createdAt": "2020-04-02T10:24:19Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSIMongoBaseSink.java", "diffHunk": "@@ -98,33 +107,35 @@ protected void setBackend(MongoBackendImpl backend) {\n     protected MongoBackendImpl getBackend() {\n         return backend;\n     } // getBackend\n-    \n+\n     @Override\n     public void configure(Context context) {\n         super.configure(context);\n-        \n+\n         mongoHosts = context.getString(\"mongo_hosts\", \"localhost:27017\");\n         LOGGER.debug(\"[\" + this.getName() + \"] Reading configuration (mongo_hosts=\" + mongoHosts + \")\");\n         mongoUsername = context.getString(\"mongo_username\", \"\");\n         LOGGER.debug(\"[\" + this.getName() + \"] Reading configuration (mongo_username=\" + mongoUsername + \")\");\n         // FIXME: mongoPassword should be read as a SHA1 and decoded here\n         mongoPassword = context.getString(\"mongo_password\", \"\");\n         LOGGER.debug(\"[\" + this.getName() + \"] Reading configuration (mongo_password=\" + mongoPassword + \")\");\n-        \n+        mongoAuthSource = context.getString(\"mongo_auth_source\", \"\");", "originalCommit": "e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyOTEzNQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402229135", "bodyText": "IMHO authSource is necessary to be configured and not fixed as default constant value to admin for security reason. Admin is a sensible and critical database with rights and high privileges. Giving the possibility to configure the authentication database will allow to provide other specific databases with some restrictions and with just the necesary privileges with a set of user depending of the uses and applications needed and it is more secure tha using only the admin database.", "author": "srrspace", "createdAt": "2020-04-02T11:03:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwODU4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMjMzMg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402232332", "bodyText": "You are right, I misunderstood the \"defaultauthdb\" value, it actually is the db where the connection is created.\nNTC", "author": "IvanHdzC", "createdAt": "2020-04-02T11:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIwODU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMDUzNw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402210537", "bodyText": "Not sure if the dbName is the right authSource in case it is not specified.", "author": "IvanHdzC", "createdAt": "2020-04-02T10:27:58Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/mongo/MongoBackendImpl.java", "diffHunk": "@@ -492,9 +512,20 @@ private MongoDatabase getDatabase(String dbName) {\n \n         if (client == null) {\n             if (mongoUsername.length() != 0) {\n-                MongoCredential credential = MongoCredential.createCredential(mongoUsername, dbName,\n+                String authSource;\n+                if ((mongoAuthSource != null) && !mongoAuthSource.isEmpty()) {\n+                    authSource = mongoAuthSource;\n+                } else {\n+                    authSource = dbName;", "originalCommit": "e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMjUwMA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402232500", "bodyText": "Before this modification dbName was the value used in the previous version. If authSource is not configured then the behavior of the code is the same as before maintaining the backward compatibility. From my point of view it is better to keep the code as it is and not setting authSource as a constant to \"admin\".", "author": "srrspace", "createdAt": "2020-04-02T11:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMDUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMjUxMw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402232513", "bodyText": "I misunderstood the \"defaultauthdb\" value, it actually is the db where the connection is created.\nNTC", "author": "IvanHdzC", "createdAt": "2020-04-02T11:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMDUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI0NDk1OQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402244959", "bodyText": "Yes, dbName is one thing and authSource is another. The parameter dbName is the name of the database to create and based on \"Fiware-Service\" where the collections will be stored. And authSource is used to specify a user DB where the credentials are defined, as documented by Mongo and for the credentials objects. These are 2 different things.\ndbName is used in client.getDatabase(dbName) (class MongoClient) and authSource is used by credential object (MongoCredential) if only there is a need of authentication.", "author": "srrspace", "createdAt": "2020-04-02T11:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMDUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzk0MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402223941", "bodyText": "is this ever used?", "author": "IvanHdzC", "createdAt": "2020-04-02T10:53:00Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/mongo/MongoBackendImpl.java", "diffHunk": "@@ -600,4 +631,24 @@ protected int getOffset(GregorianCalendar calendar, Resolution resolution) {\n         return offset;\n     } // getOffset\n \n+    /**\n+     * Gets the mongo auth_source\n+     * @return\n+     */\n+    public String getAuthSource() {\n+        return mongoAuthSource;\n+    } // getAuthSource\n+\n+    /**\n+     * Set the mongo auth_source\n+     * @param authSource DB used for mongo authentication\n+     */\n+    public void setAuthSource(String authSource) {\n+        if (authSource != null) {\n+            this.mongoAuthSource = authSource;\n+        } else {\n+            this.mongoAuthSource = \"\";\n+        }\n+    } // setAuthSource\n+", "originalCommit": "e0ebd92a4e752cd2d78601af257a1f15ca5013f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI0NTIxNg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402245216", "bodyText": "Again, if somebody or other piece of code (allowing other new sink in the future to use mongo as a DB with authentication),  and want to use the first constructor without authSource in parameter, it will have the opportunity to set the authSource after to build the backend object using the setAuthSource(...) operation when needed and in some place in the code. It is typical and best practices to do it in OOP (overload constructors and get/set operations), and give more possibilities.\nNotice that in this case mongoAuthSource shoud not be annotated as \"final\" in the declaration.", "author": "srrspace", "createdAt": "2020-04-02T11:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI1MDAyMw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402250023", "bodyText": "get/setAuthSource(...) could be used, if somebody build the object without authSource parameter and if after they want to initialize this parameter.\nThis is what I tested successfully and put in comment as documentation (see start() operation), and use of the new constructor.\nBTW, What does it mean \"NTC\" and \"LGTM\"?", "author": "srrspace", "createdAt": "2020-04-02T11:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQxODAzOA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402418038", "bodyText": "NTC = Nothing to change\nLGTM = Looks good to me", "author": "IvanHdzC", "createdAt": "2020-04-02T15:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0ODQ0MA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1851#discussion_r402548440", "bodyText": "More on \"the NTC and LGTM protocol\" review protocol here: https://github.com/telefonicaid/fiware-orion/blob/master/doc/manuals/contribution_guidelines.md#pull-request-protocol", "author": "fgalan", "createdAt": "2020-04-02T19:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyMzk0MQ=="}], "type": "inlineReview"}, {"oid": "99025be69930f7fccb2cb7dec46dff99f034297c", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/99025be69930f7fccb2cb7dec46dff99f034297c", "message": "Update CHANGES_NEXT_RELEASE", "committedDate": "2020-04-02T16:36:26Z", "type": "commit"}, {"oid": "59b52cf6daa4fffd9ce10c6705f36276fb6a0b5e", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/59b52cf6daa4fffd9ce10c6705f36276fb6a0b5e", "message": "Fix persistence error mongo authentication adding mongoAuthSource parameter to built Mongo backend", "committedDate": "2020-04-02T16:40:11Z", "type": "commit"}, {"oid": "2a8ddffb74f385d2608ac3561c2ac2ff2b9a50b4", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2a8ddffb74f385d2608ac3561c2ac2ff2b9a50b4", "message": "Add a new mongoAuthSource parameter to create the Mongo backend", "committedDate": "2020-04-02T16:56:38Z", "type": "commit"}, {"oid": "3de97a897dccc6a31446088f6c2a2f551b248e37", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3de97a897dccc6a31446088f6c2a2f551b248e37", "message": "Update the documentation to reference the mongo_auth_source parameter", "committedDate": "2020-04-02T17:44:21Z", "type": "commit"}, {"oid": "83e6db00e272403b66b5c615e370bb27e0eead0e", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/83e6db00e272403b66b5c615e370bb27e0eead0e", "message": "Update docker file, configuration, entrypoint to reference the mongo_auth_source parameter", "committedDate": "2020-04-02T17:47:40Z", "type": "commit"}, {"oid": "773eb00c8d8972962e2448c59fe797424df6471b", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/773eb00c8d8972962e2448c59fe797424df6471b", "message": "Update cygnus-ngsi agent configuration template, test files", "committedDate": "2020-04-02T17:50:06Z", "type": "commit"}, {"oid": "c3a06b5b5f9880b69563ae90a2f48171280f5606", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c3a06b5b5f9880b69563ae90a2f48171280f5606", "message": "Update the documentation, mongo_auth_source added to the configuration table", "committedDate": "2020-04-06T14:52:58Z", "type": "commit"}, {"oid": "83c5ddb36bbf47d766560fe8726a1775bb2ff6b4", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/83c5ddb36bbf47d766560fe8726a1775bb2ff6b4", "message": "Update the documentation, mongo_auth_source added to the configuration table", "committedDate": "2020-04-06T14:59:47Z", "type": "commit"}, {"oid": "c19f6df8e8085f50c6c0f9ce489caf9a70e5273a", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c19f6df8e8085f50c6c0f9ce489caf9a70e5273a", "message": "Update CHANGES_NEXT_RELEASE\n\nCo-Authored-By: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-04-14T08:16:07Z", "type": "commit"}, {"oid": "75914ad0956bedba2f2e9417e7bac6ea728e1ecb", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/75914ad0956bedba2f2e9417e7bac6ea728e1ecb", "message": "Update CHANGES_NEXT_RELEASE\n\nCo-Authored-By: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-04-14T10:30:05Z", "type": "commit"}]}