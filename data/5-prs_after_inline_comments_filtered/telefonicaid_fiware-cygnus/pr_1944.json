{"pr_number": 1944, "pr_title": "Task/insert upsert transaction", "pr_createdAt": "2020-10-05T13:36:30Z", "pr_url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944", "timeline": [{"oid": "0cf9c65b2d889f54b41d3535a34b6fa0d7acf1d4", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0cf9c65b2d889f54b41d3535a34b6fa0d7acf1d4", "message": "code cleanning", "committedDate": "2020-10-01T09:15:06Z", "type": "commit"}, {"oid": "b4006a1f2dc1eaf1a6a91dc7ac8d8df40b153c3d", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/b4006a1f2dc1eaf1a6a91dc7ac8d8df40b153c3d", "message": "Merge branch 'master' into task/insert_upsert_transaction", "committedDate": "2020-10-01T09:15:30Z", "type": "commit"}, {"oid": "2a99f7ee20c34275b220e49e204a325d919cd899", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2a99f7ee20c34275b220e49e204a325d919cd899", "message": "add insert statement for mysql", "committedDate": "2020-10-01T11:37:44Z", "type": "commit"}, {"oid": "ed5afc75b52a0e3deceb08f041c6bb6e2d37450d", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/ed5afc75b52a0e3deceb08f041c6bb6e2d37450d", "message": "add upsert function and mysql upsert", "committedDate": "2020-10-02T09:53:24Z", "type": "commit"}, {"oid": "3c39dfe037866667673f52a6935285671722e818", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3c39dfe037866667673f52a6935285671722e818", "message": "update sink to use upsert transaction", "committedDate": "2020-10-02T09:55:21Z", "type": "commit"}, {"oid": "869147360d88020fce306568730a16aec99f1027", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/869147360d88020fce306568730a16aec99f1027", "message": "update mysql upsert query", "committedDate": "2020-10-02T11:47:07Z", "type": "commit"}, {"oid": "43c94d10e636aeac0020d6ddf1b8f72e5c62570c", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/43c94d10e636aeac0020d6ddf1b8f72e5c62570c", "message": "update insert query log", "committedDate": "2020-10-02T11:47:20Z", "type": "commit"}, {"oid": "2c4d43656a720abb93fbee588f7badb5d4b30dc7", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2c4d43656a720abb93fbee588f7badb5d4b30dc7", "message": "update tests", "committedDate": "2020-10-05T08:20:10Z", "type": "commit"}, {"oid": "80c443fe6321d0f14bf706cf40186a9c30b7d28a", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/80c443fe6321d0f14bf706cf40186a9c30b7d28a", "message": "add CNR entry", "committedDate": "2020-10-05T09:55:33Z", "type": "commit"}, {"oid": "8923a472d4a9f011e9fa4bd764276056b035ecb0", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8923a472d4a9f011e9fa4bd764276056b035ecb0", "message": "update docs", "committedDate": "2020-10-05T13:33:56Z", "type": "commit"}, {"oid": "803356bc6288c2273ffb39529151d556fb54ba58", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/803356bc6288c2273ffb39529151d556fb54ba58", "message": "Update CHANGES_NEXT_RELEASE\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-10-05T13:45:23Z", "type": "commit"}, {"oid": "3a6ef257335bcb2c419b38e841d7a683dfeabe76", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3a6ef257335bcb2c419b38e841d7a683dfeabe76", "message": "update sink docs", "committedDate": "2020-10-05T14:02:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMzk2Mw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499623963", "bodyText": "not sure if indentation is fine.", "author": "AlvaroVega", "createdAt": "2020-10-05T14:05:10Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtils.java", "diffHunk": "@@ -52,52 +52,44 @@\n      * @param timestampFormat the timestamp format\n      * @param sqlInstance     the sql instance\n      * @param destination     the destination\n-     * @param connection      the connection\n-     * @param attrNativeTypes the attr native types\n-     * @return the prepared statement\n-     * @throws SQLException the sql exception\n+     * @return the string buffer\n      */\n-    public static PreparedStatement upsertStatement (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n-                                            LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n-                                            String tableName,\n-                                            String tableSuffix,\n-                                            String uniqueKey,\n-                                            String timestampKey,\n-                                            String timestampFormat,\n-                                            String sqlInstance,\n-                                            String destination,\n-                                            Connection connection,\n-                                            boolean attrNativeTypes) throws SQLException {\n-\n-\n-        String query = sqlUpsertQuery(aggregation,\n-                lastData,\n-                tableName,\n-                tableSuffix,\n-                uniqueKey,\n-                timestampKey,\n-                timestampFormat,\n-                sqlInstance,\n-                destination).toString();\n+    protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                                        LinkedHashMap<String, ArrayList<JsonElement>> lastData,", "originalCommit": "803356bc6288c2273ffb39529151d556fb54ba58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzODIyNA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499638224", "bodyText": "Fixed in e0aa884", "author": "IvanHdzC", "createdAt": "2020-10-05T14:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMzk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNDkwMg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499624902", "bodyText": "Not sure if indentation is right", "author": "AlvaroVega", "createdAt": "2020-10-05T14:06:33Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtils.java", "diffHunk": "@@ -140,19 +132,114 @@ protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<Jso\n                 sqlInstance,\n                 destination);\n \n-        if (sqlInstance.equals(\"postgresql\")) {\n-            query.append(insertQuery).\n-                    append(\"ON CONFLICT \").append(\"(\").append(uniqueKey).append(\") \").\n-                    append(\"DO \").\n-                    append(\"UPDATE SET \").append(updateSet).append(\" \").\n-                    append(\"WHERE \").append(postgisDestination).append(\".\").append(uniqueKey).append(\"=\").append(postgisTempReference).append(\".\").append(uniqueKey).append(\" \").\n-                    append(\"AND \").append(\"to_timestamp(\").append(postgisDestination).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"') \").\n-                    append(\"< \").append(\"to_timestamp(\").append(postgisTempReference).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"')\");\n+        query.append(insertQuery).\n+                append(\"ON CONFLICT \").append(\"(\").append(uniqueKey).append(\") \").\n+                append(\"DO \").\n+                append(\"UPDATE SET \").append(updateSet).append(\" \").\n+                append(\"WHERE \").append(postgisDestination).append(\".\").append(uniqueKey).append(\"=\").append(postgisTempReference).append(\".\").append(uniqueKey).append(\" \").\n+                append(\"AND \").append(\"to_timestamp(\").append(postgisDestination).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"') \").\n+                append(\"< \").append(\"to_timestamp(\").append(postgisTempReference).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"')\");\n+\n+        LOGGER.debug(\"[NGSISQLUtils.sqlUpsertQuery] Preparing Upsert query: \" + query.toString());\n+        return query;\n+    }\n+\n+    /**\n+     * Sql upsert query for MySQL string buffer.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @return the string buffer\n+     */\n+    protected static StringBuffer mySqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                                        LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                                        String tableName,\n+                                                        String tableSuffix,\n+                                                        String uniqueKey,\n+                                                        String timestampKey,\n+                                                        String timestampFormat,\n+                                                        String sqlInstance,\n+                                                        String destination) {\n+\n+        StringBuffer updateSet = new StringBuffer();\n+        StringBuffer query = new StringBuffer();\n+        StringBuffer dateKeyUpdate = new StringBuffer();\n+        boolean first = true;\n+\n+        for (String key : lastData.keySet()) {\n+            if (!key.equals(timestampKey)) {\n+                if (!key.equals(uniqueKey) && first) {\n+                    first = false;\n+                } else if (!key.equals(uniqueKey)) {\n+                    updateSet.append(\", \");\n+                }\n+                if (!key.equals(uniqueKey)) {\n+                    updateSet.append(mySQLUpdateRecordQuery(key, uniqueKey, timestampKey, timestampFormat));\n+                }\n+            } else {\n+                dateKeyUpdate.append(mySQLUpdateRecordQuery(key, uniqueKey, timestampKey, timestampFormat));\n+            }\n+        }\n+        // The key that corresponds to the timestampKey must be updated at the end, if it is updated before any other key.\n+        // The subsecuent timestamp validations will be allways false, because the date would already be updated.\n+        if (first) {\n+            updateSet.append(dateKeyUpdate);\n+        } else {\n+            updateSet.append(\", \").append(dateKeyUpdate);\n         }\n+\n+        StringBuffer insertQuery = sqlInsertQuery(lastData,\n+                tableName.concat(tableSuffix),\n+                sqlInstance,\n+                destination);\n+\n+        query.append(insertQuery).\n+                append(\"ON DUPLICATE KEY \").\n+                append(\"UPDATE \").append(updateSet);\n+\n         LOGGER.debug(\"[NGSISQLUtils.sqlUpsertQuery] Preparing Upsert query: \" + query.toString());\n         return query;\n     }\n \n+    /**\n+     * Creates a update statement for an upsert query\n+     *\n+     * @param key     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @return the string buffer like the following one\n+     * recvTime=IF((entityId=VALUES(entityId)) AND (STR_TO_DATE(recvTime, '%Y-%m-%d %H:%i:%s.%f') < (STR_TO_DATE(VALUES(recvTime), '%Y-%m-%d %H:%i:%s.%f'))), VALUES(recvTime), recvTime)\n+     */\n+\n+    protected static StringBuffer mySQLUpdateRecordQuery(String key,\n+                                                       String uniqueKey,", "originalCommit": "803356bc6288c2273ffb39529151d556fb54ba58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzODI5NA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499638294", "bodyText": "Fixed in e0aa884", "author": "IvanHdzC", "createdAt": "2020-10-05T14:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNDkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNTkxOA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499625918", "bodyText": "Should this new dependence be added to pom.xml ?", "author": "AlvaroVega", "createdAt": "2020-10-05T14:08:04Z", "path": "cygnus-common/src/test/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtilsTest.java", "diffHunk": "@@ -18,9 +18,9 @@\n \n package com.telefonica.iot.cygnus.backends.sql;\n \n+import com.amazonaws.services.dynamodbv2.xspec.L;", "originalCommit": "3a6ef257335bcb2c419b38e841d7a683dfeabe76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzOTA3Mw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499639073", "bodyText": "Not really. Not sure why I added it, may be an auto suggestion from IntelliJ. Anyway, I removed it.\nFixed in e0aa884", "author": "IvanHdzC", "createdAt": "2020-10-05T14:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNTkxOA=="}], "type": "inlineReview"}, {"oid": "e0aa8847b5596ace1a4bf45340f279f7aa8e90e0", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e0aa8847b5596ace1a4bf45340f279f7aa8e90e0", "message": "indentation fixes and remove unused dependencies", "committedDate": "2020-10-05T14:23:04Z", "type": "commit"}, {"oid": "e1fc9bf8fa00baec03b7aaba267b440468a6ce71", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e1fc9bf8fa00baec03b7aaba267b440468a6ce71", "message": "update readme docs", "committedDate": "2020-10-05T14:23:38Z", "type": "commit"}]}