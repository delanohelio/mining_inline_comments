{"pr_number": 1850, "pr_title": "20200401 New CKAN DataModel", "pr_createdAt": "2020-04-01T12:08:41Z", "pr_url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850", "timeline": [{"oid": "dd61bbdef9e122d6e143d15f9d8e497f9697fdce", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/dd61bbdef9e122d6e143d15f9d8e497f9697fdce", "message": "20200401 New CKAN DataModel", "committedDate": "2020-04-01T12:02:50Z", "type": "commit"}, {"oid": "b2f08615bebf5bedb4681eee5414cf35043e5791", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/b2f08615bebf5bedb4681eee5414cf35043e5791", "message": "20200401 New CKAN DataModel Tests", "committedDate": "2020-04-01T12:11:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYwMjQ3MA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r401602470", "bodyText": "The goal for this task is to use the entity id as orgName, pkgName and resName.\nPerhaps It isn't necessary to store again the entityId on the sink, because it's already stored into the corresponding objects inside the generic aggregator.\ndo you agree @VicenteLT?", "author": "IvanHdzC", "createdAt": "2020-04-01T13:11:10Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSICKANSink.java", "diffHunk": "@@ -349,6 +362,7 @@ private void persistAggregation(NGSIGenericAggregator aggregator, String service\n                 aggregation += \",\" + jsonObject;\n             }\n         }\n+        entityId=aggregator.getEntityId();", "originalCommit": "b2f08615bebf5bedb4681eee5414cf35043e5791", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MTk4NQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402171985", "bodyText": "fixed in dd61bbd", "author": "VicenteLT", "createdAt": "2020-04-02T09:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYwMjQ3MA=="}], "type": "inlineReview"}, {"oid": "2fec1dcc982f4a027fa828b46e243d19ebf12873", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2fec1dcc982f4a027fa828b46e243d19ebf12873", "message": "20200401 New CKAN DataModel - Remove entityId", "committedDate": "2020-04-01T17:02:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMzk1OA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402113958", "bodyText": "remove this lines", "author": "IvanHdzC", "createdAt": "2020-04-02T07:45:40Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/aggregation/NGSIGenericAggregator.java", "diffHunk": "@@ -393,6 +394,24 @@ public void setEntityType(String entityType) {\n     } //setEntityType\n \n     /**\n+     * Gets the entityId", "originalCommit": "2fec1dcc982f4a027fa828b46e243d19ebf12873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MTUwOA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402171508", "bodyText": "fixed in b179bd5", "author": "VicenteLT", "createdAt": "2020-04-02T09:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMzk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNDA0Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402114046", "bodyText": "remove this line", "author": "IvanHdzC", "createdAt": "2020-04-02T07:45:49Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSICKANSink.java", "diffHunk": "@@ -349,6 +346,7 @@ private void persistAggregation(NGSIGenericAggregator aggregator, String service\n                 aggregation += \",\" + jsonObject;\n             }\n         }\n+        //entityId=aggregator.getEntityId();", "originalCommit": "2fec1dcc982f4a027fa828b46e243d19ebf12873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MTU4OA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402171588", "bodyText": "fixed in b179bd5", "author": "VicenteLT", "createdAt": "2020-04-02T09:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNDA0Ng=="}], "type": "inlineReview"}, {"oid": "b179bd50cd3a0408217c4d5d0878910cc8530ce1", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/b179bd50cd3a0408217c4d5d0878910cc8530ce1", "message": "20200402 New CKAN DataModel - Remove entityId from GenericAggregator", "committedDate": "2020-04-02T08:59:37Z", "type": "commit"}, {"oid": "097cfc576625ab25cde9f08b66696f277716fd36", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/097cfc576625ab25cde9f08b66696f277716fd36", "message": "20200402 New CKAN DataModel - Update documentation", "committedDate": "2020-04-02T12:40:38Z", "type": "commit"}, {"oid": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "message": "20200402 New CKAN DataModel - Update documentacion 1.1", "committedDate": "2020-04-02T15:00:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjEyNA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402532124", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /*entityId\n          \n          \n            \n                /**\n          \n      \n    \n    \n  \n\nSeems to be a typo", "author": "fgalan", "createdAt": "2020-04-02T18:41:28Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSICKANSink.java", "diffHunk": "@@ -66,7 +67,7 @@\n     private String ckanViewer;\n     private CKANBackend persistenceBackend;\n \n-    /**\n+    /*entityId", "originalCommit": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyNzE3OQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r428727179", "bodyText": "Fixed in 0ab256e", "author": "IvanHdzC", "createdAt": "2020-05-21T15:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMzY3MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402533671", "bodyText": "Block seems to be missindented\n\nMabye some spaces vs. tab issue?", "author": "fgalan", "createdAt": "2020-04-02T18:44:07Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSICKANSink.java", "diffHunk": "@@ -442,22 +450,27 @@ public String buildPkgName(String fiwareService, String fiwareServicePath) throw\n      * @return Resource name\n      * @throws CygnusBadConfiguration\n      */\n-    public String buildResName(String entity) throws CygnusBadConfiguration {\n+    public String buildResName(String entity, String entityId) throws CygnusBadConfiguration {\n         String resName;\n-        \n-        if (enableEncoding) {\n-            resName = NGSICharsets.encodeCKAN(entity);\n-        } else {\n-            resName = NGSIUtils.encode(entity, false, true).toLowerCase(Locale.ENGLISH);\n-        } // if else\n+        switch(dataModel) {\n+            case DMBYENTITYID:\n+            \tresName=entityId;\n+                break;\n+        default:\n+            if (enableEncoding) {\n+                resName = NGSICharsets.encodeCKAN(entity);\n+            } else {\n+                resName = NGSIUtils.encode(entity, false, true).toLowerCase(Locale.ENGLISH);\n+            } // if else", "originalCommit": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyNzc0MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r428727741", "bodyText": "Fixed in 1651f0d", "author": "IvanHdzC", "createdAt": "2020-05-21T15:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMzY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDM3Mw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402534373", "bodyText": "Missidentent block:\n\nMaybe some \"spaces vs. tabs\" issue?", "author": "fgalan", "createdAt": "2020-04-02T18:45:21Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSISink.java", "diffHunk": "@@ -871,6 +874,37 @@ private void accumulateByEntityType(NGSIEvent event) {\n             batch.addEvent(destination, event);\n         } // accumulateByEntityType\n \n+        private void accumulateByEntityId(NGSIEvent event) {\n+        \tMap<String, String> headers = event.getHeaders();\n+            ContextElement originalCE = event.getOriginalCE();\n+            ContextElement mappedCE = event.getMappedCE();", "originalCommit": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NzMxMg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402547312", "bodyText": "(In general, I think the code should be reviewed for indent problems... not sure if the ones I have commented in this PR are the only ones. They are easy to find with a carfeful examination of https://github.com/telefonicaid/fiware-cygnus/pull/1850/files).", "author": "fgalan", "createdAt": "2020-04-02T19:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODAxOA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r428728018", "bodyText": "Fixed in 72fd80e", "author": "IvanHdzC", "createdAt": "2020-05-21T15:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NTYxOQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402545619", "bodyText": "As far as I understand (according to https://github.com/telefonicaid/fiware-cygnus/pull/1850/files#diff-7d759ac06f173f8e331ae811fbf231c7R354) CKAN sink support two modes: dm-by-entity-id and dm-by-entity. I see the following pattern in this PR (in several places):\n        switch(dataModel) {\n            case DMBYENTITYID:\n                // Code for processing the dm-by-entity-id case\n                break;\n            default:\n                // Code for processing the dm-by-entity\n                break;\n\nHowever, I'd suggest a more extensible and robuts approach:\n        switch(dataModel) {\n            case DMBYENTITYID:\n                // Code for processing the dm-by-entity-id case\n                break;\n            case DMBYENTITY:\n                // Code for processing the dm-by-entity\n                break;\n            default:\n                // Deal with the error of trying to use an unsupported mode (log, etc.)\n                break;", "author": "fgalan", "createdAt": "2020-04-02T19:04:17Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSICKANSink.java", "diffHunk": "@@ -409,29 +411,35 @@ public String buildOrgName(String fiwareService) throws CygnusBadConfiguration {\n      * @return Package name\n      * @throws CygnusBadConfiguration\n      */\n-    public String buildPkgName(String fiwareService, String fiwareServicePath) throws CygnusBadConfiguration {\n+    public String buildPkgName(String fiwareService, String fiwareServicePath, String entityId) throws CygnusBadConfiguration {\n         String pkgName;\n         \n-        if (enableEncoding) {\n-            pkgName = NGSICharsets.encodeCKAN(fiwareService)\n-                    + CommonConstants.CONCATENATOR\n-                    + NGSICharsets.encodeCKAN(fiwareServicePath);\n-        } else {\n-            if (fiwareServicePath.equals(\"/\")) {\n-                pkgName = NGSIUtils.encode(fiwareService, false, true).toLowerCase(Locale.ENGLISH);\n-            } else {\n-                pkgName = (NGSIUtils.encode(fiwareService, false, true)\n-                        + NGSIUtils.encode(fiwareServicePath, false, true)).toLowerCase(Locale.ENGLISH);\n-            } // if else\n-        } // if else\n-\n-        if (pkgName.length() > NGSIConstants.CKAN_MAX_NAME_LEN) {\n-            throw new CygnusBadConfiguration(\"Building package name '\" + pkgName + \"' and its length is \"\n-                    + \"greater than \" + NGSIConstants.CKAN_MAX_NAME_LEN);\n-        } else if (pkgName.length() < NGSIConstants.CKAN_MIN_NAME_LEN) {\n-            throw new CygnusBadConfiguration(\"Building package name '\" + pkgName + \"' and its length is \"\n-                    + \"lower than \" + NGSIConstants.CKAN_MIN_NAME_LEN);\n-        } // if else if\n+        switch(dataModel) {", "originalCommit": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcxMzQ4Nw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r428713487", "bodyText": "Fixed in 1651f0d", "author": "IvanHdzC", "createdAt": "2020-05-21T15:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0Njc0NQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402546745", "bodyText": "Maybe is a na\u00efve question :) but... where is the code that translate the string \"dm-by-entity-id\" to DMBYENTITYID ? Is some kind of generic uppercase + dash removal function?", "author": "fgalan", "createdAt": "2020-04-02T19:06:19Z", "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/sinks/Enums.java", "diffHunk": "@@ -14,6 +14,6 @@\n     /**\n      * Available data models for all the sinks.\n      */\n-    public enum DataModel { DMBYSERVICE, DMBYSERVICEPATH, DMBYENTITY, DMBYENTITYTYPE, DMBYATTRIBUTE }\n+    public enum DataModel { DMBYSERVICE, DMBYSERVICEPATH, DMBYENTITY, DMBYENTITYTYPE, DMBYATTRIBUTE, DMBYENTITYID }", "originalCommit": "aad6fe1d70613f27b5bae4ab36969c8fa512c61c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDU0Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r402990546", "bodyText": "In the configure method , in NGSISynk.java:\n@Override public void configure(Context context) { String dataModelStr = context.getString(\"data_model\", \"dm-by-entity\");", "author": "VicenteLT", "createdAt": "2020-04-03T13:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0Njc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcwMzM4Mg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1850#discussion_r428703382", "bodyText": "NGSISink read it on the agent properties and then CKAN sinks inherits it", "author": "IvanHdzC", "createdAt": "2020-05-21T14:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0Njc0NQ=="}], "type": "inlineReview"}, {"oid": "8a42a4f89d88cdca418e4826ec96eb7c77471259", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8a42a4f89d88cdca418e4826ec96eb7c77471259", "message": "Update CHANGES_NEXT_RELEASE\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-21T14:41:28Z", "type": "commit"}, {"oid": "0ab256e454a652c3ec81c53c46be1cc41a9a0830", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0ab256e454a652c3ec81c53c46be1cc41a9a0830", "message": "Fix Typo\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-21T14:54:03Z", "type": "commit"}, {"oid": "1651f0dbeb116b8222d7fe9df90bd4d603b17b5e", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/1651f0dbeb116b8222d7fe9df90bd4d603b17b5e", "message": "edit switch cases to add a new default behaviour", "committedDate": "2020-05-21T15:03:54Z", "type": "commit"}, {"oid": "db4c369038e851be614e0c5e15585f31d3a1303a", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/db4c369038e851be614e0c5e15585f31d3a1303a", "message": "Fix Typo\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-21T15:06:11Z", "type": "commit"}, {"oid": "72fd80eef59c95ee8ade44adb2e4751144649009", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/72fd80eef59c95ee8ade44adb2e4751144649009", "message": "Fix indentation issue", "committedDate": "2020-05-21T15:12:14Z", "type": "commit"}, {"oid": "83e580235e2d7418961ce226505d1224b9f91432", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/83e580235e2d7418961ce226505d1224b9f91432", "message": "Merge branch 'master' into feature/1792_fix", "committedDate": "2020-05-21T15:33:52Z", "type": "commit"}, {"oid": "082929db96fee32ecdbab83c04a0393ad0962ba2", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/082929db96fee32ecdbab83c04a0393ad0962ba2", "message": "update docs", "committedDate": "2020-05-21T16:21:53Z", "type": "commit"}, {"oid": "63406ac96c73f988af1a78c91881848251c22a66", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/63406ac96c73f988af1a78c91881848251c22a66", "message": "update doc", "committedDate": "2020-05-22T08:55:50Z", "type": "commit"}, {"oid": "1ed14fea42ed73cb07423237d67dea78af326afe", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/1ed14fea42ed73cb07423237d67dea78af326afe", "message": "add FIXME notes", "committedDate": "2020-05-22T08:58:20Z", "type": "commit"}, {"oid": "a0373a8a5c2a17ab17f1703e953bb9b9598ddbed", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/a0373a8a5c2a17ab17f1703e953bb9b9598ddbed", "message": "Update doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_ckan_sink.md\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-22T09:04:54Z", "type": "commit"}, {"oid": "4a57860810552aee2b19859af7f21d61baa8f3ba", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/4a57860810552aee2b19859af7f21d61baa8f3ba", "message": "Update doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_ckan_sink.md\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-22T09:05:03Z", "type": "commit"}, {"oid": "176c8767ac28365ce902adf995661353e21ac7f7", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/176c8767ac28365ce902adf995661353e21ac7f7", "message": "Update doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_ckan_sink.md\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>", "committedDate": "2020-05-22T09:05:13Z", "type": "commit"}]}