{"pr_number": 3172, "pr_title": "Missing transmodel queries", "pr_createdAt": "2020-09-02T14:12:18Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172", "timeline": [{"oid": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "message": "Add find bike parks by envelope method", "committedDate": "2020-09-08T10:33:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3OTg1Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485079857", "bodyText": "Is it time to remove this TODO?", "author": "t2gran", "createdAt": "2020-09-08T17:21:57Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/stop/PlaceInterfaceType.java", "diffHunk": "@@ -38,17 +41,21 @@ public static GraphQLInterfaceType create(\n             .build())\n         .typeResolver(typeResolutionEnvironment -> {\n           Object o = typeResolutionEnvironment.getObject();\n+          GraphQLSchema schema = typeResolutionEnvironment.getSchema();\n \n           // TODO OTP2 - Add support for Station, osv", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTk2Ng==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485081966", "bodyText": "Why are these made none type safe?", "author": "t2gran", "createdAt": "2020-09-08T17:25:35Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/stop/PlaceInterfaceType.java", "diffHunk": "@@ -38,17 +41,21 @@ public static GraphQLInterfaceType create(\n             .build())\n         .typeResolver(typeResolutionEnvironment -> {\n           Object o = typeResolutionEnvironment.getObject();\n+          GraphQLSchema schema = typeResolutionEnvironment.getSchema();\n \n           // TODO OTP2 - Add support for Station, osv\n \n           if (o instanceof Stop) {\n-            return (GraphQLObjectType) quayType;\n+            return schema.getObjectType(\"Quay\");\n+          }\n+          if (o instanceof MonoOrMultiModalStation) {\n+            return schema.getObjectType(\"StopPlace\");\n           }\n           if (o instanceof BikeRentalStation) {\n-            return (GraphQLObjectType) bikeRentalStationType;\n+            return schema.getObjectType(\"BikeRentalStation\");\n           }\n           if (o instanceof BikePark) {\n-            return (GraphQLObjectType) bikeParkType;\n+            return schema.getObjectType(\"BikePark\");", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUwNTg5OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485505898", "bodyText": "Passing in the type itself in the constructor does not work, as the type has not been created yet and you need the actual type and not just a reference to it. That is why I get the type from the schema. This also follows how it is done in the LegacyGraphQLNodeTypeResolver.", "author": "gmellemstrand", "createdAt": "2020-09-09T10:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTk2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE1OTU3Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r486159573", "bodyText": "Ok, would like to add that as a comment?", "author": "t2gran", "createdAt": "2020-09-10T08:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4MTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NDcwNw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485084707", "bodyText": "I would have pushed the creation of the Envelope into the getBikeRentalStationForEnvelope method, passing in the 4 coordinates instead. Of cause this is an error in the API design not wrapping the coordinates in its own object of having a Envelop API type. Something to remember for the a new API.", "author": "t2gran", "createdAt": "2020-09-08T17:30:23Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLSchema.java", "diffHunk": "@@ -1595,7 +1489,16 @@ private GraphQLSchema create() {\n                 .name(\"maximumLongitude\")\n                 .type(Scalars.GraphQLFloat)\n                 .build())\n-            .dataFetcher(environment -> Collections.emptyList())\n+            .dataFetcher(environment -> GqlUtil\n+                .getRoutingService(environment)\n+                .getBikerentalStationService()\n+                .getBikeRentalStationForEnvelope(new Envelope(new Coordinate(\n+                    environment.getArgument(\"minimumLongitude\"),\n+                    environment.getArgument(\"minimumLatitude\")\n+                ), new Coordinate(\n+                    environment.getArgument(\"maximumLongitude\"),\n+                    environment.getArgument(\"maximumLatitude\")\n+                ))))", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUwNjU2MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485506561", "bodyText": "That's a fair point. I can change the method parameters for now, and we can think about how to do it in the new API.", "author": "gmellemstrand", "createdAt": "2020-09-09T10:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NDcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA4NjI5Ng==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485086296", "bodyText": "I am not sure if the type qualification is needed if this is moved into a mapper class...", "author": "t2gran", "createdAt": "2020-09-08T17:33:26Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/mapping/TransmodelMappingUtil.java", "diffHunk": "@@ -38,26 +38,26 @@ public ServiceDate secondsSinceEpochToServiceDate(Long secondsSinceEpoch) {\n     }\n \n \n-    // public List<PlaceType> mapPlaceTypes(List<TransmodelPlaceType> inputTypes) {\n-    //     if (inputTypes == null) {\n-    //         return null;\n-    //     }\n-    //\n-    //     return inputTypes.stream().map(pt -> mapPlaceType(pt)).distinct().collect(Collectors.toList());\n-    // }\n+     public static List<org.opentripplanner.routing.graphfinder.PlaceType> mapPlaceTypes(List<TransmodelPlaceType> inputTypes) {\n+         if (inputTypes == null) {\n+             return null;\n+         }\n \n-    private PlaceType mapPlaceType(TransmodelPlaceType transmodelType){\n+         return inputTypes.stream().map(TransmodelMappingUtil::mapPlaceType).distinct().collect(Collectors.toList());\n+     }\n+\n+    private static org.opentripplanner.routing.graphfinder.PlaceType mapPlaceType(TransmodelPlaceType transmodelType){\n         if (transmodelType!=null) {\n             switch (transmodelType) {\n                 case QUAY:\n                 case STOP_PLACE:\n-                    return PlaceType.STOP;\n+                    return org.opentripplanner.routing.graphfinder.PlaceType.STOP;\n                 case BICYCLE_RENT:\n-                    return PlaceType.BICYCLE_RENT;\n+                    return org.opentripplanner.routing.graphfinder.PlaceType.BICYCLE_RENT;\n                 case BIKE_PARK:\n-                    return PlaceType.BIKE_PARK;\n+                    return org.opentripplanner.routing.graphfinder.PlaceType.BIKE_PARK;\n                 case CAR_PARK:\n-                    return PlaceType.CAR_PARK;\n+                    return org.opentripplanner.routing.graphfinder.PlaceType.CAR_PARK;", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5MzM5NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485093394", "bodyText": "FYI: I plan to create a type-safe static resolver method for the ((PlaceAtDistance) environment.getSource()) like the:\nprivate static Trip trip(DataFetchingEnvironment environment) {\n    return environment.getSource();\n  }\n\nin ServiceJourneyType. It makes the code a bit easier to read, but I have not got around to refactor everything to use it. I hope extracting the data fetchers will help when we switch to a schema based approach later.", "author": "t2gran", "createdAt": "2020-09-08T17:46:34Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/stop/PlaceAtDistanceType.java", "diffHunk": "@@ -20,16 +22,16 @@ public static GraphQLObjectType create(Relay relay) {\n                   .dataFetcher(environment -> relay.toGlobalId(NAME, \"N/A\"))\n                   .build()\n           )\n-//                .field(GraphQLFieldDefinition.newFieldDefinition()\n-//                        .name(\"place\")\n-//                        .type(placeInterface)\n-//                        .dataFetcher(environment -> ((GraphIndex.PlaceAndDistance) environment.getSource()).place)\n-//                        .build())\n-//                .field(GraphQLFieldDefinition.newFieldDefinition()\n-//                        .name(\"distance\")\n-//                        .type(Scalars.GraphQLInt)\n-//                        .dataFetcher(environment -> ((GraphIndex.PlaceAndDistance) environment.getSource()).distance)\n-//                        .build())\n+                .field(GraphQLFieldDefinition.newFieldDefinition()\n+                        .name(\"place\")\n+                        .type(placeInterface)\n+                        .dataFetcher(environment -> ((PlaceAtDistance) environment.getSource()).place)\n+                        .build())", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5NjE3NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485096175", "bodyText": "Can this be moved somewhere else? I would like this class to the \"index\" to the Schema types - wiring the Schema together. Mapping, resolving and fetching data should be some where else.", "author": "t2gran", "createdAt": "2020-09-08T17:51:38Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLSchema.java", "diffHunk": "@@ -1745,43 +1648,51 @@ private GraphQLSchema create() {\n \n \n \n+    /**\n+     * Create PlaceAndDistance objects for all unique stopPlaces according to specified multiModalMode if client has requested stopPlace type.\n+     *\n+     * Necessary because nearest does not support StopPlace (stations), so we need to fetch quays instead and map the response.\n+     *\n+     * Remove PlaceAndDistance objects for quays if client has not requested these.\n+     */\n+    private List<PlaceAtDistance> convertQuaysToStopPlaces(List<TransmodelPlaceType> placeTypes, List<PlaceAtDistance> places, String multiModalMode, RoutingService routingService) {", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMjcyMw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r485102723", "bodyText": "I think we should rename this type to InputPlaceIds, the name here is bad it does not reflect what it is, but the roll it plays in the one situation it is used. The name is defined in a global space and the name is fare too generic.", "author": "t2gran", "createdAt": "2020-09-08T18:04:07Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLSchema.java", "diffHunk": "@@ -680,34 +697,34 @@ private GraphQLSchema create() {\n //                        .build())\n //                .build();\n \n-//        GraphQLInputObjectType filterInputType = GraphQLInputObjectType.newInputObject()\n-//                .name(\"InputFilters\")\n-//                .field(GraphQLInputObjectField.newInputObjectField()\n-//                        .name(\"quays\")\n-//                        .description(\"Quays to include by id.\")\n-//                        .type(new GraphQLList(Scalars.GraphQLString))\n-//                        .build())\n-//                .field(GraphQLInputObjectField.newInputObjectField()\n-//                        .name(\"lines\")\n-//                        .description(\"Lines to include by id.\")\n-//                        .type(new GraphQLList(Scalars.GraphQLString))\n-//                        .build())\n-//                .field(GraphQLInputObjectField.newInputObjectField()\n-//                        .name(\"bikeRentalStations\")\n-//                        .description(\"Bike rentals to include by id.\")\n-//                        .type(new GraphQLList(Scalars.GraphQLString))\n-//                        .build())\n-//                .field(GraphQLInputObjectField.newInputObjectField()\n-//                        .name(\"bikeParks\")\n-//                        .description(\"Bike parks to include by id.\")\n-//                        .type(new GraphQLList(Scalars.GraphQLString))\n-//                        .build())\n-//                .field(GraphQLInputObjectField.newInputObjectField()\n-//                        .name(\"carParks\")\n-//                        .description(\"Car parks to include by id.\")\n-//                        .type(new GraphQLList(Scalars.GraphQLString))\n-//                        .build())\n-//                .build();\n+        GraphQLInputObjectType filterInputType = GraphQLInputObjectType.newInputObject()\n+                .name(\"InputFilters\")", "originalCommit": "a62d2cb9148bb9237e3d6e01ede1e4e0c422f229", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44f9022612fc994de1b987ebb581608e0062d0d2", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/44f9022612fc994de1b987ebb581608e0062d0d2", "message": "Change name of filterPlaceIds to inputPlaceIds", "committedDate": "2020-09-09T13:07:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4MDc4OQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r487980789", "bodyText": "Include that this should never be set higher than walkReluctance since that would lead to walking down the line to avoid waiting.", "author": "t2gran", "createdAt": "2020-09-14T14:34:19Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/TransmodelGraphQLSchema.java", "diffHunk": "@@ -623,6 +623,12 @@ private GraphQLSchema create() {\n                         .type(Scalars.GraphQLFloat)\n                         .defaultValue(routing.request.walkReluctance)\n                         .build())\n+                .argument(GraphQLArgument.newArgument()\n+                        .name(\"waitReluctance\")\n+                        .description(\"Wait cost is multiplied by this value. Setting this to a value lower than 1 indicates that waiting is better than staying on a vehicle.\")\n+                        .type(Scalars.GraphQLFloat)", "originalCommit": "4d085184e6ff8b49f2cff11970bcfb5bb63a76c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNjIwMg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3172#discussion_r491006202", "bodyText": ".type(gqlUtil.doubleFunctionScalar)", "author": "t2gran", "createdAt": "2020-09-18T14:55:08Z", "path": "src/ext/java/org/opentripplanner/ext/transmodelapi/model/DefaultRoutingRequestType.java", "diffHunk": "@@ -401,6 +401,12 @@ private GraphQLObjectType createGraphQLType() {\n                         .type(Scalars.GraphQLBoolean)\n                         .dataFetcher(env -> request.geoidElevation)\n                         .build())\n+                .field(GraphQLFieldDefinition.newFieldDefinition()\n+                        .name(\"transitGeneralizedCostLimit\")\n+                        .description(\"A relative maximum limit for the generalized cost for transit itineraries. The limit is a linear function of the minimum generalized-cost.\")\n+                        .type(Scalars.GraphQLString)", "originalCommit": "b1a1336073ed85081884de0c460e0c1d81bba017", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb21bc564f1cf56864cabb35a48143968fbd6658", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/eb21bc564f1cf56864cabb35a48143968fbd6658", "message": "Reimplement transmodel nearest search", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "6906d8f86cccea23ec23c1e34f026848b5444f6c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6906d8f86cccea23ec23c1e34f026848b5444f6c", "message": "Add find bike parks by envelope method", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "3ba17e41a2dab2cb5d4d7cc2f5da02015ec7def4", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3ba17e41a2dab2cb5d4d7cc2f5da02015ec7def4", "message": "Remove TODO", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "562e67f2f5f93aafb79ba79c0df4fb9fdadfb9da", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/562e67f2f5f93aafb79ba79c0df4fb9fdadfb9da", "message": "Fixed import on TransmodelMappingUtil", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "e40e1f905a39f3cc4ecb9e78f571326d86d189fe", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e40e1f905a39f3cc4ecb9e78f571326d86d189fe", "message": "Move convertQuaysToStopPlaces method to the TransmodelMappingUtil class", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "8c1113590cf501048e94786c7ec1a2e934f1c6b5", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/8c1113590cf501048e94786c7ec1a2e934f1c6b5", "message": "Change name of filterPlaceIds to inputPlaceIds", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "687cefc807c7b5c7debfb1fc51e90e959aec3dc1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/687cefc807c7b5c7debfb1fc51e90e959aec3dc1", "message": "Added comment and removed unused parameters in PlaceInterfaceType", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "3de354717f48ee3a10d362903184dc10254d7890", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3de354717f48ee3a10d362903184dc10254d7890", "message": "Update TransmodelMappingUtil.java\n\nAdd TODO to remember to refactor the TransmodelMappingUtil.", "committedDate": "2020-09-29T12:57:34Z", "type": "commit"}, {"oid": "40eb64809ca2709a3fe84351ad616940d4a84d57", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/40eb64809ca2709a3fe84351ad616940d4a84d57", "message": "Clean code - delete the TransmodelMappingUtil class, and move the functionality into more appropriate domain specific places.", "committedDate": "2020-09-29T13:02:40Z", "type": "commit"}, {"oid": "b8ebf8cc91ea3408f7c1c38f3c92e8b1acd5ff44", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b8ebf8cc91ea3408f7c1c38f3c92e8b1acd5ff44", "message": "Change parameters in getBikeRentalStationsForEnvelope", "committedDate": "2020-09-29T13:02:40Z", "type": "commit"}, {"oid": "7d460cc97fcf355bb2227dc71e9fb7f1f3ab4023", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/7d460cc97fcf355bb2227dc71e9fb7f1f3ab4023", "message": "Add wait reluctance parameter to transmodel api", "committedDate": "2020-09-29T13:02:40Z", "type": "commit"}, {"oid": "3fd042111ec0225888b65bef32c37dad222b559a", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3fd042111ec0225888b65bef32c37dad222b559a", "message": "Add routingParameters-transitGeneralizedCostLimit to transmodel API", "committedDate": "2020-09-29T13:02:40Z", "type": "commit"}, {"oid": "2b69b774746c4a2c0843944dac75c26a5036734e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2b69b774746c4a2c0843944dac75c26a5036734e", "message": "Updated transmodel api waitReluctance doc", "committedDate": "2020-09-29T13:02:40Z", "type": "commit"}, {"oid": "2b69b774746c4a2c0843944dac75c26a5036734e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2b69b774746c4a2c0843944dac75c26a5036734e", "message": "Updated transmodel api waitReluctance doc", "committedDate": "2020-09-29T13:02:40Z", "type": "forcePushed"}]}