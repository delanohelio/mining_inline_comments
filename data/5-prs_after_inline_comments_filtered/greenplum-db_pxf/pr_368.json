{"pr_number": 368, "pr_title": "Migrate pxf-hbase to Spring Boot", "pr_createdAt": "2020-06-04T17:51:04Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/368", "timeline": [{"oid": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "url": "https://github.com/greenplum-db/pxf/commit/16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "message": "Migrate pxf-hbase to Spring Boot\n\n- Update top level build.gradle to include pxf-hbase\n- Add new build.gradle for pxf-hbase\n- all existing unit tests should be ported to junit 5\n- all automation tests for HBase should be working", "committedDate": "2020-06-04T17:48:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NzY2NQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435467665", "bodyText": "when will this be uncommented ?", "author": "denalex", "createdAt": "2020-06-04T18:34:05Z", "path": "automation/src/main/java/org/greenplum/pxf/automation/testplugin/MultipleHiveFragmentsPerFileFragmenter.java", "diffHunk": "@@ -1,122 +1,122 @@\n-package org.greenplum.pxf.automation.testplugin;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.apache.hadoop.fs.Path;\n-import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n-import org.apache.hadoop.hive.metastore.MetaStoreUtils;\n-import org.apache.hadoop.hive.metastore.api.StorageDescriptor;\n-import org.apache.hadoop.hive.metastore.api.Table;\n-import org.apache.hadoop.mapred.FileInputFormat;\n-import org.apache.hadoop.mapred.FileSplit;\n-import org.apache.hadoop.mapred.InputFormat;\n-import org.apache.hadoop.mapred.InputSplit;\n-import org.apache.hadoop.mapred.JobConf;\n-import org.greenplum.pxf.api.model.BaseFragmenter;\n-import org.greenplum.pxf.api.model.Fragment;\n-import org.greenplum.pxf.api.model.Metadata;\n-import org.greenplum.pxf.api.model.RequestContext;\n-import org.greenplum.pxf.plugins.hive.HiveClientWrapper;\n-import org.greenplum.pxf.plugins.hive.HiveDataFragmenter;\n-import org.greenplum.pxf.plugins.hive.HiveUserData;\n-\n-import java.io.ByteArrayOutputStream;\n-import java.io.ObjectOutputStream;\n-import java.util.List;\n-import java.util.Properties;\n-\n-\n-/**\n- * Fragmenter which splits one file into multiple fragments. Helps to simulate a\n- * case of big files.\n- * <p>\n- * inputData has to have following parameters:\n- * TEST-FRAGMENTS-NUM - defines how many fragments will be returned for current file\n- */\n-public class MultipleHiveFragmentsPerFileFragmenter extends BaseFragmenter {\n-    private static final Log LOG = LogFactory.getLog(MultipleHiveFragmentsPerFileFragmenter.class);\n-\n-    private static final long SPLIT_SIZE = 1024;\n-    private JobConf jobConf;\n-    private IMetaStoreClient client;\n-    private HiveClientWrapper hiveClientWrapper;\n-\n-    public MultipleHiveFragmentsPerFileFragmenter() {\n-        hiveClientWrapper = HiveClientWrapper.getInstance();\n-    }\n-\n-    @Override\n-    public void initialize(RequestContext context) {\n-        super.initialize(context);\n-        jobConf = new JobConf(configuration, MultipleHiveFragmentsPerFileFragmenter.class);\n-        client = hiveClientWrapper.initHiveClient(context, configuration);\n-    }\n-\n-    @Override\n-    public List<Fragment> getFragments() throws Exception {\n-        String localhostname = java.net.InetAddress.getLocalHost().getHostName();\n-        String[] localHosts = new String[]{localhostname, localhostname};\n-\n-        // TODO whitelist property\n-        int fragmentsNum = Integer.parseInt(context.getOption(\"TEST-FRAGMENTS-NUM\"));\n-        Metadata.Item tblDesc = hiveClientWrapper.extractTableFromName(context.getDataSource());\n-        Table tbl = hiveClientWrapper.getHiveTable(client, tblDesc);\n-        Properties properties = getSchema(tbl);\n-\n-        for (int i = 0; i < fragmentsNum; i++) {\n-\n-            String userData = \"inputFormatName\" + HiveUserData.HIVE_UD_DELIM\n-                    + tbl.getSd().getSerdeInfo().getSerializationLib()\n-                    + HiveUserData.HIVE_UD_DELIM + \"propertiesString\"\n-                    + HiveUserData.HIVE_UD_DELIM + HiveDataFragmenter.HIVE_NO_PART_TBL\n-                    + HiveUserData.HIVE_UD_DELIM + \"filterInFragmenter\"\n-                    + HiveUserData.HIVE_UD_DELIM + \"delimiter\"\n-                    + HiveUserData.HIVE_UD_DELIM + properties.getProperty(\"columns.types\");\n-\n-            ByteArrayOutputStream bas = new ByteArrayOutputStream();\n-            ObjectOutputStream os = new ObjectOutputStream(bas);\n-            os.writeLong(i * SPLIT_SIZE); // start\n-            os.writeLong(SPLIT_SIZE); // length\n-            os.writeObject(localHosts); // hosts\n-            os.close();\n-\n-            String filePath = getFilePath(tbl);\n-\n-            fragments.add(new Fragment(filePath, localHosts, bas.toByteArray(), userData.getBytes()));\n-        }\n-\n-        return fragments;\n-    }\n-\n-\n-    private static Properties getSchema(Table table) {\n-        return MetaStoreUtils.getSchema(table.getSd(), table.getSd(),\n-                table.getParameters(), table.getDbName(), table.getTableName(),\n-                table.getPartitionKeys());\n-    }\n-\n-    private String getFilePath(Table tbl) throws Exception {\n-\n-        StorageDescriptor descTable = tbl.getSd();\n-\n-        InputFormat<?, ?> fformat = HiveDataFragmenter.makeInputFormat(descTable.getInputFormat(), jobConf);\n-\n-        FileInputFormat.setInputPaths(jobConf, new Path(descTable.getLocation()));\n-\n-        InputSplit[] splits;\n-        try {\n-            splits = fformat.getSplits(jobConf, 1);\n-        } catch (org.apache.hadoop.mapred.InvalidInputException e) {\n-            LOG.debug(\"getSplits failed on \" + e.getMessage());\n-            throw new RuntimeException(\"Unable to get file path for table.\");\n-        }\n-\n-        for (InputSplit split : splits) {\n-            FileSplit fsp = (FileSplit) split;\n-            String[] hosts = fsp.getLocations();\n-            String filepath = fsp.getPath().toString();\n-            return filepath;\n-        }\n-        throw new RuntimeException(\"Unable to get file path for table.\");\n-    }\n-}\n+//package org.greenplum.pxf.automation.testplugin;\n+//\n+//import org.apache.commons.logging.Log;\n+//import org.apache.commons.logging.LogFactory;\n+//import org.apache.hadoop.fs.Path;\n+//import org.apache.hadoop.hive.metastore.IMetaStoreClient;\n+//import org.apache.hadoop.hive.metastore.MetaStoreUtils;\n+//import org.apache.hadoop.hive.metastore.api.StorageDescriptor;\n+//import org.apache.hadoop.hive.metastore.api.Table;\n+//import org.apache.hadoop.mapred.FileInputFormat;\n+//import org.apache.hadoop.mapred.FileSplit;\n+//import org.apache.hadoop.mapred.InputFormat;\n+//import org.apache.hadoop.mapred.InputSplit;\n+//import org.apache.hadoop.mapred.JobConf;\n+//import org.greenplum.pxf.api.model.BaseFragmenter;\n+//import org.greenplum.pxf.api.model.Fragment;\n+//import org.greenplum.pxf.api.model.Metadata;\n+//import org.greenplum.pxf.api.model.RequestContext;\n+//import org.greenplum.pxf.plugins.hive.HiveClientWrapper;\n+//import org.greenplum.pxf.plugins.hive.HiveDataFragmenter;\n+//import org.greenplum.pxf.plugins.hive.HiveUserData;\n+//\n+//import java.io.ByteArrayOutputStream;\n+//import java.io.ObjectOutputStream;\n+//import java.util.List;\n+//import java.util.Properties;\n+//\n+//\n+///**\n+// * Fragmenter which splits one file into multiple fragments. Helps to simulate a\n+// * case of big files.\n+// * <p>\n+// * inputData has to have following parameters:\n+// * TEST-FRAGMENTS-NUM - defines how many fragments will be returned for current file\n+// */\n+//public class MultipleHiveFragmentsPerFileFragmenter extends BaseFragmenter {\n+//    private static final Log LOG = LogFactory.getLog(MultipleHiveFragmentsPerFileFragmenter.class);\n+//\n+//    private static final long SPLIT_SIZE = 1024;\n+//    private JobConf jobConf;\n+//    private IMetaStoreClient client;\n+//    private HiveClientWrapper hiveClientWrapper;\n+//\n+//    public MultipleHiveFragmentsPerFileFragmenter() {\n+//        hiveClientWrapper = HiveClientWrapper.getInstance();\n+//    }\n+//\n+//    @Override\n+//    public void initialize(RequestContext context) {\n+//        super.initialize(context);\n+//        jobConf = new JobConf(configuration, MultipleHiveFragmentsPerFileFragmenter.class);\n+//        client = hiveClientWrapper.initHiveClient(context, configuration);\n+//    }\n+//\n+//    @Override\n+//    public List<Fragment> getFragments() throws Exception {\n+//        String localhostname = java.net.InetAddress.getLocalHost().getHostName();\n+//        String[] localHosts = new String[]{localhostname, localhostname};\n+//\n+//        // TODO whitelist property\n+//        int fragmentsNum = Integer.parseInt(context.getOption(\"TEST-FRAGMENTS-NUM\"));\n+//        Metadata.Item tblDesc = hiveClientWrapper.extractTableFromName(context.getDataSource());\n+//        Table tbl = hiveClientWrapper.getHiveTable(client, tblDesc);\n+//        Properties properties = getSchema(tbl);\n+//\n+//        for (int i = 0; i < fragmentsNum; i++) {\n+//\n+//            String userData = \"inputFormatName\" + HiveUserData.HIVE_UD_DELIM\n+//                    + tbl.getSd().getSerdeInfo().getSerializationLib()\n+//                    + HiveUserData.HIVE_UD_DELIM + \"propertiesString\"\n+//                    + HiveUserData.HIVE_UD_DELIM + HiveDataFragmenter.HIVE_NO_PART_TBL\n+//                    + HiveUserData.HIVE_UD_DELIM + \"filterInFragmenter\"\n+//                    + HiveUserData.HIVE_UD_DELIM + \"delimiter\"\n+//                    + HiveUserData.HIVE_UD_DELIM + properties.getProperty(\"columns.types\");\n+//\n+//            ByteArrayOutputStream bas = new ByteArrayOutputStream();\n+//            ObjectOutputStream os = new ObjectOutputStream(bas);\n+//            os.writeLong(i * SPLIT_SIZE); // start\n+//            os.writeLong(SPLIT_SIZE); // length\n+//            os.writeObject(localHosts); // hosts\n+//            os.close();\n+//\n+//            String filePath = getFilePath(tbl);\n+//\n+//            fragments.add(new Fragment(filePath, localHosts, bas.toByteArray(), userData.getBytes()));\n+//        }\n+//\n+//        return fragments;\n+//    }\n+//\n+//\n+//    private static Properties getSchema(Table table) {\n+//        return MetaStoreUtils.getSchema(table.getSd(), table.getSd(),\n+//                table.getParameters(), table.getDbName(), table.getTableName(),\n+//                table.getPartitionKeys());\n+//    }\n+//\n+//    private String getFilePath(Table tbl) throws Exception {\n+//\n+//        StorageDescriptor descTable = tbl.getSd();\n+//\n+//        InputFormat<?, ?> fformat = HiveDataFragmenter.makeInputFormat(descTable.getInputFormat(), jobConf);\n+//\n+//        FileInputFormat.setInputPaths(jobConf, new Path(descTable.getLocation()));\n+//\n+//        InputSplit[] splits;\n+//        try {\n+//            splits = fformat.getSplits(jobConf, 1);\n+//        } catch (org.apache.hadoop.mapred.InvalidInputException e) {\n+//            LOG.debug(\"getSplits failed on \" + e.getMessage());\n+//            throw new RuntimeException(\"Unable to get file path for table.\");\n+//        }\n+//\n+//        for (InputSplit split : splits) {\n+//            FileSplit fsp = (FileSplit) split;\n+//            String[] hosts = fsp.getLocations();\n+//            String filepath = fsp.getPath().toString();\n+//            return filepath;\n+//        }\n+//        throw new RuntimeException(\"Unable to get file path for table.\");\n+//    }\n+//}", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NjExNQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435486115", "bodyText": "In the PR message I state that we intentionally comment out the automation tests for Hive, which should be restored with the inclusion of the pxf-hive profile. . So with the pxf-hive profile, these classes have to be uncommented", "author": "frankgh", "createdAt": "2020-06-04T19:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc4Ng==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435467786", "bodyText": "when will this be uncommented ?", "author": "denalex", "createdAt": "2020-06-04T18:34:15Z", "path": "automation/src/main/java/org/greenplum/pxf/automation/testplugin/HiveInputFormatFragmenterWithFilter.java", "diffHunk": "@@ -1,35 +1,35 @@\n-package org.greenplum.pxf.automation.testplugin;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.greenplum.pxf.api.model.RequestContext;\n-import org.greenplum.pxf.plugins.hive.HiveInputFormatFragmenter;\n-\n-public class HiveInputFormatFragmenterWithFilter extends HiveInputFormatFragmenter {\n-\n-    private static final Log LOG = LogFactory.getLog(HiveInputFormatFragmenterWithFilter.class);\n-\n-    @Override\n-    public void initialize(RequestContext requestContext) {\n-        super.initialize(requestContext);\n-        addFilters();  // Set the test hive filter (overwrite gpdb filter)\n-    }\n-\n-    /*\n-     *  Ignores filter from gpdb, use user defined filter\n-     *  Set the protected filterString by reflection (only for regression, dont want to modify the original code)\n-     */\n-    private void addFilters() {\n-\n-        // TODO: whitelist the option\n-        String filterStr = context.getOption(\"TEST-HIVE-FILTER\");\n-        LOG.debug(\"user defined filter: \" + filterStr);\n-        if ((filterStr == null) || filterStr.isEmpty() || \"null\".equals(filterStr))\n-            return;\n-\n-            context.setFilterString(filterStr);\n-            LOG.debug(\"User defined filter: \" + context.getFilterString());\n-\n-            LOG.debug(\"User defined filter: \" + context.hasFilter());\n-    }\n-}\n+//package org.greenplum.pxf.automation.testplugin;\n+//\n+//import org.apache.commons.logging.Log;\n+//import org.apache.commons.logging.LogFactory;\n+//import org.greenplum.pxf.api.model.RequestContext;\n+//import org.greenplum.pxf.plugins.hive.HiveInputFormatFragmenter;\n+//\n+//public class HiveInputFormatFragmenterWithFilter extends HiveInputFormatFragmenter {\n+//\n+//    private static final Log LOG = LogFactory.getLog(HiveInputFormatFragmenterWithFilter.class);\n+//\n+//    @Override\n+//    public void initialize(RequestContext requestContext) {\n+//        super.initialize(requestContext);\n+//        addFilters();  // Set the test hive filter (overwrite gpdb filter)\n+//    }\n+//\n+//    /*\n+//     *  Ignores filter from gpdb, use user defined filter\n+//     *  Set the protected filterString by reflection (only for regression, dont want to modify the original code)\n+//     */\n+//    private void addFilters() {\n+//\n+//        // TODO: whitelist the option\n+//        String filterStr = context.getOption(\"TEST-HIVE-FILTER\");\n+//        LOG.debug(\"user defined filter: \" + filterStr);\n+//        if ((filterStr == null) || filterStr.isEmpty() || \"null\".equals(filterStr))\n+//            return;\n+//\n+//            context.setFilterString(filterStr);\n+//            LOG.debug(\"User defined filter: \" + context.getFilterString());\n+//\n+//            LOG.debug(\"User defined filter: \" + context.hasFilter());\n+//    }\n+//}", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTI3MA==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435495270", "bodyText": "it will be uncommented with pxf-hive", "author": "frankgh", "createdAt": "2020-06-04T19:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzg3MQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435467871", "bodyText": "when will this be uncommented ?", "author": "denalex", "createdAt": "2020-06-04T18:34:21Z", "path": "automation/src/main/java/org/greenplum/pxf/automation/testplugin/HiveDataFragmenterWithFilter.java", "diffHunk": "@@ -1,35 +1,35 @@\n-package org.greenplum.pxf.automation.testplugin;\n-\n-import org.apache.commons.logging.Log;\n-import org.apache.commons.logging.LogFactory;\n-import org.greenplum.pxf.api.model.RequestContext;\n-import org.greenplum.pxf.plugins.hive.HiveDataFragmenter;\n-\n-public class HiveDataFragmenterWithFilter extends HiveDataFragmenter {\n-\n-    private static final Log LOG = LogFactory.getLog(HiveDataFragmenterWithFilter.class);\n-\n-    @Override\n-    public void initialize(RequestContext requestContext) {\n-        super.initialize(requestContext);\n-        addFilters();  // Set the test hive filter (overwrite gpdb filter)\n-    }\n-\n-    /*\n-     *  Ignores filter from gpdb, use user defined filter\n-     *  Set the protected filterString by reflection (only for regression, dont want to modify the original code)\n-     */\n-    private void addFilters() {\n-\n-        //TODO whitelist the option\n-        String filterStr = context.getOption(\"TEST-HIVE-FILTER\");\n-        LOG.debug(\"user defined filter: \" + filterStr);\n-        if ((filterStr == null) || filterStr.isEmpty() || \"null\".equals(filterStr))\n-            return;\n-\n-        context.setFilterString(filterStr);\n-        LOG.debug(\"User defined filter: \" + context.getFilterString());\n-\n-        LOG.debug(\"User defined filter: \" + context.hasFilter());\n-    }\n-}\n+//package org.greenplum.pxf.automation.testplugin;\n+//\n+//import org.apache.commons.logging.Log;\n+//import org.apache.commons.logging.LogFactory;\n+//import org.greenplum.pxf.api.model.RequestContext;\n+//import org.greenplum.pxf.plugins.hive.HiveDataFragmenter;\n+//\n+//public class HiveDataFragmenterWithFilter extends HiveDataFragmenter {\n+//\n+//    private static final Log LOG = LogFactory.getLog(HiveDataFragmenterWithFilter.class);\n+//\n+//    @Override\n+//    public void initialize(RequestContext requestContext) {\n+//        super.initialize(requestContext);\n+//        addFilters();  // Set the test hive filter (overwrite gpdb filter)\n+//    }\n+//\n+//    /*\n+//     *  Ignores filter from gpdb, use user defined filter\n+//     *  Set the protected filterString by reflection (only for regression, dont want to modify the original code)\n+//     */\n+//    private void addFilters() {\n+//\n+//        //TODO whitelist the option\n+//        String filterStr = context.getOption(\"TEST-HIVE-FILTER\");\n+//        LOG.debug(\"user defined filter: \" + filterStr);\n+//        if ((filterStr == null) || filterStr.isEmpty() || \"null\".equals(filterStr))\n+//            return;\n+//\n+//        context.setFilterString(filterStr);\n+//        LOG.debug(\"User defined filter: \" + context.getFilterString());\n+//\n+//        LOG.debug(\"User defined filter: \" + context.hasFilter());\n+//    }\n+//}", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTE4MA==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435495180", "bodyText": "it will be uncommented with pxf-hive", "author": "frankgh", "createdAt": "2020-06-04T19:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2ODYzNg==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435468636", "bodyText": "this does not need @JsonCreator because it has a single argument constructor and there's only 1 property ?", "author": "denalex", "createdAt": "2020-06-04T18:35:17Z", "path": "automation/src/main/java/org/greenplum/pxf/automation/testplugin/FilterVerifyFragmentMetadata.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package org.greenplum.pxf.automation.testplugin;\n+\n+import org.greenplum.pxf.api.utilities.FragmentMetadata;\n+\n+public class FilterVerifyFragmentMetadata implements FragmentMetadata {", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NjI0Ng==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435486246", "bodyText": "correct", "author": "frankgh", "createdAt": "2020-06-04T19:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2ODYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NDQ2NQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435474465", "bodyText": "wonder how serialized byte[] looks like in JSON ? Is it a base64 encoded string ?", "author": "denalex", "createdAt": "2020-06-04T18:42:50Z", "path": "server/pxf-hbase/src/main/java/org/greenplum/pxf/plugins/hbase/HBaseFragmentMetadata.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package org.greenplum.pxf.plugins.hbase;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.Getter;\n+import org.apache.hadoop.hbase.HRegionInfo;\n+import org.codehaus.jackson.annotate.JsonCreator;\n+import org.greenplum.pxf.api.utilities.FragmentMetadata;\n+\n+import java.util.Map;\n+\n+public class HBaseFragmentMetadata implements FragmentMetadata {\n+\n+    @Getter\n+    private final byte[] startKey;\n+\n+    @Getter\n+    private final byte[] endKey;\n+\n+    @Getter\n+    private final Map<String, byte[]> columnMapping;\n+\n+    public HBaseFragmentMetadata(HRegionInfo region, Map<String, byte[]> columnMapping) {\n+        this(region.getStartKey(), region.getEndKey(), columnMapping);\n+    }\n+\n+    @JsonCreator\n+    public HBaseFragmentMetadata(\n+            @JsonProperty(\"startKey\") byte[] startKey,", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MDIyNw==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435490227", "bodyText": "i will add some tests to see what the output looks like", "author": "frankgh", "createdAt": "2020-06-04T19:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NDQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwOTEzNA==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435509134", "bodyText": "just checked (and added a test), it is a base64 encoded string", "author": "frankgh", "createdAt": "2020-06-04T19:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NDQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NzM2Nw==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435477367", "bodyText": "the more I see this, the more it reminds me of https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/InitializingBean.html -- wonder if we should take out explicit initialization in plugins and have them implement afterPropertiesSet() instead and have it being managed by Spring and not the Bridge. The tests will still have to do it, though, like here. Just food for thought.", "author": "denalex", "createdAt": "2020-06-04T18:46:45Z", "path": "server/pxf-hbase/src/test/java/org/greenplum/pxf/plugins/hbase/HBaseAccessorTest.java", "diffHunk": "@@ -73,47 +67,44 @@ public void tearDown() throws Exception {\n         accessor = null;\n     }\n \n-\t/*\n-\t * Test construction of HBaseAccessor.\n-\t * Actually no need for this as it is tested in all other tests\n-\t * constructing HBaseAccessor but it serves as a simple example\n-\t * of mocking\n-\t *\n-\t * HBaseAccessor is created and then HBaseTupleDescriptioncreation\n-\t * is verified\n-\t */\n+    /*\n+     * Test construction of HBaseAccessor.\n+     * Actually no need for this as it is tested in all other tests\n+     * constructing HBaseAccessor but it serves as a simple example\n+     * of mocking\n+     *\n+     * HBaseAccessor is created and then HBaseTupleDescriptioncreation\n+     * is verified\n+     */\n     @Test\n-    public void construction() throws Exception {\n+    public void construction() {\n         prepareConstruction();\n         HBaseAccessor accessor = new HBaseAccessor();\n-        accessor.initialize(context);\n-        PowerMockito.verifyNew(HBaseTupleDescription.class).withArguments(context);\n+        accessor.setRequestContext(context);\n+        accessor.initialize();", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4OTk1MQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435489951", "bodyText": "interesting. I did not know about it.", "author": "frankgh", "createdAt": "2020-06-04T19:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NzM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3Nzc4Mg==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435477782", "bodyText": "remove ?", "author": "denalex", "createdAt": "2020-06-04T18:47:34Z", "path": "server/pxf-hbase/src/test/java/org/greenplum/pxf/plugins/hbase/HBaseAccessorTest.java", "diffHunk": "@@ -156,11 +142,10 @@ private void prepareTableOpen() throws Exception {\n      * Helper for test setup.\n      * Sets zero columns (not realistic) and no filter\n      */\n-    private void prepareEmptyScanner() throws Exception {\n+    private void prepareEmptyScanner() {\n         scanDetails = mock(Scan.class);\n-        PowerMockito.whenNew(Scan.class).withNoArguments().thenReturn(scanDetails);\n \n-        when(tupleDescription.columns()).thenReturn(0);\n+        // when(tupleDescription.columns()).thenReturn(0);", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3ODMxNg==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435478316", "bodyText": "did behavior switch from returning null to throwing NPE ? Is it Ok ?", "author": "denalex", "createdAt": "2020-06-04T18:48:35Z", "path": "server/pxf-hbase/src/test/java/org/greenplum/pxf/plugins/hbase/HBaseFilterBuilderTest.java", "diffHunk": "@@ -94,12 +90,11 @@ public void parseNotExpressionIgnored() throws Exception {\n \n     @Test\n     public void parseNotOpCodeInConstant() throws Exception {\n-        thrown.expect(NullPointerException.class);\n \n         String filter = \"a1c25s2dl2o1a1c20s1d2o2l0\";\n         // Testing that we get past the parsing stage\n         // Very crude but it avoids instantiating all the necessary dependencies\n-        assertNull(helper(filter, null));\n+        assertThrows(NullPointerException.class, () -> helper(filter, null));", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4OTA3NA==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435489074", "bodyText": "this one threw me off too, if you look closely, this class expects a NPE in line 97 of the previous version of this class.", "author": "frankgh", "createdAt": "2020-06-04T19:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3ODMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTU3NA==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435479574", "bodyText": "maybe also have a few tests to serialize / deserialize the POJO with ObjectMapper to make sure @JsonCreator and others are configured correctly ?", "author": "denalex", "createdAt": "2020-06-04T18:50:50Z", "path": "server/pxf-hbase/src/test/java/org/greenplum/pxf/plugins/hbase/HBaseFragmentMetadataTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package org.greenplum.pxf.plugins.hbase;\n+\n+import org.apache.hadoop.hbase.HRegionInfo;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertSame;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class HBaseFragmentMetadataTest {\n+\n+    @Test\n+    public void testHRegionInfoConstructor() {\n+        final byte[] startKey = new byte[0];\n+        final byte[] endKey = new byte[0];\n+        final byte[] fooValue = new byte[0];\n+        Map<String, byte[]> columnMapping = new HashMap<>();\n+        columnMapping.put(\"foo\", fooValue);\n+\n+        HRegionInfo hRegionInfo = mock(HRegionInfo.class);\n+        when(hRegionInfo.getStartKey()).thenReturn(startKey);\n+        when(hRegionInfo.getEndKey()).thenReturn(endKey);\n+\n+        HBaseFragmentMetadata metadata = new HBaseFragmentMetadata(hRegionInfo, columnMapping);\n+        assertNotNull(metadata);\n+        assertSame(startKey, metadata.getStartKey());\n+        assertSame(endKey, metadata.getEndKey());\n+        assertSame(columnMapping, metadata.getColumnMapping());\n+        assertSame(fooValue, metadata.getColumnMapping().get(\"foo\"));\n+    }\n+\n+    @Test\n+    public void testConstructor() {\n+        final byte[] startKey = new byte[0];\n+        final byte[] endKey = new byte[0];\n+        final byte[] fooValue = new byte[0];\n+        Map<String, byte[]> columnMapping = new HashMap<>();\n+        columnMapping.put(\"foo\", fooValue);\n+\n+        HBaseFragmentMetadata metadata = new HBaseFragmentMetadata(startKey, endKey, columnMapping);\n+        assertNotNull(metadata);\n+        assertSame(startKey, metadata.getStartKey());\n+        assertSame(endKey, metadata.getEndKey());\n+        assertSame(columnMapping, metadata.getColumnMapping());\n+        assertSame(fooValue, metadata.getColumnMapping().get(\"foo\"));\n+    }\n+", "originalCommit": "16c64bc3c56ed2f0a4aa4e81eaf13667d9a47fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MjMzNw==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435492337", "bodyText": "we have tests for json serialization / deserialization in FragmentMetadataSerDeTest", "author": "frankgh", "createdAt": "2020-06-04T19:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDgwMQ==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435494801", "bodyText": "yes, but SerDe is specific to the POJO, let's say if the names of properties on @JsonCreator are mis-types or mixed up, this specific POJO will have problems deserializing, while others will be ok. The test will essentially ensure that the annotation is configured correctly", "author": "denalex", "createdAt": "2020-06-04T19:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NjQ5Ng==", "url": "https://github.com/greenplum-db/pxf/pull/368#discussion_r435496496", "bodyText": "true, I am not too keen on @JsonCreator. I much prefer clean POJOs with no annotations, but I will add tests to serialize, deserialize this class specifically.", "author": "frankgh", "createdAt": "2020-06-04T19:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTU3NA=="}], "type": "inlineReview"}, {"oid": "05d299bbc02fa99faaa531a4e96843d1b17a9871", "url": "https://github.com/greenplum-db/pxf/commit/05d299bbc02fa99faaa531a4e96843d1b17a9871", "message": "Address PR feedback", "committedDate": "2020-06-04T19:54:38Z", "type": "commit"}, {"oid": "ea9d934dd15f438ed99ece6ed77fe0131541f022", "url": "https://github.com/greenplum-db/pxf/commit/ea9d934dd15f438ed99ece6ed77fe0131541f022", "message": "Address PR feedback", "committedDate": "2020-06-04T20:10:46Z", "type": "commit"}]}