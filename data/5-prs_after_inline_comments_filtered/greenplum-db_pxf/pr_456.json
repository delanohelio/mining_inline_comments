{"pr_number": 456, "pr_title": "Add support for Network File Storage (NFS) ", "pr_createdAt": "2020-09-30T21:58:46Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/456", "timeline": [{"oid": "f3783c82546b0154d2e3845c899b35d9441d24ad", "url": "https://github.com/greenplum-db/pxf/commit/f3783c82546b0154d2e3845c899b35d9441d24ad", "message": "Productize NFS (localfile) profile\n\nThe NFS profile allows PXF reading data from Network File Systems. The\nNFS has to be mounted on every segment host where PXF is running from.\nPXF will then read/write data from the mounted NFS file.\n\nFor NFS, the `pxf.fs.basePath` property must be set to a valid path. The\n`pxf.fs.basePath` property represents the base path to be used for\ntables accessing that server.\n\nFor example, if the `pxf.fs.basePath` property is set to `/mount/path`\nand the external table definition is the following:\n\n```sql\nCREATE EXTERNAL TABLE nfs_table()\nLOCATION ('pxf://path/to/data?PROFILE=nfs:avro&SERVER=nfs-server')\nFORMAT 'CUSTOM' (formatter='pxfwritable_import');\n\nThen PXF will use the :///mount/path/path/to/data URI to read AVRO\nfiles.\n\nIn this commit, PXF also prevents relative paths to be specified in the\nlocation of any of the hadoop-compatible file systems (S3, GS, HDFS,\nNFS, etc). This is to prevent users from accessing data under relative\npaths to the `basePath`. For example, assume the mount path above, a\nmalicious user can attempt to read data from `/etc/passwd` by creating\nan external table like this:\n\n```sql\nCREATE EXTERNAL TABLE hack_etc_passwd (entry text)\nLOCATION ('pxf://../../etc/passwd?PROFILE=nfs:text&SERVER=nfs')\nFORMAT 'text';\n```\n\nPXF now prevents users from accessing relative paths in the path defined\nin the LOCATION URI. PXF also prevents using `$` to disallow resolution\nof environment variables for example:\n\n```sql\nCREATE EXTERNAL TABLE hack_home_dir (entry text)\nLOCATION\n('pxf://$HOME/secret-files-in-gpadmin-home?PROFILE=nfs:text&SERVER=nfs')\nFORMAT 'text';\n```\n\nPXF now will throw an exception in cases where users attempt to use\nrelative paths or $ in the path.", "committedDate": "2020-09-28T20:27:59Z", "type": "commit"}, {"oid": "2e73d3e784842efa5d1973fa70b6f433061b1c5f", "url": "https://github.com/greenplum-db/pxf/commit/2e73d3e784842efa5d1973fa70b6f433061b1c5f", "message": "Deprecate LOCALFILE\n\nLOCALFILE is deprecated in favor of NFS", "committedDate": "2020-09-28T20:41:25Z", "type": "commit"}, {"oid": "0ab9a53952a65fa7776c62555e81ef5aa13f4503", "url": "https://github.com/greenplum-db/pxf/commit/0ab9a53952a65fa7776c62555e81ef5aa13f4503", "message": "Add automation tests for NFS\n\nAdd multinode tests for NFS", "committedDate": "2020-09-30T21:56:02Z", "type": "commit"}, {"oid": "b9fc21cd0a10ee5af16bd21d36c553d2c92589f7", "url": "https://github.com/greenplum-db/pxf/commit/b9fc21cd0a10ee5af16bd21d36c553d2c92589f7", "message": "Mount NFS on the running container, configure the NFS server on the cluster", "committedDate": "2020-09-30T22:48:54Z", "type": "commit"}, {"oid": "44a81852b24bcb49d2e3e363c7ccd548b61d9ee4", "url": "https://github.com/greenplum-db/pxf/commit/44a81852b24bcb49d2e3e363c7ccd548b61d9ee4", "message": "Fix sed", "committedDate": "2020-09-30T23:09:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzODY5Nw==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497838697", "bodyText": "It looks like this check does not allow any occurrence of .. in the effective base path. This is probably the safest check to do, but doesn't it prevent the use of relative paths that stay within the configured base path, e.g. /mnt/data/dir1/../dir2?", "author": "bradfordb-vmware", "createdAt": "2020-09-30T22:35:15Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -199,8 +213,23 @@ public String getDataUri(Configuration configuration, String path) {\n      * @param dataSource The path to the data source\n      * @return the normalized path to the data source\n      */\n-    public String normalizeDataSource(String dataSource) {\n-        return StringUtils.removeStart(dataSource, \"/\");\n+    public String validateAndNormalizeDataSource(String dataSource) {\n+\n+        String effectiveBasePath = StringUtils.removeStart(dataSource, \"/\");\n+\n+        if (\"..\".equals(effectiveBasePath) || StringUtils.contains(effectiveBasePath, \"../\")) {", "originalCommit": "f3783c82546b0154d2e3845c899b35d9441d24ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MzM5Mg==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497863392", "bodyText": "it does, but we don't want to be super smart here as that location is reachable without using ..", "author": "denalex", "createdAt": "2020-09-30T23:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzODY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTYzNg==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497839636", "bodyText": "You can have pathnames that contain $ that are not part of an environment variable. As long as we don't expand the path or pass it to a shell unescaped, we should be able to safely allow $ in paths, right?", "author": "bradfordb-vmware", "createdAt": "2020-09-30T22:38:00Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -199,8 +213,23 @@ public String getDataUri(Configuration configuration, String path) {\n      * @param dataSource The path to the data source\n      * @return the normalized path to the data source\n      */\n-    public String normalizeDataSource(String dataSource) {\n-        return StringUtils.removeStart(dataSource, \"/\");\n+    public String validateAndNormalizeDataSource(String dataSource) {\n+\n+        String effectiveBasePath = StringUtils.removeStart(dataSource, \"/\");\n+\n+        if (\"..\".equals(effectiveBasePath) || StringUtils.contains(effectiveBasePath, \"../\")) {\n+            // Disallow relative paths\n+            throw new IllegalArgumentException(String\n+                    .format(\"the provided path '%s' is invalid. Relative paths are not allowed by PXF\", effectiveBasePath));\n+        }\n+\n+        if (StringUtils.contains(effectiveBasePath, \"$\")) {", "originalCommit": "f3783c82546b0154d2e3845c899b35d9441d24ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1NTAyMg==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497855022", "bodyText": "yeah, but we are being conservative here. We make a big bet that nobody will actually have a path with $ in the path name.", "author": "frankgh", "createdAt": "2020-09-30T23:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzOTYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1NzM2MQ==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497857361", "bodyText": "effectiveDataSource", "author": "frankgh", "createdAt": "2020-09-30T23:34:02Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -199,8 +215,23 @@ public String getDataUri(Configuration configuration, String path) {\n      * @param dataSource The path to the data source\n      * @return the normalized path to the data source\n      */\n-    public String normalizeDataSource(String dataSource) {\n-        return StringUtils.removeStart(dataSource, \"/\");\n+    public String validateAndNormalizeDataSource(String dataSource) {\n+\n+        String effectiveBasePath = StringUtils.removeStart(dataSource, \"/\");", "originalCommit": "44a81852b24bcb49d2e3e363c7ccd548b61d9ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1NzYwOQ==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497857609", "bodyText": "this logic will still be correct for \"/\" input, right ? Then I think comparing is a premature optimization.", "author": "denalex", "createdAt": "2020-09-30T23:35:00Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -212,20 +243,37 @@ protected String getDataUriForPrefix(Configuration configuration, String dataSou\n         URI defaultFS = FileSystem.getDefaultUri(configuration);\n \n         String uri;\n-        String normalizedDataSource = normalizeDataSource(dataSource);\n+        String basePath = validateAndNormalizeBasePath(configuration.get(CONFIG_KEY_BASE_PATH));\n+        String normalizedDataSource = validateAndNormalizeDataSource(dataSource);\n \n         if (FILE_SCHEME.equals(defaultFS.getScheme())) {\n             // if the defaultFS is file://, but enum is not FILE, use enum scheme only\n-            uri = StringUtils.removeEnd(scheme, \"://\") + \"://\" + normalizedDataSource;\n+            uri = StringUtils.removeEnd(scheme, \"://\") + \"://\" + basePath + normalizedDataSource;\n         } else {\n             // if the defaultFS is not file://, use it, instead of enum scheme and append user's path\n-            uri = StringUtils.removeEnd(defaultFS.toString(), \"/\") + \"/\" + normalizedDataSource;\n+            uri = StringUtils.removeEnd(defaultFS.toString(), \"/\") + basePath + \"/\" + normalizedDataSource;\n         }\n \n         disableSecureTokenRenewal(uri, configuration);\n         return uri;\n     }\n \n+    /**\n+     * Validates the basePath and normalizes it for the appropriate filesystem\n+     *\n+     * @param basePath the basePath as configured by the user\n+     * @return the normalized basePath\n+     */\n+    protected String validateAndNormalizeBasePath(String basePath) {\n+        if (StringUtils.isNotBlank(basePath)) {\n+            if (\"/\".equals(basePath))\n+                return \"/\";\n+            return StringUtils.removeEnd(StringUtils.removeStart(basePath, \"/\"), \"/\") + \"/\";", "originalCommit": "b9fc21cd0a10ee5af16bd21d36c553d2c92589f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyMDg0MQ==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r498320841", "bodyText": "yes, this is something I was doing somewhere else", "author": "frankgh", "createdAt": "2020-10-01T15:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg1NzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MDIzMw==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497860233", "bodyText": "this seems to be the same as the previous one", "author": "denalex", "createdAt": "2020-09-30T23:44:27Z", "path": "server/pxf-hdfs/src/test/java/org/greenplum/pxf/plugins/hdfs/HcfsTypeTest.java", "diffHunk": "@@ -373,4 +374,144 @@ public void testHcfsGlobPattern() {\n         assertEquals(\"0.0.0.0\", configuration.get(MRJobConfig.JOB_NAMENODES_TOKEN_RENEWAL_EXCLUDE));\n     }\n \n+    @Test\n+    public void testFailureOnNFSWhenBasePathIsNotConfigured() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"the 'pxf.fs.basePath' configuration is required to access NFS filesystems. Configure a valid 'pxf.fs.basePath' property to access this server\");\n+\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType.getHcfsType(configuration, context);\n+    }\n+\n+    @Test\n+    public void testFailureOnNFSWhenInvalidDefaultFSIsProvided() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"profile protocol (nfs) is not compatible with server filesystem (s3a)\");\n+\n+        configuration.set(\"fs.defaultFS\", \"s3a://abc/\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType.getHcfsType(configuration, context);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToRootDirectory() {\n+        configuration.set(\"pxf.fs.basePath\", \"/\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToAFixedBucket() {\n+        configuration.set(\"pxf.fs.basePath\", \"some-bucket\");\n+        context.setProfileScheme(\"s3a\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"s3a://some-bucket/foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToASingleCharPath() {\n+        configuration.set(\"pxf.fs.basePath\", \"p\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // trailing / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"p/\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // preceding / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"/p\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // trailing and preceding / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"/p/\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToSomeValue() {\n+        configuration.set(\"pxf.fs.basePath\", \"/my/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+\n+        // no / preceding the basePath\n+        configuration.set(\"pxf.fs.basePath\", \"my/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+\n+        // no / trailing the basePath\n+        configuration.set(\"pxf.fs.basePath\", \"my/base/path\");", "originalCommit": "b9fc21cd0a10ee5af16bd21d36c553d2c92589f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg2MTAzNw==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r497861037", "bodyText": "let's also test ../ and a/..", "author": "denalex", "createdAt": "2020-09-30T23:46:59Z", "path": "server/pxf-hdfs/src/test/java/org/greenplum/pxf/plugins/hdfs/HcfsTypeTest.java", "diffHunk": "@@ -373,4 +374,144 @@ public void testHcfsGlobPattern() {\n         assertEquals(\"0.0.0.0\", configuration.get(MRJobConfig.JOB_NAMENODES_TOKEN_RENEWAL_EXCLUDE));\n     }\n \n+    @Test\n+    public void testFailureOnNFSWhenBasePathIsNotConfigured() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"the 'pxf.fs.basePath' configuration is required to access NFS filesystems. Configure a valid 'pxf.fs.basePath' property to access this server\");\n+\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType.getHcfsType(configuration, context);\n+    }\n+\n+    @Test\n+    public void testFailureOnNFSWhenInvalidDefaultFSIsProvided() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"profile protocol (nfs) is not compatible with server filesystem (s3a)\");\n+\n+        configuration.set(\"fs.defaultFS\", \"s3a://abc/\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType.getHcfsType(configuration, context);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToRootDirectory() {\n+        configuration.set(\"pxf.fs.basePath\", \"/\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToAFixedBucket() {\n+        configuration.set(\"pxf.fs.basePath\", \"some-bucket\");\n+        context.setProfileScheme(\"s3a\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"s3a://some-bucket/foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToASingleCharPath() {\n+        configuration.set(\"pxf.fs.basePath\", \"p\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // trailing / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"p/\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // preceding / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"/p\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+\n+        // trailing and preceding / in basePath\n+        configuration.set(\"pxf.fs.basePath\", \"/p/\");\n+        context.setProfileScheme(\"nfs\");\n+        nfs = HcfsType.getHcfsType(configuration, context);\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///p/foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testBasePathIsConfiguredToSomeValue() {\n+        configuration.set(\"pxf.fs.basePath\", \"/my/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        String uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+\n+        // no / preceding the basePath\n+        configuration.set(\"pxf.fs.basePath\", \"my/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+\n+        // no / trailing the basePath\n+        configuration.set(\"pxf.fs.basePath\", \"my/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+\n+        // preceding and trailing / in the basePath\n+        configuration.set(\"pxf.fs.basePath\", \"/my/base/path/\");\n+        context.setProfileScheme(\"nfs\");\n+        uri = nfs.getDataUri(configuration, context);\n+        assertEquals(\"file:///my/base/path/foo/bar.txt\", uri);\n+    }\n+\n+    @Test\n+    public void testFailsWhenARelativeDataSourceIsProvided1() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"the provided path '../../../etc/passwd' is invalid. Relative paths are not allowed by PXF\");\n+\n+        configuration.set(\"pxf.fs.basePath\", \"/some/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        context.setDataSource(\"../../../etc/passwd\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        nfs.getDataUri(configuration, context);\n+    }\n+\n+    @Test\n+    public void testFailsWhenARelativeDataSourceIsProvided2() {\n+        thrown.expect(IllegalArgumentException.class);\n+        thrown.expectMessage(\"the provided path '..' is invalid. Relative paths are not allowed by PXF\");\n+\n+        configuration.set(\"pxf.fs.basePath\", \"/some/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        context.setDataSource(\"..\");\n+        HcfsType nfs = HcfsType.getHcfsType(configuration, context);\n+        nfs.getDataUri(configuration, context);\n+    }\n+\n+    @Test\n+    public void testDataSourceWithTwoDotsInName() {\n+        configuration.set(\"pxf.fs.basePath\", \"/some/base/path\");\n+        context.setProfileScheme(\"nfs\");\n+        context.setDataSource(\"a..txt\");", "originalCommit": "b9fc21cd0a10ee5af16bd21d36c553d2c92589f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8a71180642fd7c67cef9cd4a3a0cb491c64f7e1", "url": "https://github.com/greenplum-db/pxf/commit/b8a71180642fd7c67cef9cd4a3a0cb491c64f7e1", "message": " is the if the issue?", "committedDate": "2020-10-01T10:27:52Z", "type": "commit"}, {"oid": "fcda74048057f7aedf0cfe90ea969ae6d4a33e7b", "url": "https://github.com/greenplum-db/pxf/commit/fcda74048057f7aedf0cfe90ea969ae6d4a33e7b", "message": "Install NFS first then use showmount", "committedDate": "2020-10-01T10:47:37Z", "type": "commit"}, {"oid": "358b5d7bbc1e4b749d878df23f183c6bb5429580", "url": "https://github.com/greenplum-db/pxf/commit/358b5d7bbc1e4b749d878df23f183c6bb5429580", "message": "fix sed", "committedDate": "2020-10-01T10:52:37Z", "type": "commit"}, {"oid": "5abf435b1fb0989d0c05227aa572722026647039", "url": "https://github.com/greenplum-db/pxf/commit/5abf435b1fb0989d0c05227aa572722026647039", "message": "start services inside container. do not install nfs-utils, as it is already installed in the VMs", "committedDate": "2020-10-01T14:03:03Z", "type": "commit"}, {"oid": "d2dcd4a0951b2bc5ffa2da140f6886e0c5e75bb0", "url": "https://github.com/greenplum-db/pxf/commit/d2dcd4a0951b2bc5ffa2da140f6886e0c5e75bb0", "message": "fixup! Productize NFS (localfile) profile", "committedDate": "2020-10-01T14:14:02Z", "type": "commit"}, {"oid": "c62cb21c214be4d9145ec87eddfaa2e5e46f0843", "url": "https://github.com/greenplum-db/pxf/commit/c62cb21c214be4d9145ec87eddfaa2e5e46f0843", "message": "Fix mounting of NFS inside the container", "committedDate": "2020-10-01T15:03:59Z", "type": "commit"}, {"oid": "ebc6785591fd3e19e3b1d225b75dcab7a20d9ff8", "url": "https://github.com/greenplum-db/pxf/commit/ebc6785591fd3e19e3b1d225b75dcab7a20d9ff8", "message": "Address PR feedback from Alex: f3783c82546b0154d2e3845c899b35d9441d24ad", "committedDate": "2020-10-01T15:31:45Z", "type": "commit"}, {"oid": "e11a451cac6bf53bf9a0a58b075d0e0579579f33", "url": "https://github.com/greenplum-db/pxf/commit/e11a451cac6bf53bf9a0a58b075d0e0579579f33", "message": "Run as privileged", "committedDate": "2020-10-01T15:32:00Z", "type": "commit"}, {"oid": "0567abdb46cd1f352952fda7871b9ec1bab8f9f9", "url": "https://github.com/greenplum-db/pxf/commit/0567abdb46cd1f352952fda7871b9ec1bab8f9f9", "message": "Fix issues with chown", "committedDate": "2020-10-01T15:43:04Z", "type": "commit"}, {"oid": "7809c1a176e9c3a80a14e8cb4beb6ad7f3193bc7", "url": "https://github.com/greenplum-db/pxf/commit/7809c1a176e9c3a80a14e8cb4beb6ad7f3193bc7", "message": "CI: When the profile is NFS, remove the basePath during external table creation", "committedDate": "2020-10-01T19:39:57Z", "type": "commit"}, {"oid": "e9a76fcd23c4d968da812105d435dd1a54be4ac0", "url": "https://github.com/greenplum-db/pxf/commit/e9a76fcd23c4d968da812105d435dd1a54be4ac0", "message": "NFS -> FILE", "committedDate": "2020-10-01T22:07:35Z", "type": "commit"}, {"oid": "2bcb9c0c432844abc1a2a2eb652fad5568e94e2c", "url": "https://github.com/greenplum-db/pxf/commit/2bcb9c0c432844abc1a2a2eb652fad5568e94e2c", "message": "make SecureLogin.isUserImpersonationEnabled static", "committedDate": "2020-10-01T22:37:04Z", "type": "commit"}, {"oid": "4e30f06a57af4ee8f8da464605e498e531b4b3ad", "url": "https://github.com/greenplum-db/pxf/commit/4e30f06a57af4ee8f8da464605e498e531b4b3ad", "message": "Error out when impersonation is enabled for the FILE protocol", "committedDate": "2020-10-01T22:51:47Z", "type": "commit"}, {"oid": "3df36444cf0865c46b742acb2e71692ad4de2f10", "url": "https://github.com/greenplum-db/pxf/commit/3df36444cf0865c46b742acb2e71692ad4de2f10", "message": "Configure pxf-profiles for file protocol to include file:AvroSequenceFile and file:SequenceFile", "committedDate": "2020-10-01T23:01:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1MDk0NA==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r498550944", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    String.format(\"the '%1$s' configuration is required to access locally mounted file systems. Configure a valid '%1$s' property to access this server\",\n          \n          \n            \n                                    String.format(\"Configure a valid value for '%s' property for this server to access the filesystem\",", "author": "denalex", "createdAt": "2020-10-01T22:55:35Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -26,20 +26,24 @@ public String getDataUri(Configuration configuration, RequestContext context) {\n     },\n     FILE {\n         @Override\n-        public String getDataUri(Configuration configuration, RequestContext context) {\n-            throw new IllegalStateException(\"core-site.xml is missing or using unsupported file:// as default filesystem\");\n-        }\n+        protected String validateAndNormalizeBasePath(String basePath) {\n+            if (StringUtils.isBlank(basePath))\n+                throw new IllegalArgumentException(\n+                        String.format(\"the '%1$s' configuration is required to access locally mounted file systems. Configure a valid '%1$s' property to access this server\",", "originalCommit": "e9a76fcd23c4d968da812105d435dd1a54be4ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1MzA5OA==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r498553098", "bodyText": "normalized base path already has \"/\" at the end, unless it is empty, so will you end up with \"//\" here ?", "author": "denalex", "createdAt": "2020-10-01T23:03:48Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsType.java", "diffHunk": "@@ -212,20 +234,34 @@ protected String getDataUriForPrefix(Configuration configuration, String dataSou\n         URI defaultFS = FileSystem.getDefaultUri(configuration);\n \n         String uri;\n-        String normalizedDataSource = normalizeDataSource(dataSource);\n+        String basePath = validateAndNormalizeBasePath(configuration.get(CONFIG_KEY_BASE_PATH));\n+        String normalizedDataSource = validateAndNormalizeDataSource(dataSource);\n \n         if (FILE_SCHEME.equals(defaultFS.getScheme())) {\n             // if the defaultFS is file://, but enum is not FILE, use enum scheme only\n-            uri = StringUtils.removeEnd(scheme, \"://\") + \"://\" + normalizedDataSource;\n+            uri = StringUtils.removeEnd(scheme, \"://\") + \"://\" + basePath + normalizedDataSource;\n         } else {\n             // if the defaultFS is not file://, use it, instead of enum scheme and append user's path\n-            uri = StringUtils.removeEnd(defaultFS.toString(), \"/\") + \"/\" + normalizedDataSource;\n+            uri = StringUtils.removeEnd(defaultFS.toString(), \"/\") + basePath + \"/\" + normalizedDataSource;", "originalCommit": "e9a76fcd23c4d968da812105d435dd1a54be4ac0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1NzE1OA==", "url": "https://github.com/greenplum-db/pxf/pull/456#discussion_r498557158", "bodyText": "yes, this is incorrect", "author": "frankgh", "createdAt": "2020-10-01T23:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU1MzA5OA=="}], "type": "inlineReview"}, {"oid": "7ba39e5d8260541031bab5148b5d800bce98f37a", "url": "https://github.com/greenplum-db/pxf/commit/7ba39e5d8260541031bab5148b5d800bce98f37a", "message": "Address PR feedback", "committedDate": "2020-10-01T23:21:39Z", "type": "commit"}, {"oid": "859fb8ee7dbf8c7ac1939af572def13c0d441104", "url": "https://github.com/greenplum-db/pxf/commit/859fb8ee7dbf8c7ac1939af572def13c0d441104", "message": "fix impersonation, address PR feedback", "committedDate": "2020-10-01T23:28:42Z", "type": "commit"}, {"oid": "30a0ba4c50028c39d4ab712ad207a950a3999c13", "url": "https://github.com/greenplum-db/pxf/commit/30a0ba4c50028c39d4ab712ad207a950a3999c13", "message": "fix tests", "committedDate": "2020-10-02T09:42:14Z", "type": "commit"}, {"oid": "b4d1f224a2f826d6fc9c0e50fe34ec138dcbd026", "url": "https://github.com/greenplum-db/pxf/commit/b4d1f224a2f826d6fc9c0e50fe34ec138dcbd026", "message": "More fixes", "committedDate": "2020-10-02T10:51:19Z", "type": "commit"}, {"oid": "93aeb8b1f8a3f3892e990a7c0825fe802e5a44dd", "url": "https://github.com/greenplum-db/pxf/commit/93aeb8b1f8a3f3892e990a7c0825fe802e5a44dd", "message": "Skip workspace creation for write tests", "committedDate": "2020-10-02T14:15:52Z", "type": "commit"}, {"oid": "4c2410e7c84f952d426e625d47f46a88cbf8f2b0", "url": "https://github.com/greenplum-db/pxf/commit/4c2410e7c84f952d426e625d47f46a88cbf8f2b0", "message": "Allow writes from all segments on the basepath", "committedDate": "2020-10-02T14:42:01Z", "type": "commit"}, {"oid": "8556d28a28e027aa499d6d08a963692296fe8811", "url": "https://github.com/greenplum-db/pxf/commit/8556d28a28e027aa499d6d08a963692296fe8811", "message": "More fixes", "committedDate": "2020-10-02T15:48:30Z", "type": "commit"}, {"oid": "ecaac700abc1ea0bf7d451d4f18f2b6d38f3b545", "url": "https://github.com/greenplum-db/pxf/commit/ecaac700abc1ea0bf7d451d4f18f2b6d38f3b545", "message": "Use 777 for mount points to see if write works correctly", "committedDate": "2020-10-02T17:14:42Z", "type": "commit"}, {"oid": "d9d59d78454e74580b66d7c2476791b095a5e5fa", "url": "https://github.com/greenplum-db/pxf/commit/d9d59d78454e74580b66d7c2476791b095a5e5fa", "message": "more fixes", "committedDate": "2020-10-02T18:33:21Z", "type": "commit"}, {"oid": "902ed7fe31c011b99d833d04c0085357979a291b", "url": "https://github.com/greenplum-db/pxf/commit/902ed7fe31c011b99d833d04c0085357979a291b", "message": "Another attempt at fixing permissions for write", "committedDate": "2020-10-02T18:58:16Z", "type": "commit"}, {"oid": "00ea5e305811d42942f79d6fc19011e26e6889f1", "url": "https://github.com/greenplum-db/pxf/commit/00ea5e305811d42942f79d6fc19011e26e6889f1", "message": "fix HdfsReadableTextTest.limit test", "committedDate": "2020-10-02T20:04:35Z", "type": "commit"}, {"oid": "80786a007f3800b1ef86337dbe97913ace1d8216", "url": "https://github.com/greenplum-db/pxf/commit/80786a007f3800b1ef86337dbe97913ace1d8216", "message": "fix parquet tests", "committedDate": "2020-10-02T20:59:38Z", "type": "commit"}, {"oid": "24eea1cf571c3c53955a3375d7d3f26a016388b4", "url": "https://github.com/greenplum-db/pxf/commit/24eea1cf571c3c53955a3375d7d3f26a016388b4", "message": "match user and group id with VMs gpadmin user/group ids", "committedDate": "2020-10-02T21:44:01Z", "type": "commit"}, {"oid": "641bf22560c29c17a286af26270cceb5686bb217", "url": "https://github.com/greenplum-db/pxf/commit/641bf22560c29c17a286af26270cceb5686bb217", "message": "Configure remote access to gpdb then change ids", "committedDate": "2020-10-02T22:01:00Z", "type": "commit"}, {"oid": "47761eb4f1df5255daf788c4c786b34b219085aa", "url": "https://github.com/greenplum-db/pxf/commit/47761eb4f1df5255daf788c4c786b34b219085aa", "message": "some reverts after write works", "committedDate": "2020-10-02T23:23:13Z", "type": "commit"}, {"oid": "5988e132fe9e94df70f4a65120fe354822351a81", "url": "https://github.com/greenplum-db/pxf/commit/5988e132fe9e94df70f4a65120fe354822351a81", "message": "Revert \"make SecureLogin.isUserImpersonationEnabled static\"\n\nThis reverts commit 2bcb9c0c432844abc1a2a2eb652fad5568e94e2c.", "committedDate": "2020-10-02T23:23:17Z", "type": "commit"}, {"oid": "9b496a1be45e64fc96f94b130773f3c89229b013", "url": "https://github.com/greenplum-db/pxf/commit/9b496a1be45e64fc96f94b130773f3c89229b013", "message": "Fix parquet write tests", "committedDate": "2020-10-03T11:40:02Z", "type": "commit"}, {"oid": "82f901fe8a11c9f3d073e0490612f0340a4c0036", "url": "https://github.com/greenplum-db/pxf/commit/82f901fe8a11c9f3d073e0490612f0340a4c0036", "message": "do not sleep for HDFS and FILE. Fixes to HdfsWritableTextTest", "committedDate": "2020-10-03T12:39:41Z", "type": "commit"}, {"oid": "2bd7525c120775e07f35196c30f1a126f02daf57", "url": "https://github.com/greenplum-db/pxf/commit/2bd7525c120775e07f35196c30f1a126f02daf57", "message": "fix HdfsWritableTextTest", "committedDate": "2020-10-04T00:43:56Z", "type": "commit"}, {"oid": "540d5e085b5db11cd1bc8a45ef60cc95bd245916", "url": "https://github.com/greenplum-db/pxf/commit/540d5e085b5db11cd1bc8a45ef60cc95bd245916", "message": "Fix HdfsWritableSequenceTest", "committedDate": "2020-10-04T15:40:32Z", "type": "commit"}, {"oid": "2d76a0b7c5cfd67fee0bf289247b18d6214b78aa", "url": "https://github.com/greenplum-db/pxf/commit/2d76a0b7c5cfd67fee0bf289247b18d6214b78aa", "message": "Address PR feedback", "committedDate": "2020-10-07T17:15:00Z", "type": "commit"}]}