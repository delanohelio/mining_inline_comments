{"pr_number": 1542, "pr_title": "Handle legacy fork id Eth/64", "pr_createdAt": "2020-11-09T09:42:45Z", "pr_url": "https://github.com/hyperledger/besu/pull/1542", "timeline": [{"oid": "b2df58f7824c9f1d5030544ebd4c316cad96190e", "url": "https://github.com/hyperledger/besu/commit/b2df58f7824c9f1d5030544ebd4c316cad96190e", "message": "Handle legacy fork id Eth/64\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-09T09:35:32Z", "type": "commit"}, {"oid": "7aa5173739acb834c7c680653e73e52900de621f", "url": "https://github.com/hyperledger/besu/commit/7aa5173739acb834c7c680653e73e52900de621f", "message": "update changelog\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-09T09:43:44Z", "type": "commit"}, {"oid": "0a4b6bc3a1d078aca3161c37c2059ad288346360", "url": "https://github.com/hyperledger/besu/commit/0a4b6bc3a1d078aca3161c37c2059ad288346360", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-09T09:53:45Z", "type": "commit"}, {"oid": "9589ae0894087ed453e3e54defe852e5a28c28ea", "url": "https://github.com/hyperledger/besu/commit/9589ae0894087ed453e3e54defe852e5a28c28ea", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T08:11:49Z", "type": "commit"}, {"oid": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "url": "https://github.com/hyperledger/besu/commit/bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "message": "handle legacy fork id computation\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T09:04:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NDcxMw==", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522094713", "bodyText": "If you use isEmpty here it's easier to parse at a glance how it differs from the version below", "author": "RatanRSur", "createdAt": "2020-11-12T13:12:11Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -61,6 +64,9 @@ public ForkIdManager(final Blockchain blockchain, final List<Long> nonFilteredFo\n   }\n \n   public ForkId computeForkId() {\n+    if (legacyEth64) {\n+      return forkAndHashList.size() > 0 ? forkAndHashList.get(forkAndHashList.size() - 1) : null;", "originalCommit": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwMjAyNA==", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522102024", "bodyText": "I agree. Done", "author": "abdelhamidbakhta", "createdAt": "2020-11-12T13:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NDcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NzUzOA==", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522097538", "bodyText": "Do we need to keep these unused methods around?", "author": "RatanRSur", "createdAt": "2020-11-12T13:16:57Z", "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/LegacyForkIdManager.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.eth.manager.ForkId;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.zip.CRC32;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class LegacyForkIdManager {\n+\n+  private final Blockchain blockchain;\n+  private final Hash genesisHash;\n+  private final List<Long> forks;\n+  private long forkNext;\n+  private final long highestKnownFork;\n+  private List<ForkId> forkAndHashList;\n+\n+  public LegacyForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n+    this.blockchain = blockchain;\n+    this.genesisHash = blockchain.getGenesisBlock().getHash();\n+    // de-dupe and sanitize forks\n+    this.forks =\n+        forks.stream().filter(fork -> fork > 0).distinct().collect(Collectors.toUnmodifiableList());\n+    highestKnownFork = forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;\n+    createForkIds();\n+  };\n+\n+  public List<ForkId> getForkAndHashList() {\n+    return this.forkAndHashList;\n+  }\n+\n+  public ForkId getLatestForkId() {\n+    if (forkAndHashList.size() > 0) {\n+      return forkAndHashList.get(forkAndHashList.size() - 1);\n+    }\n+    return null;\n+  }\n+\n+  public static ForkId readFrom(final RLPInput in) {\n+    in.enterList();\n+    final Bytes hash = in.readBytes();\n+    final Bytes next = in.readBytes();\n+    in.leaveList();\n+    return new ForkId(hash, next);\n+  }\n+\n+  /**\n+   * EIP-2124 behaviour\n+   *\n+   * @param forkId to be validated.\n+   * @return boolean (peer valid (true) or invalid (false))\n+   */\n+  boolean peerCheck(final ForkId forkId) {", "originalCommit": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEwMjEwNw==", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522102107", "bodyText": "No. I removed them.", "author": "abdelhamidbakhta", "createdAt": "2020-11-12T13:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NzUzOA=="}], "type": "inlineReview"}, {"oid": "9140de0441ef879fffd43dd1abc1b63ce7565888", "url": "https://github.com/hyperledger/besu/commit/9140de0441ef879fffd43dd1abc1b63ce7565888", "message": "address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T13:24:15Z", "type": "commit"}, {"oid": "25aee359c1c561fd3eb49a1fb190e6adaeb266e2", "url": "https://github.com/hyperledger/besu/commit/25aee359c1c561fd3eb49a1fb190e6adaeb266e2", "message": "fix error prone\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T13:35:26Z", "type": "commit"}, {"oid": "315ca8829c29cc0e26ca0d07e07ea9fbf671bd7e", "url": "https://github.com/hyperledger/besu/commit/315ca8829c29cc0e26ca0d07e07ea9fbf671bd7e", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T13:39:28Z", "type": "commit"}, {"oid": "2a0c60b6ea4222c5402cfdc5a088cfbb416e0957", "url": "https://github.com/hyperledger/besu/commit/2a0c60b6ea4222c5402cfdc5a088cfbb416e0957", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-12T17:32:30Z", "type": "commit"}, {"oid": "8a33778062d72c894cc5e77ef43020fcd67fea22", "url": "https://github.com/hyperledger/besu/commit/8a33778062d72c894cc5e77ef43020fcd67fea22", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-11-13T08:25:40Z", "type": "commit"}, {"oid": "2779e9b8caed6dec9821aed10f100dd50ff574b3", "url": "https://github.com/hyperledger/besu/commit/2779e9b8caed6dec9821aed10f100dd50ff574b3", "message": "- update changelog\n- change cli option name\n- add unit tests\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-11-13T08:47:21Z", "type": "commit"}]}