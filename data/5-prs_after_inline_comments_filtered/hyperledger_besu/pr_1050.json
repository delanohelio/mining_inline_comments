{"pr_number": 1050, "pr_title": "Fix EIP-2124 Fork identifier for chain compatibility checks.", "pr_createdAt": "2020-06-05T10:02:42Z", "pr_url": "https://github.com/hyperledger/besu/pull/1050", "timeline": [{"oid": "9628d1d07c26740362c84f60a8b0941af0428d83", "url": "https://github.com/hyperledger/besu/commit/9628d1d07c26740362c84f60a8b0941af0428d83", "message": "Fix EIP-2124 Fork identifier for chain compatibility checks.\n\nBefore this pull request Besu was using the latest known fork id to create status message for Ethereum P2P protocol handshake.\nThis latest known fork id was created based on a list of forks retrieved from the Genesis.\nFor private networks it is possible that all fork blocks number are set to 0.\nThe algorithm to compute the valid fork hashes excludes 0 values.\nAs a result, the list was empty and the `getLatestForkId` was returning `null`. This is an issue when you support capabilities >= to Eth/64 sub protocol because other peers expect the fork id value in the `RLP` encoded message.\nMoreover, the algorithm to compute the fork id should be aware of the chain head number and update `CRC` value only for fork blocks below the current head.\nThis pull request fixes this issue by fetching the chain head number and update accordingly the `CRC` value.\nUnit tests have been extended to cover an exhaustive list of possible combinations on named networks (`goerli`, `rinkeby`, `ropsten` and `mainnet`).\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-05T10:00:44Z", "type": "commit"}, {"oid": "5a224b78ab36e27f98dbac4070d6d79940261ceb", "url": "https://github.com/hyperledger/besu/commit/5a224b78ab36e27f98dbac4070d6d79940261ceb", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-05T16:29:42Z", "type": "commit"}, {"oid": "6ebc051e88ce61ac293dd996ce7dc9fefb0dc8ac", "url": "https://github.com/hyperledger/besu/commit/6ebc051e88ce61ac293dd996ce7dc9fefb0dc8ac", "message": "Add condition in if statement\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-05T16:39:46Z", "type": "commit"}, {"oid": "e4b0cecf1b18052c7b351d589084551f68ec1062", "url": "https://github.com/hyperledger/besu/commit/e4b0cecf1b18052c7b351d589084551f68ec1062", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-05T16:41:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436136362", "bodyText": "This feels like a lot of duplication with  org.hyperledger.besu.ethereum.eth.manager.ForkIdManagerTest - What is being tested here that is not being tested there and can these two files be merged into one?", "author": "shemnon", "createdAt": "2020-06-05T19:57:30Z", "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/manager/EIP2124Test.java", "diffHunk": "@@ -0,0 +1,235 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Block;\n+import org.hyperledger.besu.ethereum.core.BlockHeader;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.eth.manager.ForkIdManager.ForkId;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n+@RunWith(Parameterized.class)\n+public class EIP2124Test {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Parameters(name = \"{index}: {0}\")\n+  public static Collection<Object[]> data() {\n+    return Arrays.asList(\n+        new Object[][] {\n+          // Mainnet test cases\n+          {\"Mainnet // First Homestead block\", Network.MAINNET, 1150000L, \"0x97c2c34c\", 1920000L},", "originalCommit": "e4b0cecf1b18052c7b351d589084551f68ec1062", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5NTI0Ng==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436495246", "bodyText": "They don't exactly test the same things. The new test class EIP2124Test is focused on testing the fork id sent in P2P status messages. It also performs the assertions on multiple combinations of chain heights. The ForkIdManagerTest is focus on testing the intermediate fork hashes generated to perform the peer check. I think they have different scopes of responsibilities. I would keep them both. Moreover, the new test class cases are aligned with some tests in the EIP specification and also the implementation of other clients.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T07:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5NjA1Mg==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436496052", "bodyText": "Simply put: ForkIdManagerTest tests the behaviour of peerCheck method whereas EIP2124Test tests the behaviour of computeForkId method used by EthProtocolManager.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T07:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5NjIxNA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436496214", "bodyText": "Are you ok if i keep both files ?", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T07:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MjQ3OA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436792478", "bodyText": "There's too much duplication.  They are testing two things in the same java file, so they should at least be in the same file.  Also, the data sets (what the fork IDs of the well known networks are) should be normalized into one data set.", "author": "shemnon", "createdAt": "2020-06-08T15:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxNTY2OQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437415669", "bodyText": "It is not a well-documented feature in the genesis configuration that this can occur. Esp. with EthProtocolManager handshake as that has been a worry for us.", "author": "sambacha", "createdAt": "2020-06-09T13:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODE0OA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437418148", "bodyText": "I refactored both the implementation and the testing.", "author": "abdelhamidbakhta", "createdAt": "2020-06-09T13:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxODQ4MQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437418481", "bodyText": "And tested on almost all Ethereum networks, including consortium networks.", "author": "abdelhamidbakhta", "createdAt": "2020-06-09T13:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg=="}], "type": "inlineReview"}, {"oid": "7e92a86e1c2bb87a2f2c8b4b58ce3e19840286b8", "url": "https://github.com/hyperledger/besu/commit/7e92a86e1c2bb87a2f2c8b4b58ce3e19840286b8", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-08T07:05:04Z", "type": "commit"}, {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "url": "https://github.com/hyperledger/besu/commit/991c1d6c96bf23074b7c5e21534e2a5f2b424127", "message": "Fix Ethereum classic mordor fork id\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-08T08:57:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyODE0Nw==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436828147", "bodyText": "Is this just for testing?", "author": "RatanRSur", "createdAt": "2020-06-08T16:14:44Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -66,12 +69,41 @@ public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n               blockchain,\n               genesisHash,\n               forks,\n-              fs -> fs.stream().distinct().collect(Collectors.toUnmodifiableList()),\n+              fs -> fs.stream().distinct().sorted().collect(Collectors.toUnmodifiableList()),\n               new ArrayList<>());\n       this.forkIDCheckers = Arrays.asList(newForkIdChecker, legacyForkIdChecker);\n     }\n   }\n \n+  public ForkId computeForkId() {\n+    final long head = chainHeadSupplier.getAsLong();\n+    if (lastHead != 0 && head == lastHead && lastComputedForkId != null) {\n+      return lastComputedForkId;\n+    }\n+    lastHead = head;\n+\n+    final CRC32 crc = new CRC32();\n+    long next = 0;\n+    crc.update(genesisHash.toArray());\n+    for (final Long fork : forks) {\n+      if (fork <= head) {\n+        updateCrc(crc, fork);\n+        continue;\n+      }\n+      next = fork;\n+      break;\n+    }\n+    lastComputedForkId = new ForkId(getCurrentCrcHash(crc), next);\n+    return lastComputedForkId;\n+  }\n+\n+  ForkId getLatestForkId() {", "originalCommit": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NDQzOA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436864438", "bodyText": "Yes. Added @VisibleForTesting annotation.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T17:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyODE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzQxMA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436833410", "bodyText": "Since forks doesn't include 0, onlyZerosForkBlocks is not doing what it looks like it's doing. As it happens, it will be true because allMatch is true for empty but it's pretty misleading right now.", "author": "RatanRSur", "createdAt": "2020-06-08T16:22:45Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -40,23 +41,25 @@\n   private final List<ForkId> forkAndHashList;\n \n   private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n     checkNotNull(blockchain);\n     checkNotNull(forks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n+    this.forks =\n+        forks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());", "originalCommit": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NDYwOQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436864609", "bodyText": "Fixed.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T17:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzk5NA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436833994", "bodyText": "If this isn't used anywhere else, we should probably move it into the else clause.", "author": "RatanRSur", "createdAt": "2020-06-08T16:23:44Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -40,23 +41,25 @@\n   private final List<ForkId> forkAndHashList;\n \n   private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n     checkNotNull(blockchain);\n     checkNotNull(forks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n+    this.forks =\n+        forks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());\n     final Predicate<ForkId> legacyForkIdChecker =\n-        createForkIDChecker(\n-            blockchain,\n-            genesisHash,\n-            forks,\n-            fs ->\n-                fs.stream()\n-                    .filter(fork -> fork > 0)\n-                    .distinct()\n-                    .collect(Collectors.toUnmodifiableList()),\n-            forkAndHashList);\n+        createForkIDChecker(blockchain, genesisHash, forks, fs -> forks, forkAndHashList);", "originalCommit": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NTU0NA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436865544", "bodyText": "Non relevant anymore.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T17:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzE0Mw==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436843143", "bodyText": "Do we need this filter as well? I thought we already got rid of the 0's above. If it does break when this is removed, I wonder if there's a way we can do this filter in only one place.", "author": "RatanRSur", "createdAt": "2020-06-08T16:38:28Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -205,16 +230,20 @@ private static long createForkIds(\n     final CRC32 crc = new CRC32();\n     crc.update(genesisHash.toArray());\n     final List<Bytes> forkHashes = new ArrayList<>(List.of(getCurrentCrcHash(crc)));\n-    for (final Long fork : forks) {\n-      updateCrc(crc, fork);\n-      forkHashes.add(getCurrentCrcHash(crc));\n-    }\n+    final List<Long> filteredForks =\n+        forks.stream().filter(v -> v > 0).distinct().collect(Collectors.toUnmodifiableList());", "originalCommit": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NTQxOQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436865419", "bodyText": "Fixed.", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T17:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDc3MQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436844771", "bodyText": "Can we reuse the getLatestForkId here?", "author": "RatanRSur", "createdAt": "2020-06-08T16:41:14Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -205,16 +230,20 @@ private static long createForkIds(\n     final CRC32 crc = new CRC32();\n     crc.update(genesisHash.toArray());\n     final List<Bytes> forkHashes = new ArrayList<>(List.of(getCurrentCrcHash(crc)));\n-    for (final Long fork : forks) {\n-      updateCrc(crc, fork);\n-      forkHashes.add(getCurrentCrcHash(crc));\n-    }\n+    final List<Long> filteredForks =\n+        forks.stream().filter(v -> v > 0).distinct().collect(Collectors.toUnmodifiableList());\n+    filteredForks.forEach(\n+        fork -> {\n+          updateCrc(crc, fork);\n+          forkHashes.add(getCurrentCrcHash(crc));\n+        });\n+\n     // This loop is for all the fork hashes that have an associated \"next fork\"\n-    for (int i = 0; i < forks.size(); i++) {\n-      forkIds.add(new ForkId(forkHashes.get(i), forks.get(i)));\n+    for (int i = 0; i < filteredForks.size(); i++) {\n+      forkIds.add(new ForkId(forkHashes.get(i), filteredForks.get(i)));\n     }\n     long forkNext = 0;\n-    if (!forks.isEmpty()) {\n+    if (!filteredForks.isEmpty()) {\n       forkNext = forkIds.get(forkIds.size() - 1).getNext();\n       forkIds.add(new ForkId(forkHashes.get(forkHashes.size() - 1), 0));\n     }", "originalCommit": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NDAxOA==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436864018", "bodyText": "Can't really unless i move everything from static methods to instance methods", "author": "abdelhamidbakhta", "createdAt": "2020-06-08T17:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NTAzMw==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436865033", "bodyText": "ahh ok", "author": "RatanRSur", "createdAt": "2020-06-08T17:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDc3MQ=="}], "type": "inlineReview"}, {"oid": "e859dd2fa6d4f7149b66666750cb230f5351a8d2", "url": "https://github.com/hyperledger/besu/commit/e859dd2fa6d4f7149b66666750cb230f5351a8d2", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-08T16:47:52Z", "type": "commit"}, {"oid": "1a91f7837870b07f1d3db04bfa4ff701f7e2a1aa", "url": "https://github.com/hyperledger/besu/commit/1a91f7837870b07f1d3db04bfa4ff701f7e2a1aa", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-08T17:18:23Z", "type": "commit"}, {"oid": "19081d5602722308acd5f39e0672a9990397ffe2", "url": "https://github.com/hyperledger/besu/commit/19081d5602722308acd5f39e0672a9990397ffe2", "message": "Refactor tests\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-09T09:14:09Z", "type": "commit"}, {"oid": "29f7e60a78d285f63bb564f33115eba8c1c8bbb7", "url": "https://github.com/hyperledger/besu/commit/29f7e60a78d285f63bb564f33115eba8c1c8bbb7", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-09T09:14:34Z", "type": "commit"}, {"oid": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae", "url": "https://github.com/hyperledger/besu/commit/0c5cf8151b6e27bfbde25c4e41f50e831241a8ae", "message": "Refactor ForkIdManager\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-09T12:51:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4NTA5Mg==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437485092", "bodyText": "Is there a way to get this from the forkAndHashList? If I understand correctly we just need to filter out the hashes that are for forks past the chain head, right?", "author": "RatanRSur", "createdAt": "2020-06-09T14:51:20Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -39,69 +36,58 @@\n   private final Hash genesisHash;\n   private final List<ForkId> forkAndHashList;\n \n-  private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n+  private final long forkNext;\n+  private final boolean onlyZerosForkBlocks;\n+  private final long highestKnownFork;\n \n-  public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n+  public ForkIdManager(final Blockchain blockchain, final List<Long> nonFilteredForks) {\n     checkNotNull(blockchain);\n-    checkNotNull(forks);\n+    checkNotNull(nonFilteredForks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n-    final Predicate<ForkId> legacyForkIdChecker =\n-        createForkIDChecker(\n-            blockchain,\n-            genesisHash,\n-            forks,\n-            fs ->\n-                fs.stream()\n-                    .filter(fork -> fork > 0)\n-                    .distinct()\n-                    .collect(Collectors.toUnmodifiableList()),\n-            forkAndHashList);\n-    // if the fork list contains only zeros then we may be in a consortium/dev network\n-    if (onlyZerosForkBlocks(forks)) {\n-      this.forkIDCheckers = singletonList(forkId -> true);\n-    } else {\n-      final Predicate<ForkId> newForkIdChecker =\n-          createForkIDChecker(\n-              blockchain,\n-              genesisHash,\n-              forks,\n-              fs -> fs.stream().distinct().collect(Collectors.toUnmodifiableList()),\n-              new ArrayList<>());\n-      this.forkIDCheckers = Arrays.asList(newForkIdChecker, legacyForkIdChecker);\n-    }\n-  }\n-\n-  private static Predicate<ForkId> createForkIDChecker(\n-      final Blockchain blockchain,\n-      final Hash genesisHash,\n-      final List<Long> forks,\n-      final Function<List<Long>, List<Long>> sanitizer,\n-      final List<ForkId> forkIds) {\n-    final List<Long> sanitizedForks = sanitizer.apply(forks);\n-    final long forkNext = createForkIds(genesisHash, sanitizedForks, forkIds);\n-    return eip2124(blockchain, forkNext, forkIds, highestKnownFork(sanitizedForks));\n+    this.forks =\n+        nonFilteredForks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());\n+    this.onlyZerosForkBlocks = nonFilteredForks.stream().allMatch(value -> 0L == value);\n+    this.forkNext = createForkIds();\n+    this.highestKnownFork = !forks.isEmpty() ? forks.get(forks.size() - 1) : 0L;\n   }\n \n-  private static boolean onlyZerosForkBlocks(final List<Long> forks) {\n-    return forks.stream().allMatch(value -> 0L == value);\n-  }\n+  public ForkId computeForkId() {\n+    final long head = chainHeadSupplier.getAsLong();\n+    if (lastHead != 0 && head == lastHead && lastComputedForkId != null) {\n+      return lastComputedForkId;\n+    }\n+    lastHead = head;\n \n-  private static long highestKnownFork(final List<Long> forks) {\n-    return !forks.isEmpty() ? forks.get(forks.size() - 1) : 0L;\n+    final CRC32 crc = new CRC32();\n+    long next = 0;\n+    crc.update(genesisHash.toArray());\n+    for (final Long fork : forks) {\n+      if (fork <= head) {\n+        updateCrc(crc, fork);\n+        continue;\n+      }\n+      next = fork;\n+      break;\n+    }\n+    lastComputedForkId = new ForkId(getCurrentCrcHash(crc), next);\n+    return lastComputedForkId;", "originalCommit": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4OTQxNg==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437489416", "bodyText": "Maybe we can. Let me check.", "author": "abdelhamidbakhta", "createdAt": "2020-06-09T14:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4NTA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUwMDA3Ng==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437500076", "bodyText": "Well. We can", "author": "abdelhamidbakhta", "createdAt": "2020-06-09T15:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4NTA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUwMjU3Mg==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437502572", "bodyText": "Fixed here db09f76", "author": "abdelhamidbakhta", "createdAt": "2020-06-09T15:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4NTA5Mg=="}], "type": "inlineReview"}, {"oid": "db09f7677652d3ad561b2f78746b98e796f277ad", "url": "https://github.com/hyperledger/besu/commit/db09f7677652d3ad561b2f78746b98e796f277ad", "message": "Simplify fork id computation\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-09T15:11:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNDIyOQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437524229", "bodyText": "nit: java.lang.Long#reverseBytes is quicker and hotspot compiles faster.", "author": "shemnon", "createdAt": "2020-06-09T15:32:17Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkId.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager;\n+\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+import org.hyperledger.besu.ethereum.rlp.RLPOutput;\n+import org.hyperledger.besu.util.EndianUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public class ForkId {\n+  final Bytes hash;\n+  final Bytes next;\n+  Bytes forkIdRLP;\n+\n+  protected ForkId(final Bytes hash, final Bytes next) {\n+    this.hash = hash;\n+    this.next = next;\n+    createForkIdRLP();\n+  }\n+\n+  public ForkId(final Bytes hash, final long next) {\n+    this(hash, Bytes.wrap(EndianUtils.longToBigEndian(next)).trimLeadingZeros());", "originalCommit": "db09f7677652d3ad561b2f78746b98e796f277ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNTc2OQ==", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437525769", "bodyText": "nit: we don't need this.  Integer and Long both have reerseBytes that can do this as HotSpot 'Intrinsic' methods, which means it goes straight to ASM when JITed.", "author": "shemnon", "createdAt": "2020-06-09T15:34:25Z", "path": "util/src/main/java/org/hyperledger/besu/util/EndianUtils.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.util;\n+\n+public class EndianUtils {", "originalCommit": "db09f7677652d3ad561b2f78746b98e796f277ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}