{"pr_number": 1241, "pr_title": "Updated private transaction processing to generate private receipt for invalid transactions", "pr_createdAt": "2020-07-21T13:18:31Z", "pr_url": "https://github.com/hyperledger/besu/pull/1241", "timeline": [{"oid": "1251fe2f6391e7feea9835858b069b860ca4da29", "url": "https://github.com/hyperledger/besu/commit/1251fe2f6391e7feea9835858b069b860ca4da29", "message": "Added invalid transaction receipt creation + tests.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-07-21T05:46:49Z", "type": "commit"}, {"oid": "09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "url": "https://github.com/hyperledger/besu/commit/09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "message": "Unit test for invalid transaction.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-07-21T12:36:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxMzc5Ng==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458413796", "bodyText": "Could this somehow introduce backwards incompatibility? I'm thinking of node that will resync in a network that already has processed PMTs... Could the public state end up being different because of this change?\nIt might be worth testing this!\nWhat do you think @pinges ?", "author": "lucassaldanha", "createdAt": "2020-07-21T22:00:22Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -165,7 +168,7 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n           result);\n     }\n \n-    return result.getOutput();\n+    return Bytes.EMPTY;", "originalCommit": "09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NjA2Mg==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458496062", "bodyText": "I changed this and meant to revert it, though I'm interested in @pinges opinion.", "author": "mark-terry", "createdAt": "2020-07-22T02:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxMzc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNDI4NQ==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458414285", "bodyText": "NIT: we could use a switch statement here, couldn't we?", "author": "lucassaldanha", "createdAt": "2020-07-21T22:01:25Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateTransactionReceipt.java", "diffHunk": "@@ -64,12 +62,22 @@ public PrivateTransactionReceipt(\n \n   public PrivateTransactionReceipt(final TransactionProcessor.Result result) {\n     this(\n-        result.getStatus() == PrivateTransactionProcessor.Result.Status.SUCCESSFUL ? 1 : 0,\n+        getStatusCode(result.getStatus()),\n         result.getLogs(),\n         result.getOutput(),\n         result.getRevertReason());\n   }\n \n+  private static int getStatusCode(final TransactionProcessor.Result.Status result) {\n+    if (result.equals(PrivateTransactionProcessor.Result.Status.SUCCESSFUL)) {", "originalCommit": "09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNjc0OA==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458416748", "bodyText": "Also, we could introduce constants STATUS_SUCCESSFUL = 1, STATUS_FAILED = 0 and STATUS_INVALID = 2 to highlight the mapping btw status and the numbers.", "author": "lucassaldanha", "createdAt": "2020-07-21T22:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNDI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNTE5Mw==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458415193", "bodyText": "PrivGetInvalidTransactionReceiptSuccess is a bit confusing... It has Invalid and Success together :P\nMaybe if we use something like\nPrivGetExpectedInvalidTransactionReceipt or something like that?", "author": "lucassaldanha", "createdAt": "2020-07-21T22:03:42Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/condition/priv/PrivGetInvalidTransactionReceiptSuccess.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.dsl.condition.priv;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.hyperledger.besu.tests.acceptance.dsl.WaitUtils;\n+import org.hyperledger.besu.tests.acceptance.dsl.condition.Condition;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.Node;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivGetTransactionReceiptTransaction;\n+\n+public class PrivGetInvalidTransactionReceiptSuccess implements Condition {", "originalCommit": "09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5ODA4NQ==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458498085", "bodyText": "Good suggestion!", "author": "mark-terry", "createdAt": "2020-07-22T02:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNTE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNTk2Mg==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458415962", "bodyText": "I can see a test for a successful private tx and for an invalid private tx. What about a failed private tx?", "author": "lucassaldanha", "createdAt": "2020-07-21T22:05:22Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/PrivacyReceiptAcceptanceTest.java", "diffHunk": "@@ -81,6 +84,37 @@ public void createPrivateTransactionReceiptFailedTransaction() {\n     alice.getBesu().verify(priv.getFailedTransactionReceipt(transactionHash));\n   }\n \n+  @Test\n+  public void createPrivateTransactionReceiptInvalidTransaction() {\n+    final CreatePrivacyGroupTransaction onlyAlice =\n+        privacyTransactions.createPrivacyGroup(\"Only Alice\", \"\", alice);\n+\n+    final String privacyGroupId = alice.execute(onlyAlice);\n+\n+    final PrivateTransaction invalidPayloadTransaction =\n+        createSignedTransaction(alice, privacyGroupId, empty());\n+    final BytesValueRLPOutput rlpOutput = getRLPOutput(invalidPayloadTransaction);\n+\n+    // Stop mining, to allow adding duplicate nonce block\n+    alice.getBesu().execute(minerTransactions.minerStop());\n+\n+    final Hash transactionHash1 =\n+        alice.execute(privacyTransactions.sendRawTransaction(rlpOutput.encoded().toHexString()));\n+    final Hash transactionHash2 =\n+        alice.execute(privacyTransactions.sendRawTransaction(rlpOutput.encoded().toHexString()));\n+\n+    // Start mining again\n+    alice.getBesu().execute(minerTransactions.minerStart());\n+\n+    // Successful PMTs\n+    alice.getBesu().verify(eth.expectSuccessfulTransactionReceipt(transactionHash1.toString()));\n+    alice.getBesu().verify(eth.expectSuccessfulTransactionReceipt(transactionHash2.toString()));\n+    // Successful first private transaction\n+    alice.getBesu().verify(priv.getSuccessfulTransactionReceipt(transactionHash1));\n+    // Invalid second private transaction\n+    alice.getBesu().verify(priv.getInvalidTransactionReceipt(transactionHash2));", "originalCommit": "09fb1e9e1f92510b5fcfba8b9df36bd4375e28c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5NzQ3Mw==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r458497473", "bodyText": "That's in the previous test.", "author": "mark-terry", "createdAt": "2020-07-22T02:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNTk2Mg=="}], "type": "inlineReview"}, {"oid": "77dd0fabb1517ec5a6ba4110a06eee319074af4b", "url": "https://github.com/hyperledger/besu/commit/77dd0fabb1517ec5a6ba4110a06eee319074af4b", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-07-22T02:54:08Z", "type": "commit"}, {"oid": "42faaf18f7a7942c1f336f44961cadda1ee8e1a1", "url": "https://github.com/hyperledger/besu/commit/42faaf18f7a7942c1f336f44961cadda1ee8e1a1", "message": "Merge branch 'master' into 1117", "committedDate": "2020-07-22T02:58:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNTkyMA==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r459215920", "bodyText": "Not sure about this default. We might want to fail if there is a value that we do not expect?", "author": "pinges", "createdAt": "2020-07-23T05:03:58Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateTransactionReceipt.java", "diffHunk": "@@ -64,12 +66,23 @@ public PrivateTransactionReceipt(\n \n   public PrivateTransactionReceipt(final TransactionProcessor.Result result) {\n     this(\n-        result.getStatus() == PrivateTransactionProcessor.Result.Status.SUCCESSFUL ? 1 : 0,\n+        getStatusCode(result.getStatus()),\n         result.getLogs(),\n         result.getOutput(),\n         result.getRevertReason());\n   }\n \n+  private static int getStatusCode(final TransactionProcessor.Result.Status result) {\n+    switch (result) {\n+      case SUCCESSFUL:\n+        return STATUS_SUCCESSFUL;\n+      case INVALID:\n+        return STATUS_INVALID;\n+      default:\n+        return STATUS_FAILED;", "originalCommit": "42faaf18f7a7942c1f336f44961cadda1ee8e1a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzMDYzOA==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r459830638", "bodyText": "I see what you're saying, but that'd then require an additional status code, yeah? ie:\n0 = fail\n1 = success\n2 = invalid\n3 = other ?", "author": "mark-terry", "createdAt": "2020-07-24T03:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNTkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyODUyNg==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r460228526", "bodyText": "It should never be anything but FAILED, SUCCESS or INVALID. I believe what Stefan suggested is that the default case should throw an exception (InvalidState maybe) or something to notify that there is something wrong.", "author": "lucassaldanha", "createdAt": "2020-07-24T18:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNTkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYxNjE3NQ==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r460616175", "bodyText": "Updated.", "author": "mark-terry", "createdAt": "2020-07-27T02:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNTkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNjQyMg==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r459216422", "bodyText": "We are not really processing it, maybe storeTransactionReceipt would be better?", "author": "pinges", "createdAt": "2020-07-23T05:06:06Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/PrivacyPrecompiledContract.java", "diffHunk": "@@ -206,17 +209,20 @@ void persistPrivateState(\n         disposablePrivateState.rootHash(),\n         privateStateUpdater);\n \n-    final int txStatus =\n-        result.getStatus() == PrivateTransactionProcessor.Result.Status.SUCCESSFUL ? 1 : 0;\n+    maybeUpdateGroupHeadBlockMap(privacyGroupId, currentBlockHash, privateStateUpdater);\n \n-    final PrivateTransactionReceipt privateTransactionReceipt =\n-        new PrivateTransactionReceipt(\n-            txStatus, result.getLogs(), result.getOutput(), result.getRevertReason());\n+    processTransactionReceipt(commitmentHash, currentBlockHash, result, privateStateUpdater);\n+  }\n \n-    privateStateUpdater.putTransactionReceipt(\n-        currentBlockHash, commitmentHash, privateTransactionReceipt);\n+  void processTransactionReceipt(", "originalCommit": "42faaf18f7a7942c1f336f44961cadda1ee8e1a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNDE2Mw==", "url": "https://github.com/hyperledger/besu/pull/1241#discussion_r459804163", "bodyText": "I think the code would be easier to read if you moved the commit out of this method, as there is data being committed that is not created in this method.", "author": "pinges", "createdAt": "2020-07-24T00:51:08Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/PrivacyPrecompiledContract.java", "diffHunk": "@@ -206,17 +209,20 @@ void persistPrivateState(\n         disposablePrivateState.rootHash(),\n         privateStateUpdater);\n \n-    final int txStatus =\n-        result.getStatus() == PrivateTransactionProcessor.Result.Status.SUCCESSFUL ? 1 : 0;\n+    maybeUpdateGroupHeadBlockMap(privacyGroupId, currentBlockHash, privateStateUpdater);\n \n-    final PrivateTransactionReceipt privateTransactionReceipt =\n-        new PrivateTransactionReceipt(\n-            txStatus, result.getLogs(), result.getOutput(), result.getRevertReason());\n+    processTransactionReceipt(commitmentHash, currentBlockHash, result, privateStateUpdater);\n+  }\n \n-    privateStateUpdater.putTransactionReceipt(\n-        currentBlockHash, commitmentHash, privateTransactionReceipt);\n+  void processTransactionReceipt(\n+      final Hash pmtHash,\n+      final Hash currentBlockHash,\n+      final PrivateTransactionProcessor.Result result,\n+      final PrivateStateStorage.Updater privateStateUpdater) {\n+    final PrivateTransactionReceipt privateTransactionReceipt =\n+        new PrivateTransactionReceipt(result);\n \n-    maybeUpdateGroupHeadBlockMap(privacyGroupId, currentBlockHash, privateStateUpdater);\n+    privateStateUpdater.putTransactionReceipt(currentBlockHash, pmtHash, privateTransactionReceipt);\n \n     privateStateUpdater.commit();", "originalCommit": "42faaf18f7a7942c1f336f44961cadda1ee8e1a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cff4ff6f609b118ccf87765693dab2e4fbb10252", "url": "https://github.com/hyperledger/besu/commit/cff4ff6f609b118ccf87765693dab2e4fbb10252", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-07-27T02:29:56Z", "type": "commit"}, {"oid": "ab58d4b04a4d8ea9092442788f0be64390fe5036", "url": "https://github.com/hyperledger/besu/commit/ab58d4b04a4d8ea9092442788f0be64390fe5036", "message": "Merge branch 'master' into 1117", "committedDate": "2020-07-27T02:31:40Z", "type": "commit"}, {"oid": "379dc152f5cbd9025affc2ca2292a53e851b946c", "url": "https://github.com/hyperledger/besu/commit/379dc152f5cbd9025affc2ca2292a53e851b946c", "message": "Fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-07-27T14:34:05Z", "type": "commit"}, {"oid": "2102d738d82eb14c12f06c98aa73b231c94e7032", "url": "https://github.com/hyperledger/besu/commit/2102d738d82eb14c12f06c98aa73b231c94e7032", "message": "Merge branch 'master' into 1117", "committedDate": "2020-07-27T22:40:29Z", "type": "commit"}]}