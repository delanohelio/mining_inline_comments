{"pr_number": 947, "pr_title": "make mark/sweep prepare async with main thread", "pr_createdAt": "2020-05-19T16:00:20Z", "pr_url": "https://github.com/hyperledger/besu/pull/947", "timeline": [{"oid": "655113820b1bb67ccbf9ceaa850e1e8cbf87e618", "url": "https://github.com/hyperledger/besu/commit/655113820b1bb67ccbf9ceaa850e1e8cbf87e618", "message": "make mark/sweep prepare async with main thread\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-05-19T15:49:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTU0OA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r427429548", "bodyText": "Should the whole block be in the execute runnable?  i.e. add the compare and set check into the async part?  Are we sure start will only ever be called once?", "author": "shemnon", "createdAt": "2020-05-19T16:18:18Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/worldstate/Pruner.java", "diffHunk": "@@ -84,12 +84,14 @@ public Pruner(\n   }\n \n   public void start() {\n-\n     if (state.compareAndSet(State.IDLE, State.RUNNING)) {", "originalCommit": "655113820b1bb67ccbf9ceaa850e1e8cbf87e618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUzMzU2MA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r430533560", "bodyText": "I think we could call this as many times as we like and the compareAndSet would make sure that the if body is only executed once, right? That said, I don't mind pushing the whole thing into the execute. Works for me.", "author": "RatanRSur", "createdAt": "2020-05-26T16:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1NjU3NQ==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r430656575", "bodyText": "The executor may back up, so we could queue up a bunch of the lambdas for execution before the first one starts (which is where I presume the stat gets set to running or prepare).  While the test is idempotent the execution does not appear on its surface to be, especially since we are adding observers inside the async function.", "author": "shemnon", "createdAt": "2020-05-26T19:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk0MzAzNg==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431943036", "bodyText": "The state variable  is an AtomicReference - the code inside the block is guaranteed to execute at most once as it's currently written.", "author": "mbaxter", "createdAt": "2020-05-28T15:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk1MTE3Ng==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431951176", "bodyText": "nm - I think I see the issue:  the startup logic could actually run after the shutdown logic because you don't know when it will actually execute \ud83d\udc4d", "author": "mbaxter", "createdAt": "2020-05-28T16:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyOTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzMTAyOA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r427431028", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void start() {\n          \n          \n            \n            \n          \n          \n            \n                if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n          \n          \n            \n                  LOG.info(\"Starting Pruner.\");\n          \n          \n            \n                  executorService = executorServiceSupplier.get();\n          \n          \n            \n                  pruningStrategy.prepare();\n          \n          \n            \n                  blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                  execute(\n          \n          \n            \n                      () -> {\n          \n          \n            \n                        pruningStrategy.prepare();\n          \n          \n            \n                        blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                      });\n          \n          \n            \n                }\n          \n          \n            \n              }\n          \n          \n            \n              public void start() {\n          \n          \n            \n                execute(this::startAsync);\n          \n          \n            \n              }\n          \n          \n            \n            \n          \n          \n            \n              private void startAsync() {\n          \n          \n            \n                  LOG.info(\"Starting Pruner.\");\n          \n          \n            \n                  executorService = executorServiceSupplier.get();\n          \n          \n            \n                  pruningStrategy.prepare();\n          \n          \n            \n                  blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                  pruningStrategy.prepare();\n          \n          \n            \n                  blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                }\n          \n          \n            \n              }", "author": "shemnon", "createdAt": "2020-05-19T16:20:21Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/worldstate/Pruner.java", "diffHunk": "@@ -84,12 +84,14 @@ public Pruner(\n   }\n \n   public void start() {\n-\n     if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n       LOG.info(\"Starting Pruner.\");\n       executorService = executorServiceSupplier.get();\n-      pruningStrategy.prepare();\n-      blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n+      execute(\n+          () -> {\n+            pruningStrategy.prepare();\n+            blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n+          });\n     }\n   }", "originalCommit": "655113820b1bb67ccbf9ceaa850e1e8cbf87e618", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2276ed75e17a54077503eb888d09de06f61b5eb5", "url": "https://github.com/hyperledger/besu/commit/2276ed75e17a54077503eb888d09de06f61b5eb5", "message": "Merge remote-tracking branch 'upstream/master' into pruner-start-asynchrony", "committedDate": "2020-05-26T16:10:57Z", "type": "commit"}, {"oid": "74350ba5b68f63d6e4c1c6a842a0f0de79e35254", "url": "https://github.com/hyperledger/besu/commit/74350ba5b68f63d6e4c1c6a842a0f0de79e35254", "message": "push all start code into execute\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-05-26T16:12:26Z", "type": "commit"}, {"oid": "463f9053396444121b5a548a9b7806afb792f765", "url": "https://github.com/hyperledger/besu/commit/463f9053396444121b5a548a9b7806afb792f765", "message": "Merge branch 'master' into pruner-start-asynchrony", "committedDate": "2020-05-26T20:54:21Z", "type": "commit"}, {"oid": "c458c055c64cd1f2c9884cae8e1518d95df0e854", "url": "https://github.com/hyperledger/besu/commit/c458c055c64cd1f2c9884cae8e1518d95df0e854", "message": "remove executor supplier so that executor is available in start\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-05-28T13:55:15Z", "type": "commit"}, {"oid": "1bbe7443e308a2c68060a752e5da08ab34b0491f", "url": "https://github.com/hyperledger/besu/commit/1bbe7443e308a2c68060a752e5da08ab34b0491f", "message": "Merge remote-tracking branch 'upstream/master' into pruner-start-asynchrony", "committedDate": "2020-05-28T13:55:42Z", "type": "commit"}, {"oid": "b2fc0cd10fc9bb5e80fb62f8f85a9ea19065ce09", "url": "https://github.com/hyperledger/besu/commit/b2fc0cd10fc9bb5e80fb62f8f85a9ea19065ce09", "message": "fix compile errors\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-05-28T13:58:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNDg0Mw==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431924843", "bodyText": "Not sure why you can't get your executor and then run the async task?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                execute(\n          \n          \n            \n                    () -> {\n          \n          \n            \n                      if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n          \n          \n            \n                        LOG.info(\"Starting Pruner.\");\n          \n          \n            \n                        pruningStrategy.prepare();\n          \n          \n            \n                        blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                      }\n          \n          \n            \n                    });\n          \n          \n            \n                if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n          \n          \n            \n                  LOG.info(\"Starting Pruner.\");\n          \n          \n            \n                  executorService = executorServiceSupplier.get();\n          \n          \n            \n                  execute(() -> {\n          \n          \n            \n                      pruningStrategy.prepare();\n          \n          \n            \n                      blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n          \n          \n            \n                  });\n          \n          \n            \n                }", "author": "mbaxter", "createdAt": "2020-05-28T15:26:42Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/worldstate/Pruner.java", "diffHunk": "@@ -70,27 +68,27 @@ public Pruner(\n       final MarkSweepPruner pruningStrategy,\n       final Blockchain blockchain,\n       final PrunerConfiguration prunerConfiguration) {\n-    this(pruningStrategy, blockchain, prunerConfiguration, getDefaultExecutorSupplier());\n-  }\n-\n-  private static Supplier<ExecutorService> getDefaultExecutorSupplier() {\n-    return () ->\n+    this(\n+        pruningStrategy,\n+        blockchain,\n+        prunerConfiguration,\n         Executors.newSingleThreadExecutor(\n             new ThreadFactoryBuilder()\n                 .setDaemon(true)\n                 .setPriority(Thread.MIN_PRIORITY)\n                 .setNameFormat(\"StatePruning-%d\")\n-                .build());\n+                .build()));\n   }\n \n   public void start() {\n-\n-    if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n-      LOG.info(\"Starting Pruner.\");\n-      executorService = executorServiceSupplier.get();\n-      pruningStrategy.prepare();\n-      blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n-    }\n+    execute(\n+        () -> {\n+          if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n+            LOG.info(\"Starting Pruner.\");\n+            pruningStrategy.prepare();\n+            blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n+          }\n+        });", "originalCommit": "b2fc0cd10fc9bb5e80fb62f8f85a9ea19065ce09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMTI1MA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431931250", "bodyText": "That's how I initially had it \ud83d\ude05. Danno mentioned something about the executor backing up. Tbh I didn't understand his point fully but I was going to look into it later. I was thinking that the AtomicBool should be enough to prevent starting it multiple times.", "author": "RatanRSur", "createdAt": "2020-05-28T15:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNDg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMTQ1MQ==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431931451", "bodyText": "Look at just the first commit in the PR", "author": "RatanRSur", "createdAt": "2020-05-28T15:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNDg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNzEwOA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431927108", "bodyText": "Is this not going to create timing issues?  I think we may be intentionally blocking here, so that our listeners get setup before we start syncing and pulling in data.  Changing this to async, it seems like we might run into problems where:  we start importing blocks before our listeners are set up, we don't mark those initial state data, so we end up pruning useful state.\nI'd suggest returning a future, and waiting for the future to complete before starting the sync task.", "author": "mbaxter", "createdAt": "2020-05-28T15:29:35Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/worldstate/Pruner.java", "diffHunk": "@@ -70,27 +68,27 @@ public Pruner(\n       final MarkSweepPruner pruningStrategy,\n       final Blockchain blockchain,\n       final PrunerConfiguration prunerConfiguration) {\n-    this(pruningStrategy, blockchain, prunerConfiguration, getDefaultExecutorSupplier());\n-  }\n-\n-  private static Supplier<ExecutorService> getDefaultExecutorSupplier() {\n-    return () ->\n+    this(\n+        pruningStrategy,\n+        blockchain,\n+        prunerConfiguration,\n         Executors.newSingleThreadExecutor(\n             new ThreadFactoryBuilder()\n                 .setDaemon(true)\n                 .setPriority(Thread.MIN_PRIORITY)\n                 .setNameFormat(\"StatePruning-%d\")\n-                .build());\n+                .build()));\n   }\n \n   public void start() {\n-\n-    if (state.compareAndSet(State.IDLE, State.RUNNING)) {\n-      LOG.info(\"Starting Pruner.\");\n-      executorService = executorServiceSupplier.get();\n-      pruningStrategy.prepare();\n-      blockAddedObserverId = blockchain.observeBlockAdded(this::handleNewBlock);\n-    }\n+    execute(", "originalCommit": "b2fc0cd10fc9bb5e80fb62f8f85a9ea19065ce09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMjQ4Mw==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431932483", "bodyText": "I thought about this but it's this runnable that sets up the block added listener so I think we're good.", "author": "RatanRSur", "createdAt": "2020-05-28T15:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNzEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk0ODU1OA==", "url": "https://github.com/hyperledger/besu/pull/947#discussion_r431948558", "bodyText": "Ok, I think that makes sense - we start listening for world state, then start listening for blocks, and the block listener is what starts up the marking phase. \ud83d\udc4d", "author": "mbaxter", "createdAt": "2020-05-28T15:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNzEwOA=="}], "type": "inlineReview"}, {"oid": "3496ae2adf7aa9447b5fce695dff926dc4211d5b", "url": "https://github.com/hyperledger/besu/commit/3496ae2adf7aa9447b5fce695dff926dc4211d5b", "message": "inline single threaded executor and set coreThreads to 0\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-05-28T16:59:27Z", "type": "commit"}, {"oid": "8da302213d3b8f78fa81a1c5c7f5c380fadbfd8d", "url": "https://github.com/hyperledger/besu/commit/8da302213d3b8f78fa81a1c5c7f5c380fadbfd8d", "message": "Merge branch 'master' into pruner-start-asynchrony", "committedDate": "2020-05-28T17:45:17Z", "type": "commit"}]}