{"pr_number": 1228, "pr_title": "Added admin_logsRepairCache end point", "pr_createdAt": "2020-07-16T16:53:15Z", "pr_url": "https://github.com/hyperledger/besu/pull/1228", "timeline": [{"oid": "dad8dae8bd6601bfe0d3f620036ffdc2f657b702", "url": "https://github.com/hyperledger/besu/commit/dad8dae8bd6601bfe0d3f620036ffdc2f657b702", "message": "#1066 Switched to use unprefixed hex strings for memory and stack values\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-26T13:37:13Z", "type": "commit"}, {"oid": "01430e770da93ea19171e1a9683daec7c10677f4", "url": "https://github.com/hyperledger/besu/commit/01430e770da93ea19171e1a9683daec7c10677f4", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-26T16:53:26Z", "type": "commit"}, {"oid": "aac3bd6d4d5c6f16a4ef1e8c1cf7fb3fd8346b7d", "url": "https://github.com/hyperledger/besu/commit/aac3bd6d4d5c6f16a4ef1e8c1cf7fb3fd8346b7d", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-30T17:04:49Z", "type": "commit"}, {"oid": "17aa301cff4a1192efb3a0d3e53e05995dafa744", "url": "https://github.com/hyperledger/besu/commit/17aa301cff4a1192efb3a0d3e53e05995dafa744", "message": "Disable flaky tests per Ben Burns(Yeti) request\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-30T20:58:04Z", "type": "commit"}, {"oid": "4a987ae3bd51de708b0f230a26b56785142ec06f", "url": "https://github.com/hyperledger/besu/commit/4a987ae3bd51de708b0f230a26b56785142ec06f", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-06-30T23:43:03Z", "type": "commit"}, {"oid": "520d3172fad19bb6ff7055c44b6ddce524ee8bce", "url": "https://github.com/hyperledger/besu/commit/520d3172fad19bb6ff7055c44b6ddce524ee8bce", "message": "Revert last commit and enable ignored tests.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-06-30T23:45:44Z", "type": "commit"}, {"oid": "0e61d8699e37f65780ac5985fb841cbb31920ee8", "url": "https://github.com/hyperledger/besu/commit/0e61d8699e37f65780ac5985fb841cbb31920ee8", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-01T19:10:35Z", "type": "commit"}, {"oid": "6fc3bf9be8452f237c8a1eb0b96ede151c8a2427", "url": "https://github.com/hyperledger/besu/commit/6fc3bf9be8452f237c8a1eb0b96ede151c8a2427", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-06T18:44:24Z", "type": "commit"}, {"oid": "47c82ed2dbbf9d1c31e0f60fe0f963d8c16a7362", "url": "https://github.com/hyperledger/besu/commit/47c82ed2dbbf9d1c31e0f60fe0f963d8c16a7362", "message": "#1157 - updated to create 2 agents so that proper bonding can occur\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-06T21:11:34Z", "type": "commit"}, {"oid": "9742c60a6d08924106055868d933b06ec6b41b1f", "url": "https://github.com/hyperledger/besu/commit/9742c60a6d08924106055868d933b06ec6b41b1f", "message": "Merge branch 'master' into master", "committedDate": "2020-07-06T21:26:30Z", "type": "commit"}, {"oid": "a13be1b0ddac0a3972c0b2af59fe86479c22bc02", "url": "https://github.com/hyperledger/besu/commit/a13be1b0ddac0a3972c0b2af59fe86479c22bc02", "message": "Merge branch 'master' into master", "committedDate": "2020-07-06T23:16:30Z", "type": "commit"}, {"oid": "5d8dfe6f80d2ea9a337126b79042207a9a555041", "url": "https://github.com/hyperledger/besu/commit/5d8dfe6f80d2ea9a337126b79042207a9a555041", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-07T13:05:21Z", "type": "commit"}, {"oid": "4c6163d1472d16f60b32ec038ce81cb3abfea6e3", "url": "https://github.com/hyperledger/besu/commit/4c6163d1472d16f60b32ec038ce81cb3abfea6e3", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-08T15:26:54Z", "type": "commit"}, {"oid": "11873402ff1e78d9f0d1edfe3ef0bc4557878133", "url": "https://github.com/hyperledger/besu/commit/11873402ff1e78d9f0d1edfe3ef0bc4557878133", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-09T13:20:06Z", "type": "commit"}, {"oid": "a92d67821b55776d6c1625f40e713d2214fad6f4", "url": "https://github.com/hyperledger/besu/commit/a92d67821b55776d6c1625f40e713d2214fad6f4", "message": "#1162 - Updated test to mock the local peer PING packet creation so that the hash can be managed.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-09T13:27:29Z", "type": "commit"}, {"oid": "b0db56c0bedcd3266e88cb41ef7a2e16fcb63908", "url": "https://github.com/hyperledger/besu/commit/b0db56c0bedcd3266e88cb41ef7a2e16fcb63908", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-14T15:19:03Z", "type": "commit"}, {"oid": "e301b49061e1b443b2da32ae83b7075632f84518", "url": "https://github.com/hyperledger/besu/commit/e301b49061e1b443b2da32ae83b7075632f84518", "message": "Added admin_logsRepairCache end point\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T15:58:11Z", "type": "commit"}, {"oid": "133485e7d254442ac043fdcb8353cd72420fca11", "url": "https://github.com/hyperledger/besu/commit/133485e7d254442ac043fdcb8353cd72420fca11", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-16T15:58:24Z", "type": "commit"}, {"oid": "7d6690d84c242eb5f0bbd1d9863f82a07646a16f", "url": "https://github.com/hyperledger/besu/commit/7d6690d84c242eb5f0bbd1d9863f82a07646a16f", "message": "Added admin_logsRepairCache end point\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T15:59:53Z", "type": "commit"}, {"oid": "ae4776c263bcc77548973645f8cc9b62e38b654b", "url": "https://github.com/hyperledger/besu/commit/ae4776c263bcc77548973645f8cc9b62e38b654b", "message": "Merge branch 'master' into master", "committedDate": "2020-07-16T16:54:14Z", "type": "commit"}, {"oid": "8d09e0340beef2421d0f4272ab5d13918c29f196", "url": "https://github.com/hyperledger/besu/commit/8d09e0340beef2421d0f4272ab5d13918c29f196", "message": "Remove p2p network code per PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T18:04:11Z", "type": "commit"}, {"oid": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "url": "https://github.com/hyperledger/besu/commit/99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "message": "Merge branch 'master' of github.com:hyperledger/besu", "committedDate": "2020-07-16T18:51:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAwOTkzMw==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456009933", "bodyText": "Since the user could actually see this exception, we should put a message in the orElseThrow that explains that this method can't do anything without t a log cacher.", "author": "RatanRSur", "createdAt": "2020-07-16T19:07:18Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private static final String STATUS = \"Status\";\n+\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found\")));\n+\n+    final TransactionLogBloomCacher transactionLogBloomCacher =\n+        blockchainQueries.getTransactionLogBloomCacher().orElseThrow();", "originalCommit": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNDkwNA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456014904", "bodyText": "Since we have it anyways we can put the block the user tried to put in the string and specifically call out that it's too high of a number.", "author": "RatanRSur", "createdAt": "2020-07-16T19:16:37Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private static final String STATUS = \"Status\";\n+\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found\")));", "originalCommit": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxODgxNA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456018814", "bodyText": "Is it possible that this won't actually force the repair of that segment? My quick reading makes it seem like we wouldn't do it if we had the right bloom file size:\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogBloomCacher.java\n    \n    \n         Line 220\n      in\n      e301b49\n    \n    \n    \n    \n\n        \n          \n           if (!cacheFile.isFile() || cacheFile.length() != EXPECTED_BLOOM_FILE_SIZE) { \n        \n    \n  \n\n\nWhat if the size is right but the user wants to force the recalculation because of corruption?", "author": "RatanRSur", "createdAt": "2020-07-16T19:22:53Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private static final String STATUS = \"Status\";\n+\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found\")));\n+\n+    final TransactionLogBloomCacher transactionLogBloomCacher =\n+        blockchainQueries.getTransactionLogBloomCacher().orElseThrow();\n+\n+    transactionLogBloomCacher.ensurePreviousSegmentsArePresent(\n+        blockNumber.orElse(blockchainQueries.headBlockNumber()), true);", "originalCommit": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAzNzU1OA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456037558", "bodyText": "The idea of the end point was to re-do if missing or the wrong size. What you are asking for is additional logic to let the user do it whenever they want. Not sure we want to add that ability to this end point.", "author": "davemec", "createdAt": "2020-07-16T19:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxODgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU2OTg1Mg==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456569852", "bodyText": "This has been updated to always force regeneration when called from the end point.", "author": "davemec", "createdAt": "2020-07-17T17:14:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxODgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyMjk3Mg==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456022972", "bodyText": "Connected to my point above about forcing regeneration, why can't we use cacheLogsBloomForBlockHeader?", "author": "RatanRSur", "createdAt": "2020-07-16T19:29:00Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogBloomCacher.java", "diffHunk": "@@ -202,14 +206,15 @@ private boolean populateLatestSegment(final long eventBlockNumber) {\n     return false;\n   }\n \n-  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+  public void ensurePreviousSegmentsArePresent(\n+      final long blockNumber, final boolean overrideCacheCheck) {\n     if (!cachingStatus.isCaching()) {\n       scheduler.scheduleFutureTask(\n           () -> {\n             long currentSegment = (blockNumber / BLOCKS_PER_BLOOM_CACHE) - 1;\n             while (currentSegment > 0) {\n               try {\n-                if (!cachedSegments.getOrDefault(currentSegment, false)) {\n+                if (overrideCacheCheck || !cachedSegments.getOrDefault(currentSegment, false)) {", "originalCommit": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAzODY5NA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456038694", "bodyText": "Not sure we want to force generation in any case, will verify.", "author": "davemec", "createdAt": "2020-07-16T19:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyMjk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyNzYwNg==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456027606", "bodyText": "I think we want some sort of thread-safe object that can track this. We might be able to get away with an AtomicBoolean", "author": "RatanRSur", "createdAt": "2020-07-16T19:35:30Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private static final String STATUS = \"Status\";\n+\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found\")));\n+\n+    final TransactionLogBloomCacher transactionLogBloomCacher =\n+        blockchainQueries.getTransactionLogBloomCacher().orElseThrow();\n+\n+    transactionLogBloomCacher.ensurePreviousSegmentsArePresent(\n+        blockNumber.orElse(blockchainQueries.headBlockNumber()), true);\n+\n+    final Map<String, Object> response = new HashMap<>();\n+    response.put(STATUS, \"Started\");\n+\n+    if (transactionLogBloomCacher.getCachingStatus().isCaching()) {\n+      response.put(STATUS, \"Already running\");\n+    }", "originalCommit": "99a2d6fb0c5596fc72631fce7d7063dc6c29a57c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0MDQzNA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456040434", "bodyText": "I don't follow, CachingStatus is a static final class where the isCaching method uses an AtomicInteger to keep track of status. Are you speaking about the status message in the response?", "author": "davemec", "createdAt": "2020-07-16T19:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyNzYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA1MDY5NQ==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456050695", "bodyText": "Ah! I missed that.", "author": "RatanRSur", "createdAt": "2020-07-16T20:14:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAyNzYwNg=="}], "type": "inlineReview"}, {"oid": "315149c134ab7f3f70701ed89e28f4c9d1a4954d", "url": "https://github.com/hyperledger/besu/commit/315149c134ab7f3f70701ed89e28f4c9d1a4954d", "message": "Updates from PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T19:56:25Z", "type": "commit"}, {"oid": "2b70082c6dd14ce51dd6bd63d96a875126795390", "url": "https://github.com/hyperledger/besu/commit/2b70082c6dd14ce51dd6bd63d96a875126795390", "message": "Spotless Apply fixes\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-16T21:07:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjExNg==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456086116", "bodyText": "Why is the value type Object?\n(optional) Since we're always going to have a STATUS key and are never going to mutate the Map, we could make the map immutable\n    final Map<String, String> response =\n        Map.of(\n            STATUS,\n            transactionLogBloomCacher.getCachingStatus().isCaching()\n                ? \"Already running\"\n                : \"Started\");", "author": "RatanRSur", "createdAt": "2020-07-16T21:23:44Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private static final String STATUS = \"Status\";\n+\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found, \" + bn)));\n+\n+    final TransactionLogBloomCacher transactionLogBloomCacher =\n+        blockchainQueries\n+            .getTransactionLogBloomCacher()\n+            .orElseThrow(\n+                () -> new InternalError(\"Error attempting to get TransactionLogBloomCacher\"));\n+\n+    transactionLogBloomCacher.ensurePreviousSegmentsArePresent(\n+        blockNumber.orElse(blockchainQueries.headBlockNumber()), true);\n+\n+    final Map<String, Object> response = new HashMap<>();\n+    response.put(STATUS, \"Started\");\n+\n+    if (transactionLogBloomCacher.getCachingStatus().isCaching()) {\n+      response.put(STATUS, \"Already running\");\n+    }", "originalCommit": "2b70082c6dd14ce51dd6bd63d96a875126795390", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1NDE5MQ==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456154191", "bodyText": "Thanks, good catch, not sure why I had it as Object.", "author": "davemec", "createdAt": "2020-07-17T00:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjExNg=="}], "type": "inlineReview"}, {"oid": "f32a56c946022de71be4087c542044c96ec7bed6", "url": "https://github.com/hyperledger/besu/commit/f32a56c946022de71be4087c542044c96ec7bed6", "message": "PR updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-17T00:59:56Z", "type": "commit"}, {"oid": "0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "url": "https://github.com/hyperledger/besu/commit/0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "message": "Admin force cache refresh when called through end point per PR comments\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-17T17:09:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDE1OA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456624158", "bodyText": "@shemnon Would it be alright to change cachedSegments into a TreeSet? Couldn't see anywhere we need the model the ternary of <true, false, not present>", "author": "RatanRSur", "createdAt": "2020-07-17T19:05:26Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogBloomCacher.java", "diffHunk": "@@ -202,17 +206,20 @@ private boolean populateLatestSegment(final long eventBlockNumber) {\n     return false;\n   }\n \n-  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+  public void ensurePreviousSegmentsArePresent(\n+      final long blockNumber, final boolean overrideCacheCheck) {\n     if (!cachingStatus.isCaching()) {\n       scheduler.scheduleFutureTask(\n           () -> {\n             long currentSegment = (blockNumber / BLOCKS_PER_BLOOM_CACHE) - 1;\n             while (currentSegment > 0) {\n               try {\n-                if (!cachedSegments.getOrDefault(currentSegment, false)) {\n+                if (overrideCacheCheck || !cachedSegments.getOrDefault(currentSegment, false)) {", "originalCommit": "0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2Njc5OA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456666798", "bodyText": "@RatanRSur This may be an option but let's leave refactoring to another story.", "author": "davemec", "createdAt": "2020-07-17T20:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY5MDQ2Ng==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456690466", "bodyText": "In another PR is fine.", "author": "shemnon", "createdAt": "2020-07-17T21:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxNjM5MA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456716390", "bodyText": "\ud83d\udc4d", "author": "RatanRSur", "createdAt": "2020-07-17T23:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyNDE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456630555", "bodyText": "We should make this actionable since this is inscrutable to anyone who doesn't know our architecture. If there isn't a TransactionLogBloomCacher, that means the associated option must be disabled. We should tell them that this rpc method doesn't do anything unless they have the cacher enabled.", "author": "RatanRSur", "createdAt": "2020-07-17T19:20:11Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.api.query.TransactionLogBloomCacher;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public class AdminLogsRepairCache implements JsonRpcMethod {\n+  private final BlockchainQueries blockchainQueries;\n+\n+  public AdminLogsRepairCache(final BlockchainQueries blockchainQueries) {\n+    this.blockchainQueries = blockchainQueries;\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.ADMIN_LOGS_REPAIR_CACHE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    final Optional<Long> blockNumber = requestContext.getOptionalParameter(0, Long.class);\n+\n+    blockNumber.ifPresent(\n+        bn ->\n+            blockchainQueries\n+                .getBlockchain()\n+                .getBlockByNumber(bn)\n+                .orElseThrow(() -> new IllegalStateException(\"Block not found, \" + bn)));\n+\n+    final TransactionLogBloomCacher transactionLogBloomCacher =\n+        blockchainQueries\n+            .getTransactionLogBloomCacher()\n+            .orElseThrow(\n+                () -> new InternalError(\"Error attempting to get TransactionLogBloomCacher\"));", "originalCommit": "0a9c73d8c69750635a0ccbcac69a347e8b4c3949", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NzU3Ng==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456667576", "bodyText": "I can update this message, but don't follow what you mean by actionable. I will update the message to state more info about the need for the TransactionLogBloomCacher but aside from that I don't think there is much more this end point should do for them.", "author": "davemec", "createdAt": "2020-07-17T20:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxNzA3Ng==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456717076", "bodyText": "It's the difference between the user seeing \"Error something didn't work...\", which might make them think it's our problem, vs \"Can't repair caches because the transaction log bloom cacher isn't enabled. Try enabling it with insert option name here\"", "author": "RatanRSur", "createdAt": "2020-07-17T23:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxODMyMA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r456718320", "bodyText": "Basically what I mean by actionable is that it empowers them to understand and fix the issue since the reason they're trying to access this method is because things are going wrong.\nI can easily imagine this happening:\nlogs are innacurate -> they turn log caching off -> they forget to turn it back on -> they try to repair it -> we give them another error that they don't understand\nWe want to change that last step so it's instead:\n\"oh, I didn't know I needed to enable the caching going forward to be able to repair it, I'll go do that now.\"", "author": "RatanRSur", "createdAt": "2020-07-17T23:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0Mjc5OA==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r457342798", "bodyText": "I will make the update but this is possibly our issue. When something like this goes wrong it is not always just the user entering the wrong command, it can also be a major issue within the software itself.", "author": "davemec", "createdAt": "2020-07-20T12:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4NjAwMg==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r457486002", "bodyText": "You're right that there's one other case. If we had an empty optional even though the user had the log cacher enabled that means that we have a bug in our configuration code. Even this eventuality can be handled with a sentence like \"If this message persists, create an issue.\"\nI guess what I'm having a hard time understanding is what is the argument for terse and opaque error messages. We don't have word limits on these. As we improve the software and have more people relying on us, we want to create as painless of an experience for them as possible. Like I said before working with this endpoint at all is a result of instability in the log cacher, so things are already going wrong. I'm on linux so I know how it feels to hit error after error in software someone else wrote ;) It's pretty frustrating.", "author": "RatanRSur", "createdAt": "2020-07-20T15:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ5MTAyOQ==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r457491029", "bodyText": "Agreed, my initial message was really not helpful. I think this is something we can improve as you mention as we go forward.", "author": "davemec", "createdAt": "2020-07-20T15:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzMDU1NQ=="}], "type": "inlineReview"}, {"oid": "2bba686aa081d3b1d63af237f605a36a76b9753a", "url": "https://github.com/hyperledger/besu/commit/2bba686aa081d3b1d63af237f605a36a76b9753a", "message": "Pr updates\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>", "committedDate": "2020-07-20T12:49:02Z", "type": "commit"}, {"oid": "462ef6f3358e3be9df7757a796ed6fe5387bad43", "url": "https://github.com/hyperledger/besu/commit/462ef6f3358e3be9df7757a796ed6fe5387bad43", "message": "Merge branch 'master' into master", "committedDate": "2020-07-20T13:40:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4NzMyNw==", "url": "https://github.com/hyperledger/besu/pull/1228#discussion_r457487327", "bodyText": "This is good! It covers the case where we have an error while also addressing the most likely case", "author": "RatanRSur", "createdAt": "2020-07-20T15:20:33Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/AdminLogsRepairCache.java", "diffHunk": "@@ -51,7 +51,9 @@ public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n         blockchainQueries\n             .getTransactionLogBloomCacher()\n             .orElseThrow(\n-                () -> new InternalError(\"Error attempting to get TransactionLogBloomCacher\"));\n+                () ->\n+                    new InternalError(\n+                        \"Error attempting to get TransactionLogBloomCacher. Please ensure that the TransactionLogBloomCacher is enabled.\"));", "originalCommit": "462ef6f3358e3be9df7757a796ed6fe5387bad43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}