{"pr_number": 427, "pr_title": "[BESU-194] Remove max pivot block resets during fast sync", "pr_createdAt": "2020-02-24T10:52:05Z", "pr_url": "https://github.com/hyperledger/besu/pull/427", "timeline": [{"oid": "6a964f93d03ba14270db056449a8710712400b91", "url": "https://github.com/hyperledger/besu/commit/6a964f93d03ba14270db056449a8710712400b91", "message": "remove max pivot block resets during fast sync\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-24T10:00:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MjQ0Ng==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r383382446", "bodyText": "This is the wrong log message now, it should complain about the selected pivot block being negative or at genesis.  Retries won't trigger this.", "author": "shemnon", "createdAt": "2020-02-24T16:46:09Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -147,9 +126,10 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n         contestedBlockNumber, contestedBlockNumber - pivotBlockNumberResetDelta)) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n-      final int retryCount = confirmationTasks.size();\n-      if (retryCount > maxPivotBlockResets\n-          || pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n+      if (confirmationTasks.size() > SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");\n+      }\n+      if (pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n         LOG.info(\"Max retries reached, cancel pivot block download.\");", "originalCommit": "6a964f93d03ba14270db056449a8710712400b91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ1MDMxOA==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r383450318", "bodyText": "I'd print a warning periodically (every SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS retries?) rather than on every individual retry.  Also, confirmationTasks can now grow very large, so we'll probably need to rework how we track tasks so we don't hold onto every confirmation task we created.\nAlternatively, I wonder if we could alleviate the problem of prematurely switching to full sync by just increasing DEFAULT_MAX_PIVOT_BLOCK_RESETS and making sure we retry fast sync here: \n  \n    \n      besu/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/DefaultSynchronizer.java\n    \n    \n         Line 166\n      in\n      7fe1d47\n    \n    \n    \n    \n\n        \n          \n           LOG.error(\"Fast sync failed, switching to full sync.\", error); \n        \n    \n  \n\n ...", "author": "mbaxter", "createdAt": "2020-02-24T18:55:16Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -147,9 +126,10 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n         contestedBlockNumber, contestedBlockNumber - pivotBlockNumberResetDelta)) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n-      final int retryCount = confirmationTasks.size();\n-      if (retryCount > maxPivotBlockResets\n-          || pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n+      if (confirmationTasks.size() > SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");", "originalCommit": "6a964f93d03ba14270db056449a8710712400b91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fe85838e4a8c729094b803910087362ba80e109", "url": "https://github.com/hyperledger/besu/commit/1fe85838e4a8c729094b803910087362ba80e109", "message": "increase retry number and add retry for fast sync\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-25T17:28:28Z", "type": "commit"}, {"oid": "b2a4326f5d1614916591ec97ebf949f84595ce74", "url": "https://github.com/hyperledger/besu/commit/b2a4326f5d1614916591ec97ebf949f84595ce74", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T11:22:29Z", "type": "commit"}, {"oid": "66e56b30f17145685632c9ef2beefd57c4219837", "url": "https://github.com/hyperledger/besu/commit/66e56b30f17145685632c9ef2beefd57c4219837", "message": "increase max retry number and fix test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T11:31:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyMzMxMw==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384523313", "bodyText": "The catch-all log needs to be updated.  Probably worth keeping the more specific log message for the StalledDownload:\nelse if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n      LOG.warn(\n          \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n      return start(FastSyncState.EMPTY_SYNC_STATE);\n} else {\n      LOG.error(\n          \"Encountered an unexpected error during fast sync.  Restarting fast sync.\", error);\n      return start(FastSyncState.EMPTY_SYNC_STATE);\n}", "author": "mbaxter", "createdAt": "2020-02-26T14:24:12Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +79,17 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n-    } else {\n-      return completedExceptionally(error);\n     }", "originalCommit": "66e56b30f17145685632c9ef2beefd57c4219837", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MDI2Mw==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384550263", "bodyText": "Done", "author": "matkt", "createdAt": "2020-02-26T15:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyMzMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyNjI2Ng==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384526266", "bodyText": "(optional) Might be worth adding some more specific details:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.warn(\"Several attempts have been made without finding a pivot block\");\n          \n          \n            \n                    LOG.warn(\"{} attempts have failed to find a fast sync pivot block\", retryCount);", "author": "mbaxter", "createdAt": "2020-02-26T14:28:51Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -148,6 +149,11 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n       final int retryCount = confirmationTasks.size();\n+\n+      if ((retryCount % SUSPICIOUS_NUMBER_OF_RETRIES) == 0) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");", "originalCommit": "66e56b30f17145685632c9ef2beefd57c4219837", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjQxMQ==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384552411", "bodyText": "Done", "author": "matkt", "createdAt": "2020-02-26T15:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyNjI2Ng=="}], "type": "inlineReview"}, {"oid": "0e6843035dd5cc46d27acffa169305cd898640d1", "url": "https://github.com/hyperledger/besu/commit/0e6843035dd5cc46d27acffa169305cd898640d1", "message": "change logs in the handleFailure method\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T15:03:24Z", "type": "commit"}, {"oid": "1ce4949bcbdd82b94c2278aa8e7e8512f636cc2c", "url": "https://github.com/hyperledger/besu/commit/1ce4949bcbdd82b94c2278aa8e7e8512f636cc2c", "message": "change logs related to suspicious number of retries\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T15:07:00Z", "type": "commit"}, {"oid": "e74d3d4185d4d6857f505d0eb07dc612ae6ada9b", "url": "https://github.com/hyperledger/besu/commit/e74d3d4185d4d6857f505d0eb07dc612ae6ada9b", "message": "add a delay before each fast sync retry\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T19:06:13Z", "type": "commit"}, {"oid": "e29644339f6075d521ae02504e4d60ab8271d5c5", "url": "https://github.com/hyperledger/besu/commit/e29644339f6075d521ae02504e4d60ab8271d5c5", "message": "add a timeout for fast sync retry\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T19:12:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMjkyMA==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384712920", "bodyText": "We already have some utilities around executing timeouts.  I suggest hooking into those by adding a helper method to FastSyncActions which has access to EthScheduler - FastSyncActions.scheduleTask(Supplier<CompletableFuture<T>> future, Duration duration) perhaps?  See: \n  \n    \n      besu/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthScheduler.java\n    \n    \n         Line 170\n      in\n      2820587\n    \n    \n    \n    \n\n        \n          \n           public <T> CompletableFuture<T> scheduleFutureTask(", "author": "mbaxter", "createdAt": "2020-02-26T19:27:53Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +87,31 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n     } else {\n-      return completedExceptionally(error);\n+      LOG.error(\"Encountered an unexpected error during fast sync.  Trying to restart fast sync.\");\n+      final ScheduledFuture<CompletableFuture<FastSyncState>> fastSyncCountdown =\n+          Executors.newSingleThreadScheduledExecutor()", "originalCommit": "e29644339f6075d521ae02504e4d60ab8271d5c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDczMjEzMQ==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384732131", "bodyText": "good idea. done", "author": "matkt", "createdAt": "2020-02-26T20:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMjkyMA=="}], "type": "inlineReview"}, {"oid": "8438dacd566879450baa6cd6b7f7cfeed2ef0140", "url": "https://github.com/hyperledger/besu/commit/8438dacd566879450baa6cd6b7f7cfeed2ef0140", "message": "change timeout for fast sync retry\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T19:56:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1NjMwMQ==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384756301", "bodyText": "We should log the error since we don't really want generic errors bubbling all the way up here.  Also, probably worth mentioning the delay here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync.\");\n          \n          \n            \n                  LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync in \" + FAST_SYNC_RETRY_DELAY + \" seconds.\", error);\n          \n      \n    \n    \n  \n\nNote: To get stack traces printed in the logs, you can only supply a single error parameter to the error method.", "author": "mbaxter", "createdAt": "2020-02-26T20:48:49Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +84,21 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n     } else {\n-      return completedExceptionally(error);\n+      LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync.\");", "originalCommit": "8438dacd566879450baa6cd6b7f7cfeed2ef0140", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1Njc2Mg==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384756762", "bodyText": "(nit / optional) - I'd probably keep this constant as a Duration for readability (so its easy to see the time unit).", "author": "mbaxter", "createdAt": "2020-02-26T20:49:45Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -38,6 +39,9 @@\n import org.apache.logging.log4j.Logger;\n \n public class FastSyncDownloader<C> {\n+\n+  private static final long FAST_SYNC_RETRY_DELAY = 5;", "originalCommit": "8438dacd566879450baa6cd6b7f7cfeed2ef0140", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ecbe0cab7ad577710fa83f3bab20f1b0414ae97e", "url": "https://github.com/hyperledger/besu/commit/ecbe0cab7ad577710fa83f3bab20f1b0414ae97e", "message": "fix log add error\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T21:17:14Z", "type": "commit"}, {"oid": "ecbe0cab7ad577710fa83f3bab20f1b0414ae97e", "url": "https://github.com/hyperledger/besu/commit/ecbe0cab7ad577710fa83f3bab20f1b0414ae97e", "message": "fix log add error\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T21:17:14Z", "type": "forcePushed"}, {"oid": "7f0d07c9e9e9bbf42e0e6084b2b88810a4741d07", "url": "https://github.com/hyperledger/besu/commit/7f0d07c9e9e9bbf42e0e6084b2b88810a4741d07", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T21:29:02Z", "type": "commit"}, {"oid": "cbd012ac32ea938d287a363200089294a3da99e4", "url": "https://github.com/hyperledger/besu/commit/cbd012ac32ea938d287a363200089294a3da99e4", "message": "resolve pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-26T21:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxMjgwNg==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384812806", "bodyText": "I think you should be able to validate the second run if you use thenAnswer to go ahead and run the future supplier with something like:\nwhen(fastSyncActions).scheduleFutureTask(any(), any())\n    .thenAnswer(invocation -> invocation.getArgument(0).get());", "author": "mbaxter", "createdAt": "2020-02-26T22:43:13Z", "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloaderTest.java", "diffHunk": "@@ -413,17 +401,7 @@ public void shouldResetFastSyncStateAndRestartProcessIfANonFastSyncExceptionOccu\n     // A real chain downloader would cause the chainFuture to complete when cancel is called.\n     chainFuture.completeExceptionally(new CancellationException());\n \n-    verify(fastSyncActions, times(2)).waitForSuitablePeers(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions, times(2)).selectPivotBlock(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions).downloadPivotBlockHeader(secondSelectPivotBlockState);\n-    verify(storage).storeState(secondDownloadPivotBlockHeaderState);\n-    verify(fastSyncActions).createChainDownloader(secondDownloadPivotBlockHeaderState);\n-    verify(worldStateDownloader).run(secondPivotBlockHeader);\n-    verifyNoMoreInteractions(fastSyncActions, worldStateDownloader, storage);\n-\n-    secondWorldStateFuture.complete(null);\n-\n-    assertThat(result).isCompletedWithValue(secondDownloadPivotBlockHeaderState);\n+    verify(fastSyncActions).scheduleFutureTask(any(Supplier.class), any(Duration.class));", "originalCommit": "cbd012ac32ea938d287a363200089294a3da99e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MjUyOQ==", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r385082529", "bodyText": "Done", "author": "matkt", "createdAt": "2020-02-27T11:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxMjgwNg=="}], "type": "inlineReview"}, {"oid": "e07dc4020a2fb0326870208927e8c03c45e74847", "url": "https://github.com/hyperledger/besu/commit/e07dc4020a2fb0326870208927e8c03c45e74847", "message": "update test for restart fastsync mechanism\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-27T09:32:19Z", "type": "commit"}, {"oid": "cf8960618d6a5c7601cc7a93aceddde75d5b2f1c", "url": "https://github.com/hyperledger/besu/commit/cf8960618d6a5c7601cc7a93aceddde75d5b2f1c", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into feature/BP-117-remove-fast-synf-fallback", "committedDate": "2020-02-27T12:10:50Z", "type": "commit"}]}