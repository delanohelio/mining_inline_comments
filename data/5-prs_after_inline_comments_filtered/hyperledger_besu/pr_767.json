{"pr_number": 767, "pr_title": "Add regular logs to filters straight from BlockAddedEvent. Still use `privacyQueries` for private logs", "pr_createdAt": "2020-04-22T16:46:10Z", "pr_url": "https://github.com/hyperledger/besu/pull/767", "timeline": [{"oid": "d87bed3c4f5a60d91803af711a2598d3fd4e04e2", "url": "https://github.com/hyperledger/besu/commit/d87bed3c4f5a60d91803af711a2598d3fd4e04e2", "message": "use logs from event directly instead of going to disk\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T16:32:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413153866", "bodyText": "I see that it is not being used by the method, but why the underscore variable name? Is it just how you are denoting that it is not used?", "author": "davemec", "createdAt": "2020-04-22T16:58:00Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -151,28 +152,28 @@ public boolean uninstallFilter(final String filterId) {\n     }\n   }\n \n-  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain blockchain) {\n+  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain __) {", "originalCommit": "d87bed3c4f5a60d91803af711a2598d3fd4e04e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE3MjEwNg==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413172106", "bodyText": "Yup! Common functional pattern to let the reader know early that they don't have to worry about it.", "author": "RatanRSur", "createdAt": "2020-04-22T17:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIwOTU1Mg==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413209552", "bodyText": "Should we handle that at the lambda level and for the method signature actually just remove the param?", "author": "davemec", "createdAt": "2020-04-22T18:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1NTgwNA==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413355804", "bodyText": "If we never use it then for sure, I'll have to look into that.", "author": "RatanRSur", "createdAt": "2020-04-22T21:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwNjQ2MA==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413906460", "bodyText": "You were right, it was pretty useless. It was only used in one place that already had access to the blockchain in the scope anyways!", "author": "RatanRSur", "createdAt": "2020-04-23T15:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwNjcxOA==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413906718", "bodyText": "I made a separate PR removing it", "author": "RatanRSur", "createdAt": "2020-04-23T15:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng=="}], "type": "inlineReview"}, {"oid": "f4e28ec7572c0b4e35e193b6ffb49e3bec194e5c", "url": "https://github.com/hyperledger/besu/commit/f4e28ec7572c0b4e35e193b6ffb49e3bec194e5c", "message": "test changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:38:44Z", "type": "commit"}, {"oid": "3150a77f87b9eed331b95f52bc40101f8909268e", "url": "https://github.com/hyperledger/besu/commit/3150a77f87b9eed331b95f52bc40101f8909268e", "message": "rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:38:44Z", "type": "commit"}, {"oid": "fdfb6b19e592f1e4d88c8515c507271bdc7c455a", "url": "https://github.com/hyperledger/besu/commit/fdfb6b19e592f1e4d88c8515c507271bdc7c455a", "message": "reinstate querying for private txs\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:38:44Z", "type": "commit"}, {"oid": "451b733cebcde544a197ba5d9d97a95fb2367910", "url": "https://github.com/hyperledger/besu/commit/451b733cebcde544a197ba5d9d97a95fb2367910", "message": "spotless\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:39:47Z", "type": "commit"}, {"oid": "c3f97653f6f18d1d42e780420c77b06b9c81970d", "url": "https://github.com/hyperledger/besu/commit/c3f97653f6f18d1d42e780420c77b06b9c81970d", "message": "comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:42:34Z", "type": "commit"}, {"oid": "3745c6acb93073e86e0f31ed26c4716f42df2651", "url": "https://github.com/hyperledger/besu/commit/3745c6acb93073e86e0f31ed26c4716f42df2651", "message": "unused method\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-22T21:43:55Z", "type": "commit"}, {"oid": "6da3ffedbc50a4537a80fe88a3c0981ef700afcb", "url": "https://github.com/hyperledger/besu/commit/6da3ffedbc50a4537a80fe88a3c0981ef700afcb", "message": "revert some changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-23T14:09:50Z", "type": "commit"}, {"oid": "5fc6587c1fd5b0fd679760c5ac16d7cfcd0f6ed1", "url": "https://github.com/hyperledger/besu/commit/5fc6587c1fd5b0fd679760c5ac16d7cfcd0f6ed1", "message": "reintroduce privacy test invariants\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-23T14:19:53Z", "type": "commit"}, {"oid": "95e3b77d546d9a1199f1563bf6d8c68ae1907afc", "url": "https://github.com/hyperledger/besu/commit/95e3b77d546d9a1199f1563bf6d8c68ae1907afc", "message": "bugfixes and test changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-04-23T15:34:33Z", "type": "commit"}, {"oid": "917c94473c8718cdb5ae45f6266d331abacc4879", "url": "https://github.com/hyperledger/besu/commit/917c94473c8718cdb5ae45f6266d331abacc4879", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates", "committedDate": "2020-04-23T15:34:40Z", "type": "commit"}, {"oid": "44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524", "url": "https://github.com/hyperledger/besu/commit/44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates", "committedDate": "2020-04-23T15:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExODI5NA==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r414118294", "bodyText": "Maybe this is a problem that was already in the code. But I have just thought about it.\nIf the filter is using a blockhash, we shouldn't be adding logs from any other block into it. However, it looks like our log filtering logic would add the logs regardless. Because in this case, the blockhash in the filter won't be empty but the from/to block parameter will be empty.", "author": "lucassaldanha", "createdAt": "2020-04-23T20:56:44Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -151,28 +153,45 @@ public boolean uninstallFilter(final String filterId) {\n     }\n   }\n \n-  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain blockchain) {\n+  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain __) {\n     final Hash blockHash = event.getBlock().getHash();\n     final Collection<BlockFilter> blockFilters =\n         filterRepository.getFiltersOfType(BlockFilter.class);\n     blockFilters.forEach(\n-        (filter) -> {\n+        filter -> {\n           synchronized (filter) {\n             filter.addBlockHash(blockHash);\n           }\n         });\n \n-    filterRepository.getFiltersOfType(LogFilter.class).forEach(this::addNewMatchingLogs);\n-  }\n-\n-  private void addNewMatchingLogs(final LogFilter filter) {\n-    final long fromBlockNumber = blockchainQueries.headBlockNumber();\n-    final long toBlockNumber =\n-        filter.getToBlock().getNumber().orElse(blockchainQueries.headBlockNumber());\n-\n-    final List<LogWithMetadata> logs = findLogsWithinRange(filter, fromBlockNumber, toBlockNumber);\n-\n-    filter.addLogs(logs);\n+    final List<LogWithMetadata> logsWithMetadata = event.getLogsWithMetadata();\n+    filterRepository.getFiltersOfType(LogFilter.class).stream()\n+        .filter(\n+            // Only keep filters where the \"to\" block could include the block in the event\n+            filter -> {\n+              final OptionalLong maybeToBlockNumber = filter.getToBlock().getNumber();", "originalCommit": "44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1ODQ5Nw==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r414158497", "bodyText": "I'm not sure if I understand but these LogFilters don't specify a block hash.", "author": "RatanRSur", "createdAt": "2020-04-23T22:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExODI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MTE2NA==", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r414161164", "bodyText": "Ah nvm... I mixed up with eth_getLogs!", "author": "lucassaldanha", "createdAt": "2020-04-23T22:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExODI5NA=="}], "type": "inlineReview"}, {"oid": "abb64e9e836f0cb3736f81c3261afad8ec6ba251", "url": "https://github.com/hyperledger/besu/commit/abb64e9e836f0cb3736f81c3261afad8ec6ba251", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates", "committedDate": "2020-04-23T21:55:35Z", "type": "commit"}]}