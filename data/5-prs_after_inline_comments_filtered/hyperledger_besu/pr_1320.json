{"pr_number": 1320, "pr_title": "Evmtool tweaks", "pr_createdAt": "2020-08-18T19:41:16Z", "pr_url": "https://github.com/hyperledger/besu/pull/1320", "timeline": [{"oid": "04379ff036717e82d2dbda2a460a69b460c0d239", "url": "https://github.com/hyperledger/besu/commit/04379ff036717e82d2dbda2a460a69b460c0d239", "message": "Help Text Updates\n\nUpdate help text of the EvmTool options.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-18T13:31:21Z", "type": "commit"}, {"oid": "fc1894dd5fc953961a5fb21504a8c1758175344f", "url": "https://github.com/hyperledger/besu/commit/fc1894dd5fc953961a5fb21504a8c1758175344f", "message": "Merge branch 'master' of github.com:hyperledger/besu into evmTool\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-18T18:52:18Z", "type": "commit"}, {"oid": "52eea73d4d4b972334a445a5c6e4a0100a1cf718", "url": "https://github.com/hyperledger/besu/commit/52eea73d4d4b972334a445a5c6e4a0100a1cf718", "message": "Allow multiple tests via standard input\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-18T19:25:07Z", "type": "commit"}, {"oid": "282edd50737d64bfe988bae5b1a3c9740462cac1", "url": "https://github.com/hyperledger/besu/commit/282edd50737d64bfe988bae5b1a3c9740462cac1", "message": "Fix  memory expansion bounds checking\n\nWhen a CALL series operation has an erroneous input offset (such as\nstarting at a ETH address instead of a real offset) we threw an\nArithmeticException.\n\n* Restore the old memory bounds checking on memory expansion\n* Treat these formerly uncaught exceptions as invalid transactions and\n  report errors with a stack trace and custom halt reason.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-19T17:56:44Z", "type": "commit"}, {"oid": "2bfc4279e823f1afaa11de13393464e15b50afcc", "url": "https://github.com/hyperledger/besu/commit/2bfc4279e823f1afaa11de13393464e15b50afcc", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-19T18:52:40Z", "type": "commit"}, {"oid": "a88837609887f794779a0c3c40a4bf6d58be2db2", "url": "https://github.com/hyperledger/besu/commit/a88837609887f794779a0c3c40a4bf6d58be2db2", "message": "Merge branch 'memoryExpansion' into evmtool\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-19T18:54:42Z", "type": "commit"}, {"oid": "d48cc31819abbf9ece16ebec6109ff42abb1fbe7", "url": "https://github.com/hyperledger/besu/commit/d48cc31819abbf9ece16ebec6109ff42abb1fbe7", "message": "align output format with evmlab expectations\n\nre-order calls, and re-work some operations so that oepration cost is\nincluded in exceptions when they cost can be known (such as fixed costs\nor failures unrelated to stack underflow).\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-19T23:36:58Z", "type": "commit"}, {"oid": "df640521bde89cb0f9bbb06f0c4deb94cc00cae6", "url": "https://github.com/hyperledger/besu/commit/df640521bde89cb0f9bbb06f0c4deb94cc00cae6", "message": "Merge branch 'master' into evmtool", "committedDate": "2020-08-20T13:46:12Z", "type": "commit"}, {"oid": "24211a701c4493fa9793ac6a1d69b9c004045b8e", "url": "https://github.com/hyperledger/besu/commit/24211a701c4493fa9793ac6a1d69b9c004045b8e", "message": "don't lose invalid opcode in trace\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-20T14:10:01Z", "type": "commit"}, {"oid": "59ff3fae2562d9c901ba4d9d257c3f20db854c65", "url": "https://github.com/hyperledger/besu/commit/59ff3fae2562d9c901ba4d9d257c3f20db854c65", "message": "fix unit test\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-20T15:54:06Z", "type": "commit"}, {"oid": "dd0facf00ace6ceafc0d00747df28dcb2b71f0fc", "url": "https://github.com/hyperledger/besu/commit/dd0facf00ace6ceafc0d00747df28dcb2b71f0fc", "message": "Merge branch 'master' into evmtool", "committedDate": "2020-08-20T16:33:21Z", "type": "commit"}, {"oid": "aaf35c51ec95bacc17d0f7a676247a9138c4e895", "url": "https://github.com/hyperledger/besu/commit/aaf35c51ec95bacc17d0f7a676247a9138c4e895", "message": "Merge branch 'master' into evmtool", "committedDate": "2020-08-20T16:37:41Z", "type": "commit"}, {"oid": "d2455a8351144aead542e9db3e1e2ce8745d825b", "url": "https://github.com/hyperledger/besu/commit/d2455a8351144aead542e9db3e1e2ce8745d825b", "message": "Merge branch 'master' into evmtool", "committedDate": "2020-08-23T14:44:55Z", "type": "commit"}, {"oid": "e65bf52002b78f7d9ac2da8a224ea783b1ecdc36", "url": "https://github.com/hyperledger/besu/commit/e65bf52002b78f7d9ac2da8a224ea783b1ecdc36", "message": "move unsingined into to a long\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-24T19:46:25Z", "type": "commit"}, {"oid": "8031ce9e8214d9350c0e1db3afacbce0f6793582", "url": "https://github.com/hyperledger/besu/commit/8031ce9e8214d9350c0e1db3afacbce0f6793582", "message": "different cast\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-24T19:50:46Z", "type": "commit"}, {"oid": "a8ed96a6a04867ce1766cf416e612d53b60642e6", "url": "https://github.com/hyperledger/besu/commit/a8ed96a6a04867ce1766cf416e612d53b60642e6", "message": "wire in `--nomemory` to state test tool.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-24T19:58:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5NjAxNw==", "url": "https://github.com/hyperledger/besu/pull/1320#discussion_r476496017", "bodyText": "shouldn't we check the \"top-offset\" bounds rather than just offset?", "author": "matkt", "createdAt": "2020-08-25T14:32:09Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/FixedStack.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.vm;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.lang.reflect.Array;\n+import java.util.Arrays;\n+\n+/**\n+ * An operand stack for the Ethereum Virtual machine (EVM).\n+ *\n+ * <p>The operand stack is responsible for storing the current operands that the EVM can execute. It\n+ * is assumed to have a fixed size.\n+ */\n+public class FixedStack<T> {\n+\n+  private final T[] entries;\n+\n+  private final int maxSize;\n+\n+  private int top;\n+\n+  public static class UnderflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public static class OverflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  public FixedStack(final int maxSize, final Class<T> klass) {\n+    checkArgument(maxSize >= 0, \"max size must be non-negative\");\n+\n+    this.entries = (T[]) Array.newInstance(klass, maxSize);\n+    this.maxSize = maxSize;\n+    this.top = -1;\n+  }\n+\n+  public T get(final int offset) {\n+    if (offset < 0 || offset >= size()) {\n+      throw new IndexOutOfBoundsException();\n+    }\n+\n+    return entries[top - offset];", "originalCommit": "a8ed96a6a04867ce1766cf416e612d53b60642e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUwODMzNw==", "url": "https://github.com/hyperledger/besu/pull/1320#discussion_r476508337", "bodyText": "offset is always positive.  size() is always top + 1.  So the index is always between zero and top, it's a check that would always pass after asserting those two boundaries on offset.", "author": "shemnon", "createdAt": "2020-08-25T14:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5NjAxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUwMTY2NA==", "url": "https://github.com/hyperledger/besu/pull/1320#discussion_r476501664", "bodyText": "I don't understand why this test had to be modified \ud83e\udd14", "author": "matkt", "createdAt": "2020-08-25T14:39:29Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/operations/BeginSubOperationTest.java", "diffHunk": "@@ -95,6 +94,6 @@ public void shouldHaltWithInvalidSubRoutineEntryWhenBeginSubIsExecuted() {\n     frame.setPC(CURRENT_PC);\n     final OperationResult result = operation.execute(frame, null);\n \n-    assertThat(result.getHaltReason()).contains(ExceptionalHaltReason.INVALID_SUB_ROUTINE_ENTRY);\n+    assertThat(result.getHaltReason()).isNotEmpty();", "originalCommit": "a8ed96a6a04867ce1766cf416e612d53b60642e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUwNjAxOA==", "url": "https://github.com/hyperledger/besu/pull/1320#discussion_r476506018", "bodyText": "The test would also fail because of out of gas, and we check gas sooner now.  I think your intent is right in that the only way this should fail is invalid subroutine entry, so I re-worked the test to provide more gas and only accept that exceptional halt.", "author": "shemnon", "createdAt": "2020-08-25T14:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUwMTY2NA=="}], "type": "inlineReview"}, {"oid": "2ed3739f485c902d290eaef941d4c56bcef5c290", "url": "https://github.com/hyperledger/besu/commit/2ed3739f485c902d290eaef941d4c56bcef5c290", "message": "change failure mode we are checking for\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-08-25T14:43:23Z", "type": "commit"}, {"oid": "bed5975d5fa2d1803b3a39a482309de52e1979b4", "url": "https://github.com/hyperledger/besu/commit/bed5975d5fa2d1803b3a39a482309de52e1979b4", "message": "Merge branch 'master' into evmtool", "committedDate": "2020-08-25T15:54:45Z", "type": "commit"}]}