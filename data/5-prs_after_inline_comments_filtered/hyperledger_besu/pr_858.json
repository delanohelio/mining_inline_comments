{"pr_number": 858, "pr_title": "Add support for private log subscriptions (Pub-Sub API)", "pr_createdAt": "2020-05-06T23:06:29Z", "pr_url": "https://github.com/hyperledger/besu/pull/858", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1MjQyNg==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421152426", "bodyText": "Should we also have a branch for an invalid params json rpc error?", "author": "RatanRSur", "createdAt": "2020-05-06T23:35:20Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivSubscribe.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.websocket.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.RpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.privacy.methods.EnclavePublicKeyProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcError;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcErrorResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.SubscriptionManager;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.InvalidSubscriptionRequestException;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.PrivateSubscribeRequest;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionRequestMapper;\n+import org.hyperledger.besu.ethereum.privacy.PrivacyController;\n+\n+public class PrivSubscribe extends AbstractPrivateSubscriptionMethod {\n+\n+  public PrivSubscribe(\n+      final SubscriptionManager subscriptionManager,\n+      final SubscriptionRequestMapper mapper,\n+      final PrivacyController privacyController,\n+      final EnclavePublicKeyProvider enclavePublicKeyProvider) {\n+    super(subscriptionManager, mapper, privacyController, enclavePublicKeyProvider);\n+  }\n+\n+  @Override\n+  public String getName() {\n+    return RpcMethod.PRIV_SUBSCRIBE.getMethodName();\n+  }\n+\n+  @Override\n+  public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+    try {\n+      final PrivateSubscribeRequest subscribeRequest =\n+          getMapper().mapPrivateSubscribeRequest(requestContext);\n+\n+      checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(\n+          requestContext, subscribeRequest.getPrivacyGroupId());\n+\n+      final Long subscriptionId = subscriptionManager().subscribe(subscribeRequest);\n+\n+      return new JsonRpcSuccessResponse(\n+          requestContext.getRequest().getId(), Quantity.create(subscriptionId));\n+    } catch (final InvalidSubscriptionRequestException isEx) {\n+      return new JsonRpcErrorResponse(\n+          requestContext.getRequest().getId(), JsonRpcError.INVALID_REQUEST);", "originalCommit": "49a62546bd4f47f2505f2b885957fee1c8247915", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDc4MQ==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421164781", "bodyText": "Yeah, I thought it was being done in the same way we do for the JsonRpc API (https://github.com/hyperledger/besu/blob/master/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/JsonRpcHttpService.java#L590-L592).\nInstead of adding it to each WebSocket method, I think we should add this to the WebSocketRequestHandler#handle. So it applies for any WebSocket request.", "author": "lucassaldanha", "createdAt": "2020-05-07T00:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1MjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMjU2OA==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421212568", "bodyText": "Done! \ud83d\udc4d\nWebSocketRequestHandler now will handle a InvalidJsonRpcParameters exception.", "author": "lucassaldanha", "createdAt": "2020-05-07T03:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1MjQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1Njk3Ng==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421156976", "bodyText": "I understand that we might not be able to reach the nirvana of not checking anything on disk for each block added event like we can with the mainnet side but could we at least take advantage of the fact that we already have the logs from the block added event and get the bare minimum from the privacy storage to filter a subset of them?", "author": "RatanRSur", "createdAt": "2020-05-06T23:49:37Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/logs/LogsSubscriptionService.java", "diffHunk": "@@ -46,9 +54,34 @@ public void accept(final LogWithMetadata logWithMetadata) {\n                   && filterParameter.getToBlock().getNumber().orElse(Long.MAX_VALUE) >= blockNumber\n                   && filterParameter.getLogsQuery().matches(logWithMetadata);\n             })\n-        .forEach(\n-            logsSubscription ->\n-                subscriptionManager.sendMessage(\n-                    logsSubscription.getSubscriptionId(), new LogResult(logWithMetadata)));\n+        .forEach(logsSubscription -> sendLogToSubscription(logWithMetadata, logsSubscription));\n+  }\n+\n+  public void checkPrivateLogs(final BlockAddedEvent event) {\n+    privacyQueries.ifPresent(\n+        pq ->\n+            subscriptionManager.subscriptionsOfType(SubscriptionType.LOGS, LogsSubscription.class)\n+                .stream()\n+                .filter(PrivateLogsSubscription.class::isInstance)\n+                .map(PrivateLogsSubscription.class::cast)\n+                .forEach(queryPrivateEventForSubscription(pq, event)));\n+  }\n+\n+  private Consumer<PrivateLogsSubscription> queryPrivateEventForSubscription(\n+      final PrivacyQueries privacyQueries, final BlockAddedEvent event) {\n+    return subscription -> {\n+      final String privacyGroupId = subscription.getPrivacyGroupId();\n+      final LogsQuery logsQuery = subscription.getFilterParameter().getLogsQuery();\n+\n+      privacyQueries\n+          .matchingLogs(privacyGroupId, event.getBlock().getHash(), logsQuery)\n+          .forEach(logWithMetadata -> sendLogToSubscription(logWithMetadata, subscription));", "originalCommit": "49a62546bd4f47f2505f2b885957fee1c8247915", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1OTc4NQ==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421159785", "bodyText": "I don't think I understand your suggestion. The logs in the block added event are only logs generated by public contracts. We can't really use them to find private logs.", "author": "lucassaldanha", "createdAt": "2020-05-06T23:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1Njk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2MDcwOA==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421160708", "bodyText": "Ahh, my misunderstanding then.", "author": "RatanRSur", "createdAt": "2020-05-07T00:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1Njk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2MDgyNQ==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421160825", "bodyText": "Sem problemas! ;)", "author": "lucassaldanha", "createdAt": "2020-05-07T00:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE1Njk3Ng=="}], "type": "inlineReview"}, {"oid": "99f64eb50f0f17e322f52cfdc60331e67811fa2d", "url": "https://github.com/hyperledger/besu/commit/99f64eb50f0f17e322f52cfdc60331e67811fa2d", "message": "Added invalid param check for websockets\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-07T03:06:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxNTYyMg==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421215622", "bodyText": "could do an if/else or even\nprivacyQueries = privacyParameters.isEnabled() ? x : y;", "author": "pinges", "createdAt": "2020-05-07T03:19:53Z", "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -698,11 +712,31 @@ private SubscriptionManager createSubscriptionManager(\n   }\n \n   private void createLogsSubscriptionService(\n-      final Blockchain blockchain, final SubscriptionManager subscriptionManager) {\n+      final Blockchain blockchain,\n+      final WorldStateArchive worldStateArchive,\n+      final SubscriptionManager subscriptionManager,\n+      final PrivacyParameters privacyParameters) {\n+\n+    Optional<PrivacyQueries> privacyQueries = Optional.empty();", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcwODk4NA==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422708984", "bodyText": "I think the way that it is implemented makes it more readable. PrivacyQueries start empty and, if privacy is enabled, we set it to the proper object.\nI think in this case the ternary operator will make it less readable.", "author": "lucassaldanha", "createdAt": "2020-05-10T22:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxNTYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg3NzA1OQ==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421877059", "bodyText": "Do you think you can come up with a better message? :-)\nIt looks like this is not used anywhere. So maybe just delete the line.", "author": "pinges", "createdAt": "2020-05-08T00:57:40Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/response/JsonRpcError.java", "diffHunk": "@@ -127,6 +127,7 @@\n   PMT_FAILED_INTRINSIC_GAS_EXCEEDS_LIMIT(\n       -50100,\n       \"Private Marker Transaction failed due to intrinsic gas exeeding the limit. Gas limit used from the Private Transaction.\"),\n+  PRIVATE_SUBSCRIPTION_MULTI_TENANCY_ERROR(-50100, \"foo.\"),", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcwOTQxNw==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422709417", "bodyText": "Removed it :)", "author": "lucassaldanha", "createdAt": "2020-05-10T22:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg3NzA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkwNzYwOA==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421907608", "bodyText": "We do this in the PrivacyApiGroupJsonRpcMethods as well, but in the PrivJsonRpcMethods we do pass the privacy controller and the enclavePublicKeyProvider into the create() method.\nThis means that we have several instances of the controller and enclavePKP where we would only need one.\nCan we fix that in a nice way?", "author": "pinges", "createdAt": "2020-05-08T02:54:06Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivateWebSocketMethodsFactory.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.websocket.methods;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.LatestNonceProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.methods.JsonRpcMethod;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.privacy.methods.EnclavePublicKeyProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.SubscriptionManager;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionRequestMapper;\n+import org.hyperledger.besu.ethereum.api.query.BlockchainQueries;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.PrivacyParameters;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool;\n+import org.hyperledger.besu.ethereum.mainnet.ProtocolSchedule;\n+import org.hyperledger.besu.ethereum.privacy.ChainHeadPrivateNonceProvider;\n+import org.hyperledger.besu.ethereum.privacy.DefaultPrivacyController;\n+import org.hyperledger.besu.ethereum.privacy.MultiTenancyPrivacyController;\n+import org.hyperledger.besu.ethereum.privacy.PrivacyController;\n+import org.hyperledger.besu.ethereum.privacy.PrivateNonceProvider;\n+import org.hyperledger.besu.ethereum.privacy.PrivateTransactionSimulator;\n+import org.hyperledger.besu.ethereum.privacy.markertransaction.FixedKeySigningPrivateMarkerTransactionFactory;\n+import org.hyperledger.besu.ethereum.privacy.markertransaction.PrivateMarkerTransactionFactory;\n+import org.hyperledger.besu.ethereum.privacy.markertransaction.RandomSigningPrivateMarkerTransactionFactory;\n+\n+import java.math.BigInteger;\n+import java.util.Collection;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public class PrivateWebSocketMethodsFactory {\n+\n+  private final PrivacyParameters privacyParameters;\n+  private final SubscriptionManager subscriptionManager;\n+  private final ProtocolSchedule<?> protocolSchedule;\n+  private final BlockchainQueries blockchainQueries;\n+  private final TransactionPool transactionPool;\n+\n+  public PrivateWebSocketMethodsFactory(\n+      final PrivacyParameters privacyParameters,\n+      final SubscriptionManager subscriptionManager,\n+      final ProtocolSchedule<?> protocolSchedule,\n+      final BlockchainQueries blockchainQueries,\n+      final TransactionPool transactionPool) {\n+    this.privacyParameters = privacyParameters;\n+    this.subscriptionManager = subscriptionManager;\n+    this.protocolSchedule = protocolSchedule;\n+    this.blockchainQueries = blockchainQueries;\n+    this.transactionPool = transactionPool;\n+  }\n+\n+  public Collection<JsonRpcMethod> methods() {\n+    final SubscriptionRequestMapper subscriptionRequestMapper = new SubscriptionRequestMapper();\n+    final EnclavePublicKeyProvider enclavePublicKeyProvider =\n+        EnclavePublicKeyProvider.build(privacyParameters);", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk5OTg2NA==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r421999864", "bodyText": "nit: final", "author": "pinges", "createdAt": "2020-05-08T07:51:15Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/request/SubscriptionRequestMapper.java", "diffHunk": "@@ -83,11 +83,60 @@ public UnsubscribeRequest mapUnsubscribeRequest(final JsonRpcRequestContext json\n       final long subscriptionId =\n           webSocketRpcRequestBody.getRequiredParameter(0, UnsignedLongParameter.class).getValue();\n       return new UnsubscribeRequest(subscriptionId, webSocketRpcRequestBody.getConnectionId());\n+    } catch (final Exception e) {\n+      throw new InvalidSubscriptionRequestException(\"Error parsing unsubscribe request\", e);\n+    }\n+  }\n+\n+  public PrivateSubscribeRequest mapPrivateSubscribeRequest(\n+      final JsonRpcRequestContext jsonRpcRequestContext)\n+      throws InvalidSubscriptionRequestException {\n+    try {\n+      final WebSocketRpcRequest webSocketRpcRequestBody = validateRequest(jsonRpcRequestContext);\n+\n+      final String privacyGroupId = webSocketRpcRequestBody.getRequiredParameter(0, String.class);\n+      final SubscriptionType subscriptionType =\n+          webSocketRpcRequestBody.getRequiredParameter(1, SubscriptionType.class);\n+\n+      switch (subscriptionType) {\n+        case LOGS:\n+          {\n+            final FilterParameter filterParameter =\n+                jsonRpcRequestContext.getRequiredParameter(2, FilterParameter.class);\n+            return new PrivateSubscribeRequest(\n+                SubscriptionType.LOGS,\n+                filterParameter,\n+                null,\n+                webSocketRpcRequestBody.getConnectionId(),\n+                privacyGroupId);\n+          }\n+        default:\n+          throw new InvalidSubscriptionRequestException(\n+              \"Invalid subscribe request. Invalid private subscription type.\");\n+      }\n+    } catch (InvalidSubscriptionRequestException e) {", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwMjY2Ng==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422002666", "bodyText": "I hope that nobody relies on the order ...", "author": "pinges", "createdAt": "2020-05-08T07:57:10Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/response/SubscriptionResponseResult.java", "diffHunk": "@@ -17,17 +17,28 @@\n import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.JsonRpcResult;\n \n import com.fasterxml.jackson.annotation.JsonGetter;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n \n-@JsonPropertyOrder({\"subscription\", \"result\"})\n+@JsonPropertyOrder({\"subscription\", \"privacyGroupId\", \"result\"})", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NDEyNg==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422794126", "bodyText": "nit should it be jsonRpcRequestContext? Please check that in other tests in this file as well!", "author": "pinges", "createdAt": "2020-05-11T05:46:05Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivSubscribeTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.websocket.methods;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.privacy.methods.EnclavePublicKeyProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcError;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcErrorResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.SubscriptionManager;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.InvalidSubscriptionRequestException;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.PrivateSubscribeRequest;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionRequestMapper;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionType;\n+import org.hyperledger.besu.ethereum.privacy.MultiTenancyValidationException;\n+import org.hyperledger.besu.ethereum.privacy.PrivacyController;\n+\n+import io.vertx.core.json.Json;\n+import io.vertx.ext.auth.User;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class PrivSubscribeTest {\n+\n+  private final String ENCLAVE_KEY = \"enclave_key\";\n+  private final String PRIVACY_GROUP_ID = \"B1aVtMxLCUHmBVHXoZzzBgPbW/wj5axDpW9X8l91SGo=\";\n+\n+  @Mock private SubscriptionManager subscriptionManagerMock;\n+  @Mock private SubscriptionRequestMapper mapperMock;\n+  @Mock private PrivacyController privacyController;\n+  @Mock private EnclavePublicKeyProvider enclavePublicKeyProvider;\n+\n+  private PrivSubscribe privSubscribe;\n+\n+  @Before\n+  public void before() {\n+    privSubscribe =\n+        new PrivSubscribe(\n+            subscriptionManagerMock, mapperMock, privacyController, enclavePublicKeyProvider);\n+  }\n+\n+  @Test\n+  public void expectedMethodName() {\n+    assertThat(privSubscribe.getName()).isEqualTo(\"priv_subscribe\");\n+  }\n+\n+  @Test\n+  public void responseContainsSubscriptionId() {\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext = new JsonRpcRequestContext(webSocketRequest);", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQxMzkzNg==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r423413936", "bodyText": "It is correct. We only have a JsonRpcRequestContext, used for both JsonRpcRequest and WebSocketRpcRequest (subclass of the first one)", "author": "lucassaldanha", "createdAt": "2020-05-12T01:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NDEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NDU2Mw==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422794563", "bodyText": "s.a.", "author": "pinges", "createdAt": "2020-05-11T05:47:34Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivSubscribeTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.websocket.methods;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.privacy.methods.EnclavePublicKeyProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcError;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcErrorResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.SubscriptionManager;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.InvalidSubscriptionRequestException;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.PrivateSubscribeRequest;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionRequestMapper;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionType;\n+import org.hyperledger.besu.ethereum.privacy.MultiTenancyValidationException;\n+import org.hyperledger.besu.ethereum.privacy.PrivacyController;\n+\n+import io.vertx.core.json.Json;\n+import io.vertx.ext.auth.User;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class PrivSubscribeTest {\n+\n+  private final String ENCLAVE_KEY = \"enclave_key\";\n+  private final String PRIVACY_GROUP_ID = \"B1aVtMxLCUHmBVHXoZzzBgPbW/wj5axDpW9X8l91SGo=\";\n+\n+  @Mock private SubscriptionManager subscriptionManagerMock;\n+  @Mock private SubscriptionRequestMapper mapperMock;\n+  @Mock private PrivacyController privacyController;\n+  @Mock private EnclavePublicKeyProvider enclavePublicKeyProvider;\n+\n+  private PrivSubscribe privSubscribe;\n+\n+  @Before\n+  public void before() {\n+    privSubscribe =\n+        new PrivSubscribe(\n+            subscriptionManagerMock, mapperMock, privacyController, enclavePublicKeyProvider);\n+  }\n+\n+  @Test\n+  public void expectedMethodName() {\n+    assertThat(privSubscribe.getName()).isEqualTo(\"priv_subscribe\");\n+  }\n+\n+  @Test\n+  public void responseContainsSubscriptionId() {\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext = new JsonRpcRequestContext(webSocketRequest);\n+\n+    final PrivateSubscribeRequest subscribeRequest =\n+        new PrivateSubscribeRequest(\n+            SubscriptionType.LOGS,\n+            null,\n+            null,\n+            webSocketRequest.getConnectionId(),\n+            PRIVACY_GROUP_ID);\n+\n+    when(mapperMock.mapPrivateSubscribeRequest(eq(jsonRpcrequestContext)))\n+        .thenReturn(subscribeRequest);\n+    when(subscriptionManagerMock.subscribe(eq(subscribeRequest))).thenReturn(1L);\n+\n+    final JsonRpcSuccessResponse expectedResponse =\n+        new JsonRpcSuccessResponse(\n+            jsonRpcrequestContext.getRequest().getId(), Quantity.create((1L)));\n+\n+    assertThat(privSubscribe.response(jsonRpcrequestContext)).isEqualTo(expectedResponse);\n+  }\n+\n+  @Test\n+  public void invalidSubscribeRequestRespondsInvalidRequestResponse() {\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext = new JsonRpcRequestContext(webSocketRequest);\n+\n+    when(mapperMock.mapPrivateSubscribeRequest(any()))\n+        .thenThrow(new InvalidSubscriptionRequestException());\n+\n+    final JsonRpcErrorResponse expectedResponse =\n+        new JsonRpcErrorResponse(\n+            jsonRpcrequestContext.getRequest().getId(), JsonRpcError.INVALID_REQUEST);\n+\n+    assertThat(privSubscribe.response(jsonRpcrequestContext)).isEqualTo(expectedResponse);\n+  }\n+\n+  @Test\n+  public void multiTenancyCheckFailure() {\n+    final User user = mock(User.class);\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext =", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NDY0Mw==", "url": "https://github.com/hyperledger/besu/pull/858#discussion_r422794643", "bodyText": "s.a.", "author": "pinges", "createdAt": "2020-05-11T05:47:48Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivSubscribeTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.api.jsonrpc.websocket.methods;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doThrow;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.JsonRpcRequestContext;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.privacy.methods.EnclavePublicKeyProvider;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcError;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcErrorResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.response.JsonRpcSuccessResponse;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.SubscriptionManager;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.InvalidSubscriptionRequestException;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.PrivateSubscribeRequest;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionRequestMapper;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.websocket.subscription.request.SubscriptionType;\n+import org.hyperledger.besu.ethereum.privacy.MultiTenancyValidationException;\n+import org.hyperledger.besu.ethereum.privacy.PrivacyController;\n+\n+import io.vertx.core.json.Json;\n+import io.vertx.ext.auth.User;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class PrivSubscribeTest {\n+\n+  private final String ENCLAVE_KEY = \"enclave_key\";\n+  private final String PRIVACY_GROUP_ID = \"B1aVtMxLCUHmBVHXoZzzBgPbW/wj5axDpW9X8l91SGo=\";\n+\n+  @Mock private SubscriptionManager subscriptionManagerMock;\n+  @Mock private SubscriptionRequestMapper mapperMock;\n+  @Mock private PrivacyController privacyController;\n+  @Mock private EnclavePublicKeyProvider enclavePublicKeyProvider;\n+\n+  private PrivSubscribe privSubscribe;\n+\n+  @Before\n+  public void before() {\n+    privSubscribe =\n+        new PrivSubscribe(\n+            subscriptionManagerMock, mapperMock, privacyController, enclavePublicKeyProvider);\n+  }\n+\n+  @Test\n+  public void expectedMethodName() {\n+    assertThat(privSubscribe.getName()).isEqualTo(\"priv_subscribe\");\n+  }\n+\n+  @Test\n+  public void responseContainsSubscriptionId() {\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext = new JsonRpcRequestContext(webSocketRequest);\n+\n+    final PrivateSubscribeRequest subscribeRequest =\n+        new PrivateSubscribeRequest(\n+            SubscriptionType.LOGS,\n+            null,\n+            null,\n+            webSocketRequest.getConnectionId(),\n+            PRIVACY_GROUP_ID);\n+\n+    when(mapperMock.mapPrivateSubscribeRequest(eq(jsonRpcrequestContext)))\n+        .thenReturn(subscribeRequest);\n+    when(subscriptionManagerMock.subscribe(eq(subscribeRequest))).thenReturn(1L);\n+\n+    final JsonRpcSuccessResponse expectedResponse =\n+        new JsonRpcSuccessResponse(\n+            jsonRpcrequestContext.getRequest().getId(), Quantity.create((1L)));\n+\n+    assertThat(privSubscribe.response(jsonRpcrequestContext)).isEqualTo(expectedResponse);\n+  }\n+\n+  @Test\n+  public void invalidSubscribeRequestRespondsInvalidRequestResponse() {\n+    final WebSocketRpcRequest webSocketRequest = createWebSocketRpcRequest();\n+    final JsonRpcRequestContext jsonRpcrequestContext = new JsonRpcRequestContext(webSocketRequest);", "originalCommit": "f276aaf14e6f25c26bea3311242e56b380a90760", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3a3a4291acf26b9e2c50c911c04c6ce4f957435", "url": "https://github.com/hyperledger/besu/commit/d3a3a4291acf26b9e2c50c911c04c6ce4f957435", "message": "Created priv_subscribe and priv_unsubscribe methods\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "49fcf93ed529c295e77049f9f2fd83b04f787c37", "url": "https://github.com/hyperledger/besu/commit/49fcf93ed529c295e77049f9f2fd83b04f787c37", "message": "Added PrivateWebSocketMethodsFactory\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "c1d9ff9d9aed7ebeca8ddd019686072e584a7da0", "url": "https://github.com/hyperledger/besu/commit/c1d9ff9d9aed7ebeca8ddd019686072e584a7da0", "message": "Updated CHANGELOG\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "c16c113f89c032403acf216e79680cb2b4ae7987", "url": "https://github.com/hyperledger/besu/commit/c16c113f89c032403acf216e79680cb2b4ae7987", "message": "Created PrivateLogSubscription\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "73d31867e5cebe53af45e39de8f026972007f4d5", "url": "https://github.com/hyperledger/besu/commit/73d31867e5cebe53af45e39de8f026972007f4d5", "message": "Observing blocks and checking for private logs\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "b1c2daa7b99be848a5c7ff7adf88c17d472cd5b8", "url": "https://github.com/hyperledger/besu/commit/b1c2daa7b99be848a5c7ff7adf88c17d472cd5b8", "message": "Added invalid param check for websockets\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "5fd0d2e50613c98c342543179d5b1089d3584eb4", "url": "https://github.com/hyperledger/besu/commit/5fd0d2e50613c98c342543179d5b1089d3584eb4", "message": "Updated CHANGELOG\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "f0762b07736c8d5204ce9ab5eaa915e8f6c00dc1", "url": "https://github.com/hyperledger/besu/commit/f0762b07736c8d5204ce9ab5eaa915e8f6c00dc1", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "commit"}, {"oid": "f0762b07736c8d5204ce9ab5eaa915e8f6c00dc1", "url": "https://github.com/hyperledger/besu/commit/f0762b07736c8d5204ce9ab5eaa915e8f6c00dc1", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T01:40:15Z", "type": "forcePushed"}, {"oid": "fe463e62970de8a5a707c299003d51d9e508e63a", "url": "https://github.com/hyperledger/besu/commit/fe463e62970de8a5a707c299003d51d9e508e63a", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-05-12T02:36:46Z", "type": "commit"}]}