{"pr_number": 1435, "pr_title": "Added NodeSmartContractV2PermissioningController", "pr_createdAt": "2020-10-08T19:51:39Z", "pr_url": "https://github.com/hyperledger/besu/pull/1435", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwOTYyMQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r503009621", "bodyText": "what is the -1 value?", "author": "macfarla", "createdAt": "2020-10-12T02:36:11Z", "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/NodeSmartContractV2PermissioningController.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.permissioning;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.p2p.peers.EnodeURL;\n+import org.hyperledger.besu.ethereum.transaction.CallParameter;\n+import org.hyperledger.besu.ethereum.transaction.TransactionSimulator;\n+import org.hyperledger.besu.ethereum.transaction.TransactionSimulatorResult;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.net.InetAddress;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.web3j.abi.FunctionEncoder;\n+import org.web3j.abi.TypeEncoder;\n+import org.web3j.abi.datatypes.Bool;\n+import org.web3j.abi.datatypes.Function;\n+\n+/**\n+ * Controller that can read from a smart contract that exposes the EEA node permissioning v2 call\n+ * connectionAllowed(string,bytes16,uint16)\n+ */\n+public class NodeSmartContractV2PermissioningController\n+    extends AbstractNodeSmartContractPermissioningController {\n+\n+  final Bytes TRUE_RESPONSE = Bytes.fromHexString(TypeEncoder.encode(new Bool(true)));\n+  final Bytes FALSE_RESPONSE = Bytes.fromHexString(TypeEncoder.encode(new Bool(false)));\n+\n+  public NodeSmartContractV2PermissioningController(\n+      final Address contractAddress,\n+      final TransactionSimulator transactionSimulator,\n+      final MetricsSystem metricsSystem) {\n+    super(contractAddress, transactionSimulator, metricsSystem);\n+  }\n+\n+  @Override\n+  boolean checkSmartContractRules(final EnodeURL sourceEnode, final EnodeURL destinationEnode) {\n+    return isPermitted(sourceEnode) && isPermitted(destinationEnode);\n+  }\n+\n+  private boolean isPermitted(final EnodeURL enode) {\n+    final Bytes payload = createPayload(enode);\n+    final CallParameter callParams =\n+        new CallParameter(null, contractAddress, -1, null, null, payload);", "originalCommit": "dde420b35359c613760597cc3cd065513a288e0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTc2Mg==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r503675762", "bodyText": "the gas limit. It isn't relevant for the simulation call.", "author": "lucassaldanha", "createdAt": "2020-10-13T05:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwOTYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxODE3OQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r503018179", "bodyText": "this is duplicated on the new V2 controller", "author": "macfarla", "createdAt": "2020-10-12T03:17:17Z", "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/NodeSmartContractPermissioningController.java", "diffHunk": "@@ -61,58 +55,19 @@ private static Bytes hashSignature(final String signature) {\n   private static final Bytes FALSE_RESPONSE =", "originalCommit": "dde420b35359c613760597cc3cd065513a288e0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTU1OQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r503675559", "bodyText": "Not really, this is using the 32-bit encoded response. The V2 is using a simple bool response (as per solidity types). They look similar but are different :)", "author": "lucassaldanha", "createdAt": "2020-10-13T05:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxODE3OQ=="}], "type": "inlineReview"}, {"oid": "931c230884cae0e54d419c44c77955b6657dd245", "url": "https://github.com/hyperledger/besu/commit/931c230884cae0e54d419c44c77955b6657dd245", "message": "Added unit tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-13T05:40:27Z", "type": "forcePushed"}, {"oid": "6a7f15baf4973da8e452a135af574529d486ab53", "url": "https://github.com/hyperledger/besu/commit/6a7f15baf4973da8e452a135af574529d486ab53", "message": "Added unit tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-13T05:48:53Z", "type": "forcePushed"}, {"oid": "1c202990ec4b13439fee00491ed56fde19ecfc57", "url": "https://github.com/hyperledger/besu/commit/1c202990ec4b13439fee00491ed56fde19ecfc57", "message": "Added unit tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-13T07:43:36Z", "type": "forcePushed"}, {"oid": "fda1b7c9b407f5767d09fd03e792b68c525fafe7", "url": "https://github.com/hyperledger/besu/commit/fda1b7c9b407f5767d09fd03e792b68c525fafe7", "message": "Added unit tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-14T02:26:38Z", "type": "forcePushed"}, {"oid": "62b258aea269119ebbf087401e329c58e68b8f0f", "url": "https://github.com/hyperledger/besu/commit/62b258aea269119ebbf087401e329c58e68b8f0f", "message": "Added unit and acceptance tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-15T05:50:58Z", "type": "forcePushed"}, {"oid": "9b3a716c0c2dbc60b9f5224604eb17bdde16277f", "url": "https://github.com/hyperledger/besu/commit/9b3a716c0c2dbc60b9f5224604eb17bdde16277f", "message": "Added NodeSmartContractV2PermissioningController\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:05:19Z", "type": "commit"}, {"oid": "3df9050e208bfa670a6df07c98b48c226e0d915f", "url": "https://github.com/hyperledger/besu/commit/3df9050e208bfa670a6df07c98b48c226e0d915f", "message": "Spotless :)\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:05:19Z", "type": "commit"}, {"oid": "80850c51f5fa9bbfde4168a73209dabb2f1d6964", "url": "https://github.com/hyperledger/besu/commit/80850c51f5fa9bbfde4168a73209dabb2f1d6964", "message": "Added unit and acceptance tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:05:19Z", "type": "commit"}, {"oid": "dd955697b5559fd2d6feaf4e04dbd18cf2806f4b", "url": "https://github.com/hyperledger/besu/commit/dd955697b5559fd2d6feaf4e04dbd18cf2806f4b", "message": "Changelog entry\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:09:19Z", "type": "commit"}, {"oid": "dd955697b5559fd2d6feaf4e04dbd18cf2806f4b", "url": "https://github.com/hyperledger/besu/commit/dd955697b5559fd2d6feaf4e04dbd18cf2806f4b", "message": "Changelog entry\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:09:19Z", "type": "forcePushed"}, {"oid": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "url": "https://github.com/hyperledger/besu/commit/702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "message": "Updating tests\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-16T01:51:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NzQ1MQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r506987451", "bodyText": "connectionAllowedFunction?", "author": "macfarla", "createdAt": "2020-10-17T21:46:57Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/transaction/perm/NodeSmartContractPermissioningConnectionIsAllowedV2Transaction.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.dsl.transaction.perm;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.p2p.peers.EnodeURL;\n+import org.hyperledger.besu.ethereum.permissioning.NodeSmartContractV2PermissioningController;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.Node;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.RunnableNode;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.NodeRequests;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.Transaction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.web3j.abi.FunctionEncoder;\n+import org.web3j.abi.datatypes.Function;\n+import org.web3j.protocol.core.DefaultBlockParameterName;\n+\n+public class NodeSmartContractPermissioningConnectionIsAllowedV2Transaction\n+    implements Transaction<Boolean> {\n+\n+  private final Address contractAddress;\n+  private final Node node;\n+\n+  public NodeSmartContractPermissioningConnectionIsAllowedV2Transaction(\n+      final Address contractAddress, final Node node) {\n+    this.contractAddress = contractAddress;\n+    this.node = node;\n+  }\n+\n+  @Override\n+  public Boolean execute(final NodeRequests node) {\n+    try {\n+      final String value =\n+          node.eth().ethCall(payload(), DefaultBlockParameterName.LATEST).send().getValue();\n+      return Bytes.fromHexString(value)\n+          .equals(NodeSmartContractV2PermissioningController.TRUE_RESPONSE);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private org.web3j.protocol.core.methods.request.Transaction payload() {\n+    final EnodeURL enodeURL = EnodeURL.fromURI(((RunnableNode) node).enodeUrl());\n+    final Bytes payload = createPayload(enodeURL);\n+\n+    return org.web3j.protocol.core.methods.request.Transaction.createFunctionCallTransaction(\n+        null, null, null, null, contractAddress.toString(), payload.toString());\n+  }\n+\n+  private Bytes createPayload(final EnodeURL enodeUrl) {\n+    try {\n+      final String hexNodeIdString = enodeUrl.getNodeId().toUnprefixedHexString();\n+      final byte[] ip = NodeSmartContractV2PermissioningController.encodeIp(enodeUrl.getIp());\n+      final int port = enodeUrl.getListeningPortOrZero();\n+\n+      final Function addNodeFunction =", "originalCommit": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NzU4MQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r506987581", "bodyText": "removeNodeFunction", "author": "macfarla", "createdAt": "2020-10-17T21:49:11Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/transaction/perm/NodeSmartContractPermissioningForbidNodeV2Transaction.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.dsl.transaction.perm;\n+\n+import static org.web3j.utils.Numeric.toHexString;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.p2p.peers.EnodeURL;\n+import org.hyperledger.besu.ethereum.permissioning.NodeSmartContractV2PermissioningController;\n+import org.hyperledger.besu.tests.acceptance.dsl.account.Account;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.Node;\n+import org.hyperledger.besu.tests.acceptance.dsl.node.RunnableNode;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.NodeRequests;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.Transaction;\n+\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.web3j.abi.FunctionEncoder;\n+import org.web3j.abi.datatypes.Function;\n+import org.web3j.crypto.RawTransaction;\n+import org.web3j.crypto.TransactionEncoder;\n+\n+public class NodeSmartContractPermissioningForbidNodeV2Transaction implements Transaction<Hash> {\n+\n+  private final Account sender;\n+  private final Address contractAddress;\n+  private final Node node;\n+\n+  public NodeSmartContractPermissioningForbidNodeV2Transaction(\n+      final Account sender, final Address contractAddress, final Node node) {\n+    this.sender = sender;\n+    this.contractAddress = contractAddress;\n+    this.node = node;\n+  }\n+\n+  @Override\n+  public Hash execute(final NodeRequests node) {\n+    final String signedTransactionData = signedTransactionData();\n+    try {\n+      String hash =\n+          node.eth().ethSendRawTransaction(signedTransactionData).send().getTransactionHash();\n+      return Hash.fromHexString(hash);\n+    } catch (final IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  private String signedTransactionData() {\n+    final EnodeURL enodeURL = EnodeURL.fromURI(((RunnableNode) node).enodeUrl());\n+    final Bytes payload = createPayload(enodeURL);\n+\n+    RawTransaction transaction =\n+        RawTransaction.createTransaction(\n+            sender.getNextNonce(),\n+            BigInteger.valueOf(1000),\n+            BigInteger.valueOf(3_000_000L),\n+            contractAddress.toString(),\n+            payload.toString());\n+\n+    return toHexString(\n+        TransactionEncoder.signMessage(transaction, sender.web3jCredentialsOrThrow()));\n+  }\n+\n+  private Bytes createPayload(final EnodeURL enodeUrl) {\n+    try {\n+      final String hexNodeIdString = enodeUrl.getNodeId().toUnprefixedHexString();\n+      final byte[] ip = NodeSmartContractV2PermissioningController.encodeIp(enodeUrl.getIp());\n+      final int port = enodeUrl.getListeningPortOrZero();\n+\n+      final Function addNodeFunction =", "originalCommit": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4Nzk3Ng==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r506987976", "bodyText": "is it worth adding verify(connectionNotAllowed(forbiddenNode))", "author": "macfarla", "createdAt": "2020-10-17T21:54:30Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/permissioning/NodeSmartContractPermissioningV2AcceptanceTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.permissioning;\n+\n+import org.hyperledger.besu.tests.acceptance.dsl.node.Node;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class NodeSmartContractPermissioningV2AcceptanceTest\n+    extends NodeSmartContractPermissioningV2AcceptanceTestBase {\n+\n+  private Node bootnode;\n+  private Node permissionedNode;\n+  private Node allowedNode;\n+  private Node forbiddenNode;\n+\n+  @Before\n+  public void setUp() {\n+    bootnode = bootnode(\"bootnode\");\n+    forbiddenNode = node(\"forbidden-node\");\n+    allowedNode = node(\"allowed-node\");\n+    permissionedNode = permissionedNode(\"permissioned-node\");\n+\n+    permissionedCluster.start(bootnode, forbiddenNode, allowedNode, permissionedNode);\n+\n+    // updating permissioning smart contract with allowed nodes\n+\n+    permissionedNode.execute(allowNode(bootnode));\n+    permissionedNode.verify(connectionIsAllowed(bootnode));\n+\n+    permissionedNode.execute(allowNode(allowedNode));\n+    permissionedNode.verify(connectionIsAllowed(allowedNode));\n+\n+    permissionedNode.execute(allowNode(permissionedNode));\n+    permissionedNode.verify(connectionIsAllowed(permissionedNode));\n+  }\n+\n+  @Test\n+  public void permissionedNodeShouldPeerOnlyWithAllowedNodes() {\n+    bootnode.verify(net.awaitPeerCount(3));\n+    allowedNode.verify(net.awaitPeerCount(3));\n+    forbiddenNode.verify(net.awaitPeerCount(2));\n+    permissionedNode.verify(net.awaitPeerCount(2));\n+  }\n+\n+  @Test\n+  public void permissionedNodeShouldDisconnectFromNodeNotPermittedAnymore() {\n+    permissionedNode.verify(admin.addPeer(bootnode));\n+    permissionedNode.verify(admin.addPeer(allowedNode));\n+    permissionedNode.verify(net.awaitPeerCount(2));\n+\n+    permissionedNode.execute(forbidNode(allowedNode));\n+    permissionedNode.verify(connectionIsForbidden(allowedNode));\n+\n+    permissionedNode.verify(net.awaitPeerCount(1));\n+  }\n+\n+  @Test\n+  public void permissionedNodeShouldConnectToNewlyPermittedNode() {\n+    permissionedNode.verify(admin.addPeer(bootnode));\n+    permissionedNode.verify(admin.addPeer(allowedNode));\n+    permissionedNode.verify(net.awaitPeerCount(2));\n+\n+    permissionedNode.execute(allowNode(forbiddenNode));\n+    permissionedNode.verify(connectionIsAllowed(forbiddenNode));\n+    permissionedNode.verify(admin.addPeer(forbiddenNode));\n+\n+    permissionedNode.verify(net.awaitPeerCount(3));\n+  }\n+\n+  @Test\n+  public void permissioningUpdatesPropagateThroughNetwork() {\n+    permissionedNode.verify(admin.addPeer(bootnode));\n+    permissionedNode.verify(admin.addPeer(allowedNode));\n+    permissionedNode.verify(net.awaitPeerCount(2));\n+\n+    // permissioning changes in peer should propagate to permissioned node\n+    allowedNode.execute(allowNode(forbiddenNode));\n+    allowedNode.verify(connectionIsAllowed(forbiddenNode));\n+    permissionedNode.verify(connectionIsAllowed(forbiddenNode));\n+\n+    permissionedNode.verify(admin.addPeer(forbiddenNode));\n+    permissionedNode.verify(net.awaitPeerCount(3));\n+  }\n+\n+  @Test\n+  public void onChainPermissioningAllowlistShouldPersistAcrossRestarts() {\n+    permissionedCluster.stop();\n+    permissionedCluster.start(bootnode, forbiddenNode, allowedNode, permissionedNode);\n+\n+    permissionedNode.verify(connectionIsAllowed(allowedNode));\n+    permissionedNode.verify(connectionIsAllowed(bootnode));\n+    permissionedNode.verify(connectionIsAllowed(permissionedNode));", "originalCommit": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODMxNQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r506988315", "bodyText": "final", "author": "macfarla", "createdAt": "2020-10-17T21:58:40Z", "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/NodeSmartContractV2PermissioningController.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.permissioning;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.p2p.peers.EnodeURL;\n+import org.hyperledger.besu.ethereum.transaction.CallParameter;\n+import org.hyperledger.besu.ethereum.transaction.TransactionSimulator;\n+import org.hyperledger.besu.ethereum.transaction.TransactionSimulatorResult;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.net.InetAddress;\n+import java.util.List;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.web3j.abi.FunctionEncoder;\n+import org.web3j.abi.TypeEncoder;\n+import org.web3j.abi.datatypes.Bool;\n+import org.web3j.abi.datatypes.Function;\n+\n+/**\n+ * Controller that can read from a smart contract that exposes the EEA node permissioning v2 call\n+ * connectionAllowed(string,bytes16,uint16)\n+ */\n+public class NodeSmartContractV2PermissioningController\n+    extends AbstractNodeSmartContractPermissioningController {\n+\n+  public static final Bytes TRUE_RESPONSE = Bytes.fromHexString(TypeEncoder.encode(new Bool(true)));\n+  public static Bytes FALSE_RESPONSE = Bytes.fromHexString(TypeEncoder.encode(new Bool(false)));", "originalCommit": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODc5NQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r506988795", "bodyText": "is this needed? no other changes in this test", "author": "macfarla", "createdAt": "2020-10-17T22:04:56Z", "path": "ethereum/permissioning/src/test/java/org/hyperledger/besu/ethereum/permissioning/node/NodePermissioningControllerFactoryTest.java", "diffHunk": "@@ -55,6 +56,11 @@\n   SmartContractPermissioningConfiguration smartContractPermissioningConfiguration;\n   PermissioningConfiguration config;\n \n+  @Before\n+  public void before() {\n+    when(transactionSimulator.doesAddressExistAtHead(any())).thenReturn(Optional.of(true));\n+  }\n+", "originalCommit": "702c1a5dae36ea6b7c911c61d3dea207fe2eacf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzM1NDY2OQ==", "url": "https://github.com/hyperledger/besu/pull/1435#discussion_r507354669", "bodyText": "It is! because now the existence of the contract is tested a bit earlier in the code. Without this, all tests fail :)", "author": "lucassaldanha", "createdAt": "2020-10-19T02:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODc5NQ=="}], "type": "inlineReview"}, {"oid": "99f95133ee1c625d7925383e4bc72fdc6bd300e2", "url": "https://github.com/hyperledger/besu/commit/99f95133ee1c625d7925383e4bc72fdc6bd300e2", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-19T02:11:05Z", "type": "commit"}, {"oid": "6940d9cd7bbc73e2ae60b9365f00cbdfea3c0f65", "url": "https://github.com/hyperledger/besu/commit/6940d9cd7bbc73e2ae60b9365f00cbdfea3c0f65", "message": "Merge branch 'master' into node-perm-update\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>", "committedDate": "2020-10-19T02:11:40Z", "type": "commit"}]}