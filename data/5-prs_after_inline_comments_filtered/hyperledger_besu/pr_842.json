{"pr_number": 842, "pr_title": "[BESU-696/492][Fix the eth_estimateGas json rpc", "pr_createdAt": "2020-05-05T12:40:25Z", "pr_url": "https://github.com/hyperledger/besu/pull/842", "timeline": [{"oid": "11c8d5679a37d33d223fdf8c32a2ce04b143ea41", "url": "https://github.com/hyperledger/besu/commit/11c8d5679a37d33d223fdf8c32a2ce04b143ea41", "message": "fix the eth_estimateGas json rpc\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T12:14:15Z", "type": "commit"}, {"oid": "385d96526c83104a38dd2c47a2381ab2bd4a6468", "url": "https://github.com/hyperledger/besu/commit/385d96526c83104a38dd2c47a2381ab2bd4a6468", "message": "Merge branch 'master/master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T12:41:28Z", "type": "commit"}, {"oid": "d99ae15eda3c1632551d4806cdd2083c7b43e7bf", "url": "https://github.com/hyperledger/besu/commit/d99ae15eda3c1632551d4806cdd2083c7b43e7bf", "message": "fix unit test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T13:00:18Z", "type": "commit"}, {"oid": "96980c5b9ef86957746c8ed9a86db7daab425a7d", "url": "https://github.com/hyperledger/besu/commit/96980c5b9ef86957746c8ed9a86db7daab425a7d", "message": "Merge branch 'master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T13:21:32Z", "type": "commit"}, {"oid": "4a2c64b914efcb6f52fd756af9beb05cf15a45ae", "url": "https://github.com/hyperledger/besu/commit/4a2c64b914efcb6f52fd756af9beb05cf15a45ae", "message": "fix some issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T14:20:54Z", "type": "commit"}, {"oid": "867a463c1a0c0b1226ba92b566833fca52306ace", "url": "https://github.com/hyperledger/besu/commit/867a463c1a0c0b1226ba92b566833fca52306ace", "message": "fix some tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-05T15:36:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4ODE3OQ==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r421088179", "bodyText": "I'd prefer we clone and change the object instead of introducing a single mutable field into an otherwise immutable class.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    modifiedCallParams.setGasLimit(highGasLimit);\n          \n          \n            \n            JsonCallParameter modifiedCallParams =\n          \n          \n            \n                    overrideGasLimitAndPrice(callParams, highGasLimit);", "author": "shemnon", "createdAt": "2020-05-06T20:59:07Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGas.java", "diffHunk": "@@ -51,21 +60,94 @@ public String getName() {\n \n   @Override\n   public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n+\n     final JsonCallParameter callParams =\n         requestContext.getRequiredParameter(0, JsonCallParameter.class);\n \n     final BlockHeader blockHeader = blockHeader();\n     if (blockHeader == null) {\n-      return errorResponse(requestContext, JsonRpcError.INTERNAL_ERROR);\n+      return new JsonRpcErrorResponse(\n+          requestContext.getRequest().getId(), JsonRpcError.INTERNAL_ERROR);\n     }\n+    return doEstimateGas(requestContext.getRequest(), callParams, blockHeader);\n+  }\n+\n+  /**\n+   * Allows to estimate gas for a transaction\n+   *\n+   * @param request json rpc request\n+   * @param callParams call params\n+   * @param blockHeader block header\n+   * @return json rpc response with the estimate gas of the transaction, otherwise the error\n+   */\n+  private JsonRpcResponse doEstimateGas(\n+      final JsonRpcRequest request,\n+      final JsonCallParameter callParams,\n+      final BlockHeader blockHeader) {\n \n-    final JsonCallParameter modifiedCallParams =\n+    long lowGasLimit, midGasLimit, highGasLimit;\n+    int numberOfRetry = 0;\n+    boolean foundEstimateGas;\n+\n+    JsonCallParameter modifiedCallParams =\n         overrideGasLimitAndPrice(callParams, blockHeader.getGasLimit());\n \n-    return transactionSimulator\n-        .process(modifiedCallParams, blockHeader.getNumber())\n-        .map(gasEstimateResponse(requestContext))\n-        .orElse(errorResponse(requestContext, JsonRpcError.INTERNAL_ERROR));\n+    Optional<TransactionSimulatorResult> simulatorResult = Optional.empty();\n+\n+    try {\n+\n+      // make a first estimate of the necessary gasLimit\n+      simulatorResult = transactionSimulator.process(modifiedCallParams, blockHeader.getNumber());\n+      lowGasLimit =\n+          highGasLimit =\n+              simulatorResult\n+                  .filter(TransactionSimulatorResult::isSuccessful)\n+                  .map(TransactionSimulatorResult::getGasEstimate)\n+                  .orElseThrow();\n+\n+      // check that the estimate is valid and if not we increase the estimate by\n+      // GAS_ESTIMATE_CHANGE_DENOMINATOR. if after MAX_ESTIMATE_NUMBER_OF_RETRY retries you cannot\n+      // find a valid estimate. we return the error returned by the transaction\n+      do {\n+\n+        modifiedCallParams.setGasLimit(highGasLimit);", "originalCommit": "867a463c1a0c0b1226ba92b566833fca52306ace", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4ODQ4OQ==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r421088489", "bodyText": "See my comment on clone and copy.  Making this the only mutable field seems awkward.", "author": "shemnon", "createdAt": "2020-05-06T20:59:36Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/transaction/CallParameter.java", "diffHunk": "@@ -28,7 +28,7 @@\n \n   private final Address to;\n \n-  private final long gasLimit;\n+  private long gasLimit;", "originalCommit": "867a463c1a0c0b1226ba92b566833fca52306ace", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28bfa808233fec7b22930ed1ab7d1cc653b89178", "url": "https://github.com/hyperledger/besu/commit/28bfa808233fec7b22930ed1ab7d1cc653b89178", "message": "estimate gas thanks to an operation tracer\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-07T14:43:25Z", "type": "commit"}, {"oid": "85080dce4f3be22832ea824cba5cadaee481ea38", "url": "https://github.com/hyperledger/besu/commit/85080dce4f3be22832ea824cba5cadaee481ea38", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-07T14:51:32Z", "type": "commit"}, {"oid": "3718da33f13f924dde0d089b3c812682b3add569", "url": "https://github.com/hyperledger/besu/commit/3718da33f13f924dde0d089b3c812682b3add569", "message": "add unit test for tracer\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-07T17:06:49Z", "type": "commit"}, {"oid": "631df3a64d502ef2b4006e079a1f40b387a044f2", "url": "https://github.com/hyperledger/besu/commit/631df3a64d502ef2b4006e079a1f40b387a044f2", "message": "fix build issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-07T17:31:17Z", "type": "commit"}, {"oid": "3c9be99997400df486b5fc877c6412db80c754a4", "url": "https://github.com/hyperledger/besu/commit/3c9be99997400df486b5fc877c6412db80c754a4", "message": "update test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-07T20:39:13Z", "type": "commit"}, {"oid": "204bfc93c0194b64b09e44a1544b1ca04d575692", "url": "https://github.com/hyperledger/besu/commit/204bfc93c0194b64b09e44a1544b1ca04d575692", "message": "Merge branch 'upstream/master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-08T09:06:29Z", "type": "commit"}, {"oid": "dda4666e521ba6a5ed9b9b019fbb3edf8d0f7857", "url": "https://github.com/hyperledger/besu/commit/dda4666e521ba6a5ed9b9b019fbb3edf8d0f7857", "message": "add try finally for the operation tracer\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-08T11:36:31Z", "type": "commit"}, {"oid": "3c70ed05a1531b8cd80477a9898339f64f229942", "url": "https://github.com/hyperledger/besu/commit/3c70ed05a1531b8cd80477a9898339f64f229942", "message": "Merge branch 'upstream/master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-11T08:23:27Z", "type": "commit"}, {"oid": "3c70ed05a1531b8cd80477a9898339f64f229942", "url": "https://github.com/hyperledger/besu/commit/3c70ed05a1531b8cd80477a9898339f64f229942", "message": "Merge branch 'upstream/master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-11T08:23:27Z", "type": "forcePushed"}, {"oid": "8765d8cbdbc2d9ea7ec2dd87ca26b3eafbdd63c3", "url": "https://github.com/hyperledger/besu/commit/8765d8cbdbc2d9ea7ec2dd87ca26b3eafbdd63c3", "message": "Add check that reason is available before trying to recover it\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-11T14:25:22Z", "type": "commit"}, {"oid": "98cf9753f1f5415c5105a34552836e0d8d77fc3a", "url": "https://github.com/hyperledger/besu/commit/98cf9753f1f5415c5105a34552836e0d8d77fc3a", "message": "Merge branch 'master' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit", "committedDate": "2020-05-12T08:53:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4MzIwNg==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423583206", "bodyText": "I would suggest to compute the 65/64 factor once and set it as a constant in this class.", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T09:11:13Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGas.java", "diffHunk": "@@ -85,19 +88,38 @@ private JsonCallParameter overrideGasLimitAndPrice(\n   }\n \n   private Function<TransactionSimulatorResult, JsonRpcResponse> gasEstimateResponse(\n-      final JsonRpcRequestContext request) {\n+      final JsonRpcRequestContext request, final EstimateGasOperationTracer operationTracer) {\n     return result ->\n         result.isSuccessful()\n             ? new JsonRpcSuccessResponse(\n-                request.getRequest().getId(), Quantity.create(result.getGasEstimate()))\n+                request.getRequest().getId(),\n+                Quantity.create(processEstimateGas(result, operationTracer)))\n             : errorResponse(request, result.getValidationResult());\n   }\n \n+  /**\n+   * Estimate gas by adding minimum gas remaining for some operation and the necessary gas for sub\n+   * calls\n+   *\n+   * @param result transaction simulator result\n+   * @param operationTracer estimate gas operation tracer\n+   * @return estimate gas\n+   */\n+  private long processEstimateGas(\n+      final TransactionSimulatorResult result, final EstimateGasOperationTracer operationTracer) {\n+    // no more than 63/64s of the remaining gas can be passed to the sub calls\n+    final double subCallMultiplier = Math.pow(65D / 64D, operationTracer.getMaxDepth());", "originalCommit": "98cf9753f1f5415c5105a34552836e0d8d77fc3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNzE5Nw==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423627197", "bodyText": "Done", "author": "matkt", "createdAt": "2020-05-12T10:25:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4MzIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4NTAyNg==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423585026", "bodyText": "Missing Javadoc", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T09:14:07Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/TransactionProcessor.java", "diffHunk": "@@ -105,6 +105,8 @@ default boolean isSuccessful() {\n      * @return the revert reason.\n      */\n     Optional<Bytes> getRevertReason();\n+\n+    long getEstimateGasUsedByTransaction();", "originalCommit": "98cf9753f1f5415c5105a34552836e0d8d77fc3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNzI3OA==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423627278", "bodyText": "Added", "author": "matkt", "createdAt": "2020-05-12T10:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4NTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4NzM3OQ==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423587379", "bodyText": "Rather use Gas.compareTo method to check if sStoreStipendNeeded  is equal to zero. Conversion to long is not necessary.", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T09:17:50Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/EstimateGasOperationTracer.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.vm;\n+\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.vm.ehalt.ExceptionalHaltException;\n+import org.hyperledger.besu.ethereum.vm.operations.SStoreOperation;\n+\n+import java.util.Optional;\n+\n+public class EstimateGasOperationTracer implements OperationTracer {\n+\n+  private int maxDepth = 0;\n+\n+  private Gas sStoreStipendNeeded = Gas.ZERO;\n+\n+  @Override\n+  public void traceExecution(\n+      final MessageFrame frame,\n+      final Optional<Gas> currentGasCost,\n+      final OperationTracer.ExecuteOperation executeOperation)\n+      throws ExceptionalHaltException {\n+    try {\n+      executeOperation.execute();\n+    } finally {\n+      if (frame.getCurrentOperation() instanceof SStoreOperation\n+          && sStoreStipendNeeded.toLong() == 0) {", "originalCommit": "98cf9753f1f5415c5105a34552836e0d8d77fc3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNzM5NQ==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423627395", "bodyText": "Done", "author": "matkt", "createdAt": "2020-05-12T10:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4NzM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4ODg5NA==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423588894", "bodyText": "(Suggestion): For consistency i would suggest to import statically assertThat method.", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T09:20:03Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/EstimateGasOperationTracerTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.vm;\n+\n+import static org.mockito.Mockito.mock;\n+\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.core.MessageFrameTestFixture;\n+import org.hyperledger.besu.ethereum.vm.OperationTracer.ExecuteOperation;\n+import org.hyperledger.besu.ethereum.vm.ehalt.ExceptionalHaltException;\n+import org.hyperledger.besu.ethereum.vm.operations.CallCodeOperation;\n+import org.hyperledger.besu.ethereum.vm.operations.SStoreOperation;\n+\n+import java.util.Optional;\n+\n+import org.assertj.core.api.Assertions;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class EstimateGasOperationTracerTest {\n+\n+  private EstimateGasOperationTracer operationTracer;\n+  private MessageFrameTestFixture messageFrameTestFixture;\n+\n+  @Before\n+  public void setUp() {\n+    operationTracer = new EstimateGasOperationTracer();\n+    messageFrameTestFixture = new MessageFrameTestFixture();\n+  }\n+\n+  @Test\n+  public void shouldDetectChangeInDepthDuringExecution() throws ExceptionalHaltException {\n+\n+    final ExecuteOperation noExecutionOperation = mock(ExecuteOperation.class);\n+\n+    Assertions.assertThat(operationTracer.getMaxDepth()).isEqualTo(0);", "originalCommit": "98cf9753f1f5415c5105a34552836e0d8d77fc3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNzY4NA==", "url": "https://github.com/hyperledger/besu/pull/842#discussion_r423627684", "bodyText": "yes you are right I just changed", "author": "matkt", "createdAt": "2020-05-12T10:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4ODg5NA=="}], "type": "inlineReview"}, {"oid": "2007f27ae88721c75b9cb9be3338fd340471eb66", "url": "https://github.com/hyperledger/besu/commit/2007f27ae88721c75b9cb9be3338fd340471eb66", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-12T10:24:18Z", "type": "commit"}, {"oid": "181a50373459819aec91cdb7cb694849045caf84", "url": "https://github.com/hyperledger/besu/commit/181a50373459819aec91cdb7cb694849045caf84", "message": "Merge commit '4d1cf80d498119a25fa2da4bd3c8c31e5f366628' into feature/besu-696-fix-intrinsic-gas-exceeds-gas-limit\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-12T17:06:42Z", "type": "commit"}]}