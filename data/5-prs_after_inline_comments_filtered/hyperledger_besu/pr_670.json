{"pr_number": 670, "pr_title": "[EIP-1559] Step 6 - Enforce the per transaction gas limit", "pr_createdAt": "2020-04-07T12:00:51Z", "pr_url": "https://github.com/hyperledger/besu/pull/670", "timeline": [{"oid": "ba37fd0efcba2de4ea34c979060ff361a1fe9798", "url": "https://github.com/hyperledger/besu/commit/ba37fd0efcba2de4ea34c979060ff361a1fe9798", "message": "Added changelog entries for PR:\n- https://github.com/hyperledger/besu/pull/430\n- https://github.com/hyperledger/besu/pull/440\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-12T09:09:40Z", "type": "commit"}, {"oid": "872f9cc4e93b90829961ebe6e599c51af43c95a7", "url": "https://github.com/hyperledger/besu/commit/872f9cc4e93b90829961ebe6e599c51af43c95a7", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-13T08:25:43Z", "type": "commit"}, {"oid": "e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "url": "https://github.com/hyperledger/besu/commit/e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-16T09:10:11Z", "type": "commit"}, {"oid": "a2fb831c87dae221c92a9f9ec7705500717f1e77", "url": "https://github.com/hyperledger/besu/commit/a2fb831c87dae221c92a9f9ec7705500717f1e77", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T09:17:25Z", "type": "commit"}, {"oid": "c07ed7de515e1e25ea22ef38b59bf8337086812e", "url": "https://github.com/hyperledger/besu/commit/c07ed7de515e1e25ea22ef38b59bf8337086812e", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T15:26:18Z", "type": "commit"}, {"oid": "1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "url": "https://github.com/hyperledger/besu/commit/1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-18T08:29:25Z", "type": "commit"}, {"oid": "ee10a2590d8e23b95a40c946a2927730714c4793", "url": "https://github.com/hyperledger/besu/commit/ee10a2590d8e23b95a40c946a2927730714c4793", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-19T16:27:54Z", "type": "commit"}, {"oid": "40cd31d7b48aab7b285524661ac17168c0d38467", "url": "https://github.com/hyperledger/besu/commit/40cd31d7b48aab7b285524661ac17168c0d38467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-23T10:35:38Z", "type": "commit"}, {"oid": "e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "url": "https://github.com/hyperledger/besu/commit/e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-25T08:04:10Z", "type": "commit"}, {"oid": "2c782ba4617a68e42def01737bdc6950ff7f9f53", "url": "https://github.com/hyperledger/besu/commit/2c782ba4617a68e42def01737bdc6950ff7f9f53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T09:26:18Z", "type": "commit"}, {"oid": "8b7f62d00c53ed1e8de940bffc675fad31825ba2", "url": "https://github.com/hyperledger/besu/commit/8b7f62d00c53ed1e8de940bffc675fad31825ba2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T11:50:21Z", "type": "commit"}, {"oid": "ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "url": "https://github.com/hyperledger/besu/commit/ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T08:45:52Z", "type": "commit"}, {"oid": "97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "url": "https://github.com/hyperledger/besu/commit/97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T10:50:47Z", "type": "commit"}, {"oid": "95947ab35e9145c5f788bb98ad1068a3db7a4895", "url": "https://github.com/hyperledger/besu/commit/95947ab35e9145c5f788bb98ad1068a3db7a4895", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T12:24:48Z", "type": "commit"}, {"oid": "e8c4e9921430b8a06f8bb882bc9ce4975ce5579b", "url": "https://github.com/hyperledger/besu/commit/e8c4e9921430b8a06f8bb882bc9ce4975ce5579b", "message": "Implement gas limit and gas price block header validation rules as per specified in EIP-1559\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T15:33:44Z", "type": "commit"}, {"oid": "e911532ffe39cc3d159d29fa8e99b7506fdcf168", "url": "https://github.com/hyperledger/besu/commit/e911532ffe39cc3d159d29fa8e99b7506fdcf168", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T08:15:04Z", "type": "commit"}, {"oid": "9fb289299c04b4afc774b74c51b5ed15ad63882f", "url": "https://github.com/hyperledger/besu/commit/9fb289299c04b4afc774b74c51b5ed15ad63882f", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T09:00:06Z", "type": "commit"}, {"oid": "c521cef761d09abb3aee753bf5207fac9574bf87", "url": "https://github.com/hyperledger/besu/commit/c521cef761d09abb3aee753bf5207fac9574bf87", "message": "Merge remote-tracking branch 'upstream/master' into eip1559-step5\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-07T11:18:43Z", "type": "commit"}, {"oid": "aa2f839d1218a684625a616a76754af216510221", "url": "https://github.com/hyperledger/besu/commit/aa2f839d1218a684625a616a76754af216510221", "message": "Merge branch 'eip1559-step5' of https://github.com/abdelhamidbakhta/besu into eip1559-step5", "committedDate": "2020-04-07T11:19:02Z", "type": "commit"}, {"oid": "5899116effcd29e2ce4d33b33f9017dff0471ef4", "url": "https://github.com/hyperledger/besu/commit/5899116effcd29e2ce4d33b33f9017dff0471ef4", "message": "We should enforce the per transaction gas limit, as specified by the EIP, to 8,000,000 gas.\nAdd a `TransactionInvalidReason`\nUpdate the `validate` method in `MainnetTransactionValidator` to enforce this check.\nUpdate the validation process in `MainnetBlockBodyValidator` to enforce this check for all transactions within a block.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-07T11:58:55Z", "type": "commit"}, {"oid": "c01b0e3bc72247e7120147d876cefdf1802fd2a4", "url": "https://github.com/hyperledger/besu/commit/c01b0e3bc72247e7120147d876cefdf1802fd2a4", "message": "fix unit test\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-07T12:23:54Z", "type": "commit"}, {"oid": "29878ceb5401ae7a0af41a3d57e0c4f475b34912", "url": "https://github.com/hyperledger/besu/commit/29878ceb5401ae7a0af41a3d57e0c4f475b34912", "message": "Merge branch 'master' into eip1559-step6", "committedDate": "2020-04-07T16:31:20Z", "type": "commit"}, {"oid": "cfc87ab071b76e6e8abaae598b0b68e770987d57", "url": "https://github.com/hyperledger/besu/commit/cfc87ab071b76e6e8abaae598b0b68e770987d57", "message": "Merge remote-tracking branch 'upstream/master' into eip1559-step6\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasLimitValidationRule.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasPriceValidationRule.java\n#\tethereum/core/src/test/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasLimitValidationRuleTest.java\n#\tethereum/core/src/test/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasPriceValidationRuleTest.java", "committedDate": "2020-04-09T08:04:29Z", "type": "commit"}, {"oid": "cfc87ab071b76e6e8abaae598b0b68e770987d57", "url": "https://github.com/hyperledger/besu/commit/cfc87ab071b76e6e8abaae598b0b68e770987d57", "message": "Merge remote-tracking branch 'upstream/master' into eip1559-step6\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasLimitValidationRule.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasPriceValidationRule.java\n#\tethereum/core/src/test/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasLimitValidationRuleTest.java\n#\tethereum/core/src/test/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/EIP1559BlockHeaderGasPriceValidationRuleTest.java", "committedDate": "2020-04-09T08:04:29Z", "type": "forcePushed"}, {"oid": "1003315c3d59b84fc1ac948fdea265ef92fa4d93", "url": "https://github.com/hyperledger/besu/commit/1003315c3d59b84fc1ac948fdea265ef92fa4d93", "message": "Merge branch 'master' into eip1559-step6", "committedDate": "2020-04-09T09:48:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MjMyNQ==", "url": "https://github.com/hyperledger/besu/pull/670#discussion_r406292325", "bodyText": "Why do we need the blockNumber?  We get a separate TransactionValidator per fork, so either EIP 1559 will be configured because it applies in that fork or it won't be present because it wasn't configured. It's all kept in the ProtocolSchedule.  I think we should do without it.", "author": "shemnon", "createdAt": "2020-04-09T15:34:00Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetTransactionValidator.java", "diffHunk": "@@ -40,24 +42,46 @@\n   private final Optional<BigInteger> chainId;\n \n   private Optional<TransactionFilter> transactionFilter = Optional.empty();\n+  private final Optional<EIP1559> maybeEip1559;\n \n   public MainnetTransactionValidator(\n       final GasCalculator gasCalculator,\n       final boolean checkSignatureMalleability,\n       final Optional<BigInteger> chainId) {\n+    this(gasCalculator, checkSignatureMalleability, chainId, Optional.empty());\n+  }\n+\n+  public MainnetTransactionValidator(\n+      final GasCalculator gasCalculator,\n+      final boolean checkSignatureMalleability,\n+      final Optional<BigInteger> chainId,\n+      final Optional<EIP1559> maybeEip1559) {\n     this.gasCalculator = gasCalculator;\n     this.disallowSignatureMalleability = checkSignatureMalleability;\n     this.chainId = chainId;\n+    this.maybeEip1559 = maybeEip1559;\n   }\n \n   @Override\n-  public ValidationResult<TransactionInvalidReason> validate(final Transaction transaction) {\n+  public ValidationResult<TransactionInvalidReason> validate(\n+      final Transaction transaction, final long blockNumber) {", "originalCommit": "1003315c3d59b84fc1ac948fdea265ef92fa4d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NDE0Mg==", "url": "https://github.com/hyperledger/besu/pull/670#discussion_r406294142", "bodyText": "Oh yes you're right.", "author": "abdelhamidbakhta", "createdAt": "2020-04-09T15:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5ODUzOA==", "url": "https://github.com/hyperledger/besu/pull/670#discussion_r406298538", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-04-09T15:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MjMyNQ=="}], "type": "inlineReview"}, {"oid": "57d70f632d340202b3c645d176cbed7724e04487", "url": "https://github.com/hyperledger/besu/commit/57d70f632d340202b3c645d176cbed7724e04487", "message": "Removed blockNumber from TransactionValidator.validate\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-09T15:43:07Z", "type": "commit"}]}