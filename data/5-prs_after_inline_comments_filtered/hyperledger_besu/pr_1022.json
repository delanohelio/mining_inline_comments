{"pr_number": 1022, "pr_title": "[BESU-1003] Verify jumpsub destination validation", "pr_createdAt": "2020-06-02T15:27:35Z", "pr_url": "https://github.com/hyperledger/besu/pull/1022", "timeline": [{"oid": "4022daa609afb2fe14374b1819dbb1bf7afc7595", "url": "https://github.com/hyperledger/besu/commit/4022daa609afb2fe14374b1819dbb1bf7afc7595", "message": "update eip2315 implementation(change gastcosts)\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-28T12:10:30Z", "type": "commit"}, {"oid": "fbed57aa5ae857a290072864f676d482878e890f", "url": "https://github.com/hyperledger/besu/commit/fbed57aa5ae857a290072864f676d482878e890f", "message": "update opcode\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-05-29T18:38:25Z", "type": "commit"}, {"oid": "b9e770ea710fbe168c5df1f5268b02741699b7fe", "url": "https://github.com/hyperledger/besu/commit/b9e770ea710fbe168c5df1f5268b02741699b7fe", "message": "Merge branch 'feature/eip2315-change-gas-cost' into feature/besu-1003-verify-jumpsub-destination-validation\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-02T10:15:59Z", "type": "commit"}, {"oid": "9a421daaa6f1cc6de5a350a3aff995f7a337e659", "url": "https://github.com/hyperledger/besu/commit/9a421daaa6f1cc6de5a350a3aff995f7a337e659", "message": "improved check destination for Jump and JumpSub\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-02T11:39:19Z", "type": "commit"}, {"oid": "34e25cf44afd2665751945061b6a1475b42e2cce", "url": "https://github.com/hyperledger/besu/commit/34e25cf44afd2665751945061b6a1475b42e2cce", "message": "Merge branch 'upstream/master' into feature/besu-1003-verify-jumpsub-destination-validation", "committedDate": "2020-06-02T15:21:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r433968851", "bodyText": "I thought this is only an issue for jump sub? I thought we're allowed to have a jumpdest be the last op in the code.", "author": "RatanRSur", "createdAt": "2020-06-02T15:34:28Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Code.java", "diffHunk": "@@ -116,7 +116,7 @@ public boolean isValidJumpSubDestination(\n       final EVM evm, final MessageFrame frame, final UInt256 destination) {\n     if (!destination.fitsInt()) return false;\n     final int jumpDestination = destination.intValue();\n-    if (jumpDestination > getSize()) return false;\n+    if (jumpDestination >= getSize()) return false;", "originalCommit": "34e25cf44afd2665751945061b6a1475b42e2cce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3ODgyMQ==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r433978821", "bodyText": "it is true we're allowed to have a jumpdest be the last op in the code. but if the destination is equal to the size of the code it is because we are outside the code (PC == 0). I added a test to validate the fact that we can have a jumpdest at the end of the code shouldJumpWhenLocationIsJumpDestAndAtEndOfCode", "author": "matkt", "createdAt": "2020-06-02T15:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4Nzk3NA==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r433987974", "bodyText": "Ah! Ok, that makes sense.", "author": "RatanRSur", "createdAt": "2020-06-02T15:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4OTcxMg==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r433989712", "bodyText": "Wait, shouldn't it be something like >= getSize() -1? Because jump sub can't be the last instruction either? So it's technically inbounds but not actually legal.", "author": "RatanRSur", "createdAt": "2020-06-02T15:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMzQ4MQ==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r434003481", "bodyText": "Jumbsub can be the last instruction. there is a sample in the EIP (https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2315.md#subroutine-at-end-of-code) . You can see the Jumpsub opcode at the end of the code. 0x6005565c5d5b60035e (0x5e)", "author": "matkt", "createdAt": "2020-06-02T16:14:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMzk1OA==", "url": "https://github.com/hyperledger/besu/pull/1022#discussion_r434003958", "bodyText": "Ok, all I needed to know, LGTM!", "author": "RatanRSur", "createdAt": "2020-06-02T16:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk2ODg1MQ=="}], "type": "inlineReview"}, {"oid": "fcfed4b63b27acfb77837a4e63a40b95451f4d1a", "url": "https://github.com/hyperledger/besu/commit/fcfed4b63b27acfb77837a4e63a40b95451f4d1a", "message": "Merge branch 'upstream/master' into feature/besu-1003-verify-jumpsub-destination-validation\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-03T08:50:23Z", "type": "commit"}]}