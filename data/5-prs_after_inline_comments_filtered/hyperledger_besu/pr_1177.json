{"pr_number": 1177, "pr_title": "feat: add peer to PeerTable on admin_addPeer", "pr_createdAt": "2020-06-30T18:46:06Z", "pr_url": "https://github.com/hyperledger/besu/pull/1177", "timeline": [{"oid": "b223c0ab13b7dd10ee0c683cd67e72d4229f6b82", "url": "https://github.com/hyperledger/besu/commit/b223c0ab13b7dd10ee0c683cd67e72d4229f6b82", "message": "feat:\nhandle peerAdded on admin_addPeer to add the peer to the PeerTable\nhandle peerRemoved on admin_removePeer to remove the peer from the PeerTable\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-06-30T18:42:27Z", "type": "commit"}, {"oid": "ee860171efe24fd5f100db7a11da4ebabb5d1c63", "url": "https://github.com/hyperledger/besu/commit/ee860171efe24fd5f100db7a11da4ebabb5d1c63", "message": "Merge branch 'master' into feature/560-addpeer-to-peer-table", "committedDate": "2020-07-01T14:45:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQyNjA5OA==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r448426098", "bodyText": "This feels too convoluted and inverted.  Passing just the subscribe methods does not keep the type from needing to be known by the classes doing the subscriptions. It also impairs readability so I have no idea what object I am ultimately subscribing to.  I think it would be cleaner to pass the maintainedPeers instance as part of the constructor chain instead of two curried methods and then in the PeerDiscoveryController method call\n    maintainedPeers.subscribeAdd(this::onPeerAdded);\n    maintainedPeers.subscribeRemove(this::onPeerRemoved);\n\nIf we want the discovery controller to be removable and re-installable we could then track the subscription IDs and then also keep a reference to the maintainedPeers object for un-installation.", "author": "shemnon", "createdAt": "2020-07-01T15:01:23Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java", "diffHunk": "@@ -443,7 +443,14 @@ private void validate() {\n     private PeerDiscoveryAgent createDiscoveryAgent() {\n \n       return new VertxPeerDiscoveryAgent(\n-          vertx, nodeKey, config.getDiscovery(), peerPermissions, natService, metricsSystem);\n+          vertx,\n+          nodeKey,\n+          config.getDiscovery(),\n+          peerPermissions,\n+          natService,\n+          metricsSystem,\n+          maintainedPeers::subscribeAdd,", "originalCommit": "ee860171efe24fd5f100db7a11da4ebabb5d1c63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ5NTY1MQ==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r448495651", "bodyText": "Hi @shemnon, thank you for your review. Unfortunately I won't have enough time to fix this before leaving on holidays so I'll get back into it when as soon as I can.", "author": "br0tchain", "createdAt": "2020-07-01T16:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQyNjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExMDYwNg==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r464110606", "bodyText": "Hi @shemnon, I've fixed this as you suggested, it's more readable this way :)", "author": "br0tchain", "createdAt": "2020-08-02T18:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQyNjA5OA=="}], "type": "inlineReview"}, {"oid": "38dab7f48593e96bac260f1d81e7b3e5e58bbf3b", "url": "https://github.com/hyperledger/besu/commit/38dab7f48593e96bac260f1d81e7b3e5e58bbf3b", "message": "Merge branch 'master' into feature/560-addpeer-to-peer-table", "committedDate": "2020-08-02T15:07:22Z", "type": "commit"}, {"oid": "d8513aafbdd000ea1d6dec4dd102904310cc87af", "url": "https://github.com/hyperledger/besu/commit/d8513aafbdd000ea1d6dec4dd102904310cc87af", "message": "style: add comment to explain added lines\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T17:48:47Z", "type": "forcePushed"}, {"oid": "96319740cf0565bb2ab97d57d2e5026148865d60", "url": "https://github.com/hyperledger/besu/commit/96319740cf0565bb2ab97d57d2e5026148865d60", "message": "style: add comment to explain added lines\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T18:03:03Z", "type": "forcePushed"}, {"oid": "68bc7facfde4631dfe4e89b6085f0b750a94696e", "url": "https://github.com/hyperledger/besu/commit/68bc7facfde4631dfe4e89b6085f0b750a94696e", "message": "feat: update peerDiscoveryController to improve readability for peer subscription\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T18:04:48Z", "type": "commit"}, {"oid": "08444d8acf901753f16a295df50845da10803507", "url": "https://github.com/hyperledger/besu/commit/08444d8acf901753f16a295df50845da10803507", "message": "style: add comment to explain added lines\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T18:04:54Z", "type": "commit"}, {"oid": "08444d8acf901753f16a295df50845da10803507", "url": "https://github.com/hyperledger/besu/commit/08444d8acf901753f16a295df50845da10803507", "message": "style: add comment to explain added lines\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T18:04:54Z", "type": "forcePushed"}, {"oid": "9f215c9b2a5d320e55cbaf8506cea33cbca19de6", "url": "https://github.com/hyperledger/besu/commit/9f215c9b2a5d320e55cbaf8506cea33cbca19de6", "message": "test: fix unit test with new constructor\n\nSigned-off-by: Alexandre PARIS-VERGNE <alexpv14@gmail.com>", "committedDate": "2020-08-02T18:16:36Z", "type": "commit"}, {"oid": "28a992842de4f0e200d9982f60283f359048b87c", "url": "https://github.com/hyperledger/besu/commit/28a992842de4f0e200d9982f60283f359048b87c", "message": "Merge branch 'master' into feature/560-addpeer-to-peer-table", "committedDate": "2020-08-05T04:42:58Z", "type": "commit"}, {"oid": "e905a3e04fcb62a2aad9be30127945bfd0d1b4e1", "url": "https://github.com/hyperledger/besu/commit/e905a3e04fcb62a2aad9be30127945bfd0d1b4e1", "message": "Merge branch 'master' into feature/560-addpeer-to-peer-table", "committedDate": "2020-08-05T07:30:32Z", "type": "commit"}, {"oid": "7fa4f028fac1d257b19c84772ba0ea195b7fa124", "url": "https://github.com/hyperledger/besu/commit/7fa4f028fac1d257b19c84772ba0ea195b7fa124", "message": "Merge branch 'master' into feature/560-addpeer-to-peer-table", "committedDate": "2020-08-05T16:09:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0ODUwOA==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r466048508", "bodyText": "This doesn't look right.  As we discussed in the issue, we should bond to the peer rather than just adding them to our peer table and immediately advertising the node to the network.", "author": "mbaxter", "createdAt": "2020-08-05T22:56:03Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -195,6 +201,18 @@ private PeerDiscoveryController(\n             \"type\");\n   }\n \n+  private void onPeerAdded(final Peer peer, final boolean wasAdded) {\n+    if (wasAdded) {\n+      addToPeerTable(DiscoveryPeer.fromEnode(peer.getEnodeURL()));", "originalCommit": "7fa4f028fac1d257b19c84772ba0ea195b7fa124", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MzYyNA==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r466063624", "bodyText": "Added a follow-up ticket to address since this is already merged: #1278", "author": "mbaxter", "createdAt": "2020-08-05T23:42:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0ODUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0ODkxNg==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r466048916", "bodyText": "A simpler way of implementing this would be to call the publicly exposed method PeerDiscoveryAgent.bond() from P2PNetwork.addMaintainConnection.", "author": "mbaxter", "createdAt": "2020-08-05T22:57:04Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "diffHunk": "@@ -81,13 +82,15 @@\n   /* Is discovery enabled? */\n   private boolean isActive = false;\n   protected final Subscribers<PeerBondedObserver> peerBondedObservers = Subscribers.create();\n+  private final MaintainedPeers maintainedPeers;", "originalCommit": "7fa4f028fac1d257b19c84772ba0ea195b7fa124", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA0OTI2MQ==", "url": "https://github.com/hyperledger/besu/pull/1177#discussion_r466049261", "bodyText": "Do we need this logic?  Honestly not sure if we do or not, but it's a little unexpected at first glance.", "author": "mbaxter", "createdAt": "2020-08-05T22:58:07Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -195,6 +201,18 @@ private PeerDiscoveryController(\n             \"type\");\n   }\n \n+  private void onPeerAdded(final Peer peer, final boolean wasAdded) {\n+    if (wasAdded) {\n+      addToPeerTable(DiscoveryPeer.fromEnode(peer.getEnodeURL()));\n+    }\n+  }\n+\n+  private void onPeerRemoved(final Peer peer, final boolean wasRemoved) {\n+    if (wasRemoved) {\n+      peerTable.tryEvict(peer);", "originalCommit": "7fa4f028fac1d257b19c84772ba0ea195b7fa124", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}