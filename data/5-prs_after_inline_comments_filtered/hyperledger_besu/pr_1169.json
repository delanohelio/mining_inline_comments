{"pr_number": 1169, "pr_title": "Copy Subscribers to Prevent Unwanted Recursion", "pr_createdAt": "2020-06-29T21:07:54Z", "pr_url": "https://github.com/hyperledger/besu/pull/1169", "timeline": [{"oid": "fcb58cddeca556a4ba315a20c9670538661b6920", "url": "https://github.com/hyperledger/besu/commit/fcb58cddeca556a4ba315a20c9670538661b6920", "message": "copy subscribers to prevent recursion\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-06-29T20:57:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDExNw==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447280117", "bodyText": "So this is the main change?  the rest are all style adjustments?", "author": "shemnon", "createdAt": "2020-06-29T22:03:36Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/SyncTargetManager.java", "diffHunk": "@@ -113,7 +113,7 @@ protected SyncTargetManager(\n   protected abstract CompletableFuture<Optional<EthPeer>> selectBestAvailableSyncTarget();\n \n   private CompletableFuture<SyncTarget> waitForPeerAndThenSetSyncTarget() {\n-    return waitForNewPeer().handle((r, t) -> r).thenCompose((r) -> selectNewSyncTarget());", "originalCommit": "fcb58cddeca556a4ba315a20c9670538661b6920", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDk2Ng==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447280966", "bodyText": "Actually, this is the main change.  Can we move all style changes to a separate PR since they masked where the real change was?", "author": "shemnon", "createdAt": "2020-06-29T22:05:21Z", "path": "util/src/main/java/org/hyperledger/besu/util/Subscribers.java", "diffHunk": "@@ -101,17 +102,19 @@ public boolean unsubscribe(final long subscriberId) {\n    * @param action the action to perform for each subscriber\n    */\n   public void forEach(final Consumer<T> action) {\n-    subscribers\n-        .values()\n+    ImmutableSet.copyOf(\n+            // we copy here to ensure that our callback, which may add another subscriber on this", "originalCommit": "fcb58cddeca556a4ba315a20c9670538661b6920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1OTc5OQ==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r450359799", "bodyText": "removed all the other changes", "author": "RatanRSur", "createdAt": "2020-07-06T17:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5MjQ5Mw==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447292493", "bodyText": "changing this from throwable to exception seems important - i.e. prior to this change, throwables would be eaten by the \"suppress\" - now they will always be raised (which maybe the intent, but wanted to confirm).", "author": "rain-on", "createdAt": "2020-06-29T22:23:37Z", "path": "util/src/main/java/org/hyperledger/besu/util/Subscribers.java", "diffHunk": "@@ -101,17 +102,19 @@ public boolean unsubscribe(final long subscriberId) {\n    * @param action the action to perform for each subscriber\n    */\n   public void forEach(final Consumer<T> action) {\n-    subscribers\n-        .values()\n+    ImmutableSet.copyOf(\n+            // we copy here to ensure that our callback, which may add another subscriber on this\n+            // event, won't trigger that new additional subscriber\n+            subscribers.values())\n         .forEach(\n             subscriber -> {\n               try {\n                 action.accept(subscriber);\n-              } catch (Throwable throwable) {\n+              } catch (Exception e) {", "originalCommit": "fcb58cddeca556a4ba315a20c9670538661b6920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MjQ4MA==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r448072480", "bodyText": "The only relevant throwable suppressed are Errors, which generally speaking are non-recoverable (OutOfMemoryError, ThreadDeath, LinkageError, etc.).  When those happen the VM is going down hard.", "author": "shemnon", "createdAt": "2020-07-01T01:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5MjQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1NjcxMQ==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r450356711", "bodyText": "@rain-on Are you alright with leaving it as is?", "author": "RatanRSur", "createdAt": "2020-07-06T16:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5MjQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4Mjk5OA==", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r451182998", "bodyText": "\ud83d\udc4d  all good.", "author": "rain-on", "createdAt": "2020-07-07T22:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5MjQ5Mw=="}], "type": "inlineReview"}, {"oid": "9a1408cf4dcb7df6536cf55d0b92b28a6615c56c", "url": "https://github.com/hyperledger/besu/commit/9a1408cf4dcb7df6536cf55d0b92b28a6615c56c", "message": "remove style changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-06T16:57:00Z", "type": "commit"}, {"oid": "67f7a3fad2f75927e1575d7a3187a20ac6a280d6", "url": "https://github.com/hyperledger/besu/commit/67f7a3fad2f75927e1575d7a3187a20ac6a280d6", "message": "Merge remote-tracking branch 'upstream' into wait-for-peer", "committedDate": "2020-07-06T16:57:25Z", "type": "commit"}, {"oid": "6ed9f7fa367ba4a85b6c6ff8e5e262c82265bd5f", "url": "https://github.com/hyperledger/besu/commit/6ed9f7fa367ba4a85b6c6ff8e5e262c82265bd5f", "message": "Merge branch 'master' into wait-for-peer", "committedDate": "2020-07-08T15:19:35Z", "type": "commit"}]}