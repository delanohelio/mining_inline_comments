{"pr_number": 1590, "pr_title": "Refactored genesis config fork logic.", "pr_createdAt": "2020-11-19T04:22:47Z", "pr_url": "https://github.com/hyperledger/besu/pull/1590", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NDYwOQ==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r527174609", "bodyText": "is this meant to be duplicated?", "author": "macfarla", "createdAt": "2020-11-19T20:23:37Z", "path": "config/src/main/java/org/hyperledger/besu/config/JsonGenesisConfigOptions.java", "diffHunk": "@@ -419,4 +422,36 @@ private OptionalInt getOptionalInt(final String key) {\n       return JsonUtil.getBoolean(configRoot, key);\n     }\n   }\n+\n+  @Override\n+  public List<Long> getForks() {\n+    Stream<OptionalLong> forkBlockNumbers =\n+        Stream.of(\n+            getHomesteadBlockNumber(),\n+            getDaoForkBlock(),\n+            getTangerineWhistleBlockNumber(),\n+            // duplicated for EIP155 and EIP158 handling\n+            getSpuriousDragonBlockNumber(),\n+            getSpuriousDragonBlockNumber(),", "originalCommit": "a0554a530a3302528c431cd92ca1628b319bab24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5NTU2OA==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r528795568", "bodyText": "It shouldn't be duplicated.  Even if it is two separate EIPs it will be the same block number, and ForkID will de-dup it.", "author": "shemnon", "createdAt": "2020-11-23T15:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NDYwOQ=="}], "type": "inlineReview"}, {"oid": "d2b32540d59dc6b8e1b862f7dd2fb124133973a5", "url": "https://github.com/hyperledger/besu/commit/d2b32540d59dc6b8e1b862f7dd2fb124133973a5", "message": "Refactored genesis config fork logic.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T23:18:22Z", "type": "commit"}, {"oid": "d2c30176cc7209facd6102e1e7e978faeb9aa0a3", "url": "https://github.com/hyperledger/besu/commit/d2c30176cc7209facd6102e1e7e978faeb9aa0a3", "message": "Progress commit - added test.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T23:18:22Z", "type": "commit"}, {"oid": "ffdcb4cac1957891e8386d592a5bba91c59b3d42", "url": "https://github.com/hyperledger/besu/commit/ffdcb4cac1957891e8386d592a5bba91c59b3d42", "message": "Progress commit - slight refactor.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T23:18:22Z", "type": "commit"}, {"oid": "512dba0b98a0bef28823a49b1da5a0c0751b8799", "url": "https://github.com/hyperledger/besu/commit/512dba0b98a0bef28823a49b1da5a0c0751b8799", "message": "Added tests.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-03T01:26:24Z", "type": "commit"}, {"oid": "512dba0b98a0bef28823a49b1da5a0c0751b8799", "url": "https://github.com/hyperledger/besu/commit/512dba0b98a0bef28823a49b1da5a0c0751b8799", "message": "Added tests.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-03T01:26:24Z", "type": "forcePushed"}, {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "url": "https://github.com/hyperledger/besu/commit/09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "message": "Merge branch 'master' into 1532", "committedDate": "2020-12-03T01:31:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3Njg4Nw==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534676887", "bodyText": "so duplicates weren't removed before? Or did it happen after this point?", "author": "macfarla", "createdAt": "2020-12-03T05:23:13Z", "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);", "originalCommit": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwNjYwNA==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r535206604", "bodyText": "It happens later at ForkIdManager.java:58\nThese tests were expecting a duplicate value for eip155Block and eip158Block (see JsonGenesisConfigOptions.java:334), which the new logic doesn't do.", "author": "mark-terry", "createdAt": "2020-12-03T12:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3Njg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYxMDY0NA==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r535610644", "bodyText": "We need to make sure this doesn't interfere with the legacy forkid issue with Besu 1.4 - @abdelhamidbakhta", "author": "shemnon", "createdAt": "2020-12-03T21:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3Njg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODI5NA==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678294", "bodyText": "Need to add back in the assertion that the result is the same as that generated from the config with no unexpected fork values", "author": "macfarla", "createdAt": "2020-12-03T05:26:48Z", "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_etc_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final ObjectNode configNodeWithUnexpectedForks =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_unexpected_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final GenesisConfigFile config = fromConfig(configNode);\n+    final GenesisConfigFile configWithUnexpectedForks = fromConfig(configNodeWithUnexpectedForks);\n+\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);", "originalCommit": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4OTExNw==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r535189117", "bodyText": "Are you suggesting the assertion on line 394?", "author": "mark-terry", "createdAt": "2020-12-03T12:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0OTk0MQ==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r535749941", "bodyText": "Yes it is there.", "author": "macfarla", "createdAt": "2020-12-04T00:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODQ0OQ==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678449", "bodyText": "I think some renaming would make things clearer", "author": "macfarla", "createdAt": "2020-12-03T05:27:18Z", "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =", "originalCommit": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODY3Ng==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678676", "bodyText": "configWithNoUnexpectedForkBlocks\nconfigWithUnexpectedClassicForkBlock\nconfigWithMultipleUnexpectedForkBlocks", "author": "macfarla", "createdAt": "2020-12-03T05:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3OTUxNg==", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534679516", "bodyText": "classicForkBlock doesn't get special treatment any more, but maybe it's still worth checking single vs multiple unexpected forks?", "author": "macfarla", "createdAt": "2020-12-03T05:30:21Z", "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_etc_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final ObjectNode configNodeWithUnexpectedForks =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_unexpected_forks.json\"),", "originalCommit": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9bd5bffc0a0e4f33ec429e492f8cd6cefdee218b", "url": "https://github.com/hyperledger/besu/commit/9bd5bffc0a0e4f33ec429e492f8cd6cefdee218b", "message": "Merge branch 'master' into 1532", "committedDate": "2020-12-03T12:59:54Z", "type": "commit"}, {"oid": "25f0b9d06319a8dc129b72846887d814c9abeeca", "url": "https://github.com/hyperledger/besu/commit/25f0b9d06319a8dc129b72846887d814c9abeeca", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-03T13:05:03Z", "type": "commit"}, {"oid": "84a5c96f7100688720419234e33a560a08768926", "url": "https://github.com/hyperledger/besu/commit/84a5c96f7100688720419234e33a560a08768926", "message": "Merge branch '1532' of github.com:mark-terry/besu into 1532", "committedDate": "2020-12-03T13:05:17Z", "type": "commit"}, {"oid": "f771e207a7c75075a30a339c1d67acb08c8661ac", "url": "https://github.com/hyperledger/besu/commit/f771e207a7c75075a30a339c1d67acb08c8661ac", "message": "Merge branch 'master' into 1532", "committedDate": "2020-12-07T02:51:55Z", "type": "commit"}, {"oid": "db1143be65035681fd48f4a6c0cfba3cbf1426ea", "url": "https://github.com/hyperledger/besu/commit/db1143be65035681fd48f4a6c0cfba3cbf1426ea", "message": "Merge branch 'master' into 1532", "committedDate": "2020-12-07T22:29:16Z", "type": "commit"}]}