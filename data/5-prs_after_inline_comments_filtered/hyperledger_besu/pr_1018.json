{"pr_number": 1018, "pr_title": "Reintroduce consortium network friendly EIP-2124 fork id management.", "pr_createdAt": "2020-06-02T10:02:51Z", "pr_url": "https://github.com/hyperledger/besu/pull/1018", "timeline": [{"oid": "08f34a81eff203868757e5c5eebeada8da466e40", "url": "https://github.com/hyperledger/besu/commit/08f34a81eff203868757e5c5eebeada8da466e40", "message": "Handle backward compatible fork id.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T08:45:29Z", "type": "commit"}, {"oid": "ff72b54e5f3755391489988da48478569617c196", "url": "https://github.com/hyperledger/besu/commit/ff72b54e5f3755391489988da48478569617c196", "message": "Build fork id list no matter the network.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T09:56:13Z", "type": "commit"}, {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6", "url": "https://github.com/hyperledger/besu/commit/a83f2c43c3245290fbc0365560e06f74b50f16e6", "message": "Merge remote-tracking branch 'upstream/master' into 1002\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T11:12:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzMzc2OQ==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433933769", "bodyText": "asserts do nothing unless explicitly enabled at runtime, and we never do that.  Perhaps you meant Preconditions.checkNotNull? (com.google.common.base.Preconditions)", "author": "shemnon", "createdAt": "2020-06-02T14:46:24Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -30,22 +34,59 @@\n \n public class ForkIdManager {\n \n-  private final Blockchain blockchain;\n   private final Hash genesisHash;\n-  private final List<Long> forks;\n-  private long forkNext;\n-  private final long highestKnownFork;\n-  private List<ForkId> forkAndHashList;\n+  private final List<ForkId> forkAndHashList;\n+\n+  private final List<ForkIDChecker> forkIDCheckers;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n-    this.blockchain = blockchain;\n+    assert blockchain != null && forks != null;", "originalCommit": "a83f2c43c3245290fbc0365560e06f74b50f16e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDU2NA==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433974564", "bodyText": "I have a unit test verifying this specific assertion error and it passes. I thought it was enabled by default on recent Java versions.\nI will change with Preconditions.checkNotNull then", "author": "abdelhamidbakhta", "createdAt": "2020-06-02T15:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzMzc2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MDE4Mg==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433980182", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-06-02T15:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzMzc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDc0Ng==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433970746", "bodyText": "What happens if we have a few 0 forks but others greater than 0? Would we do the right thing?", "author": "RatanRSur", "createdAt": "2020-06-02T15:37:12Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -30,22 +34,59 @@\n \n public class ForkIdManager {\n \n-  private final Blockchain blockchain;\n   private final Hash genesisHash;\n-  private final List<Long> forks;\n-  private long forkNext;\n-  private final long highestKnownFork;\n-  private List<ForkId> forkAndHashList;\n+  private final List<ForkId> forkAndHashList;\n+\n+  private final List<ForkIDChecker> forkIDCheckers;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n-    this.blockchain = blockchain;\n+    assert blockchain != null && forks != null;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n-    // de-dupe and sanitize forks\n-    this.forks =\n-        forks.stream().filter(fork -> fork > 0).distinct().collect(Collectors.toUnmodifiableList());\n-    highestKnownFork = forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;\n-    createForkIds();\n-  };\n+    this.forkAndHashList = new ArrayList<>();\n+    final ForkIDChecker legacyForkIdChecker =\n+        createForkIDChecker(\n+            blockchain,\n+            genesisHash,\n+            forks,\n+            fs ->\n+                fs.stream()\n+                    .filter(fork -> fork > 0)\n+                    .distinct()\n+                    .collect(Collectors.toUnmodifiableList()),\n+            forkAndHashList);\n+    // if the fork list contains only zeros then we may be in a consortium/dev network\n+    if (onlyZerosForkBlocks(forks)) {", "originalCommit": "a83f2c43c3245290fbc0365560e06f74b50f16e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MjIwOA==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433972208", "bodyText": "Yes we would to the right thing. This is what happens on Goerli:\n{\n  \"config\":{\n    \"chainId\":5,\n    \"homesteadBlock\":0,\n    \"eip150Block\":0,\n    \"eip150Hash\": \"0xbf7e331f7f7c1dd2e05159666b3bf8bc7a8a3a9eb1d518969eab529dd9b88c1a\",\n    \"eip155Block\":0,\n    \"eip158Block\":0,\n    \"eip160Block\":0,\n    \"byzantiumBlock\":0,\n    \"constantinopleBlock\":0,\n    \"petersburgBlock\":0,\n    \"istanbulBlock\":1561651,\n    \"clique\":{\n      \"blockperiodseconds\":15,\n      \"epochlength\":30000\n    }\n  }", "author": "abdelhamidbakhta", "createdAt": "2020-06-02T15:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDc0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwNDA5OQ==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r434004099", "bodyText": "Unit tests and the EIP2124 spec also validate that the correct hashes are arrived at.", "author": "shemnon", "createdAt": "2020-06-02T16:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDc0Ng=="}], "type": "inlineReview"}, {"oid": "fb667c6a6217c2a78a2dc7a538e3abd7c5460071", "url": "https://github.com/hyperledger/besu/commit/fb667c6a6217c2a78a2dc7a538e3abd7c5460071", "message": "Merge remote-tracking branch 'upstream/master' into 1002\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T15:42:43Z", "type": "commit"}, {"oid": "4e1bb7c6dc1a2efc8913077a28d04f494cb114b1", "url": "https://github.com/hyperledger/besu/commit/4e1bb7c6dc1a2efc8913077a28d04f494cb114b1", "message": "Do not use assert\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T15:47:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MDQyMw==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433980423", "bodyText": "I suggest we put implements Predicate<ForkId> here so that we can get all the other Predicate methods for free", "author": "RatanRSur", "createdAt": "2020-06-02T15:47:59Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -257,4 +316,9 @@ private static void intToBigEndian(final int n, final byte[] bs, int off) {\n     bs[++off] = (byte) (n >>> 8);\n     bs[++off] = (byte) (n);\n   }\n+\n+  @FunctionalInterface\n+  private interface ForkIDChecker {", "originalCommit": "4e1bb7c6dc1a2efc8913077a28d04f494cb114b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NTk4Ng==", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433985986", "bodyText": "Nice catch. Done", "author": "abdelhamidbakhta", "createdAt": "2020-06-02T15:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MDQyMw=="}], "type": "inlineReview"}, {"oid": "32db91fdf060689bb42783f0fc289f74c0cdf057", "url": "https://github.com/hyperledger/besu/commit/32db91fdf060689bb42783f0fc289f74c0cdf057", "message": "Move to Predicate\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-06-02T15:53:45Z", "type": "commit"}, {"oid": "95ae44d520fac6d93693a6f6a99c3268a8f9dc8b", "url": "https://github.com/hyperledger/besu/commit/95ae44d520fac6d93693a6f6a99c3268a8f9dc8b", "message": "Merge branch 'master' into 1002", "committedDate": "2020-06-02T16:48:13Z", "type": "commit"}]}