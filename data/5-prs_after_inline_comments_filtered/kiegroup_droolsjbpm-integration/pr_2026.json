{"pr_number": 2026, "pr_title": "[JBPM-8936] ConcurrentModificationException when retrieving server template", "pr_createdAt": "2020-02-21T08:03:13Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026", "timeline": [{"oid": "1652864eeb58615a108fb7df77f5e2b4fc2cb441", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/1652864eeb58615a108fb7df77f5e2b4fc2cb441", "message": "[JBPM-8936] ConcurrentModificationException when retrieving server template\n\ndifferent instances of the server template through the storage.", "committedDate": "2020-02-21T15:10:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ2ODE3OQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026#discussion_r384468179", "bodyText": "Please change the line 38 to also use EnumMap<> for consistency.", "author": "MarianMacik", "createdAt": "2020-02-26T12:44:27Z", "path": "kie-server-parent/kie-server-controller/kie-server-controller-api/src/main/java/org/kie/server/controller/api/model/spec/ContainerSpec.java", "diffHunk": "@@ -44,6 +46,13 @@ public ReleaseId getReleasedId() {\n     public ContainerSpec() {\n     }\n \n+    public ContainerSpec(ContainerSpec other) {\n+        super(other.getId(), other.getContainerName(), other.getServerTemplateKey());\n+        this.releasedId = other.releasedId;\n+        this.status = other.status;\n+        this.configs = other.getConfigs().isEmpty() ? Collections.emptyMap() : new EnumMap<>(other.getConfigs());", "originalCommit": "1652864eeb58615a108fb7df77f5e2b4fc2cb441", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQyNTEwNw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026#discussion_r386425107", "bodyText": "Still uses HashMap.", "author": "MarianMacik", "createdAt": "2020-03-02T14:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ2ODE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ3MDkxNw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026#discussion_r384470917", "bodyText": "I guess we no longer need store to be of ConcurrentHashMap implementation if we are fully locking it.", "author": "MarianMacik", "createdAt": "2020-02-26T12:50:20Z", "path": "kie-server-parent/kie-server-controller/kie-server-controller-impl/src/main/java/org/kie/server/controller/impl/storage/InMemoryKieServerTemplateStorage.java", "diffHunk": "@@ -54,17 +58,44 @@ public ServerTemplate store(ServerTemplate serverTemplate) {\n \n     @Override\n     public List<ServerTemplate> load() {\n-        return new ArrayList<ServerTemplate>(store.values());\n+        synchronized (store) {", "originalCommit": "1652864eeb58615a108fb7df77f5e2b4fc2cb441", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04d1844292707992361d2a8abf8366da35cb4694", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/04d1844292707992361d2a8abf8366da35cb4694", "message": "[JBPM-8936] ConcurrentModificationException when retrieving server template\n\ndifferent instances of the server template through the storage.", "committedDate": "2020-03-02T08:05:43Z", "type": "forcePushed"}, {"oid": "9050596a307696077124885ea00a264293e804a9", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/9050596a307696077124885ea00a264293e804a9", "message": "[JBPM-8936] ConcurrentModificationException when retrieving server template\n\ndifferent instances of the server template through the storage.", "committedDate": "2020-03-04T08:58:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MDkyOA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026#discussion_r389540928", "bodyText": "Here we store the EnumMap instance but in the original state of an object there is an instance of HashMap created. \n  \n    \n      droolsjbpm-integration/kie-server-parent/kie-server-controller/kie-server-controller-api/src/main/java/org/kie/server/controller/api/model/spec/ServerTemplate.java\n    \n    \n         Line 40\n      in\n      1b42ad1\n    \n    \n    \n    \n\n        \n          \n           private Map<Capability, ServerConfig> configs = new HashMap<Capability, ServerConfig>();", "author": "MarianMacik", "createdAt": "2020-03-09T09:23:18Z", "path": "kie-server-parent/kie-server-controller/kie-server-controller-impl/src/main/java/org/kie/server/controller/impl/storage/InMemoryKieServerTemplateStorage.java", "diffHunk": "@@ -54,17 +60,44 @@ public ServerTemplate store(ServerTemplate serverTemplate) {\n \n     @Override\n     public List<ServerTemplate> load() {\n-        return new ArrayList<ServerTemplate>(store.values());\n+        synchronized (store) {\n+            return store.values().stream().map(this::cloneServerTemplate).collect(Collectors.toList());\n+        }\n     }\n \n     @Override\n     public ServerTemplate load(String identifier) {\n-        return store.get(identifier);\n+        synchronized (store) {\n+            return cloneServerTemplate(store.get(identifier));\n+        }\n     }\n \n     @Override\n     public boolean exists(String identifier) {\n-        return store.containsKey(identifier);\n+        synchronized (store) {\n+            return store.containsKey(identifier);\n+        }\n+    }\n+\n+    private ServerTemplate cloneServerTemplate(ServerTemplate current) {\n+\n+        if (current == null) {\n+            return null;\n+        }\n+\n+        List<ContainerSpec> specs = current.getContainersSpec().stream().map(ContainerSpec::new).collect(Collectors.toList());\n+\n+        ServerTemplate serverTemplate = new ServerTemplate(current.getId(),\n+                                                           current.getName(),\n+                                                           new ArrayList<>(current.getCapabilities()),\n+                                                           current.getConfigs().isEmpty() ? new EnumMap<>(Capability.class) : new EnumMap<>(current.getConfigs()),", "originalCommit": "9050596a307696077124885ea00a264293e804a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MTY5MA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2026#discussion_r389541690", "bodyText": "Here we use EnumMap but the initializer is set to HashMap, see:\n\n  \n    \n      droolsjbpm-integration/kie-server-parent/kie-server-controller/kie-server-controller-api/src/main/java/org/kie/server/controller/api/model/spec/ContainerSpec.java\n    \n    \n         Line 36\n      in\n      1b42ad1\n    \n    \n    \n    \n\n        \n          \n           private Map<Capability, ContainerConfig> configs = new HashMap<>();", "author": "MarianMacik", "createdAt": "2020-03-09T09:24:42Z", "path": "kie-server-parent/kie-server-controller/kie-server-controller-api/src/main/java/org/kie/server/controller/api/model/spec/ContainerSpec.java", "diffHunk": "@@ -44,6 +45,13 @@ public ReleaseId getReleasedId() {\n     public ContainerSpec() {\n     }\n \n+    public ContainerSpec(ContainerSpec other) {\n+        super(other.getId(), other.getContainerName(), other.getServerTemplateKey());\n+        this.releasedId = other.releasedId;\n+        this.status = other.status;\n+        this.configs = other.getConfigs().isEmpty() ? new EnumMap<Capability, ContainerConfig>(Capability.class) : new EnumMap<>(other.getConfigs());", "originalCommit": "9050596a307696077124885ea00a264293e804a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "32af161bc8888e4ad6d6f8de00d1d3e05c8455b2", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/32af161bc8888e4ad6d6f8de00d1d3e05c8455b2", "message": "[JBPM-8936] ConcurrentModificationException when retrieving server template\n\ndifferent instances of the server template through the storage.", "committedDate": "2020-03-10T08:16:28Z", "type": "commit"}, {"oid": "32af161bc8888e4ad6d6f8de00d1d3e05c8455b2", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/32af161bc8888e4ad6d6f8de00d1d3e05c8455b2", "message": "[JBPM-8936] ConcurrentModificationException when retrieving server template\n\ndifferent instances of the server template through the storage.", "committedDate": "2020-03-10T08:16:28Z", "type": "forcePushed"}]}