{"pr_number": 2060, "pr_title": "[Drools-5228] Fix a wrong refactoring", "pr_createdAt": "2020-04-08T08:19:08Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060", "timeline": [{"oid": "47bc0632eeff3585c9d961e081b85f5124bda24a", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/47bc0632eeff3585c9d961e081b85f5124bda24a", "message": "revert a refactoring", "committedDate": "2020-04-08T08:17:45Z", "type": "commit"}, {"oid": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "message": "Start tests", "committedDate": "2020-04-08T11:25:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2MjYxNQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405462615", "bodyText": "I think we should reuse an existing instance (constructor parameter?)", "author": "danielezonca", "createdAt": "2020-04-08T11:46:55Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -93,13 +95,28 @@ public DefaultKafkaConsumer(EnvConfig config, Producer producer) {\n         }\n         this.producer = producer;\n         this.consumerUtilsCore = new ConsumerUtilsCoreImpl();\n+        this.snapshotOnDemandUtils = new SnapshotOnDemandUtilsImpl();", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2NzI4Ng==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405467286", "bodyText": "Reformat code", "author": "danielezonca", "createdAt": "2020-04-08T11:55:27Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -130,28 +147,43 @@ public void stop() {\n     }\n \n     @Override\n-    public void updateStatus(State state) {\n+    public InfraCallbackStatus updateStatus(State state) {\n+        State previousState = currentState;\n         boolean changedState = !state.equals(currentState);\n+        boolean completedSnapshotOnDemand = false;\n+        boolean updateOnRunningConsumer = false;\n+        boolean enableConsumerAndStartLoop = false;\n         if (currentState == null || changedState) {\n             currentState = state;\n         }\n         if (started && changedState && !currentState.equals(State.BECOMING_LEADER)) {\n+            updateOnRunningConsumer = true;\n             updateOnRunningConsumer(state);\n-        } else if (!started && state.equals(State.REPLICA) && !envConfig.isSkipOnDemandSnapshot() && !askedSnapshotOnDemand) {\n-            boolean completed = askAndProcessSnapshotOnDemand(SnapshotOnDemandUtilsImpl.askASnapshotOnDemand(envConfig, snapShooter, producer));\n-            if (logger.isInfoEnabled()) {\n-                logger.info(\"askAndProcessSnapshotOnDemand completed:{}\", completed);\n+        } else if(!started) {\n+            if (state.equals(State.REPLICA) && !envConfig.isSkipOnDemandSnapshot() && !askedSnapshotOnDemand) {\n+                    //ask and wait a snapshot before start\n+                    if (logger.isInfoEnabled()) {\n+                        logger.info(\"askAndProcessSnapshotOnDemand:\");\n+                    }\n+                completedSnapshotOnDemand = askAndProcessSnapshotOnDemand(snapshotOnDemandUtils.askASnapshotOnDemand(envConfig, snapShooter, producer));\n+                    if (logger.isInfoEnabled()) {\n+                        logger.info(\"askAndProcessSnapshotOnDemand completed:{}\", completedSnapshotOnDemand);\n+                    }", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2ODI5NA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405468294", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-04-08T11:57:23Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -286,7 +318,9 @@ protected void enableConsumeAndStartLoop(State state) {\n             DroolsExecutor.setAsLeader();\n         } else if (state.equals(State.REPLICA)) {\n             currentState = State.REPLICA;\n-            kafkaSecondaryConsumer = new KafkaConsumer<>(Config.getConsumerConfig(SECONDARY_CONSUMER));\n+            if(kafkaSecondaryConsumer == null) {\n+                kafkaSecondaryConsumer = new KafkaConsumer<>(Config.getConsumerConfig(SECONDARY_CONSUMER));\n+            }", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2ODc5OA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405468798", "bodyText": "You can create a field for this variable (and instantiate it a @Before method`)", "author": "danielezonca", "createdAt": "2020-04-08T11:58:18Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/SnapshotOnDemandUtilsTest.java", "diffHunk": "@@ -28,21 +29,23 @@\n \n     @Test(expected = org.apache.kafka.common.KafkaException.class)\n     public void askAKafkaConsumerWithoutServerUpTest(){\n+        SnapshotOnDemandUtils snapshotOnDemandUtils = new SnapshotOnDemandUtilsImpl();", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NDA2Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405474062", "bodyText": "To be removed as agreed", "author": "danielezonca", "createdAt": "2020-04-08T12:07:48Z", "path": "drools-ha/ha-core/src/main/java/org/kie/hacep/core/infra/consumer/InfraCallbackStatus.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NDIyMA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405474220", "bodyText": "Use spy(...)", "author": "danielezonca", "createdAt": "2020-04-08T12:08:09Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer consumer;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+    consumer = new DefaultKafkaConsumer(EnvConfig.getDefaultEnvConfig(), producer, primaryConsumer, secondaryConsumer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NzAxOQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405477019", "bodyText": "Change to\nverify(consumer, never()).enableConsumeAndStartLoop(any());\nor\nverify(consumer, times(1)).enableConsumeAndStartLoop(eq(State.BECOMING_LEADER));\nbased on the logic you want to test", "author": "danielezonca", "createdAt": "2020-04-08T12:13:01Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.junit.Assert.*;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer consumer;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+    consumer = new DefaultKafkaConsumer(EnvConfig.getDefaultEnvConfig(), producer, primaryConsumer, secondaryConsumer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);\n+  }\n+\n+  @Test\n+  public void UpdateStatusBecomingLeaderAtStartupTest(){\n+    InfraCallbackStatus status = consumer.updateStatus(State.BECOMING_LEADER);\n+    assertFalse(status.isEnableConsumerAndStartLoop());// nothing happens\n+    assertFalse(status.isUpdateOnRunningConsumer());// isn't on running consumer\n+    assertFalse(status.isAskAndProcessSnapshotOnDemandResult()); // no snapshot enabled\n+    assertEquals(status.getPreviousState(), State.REPLICA); // every instance starts as a replica", "originalCommit": "a51340b0d2b84d15e0300ee26dd988f0c05e1ebf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43e8e07a70f35dc2a853ac43afe2a16023b9d36d", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/43e8e07a70f35dc2a853ac43afe2a16023b9d36d", "message": "changes requested by reviewer", "committedDate": "2020-04-08T14:04:38Z", "type": "commit"}, {"oid": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "message": "clean up", "committedDate": "2020-04-08T14:05:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1NzQ5NQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405557495", "bodyText": "You should use eq(State.LEADER) instead of the direct value", "author": "danielezonca", "createdAt": "2020-04-08T14:13:59Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer spy;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+\n+    spy = Mockito.spy(new DefaultKafkaConsumer(){\n+      @Override\n+      public void getOrCreateKafkaConsumer() {\n+        this.kafkaConsumer = primaryConsumer;\n+      }\n+\n+      @Override\n+      public void getOrCreateKafkaSecondaryConsumer() {\n+        this.kafkaSecondaryConsumer = secondaryConsumer;\n+      }\n+    });\n+    spy.setupForTest(envConfig, producer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);\n+  }\n+\n+  @Test\n+  public void updateStatusBecomingLeaderAtStartupTest(){\n+    spy.updateStatus(State.BECOMING_LEADER);\n+    verify(spy).updateStatus(State.BECOMING_LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.BECOMING_LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, never()).enableConsumeAndStartLoop(State.BECOMING_LEADER);\n+   }\n+\n+  @Test\n+  public void updateStatusLeaderAtStartupTest(){\n+    spy.updateStatus(State.LEADER);\n+    verify(spy).updateStatus(State.LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, times(1)).enableConsumeAndStartLoop(State.LEADER);", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1Nzg3Ng==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405557876", "bodyText": "Please use any(State.class) with never() to be more reliable", "author": "danielezonca", "createdAt": "2020-04-08T14:14:29Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer spy;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+\n+    spy = Mockito.spy(new DefaultKafkaConsumer(){\n+      @Override\n+      public void getOrCreateKafkaConsumer() {\n+        this.kafkaConsumer = primaryConsumer;\n+      }\n+\n+      @Override\n+      public void getOrCreateKafkaSecondaryConsumer() {\n+        this.kafkaSecondaryConsumer = secondaryConsumer;\n+      }\n+    });\n+    spy.setupForTest(envConfig, producer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);\n+  }\n+\n+  @Test\n+  public void updateStatusBecomingLeaderAtStartupTest(){\n+    spy.updateStatus(State.BECOMING_LEADER);\n+    verify(spy).updateStatus(State.BECOMING_LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.BECOMING_LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, never()).enableConsumeAndStartLoop(State.BECOMING_LEADER);\n+   }\n+\n+  @Test\n+  public void updateStatusLeaderAtStartupTest(){\n+    spy.updateStatus(State.LEADER);\n+    verify(spy).updateStatus(State.LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.LEADER);", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1ODIyMw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405558223", "bodyText": "Please use any(State.class) with never() to be more reliable", "author": "danielezonca", "createdAt": "2020-04-08T14:14:56Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer spy;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+\n+    spy = Mockito.spy(new DefaultKafkaConsumer(){\n+      @Override\n+      public void getOrCreateKafkaConsumer() {\n+        this.kafkaConsumer = primaryConsumer;\n+      }\n+\n+      @Override\n+      public void getOrCreateKafkaSecondaryConsumer() {\n+        this.kafkaSecondaryConsumer = secondaryConsumer;\n+      }\n+    });\n+    spy.setupForTest(envConfig, producer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);\n+  }\n+\n+  @Test\n+  public void updateStatusBecomingLeaderAtStartupTest(){\n+    spy.updateStatus(State.BECOMING_LEADER);\n+    verify(spy).updateStatus(State.BECOMING_LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.BECOMING_LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, never()).enableConsumeAndStartLoop(State.BECOMING_LEADER);\n+   }\n+\n+  @Test\n+  public void updateStatusLeaderAtStartupTest(){\n+    spy.updateStatus(State.LEADER);\n+    verify(spy).updateStatus(State.LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, times(1)).enableConsumeAndStartLoop(State.LEADER);\n+    verify(spy, times(1)).setLastProcessedKey();\n+    verify(spy, times(1)).assignAndStartConsume();\n+  }\n+\n+  @Test\n+  public void updateStatusReplicaAtStartupTest(){\n+    spy.updateStatus(State.REPLICA);\n+    verify(spy).updateStatus(State.REPLICA);\n+    verify(spy, never()).updateOnRunningConsumer(State.REPLICA);", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU1ODU4NA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405558584", "bodyText": "Please use eq(State.REPLICA)", "author": "danielezonca", "createdAt": "2020-04-08T14:15:28Z", "path": "drools-ha/ha-core-infra/src/test/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumerTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.hacep.core.infra.consumer;\n+\n+import java.time.LocalDateTime;\n+\n+import org.apache.kafka.clients.consumer.KafkaConsumer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.kie.hacep.EnvConfig;\n+import org.kie.hacep.consumer.DroolsConsumerHandler;\n+import org.kie.hacep.core.infra.DefaultSessionSnapShooter;\n+import org.kie.hacep.core.infra.SnapshotInfos;\n+import org.kie.hacep.core.infra.election.State;\n+import org.kie.hacep.core.infra.utils.SnapshotOnDemandUtils;\n+import org.kie.hacep.util.ConsumerUtilsCore;\n+import org.kie.remote.impl.producer.Producer;\n+import org.kie.remote.message.ControlMessage;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.verify;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class DefaultKafkaConsumerTest {\n+\n+  @Mock\n+  protected Producer producer;\n+  @Mock\n+  protected DroolsConsumerHandler handler;\n+  @Mock\n+  protected KafkaConsumer primaryConsumer;\n+  @Mock\n+  protected KafkaConsumer secondaryConsumer;\n+  @Mock\n+  protected ConsumerUtilsCore consumerUtilsCore;\n+  @Mock\n+  protected DefaultSessionSnapShooter defaultSessionSnapShooter;\n+  @Mock\n+  protected SnapshotOnDemandUtils snapshotOnDemandUtils;\n+\n+  private DefaultKafkaConsumer spy;\n+\n+  @Before\n+  public void initTest() {\n+    EnvConfig envConfig = EnvConfig.getDefaultEnvConfig();\n+    ControlMessage lastControlMessage = new ControlMessage();\n+    lastControlMessage.setId(\"1\");\n+    lastControlMessage.setOffset(1l);\n+    when(consumerUtilsCore.getLastEvent(envConfig.getControlTopicName(), envConfig.getPollTimeout())).thenReturn(lastControlMessage);\n+    when(defaultSessionSnapShooter.getLastSnapshotTime()).thenReturn(LocalDateTime.now());\n+    when(handler.initializeKieSessionFromSnapshotOnDemand(any(EnvConfig.class), any(SnapshotInfos.class))).thenReturn(Boolean.TRUE);\n+\n+    spy = Mockito.spy(new DefaultKafkaConsumer(){\n+      @Override\n+      public void getOrCreateKafkaConsumer() {\n+        this.kafkaConsumer = primaryConsumer;\n+      }\n+\n+      @Override\n+      public void getOrCreateKafkaSecondaryConsumer() {\n+        this.kafkaSecondaryConsumer = secondaryConsumer;\n+      }\n+    });\n+    spy.setupForTest(envConfig, producer, consumerUtilsCore, defaultSessionSnapShooter, snapshotOnDemandUtils, handler);\n+  }\n+\n+  @Test\n+  public void updateStatusBecomingLeaderAtStartupTest(){\n+    spy.updateStatus(State.BECOMING_LEADER);\n+    verify(spy).updateStatus(State.BECOMING_LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.BECOMING_LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, never()).enableConsumeAndStartLoop(State.BECOMING_LEADER);\n+   }\n+\n+  @Test\n+  public void updateStatusLeaderAtStartupTest(){\n+    spy.updateStatus(State.LEADER);\n+    verify(spy).updateStatus(State.LEADER);\n+    verify(spy, never()).updateOnRunningConsumer(State.LEADER);\n+    verify(spy, never()).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, times(1)).enableConsumeAndStartLoop(State.LEADER);\n+    verify(spy, times(1)).setLastProcessedKey();\n+    verify(spy, times(1)).assignAndStartConsume();\n+  }\n+\n+  @Test\n+  public void updateStatusReplicaAtStartupTest(){\n+    spy.updateStatus(State.REPLICA);\n+    verify(spy).updateStatus(State.REPLICA);\n+    verify(spy, never()).updateOnRunningConsumer(State.REPLICA);\n+    verify(spy, times(1)).askAndProcessSnapshotOnDemand(any(SnapshotInfos.class));\n+    verify(spy, times(1)).enableConsumeAndStartLoop(State.REPLICA);", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU2MDQ1OQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405560459", "bodyText": "A method like getOrCreate should:\n\nprevent multiple initialization\nreturn the value\n\nPlease rename it to initKafkaConsumer if there is no check nor value to return :)", "author": "danielezonca", "createdAt": "2020-04-08T14:17:54Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -93,28 +96,50 @@ public DefaultKafkaConsumer(EnvConfig config, Producer producer) {\n         }\n         this.producer = producer;\n         this.consumerUtilsCore = new ConsumerUtilsCoreImpl();\n+        this.snapshotOnDemandUtils = snapshotOnDemandUtils;\n     }\n \n-    public void initConsumer(ConsumerHandler consumerHandler) {\n-        this.consumerHandler = (DroolsConsumerHandler) consumerHandler;\n-        this.snapShooter = (DefaultSessionSnapShooter) InfraFactory.getSnapshooter(envConfig);\n+    //For test\n+    void setupForTest(EnvConfig config, Producer producer,\n+                      ConsumerUtilsCore consumerUtilsCore,\n+                      DefaultSessionSnapShooter defaultSessionSnapShooter,\n+                      SnapshotOnDemandUtils snapshotOnDemandUtils, DroolsConsumerHandler consumerHandler){\n+        this.envConfig = config;\n+        this.producer = producer;\n+        this.consumerUtilsCore = consumerUtilsCore;\n+        this.snapShooter = defaultSessionSnapShooter;\n+        this.snapshotOnDemandUtils = snapshotOnDemandUtils;\n+        this.consumerHandler = consumerHandler;\n+        getOrCreateKafkaConsumer();\n+        getOrCreateKafkaSecondaryConsumer();\n+    }\n+\n+    public void getOrCreateKafkaConsumer(){", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU2MTk5Ng==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405561996", "bodyText": "Are you sure it is not possible to subclass/set directly some fields and avoid to have a test specific method?", "author": "danielezonca", "createdAt": "2020-04-08T14:20:00Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -93,28 +96,50 @@ public DefaultKafkaConsumer(EnvConfig config, Producer producer) {\n         }\n         this.producer = producer;\n         this.consumerUtilsCore = new ConsumerUtilsCoreImpl();\n+        this.snapshotOnDemandUtils = snapshotOnDemandUtils;\n     }\n \n-    public void initConsumer(ConsumerHandler consumerHandler) {\n-        this.consumerHandler = (DroolsConsumerHandler) consumerHandler;\n-        this.snapShooter = (DefaultSessionSnapShooter) InfraFactory.getSnapshooter(envConfig);\n+    //For test\n+    void setupForTest(EnvConfig config, Producer producer,", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU3MjEyNw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2060#discussion_r405572127", "bodyText": "Please rename to updateKafkaSecondaryConsumer", "author": "danielezonca", "createdAt": "2020-04-08T14:33:59Z", "path": "drools-ha/ha-core-infra/src/main/java/org/kie/hacep/core/infra/consumer/DefaultKafkaConsumer.java", "diffHunk": "@@ -93,28 +96,50 @@ public DefaultKafkaConsumer(EnvConfig config, Producer producer) {\n         }\n         this.producer = producer;\n         this.consumerUtilsCore = new ConsumerUtilsCoreImpl();\n+        this.snapshotOnDemandUtils = snapshotOnDemandUtils;\n     }\n \n-    public void initConsumer(ConsumerHandler consumerHandler) {\n-        this.consumerHandler = (DroolsConsumerHandler) consumerHandler;\n-        this.snapShooter = (DefaultSessionSnapShooter) InfraFactory.getSnapshooter(envConfig);\n+    //For test\n+    void setupForTest(EnvConfig config, Producer producer,\n+                      ConsumerUtilsCore consumerUtilsCore,\n+                      DefaultSessionSnapShooter defaultSessionSnapShooter,\n+                      SnapshotOnDemandUtils snapshotOnDemandUtils, DroolsConsumerHandler consumerHandler){\n+        this.envConfig = config;\n+        this.producer = producer;\n+        this.consumerUtilsCore = consumerUtilsCore;\n+        this.snapShooter = defaultSessionSnapShooter;\n+        this.snapshotOnDemandUtils = snapshotOnDemandUtils;\n+        this.consumerHandler = consumerHandler;\n+        getOrCreateKafkaConsumer();\n+        getOrCreateKafkaSecondaryConsumer();\n+    }\n+\n+    public void getOrCreateKafkaConsumer(){\n         this.kafkaConsumer = new KafkaConsumer<>(Config.getConsumerConfig(PRIMARY_CONSUMER));\n+    }\n+\n+    public void getOrCreateKafkaSecondaryConsumer(){\n         if (currentState.equals(State.REPLICA)) {\n             this.kafkaSecondaryConsumer = new KafkaConsumer<>(Config.getConsumerConfig(SECONDARY_CONSUMER));\n+        } else {\n+            this.kafkaSecondaryConsumer = null;\n         }\n     }", "originalCommit": "8f3757d373bbb89854ba0ffc475ba17c8444cbd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5abd9b5ecacd86fcffa23d5d4ab28c12c14b0d9b", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/5abd9b5ecacd86fcffa23d5d4ab28c12c14b0d9b", "message": "changes requested by reviewer", "committedDate": "2020-04-08T14:46:07Z", "type": "commit"}, {"oid": "62c37713987ad1014cc1ae0fb08ee79017104e1f", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/62c37713987ad1014cc1ae0fb08ee79017104e1f", "message": "changes requested by reviewer", "committedDate": "2020-04-08T15:32:47Z", "type": "commit"}, {"oid": "afc3585f9cd1081c3fd209be0c82af60fb399367", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/afc3585f9cd1081c3fd209be0c82af60fb399367", "message": "removed unused import", "committedDate": "2020-04-10T09:42:57Z", "type": "commit"}]}