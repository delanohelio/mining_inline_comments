{"pr_number": 2019, "pr_title": "Refactor KJar builds for Kie server tests to use installed Maven binary", "pr_createdAt": "2020-02-18T16:34:03Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019", "timeline": [{"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/a896828bc15f6f45045a4f629ad5ee211dccf01f", "message": "Refactor KJar builds for Kie server tests to use installed Maven binary\n\nSigned-off-by: Karel Suta <ksuta@redhat.com>", "committedDate": "2020-02-18T16:31:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r380894263", "bodyText": "I usually have problem with embedded maven not showing error messages.\nCan this --quiet worsen the situation?", "author": "lucamolteni", "createdAt": "2020-02-18T19:43:34Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -61,24 +62,19 @@ public static void buildAndDeployMavenProjectFromResource(String resourcePath) {\n     }\n \n     public static void buildAndDeployMavenProject(String basedir) {\n-        // need to backup (and later restore) the current class loader, because the Maven/Plexus does some classloader\n-        // magic which then results in CNFE in RestEasy client\n         // run the Maven build which will create the kjar. The kjar is then either installed or deployed to local and\n         // remote repo\n         logger.debug(\"Building and deploying Maven project from basedir '{}'.\", basedir);\n-        ClassLoader classLoaderBak = Thread.currentThread().getContextClassLoader();\n-        System.setProperty(\"maven.multiModuleProjectDirectory\", basedir); // required by MavenCli 3.3.0+\n-        MavenCli cli = new MavenCli();\n         List<String> mvnArgs;\n         if (TestConfig.isLocalServer()) {\n             // just install into local repository when running the local server. Deploying to remote repo will fail\n             // if the repo does not exist.\n \n             // wrapping explicitly in ArrayList as we may need to update the list later (and Arrays.toList() returns\n             // just read-only list)\n-            mvnArgs = new ArrayList<String>(Arrays.asList(\"-B\", \"clean\", \"install\"));\n+            mvnArgs = new ArrayList<>(Arrays.asList(\"mvn\", \"--quiet\", \"clean\", \"install\"));", "originalCommit": "a896828bc15f6f45045a4f629ad5ee211dccf01f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTExNDg3MA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381114870", "bodyText": "The errors should be still shown. From the maven help:\n-q,--quiet                             Quiet output - only show errors\nI have tried that manually, the error is shown if any error happens.", "author": "sutaakar", "createdAt": "2020-02-19T07:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMzgxOA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381123818", "bodyText": "Ok perfect", "author": "lucamolteni", "createdAt": "2020-02-19T07:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r380894629", "bodyText": "We need some better error messages here. This one is too generic and when it occured to me I had to debug to discover the real cause", "author": "lucamolteni", "createdAt": "2020-02-18T19:44:15Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -87,13 +83,15 @@ public static void buildAndDeployMavenProject(String basedir) {\n             mvnArgs.add(\"-s\");\n             mvnArgs.add(kjarsBuildSettingsXml);\n         }\n-        int mvnRunResult = cli.doMain(mvnArgs.toArray(new String[mvnArgs.size()]), basedir, System.out, System.err);\n \n-        Thread.currentThread().setContextClassLoader(classLoaderBak);\n+        // Execute the Maven build using installed Maven binary\n+        try (ProcessExecutor executor = new ProcessExecutor()) {\n+            String command = mvnArgs.stream().collect(Collectors.joining(\" \"));\n+            boolean executionSuccessful = executor.executeProcessCommand(command, Paths.get(basedir));\n \n-        if (mvnRunResult != 0) {\n-            throw new RuntimeException(\"Error while building Maven project from basedir \" + basedir +\n-                    \". Return code=\" + mvnRunResult);\n+            if (!executionSuccessful) {", "originalCommit": "a896828bc15f6f45045a4f629ad5ee211dccf01f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTExNzAwNA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381117004", "bodyText": "Ideally the real issue should be visible from the invoked process log - any error should be shown there.\nHere in the code we can get just process exit value, that won't tell us much.\nIf it is not enough I can adjust the code to print complete process log (not just error) in case maven build fails. What do you think about it?", "author": "sutaakar", "createdAt": "2020-02-19T07:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMzc2NA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381123764", "bodyText": "If the errors are shown before it's fine, we don't need to print the log again. Thanks", "author": "lucamolteni", "createdAt": "2020-02-19T07:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ=="}], "type": "inlineReview"}]}