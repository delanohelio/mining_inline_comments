{"pr_number": 2055, "pr_title": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "pr_createdAt": "2020-04-03T15:40:02Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055", "timeline": [{"oid": "1f834b09634412fa509706843a352a9b45282569", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/1f834b09634412fa509706843a352a9b45282569", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "committedDate": "2020-04-07T09:45:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3MzUzNg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404673536", "bodyText": "I would rename \"id\" to \"taskId\" to keep it similar to \"saveTaskContent\" method above.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Long saveTaskContent(String containerId, Long id, String userId, Map<String, Object> content);\n          \n          \n            \n                Long saveTaskContent(String containerId, Long taskId, String userId, Map<String, Object> content);", "author": "afalhambra", "createdAt": "2020-04-07T09:37:31Z", "path": "kie-server-parent/kie-server-remote/kie-server-client/src/main/java/org/kie/server/client/UserTaskServicesClient.java", "diffHunk": "@@ -73,6 +73,8 @@\n \n     Long saveTaskContent(String containerId, Long taskId, Map<String, Object> values);\n \n+    Long saveTaskContent(String containerId, Long id, String userId, Map<String, Object> content);", "originalCommit": "564f313f343e81d003797b17c4b14ec3f2f9334c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NjM4Mw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406046383", "bodyText": "done", "author": "elguardian", "createdAt": "2020-04-09T08:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3MzUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3OTM3Nw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404679377", "bodyText": "Too much indent tabulation.\n\"required = false\" is not really needed, but for clarity sake I think it's ok. wdyt?\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            @ApiParam(value = \"optional user id to be used instead of authenticated user - only when bypass authenticated user is enabled\", required = false) @QueryParam(\"user\") String userId,\n          \n          \n            \n                        @ApiParam(value = \"optional user id to be used instead of authenticated user - only when bypass authenticated user is enabled\") @QueryParam(\"user\") String userId,", "author": "afalhambra", "createdAt": "2020-04-07T09:47:03Z", "path": "kie-server-parent/kie-server-remote/kie-server-rest/kie-server-rest-jbpm/src/main/java/org/kie/server/remote/rest/jbpm/UserTaskResource.java", "diffHunk": "@@ -707,6 +707,7 @@ public Response setDescription(@Context HttpHeaders headers,\n     public Response saveContent(@Context HttpHeaders headers, \n             @ApiParam(value = \"container id that task instance belongs to\", required = true, example = \"evaluation_1.0.0-SNAPSHOT\") @PathParam(CONTAINER_ID) String containerId,\n             @ApiParam(value = \"identifier of the task instance that data should be saved into\", required = true, example = \"123\") @PathParam(TASK_INSTANCE_ID) Long taskId, \n+                                @ApiParam(value = \"optional user id to be used instead of authenticated user - only when bypass authenticated user is enabled\", required = false) @QueryParam(\"user\") String userId,", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NzQ5Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406047492", "bodyText": "just left it", "author": "elguardian", "createdAt": "2020-04-09T08:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3OTM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NTc4Mw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404695783", "bodyText": "Not really sure whether we need to pass \"containerId\" as it was done before? Why it is not required now from a functional point of view?", "author": "afalhambra", "createdAt": "2020-04-07T10:14:11Z", "path": "kie-server-parent/kie-server-services/kie-server-services-jbpm/src/main/java/org/kie/server/services/jbpm/UserTaskServiceBase.java", "diffHunk": "@@ -258,12 +256,17 @@ public void setDescription(String containerId, Number taskId, String description\n     }\n \n     public String saveContent(String containerId, Number taskId, String payload, String marshallingType) {\n+        return saveContent(containerId, null, taskId, payload, marshallingType);\n+    }\n+\n+    public String saveContent(String containerId, String userId, Number taskId, String payload, String marshallingType) {\n+        userId = getUser(userId);\n         containerId = context.getContainerId(containerId, new ByTaskIdContainerLocator(taskId.longValue()));\n         logger.debug(\"About to unmarshal task content parameters from payload: '{}'\", payload);\n         Map<String, Object> parameters = marshallerHelper.unmarshal(containerId, payload, marshallingType, Map.class);\n \n         logger.debug(\"About to set content of a task with id '{}' with data {}\", taskId, parameters);\n-        Long contentId = userTaskService.saveContent(containerId, taskId.longValue(), parameters);\n+        Long contentId = userTaskService.saveContentFromUser(taskId.longValue(), userId, parameters);", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2MzUxOA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406063518", "bodyText": "not really needed when you have the task id", "author": "elguardian", "createdAt": "2020-04-09T09:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NTc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5OTcxOQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404699719", "bodyText": "unboxing not needed", "author": "afalhambra", "createdAt": "2020-04-07T10:20:56Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)\n+    public void testProcessWithUserTasks() throws Exception {\n+        Long processInstanceId = processClient.startProcess(CONTAINER_ID, PROCESS_ID_USERTASK);\n+        assertNotNull(processInstanceId);\n+        assertTrue(processInstanceId.longValue() > 0);", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0ODA0Nw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406048047", "bodyText": "ok", "author": "elguardian", "createdAt": "2020-04-09T08:40:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5OTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNTQ5Ng==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404705496", "bodyText": "Why is it marked as Smoke category? couldn't find any test suite to execute this category", "author": "afalhambra", "createdAt": "2020-04-07T10:31:03Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0ODE3Nw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406048177", "bodyText": "removed", "author": "elguardian", "createdAt": "2020-04-09T08:40:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNTQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzQzMQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404717431", "bodyText": "not sure why \"events.size() - 1\"? shouldn't we get always events.size = 1? if not, why events.size - 1 would return \"admin\" as userId?", "author": "afalhambra", "createdAt": "2020-04-07T10:53:11Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)\n+    public void testProcessWithUserTasks() throws Exception {\n+        Long processInstanceId = processClient.startProcess(CONTAINER_ID, PROCESS_ID_USERTASK);\n+        assertNotNull(processInstanceId);\n+        assertTrue(processInstanceId.longValue() > 0);\n+        try {\n+            List<TaskSummary> taskList = taskClient.findTasksAssignedAsPotentialOwner(USER_YODA, 0, 10);\n+            assertNotNull(taskList);\n+\n+            assertEquals(1, taskList.size());\n+            TaskSummary taskSummary = taskList.get(0);\n+            assertEquals(\"First task\", taskSummary.getName());\n+\n+            // startTask and completeTask task\n+            taskClient.startTask(CONTAINER_ID, taskSummary.getId(), USER_YODA);\n+\n+            Map<String, Object> taskOutcome = new HashMap<String, Object>();\n+            taskOutcome.put(\"string_\", \"my custom data\");\n+            taskOutcome.put(\"person_\", createPersonInstance(USER_MARY));\n+\n+            Map<String, Object> content = new HashMap<>();\n+            content.put(\"name\", \"joda\");\n+            taskClient.saveTaskContent(CONTAINER_ID, taskSummary.getId(), \"admin\", content);\n+            List<TaskEventInstance> events = taskClient.findTaskEvents(taskSummary.getId(), 0, 10);\n+            assertEquals(\"admin\", events.get(events.size() - 1).getUserId());", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0ODQ3Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406048472", "bodyText": "it is the lasts event. We are checking that the last event modification is by the user being impersonated.", "author": "elguardian", "createdAt": "2020-04-09T08:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzUyMQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404717521", "bodyText": "same as previous comment", "author": "afalhambra", "createdAt": "2020-04-07T10:53:23Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)\n+    public void testProcessWithUserTasks() throws Exception {\n+        Long processInstanceId = processClient.startProcess(CONTAINER_ID, PROCESS_ID_USERTASK);\n+        assertNotNull(processInstanceId);\n+        assertTrue(processInstanceId.longValue() > 0);\n+        try {\n+            List<TaskSummary> taskList = taskClient.findTasksAssignedAsPotentialOwner(USER_YODA, 0, 10);\n+            assertNotNull(taskList);\n+\n+            assertEquals(1, taskList.size());\n+            TaskSummary taskSummary = taskList.get(0);\n+            assertEquals(\"First task\", taskSummary.getName());\n+\n+            // startTask and completeTask task\n+            taskClient.startTask(CONTAINER_ID, taskSummary.getId(), USER_YODA);\n+\n+            Map<String, Object> taskOutcome = new HashMap<String, Object>();\n+            taskOutcome.put(\"string_\", \"my custom data\");\n+            taskOutcome.put(\"person_\", createPersonInstance(USER_MARY));\n+\n+            Map<String, Object> content = new HashMap<>();\n+            content.put(\"name\", \"joda\");\n+            taskClient.saveTaskContent(CONTAINER_ID, taskSummary.getId(), \"admin\", content);\n+            List<TaskEventInstance> events = taskClient.findTaskEvents(taskSummary.getId(), 0, 10);\n+            assertEquals(\"admin\", events.get(events.size() - 1).getUserId());\n+\n+            taskClient.saveTaskContent(CONTAINER_ID, taskSummary.getId(), \"other\", content);\n+            events = taskClient.findTaskEvents(taskSummary.getId(), 0, 10);\n+            assertEquals(\"other\", events.get(events.size() - 1).getUserId());", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0ODcxMg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406048712", "bodyText": "checking the last event is by the user being impersonated.", "author": "elguardian", "createdAt": "2020-04-09T08:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzg5NQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404717895", "bodyText": "this method doesn't throw any exception", "author": "afalhambra", "createdAt": "2020-04-07T10:54:04Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)\n+    public void testProcessWithUserTasks() throws Exception {", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0ODc5NQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r406048795", "bodyText": "removed", "author": "elguardian", "createdAt": "2020-04-09T08:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxNzg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcxODM4OA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r404718388", "bodyText": "These 4 methods are never used", "author": "afalhambra", "createdAt": "2020-04-07T10:55:00Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/ByPassUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+*/\n+\n+package org.kie.server.integrationtests.jbpm;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.kie.api.KieServices;\n+import org.kie.api.task.model.Status;\n+import org.kie.server.api.model.ReleaseId;\n+import org.kie.server.api.model.instance.TaskEventInstance;\n+import org.kie.server.api.model.instance.TaskInstance;\n+import org.kie.server.api.model.instance.TaskSummary;\n+import org.kie.server.integrationtests.category.Smoke;\n+import org.kie.server.integrationtests.shared.KieServerDeployer;\n+import org.kie.server.integrationtests.shared.KieServerReflections;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class ByPassUserTaskServiceIntegrationTest extends JbpmKieServerBaseIntegrationTest {\n+\n+    private static ReleaseId releaseId = new ReleaseId(\"org.kie.server.testing\", \"definition-project\",\n+            \"1.0.0.Final\");\n+\n+    @BeforeClass\n+    public static void buildAndDeployArtifacts() {\n+\n+        KieServerDeployer.buildAndDeployCommonMavenParent();\n+        KieServerDeployer.buildAndDeployMavenProjectFromResource(\"/kjars-sources/definition-project\");\n+\n+\n+        kieContainer = KieServices.Factory.get().newKieContainer(releaseId);\n+\n+        createContainer(CONTAINER_ID, releaseId);\n+    }\n+\n+    @Override\n+    protected void addExtraCustomClasses(Map<String, Class<?>> extraClasses) throws Exception {\n+        extraClasses.put(PERSON_CLASS_NAME, Class.forName(PERSON_CLASS_NAME, true, kieContainer.getClassLoader()));\n+    }\n+\n+    @Test\n+    @Category(Smoke.class)\n+    public void testProcessWithUserTasks() throws Exception {\n+        Long processInstanceId = processClient.startProcess(CONTAINER_ID, PROCESS_ID_USERTASK);\n+        assertNotNull(processInstanceId);\n+        assertTrue(processInstanceId.longValue() > 0);\n+        try {\n+            List<TaskSummary> taskList = taskClient.findTasksAssignedAsPotentialOwner(USER_YODA, 0, 10);\n+            assertNotNull(taskList);\n+\n+            assertEquals(1, taskList.size());\n+            TaskSummary taskSummary = taskList.get(0);\n+            assertEquals(\"First task\", taskSummary.getName());\n+\n+            // startTask and completeTask task\n+            taskClient.startTask(CONTAINER_ID, taskSummary.getId(), USER_YODA);\n+\n+            Map<String, Object> taskOutcome = new HashMap<String, Object>();\n+            taskOutcome.put(\"string_\", \"my custom data\");\n+            taskOutcome.put(\"person_\", createPersonInstance(USER_MARY));\n+\n+            Map<String, Object> content = new HashMap<>();\n+            content.put(\"name\", \"joda\");\n+            taskClient.saveTaskContent(CONTAINER_ID, taskSummary.getId(), \"admin\", content);\n+            List<TaskEventInstance> events = taskClient.findTaskEvents(taskSummary.getId(), 0, 10);\n+            assertEquals(\"admin\", events.get(events.size() - 1).getUserId());\n+\n+            taskClient.saveTaskContent(CONTAINER_ID, taskSummary.getId(), \"other\", content);\n+            events = taskClient.findTaskEvents(taskSummary.getId(), 0, 10);\n+            assertEquals(\"other\", events.get(events.size() - 1).getUserId());\n+\n+            taskClient.completeTask(CONTAINER_ID, taskSummary.getId(), USER_YODA, taskOutcome);\n+\n+            // check if task outcomes are properly set as process variables\n+            Object personVar = processClient.getProcessInstanceVariable(CONTAINER_ID, processInstanceId, \"personData\");\n+            assertNotNull(personVar);\n+            assertEquals(USER_MARY, KieServerReflections.valueOf(personVar, \"name\"));\n+\n+            String stringVar = (String) processClient.getProcessInstanceVariable(CONTAINER_ID, processInstanceId, \"stringData\");\n+            assertNotNull(personVar);\n+            assertEquals(\"my custom data\", stringVar);\n+\n+            taskList = taskClient.findTasksAssignedAsPotentialOwner(USER_YODA, 0, 10);\n+            assertNotNull(taskList);\n+\n+            assertEquals(1, taskList.size());\n+            taskSummary = taskList.get(0);\n+            assertEquals(\"Second task\", taskSummary.getName());\n+\n+        } finally {\n+            processClient.abortProcessInstance(CONTAINER_ID, processInstanceId);\n+        }\n+    }\n+    \n+    \n+    \n+    private void assertTaskEventInstance(TaskEventInstance expected, TaskEventInstance actual) {\n+        assertNotNull(actual);\n+        assertEquals(expected.getType(), actual.getType());\n+        assertEquals(expected.getProcessInstanceId(), actual.getProcessInstanceId());\n+        assertEquals(expected.getTaskId(), actual.getTaskId());\n+        assertEquals(expected.getUserId(), actual.getUserId());\n+        assertNotNull(actual.getId());\n+        assertNotNull(actual.getLogTime());\n+        assertNotNull(actual.getWorkItemId());\n+    }\n+\n+    private void checkTaskNameAndStatus(TaskSummary taskSummary, String name, Status status) {\n+        assertNotNull(taskSummary);\n+        assertEquals(name, taskSummary.getName());\n+        assertEquals(status.toString(), taskSummary.getStatus());\n+    }\n+\n+    private void checkTaskStatusAndOwners(String containerId, Long taskId, Status status, String actualOwner, String potentialOwner) {\n+        TaskInstance task = taskClient.getTaskInstance(containerId, taskId, false, false, true);\n+        checkTaskStatusAndActualOwner(containerId, taskId, status, actualOwner);\n+        assertEquals(1, task.getPotentialOwners().size());\n+        assertEquals(potentialOwner, task.getPotentialOwners().get(0));\n+    }\n+\n+    private void checkTaskStatusAndActualOwner(String containerId, Long taskId, Status status, String actualOwner) {\n+        TaskInstance task = taskClient.getTaskInstance(containerId, taskId);\n+        assertEquals(taskId, task.getId());\n+        assertEquals(status.toString(), task.getStatus());\n+        assertEquals(actualOwner, task.getActualOwner());\n+    }", "originalCommit": "1f834b09634412fa509706843a352a9b45282569", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04f27a567723c48c4f3dace75fec03406b45520b", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/04f27a567723c48c4f3dace75fec03406b45520b", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "committedDate": "2020-04-09T10:23:36Z", "type": "forcePushed"}, {"oid": "d6f6441ed0e537764ce9d0083a15d2322d18a9bb", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/d6f6441ed0e537764ce9d0083a15d2322d18a9bb", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "committedDate": "2020-04-09T10:50:27Z", "type": "forcePushed"}, {"oid": "3559d4542c57df07d78e8ea0a0d75064c4c0be65", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/3559d4542c57df07d78e8ea0a0d75064c4c0be65", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "committedDate": "2020-04-09T11:51:47Z", "type": "forcePushed"}, {"oid": "2af8bb69334b27af5a7d825bca3f669f3c58ad77", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/2af8bb69334b27af5a7d825bca3f669f3c58ad77", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.", "committedDate": "2020-04-12T08:37:59Z", "type": "commit"}, {"oid": "7d5fff5976f8db398fd9786b5761a94347a90e21", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/7d5fff5976f8db398fd9786b5761a94347a90e21", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.\n\nadd user query with parameters", "committedDate": "2020-04-12T15:10:52Z", "type": "forcePushed"}, {"oid": "3d6709a5590c1f47be13eec6c9e93f1c789e5820", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/3d6709a5590c1f47be13eec6c9e93f1c789e5820", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.\n\nadd user query with parameters", "committedDate": "2020-04-13T09:37:16Z", "type": "commit"}, {"oid": "3d6709a5590c1f47be13eec6c9e93f1c789e5820", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/3d6709a5590c1f47be13eec6c9e93f1c789e5820", "message": "[RHPAM-2813] Allow to use 'user' query parameter with /contents/output REST API.\n\nadd user query with parameters", "committedDate": "2020-04-13T09:37:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5OTM4Nw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r407999387", "bodyText": "Why this change?", "author": "afalhambra", "createdAt": "2020-04-14T09:34:34Z", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-jbpm/src/test/java/org/kie/server/integrationtests/jbpm/RollingUpdateUserTaskServiceIntegrationTest.java", "diffHunk": "@@ -64,7 +64,7 @@ public void testGetTaskInputAndOutputWithAlias() throws Exception {\n             ProcessInstance processInstance = processClient.getProcessInstance(CONTAINER_ALIAS, pid);\n             assertThat(processInstance).isNotNull();\n \n-            List<TaskSummary> taskList = taskClient.findTasksAssignedAsBusinessAdministrator(USER_YODA, 0, 10);\n+            List<TaskSummary> taskList = taskClient.findTasksAssignedAsBusinessAdministrator(USER_ADMINISTRATOR, 0, 10);", "originalCommit": "3d6709a5590c1f47be13eec6c9e93f1c789e5820", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwOTk1NQ==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2055#discussion_r408009955", "bodyText": "this is a faulty test.  before it was working because the bypass was on false. But when I changed it the the administrator user was the right one to set.", "author": "elguardian", "createdAt": "2020-04-14T09:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5OTM4Nw=="}], "type": "inlineReview"}]}