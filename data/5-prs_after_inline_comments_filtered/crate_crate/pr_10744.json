{"pr_number": 10744, "pr_title": "Add the `sys.snapshot_restore` table.", "pr_createdAt": "2020-11-04T15:05:24Z", "pr_url": "https://github.com/crate/crate/pull/10744", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQzMjg3NA==", "url": "https://github.com/crate/crate/pull/10744#discussion_r517432874", "bodyText": "Do you think it worth adding an integration test? It is essentially the same, I would have to build the RestoreInProgress and update the cluster state and then query the table. Another approach with running restore snapshot statements in the test and querying the sys.snapshot_restore table seems to be not feasible.", "author": "kovrus", "createdAt": "2020-11-04T15:35:58Z", "path": "server/src/test/java/io/crate/expression/reference/sys/snapshot/SysSnapshotRestoreTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.reference.sys.snapshot;\n+\n+import io.crate.test.integration.CrateDummyClusterServiceUnitTest;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.RestoreInProgress;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.index.shard.ShardId;\n+import org.elasticsearch.snapshots.Snapshot;\n+import org.elasticsearch.snapshots.SnapshotId;\n+import org.junit.Test;\n+\n+import java.util.List;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class SysSnapshotRestoreTest extends CrateDummyClusterServiceUnitTest {", "originalCommit": "1465126cfd791b9e311587671584aee4b9306d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0OTU0Nw==", "url": "https://github.com/crate/crate/pull/10744#discussion_r517449547", "bodyText": "Seems okay. Given we have tests that already picked up the new table. And I think there is a test that already ensures that all columns of all tables can be selected.", "author": "mfussenegger", "createdAt": "2020-11-04T15:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQzMjg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0ODI2Mw==", "url": "https://github.com/crate/crate/pull/10744#discussion_r517448263", "bodyText": "I'm not sure if it is worth testing on this level if the clusterService and state is mocked.\nHow about changing the snapshotsRestoreInProgress method to take the ClusterState or even the RestoreInProgress as an argument? I think it could also move into the new SysSnapshotRestoreTableInfo class as a static method.\nSysTableDefinitions could then directly call that method - it already has a clusterService instance - and the new SysSnapshotsRestore class could be removed again.", "author": "mfussenegger", "createdAt": "2020-11-04T15:56:33Z", "path": "server/src/test/java/io/crate/expression/reference/sys/snapshot/SysSnapshotRestoreTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.reference.sys.snapshot;\n+\n+import io.crate.test.integration.CrateDummyClusterServiceUnitTest;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.RestoreInProgress;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.collect.ImmutableOpenMap;\n+import org.elasticsearch.index.shard.ShardId;\n+import org.elasticsearch.snapshots.Snapshot;\n+import org.elasticsearch.snapshots.SnapshotId;\n+import org.junit.Test;\n+\n+import java.util.List;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class SysSnapshotRestoreTest extends CrateDummyClusterServiceUnitTest {\n+\n+    @Test\n+    public void test_extract_and_convert_one_restore_in_progress_to_sys_restore_snapshot_context_type() {\n+        ImmutableOpenMap.Builder<ShardId, RestoreInProgress.ShardRestoreStatus> shardsBuilder\n+            = ImmutableOpenMap.builder();\n+        shardsBuilder.put(\n+            new ShardId(\"index\", \"_uuid\", 0),\n+            new RestoreInProgress.ShardRestoreStatus(\"nodeId\", RestoreInProgress.State.STARTED)\n+        );\n+        RestoreInProgress.Entry entry = new RestoreInProgress.Entry(\n+            \"_uuid\",\n+            new Snapshot(\n+                \"repository\",\n+                new SnapshotId(\"snapshot\", UUID.randomUUID().toString())),\n+            RestoreInProgress.State.SUCCESS,\n+            List.of(\"index\"),\n+            shardsBuilder.build()\n+        );\n+\n+        var clusterService = mock(ClusterService.class);\n+        var clusterState = mock(ClusterState.class);\n+        when(clusterState.custom(RestoreInProgress.TYPE))\n+            .thenReturn(new RestoreInProgress.Builder().add(entry).build());\n+        when(clusterService.state()).thenReturn(clusterState);", "originalCommit": "1465126cfd791b9e311587671584aee4b9306d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUxNjIxOA==", "url": "https://github.com/crate/crate/pull/10744#discussion_r517516218", "bodyText": "Pushed the fixup. I was also not sure about SysSnapshotRestore..", "author": "kovrus", "createdAt": "2020-11-04T17:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0ODI2Mw=="}], "type": "inlineReview"}, {"oid": "5898c62b7a8d507e52d682a62b9a7c799b754373", "url": "https://github.com/crate/crate/commit/5898c62b7a8d507e52d682a62b9a7c799b754373", "message": "fixup! Add the `sys.snapshot_restore` table.", "committedDate": "2020-11-04T17:34:41Z", "type": "forcePushed"}, {"oid": "0707cbb205bc6bc6d23b86c3a6df08b0a6e2c144", "url": "https://github.com/crate/crate/commit/0707cbb205bc6bc6d23b86c3a6df08b0a6e2c144", "message": "Add the `sys.snapshot_restore` table.\n\nA user can check the progress of the `RESTORE SNAPSHOT` statement\nby querying the `sys.snapshot_restore`.", "committedDate": "2020-11-04T20:54:40Z", "type": "forcePushed"}, {"oid": "6acf0fc9815e6ce9e4242d23cb519aefc3235c34", "url": "https://github.com/crate/crate/commit/6acf0fc9815e6ce9e4242d23cb519aefc3235c34", "message": "Add the `sys.snapshot_restore` table.\n\nA user can check the progress of the `RESTORE SNAPSHOT` statement\nby querying the `sys.snapshot_restore`.", "committedDate": "2020-11-05T10:01:24Z", "type": "commit"}, {"oid": "6acf0fc9815e6ce9e4242d23cb519aefc3235c34", "url": "https://github.com/crate/crate/commit/6acf0fc9815e6ce9e4242d23cb519aefc3235c34", "message": "Add the `sys.snapshot_restore` table.\n\nA user can check the progress of the `RESTORE SNAPSHOT` statement\nby querying the `sys.snapshot_restore`.", "committedDate": "2020-11-05T10:01:24Z", "type": "forcePushed"}]}