{"pr_number": 9840, "pr_title": "Refactor array_agg, string_agg and count functions to use new function registry.", "pr_createdAt": "2020-04-01T14:56:36Z", "pr_url": "https://github.com/crate/crate/pull/9840", "timeline": [{"oid": "d05f5515687df5055c075fee5a4b69fd5d6da0f0", "url": "https://github.com/crate/crate/commit/d05f5515687df5055c075fee5a4b69fd5d6da0f0", "message": "Refactor count function to use new function registry.", "committedDate": "2020-04-02T08:52:47Z", "type": "commit"}, {"oid": "82841407468d5f4d8accc0165717d1bbe712ed42", "url": "https://github.com/crate/crate/commit/82841407468d5f4d8accc0165717d1bbe712ed42", "message": "Refactor array_agg function to use new function registry.", "committedDate": "2020-04-02T08:52:47Z", "type": "commit"}, {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "url": "https://github.com/crate/crate/commit/b8f9230c347bedbb3170ffa8b07828d78d481a1b", "message": "Refactor string_agg function to use new function registry.", "committedDate": "2020-04-02T08:52:54Z", "type": "commit"}, {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "url": "https://github.com/crate/crate/commit/b8f9230c347bedbb3170ffa8b07828d78d481a1b", "message": "Refactor string_agg function to use new function registry.", "committedDate": "2020-04-02T08:52:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMTk1OA==", "url": "https://github.com/crate/crate/pull/9840#discussion_r402211958", "bodyText": "Maybe worth creating builder shortcuts like Signature.scalar() also for aggregates? I think this really improves readability. Also note the signature.withTypeVariableContraints() builder.", "author": "seut", "createdAt": "2020-04-02T10:30:33Z", "path": "sql/src/main/java/io/crate/execution/engine/aggregation/impl/ArrayAgg.java", "diffHunk": "@@ -42,19 +40,24 @@\n import java.util.ArrayList;\n import java.util.List;\n \n+import static io.crate.metadata.functions.TypeVariableConstraint.typeVariable;\n+import static io.crate.types.TypeSignature.parseTypeSignature;\n+\n public final class ArrayAgg extends AggregationFunction<List<Object>, List<Object>> {\n \n     public static final String NAME = \"array_agg\";\n \n     public static void register(AggregationImplModule module) {\n-        module.register(NAME, new BaseFunctionResolver(FuncParams.SINGLE_ANY) {\n-\n-            @Override\n-            public FunctionImplementation getForTypes(List<DataType> types) throws IllegalArgumentException {\n-                var type = types.get(0);\n-                return new ArrayAgg(type);\n-            }\n-        });\n+        module.register(\n+            Signature.builder()\n+                .name(NAME)\n+                .kind(FunctionInfo.Type.AGGREGATE)\n+                .argumentTypes(parseTypeSignature(\"E\"))\n+                .typeVariableConstraints(typeVariable(\"E\"))\n+                .returnType(parseTypeSignature(\"array(E)\"))\n+                .build(),", "originalCommit": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxNDg2OQ==", "url": "https://github.com/crate/crate/pull/9840#discussion_r402214869", "bodyText": "Can we mark the old register methods as deprecated?", "author": "seut", "createdAt": "2020-04-02T10:35:28Z", "path": "sql/src/main/java/io/crate/expression/AbstractFunctionModule.java", "diffHunk": "@@ -57,6 +61,13 @@ public void register(FunctionName qualifiedName, FunctionResolver functionResolv\n         resolver.put(qualifiedName, functionResolver);\n     }\n \n+    public void register(Signature signature, Function<List<DataType>, FunctionImplementation> factory) {", "originalCommit": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a317e2adc78330713aa5c63bae816d8307d33976", "url": "https://github.com/crate/crate/commit/a317e2adc78330713aa5c63bae816d8307d33976", "message": "Add a shortcut for building aggregate function signatures.", "committedDate": "2020-04-02T10:56:00Z", "type": "commit"}, {"oid": "07da78fcc20cde371ba40e6dd47ef0c8c5588ed2", "url": "https://github.com/crate/crate/commit/07da78fcc20cde371ba40e6dd47ef0c8c5588ed2", "message": "Merge branch 'master' into r/count-agg", "committedDate": "2020-04-02T12:46:21Z", "type": "commit"}]}