{"pr_number": 9853, "pr_title": "Add fast function lookup-by-signature support", "pr_createdAt": "2020-04-03T14:31:02Z", "pr_url": "https://github.com/crate/crate/pull/9853", "timeline": [{"oid": "587aed21ca2d07e904b5c17482a0b6a2b92a972b", "url": "https://github.com/crate/crate/commit/587aed21ca2d07e904b5c17482a0b6a2b92a972b", "message": "Add fast function lookup-by-signature support\n\nAdd support to lookup a function directly by its declared signature.\nBefore that, looking up a function which uses the signature based\nregistry, resulted in a full expensive signature match logic.\nThis improvement may fix related existing performance regressions.\n\nFunction implementations must carry the signature and also the signature\nmust be streamable in order for this to work.\n\nWe carry now both, a `FunctionIdent` and a `Signature` all through the\ncode base to be able to still support the old registry to migrate\nall functions iterative.\nEventually the `FunctionInfo` (and `FunctionIdent`) should be replaced\nby a `Signature` after all functions are migrated.", "committedDate": "2020-04-03T14:42:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0OTIyMQ==", "url": "https://github.com/crate/crate/pull/9853#discussion_r403149221", "bodyText": "Is this safe to stream TypeSignature like this? I think this could lose information if it's  ObjectParameterTypeSignature", "author": "mfussenegger", "createdAt": "2020-04-03T17:01:21Z", "path": "sql/src/main/java/io/crate/metadata/functions/Signature.java", "diffHunk": "@@ -231,6 +237,29 @@ private Signature(FunctionName name,\n         this.allowCoercion = allowCoercion;\n     }\n \n+    public Signature(StreamInput in) throws IOException {\n+        name = new FunctionName(in);\n+        kind = FunctionInfo.Type.values()[in.readVInt()];\n+        int argsSize = in.readVInt();\n+        argumentTypes = new ArrayList<>(argsSize);\n+        for (int i = 0; i < argsSize; i++) {\n+            argumentTypes.add(new TypeSignature(in));", "originalCommit": "f91eecbd1c14a1bd3aa6bf02d4d4a5962e40de54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3MzY0NQ==", "url": "https://github.com/crate/crate/pull/9853#discussion_r404673645", "bodyText": "\ud83d\udc4d ah, good catch", "author": "seut", "createdAt": "2020-04-07T09:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0OTIyMQ=="}], "type": "inlineReview"}, {"oid": "407255033a2e692c61cffba2ae3cdfd96e33307c", "url": "https://github.com/crate/crate/commit/407255033a2e692c61cffba2ae3cdfd96e33307c", "message": "Move signature binding-only relevant info into own class\n\nThus only information required for looking up a function by signature\nwill be streamed.", "committedDate": "2020-04-22T15:31:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2MTk5OA==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413561998", "bodyText": "This case will be removed once all functions are migrated,  right?", "author": "mfussenegger", "createdAt": "2020-04-23T07:02:43Z", "path": "sql/src/main/java/io/crate/analyze/relations/RelationAnalyzer.java", "diffHunk": "@@ -613,8 +614,15 @@ public AnalyzedRelation visitTableFunction(TableFunction node, StatementAnalysis\n         }\n         Function function = (Function) symbol;\n         FunctionIdent ident = function.info().ident();\n+        Signature signature = function.signature();\n \n-        FunctionImplementation functionImplementation = functions.getQualified(ident);\n+        FunctionImplementation functionImplementation;\n+        if (signature == null) {\n+            functionImplementation = functions.getQualified(ident);", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU4ODAzNQ==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413588035", "bodyText": "Yep", "author": "seut", "createdAt": "2020-04-23T07:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2MTk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NTc4Mw==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413565783", "bodyText": "This should probably be 4.2, no?", "author": "mfussenegger", "createdAt": "2020-04-23T07:09:51Z", "path": "sql/src/main/java/io/crate/expression/symbol/Aggregation.java", "diffHunk": "@@ -66,10 +64,27 @@ public Aggregation(FunctionInfo functionInfo,\n \n         this.valueType = valueType;\n         this.functionInfo = functionInfo;\n+        this.signature = signature;\n         this.inputs = inputs;\n         this.filter = filter;\n     }\n \n+    public Aggregation(StreamInput in) throws IOException {\n+        functionInfo = new FunctionInfo(in);\n+        valueType = DataTypes.fromStream(in);\n+        if (in.getVersion().onOrAfter(Version.V_4_1_0)) {\n+            filter = Symbols.fromStream(in);\n+        } else {\n+            filter = Literal.BOOLEAN_TRUE;\n+        }\n+        inputs = Symbols.listFromStream(in);\n+        if (in.getVersion().onOrAfter(Version.V_4_1_0) && in.readBoolean()) {", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NTkwNw==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413565907", "bodyText": "Same here", "author": "mfussenegger", "createdAt": "2020-04-23T07:10:04Z", "path": "sql/src/main/java/io/crate/expression/symbol/Aggregation.java", "diffHunk": "@@ -105,7 +125,12 @@ public void writeTo(StreamOutput out) throws IOException {\n             Symbols.toStream(filter, out);\n         }\n         Symbols.toStream(inputs, out);\n-\n+        if (out.getVersion().onOrAfter(Version.V_4_1_0)) {", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NjAzNQ==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413566035", "bodyText": "4.2", "author": "mfussenegger", "createdAt": "2020-04-23T07:10:20Z", "path": "sql/src/main/java/io/crate/expression/symbol/Function.java", "diffHunk": "@@ -98,17 +101,27 @@ public Function(StreamInput in) throws IOException {\n             filter = null;\n         }\n         arguments = List.copyOf(Symbols.listFromStream(in));\n+        if (in.getVersion().onOrAfter(Version.V_4_1_0) && in.readBoolean()) {", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NjEzOQ==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413566139", "bodyText": "here as well", "author": "mfussenegger", "createdAt": "2020-04-23T07:10:33Z", "path": "sql/src/main/java/io/crate/expression/symbol/Function.java", "diffHunk": "@@ -191,6 +211,12 @@ public void writeTo(StreamOutput out) throws IOException {\n             Symbols.nullableToStream(filter, out);\n         }\n         Symbols.toStream(arguments, out);\n+        if (out.getVersion().onOrAfter(Version.V_4_1_0)) {", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2NzQ0OA==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413567448", "bodyText": "This can be nullable", "author": "mfussenegger", "createdAt": "2020-04-23T07:12:51Z", "path": "sql/src/main/java/io/crate/metadata/functions/Signature.java", "diffHunk": "@@ -269,25 +290,49 @@ public TypeSignature getReturnType() {\n         return returnType;\n     }\n \n-    public List<TypeVariableConstraint> getTypeVariableConstraints() {\n-        return typeVariableConstraints;\n+    public SignatureBindingInfo getBindingInfo() {", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU3MDI3Nw==", "url": "https://github.com/crate/crate/pull/9853#discussion_r413570277", "bodyText": "For Symbol and DataType we've static methods to handle the ordinal handling.\n    public static void toStream(DataType type, StreamOutput out) throws IOException {\n        out.writeVInt(type.id());\n        type.writeTo(out);\n    }\n\nDo you think it would make sense to follow that pattern here too?", "author": "mfussenegger", "createdAt": "2020-04-23T07:17:42Z", "path": "common/src/main/java/io/crate/types/TypeSignature.java", "diffHunk": "@@ -143,6 +157,16 @@ public String getBaseTypeName() {\n         return DataTypes.ofName(baseTypeName);\n     }\n \n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeString(baseTypeName);\n+        out.writeVInt(parameters.size());\n+        for (TypeSignature parameter : parameters) {\n+            out.writeVInt(parameter.type().ordinal());", "originalCommit": "407255033a2e692c61cffba2ae3cdfd96e33307c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a3320aed7a3064a45c38f262c4419a73dbb72ea", "url": "https://github.com/crate/crate/commit/1a3320aed7a3064a45c38f262c4419a73dbb72ea", "message": "Add fast function lookup-by-signature support\n\nAdd support to lookup a function directly by its declared signature.\nBefore that, looking up a function which uses the signature based\nregistry, resulted in a full expensive signature match logic.\nThis improvement may fix related existing performance regressions.\n\nFunction implementations must carry the signature and also the signature\nmust be streamable in order for this to work.\n\nWe carry now both, a `FunctionIdent` and a `Signature` all through the\ncode base to be able to still support the old registry to migrate\nall functions iterative.\nEventually the `FunctionInfo` (and `FunctionIdent`) should be replaced\nby a `Signature` after all functions are migrated.", "committedDate": "2020-04-23T09:12:31Z", "type": "commit"}, {"oid": "4c34019e979307c33d782a88a6529765f7a82f5f", "url": "https://github.com/crate/crate/commit/4c34019e979307c33d782a88a6529765f7a82f5f", "message": "Raise error on registering functions with same signature\n\nAlso some signature properties are excluded from streaming to lower the\nfootprint and won\u2019t be taken into account when resolving functions by\nsignature. Thus registering functions which signatures only differ in\nthus properties should raise an error to avoid unexpected behaviour.", "committedDate": "2020-04-23T09:12:31Z", "type": "commit"}, {"oid": "4c34019e979307c33d782a88a6529765f7a82f5f", "url": "https://github.com/crate/crate/commit/4c34019e979307c33d782a88a6529765f7a82f5f", "message": "Raise error on registering functions with same signature\n\nAlso some signature properties are excluded from streaming to lower the\nfootprint and won\u2019t be taken into account when resolving functions by\nsignature. Thus registering functions which signatures only differ in\nthus properties should raise an error to avoid unexpected behaviour.", "committedDate": "2020-04-23T09:12:31Z", "type": "forcePushed"}]}