{"pr_number": 10484, "pr_title": "Backport ES changes", "pr_createdAt": "2020-09-03T07:43:27Z", "pr_url": "https://github.com/crate/crate/pull/10484", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg0MDE5OA==", "url": "https://github.com/crate/crate/pull/10484#discussion_r482840198", "bodyText": "Why don't we keep the note related to soft-deletes?", "author": "seut", "createdAt": "2020-09-03T09:29:25Z", "path": "server/src/main/java/org/elasticsearch/index/IndexSettings.java", "diffHunk": "@@ -193,6 +176,24 @@\n     public static final Setting<Long> INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING =\n         Setting.longSetting(\"index.soft_deletes.retention.operations\", 0, 0, Property.IndexScope, Property.Dynamic);\n \n+    /**\n+     * Controls how long translog files that are no longer needed for persistence reasons\n+     * will be kept around before being deleted. A longer retention policy is useful to increase\n+     * the chance of ops based recoveries.", "originalCommit": "8e8d07c5d4101198845872e943ca8901f0b7696d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkxODA5Nw==", "url": "https://github.com/crate/crate/pull/10484#discussion_r482918097", "bodyText": "I thought that the setting was just moved and didn't pay close enough attention to the comment :(\nUpdated it now.", "author": "mfussenegger", "createdAt": "2020-09-03T11:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg0MDE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg0MTAwMA==", "url": "https://github.com/crate/crate/pull/10484#discussion_r482841000", "bodyText": "Same here, afaik the note related to soft-deletes is worth mentioning even that we do not yet enable soft-deletes by default. Otherwise we may miss adding these notes later on.", "author": "seut", "createdAt": "2020-09-03T09:30:40Z", "path": "server/src/main/java/org/elasticsearch/index/IndexSettings.java", "diffHunk": "@@ -193,6 +176,24 @@\n     public static final Setting<Long> INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING =\n         Setting.longSetting(\"index.soft_deletes.retention.operations\", 0, 0, Property.IndexScope, Property.Dynamic);\n \n+    /**\n+     * Controls how long translog files that are no longer needed for persistence reasons\n+     * will be kept around before being deleted. A longer retention policy is useful to increase\n+     * the chance of ops based recoveries.\n+     **/\n+    public static final Setting<TimeValue> INDEX_TRANSLOG_RETENTION_AGE_SETTING =\n+        Setting.timeSetting(\"index.translog.retention.age\", TimeValue.timeValueHours(12), TimeValue.timeValueMillis(-1), Property.Dynamic,\n+            Property.IndexScope);\n+\n+    /**\n+     * Controls how many translog files that are no longer needed for persistence reasons\n+     * will be kept around before being deleted. Keeping more files is useful to increase\n+     * the chance of ops based recoveries.", "originalCommit": "8e8d07c5d4101198845872e943ca8901f0b7696d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff96dbad7265a586c4bcf8f2abf105d832064411", "url": "https://github.com/crate/crate/commit/ff96dbad7265a586c4bcf8f2abf105d832064411", "message": "bp: Remove fileBasedRecovery flag\n\nhttps://github.com/elastic/elasticsearch/commit/6215f98fa68aedbd8f0be10e0064afb45c970e90", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "66962fc387de031ac701ecc69007852e3d62ef1c", "url": "https://github.com/crate/crate/commit/66962fc387de031ac701ecc69007852e3d62ef1c", "message": "bp: Trim local translog in peer recovery\n\nhttps://github.com/elastic/elasticsearch/commit/302d29c87059658f776fb9c22bc76362bd46d0a0", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "c7e380a348d168d69f59c0c08b3d202629b0f0ac", "url": "https://github.com/crate/crate/commit/c7e380a348d168d69f59c0c08b3d202629b0f0ac", "message": "bp: Remove assertion after locally recover replica\n\nhttps://github.com/elastic/elasticsearch/commit/6bb6927151ca7627837e5978e63694507244f3ff", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "7d538943572c1a73e2e6ede7ad8e5452ce15a4ca", "url": "https://github.com/crate/crate/commit/7d538943572c1a73e2e6ede7ad8e5452ce15a4ca", "message": "bp: Call afterWriteOperation after trim translog in peer recovery\n\nhttps://github.com/elastic/elasticsearch/commit/c26f850c4434621fd385b55e90d57270df30e54b", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "d88dd46421a729baa811732189aec4c9133004ba", "url": "https://github.com/crate/crate/commit/d88dd46421a729baa811732189aec4c9133004ba", "message": "bp: Only retain reasonable history for peer recoveries\n\nhttps://github.com/elastic/elasticsearch/commit/fd4acb3e8b7cc88a10ae5c922a62cea719b1c701\n\nSome of the changes - especially in CombinedDeletionPolicy - were\nalready applied as part of https://github.com/crate/crate/commit/dfed1ca79cde0ecfb79e0aa16eca41bf597bfe19\n\nThere we also already pulled in pieces of\nhttps://github.com/elastic/elasticsearch/commit/71a6873e8928f882bd06122f421a586fa6b85f09\nwhich is why our CombinedDeletionPolicy differs", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "3952c47b97cdce74f7feb137dbe18f3f9656a698", "url": "https://github.com/crate/crate/commit/3952c47b97cdce74f7feb137dbe18f3f9656a698", "message": "bp: Set start of the week to Monday for root locale\n\nhttps://github.com/elastic/elasticsearch/commit/8d1ea8651976c40100df65cd58f26cb00325de96", "committedDate": "2020-09-03T11:49:40Z", "type": "commit"}, {"oid": "f1ba34423e07b718cdff02e57dafac39f0c72562", "url": "https://github.com/crate/crate/commit/f1ba34423e07b718cdff02e57dafac39f0c72562", "message": "bp: Ignore translog retention policy if soft-deletes enabled\n\nhttps://github.com/elastic/elasticsearch/commit/b0d346fd7421bf9c470b8cda56f134b10e726d33", "committedDate": "2020-09-03T11:49:40Z", "type": "forcePushed"}, {"oid": "39ca1421687f36582529f8edae2fed3f3641cda2", "url": "https://github.com/crate/crate/commit/39ca1421687f36582529f8edae2fed3f3641cda2", "message": "bp: Ignore translog retention policy if soft-deletes enabled\n\nhttps://github.com/elastic/elasticsearch/commit/b0d346fd7421bf9c470b8cda56f134b10e726d33", "committedDate": "2020-09-03T12:19:30Z", "type": "commit"}, {"oid": "39ca1421687f36582529f8edae2fed3f3641cda2", "url": "https://github.com/crate/crate/commit/39ca1421687f36582529f8edae2fed3f3641cda2", "message": "bp: Ignore translog retention policy if soft-deletes enabled\n\nhttps://github.com/elastic/elasticsearch/commit/b0d346fd7421bf9c470b8cda56f134b10e726d33", "committedDate": "2020-09-03T12:19:30Z", "type": "forcePushed"}]}