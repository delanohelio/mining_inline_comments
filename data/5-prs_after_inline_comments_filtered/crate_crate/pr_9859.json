{"pr_number": 9859, "pr_title": "Fix bug in selecting license object column.", "pr_createdAt": "2020-04-15T09:42:22Z", "pr_url": "https://github.com/crate/crate/pull/9859", "timeline": [{"oid": "33ff36632ae74fc2202d5e8d0bb46d8f06ab74f6", "url": "https://github.com/crate/crate/commit/33ff36632ae74fc2202d5e8d0bb46d8f06ab74f6", "message": "Fix bug in selecting license object column.\n\nSelecting the license object column from sys.cluster results\nin the row with the object that contains null values for its\nkeys even though the license is set and the access to each of\nthe license object key separately return the correct result.", "committedDate": "2020-04-15T09:51:32Z", "type": "forcePushed"}, {"oid": "34e14f4421039e290373f8f17cdf2ce038cfe079", "url": "https://github.com/crate/crate/commit/34e14f4421039e290373f8f17cdf2ce038cfe079", "message": "Fix bug in selecting license object column.\n\nSelecting the license object column from sys.cluster results\nin the row with the object that contains null values for its\nkeys even though the license is set and the access to each of\nthe license object key separately return the correct result.", "committedDate": "2020-04-15T10:20:07Z", "type": "commit"}, {"oid": "34e14f4421039e290373f8f17cdf2ce038cfe079", "url": "https://github.com/crate/crate/commit/34e14f4421039e290373f8f17cdf2ce038cfe079", "message": "Fix bug in selecting license object column.\n\nSelecting the license object column from sys.cluster results\nin the row with the object that contains null values for its\nkeys even though the license is set and the access to each of\nthe license object key separately return the correct result.", "committedDate": "2020-04-15T10:20:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NTY2NQ==", "url": "https://github.com/crate/crate/pull/9859#discussion_r408745665", "bodyText": "How does switching from forFunction to constant fix the issue? Is LicenseData mutated?", "author": "mfussenegger", "createdAt": "2020-04-15T10:38:23Z", "path": "sql/src/main/java/io/crate/expression/reference/sys/cluster/ClusterLicenseExpression.java", "diffHunk": "@@ -59,15 +57,12 @@ public NestableInput getChild(String name) {\n \n     private void fillChildImplementations(LicenseData licenseData) {\n         if (licenseData != null) {\n-            childImplementations.put(EXPIRY_DATE, forFunction(ignored -> {\n-                if (licenseData.expiryDateInMs() == Long.MAX_VALUE) {\n-                    return null;\n-                } else {\n-                    return licenseData.expiryDateInMs();\n-                }\n-            }));\n-            childImplementations.put(ISSUED_TO, forFunction(ignored -> licenseData.issuedTo()));\n-            childImplementations.put(MAX_NODES, forFunction(ignored -> licenseData.maxNumberOfNodes()));\n+            var expiryDateInMs = licenseData.expiryDateInMs() == Long.MAX_VALUE\n+                ? null\n+                : licenseData.expiryDateInMs();\n+            childImplementations.put(EXPIRY_DATE, constant(expiryDateInMs));\n+            childImplementations.put(ISSUED_TO, constant(licenseData.issuedTo()));\n+            childImplementations.put(MAX_NODES, constant(licenseData.maxNumberOfNodes()));", "originalCommit": "34e14f4421039e290373f8f17cdf2ce038cfe079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3MjUwMg==", "url": "https://github.com/crate/crate/pull/9859#discussion_r408772502", "bodyText": "The setNextRow is never called for FuncExpression so calling value on child expression will always result in null. I've checked other implementations of NestedObjectExpression they never use forFunction, so I decided to follow this approach.", "author": "kovrus", "createdAt": "2020-04-15T11:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NTY2NQ=="}], "type": "inlineReview"}]}