{"pr_number": 9915, "pr_title": "New TimeTZType to be returned by scalar function current_time", "pr_createdAt": "2020-05-04T06:41:20Z", "pr_url": "https://github.com/crate/crate/pull/9915", "timeline": [{"oid": "bbc4d8db07481bc91999ce5627d4978bc31661c9", "url": "https://github.com/crate/crate/commit/bbc4d8db07481bc91999ce5627d4978bc31661c9", "message": "Fix postgres.rst", "committedDate": "2020-05-06T17:26:05Z", "type": "forcePushed"}, {"oid": "b347cb1b845a7143bdf102b0d9540a0d38d5909c", "url": "https://github.com/crate/crate/commit/b347cb1b845a7143bdf102b0d9540a0d38d5909c", "message": "Fist idea on how to implement TimeType on an Integer, WIP", "committedDate": "2020-05-06T17:37:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxMzcwNQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421313705", "bodyText": "Why is BOOLEAN allowed here?", "author": "mfussenegger", "createdAt": "2020-05-07T08:01:11Z", "path": "common/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -169,6 +174,7 @@\n         entry(IP.id(), Set.of(STRING.id())),\n         entry(TIMESTAMPZ.id(), Set.of(DOUBLE.id(), LONG.id(), STRING.id(), TIMESTAMP.id())),\n         entry(TIMESTAMP.id(), Set.of(DOUBLE.id(), LONG.id(), STRING.id(), TIMESTAMPZ.id())),\n+        entry(TIME.id(), Set.of(BOOLEAN.id(), STRING.id(), INTEGER.id())),", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNDI2Ng==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421314266", "bodyText": "Is  float -> time really a safe (lossless) conversion?", "author": "mfussenegger", "createdAt": "2020-05-07T08:02:07Z", "path": "common/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -181,11 +187,11 @@\n      * used to store the value)\n      */\n     private static final Map<Integer, Set<DataType>> SAFE_CONVERSIONS = Map.of(\n-        BYTE.id(), Set.of(SHORT, INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n-        SHORT.id(), Set.of(INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n-        INTEGER.id(), Set.of(LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n+        BYTE.id(), Set.of(SHORT, INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n+        SHORT.id(), Set.of(INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n+        INTEGER.id(), Set.of(LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n         LONG.id(), Set.of(TIMESTAMPZ, TIMESTAMP, DOUBLE),\n-        FLOAT.id(), Set.of(DOUBLE));\n+        FLOAT.id(), Set.of(TIME, DOUBLE));", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNjA0OQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421316049", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final int id;\n          \n          \n            \n                private final String name;\n          \n      \n    \n    \n  \n\nGiven that there is only a single instance with fixed types we can remove the attributes and just return the constants. Reduces the memory footprint a bit.", "author": "mfussenegger", "createdAt": "2020-05-07T08:05:17Z", "path": "common/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.ResolverStyle;\n+import java.util.Locale;\n+\n+public final class TimeType extends DataType<Integer> implements FixedWidthType, Streamer<Integer> {\n+\n+    public static final int ID = 19;\n+    public static final String NAME = \"time without time zone\";\n+    public static final TimeType INSTANCE = new TimeType(ID, NAME);\n+\n+\n+    private final int id;\n+    private final String name;\n+", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNjQwOQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421316409", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static int translateFrom(@Nonnull Float number) {\n          \n          \n            \n                public static int translateFrom(float number) {", "author": "mfussenegger", "createdAt": "2020-05-07T08:05:58Z", "path": "common/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.ResolverStyle;\n+import java.util.Locale;\n+\n+public final class TimeType extends DataType<Integer> implements FixedWidthType, Streamer<Integer> {\n+\n+    public static final int ID = 19;\n+    public static final String NAME = \"time without time zone\";\n+    public static final TimeType INSTANCE = new TimeType(ID, NAME);\n+\n+\n+    private final int id;\n+    private final String name;\n+\n+    private TimeType(int id, String name) {\n+        this.id = id;\n+        this.name = name;\n+    }\n+\n+    @Override\n+    public int id() {\n+        return id;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIME;\n+    }\n+\n+    @Override\n+    public Streamer<Integer> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(Integer val1, Integer val2) {\n+        return Integer.compare(val1, val2);\n+    }\n+\n+    @Override\n+    public Integer readValueFrom(StreamInput in) throws IOException {\n+        return in.readBoolean() ? null : in.readInt();\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, Integer v) throws IOException {\n+        out.writeBoolean(v == null);\n+        if (v != null) {\n+            out.writeInt(v);\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return IntegerType.INTEGER_SIZE;\n+    }\n+\n+    @Override\n+    public Integer value(Object value) throws ClassCastException {\n+        if (value == null) {\n+            return null;\n+        }\n+        if (value instanceof String) {\n+            return parseTime((String) value);\n+        }\n+        // float values are treated as \"seconds.milliseconds\"\n+        if (value instanceof Double) {\n+            Double n = (Double) value;\n+            if (n.doubleValue() < Float.MAX_VALUE) {\n+                return translateFrom(n.floatValue());\n+            }\n+            throw new IllegalArgumentException(String.format(\n+                Locale.ENGLISH,\n+                \"value too large [%f] if does not fit in a float\",\n+                value));\n+        }\n+        if (value instanceof Float) {\n+            return translateFrom((Float) value);\n+        }\n+        return value instanceof Integer ? (Integer) value : ((Number) value).intValue();\n+    }\n+\n+    public static int translateFrom(@Nonnull Float number) {", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMxNzcyNg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421317726", "bodyText": "Could you add some docs that explain the allowed input formats and the internal storage format a bit?", "author": "mfussenegger", "createdAt": "2020-05-07T08:08:21Z", "path": "common/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.ResolverStyle;\n+import java.util.Locale;\n+\n+public final class TimeType extends DataType<Integer> implements FixedWidthType, Streamer<Integer> {", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyMDEzMw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421320133", "bodyText": "The conditions seem a bit redundant - maybe this could be changed to avoid the duplicate isTime checks - I think then it would also be easier to read.", "author": "mfussenegger", "createdAt": "2020-05-07T08:12:32Z", "path": "sql/src/main/java/io/crate/analyze/expressions/ExpressionAnalyzer.java", "diffHunk": "@@ -448,13 +449,15 @@ protected Symbol visitExpression(Expression node, ExpressionAnalysisContext cont\n \n         @Override\n         protected Symbol visitCurrentTime(CurrentTime node, ExpressionAnalysisContext context) {\n-            if (!node.getType().equals(CurrentTime.Type.TIMESTAMP)) {\n+            boolean isTime = node.getType().equals(CurrentTime.Type.TIME);\n+            if (!(node.getType().equals(CurrentTime.Type.TIMESTAMP) || isTime)) {\n                 visitExpression(node, context);\n             }\n+            String functionName = isTime ? CurrentTimeFunction.NAME : CurrentTimestampFunction.NAME;", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU2ODgyMw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r428568823", "bodyText": "I have removed the implementation of CurrentTimeFunction from this PR.\nIt was dragged in by mistake, as I rebased from the branch I use for it.\nThe plan is to get TimeType in and then use it to move forward with the function. I'd rather not mix.", "author": "marregui", "createdAt": "2020-05-21T10:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyMDEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyMTMxMA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421321310", "bodyText": "Why does this return Long and TIMESTAMPZ ? Shouldn't this return the new time type?", "author": "mfussenegger", "createdAt": "2020-05-07T08:14:27Z", "path": "sql/src/main/java/io/crate/expression/scalar/timestamp/CurrentTimeFunction.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.expression.scalar.timestamp;\n+\n+import io.crate.data.Input;\n+import io.crate.expression.scalar.ScalarFunctionModule;\n+import io.crate.metadata.FunctionIdent;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.metadata.Scalar;\n+import io.crate.metadata.TransactionContext;\n+import io.crate.metadata.functions.Signature;\n+import io.crate.types.DataTypes;\n+\n+import javax.annotation.Nullable;\n+import java.time.Instant;\n+import java.time.ZoneOffset;\n+import java.time.temporal.ChronoUnit;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public class CurrentTimeFunction extends Scalar<Long, Integer> {\n+\n+    public static final String NAME = \"current_time\";\n+\n+    public static final FunctionInfo INFO = new FunctionInfo(\n+        new FunctionIdent(NAME, List.of(DataTypes.INTEGER)),\n+        DataTypes.TIMESTAMPZ,\n+        FunctionInfo.Type.SCALAR,", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyMzEwNQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421323105", "bodyText": "Using Instant may be a bit expensive for what it does", "author": "mfussenegger", "createdAt": "2020-05-07T08:17:30Z", "path": "sql/src/main/java/io/crate/expression/scalar/timestamp/CurrentTimeFunction.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.expression.scalar.timestamp;\n+\n+import io.crate.data.Input;\n+import io.crate.expression.scalar.ScalarFunctionModule;\n+import io.crate.metadata.FunctionIdent;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.metadata.Scalar;\n+import io.crate.metadata.TransactionContext;\n+import io.crate.metadata.functions.Signature;\n+import io.crate.types.DataTypes;\n+\n+import javax.annotation.Nullable;\n+import java.time.Instant;\n+import java.time.ZoneOffset;\n+import java.time.temporal.ChronoUnit;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public class CurrentTimeFunction extends Scalar<Long, Integer> {\n+\n+    public static final String NAME = \"current_time\";\n+\n+    public static final FunctionInfo INFO = new FunctionInfo(\n+        new FunctionIdent(NAME, List.of(DataTypes.INTEGER)),\n+        DataTypes.TIMESTAMPZ,\n+        FunctionInfo.Type.SCALAR,\n+        Collections.emptySet());\n+\n+    public static void register(ScalarFunctionModule module) {\n+        module.register(\n+            Signature.scalar(\n+                NAME,\n+                DataTypes.INTEGER.getTypeSignature(),\n+                DataTypes.TIMESTAMPZ.getTypeSignature()\n+            ),\n+            (signature, args) -> new CurrentTimeFunction(signature)\n+        );\n+    }\n+\n+    private final Signature signature;\n+\n+    public CurrentTimeFunction(Signature signature) {\n+        this.signature = signature;\n+    }\n+\n+    @Override\n+    @SafeVarargs\n+    public final Long evaluate(TransactionContext txnCtx, Input<Integer>... args) {\n+        long now = txnCtx.currentTimeMillis();\n+        long justDate = Instant\n+            .ofEpochMilli(now)\n+            .atZone(ZoneOffset.UTC)\n+            .truncatedTo(ChronoUnit.DAYS)\n+            .toInstant()\n+            .toEpochMilli();\n+        return CurrentTimestampFunction.applyPrecision(now - justDate, args);", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNTA1OQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421325059", "bodyText": "In PostgreSQL the typlen is 8. Which would imply that we use less storage and that the streaming implementation is not compatible.", "author": "mfussenegger", "createdAt": "2020-05-07T08:20:51Z", "path": "sql/src/main/java/io/crate/protocols/postgres/types/TimeType.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.protocols.postgres.types;\n+\n+import io.netty.buffer.ByteBuf;\n+\n+import javax.annotation.Nonnull;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Locale;\n+\n+import static io.crate.types.TimeType.parseTime;\n+import static io.crate.types.TimeType.formatTime;\n+\n+\n+final class TimeType extends PGType<Integer> {\n+\n+    public static final PGType<Integer> INSTANCE = new TimeType();\n+\n+    private static final int OID = 1083;\n+    private static final int TYPE_MOD = -1;\n+    private static final int TYPE_LEN = 4;", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNTk5OQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421325999", "bodyText": "Why is this necessary?", "author": "mfussenegger", "createdAt": "2020-05-07T08:22:28Z", "path": "sql/src/test/java/io/crate/integrationtests/LuceneQueryBuilderIntegrationTest.java", "diffHunk": "@@ -313,7 +314,10 @@ public void testWhereNotEqualAnyWithLargeArray() throws Exception {\n \n     @Test\n     public void testNullOperators() throws Exception {\n-        DataType<?> type = randomType();\n+        DataType<?> type;\n+        do {\n+           type = randomType();\n+        } while (type == DataTypes.INTERVAL);", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU3MTYwOQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r428571609", "bodyText": "Because you cannot have a column of type interval.\ncr> create table t1(c interval);\nSQLActionException[SQLParseException: Cannot use the type `interval` for column: c]\n\nSQLActionException: 400 Bad Request 4000 SQLParseException: Cannot use the type `interval` for column: c\n\tat io.crate.analyze.AnalyzedColumnDefinition.validate(AnalyzedColumnDefinition.java:369)\n\tat io.crate.analyze.AnalyzedTableElements.finalizeAndValidate(AnalyzedTableElements.java:319)\n\tat io.crate.planner.node.ddl.CreateTablePlan.bind(CreateTablePlan.java:150)\n\tat io.crate.planner.node.ddl.CreateTablePlan.executeOrFail(CreateTablePlan.java:97)\n\tat io.crate.planner.Plan.execute(Plan.java:74)\n       ...", "author": "marregui", "createdAt": "2020-05-21T10:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNTk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMyNjMwOA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r421326308", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ensureYellow();\n          \n      \n    \n    \n  \n\nensureYellow is implicit on CREATE TABLE", "author": "mfussenegger", "createdAt": "2020-05-07T08:22:59Z", "path": "sql/src/test/java/io/crate/integrationtests/SQLTypeMappingTest.java", "diffHunk": "@@ -575,4 +575,15 @@ public void testInsertTimestampPreferMillis() {\n         assertThat((Long) response.rows()[0][0], is(1000L));\n         assertThat((Long) response.rows()[1][0], is(2016L));\n     }\n+\n+    @Test\n+    public void test_insert_time_without_time_zone() {\n+        execute(\"create table eons_table (dt time) \" +\n+                \"clustered into 2 shards with (number_of_replicas=0)\");\n+        ensureYellow();", "originalCommit": "9c039c0436c10d2017eed7295ed74f94aec82d2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f746ad18c19dc0b43e5f56312dfa6c2f74af433f", "url": "https://github.com/crate/crate/commit/f746ad18c19dc0b43e5f56312dfa6c2f74af433f", "message": "Add missing method", "committedDate": "2020-05-11T10:09:11Z", "type": "forcePushed"}, {"oid": "7d4c28784b2faa7212a193ea6382c4de450bd61f", "url": "https://github.com/crate/crate/commit/7d4c28784b2faa7212a193ea6382c4de450bd61f", "message": "Add missing method", "committedDate": "2020-05-21T08:20:30Z", "type": "forcePushed"}, {"oid": "b37861c93ef185dd14de0f637ef7dd92120ed5de", "url": "https://github.com/crate/crate/commit/b37861c93ef185dd14de0f637ef7dd92120ed5de", "message": "Fix TimeType wiring in DataTypes, paying attention to conversions and mapping to lucene long", "committedDate": "2020-05-21T11:50:08Z", "type": "forcePushed"}, {"oid": "e262734e8d3c08935e8c85e04175c08b0306830e", "url": "https://github.com/crate/crate/commit/e262734e8d3c08935e8c85e04175c08b0306830e", "message": "Remove unnecessary translateFrom", "committedDate": "2020-05-22T10:22:16Z", "type": "forcePushed"}, {"oid": "9fd0ca5b4ed1de4c7c7bb84365381d0c92b722ba", "url": "https://github.com/crate/crate/commit/9fd0ca5b4ed1de4c7c7bb84365381d0c92b722ba", "message": "Improve parser, add tests, document the class for clarity", "committedDate": "2020-05-23T18:22:05Z", "type": "forcePushed"}, {"oid": "09bec9092ab9c13daadeb2ae73d3f87ffad7481b", "url": "https://github.com/crate/crate/commit/09bec9092ab9c13daadeb2ae73d3f87ffad7481b", "message": "Conversions", "committedDate": "2020-05-25T15:07:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAyOTA0OA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430029048", "bodyText": "Where is this difference in precision coming from?", "author": "mfussenegger", "createdAt": "2020-05-25T17:36:25Z", "path": "server/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.LocalDate;\n+import java.time.LocalDateTime;\n+import java.time.LocalTime;\n+import java.time.ZoneOffset;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.DateTimeParseException;\n+import java.time.format.ResolverStyle;\n+import java.util.Locale;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Represents time as milliseconds from Jan 1st 1970 (EPOCH), ignoring\n+ * the date portion, the time zone, and storing the value as UTC long.\n+ * <p>\n+ * Accepts two kinds of literal:\n+ * <ol>\n+ *    <li><b>numeric:</b>\n+ *      <ul>\n+ *        <li>short, integer and long values are taken at face value\n+ *        and range checked.</li>\n+ *        <li>double and float values are interpreted as seconds.millis\n+ *        and are range checked. float values loose some precision (milliseconds).\n+ *        </li>\n+ *      </ul>\n+ *    </li>\n+ *\n+ *    <li>text:\n+ *      <ul>\n+ *        <li>hhmmss: e.g. 23:12:21</li>\n+ *        <li>hhmm: e.g. 23:12:00</li>\n+ *        <li>hh: e.g. 23:00:00</li>\n+ *        <li>hhmmss.ffffff: e.g. 23:12:21.999</li>\n+ *        <li>hhmm.ffffff: e.g. 23:12:00.999</li>\n+ *        <li>hh.ffffff: e.g. 23:00:00.999</li>\n+ *        <li>any ISO-8601 extended local time format</li>\n+ *      </ul>\n+ *    </li>\n+ * </ol>\n+ *\n+ * Precision is milli seconds (10e3 in a second, unlike postgres which is", "originalCommit": "09bec9092ab9c13daadeb2ae73d3f87ffad7481b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA0MjA5Mw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430042093", "bodyText": "I store milliseconds from EPOCH, instead of microseconds from midnight (0L). Although I suppose that as EPOCH is also 0L, it would just be a matter of interpretation of the value. I went for milliseconds from epoch to make time look like a timestamp with no date.\nShould I try microseconds?", "author": "marregui", "createdAt": "2020-05-25T18:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAyOTA0OA=="}], "type": "inlineReview"}, {"oid": "76ceeaeafd74cb56f1b360a6c9037ab3458bdea6", "url": "https://github.com/crate/crate/commit/76ceeaeafd74cb56f1b360a6c9037ab3458bdea6", "message": "Cannot create/alter table if column definition of type time", "committedDate": "2020-05-26T13:40:38Z", "type": "forcePushed"}, {"oid": "693bc0d6eb7e0a6a978f63d61bb68ef2d1b73d2e", "url": "https://github.com/crate/crate/commit/693bc0d6eb7e0a6a978f63d61bb68ef2d1b73d2e", "message": "Time is now internally stored as micros", "committedDate": "2020-05-26T18:31:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNzEyMg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430907122", "bodyText": "I think I'd rather be restrictive here for now and not allow any casts unless required for PostgreSQL compatibility (e.g. casting the string to time, but only if done explicitly)", "author": "mfussenegger", "createdAt": "2020-05-27T07:21:06Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -170,6 +175,7 @@\n         entry(IP.id(), Set.of(STRING.id())),\n         entry(TIMESTAMPZ.id(), Set.of(DOUBLE.id(), LONG.id(), STRING.id(), TIMESTAMP.id())),\n         entry(TIMESTAMP.id(), Set.of(DOUBLE.id(), LONG.id(), STRING.id(), TIMESTAMPZ.id())),\n+        entry(TIME.id(), Set.of(DOUBLE.id(), LONG.id(), STRING.id())),", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNzM2NQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430907365", "bodyText": "Similar here. I'd leave TIME out for now.", "author": "mfussenegger", "createdAt": "2020-05-27T07:21:34Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -182,10 +188,11 @@\n      * used to store the value)\n      */\n     private static final Map<Integer, Set<DataType>> SAFE_CONVERSIONS = Map.of(\n-        BYTE.id(), Set.of(SHORT, INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n-        SHORT.id(), Set.of(INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n-        INTEGER.id(), Set.of(LONG, TIMESTAMPZ, TIMESTAMP, FLOAT, DOUBLE),\n-        LONG.id(), Set.of(TIMESTAMPZ, TIMESTAMP, DOUBLE),\n+        BYTE.id(), Set.of(SHORT, INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n+        SHORT.id(), Set.of(INTEGER, LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n+        INTEGER.id(), Set.of(LONG, TIMESTAMPZ, TIMESTAMP, TIME, FLOAT, DOUBLE),\n+        LONG.id(), Set.of(TIMESTAMPZ, TIMESTAMP, TIME, DOUBLE),\n+        DOUBLE.id(), Set.of(TIME),", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNzg5Nw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430907897", "bodyText": "Given that we don't want to support storage yet, can we remove this entry?", "author": "mfussenegger", "createdAt": "2020-05-27T07:22:28Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -380,6 +390,7 @@ private static boolean safeConversionPossible(DataType type1, DataType type2) {\n     );\n \n     private static final Map<Integer, String> TYPE_IDS_TO_MAPPINGS = Map.ofEntries(\n+        entry(TIME.id(), \"long\"),", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwOTY2Mg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430909662", "bodyText": "PostgreSQL doesn't support numeric conversion to time:\nselect 231221.999::time;\nERROR:  42846: cannot cast type numeric to time without time zone\nLINE 1: select 231221.999::time\n\nI think we should also restrict this and not support it.\nCompared to using a string literal, which is supported:\n# select '231221.999'::time;\n     time\n--------------\n 23:12:21.999\n(1 row)", "author": "mfussenegger", "createdAt": "2020-05-27T07:25:42Z", "path": "server/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,277 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.LocalTime;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.DateTimeParseException;\n+import java.time.format.ResolverStyle;\n+import java.time.temporal.ChronoField;\n+import java.util.Locale;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Represents time as microseconds from midnight, ignoring the time\n+ * zone and storing the value as UTC <b>long</b>.\n+ *\n+ * <p>\n+ *\n+ * There are 1000_000 microseconds in one second:\n+ *\n+ * <pre>\n+ *     (24 * 3600 + 59 * 60 + 59) * 1000_000L > Integer.MAX_VALUE\n+ * </pre>\n+ *\n+ * Thus the range for time values is 0 .. 86400000000 (max number\n+ * of micros in a day), where both extremes are equivalent to\n+ * '00:00:00:000000' and '24:00:00.000000' respectively.\n+ *\n+ * <p>\n+ *\n+ * Accepts four kinds of literal:\n+ * <ol>\n+ *    <li>text:\n+ *      <ul>\n+ *        <li>'hhmmss': e.g. '232121', equivalent to '23:12:21'</li>\n+ *        <li>'hhmm': e.g. '2312', equivalent to '23:12:00'</li>\n+ *        <li>'hh': e.g. '23', equivalent to '23:00:00'</li>\n+ *      </ul>\n+ *    </li>\n+ *\n+ *    <li>numeric:\n+ *      <ul>\n+ *        <li>integer and long values are first interpreted as\n+ *        'text'. Failing this they are kept as is, representing\n+ *        microseconds from midnight, ignoring the time zone\n+ *        and storing the value as UTC.\n+ *    </li>\n+ *\n+ *    <li>text high precision:\n+ *      <p>\n+ *      Expects up to six digits after the floating point (number of\n+ *      micro seconds), and it will right pad with zeroes if this is\n+ *      not the case. For instance the examples below are all padded\n+ *      to 999000 micro seconds.\n+ *      <ul>\n+ *        <li>'hhmmss.ffffff': e.g. '231221.999', equivalent to '23:12:21.999'</li>\n+ *        <li>'hhmm.ffffff': e.g. '2312.999', equivalent to '23:12:00.999'</li>\n+ *        <li>'hh.ffffff': e.g. '23.999', equivalent to '23:00:00.999'</li>\n+ *      </ul>\n+ *    </li>\n+ *\n+ *    <li>numeric high precision:\n+ *      <ul>\n+ *        <li>double and float values are interpreted as", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxMDM1OQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430910359", "bodyText": "PostgreSQL also seems to support : inbetween:\nselect '14:32'::time;\n   time\n----------\n 14:32:00\n(1 row)\n\nCan we extend this?", "author": "mfussenegger", "createdAt": "2020-05-27T07:27:00Z", "path": "server/src/main/java/io/crate/types/TimeType.java", "diffHunk": "@@ -0,0 +1,277 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.time.LocalTime;\n+import java.time.format.DateTimeFormatter;\n+import java.time.format.DateTimeFormatterBuilder;\n+import java.time.format.DateTimeParseException;\n+import java.time.format.ResolverStyle;\n+import java.time.temporal.ChronoField;\n+import java.util.Locale;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Represents time as microseconds from midnight, ignoring the time\n+ * zone and storing the value as UTC <b>long</b>.\n+ *\n+ * <p>\n+ *\n+ * There are 1000_000 microseconds in one second:\n+ *\n+ * <pre>\n+ *     (24 * 3600 + 59 * 60 + 59) * 1000_000L > Integer.MAX_VALUE\n+ * </pre>\n+ *\n+ * Thus the range for time values is 0 .. 86400000000 (max number\n+ * of micros in a day), where both extremes are equivalent to\n+ * '00:00:00:000000' and '24:00:00.000000' respectively.\n+ *\n+ * <p>\n+ *\n+ * Accepts four kinds of literal:\n+ * <ol>\n+ *    <li>text:\n+ *      <ul>\n+ *        <li>'hhmmss': e.g. '232121', equivalent to '23:12:21'</li>", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNzM5OA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430907398", "bodyText": "i think we do not need two entries for one type in the precedence", "author": "kovrus", "createdAt": "2020-05-27T07:21:37Z", "path": "server/src/main/java/io/crate/types/DataType.java", "diffHunk": "@@ -52,6 +52,8 @@\n         BYTE,\n         BOOLEAN,\n         SHORT,\n+        TIME_WITHOUT_TIME_ZONE,\n+        TIME,", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNzc1Mg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430907752", "bodyText": "in pg it is just time\ntemplate1=# select typname from pg_catalog.pg_type where oid = 1083;\n typname\n---------\n time\n(1 row)", "author": "kovrus", "createdAt": "2020-05-27T07:22:13Z", "path": "server/src/main/java/io/crate/protocols/postgres/types/TimeType.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.protocols.postgres.types;\n+\n+import io.netty.buffer.ByteBuf;\n+\n+import javax.annotation.Nonnull;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Locale;\n+\n+import static io.crate.types.TimeType.parseTime;\n+import static io.crate.types.TimeType.formatTime;\n+\n+\n+final class TimeType extends PGType<Long> {\n+\n+    public static final PGType<Long> INSTANCE = new TimeType();\n+\n+    private static final int OID = 1083;\n+    private static final int TYPE_MOD = -1;\n+    private static final int TYPE_LEN = 8;\n+    private static final String TYPE_NAME = \"time without time zone\";", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwODU4NQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430908585", "bodyText": "should be removed ?", "author": "kovrus", "createdAt": "2020-05-27T07:23:47Z", "path": "server/src/test/java/io/crate/planner/selectivity/SelectivityFunctionsTest.java", "diffHunk": "@@ -24,6 +25,7 @@\n \n public class SelectivityFunctionsTest extends CrateDummyClusterServiceUnitTest {\n \n+    @Seed(\"BAAF67D01CA68AAE\")", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwOTUwMA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430909500", "bodyText": "maybe extends CrateUnitTest, you also will get  ExpectedException from base class", "author": "kovrus", "createdAt": "2020-05-27T07:25:25Z", "path": "server/src/test/java/io/crate/types/TimeTypeTest.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package io.crate.types;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.util.function.Function;\n+\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+\n+public class TimeTypeTest {\n+\n+    @Rule\n+    public ExpectedException expectedException = ExpectedException.none();", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxMDYwNw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430910607", "bodyText": "this test case has around 60 assertions, is it possible to reduce or split it?", "author": "kovrus", "createdAt": "2020-05-27T07:27:26Z", "path": "server/src/test/java/io/crate/types/TimeTypeTest.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package io.crate.types;\n+\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+\n+import java.util.function.Function;\n+\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertThat;\n+\n+public class TimeTypeTest {\n+\n+    @Rule\n+    public ExpectedException expectedException = ExpectedException.none();\n+\n+    @Test\n+    public void test_parse_time_range_overflow() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [86400000001] is out of range for 'TimeType' [0, 86400000000]\");\n+        TimeType.parseTime(String.valueOf(24 * 3600 * 1000_000L + 1));\n+    }\n+\n+    @Test\n+    public void test_parse_time_range_underflow() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [-86400000000] is out of range for 'TimeType' [0, 86400000000]\");\n+        TimeType.parseTime(String.valueOf(-24 * 3600 * 1000_000L));\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hh() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [25] is out of range for 'hh' [0, 24]\");\n+        TimeType.parseTime(\"25\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hhmm() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [78] is out of range for 'mm' [0, 59]\");\n+        TimeType.parseTime(\"1778\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hhmmss() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [78] is out of range for 'ss' [0, 59]\");\n+        TimeType.parseTime(\"175978\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hh_floating_point() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [25] is out of range for 'hh' [0, 24]\");\n+        TimeType.parseTime(\"25.999999\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hhmm_floating_point() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [78] is out of range for 'mm' [0, 59]\");\n+        TimeType.parseTime(\"1778.999999\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_hhmmss_floating_point() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [78] is out of range for 'ss' [0, 59]\");\n+        TimeType.parseTime(\"175978.999999\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_out_of_range_micros_floating_point() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [9999999] is out of range for 'micros' [0, 999999]\");\n+        TimeType.parseTime(\"00.9999999\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_range_overflow_take_two() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [86400999000] is out of range for 'TimeType' [0, 86400000000]\");\n+        TimeType.parseTime(\"240000.999\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_midnight_when_ISO_parser_does_not_like_it() {\n+        expectedException.expect(IllegalArgumentException.class);\n+        expectedException.expectMessage(\"value [24:00:00.000] is not a valid literal for TimeType\");\n+        TimeType.parseTime(\"24:00:00.000\");\n+    }\n+\n+    @Test\n+    public void test_parse_time_midnight_when_ISO_parser_does_like_it() {\n+        assertThat(TimeType.parseTime(\"240000.000\"), is(24 * 60 * 60 * 1000_000L));\n+    }\n+\n+    @Test\n+    public void test_parse_time_should_always_ignore_time_zone() {\n+        assertThat(TimeType.parseTime(\"01:00:00Z\"), is(3600000000L));\n+        assertThat(TimeType.parseTime(\"01:00:00+00\"), is(3600000000L));\n+        assertThat(TimeType.parseTime(\"04:00:00-03:00\"), is(14400000000L));\n+        assertThat(TimeType.parseTime(\"04:00:00+0300\"), is(14400000000L));\n+        assertThat(TimeType.parseTime(\"04:00:00+03:00\"), is(14400000000L));\n+        assertThat(TimeType.parseTime(\"04:00:00.123456789+03:00\"), is(14400123456L));\n+        assertThat(TimeType.parseTime(\"04:00:00+0000\"), is(14400000000L));\n+        assertThat(TimeType.parseTime(\"04:00:00.123456789-0000\"), is(14400123456L));\n+    }\n+\n+    @Test\n+    public void test_parse_time_no_time_zone_explicitly_mentioned() {\n+        assertThat(TimeType.parseTime(\"04:00:00\"), is(14400000000L));\n+        assertThat(TimeType.parseTime(\"14400000\"), is(14400000L));\n+        assertThat(TimeType.parseTime(\"04:00:00.123456789\"), is(14400123456L));\n+        assertThat(TimeType.parseTime(\"14400123\"), is(14400123L));\n+    }\n+\n+    @Test\n+    public void test_format_time() {\n+        assertThat(TimeType.formatTime(14400000000L), is(\"04:00:00\"));\n+        assertThat(TimeType.formatTime(14400123000L), is(\"04:00:00.123\"));\n+    }\n+\n+    @Test\n+    public void test_value() {", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxMjEwMg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430912102", "bodyText": "is there a mapping with the time without time zonename?", "author": "kovrus", "createdAt": "2020-05-27T07:30:11Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -360,7 +369,8 @@ private static boolean safeConversionPossible(DataType type1, DataType type2) {\n     }\n \n     private static final Map<String, DataType> MAPPING_NAMES_TO_TYPES = Map.ofEntries(\n-        entry(\"date\", DataTypes.TIMESTAMPZ),\n+        entry(\"time\", DataTypes.TIME),\n+        entry(DataTypes.TIME.getName(), DataTypes.TIME),", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxMzI2MQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r430913261", "bodyText": "why date is removed?", "author": "kovrus", "createdAt": "2020-05-27T07:32:34Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -360,7 +369,8 @@ private static boolean safeConversionPossible(DataType type1, DataType type2) {\n     }\n \n     private static final Map<String, DataType> MAPPING_NAMES_TO_TYPES = Map.ofEntries(\n-        entry(\"date\", DataTypes.TIMESTAMPZ),", "originalCommit": "f4c87e68a1a2ab5892ca3f18da647d52ee1e45f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "918d137534f32ff19b17e360e2d27467ac187cbe", "url": "https://github.com/crate/crate/commit/918d137534f32ff19b17e360e2d27467ac187cbe", "message": "Fix style", "committedDate": "2020-05-28T19:06:57Z", "type": "forcePushed"}, {"oid": "8700fd3699eff185f7416a200f8f7b5fe1f163e8", "url": "https://github.com/crate/crate/commit/8700fd3699eff185f7416a200f8f7b5fe1f163e8", "message": "Make TimeTZType a 12 byte structure, long for micros from midnight, int for secs from UTC (WIP)", "committedDate": "2020-06-01T07:29:12Z", "type": "forcePushed"}, {"oid": "830673911fdaeae8e8686f9ea589c504f964b46e", "url": "https://github.com/crate/crate/commit/830673911fdaeae8e8686f9ea589c504f964b46e", "message": "Fixup", "committedDate": "2020-06-02T16:37:48Z", "type": "forcePushed"}, {"oid": "e6da852a73a8a9d14255471e2b013dcdee638410", "url": "https://github.com/crate/crate/commit/e6da852a73a8a9d14255471e2b013dcdee638410", "message": "Cosmetics", "committedDate": "2020-06-03T08:35:47Z", "type": "forcePushed"}, {"oid": "684e366e25824529b81d578a35e94b841e08e1e3", "url": "https://github.com/crate/crate/commit/684e366e25824529b81d578a35e94b841e08e1e3", "message": "Fix indentation", "committedDate": "2020-06-03T09:23:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzMTcwMA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434431700", "bodyText": "does this time with time zone mapping exist?", "author": "kovrus", "createdAt": "2020-06-03T09:26:02Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -360,6 +366,8 @@ private static boolean safeConversionPossible(DataType type1, DataType type2) {\n     }\n \n     private static final Map<String, DataType> MAPPING_NAMES_TO_TYPES = Map.ofEntries(\n+        entry(DataTypes.TIMETZ.getName(), DataTypes.TIMETZ),", "originalCommit": "684e366e25824529b81d578a35e94b841e08e1e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUyOTQ0NA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434529444", "bodyText": "Nope, with the question I realised, thank you:\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html", "author": "marregui", "createdAt": "2020-06-03T12:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzMTcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzNzUzNA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434437534", "bodyText": "Maybe TimeTZParser.formatTime, because of class TimeTZType extends DataType<TimeTZ>?", "author": "kovrus", "createdAt": "2020-06-03T09:35:38Z", "path": "server/src/main/java/io/crate/types/TimeTZ.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import java.util.Objects;\n+\n+\n+public final class TimeTZ implements Comparable<TimeTZ> {\n+\n+    private final long microsFromMidnight;\n+    private final int secondsFromUTC;\n+\n+    public TimeTZ(long microsFromMidnight, int secondsFromUTC) {\n+        this.microsFromMidnight = microsFromMidnight;\n+        this.secondsFromUTC = secondsFromUTC;\n+    }\n+\n+    public long getMicrosFromMidnight() {\n+        return microsFromMidnight;\n+    }\n+\n+    public int getSecondsFromUTC() {\n+        return secondsFromUTC;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || false == o instanceof TimeTZ) {\n+            return false;\n+        }\n+        TimeTZ that = (TimeTZ) o;\n+        return microsFromMidnight == that.microsFromMidnight && secondsFromUTC == that.secondsFromUTC;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(microsFromMidnight, secondsFromUTC);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return TimeTZType.formatTime(this);", "originalCommit": "684e366e25824529b81d578a35e94b841e08e1e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzMDg1Nw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434530857", "bodyText": "keen eye!", "author": "marregui", "createdAt": "2020-06-03T12:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzNzUzNA=="}], "type": "inlineReview"}, {"oid": "b6abf87a63a616deeaccfd37c8ed3252a7427923", "url": "https://github.com/crate/crate/commit/b6abf87a63a616deeaccfd37c8ed3252a7427923", "message": "Remove non existing mapping", "committedDate": "2020-06-03T12:28:49Z", "type": "forcePushed"}, {"oid": "8847d6d6c27e55f135fb9368a84c4085fb079019", "url": "https://github.com/crate/crate/commit/8847d6d6c27e55f135fb9368a84c4085fb079019", "message": "Fix oid name", "committedDate": "2020-06-03T13:46:17Z", "type": "forcePushed"}, {"oid": "57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "url": "https://github.com/crate/crate/commit/57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "message": "Fix message, holly molly", "committedDate": "2020-06-03T15:05:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NDUyMQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434664521", "bodyText": "Not sure if there is much value in re-exporting these functions here. Either TimeTZ could have a formatTime directly, or TimeTZParser.formatTime could be used directly.", "author": "mfussenegger", "createdAt": "2020-06-03T15:41:04Z", "path": "server/src/main/java/io/crate/types/TimeTZType.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+\n+import static io.crate.types.TimeTZParser.timeTZOf;\n+import static io.crate.types.TimeTZParser.exceptionForInvalidLiteral;\n+\n+public final class TimeTZType extends DataType<TimeTZ> implements FixedWidthType, Streamer<TimeTZ> {\n+\n+    public static final int ID = 19;\n+    public static final int TYPE_LEN = 12;\n+    public static final String NAME = \"timetz\";\n+    public static final TimeTZType INSTANCE = new TimeTZType();\n+\n+\n+    @Override\n+    public int id() {\n+        return ID;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIMETZ;\n+    }\n+\n+    @Override\n+    public Streamer<TimeTZ> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(TimeTZ val1, TimeTZ val2) {\n+        return val1.compareTo(val2);\n+    }\n+\n+    @Override\n+    public TimeTZ readValueFrom(StreamInput in) throws IOException {\n+        if (in.readBoolean()) {\n+            return null;\n+        }\n+        return new TimeTZ(in.readLong(), in.readInt());\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, TimeTZ tz) throws IOException {\n+        out.writeBoolean(tz == null);\n+        if (tz != null) {\n+            out.writeLong(tz.getMicrosFromMidnight());\n+            out.writeInt(tz.getSecondsFromUTC());\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return TYPE_LEN;\n+    }\n+\n+    @Override\n+    public TimeTZ value(Object value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if (value instanceof TimeTZ) {\n+            return (TimeTZ) value;\n+        }\n+        if (value instanceof String) {\n+            try {\n+                return parseTime((String) value);\n+            } catch (IllegalArgumentException e0) {\n+                try {\n+                    return timeTZOf(\n+                        TimeTZType.class.getSimpleName(),\n+                        Long.valueOf((String) value));\n+                } catch (NumberFormatException e1) {\n+                    throw exceptionForInvalidLiteral(value);\n+                }\n+            }\n+        }\n+        throw exceptionForInvalidLiteral(value);\n+    }\n+\n+    public static String formatTime(@Nonnull TimeTZ time) {", "originalCommit": "57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NTExNg==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434665116", "bodyText": "Same here. Consumers could use TimeTZParser.parse directly, or maybe there could be a TimeTZ.parse and the TimeTZParser could become package private.", "author": "mfussenegger", "createdAt": "2020-06-03T15:41:52Z", "path": "server/src/main/java/io/crate/types/TimeTZType.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+\n+import static io.crate.types.TimeTZParser.timeTZOf;\n+import static io.crate.types.TimeTZParser.exceptionForInvalidLiteral;\n+\n+public final class TimeTZType extends DataType<TimeTZ> implements FixedWidthType, Streamer<TimeTZ> {\n+\n+    public static final int ID = 19;\n+    public static final int TYPE_LEN = 12;\n+    public static final String NAME = \"timetz\";\n+    public static final TimeTZType INSTANCE = new TimeTZType();\n+\n+\n+    @Override\n+    public int id() {\n+        return ID;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIMETZ;\n+    }\n+\n+    @Override\n+    public Streamer<TimeTZ> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(TimeTZ val1, TimeTZ val2) {\n+        return val1.compareTo(val2);\n+    }\n+\n+    @Override\n+    public TimeTZ readValueFrom(StreamInput in) throws IOException {\n+        if (in.readBoolean()) {\n+            return null;\n+        }\n+        return new TimeTZ(in.readLong(), in.readInt());\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, TimeTZ tz) throws IOException {\n+        out.writeBoolean(tz == null);\n+        if (tz != null) {\n+            out.writeLong(tz.getMicrosFromMidnight());\n+            out.writeInt(tz.getSecondsFromUTC());\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return TYPE_LEN;\n+    }\n+\n+    @Override\n+    public TimeTZ value(Object value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if (value instanceof TimeTZ) {\n+            return (TimeTZ) value;\n+        }\n+        if (value instanceof String) {\n+            try {\n+                return parseTime((String) value);\n+            } catch (IllegalArgumentException e0) {\n+                try {\n+                    return timeTZOf(\n+                        TimeTZType.class.getSimpleName(),\n+                        Long.valueOf((String) value));\n+                } catch (NumberFormatException e1) {\n+                    throw exceptionForInvalidLiteral(value);\n+                }\n+            }\n+        }\n+        throw exceptionForInvalidLiteral(value);\n+    }\n+\n+    public static String formatTime(@Nonnull TimeTZ time) {\n+        return TimeTZParser.formatTime(time);\n+    }\n+\n+    public static TimeTZ parseTime(@Nonnull String time) {\n+        return TimeTZParser.parse(time);\n+    }", "originalCommit": "57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NTg1OA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434665858", "bodyText": "I still don't really undestand why this change became necessary within this PR? That interval cannot be stored isn't new. Did randomType change in some unrelated way?", "author": "mfussenegger", "createdAt": "2020-06-03T15:42:54Z", "path": "server/src/test/java/io/crate/integrationtests/LuceneQueryBuilderIntegrationTest.java", "diffHunk": "@@ -313,7 +314,10 @@ public void testWhereNotEqualAnyWithLargeArray() throws Exception {\n \n     @Test\n     public void testNullOperators() throws Exception {\n-        DataType<?> type = randomType();\n+        DataType<?> type;\n+        do {\n+           type = randomType();\n+        } while (type == DataTypes.INTERVAL);", "originalCommit": "57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NzU3Mw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434667573", "bodyText": "These additions here shouldn't be necessary anymore, since TIMETZ is no longer part of the allowed conversions for BYTE.", "author": "mfussenegger", "createdAt": "2020-06-03T15:45:18Z", "path": "server/src/test/java/io/crate/types/TypeConversionTest.java", "diffHunk": "@@ -97,6 +98,8 @@ public void numberConversionTest() throws Exception {\n                 var t = DataTypes.fromId(id);\n                 if (t.equals(DataTypes.IP)) {\n                     byteVal = (byte) Math.abs(byteVal == Byte.MIN_VALUE ? byteVal >> 1 : byteVal);\n+                } else if (t.equals(DataTypes.TIMETZ)) {", "originalCommit": "57a24eb2d64e801b5e2092f4a5af5e54ecc82143", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2ce6b01172c13642e76c620b62c792d6e828707", "url": "https://github.com/crate/crate/commit/b2ce6b01172c13642e76c620b62c792d6e828707", "message": "Fix tests", "committedDate": "2020-06-03T19:14:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MDg2Mw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r434880863", "bodyText": "TIMETZ name does not contain spaces.", "author": "kovrus", "createdAt": "2020-06-03T21:57:39Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -90,6 +92,7 @@\n     public static Set<String> PRIMITIVE_TYPE_NAMES_WITH_SPACES = Set.of(\n         TIMESTAMPZ.getName(),\n         TIMESTAMP.getName(),\n+        TIMETZ.getName(),", "originalCommit": "b2ce6b01172c13642e76c620b62c792d6e828707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b73bf96560090896774dd93ab9dddb20da1a3b7b", "url": "https://github.com/crate/crate/commit/b73bf96560090896774dd93ab9dddb20da1a3b7b", "message": "Simplify parser/formatter", "committedDate": "2020-06-04T10:37:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDI4NA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435764284", "bodyText": "Shouldn't the type name be time with time zone, see https://www.postgresql.org/docs/9.1/datatype-datetime.html and timetz would be an alias?\n\ntimetz is a valid alias for time with time zone.\n\nYou have documented it as it supposedly has to be, but in implementation it is another way around.", "author": "kovrus", "createdAt": "2020-06-05T08:20:35Z", "path": "server/src/main/java/io/crate/types/DataTypes.java", "diffHunk": "@@ -346,6 +350,7 @@ private static boolean safeConversionPossible(DataType type1, DataType type2) {\n         entry(\"string\", STRING),\n         entry(\"varchar\", STRING),\n         entry(\"character varying\", STRING),\n+        entry(\"time with time zone\", TIMETZ),", "originalCommit": "2bd296f89274f987f54d87f0a4d6f7049ccb2e24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc4MjU2MA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435782560", "bodyText": "ok, yes, I suppose I need to declare it as time with time zone, but make sure that it ends up as timetz in here.", "author": "marregui", "createdAt": "2020-06-05T08:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTI3NQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435771275", "bodyText": "You catch only NumberFormatException which could be thrown by Long.valueOf, but timeTZOf-> checkRange could throw IllegalArgumentException that is not handled.", "author": "kovrus", "createdAt": "2020-06-05T08:33:11Z", "path": "server/src/main/java/io/crate/types/TimeTZType.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import java.io.IOException;\n+\n+import static io.crate.types.TimeTZParser.timeTZOf;\n+import static io.crate.types.TimeTZParser.exceptionForInvalidLiteral;\n+\n+public final class TimeTZType extends DataType<TimeTZ> implements FixedWidthType, Streamer<TimeTZ> {\n+\n+    public static final int ID = 19;\n+    public static final int TYPE_LEN = 12;\n+    public static final String NAME = \"timetz\";\n+    public static final TimeTZType INSTANCE = new TimeTZType();\n+\n+\n+    @Override\n+    public int id() {\n+        return ID;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIMETZ;\n+    }\n+\n+    @Override\n+    public Streamer<TimeTZ> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(TimeTZ val1, TimeTZ val2) {\n+        return val1.compareTo(val2);\n+    }\n+\n+    @Override\n+    public TimeTZ readValueFrom(StreamInput in) throws IOException {\n+        if (in.readBoolean()) {\n+            return null;\n+        }\n+        return new TimeTZ(in.readLong(), in.readInt());\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, TimeTZ tz) throws IOException {\n+        out.writeBoolean(tz == null);\n+        if (tz != null) {\n+            out.writeLong(tz.getMicrosFromMidnight());\n+            out.writeInt(tz.getSecondsFromUTC());\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return TYPE_LEN;\n+    }\n+\n+    @Override\n+    public TimeTZ value(Object value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if (value instanceof TimeTZ) {\n+            return (TimeTZ) value;\n+        }\n+        if (value instanceof String) {\n+            try {\n+                return TimeTZParser.parse((String) value);\n+            } catch (IllegalArgumentException e0) {\n+                try {\n+                    return timeTZOf(\n+                        TimeTZType.class.getSimpleName(),\n+                        Long.valueOf((String) value));\n+                } catch (NumberFormatException e1) {", "originalCommit": "2bd296f89274f987f54d87f0a4d6f7049ccb2e24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc4NTc4NA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435785784", "bodyText": "IllegalArgumentException is what I throw to issue a problem with the format, including range fail:\n static IllegalArgumentException exceptionForInvalidLiteral(Object literal) {\n        throw new IllegalArgumentException(String.format(\n            Locale.ENGLISH,\n            \"value [%s] is not a valid literal for %s\",\n            literal, TimeTZType.class.getSimpleName()));\n    }", "author": "marregui", "createdAt": "2020-06-05T08:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTQ4Nw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435771487", "bodyText": "I'm not sure if this is the best representation for HTTP.\n@seut Do you have any inputs here how we should represent time with time zone to users via HTTP?", "author": "mfussenegger", "createdAt": "2020-06-05T08:33:31Z", "path": "server/src/main/java/io/crate/types/DataTypeXContentExtension.java", "diffHunk": "@@ -63,6 +63,13 @@\n                     b.value(row.get(i));\n                 }\n                 b.endArray();\n+            }),\n+            Map.entry(TimeTZ.class, (b, v) -> {\n+                TimeTZ timetz = (TimeTZ) v;\n+                b.startArray();\n+                b.value(timetz.getMicrosFromMidnight());\n+                b.value(timetz.getSecondsFromUTC());\n+                b.endArray();", "originalCommit": "2b3bebd0f04dee6dd40e008fc3208cd953d6cd63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NzA0OA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435777048", "bodyText": "I was not sure either, but as it makes the micros offset, as well as the seconds offset, explicit, I went with it. Please let me know your thoughts.", "author": "marregui", "createdAt": "2020-06-05T08:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3NjA0MQ==", "url": "https://github.com/crate/crate/pull/9915#discussion_r435876041", "bodyText": "I guess it makes sense to keep it in a format that is easy to parse for clients - we do the same for timestamp (long instead of text format)\nWe also have to extend the documentation here:\n\n  \n    \n      crate/docs/interfaces/http.rst\n    \n    \n        Lines 233 to 237\n      in\n      e09e00d\n    \n    \n    \n    \n\n        \n          \n           IDs of all currently available data types: \n        \n\n        \n          \n            \n        \n\n        \n          \n           ===== =================== \n        \n\n        \n          \n           ID    Data Type \n        \n\n        \n          \n           ===== =================== \n        \n    \n  \n\n\nand we should probably also follow up:\n\nAdd the time to the python client (mapping it to datetime.time)\ninterpreting it in the Admin UI. (To have a human readable display as well)\n\ncc @autophagy", "author": "mfussenegger", "createdAt": "2020-06-05T12:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTQ4Nw=="}], "type": "inlineReview"}, {"oid": "1fd3f603f226529804c48352df5a217b3c37621e", "url": "https://github.com/crate/crate/commit/1fd3f603f226529804c48352df5a217b3c37621e", "message": "Mention that timetz cannot be used in create/alter statements", "committedDate": "2020-06-05T08:46:50Z", "type": "forcePushed"}, {"oid": "d65e18a7846053ee99a3e40191d0c6abac87d5cc", "url": "https://github.com/crate/crate/commit/d65e18a7846053ee99a3e40191d0c6abac87d5cc", "message": "Make the type name be `time with time zone` and `timetz` an alias", "committedDate": "2020-06-07T18:05:16Z", "type": "forcePushed"}, {"oid": "f2d8d7ee21d4bc05efe635cf1e26c70cc8b59b83", "url": "https://github.com/crate/crate/commit/f2d8d7ee21d4bc05efe635cf1e26c70cc8b59b83", "message": "Improve javadoc", "committedDate": "2020-06-08T14:29:50Z", "type": "forcePushed"}, {"oid": "e741d79ca700d214fe4e34812bddd47a604ffa9f", "url": "https://github.com/crate/crate/commit/e741d79ca700d214fe4e34812bddd47a604ffa9f", "message": "Reformat table to 'list-table' and describe timetz lazily", "committedDate": "2020-06-09T19:38:27Z", "type": "forcePushed"}, {"oid": "048aabf85ea6a6c24a509cfc55527f293a526b62", "url": "https://github.com/crate/crate/commit/048aabf85ea6a6c24a509cfc55527f293a526b62", "message": "Change timetz type's id to 20", "committedDate": "2020-06-10T18:29:11Z", "type": "forcePushed"}, {"oid": "8f7c141b9d1870e238715397f3e155d4355c0ea9", "url": "https://github.com/crate/crate/commit/8f7c141b9d1870e238715397f3e155d4355c0ea9", "message": "Change timetz type's id to 20", "committedDate": "2020-06-11T08:36:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY0MDAxMA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r438640010", "bodyText": "Maybe this part can be moved into the method that is responsible for the cast now https://github.com/crate/crate/blob/master/server/src/main/java/io/crate/types/DataType.java#L93 It is the correct place for the cast routine and would simplify future refactoring/removing/renaming of the DataType#value.\nand the DataType#value can be probably just or smth like that\npublic TimeTZ value(Object value) {\n        if (value == null) {\n            return null;\n        }\n        return (TimeTZ) value;\n}", "author": "kovrus", "createdAt": "2020-06-11T08:54:28Z", "path": "server/src/main/java/io/crate/types/TimeTZType.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import java.io.IOException;\n+\n+import static io.crate.types.TimeTZParser.timeTZOf;\n+import static io.crate.types.TimeTZParser.exceptionForInvalidLiteral;\n+\n+public final class TimeTZType extends DataType<TimeTZ> implements FixedWidthType, Streamer<TimeTZ> {\n+\n+    public static final int ID = 20;\n+    public static final int TYPE_LEN = 12;\n+    public static final String NAME = \"time with time zone\";\n+    public static final TimeTZType INSTANCE = new TimeTZType();\n+\n+\n+    @Override\n+    public int id() {\n+        return ID;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIMETZ;\n+    }\n+\n+    @Override\n+    public Streamer<TimeTZ> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(TimeTZ val1, TimeTZ val2) {\n+        return val1.compareTo(val2);\n+    }\n+\n+    @Override\n+    public TimeTZ readValueFrom(StreamInput in) throws IOException {\n+        if (in.readBoolean()) {\n+            return null;\n+        }\n+        return new TimeTZ(in.readLong(), in.readInt());\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, TimeTZ tz) throws IOException {\n+        out.writeBoolean(tz == null);\n+        if (tz != null) {\n+            out.writeLong(tz.getMicrosFromMidnight());\n+            out.writeInt(tz.getSecondsFromUTC());\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return TYPE_LEN;\n+    }\n+\n+    @Override\n+    public TimeTZ value(Object value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if (value instanceof TimeTZ) {\n+            return (TimeTZ) value;\n+        }\n+        if (value instanceof String) {", "originalCommit": "8f7c141b9d1870e238715397f3e155d4355c0ea9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY0MDU3Mw==", "url": "https://github.com/crate/crate/pull/9915#discussion_r438640573", "bodyText": "is it needed?", "author": "kovrus", "createdAt": "2020-06-11T08:55:19Z", "path": "server/src/test/java/io/crate/integrationtests/LuceneQueryBuilderIntegrationTest.java", "diffHunk": "@@ -24,6 +24,7 @@\n import com.carrotsearch.randomizedtesting.annotations.Seed;\n import io.crate.testing.DataTypeTesting;\n import io.crate.types.DataType;\n+import io.crate.types.DataTypes;", "originalCommit": "0b66904d3c51d996939b741ea44a9cab836f5a6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "946b493745c0071ddf47ee07eeccce414a81cff1", "url": "https://github.com/crate/crate/commit/946b493745c0071ddf47ee07eeccce414a81cff1", "message": "Make use of implicitCast", "committedDate": "2020-06-11T09:59:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4Mjg1MA==", "url": "https://github.com/crate/crate/pull/9915#discussion_r438782850", "bodyText": "DataType#value must not call DataType#implicitCast and perform the casting.\nYou would probably also have to adjust tests accordingly.\nI'll copy-paste jordi's comment from the slack discussion regarding refactoring DataType and splitting\nDataType#value for a better context.\nBasically what I'm proposing is to split up value into multiple use cases because\nright now it is a bit overloaded:\n- cast, with a comment that this is only to be used via the cast function\n CastFunction, supports explicit/try/implicit\n- valueForInsert - for the new implicit whitespace truncation case\n- santizeType - for the cases where we currently use dataType#value to fix\na type read from source or so where an integer might have been stored as long\n(This is mostly in the reference resolvers / column expression implementations)\n\nFor the timetz it seems that it'd be enough to implement the implicitCast, which is done already and keep the DataType#value as it was suggested in the previous comment.", "author": "kovrus", "createdAt": "2020-06-11T13:32:11Z", "path": "server/src/main/java/io/crate/types/TimeTZType.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.types;\n+\n+import io.crate.Streamer;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import java.io.IOException;\n+\n+import static io.crate.types.TimeTZParser.timeTZOf;\n+import static io.crate.types.TimeTZParser.exceptionForInvalidLiteral;\n+\n+public final class TimeTZType extends DataType<TimeTZ> implements FixedWidthType, Streamer<TimeTZ> {\n+\n+    public static final int ID = 20;\n+    public static final int TYPE_LEN = 12;\n+    public static final String NAME = \"time with time zone\";\n+    public static final TimeTZType INSTANCE = new TimeTZType();\n+\n+\n+    @Override\n+    public int id() {\n+        return ID;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Precedence precedence() {\n+        return Precedence.TIMETZ;\n+    }\n+\n+    @Override\n+    public Streamer<TimeTZ> streamer() {\n+        return this;\n+    }\n+\n+    @Override\n+    public int compare(TimeTZ val1, TimeTZ val2) {\n+        return val1.compareTo(val2);\n+    }\n+\n+    @Override\n+    public TimeTZ readValueFrom(StreamInput in) throws IOException {\n+        if (in.readBoolean()) {\n+            return null;\n+        }\n+        return new TimeTZ(in.readLong(), in.readInt());\n+    }\n+\n+    @Override\n+    public void writeValueTo(StreamOutput out, TimeTZ tz) throws IOException {\n+        out.writeBoolean(tz == null);\n+        if (tz != null) {\n+            out.writeLong(tz.getMicrosFromMidnight());\n+            out.writeInt(tz.getSecondsFromUTC());\n+        }\n+    }\n+\n+    @Override\n+    public int fixedSize() {\n+        return TYPE_LEN;\n+    }\n+\n+    @Override\n+    public TimeTZ implicitCast(Object value) {\n+        if (value instanceof String) {\n+            try {\n+                return TimeTZParser.parse((String) value);\n+            } catch (IllegalArgumentException e0) {\n+                try {\n+                    return timeTZOf(\n+                        TimeTZType.class.getSimpleName(),\n+                        Long.valueOf((String) value));\n+                } catch (NumberFormatException e1) {\n+                    throw exceptionForInvalidLiteral(value);\n+                }\n+            }\n+        }\n+        throw exceptionForInvalidLiteral(value);\n+    }\n+\n+    @Override\n+    public TimeTZ value(Object value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        return value instanceof TimeTZ ? (TimeTZ) value : implicitCast(value);", "originalCommit": "946b493745c0071ddf47ee07eeccce414a81cff1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "923e57475fb62e221621a623ceeb7510c8dd182e", "url": "https://github.com/crate/crate/commit/923e57475fb62e221621a623ceeb7510c8dd182e", "message": "Correct documentation, note regarding use of type in create/alter", "committedDate": "2020-06-15T10:16:47Z", "type": "forcePushed"}, {"oid": "16174e93b7807b92025e09b4c1fec121fe121352", "url": "https://github.com/crate/crate/commit/16174e93b7807b92025e09b4c1fec121fe121352", "message": "Add type \"time with time zone\", alias timetz\n\nThis type is used as return value for time related functions, such as\n\"current_time\".\nLiterals can be constructed using a string literal and a cast. Syntax\nfor the string literal:\n\ntime-element [offset]\n\n    time-element: time-only [fraction]\n    time-only:    HH[[:][mm[:]ss]]\n    fraction:     '.' digit+\n    offset:       {+ | -} time-only | geo-region\n    geo-region:   As defined by ISO 8601.\n\nfraction accepts up to 6 digits, delivering microsecond precision.\nThe type cannot be used in CREATE/ALTER statements.", "committedDate": "2020-06-15T11:08:04Z", "type": "forcePushed"}, {"oid": "6b165196499a5657448094dedd485d53bc820673", "url": "https://github.com/crate/crate/commit/6b165196499a5657448094dedd485d53bc820673", "message": "Add type \"time with time zone\", alias timetz\n\nThis type is used as return value for time related functions, such as\n\"current_time\".\nLiterals can be constructed using a string literal and a cast. Syntax\nfor the string literal:\n\ntime-element [offset]\n\n    time-element: time-only [fraction]\n    time-only:    HH[[:][mm[:]ss]]\n    fraction:     '.' digit+\n    offset:       {+ | -} time-only | geo-region\n    geo-region:   As defined by ISO 8601.\n\nfraction accepts up to 6 digits, delivering microsecond precision.\nThe type cannot be used in CREATE/ALTER statements.", "committedDate": "2020-06-16T08:29:18Z", "type": "forcePushed"}, {"oid": "cbe8a7371a0fb45d0f2e350cbccc391bec898e32", "url": "https://github.com/crate/crate/commit/cbe8a7371a0fb45d0f2e350cbccc391bec898e32", "message": "Add type \"time with time zone\", alias timetz\n\nThis type is used as return value for time related functions, such as\n\"current_time\".\nLiterals can be constructed using a string literal and a cast. Syntax\nfor the string literal:\n\ntime-element [offset]\n\n    time-element: time-only [fraction]\n    time-only:    HH[[:][mm[:]ss]]\n    fraction:     '.' digit+\n    offset:       {+ | -} time-only | geo-region\n    geo-region:   As defined by ISO 8601.\n\nfraction accepts up to 6 digits, delivering microsecond precision.\nThe type cannot be used in CREATE/ALTER statements.", "committedDate": "2020-06-16T09:23:15Z", "type": "commit"}, {"oid": "cbe8a7371a0fb45d0f2e350cbccc391bec898e32", "url": "https://github.com/crate/crate/commit/cbe8a7371a0fb45d0f2e350cbccc391bec898e32", "message": "Add type \"time with time zone\", alias timetz\n\nThis type is used as return value for time related functions, such as\n\"current_time\".\nLiterals can be constructed using a string literal and a cast. Syntax\nfor the string literal:\n\ntime-element [offset]\n\n    time-element: time-only [fraction]\n    time-only:    HH[[:][mm[:]ss]]\n    fraction:     '.' digit+\n    offset:       {+ | -} time-only | geo-region\n    geo-region:   As defined by ISO 8601.\n\nfraction accepts up to 6 digits, delivering microsecond precision.\nThe type cannot be used in CREATE/ALTER statements.", "committedDate": "2020-06-16T09:23:15Z", "type": "forcePushed"}]}