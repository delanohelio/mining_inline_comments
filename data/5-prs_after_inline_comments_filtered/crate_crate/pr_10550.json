{"pr_number": 10550, "pr_title": "Add support for `SET AND RESET SESSION AUTHORIZATION` statements.", "pr_createdAt": "2020-09-16T14:57:23Z", "pr_url": "https://github.com/crate/crate/pull/10550", "timeline": [{"oid": "41410dfd159b298aef0ac4cc250106c824ef47ac", "url": "https://github.com/crate/crate/commit/41410dfd159b298aef0ac4cc250106c824ef47ac", "message": "Add support for RESET SESSION AUTHORIZATION statement.", "committedDate": "2020-09-16T15:22:16Z", "type": "forcePushed"}, {"oid": "8d4a5d1d5d809ffc3ea154f8de2bbfe59e3769af", "url": "https://github.com/crate/crate/commit/8d4a5d1d5d809ffc3ea154f8de2bbfe59e3769af", "message": "Add support for RESET SESSION AUTHORIZATION statement.", "committedDate": "2020-09-17T08:10:41Z", "type": "forcePushed"}, {"oid": "9885f0589524abca7c8134940566cb69ef77f6f0", "url": "https://github.com/crate/crate/commit/9885f0589524abca7c8134940566cb69ef77f6f0", "message": "Add support for RESET SESSION AUTHORIZATION statement.", "committedDate": "2020-09-17T08:43:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MTgzNw==", "url": "https://github.com/crate/crate/pull/10550#discussion_r490081837", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var userName = ((StringLiteral) visit(context.username)).getValue();\n          \n          \n            \n                        var userLiteral = visit(context.username);\n          \n          \n            \n                        assert userLiteral instanceof StringLiteral\n          \n          \n            \n                            : \"username must be a StringLiteral because the parser grammar is restricted to string literals\";\n          \n          \n            \n                        var userName = ((StringLiteral) userLiteral).getValue();\n          \n      \n    \n    \n  \n\nJust a suggestion to make the contract between AstBuilder and parser grammar more explicit.", "author": "mfussenegger", "createdAt": "2020-09-17T08:55:06Z", "path": "libs/sql-parser/src/main/java/io/crate/sql/parser/AstBuilder.java", "diffHunk": "@@ -730,6 +730,28 @@ public Node visitResetGlobal(SqlBaseParser.ResetGlobalContext context) {\n         return new ResetStatement<>(visitCollection(context.primaryExpression(), Expression.class));\n     }\n \n+    @Override\n+    public Node visitSetSessionAuthorization(SqlBaseParser.SetSessionAuthorizationContext context) {\n+        SetSessionAuthorizationStatement.Scope scope;\n+        if (context.LOCAL() != null) {\n+            scope = SetSessionAuthorizationStatement.Scope.LOCAL;\n+        } else {\n+            scope = SetSessionAuthorizationStatement.Scope.SESSION;\n+        }\n+\n+        if (context.DEFAULT() != null) {\n+            return new SetSessionAuthorizationStatement(scope);\n+        } else {\n+            var userName = ((StringLiteral) visit(context.username)).getValue();", "originalCommit": "9885f0589524abca7c8134940566cb69ef77f6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MjQ2MQ==", "url": "https://github.com/crate/crate/pull/10550#discussion_r490082461", "bodyText": "\ud83d\udc4d", "author": "mfussenegger", "createdAt": "2020-09-17T08:55:56Z", "path": "libs/sql-parser/src/main/java/io/crate/sql/tree/SetSessionAuthorizationStatement.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.sql.tree;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+public class SetSessionAuthorizationStatement extends Statement {\n+\n+    public enum Scope {\n+        SESSION, LOCAL\n+    }\n+\n+    @Nullable\n+    private final String user;\n+    private final Scope scope;\n+\n+    public SetSessionAuthorizationStatement(Scope scope) {\n+        this(null, scope);\n+    }\n+\n+    public SetSessionAuthorizationStatement(@Nullable String user, Scope scope) {\n+        this.scope = scope;\n+        this.user = user;\n+    }\n+\n+    /**\n+     * user is null for the following statements::", "originalCommit": "9885f0589524abca7c8134940566cb69ef77f6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MzE1Nw==", "url": "https://github.com/crate/crate/pull/10550#discussion_r490083157", "bodyText": "Maybe add the same comment as in the statement class, or link to it?", "author": "mfussenegger", "createdAt": "2020-09-17T08:56:51Z", "path": "server/src/main/java/io/crate/analyze/AnalyzedSetSessionAuthorizationStatement.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.analyze;\n+\n+import io.crate.sql.tree.SetSessionAuthorizationStatement;\n+\n+import javax.annotation.Nullable;\n+\n+public class AnalyzedSetSessionAuthorizationStatement implements AnalyzedStatement {\n+\n+    @Nullable\n+    private final String user;\n+    private final SetSessionAuthorizationStatement.Scope scope;\n+\n+    AnalyzedSetSessionAuthorizationStatement(@Nullable String user,\n+                                             SetSessionAuthorizationStatement.Scope scope) {\n+        this.user = user;\n+        this.scope = scope;\n+    }\n+\n+    @Nullable", "originalCommit": "9885f0589524abca7c8134940566cb69ef77f6f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MzcxNw==", "url": "https://github.com/crate/crate/pull/10550#discussion_r490083717", "bodyText": "Should we inline this into the Analyzer instead of creating a separate class? Seems overkill to extract this only for the call of a constructor", "author": "mfussenegger", "createdAt": "2020-09-17T08:57:41Z", "path": "server/src/main/java/io/crate/analyze/SetSessionAuthorizationStatementAnalyzer.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.analyze;\n+\n+import io.crate.sql.tree.SetSessionAuthorizationStatement;\n+\n+class SetSessionAuthorizationStatementAnalyzer {\n+\n+    public static AnalyzedStatement analyze(SetSessionAuthorizationStatement statement) {\n+        return new AnalyzedSetSessionAuthorizationStatement(\n+            statement.user(),\n+            statement.scope()\n+        );\n+    }\n+}", "originalCommit": "9885f0589524abca7c8134940566cb69ef77f6f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5NDE1Ng==", "url": "https://github.com/crate/crate/pull/10550#discussion_r490094156", "bodyText": "\ud83d\udc4d yep, it looks like overkill.", "author": "kovrus", "createdAt": "2020-09-17T09:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MzcxNw=="}], "type": "inlineReview"}, {"oid": "4a04d31a6c34061370a1a61224a28f213ef70327", "url": "https://github.com/crate/crate/commit/4a04d31a6c34061370a1a61224a28f213ef70327", "message": "fixup! Add support for SET SESSION AUTHORIZATION username statement.", "committedDate": "2020-09-17T09:25:42Z", "type": "forcePushed"}, {"oid": "1f3766ba7db73598ccbff2efd05ba0588c2fa582", "url": "https://github.com/crate/crate/commit/1f3766ba7db73598ccbff2efd05ba0588c2fa582", "message": "Add support for SET SESSION AUTHORIZATION username statement.", "committedDate": "2020-09-17T09:50:56Z", "type": "commit"}, {"oid": "85695a05efbcac6c15458af6c906087b5029c0da", "url": "https://github.com/crate/crate/commit/85695a05efbcac6c15458af6c906087b5029c0da", "message": "Rename SessionContext#user to SessionContext#sessionUser.\n\nTo emphasize which user is used such as currently session context\ncontains authenticated and session users.", "committedDate": "2020-09-17T09:50:58Z", "type": "commit"}, {"oid": "faeb620ab7875c0953361df421af80f419cdfb4a", "url": "https://github.com/crate/crate/commit/faeb620ab7875c0953361df421af80f419cdfb4a", "message": "Add support for RESET SESSION AUTHORIZATION statement.", "committedDate": "2020-09-17T09:51:19Z", "type": "commit"}, {"oid": "faeb620ab7875c0953361df421af80f419cdfb4a", "url": "https://github.com/crate/crate/commit/faeb620ab7875c0953361df421af80f419cdfb4a", "message": "Add support for RESET SESSION AUTHORIZATION statement.", "committedDate": "2020-09-17T09:51:19Z", "type": "forcePushed"}]}