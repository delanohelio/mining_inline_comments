{"pr_number": 16, "pr_title": "Add foreign keys after loading data, use multi-column hash keys", "pr_createdAt": "2020-05-08T23:57:12Z", "pr_url": "https://github.com/yugabyte/tpcc/pull/16", "timeline": [{"oid": "0fbbed844c82166ffae115eeec74ff4a3974754f", "url": "https://github.com/yugabyte/tpcc/commit/0fbbed844c82166ffae115eeec74ff4a3974754f", "message": "Add Deferred forreign key checks.\n\nReviewers:\nNeha, Karthik", "committedDate": "2020-05-08T23:51:53Z", "type": "commit"}, {"oid": "993a1568d02ddd247724e4edc7bea51914dfcae0", "url": "https://github.com/yugabyte/tpcc/commit/993a1568d02ddd247724e4edc7bea51914dfcae0", "message": "USing WarehouseId and DistrictId for partitioning.\n\nReviewers:\nNeha, Karthik", "committedDate": "2020-05-08T23:52:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDM5Mw==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580393", "bodyText": "Do we need this log line?", "author": "rkarthik007", "createdAt": "2020-05-10T03:57:48Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -118,10 +126,30 @@ public void load(Connection conn) throws SQLException {\n \n                     // ORDERS\n                     loadOrders(conn, w_id, TPCCConfig.configDistPerWhse, TPCCConfig.configCustPerDist);\n+\n+                    warehouseLatch.countDown();\n                 }\n             };\n             threads.add(t);\n         } // FOR\n+\n+        if (workConf.getDeferConstraintChecks()) {\n+            threads.add(new LoaderThread() {\n+                @Override\n+                public void load(Connection conn) throws SQLException {\n+                    try {\n+                        warehouseLatch.await();\n+                    } catch (InterruptedException ex) {\n+                        ex.printStackTrace();\n+                        throw new RuntimeException(ex);\n+                    }\n+                    long startTime = System.nanoTime();\n+                    EnableForeignKeyConstraints(conn);\n+                    LOG.info(\"The total Time for enabling foreign keys \" + (System.nanoTime() - startTime) / 1000 / 1000 / 1000);", "originalCommit": "993a1568d02ddd247724e4edc7bea51914dfcae0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3MjIwOA==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423272208", "bodyText": "We don't specifically need it.\nWill remove.", "author": "psudheer21", "createdAt": "2020-05-11T19:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDQ2NA==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r422580464", "bodyText": "Comments please.", "author": "rkarthik007", "createdAt": "2020-05-10T03:58:55Z", "path": "src/com/oltpbenchmark/DBWorkload.java", "diffHunk": "@@ -237,6 +237,12 @@ public static void main(String[] args) throws Exception {\n                 // Nothing to do here !\n             }\n \n+            try {\n+              wrkld.setDeferConstraintChecks(xmlConfig.getBoolean(\"deferConstraintChecks\"));", "originalCommit": "993a1568d02ddd247724e4edc7bea51914dfcae0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3MjM5OA==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423272398", "bodyText": "Sure.", "author": "psudheer21", "createdAt": "2020-05-11T19:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU4MDQ2NA=="}], "type": "inlineReview"}, {"oid": "4bd6c175a8f57770a9e0be9c204036bfcf0bd83d", "url": "https://github.com/yugabyte/tpcc/commit/4bd6c175a8f57770a9e0be9c204036bfcf0bd83d", "message": "Added comments for the new features added in TPC-C.", "committedDate": "2020-05-11T19:44:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDE5MQ==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423274191", "bodyText": "Let's not use the term \"deferred constraints\" since that has a different meaning in postgresql and YSQL. Let's use setForeignKeysAfterLoad instead.", "author": "ndeodhar", "createdAt": "2020-05-11T19:40:02Z", "path": "src/com/oltpbenchmark/DBWorkload.java", "diffHunk": "@@ -237,6 +237,12 @@ public static void main(String[] args) throws Exception {\n                 // Nothing to do here !\n             }\n \n+            try {\n+              wrkld.setDeferConstraintChecks(xmlConfig.getBoolean(\"deferConstraintChecks\"));", "originalCommit": "993a1568d02ddd247724e4edc7bea51914dfcae0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MDA0OA==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r424750048", "bodyText": "Done.", "author": "psudheer21", "createdAt": "2020-05-13T21:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDk4OA==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r423274988", "bodyText": "We can skip this log since this is not a time consuming operation.", "author": "ndeodhar", "createdAt": "2020-05-11T19:41:36Z", "path": "src/com/oltpbenchmark/benchmarks/tpcc/TPCCLoader.java", "diffHunk": "@@ -67,19 +69,25 @@ public TPCCLoader(TPCCBenchmark benchmark) {\n         }\n     }\n \n+    private boolean deferConstraintChecks;\n     private int numWarehouses = 0;\n     private static final int FIRST_UNPROCESSED_O_ID = 2101;\n \n     @Override\n     public List<LoaderThread> createLoaderThreads() throws SQLException {\n         List<LoaderThread> threads = new ArrayList<LoaderThread>();\n         final CountDownLatch itemLatch = new CountDownLatch(1);\n+        final CountDownLatch warehouseLatch = new CountDownLatch(numWarehouses);\n \n         // ITEM\n         // This will be invoked first and executed in a single thread.\n         threads.add(new LoaderThread() {\n             @Override\n             public void load(Connection conn) throws SQLException {\n+                if (!workConf.getDeferConstraintChecks()) {\n+                    EnableForeignKeyConstraints(conn);\n+                    LOG.info(\"The total Time for enabling foreign keys \" + (System.nanoTime() - startTime) / 1000 / 1000 / 1000);", "originalCommit": "993a1568d02ddd247724e4edc7bea51914dfcae0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0NjA2MQ==", "url": "https://github.com/yugabyte/tpcc/pull/16#discussion_r424746061", "bodyText": "done.", "author": "psudheer21", "createdAt": "2020-05-13T21:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3NDk4OA=="}], "type": "inlineReview"}, {"oid": "1c424379c7c252c8617799e39769a83073a919a8", "url": "https://github.com/yugabyte/tpcc/commit/1c424379c7c252c8617799e39769a83073a919a8", "message": "Addressed Neha's comments.", "committedDate": "2020-05-13T22:42:45Z", "type": "commit"}, {"oid": "5d7b205c4015e7e389413493baec886ef4d1d894", "url": "https://github.com/yugabyte/tpcc/commit/5d7b205c4015e7e389413493baec886ef4d1d894", "message": "Modified comments.", "committedDate": "2020-05-19T22:18:37Z", "type": "commit"}]}