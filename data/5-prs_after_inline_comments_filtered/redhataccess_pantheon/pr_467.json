{"pr_number": 467, "pr_title": "Fix publish/updated dates CCS-3877 CCS-3879", "pr_createdAt": "2020-11-10T22:26:05Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/467", "timeline": [{"oid": "f718dc8e71d7aeb2ac2852c9fee6cb243b71157b", "url": "https://github.com/redhataccess/pantheon/commit/f718dc8e71d7aeb2ac2852c9fee6cb243b71157b", "message": "intermediate work toward copying metadata and fixing dates", "committedDate": "2020-11-05T00:19:30Z", "type": "commit"}, {"oid": "dcdf6b25bf3f99f4f3d918b0886eee6147af6212", "url": "https://github.com/redhataccess/pantheon/commit/dcdf6b25bf3f99f4f3d918b0886eee6147af6212", "message": "Pulling out common code, needs tested", "committedDate": "2020-11-10T21:17:26Z", "type": "commit"}, {"oid": "d2f4e3d7fb30d2825b8af8d5897345dd19885258", "url": "https://github.com/redhataccess/pantheon/commit/d2f4e3d7fb30d2825b8af8d5897345dd19885258", "message": "Reworking class structure", "committedDate": "2020-11-10T22:11:11Z", "type": "commit"}, {"oid": "d1713183d40a47b6dc1d5c5b8031576f2a224a24", "url": "https://github.com/redhataccess/pantheon/commit/d1713183d40a47b6dc1d5c5b8031576f2a224a24", "message": "misc cleanup", "committedDate": "2020-11-10T22:22:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyNDY2NA==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r524524664", "bodyText": "what's the difference between pant:datePublished and pant:dateFirstPublished?", "author": "xdavidson", "createdAt": "2020-11-16T19:38:35Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/document/DocumentMetadata.java", "diffHunk": "@@ -37,6 +37,9 @@\n     @Named(\"pant:datePublished\")\n     Field<Calendar> datePublished();\n \n+    @Named(\"pant:dateFirstPublished\")", "originalCommit": "d1713183d40a47b6dc1d5c5b8031576f2a224a24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0NDkxNg==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r525644916", "bodyText": "Great question. datePublished is specific to that particular version and is not carried forward to any new versions. dateFirstPublished is populated only once, on first-ever publish only, and then carried forward from version to version.", "author": "benradey", "createdAt": "2020-11-18T01:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyNDY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIxMjAwNw==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r526212007", "bodyText": "Thank you for the info! how are we going to handle the modules/assemblies published in prod today that don't have pant:dateFirstPublished?", "author": "xdavidson", "createdAt": "2020-11-18T16:09:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyNDY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1ODcyOA==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r526358728", "bodyText": "Another good question. :)\nI have the logic set up in AsciidoctorService.java:258 so that the 'datePublished' value is used for both the \"updated\" and \"published\" injected attributes. Then immediately after that, if the 'firstPublished' value exists, it overwrites the \"published\" injected attribute.\nSo all of our docs today will rely on the fallback logic. Over time it will become less necessary, but the bottom line is that today's docs will be handled as best as possible with what we have.", "author": "benradey", "createdAt": "2020-11-18T19:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUyNDY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUzNTk3OQ==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r524535979", "bodyText": "should we consider the following two to be added to this list?\n\"pant:headline\"\n\"pant:abstract\"", "author": "xdavidson", "createdAt": "2020-11-16T19:58:32Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/util/VersionUploadOperation.java", "diffHunk": "@@ -0,0 +1,161 @@\n+package com.redhat.pantheon.servlet.util;\n+\n+import com.google.common.hash.HashCode;\n+import com.redhat.pantheon.asciidoctor.AsciidoctorService;\n+import com.redhat.pantheon.conf.GlobalConfig;\n+import com.redhat.pantheon.jcr.JcrResources;\n+import com.redhat.pantheon.model.HashableFileResource;\n+import com.redhat.pantheon.model.api.Child;\n+import com.redhat.pantheon.model.api.SlingModels;\n+import com.redhat.pantheon.model.document.Document;\n+import com.redhat.pantheon.model.document.DocumentLocale;\n+import com.redhat.pantheon.model.document.DocumentMetadata;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.ModifiableValueMap;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.api.resource.ResourceResolver;\n+import org.apache.sling.servlets.post.AbstractPostOperation;\n+import org.apache.sling.servlets.post.PostResponse;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.jcr.Session;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.Arrays;\n+import java.util.Calendar;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public abstract class VersionUploadOperation extends AbstractPostOperation {\n+\n+    private static final Logger log = LoggerFactory.getLogger(VersionUploadOperation.class);\n+\n+    private static final Set<String> METADATA_COPY_EXCLUDES = Collections.unmodifiableSet(\n+            new HashSet<>(\n+                    Arrays.asList(\n+                            \"jcr:description\",\n+                            \"jcr:lastModified\",\n+                            \"jcr:primaryType\",\n+                            \"jcr:title\",\n+                            \"pant:dateUploaded\",\n+                            \"pant:datePublished\"", "originalCommit": "d1713183d40a47b6dc1d5c5b8031576f2a224a24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0NTE0NA==", "url": "https://github.com/redhataccess/pantheon/pull/467#discussion_r525645144", "bodyText": "Probably! If those are both populated automatically from the doc, then it doesn't make sense to carry them forward.", "author": "benradey", "createdAt": "2020-11-18T01:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUzNTk3OQ=="}], "type": "inlineReview"}, {"oid": "34d6938e60c4a887bd61cbdedced32dc38c41d9a", "url": "https://github.com/redhataccess/pantheon/commit/34d6938e60c4a887bd61cbdedced32dc38c41d9a", "message": "Code review feedback", "committedDate": "2020-11-18T02:04:53Z", "type": "commit"}]}