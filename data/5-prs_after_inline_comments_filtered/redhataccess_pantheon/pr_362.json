{"pr_number": 362, "pr_title": "CCS-3661: Json API for assembly", "pr_createdAt": "2020-08-06T10:39:00Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/362", "timeline": [{"oid": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "url": "https://github.com/redhataccess/pantheon/commit/8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "message": "CCS-3661: Json API for assembly", "committedDate": "2020-08-06T11:34:12Z", "type": "commit"}, {"oid": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "url": "https://github.com/redhataccess/pantheon/commit/8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "message": "CCS-3661: Json API for assembly", "committedDate": "2020-08-06T11:34:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzMDQzOQ==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466430439", "bodyText": "we should replace 'module' with 'assembly'.", "author": "xdavidson", "createdAt": "2020-08-06T13:55:26Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzMDk1MA==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466430950", "bodyText": "line 50 should be updated with assembly path.", "author": "xdavidson", "createdAt": "2020-08-06T13:56:11Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        })\n+// /api/module.json?module_id=${moduleUuid}&locale=${localeId}&variant=${variantName}\";", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNDk4OQ==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466434989", "bodyText": "can we rename module_uuid to assembly_uuid?", "author": "xdavidson", "createdAt": "2020-08-06T14:01:46Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        })\n+// /api/module.json?module_id=${moduleUuid}&locale=${localeId}&variant=${variantName}\";\n+@SlingServletPaths(value = \"/api/assembly\")\n+public class AssemblyJsonServlet extends AbstractJsonSingleQueryServlet {\n+    public static final String PRODUCT_VERSION = \"product_version\";\n+    public static final String PRODUCT_NAME = \"product_name\";\n+    public static final String PRODUCT_LINK = \"product_link\";\n+    public static final String VANITY_URL_FRAGMENT = \"vanity_url_fragment\";\n+    public static final String SEARCH_KEYWORDS = \"search_keywords\";\n+    public static final String VIEW_URI = \"view_uri\";\n+    public static final String PORTAL_URL = \"PORTAL_URL\";\n+\n+    private final Logger log = LoggerFactory.getLogger(AssemblyJsonServlet.class);\n+\n+    @Override\n+    protected String getQuery(SlingHttpServletRequest request) {\n+        // Get the query parameter(s)\n+        String uuidParam = paramValue(request, \"assembly_id\", \"\");\n+\n+        StringBuilder query = new StringBuilder(\"select * from [pant:assembly] as assembly WHERE assembly.[jcr:uuid] = '\")\n+                .append(uuidParam)\n+                .append(\"'\");\n+        return query.toString();\n+    }\n+\n+    @Override\n+    protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Nonnull Resource resource) {\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+        return releasedRevision.isPresent();\n+    }\n+\n+    //ToDo: Refactor map based to builder pattern based POJO backed response entity\n+    @Override\n+    protected Map<String, Object> resourceToMap(@Nonnull SlingHttpServletRequest request,\n+                                                @NotNull Resource resource) throws RepositoryException {\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Optional<AssemblyMetadata> releasedMetadata = assembly.getReleasedMetadata(locale, variantName);\n+        Optional<FileResource> releasedContent = assembly.getReleasedContent(locale, variantName);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+\n+        Map<String, Object> assemblyMap = super.resourceToMap(request, resource);\n+        Map<String, Object> assemblyDetails = new HashMap<>();\n+\n+        assemblyDetails.put(\"status\", SC_OK);\n+        assemblyDetails.put(\"message\", \"Assembly Found\");\n+\n+        String resourcePath = resource.getPath();\n+        assemblyMap.put(\"locale\", ServletUtils.toLanguageTag(locale));\n+        assemblyMap.put(\"revision_id\", releasedRevision.get().getName());\n+        assemblyMap.put(\"title\", releasedMetadata.get().title().get());\n+        assemblyMap.put(\"headline\", releasedMetadata.get().getValueMap().containsKey(\"pant:headline\") ? releasedMetadata.get().headline().get() : \"\");\n+        //assemblyMap.put(\"description\", releasedMetadata.get().description().get());\n+        assemblyMap.put(\"content_type\", \"assembly\");\n+        assemblyMap.put(\"date_published\", releasedMetadata.get().getValueMap().containsKey(\"pant:datePublished\") ? releasedMetadata.get().datePublished().get().toInstant().toString() : \"\");\n+        assemblyMap.put(\"status\", \"published\");\n+\n+        // Assume the path is something like: /content/<something>/my/resource/path\n+        assemblyMap.put(\"assembly_url_fragment\", resourcePath.substring(\"/content/repositories/\".length()));\n+\n+        // Striping out the jcr: from key name\n+        String module_uuid = (String) assemblyMap.remove(\"jcr:uuid\");", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTMwMQ==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466435301", "bodyText": "same as above", "author": "xdavidson", "createdAt": "2020-08-06T14:02:15Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        })\n+// /api/module.json?module_id=${moduleUuid}&locale=${localeId}&variant=${variantName}\";\n+@SlingServletPaths(value = \"/api/assembly\")\n+public class AssemblyJsonServlet extends AbstractJsonSingleQueryServlet {\n+    public static final String PRODUCT_VERSION = \"product_version\";\n+    public static final String PRODUCT_NAME = \"product_name\";\n+    public static final String PRODUCT_LINK = \"product_link\";\n+    public static final String VANITY_URL_FRAGMENT = \"vanity_url_fragment\";\n+    public static final String SEARCH_KEYWORDS = \"search_keywords\";\n+    public static final String VIEW_URI = \"view_uri\";\n+    public static final String PORTAL_URL = \"PORTAL_URL\";\n+\n+    private final Logger log = LoggerFactory.getLogger(AssemblyJsonServlet.class);\n+\n+    @Override\n+    protected String getQuery(SlingHttpServletRequest request) {\n+        // Get the query parameter(s)\n+        String uuidParam = paramValue(request, \"assembly_id\", \"\");\n+\n+        StringBuilder query = new StringBuilder(\"select * from [pant:assembly] as assembly WHERE assembly.[jcr:uuid] = '\")\n+                .append(uuidParam)\n+                .append(\"'\");\n+        return query.toString();\n+    }\n+\n+    @Override\n+    protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Nonnull Resource resource) {\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+        return releasedRevision.isPresent();\n+    }\n+\n+    //ToDo: Refactor map based to builder pattern based POJO backed response entity\n+    @Override\n+    protected Map<String, Object> resourceToMap(@Nonnull SlingHttpServletRequest request,\n+                                                @NotNull Resource resource) throws RepositoryException {\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Optional<AssemblyMetadata> releasedMetadata = assembly.getReleasedMetadata(locale, variantName);\n+        Optional<FileResource> releasedContent = assembly.getReleasedContent(locale, variantName);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+\n+        Map<String, Object> assemblyMap = super.resourceToMap(request, resource);\n+        Map<String, Object> assemblyDetails = new HashMap<>();\n+\n+        assemblyDetails.put(\"status\", SC_OK);\n+        assemblyDetails.put(\"message\", \"Assembly Found\");\n+\n+        String resourcePath = resource.getPath();\n+        assemblyMap.put(\"locale\", ServletUtils.toLanguageTag(locale));\n+        assemblyMap.put(\"revision_id\", releasedRevision.get().getName());\n+        assemblyMap.put(\"title\", releasedMetadata.get().title().get());\n+        assemblyMap.put(\"headline\", releasedMetadata.get().getValueMap().containsKey(\"pant:headline\") ? releasedMetadata.get().headline().get() : \"\");\n+        //assemblyMap.put(\"description\", releasedMetadata.get().description().get());\n+        assemblyMap.put(\"content_type\", \"assembly\");\n+        assemblyMap.put(\"date_published\", releasedMetadata.get().getValueMap().containsKey(\"pant:datePublished\") ? releasedMetadata.get().datePublished().get().toInstant().toString() : \"\");\n+        assemblyMap.put(\"status\", \"published\");\n+\n+        // Assume the path is something like: /content/<something>/my/resource/path\n+        assemblyMap.put(\"assembly_url_fragment\", resourcePath.substring(\"/content/repositories/\".length()));\n+\n+        // Striping out the jcr: from key name\n+        String module_uuid = (String) assemblyMap.remove(\"jcr:uuid\");\n+        assemblyMap.put(\"assembly_uuid\", module_uuid);", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzNTgwNg==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466435806", "bodyText": "please replace \"module\" with \"assembly\"", "author": "xdavidson", "createdAt": "2020-08-06T14:03:02Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        })\n+// /api/module.json?module_id=${moduleUuid}&locale=${localeId}&variant=${variantName}\";\n+@SlingServletPaths(value = \"/api/assembly\")\n+public class AssemblyJsonServlet extends AbstractJsonSingleQueryServlet {\n+    public static final String PRODUCT_VERSION = \"product_version\";\n+    public static final String PRODUCT_NAME = \"product_name\";\n+    public static final String PRODUCT_LINK = \"product_link\";\n+    public static final String VANITY_URL_FRAGMENT = \"vanity_url_fragment\";\n+    public static final String SEARCH_KEYWORDS = \"search_keywords\";\n+    public static final String VIEW_URI = \"view_uri\";\n+    public static final String PORTAL_URL = \"PORTAL_URL\";\n+\n+    private final Logger log = LoggerFactory.getLogger(AssemblyJsonServlet.class);\n+\n+    @Override\n+    protected String getQuery(SlingHttpServletRequest request) {\n+        // Get the query parameter(s)\n+        String uuidParam = paramValue(request, \"assembly_id\", \"\");\n+\n+        StringBuilder query = new StringBuilder(\"select * from [pant:assembly] as assembly WHERE assembly.[jcr:uuid] = '\")\n+                .append(uuidParam)\n+                .append(\"'\");\n+        return query.toString();\n+    }\n+\n+    @Override\n+    protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Nonnull Resource resource) {\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+        return releasedRevision.isPresent();\n+    }\n+\n+    //ToDo: Refactor map based to builder pattern based POJO backed response entity\n+    @Override\n+    protected Map<String, Object> resourceToMap(@Nonnull SlingHttpServletRequest request,\n+                                                @NotNull Resource resource) throws RepositoryException {\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Optional<AssemblyMetadata> releasedMetadata = assembly.getReleasedMetadata(locale, variantName);\n+        Optional<FileResource> releasedContent = assembly.getReleasedContent(locale, variantName);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+\n+        Map<String, Object> assemblyMap = super.resourceToMap(request, resource);\n+        Map<String, Object> assemblyDetails = new HashMap<>();\n+\n+        assemblyDetails.put(\"status\", SC_OK);\n+        assemblyDetails.put(\"message\", \"Assembly Found\");\n+\n+        String resourcePath = resource.getPath();\n+        assemblyMap.put(\"locale\", ServletUtils.toLanguageTag(locale));\n+        assemblyMap.put(\"revision_id\", releasedRevision.get().getName());\n+        assemblyMap.put(\"title\", releasedMetadata.get().title().get());\n+        assemblyMap.put(\"headline\", releasedMetadata.get().getValueMap().containsKey(\"pant:headline\") ? releasedMetadata.get().headline().get() : \"\");\n+        //assemblyMap.put(\"description\", releasedMetadata.get().description().get());\n+        assemblyMap.put(\"content_type\", \"assembly\");\n+        assemblyMap.put(\"date_published\", releasedMetadata.get().getValueMap().containsKey(\"pant:datePublished\") ? releasedMetadata.get().datePublished().get().toInstant().toString() : \"\");\n+        assemblyMap.put(\"status\", \"published\");\n+\n+        // Assume the path is something like: /content/<something>/my/resource/path\n+        assemblyMap.put(\"assembly_url_fragment\", resourcePath.substring(\"/content/repositories/\".length()));\n+\n+        // Striping out the jcr: from key name\n+        String module_uuid = (String) assemblyMap.remove(\"jcr:uuid\");\n+        assemblyMap.put(\"assembly_uuid\", module_uuid);\n+        // Convert date string to UTC\n+        Date dateModified = new Date(resource.getResourceMetadata().getModificationTime());\n+        assemblyMap.put(\"date_modified\", dateModified.toInstant().toString());\n+        // Return the body content of the module ONLY", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzODUwNQ==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466438505", "bodyText": "please rename module_uuid to assembly_uuid", "author": "xdavidson", "createdAt": "2020-08-06T14:06:55Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServlet.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.google.common.base.Charsets;\n+import com.redhat.pantheon.html.Html;\n+import com.redhat.pantheon.model.ProductVersion;\n+import com.redhat.pantheon.model.api.FileResource;\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.assembly.AssemblyMetadata;\n+import com.redhat.pantheon.model.assembly.AssemblyVersion;\n+import com.redhat.pantheon.servlet.AbstractJsonSingleQueryServlet;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nonnull;\n+import javax.jcr.RepositoryException;\n+import javax.servlet.Servlet;\n+import java.util.*;\n+\n+import static com.redhat.pantheon.conf.GlobalConfig.DEFAULT_MODULE_LOCALE;\n+import static com.redhat.pantheon.model.assembly.AssemblyVariant.DEFAULT_VARIANT_NAME;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValue;\n+import static com.redhat.pantheon.servlet.ServletUtils.paramValueAsLocale;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+\n+/**\n+ * Get operation to render a Released Assembly data in JSON format.\n+ * Only two parameters are expected in the Get request:\n+ * 1. locale - Optional; indicates the locale that the assembly content is in, defaulted to en-US\n+ * 2. assembly_id - indicates the uuid string which uniquely identifies an assembly\n+ *\n+ * The url to GET a request from the server is /api/module\n+ * Example: <server_url>/api/assembly?locale=en-us&module_id=xyz&variant=abc\n+ * The said url is accessible outside of the system without any authentication.\n+ *\n+ * @author A.P. Rajjshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION + \"=Servlet to facilitate GET operation which accepts locale and assembly uuid to output module data\",\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        })\n+// /api/module.json?module_id=${moduleUuid}&locale=${localeId}&variant=${variantName}\";\n+@SlingServletPaths(value = \"/api/assembly\")\n+public class AssemblyJsonServlet extends AbstractJsonSingleQueryServlet {\n+    public static final String PRODUCT_VERSION = \"product_version\";\n+    public static final String PRODUCT_NAME = \"product_name\";\n+    public static final String PRODUCT_LINK = \"product_link\";\n+    public static final String VANITY_URL_FRAGMENT = \"vanity_url_fragment\";\n+    public static final String SEARCH_KEYWORDS = \"search_keywords\";\n+    public static final String VIEW_URI = \"view_uri\";\n+    public static final String PORTAL_URL = \"PORTAL_URL\";\n+\n+    private final Logger log = LoggerFactory.getLogger(AssemblyJsonServlet.class);\n+\n+    @Override\n+    protected String getQuery(SlingHttpServletRequest request) {\n+        // Get the query parameter(s)\n+        String uuidParam = paramValue(request, \"assembly_id\", \"\");\n+\n+        StringBuilder query = new StringBuilder(\"select * from [pant:assembly] as assembly WHERE assembly.[jcr:uuid] = '\")\n+                .append(uuidParam)\n+                .append(\"'\");\n+        return query.toString();\n+    }\n+\n+    @Override\n+    protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Nonnull Resource resource) {\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+        return releasedRevision.isPresent();\n+    }\n+\n+    //ToDo: Refactor map based to builder pattern based POJO backed response entity\n+    @Override\n+    protected Map<String, Object> resourceToMap(@Nonnull SlingHttpServletRequest request,\n+                                                @NotNull Resource resource) throws RepositoryException {\n+        Assembly assembly = resource.adaptTo(Assembly.class);\n+\n+        Locale locale = paramValueAsLocale(request, \"locale\", DEFAULT_MODULE_LOCALE);\n+        String variantName = paramValue(request, \"variant\", DEFAULT_VARIANT_NAME);\n+        Optional<AssemblyMetadata> releasedMetadata = assembly.getReleasedMetadata(locale, variantName);\n+        Optional<FileResource> releasedContent = assembly.getReleasedContent(locale, variantName);\n+        Optional<AssemblyVersion> releasedRevision = assembly.getReleasedVersion(locale, variantName);\n+\n+        Map<String, Object> assemblyMap = super.resourceToMap(request, resource);\n+        Map<String, Object> assemblyDetails = new HashMap<>();\n+\n+        assemblyDetails.put(\"status\", SC_OK);\n+        assemblyDetails.put(\"message\", \"Assembly Found\");\n+\n+        String resourcePath = resource.getPath();\n+        assemblyMap.put(\"locale\", ServletUtils.toLanguageTag(locale));\n+        assemblyMap.put(\"revision_id\", releasedRevision.get().getName());\n+        assemblyMap.put(\"title\", releasedMetadata.get().title().get());\n+        assemblyMap.put(\"headline\", releasedMetadata.get().getValueMap().containsKey(\"pant:headline\") ? releasedMetadata.get().headline().get() : \"\");\n+        //assemblyMap.put(\"description\", releasedMetadata.get().description().get());\n+        assemblyMap.put(\"content_type\", \"assembly\");\n+        assemblyMap.put(\"date_published\", releasedMetadata.get().getValueMap().containsKey(\"pant:datePublished\") ? releasedMetadata.get().datePublished().get().toInstant().toString() : \"\");\n+        assemblyMap.put(\"status\", \"published\");\n+\n+        // Assume the path is something like: /content/<something>/my/resource/path\n+        assemblyMap.put(\"assembly_url_fragment\", resourcePath.substring(\"/content/repositories/\".length()));\n+\n+        // Striping out the jcr: from key name\n+        String module_uuid = (String) assemblyMap.remove(\"jcr:uuid\");\n+        assemblyMap.put(\"assembly_uuid\", module_uuid);\n+        // Convert date string to UTC\n+        Date dateModified = new Date(resource.getResourceMetadata().getModificationTime());\n+        assemblyMap.put(\"date_modified\", dateModified.toInstant().toString());\n+        // Return the body content of the module ONLY\n+        assemblyMap.put(\"body\",\n+                Html.parse(Charsets.UTF_8.name())\n+                        .andThen(Html.getBody())\n+                        .apply(releasedContent.get().jcrContent().get().jcrData().get()));\n+\n+        // Fields that are part of the spec and yet to be implemented\n+        // TODO Should either of these be the variant name?\n+        assemblyMap.put(\"context_url_fragment\", \"\");\n+        assemblyMap.put(\"context_id\", \"\");\n+\n+        // Process productVersion from metadata\n+        // Making these arrays - in the future, we will have multi-product, so get the API right the first time\n+        List<Map> productList = new ArrayList<>();\n+        assemblyMap.put(\"products\", productList);\n+        ProductVersion pv = releasedMetadata.get().productVersion().getReference();\n+        if (pv != null) {\n+            Map<String, String> productMap = new HashMap<>();\n+            productList.add(productMap);\n+            productMap.put(PRODUCT_VERSION, pv.name().get());\n+            productMap.put(PRODUCT_NAME, pv.getProduct().name().get());\n+            productMap.put(PRODUCT_LINK, \"https://www.redhat.com/productlinkplaceholder\");\n+        }\n+\n+        // Process url_fragment from metadata\n+        String urlFragment = releasedMetadata.get().urlFragment().get() != null ? releasedMetadata.get().urlFragment().get() : \"\";\n+        if (!urlFragment.isEmpty()) {\n+            assemblyMap.put(VANITY_URL_FRAGMENT, urlFragment);\n+        }\n+        else {\n+            assemblyMap.put(VANITY_URL_FRAGMENT, \"\");\n+        }\n+\n+        String searchKeywords = releasedMetadata.get().searchKeywords().get();\n+        if (searchKeywords != null && !searchKeywords.isEmpty()) {\n+            assemblyMap.put(SEARCH_KEYWORDS, searchKeywords.split(\", *\"));\n+        }\n+        else {\n+            assemblyMap.put(SEARCH_KEYWORDS, new String[] {});\n+        }\n+\n+        // Process view_uri\n+        if (System.getenv(PORTAL_URL) != null) {\n+            String view_uri = System.getenv(PORTAL_URL) + \"/topics/\" + ServletUtils.toLanguageTag(locale) + \"/\" + module_uuid;", "originalCommit": "8c5c159533a7f3770bda6cbbb646b16bef1dbed5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd2e6c454588be1e57edf3485c01aaaeefb18778", "url": "https://github.com/redhataccess/pantheon/commit/bd2e6c454588be1e57edf3485c01aaaeefb18778", "message": "CCS-3661: Json API for assembly. Code review changes", "committedDate": "2020-08-06T14:22:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466456177", "bodyText": "i wonder if we should call it something more generic so that both module api and assembly api can share the same name. Hydra team maps this field to id field in solr. The fact is this is assembly_id not module_id. Both are uuid of a node. we could call it \"uuid\", which will make the mapping more straightforward for hydra team.", "author": "xdavidson", "createdAt": "2020-08-06T14:31:23Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/assembly/AssemblyJsonServletTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package com.redhat.pantheon.servlet.assembly;\n+\n+import com.redhat.pantheon.model.assembly.Assembly;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.servlet.ServletUtils;\n+import com.redhat.pantheon.servlet.assembly.AssemblyJsonServlet;\n+import com.redhat.pantheon.servlet.module.ModuleJsonServlet;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledIf;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import javax.jcr.RepositoryException;\n+import javax.jcr.query.Query;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+import static com.google.common.collect.Maps.newHashMap;\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static javax.servlet.http.HttpServletResponse.SC_OK;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+@ExtendWith({SlingContextExtension.class})\n+class AssemblyJsonServletTest {\n+\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @Test\n+    void getQueryNoParams() {\n+        // Given\n+        AssemblyJsonServlet servlet = new AssemblyJsonServlet();\n+\n+        // When\n+        String query = servlet.getQuery(slingContext.request());\n+\n+        // Then\n+        // make sure queries don't throw exceptions when executed against the JCR repository\n+        assertDoesNotThrow(() -> slingContext.resourceResolver().queryResources(query, Query.JCR_SQL2));\n+    }\n+\n+    @Test\n+    void getQuery() {\n+        // Given\n+        AssemblyJsonServlet servlet = new AssemblyJsonServlet();\n+        Map<String, Object> map = newHashMap();\n+        map.put(\"locale\", ServletUtils.toLanguageTag(Locale.US));\n+        map.put(\"module_id\", \"jcr:uuid\");", "originalCommit": "bd2e6c454588be1e57edf3485c01aaaeefb18778", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ2MDExMw==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466460113", "bodyText": "That is a good idea. So, rename (assembly, module)_uuid to just uuid in the response only or also in the url as well?", "author": "aprajshekhar", "createdAt": "2020-08-06T14:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3MTY3NA==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466471674", "bodyText": "I would rename in both the response body. I am not sure which url you refer to.\nthe url to module api looks like this: https:///api/module/variant.json/b537ef3c-5c7d-4280-91ce-e7e818e6cc11\nthe url to assembly api looks like this: https:///api/assembly.json/bc3ae91d-fbf1-4dc5-9bec-edfaa03d29fa", "author": "xdavidson", "createdAt": "2020-08-06T14:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3NDA0Mw==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466474043", "bodyText": "if you do decide to rename line 51 to uuid instead of \"module_id\", it would be great if you can add this to VariantJsonServlet.java:\n// TODO: remove module_uuid after Hydra team releases UNIFIED-6570\nvariantMap.put(\"module_uuid\", variant_uuid);\n// add the following to the map for hdyra to consume\nvariantMap.put(\"uuid\", variant_uuid);", "author": "xdavidson", "createdAt": "2020-08-06T14:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3ODM4NA==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466478384", "bodyText": "Ah.. ok, my bad regarding the URI. I am fine with renaming in assembly but module response is being used by  teams other than Hydra. So, it could introduce bugs. Hence, I am hesitant and not in favor of making change  to module response in the scope of this JIRA/PR. Maybe we can have another JIRA for that where other teams can be notified?", "author": "aprajshekhar", "createdAt": "2020-08-06T15:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3OTc0Nw==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466479747", "bodyText": "yes, that works for me.", "author": "xdavidson", "createdAt": "2020-08-06T15:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ4NTcyMw==", "url": "https://github.com/redhataccess/pantheon/pull/362#discussion_r466485723", "bodyText": "I have updated the test case accordingly. Will raise another JIRA for common/generic name for uuid", "author": "aprajshekhar", "createdAt": "2020-08-06T15:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1NjE3Nw=="}], "type": "inlineReview"}, {"oid": "41f485ab7dc3cdc503e458f5f46194e18eab590b", "url": "https://github.com/redhataccess/pantheon/commit/41f485ab7dc3cdc503e458f5f46194e18eab590b", "message": "CCS-3661: Json API for assembly. Code review changes import opimizations for test cases", "committedDate": "2020-08-06T15:10:37Z", "type": "commit"}]}