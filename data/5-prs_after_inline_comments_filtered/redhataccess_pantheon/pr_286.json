{"pr_number": 286, "pr_title": "resolves CORS issue using Filter", "pr_createdAt": "2020-05-06T20:23:21Z", "pr_url": "https://github.com/redhataccess/pantheon/pull/286", "timeline": [{"oid": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "url": "https://github.com/redhataccess/pantheon/commit/aad151e59e3f7271a8d86274ae32d215d0dd7c61", "message": "resolves CORS issue using Filter", "committedDate": "2020-05-06T20:21:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxOTgyMw==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421419823", "bodyText": "Could we call this something like CorsEnablingFilter? (or a better name)", "author": "carlosmunoz", "createdAt": "2020-05-07T11:02:21Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/SimpleFilter.java", "diffHunk": "@@ -49,22 +54,30 @@\n  *     @Property(name=\"service.ranking\", intValue=1)\n  * })\n  */\n-//@SlingFilter(order=1, description=\"A Simple Filter\")\n-//@Property(name=\"service.vendor\", value=\"The Apache Software Foundation\")\n+@Component\n+@SlingServletFilter(scope = {SlingServletFilterScope.REQUEST},\n+                    methods = {\"GET\",\"HEAD\"})\n public class SimpleFilter implements Filter {", "originalCommit": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3Nzg4OQ==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421577889", "bodyText": "done", "author": "xdavidson", "createdAt": "2020-05-07T15:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxOTgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMTk3MQ==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421421971", "bodyText": "Lets add some properties here, similar to what the other servlets are using.", "author": "carlosmunoz", "createdAt": "2020-05-07T11:06:32Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/SimpleFilter.java", "diffHunk": "@@ -49,22 +54,30 @@\n  *     @Property(name=\"service.ranking\", intValue=1)\n  * })\n  */\n-//@SlingFilter(order=1, description=\"A Simple Filter\")\n-//@Property(name=\"service.vendor\", value=\"The Apache Software Foundation\")", "originalCommit": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3NzgzMg==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421577832", "bodyText": "done", "author": "xdavidson", "createdAt": "2020-05-07T15:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMTk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMzA5MQ==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421423091", "bodyText": "GET  and HEAD will do for now, but we might need to extend this to other methods.", "author": "carlosmunoz", "createdAt": "2020-05-07T11:08:42Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/SimpleFilter.java", "diffHunk": "@@ -49,22 +54,30 @@\n  *     @Property(name=\"service.ranking\", intValue=1)\n  * })\n  */\n-//@SlingFilter(order=1, description=\"A Simple Filter\")\n-//@Property(name=\"service.vendor\", value=\"The Apache Software Foundation\")\n+@Component\n+@SlingServletFilter(scope = {SlingServletFilterScope.REQUEST},\n+                    methods = {\"GET\",\"HEAD\"})", "originalCommit": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3OTMxMA==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421579310", "bodyText": "i added pattern value to limit when this filter will run:\n@SlingServletFilter(scope = {SlingServletFilterScope.REQUEST},\npattern = \"/api/.*\",\nmethods = {\"GET\",\"HEAD\", \"OPTIONS\"})", "author": "xdavidson", "createdAt": "2020-05-07T15:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMzI4Ng==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421423286", "bodyText": "You are missing the OPTIONS method in your annotation above.", "author": "carlosmunoz", "createdAt": "2020-05-07T11:09:05Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/SimpleFilter.java", "diffHunk": "@@ -49,22 +54,30 @@\n  *     @Property(name=\"service.ranking\", intValue=1)\n  * })\n  */\n-//@SlingFilter(order=1, description=\"A Simple Filter\")\n-//@Property(name=\"service.vendor\", value=\"The Apache Software Foundation\")\n+@Component\n+@SlingServletFilter(scope = {SlingServletFilterScope.REQUEST},\n+                    methods = {\"GET\",\"HEAD\"})\n public class SimpleFilter implements Filter {\n     \n+    public static final String DOMAIN_ALLOWED = \".redhat.com\";\n     private final Logger log = LoggerFactory.getLogger(SimpleFilter.class);\n \n     public void init(FilterConfig filterConfig) throws ServletException {\n     }\n \n-    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException,\n+    public void doFilter(final ServletRequest req, final ServletResponse res, final FilterChain chain) throws IOException,\n             ServletException {\n-        log.info(\"filter invoked - start\");\n+        final SlingHttpServletRequest request = (SlingHttpServletRequest)req;\n+        final SlingHttpServletResponse response = (SlingHttpServletResponse)res;\n+        String origin = request.getHeader(\"Origin\");\n+        if (origin != null) {\n+            if (origin.contains(DOMAIN_ALLOWED)) {\n+                 response.addHeader(\"Access-control-Allow-Origin\", origin);\n+                 response.addHeader(\"Access-control-Allow-Methods\", \"GET, HEAD, OPTIONS\");", "originalCommit": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3OTQzNw==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421579437", "bodyText": "updated", "author": "xdavidson", "createdAt": "2020-05-07T15:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMzI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyNTAyNA==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421425024", "bodyText": "not a blocker, but since this is a security-related change, I would make this condition a bit tighter. Maybe endsWith would work, or a regular expression check.\nMaybe I'm being too careful here.. so I'll leave this decision to you.", "author": "carlosmunoz", "createdAt": "2020-05-07T11:12:28Z", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/SimpleFilter.java", "diffHunk": "@@ -49,22 +54,30 @@\n  *     @Property(name=\"service.ranking\", intValue=1)\n  * })\n  */\n-//@SlingFilter(order=1, description=\"A Simple Filter\")\n-//@Property(name=\"service.vendor\", value=\"The Apache Software Foundation\")\n+@Component\n+@SlingServletFilter(scope = {SlingServletFilterScope.REQUEST},\n+                    methods = {\"GET\",\"HEAD\"})\n public class SimpleFilter implements Filter {\n     \n+    public static final String DOMAIN_ALLOWED = \".redhat.com\";\n     private final Logger log = LoggerFactory.getLogger(SimpleFilter.class);\n \n     public void init(FilterConfig filterConfig) throws ServletException {\n     }\n \n-    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException,\n+    public void doFilter(final ServletRequest req, final ServletResponse res, final FilterChain chain) throws IOException,\n             ServletException {\n-        log.info(\"filter invoked - start\");\n+        final SlingHttpServletRequest request = (SlingHttpServletRequest)req;\n+        final SlingHttpServletResponse response = (SlingHttpServletResponse)res;\n+        String origin = request.getHeader(\"Origin\");\n+        if (origin != null) {\n+            if (origin.contains(DOMAIN_ALLOWED)) {", "originalCommit": "aad151e59e3f7271a8d86274ae32d215d0dd7c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3OTU1NQ==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421579555", "bodyText": "updated", "author": "xdavidson", "createdAt": "2020-05-07T15:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyNTAyNA=="}], "type": "inlineReview"}, {"oid": "5c0d9ea5db6797344c865abae315beb46ea6814c", "url": "https://github.com/redhataccess/pantheon/commit/5c0d9ea5db6797344c865abae315beb46ea6814c", "message": "code review fixes", "committedDate": "2020-05-07T15:05:09Z", "type": "commit"}, {"oid": "724cb0eb71da75fdb66a4d6692991dd31ccae59d", "url": "https://github.com/redhataccess/pantheon/commit/724cb0eb71da75fdb66a4d6692991dd31ccae59d", "message": "add junit test for CorsEnablingFilter", "committedDate": "2020-05-07T16:04:43Z", "type": "commit"}, {"oid": "926346bdb4556105e44023185ef0bb9204ea71ed", "url": "https://github.com/redhataccess/pantheon/commit/926346bdb4556105e44023185ef0bb9204ea71ed", "message": "clean up", "committedDate": "2020-05-07T16:06:26Z", "type": "commit"}, {"oid": "7c7aa98f2fcaf2b644bcf2ac6579cd74f144cba3", "url": "https://github.com/redhataccess/pantheon/commit/7c7aa98f2fcaf2b644bcf2ac6579cd74f144cba3", "message": "cleanup", "committedDate": "2020-05-07T18:14:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc0OTA1Ng==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421749056", "bodyText": "I would add the verification that the headers are being set. I'll approve the PR, but consider adding this to the unit test otherwise the only thing being tested is that the doFilter method is invoked, which actually happens on every invocation.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    verify(chain).doFilter(request, response);\n          \n          \n            \n                    verify(chain).doFilter(request, response);\n          \n          \n            \n                    verify(response).addHeader(\"Access-control-Allow-Origin\", \"https://www.redhat.com\");\n          \n          \n            \n                    verify(response).addHeader(\"Access-control-Allow-Methods\", \"GET, HEAD, OPTIONS\");", "author": "carlosmunoz", "createdAt": "2020-05-07T19:42:09Z", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/CorsEnablingFilterTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.redhat.pantheon.servlet;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.PrintWriter;\n+\n+import javax.servlet.FilterChain;\n+\n+import org.apache.sling.api.SlingHttpServletResponse;\n+import org.apache.sling.api.resource.ResourceResolver;\n+import org.apache.sling.api.servlets.HttpConstants;\n+import org.apache.sling.testing.mock.sling.MockSling;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+@ExtendWith({SlingContextExtension.class})\n+public class CorsEnablingFilterTest {\n+\n+    private SlingHttpServletResponse response = null;\n+    private FilterChain chain = null;\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+\n+    @BeforeEach\n+    public void setUp() throws Exception {\n+        // Create mocks for required variables\n+        response = mock(SlingHttpServletResponse.class);\n+        chain = mock(FilterChain.class);\n+    }\n+\n+    @AfterEach\n+    public void tearDown() throws Exception {\n+        // Clear variables during teardown\n+        // Not actually necessary as they get re-initialized in setUp\n+        response = null;\n+        chain = null;\n+    }\n+\n+    @Test\n+    public void testDoFilter() throws Exception {\n+        // prepare sling request\n+        ResourceResolver resourceResolver = MockSling.newResourceResolver(slingContext.bundleContext());\n+        MockSlingHttpServletRequest request = new MockSlingHttpServletRequest(resourceResolver);\n+\n+        // simulate query string\n+        request.setQueryString(\"locale=en-us&module_id=123-456-789\");\n+\n+        // set current resource\n+        request.setResource(resourceResolver.getResource(\"/api/module\"));\n+\n+        // set method\n+        request.setMethod(HttpConstants.METHOD_GET);\n+\n+        // set headers\n+        request.addHeader(\"Origin\", \"https://www.redhat.com\");\n+\n+        CorsEnablingFilter filter = new CorsEnablingFilter();\n+\n+        // Execute the method with the mocks we want to test\n+        filter.doFilter(request, response, chain);\n+\n+        // Verify that chain.doFilter() was called\n+        verify(chain).doFilter(request, response);", "originalCommit": "7c7aa98f2fcaf2b644bcf2ac6579cd74f144cba3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1MjcwMA==", "url": "https://github.com/redhataccess/pantheon/pull/286#discussion_r421752700", "bodyText": "thank you for the suggestion!", "author": "xdavidson", "createdAt": "2020-05-07T19:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc0OTA1Ng=="}], "type": "inlineReview"}, {"oid": "0653f998b296bb3a3acf53a50c99b3dbd6352dc6", "url": "https://github.com/redhataccess/pantheon/commit/0653f998b296bb3a3acf53a50c99b3dbd6352dc6", "message": "verify headers", "committedDate": "2020-05-07T19:47:50Z", "type": "commit"}]}