{"pr_number": 206, "pr_title": "Fixed issue on rename", "pr_createdAt": "2020-11-10T14:03:36Z", "pr_url": "https://github.com/ExpediaGroup/circus-train/pull/206", "timeline": [{"oid": "0f4027feef3cf970731f8dca5c620873a438b723", "url": "https://github.com/ExpediaGroup/circus-train/commit/0f4027feef3cf970731f8dca5c620873a438b723", "message": "Fixed issue on rename", "committedDate": "2020-11-10T14:00:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU4NTg3Mw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520585873", "bodyText": "these test were wrong cause the \"test\" table object was injected into the real code and then mutated so the test weren't testing what they thought they were testing. Was never failing.", "author": "patduin", "createdAt": "2020-11-10T14:04:47Z", "path": "circus-train-core/src/test/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperationTest.java", "diffHunk": "@@ -55,8 +55,8 @@ public void setUp() throws TException {\n     toTable.setTableName(TO_TABLE_NAME);\n     fromTable.setDbName(FROM_DB_NAME);\n     toTable.setDbName(TO_DB_NAME);\n-    when(client.getTable(FROM_DB_NAME, FROM_TABLE_NAME)).thenReturn(fromTable);\n-    when(client.getTable(TO_DB_NAME, TO_TABLE_NAME)).thenReturn(toTable);\n+    when(client.getTable(FROM_DB_NAME, FROM_TABLE_NAME)).thenReturn(new Table(fromTable));", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NTg0MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520595840", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      .info(\"Alter table {}.{} to {}.{}\", toTable.getDbName(), toTableName, toTable.getDbName(),\n          \n          \n            \n                      .info(\"Renaming table {}.{} to {}.{}\", toTable.getDbName(), toTableName, toTable.getDbName(),", "author": "massdosage", "createdAt": "2020-11-10T14:18:14Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperation.java", "diffHunk": "@@ -40,20 +40,27 @@ public RenameTableOperation(DropTableService dropTableService) {\n    * renamed.\n    */\n   public void execute(CloseableMetaStoreClient client, Table from, Table to) throws Exception {\n-    LOG\n-        .info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(),\n-            to.getTableName());\n+    LOG.info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(), to.getTableName());\n     Table fromTable = client.getTable(from.getDbName(), from.getTableName());\n     Table toTable = client.getTable(to.getDbName(), to.getTableName());\n+    String fromDatabaseName = fromTable.getDbName();\n     String fromTableName = fromTable.getTableName();\n     String toTableName = toTable.getTableName();\n     String toDelete = toTableName + DELETE_ME;\n     try {\n+      fromTable.setDbName(toTable.getDbName());\n       fromTable.setTableName(toTableName);\n       toTable.setTableName(toDelete);\n+      LOG\n+          .info(\"Alter table {}.{} to {}.{}\", toTable.getDbName(), toTableName, toTable.getDbName(),", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5Njc5Mg==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520596792", "bodyText": "Also, shouldn't the first two arguments be the \"from\" values? Same in the log statement below.", "author": "massdosage", "createdAt": "2020-11-10T14:19:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NzU4Ng==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520597586", "bodyText": "Alternatively we remove these two new log statements and just keep the one we already had.", "author": "massdosage", "createdAt": "2020-11-10T14:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MjEwNQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r527552105", "bodyText": "It's more clear when you actually read the log messages in test and when running CT.", "author": "patduin", "createdAt": "2020-11-20T09:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NTg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NjAyMA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520596020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      .info(\"Alter table {}.{} to {}.{}\", fromDatabaseName, fromTableName, fromTable.getDbName(),\n          \n          \n            \n                      .info(\"Renamed table {}.{} to {}.{}\", fromDatabaseName, fromTableName, fromTable.getDbName(),", "author": "massdosage", "createdAt": "2020-11-10T14:18:28Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperation.java", "diffHunk": "@@ -40,20 +40,27 @@ public RenameTableOperation(DropTableService dropTableService) {\n    * renamed.\n    */\n   public void execute(CloseableMetaStoreClient client, Table from, Table to) throws Exception {\n-    LOG\n-        .info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(),\n-            to.getTableName());\n+    LOG.info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(), to.getTableName());\n     Table fromTable = client.getTable(from.getDbName(), from.getTableName());\n     Table toTable = client.getTable(to.getDbName(), to.getTableName());\n+    String fromDatabaseName = fromTable.getDbName();\n     String fromTableName = fromTable.getTableName();\n     String toTableName = toTable.getTableName();\n     String toDelete = toTableName + DELETE_ME;\n     try {\n+      fromTable.setDbName(toTable.getDbName());\n       fromTable.setTableName(toTableName);\n       toTable.setTableName(toDelete);\n+      LOG\n+          .info(\"Alter table {}.{} to {}.{}\", toTable.getDbName(), toTableName, toTable.getDbName(),\n+              toTable.getTableName());\n       client.alter_table(toTable.getDbName(), toTableName, toTable);\n-      client.alter_table(fromTable.getDbName(), fromTableName, fromTable);\n+      LOG\n+          .info(\"Alter table {}.{} to {}.{}\", fromDatabaseName, fromTableName, fromTable.getDbName(),", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MTc0OQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r527551749", "bodyText": "that's wrong, I kept the \"alter\" but changed to \"Altering\"\nIf you run the tests the logs read like this and are very clear:\n- Renaming table old_db.old_table to new_db.new_table\n- Altering table new_db.new_table to new_db.new_table_delete_me\n- Altering table old_db.old_table to new_db.new_table\n- Dropping table new_db.new_table_delete_me", "author": "patduin", "createdAt": "2020-11-20T09:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NjAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5Nzc2MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520597760", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.info(\"Drop table {}.{}\", toTable.getDbName(), toDelete);\n          \n          \n            \n                  LOG.info(\"Dropping table {}.{}\", toTable.getDbName(), toDelete);", "author": "massdosage", "createdAt": "2020-11-10T14:20:40Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperation.java", "diffHunk": "@@ -40,20 +40,27 @@ public RenameTableOperation(DropTableService dropTableService) {\n    * renamed.\n    */\n   public void execute(CloseableMetaStoreClient client, Table from, Table to) throws Exception {\n-    LOG\n-        .info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(),\n-            to.getTableName());\n+    LOG.info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(), to.getTableName());\n     Table fromTable = client.getTable(from.getDbName(), from.getTableName());\n     Table toTable = client.getTable(to.getDbName(), to.getTableName());\n+    String fromDatabaseName = fromTable.getDbName();\n     String fromTableName = fromTable.getTableName();\n     String toTableName = toTable.getTableName();\n     String toDelete = toTableName + DELETE_ME;\n     try {\n+      fromTable.setDbName(toTable.getDbName());\n       fromTable.setTableName(toTableName);\n       toTable.setTableName(toDelete);\n+      LOG\n+          .info(\"Alter table {}.{} to {}.{}\", toTable.getDbName(), toTableName, toTable.getDbName(),\n+              toTable.getTableName());\n       client.alter_table(toTable.getDbName(), toTableName, toTable);\n-      client.alter_table(fromTable.getDbName(), fromTableName, fromTable);\n+      LOG\n+          .info(\"Alter table {}.{} to {}.{}\", fromDatabaseName, fromTableName, fromTable.getDbName(),\n+              fromTable.getTableName());\n+      client.alter_table(fromDatabaseName, fromTableName, fromTable);\n     } finally {\n+      LOG.info(\"Drop table {}.{}\", toTable.getDbName(), toDelete);", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDg0MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r527550840", "bodyText": "done", "author": "patduin", "createdAt": "2020-11-20T09:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5Nzc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMTgwNQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520601805", "bodyText": "Might be worth adding in the comment lines above the logs like we have in Cloverleaf? I find it a bit easier to follow", "author": "JayGreeeen", "createdAt": "2020-11-10T14:25:44Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperation.java", "diffHunk": "@@ -40,20 +40,27 @@ public RenameTableOperation(DropTableService dropTableService) {\n    * renamed.\n    */\n   public void execute(CloseableMetaStoreClient client, Table from, Table to) throws Exception {\n-    LOG\n-        .info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(),\n-            to.getTableName());\n+    LOG.info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(), to.getTableName());\n     Table fromTable = client.getTable(from.getDbName(), from.getTableName());\n     Table toTable = client.getTable(to.getDbName(), to.getTableName());\n+    String fromDatabaseName = fromTable.getDbName();\n     String fromTableName = fromTable.getTableName();\n     String toTableName = toTable.getTableName();\n     String toDelete = toTableName + DELETE_ME;\n     try {\n+      fromTable.setDbName(toTable.getDbName());\n       fromTable.setTableName(toTableName);\n       toTable.setTableName(toDelete);\n+      LOG", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDc1NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r527550754", "bodyText": "ok", "author": "patduin", "createdAt": "2020-11-20T09:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMTgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMjg1MQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r520602851", "bodyText": "Worth also having String toDatabaseName = toTable.getDbName() ?\ntoTable.getDbName() is called quite a few times", "author": "JayGreeeen", "createdAt": "2020-11-10T14:27:09Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/replica/hive/RenameTableOperation.java", "diffHunk": "@@ -40,20 +40,27 @@ public RenameTableOperation(DropTableService dropTableService) {\n    * renamed.\n    */\n   public void execute(CloseableMetaStoreClient client, Table from, Table to) throws Exception {\n-    LOG\n-        .info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(),\n-            to.getTableName());\n+    LOG.info(\"Renaming table {}.{} to {}.{}\", from.getDbName(), from.getTableName(), to.getDbName(), to.getTableName());\n     Table fromTable = client.getTable(from.getDbName(), from.getTableName());\n     Table toTable = client.getTable(to.getDbName(), to.getTableName());\n+    String fromDatabaseName = fromTable.getDbName();\n     String fromTableName = fromTable.getTableName();\n     String toTableName = toTable.getTableName();", "originalCommit": "0f4027feef3cf970731f8dca5c620873a438b723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1MDcxNA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/206#discussion_r527550714", "bodyText": "sure", "author": "patduin", "createdAt": "2020-11-20T09:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYwMjg1MQ=="}], "type": "inlineReview"}, {"oid": "c9a9720ec99b6e1067465fef6d50212fd022c8fb", "url": "https://github.com/ExpediaGroup/circus-train/commit/c9a9720ec99b6e1067465fef6d50212fd022c8fb", "message": "fine tuning", "committedDate": "2020-11-20T09:13:34Z", "type": "commit"}]}