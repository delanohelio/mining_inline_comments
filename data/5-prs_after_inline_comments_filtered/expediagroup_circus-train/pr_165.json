{"pr_number": 165, "pr_title": "applying limit when creating the partition filter", "pr_createdAt": "2020-01-24T16:26:19Z", "pr_url": "https://github.com/ExpediaGroup/circus-train/pull/165", "timeline": [{"oid": "1f570bf194ec9eb13d2004a6ba0f8cc05402983d", "url": "https://github.com/ExpediaGroup/circus-train/commit/1f570bf194ec9eb13d2004a6ba0f8cc05402983d", "message": "applying limit when creating the partition filter", "committedDate": "2020-01-24T16:25:11Z", "type": "commit"}, {"oid": "d9b3e22b490606e9f4c7209c9792f9e15086807b", "url": "https://github.com/ExpediaGroup/circus-train/commit/d9b3e22b490606e9f4c7209c9792f9e15086807b", "message": "reversing order so we pick new partitions first by default (given partitions are date strings)", "committedDate": "2020-01-24T16:51:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI5Mzk2MQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371293961", "bodyText": "How comes this isn't initialised to UNLIMITED here? This is only to figure out the limit on line 183 in HiveDifferences right?", "author": "max-jacobs", "createdAt": "2020-01-27T15:07:43Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicate.java", "diffHunk": "@@ -45,6 +46,7 @@\n   private final Function<Path, String> checksumFunction;\n   private String partitionPredicate;\n   private boolean generated = false;\n+  private Short partitionLimit = -1;", "originalCommit": "d9b3e22b490606e9f4c7209c9792f9e15086807b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMjMyMw==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371432323", "bodyText": "UNLIMITED is max int\npartitionLimit for hive fetch partition call is -1 for being unlimited.\nSo I map -1 to max int in HiveDiferences so my loop nicely reads while (i < limit) https://github.com/HotelsDotCom/circus-train/blob/3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7/circus-train-comparator/src/main/java/com/hotels/bdp/circustrain/comparator/hive/HiveDifferences.java#L219\nit's mostly sugarcoating to be honest...", "author": "patduin", "createdAt": "2020-01-27T19:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI5Mzk2MQ=="}], "type": "inlineReview"}, {"oid": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7", "url": "https://github.com/ExpediaGroup/circus-train/commit/3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7", "message": "reworded", "committedDate": "2020-01-27T15:33:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTg2NA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371329864", "bodyText": "What if the partitionLimit is 0?", "author": "nvitucci", "createdAt": "2020-01-27T16:04:51Z", "path": "circus-train-comparator/src/main/java/com/hotels/bdp/circustrain/comparator/hive/HiveDifferences.java", "diffHunk": "@@ -162,14 +171,16 @@ private HiveDifferences(\n       Iterator<Partition> sourcePartitionIterator,\n       Optional<Table> replicaTable,\n       Optional<? extends PartitionFetcher> replicaPartitionFetcher,\n-      Function<Path, String> checksumFunction) {\n+      Function<Path, String> checksumFunction,\n+      int partitionLimit) {\n     this.diffListener = diffListener;\n     this.comparatorRegistry = comparatorRegistry;\n     this.sourceTable = sourceTable;\n     this.sourcePartitionIterator = sourcePartitionIterator;\n     this.replicaTable = replicaTable;\n     this.replicaPartitionFetcher = replicaPartitionFetcher;\n     this.checksumFunction = checksumFunction;\n+    this.partitionLimit = partitionLimit < 0 ? UNLIMITED : partitionLimit;", "originalCommit": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMTYwMQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371431601", "bodyText": "then it's 0, and stays 0 and you get 0 partitions back just like you asked :)", "author": "patduin", "createdAt": "2020-01-27T19:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTg2NA=="}], "type": "inlineReview"}, {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "url": "https://github.com/ExpediaGroup/circus-train/commit/47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "message": "typo", "committedDate": "2020-01-27T19:22:11Z", "type": "commit"}, {"oid": "7fdb171d404a385d109c145a303afc4ce0248978", "url": "https://github.com/ExpediaGroup/circus-train/commit/7fdb171d404a385d109c145a303afc4ce0248978", "message": "newline", "committedDate": "2020-01-28T10:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyOTc0OQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371729749", "bodyText": "Isn't this also a change in behaviour that we should mention in the CHANGELOG? HiveDiff will now process the partitions with newest first while in the past it was oldest first?", "author": "massdosage", "createdAt": "2020-01-28T10:47:32Z", "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicate.java", "diffHunk": "@@ -55,19 +57,23 @@ public DiffGeneratedPartitionPredicate(\n     this.replica = replica;\n     this.tableReplication = tableReplication;\n     this.checksumFunction = checksumFunction;\n+    if (tableReplication.getSourceTable().getPartitionLimit() != null) {\n+      partitionLimit = tableReplication.getSourceTable().getPartitionLimit();\n+    }\n   }\n \n   private String generate() {\n     try (CloseableMetaStoreClient sourceMetastore = source.getMetaStoreClientSupplier().get()) {\n       try (CloseableMetaStoreClient replicaMetastore = replica.getMetaStoreClientSupplier().get()) {\n         Table sourceTable = source.getTableAndStatistics(tableReplication).getTable();\n         PartitionIterator partitionIterator = new PartitionIterator(sourceMetastore, sourceTable,\n-            tableReplication.getPartitionIteratorBatchSize());\n+            tableReplication.getPartitionIteratorBatchSize(), Ordering.REVERSE);", "originalCommit": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczODA4OA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371738088", "bodyText": "yeah I'll add a note", "author": "patduin", "createdAt": "2020-01-28T11:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyOTc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMDE2MA==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371730160", "bodyText": "I can't make up my mind whether this would be considered a breaking change. Technically I think it is, but I guess most of our end users wouldn't notice?", "author": "massdosage", "createdAt": "2020-01-28T10:48:26Z", "path": "circus-train-core/src/test/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicateTest.java", "diffHunk": "@@ -106,17 +105,23 @@ public void setUp() throws Exception {\n   public void autogeneratePredicate() throws Exception {\n     when(replica.getTableAndStatistics(tableReplication)).thenReturn(replicaTableAndStats);\n     when(replicaTableAndStats.getTable()).thenReturn(table2);\n+    when(sourceTable.getPartitionLimit()).thenReturn((short) 10);\n+\n+    predicate = new DiffGeneratedPartitionPredicate(source, replica, tableReplication, checksumFunction);\n \n     assertThat(predicate.getPartitionPredicate(),\n-        is(\"(p1='value1' AND p2='value2') OR (p1='value11' AND p2='value22')\"));\n+        is(\"(p1='value11' AND p2='value22') OR (p1='value1' AND p2='value2')\"));", "originalCommit": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczODc5NQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371738795", "bodyText": "I was doubting if we should make it configurable, but to be honest i you're using hiveDiff and your whole table is copied its all the same. It's just for the backfill, I think it's not a breaking change.", "author": "patduin", "createdAt": "2020-01-28T11:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMDE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0MDMyOQ==", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371740329", "bodyText": "OK, then let's just document it in the CHANGELOG. If there is an easy place to mention the order that HiveDiff processes the partitions in the README that would be nice but not required. We could add a feature to make it configurable in the future if anyone ever actually needs it.", "author": "massdosage", "createdAt": "2020-01-28T11:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMDE2MA=="}], "type": "inlineReview"}, {"oid": "26f05f1302ad10928d6a7dd2fdb0d0846f255839", "url": "https://github.com/ExpediaGroup/circus-train/commit/26f05f1302ad10928d6a7dd2fdb0d0846f255839", "message": "removed", "committedDate": "2020-01-28T11:09:39Z", "type": "commit"}, {"oid": "4eb28377c0c4dfd4271255337ad58fa15e43c131", "url": "https://github.com/ExpediaGroup/circus-train/commit/4eb28377c0c4dfd4271255337ad58fa15e43c131", "message": "Added note about the HiveDiff order", "committedDate": "2020-01-28T11:18:59Z", "type": "commit"}, {"oid": "1743ed38c63f338a9bd2cb1d63340557cee7607d", "url": "https://github.com/ExpediaGroup/circus-train/commit/1743ed38c63f338a9bd2cb1d63340557cee7607d", "message": "Update CHANGELOG.md\n\nCo-Authored-By: Adrian Woodhead <awoodhead@expediagroup.com>", "committedDate": "2020-01-28T12:01:17Z", "type": "commit"}]}