{"pr_number": 4570, "pr_title": "ECOSYS-118 OpenID Connect session timeout association with access and/or identity token expiry", "pr_createdAt": "2020-03-10T14:05:05Z", "pr_url": "https://github.com/payara/Payara/pull/4570", "timeline": [{"oid": "83f23ad745e38524e532e5daccf47d6b00cee68f", "url": "https://github.com/payara/Payara/commit/83f23ad745e38524e532e5daccf47d6b00cee68f", "message": "ECOSYS-118 Validate AccessToken expiry on each request", "committedDate": "2020-03-10T13:59:26Z", "type": "commit"}, {"oid": "f660aa5a4b09f138fded6c0b985697e8a00b0163", "url": "https://github.com/payara/Payara/commit/f660aa5a4b09f138fded6c0b985697e8a00b0163", "message": "ECOSYS-118 COPYRIGHT YEAR update", "committedDate": "2020-03-23T11:37:18Z", "type": "commit"}, {"oid": "c5a4900b3e1f812e240f54ee4b7ea6589e2fe66a", "url": "https://github.com/payara/Payara/commit/c5a4900b3e1f812e240f54ee4b7ea6589e2fe66a", "message": "Fixes expires_in claim datatype\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>", "committedDate": "2020-05-28T11:15:39Z", "type": "commit"}, {"oid": "55d4f549214950d3773b45e7808a579de791736d", "url": "https://github.com/payara/Payara/commit/55d4f549214950d3773b45e7808a579de791736d", "message": "ECOSYS-118 OpenID Connect session timeout association with access and/or identity token expiry\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>", "committedDate": "2020-05-29T10:32:42Z", "type": "commit"}, {"oid": "5ee958716ac29b63fd7c623108732fec66fc5228", "url": "https://github.com/payara/Payara/commit/5ee958716ac29b63fd7c623108732fec66fc5228", "message": "ECOSYS-118 OpenID Connect end_session_endpoint support\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>", "committedDate": "2020-06-01T04:27:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzNzg5Mw==", "url": "https://github.com/payara/Payara/pull/4570#discussion_r436237893", "bodyText": "They way you've nested this means that tokenAutoRefresh is ignored if at least one of accessTokenExpiry or identityTokenExpiry isn't true.\nOn one hand, I think this makes sense because if a user has set tokenAutoRefresh then logically the application requires a valid access token to function. On the other hand, maybe someone wants to automatically refresh tokens, but they don't want the user to be logged-out if the tokens expire.\nIf this is the intended behaviour, then the documentation should be clear that tokenAutoRefresh only works when at least one of accessTokenExpiry or identityTokenExpiry is set.", "author": "sharpedavid", "createdAt": "2020-06-06T04:51:21Z", "path": "appserver/payara-appserver-modules/security-openid/src/main/java/fish/payara/security/openid/OpenIdAuthenticationMechanism.java", "diffHunk": "@@ -214,9 +220,30 @@ public AuthenticationStatus validateRequest(\n                 throw new AuthenticationException(\"Failed to register CallerPrincipalCallback.\", ex);\n             }\n \n-            if (configuration.isTokenAutoRefresh()) {\n+            LogoutConfiguration logout = configuration.getLogoutConfiguration();\n+            boolean accessTokenExpired = this.context.getAccessToken().isExpired();\n+            boolean identityTokenExpired = this.context.getIdentityToken().isExpired();\n+            if (logout.isIdentityTokenExpiry()) {\n+                LOGGER.log(Level.FINE, \"UserPrincipal is set, check if Identity Token is valid.\");\n+            }\n+            if (logout.isAccessTokenExpiry()) {\n                 LOGGER.log(Level.FINE, \"UserPrincipal is set, check if Access Token is valid.\");\n-                return this.reAuthenticate(request, response, httpContext);\n+            }\n+\n+            if((logout.isAccessTokenExpiry() && accessTokenExpired)\n+                    || (logout.isIdentityTokenExpiry() && identityTokenExpired)) {\n+                if (configuration.isTokenAutoRefresh()) {", "originalCommit": "5ee958716ac29b63fd7c623108732fec66fc5228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzODk2Ng==", "url": "https://github.com/payara/Payara/pull/4570#discussion_r436238966", "bodyText": "Hi,\nYes, it is intended behavior, I will update the documentation. Also IMO accessTokenExpiry should be true by default, WDYT?", "author": "jGauravGupta", "createdAt": "2020-06-06T05:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzNzg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0MTYzOA==", "url": "https://github.com/payara/Payara/pull/4570#discussion_r436241638", "bodyText": "Access tokens are usually short-lived. It's 5 minutes by default on Keycloak. So if accessTokenExpiry is true by default, then maybe tokenAutoRefresh should also be true by default otherwise that's a really short idle timeout (assuming 5 minutes). See what I mean?\nI think you can make a good case for either being the default, true or false. On one hand false is simpler and reduces network traffic, on the other hand I think most people will want to use true once they realize the benefits of tying their Payara session to OIDC token expiry.", "author": "sharpedavid", "createdAt": "2020-06-06T05:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzNzg5Mw=="}], "type": "inlineReview"}, {"oid": "90796d0f57137e588776d40b495a05c068be6c3c", "url": "https://github.com/payara/Payara/commit/90796d0f57137e588776d40b495a05c068be6c3c", "message": "ECOSYS-118 OpenID Connect programmatic logout via OpenIdContext\n\nSigned-off-by: Gaurav Gupta <gaurav.gupta@payara.fish>", "committedDate": "2020-06-06T17:33:28Z", "type": "commit"}, {"oid": "4fc420e967ab3d5507d6bed1c991e81bcdf9d9c8", "url": "https://github.com/payara/Payara/commit/4fc420e967ab3d5507d6bed1c991e81bcdf9d9c8", "message": "Merge branch 'master' into ECOSYS-118", "committedDate": "2020-06-06T17:40:06Z", "type": "commit"}]}