{"pr_number": 4966, "pr_title": "FISH-327 Implement MicroProfile Sniffers", "pr_createdAt": "2020-10-27T10:30:12Z", "pr_url": "https://github.com/payara/Payara/pull/4966", "timeline": [{"oid": "28b73bd32ff20437b679854af2d5f7124bb8b910", "url": "https://github.com/payara/Payara/commit/28b73bd32ff20437b679854af2d5f7124bb8b910", "message": "FISH-327 Implement MicroProfile Connector Module\n\nImplement a new base module for each MicroProfile implementation to\nextend to provide their sniffers.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T09:52:34Z", "type": "commit"}, {"oid": "d0073114146ee03cfdcbe98fff84fe1d5367726a", "url": "https://github.com/payara/Payara/commit/d0073114146ee03cfdcbe98fff84fe1d5367726a", "message": "FISH-327 Implement MicroProfile OpenAPI Sniffer\n\nOpenAPI implementation now uses a sniffer to determine if the\napplication is appropriate for OpenAPI scanning.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T09:54:03Z", "type": "commit"}, {"oid": "023866b60d4b3159652e73592f9f0607cbc39178", "url": "https://github.com/payara/Payara/commit/023866b60d4b3159652e73592f9f0607cbc39178", "message": "FISH-327 Implement MicroProfile Metrics Sniffer\n\nMetrics now uses a sniffer to determine if the servlet or CDI extensions\nare necessary to deploy.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T09:55:52Z", "type": "commit"}, {"oid": "372c734ed5ae53a3a15e6a4de79faf41fa8b3748", "url": "https://github.com/payara/Payara/commit/372c734ed5ae53a3a15e6a4de79faf41fa8b3748", "message": "FISH-327 Implement MicroProfile Health Sniffer\n\nOnly run health CDI extension and servlet when the sniffer detects a MP\ncompatible application. Move CDI bean registration from the\nServletContextListener into its own CDI extension.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T10:05:03Z", "type": "commit"}, {"oid": "49ae71f3f270d167ae6664cc3229875dad2e5a72", "url": "https://github.com/payara/Payara/commit/49ae71f3f270d167ae6664cc3229875dad2e5a72", "message": "FISH-327 Implement MicroProfile Fault Tolerance Sniffer\n\nAdded a sniffer to only apply the CDI extension when the fault tolerance\nannotations have been detected.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T10:06:12Z", "type": "commit"}, {"oid": "d95d8fcce346a9deb2e24478b358f126f5528560", "url": "https://github.com/payara/Payara/commit/d95d8fcce346a9deb2e24478b358f126f5528560", "message": "FISH-327 Implement MicroProfile JWT Auth Sniffer\n\nMove the RolesDeclaredInitializer and CDI Extension behind the sniffer\nlogic, to improve startup performance.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T10:07:06Z", "type": "commit"}, {"oid": "4592003f2abd7720a90694a7d4f8de00fdff8061", "url": "https://github.com/payara/Payara/commit/4592003f2abd7720a90694a7d4f8de00fdff8061", "message": "FISH-327 Implement MicroProfile Config Sniffer\n\nOnly enable CDI extension when the @ConfigProperty annotation is\ndetected.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T10:07:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzNzU0Mw==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r512637543", "bodyText": "much nicer using an array literal, something like\nreturn { org.eclipse.microprofile.config.inject.ConfigProperty.class }\nMaybe also use a import for ConfigProperty?", "author": "jbee", "createdAt": "2020-10-27T12:05:36Z", "path": "appserver/payara-appserver-modules/microprofile/config/src/main/java/fish/payara/microprofile/config/ConfigSniffer.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.config;\n+\n+import java.lang.annotation.Annotation;\n+\n+import org.glassfish.hk2.api.PerLookup;\n+import org.jvnet.hk2.annotations.Service;\n+\n+import fish.payara.microprofile.connector.MicroProfileSniffer;\n+\n+@Service\n+@PerLookup\n+public class ConfigSniffer extends MicroProfileSniffer {\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public Class<? extends Annotation>[] getAnnotationTypes() {\n+        Class<? extends Annotation>[] annotations = new Class[1];\n+\n+        // Search for ConfigProperty annotation used in the CDI extension\n+        annotations[0] = org.eclipse.microprofile.config.inject.ConfigProperty.class;\n+\n+        return annotations;", "originalCommit": "4592003f2abd7720a90694a7d4f8de00fdff8061", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzODQ1Ng==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r512638456", "bodyText": "Why override the methods identical to how they are implemented in the super class?", "author": "jbee", "createdAt": "2020-10-27T12:07:05Z", "path": "appserver/payara-appserver-modules/microprofile/fault-tolerance/src/main/java/fish/payara/microprofile/faulttolerance/FaultToleranceApplicationContainer.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.faulttolerance;\n+\n+import org.glassfish.api.deployment.ApplicationContext;\n+import org.glassfish.api.deployment.DeploymentContext;\n+\n+import fish.payara.microprofile.connector.MicroProfileApplicationContainer;\n+\n+public class FaultToleranceApplicationContainer extends MicroProfileApplicationContainer {\n+\n+    protected FaultToleranceApplicationContainer(DeploymentContext deploymentContext) {\n+        super(deploymentContext);\n+    }\n+\n+    @Override\n+    public boolean start(ApplicationContext ctx) throws Exception {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean stop(ApplicationContext ctx) {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean resume() throws Exception {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean suspend() {\n+        return true;\n+    }", "originalCommit": "4592003f2abd7720a90694a7d4f8de00fdff8061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc0NDEzNg==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r512744136", "bodyText": "These aren't implemented in the superclass which is why they're required. I'm hesitant to implement them in the super class, as thinking abstractly it doesn't make sense to me to have these as the default implementation. I want to remove the instances of \"magic\" that make the class harder to understand. I can add some javadocs to explain what these methods are doing?", "author": "MattGill98", "createdAt": "2020-10-27T14:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzODQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5NjQ3MA==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r513296470", "bodyText": "Must have become confused by all the new classes. I thought I saw these also being implemented in a base class. So you say these are implemented identical several times for different reasons?", "author": "jbee", "createdAt": "2020-10-28T09:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzODQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUzMzU5OQ==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r516533599", "bodyText": "The start and stop methods are stubs in a couple of cases, but the resume and suspend methods may be stubs everywhere. I'll implement default resume and suspend methods.", "author": "MattGill98", "createdAt": "2020-11-03T09:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYzODQ1Ng=="}], "type": "inlineReview"}, {"oid": "f2f4e9cc90e408b3b0ff621fa848b1af5729ef3a", "url": "https://github.com/payara/Payara/commit/f2f4e9cc90e408b3b0ff621fa848b1af5729ef3a", "message": "FISH-327 Fix MP Connectors\n\nConnectors were incorrectly activating for all module types. This change\nchecks properly for a web activated module, and logs a proper message\nif this logic fails.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T13:00:31Z", "type": "commit"}, {"oid": "e038a3296f42c0e6cbab9e9c65a58e85e8b88e80", "url": "https://github.com/payara/Payara/commit/e038a3296f42c0e6cbab9e9c65a58e85e8b88e80", "message": "FISH-327 Fix MP Sniffer ClassLoading Issue\n\nThe updated connector module wasn't being used, and a ClassLoading issue\noccurred when trying to inject WarType. WarType has been moved into an\nexported OSGI module to be used by the MicroProfile sniffers, and the\ncorrect module has been referenced in the POM.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T14:13:59Z", "type": "commit"}, {"oid": "f33dee39fbe58e0092017f084c2fb37e69e4f52e", "url": "https://github.com/payara/Payara/commit/f33dee39fbe58e0092017f084c2fb37e69e4f52e", "message": "FISH-327 Rename Generic CDI Extension Classes\n\nJWT-Auth and Config had generic \"CdiExtension\" classes, which aren't\nidentifiable at runtime. This commit renames them appropriately.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T14:19:35Z", "type": "commit"}, {"oid": "a1989ca4d26769f22412931083966d3f60f348f3", "url": "https://github.com/payara/Payara/commit/a1989ca4d26769f22412931083966d3f60f348f3", "message": "FISH-327 Code cleanup to use Array Literals\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T14:30:50Z", "type": "commit"}, {"oid": "b28880f705a831dd0ea273ec910655df87fc504f", "url": "https://github.com/payara/Payara/commit/b28880f705a831dd0ea273ec910655df87fc504f", "message": "FISH-327 Remove WarType injection\n\nMicroProfile sniffers were handling all WAR archives, which is incorrect\nbehaviour.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-10-27T17:05:43Z", "type": "commit"}, {"oid": "f95f02d279aed2bbeaea35fef4ee5dbc81b0c7cc", "url": "https://github.com/payara/Payara/commit/f95f02d279aed2bbeaea35fef4ee5dbc81b0c7cc", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327", "committedDate": "2020-10-30T12:58:49Z", "type": "commit"}, {"oid": "ea94978f6de8897841eeae51fd1240a888a32b0e", "url": "https://github.com/payara/Payara/commit/ea94978f6de8897841eeae51fd1240a888a32b0e", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327", "committedDate": "2020-10-30T14:55:07Z", "type": "commit"}, {"oid": "14ea1c7be026cfc0b5afd7acf911682c562eaeb7", "url": "https://github.com/payara/Payara/commit/14ea1c7be026cfc0b5afd7acf911682c562eaeb7", "message": "Make Arquillian runners debuggable by default\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:45Z", "type": "commit"}, {"oid": "bba4a79c3dc9cd37adb5c3dd5779e562ed90a455", "url": "https://github.com/payara/Payara/commit/bba4a79c3dc9cd37adb5c3dd5779e562ed90a455", "message": "FISH-327 Fix MP Config Source Creation\n\nThe password alias store failed to be found when the OpenAPI container\ndidn't call ConfigProvider.getConfig(). This change calls\nConfigProvider.getConfig() in the config sniffer regardless of whether\nthe Config API annotations are detected or not.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:47Z", "type": "commit"}, {"oid": "0b4efd98d4d5bf58e626009efbbf514845feae56", "url": "https://github.com/payara/Payara/commit/0b4efd98d4d5bf58e626009efbbf514845feae56", "message": "FISH-327 Remove unnecessary app container overrides\n\nEach MP container overrides methods unnecessarily, so they've been\nstubbed in the parent class to minimise boilerplate.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:47Z", "type": "commit"}, {"oid": "bbc361a886e429762874a399e1d14e17a7354869", "url": "https://github.com/payara/Payara/commit/bbc361a886e429762874a399e1d14e17a7354869", "message": "Partial revert \"FISH-327 Implement MicroProfile OpenAPI Sniffer\"\n\nThis reverts a part of commit d0073114146ee03cfdcbe98fff84fe1d5367726a.\n\nThe ServletContainerInitializer is returned, as the\nServletContextListener caused the OpenAPI endpoint to use the app context\nroot. The OpenAPI endpoint is now always deployed, but the sniffer\ndetermines if the app should be read.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:47Z", "type": "commit"}, {"oid": "b7ddab0e6e185123a2d08495812de4b2e9ed857f", "url": "https://github.com/payara/Payara/commit/b7ddab0e6e185123a2d08495812de4b2e9ed857f", "message": "Partial revert \"FISH-327 Implement MicroProfile Metrics Sniffer\"\n\nThis partially reverts commit 023866b60d4b3159652e73592f9f0607cbc39178.\n\nThe ServletContainerInitializer is returned, as the ServletContextListener\ncaused the metrics endpoint to use the app context root.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:47Z", "type": "commit"}, {"oid": "b9c54c295c1e3f79dff0ff7402bf0e921fd70703", "url": "https://github.com/payara/Payara/commit/b9c54c295c1e3f79dff0ff7402bf0e921fd70703", "message": "Partial revert \"FISH-327 Implement MicroProfile Health Sniffer\"\n\nThis partially reverts commit 372c734ed5ae53a3a15e6a4de79faf41fa8b3748.\n\nThe ServletContainerInitializer is returned, as the ServletContextListener\ncased the health endpoint to use the app context root.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T11:19:47Z", "type": "commit"}, {"oid": "37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "url": "https://github.com/payara/Payara/commit/37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "message": "FISH-327 Add new 'activation' folders\n\nMoved the sniffer code for each module into their own folder for better\norganisation.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T13:03:03Z", "type": "commit"}, {"oid": "37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "url": "https://github.com/payara/Payara/commit/37c08ba672bfaa4e1f9891cc7e6ba0b887c069c3", "message": "FISH-327 Add new 'activation' folders\n\nMoved the sniffer code for each module into their own folder for better\norganisation.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-05T13:03:03Z", "type": "forcePushed"}, {"oid": "8af6f292beebeb26073d645f018b7ba9f09979f5", "url": "https://github.com/payara/Payara/commit/8af6f292beebeb26073d645f018b7ba9f09979f5", "message": "FISH-327 Fix extensions loading twice\n\nExtensions now load only once, and sniffers now enable for EJB JARs.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-09T09:18:16Z", "type": "commit"}, {"oid": "aca874527daddd1df962be89ab73fca387f1c4be", "url": "https://github.com/payara/Payara/commit/aca874527daddd1df962be89ab73fca387f1c4be", "message": "FISH-327 Fix Health Extension\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-09T09:24:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxODA1MQ==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r519718051", "bodyText": "Does this work like as intended should an exception be thrown at some of the steps so that the document contains as much information as possible to that point?", "author": "jbee", "createdAt": "2020-11-09T10:52:47Z", "path": "appserver/payara-appserver-modules/microprofile/openapi/src/main/java/fish/payara/microprofile/openapi/impl/OpenAPISupplier.java", "diffHunk": "@@ -0,0 +1,264 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.microprofile.openapi.impl;\n+\n+import static java.util.stream.Collectors.toSet;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Enumeration;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.function.Supplier;\n+import java.util.logging.Logger;\n+\n+import com.sun.enterprise.v3.server.ApplicationLifecycle;\n+import com.sun.enterprise.v3.services.impl.GrizzlyService;\n+\n+import org.eclipse.microprofile.openapi.models.OpenAPI;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.api.deployment.archive.ReadableArchive;\n+import org.glassfish.grizzly.config.dom.NetworkListener;\n+import org.glassfish.hk2.api.MultiException;\n+import org.glassfish.hk2.classmodel.reflect.Parser;\n+import org.glassfish.hk2.classmodel.reflect.Type;\n+import org.glassfish.hk2.classmodel.reflect.Types;\n+import org.glassfish.internal.api.Globals;\n+import org.glassfish.internal.api.ServerContext;\n+import org.glassfish.internal.deployment.analysis.StructuredDeploymentTracing;\n+\n+import fish.payara.microprofile.openapi.impl.config.OpenApiConfiguration;\n+import fish.payara.microprofile.openapi.impl.model.OpenAPIImpl;\n+import fish.payara.microprofile.openapi.impl.processor.ApplicationProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.BaseProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.FileProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.FilterProcessor;\n+import fish.payara.microprofile.openapi.impl.processor.ModelReaderProcessor;\n+\n+public class OpenAPISupplier implements Supplier<OpenAPI> {\n+\n+    private final OpenApiConfiguration config;\n+    private final String applicationId;\n+    private final String contextRoot;\n+    private final ReadableArchive archive;\n+    private final ClassLoader classLoader;\n+\n+    private volatile OpenAPI document;\n+\n+    private boolean enabled;\n+\n+    public OpenAPISupplier(String applicationId, String contextRoot,\n+            ReadableArchive archive, ClassLoader classLoader) {\n+        this.config = new OpenApiConfiguration(classLoader);\n+        this.applicationId = applicationId;\n+        this.contextRoot = contextRoot;\n+        this.archive = archive;\n+        this.classLoader = classLoader;\n+        this.enabled = true;\n+    }\n+\n+    public void setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+    }\n+\n+    @Override\n+    public synchronized OpenAPI get() {\n+        if (this.document != null) {\n+            return this.document;\n+        }\n+        if (!enabled) {\n+            return null;\n+        }\n+\n+        try {\n+            final Parser parser = Globals.get(ApplicationLifecycle.class).getDeployableParser(\n+                    archive,\n+                    true,\n+                    true,\n+                    StructuredDeploymentTracing.create(applicationId),\n+                    Logger.getLogger(OpenApiService.class.getName())\n+            );\n+            final Types types = parser.getContext().getTypes();\n+\n+            OpenAPI doc = new OpenAPIImpl();\n+            try {\n+                final List<URL> baseURLs = getServerURL(contextRoot);\n+                doc = new ModelReaderProcessor().process(doc, config);\n+                doc = new FileProcessor(classLoader).process(doc, config);\n+                doc = new ApplicationProcessor(\n+                        types,\n+                        filterTypes(archive, config, types),\n+                        classLoader\n+                ).process(doc, config);\n+                doc = new BaseProcessor(baseURLs).process(doc, config);\n+                doc = new FilterProcessor().process(doc, config);\n+            } finally {\n+                this.document = doc;", "originalCommit": "aca874527daddd1df962be89ab73fca387f1c4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5NjkzMg==", "url": "https://github.com/payara/Payara/pull/4966#discussion_r519996932", "bodyText": "My changes don't (see \"shouldn't\") change any functionality when the sniffer returns true for the application. All DeploymentExceptions related to MP deployment should still propagate, this just disables all CDI extensions and processing when no MP or JAX-RS annotations are detected", "author": "MattGill98", "createdAt": "2020-11-09T17:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxODA1MQ=="}], "type": "inlineReview"}, {"oid": "f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "url": "https://github.com/payara/Payara/commit/f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327", "committedDate": "2020-11-13T16:08:43Z", "type": "commit"}, {"oid": "f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "url": "https://github.com/payara/Payara/commit/f8ce23f03050e04874f9579c9ce221cfe4f3c9eb", "message": "Merge branch 'master' of https://github.com/payara/Payara into FISH-327", "committedDate": "2020-11-13T16:08:43Z", "type": "forcePushed"}, {"oid": "c2d687a406ab7e7532e3f34dd537af8906f82044", "url": "https://github.com/payara/Payara/commit/c2d687a406ab7e7532e3f34dd537af8906f82044", "message": "FISH-327 Add Sniffer Extention MetaData Earlier\n\nA race condition existed where the load() method of each MP sniffer\ndepended on the Weld load() method. If they ran in the wrong order, the\nMP CDI extensions wouldn't load. This makes sure that the Weld sniffer\ncreates this MetaData earlier in the deploy lifecycle.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-17T10:48:53Z", "type": "commit"}, {"oid": "b85f974ae185f0fbe95811140907a01f020795cf", "url": "https://github.com/payara/Payara/commit/b85f974ae185f0fbe95811140907a01f020795cf", "message": "FISH-327 Add OpenAPI YAML Files to Sniffer\n\nThe Static OpenAPI YAML file wasn't being scanned for by the sniffer.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-18T11:20:18Z", "type": "commit"}, {"oid": "b85f974ae185f0fbe95811140907a01f020795cf", "url": "https://github.com/payara/Payara/commit/b85f974ae185f0fbe95811140907a01f020795cf", "message": "FISH-327 Add OpenAPI YAML Files to Sniffer\n\nThe Static OpenAPI YAML file wasn't being scanned for by the sniffer.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-18T11:20:18Z", "type": "forcePushed"}, {"oid": "de0f8524c2c37c8ec996eda06260485b07bceaa2", "url": "https://github.com/payara/Payara/commit/de0f8524c2c37c8ec996eda06260485b07bceaa2", "message": "FISH-327 Fix Health CDI Extension\n\nThe extension logged errors about the creational context, so the\nhealthchecks are now registered later (once this can be created\ncorrectly). The extension also wasn't listening on all health check\ntypes, so the observer has been made more generic.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-18T13:11:11Z", "type": "commit"}, {"oid": "65178a0ee9152351e0d0a5b9c893812f4afaf637", "url": "https://github.com/payara/Payara/commit/65178a0ee9152351e0d0a5b9c893812f4afaf637", "message": "FISH-327 Fix Config Sniffer\n\nConfig applications that injected the Config type weren't previously\ndetected, but they now count as Config applications.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-18T14:26:31Z", "type": "commit"}, {"oid": "5af66d06d52befc2053cc56b4feefa7a6e51cf51", "url": "https://github.com/payara/Payara/commit/5af66d06d52befc2053cc56b4feefa7a6e51cf51", "message": "FISH-327 Fix Metrics TCK\n\nThe metrics TCK caused ClassCastExceptions casting from ParameterImpl to\nType. ParameterizedTypes such as ParameterImpl are now recognised and\nhandled correctly, and unrecognised types are logged and ignored.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-18T14:27:58Z", "type": "commit"}, {"oid": "5247791d6fcd99cb43d1ab81892b42adfe598b1c", "url": "https://github.com/payara/Payara/commit/5247791d6fcd99cb43d1ab81892b42adfe598b1c", "message": "FISH-327 Fix Metrics Sniffer\n\nAllow Metrics sniffer to deploy Metrics if any Metric is injected, as\nwell as the enabled annotations.\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-19T10:35:51Z", "type": "commit"}, {"oid": "671da1949837273ee37ff4157c9b64ad0a83a812", "url": "https://github.com/payara/Payara/commit/671da1949837273ee37ff4157c9b64ad0a83a812", "message": "FISH-327 Fix Missing Copyright Headers\n\nSigned-off-by: Matthew Gill <matthew.gill@live.co.uk>", "committedDate": "2020-11-20T10:44:13Z", "type": "commit"}]}