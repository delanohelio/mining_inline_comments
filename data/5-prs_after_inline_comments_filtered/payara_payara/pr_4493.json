{"pr_number": 4493, "pr_title": "APPSERV-36 Extracts Monitoring Console to its own Repository", "pr_createdAt": "2020-02-14T14:02:12Z", "pr_url": "https://github.com/payara/Payara/pull/4493", "timeline": [{"oid": "6e238b17497e0c2127c39c554dea3c1ef0e2ba44", "url": "https://github.com/payara/Payara/commit/6e238b17497e0c2127c39c554dea3c1ef0e2ba44", "message": "APPSERV-36 extract API (incomplete)", "committedDate": "2020-02-03T08:45:10Z", "type": "commit"}, {"oid": "d79fc8dedfc41bc20ad7901b72c6cbcc20ea1efa", "url": "https://github.com/payara/Payara/commit/d79fc8dedfc41bc20ad7901b72c6cbcc20ea1efa", "message": "Merge branch 'master' into APPSERV-36-top-level-repo", "committedDate": "2020-02-10T11:00:26Z", "type": "commit"}, {"oid": "8736b667af9f4a228df1f4354e6794754ab2739e", "url": "https://github.com/payara/Payara/commit/8736b667af9f4a228df1f4354e6794754ab2739e", "message": "APPSERV-36 extracted monitoring console", "committedDate": "2020-02-14T13:44:11Z", "type": "commit"}, {"oid": "9ef0b5c5a27ae27a4d7509e99ed85031379fb12a", "url": "https://github.com/payara/Payara/commit/9ef0b5c5a27ae27a4d7509e99ed85031379fb12a", "message": "APPSERV-36 removed unused method(s)", "committedDate": "2020-02-19T09:51:18Z", "type": "commit"}, {"oid": "fd0c847f51893d60ca2b99559dbf56dbe8518e01", "url": "https://github.com/payara/Payara/commit/fd0c847f51893d60ca2b99559dbf56dbe8518e01", "message": "APPSERV-36 fixes automatic startup and monitoring data message exchange classloader issue", "committedDate": "2020-02-20T11:02:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUyNjY1NQ==", "url": "https://github.com/payara/Payara/pull/4493#discussion_r382526655", "bodyText": "Am I understanding this correctly? It seems off to me.\nSo if Hazelcast isn't enabled, despite an instance for example being called \"Insty1\", it will go to the MonitoringConsoleFactory and eventually get given an InMemorySeriesRepository which registers the instance name as server and adds that name to its set of instances.\nIs that correct? I haven't dug deep down into the guts but an instance registering itself with an incorrect name perked an eyebrow \ud83e\udd14", "author": "Pandrex247", "createdAt": "2020-02-21T11:12:17Z", "path": "appserver/monitoring-console/core/src/main/java/fish/payara/monitoring/runtime/MonitoringConsoleRuntimeImpl.java", "diffHunk": "@@ -0,0 +1,336 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) 2020 Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.monitoring.runtime;\n+\n+import static java.lang.Boolean.parseBoolean;\n+import static java.util.Collections.emptyList;\n+import static org.jvnet.hk2.config.Dom.unwrap;\n+\n+import java.beans.PropertyChangeEvent;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map.Entry;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.glassfish.api.ActionReport;\n+import org.glassfish.api.admin.CommandRunner;\n+import org.glassfish.api.admin.CommandRunner.CommandInvocation;\n+import org.glassfish.api.admin.ParameterMap;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.api.event.EventListener;\n+import org.glassfish.api.event.EventTypes;\n+import org.glassfish.api.event.Events;\n+import org.glassfish.hk2.api.ServiceLocator;\n+import org.glassfish.internal.api.InternalSystemAdministrator;\n+import org.glassfish.internal.deployment.ApplicationLifecycleInterceptor;\n+import org.glassfish.internal.deployment.ExtendedDeploymentContext;\n+import org.glassfish.internal.deployment.ExtendedDeploymentContext.Phase;\n+import org.jvnet.hk2.annotations.Service;\n+import org.jvnet.hk2.config.ConfigBeanProxy;\n+import org.jvnet.hk2.config.ConfigListener;\n+import org.jvnet.hk2.config.UnprocessedChangeEvents;\n+\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.core.ITopic;\n+import com.sun.enterprise.config.serverbeans.Config;\n+import com.sun.enterprise.config.serverbeans.Domain;\n+import com.sun.enterprise.config.serverbeans.MonitoringService;\n+\n+import fish.payara.monitoring.adapt.GroupData;\n+import fish.payara.monitoring.adapt.GroupDataRepository;\n+import fish.payara.monitoring.adapt.MonitoringConsole;\n+import fish.payara.monitoring.adapt.MonitoringConsoleFactory;\n+import fish.payara.monitoring.adapt.MonitoringConsoleRuntime;\n+import fish.payara.monitoring.adapt.MonitoringConsoleWatchConfig;\n+import fish.payara.monitoring.collect.MonitoringDataSource;\n+import fish.payara.monitoring.collect.MonitoringWatchSource;\n+import fish.payara.monitoring.configuration.MonitoringConsoleConfiguration;\n+import fish.payara.notification.requesttracing.RequestTrace;\n+import fish.payara.notification.requesttracing.RequestTraceSpan;\n+import fish.payara.nucleus.executorservice.PayaraExecutorService;\n+import fish.payara.nucleus.hazelcast.HazelcastCore;\n+import fish.payara.nucleus.requesttracing.RequestTracingService;\n+\n+/**\n+ * This implementation of the {@link MonitoringConsoleRuntime} connects the Payara independent parts of the monitoring\n+ * console with the Payara server.\n+ * \n+ * The most complicated aspect about the implementation is the way it is bootstrapped. By implementing\n+ * {@link ApplicationLifecycleInterceptor} it forces the creation of an instance of this {@link Service} even though it\n+ * is not otherwise referenced within the HK2 context. As this happens fairly early in the bootstrapping it then\n+ * registers itself as an {@link EventListener} so that it can run its actual {@link #init()} bootstrapping as soon as\n+ * the {@link EventTypes#SERVER_READY} is received. This makes sure the bootstrapping of the console runtime does not\n+ * alter the order of services created by starting to collect data from services that implement\n+ * {@link MonitoringDataSource} or {@link MonitoringWatchSource}.\n+ * \n+ * @author Jan Bernitt\n+ * @since 5.201\n+ */\n+@Service\n+public class MonitoringConsoleRuntimeImpl\n+        implements ConfigListener, ApplicationLifecycleInterceptor, EventListener,\n+        MonitoringConsoleRuntime, MonitoringConsoleWatchConfig, GroupDataRepository {\n+\n+    private static final Logger LOGGER = Logger.getLogger(\"monitoring-console-core\");\n+\n+    private static final String SET_MONITORING_CONSOLE_CONFIGURATION_COMMAND = \"set-monitoring-console-configuration\";\n+\n+    /**\n+     * The topic name used to share data of instances with the DAS.\n+     */\n+    private static final String MONITORING_DATA_TOPIC_NAME = \"payara-monitoring-data\";\n+\n+    @Inject\n+    private PayaraExecutorService executor;\n+    @Inject\n+    private ServerEnvironment serverEnv;\n+    @Inject @Named(ServerEnvironment.DEFAULT_INSTANCE_NAME)\n+    private Config serverConfig;\n+    @Inject\n+    private Domain domain;\n+    @Inject\n+    private CommandRunner commandRunner;\n+    @Inject\n+    private InternalSystemAdministrator kernelIdentity;\n+    @Inject\n+    private HazelcastCore hazelcastCore;\n+    @Inject\n+    private RequestTracingService requestTracingService;\n+    @Inject\n+    private ServiceLocator serviceLocator;\n+    @Inject\n+    private Events events;\n+\n+    private final AtomicBoolean initialised = new AtomicBoolean();\n+    private ITopic<byte[]> exchange;\n+    private MonitoringConsoleConfiguration config;\n+    private MonitoringConsole console;\n+\n+    @PostConstruct\n+    public void postConstruct() {\n+        events.register(this);\n+    }\n+\n+    @Override\n+    public void event(Event<?> event) {\n+        if (event.is(EventTypes.SERVER_READY)) {\n+            init();\n+        }\n+    }\n+\n+    public void init() {\n+        if (!initialised.compareAndSet(false, true) ) {\n+            return;\n+        }\n+        try {\n+            LOGGER.info(\"Bootstrapping Monitoring Console Runtime\");\n+            boolean isDas = serverEnv.isDas();\n+            config = domain.getExtensionByType(MonitoringConsoleConfiguration.class);\n+            String instanceName = \"server\"; // default", "originalCommit": "fd0c847f51893d60ca2b99559dbf56dbe8518e01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzMDI4Nw==", "url": "https://github.com/payara/Payara/pull/4493#discussion_r382530287", "bodyText": "So far I extracted the name from hazelcast from the HazelcastCore.INSTANCE_ATTRIBUTE as I found that is done at other places. Happy to use some other reliable source if you can point me at one.", "author": "jbee", "createdAt": "2020-02-21T11:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUyNjY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0MzcwNA==", "url": "https://github.com/payara/Payara/pull/4493#discussion_r382543704", "bodyText": "I believe ServerEnvironment.getInstanceName() is fairly reliable.\nOttomh I'm not sure that the name returned by that is 100% always the name used in Hazelcast, but I'm nitpicking what happens if Hazelcast isn't enabled here so should be fine (assuming it works).\nAlthough having said all that - does the monitoring even work without Hazelcast?", "author": "Pandrex247", "createdAt": "2020-02-21T11:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUyNjY1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1MjUwNA==", "url": "https://github.com/payara/Payara/pull/4493#discussion_r382552504", "bodyText": "I changed it to ServerEnvironment.getInstanceName(). It does work without Hazelcast in a single instance (DAS) configuration.", "author": "jbee", "createdAt": "2020-02-21T12:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUyNjY1NQ=="}], "type": "inlineReview"}, {"oid": "0e26a3113f544a8f8bac0900b485f9afe3b10cc8", "url": "https://github.com/payara/Payara/commit/0e26a3113f544a8f8bac0900b485f9afe3b10cc8", "message": "Update appserver/payara-appserver-modules/microprofile/fault-tolerance/pom.xml\n\nCo-Authored-By: Andrew Pielage <pandrex247@hotmail.com>", "committedDate": "2020-02-21T11:17:15Z", "type": "commit"}, {"oid": "e4ae90a91c1d062c9775777c66a99252136fb03a", "url": "https://github.com/payara/Payara/commit/e4ae90a91c1d062c9775777c66a99252136fb03a", "message": "Update appserver/payara-appserver-modules/microprofile/metrics/pom.xml\n\nCo-Authored-By: Andrew Pielage <pandrex247@hotmail.com>", "committedDate": "2020-02-21T11:18:18Z", "type": "commit"}, {"oid": "4c55f8339392e9fefdeead19a49ab8e3b6a4c8d3", "url": "https://github.com/payara/Payara/commit/4c55f8339392e9fefdeead19a49ab8e3b6a4c8d3", "message": "Update nucleus/common/internal-api/pom.xml\n\nCo-Authored-By: Andrew Pielage <pandrex247@hotmail.com>", "committedDate": "2020-02-21T11:18:33Z", "type": "commit"}, {"oid": "46d556d333313ff3e11a649c03a06480ecceaae9", "url": "https://github.com/payara/Payara/commit/46d556d333313ff3e11a649c03a06480ecceaae9", "message": "Update pom.xml\n\nCo-Authored-By: Andrew Pielage <pandrex247@hotmail.com>", "committedDate": "2020-02-21T11:19:01Z", "type": "commit"}, {"oid": "c0553861db058bace3cdff39e89c9250fe5ca49e", "url": "https://github.com/payara/Payara/commit/c0553861db058bace3cdff39e89c9250fe5ca49e", "message": "Merge branch 'master' into APPSERV-36-top-level-repo", "committedDate": "2020-02-21T11:27:15Z", "type": "commit"}, {"oid": "ba812fefebae7da141d1fa0961eb28f4d425c533", "url": "https://github.com/payara/Payara/commit/ba812fefebae7da141d1fa0961eb28f4d425c533", "message": "APPSERV-36 fixes wrong dependecy for MC api", "committedDate": "2020-02-21T12:00:05Z", "type": "commit"}, {"oid": "1b89960c30fc29aa892bb19267f0520482aa3b1f", "url": "https://github.com/payara/Payara/commit/1b89960c30fc29aa892bb19267f0520482aa3b1f", "message": "APPSERV-36 extracts the instance name from ServerEnvironment", "committedDate": "2020-02-21T12:18:31Z", "type": "commit"}, {"oid": "7f5cb070906d4dcc53d8db25ab91c86878c06756", "url": "https://github.com/payara/Payara/commit/7f5cb070906d4dcc53d8db25ab91c86878c06756", "message": "APPSERV-36. Grant access to payara-staging for builds to access deployed monitoring console", "committedDate": "2020-02-21T15:41:24Z", "type": "commit"}, {"oid": "ee7d48ea42197022747db9ffda63c7ad220bf834", "url": "https://github.com/payara/Payara/commit/ee7d48ea42197022747db9ffda63c7ad220bf834", "message": "Merge pull request #4 from MarkWareham/use-payara-staging\n\nUse payara staging", "committedDate": "2020-02-21T15:45:07Z", "type": "commit"}]}