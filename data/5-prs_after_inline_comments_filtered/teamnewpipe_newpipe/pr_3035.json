{"pr_number": 3035, "pr_title": "Fix ReCaptcha activity and correctly save obtained cookies", "pr_createdAt": "2020-01-29T19:17:53Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/3035", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwMzg2OA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r372603868", "bodyText": "It might be good to check the service id first. Just in case we get a reCAPTCHA from a different service.", "author": "TobiGr", "createdAt": "2020-01-29T20:06:45Z", "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -89,74 +91,89 @@ protected void onCreate(Bundle savedInstanceState) {\n         myWebView.loadUrl(url);\n     }\n \n-    private class ReCaptchaWebViewClient extends WebViewClient {\n-        private final Activity context;\n-        private String mCookies;\n+    @Override\n+    public boolean onCreateOptionsMenu(Menu menu) {\n+        boolean ret = super.onCreateOptionsMenu(menu);\n \n-        ReCaptchaWebViewClient(Activity ctx) {\n-            context = ctx;\n+        ActionBar actionBar = getSupportActionBar();\n+        if (actionBar != null) {\n+            actionBar.setDisplayHomeAsUpEnabled(true);\n+            actionBar.setHomeAsUpIndicator(getResources().getDrawable(R.drawable.ic_done_white_24dp));\n+            actionBar.setTitle(R.string.title_activity_recaptcha);\n+            actionBar.setSubtitle(R.string.subtitle_activity_recaptcha);\n         }\n \n-        @Override\n-        public void onPageStarted(WebView view, String url, Bitmap favicon) {\n-            // TODO: Start Loader\n-            super.onPageStarted(view, url, favicon);\n+        return ret;\n+    }\n+\n+    @Override\n+    public void onBackPressed() {\n+        saveCookiesAndFinish();\n+    }\n+\n+    @Override\n+    public boolean onOptionsItemSelected(MenuItem item) {\n+        int id = item.getItemId();\n+        switch (id) {\n+            case android.R.id.home:\n+                saveCookiesAndFinish();\n+                return true;\n+            default:\n+                return false;\n         }\n+    }\n \n-        @Override\n-        public void onPageFinished(WebView view, String url) {\n-            String cookies = CookieManager.getInstance().getCookie(url);\n+    private void saveCookiesAndFinish() {\n+        if (!foundCookies.isEmpty()) {\n+            // Give cookies to Downloader class\n+            DownloaderImpl.getInstance().setCookies(foundCookies);\n+            setResult(RESULT_OK);\n+        }\n \n-            // TODO: Stop Loader\n+        Intent intent = new Intent(this, org.schabi.newpipe.MainActivity.class);\n+        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n+        NavUtils.navigateUpTo(this, intent);\n+    }\n \n-            // find cookies : s_gl & goojf and Add cookies to Downloader\n-            if (find_access_cookies(cookies)) {\n-                // Give cookies to Downloader class\n-                DownloaderImpl.getInstance().setCookies(mCookies);\n \n-                // Closing activity and return to parent\n-                setResult(RESULT_OK);\n-                finish();\n-            }\n-        }\n \n-        private boolean find_access_cookies(String cookies) {\n-            boolean ret = false;\n-            String c_s_gl = \"\";\n-            String c_goojf = \"\";\n-\n-            String[] parts = cookies.split(\"; \");\n-            for (String part : parts) {\n-                if (part.trim().startsWith(\"s_gl\")) {\n-                    c_s_gl = part.trim();\n-                }\n-                if (part.trim().startsWith(\"goojf\")) {\n-                    c_goojf = part.trim();\n-                }\n+    private void handleCookies(@Nullable String cookies) {\n+        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: cookies=\" + (cookies == null ? \"null\" : cookies));\n+        if (cookies == null) return;\n+\n+        addYoutubeCookies(cookies);", "originalCommit": "702e41b1650236a3912536b2734241a758d70c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1ODkwNA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373158904", "bodyText": "This could be done, but it would require modifying the downloader making it service-aware, so that it can throw service-aware recaptcha exceptions. Another option would be to recognize the service from the url using its url handler, but API urls wouldn't be probably recognized.\nSo I think this is good as it is, since if the addYoutubeCookies() function is able to find YouTube cookies they get saved, otherwise they do not. And, as the comment on the line below suggests, it is simple to add new cookie extractors for other services in the future.", "author": "Stypox", "createdAt": "2020-01-30T19:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwMzg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2OTMxNg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373169316", "bodyText": "Okay :)", "author": "TobiGr", "createdAt": "2020-01-30T20:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwMzg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NjE4NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373186184", "bodyText": "I was not able to get a reCAPTCHA while visiting peertube.co.uk, so I could not test your PR. However from what I can say when reading the code, it looks like there is no theme handling in the toolbar. Please ensure to have the correct button color when using the light theme.", "author": "TobiGr", "createdAt": "2020-01-30T20:50:04Z", "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -89,74 +90,89 @@ protected void onCreate(Bundle savedInstanceState) {\n         myWebView.loadUrl(url);\n     }\n \n-    private class ReCaptchaWebViewClient extends WebViewClient {\n-        private final Activity context;\n-        private String mCookies;\n+    @Override\n+    public boolean onCreateOptionsMenu(Menu menu) {\n+        boolean ret = super.onCreateOptionsMenu(menu);\n+\n+        ActionBar actionBar = getSupportActionBar();\n+        if (actionBar != null) {\n+            actionBar.setDisplayHomeAsUpEnabled(true);\n+            actionBar.setHomeAsUpIndicator(getResources().getDrawable(R.drawable.ic_done_white_24dp));", "originalCommit": "54098b925f7e258f62544ee3092e4712e79bf9fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYzNjM2NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373636364", "bodyText": "Unfortunately I am unable to test, too (I keep getting Network Errors in peertube.co.uk). But since the app bar background color is always red I don't think it is a problem to have an always white icon. @B0pol could you test how it looks with a white theme?", "author": "Stypox", "createdAt": "2020-01-31T19:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NjE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY0NDcxNA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373644714", "bodyText": "Oh, apparently other menu icons are black in white theme even though they are on the exact same background color as dark theme, which is strange. With white theme this is, respectively, how the app and the recaptcha activity look: should I make the recaptcha activity's icon/text color black?", "author": "Stypox", "createdAt": "2020-01-31T19:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NjE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc3NzY0Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373777647", "bodyText": "I agree that the black text looks not good. But I'd suggest to use the same colors as in the current theme for consistency. Could you open an issue to ask for help polishing the light theme?", "author": "TobiGr", "createdAt": "2020-02-01T12:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4NjE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDk1Ng==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3035#discussion_r373790956", "bodyText": "I guess this was accidentally committed.", "author": "TobiGr", "createdAt": "2020-02-01T17:19:39Z", "path": "app/src/main/java/org/schabi/newpipe/ReCaptchaActivity.java", "diffHunk": "@@ -138,8 +140,10 @@ private void saveCookiesAndFinish() {\n \n \n \n-    private void handleCookies(@Nullable String cookies) {\n-        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: cookies=\" + (cookies == null ? \"null\" : cookies));\n+    private void handleCookies(String url) {\n+        String cookies = CookieManager.getInstance().getCookie(url);\n+        if (MainActivity.DEBUG) Log.d(TAG, \"handleCookies: url=\" + url + \"; cookies=\" + (cookies == null ? \"null\" : cookies));\n+        Log.e(TAG, \"handleCookies: url=\" + url + \"; cookies=\" + (cookies == null ? \"null\" : cookies));", "originalCommit": "c3c84dff643fe736e0729b65ff897df4d7d8d495", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0519d8313505b5b074e17906edadacfb276484a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/c0519d8313505b5b074e17906edadacfb276484a", "message": "fixes #3021, see also https://github.com/TeamNewPipe/NewPipe-legacy/pull/21", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "61d102dc75a1a1470adab17edcf5d251c67e2549", "url": "https://github.com/TeamNewPipe/NewPipe/commit/61d102dc75a1a1470adab17edcf5d251c67e2549", "message": "Change recaptcha string names to match style", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "a3d8848825d52226479f7d14d5ddbb7c0d3bf605", "url": "https://github.com/TeamNewPipe/NewPipe/commit/a3d8848825d52226479f7d14d5ddbb7c0d3bf605", "message": "Add \"Done\" drawable (only white since it is used on toolbar)", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "daa4fd510320f2ee8a898a38b3851d6408e50a93", "url": "https://github.com/TeamNewPipe/NewPipe/commit/daa4fd510320f2ee8a898a38b3851d6408e50a93", "message": "Fix ReCaptchaActivity crash and save cookies correctly", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "4e1638f86e75d546154b28714fd1bd2f9a426e9a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/4e1638f86e75d546154b28714fd1bd2f9a426e9a", "message": "Remove space between \"Done\" button and ReCaptchaActivity title", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "fe138f6d611d4a182db9ddec902f1d4c471752b1", "url": "https://github.com/TeamNewPipe/NewPipe/commit/fe138f6d611d4a182db9ddec902f1d4c471752b1", "message": "Improve formatting", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "0cc890a1d1384266916a9382309fcaa3cdbb0115", "url": "https://github.com/TeamNewPipe/NewPipe/commit/0cc890a1d1384266916a9382309fcaa3cdbb0115", "message": "Move \"Done\" button and make it theme conpliant in ReCaptcha", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "9b09028440b2b12b9dfdac786d6489bdbbff131c", "url": "https://github.com/TeamNewPipe/NewPipe/commit/9b09028440b2b12b9dfdac786d6489bdbbff131c", "message": "Try to extract cookies just before closing recaptcha activity\n\nEven if the page didn't auto-close", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "1bf55c21392090855f2c5e0363e221f92f2827ec", "url": "https://github.com/TeamNewPipe/NewPipe/commit/1bf55c21392090855f2c5e0363e221f92f2827ec", "message": "Remove left-behind Log", "committedDate": "2020-02-01T17:24:16Z", "type": "commit"}, {"oid": "1bf55c21392090855f2c5e0363e221f92f2827ec", "url": "https://github.com/TeamNewPipe/NewPipe/commit/1bf55c21392090855f2c5e0363e221f92f2827ec", "message": "Remove left-behind Log", "committedDate": "2020-02-01T17:24:16Z", "type": "forcePushed"}, {"oid": "f95d51b3075db8e95dadf33321df03c0701e62f3", "url": "https://github.com/TeamNewPipe/NewPipe/commit/f95d51b3075db8e95dadf33321df03c0701e62f3", "message": "Merge branch 'dev' of github.com:TeamNewPipe/NewPipe into recaptcha", "committedDate": "2020-02-01T17:27:00Z", "type": "commit"}, {"oid": "6da90961762b92a2d9cae90e4b5879fdf481ce5a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/6da90961762b92a2d9cae90e4b5879fdf481ce5a", "message": "Fix addYoutubeCookies functions (Yt changed things lately)", "committedDate": "2020-02-02T20:33:07Z", "type": "commit"}, {"oid": "3372bacc6291b4de9f470c7724645d1ac9665964", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3372bacc6291b4de9f470c7724645d1ac9665964", "message": "Merge branch 'dev' into recaptcha", "committedDate": "2020-02-02T20:36:15Z", "type": "commit"}, {"oid": "b6841158df60b066a0b53fe80f4a780d822c227a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/b6841158df60b066a0b53fe80f4a780d822c227a", "message": "Remove unused imports and clean up comment style", "committedDate": "2020-02-02T20:48:45Z", "type": "commit"}]}