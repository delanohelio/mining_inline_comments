{"pr_number": 3741, "pr_title": "Bandcamp support", "pr_createdAt": "2020-06-04T09:49:15Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/3741", "timeline": [{"oid": "b7d13689e0feb1f685eda2854833d44be28c26d8", "url": "https://github.com/TeamNewPipe/NewPipe/commit/b7d13689e0feb1f685eda2854833d44be28c26d8", "message": "Update NPE version", "committedDate": "2020-12-18T23:29:08Z", "type": "forcePushed"}, {"oid": "0fc3ed9b1c1ebce0d315b4690d5b7e664ce309b0", "url": "https://github.com/TeamNewPipe/NewPipe/commit/0fc3ed9b1c1ebce0d315b4690d5b7e664ce309b0", "message": "Update NPE version\n\n\nNPE", "committedDate": "2020-12-19T09:47:10Z", "type": "forcePushed"}, {"oid": "62004ff132779fd7caba20088bb2116f417532a1", "url": "https://github.com/TeamNewPipe/NewPipe/commit/62004ff132779fd7caba20088bb2116f417532a1", "message": "Use latest NPE fork commit", "committedDate": "2021-01-15T21:03:54Z", "type": "forcePushed"}, {"oid": "7a6da5ef544ac497f73c4a2c9478697a35cf7191", "url": "https://github.com/TeamNewPipe/NewPipe/commit/7a6da5ef544ac497f73c4a2c9478697a35cf7191", "message": "Ignore ContentNotSupportedException caused by BAndcamp fan pages", "committedDate": "2021-02-15T21:48:38Z", "type": "forcePushed"}, {"oid": "d831ef656f1f88ac4fc424f60b517a9d558b9ad8", "url": "https://github.com/TeamNewPipe/NewPipe/commit/d831ef656f1f88ac4fc424f60b517a9d558b9ad8", "message": "Use latest NPE fork commit", "committedDate": "2021-02-19T23:32:28Z", "type": "forcePushed"}, {"oid": "3dc01c11e6f78014bf6d64db74caae70bd518163", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3dc01c11e6f78014bf6d64db74caae70bd518163", "message": "Use latest NPE fork commit", "committedDate": "2021-02-21T12:52:59Z", "type": "forcePushed"}, {"oid": "96a99c0f3548675108998d0e780e481a43aada09", "url": "https://github.com/TeamNewPipe/NewPipe/commit/96a99c0f3548675108998d0e780e481a43aada09", "message": "Use latest NPE fork commit", "committedDate": "2021-03-05T20:49:20Z", "type": "forcePushed"}, {"oid": "9361916bb16833a176ed6c8c1a10f524c4673afe", "url": "https://github.com/TeamNewPipe/NewPipe/commit/9361916bb16833a176ed6c8c1a10f524c4673afe", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large thumbnails and fixed by scaling the thumbnail.", "committedDate": "2021-03-13T10:56:47Z", "type": "forcePushed"}, {"oid": "15df0a386efc7a36654b052abfd6ab8e4385223b", "url": "https://github.com/TeamNewPipe/NewPipe/commit/15df0a386efc7a36654b052abfd6ab8e4385223b", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large thumbnails and fixed by scaling the thumbnail.", "committedDate": "2021-03-13T11:00:50Z", "type": "forcePushed"}, {"oid": "3785ba0d95eccb4841333021637132be73168b6d", "url": "https://github.com/TeamNewPipe/NewPipe/commit/3785ba0d95eccb4841333021637132be73168b6d", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large thumbnails and fixed by scaling the thumbnail.", "committedDate": "2021-03-13T11:03:50Z", "type": "forcePushed"}, {"oid": "0eb4fec3e5df6cba35e416c890d01b801405dfa3", "url": "https://github.com/TeamNewPipe/NewPipe/commit/0eb4fec3e5df6cba35e416c890d01b801405dfa3", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large end screen thumbnails enlarging the whole palyer. Fixed by scaling the thumbnail.\n\nEnsure that the player does not use the whole screen height in detail fragment to keep the additional content like title, comments, etc. available.", "committedDate": "2021-03-13T16:25:20Z", "type": "forcePushed"}, {"oid": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "url": "https://github.com/TeamNewPipe/NewPipe/commit/56a9fe6f491e6ccfc1a75db87d8d11263763655c", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large end screen thumbnails enlarging the whole palyer. Fixed by scaling the thumbnail.\n\nEnsure that the player does not use the whole screen height in detail fragment to keep the additional content like title, comments, etc. available.", "committedDate": "2021-03-13T16:26:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjU0NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593856544", "bodyText": "Why not use javadoc above the method declaration instead of inline comments. Javadoc has IDE support.", "author": "XiangRongLin", "createdAt": "2021-03-14T07:31:07Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -1129,6 +1129,12 @@ private void onBroadcastReceived(final Intent intent) {\n                 // Close it because when changing orientation from portrait\n                 // (in fullscreen mode) the size of queue layout can be larger than the screen size\n                 closeItemsList();\n+                // When the orientation changed, the screen height might be smaller.\n+                // If the end screen thumbnail is not re-scaled,\n+                // it can be larger than the current screen height\n+                // and thus enlarging the whole player.\n+                // This causes the seekbar to be ouf the visible area.\n+                updateEndScreenThumbnail();", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4NzQ0OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593887449", "bodyText": "Done", "author": "TobiGr", "createdAt": "2021-03-14T11:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjY3MQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593856671", "bodyText": "conversion to int (rounding down) won't cause problems?", "author": "XiangRongLin", "createdAt": "2021-03-14T07:32:37Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -1187,6 +1193,54 @@ private void initThumbnail(final String url) {\n                 .loadImage(url, ImageDisplayConstants.DISPLAY_THUMBNAIL_OPTIONS, this);\n     }\n \n+    public void updateEndScreenThumbnail() {\n+        if (currentThumbnail == null) {\n+            return;\n+        }\n+\n+        final float endScreenHeight;\n+\n+        updateScreenSize(); // ensure that screenHeight is initialized and thus not 0\n+\n+        // Show at least stream title and content creator on TVs and tablets (using the land layout)\n+        // 85dp for height of R.id.detail_root and R.id.detail_title_root_layout\n+        // 15/16sp for text size of video title\n+        if (DeviceUtils.isTv(context) && !isFullscreen) {\n+            final int videoInfoHeight =\n+                    DeviceUtils.dpToPx(85, context) + DeviceUtils.spToPx(16, context);\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(),\n+                    screenHeight - videoInfoHeight);\n+        } else if (DeviceUtils.isTablet(context) && !isFullscreen) {\n+            final int videoInfoHeight =\n+                    DeviceUtils.dpToPx(85, context) + DeviceUtils.spToPx(15, context);\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(),\n+                    screenHeight - videoInfoHeight);\n+        } else { // fullscreen player: max height is the device height\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(), screenHeight);\n+        }\n+\n+        // scale the player audio / end screen thumbnail\n+        // This is necessary when the thumbnail's height is larger than the device's height\n+        // and thus is enlarging the player's height\n+        // causing the bottom playback controls to be out of the visible screen.\n+        final Bitmap endScreenBitmap = Bitmap.createScaledBitmap(\n+                currentThumbnail,\n+                (int) (currentThumbnail.getWidth()\n+                        / (currentThumbnail.getHeight() / endScreenHeight)),\n+                (int) endScreenHeight,\n+                true);", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4MTQyMA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593881420", "bodyText": "no. The size is in pixels. The device cannot display an image with e.g. with a width of 800.8px.  We want to scale the thumbnail to not make the player larger than the screen, so to be sure we do not make the player grow out of the display, we need to scale down.", "author": "TobiGr", "createdAt": "2021-03-14T10:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjcyMQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593856721", "bodyText": "scale to what and why?", "author": "XiangRongLin", "createdAt": "2021-03-14T07:33:12Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -1207,23 +1261,28 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n-        final float width = Math.min(\n+        // scale the notification thumbnail", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4MjM1MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593882350", "bodyText": "Performance improvements. IIRC if we pass the full size thumbnail to the notification, the notification needs more RAM and every time it is updated, the thumbnail needs to the scaled again. That's why we scale it down to the maximum thumbnail size.", "author": "TobiGr", "createdAt": "2021-03-14T11:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4MzYyNw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593883627", "bodyText": "Then expand the comment to something like scale down the notification thumbnail for performance", "author": "XiangRongLin", "createdAt": "2021-03-14T11:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjgzNw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593856837", "bodyText": "Seeing as the method twice is used twice, it definetly should be javadoc instead of inline comments", "author": "XiangRongLin", "createdAt": "2021-03-14T07:34:17Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -1207,23 +1261,28 @@ public void onLoadingFailed(final String imageUri, final View view,\n     @Override\n     public void onLoadingComplete(final String imageUri, final View view,\n                                   final Bitmap loadedImage) {\n-        final float width = Math.min(\n+        // scale the notification thumbnail\n+        final float notificationThumbnailWidth = Math.min(\n                 context.getResources().getDimension(R.dimen.player_notification_thumbnail_width),\n                 loadedImage.getWidth());\n+        currentThumbnail = Bitmap.createScaledBitmap(\n+                loadedImage,\n+                (int) notificationThumbnailWidth,\n+                (int) (loadedImage.getHeight()\n+                        / (loadedImage.getWidth() / notificationThumbnailWidth)),\n+                true);\n \n         if (DEBUG) {\n             Log.d(TAG, \"Thumbnail - onLoadingComplete() called with: \"\n                     + \"imageUri = [\" + imageUri + \"], view = [\" + view + \"], \"\n                     + \"loadedImage = [\" + loadedImage + \"], \"\n                     + loadedImage.getWidth() + \"x\" + loadedImage.getHeight()\n-                    + \", scaled width = \" + width);\n+                    + \", scaled notification width = \" + notificationThumbnailWidth);\n         }\n \n-        currentThumbnail = Bitmap.createScaledBitmap(loadedImage,\n-                (int) width,\n-                (int) (loadedImage.getHeight() / (loadedImage.getWidth() / width)), true);\n-        binding.endScreen.setImageBitmap(loadedImage);\n         NotificationUtil.getInstance().createNotificationIfNeededAndUpdate(this, false);\n+\n+        updateEndScreenThumbnail();", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4NzM5MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593887390", "bodyText": "Done", "author": "TobiGr", "createdAt": "2021-03-14T11:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NjgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1NzQxNQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593857415", "bodyText": "If you extract this into a method, you can\n\nGive it a name, which make this part here easier to read\nReference the R.id.* properly through javadoc instead of inline comments, which gives IDE support when refactoring or navigating. I don't think Android Studio will pick these up, if they are changed.\n\nSomething like calculateScreenHeight", "author": "XiangRongLin", "createdAt": "2021-03-14T07:39:19Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -1187,6 +1193,54 @@ private void initThumbnail(final String url) {\n                 .loadImage(url, ImageDisplayConstants.DISPLAY_THUMBNAIL_OPTIONS, this);\n     }\n \n+    public void updateEndScreenThumbnail() {\n+        if (currentThumbnail == null) {\n+            return;\n+        }\n+\n+        final float endScreenHeight;\n+\n+        updateScreenSize(); // ensure that screenHeight is initialized and thus not 0\n+\n+        // Show at least stream title and content creator on TVs and tablets (using the land layout)\n+        // 85dp for height of R.id.detail_root and R.id.detail_title_root_layout\n+        // 15/16sp for text size of video title\n+        if (DeviceUtils.isTv(context) && !isFullscreen) {\n+            final int videoInfoHeight =\n+                    DeviceUtils.dpToPx(85, context) + DeviceUtils.spToPx(16, context);\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(),\n+                    screenHeight - videoInfoHeight);\n+        } else if (DeviceUtils.isTablet(context) && !isFullscreen) {\n+            final int videoInfoHeight =\n+                    DeviceUtils.dpToPx(85, context) + DeviceUtils.spToPx(15, context);\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(),\n+                    screenHeight - videoInfoHeight);\n+        } else { // fullscreen player: max height is the device height\n+            endScreenHeight = Math.min(currentThumbnail.getHeight(), screenHeight);\n+        }", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1ODE3MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593858170", "bodyText": "Tests would be nice", "author": "XiangRongLin", "createdAt": "2021-03-14T07:46:53Z", "path": "app/src/main/java/org/schabi/newpipe/util/DeviceUtils.java", "diffHunk": "@@ -70,4 +71,15 @@ public static boolean isConfirmKey(final int keyCode) {\n                 return false;\n         }\n     }\n+\n+    public static int dpToPx(final float dp, final Context context) {\n+        return (int) (dp * context.getResources().getDisplayMetrics().density);\n+    }\n+\n+    public static int spToPx(final float sp, final Context context) {\n+        return (int) TypedValue.applyDimension(\n+                TypedValue.COMPLEX_UNIT_SP,\n+                sp,\n+                context.getResources().getDisplayMetrics());\n+    }", "originalCommit": "56a9fe6f491e6ccfc1a75db87d8d11263763655c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg4MTc5NA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/3741#discussion_r593881794", "bodyText": "spToPx is the recommended way to do it, I will also change the dpToPx method to do the same. These methods are used in various internal android libs (e.g. see com.google.android.material.internal.ViewUtils.dpToPx(Context context, int dp)), so I do not think they need tests.", "author": "TobiGr", "createdAt": "2021-03-14T11:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzg1ODE3MA=="}], "type": "inlineReview"}, {"oid": "26018c48e7d0e5cdf3e675bceccd41f15e8d7944", "url": "https://github.com/TeamNewPipe/NewPipe/commit/26018c48e7d0e5cdf3e675bceccd41f15e8d7944", "message": "Apply review", "committedDate": "2021-03-14T11:51:02Z", "type": "forcePushed"}, {"oid": "fb2013d9b153ece4c2de8a39fd8582894218b456", "url": "https://github.com/TeamNewPipe/NewPipe/commit/fb2013d9b153ece4c2de8a39fd8582894218b456", "message": "Use latest NPE fork commit", "committedDate": "2021-03-14T11:59:06Z", "type": "forcePushed"}, {"oid": "856fbde671f25284b216eb94767803c38418d7f0", "url": "https://github.com/TeamNewPipe/NewPipe/commit/856fbde671f25284b216eb94767803c38418d7f0", "message": "Use latest extractor version", "committedDate": "2021-03-14T12:00:49Z", "type": "forcePushed"}, {"oid": "22d81a53aec0812332da103448e24e22a0914344", "url": "https://github.com/TeamNewPipe/NewPipe/commit/22d81a53aec0812332da103448e24e22a0914344", "message": "Use latest extractor version", "committedDate": "2021-03-14T16:49:42Z", "type": "forcePushed"}, {"oid": "39a3f03e7952de40bbac8719d97dc47721401a65", "url": "https://github.com/TeamNewPipe/NewPipe/commit/39a3f03e7952de40bbac8719d97dc47721401a65", "message": "Bandcamp support", "committedDate": "2021-03-14T16:52:15Z", "type": "commit"}, {"oid": "292e1030735e6860ba4599136f85337784c193ab", "url": "https://github.com/TeamNewPipe/NewPipe/commit/292e1030735e6860ba4599136f85337784c193ab", "message": "Ignore ContentNotSupportedException caused by Bandcamp fan pages", "committedDate": "2021-03-14T16:52:15Z", "type": "commit"}, {"oid": "a28aa6a8c438448952b42e6b3ec4bd35546f1794", "url": "https://github.com/TeamNewPipe/NewPipe/commit/a28aa6a8c438448952b42e6b3ec4bd35546f1794", "message": "Add Bandcamp to supported services section in README", "committedDate": "2021-03-14T16:52:15Z", "type": "commit"}, {"oid": "71d3227791702901d6c898d4e9a85f0d0eb3cb8c", "url": "https://github.com/TeamNewPipe/NewPipe/commit/71d3227791702901d6c898d4e9a85f0d0eb3cb8c", "message": "Fix bottom controls being out of the screen\n\nThis was caused by too large end screen thumbnails enlarging the whole palyer. Fixed by scaling the thumbnail.\n\nEnsure that the player does not use the whole screen height in detail fragment to keep the additional content like title, comments, etc. available.", "committedDate": "2021-03-14T16:52:15Z", "type": "commit"}, {"oid": "bdaee25e6116e86ce34ebcfd1444a812aaa175af", "url": "https://github.com/TeamNewPipe/NewPipe/commit/bdaee25e6116e86ce34ebcfd1444a812aaa175af", "message": "Use latest extractor version", "committedDate": "2021-03-14T16:52:15Z", "type": "commit"}, {"oid": "bdaee25e6116e86ce34ebcfd1444a812aaa175af", "url": "https://github.com/TeamNewPipe/NewPipe/commit/bdaee25e6116e86ce34ebcfd1444a812aaa175af", "message": "Use latest extractor version", "committedDate": "2021-03-14T16:52:15Z", "type": "forcePushed"}]}