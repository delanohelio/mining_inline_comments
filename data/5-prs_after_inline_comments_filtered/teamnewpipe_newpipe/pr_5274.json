{"pr_number": 5274, "pr_title": "Add stream segments to player controls", "pr_createdAt": "2020-12-25T17:08:13Z", "pr_url": "https://github.com/TeamNewPipe/NewPipe/pull/5274", "timeline": [{"oid": "91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "url": "https://github.com/TeamNewPipe/NewPipe/commit/91e3093cd6517684c13ae5fd3cb9146fcf8b93cc", "message": "Add stream segments to VideoPlayerImpl", "committedDate": "2020-12-25T18:14:39Z", "type": "forcePushed"}, {"oid": "5b2452ba001613fc64ab65dbe5f13652e2a275c9", "url": "https://github.com/TeamNewPipe/NewPipe/commit/5b2452ba001613fc64ab65dbe5f13652e2a275c9", "message": "Add stream segments to VideoPlayerImpl", "committedDate": "2020-12-26T13:04:40Z", "type": "forcePushed"}, {"oid": "5784568d61bfaa1f19725353465ef90247243878", "url": "https://github.com/TeamNewPipe/NewPipe/commit/5784568d61bfaa1f19725353465ef90247243878", "message": "Add stream segments to VideoPlayerImpl", "committedDate": "2020-12-26T17:31:31Z", "type": "forcePushed"}, {"oid": "f3c7412b375178215daccc7adf62303b01eeacb3", "url": "https://github.com/TeamNewPipe/NewPipe/commit/f3c7412b375178215daccc7adf62303b01eeacb3", "message": "Add stream segments to VideoPlayerImpl", "committedDate": "2020-12-27T15:50:18Z", "type": "forcePushed"}, {"oid": "9a901619a8250d62ee9af0a4cca72744de808ebc", "url": "https://github.com/TeamNewPipe/NewPipe/commit/9a901619a8250d62ee9af0a4cca72744de808ebc", "message": "Add stream segments to player", "committedDate": "2021-01-12T14:54:20Z", "type": "forcePushed"}, {"oid": "cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "url": "https://github.com/TeamNewPipe/NewPipe/commit/cb5f69201e14c72b5f4c5dbd671332365d9f5d67", "message": "Add stream segments to player", "committedDate": "2021-01-12T21:59:52Z", "type": "forcePushed"}, {"oid": "dbba577f7f97e06b862df03d1d95b87518cf650a", "url": "https://github.com/TeamNewPipe/NewPipe/commit/dbba577f7f97e06b862df03d1d95b87518cf650a", "message": "Add stream segments to player", "committedDate": "2021-01-14T15:28:27Z", "type": "forcePushed"}, {"oid": "880daad3fe0e49858dc1e876f0bceb7535b33013", "url": "https://github.com/TeamNewPipe/NewPipe/commit/880daad3fe0e49858dc1e876f0bceb7535b33013", "message": "Add stream segments to player", "committedDate": "2021-01-14T16:52:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU2OTI5Mg==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557569292", "bodyText": "Remove this, I left it here accidentally", "author": "Stypox", "createdAt": "2021-01-14T17:31:17Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2837,39 +2851,89 @@ private void onQueueClicked() {\n         buildQueue();\n         //updatePlaybackButtons();//TODO verify this can be removed", "originalCommit": "880daad3fe0e49858dc1e876f0bceb7535b33013", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3MTc4Nw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557571787", "bodyText": "Change\n    /*//////////////////////////////////////////////////////////////////////////\n    // Play queue and streams\n    //////////////////////////////////////////////////////////////////////////*/\n\ninto\n    /*//////////////////////////////////////////////////////////////////////////\n    // Play queue, segments and streams\n    //////////////////////////////////////////////////////////////////////////*/\n\nabove here", "author": "Stypox", "createdAt": "2021-01-14T17:35:30Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2837,39 +2851,89 @@ private void onQueueClicked() {\n         buildQueue();", "originalCommit": "880daad3fe0e49858dc1e876f0bceb7535b33013", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NDExNQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557574115", "bodyText": "Just to make sure: is it possible that the first segment does not start at 0:00? In that case the result of this function would be wrong when the progress is 0:00, since the first segment has yet to start. Maybe no item should be selected in the adapter in that case?", "author": "Stypox", "createdAt": "2021-01-14T17:39:13Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -2882,12 +2946,33 @@ public void onScrolledDown(final RecyclerView recyclerView) {\n                 if (playQueue != null && !playQueue.isComplete()) {\n                     playQueue.fetch();\n                 } else if (binding != null) {\n-                    binding.playQueue.clearOnScrollListeners();\n+                    binding.itemsList.clearOnScrollListeners();\n                 }\n             }\n         };\n     }\n \n+    private StreamSegmentAdapter.StreamSegmentListener getStreamSegmentListener() {\n+        return (item, seconds) -> {\n+            segmentAdapter.selectSegment(item);\n+            seekTo(seconds * 1000);\n+            triggerProgressUpdate();\n+        };\n+    }\n+\n+    private int getNearestStreamSegmentPosition(final long playbackPosition) {\n+        int nearestPosition = 0;\n+        final List<StreamSegment> segments = currentMetadata.getMetadata().getStreamSegments();\n+\n+        for (int i = 0; i < segments.size(); i++) {\n+            if (segments.get(i).getStartTimeSeconds() * 1000 > playbackPosition) {\n+                break;\n+            }\n+            nearestPosition++;\n+        }\n+        return Math.max(0, nearestPosition - 1);", "originalCommit": "880daad3fe0e49858dc1e876f0bceb7535b33013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwNTI1MQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557605251", "bodyText": "I ran multiple checks myself when I added the functionality to the extractor by uploading a video and playing around. The chapters are only available if the description contains 0:00, so it's always starting from the beginning.", "author": "vkay94", "createdAt": "2021-01-14T18:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NDExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxOTI0MA==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557619240", "bodyText": "Ok, great, then this is good", "author": "Stypox", "createdAt": "2021-01-14T18:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NDExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NjE0OQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557576149", "bodyText": "Maybe wrap everything in a if (areSegmentsVisible), to make it clearer:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (currentMetadata != null && areSegmentsVisible\n          \n          \n            \n                            && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n          \n          \n            \n                        final int adapterPosition = getNearestStreamSegmentPosition(\n          \n          \n            \n                                simpleExoPlayer.getCurrentPosition());\n          \n          \n            \n                        segmentAdapter.selectSegmentAt(adapterPosition);\n          \n          \n            \n                        binding.itemsList.scrollToPosition(adapterPosition);\n          \n          \n            \n                    } else if (areSegmentsVisible) {\n          \n          \n            \n                        closeItemsList();\n          \n          \n            \n                    }\n          \n          \n            \n                    if (areSegmentsVisible) {\n          \n          \n            \n                        if (currentMetadata != null\n          \n          \n            \n                                && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n          \n          \n            \n                            final int adapterPosition = getNearestStreamSegmentPosition(\n          \n          \n            \n                                    simpleExoPlayer.getCurrentPosition());\n          \n          \n            \n                            segmentAdapter.selectSegmentAt(adapterPosition);\n          \n          \n            \n                            binding.itemsList.scrollToPosition(adapterPosition);\n          \n          \n            \n                        } else {\n          \n          \n            \n                            closeItemsList();\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "author": "Stypox", "createdAt": "2021-01-14T17:42:25Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -3736,6 +3824,15 @@ private void notifyMetadataUpdateToListeners() {\n         if (activityListener != null && currentMetadata != null) {\n             activityListener.onMetadataUpdate(currentMetadata.getMetadata(), playQueue);\n         }\n+        if (currentMetadata != null && areSegmentsVisible\n+                && segmentAdapter.setItems(currentMetadata.getMetadata())) {\n+            final int adapterPosition = getNearestStreamSegmentPosition(\n+                    simpleExoPlayer.getCurrentPosition());\n+            segmentAdapter.selectSegmentAt(adapterPosition);\n+            binding.itemsList.scrollToPosition(adapterPosition);\n+        } else if (areSegmentsVisible) {\n+            closeItemsList();\n+        }", "originalCommit": "880daad3fe0e49858dc1e876f0bceb7535b33013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYzNTIyMw==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557635223", "bodyText": "Okay. I'll also move this code snippet - like the other one - to the upper method onMetadataChanged (it also provides the MetaInfo directly, no null checks required) (the placements are from the previous code before rebasing :') )", "author": "vkay94", "createdAt": "2021-01-14T19:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3NjE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3Njg1NQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557576855", "bodyText": "This is not a listener, so I don't think this piece of code should be here, but maybe I'm wrong", "author": "Stypox", "createdAt": "2021-01-14T17:43:31Z", "path": "app/src/main/java/org/schabi/newpipe/player/Player.java", "diffHunk": "@@ -3758,6 +3855,9 @@ private void notifyProgressUpdateToListeners(final int currentProgress,\n         if (activityListener != null) {\n             activityListener.onProgressUpdate(currentProgress, duration, bufferPercent);\n         }\n+        if (areSegmentsVisible) {\n+            segmentAdapter.selectSegmentAt(getNearestStreamSegmentPosition(currentProgress));\n+        }", "originalCommit": "880daad3fe0e49858dc1e876f0bceb7535b33013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwOTEzNQ==", "url": "https://github.com/TeamNewPipe/NewPipe/pull/5274#discussion_r557609135", "bodyText": "In fact, you're right, I'll move it to the \"parent\" method (onUpdateProgress), should be better.", "author": "vkay94", "createdAt": "2021-01-14T18:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU3Njg1NQ=="}], "type": "inlineReview"}, {"oid": "37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "url": "https://github.com/TeamNewPipe/NewPipe/commit/37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "message": "Add stream segments to player", "committedDate": "2021-01-14T20:58:19Z", "type": "commit"}, {"oid": "37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "url": "https://github.com/TeamNewPipe/NewPipe/commit/37aa41afaed3a3f7698fa894e6a5f6cfb12088e5", "message": "Add stream segments to player", "committedDate": "2021-01-14T20:58:19Z", "type": "forcePushed"}]}