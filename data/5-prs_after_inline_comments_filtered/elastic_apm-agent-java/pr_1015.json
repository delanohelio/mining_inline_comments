{"pr_number": 1015, "pr_title": "return error id with captureException in public api", "pr_createdAt": "2020-01-29T12:48:08Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1015", "timeline": [{"oid": "d1ee5b0ba6b715ef47333bf062e12127d1ca00e9", "url": "https://github.com/elastic/apm-agent-java/commit/d1ee5b0ba6b715ef47333bf062e12127d1ca00e9", "message": "miss imports removed", "committedDate": "2020-01-29T15:19:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372806797", "bodyText": "I don't think we need this API, it doesn't save much to the caller (only extract the ID). The one returning the ErrorCapture is very useful as is.\nI can easily imaging how a caller may want to do lots of other stuff with the ErrorCapture and we wouldn't add an API for each usage.", "author": "eyalkoren", "createdAt": "2020-01-30T08:12:07Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -320,7 +321,14 @@ public void captureException(long epochMicros, @Nullable Throwable e, TraceConte\n         captureException(epochMicros, e, parent, null);\n     }\n \n-    public void captureException(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent, @Nullable ClassLoader initiatingClassLoader) {\n+    @Nullable\n+    public String captureExceptionAndGetErrorId(long epochMicros, @Nullable Throwable e, @Nullable TraceContextHolder<?> parent) {", "originalCommit": "a596e908dfe1ff405c9e16404fe0ae29859ee873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTcwMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931701", "bodyText": "fixed", "author": "kananindzya", "createdAt": "2020-02-03T05:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTkyNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931927", "bodyText": "added documentation", "author": "kananindzya", "createdAt": "2020-02-03T05:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwNjc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwODk5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372808997", "bodyText": "Better call transaction.captureException, then you test both added methods.", "author": "eyalkoren", "createdAt": "2020-01-30T08:17:52Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/ElasticApmTracerTest.java", "diffHunk": "@@ -489,4 +490,17 @@ void testOverrideServiceNameExplicitServiceName() {\n         tracer.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader()).end();\n         assertThat(reporter.getFirstTransaction().getTraceContext().getServiceName()).isNull();\n     }\n+\n+    @Test\n+    void testCaptureExceptionAndGetErrorId() {\n+        Transaction transaction = tracerImpl.startTransaction(TraceContext.asRoot(), null, getClass().getClassLoader());\n+        String errorId = tracerImpl.captureExceptionAndGetErrorId(System.currentTimeMillis() * 1000, new Exception(\"test\"), transaction);", "originalCommit": "a596e908dfe1ff405c9e16404fe0ae29859ee873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTc0NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931745", "bodyText": "fixed", "author": "kananindzya", "createdAt": "2020-02-03T05:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgwODk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxNTI1MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r372815250", "bodyText": "This probably won't work when a user upgrades the agent and not the API (a very valid scenario)- the agent will instrument the captureException API that returns void and the instrumentation will expect a String being returned.\nWhat you need to do is change the constructor of this class, so that the method matcher is more specific on the return type, probably something like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.VOID)) and add another CaptureExceptionWithReturnIdInstrumentation class that uses a method matcher like: named(\"captureException\").and(takesArguments(Throwable.class)).and(returns(TypeDescription.STRING)) and does what you did here.\nEventually, you must test your branch's agent with an older API jar, and you should test your branch's API jar with an older agent. We don't have automatic tests for that, but should be easy to do manually.", "author": "eyalkoren", "createdAt": "2020-01-30T08:34:04Z", "path": "apm-agent-plugins/apm-api-plugin/src/main/java/co/elastic/apm/agent/plugin/api/AbstractSpanInstrumentation.java", "diffHunk": "@@ -178,8 +178,9 @@ public CaptureExceptionInstrumentation() {\n         @VisibleForAdvice\n         @Advice.OnMethodExit(suppress = Throwable.class)\n         public static void captureException(@Advice.FieldValue(value = \"span\", typing = Assigner.Typing.DYNAMIC) TraceContextHolder<?> context,\n-                                            @Advice.Argument(0) Throwable t) {\n-            context.captureException(t);\n+                                            @Advice.Argument(0) Throwable t,\n+                                            @Advice.Return(readOnly = false) String errorId) {", "originalCommit": "a596e908dfe1ff405c9e16404fe0ae29859ee873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTgxMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931810", "bodyText": "added new method captureExceptionAndReturnErrorId", "author": "kananindzya", "createdAt": "2020-02-03T05:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgxNTI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373011293", "bodyText": "Technically, this is a breaking change in binary compatibility. When not re-compiling the application and updating the dependency, it would result in an exception when calling the method. That is because methods are linked also based on their return type.\nBut still think we can leave it as-is as most likely, someone would re-compile the application again after updating the dependency to the agent API.\nA more conservative option would be to create a method with a different name, like captureExceptionAndReturnErrorId and leave void captureException(Throwable throwable) as-is.", "author": "felixbarny", "createdAt": "2020-01-30T15:18:53Z", "path": "apm-agent-api/src/main/java/co/elastic/apm/api/Span.java", "diffHunk": "@@ -281,7 +281,7 @@\n      *\n      * @param throwable the exception to report\n      */\n-    void captureException(Throwable throwable);\n+    String captureException(Throwable throwable);", "originalCommit": "a596e908dfe1ff405c9e16404fe0ae29859ee873", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgyOTg0NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373829845", "bodyText": "Good point!\nI agree it's best to leave as is (meaning - just change the method signature) and not to complicate the API for this corner case.", "author": "eyalkoren", "createdAt": "2020-02-02T08:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMTg2MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r373931861", "bodyText": "added new method", "author": "kananindzya", "createdAt": "2020-02-03T05:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc0OTIzMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1015#discussion_r374749233", "bodyText": "I think you got us wrong. While there is a corner case for a potential breaking change, just leave captureException as the method name to not clutter the API too much.", "author": "felixbarny", "createdAt": "2020-02-04T15:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxMTI5Mw=="}], "type": "inlineReview"}, {"oid": "20a0487b1c324d55cef3ac2d45d082808dbf8532", "url": "https://github.com/elastic/apm-agent-java/commit/20a0487b1c324d55cef3ac2d45d082808dbf8532", "message": "return error id with captureException in public api", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "656f715830ad1fa053bce0e64b50238e1572559a", "url": "https://github.com/elastic/apm-agent-java/commit/656f715830ad1fa053bce0e64b50238e1572559a", "message": "added tests.", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "0afc44ccb9a54338c664efcb0965aaba88e12715", "url": "https://github.com/elastic/apm-agent-java/commit/0afc44ccb9a54338c664efcb0965aaba88e12715", "message": "miss imports removed", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "dd87fd63c21451a34ed9a50e0850254c6a505ddf", "url": "https://github.com/elastic/apm-agent-java/commit/dd87fd63c21451a34ed9a50e0850254c6a505ddf", "message": "added nullable", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "148c5f6e8a38817f70620dd90b65dcdfc3283c00", "url": "https://github.com/elastic/apm-agent-java/commit/148c5f6e8a38817f70620dd90b65dcdfc3283c00", "message": "minor fixes", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "a20f31db6df2f2bc38fdaa9960e4eb9577d7a7e2", "url": "https://github.com/elastic/apm-agent-java/commit/a20f31db6df2f2bc38fdaa9960e4eb9577d7a7e2", "message": "fix styles and comments", "committedDate": "2020-02-13T10:23:28Z", "type": "commit"}, {"oid": "f33dc26662237468ce86a7f334eadd65fb55a5f5", "url": "https://github.com/elastic/apm-agent-java/commit/f33dc26662237468ce86a7f334eadd65fb55a5f5", "message": "minor fixes. added doccumentation", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "7f332d4f4808b8f65fb0191eb6b53826d29ea35b", "url": "https://github.com/elastic/apm-agent-java/commit/7f332d4f4808b8f65fb0191eb6b53826d29ea35b", "message": "deleted captureExceptionAndReturnErrorId", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "0b5c3efe480867b514b9b717cee3470832317f17", "url": "https://github.com/elastic/apm-agent-java/commit/0b5c3efe480867b514b9b717cee3470832317f17", "message": "use assertj matcher for consistency", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "c5eb7f08deae7b2073c6397c64d12a55b3e0506b", "url": "https://github.com/elastic/apm-agent-java/commit/c5eb7f08deae7b2073c6397c64d12a55b3e0506b", "message": "ensure compatibility with previous API versions", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "8d20376279f4d8bc834eee088e36de43820ed0fa", "url": "https://github.com/elastic/apm-agent-java/commit/8d20376279f4d8bc834eee088e36de43820ed0fa", "message": "add minor javadoc + rename as 'legacy'", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "a7fa926728ed5c0977ae7f1f4638fd34958e5a70", "url": "https://github.com/elastic/apm-agent-java/commit/a7fa926728ed5c0977ae7f1f4638fd34958e5a70", "message": "Update docs/public-api.asciidoc\r\n\r\ndocument API change in 1.14.0\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "4dfdccd5005b500e62fdc7f0240adf5577bb7760", "url": "https://github.com/elastic/apm-agent-java/commit/4dfdccd5005b500e62fdc7f0240adf5577bb7760", "message": "Update docs/public-api.asciidoc\r\n\r\ndocument API change in 1.14.0\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>", "committedDate": "2020-02-13T10:23:32Z", "type": "commit"}, {"oid": "2249da6d5fc9aa58327af5b3702cef678f2b9417", "url": "https://github.com/elastic/apm-agent-java/commit/2249da6d5fc9aa58327af5b3702cef678f2b9417", "message": "added feature to changelog", "committedDate": "2020-02-13T10:25:00Z", "type": "commit"}, {"oid": "2249da6d5fc9aa58327af5b3702cef678f2b9417", "url": "https://github.com/elastic/apm-agent-java/commit/2249da6d5fc9aa58327af5b3702cef678f2b9417", "message": "added feature to changelog", "committedDate": "2020-02-13T10:25:00Z", "type": "forcePushed"}]}