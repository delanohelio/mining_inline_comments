{"pr_number": 1368, "pr_title": "migrate to indy okhttp plugin", "pr_createdAt": "2020-08-30T21:26:16Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1368", "timeline": [{"oid": "b58c17e9e6592484f082ca70aaa6d44315d2281e", "url": "https://github.com/elastic/apm-agent-java/commit/b58c17e9e6592484f082ca70aaa6d44315d2281e", "message": "migrate to indy okhttp plugin", "committedDate": "2020-08-30T21:25:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4MzYyMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1368#discussion_r480083620", "bodyText": "It's probably fine either way, so just out of curiosity, why did you change from GlobalThreadLocal<Span> to returning the span in the Object[] return value?", "author": "felixbarny", "createdAt": "2020-08-31T12:02:32Z", "path": "apm-agent-plugins/apm-okhttp-plugin/src/main/java/co/elastic/apm/agent/okhttp/OkHttp3ClientInstrumentation.java", "diffHunk": "@@ -40,62 +36,52 @@\n import okhttp3.HttpUrl;\n import okhttp3.Request;\n \n+import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n \n import static net.bytebuddy.matcher.ElementMatchers.named;\n import static net.bytebuddy.matcher.ElementMatchers.returns;\n \n public class OkHttp3ClientInstrumentation extends AbstractOkHttp3ClientInstrumentation {\n \n-    public OkHttp3ClientInstrumentation(ElasticApmTracer tracer) {\n-        super(tracer);\n-    }\n-\n     @Override\n     public Class<?> getAdviceClass() {\n         return OkHttpClient3ExecuteAdvice.class;\n     }\n \n-    @VisibleForAdvice\n     public static class OkHttpClient3ExecuteAdvice {\n \n-        @VisibleForAdvice\n-        public final static GlobalThreadLocal<Span> spanTls = GlobalThreadLocal.get(OkHttpClient3ExecuteAdvice.class, \"spanTls\");", "originalCommit": "b58c17e9e6592484f082ca70aaa6d44315d2281e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgxMzAxNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1368#discussion_r480813014", "bodyText": "Hah, good question :) I don't know why.\nWhat is the difference between using GlobalThreadLocal and returning an array of objects? And when to use them?", "author": "kananindzya", "createdAt": "2020-09-01T05:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4MzYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg2MDAyNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1368#discussion_r480860024", "bodyText": "Also a good question :)\nI guess in terms of allocations, the Obect[] approach might even be better, as the JIT compiler should be able to do some escape analysis and replace it with a stack allocation. Also, it seems a bit safer maybe as there are fewer things that can go wrong, such as forgetting to clear the ThreadLocal.\nA downside is that it requires more casting and things can go wrong when accessing the wrong index in the array.\nBut overall, the Object[] approach is probably preferable in most situations.", "author": "felixbarny", "createdAt": "2020-09-01T06:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4MzYyMA=="}], "type": "inlineReview"}, {"oid": "dbb2832a23430949be5971f8650de50861c979ee", "url": "https://github.com/elastic/apm-agent-java/commit/dbb2832a23430949be5971f8650de50861c979ee", "message": "fix whitespace", "committedDate": "2020-09-01T09:08:26Z", "type": "commit"}]}