{"pr_number": 1275, "pr_title": "Validate that tests don't leaks tracers, scopes and pooled objects", "pr_createdAt": "2020-07-08T08:12:46Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1275", "timeline": [{"oid": "881bb149b23c39e31c00b48ed60d6991a2cad441", "url": "https://github.com/elastic/apm-agent-java/commit/881bb149b23c39e31c00b48ed60d6991a2cad441", "message": "Make sure tracers don't leak tests\n\nValidate recycling and scope leaks after each test method\nFixes scope leak in Executor#submitAll instrumentation", "committedDate": "2020-07-08T08:55:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0OTc4Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451549786", "bodyText": "why?", "author": "eyalkoren", "createdAt": "2020-07-08T13:36:57Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/context/Destination.java", "diffHunk": "@@ -143,7 +143,7 @@ public boolean hasContent() {\n     @Override\n     public void resetState() {\n         address.setLength(0);\n-        port = -1;\n+        port = 0;", "originalCommit": "881bb149b23c39e31c00b48ed60d6991a2cad441", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMDcxMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451600711", "bodyText": "It made a test fail. In general, when calling resetState, the instance should be in the same state as if it had just been instantiated. The field is initialized with the default value of 0.", "author": "felixbarny", "createdAt": "2020-07-08T14:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0OTc4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU2OTkzNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451569935", "bodyText": "Test is failing. Maybe revert to happen before the assertion and wait 20ms before asserting.", "author": "eyalkoren", "createdAt": "2020-07-08T14:03:39Z", "path": "apm-agent-plugins/apm-scheduled-annotation-plugin/src/test/java/co/elastic/apm/agent/spring/scheduled/TimerTaskInstrumentationTest.java", "diffHunk": "@@ -56,14 +55,13 @@ void testTimerTask_scheduleWithFixedRate() throws InterruptedException {\n \n     @Test\n     void testTimerTask_scheduleWithFixedDelay() throws InterruptedException {\n-        reporter.reset();\n         TestTimerTask timerTask = new TestTimerTask();\n         Timer timer = new Timer(\"Timer\");\n         timer.schedule(timerTask, 1L, 10L);\n \n         reporter.awaitUntilAsserted(1000L, () -> {\n-            timer.cancel();\n             assertThat(reporter.getTransactions()).isNotEmpty();\n+            timer.cancel();", "originalCommit": "881bb149b23c39e31c00b48ed60d6991a2cad441", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxNzM3MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1275#discussion_r451617370", "bodyText": "I rewrote the test a little. It should be much more deterministic and resilient now.", "author": "felixbarny", "createdAt": "2020-07-08T15:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU2OTkzNQ=="}], "type": "inlineReview"}, {"oid": "8968f9bf80425798b5cd32f2ca96669a874d9dfd", "url": "https://github.com/elastic/apm-agent-java/commit/8968f9bf80425798b5cd32f2ca96669a874d9dfd", "message": "Make TimerTaskInstrumentationTest more resilient", "committedDate": "2020-07-08T15:05:43Z", "type": "forcePushed"}, {"oid": "2035ed75094e05851d957a8ee07a881ea104e618", "url": "https://github.com/elastic/apm-agent-java/commit/2035ed75094e05851d957a8ee07a881ea104e618", "message": "Make sure tracers don't leak tests\n\nValidate recycling and scope leaks after each test method\nFixes scope leak in Executor#submitAll instrumentation", "committedDate": "2020-07-23T08:04:28Z", "type": "commit"}, {"oid": "5842ad6a3d1fcdbc30d53f9619c5cf377a4efeb0", "url": "https://github.com/elastic/apm-agent-java/commit/5842ad6a3d1fcdbc30d53f9619c5cf377a4efeb0", "message": "Make TimerTaskInstrumentationTest more resilient", "committedDate": "2020-07-23T08:13:10Z", "type": "commit"}, {"oid": "5842ad6a3d1fcdbc30d53f9619c5cf377a4efeb0", "url": "https://github.com/elastic/apm-agent-java/commit/5842ad6a3d1fcdbc30d53f9619c5cf377a4efeb0", "message": "Make TimerTaskInstrumentationTest more resilient", "committedDate": "2020-07-23T08:13:10Z", "type": "forcePushed"}]}