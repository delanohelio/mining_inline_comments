{"pr_number": 1019, "pr_title": "Add gRPC client/server instrumentation plugin", "pr_createdAt": "2020-02-04T09:16:35Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1019", "timeline": [{"oid": "5f4fc0d4362a3ee9826c42bfa3f9ecf95aa8d53e", "url": "https://github.com/elastic/apm-agent-java/commit/5f4fc0d4362a3ee9826c42bfa3f9ecf95aa8d53e", "message": "remove redundant dependencies", "committedDate": "2020-02-04T09:32:26Z", "type": "commit"}, {"oid": "a1e09ad78ce9b6971d69038ca8673d9a835a6da9", "url": "https://github.com/elastic/apm-agent-java/commit/a1e09ad78ce9b6971d69038ca8673d9a835a6da9", "message": "bootstrap a new plugin", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "604a013b2e065daa344d44eb6d401a7173f77a1d", "url": "https://github.com/elastic/apm-agent-java/commit/604a013b2e065daa344d44eb6d401a7173f77a1d", "message": "add base grpc dependencies & build", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "e02236897a20880d6b106af9a1eefe8946caced9", "url": "https://github.com/elastic/apm-agent-java/commit/e02236897a20880d6b106af9a1eefe8946caced9", "message": "bootstrap server impl", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "19ab9ebfda3e6e0fd2d1b05ed24a9f0f0b8b41b4", "url": "https://github.com/elastic/apm-agent-java/commit/19ab9ebfda3e6e0fd2d1b05ed24a9f0f0b8b41b4", "message": "wip test app", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "0b8701e1899142d2ced9bb5d367e0e22f2a94ff1", "url": "https://github.com/elastic/apm-agent-java/commit/0b8701e1899142d2ced9bb5d367e0e22f2a94ff1", "message": "move app to test scope", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "cd32ff0552aa981c93695f029aa0d7622f0f3d14", "url": "https://github.com/elastic/apm-agent-java/commit/cd32ff0552aa981c93695f029aa0d7622f0f3d14", "message": "add generated + nested calls support", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "150bab7c7be5216d69e9a15a32ffdf9b2cdce9b7", "url": "https://github.com/elastic/apm-agent-java/commit/150bab7c7be5216d69e9a15a32ffdf9b2cdce9b7", "message": "add simple tests for sample app behavior", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "7eef77ba747d731048b9ba3c981c970c0e9fff06", "url": "https://github.com/elastic/apm-agent-java/commit/7eef77ba747d731048b9ba3c981c970c0e9fff06", "message": "cover java-ish way to deal with server side errors", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "69b05dffe49df0ddc943423b9f0d10636254c113", "url": "https://github.com/elastic/apm-agent-java/commit/69b05dffe49df0ddc943423b9f0d10636254c113", "message": "wip on server interceptor\n\nruntime exceptions thrown during transaction are not properly handled\nwhen such exceptions happen, there is no reported transaction", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "3b32c4cc6f1e7f0f8dc956bdf15d314a5cd64521", "url": "https://github.com/elastic/apm-agent-java/commit/3b32c4cc6f1e7f0f8dc956bdf15d314a5cd64521", "message": "server transactions without Interceptor !!", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "951ba529e0b3f1acd88b711533aa141a2673097c", "url": "https://github.com/elastic/apm-agent-java/commit/951ba529e0b3f1acd88b711533aa141a2673097c", "message": "cleanup before PR", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "a442b49cd3743d5b99b9060f4ad61d0ec1be8607", "url": "https://github.com/elastic/apm-agent-java/commit/a442b49cd3743d5b99b9060f4ad61d0ec1be8607", "message": "cleanup before client instrumentation", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "a67d7a3291f78ac48f900af74826e5ccda17bf63", "url": "https://github.com/elastic/apm-agent-java/commit/a67d7a3291f78ac48f900af74826e5ccda17bf63", "message": "improve benchmark ascii layout", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "bd6b2e3eaa61097673980b23cb7d9383208d2529", "url": "https://github.com/elastic/apm-agent-java/commit/bd6b2e3eaa61097673980b23cb7d9383208d2529", "message": "improve error message for easier debug", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "06b3fb04ca82929aeb026f8cddd38a34fe03c59f", "url": "https://github.com/elastic/apm-agent-java/commit/06b3fb04ca82929aeb026f8cddd38a34fe03c59f", "message": "add address+port at once on destination", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "cad7be905b9c4684e516d9575b4c1036bf1cdb49", "url": "https://github.com/elastic/apm-agent-java/commit/cad7be905b9c4684e516d9575b4c1036bf1cdb49", "message": "improve error message to help troubleshooting\n\nThis is quite common when we try to have an instrumentation that is an abstract class, thus making it obvious helps", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "fd2d761778aa6f5ea79f3ff2cdf165a0ae061b13", "url": "https://github.com/elastic/apm-agent-java/commit/fd2d761778aa6f5ea79f3ff2cdf165a0ae061b13", "message": "provide better exception messages for known causes", "committedDate": "2020-02-04T09:33:03Z", "type": "commit"}, {"oid": "2cec6ed85f32ff4e7e3aecf5f71125e0fd418059", "url": "https://github.com/elastic/apm-agent-java/commit/2cec6ed85f32ff4e7e3aecf5f71125e0fd418059", "message": "enhance assertions description", "committedDate": "2020-02-04T09:33:56Z", "type": "commit"}, {"oid": "9f1167d256864c8e7f6441779fe9cc797e28814c", "url": "https://github.com/elastic/apm-agent-java/commit/9f1167d256864c8e7f6441779fe9cc797e28814c", "message": "wip implementation", "committedDate": "2020-02-04T09:33:56Z", "type": "commit"}, {"oid": "219b709d5af720c3aafb878ef4902f3533d25875", "url": "https://github.com/elastic/apm-agent-java/commit/219b709d5af720c3aafb878ef4902f3533d25875", "message": "fix port parsing with api from java9", "committedDate": "2020-02-04T09:33:56Z", "type": "commit"}, {"oid": "219b709d5af720c3aafb878ef4902f3533d25875", "url": "https://github.com/elastic/apm-agent-java/commit/219b709d5af720c3aafb878ef4902f3533d25875", "message": "fix port parsing with api from java9", "committedDate": "2020-02-04T09:33:56Z", "type": "forcePushed"}, {"oid": "612472fd35dcf10db413a75a5f42d85caaf90b19", "url": "https://github.com/elastic/apm-agent-java/commit/612472fd35dcf10db413a75a5f42d85caaf90b19", "message": "fix & re-format code", "committedDate": "2020-02-04T09:47:51Z", "type": "commit"}, {"oid": "79df2489af6ea7d2ff19bf3665e2bde63b5e0f24", "url": "https://github.com/elastic/apm-agent-java/commit/79df2489af6ea7d2ff19bf3665e2bde63b5e0f24", "message": "minor (but essential) fixes from quick review", "committedDate": "2020-02-04T13:34:04Z", "type": "commit"}, {"oid": "5913fa8a366bc8f69fd65811cd5e7e46d13b0def", "url": "https://github.com/elastic/apm-agent-java/commit/5913fa8a366bc8f69fd65811cd5e7e46d13b0def", "message": "Merge branch 'master' into add-grpc-plugin", "committedDate": "2020-02-06T14:32:01Z", "type": "commit"}, {"oid": "b28940b4b1d674e9825fec048ff7193ce1d96da8", "url": "https://github.com/elastic/apm-agent-java/commit/b28940b4b1d674e9825fec048ff7193ce1d96da8", "message": "Felix was right about the order + assertions improve", "committedDate": "2020-02-07T15:14:58Z", "type": "commit"}, {"oid": "2d64f998c949bbccb43418174a97f48c48296c84", "url": "https://github.com/elastic/apm-agent-java/commit/2d64f998c949bbccb43418174a97f48c48296c84", "message": "wip grpc async client", "committedDate": "2020-02-07T17:30:23Z", "type": "commit"}, {"oid": "ffd35786ace400903d13af407decacd048dc862a", "url": "https://github.com/elastic/apm-agent-java/commit/ffd35786ace400903d13af407decacd048dc862a", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into add-grpc-plugin", "committedDate": "2020-02-17T15:26:43Z", "type": "commit"}, {"oid": "53fdd9b5819126c94a561d6b3e0c3a74c0123ed1", "url": "https://github.com/elastic/apm-agent-java/commit/53fdd9b5819126c94a561d6b3e0c3a74c0123ed1", "message": "fix creating instrumentation instances", "committedDate": "2020-02-18T13:34:39Z", "type": "commit"}, {"oid": "087b1ac46d1eff96288d42b5392d06f534c45447", "url": "https://github.com/elastic/apm-agent-java/commit/087b1ac46d1eff96288d42b5392d06f534c45447", "message": "update parent after merging master", "committedDate": "2020-02-18T13:35:37Z", "type": "commit"}, {"oid": "899a0c6e5c234eb1bab36fcf5d6584efb0256ba6", "url": "https://github.com/elastic/apm-agent-java/commit/899a0c6e5c234eb1bab36fcf5d6584efb0256ba6", "message": "use helper manager + start context propagation", "committedDate": "2020-02-18T13:37:56Z", "type": "commit"}, {"oid": "4edded784d5d0b033a204501cb968805b14da91a", "url": "https://github.com/elastic/apm-agent-java/commit/4edded784d5d0b033a204501cb968805b14da91a", "message": "add context propagation headers", "committedDate": "2020-02-18T15:56:49Z", "type": "commit"}, {"oid": "1bffc17e1ba503363dc6f7f8d886a97a9beb3ede", "url": "https://github.com/elastic/apm-agent-java/commit/1bffc17e1ba503363dc6f7f8d886a97a9beb3ede", "message": "remove unused class warnings", "committedDate": "2020-02-18T15:57:16Z", "type": "commit"}, {"oid": "05f2df58eeb677eb9adacdd2da138a41be7d5633", "url": "https://github.com/elastic/apm-agent-java/commit/05f2df58eeb677eb9adacdd2da138a41be7d5633", "message": "code cleanup", "committedDate": "2020-02-18T16:00:57Z", "type": "commit"}, {"oid": "96fc366c39c7e281af7ab12b5fca82114ba7949c", "url": "https://github.com/elastic/apm-agent-java/commit/96fc366c39c7e281af7ab12b5fca82114ba7949c", "message": "update doc & changelog", "committedDate": "2020-02-18T16:44:29Z", "type": "commit"}, {"oid": "23645081388b228a454b188777c5341ba707670c", "url": "https://github.com/elastic/apm-agent-java/commit/23645081388b228a454b188777c5341ba707670c", "message": "fix changelog for 1.14.0", "committedDate": "2020-02-18T16:46:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3MTE5NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r381971195", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if( address != null) {\n          \n          \n            \n                    if (address != null) {", "author": "felixbarny", "createdAt": "2020-02-20T12:34:22Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/context/Destination.java", "diffHunk": "@@ -44,17 +44,8 @@\n     private int port;\n \n     public Destination withAddress(@Nullable CharSequence address) {\n-        if (address != null && address.length() > 0) {\n-            // remove square brackets for IPv6 addresses\n-            int startIndex = 0;\n-            if (address.charAt(0) == '[') {\n-                startIndex = 1;\n-            }\n-            int endIndex = address.length();\n-            if (address.charAt(endIndex - 1) == ']') {\n-                endIndex--;\n-            }\n-            this.address.append(address, startIndex, endIndex);\n+        if( address != null) {", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3Mzc3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r381973772", "bodyText": "how does that affect breakdown metrics? Seems related to #884", "author": "felixbarny", "createdAt": "2020-02-20T12:40:19Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/transaction/AbstractSpan.java", "diffHunk": "@@ -355,10 +357,22 @@ public Runnable withActive(Runnable runnable) {\n         return tracer.wrapCallable(callable, this);\n     }\n \n+    /**\n+     * Set start timestamp\n+     *\n+     * @param epochMicros start timestamp in micro-seconds since epoch\n+     */\n     public void setStartTimestamp(long epochMicros) {\n         timestamp = epochMicros;\n     }\n \n+    /**\n+     * Set start timestamp from context current clock\n+     */\n+    public void setStartTimestampNow() {\n+        timestamp = getTraceContext().getClock().getEpochMicros();", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1ODMxNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r388358314", "bodyText": "I don't really know how does it might impact breakdown metrics, maybe we could sync IRL on that ?", "author": "SylvainJuge", "createdAt": "2020-03-05T15:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3Mzc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4ODIzOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r392988239", "bodyText": "@felixbarny maybe we should probably add a comment that this method may have an impact on breakdown metrics ?\nI've added this method just to factor-in some similar method calls (see next file in the review).", "author": "SylvainJuge", "createdAt": "2020-03-16T12:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3Mzc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3NDgwOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r381974809", "bodyText": "\ud83d\udc4d", "author": "felixbarny", "createdAt": "2020-02-20T12:42:40Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/util/DependencyInjectingServiceLoader.java", "diffHunk": "@@ -108,17 +109,39 @@ private void instantiate(Set<String> implementations) {\n     private T instantiate(String implementation) {\n         try {\n             final Class<?> implementationClass = Class.forName(implementation, true, classLoader);\n+            checkClassModifiers(implementationClass);\n             Constructor<?> constructor = getMatchingConstructor(implementationClass);\n             if (constructor != null) {\n+                checkConstructorModifiers(constructor);\n                 return clazz.cast(constructor.newInstance(constructorArguments));\n             } else {\n-                return clazz.cast(implementationClass.getConstructor().newInstance());\n+                constructor = implementationClass.getConstructor();\n+                checkConstructorModifiers(constructor);\n+                return clazz.cast(constructor.newInstance());\n             }\n+        } catch (InstantiationException e) {\n+            String msg = String.format(\"unable to instantiate '%s', please check descriptor in META-INF\", implementation);\n+            throw new ServiceConfigurationError(msg, e);\n         } catch (Exception e) {\n             throw new ServiceConfigurationError(e.getMessage(), e);\n         }\n     }\n \n+    private static void checkConstructorModifiers(Constructor<?> constructor) {", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3NTUwOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r381975509", "bodyText": "\ud83e\udd29", "author": "felixbarny", "createdAt": "2020-02-20T12:44:15Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/MockReporter.java", "diffHunk": "@@ -180,7 +181,10 @@ private JsonNode asJson(String jsonContent) {\n     }\n \n     public synchronized Transaction getFirstTransaction() {\n-        return transactions.iterator().next();\n+        assertThat(transactions)", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0OTk1Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r382049952", "bodyText": "Cache Metadata.Key instances to avoid allocations.", "author": "felixbarny", "createdAt": "2020-02-20T14:54:37Z", "path": "apm-agent-plugins/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHeaderGetter.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.grpc.helper;\n+\n+import co.elastic.apm.agent.impl.transaction.AbstractHeaderGetter;\n+import co.elastic.apm.agent.impl.transaction.TextHeaderGetter;\n+import io.grpc.Metadata;\n+\n+import javax.annotation.Nullable;\n+\n+class GrpcHeaderGetter extends AbstractHeaderGetter<String, Metadata> implements TextHeaderGetter<Metadata> {\n+\n+    @Nullable\n+    @Override\n+    public String getFirstHeader(String headerName, Metadata carrier) {\n+        return carrier.get(Metadata.Key.of(headerName, Metadata.ASCII_STRING_MARSHALLER));", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDAzMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r382050030", "bodyText": "Cache Metadata.Key instances to avoid allocations.", "author": "felixbarny", "createdAt": "2020-02-20T14:54:46Z", "path": "apm-agent-plugins/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHeaderSetter.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.grpc.helper;\n+\n+import co.elastic.apm.agent.impl.transaction.TextHeaderSetter;\n+import io.grpc.Metadata;\n+\n+class GrpcHeaderSetter implements TextHeaderSetter<Metadata> {\n+\n+    @Override\n+    public void setHeader(String headerName, String headerValue, Metadata carrier) {\n+        carrier.put(Metadata.Key.of(headerName, Metadata.ASCII_STRING_MARSHALLER), headerValue);", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDk5OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r382050998", "bodyText": "Outdated?", "author": "felixbarny", "createdAt": "2020-02-20T14:56:14Z", "path": "apm-agent-plugins/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/helper/GrpcHelperImpl.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.grpc.helper;\n+\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.context.Destination;\n+import co.elastic.apm.agent.impl.transaction.Span;\n+import co.elastic.apm.agent.impl.transaction.TextHeaderGetter;\n+import co.elastic.apm.agent.impl.transaction.TextHeaderSetter;\n+import co.elastic.apm.agent.impl.transaction.Transaction;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+import io.grpc.ClientCall;\n+import io.grpc.Metadata;\n+import io.grpc.MethodDescriptor;\n+import io.grpc.ServerCall;\n+import io.grpc.Status;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Helper class for gRPC client and server calls.\n+ *\n+ * <br>\n+ * Since instances of this class are loaded through {@see co.elastic.apm.agent.bci.HelperClassManager}, we can use all\n+ * classes that are part of the gRPC API.\n+ */\n+@SuppressWarnings(\"unused\")\n+public class GrpcHelperImpl implements GrpcHelper {\n+\n+    /**\n+     * Map of all in-flight spans, is only used by client part.\n+     * Key is {@link ClientCall}, but referred as {@link Object} to avoid loading any gRPC reference in the bootstrap classloader", "originalCommit": "23645081388b228a454b188777c5341ba707670c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cd3ff7f8c887f3a878e9bd8a9a555c4f5eb07a18", "url": "https://github.com/elastic/apm-agent-java/commit/cd3ff7f8c887f3a878e9bd8a9a555c4f5eb07a18", "message": "add tests for 1.23 & 1.27.1 gRPC", "committedDate": "2020-02-21T14:24:00Z", "type": "commit"}, {"oid": "6f140aab5e75d50b3db618094d738ab672463834", "url": "https://github.com/elastic/apm-agent-java/commit/6f140aab5e75d50b3db618094d738ab672463834", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into add-grpc-plugin", "committedDate": "2020-02-21T14:26:00Z", "type": "commit"}, {"oid": "8d6789c5f45b72e82b1c8ec16aef11da1f24244b", "url": "https://github.com/elastic/apm-agent-java/commit/8d6789c5f45b72e82b1c8ec16aef11da1f24244b", "message": "remove old broken dep", "committedDate": "2020-02-21T14:46:29Z", "type": "commit"}, {"oid": "4005615749c0183a4cdb27cf0a57ffd63ce842d9", "url": "https://github.com/elastic/apm-agent-java/commit/4005615749c0183a4cdb27cf0a57ffd63ce842d9", "message": "add test gRPC 1.22 + update protobuf compiler", "committedDate": "2020-02-21T16:12:31Z", "type": "commit"}, {"oid": "440fe0d429f69a4f3edab988fde597273344c07d", "url": "https://github.com/elastic/apm-agent-java/commit/440fe0d429f69a4f3edab988fde597273344c07d", "message": "use 'Abstract' prefix to avoid duplicate class", "committedDate": "2020-02-21T16:16:28Z", "type": "commit"}, {"oid": "21169994fdac37ab56d34883c4d6e9726604e6c2", "url": "https://github.com/elastic/apm-agent-java/commit/21169994fdac37ab56d34883c4d6e9726604e6c2", "message": "use junit DisplayName for better test naming", "committedDate": "2020-02-24T09:26:33Z", "type": "commit"}, {"oid": "161befdd9359221234e5893f55c0d92e9c9b01a0", "url": "https://github.com/elastic/apm-agent-java/commit/161befdd9359221234e5893f55c0d92e9c9b01a0", "message": "junit5 test name generator is great !", "committedDate": "2020-02-24T10:25:54Z", "type": "commit"}, {"oid": "69eba6485341f3d867d50b6ffac0f24c30094a3a", "url": "https://github.com/elastic/apm-agent-java/commit/69eba6485341f3d867d50b6ffac0f24c30094a3a", "message": "terminate root transaction before assert", "committedDate": "2020-02-24T10:36:46Z", "type": "commit"}, {"oid": "362cb712a2475c850f3de5c8bcc77652dc3bbe97", "url": "https://github.com/elastic/apm-agent-java/commit/362cb712a2475c850f3de5c8bcc77652dc3bbe97", "message": "add test for grpc 1.6.1", "committedDate": "2020-02-24T12:42:14Z", "type": "commit"}, {"oid": "cf8c9913571ebad757e78b6aef1cb8649617812f", "url": "https://github.com/elastic/apm-agent-java/commit/cf8c9913571ebad757e78b6aef1cb8649617812f", "message": "remove intermediate test versions", "committedDate": "2020-02-24T12:47:16Z", "type": "commit"}, {"oid": "87507529191a5305085d4755ea1d82fa2beefe0b", "url": "https://github.com/elastic/apm-agent-java/commit/87507529191a5305085d4755ea1d82fa2beefe0b", "message": "trying to make test less flaky", "committedDate": "2020-02-24T13:53:48Z", "type": "commit"}, {"oid": "2a9e6de3ef2b2e53b30cd6729621776cfba37fb7", "url": "https://github.com/elastic/apm-agent-java/commit/2a9e6de3ef2b2e53b30cd6729621776cfba37fb7", "message": "minor fixes after PR review", "committedDate": "2020-02-26T10:12:05Z", "type": "commit"}, {"oid": "459227e6600e9b14b26e73bb6d1723feacdc85b1", "url": "https://github.com/elastic/apm-agent-java/commit/459227e6600e9b14b26e73bb6d1723feacdc85b1", "message": "fix broken header read/write", "committedDate": "2020-02-27T09:22:40Z", "type": "commit"}, {"oid": "5318862404ff351935b29479eea3099b5ef85499", "url": "https://github.com/elastic/apm-agent-java/commit/5318862404ff351935b29479eea3099b5ef85499", "message": "anticipate that startTransaction might return null", "committedDate": "2020-02-27T17:48:39Z", "type": "commit"}, {"oid": "108277a06617aa044cedc19c1de2c6c5b0a91734", "url": "https://github.com/elastic/apm-agent-java/commit/108277a06617aa044cedc19c1de2c6c5b0a91734", "message": "add client streaming on test app", "committedDate": "2020-02-28T17:43:23Z", "type": "commit"}, {"oid": "732bd5318ec1a07aca36ed25f4d1dc3e7993f8ed", "url": "https://github.com/elastic/apm-agent-java/commit/732bd5318ec1a07aca36ed25f4d1dc3e7993f8ed", "message": "ensure client streaming calls not instrumented", "committedDate": "2020-02-28T17:52:50Z", "type": "commit"}, {"oid": "5ca6f12f29b3fea36d46477b8d9d0d3da20e257a", "url": "https://github.com/elastic/apm-agent-java/commit/5ca6f12f29b3fea36d46477b8d9d0d3da20e257a", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into add-grpc-plugin", "committedDate": "2020-03-02T08:33:04Z", "type": "commit"}, {"oid": "bc981b40caca025b09938a2e0b39d3f5ec96b994", "url": "https://github.com/elastic/apm-agent-java/commit/bc981b40caca025b09938a2e0b39d3f5ec96b994", "message": "add bidi + make test failures consistent\n\nYes, failure is an achievement here :-)", "committedDate": "2020-03-03T14:18:27Z", "type": "commit"}, {"oid": "f03416df950e4d44586e079d9b03d171d76ea860", "url": "https://github.com/elastic/apm-agent-java/commit/f03416df950e4d44586e079d9b03d171d76ea860", "message": "ignore non-unary method calls client-side", "committedDate": "2020-03-03T14:23:21Z", "type": "commit"}, {"oid": "e369905037ebcf15b262d3c12d03584bd997d4e1", "url": "https://github.com/elastic/apm-agent-java/commit/e369905037ebcf15b262d3c12d03584bd997d4e1", "message": "avoid non-unary method calls server-side for now", "committedDate": "2020-03-03T14:36:56Z", "type": "commit"}, {"oid": "ef7aa90849519685b85a3b431dabc99f6c6e1fb3", "url": "https://github.com/elastic/apm-agent-java/commit/ef7aa90849519685b85a3b431dabc99f6c6e1fb3", "message": "make async cancel test less flaky", "committedDate": "2020-03-04T11:04:36Z", "type": "commit"}, {"oid": "2564b05f4d3eb0e5900fbe6df85717938d1e4d7d", "url": "https://github.com/elastic/apm-agent-java/commit/2564b05f4d3eb0e5900fbe6df85717938d1e4d7d", "message": "making another test less flaky", "committedDate": "2020-03-04T12:59:31Z", "type": "commit"}, {"oid": "e7652a02cba1e34fbad21478d561fe6927645327", "url": "https://github.com/elastic/apm-agent-java/commit/e7652a02cba1e34fbad21478d561fe6927645327", "message": "Merge branch 'master' into add-grpc-plugin", "committedDate": "2020-03-04T13:18:47Z", "type": "commit"}, {"oid": "e573d18dc583c943683037bb754708a886e8d0ed", "url": "https://github.com/elastic/apm-agent-java/commit/e573d18dc583c943683037bb754708a886e8d0ed", "message": "update changelog", "committedDate": "2020-03-04T13:23:32Z", "type": "commit"}, {"oid": "65ed58364ca517648af95b362681ab7c10a6cd11", "url": "https://github.com/elastic/apm-agent-java/commit/65ed58364ca517648af95b362681ab7c10a6cd11", "message": "Restore unreleased 1.15.0 section ID in CHANGELOG", "committedDate": "2020-03-08T06:38:58Z", "type": "commit"}, {"oid": "b34c197b5c55c2eeb9778928073cac39027aa014", "url": "https://github.com/elastic/apm-agent-java/commit/b34c197b5c55c2eeb9778928073cac39027aa014", "message": "Restore protected access to objectPoolFactory", "committedDate": "2020-03-08T06:40:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MTQyMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1019#discussion_r389341421", "bodyText": "I restored protected access, as it failed compilation", "author": "eyalkoren", "createdAt": "2020-03-08T06:56:25Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/AbstractInstrumentationTest.java", "diffHunk": "@@ -47,8 +47,7 @@\n     protected static ElasticApmTracer tracer;\n     protected static MockReporter reporter;\n     protected static ConfigurationRegistry config;\n-\n-    private static TestObjectPoolFactory objectPoolFactory;\n+    protected static TestObjectPoolFactory objectPoolFactory;", "originalCommit": "b34c197b5c55c2eeb9778928073cac39027aa014", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c5e52afb4e390eb8091eedd4ccca75f5647e8c3b", "url": "https://github.com/elastic/apm-agent-java/commit/c5e52afb4e390eb8091eedd4ccca75f5647e8c3b", "message": "Merge branch 'master' into add-grpc-plugin", "committedDate": "2020-03-10T13:59:54Z", "type": "commit"}, {"oid": "8a9c6dc02b9fd738d56252a9d4bdb0d18d477d13", "url": "https://github.com/elastic/apm-agent-java/commit/8a9c6dc02b9fd738d56252a9d4bdb0d18d477d13", "message": "reset paused tracer after test execution\n\nWhen a test pauses tracer, we need to avoid side effects on other tests.\nMost of them assume tracer is not paused when starting state.", "committedDate": "2020-03-10T14:49:37Z", "type": "commit"}, {"oid": "3e382e4aacd9f130d70b0af4fe315b6d92d76825", "url": "https://github.com/elastic/apm-agent-java/commit/3e382e4aacd9f130d70b0af4fe315b6d92d76825", "message": "do not override start timestamp", "committedDate": "2020-03-13T15:02:19Z", "type": "commit"}]}