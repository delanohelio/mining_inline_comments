{"pr_number": 54909, "pr_title": "ILM use Priority.IMMEDIATE for stop ILM cluster update", "pr_createdAt": "2020-04-07T17:08:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54909", "timeline": [{"oid": "1dc18a639c06160098d6f90c21c3cd36230320b3", "url": "https://github.com/elastic/elasticsearch/commit/1dc18a639c06160098d6f90c21c3cd36230320b3", "message": "ILM use Priority.URGENT for stop ILM cluster update\n\nThis changes the priority of the cluster state update that stops ILM\naltogether to `URGENT`. We've chosen to change this as it can be useful to\ntemporarily stop ILM if a cluster is overwhelemed, but a `NORMAL`\npriority can see the \"stop ilm update\" not make it up the tasks queue.\n\nOn the same note, we're keeping the `start ILM` cluster update priority\nto `NORMAL` on purpose such that we only start `ILM` if the cluster can\nhandle it.", "committedDate": "2020-04-07T17:06:42Z", "type": "commit"}, {"oid": "6d6aadefd74d1dacbc08ff6ee629eaeee911dd60", "url": "https://github.com/elastic/elasticsearch/commit/6d6aadefd74d1dacbc08ff6ee629eaeee911dd60", "message": "Merge branch 'master' into stop-ilm-cluster-update-priority", "committedDate": "2020-04-07T17:08:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3NzY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54909#discussion_r404977697", "bodyText": "This also needs to change the cluster state update on line 366 of IndexLifecycleService (submitOperationModeUpdate), that is the second half that moves the state from STOPPING -> STOPPED", "author": "dakrone", "createdAt": "2020-04-07T17:15:07Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/action/TransportStopILMAction.java", "diffHunk": "@@ -50,7 +51,8 @@ protected AcknowledgedResponse read(StreamInput in) throws IOException {\n     @Override\n     protected void masterOperation(Task task, StopILMRequest request, ClusterState state, ActionListener<AcknowledgedResponse> listener) {\n         clusterService.submitStateUpdateTask(\"ilm_operation_mode_update\",\n-                new AckedClusterStateUpdateTask<AcknowledgedResponse>(request, listener) {\n+                new AckedClusterStateUpdateTask<AcknowledgedResponse>(Priority.URGENT, request, listener) {", "originalCommit": "6d6aadefd74d1dacbc08ff6ee629eaeee911dd60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1OTk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54909#discussion_r405359985", "bodyText": "Ah yes, good shout", "author": "andreidan", "createdAt": "2020-04-08T08:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3NzY5Nw=="}], "type": "inlineReview"}, {"oid": "791e6027bf58d71ac3853efd4279812362f876bb", "url": "https://github.com/elastic/elasticsearch/commit/791e6027bf58d71ac3853efd4279812362f876bb", "message": "ILM Make STOPPED cluster updates URGENT", "committedDate": "2020-04-08T08:49:40Z", "type": "commit"}, {"oid": "fc6c65fd2ca28cba962c83c95ff6c2abeb203a8c", "url": "https://github.com/elastic/elasticsearch/commit/fc6c65fd2ca28cba962c83c95ff6c2abeb203a8c", "message": "Fix tests", "committedDate": "2020-04-08T09:30:06Z", "type": "commit"}, {"oid": "04b08eb5f8dfafd14c2ebb9e8997a175152d6146", "url": "https://github.com/elastic/elasticsearch/commit/04b08eb5f8dfafd14c2ebb9e8997a175152d6146", "message": "Make stop ILM updates run at IMMEDIATE priority", "committedDate": "2020-04-08T12:03:39Z", "type": "commit"}]}