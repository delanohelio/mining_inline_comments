{"pr_number": 62173, "pr_title": "Improve Snapshot Abort Efficiency", "pr_createdAt": "2020-09-09T15:01:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62173", "timeline": [{"oid": "2b4a6a70f040ef1b9e441abaafb7d20e6f77c075", "url": "https://github.com/elastic/elasticsearch/commit/2b4a6a70f040ef1b9e441abaafb7d20e6f77c075", "message": "Improve Snapshot Abort Efficiency\n\nThere is no need to let snapshots that haven't yet written anything to the repo\nfinalize with `FAILED`. When we still had the `INIT` state we would also just remove\nthese snapshots from the state without any further action.\n\nThis is not just a theoretical optimization. Currently, the situation of having a lot of\nqueued up snapshots is fairly complicated to resolve when all the queued shards move to aborted\nsince it is now necessary to execute tasks on the `SNAPSHOT` pool (that might be very busy) to\nremove the snapshot from the CS (including a number of redundant CS updates and repo writes\nfor finalizing these snapshots before deleting them right away after).", "committedDate": "2020-09-09T14:56:39Z", "type": "commit"}, {"oid": "28a82720ad91ff8c22f15ed4c19e2e8b0c17d1de", "url": "https://github.com/elastic/elasticsearch/commit/28a82720ad91ff8c22f15ed4c19e2e8b0c17d1de", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io", "committedDate": "2020-09-13T20:55:11Z", "type": "commit"}, {"oid": "5eee2692a0dcf0950111cf49661c8cff67208c91", "url": "https://github.com/elastic/elasticsearch/commit/5eee2692a0dcf0950111cf49661c8cff67208c91", "message": "shorter and faster", "committedDate": "2020-09-13T21:43:24Z", "type": "commit"}, {"oid": "272e4aa73fd32b5b2dd5d090bec1afa6990f0132", "url": "https://github.com/elastic/elasticsearch/commit/272e4aa73fd32b5b2dd5d090bec1afa6990f0132", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io", "committedDate": "2020-09-14T08:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgyMzY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/62173#discussion_r487823648", "bodyText": "typos", "author": "tlrx", "createdAt": "2020-09-14T10:54:39Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1141,7 +1142,13 @@ public void deleteSnapshots(final DeleteSnapshotRequest request, final ActionLis\n \n             private boolean reusedExistingDelete = false;\n \n-            private final Collection<SnapshotsInProgress.Entry> completedSnapshots = new ArrayList<>();\n+            // Snapshots that had all of their shard snapshots in queued state and thus were removed from the\n+            // cluster state right away\n+            private final Collection<Snapshot> completedNoCleanup = new ArrayList<>();\n+\n+            // Snapshots that were aborted and that already wrote data to the repository and now have to be deleted\n+            // from teh repository after the clsuter state update", "originalCommit": "272e4aa73fd32b5b2dd5d090bec1afa6990f0132", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "162adc8b6c51e6866827117b5fc7603d60e588eb", "url": "https://github.com/elastic/elasticsearch/commit/162adc8b6c51e6866827117b5fc7603d60e588eb", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io", "committedDate": "2020-09-14T11:23:36Z", "type": "commit"}, {"oid": "372394c3e473a7898d40216439d10ccf30e051ad", "url": "https://github.com/elastic/elasticsearch/commit/372394c3e473a7898d40216439d10ccf30e051ad", "message": "CR: typos", "committedDate": "2020-09-14T11:24:44Z", "type": "commit"}]}