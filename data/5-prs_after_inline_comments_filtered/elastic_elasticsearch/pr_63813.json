{"pr_number": 63813, "pr_title": "[ML] Extract dependent variable's mapping correctly in case of a multi-field", "pr_createdAt": "2020-10-16T14:55:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63813", "timeline": [{"oid": "c04c4bd8163694fd7e8327b5aad5e640d0a62834", "url": "https://github.com/elastic/elasticsearch/commit/c04c4bd8163694fd7e8327b5aad5e640d0a62834", "message": "Extract dependent variable's mapping correctly in case of a multi-field", "committedDate": "2020-10-26T11:23:16Z", "type": "forcePushed"}, {"oid": "c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "url": "https://github.com/elastic/elasticsearch/commit/c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "message": "Extract dependent variable's mapping correctly in case of a multi-field", "committedDate": "2020-10-26T11:32:23Z", "type": "forcePushed"}, {"oid": "d71b5dd5ff4624bcbb48e1f20e200cf27283bc08", "url": "https://github.com/elastic/elasticsearch/commit/d71b5dd5ff4624bcbb48e1f20e200cf27283bc08", "message": "Extract dependent variable's mapping correctly in case of a multi-field", "committedDate": "2020-10-26T12:34:04Z", "type": "forcePushed"}, {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab", "url": "https://github.com/elastic/elasticsearch/commit/30f2edf3bffdedcece000b9bd8c89b15286165ab", "message": "Extract dependent variable's mapping correctly in case of a multi-field", "committedDate": "2020-10-26T12:41:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTI1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511931259", "bodyText": "I'm open to suggestions how this could be simplified.\nWe just want to fetch mapping by path. Should I be using FieldCapabilities API instead?", "author": "przemekwitek", "createdAt": "2020-10-26T12:44:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {", "originalCommit": "30f2edf3bffdedcece000b9bd8c89b15286165ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NDE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511954169", "bodyText": "We probably should use field capabilities.\nIt returns nice objects that are like:\n  \"data.foo.bar\" : {\n      \"double\" : {\n        \"type\" : \"double\",\n        \"searchable\" : true,\n        \"aggregatable\" : true,\n        \"indices\" : [\n          \"fake-foo-2\"\n        ]\n      },\n      \"long\" : {\n        \"type\" : \"long\",\n        \"searchable\" : true,\n        \"aggregatable\" : true,\n        \"indices\" : [\n          \"fake-foo\"\n        ]\n      }\n    },\n\nWhere data.foo.bar would be this path variable.\nHere is another example:\nPUT complicated\n{\n  \"mappings\": {\n    \"properties\": {\n      \"foo\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"sub_foo\": {\n          \"type\": \"keyword\"\n          }\n        }\n      },\n      \"bar\": {\n        \"properties\": {\n          \"baz\": {\n            \"type\": \"long\"\n          }\n        }\n      }\n    }\n  }\n}\n\nReturns the following in the field caps:\n{\n  \"indices\" : [\n    \"complicated\"\n  ],\n  \"fields\" : {\n    \"foo.sub_foo\" : {\n      \"keyword\" : {\n        \"type\" : \"keyword\",\n        \"searchable\" : true,\n        \"aggregatable\" : true\n      }\n    },\n    \"bar.baz\" : {\n      \"long\" : {\n        \"type\" : \"long\",\n        \"searchable\" : true,\n        \"aggregatable\" : true\n      }\n    },\n    \"foo\" : {\n      \"text\" : {\n        \"type\" : \"text\",\n        \"searchable\" : true,\n        \"aggregatable\" : false\n      }\n    }\n    \"bar\" : {\n      \"object\" : {\n        \"type\" : \"object\",\n        \"searchable\" : false,\n        \"aggregatable\" : false\n      }\n    }\n  }\n}", "author": "benwtrent", "createdAt": "2020-10-26T13:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI0MjMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r513242338", "bodyText": "Done.", "author": "przemekwitek", "createdAt": "2020-10-28T07:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Mjk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511942943", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        if (currentAsMap.containsKey(\"properties\")) {\n          \n          \n            \n                            current = currentAsMap.get(\"properties\");\n          \n          \n            \n                            currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        } else if (currentAsMap.containsKey(\"fields\")) {\n          \n          \n            \n                            current = currentAsMap.get(\"fields\");\n          \n          \n            \n                            currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        } else {\n          \n          \n            \n                            return null;\n          \n          \n            \n                        }\n          \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        current = currentAsMap.get(\"properties\");\n          \n          \n            \n                        if (current == null) {\n          \n          \n            \n                            current = currentAsMap.get(\"fields\");\n          \n          \n            \n                        }\n          \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n      \n    \n    \n  \n\nYou do a null check at the start of the loop. So, use that as your loop exit. Seems like only one branch is needed here.", "author": "benwtrent", "createdAt": "2020-10-26T13:04:57Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n+        if (path.isEmpty()) {\n+            return mappingsProperties;\n+        }\n+        Object current = mappingsProperties;\n+        Map<String, Object> currentAsMap = mappingsProperties;\n+        String[] pathParts = path.split(\"\\\\.\");\n+        for (int i = 0; i < pathParts.length; ++i) {\n+            if (current == null) {\n+                return null;\n+            }\n+            String pathPart = pathParts[i];\n+            if (currentAsMap.containsKey(pathPart) == false) {\n+                return null;\n+            }\n+            current = currentAsMap.get(pathPart);\n+            if (i == pathParts.length - 1) {\n+                break;\n+            }\n+            currentAsMap = (Map<String, Object>) current;\n+            if (currentAsMap.containsKey(\"properties\")) {\n+                current = currentAsMap.get(\"properties\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else if (currentAsMap.containsKey(\"fields\")) {\n+                current = currentAsMap.get(\"fields\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else {\n+                return null;\n+            }", "originalCommit": "30f2edf3bffdedcece000b9bd8c89b15286165ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTM0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511945343", "bodyText": "Also, casting null ends up as null. So that should still be ok.", "author": "benwtrent", "createdAt": "2020-10-26T13:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Mjk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU0ODE1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r512548153", "bodyText": "Thanks for the suggestion. I removed the mappings fetching code anyway as I use field caps now.", "author": "przemekwitek", "createdAt": "2020-10-27T09:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Mjk0Mw=="}], "type": "inlineReview"}, {"oid": "5431ce86182def18dfde87e97dff02e8bc943623", "url": "https://github.com/elastic/elasticsearch/commit/5431ce86182def18dfde87e97dff02e8bc943623", "message": "Extract dependent variable's mapping correctly in case of a multi-field", "committedDate": "2020-10-28T06:19:14Z", "type": "commit"}, {"oid": "ca79f72e5c67936fff537df807d906b3858a4738", "url": "https://github.com/elastic/elasticsearch/commit/ca79f72e5c67936fff537df807d906b3858a4738", "message": "Use FieldCapabilitiesAction to fetch dependent type mapping", "committedDate": "2020-10-28T07:57:07Z", "type": "commit"}, {"oid": "ca79f72e5c67936fff537df807d906b3858a4738", "url": "https://github.com/elastic/elasticsearch/commit/ca79f72e5c67936fff537df807d906b3858a4738", "message": "Use FieldCapabilitiesAction to fetch dependent type mapping", "committedDate": "2020-10-28T07:57:07Z", "type": "forcePushed"}, {"oid": "54b23e3230c37424259fa83acfe057193ad4e888", "url": "https://github.com/elastic/elasticsearch/commit/54b23e3230c37424259fa83acfe057193ad4e888", "message": "Fix DestinationIndexTests", "committedDate": "2020-10-28T10:54:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3NjgzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r513476836", "bodyText": "@przemekwitek  FieldCapabilitiesResponse is nullable. You need to do a null check here.", "author": "benwtrent", "createdAt": "2020-10-28T14:13:51Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -374,28 +374,19 @@ public boolean supportsCategoricalFields() {\n \n     @SuppressWarnings(\"unchecked\")\n     @Override\n-    public Map<String, Object> getExplicitlyMappedFields(Map<String, Object> mappingsProperties, String resultsFieldName) {\n+    public Map<String, Object> getExplicitlyMappedFields(String resultsFieldName, FieldCapabilitiesResponse fieldCapabilitiesResponse) {", "originalCommit": "54b23e3230c37424259fa83acfe057193ad4e888", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}