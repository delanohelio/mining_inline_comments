{"pr_number": 63161, "pr_title": "EQL: Make queries using Point-In-Time rely on index filtering", "pr_createdAt": "2020-10-02T08:29:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63161", "timeline": [{"oid": "9040ff4b3669d95a523bad7c21d08b6efcee95a3", "url": "https://github.com/elastic/elasticsearch/commit/9040ff4b3669d95a523bad7c21d08b6efcee95a3", "message": "EQL: Make queries using Point-In-Time rely on index filtering\n\nPoint-In-Time queries cannot be ran on individual indices but on all.\nThus all PIT queries move their index from the request level to a filter\nso this condition is fulfilled while keeping the query scoped\naccordingly.\n\nFix #63132", "committedDate": "2020-10-02T07:55:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMDI4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63161#discussion_r498730288", "bodyText": "I think IndexFieldMapper can't yet query against data streams. So if a data stream is provided as indices then that will correct always yield no results.\nI think the SearchIndexNameMatcher class needs to be modified in order to take into account data streams. The\nmatchesIndex() method should invoke the overloaded version of concreteIndexNames() method that accepts includeDataStreams parameter and provide true.", "author": "martijnvg", "createdAt": "2020-10-02T10:02:41Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -91,6 +97,23 @@ private void searchWithPIT(MultiSearchRequest search, ActionListener<MultiSearch\n         }, listener));\n     }\n \n+    private void makeRequestPITCompatible(SearchRequest request) {\n+        SearchSourceBuilder source = request.source();\n+        // don't increase the keep alive\n+        source.pointInTimeBuilder(new PointInTimeBuilder(pitId));\n+        // move the indices from the search request to a index filter - see #63132\n+        String[] indices = request.indices();\n+        if (CollectionUtils.isEmpty(indices) == false) {\n+            request.indices(Strings.EMPTY_ARRAY);\n+            BoolQueryBuilder indexFilter = boolQuery().filter(termsQuery(GetResult._INDEX, indices));", "originalCommit": "9040ff4b3669d95a523bad7c21d08b6efcee95a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczNzUzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63161#discussion_r498737538", "bodyText": "Should I fix that in a separate change? I think a dedicated test for this should exists as well.", "author": "martijnvg", "createdAt": "2020-10-02T10:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczOTQ4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63161#discussion_r498739487", "bodyText": "+1", "author": "jimczi", "createdAt": "2020-10-02T10:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczOTU5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63161#discussion_r498739597", "bodyText": "Thanks for looking @martijnvg", "author": "jimczi", "createdAt": "2020-10-02T10:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMDI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0NTEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63161#discussion_r498745101", "bodyText": "I've opened: #63170", "author": "martijnvg", "createdAt": "2020-10-02T10:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMDI4OA=="}], "type": "inlineReview"}, {"oid": "3073415e33cd7115409c9e106bd005e3d5ece28b", "url": "https://github.com/elastic/elasticsearch/commit/3073415e33cd7115409c9e106bd005e3d5ece28b", "message": "Merge branch 'master' into fix/63132", "committedDate": "2020-10-05T08:03:06Z", "type": "commit"}]}