{"pr_number": 61430, "pr_title": "Pass SearchLookup supplier through to fielddataBuilder", "pr_createdAt": "2020-08-21T16:08:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61430", "timeline": [{"oid": "835a65d9ae2e5a89151793e1c948359fd19acea9", "url": "https://github.com/elastic/elasticsearch/commit/835a65d9ae2e5a89151793e1c948359fd19acea9", "message": "Pass a SearchLookup supplier through to fielddataBuilder (#60224)\n\nRuntime fields look up other fields through `SearchLookup`. With this change we add a `Supplier<SearchLookup>` argument to the existing `MappedFieldType#fielddataBuilder` method so that fielddata implementations can have `SearchLookup` available when needed.\n\nNote that this commit does not introduce any production implementation of runtime fields, but rather the plumbing needed to then merge the feature branch where runtime fields have been developed.\n\nAdditionally the use of runtime fields in index sorting is disallowed.\n\nRelates to #59332", "committedDate": "2020-08-20T11:54:26Z", "type": "commit"}, {"oid": "11f73efff96dbcb994d6cc7e325d1f2a967610da", "url": "https://github.com/elastic/elasticsearch/commit/11f73efff96dbcb994d6cc7e325d1f2a967610da", "message": "add test", "committedDate": "2020-08-20T12:42:21Z", "type": "commit"}, {"oid": "caf8ecd34e775541e6e00cf85363d7b30bf52520", "url": "https://github.com/elastic/elasticsearch/commit/caf8ecd34e775541e6e00cf85363d7b30bf52520", "message": "typo", "committedDate": "2020-08-21T08:41:32Z", "type": "commit"}, {"oid": "09c2ed9130ae7f997ed6638ecafb1d8b7c5ff26f", "url": "https://github.com/elastic/elasticsearch/commit/09c2ed9130ae7f997ed6638ecafb1d8b7c5ff26f", "message": "Add support for tracking cyclic field references\n\nThis is needed for scripted runtime fields, as they allow to refer to other runtime fields.\n\nAlso reject resolving fields that depend on a defined limit, which is deterined at 32.", "committedDate": "2020-08-21T15:37:44Z", "type": "commit"}, {"oid": "864637915efd81a4250f74874414540275558bfa", "url": "https://github.com/elastic/elasticsearch/commit/864637915efd81a4250f74874414540275558bfa", "message": "trim down field data service tests", "committedDate": "2020-08-21T15:55:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MzE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r474793171", "bodyText": "This was not strictly required in this PR, though it came natural as I added isRuntimeField to MappedFieldType. and configuring index sorting on runtime fields looked like a bad idea to me.", "author": "javanna", "createdAt": "2020-08-21T16:10:38Z", "path": "server/src/main/java/org/elasticsearch/index/IndexSortConfig.java", "diffHunk": "@@ -192,7 +195,7 @@ public Sort buildIndexSort(Function<String, MappedFieldType> fieldTypeLookup,\n             try {\n                 fieldData = fieldDataLookup.apply(ft);\n             } catch (Exception e) {\n-                throw new IllegalArgumentException(\"docvalues not found for index sort field:[\" + sortSpec.field + \"]\");\n+                throw new IllegalArgumentException(\"docvalues not found for index sort field:[\" + sortSpec.field + \"]\", e);", "originalCommit": "09c2ed9130ae7f997ed6638ecafb1d8b7c5ff26f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MzY4NA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r474793684", "bodyText": "this is the main reason why I introduced isRuntimeField as part of this PR. I want to enforce that this method is never called for runtime fields. That is the case today, this is only used for index warmers and index sorting, but we need to make sure that that is still the case in the future.", "author": "javanna", "createdAt": "2020-08-21T16:11:44Z", "path": "server/src/main/java/org/elasticsearch/index/fielddata/IndexFieldDataService.java", "diffHunk": "@@ -106,14 +108,27 @@ public synchronized void clearField(final String fieldName) {\n         ExceptionsHelper.maybeThrowRuntimeAndSuppress(exceptions);\n     }\n \n+    /**\n+     * Returns fielddata for the provided field type. Same as {@link #getForField(MappedFieldType, String, Supplier)} but does not take\n+     * the index name and the search lookup supplier as arguments. Does not support runtime fields.\n+     */\n     public <IFD extends IndexFieldData<?>> IFD getForField(MappedFieldType fieldType) {\n-        return getForField(fieldType, index().getName());\n+        assert fieldType.isRuntimeField() == false : \"runtime fields are not supported\";", "originalCommit": "09c2ed9130ae7f997ed6638ecafb1d8b7c5ff26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNDc3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475704773", "bodyText": "I am not sure this is needed, index sort will check that the field has doc values so it will fail at the Lucene level. I am not saying we shouldn't check at the ES level but this assert  is confusing IMO. Can we remove this function entirely and replace it with the one below ?", "author": "jimczi", "createdAt": "2020-08-24T15:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MzY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzMTM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475831363", "bodyText": "correct, this is to have a proper error message. But what I am after here is to protect from this method being a second getForField which though can't support runtime fields (we have no search lookup!). It is so easy to use this one instead of the other one. Maybe renaming both would also help.\n\nCan we remove this function entirely and replace it with the one below?\n\nyou mean having a single getForField method I assume? That would be great but I am not sure where to get search lookup for this usecase that does not need it and it's only used for index warmers and index sorting.", "author": "javanna", "createdAt": "2020-08-24T19:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MzY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4OTYyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r477389626", "bodyText": "I removed the getForField(MappedFieldType). Callers now call the other getForField and provide their own search lookup supplier and index name. That removed the need for the isRuntimeField flag too. index sorting already throws a decent error when it is configured with a runtime field (doc values not found for field etc.). I am happier with this as it simplifies things.", "author": "javanna", "createdAt": "2020-08-26T15:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5NTM1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r474795352", "bodyText": "@nik9000 this is very similar to what you had in #60318 ( I will give you credit in the final commit). The main difference is that I don't recreate a SearchLookup and DocLookup every time a new field is referenced. I rather fork SearchLookup once a field is looked up and keep on reusing the same and adding field names to that same list. I find it more intuitive this way. I guess you may have a different opinion. I also tried to enclose the tracking in the lookup function. All of the other changes turned out the same as what you made, although I started from scratch to see where I ended up :)", "author": "javanna", "createdAt": "2020-08-21T16:14:58Z", "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -54,4 +94,20 @@ public DocLookup doc() {\n     public SourceLookup source() {\n         return sourceLookup;\n     }\n+\n+    private static Function<MappedFieldType, IndexFieldData<?>> wrapAndTrackFieldReferences(String field,\n+            Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n+        final Set<String> fields = new LinkedHashSet<>();\n+        fields.add(field);\n+        return fieldType -> {\n+            if (fields.add(fieldType.name()) == false) {\n+                String message = String.join(\" -> \", fields) + \" -> \" + fieldType.name();\n+                throw new IllegalArgumentException(\"Cyclic dependency detected while resolving runtime fields: \" + message);\n+            }\n+            if (fields.size() > MAX_FIELD_CHAIN) {\n+                throw new IllegalArgumentException(\"Field requires resolving too many dependent fields: \" + String.join(\" -> \", fields));\n+            }\n+            return fieldDataLookup.apply(fieldType);\n+        };\n+    }", "originalCommit": "09c2ed9130ae7f997ed6638ecafb1d8b7c5ff26f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MDM5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475780391", "bodyText": "If a field depends on many fields but doesn't have a \"chain\" of dependencies will this trigger? Is that what we want? Maybe it is, but I think a limit of 5 is pretty low in that case. Maybe fine, but I dunno.", "author": "nik9000", "createdAt": "2020-08-24T17:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5NTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI4MjE4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r477282185", "bodyText": "great point, it was a bug in my implementation, I don't think it should trigger without a chain. We may want to have a limit later also on number of direct dependencies for a single field, but not now. That should also make the 5 limit reasonable, as it is applied only as depth (also renamed the constant to clarify that).", "author": "javanna", "createdAt": "2020-08-26T13:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5NTM1Mg=="}], "type": "inlineReview"}, {"oid": "437e6f00c0ac6398367c618c35c78dfe3d3d63ee", "url": "https://github.com/elastic/elasticsearch/commit/437e6f00c0ac6398367c618c35c78dfe3d3d63ee", "message": "shorten test", "committedDate": "2020-08-21T16:17:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ0OTk3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475449973", "bodyText": "32 feels big to me ;). I think we can be more aggressive here, something like 4-5 should be more than enough ?", "author": "jimczi", "createdAt": "2020-08-24T09:10:38Z", "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -24,20 +24,60 @@\n import org.elasticsearch.index.mapper.MappedFieldType;\n import org.elasticsearch.index.mapper.MapperService;\n \n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+import java.util.function.BiFunction;\n import java.util.function.Function;\n+import java.util.function.Supplier;\n \n public class SearchLookup {\n \n-    final DocLookup docMap;\n+    private static final int MAX_FIELD_CHAIN = 32;", "originalCommit": "437e6f00c0ac6398367c618c35c78dfe3d3d63ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NDE4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475454183", "bodyText": "fine with me, I totally expected some discussion on this limit. maybe 4-5 is a bit on the low side, shall we do 10? :)", "author": "javanna", "createdAt": "2020-08-24T09:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ0OTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ2NzQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475467478", "bodyText": "I am maybe be too cautious here but I cannot think of a good example of a chain that would require more than 2-3 indirections. Allowing for more looks like an anti-pattern to me.", "author": "jimczi", "createdAt": "2020-08-24T09:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ0OTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3NzgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475477814", "bodyText": "being cautious is not a bad idea, let's start with 5 then and see if users complain.", "author": "javanna", "createdAt": "2020-08-24T09:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ0OTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MjM4NA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475452384", "bodyText": "I wonder if this is the right way to do since we may forgot to override this function where needed ?\nCould we instead rely on some inheritance, runtime field type must extend a specific class to be considered runtime ?", "author": "jimczi", "createdAt": "2020-08-24T09:14:56Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -83,15 +85,22 @@ public MappedFieldType(String name, boolean isIndexed, boolean hasDocValues, Tex\n      * Return a fielddata builder for this field\n      *\n      * @param fullyQualifiedIndexName the name of the index this field-data is build for\n-     *\n+     * @param searchLookup a {@link SearchLookup} supplier to allow for accessing other fields values in the context of runtime fields\n      * @throws IllegalArgumentException if the fielddata is not supported on this type.\n      * An IllegalArgumentException is needed in order to return an http error 400\n      * when this error occurs in a request. see: {@link org.elasticsearch.ExceptionsHelper#status}\n      */\n-    public IndexFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName) {\n+    public IndexFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n         throw new IllegalArgumentException(\"Fielddata is not supported on field [\" + name() + \"] of type [\" + typeName() + \"]\");\n     }\n \n+    /**\n+     * Return true for field types that are runtime fields implementation, false otherwise\n+     */\n+    public boolean isRuntimeField() {", "originalCommit": "437e6f00c0ac6398367c618c35c78dfe3d3d63ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NTA2NA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475455064", "bodyText": "The idea is that runtime fields will have a common base class that overrides this method. This method is basically here to prevent having to perform instanceof checks to figure out whether something is a runtime field.", "author": "javanna", "createdAt": "2020-08-24T09:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1ODMyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475458329", "bodyText": "ok fine with me if we have a long-term solution in the main PR", "author": "jimczi", "createdAt": "2020-08-24T09:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MjM4NA=="}], "type": "inlineReview"}, {"oid": "3c7fe453e84de221a20075bbf2f7272fc5a94743", "url": "https://github.com/elastic/elasticsearch/commit/3c7fe453e84de221a20075bbf2f7272fc5a94743", "message": "lower max field chain limit to 5", "committedDate": "2020-08-24T15:26:08Z", "type": "commit"}, {"oid": "063fe1ac17e8deb1f34ae277f48af4ae743955fa", "url": "https://github.com/elastic/elasticsearch/commit/063fe1ac17e8deb1f34ae277f48af4ae743955fa", "message": "lower max field chain limit to 5 for real", "committedDate": "2020-08-24T15:27:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NzcxNg==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475777716", "bodyText": "Shadowing the lookup name here makes this harder to read. I probably had this on my version of the PR too, but could you rename lookup to l or something?", "author": "nik9000", "createdAt": "2020-08-24T17:25:40Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -290,8 +292,9 @@ MappedFieldType failIfFieldMappingNotFound(String name, MappedFieldType fieldMap\n \n     public SearchLookup lookup() {\n         if (lookup == null) {\n-            lookup = new SearchLookup(getMapperService(),\n-                    mappedFieldType -> indexFieldDataService.apply(mappedFieldType, fullyQualifiedIndex.getName()));\n+            lookup = new SearchLookup(\n+                getMapperService(),\n+                (fieldType, lookup) -> indexFieldDataService.apply(fieldType, fullyQualifiedIndex.getName(), lookup));", "originalCommit": "063fe1ac17e8deb1f34ae277f48af4ae743955fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzMzc5NA==", "url": "https://github.com/elastic/elasticsearch/pull/61430#discussion_r475833794", "bodyText": "makes sense", "author": "javanna", "createdAt": "2020-08-24T19:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc3NzcxNg=="}], "type": "inlineReview"}, {"oid": "9608906c8a18799cd0d3d6e0d6a10750ba2ea049", "url": "https://github.com/elastic/elasticsearch/commit/9608906c8a18799cd0d3d6e0d6a10750ba2ea049", "message": "review comments", "committedDate": "2020-08-26T12:56:34Z", "type": "commit"}, {"oid": "38c9fcfd8a9f0f23c3a12ec6b8292d3880d0f6a0", "url": "https://github.com/elastic/elasticsearch/commit/38c9fcfd8a9f0f23c3a12ec6b8292d3880d0f6a0", "message": "Merge branch 'master' into enhancement/search_lookup_fielddata_builder", "committedDate": "2020-08-26T13:04:11Z", "type": "commit"}, {"oid": "19c298b098852ceb9fc26ed58e2588519dcf5740", "url": "https://github.com/elastic/elasticsearch/commit/19c298b098852ceb9fc26ed58e2588519dcf5740", "message": "remove getForField(MappedFieldType)\n\nalso remove the notion of runtime field from mapped field type, it was needed only for index sorting, but it already throws a good error \"no doc values for field\" when trying to config index sorting on a runtime field. It needs no special handling.", "committedDate": "2020-08-26T15:24:29Z", "type": "commit"}]}