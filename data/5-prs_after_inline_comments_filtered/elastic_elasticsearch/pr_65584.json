{"pr_number": 65584, "pr_title": "[Transform] use ISO dates in output instead of epoch millis", "pr_createdAt": "2020-11-30T10:27:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65584", "timeline": [{"oid": "904854fabab38e8f727ab9892ead441b24ef16ad", "url": "https://github.com/elastic/elasticsearch/commit/904854fabab38e8f727ab9892ead441b24ef16ad", "message": "write dates in ISO format, provide backwards compatibility for old jobs and old behavior\n\nfixes #63787", "committedDate": "2020-11-30T11:49:47Z", "type": "commit"}, {"oid": "56a0ba54d5717dc745eb354290c8a5806e3ffd91", "url": "https://github.com/elastic/elasticsearch/commit/56a0ba54d5717dc745eb354290c8a5806e3ffd91", "message": "adapt rest tests", "committedDate": "2020-11-30T11:49:47Z", "type": "commit"}, {"oid": "56a0ba54d5717dc745eb354290c8a5806e3ffd91", "url": "https://github.com/elastic/elasticsearch/commit/56a0ba54d5717dc745eb354290c8a5806e3ffd91", "message": "adapt rest tests", "committedDate": "2020-11-30T11:49:47Z", "type": "forcePushed"}, {"oid": "49d683c4213d052785e975274fa3e8259755de3e", "url": "https://github.com/elastic/elasticsearch/commit/49d683c4213d052785e975274fa3e8259755de3e", "message": "improve doc strings", "committedDate": "2020-11-30T14:29:05Z", "type": "commit"}, {"oid": "a28309546717427d92822ae35d7ad76666daef28", "url": "https://github.com/elastic/elasticsearch/commit/a28309546717427d92822ae35d7ad76666daef28", "message": "document changes", "committedDate": "2020-11-30T15:19:20Z", "type": "commit"}, {"oid": "4e1ad7f4450bb29ffa502ca102348f09f0127195", "url": "https://github.com/elastic/elasticsearch/commit/4e1ad7f4450bb29ffa502ca102348f09f0127195", "message": "rename parameter to dates_as_epoch_millis", "committedDate": "2020-12-01T10:26:43Z", "type": "commit"}, {"oid": "2fd4c51b4cd8f689f32726f40fce19072c01b833", "url": "https://github.com/elastic/elasticsearch/commit/2fd4c51b4cd8f689f32726f40fce19072c01b833", "message": "fix leftover renamings", "committedDate": "2020-12-01T11:00:42Z", "type": "commit"}, {"oid": "a3a7646b652a5514729cf6852d1b4000860e6d65", "url": "https://github.com/elastic/elasticsearch/commit/a3a7646b652a5514729cf6852d1b4000860e6d65", "message": "fix test", "committedDate": "2020-12-01T11:02:48Z", "type": "commit"}, {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977", "url": "https://github.com/elastic/elasticsearch/commit/c3befde0a9a6b981e714d020503cf389b4fa9977", "message": "fix docs", "committedDate": "2020-12-01T11:10:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534014915", "bodyText": "Shouldn't it be plural here as well?", "author": "przemekwitek", "createdAt": "2020-12-02T09:25:32Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -64,6 +65,8 @@\n \n     private static final Map<String, BucketKeyExtractor> BUCKET_KEY_EXTRACTOR_MAP;\n     private static final BucketKeyExtractor DEFAULT_BUCKET_KEY_EXTRACTOR = new DefaultBucketKeyExtractor();\n+    private static final BucketKeyExtractor DATE_AS_EPOCH_BUCKET_KEY_EXTRACTOR = new DateAsEpochBucketKeyExtractor();", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzA0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534017046", "bodyText": "You use formatMillis here for formatting but in the line above you check that the type is DateFieldMapper.DATE_NANOS_CONTENT_TYPE.\nPlease double-check it works as expected in case of nanos.", "author": "przemekwitek", "createdAt": "2020-12-02T09:28:33Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {\n \n+        @Override\n+        public Object value(Object key, String type) {\n+            if (isNumericType(type) && key instanceof Double) {\n+                return dropFloatingPointComponentIfTypeRequiresIt(type, (Double) key);\n+            } else if ((DateFieldMapper.CONTENT_TYPE.equals(type) || DateFieldMapper.DATE_NANOS_CONTENT_TYPE.equals(type))\n+                && key instanceof Long) {\n+                    return DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.formatMillis((Long) key);", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0ODc1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r536048752", "bodyText": "\ud83d\udc4d checked, I will create a code comment", "author": "hendrikmuhs", "createdAt": "2020-12-04T11:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxODY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534018667", "bodyText": "Would this class benefit from unit tests or is the current coverage enough?", "author": "przemekwitek", "createdAt": "2020-12-02T09:30:51Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTY3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534019672", "bodyText": "datesAsEpochMillis?", "author": "przemekwitek", "createdAt": "2020-12-02T09:32:20Z", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMDg5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534020893", "bodyText": "Why is this the only test that does it? Wouldn't it be applicable for example for DateHistogramGroupByOtherTimeFieldIT.java as well?", "author": "przemekwitek", "createdAt": "2020-12-02T09:34:11Z", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;\n \n     public DateHistogramGroupByIT() {\n         missing = randomBoolean();\n+        dateAsEpochMillis = randomBoolean();", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023685", "bodyText": "Do you mean it to stay or was it just for debug?", "author": "przemekwitek", "createdAt": "2020-12-02T09:38:17Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -111,12 +149,19 @@ public boolean equals(Object other) {\n         }\n \n         SettingsConfig that = (SettingsConfig) other;\n-        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize) && Objects.equals(docsPerSecond, that.docsPerSecond);\n+        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize)\n+            && Objects.equals(docsPerSecond, that.docsPerSecond)\n+            && Objects.equals(datesAsEpochMillis, that.datesAsEpochMillis);\n     }\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(maxPageSearchSize, docsPerSecond);\n+        return Objects.hash(maxPageSearchSize, docsPerSecond, datesAsEpochMillis);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return Strings.toString(this, true, true) + \" wdaem: \" + this.datesAsEpochMillis;", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023797", "bodyText": "plural?", "author": "przemekwitek", "createdAt": "2020-12-02T09:38:25Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -126,13 +171,12 @@ public static SettingsConfig fromXContent(final XContentParser parser, boolean l\n     public static class Builder {\n         private Integer maxPageSearchSize;\n         private Float docsPerSecond;\n+        private Integer dateAsEpochMilli;", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534025284", "bodyText": "Is this deprecation related to handling dates?", "author": "przemekwitek", "createdAt": "2020-12-02T09:40:30Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -449,12 +449,17 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n         // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        if (transformConfig.getVersion() != null\n+            && transformConfig.getVersion().onOrAfter(Version.V_8_0_0) // todo: V_7_11_0\n+            && (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null)) {", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMjY2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534322663", "bodyText": "ok, the code comment is outdated, will change it. What this does is basically rewriting the config to the latest format. The problem is as follows, a transform <7.11 will write millis, 7.11> will write strings (note the version is the version of the transform, not the es version). If update is called, it always updates the version field, a former 7.6 transform becomes a 7.11 transform. But that would mean that this transform starts writing strings. That's why we inject the dates_as_epoch_millis into the config, so it still becomes a 7.11 transform config, but with dates_as_epoch_millis:true.", "author": "hendrikmuhs", "createdAt": "2020-12-02T16:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0OTUxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r536049519", "bodyText": "ok, the code comment is outdated, will change it", "author": "hendrikmuhs", "createdAt": "2020-12-04T12:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjQ5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026492", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "author": "przemekwitek", "createdAt": "2020-12-02T09:42:16Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -77,6 +82,15 @@ public void testExplicitNullOnWriteParser() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = fromString(\"{\\\"dates_as_epoch_millis\\\" : null}\");\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026726", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "author": "przemekwitek", "createdAt": "2020-12-02T09:42:38Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -100,6 +116,16 @@ public void testExplicitNullOnWriteBuilder() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = new SettingsConfig.Builder().setDatesAsEpochMilli(null).build();\n+        // returns null, however it's `null` as in \"use default\"\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "originalCommit": "c3befde0a9a6b981e714d020503cf389b4fa9977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f06088fafd308ff4af1ccf5446ed4b3d55c9f754", "url": "https://github.com/elastic/elasticsearch/commit/f06088fafd308ff4af1ccf5446ed4b3d55c9f754", "message": "address review comments", "committedDate": "2020-12-04T10:08:32Z", "type": "commit"}, {"oid": "d59abcda114a2c929a91abc4bdb169d01895e7bf", "url": "https://github.com/elastic/elasticsearch/commit/d59abcda114a2c929a91abc4bdb169d01895e7bf", "message": "add comment about date_nanos", "committedDate": "2020-12-04T11:59:44Z", "type": "commit"}, {"oid": "bc2575780304de3a6440bb968d36c462f4c20d08", "url": "https://github.com/elastic/elasticsearch/commit/bc2575780304de3a6440bb968d36c462f4c20d08", "message": "checkstyle", "committedDate": "2020-12-04T12:07:06Z", "type": "commit"}, {"oid": "54024270d67c479471833d116b3ce6f4efca4096", "url": "https://github.com/elastic/elasticsearch/commit/54024270d67c479471833d116b3ce6f4efca4096", "message": "add more tests", "committedDate": "2020-12-04T13:44:01Z", "type": "commit"}, {"oid": "2dd63bd9661126fc9cbb30a873c65229c2314242", "url": "https://github.com/elastic/elasticsearch/commit/2dd63bd9661126fc9cbb30a873c65229c2314242", "message": "Merge branch 'master' into transform-date-not-epoch", "committedDate": "2020-12-04T14:13:52Z", "type": "commit"}, {"oid": "ee7103a30599baed6505eb0a596f53eadbb10ff8", "url": "https://github.com/elastic/elasticsearch/commit/ee7103a30599baed6505eb0a596f53eadbb10ff8", "message": "fix order (alphabetical)", "committedDate": "2020-12-04T16:23:15Z", "type": "commit"}, {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "url": "https://github.com/elastic/elasticsearch/commit/113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "message": "fix parameter name and remove debug code", "committedDate": "2020-12-07T08:30:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MjUwNg==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537472506", "bodyText": "nit:  Could this constructor reuse the other one?\nthis(maxPageSearchSize, docsPerSecond, datesAsEpochMillis == null ? null : datesAsEpochMillis ? 1 : 0);\n\n?", "author": "przemekwitek", "createdAt": "2020-12-07T12:36:01Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -28,33 +31,54 @@\n \n     private static final int DEFAULT_MAX_PAGE_SEARCH_SIZE = -1;\n     private static final float DEFAULT_DOCS_PER_SECOND = -1F;\n+    private static final int DEFAULT_DATES_AS_EPOCH_MILLIS = -1;\n \n     private static ConstructingObjectParser<SettingsConfig, Void> createParser(boolean lenient) {\n         ConstructingObjectParser<SettingsConfig, Void> parser = new ConstructingObjectParser<>(\n             \"transform_config_settings\",\n             lenient,\n-            args -> new SettingsConfig((Integer) args[0], (Float) args[1])\n+            args -> new SettingsConfig((Integer) args[0], (Float) args[1], (Integer) args[2])\n         );\n         parser.declareIntOrNull(optionalConstructorArg(), DEFAULT_MAX_PAGE_SEARCH_SIZE, TransformField.MAX_PAGE_SEARCH_SIZE);\n         parser.declareFloatOrNull(optionalConstructorArg(), DEFAULT_DOCS_PER_SECOND, TransformField.DOCS_PER_SECOND);\n+        // this boolean requires 4 possible values: true, false, not_specified, default, therefore using a custom parser\n+        parser.declareField(\n+            optionalConstructorArg(),\n+            p -> p.currentToken() == XContentParser.Token.VALUE_NULL ? DEFAULT_DATES_AS_EPOCH_MILLIS : p.booleanValue() ? 1 : 0,\n+            TransformField.DATES_AS_EPOCH_MILLIS,\n+            ValueType.BOOLEAN_OR_NULL\n+        );\n         return parser;\n     }\n \n     private final Integer maxPageSearchSize;\n     private final Float docsPerSecond;\n+    private final Integer datesAsEpochMillis;\n \n     public SettingsConfig() {\n-        this(null, null);\n+        this(null, null, (Integer) null);\n     }\n \n-    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond) {\n+    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond, Boolean datesAsEpochMillis) {", "originalCommit": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NDUwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537474501", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // quick checks(optimization) if a rewrite is required, if none found just return the original\n          \n          \n            \n                    // quick checks (optimization) if a rewrite is required, if none found just return the original", "author": "przemekwitek", "createdAt": "2020-12-07T12:39:30Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -440,37 +440,63 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     }\n \n     /**\n-     * Rewrites the transform config according to the latest format, for example moving deprecated\n-     * settings to its new place.\n+     * Rewrites the transform config according to the latest format.\n+     *\n+     * Operations cover:\n+     *\n+     *  - move deprecated settings to its new place\n+     *  - change configuration options so it stays compatible (given a newer version)\n      *\n      * @param transformConfig original config\n      * @return a rewritten transform config if a rewrite was necessary, otherwise the given transformConfig\n      */\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n-        // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        // quick checks(optimization) if a rewrite is required, if none found just return the original", "originalCommit": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "23301ba7c02c70848fb818a7cf8cd7b6a0b763cb", "url": "https://github.com/elastic/elasticsearch/commit/23301ba7c02c70848fb818a7cf8cd7b6a0b763cb", "message": "apply review suggestion", "committedDate": "2020-12-07T12:47:24Z", "type": "commit"}]}