{"pr_number": 57337, "pr_title": "Delete expired data by job", "pr_createdAt": "2020-05-29T08:16:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57337", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMyODE2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432328167", "bodyText": "requests_per_second and timeout can now be query parameters", "author": "davidkyle", "createdAt": "2020-05-29T08:17:47Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestDeleteExpiredDataAction.java", "diffHunk": "@@ -41,9 +44,34 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        DeleteExpiredDataAction.Request request = restRequest.hasContent() ?\n-            DeleteExpiredDataAction.Request.PARSER.apply(restRequest.contentParser(), null) :\n-            new DeleteExpiredDataAction.Request();\n+        DeleteExpiredDataAction.Request request;\n+        if (restRequest.hasContent()) {\n+            request = DeleteExpiredDataAction.Request.PARSER.apply(restRequest.contentParser(), null);\n+        } else {\n+            request = new DeleteExpiredDataAction.Request();", "originalCommit": "09b975ab372ac41919b93764f4b264af5d2356e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTc1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432331751", "bodyText": "This is the most controversial change I think. Previously each data remover would get all jobs using a BatchedJobsIterator which gets the jobs in batches of 10,000 using a scroll search so if there are more than 10,000 jobs a scroll search will return them all.\nThe config provider performs a normal search and cannot return more that 10,000 jobs. The 10,000 jobs is a known limit as GET jobs would never return more than that number. Using the config provider hugely simplifies the code but it is a change in behaviour not matter how unlikely it is that there are > 10,000 jobs", "author": "davidkyle", "createdAt": "2020-05-29T08:24:34Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "diffHunk": "@@ -77,20 +84,31 @@ protected void doExecute(Task task, DeleteExpiredDataAction.Request request,\n             request.getTimeout() == null ? DEFAULT_MAX_DURATION : Duration.ofMillis(request.getTimeout().millis())\n         );\n \n-        Supplier<Boolean> isTimedOutSupplier = () -> Instant.now(clock).isAfter(timeoutTime);\n-        threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(\n-            () -> deleteExpiredData(request, listener, isTimedOutSupplier)\n-        );\n+        jobConfigProvider.expandJobs(request.getJobId(), true, true, ActionListener.wrap(\n+            jobBuilders -> {", "originalCommit": "09b975ab372ac41919b93764f4b264af5d2356e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNDAyMg==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432424022", "bodyText": "IMO, if there is > 10,000, the cleanup is not likely to finish. This seems like a simple throttle we get for free.", "author": "benwtrent", "createdAt": "2020-05-29T11:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjQzNA==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432426434", "bodyText": "One thing to think about is that the 10,001st job would NEVER have it's data cleaned up. I suppose that is OK, but this should be at least documented. I agree that having more than 10k jobs is rare.\nFWIW, the code using the iterator could be just as simple as you only have to update the iterator to restrict its search. Then instead of passing in a list of jobs, you pass in the iterator.", "author": "benwtrent", "createdAt": "2020-05-29T11:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMTc1MQ=="}], "type": "inlineReview"}, {"oid": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "url": "https://github.com/elastic/elasticsearch/commit/bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "message": "Fix tests with security", "committedDate": "2020-05-29T10:19:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNDM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432424340", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (in.getVersion().onOrAfter(Version.CURRENT)) { // TODO BWC for V_7_9_0\n          \n          \n            \n                        if (in.getVersion().onOrAfter(Version.V_8_0_0)) { // TODO BWC for V_7_9_0", "author": "benwtrent", "createdAt": "2020-05-29T11:32:40Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/DeleteExpiredDataAction.java", "diffHunk": "@@ -67,6 +71,9 @@ public Request(StreamInput in) throws IOException {\n                 this.requestsPerSecond = null;\n                 this.timeout = null;\n             }\n+            if (in.getVersion().onOrAfter(Version.CURRENT)) { // TODO BWC for V_7_9_0", "originalCommit": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNDQ3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432424473", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (out.getVersion().onOrAfter(Version.CURRENT)) {  // TODO BWC for V_7_9_0\n          \n          \n            \n                        if (out.getVersion().onOrAfter(Version.V_8_0_0)) {  // TODO BWC for V_7_9_0", "author": "benwtrent", "createdAt": "2020-05-29T11:32:57Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/DeleteExpiredDataAction.java", "diffHunk": "@@ -118,6 +135,9 @@ public void writeTo(StreamOutput out) throws IOException {\n                 out.writeOptionalFloat(requestsPerSecond);\n                 out.writeOptionalTimeValue(timeout);\n             }\n+            if (out.getVersion().onOrAfter(Version.CURRENT)) {  // TODO BWC for V_7_9_0", "originalCommit": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNDY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432424689", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (version.before(Version.CURRENT)) {  // TODO make V_7_9_0\n          \n          \n            \n                    if (version.before(Version.V_8_0_0)) {  // TODO make V_7_9_0", "author": "benwtrent", "createdAt": "2020-05-29T11:33:27Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/DeleteExpiredDataActionRequestTests.java", "diffHunk": "@@ -31,6 +38,12 @@ protected Request mutateInstanceForVersion(Request instance, Version version) {\n         if (version.before(Version.V_7_8_0)) {\n             return new Request();\n         }\n+        if (version.before(Version.CURRENT)) {  // TODO make V_7_9_0", "originalCommit": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNzM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432427354", "bodyText": "We need to make sure that we take the empty route in replacedRoutes and put it here before it is removed.", "author": "benwtrent", "createdAt": "2020-05-29T11:39:39Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestDeleteExpiredDataAction.java", "diffHunk": "@@ -22,7 +24,8 @@\n \n     @Override\n     public List<Route> routes() {\n-        return Collections.emptyList();\n+        return Collections.singletonList(\n+            new Route(DELETE, MachineLearning.BASE_PATH + \"_delete_expired_data/{\" + Fields.JOB_ID.getPreferredName() + \"}\"));", "originalCommit": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNzc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/57337#discussion_r432427798", "bodyText": "This should pull in the field name from the Job config object. Not the data frame analytics fields.", "author": "benwtrent", "createdAt": "2020-05-29T11:40:41Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestDeleteExpiredDataAction.java", "diffHunk": "@@ -41,9 +44,34 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        DeleteExpiredDataAction.Request request = restRequest.hasContent() ?\n-            DeleteExpiredDataAction.Request.PARSER.apply(restRequest.contentParser(), null) :\n-            new DeleteExpiredDataAction.Request();\n+        DeleteExpiredDataAction.Request request;\n+        if (restRequest.hasContent()) {\n+            request = DeleteExpiredDataAction.Request.PARSER.apply(restRequest.contentParser(), null);\n+        } else {\n+            request = new DeleteExpiredDataAction.Request();\n+\n+            String perSecondParam = restRequest.param(DeleteExpiredDataAction.Request.REQUESTS_PER_SECOND.getPreferredName());\n+            if (perSecondParam != null) {\n+                try {\n+                    request.setRequestsPerSecond(Float.parseFloat(perSecondParam));\n+                } catch (NumberFormatException e) {\n+                    throw new IllegalArgumentException(\"Failed to parse float parameter [\" +\n+                        DeleteExpiredDataAction.Request.REQUESTS_PER_SECOND.getPreferredName() +\n+                        \"] with value [\" + perSecondParam + \"]\", e);\n+                }\n+            }\n+\n+            String timeoutParam = restRequest.param(DeleteExpiredDataAction.Request.TIMEOUT.getPreferredName());\n+            if (timeoutParam != null) {\n+                request.setTimeout(restRequest.paramAsTime(timeoutParam, null));\n+            }\n+        }\n+\n+        String jobId = restRequest.param(Fields.JOB_ID.getPreferredName());", "originalCommit": "bacdb1bc51cab9829cbfb3052fd6bd49647691b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de290b89e135bc7581eb49f4e3337f1563ff0528", "url": "https://github.com/elastic/elasticsearch/commit/de290b89e135bc7581eb49f4e3337f1563ff0528", "message": "WIP", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "f4e86036a6121749ea7b2519a02707aa95e00c5b", "url": "https://github.com/elastic/elasticsearch/commit/f4e86036a6121749ea7b2519a02707aa95e00c5b", "message": "Add jobs to job data remover", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "7913f95903c62d568c79aed3dc2b10d905c76ebe", "url": "https://github.com/elastic/elasticsearch/commit/7913f95903c62d568c79aed3dc2b10d905c76ebe", "message": "Update tests", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "0adc85643db0ff1eb830657b2d78dae76df53897", "url": "https://github.com/elastic/elasticsearch/commit/0adc85643db0ff1eb830657b2d78dae76df53897", "message": "Rest test", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "f632d8afdc00cf06f7f8021d524dfc7ceee2b585", "url": "https://github.com/elastic/elasticsearch/commit/f632d8afdc00cf06f7f8021d524dfc7ceee2b585", "message": "simplify test", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "6bb691756004a01473e36dea8d79eab9b75744a6", "url": "https://github.com/elastic/elasticsearch/commit/6bb691756004a01473e36dea8d79eab9b75744a6", "message": "remove unused code", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "9c33d09a377f8a3a88727caa1ba88ffb6820f3f6", "url": "https://github.com/elastic/elasticsearch/commit/9c33d09a377f8a3a88727caa1ba88ffb6820f3f6", "message": "Use volatile iterator", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "2bf97032ec6e1c7330dac7c7c3fdc4d783f52e7a", "url": "https://github.com/elastic/elasticsearch/commit/2bf97032ec6e1c7330dac7c7c3fdc4d783f52e7a", "message": "comment", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "1efe4f562f85607e706d102f18b8c40f3997ab1f", "url": "https://github.com/elastic/elasticsearch/commit/1efe4f562f85607e706d102f18b8c40f3997ab1f", "message": "Fix tests with security", "committedDate": "2020-06-04T10:47:11Z", "type": "commit"}, {"oid": "9a7a1e6c887fcb78aa0809bfb1c9dfe538b3853b", "url": "https://github.com/elastic/elasticsearch/commit/9a7a1e6c887fcb78aa0809bfb1c9dfe538b3853b", "message": "Review comments", "committedDate": "2020-06-04T11:16:56Z", "type": "commit"}, {"oid": "da7ae6db26d3529dd0de36b3fb54318bc19a1028", "url": "https://github.com/elastic/elasticsearch/commit/da7ae6db26d3529dd0de36b3fb54318bc19a1028", "message": "Use doc IDs in unused state remover", "committedDate": "2020-06-04T12:08:59Z", "type": "commit"}, {"oid": "ecda5c11a2e505aa2a2d7285bcd14ef045c8bd38", "url": "https://github.com/elastic/elasticsearch/commit/ecda5c11a2e505aa2a2d7285bcd14ef045c8bd38", "message": "Add wildcard query to BatchedJobsIterator", "committedDate": "2020-06-04T13:14:49Z", "type": "commit"}, {"oid": "ecda5c11a2e505aa2a2d7285bcd14ef045c8bd38", "url": "https://github.com/elastic/elasticsearch/commit/ecda5c11a2e505aa2a2d7285bcd14ef045c8bd38", "message": "Add wildcard query to BatchedJobsIterator", "committedDate": "2020-06-04T13:14:49Z", "type": "forcePushed"}, {"oid": "45fa17c85f72a2c5136b251766aae30a6dd89c96", "url": "https://github.com/elastic/elasticsearch/commit/45fa17c85f72a2c5136b251766aae30a6dd89c96", "message": "Fix wrong arguments", "committedDate": "2020-06-04T18:27:57Z", "type": "commit"}, {"oid": "46c1c84534338eb016a87244022f6d9b091f6fa9", "url": "https://github.com/elastic/elasticsearch/commit/46c1c84534338eb016a87244022f6d9b091f6fa9", "message": "Remove invalid test", "committedDate": "2020-06-05T07:36:03Z", "type": "commit"}]}