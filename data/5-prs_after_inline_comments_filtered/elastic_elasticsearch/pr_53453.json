{"pr_number": 53453, "pr_title": "Resolve anonymous roles and deduplicate roles during authentication", "pr_createdAt": "2020-03-12T08:06:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53453", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r391463115", "bodyText": "The tricky bits of this work are:\n\nXContent serialization is managed inside Authentication\nInformation about anonymous user is not available in Authentication.\n\nOne approach is to add an new anonymousRoles field to User class and populate it during authentication. But this has wide spread impact as the User object is serialised and sent everywhere. Also the anonymous access is by default off, so it does not seem to justify the wide spread change.\nSo the new logic is added here in RestAuthenticationAction, which can create the anonymous user object and inject its roles into the XContent object.", "author": "ywangd", "createdAt": "2020-03-12T08:26:57Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/RestAuthenticateAction.java", "diffHunk": "@@ -65,7 +70,16 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 new RestBuilderListener<AuthenticateResponse>(channel) {\n             @Override\n             public RestResponse buildResponse(AuthenticateResponse authenticateResponse, XContentBuilder builder) throws Exception {\n-                authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                if (anonymousEnabled\n+                    && false == anonymousUser.equals(authenticateResponse.authentication().getUser())\n+                    && anonymousUser.roles().length != 0) {\n+                    builder.startObject();\n+                    authenticateResponse.authentication().toXContentFragment(builder);\n+                    builder.array(User.Fields.ANONYMOUS_ROLES.getPreferredName(), anonymousUser.roles());\n+                    builder.endObject();\n+                } else {\n+                    authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                }", "originalCommit": "98a319d4c32b92faa66ab2af6480cd28b5317512", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE0OTUxNw==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392149517", "bodyText": "One approach is to add an new anonymousRoles field to User class and populate it during authentication.\n\nI think the best way forward is to actually do this ( no need to add a field to User), but evaluate the anonymous roles during authentication (i.e. right after the realms return the User in AuthenticationService#consumeToken ) instead of during authorization.\nIf we don't want to do this now, but defer it to a later point ( or as part of the effort to refactor the logic around AuthenticationTokens ), I think this fits better in the Transport Action than in the Rest one.", "author": "jkakavas", "createdAt": "2020-03-13T10:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1NTExNg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392155116", "bodyText": "I think this will only work if we move away from adding the new anonymous_role field in the response, am I right?\nOtherwise, there is no place to save these role information. We could use User#metadata but it feels hacky.", "author": "ywangd", "createdAt": "2020-03-13T10:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1NjIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392156224", "bodyText": "Yes this implies we follow my other comment and anonymous roles are part of roles", "author": "jkakavas", "createdAt": "2020-03-13T10:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2MDk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392160964", "bodyText": "Great. Thanks for the clarification.", "author": "ywangd", "createdAt": "2020-03-13T11:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjczMTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392731757", "bodyText": "@jkakavas There are some issues for adding the anonymous roles into User#roles\n\nAuthenticationService#consumeToken does not cover runAs user, which is handled in lookupRunAsUser.\nBoth above methods end in finishAuthentication , so this could be a better candidate.\nBut doing above changes the existing logic. It's adding the anonymous roles to all users. Currently, some system users do not inherit anonymous roles. The code even asserts that XPackUser can only have a single role. There could be other situations where adding anonymous roles are not desired?\nThe final role resolving is handled in CompositeRolesStore#getRoles. Result of this method is the source of truth as it is what gets used in execution.\n\nIn summary, adding roles to all authenticated user has wider impact and it does not feel ideal. I think that the Authorization process may still be a better place for this, because \"granting more roles\" to user sounds more like \"authorization\" instead of \"authentication\". In fact, CompositeRolesStore#getRoles (part of authorization) is where this happens.\nThe challenge of using result of CompositeRolesStore#getRoles is that it is not easily accessible:\n\nThe resulted AuthorizationInfo object does get saved in threadContext as a Transient value. But this does not seem to be accessible once cross the wire.\nIt is also not possible (or ideal) to alter the User object in authorization process for saving these resolved roles.\nAdding a new key in threadContext for saving these roles seem to be overkill and inconsistent.\n\nSo I'd like to propose the following approach:\n\nAdd a new field for the resolved roles in  org.elasticsearch.xpack.core.security.action.user.AuthenticateResponse.\nIn TransportAuthenticateAction, grab the resolved roles from threadContext and set it to the AuthenticateResponse object. It may be possible to access the transient value here because the transport action runs in the same machine as the \"authorization\" process, i.e. not cross wire.\nRestAuthenticateAction has access to AuthenticateResponse from which the final response can be built.\n\nPlease let me know your thoughts. Thanks.", "author": "ywangd", "createdAt": "2020-03-16T00:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyNDc4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r393824786", "bodyText": "There could be other situations where adding anonymous roles are not desired?\n\nI can think of reserved and internal users. I don't think we need to care about internal users here ( _system, _xpack etc ) as we wouldn't be handling requests from the REST layer as these users. But reserved users ( i.e. kibana ) would be problematic.\n\nI think that the Authorization process may still be a better place for this, because \"granting more roles\" to user sounds more like \"authorization\" instead of \"authentication\". In fact, CompositeRolesStore#getRoles (part of authorization) is where this happens.\n\nBut we do resolve and populate the user roles in authentication too which makes it hard to have this mental distinction. I would argue that role resolving based on user attributes ( i.e. role mapping ) is part of authentication. Granting access based on the definition of these roles is authorization.\nI still feel that this fits better in AuthenticationService but did not have the cycles to think it through. I think this would benefit from a short live discussion, care to put it on the agenda for our weekly meeting tomorrow? We can reach a consensus there and come back here with that and see this through to completion", "author": "jkakavas", "createdAt": "2020-03-17T16:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5ODM5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r394098392", "bodyText": "I added it under Forward agenda. Thanks.", "author": "ywangd", "createdAt": "2020-03-18T04:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzgwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392107805", "bodyText": "I think I had a change of heart since #47195 (comment). I think that the fact that these are roles inherited by the anonymous user configuration is more important to the administrator and/or for troubleshooting than it is for the user themselves. As such, if I know/should know that anonymous access is enabled, I can make sense of the response ( as to why more roles are returned ) and if I don't, I probably just care about what roles I have more than why I have them.\nSimilar to why we don't return \"native_roles\": {xxx}, \"roles_from_role_mapping_based_on_groups\": {},  \"roles_from_role_mapping_based_on_username\": {},  \"roles_from_role_mapping_based_on_metadata\": {} , I believe we shouldn't be adding anonymous_roles here. The purpose of the API is to tell us which roles the user has, but not why they have them.", "author": "jkakavas", "createdAt": "2020-03-13T09:12:27Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/RestAuthenticateAction.java", "diffHunk": "@@ -65,7 +70,16 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 new RestBuilderListener<AuthenticateResponse>(channel) {\n             @Override\n             public RestResponse buildResponse(AuthenticateResponse authenticateResponse, XContentBuilder builder) throws Exception {\n-                authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                if (anonymousEnabled\n+                    && false == anonymousUser.equals(authenticateResponse.authentication().getUser())\n+                    && anonymousUser.roles().length != 0) {\n+                    builder.startObject();\n+                    authenticateResponse.authentication().toXContentFragment(builder);\n+                    builder.array(User.Fields.ANONYMOUS_ROLES.getPreferredName(), anonymousUser.roles());", "originalCommit": "149c6f8a80b4ebb50d09a895e103f09f371b7f3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1ODAwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392158009", "bodyText": "You have a point here plus it makes the whole thing easier. I have no objection.\nJust some thought process: I am ok with adding a new field. But the name \"anonymous_roles\" feels too specific for me to like. This does raise the question why we don't have things like native_roles etc. I wanted name it inherited_roles so it can at least to re-used. But if we treat anonymous roles just like another role providers, it should then just be part of the existing roles field. So yes, I'll remove the new field.", "author": "ywangd", "createdAt": "2020-03-13T10:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzgwNQ=="}], "type": "inlineReview"}, {"oid": "19a3307df519a85eaa1ad6fb0031b87a068045b5", "url": "https://github.com/elastic/elasticsearch/commit/19a3307df519a85eaa1ad6fb0031b87a068045b5", "message": "Move anonymous role merging from authz to authc", "committedDate": "2020-03-20T05:02:52Z", "type": "forcePushed"}, {"oid": "8dac757111f96b407a0fd86884c761d2c041b4bb", "url": "https://github.com/elastic/elasticsearch/commit/8dac757111f96b407a0fd86884c761d2c041b4bb", "message": "Move anonymous role merging from authz to authc", "committedDate": "2020-03-20T05:22:46Z", "type": "commit"}, {"oid": "09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "url": "https://github.com/elastic/elasticsearch/commit/09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "message": "Update rest tests", "committedDate": "2020-03-20T05:22:46Z", "type": "commit"}, {"oid": "09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "url": "https://github.com/elastic/elasticsearch/commit/09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "message": "Update rest tests", "committedDate": "2020-03-20T05:22:46Z", "type": "forcePushed"}, {"oid": "e24072aae10802bccd9488a28507c4b1dd713634", "url": "https://github.com/elastic/elasticsearch/commit/e24072aae10802bccd9488a28507c4b1dd713634", "message": "Add unit tests for authenticationService", "committedDate": "2020-03-20T05:43:49Z", "type": "commit"}, {"oid": "2cf8516c1827344442a5bfc417eda8e918409f81", "url": "https://github.com/elastic/elasticsearch/commit/2cf8516c1827344442a5bfc417eda8e918409f81", "message": "Remove unnecessary authorizationService test", "committedDate": "2020-03-20T05:48:46Z", "type": "commit"}, {"oid": "8c5531b19914ce808a14548df0373f45a0d4a4b2", "url": "https://github.com/elastic/elasticsearch/commit/8c5531b19914ce808a14548df0373f45a0d4a4b2", "message": "Fix test", "committedDate": "2020-03-20T06:25:15Z", "type": "commit"}, {"oid": "903b805760bc0335b06de7d8b13afe8222f89506", "url": "https://github.com/elastic/elasticsearch/commit/903b805760bc0335b06de7d8b13afe8222f89506", "message": "style", "committedDate": "2020-03-20T08:27:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDY3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396960675", "bodyText": "Do we guarantee order ? if not maybe containsInAnyOrder() is better here ?", "author": "jkakavas", "createdAt": "2020-03-24T08:00:16Z", "path": "x-pack/plugin/security/qa/basic-enable-security/src/test/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -126,7 +126,7 @@ private void checkAuthentication() throws IOException {\n         final Map<String, Object> auth = getAsMap(\"/_security/_authenticate\");\n         // From file realm, configured in build.gradle\n         assertThat(ObjectPath.evaluate(auth, \"username\"), equalTo(\"security_test_user\"));\n-        assertThat(ObjectPath.evaluate(auth, \"roles\"), contains(\"security_test_role\"));\n+        assertThat(ObjectPath.evaluate(auth, \"roles\"), contains(\"security_test_role\", \"anonymous\"));", "originalCommit": "903b805760bc0335b06de7d8b13afe8222f89506", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4Njk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396986944", "bodyText": "Updated. The order is preserved. But I don't think we need guarantee it.", "author": "ywangd", "createdAt": "2020-03-24T08:50:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2Mzg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396963840", "bodyText": "nit: this implies that we have some special handling when merging the anonymous roles, while we just merge the two String arrays. I get that this is cleaner than doing it twice above but maybe a more generic mergeRoles where you pass both existingRoles and anonymoysUser.roles? Just a suggestion though", "author": "jkakavas", "createdAt": "2020-03-24T08:06:49Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = new User(\n+                    user.principal(),\n+                    mergeAnonymousRoles(user.roles()),\n+                    user.fullName(),\n+                    user.email(),\n+                    user.metadata(),\n+                    user.enabled()\n+                );\n+                if (user.isRunAs()) {\n+                    final User authenticatedUserWithMergedRoles = new User(\n+                        user.authenticatedUser().principal(),\n+                        mergeAnonymousRoles(user.authenticatedUser().roles()),\n+                        user.authenticatedUser().fullName(),\n+                        user.authenticatedUser().email(),\n+                        user.authenticatedUser().metadata(),\n+                        user.authenticatedUser().enabled()\n+                    );\n+                    userWithMergedRoles = new User(userWithMergedRoles, authenticatedUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return user;\n+            }\n+        }\n+\n+        private String[] mergeAnonymousRoles(String[] existingRoles) {", "originalCommit": "903b805760bc0335b06de7d8b13afe8222f89506", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NzQwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396987409", "bodyText": "This is a good suggestion. It is cleaner that way. I updated.", "author": "ywangd", "createdAt": "2020-03-24T08:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2Mzg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2ODEzNg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396968136", "bodyText": "Shouldn't we create a Set here and Collections.addAll so that we don't end up with duplicate roles in case the anonymous roles contains a role the user already has ?", "author": "jkakavas", "createdAt": "2020-03-24T08:15:43Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = new User(\n+                    user.principal(),\n+                    mergeAnonymousRoles(user.roles()),\n+                    user.fullName(),\n+                    user.email(),\n+                    user.metadata(),\n+                    user.enabled()\n+                );\n+                if (user.isRunAs()) {\n+                    final User authenticatedUserWithMergedRoles = new User(\n+                        user.authenticatedUser().principal(),\n+                        mergeAnonymousRoles(user.authenticatedUser().roles()),\n+                        user.authenticatedUser().fullName(),\n+                        user.authenticatedUser().email(),\n+                        user.authenticatedUser().metadata(),\n+                        user.authenticatedUser().enabled()\n+                    );\n+                    userWithMergedRoles = new User(userWithMergedRoles, authenticatedUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return user;\n+            }\n+        }\n+\n+        private String[] mergeAnonymousRoles(String[] existingRoles) {\n+            String[] mergedRoles = new String[existingRoles.length + anonymousUser.roles().length];\n+            System.arraycopy(existingRoles, 0, mergedRoles, 0, existingRoles.length);", "originalCommit": "903b805760bc0335b06de7d8b13afe8222f89506", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MTQ4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396991485", "bodyText": "I intentially didn't do deduplication here. Deduplication, filtering out un-resolvable roles, preempting the superuser role are all done in CompositeRolesStore#getRoles, which comes after authentication.\nEven without the anonymous roles, it is still possible to create an user with duplicated roles, e.g.\n{\"roles\":[\"x\",\"x\",\"x\"],\"password\":...} and these roles will all show up in the authentication response. So I decided to retain the existing behaviour.", "author": "ywangd", "createdAt": "2020-03-24T08:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2ODEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0NDc0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397044742", "bodyText": "I don't think we should entertain this existing behavior for no reason, and since we go in the trouble of merging the roles we should do de-duplication here . We could tackle this in a follow up where we for instance should not allow a user to be created with \"roles\" :[\"x\",\"x\",\"x\"] in the first place as this leniency makes no sense and I would argue that if someone created a user with  \"roles\" :[\"x\",\"x\"] , they probably meant  \"roles\" :[\"x\",\"y\"] and mistyped , so it's better to tell them up front/", "author": "jkakavas", "createdAt": "2020-03-24T10:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2ODEzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzExMTM0NA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397111344", "bodyText": "Merging only happens when anonymous access is enabled. If we de-duplicate here, it must also be applied when anonymous access is not enabled. So I re-arranged the code.", "author": "ywangd", "createdAt": "2020-03-24T12:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2ODEzNg=="}], "type": "inlineReview"}, {"oid": "c17175793e4d505bec9a18d4977d93698662c05f", "url": "https://github.com/elastic/elasticsearch/commit/c17175793e4d505bec9a18d4977d93698662c05f", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-03-24T08:31:31Z", "type": "commit"}, {"oid": "c43f8ba959e20e01c66b988a68c0dd23db57307b", "url": "https://github.com/elastic/elasticsearch/commit/c43f8ba959e20e01c66b988a68c0dd23db57307b", "message": "Address feedback", "committedDate": "2020-03-24T08:48:24Z", "type": "commit"}, {"oid": "857c9e49239a58ae977c9ca7798782f313956e21", "url": "https://github.com/elastic/elasticsearch/commit/857c9e49239a58ae977c9ca7798782f313956e21", "message": "Checkstyle", "committedDate": "2020-03-24T09:02:14Z", "type": "commit"}, {"oid": "1deaa58b5b18984be64588c5d45fca4236d24c42", "url": "https://github.com/elastic/elasticsearch/commit/1deaa58b5b18984be64588c5d45fca4236d24c42", "message": "Remove extra empty line", "committedDate": "2020-03-24T09:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0OTc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397049761", "bodyText": "I'm also a bit worried about duplicating the check here. Should we make \n  \n    \n      elasticsearch/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java\n    \n    \n         Line 418\n      in\n      9467dbf\n    \n    \n    \n    \n\n        \n          \n           private boolean isInternalUser(User user) { \n        \n    \n  \n\n public, update it to take AsyncSearchUSer into consideration ( which was missed when we introduced AsyncSearchUser - point in case )  and use that as a single source of truth for the check here ?", "author": "jkakavas", "createdAt": "2020-03-24T10:31:29Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {", "originalCommit": "1deaa58b5b18984be64588c5d45fca4236d24c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA2ODQyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397068421", "bodyText": "Yes makes sense. Long logical expression is never good as an if condition and should be wrapped inside a method.\nBut maybe we could find a better home for this method. How about User#isInternal(User user)?\nThe AsyncSearchUser is also missed in InternalUserSerializationHelper. The new Use#isInternal method can be leveraged in here as well. It won't be able to access AuthorizationService#isInternalUser due to circular dependency.", "author": "ywangd", "createdAt": "2020-03-24T11:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0OTc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MTA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397071079", "bodyText": "Sure thing!", "author": "jkakavas", "createdAt": "2020-03-24T11:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0OTc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzExNDQ5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397114496", "bodyText": "I did the refactoring. But decided to leave InternalUserSerializationHelper out for now. Changing it breaks backwards compatibility, which I think deseves its own issue.", "author": "ywangd", "createdAt": "2020-03-24T12:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0OTc2MQ=="}], "type": "inlineReview"}, {"oid": "fe6eae8f8e4271b8afee60ebef2f8d9c10904ced", "url": "https://github.com/elastic/elasticsearch/commit/fe6eae8f8e4271b8afee60ebef2f8d9c10904ced", "message": "Address feedback", "committedDate": "2020-03-24T11:45:53Z", "type": "commit"}, {"oid": "2fcbfadf54bec9a12e3d77dae3b0933b00ff08bc", "url": "https://github.com/elastic/elasticsearch/commit/2fcbfadf54bec9a12e3d77dae3b0933b00ff08bc", "message": "Address feedback", "committedDate": "2020-03-24T12:22:06Z", "type": "commit"}, {"oid": "72d26671843771d69ff4a0d8045f9cd4f4afb8f5", "url": "https://github.com/elastic/elasticsearch/commit/72d26671843771d69ff4a0d8045f9cd4f4afb8f5", "message": "Fix tests", "committedDate": "2020-03-24T13:45:16Z", "type": "commit"}, {"oid": "65faa2cc10bce07ebb1d3b2ead04763099dc7645", "url": "https://github.com/elastic/elasticsearch/commit/65faa2cc10bce07ebb1d3b2ead04763099dc7645", "message": "Fix typo", "committedDate": "2020-03-24T13:50:05Z", "type": "commit"}, {"oid": "c686985ba93b28214042b9f85765cb4dd3ec4856", "url": "https://github.com/elastic/elasticsearch/commit/c686985ba93b28214042b9f85765cb4dd3ec4856", "message": "Refactor for clarity", "committedDate": "2020-03-24T14:01:35Z", "type": "commit"}, {"oid": "faa0471a560cb9d8768ef66187876475878bc212", "url": "https://github.com/elastic/elasticsearch/commit/faa0471a560cb9d8768ef66187876475878bc212", "message": "Refactor for more predictable behaviour", "committedDate": "2020-03-24T23:24:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4MTEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397681131", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private User dedupUserRoles(User user) {\n          \n          \n            \n                    private User deduplicateUserRoles(User user) {", "author": "jkakavas", "createdAt": "2020-03-25T08:33:39Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {", "originalCommit": "faa0471a560cb9d8768ef66187876475878bc212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4OTQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397689494", "bodyText": "Do we have to do the length check ? Can't this always be user.withRoles(Set.of(user.roles()).toArray(new String[0]));", "author": "jkakavas", "createdAt": "2020-03-25T08:49:08Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {\n+            final Set<String> userRoles = new LinkedHashSet<>(Arrays.asList(user.roles()));\n+            User userWithDedupRoles = userRoles.size() == user.roles().length", "originalCommit": "faa0471a560cb9d8768ef66187876475878bc212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI1NDYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r398254602", "bodyText": "The length checks are to avoid creation of new User objects when it is not necessary. I think most of the times it is indeed not necessary, i.e. roles are already distinct. I did this mostly for: 1) retain existing behavior; 2) potential optimization.\nI added a comment to make this intention clear.", "author": "ywangd", "createdAt": "2020-03-26T00:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4OTQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY5MDcxMg==", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397690712", "bodyText": "same as above", "author": "jkakavas", "createdAt": "2020-03-25T08:51:15Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {\n+            final Set<String> userRoles = new LinkedHashSet<>(Arrays.asList(user.roles()));\n+            User userWithDedupRoles = userRoles.size() == user.roles().length\n+                ? user\n+                : user.withRoles(userRoles.toArray(new String[0]));\n+\n+            if (user.isRunAs()) {\n+                final Set <String> authUserRoles = new LinkedHashSet<>(Arrays.asList(user.authenticatedUser().roles()));\n+                User authUserWithDedupRoles = authUserRoles.size() == user.authenticatedUser().roles().length", "originalCommit": "faa0471a560cb9d8768ef66187876475878bc212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "384aa17e2003061b60f2cd727561d638c6dad656", "url": "https://github.com/elastic/elasticsearch/commit/384aa17e2003061b60f2cd727561d638c6dad656", "message": "Address feedback", "committedDate": "2020-03-26T00:44:33Z", "type": "commit"}, {"oid": "6fa37e48c913c1f1e08c29b5605fbbfa87ae819e", "url": "https://github.com/elastic/elasticsearch/commit/6fa37e48c913c1f1e08c29b5605fbbfa87ae819e", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-03-26T00:44:49Z", "type": "commit"}, {"oid": "6fd8249dc81c2b84a7c9a48a1a89f953d1b54279", "url": "https://github.com/elastic/elasticsearch/commit/6fd8249dc81c2b84a7c9a48a1a89f953d1b54279", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-03-26T02:03:58Z", "type": "commit"}, {"oid": "cc7f259ecf77773a34d476779816b16afd88105d", "url": "https://github.com/elastic/elasticsearch/commit/cc7f259ecf77773a34d476779816b16afd88105d", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-04-08T04:42:59Z", "type": "commit"}, {"oid": "9a8bd636cc6b45396cd791aef5d2a12d261a279a", "url": "https://github.com/elastic/elasticsearch/commit/9a8bd636cc6b45396cd791aef5d2a12d261a279a", "message": "Deduplicate roles for file and native realms earlier in the chain", "committedDate": "2020-04-08T06:59:25Z", "type": "commit"}, {"oid": "6af416ced443f194ff98bf3af6c2e7739f554798", "url": "https://github.com/elastic/elasticsearch/commit/6af416ced443f194ff98bf3af6c2e7739f554798", "message": "Remove unnecessary tests", "committedDate": "2020-04-08T09:20:56Z", "type": "commit"}, {"oid": "2892218e148505bc7bb82372e57a4d8827e5acd0", "url": "https://github.com/elastic/elasticsearch/commit/2892218e148505bc7bb82372e57a4d8827e5acd0", "message": "Update tests", "committedDate": "2020-04-08T11:44:11Z", "type": "commit"}, {"oid": "c6a8aa136e74b4454114c2f85a98f446ee959ead", "url": "https://github.com/elastic/elasticsearch/commit/c6a8aa136e74b4454114c2f85a98f446ee959ead", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-04-22T07:33:20Z", "type": "commit"}, {"oid": "c63c49faba17900a2f2322c9606a3f451879489d", "url": "https://github.com/elastic/elasticsearch/commit/c63c49faba17900a2f2322c9606a3f451879489d", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role", "committedDate": "2020-04-30T00:30:48Z", "type": "commit"}]}