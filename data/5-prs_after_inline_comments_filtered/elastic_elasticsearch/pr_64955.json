{"pr_number": 64955, "pr_title": "Minor Cleanup in org.elasticsearch.common.collect", "pr_createdAt": "2020-11-11T18:00:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64955", "timeline": [{"oid": "29c42d7f6c14d8caffba334d11828def7ab599b0", "url": "https://github.com/elastic/elasticsearch/commit/29c42d7f6c14d8caffba334d11828def7ab599b0", "message": "Minor Cleanup in org.elasticsearch.common.collect\n\n* Return empty map singleton from builder\n* Remove dead methods\n* Cleanup duplicate iterator", "committedDate": "2020-11-11T17:58:05Z", "type": "commit"}, {"oid": "cf0f5dcf8033cee3a756c801bbc3578e8c088a5f", "url": "https://github.com/elastic/elasticsearch/commit/cf0f5dcf8033cee3a756c801bbc3578e8c088a5f", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-collects", "committedDate": "2020-11-11T19:33:19Z", "type": "commit"}, {"oid": "06005f2790cec74052b9f2558453111faee1496a", "url": "https://github.com/elastic/elasticsearch/commit/06005f2790cec74052b9f2558453111faee1496a", "message": "fix broken test", "committedDate": "2020-11-11T20:33:09Z", "type": "commit"}, {"oid": "1307fbdd4bc4bf5898ce6a0b5ca438821c36ffc5", "url": "https://github.com/elastic/elasticsearch/commit/1307fbdd4bc4bf5898ce6a0b5ca438821c36ffc5", "message": "fix broken test", "committedDate": "2020-11-11T20:57:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzNjA2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64955#discussion_r521636067", "bodyText": "A neat side effect of this cleanup is that it made it easier to catch this bug. We were calling the builder twice, but the second invocation would actually produce a broken result because it created an immutable open map with a null map inside that would NPE on every operation if used.", "author": "original-brownbear", "createdAt": "2020-11-11T21:01:34Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/ReplaceDataStreamBackingIndexStepTests.java", "diffHunk": "@@ -61,12 +61,13 @@ public void testPerformActionThrowsExceptionIfIndexIsNotPartOfDataStream() {\n             IndexMetadata.builder(indexName).settings(settings(Version.CURRENT).put(LifecycleSettings.LIFECYCLE_NAME, policyName))\n                 .numberOfShards(randomIntBetween(1, 5)).numberOfReplicas(randomIntBetween(0, 5));\n \n+        final IndexMetadata sourceIndexMetadata = sourceIndexMetadataBuilder.build();\n         ClusterState clusterState = ClusterState.builder(emptyClusterState()).metadata(\n-            Metadata.builder().put(sourceIndexMetadataBuilder).build()\n+            Metadata.builder().put(sourceIndexMetadata, false).build()", "originalCommit": "1307fbdd4bc4bf5898ce6a0b5ca438821c36ffc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8270341ce865de7d436f38a74bd353c88a9720ee", "url": "https://github.com/elastic/elasticsearch/commit/8270341ce865de7d436f38a74bd353c88a9720ee", "message": "fix broken test", "committedDate": "2020-11-12T08:17:33Z", "type": "commit"}, {"oid": "e8139c20a2a80feb97e830b5a71a4fb4fd993ec3", "url": "https://github.com/elastic/elasticsearch/commit/e8139c20a2a80feb97e830b5a71a4fb4fd993ec3", "message": "fix broken test", "committedDate": "2020-11-12T09:03:13Z", "type": "commit"}, {"oid": "da7349baa65eb183935594e43063816c64a391eb", "url": "https://github.com/elastic/elasticsearch/commit/da7349baa65eb183935594e43063816c64a391eb", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-collects", "committedDate": "2020-11-18T09:28:55Z", "type": "commit"}]}