{"pr_number": 53919, "pr_title": "Use Azure Bulk Deletes in Azure Repository", "pr_createdAt": "2020-03-21T15:36:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53919", "timeline": [{"oid": "e04d8d5f93f782d5a7cec77718712d5985e04257", "url": "https://github.com/elastic/elasticsearch/commit/e04d8d5f93f782d5a7cec77718712d5985e04257", "message": "Fix Azure Repository with HTTPs Endpoint\n\nUpgrading to 8.6.2 in #53865 broke running against HTTPs endpoints (and hence real azure)\nbecause the https url connection needs the newly added permission to work.", "committedDate": "2020-03-20T20:33:53Z", "type": "commit"}, {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "url": "https://github.com/elastic/elasticsearch/commit/aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "message": "Use Azure Repository Bulk Deletes\n\nNow that we upgraded the Azure SDK to 8.6.2 we can make use of\nbulk deletes.", "committedDate": "2020-03-21T15:34:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQxNg==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396002416", "bodyText": "No need to deprecate here. We have never documented this threadpool and it was always seen as an internal setting.\nHaving it set will not prevent ES from starting up cleanly so I don't see anyone getting hurt here.", "author": "original-brownbear", "createdAt": "2020-03-21T15:38:08Z", "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureRepositoryPlugin.java", "diffHunk": "@@ -80,15 +74,6 @@ AzureStorageService createAzureStoreService(final Settings settings) {\n         );\n     }\n \n-    @Override\n-    public List<ExecutorBuilder<?>> getExecutorBuilders(Settings settings) {", "originalCommit": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjU4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396002589", "bodyText": "Since we needed the request body again I refactored things like we did for the other mocks to full drain the input first thing here as well to keep things simple.", "author": "original-brownbear", "createdAt": "2020-03-21T15:40:17Z", "path": "test/fixtures/azure-fixture/src/main/java/fixture/azure/AzureHttpHandler.java", "diffHunk": "@@ -67,18 +72,21 @@ public void handle(final HttpExchange exchange) throws IOException {\n             assert read == -1 : \"Request body should have been empty but saw [\" + read + \"]\";\n         }\n         try {\n+            // Request body is closed in the finally block\n+            final BytesReference requestBody = Streams.readFully(Streams.noCloseStream(exchange.getRequestBody()));", "originalCommit": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d", "url": "https://github.com/elastic/elasticsearch/commit/145569833c91e08a36f6880b3c26c48444c1c20d", "message": "shorter diff", "committedDate": "2020-03-21T15:42:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NDg4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396284887", "bodyText": "In case of more than 256 blobs to delete, this will log the same message multiple times right?", "author": "tlrx", "createdAt": "2020-03-23T08:40:30Z", "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureStorageService.java", "diffHunk": "@@ -187,72 +188,61 @@ public boolean blobExists(String account, String container, String blob) throws\n         });\n     }\n \n-    public void deleteBlob(String account, String container, String blob) throws URISyntaxException, StorageException {\n+    public void deleteBlobsIgnoringIfNotExists(String account, String container, Collection<String> blobs)\n+            throws URISyntaxException, StorageException {\n         final Tuple<CloudBlobClient, Supplier<OperationContext>> client = client(account);\n         // Container name must be lower case.\n         final CloudBlobContainer blobContainer = client.v1().getContainerReference(container);\n-        logger.trace(() -> new ParameterizedMessage(\"delete blob for container [{}], blob [{}]\", container, blob));\n-        SocketAccess.doPrivilegedVoidException(() -> {\n-            final CloudBlockBlob azureBlob = blobContainer.getBlockBlobReference(blob);\n-            logger.trace(() -> new ParameterizedMessage(\"container [{}]: blob [{}] found. removing.\", container, blob));\n-            azureBlob.delete(DeleteSnapshotsOption.NONE, null, null, client.v2().get());\n-        });\n+        final Iterator<String> blobIterator = blobs.iterator();\n+        int currentBatchSize = 0;\n+        while (blobIterator.hasNext()) {\n+            final BlobDeleteBatchOperation batchDeleteOp = new BlobDeleteBatchOperation();\n+            do {\n+                batchDeleteOp.addSubOperation(blobContainer.getBlockBlobReference(blobIterator.next()),\n+                    DeleteSnapshotsOption.NONE, null, null);\n+                ++currentBatchSize;\n+            } while (blobIterator.hasNext() && currentBatchSize < Constants.BATCH_MAX_REQUESTS);\n+            currentBatchSize = 0;\n+            logger.trace(() -> new ParameterizedMessage(\"delete blobs for container [{}], blob [{}]\", container, blobs));", "originalCommit": "145569833c91e08a36f6880b3c26c48444c1c20d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0NDgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396344807", "bodyText": "Right :) moved the log statement to the beginning of the method now", "author": "original-brownbear", "createdAt": "2020-03-23T10:22:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NDg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjA4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396286082", "bodyText": "Batch request does not prefix with the container name, right?", "author": "tlrx", "createdAt": "2020-03-23T08:42:37Z", "path": "plugins/repository-azure/src/test/java/org/elasticsearch/repositories/azure/AzureBlobStoreRepositoryTests.java", "diffHunk": "@@ -64,7 +64,7 @@ protected Settings repositorySettings() {\n \n     @Override\n     protected Map<String, HttpHandler> createHttpHandlers() {\n-        return Collections.singletonMap(\"/container\", new AzureBlobStoreHttpHandler(\"container\"));\n+        return Collections.singletonMap(\"/\", new AzureBlobStoreHttpHandler(\"container\"));", "originalCommit": "145569833c91e08a36f6880b3c26c48444c1c20d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0Mzc4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396343783", "bodyText": "Jup exactly, that's why I had to expand the context here", "author": "original-brownbear", "createdAt": "2020-03-23T10:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjgzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396286839", "bodyText": "\u2764\ufe0f", "author": "tlrx", "createdAt": "2020-03-23T08:43:57Z", "path": "test/fixtures/azure-fixture/src/main/java/fixture/azure/AzureHttpHandler.java", "diffHunk": "@@ -190,6 +198,45 @@ public void handle(final HttpExchange exchange) throws IOException {\n                 exchange.sendResponseHeaders(RestStatus.OK.getStatus(), response.length);\n                 exchange.getResponseBody().write(response);\n \n+            } else if (Regex.simpleMatch(\"POST /?comp=batch\", request)) {\n+                // Batch Delete (https://docs.microsoft.com/en-us/rest/api/storageservices/blob-batch)\n+                try (BufferedReader reader = new BufferedReader(new InputStreamReader(requestBody.streamInput()))) {\n+                    final Set<String> toDelete = reader.lines().filter(l -> l.startsWith(\"DELETE\"))\n+                        .map(l -> l.split(\" \")[1]).collect(Collectors.toSet());\n+                    final BytesStreamOutput baos = new BytesStreamOutput();\n+                    final String batchSeparator = \"batchresponse_\" + UUIDs.randomBase64UUID();\n+                    try (Writer writer = new OutputStreamWriter(baos)) {\n+                        int contentId = 0;\n+                        for (String b : toDelete) {\n+                            writer.write(\"\\r\\n--\" + batchSeparator + \"\\r\\n\" +\n+                                \"Content-Type: application/http \\r\\n\" +\n+                                \"Content-ID: \" + contentId++ + \" \\r\\n\");\n+                            if (blobs.remove(b) == null) {\n+                                writer.write(\"\\r\\nHTTP/1.1 404 The specified blob does not exist. \\r\\n\" +\n+                                    \"x-ms-error-code: BlobNotFound \\r\\n\" +", "originalCommit": "145569833c91e08a36f6880b3c26c48444c1c20d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "290d325cd510aa074504fc4014ab30231a2ffd3b", "url": "https://github.com/elastic/elasticsearch/commit/290d325cd510aa074504fc4014ab30231a2ffd3b", "message": "Merge remote-tracking branch 'elastic/master' into azure-bulk-deletes-2", "committedDate": "2020-03-23T10:18:57Z", "type": "commit"}, {"oid": "a933c2d1fa6e7b1b2a7a152ac47f773d210b9378", "url": "https://github.com/elastic/elasticsearch/commit/a933c2d1fa6e7b1b2a7a152ac47f773d210b9378", "message": "CR: move log statement", "committedDate": "2020-03-23T10:21:36Z", "type": "commit"}]}