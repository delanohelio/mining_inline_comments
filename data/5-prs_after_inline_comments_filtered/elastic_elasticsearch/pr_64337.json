{"pr_number": 64337, "pr_title": " Do not skip not available shard exception in search response", "pr_createdAt": "2020-10-29T12:42:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64337", "timeline": [{"oid": "2310c2f295236e1092add55191f1364c6bc3e3c8", "url": "https://github.com/elastic/elasticsearch/commit/2310c2f295236e1092add55191f1364c6bc3e3c8", "message": " Do not skip not available shard exception in search response\n\n Today search responses do not report failures for shard that were not available\n for the search.\n So if one shard is not assigned on a search over 5 shards, the\n search response will report:\n\n ```\n \"_shards\": {\n    \"total\": 5,\n    \"successful\": 4,\n    \"skipped\": 0,\n    \"failed\": 0\n}\n```\n\nIf all shards are unassigned, we report a generic search phase exception with no cause.\nIt's easy to spot that `successful` is less than `total` in the response but not reporting\nthe failure is misleading for users.\n\nThis change removes the special handling of not available shards exception in search responses\nand treat them as any other failure that could occur on a shard.\nThese exceptions will count in the `failed` section and will be reported in details in\nthe `shard_failures` section.\nIf all shards are unavailable, the search API will now return 404 NOT_FOUND as an indication\nthat the search failed because it couldn't find any of the resources.\n\nCloses #47700", "committedDate": "2020-10-29T12:41:03Z", "type": "commit"}, {"oid": "ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d", "url": "https://github.com/elastic/elasticsearch/commit/ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d", "message": "fix error status code in test", "committedDate": "2020-10-29T13:11:39Z", "type": "commit"}, {"oid": "5ae20cc1b2dbc16b0632a2f003f4501445ecf93a", "url": "https://github.com/elastic/elasticsearch/commit/5ae20cc1b2dbc16b0632a2f003f4501445ecf93a", "message": "fix transform test case", "committedDate": "2020-10-29T20:24:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MDUxNA==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514260514", "bodyText": "The many different shard not available exceptions have a variety of rest status codes. I wonder if it is best to wrap them or just create a NoShardAvailableActionException with the message from the inner exception - to get a 503 out every time. Otherwise we risk seeing among others a 400 NOT FOUND, which is a bit weird. Also, whether the shard was unavailable at the beginning of search or we detected it during the first phase of search is largely irrelevant to clients I think, using the same exception in all those cases could allow clients to filter out those specific errors if they want to.", "author": "henningandersen", "createdAt": "2020-10-29T13:33:07Z", "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -437,10 +437,10 @@ protected void onShardGroupFailure(int shardIndex, SearchShardTarget shardTarget\n      * @param e the failure reason\n      */\n     @Override\n-    public final void onShardFailure(final int shardIndex, @Nullable SearchShardTarget shardTarget, Exception e) {\n-        // we don't aggregate shard failures on non active shards and failures due to the internal cancellation,\n+    public final void onShardFailure(final int shardIndex, SearchShardTarget shardTarget, Exception e) {\n+        // we don't aggregate shard on failures due to the internal cancellation,\n         // but do keep the header counts right\n-        if (TransportActions.isShardNotAvailableException(e) == false && (requestCancelled.get() && isTaskCancelledException(e)) == false) {\n+        if ((requestCancelled.get() && isTaskCancelledException(e)) == false) {", "originalCommit": "ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3NzkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514977906", "bodyText": "++, I pushed 1427b5c that creates a NoShardAvailableActionException with the message from the inner exception.", "author": "jimczi", "createdAt": "2020-10-30T09:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MDUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMzMwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514913305", "bodyText": "Could we also validate that a failure is returned here in the failures field (as well as it being the right kind of failure)?", "author": "henningandersen", "createdAt": "2020-10-30T07:29:10Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/basic/SearchRedStateIndexIT.java", "diffHunk": "@@ -52,7 +54,7 @@ public void testAllowPartialsWithRedState() throws Exception {\n         SearchResponse searchResponse = client().prepareSearch().setSize(0).setAllowPartialSearchResults(true)\n                 .get();\n         assertThat(RestStatus.OK, equalTo(searchResponse.status()));\n-        assertThat(\"Expect no shards failed\", searchResponse.getFailedShards(), equalTo(0));\n+        assertThat(\"Expect some shards failed\", searchResponse.getFailedShards(), allOf(greaterThan(0), lessThanOrEqualTo(numShards)));", "originalCommit": "5ae20cc1b2dbc16b0632a2f003f4501445ecf93a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3ODA5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514978092", "bodyText": "I pushed 1427b5c", "author": "jimczi", "createdAt": "2020-10-30T09:46:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMzMwNQ=="}], "type": "inlineReview"}, {"oid": "1427b5c1dde9e716c161f296b46a2e50aea3342a", "url": "https://github.com/elastic/elasticsearch/commit/1427b5c1dde9e716c161f296b46a2e50aea3342a", "message": "apply review comment", "committedDate": "2020-10-30T09:44:35Z", "type": "commit"}, {"oid": "ce3b4e65eca2f03abede78dbe3680c814d971e45", "url": "https://github.com/elastic/elasticsearch/commit/ce3b4e65eca2f03abede78dbe3680c814d971e45", "message": "Merge branch 'master' into not_available_shards_search", "committedDate": "2020-10-30T15:01:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1ODExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r517258119", "bodyText": "I think we can now add an assertion to the constructor that shardFailures.length + successfullShards == totalShards?", "author": "henningandersen", "createdAt": "2020-11-04T10:52:46Z", "path": "server/src/main/java/org/elasticsearch/action/search/SearchResponse.java", "diffHunk": "@@ -204,8 +204,6 @@ public int getSkippedShards() {\n      * The failed number of shards the search was executed on.\n      */\n     public int getFailedShards() {\n-        // we don't return totalShards - successfulShards, we don't count \"no shards available\" as a failed shard, just don't", "originalCommit": "ce3b4e65eca2f03abede78dbe3680c814d971e45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MDQ5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r517970499", "bodyText": "We use the SearchResponse as partial response in _async_search so that's not possible.\nThis change is useful though because it clarifies that shardFailures.length + successfullShards != totalShards represents a partial response where some shard requests are still in-flight.", "author": "jimczi", "createdAt": "2020-11-05T11:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1ODExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIyNjg4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r521226883", "bodyText": "Ah, ok. Perhaps we can add the assertion at the callsites creating the full SearchResponse instead? Like AbstractSearchAsyncAction.buildSearchResponse.", "author": "henningandersen", "createdAt": "2020-11-11T09:28:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1ODExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2NDIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r529264239", "bodyText": "Added in 2354165", "author": "jimczi", "createdAt": "2020-11-24T07:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1ODExOQ=="}], "type": "inlineReview"}, {"oid": "9615dde82525d47db9de89c2492aa5ac796ce88d", "url": "https://github.com/elastic/elasticsearch/commit/9615dde82525d47db9de89c2492aa5ac796ce88d", "message": "Merge branch 'master' into not_available_shards_search", "committedDate": "2020-11-05T11:05:55Z", "type": "commit"}, {"oid": "31a3eebfecf8ebda32e7ca08d84b156ca887f8b0", "url": "https://github.com/elastic/elasticsearch/commit/31a3eebfecf8ebda32e7ca08d84b156ca887f8b0", "message": "Merge branch 'master' into not_available_shards_search", "committedDate": "2020-11-20T11:18:36Z", "type": "commit"}, {"oid": "235416573feb3cae1b85b52417a6f1eaa6ce2edf", "url": "https://github.com/elastic/elasticsearch/commit/235416573feb3cae1b85b52417a6f1eaa6ce2edf", "message": "add assert in AbstractSearchAsyncAction#buildSearchResponse", "committedDate": "2020-11-20T11:26:05Z", "type": "commit"}, {"oid": "f093ed5da5d62a1d8321d0f162b949f0b04011a3", "url": "https://github.com/elastic/elasticsearch/commit/f093ed5da5d62a1d8321d0f162b949f0b04011a3", "message": "remove noop tests", "committedDate": "2020-11-20T17:35:02Z", "type": "commit"}]}