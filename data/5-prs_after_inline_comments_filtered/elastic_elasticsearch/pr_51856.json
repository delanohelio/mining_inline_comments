{"pr_number": 51856, "pr_title": "SQL: Handle uberjar scenario where the ES jdbc driver file is bundled in another jar", "pr_createdAt": "2020-02-04T10:36:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51856", "timeline": [{"oid": "a132138f18b064aa54a193a0da1d65ec8b35831d", "url": "https://github.com/elastic/elasticsearch/commit/a132138f18b064aa54a193a0da1d65ec8b35831d", "message": "Handle uberjar scenario where the ES jdbc driver file is bundled\ninside another jar file.", "committedDate": "2020-02-04T12:26:19Z", "type": "commit"}, {"oid": "a132138f18b064aa54a193a0da1d65ec8b35831d", "url": "https://github.com/elastic/elasticsearch/commit/a132138f18b064aa54a193a0da1d65ec8b35831d", "message": "Handle uberjar scenario where the ES jdbc driver file is bundled\ninside another jar file.", "committedDate": "2020-02-04T12:26:19Z", "type": "forcePushed"}, {"oid": "77cb232a107de761031afbbe68799610a28c1c28", "url": "https://github.com/elastic/elasticsearch/commit/77cb232a107de761031afbbe68799610a28c1c28", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl", "committedDate": "2020-02-04T12:27:55Z", "type": "commit"}, {"oid": "0035ed2e1f52c17aadf4c6b9710b5897d2fd3e4d", "url": "https://github.com/elastic/elasticsearch/commit/0035ed2e1f52c17aadf4c6b9710b5897d2fd3e4d", "message": "Disable caches for jar url connection creation, to prevent locks being\nkept alive in Windows", "committedDate": "2020-02-04T14:35:45Z", "type": "commit"}, {"oid": "1423fda171ebde1b08298fc769617a87403f003e", "url": "https://github.com/elastic/elasticsearch/commit/1423fda171ebde1b08298fc769617a87403f003e", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl", "committedDate": "2020-02-04T14:36:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcxMjUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374712537", "bodyText": "Should we add a finally block to close the conn ?\n(Maybe JarInputStream 's close() takes care of that, just wondering if we should be extra safe here)", "author": "matriv", "createdAt": "2020-02-04T14:46:26Z", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -86,26 +87,34 @@ public static Version fromString(String version) {\n         // This is similar to how Elasticsearch's Build class digs up its build information.\n         // Since version info is not critical, the parsing is lenient\n         URL url = Version.class.getProtectionDomain().getCodeSource().getLocation();\n-        String urlStr = url.toString();\n+        CURRENT = extractVersion(url);\n+    }\n \n+    static Version extractVersion(URL url) {\n+        String urlStr = url.toString();\n         byte maj = 0, min = 0, rev = 0;\n         String ver = \"Unknown\";\n         String hash = ver;\n-\n-        if (urlStr.endsWith(\".jar\")) {\n-            try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                Manifest manifest = jar.getManifest();\n-                hash = manifest.getMainAttributes().getValue(\"Change\");\n-                ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                byte[] vers = from(ver);\n-                maj = vers[0];\n-                min = vers[1];\n-                rev = vers[2];\n+        \n+        if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n+            try {\n+                URLConnection conn = url.openConnection();\n+                conn.setUseCaches(false);\n+                \n+                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                    Manifest manifest = jar.getManifest();\n+                    hash = manifest.getMainAttributes().getValue(\"Change\");\n+                    ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n+                    byte[] vers = from(ver);\n+                    maj = vers[0];\n+                    min = vers[1];\n+                    rev = vers[2];\n+                }\n             } catch (Exception ex) {\n                 throw new IllegalArgumentException(\"Detected Elasticsearch JDBC jar but cannot retrieve its version\", ex);\n             }", "originalCommit": "1423fda171ebde1b08298fc769617a87403f003e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcxODI1NA==", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374718254", "bodyText": "I don't think it's needed to close the URLConnection (actually, the class doesn't have a method to close/terminate it), only its stream: https://docs.oracle.com/javase/tutorial/networking/urls/readingWriting.html", "author": "astefan", "createdAt": "2020-02-04T14:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcxMjUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyNDM4NA==", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374824384", "bodyText": "I know this is unmodified code, however, it's noteworthy that server/src/main/java/org/elasticsearch/Version.java parses ints, not bytes. Not sure if that's because it later does some int maths with the components, or because it reserves the possibility to use some tagging values at some point (like 7.2.222 for a special release). Just mentioning it, should we ever want to align this.", "author": "bpintea", "createdAt": "2020-02-04T17:48:03Z", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -86,26 +87,34 @@ public static Version fromString(String version) {\n         // This is similar to how Elasticsearch's Build class digs up its build information.\n         // Since version info is not critical, the parsing is lenient\n         URL url = Version.class.getProtectionDomain().getCodeSource().getLocation();\n-        String urlStr = url.toString();\n+        CURRENT = extractVersion(url);\n+    }\n \n+    static Version extractVersion(URL url) {\n+        String urlStr = url.toString();\n         byte maj = 0, min = 0, rev = 0;\n         String ver = \"Unknown\";\n         String hash = ver;\n-\n-        if (urlStr.endsWith(\".jar\")) {\n-            try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                Manifest manifest = jar.getManifest();\n-                hash = manifest.getMainAttributes().getValue(\"Change\");\n-                ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                byte[] vers = from(ver);\n-                maj = vers[0];\n-                min = vers[1];\n-                rev = vers[2];\n+        \n+        if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n+            try {\n+                URLConnection conn = url.openConnection();\n+                conn.setUseCaches(false);\n+                \n+                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                    Manifest manifest = jar.getManifest();\n+                    hash = manifest.getMainAttributes().getValue(\"Change\");\n+                    ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n+                    byte[] vers = from(ver);", "originalCommit": "1423fda171ebde1b08298fc769617a87403f003e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyNDQ2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374824469", "bodyText": "Given it's a test, this is completely optional: extract the \"es-sql-jdbc.jar\" into a final var and reuse that below.", "author": "bpintea", "createdAt": "2020-02-04T17:48:13Z", "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/VersionTests.java", "diffHunk": "@@ -43,4 +53,44 @@ public void testInvalidVersion() {\n         IllegalArgumentException err = expectThrows(IllegalArgumentException.class, () -> Version.from(\"7.1\"));\n         assertEquals(\"Invalid version 7.1\", err.getMessage());\n     }\n+    \n+    public void testVersionFromJarInJar() throws IOException {\n+        Path dir = createTempDir();\n+        Path jarPath = dir.resolve(\"foo.jar\");              // simulated uberjar containing the jdbc driver\n+        Path innerJarPath = dir.resolve(\"es-sql-jdbc.jar\"); // simulated ES JDBC driver file", "originalCommit": "1423fda171ebde1b08298fc769617a87403f003e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "265430471233fc829d129d711bec6a3cd6a05f79", "url": "https://github.com/elastic/elasticsearch/commit/265430471233fc829d129d711bec6a3cd6a05f79", "message": "Address feedback", "committedDate": "2020-02-06T16:41:21Z", "type": "commit"}, {"oid": "aa653ef460565c7f801f6309cf4b963bb0d50f25", "url": "https://github.com/elastic/elasticsearch/commit/aa653ef460565c7f801f6309cf4b963bb0d50f25", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl", "committedDate": "2020-02-06T16:41:35Z", "type": "commit"}, {"oid": "d8f64b8fe32cadd32cd75ac8a23e907118ee5d65", "url": "https://github.com/elastic/elasticsearch/commit/d8f64b8fe32cadd32cd75ac8a23e907118ee5d65", "message": "Merge branch 'master' into 50201_impl", "committedDate": "2020-02-07T00:36:20Z", "type": "commit"}]}