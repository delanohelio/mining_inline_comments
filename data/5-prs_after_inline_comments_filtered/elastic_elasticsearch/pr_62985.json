{"pr_number": 62985, "pr_title": "Introduce yamlRestCompatTest task and plugin. ", "pr_createdAt": "2020-09-28T22:02:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62985", "timeline": [{"oid": "f100cb05e9fb65093362dce9fdf93583c8b8b17b", "url": "https://github.com/elastic/elasticsearch/commit/f100cb05e9fb65093362dce9fdf93583c8b8b17b", "message": "initial commit", "committedDate": "2020-09-24T13:59:27Z", "type": "commit"}, {"oid": "42372d5e60871e65166d8ec8b00394016619acb2", "url": "https://github.com/elastic/elasticsearch/commit/42372d5e60871e65166d8ec8b00394016619acb2", "message": "add missing file", "committedDate": "2020-09-24T18:46:24Z", "type": "commit"}, {"oid": "339695ef6297ceb1e9e6c07482e76b3eabd6ba7e", "url": "https://github.com/elastic/elasticsearch/commit/339695ef6297ceb1e9e6c07482e76b3eabd6ba7e", "message": "wip", "committedDate": "2020-09-24T19:30:35Z", "type": "commit"}, {"oid": "ef6bc3c60d752195989bfd35bf7026627301fd87", "url": "https://github.com/elastic/elasticsearch/commit/ef6bc3c60d752195989bfd35bf7026627301fd87", "message": "remove plugin that layers in", "committedDate": "2020-09-24T21:18:21Z", "type": "commit"}, {"oid": "96245d72010000256378e12dae732fac51d57b84", "url": "https://github.com/elastic/elasticsearch/commit/96245d72010000256378e12dae732fac51d57b84", "message": "use copy resources", "committedDate": "2020-09-28T21:19:57Z", "type": "commit"}, {"oid": "24aa85387e2bfd542772ba69bc88f8efd42d09d3", "url": "https://github.com/elastic/elasticsearch/commit/24aa85387e2bfd542772ba69bc88f8efd42d09d3", "message": "remove testing and remove sourceSetForOutput", "committedDate": "2020-09-28T21:32:18Z", "type": "commit"}, {"oid": "ba34a1665929cf68b2edbb64101ddd3c3b3a59ca", "url": "https://github.com/elastic/elasticsearch/commit/ba34a1665929cf68b2edbb64101ddd3c3b3a59ca", "message": "remove testing stuff", "committedDate": "2020-09-28T21:32:50Z", "type": "commit"}, {"oid": "85a26b3dd96daf2e09f139b5d465d912422bd142", "url": "https://github.com/elastic/elasticsearch/commit/85a26b3dd96daf2e09f139b5d465d912422bd142", "message": "spotless", "committedDate": "2020-09-28T21:50:16Z", "type": "commit"}, {"oid": "f3878a1ec072da9e7fc177e66121319f121566b3", "url": "https://github.com/elastic/elasticsearch/commit/f3878a1ec072da9e7fc177e66121319f121566b3", "message": "minor wording", "committedDate": "2020-09-28T22:01:02Z", "type": "commit"}, {"oid": "b6b05ce5150374b40ea2615db6915e543992eabd", "url": "https://github.com/elastic/elasticsearch/commit/b6b05ce5150374b40ea2615db6915e543992eabd", "message": "Merge remote-tracking branch 'upstream/master' into rest_compat_test", "committedDate": "2020-09-28T22:21:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczMjkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r496732915", "bodyText": "This is needed so that you can run compat tests for a project that may no longer have YAML REST tests in master. Also, there may be cases where a module is completely deleted in master, but we will still want to use this plugin to only test compatibility.\nThis basically ensures that the execution of \"compat\" YAML tests is not directly coupled to the existence of \"normal\" YAML rest tests.", "author": "jakelandis", "createdAt": "2020-09-29T13:49:38Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -58,8 +58,10 @@\n     final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n     final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n     String sourceSetName;\n+    boolean skipHasRestTestCheck;", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjczNDMwNw==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r496734307", "bodyText": "This is needed as a way to copy the 7.x module/plugin tests to the source set. For \"normal\" YAML tests they are already in the source set (since they are part of the current source code).", "author": "jakelandis", "createdAt": "2020-09-29T13:51:21Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -58,8 +58,10 @@\n     final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n     final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n     String sourceSetName;\n+    boolean skipHasRestTestCheck;\n     Configuration coreConfig;\n     Configuration xpackConfig;\n+    Configuration additionalConfig;", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDc0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r496960741", "bodyText": "Why are we peeking at the source? Instead can we produce the files as an artifact? This would allow us to test against already released versions in the same way, just grab the zip of the spec/test files of that released version.", "author": "rjernst", "createdAt": "2020-09-29T18:45:45Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.test.RestTestBasePlugin;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.testclusters.TestDistribution;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.provider.Provider;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+\n+import static org.elasticsearch.gradle.test.rest.RestTestUtil.createTestCluster;\n+import static org.elasticsearch.gradle.test.rest.RestTestUtil.setupDependencies;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests from a prior major version against this version's cluster.\n+ */\n+public class YamlRestCompatTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestCompatTest\";\n+    private static final Path RELATIVE_API_PATH = Path.of(\"rest-api-spec/api\");\n+    private static final Path RELATIVE_TEST_PATH = Path.of(\"rest-api-spec/test\");\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        project.getPluginManager().apply(RestTestBasePlugin.class);\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+        project.getPluginManager().apply(YamlRestTestPlugin.class);\n+\n+        RestResourcesExtension extension = project.getExtensions().getByType(RestResourcesExtension.class);\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlCompatTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+        SourceSet yamlTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME);\n+        GradleUtils.extendSourceSet(project, YamlRestTestPlugin.SOURCE_SET_NAME, SOURCE_SET_NAME);\n+\n+        // create the test cluster container, and always use the default distribution\n+        ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n+        testCluster.setTestDistribution(TestDistribution.DEFAULT);\n+\n+        // TODO: this is pretty fragile but the existing logic to checkout prior version branches isn't general purpose\n+        // eventually we will want to test against multiple minor versions and will need a better way to checkout an arbitrary prior branch\n+        // however, for now we will just get a reference to the checkout directory for \":distribution:bwc:minor:checkoutBwcBranch\"\n+        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n+        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n+            .getBuildDir()\n+            .toPath()\n+            .resolve(\"bwc\")\n+            .resolve(\"checkout-\" + priorMajorVersion + \".x\");", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA5MDM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497090346", "bodyText": "The artifacts we produce only contain the OSS core api and tests. I need the x-pack core api/tests as well as all of the OSS/X-pack module/plugin API/tests. Back filling those I think is a reasonable approach as a long term solution, but I think sourcing like this is decent temporary approach.", "author": "jakelandis", "createdAt": "2020-09-29T22:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU5NDEzMA==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497594130", "bodyText": "I tend to agree with @rjernst that peeking into other source folders is kind of an anti pattern. Instead sharing it declaratively as described here: https://docs.gradle.org/current/userguide/cross_project_publications.html is what we should aim for.", "author": "breskeby", "createdAt": "2020-09-30T15:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwMjI2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497602263", "bodyText": "Ideally I think the bwc project would just share the checkoutDir as an artifact. Can you put a TODO in there to look into this after #62473 I will then pick that up at one. point. This PR does quite some rework on the bwc setup", "author": "breskeby", "createdAt": "2020-09-30T15:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5NjgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497796800", "bodyText": "Thanks, exposing the checkoutDir as an artifact, I think will clean this up. I added a TODO in the code to come back to this.", "author": "jakelandis", "createdAt": "2020-09-30T20:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2MDc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwMDMzMA==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497600330", "bodyText": "We'd like to get away from using the project property within task actions. I'm currently working on #62968 Instead using project.copy{} we should inject a FileSystemOperations service and use that one for these kind of operations. See for example the LoggedExec task how this service is injected: https://github.com/elastic/elasticsearch/pull/62968/files#diff-babd4b74d83a9cea8bf0823cf6b71b66", "author": "breskeby", "createdAt": "2020-09-30T15:25:41Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -132,7 +142,7 @@ void copy() {\n         if (BuildParams.isInternal()) {\n             getLogger().debug(\"Rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n             project.copy(c -> {", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5NTk0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497795949", "bodyText": "I added some TODO's for the new project.copy's to ensure it uses the newer style once that PR lands. I didn't make the change now to avoid avoid copy/paste code from your PR (which could merge clash). If this PR beats yours then feel free to add it to your, else I will circle back to this.", "author": "jakelandis", "createdAt": "2020-09-30T20:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwMDMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwMDUxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497600519", "bodyText": "same as above", "author": "breskeby", "createdAt": "2020-09-30T15:25:54Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -164,6 +174,13 @@ void copy() {\n                 c.include(xpackPatternSet.getIncludes());\n             });\n         }\n+        // copy any additional config\n+        if (additionalConfig != null) {\n+            project.copy(c -> {", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwNjU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/62985#discussion_r497606560", "bodyText": "same here. We should not rely on file dependencies and provide these dependencies as artifacts of the bwc project.", "author": "breskeby", "createdAt": "2020-09-30T15:34:19Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.ElasticsearchJavaPlugin;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.test.RestTestBasePlugin;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.elasticsearch.gradle.testclusters.TestDistribution;\n+import org.elasticsearch.gradle.util.GradleUtils;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.provider.Provider;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+\n+import static org.elasticsearch.gradle.test.rest.RestTestUtil.createTestCluster;\n+import static org.elasticsearch.gradle.test.rest.RestTestUtil.setupDependencies;\n+\n+/**\n+ * Apply this plugin to run the YAML based REST tests from a prior major version against this version's cluster.\n+ */\n+public class YamlRestCompatTestPlugin implements Plugin<Project> {\n+\n+    public static final String SOURCE_SET_NAME = \"yamlRestCompatTest\";\n+    private static final Path RELATIVE_API_PATH = Path.of(\"rest-api-spec/api\");\n+    private static final Path RELATIVE_TEST_PATH = Path.of(\"rest-api-spec/test\");\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        project.getPluginManager().apply(ElasticsearchJavaPlugin.class);\n+        project.getPluginManager().apply(TestClustersPlugin.class);\n+        project.getPluginManager().apply(RestTestBasePlugin.class);\n+        project.getPluginManager().apply(RestResourcesPlugin.class);\n+        project.getPluginManager().apply(YamlRestTestPlugin.class);\n+\n+        RestResourcesExtension extension = project.getExtensions().getByType(RestResourcesExtension.class);\n+\n+        // create source set\n+        SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+        SourceSet yamlCompatTestSourceSet = sourceSets.create(SOURCE_SET_NAME);\n+        SourceSet yamlTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME);\n+        GradleUtils.extendSourceSet(project, YamlRestTestPlugin.SOURCE_SET_NAME, SOURCE_SET_NAME);\n+\n+        // create the test cluster container, and always use the default distribution\n+        ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n+        testCluster.setTestDistribution(TestDistribution.DEFAULT);\n+\n+        // TODO: this is pretty fragile but the existing logic to checkout prior version branches isn't general purpose\n+        // eventually we will want to test against multiple minor versions and will need a better way to checkout an arbitrary prior branch\n+        // however, for now we will just get a reference to the checkout directory for \":distribution:bwc:minor:checkoutBwcBranch\"\n+        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n+        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n+            .getBuildDir()\n+            .toPath()\n+            .resolve(\"bwc\")\n+            .resolve(\"checkout-\" + priorMajorVersion + \".x\");\n+\n+        // copy compatible rest specs\n+        Configuration compatSpec = project.getConfigurations().create(\"compatSpec\");\n+        Configuration xpackCompatSpec = project.getConfigurations().create(\"xpackCompatSpec\");\n+        Configuration additionalCompatSpec = project.getConfigurations().create(\"additionalCompatSpec\");\n+        Provider<CopyRestApiTask> copyCompatYamlSpecTask = project.getTasks()\n+            .register(\"copyRestApiCompatSpecsTask\", CopyRestApiTask.class, task -> {\n+                task.includeCore.set(extension.restApi.getIncludeCore());\n+                task.includeXpack.set(extension.restApi.getIncludeXpack());\n+                task.sourceSetName = SOURCE_SET_NAME;\n+                task.skipHasRestTestCheck = true;\n+                task.coreConfig = compatSpec;\n+                project.getDependencies()\n+                    .add(\n+                        task.coreConfig.getName(),\n+                        project.files(checkoutDir.resolve(\"rest-api-spec/src/main/resources\").resolve(RELATIVE_API_PATH))", "originalCommit": "b6b05ce5150374b40ea2615db6915e543992eabd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "428babb190d099562b4c2ca9a8562f0ce5ea3114", "url": "https://github.com/elastic/elasticsearch/commit/428babb190d099562b4c2ca9a8562f0ce5ea3114", "message": "clean up TODO's", "committedDate": "2020-09-30T20:47:39Z", "type": "commit"}, {"oid": "d0ebbcd16339ff7228bd587e5fa03bfea7cf5ccc", "url": "https://github.com/elastic/elasticsearch/commit/d0ebbcd16339ff7228bd587e5fa03bfea7cf5ccc", "message": "add another TODO", "committedDate": "2020-09-30T20:51:11Z", "type": "commit"}, {"oid": "f03894ee0f946858543714bbe9a62c5969dfc854", "url": "https://github.com/elastic/elasticsearch/commit/f03894ee0f946858543714bbe9a62c5969dfc854", "message": "spotless", "committedDate": "2020-09-30T21:02:17Z", "type": "commit"}]}