{"pr_number": 63998, "pr_title": "Remove QueryShardContext#getMapperService", "pr_createdAt": "2020-10-21T12:41:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63998", "timeline": [{"oid": "7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5", "url": "https://github.com/elastic/elasticsearch/commit/7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5", "message": "Remove QueryShardContext#getMapperService\n\nWe have been removing usages of getMapperService with the purpose of removing the method at some point. This is so we don't have to expose the entire MapperService to all of the users of QueryShardContext, but rather only specific methods so we can better control its usages, especially around resolving field types.\n\nThis commit removes the last few usages and adds the missing methods to QueryShardContext. They all revolve around retrieving DocumentMapper from MapperService, yet we can expose specific methods without even exposing DocumentMapper, which would also cause issues.", "committedDate": "2020-10-21T12:39:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA==", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509249694", "bodyText": "This is only used for the RandomScoreFunctionBuilder, correct?  Do we need to add it, or can we just remove that 'no mappings' special case?", "author": "romseygeek", "createdAt": "2020-10-21T12:49:58Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -216,6 +221,23 @@ public void addNamedQuery(String name, Query query) {\n         return Map.copyOf(namedQueries);\n     }\n \n+    public ParsedDocument parseDocument(SourceToParse source) throws MapperParsingException {\n+        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().parse(source);\n+    }\n+\n+    public FieldNameAnalyzer getFieldNameIndexAnalyzer() {\n+        DocumentMapper documentMapper = mapperService.documentMapper();\n+        return documentMapper == null ? null : documentMapper.mappers().indexAnalyzer();\n+    }\n+\n+    public boolean hasNested() {\n+        return mapperService.hasNested();\n+    }\n+\n+    public boolean hasMappings() {\n+        return mapperService.documentMapper() != null;\n+    }", "originalCommit": "7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1MTkzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509251938", "bodyText": "yes that is surprisingly the only usage. but I don't feel comfortable removing that no mappings special case. I think it's legit, although annoying to support, and we test it.", "author": "javanna", "createdAt": "2020-10-21T12:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY0MTExNg==", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509641116", "bodyText": "@romseygeek are you ok with this or maybe do you have other ideas?", "author": "javanna", "createdAt": "2020-10-21T20:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk1MDk3NA==", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509950974", "bodyText": "Let's leave it in for now, if we decide to go with a no-op mapper by default in MapperService we can remove it then.", "author": "romseygeek", "createdAt": "2020-10-22T07:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk2MDU5OA==", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509960598", "bodyText": "true, I will try that idea very soon.", "author": "javanna", "createdAt": "2020-10-22T08:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA=="}], "type": "inlineReview"}, {"oid": "36dea78a5e8c53c910b9784438a2739a83758aba", "url": "https://github.com/elastic/elasticsearch/commit/36dea78a5e8c53c910b9784438a2739a83758aba", "message": "iter", "committedDate": "2020-10-21T13:18:14Z", "type": "commit"}]}