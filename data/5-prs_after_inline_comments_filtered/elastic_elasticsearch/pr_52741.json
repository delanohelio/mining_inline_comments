{"pr_number": 52741, "pr_title": "Move states of search to coordinating node", "pr_createdAt": "2020-02-25T03:49:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52741", "timeline": [{"oid": "6e6fbee52b945d76f360d0ec7bc7e2380b604a4c", "url": "https://github.com/elastic/elasticsearch/commit/6e6fbee52b945d76f360d0ec7bc7e2380b604a4c", "message": "Move search state to coordinating node", "committedDate": "2020-02-25T03:14:08Z", "type": "commit"}, {"oid": "f8c7e4e8aa15a3d0676b7d0105fe789c36cb6b76", "url": "https://github.com/elastic/elasticsearch/commit/f8c7e4e8aa15a3d0676b7d0105fe789c36cb6b76", "message": "Register percolator plugin", "committedDate": "2020-02-26T16:51:29Z", "type": "commit"}, {"oid": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "url": "https://github.com/elastic/elasticsearch/commit/1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "message": "Merge branch 'feature/reader-context' into stateless-search-context", "committedDate": "2020-02-26T16:52:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NDI4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r385674287", "bodyText": "Is this change needed for this pr ? It seems unrelated.", "author": "jimczi", "createdAt": "2020-02-28T12:41:22Z", "path": "modules/percolator/src/test/java/org/elasticsearch/percolator/PercolatorQuerySearchIT.java", "diffHunk": "@@ -71,6 +75,14 @@\n \n public class PercolatorQuerySearchIT extends ESIntegTestCase {\n \n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        List<Class<? extends Plugin>> plugins = new ArrayList<>();\n+        plugins.addAll(super.nodePlugins());\n+        plugins.add(PercolatorPlugin.class);\n+        return plugins;\n+    }\n+", "originalCommit": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwODk3MA==", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r387208970", "bodyText": "The problem is that MockNioTransport does not register NamedWriteables from the bundled plugins. We need to manually register the percolate plugin in the test as we now de/serialize the Percolate QueryBuilder between search phases. I looked into how to fix this issue, but it should be in a follow-up.", "author": "dnhatn", "createdAt": "2020-03-03T18:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NDI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NjA1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r385676057", "bodyText": "we could apply the TODO here and clean the (de)serialization ? This would mean reconciling the logic between the different implementations and move the serialization of the object accessible here to this function. Happy to do this in a follow up though.", "author": "jimczi", "createdAt": "2020-02-28T12:45:33Z", "path": "server/src/main/java/org/elasticsearch/search/SearchPhaseResult.java", "diffHunk": "@@ -90,6 +94,23 @@ public QuerySearchResult queryResult() {\n      */\n     public FetchSearchResult fetchResult() { return null; }\n \n+    @Nullable\n+    public ShardSearchRequest getShardSearchRequest() {\n+        return shardSearchRequest;\n+    }\n+\n+    public void setShardSearchRequest(ShardSearchRequest shardSearchRequest) {\n+        this.shardSearchRequest = shardSearchRequest;\n+    }\n+\n+    public RescoreDocIds getRescoreDocIds() {\n+        return rescoreDocIds;\n+    }\n+\n+    public void setRescoreDocIds(RescoreDocIds rescoreDocIds) {\n+        this.rescoreDocIds = rescoreDocIds;\n+    }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         // TODO: this seems wrong, SearchPhaseResult should have a writeTo?", "originalCommit": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwOTEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r387209101", "bodyText": "++. I will do this in a follow-up.", "author": "dnhatn", "createdAt": "2020-03-03T18:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NjA1Nw=="}], "type": "inlineReview"}, {"oid": "f1ba9dd2495d0ddacd0270b27c9a7ad6581db192", "url": "https://github.com/elastic/elasticsearch/commit/f1ba9dd2495d0ddacd0270b27c9a7ad6581db192", "message": "Merge branch 'feature/reader-context' into stateless-search-context", "committedDate": "2020-03-03T18:11:27Z", "type": "commit"}]}