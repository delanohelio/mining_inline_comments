{"pr_number": 52316, "pr_title": "Dump container logs on shell command failure", "pr_createdAt": "2020-02-13T13:02:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52316", "timeline": [{"oid": "22e78cef736df31de1acfb194107a5cffde468f2", "url": "https://github.com/elastic/elasticsearch/commit/22e78cef736df31de1acfb194107a5cffde468f2", "message": "Dump container logs on shell command failure\n\nThe Docker tests framework captures container logs when Elasticsearch\nfails to start. However, it doesn't do this if a later shell command\nfails. Amend the DockerShell wrapper to capture the container logs if\na command fails when it should succeed.", "committedDate": "2020-02-13T12:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MjA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52316#discussion_r379142041", "bodyText": "We lose the original exception in this scenario and effectively replace it with one about not being able to fetch logs. We should probably still rethrow the original exception and maybe add this one as a suppressed exception.", "author": "mark-vieira", "createdAt": "2020-02-13T21:57:50Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -291,6 +291,22 @@ public static void copyFromContainer(Path from, Path to) {\n \n             return super.getScriptCommand(\"docker exec --user elasticsearch:root --tty \" + containerId + \" \" + script);\n         }\n+\n+        @Override\n+        public Result run(String script) {\n+            try {\n+                return super.run(script);\n+            } catch (ShellException e) {\n+                try {\n+                    final Shell.Result dockerLogs = getContainerLogs();\n+                    throw new ShellException(\n+                        e.getMessage() + \"\\n\\nContainer stdout: \" + dockerLogs.stdout + \"\\n\\nContainer stderr: \" + dockerLogs.stderr\n+                    );\n+                } catch (ShellException logsException) {\n+                    throw new ShellException(\"Command failed, and couldn't get docker logs\", logsException);", "originalCommit": "22e78cef736df31de1acfb194107a5cffde468f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MjM4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52316#discussion_r379142383", "bodyText": "Even though we are logging the original exception message, we should still add it as the cause to this one, otherwise we lose the original call site stacktrace.", "author": "mark-vieira", "createdAt": "2020-02-13T21:58:32Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -291,6 +291,22 @@ public static void copyFromContainer(Path from, Path to) {\n \n             return super.getScriptCommand(\"docker exec --user elasticsearch:root --tty \" + containerId + \" \" + script);\n         }\n+\n+        @Override\n+        public Result run(String script) {\n+            try {\n+                return super.run(script);\n+            } catch (ShellException e) {\n+                try {\n+                    final Shell.Result dockerLogs = getContainerLogs();\n+                    throw new ShellException(\n+                        e.getMessage() + \"\\n\\nContainer stdout: \" + dockerLogs.stdout + \"\\n\\nContainer stderr: \" + dockerLogs.stderr", "originalCommit": "22e78cef736df31de1acfb194107a5cffde468f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0NTIzOA==", "url": "https://github.com/elastic/elasticsearch/pull/52316#discussion_r379245238", "bodyText": "Why are we catching an exception we just threw on the line above? It seems like we are adding an additional stack frame, why?", "author": "rjernst", "createdAt": "2020-02-14T04:23:31Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -291,6 +291,22 @@ public static void copyFromContainer(Path from, Path to) {\n \n             return super.getScriptCommand(\"docker exec --user elasticsearch:root --tty \" + containerId + \" \" + script);\n         }\n+\n+        @Override\n+        public Result run(String script) {\n+            try {\n+                return super.run(script);\n+            } catch (ShellException e) {\n+                try {\n+                    final Shell.Result dockerLogs = getContainerLogs();\n+                    throw new ShellException(\n+                        e.getMessage() + \"\\n\\nContainer stdout: \" + dockerLogs.stdout + \"\\n\\nContainer stderr: \" + dockerLogs.stderr\n+                    );\n+                } catch (ShellException logsException) {", "originalCommit": "22e78cef736df31de1acfb194107a5cffde468f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c31c7f017ae2abd684ca9152de2c488ad0114ba", "url": "https://github.com/elastic/elasticsearch/commit/1c31c7f017ae2abd684ca9152de2c488ad0114ba", "message": "Throw original exception docker logs capture\n\nWhen DockerShell.run() catches a ShellException, dump out the logs and\nthen rethrow the exception, rather than wrapping the original exception.", "committedDate": "2020-02-14T16:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU2NjE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52316#discussion_r379566149", "bodyText": "This is losing the stack trace of the nested exception. Instead we should attach this as a suppressed exception to the original exception", "author": "rjernst", "createdAt": "2020-02-14T17:56:30Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -291,6 +291,36 @@ public static void copyFromContainer(Path from, Path to) {\n \n             return super.getScriptCommand(\"docker exec --user elasticsearch:root --tty \" + containerId + \" \" + script);\n         }\n+\n+        /**\n+         * Overrides {@link Shell#run(String)} to attempt to collect Docker container\n+         * logs when a command fails to execute successfully.\n+         * @param script the command to run\n+         * @return the command's output\n+         */\n+        @Override\n+        public Result run(String script) {\n+            try {\n+                return super.run(script);\n+            } catch (ShellException e) {\n+                try {\n+                    final Shell.Result dockerLogs = getContainerLogs();\n+                    logger.error(\n+                        \"Command [{}] failed.\\n\\nContainer stdout: [{}]\\n\\nContainer stderr: [{}]\",\n+                        script,\n+                        dockerLogs.stdout,\n+                        dockerLogs.stderr\n+                    );\n+                } catch (ShellException shellException) {\n+                    logger.error(\n+                        \"Command [{}] failed.\\n\\nTried to dump container logs but that failed too: [{}]\",\n+                        script,\n+                        shellException.getMessage()", "originalCommit": "1c31c7f017ae2abd684ca9152de2c488ad0114ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}