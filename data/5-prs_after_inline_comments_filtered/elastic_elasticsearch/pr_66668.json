{"pr_number": 66668, "pr_title": "Assign id to searcher using ids of segments", "pr_createdAt": "2020-12-20T22:20:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66668", "timeline": [{"oid": "89704d82772c12cc9001ceacd2e4533845782085", "url": "https://github.com/elastic/elasticsearch/commit/89704d82772c12cc9001ceacd2e4533845782085", "message": "Generate searcher's commit id from ids of segments", "committedDate": "2020-12-20T23:19:51Z", "type": "commit"}, {"oid": "89704d82772c12cc9001ceacd2e4533845782085", "url": "https://github.com/elastic/elasticsearch/commit/89704d82772c12cc9001ceacd2e4533845782085", "message": "Generate searcher's commit id from ids of segments", "committedDate": "2020-12-20T23:19:51Z", "type": "forcePushed"}, {"oid": "eae1cb162b442ed0ea32fd447fef64f42762dbfc", "url": "https://github.com/elastic/elasticsearch/commit/eae1cb162b442ed0ea32fd447fef64f42762dbfc", "message": "wording", "committedDate": "2020-12-21T02:32:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5NTQ0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546595441", "bodyText": "Does this assume that the snapshot is mounted with replicas? Otherwise I am not sure we will hit this line.\nNotice that searchable snapshots by default mount with 0 replicas. Perhaps randomly add IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1 to settings when mounting?", "author": "henningandersen", "createdAt": "2020-12-21T09:22:34Z", "path": "x-pack/plugin/searchable-snapshots/src/internalClusterTest/java/org/elasticsearch/xpack/searchablesnapshots/RetrySearchIntegTests.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.searchablesnapshots;\n+\n+import org.elasticsearch.action.index.IndexRequestBuilder;\n+import org.elasticsearch.cluster.metadata.IndexMetadata;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.IndexService;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.indices.IndicesService;\n+import org.elasticsearch.snapshots.SnapshotId;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Set;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class RetrySearchIntegTests extends BaseSearchableSnapshotsIntegTestCase {\n+\n+    public void testSearcherId() throws Exception {\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final int numberOfShards = between(1, 5);\n+        assertAcked(\n+            client().admin()\n+                .indices()\n+                .prepareCreate(indexName)\n+                .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, numberOfShards).build())\n+                .setMapping(\"{\\\"properties\\\":{\\\"created_date\\\":{\\\"type\\\": \\\"date\\\", \\\"format\\\": \\\"yyyy-MM-dd\\\"}}}\")\n+        );\n+        final List<IndexRequestBuilder> indexRequestBuilders = new ArrayList<>();\n+        final int docCount = between(0, 100);\n+        for (int i = 0; i < docCount; i++) {\n+            indexRequestBuilders.add(client().prepareIndex(indexName).setSource(\"created_date\", \"2011-02-02\"));\n+        }\n+        indexRandom(true, false, indexRequestBuilders);\n+        assertThat(\n+            client().admin().indices().prepareForceMerge(indexName).setOnlyExpungeDeletes(true).setFlush(true).get().getFailedShards(),\n+            equalTo(0)\n+        );\n+        refresh(indexName);\n+        forceMerge();\n+\n+        final String repositoryName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        createRepository(repositoryName, \"fs\");\n+\n+        final SnapshotId snapshotOne = createSnapshot(repositoryName, \"snapshot-1\", List.of(indexName)).snapshotId();\n+        assertAcked(client().admin().indices().prepareDelete(indexName));\n+\n+        mountSnapshot(repositoryName, snapshotOne.getName(), indexName, indexName, Settings.EMPTY);\n+        ensureGreen(indexName);\n+\n+        final String[] searcherIds = new String[numberOfShards];\n+        Set<String> allocatedNodes = internalCluster().nodesInclude(indexName);\n+        for (String node : allocatedNodes) {\n+            IndexService indexService = internalCluster().getInstance(IndicesService.class, node).indexServiceSafe(resolveIndex(indexName));\n+            for (IndexShard indexShard : indexService) {\n+                try (Engine.SearcherSupplier searcher = indexShard.acquireSearcherSupplier()) {\n+                    assertNotNull(searcher.getCommitId());\n+                    if (searcherIds[indexShard.shardId().id()] != null) {\n+                        assertThat(searcher.getCommitId(), equalTo(searcherIds[indexShard.shardId().id()]));", "originalCommit": "eae1cb162b442ed0ea32fd447fef64f42762dbfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcxNzU1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546717557", "bodyText": "Good catch. I pushed bba8f04", "author": "dnhatn", "createdAt": "2020-12-21T13:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5NTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwNTgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546605807", "bodyText": "I wonder if we should rename the method to getSearcherId(), just like you did for the test case? Since it is no longer a commit-id, it might be a confusing name.", "author": "henningandersen", "createdAt": "2020-12-21T09:44:34Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/state/CloseIndexIT.java", "diffHunk": "@@ -486,19 +488,42 @@ public void testCommitIdInSearcher() throws Exception {\n         assertAcked(client().admin().indices().prepareClose(indexName));\n         assertIndexIsClosed(indexName);\n         ensureGreen(indexName);\n-        final String nodeWithPrimary = Iterables.get(internalCluster().nodesInclude(indexName), 0);\n-        IndexShard shard = internalCluster().getInstance(IndicesService.class, nodeWithPrimary)\n-            .indexService(resolveIndex(indexName)).getShard(0);\n-        final String commitId;\n-        try (Engine.SearcherSupplier searcherSupplier = shard.acquireSearcherSupplier(randomFrom(Engine.SearcherScope.values()))) {\n-            assertNotNull(searcherSupplier.getCommitId());\n-            commitId = searcherSupplier.getCommitId();\n+        if (randomBoolean()) {\n+            assertAcked(client().admin().indices().prepareUpdateSettings(indexName)\n+                .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+            internalCluster().ensureAtLeastNumDataNodes(2);\n+            ensureGreen(indexName);\n+        }\n+        String[] searcherIds = new String[numberOfShards];\n+        Set<String> allocatedNodes = internalCluster().nodesInclude(indexName);\n+        for (String node : allocatedNodes) {\n+            IndexService indexService = internalCluster().getInstance(IndicesService.class, node).indexServiceSafe(resolveIndex(indexName));\n+            for (IndexShard shard : indexService) {\n+                try (Engine.SearcherSupplier searcher = shard.acquireSearcherSupplier()) {\n+                    assertNotNull(searcher.getCommitId());", "originalCommit": "eae1cb162b442ed0ea32fd447fef64f42762dbfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcxNzQxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546717411", "bodyText": "++, I adjusted it in d2f7854", "author": "dnhatn", "createdAt": "2020-12-21T13:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwNTgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwODgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546608800", "bodyText": "Maybe name this lastSearcherId?", "author": "henningandersen", "createdAt": "2020-12-21T09:50:45Z", "path": "server/src/test/java/org/elasticsearch/index/engine/ReadOnlyEngineTests.java", "diffHunk": "@@ -294,4 +296,40 @@ public void testTranslogStats() throws IOException {\n             }\n         }\n     }\n+\n+    public void testSearcherId() throws Exception {\n+        IOUtils.close(engine, store);\n+        AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);\n+        try (Store store = createStore()) {\n+            final EngineConfig config =\n+                config(defaultSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null, null, globalCheckpoint::get);\n+            String lastCommitId;", "originalCommit": "eae1cb162b442ed0ea32fd447fef64f42762dbfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcxNzY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66668#discussion_r546717645", "bodyText": "Yes, see a6abd00", "author": "dnhatn", "createdAt": "2020-12-21T13:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwODgwMA=="}], "type": "inlineReview"}, {"oid": "d2f78544003a1d9c5e56a5148b96b5d60bc1f0ff", "url": "https://github.com/elastic/elasticsearch/commit/d2f78544003a1d9c5e56a5148b96b5d60bc1f0ff", "message": "commitId -> searcherId", "committedDate": "2020-12-21T13:44:12Z", "type": "commit"}, {"oid": "bba8f04d97163dda9097e0540b9025adf81b8b5d", "url": "https://github.com/elastic/elasticsearch/commit/bba8f04d97163dda9097e0540b9025adf81b8b5d", "message": "mount searchable snapshot with replicas", "committedDate": "2020-12-21T13:46:18Z", "type": "commit"}, {"oid": "a6abd00ee05beb03ad281e8b87faa42e5e4e15b2", "url": "https://github.com/elastic/elasticsearch/commit/a6abd00ee05beb03ad281e8b87faa42e5e4e15b2", "message": "lastCommitId -> lastSearcherId", "committedDate": "2020-12-21T13:52:00Z", "type": "commit"}]}