{"pr_number": 56620, "pr_title": "Cancel task and descendants on channel disconnects", "pr_createdAt": "2020-05-12T17:19:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56620", "timeline": [{"oid": "59f50a020e072f8813b7367ed6e9fd0284de8e22", "url": "https://github.com/elastic/elasticsearch/commit/59f50a020e072f8813b7367ed6e9fd0284de8e22", "message": "Cancel task and descendants on channel disconnects", "committedDate": "2020-05-12T16:54:33Z", "type": "commit"}, {"oid": "d92ef102c68b753266218518de777c02d15d1cf9", "url": "https://github.com/elastic/elasticsearch/commit/d92ef102c68b753266218518de777c02d15d1cf9", "message": "Merge branch 'master' into cancel-on-disconnect", "committedDate": "2020-05-12T18:08:15Z", "type": "commit"}, {"oid": "22b28fa81d4dae04cb1c44a38296a9cea8c58490", "url": "https://github.com/elastic/elasticsearch/commit/22b28fa81d4dae04cb1c44a38296a9cea8c58490", "message": "fix test", "committedDate": "2020-05-12T18:09:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NjU1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r423976557", "bodyText": "I think we need to clean these up when the channel closes. Maybe slightly tricky, we might close the channel concurrently with calling this method too.", "author": "DaveCTurner", "createdAt": "2020-05-12T19:22:01Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -607,4 +602,41 @@ void unregisterChildNode(DiscoveryNode node) {\n         }\n     }\n \n+    /**\n+     * Start tracking a cancellable task with its tcp channel, so if the channel gets closed we can get a set of\n+     * pending tasks associated that channel and cancel them as these results won't be retrieved by the parent task.\n+     *\n+     * @return a releasable that should be called when this pending task is completed\n+     */\n+    public Releasable startTrackingCancellableChannelTask(TcpChannel channel, CancellableTask task) {\n+        assert cancellableTasks.containsKey(task.getId()) : \"task [\" + task.getId() + \"] is not registered yet\";\n+        final ChannelPendingTaskTracker tracker = channelPendingTaskTrackers.computeIfAbsent(channel, k -> new ChannelPendingTaskTracker());", "originalCommit": "22b28fa81d4dae04cb1c44a38296a9cea8c58490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNjgzMg==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424026832", "bodyText": "Good catch. I pushed cbe02c7.", "author": "dnhatn", "createdAt": "2020-05-12T20:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NjU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NjkyMw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r423976923", "bodyText": "Can we assert it was removed?", "author": "DaveCTurner", "createdAt": "2020-05-12T19:22:42Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -607,4 +602,41 @@ void unregisterChildNode(DiscoveryNode node) {\n         }\n     }\n \n+    /**\n+     * Start tracking a cancellable task with its tcp channel, so if the channel gets closed we can get a set of\n+     * pending tasks associated that channel and cancel them as these results won't be retrieved by the parent task.\n+     *\n+     * @return a releasable that should be called when this pending task is completed\n+     */\n+    public Releasable startTrackingCancellableChannelTask(TcpChannel channel, CancellableTask task) {\n+        assert cancellableTasks.containsKey(task.getId()) : \"task [\" + task.getId() + \"] is not registered yet\";\n+        final ChannelPendingTaskTracker tracker = channelPendingTaskTrackers.computeIfAbsent(channel, k -> new ChannelPendingTaskTracker());\n+        tracker.pendingTasks.add(task);\n+        if (tracker.registered.compareAndSet(false, true)) {\n+            channel.addCloseListener(ActionListener.wrap(\n+                r -> {\n+                    final Set<CancellableTask> pendingTasks = Collections.unmodifiableSet(tracker.pendingTasks);\n+                    for (Consumer<Set<CancellableTask>> listener : onChannelCloseListeners) {\n+                        listener.accept(pendingTasks);\n+                    }\n+                },\n+                e -> {\n+                    assert false : new AssertionError(\"must not be here\", e);\n+                }));\n+        }\n+        return () -> tracker.pendingTasks.remove(task);", "originalCommit": "22b28fa81d4dae04cb1c44a38296a9cea8c58490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNjk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424026988", "bodyText": "++. Adjusted in 09a612e.", "author": "dnhatn", "createdAt": "2020-05-12T20:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NjkyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r423987569", "bodyText": "I wasn't expecting this to be included here, although perhaps it makes sense as a separate change. It's reasonable if the node is shut down but today we also cancel these tasks if the node is temporarily partitioned from the master, and perhaps we want to keep that behaviour.\nThe issue is that we don't tell the partitioned node that it has been dropped from the cluster so it won't close its outgoing channels, which means we won't cancel those tasks any more if we remove this.\nAlso looks like the tests around this are quite weak, since this change doesn't seem to have a corresponding change to the tests.", "author": "DaveCTurner", "createdAt": "2020-05-12T19:40:42Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -442,17 +448,6 @@ public void applyClusterState(ClusterChangedEvent event) {\n                     }\n                 }\n             }\n-            // Cancel cancellable tasks for the nodes that are gone", "originalCommit": "22b28fa81d4dae04cb1c44a38296a9cea8c58490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyODY0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424028642", "bodyText": "This has become an issue for us in the context of cross clusters. A subtask on the remote cluster will get canceled if any node in that cluster leaves. The reason is that the node with the parent task is from another cluster. This blocks the work to support cancellation cross clusters in #55779. We would like to replace it with the task heartbeat, but I found your proposal is much better.\n\nAlso looks like the tests around this are quite weak, since this change doesn't seem to have a corresponding change to the tests.\n\nYeah, we only test when a node leaves the cluster.", "author": "dnhatn", "createdAt": "2020-05-12T20:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MjcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424042718", "bodyText": "I see, in which case this change is ok with me. Could we make that test stronger? It seems very artificial that the tasks are only cancelled on testNodes[0].close();.", "author": "DaveCTurner", "createdAt": "2020-05-12T21:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NDc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424054744", "bodyText": "The issue is that we don't tell the partitioned node that it has been dropped from the cluster so it won't close its outgoing channels, which means we won't cancel those tasks any more if we remove this.\n\nThat looks like an enhancement to me. If the channel is still active we should give a chance for the task to finish ?", "author": "jimczi", "createdAt": "2020-05-12T21:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MDAwNg==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424140006", "bodyText": "ok, I pushed 8ae7042.", "author": "dnhatn", "createdAt": "2020-05-13T02:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4NzU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4ODE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r423988164", "bodyText": "Maybe log a warning here?", "author": "DaveCTurner", "createdAt": "2020-05-12T19:41:51Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java", "diffHunk": "@@ -276,4 +279,23 @@ public void messageReceived(final BanParentTaskRequest request, final TransportC\n         }\n     }\n \n+    void cancelOrphanedTasks(Set<CancellableTask> orphanedTasks) {\n+        if (orphanedTasks.isEmpty() == false) {\n+            transportService.getThreadPool().generic().execute(new AbstractRunnable() {\n+                @Override\n+                public void onFailure(Exception e) {\n+", "originalCommit": "22b28fa81d4dae04cb1c44a38296a9cea8c58490", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNzA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424027074", "bodyText": "added in d4f7586", "author": "dnhatn", "createdAt": "2020-05-12T20:54:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4ODE2NA=="}], "type": "inlineReview"}, {"oid": "92bbcf2227e6efb9fe5d501dac2850bb8c2e75d8", "url": "https://github.com/elastic/elasticsearch/commit/92bbcf2227e6efb9fe5d501dac2850bb8c2e75d8", "message": "Merge branch 'master' into cancel-on-disconnect", "committedDate": "2020-05-12T20:38:12Z", "type": "commit"}, {"oid": "d4f7586c16d83ffea09b3f080e3a3d0a418ffeb3", "url": "https://github.com/elastic/elasticsearch/commit/d4f7586c16d83ffea09b3f080e3a3d0a418ffeb3", "message": "warning log", "committedDate": "2020-05-12T20:44:45Z", "type": "commit"}, {"oid": "cbe02c7eae5f3aa58f1a6757ac7697da7e95242f", "url": "https://github.com/elastic/elasticsearch/commit/cbe02c7eae5f3aa58f1a6757ac7697da7e95242f", "message": "remove tracker on close", "committedDate": "2020-05-12T20:50:54Z", "type": "commit"}, {"oid": "09a612eb067c2173fa060e3e2bea3bbedabfde8e", "url": "https://github.com/elastic/elasticsearch/commit/09a612eb067c2173fa060e3e2bea3bbedabfde8e", "message": "assertion", "committedDate": "2020-05-12T20:52:02Z", "type": "commit"}, {"oid": "3b4e3bef9e1d36b9188b5b5451c8b643e648ba23", "url": "https://github.com/elastic/elasticsearch/commit/3b4e3bef9e1d36b9188b5b5451c8b643e648ba23", "message": "wording", "committedDate": "2020-05-12T20:59:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MTQ4MA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424041480", "bodyText": "What if the channel is closed (and the close listener executes completely) just before this line executes? I think that means we never cancel the task added in this line.\nCould we have a test with some concurrency to pick this up?", "author": "DaveCTurner", "createdAt": "2020-05-12T21:22:32Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -607,4 +602,53 @@ void unregisterChildNode(DiscoveryNode node) {\n         }\n     }\n \n+    /**\n+     * Start tracking a cancellable task with its tcp channel, so if the channel gets closed we can get a set of\n+     * pending tasks associated that channel and cancel them as these results won't be retrieved by the parent task.\n+     *\n+     * @return a releasable that should be called when this pending task is completed\n+     */\n+    public Releasable startTrackingCancellableChannelTask(TcpChannel channel, CancellableTask task) {\n+        assert cancellableTasks.containsKey(task.getId()) : \"task [\" + task.getId() + \"] is not registered yet\";\n+        final ChannelPendingTaskTracker tracker = channelPendingTaskTrackers.computeIfAbsent(channel, k -> new ChannelPendingTaskTracker());\n+        tracker.addTask(task);", "originalCommit": "3b4e3bef9e1d36b9188b5b5451c8b643e648ba23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzOTg0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424139843", "bodyText": "Good catch. I added a test and strengthen this logic in bdfa4f2.", "author": "dnhatn", "createdAt": "2020-05-13T02:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MTQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1Njc1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424056753", "bodyText": "Do we need to add multiple listeners ? I think  it would be cleaner to move the logic to cancel a task directly in the TaskManager and call it from TransportCancelTasksAction ?", "author": "jimczi", "createdAt": "2020-05-12T21:55:32Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -607,4 +602,53 @@ void unregisterChildNode(DiscoveryNode node) {\n         }\n     }\n \n+    /**\n+     * Start tracking a cancellable task with its tcp channel, so if the channel gets closed we can get a set of\n+     * pending tasks associated that channel and cancel them as these results won't be retrieved by the parent task.\n+     *\n+     * @return a releasable that should be called when this pending task is completed\n+     */\n+    public Releasable startTrackingCancellableChannelTask(TcpChannel channel, CancellableTask task) {\n+        assert cancellableTasks.containsKey(task.getId()) : \"task [\" + task.getId() + \"] is not registered yet\";\n+        final ChannelPendingTaskTracker tracker = channelPendingTaskTrackers.computeIfAbsent(channel, k -> new ChannelPendingTaskTracker());\n+        tracker.addTask(task);\n+        if (tracker.registered.compareAndSet(false, true)) {\n+            channel.addCloseListener(ActionListener.wrap(\n+                r -> {\n+                    final ChannelPendingTaskTracker removedTracker = channelPendingTaskTrackers.remove(channel);\n+                    assert removedTracker == tracker;\n+                    final Set<CancellableTask> pendingTasks = Collections.unmodifiableSet(tracker.pendingTasks);\n+                    for (Consumer<Set<CancellableTask>> listener : onChannelCloseListeners) {\n+                        listener.accept(pendingTasks);\n+                    }\n+                },\n+                e -> {\n+                    assert false : new AssertionError(\"must not be here\", e);\n+                }));\n+        }\n+        return () -> tracker.removeTask(task);\n+    }\n+\n+    /**\n+     * Register a callback which will be called when a transport channel is closed and there're some pending orphaned\n+     * tasks associate with that transport channel.\n+     */\n+    public void registerOrphanedTasksOnChannelCloseListener(Consumer<Set<CancellableTask>> listener) {\n+        onChannelCloseListeners.add(listener);", "originalCommit": "3b4e3bef9e1d36b9188b5b5451c8b643e648ba23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MDMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424140306", "bodyText": "We need a single listener - I switched to SetOnce in 1d2de32. I exposed this method so we can cancel child tasks.", "author": "dnhatn", "createdAt": "2020-05-13T02:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1Njc1Mw=="}], "type": "inlineReview"}, {"oid": "1d2de32dde9b1ab7b73c483670a45b9666878cb7", "url": "https://github.com/elastic/elasticsearch/commit/1d2de32dde9b1ab7b73c483670a45b9666878cb7", "message": "single listener", "committedDate": "2020-05-13T00:16:21Z", "type": "commit"}, {"oid": "bdfa4f24a4fd99a819ada8db4580e84bbdd12a22", "url": "https://github.com/elastic/elasticsearch/commit/bdfa4f24a4fd99a819ada8db4580e84bbdd12a22", "message": "track and close concurrently", "committedDate": "2020-05-13T02:17:41Z", "type": "commit"}, {"oid": "8ae70421eaffc6fc67f4fcaf74030099c9c01668", "url": "https://github.com/elastic/elasticsearch/commit/8ae70421eaffc6fc67f4fcaf74030099c9c01668", "message": "simulate other condition", "committedDate": "2020-05-13T02:34:04Z", "type": "commit"}, {"oid": "ebcd4fabf1696a086bf9ac63ce6b19574598a962", "url": "https://github.com/elastic/elasticsearch/commit/ebcd4fabf1696a086bf9ac63ce6b19574598a962", "message": "Merge branch 'master' into cancel-on-disconnect", "committedDate": "2020-05-13T02:47:42Z", "type": "commit"}, {"oid": "37a77d618ec2ca3e2661dd21363a6eadeec9c958", "url": "https://github.com/elastic/elasticsearch/commit/37a77d618ec2ca3e2661dd21363a6eadeec9c958", "message": "stylecheck", "committedDate": "2020-05-13T03:30:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIzOTgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424239834", "bodyText": "I think we should move this code (cancelTaskAndDescendants) in the TaskManager and expose a simple TaskManager#cancel method that this action can call. That would remove the need to have public methods in  the TaskManager around bans and orphaned tasks. They should be private and solely used by the TaskManager to cancel a task internally ?", "author": "jimczi", "createdAt": "2020-05-13T07:50:11Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java", "diffHunk": "@@ -276,4 +279,23 @@ public void messageReceived(final BanParentTaskRequest request, final TransportC\n         }\n     }\n \n+    void cancelOrphanedTasks(Set<CancellableTask> orphanedTasks) {", "originalCommit": "37a77d618ec2ca3e2661dd21363a6eadeec9c958", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUzNTMyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424535325", "bodyText": "Thanks for pushing this \ud83d\udc4d . I've moved the cancellation to TaskManager in bd29504.", "author": "dnhatn", "createdAt": "2020-05-13T15:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIzOTgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MjczNw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424242737", "bodyText": "Looks like there is a race condition that leads to an AssertionError. See my comment below, I think the logic to cancel a task and its children/descendants should be entirely in the TaskManager.", "author": "jimczi", "createdAt": "2020-05-13T07:54:57Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java", "diffHunk": "@@ -70,6 +72,7 @@ public TransportCancelTasksAction(ClusterService clusterService, TransportServic\n             CancelTasksRequest::new, CancelTasksResponse::new, TaskInfo::new, ThreadPool.Names.MANAGEMENT);\n         transportService.registerRequestHandler(BAN_PARENT_ACTION_NAME, ThreadPool.Names.SAME, BanParentTaskRequest::new,\n             new BanParentRequestHandler());\n+        taskManager.setOrphanedTasksOnChannelCloseListener(this::cancelOrphanedTasks);", "originalCommit": "37a77d618ec2ca3e2661dd21363a6eadeec9c958", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUzNTQ4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424535489", "bodyText": "Should be fixed in bd29504", "author": "dnhatn", "createdAt": "2020-05-13T15:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI0MjczNw=="}], "type": "inlineReview"}, {"oid": "bd2950455daec1e115a0cbbdafb986c51bc77585", "url": "https://github.com/elastic/elasticsearch/commit/bd2950455daec1e115a0cbbdafb986c51bc77585", "message": "Move cancellation descendants to cancellation service", "committedDate": "2020-05-13T15:30:51Z", "type": "commit"}, {"oid": "8e78fadb8de84a805b6499f1b8c06c71456cd042", "url": "https://github.com/elastic/elasticsearch/commit/8e78fadb8de84a805b6499f1b8c06c71456cd042", "message": "Merge branch 'master' into cancel-on-disconnect", "committedDate": "2020-05-13T15:34:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyNzQ3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424727475", "bodyText": "\ud83d\udcaf", "author": "jimczi", "createdAt": "2020-05-13T20:59:16Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -607,4 +608,98 @@ void unregisterChildNode(DiscoveryNode node) {\n         }\n     }\n \n+    /**\n+     * Start tracking a cancellable task with its tcp channel, so if the channel gets closed we can get a set of\n+     * pending tasks associated that channel and cancel them as these results won't be retrieved by the parent task.\n+     *\n+     * @return a releasable that should be called when this pending task is completed\n+     */\n+    public Releasable startTrackingCancellableChannelTask(TcpChannel channel, CancellableTask task) {\n+        assert cancellableTasks.containsKey(task.getId()) : \"task [\" + task.getId() + \"] is not registered yet\";\n+        final ChannelPendingTaskTracker tracker = channelPendingTaskTrackers.compute(channel, (k, curr) -> {\n+            if (curr == null) {\n+                curr = new ChannelPendingTaskTracker();\n+            }\n+            curr.addTask(task);\n+            return curr;\n+        });\n+        if (tracker.registered.compareAndSet(false, true)) {\n+            channel.addCloseListener(ActionListener.wrap(\n+                r -> {\n+                    final ChannelPendingTaskTracker removedTracker = channelPendingTaskTrackers.remove(channel);\n+                    assert removedTracker == tracker;\n+                    cancelTasksOnChannelClosed(tracker.drainTasks());\n+                },\n+                e -> {\n+                    assert false : new AssertionError(\"must not be here\", e);\n+                }));\n+        }\n+        return () -> tracker.removeTask(task);\n+    }\n+\n+    // for testing\n+    final int numberOfChannelPendingTaskTrackers() {\n+        return channelPendingTaskTrackers.size();\n+    }\n+\n+    private static class ChannelPendingTaskTracker {\n+        final AtomicBoolean registered = new AtomicBoolean();\n+        final Semaphore permits = Assertions.ENABLED ? new Semaphore(Integer.MAX_VALUE) : null;\n+        final Set<CancellableTask> pendingTasks = ConcurrentCollections.newConcurrentSet();\n+\n+        void addTask(CancellableTask task) {\n+            assert permits.tryAcquire() : \"tracker was drained\";\n+            final boolean added = pendingTasks.add(task);\n+            assert added : \"task \" + task.getId() + \" is in the pending list already\";\n+            assert releasePermit();\n+        }\n+\n+        boolean acquireAllPermits() {\n+            permits.acquireUninterruptibly(Integer.MAX_VALUE);\n+            return true;\n+        }\n+\n+        boolean releasePermit() {\n+            permits.release();\n+            return true;\n+        }\n+\n+        Set<CancellableTask> drainTasks() {\n+            assert acquireAllPermits(); // do not release permits so we can't add tasks to this tracker after draining\n+            return Collections.unmodifiableSet(pendingTasks);\n+        }\n+\n+        void removeTask(CancellableTask task) {\n+            final boolean removed = pendingTasks.remove(task);\n+            assert removed : \"task \" + task.getId() + \" is not in the pending list\";\n+        }\n+    }\n+\n+    private void cancelTasksOnChannelClosed(Set<CancellableTask> tasks) {\n+        if (tasks.isEmpty() == false) {\n+            threadPool.generic().execute(new AbstractRunnable() {\n+                @Override\n+                public void onFailure(Exception e) {\n+                    logger.warn(\"failed to cancel tasks on channel closed\", e);\n+                }\n+\n+                @Override\n+                protected void doRun() {\n+                    for (CancellableTask task : tasks) {\n+                        cancelTaskAndDescendants(task, \"channel was closed\", false, ActionListener.wrap(() -> {}));\n+                    }\n+                }\n+            });\n+        }\n+    }\n+\n+    public void cancelTaskAndDescendants(CancellableTask task, String reason, boolean waitForCompletion, ActionListener<Void> listener) {", "originalCommit": "8e78fadb8de84a805b6499f1b8c06c71456cd042", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTUzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424729531", "bodyText": "why isn't it instantiated when we create the TaskManager (TransportService#createTaskManager) ?", "author": "jimczi", "createdAt": "2020-05-13T21:03:17Z", "path": "server/src/main/java/org/elasticsearch/node/Node.java", "diffHunk": "@@ -717,6 +718,7 @@ public Node start() throws NodeValidationException {\n         // Start the transport service now so the publish address will be added to the local disco node in ClusterService\n         TransportService transportService = injector.getInstance(TransportService.class);\n         transportService.getTaskManager().setTaskResultsService(injector.getInstance(TaskResultsService.class));\n+        transportService.getTaskManager().setTaskCancellationService(new TaskCancellationService(transportService));", "originalCommit": "8e78fadb8de84a805b6499f1b8c06c71456cd042", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MzU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56620#discussion_r424753553", "bodyText": "I tried to avoid exposing TransportService when it's not fully initialized yet. Also, there are several circular dependencies between TransportService, RequestHandlerRegistry, TaskCancellationService, and TaskManager. I will look into how to pass TaskCancellationService to the constructor of TaskManager.", "author": "dnhatn", "createdAt": "2020-05-13T21:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcyOTUzMQ=="}], "type": "inlineReview"}, {"oid": "9329a105a9c77bb155218a1cd1d6a984b6e941b3", "url": "https://github.com/elastic/elasticsearch/commit/9329a105a9c77bb155218a1cd1d6a984b6e941b3", "message": "Merge branch 'master' into cancel-on-disconnect", "committedDate": "2020-05-13T21:08:56Z", "type": "commit"}, {"oid": "956859c5033377cd44393907832c688fed98228c", "url": "https://github.com/elastic/elasticsearch/commit/956859c5033377cd44393907832c688fed98228c", "message": "assign earlier", "committedDate": "2020-05-13T21:48:04Z", "type": "commit"}, {"oid": "fd94b9798e021dbbdba3b074631163469dbbe44c", "url": "https://github.com/elastic/elasticsearch/commit/fd94b9798e021dbbdba3b074631163469dbbe44c", "message": "Revert \"assign earlier\"\n\nThis reverts commit 956859c5033377cd44393907832c688fed98228c.", "committedDate": "2020-05-13T21:51:36Z", "type": "commit"}]}