{"pr_number": 53874, "pr_title": "Verify that the field is aggregatable before attempting cardinality aggregation", "pr_createdAt": "2020-03-20T14:24:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53874", "timeline": [{"oid": "877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "url": "https://github.com/elastic/elasticsearch/commit/877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T09:42:29Z", "type": "forcePushed"}, {"oid": "76f4e4046467e410efbc16cbfb2b021d215bf17c", "url": "https://github.com/elastic/elasticsearch/commit/76f4e4046467e410efbc16cbfb2b021d215bf17c", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T10:29:30Z", "type": "forcePushed"}, {"oid": "15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "url": "https://github.com/elastic/elasticsearch/commit/15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T10:33:11Z", "type": "forcePushed"}, {"oid": "2be6e4e784e1d8299c70719c886bb68f369ed07f", "url": "https://github.com/elastic/elasticsearch/commit/2be6e4e784e1d8299c70719c886bb68f369ed07f", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T10:39:49Z", "type": "forcePushed"}, {"oid": "907fc14c0e5a0471171731eac05d0705ab759196", "url": "https://github.com/elastic/elasticsearch/commit/907fc14c0e5a0471171731eac05d0705ab759196", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T10:42:25Z", "type": "forcePushed"}, {"oid": "95cea80717e52d5a9e3abe98e4f2ae974ebd84e0", "url": "https://github.com/elastic/elasticsearch/commit/95cea80717e52d5a9e3abe98e4f2ae974ebd84e0", "message": "Remove \"text\" type from the set of supported categorical types", "committedDate": "2020-03-23T12:07:26Z", "type": "forcePushed"}, {"oid": "58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "url": "https://github.com/elastic/elasticsearch/commit/58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "message": "Verify that the field is aggregatable before attempting cardinality aggregation", "committedDate": "2020-03-23T14:34:35Z", "type": "forcePushed"}, {"oid": "871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "url": "https://github.com/elastic/elasticsearch/commit/871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "message": "Verify that the field is aggregatable before attempting cardinality aggregation", "committedDate": "2020-03-23T14:34:57Z", "type": "forcePushed"}, {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758", "url": "https://github.com/elastic/elasticsearch/commit/7a2b3dda100f9078df61b4f3b8c442a679dec758", "message": "Verify that the field is aggregatable before attempting cardinality aggregation", "committedDate": "2020-03-23T14:38:27Z", "type": "commit"}, {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758", "url": "https://github.com/elastic/elasticsearch/commit/7a2b3dda100f9078df61b4f3b8c442a679dec758", "message": "Verify that the field is aggregatable before attempting cardinality aggregation", "committedDate": "2020-03-23T14:38:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjc4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53874#discussion_r396516781", "bodyText": "\ud83e\udd14\nWhat if this is a multi-field?\nIf the field mapping is\n\"foo\": {\n   \"type\": \"text\",\n   \"keyword\": {\n      \"type\": \"keyword\"\n   }\n}\n\nDo we prefer to use foo.keyword in this instance? I know that analytics chooses a preferred field-mapping but I am not sure that occurs before this call.", "author": "benwtrent", "createdAt": "2020-03-23T15:00:56Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/extractor/ExtractedFieldsDetectorFactory.java", "diffHunk": "@@ -111,6 +114,12 @@ private void getCardinalitiesForFieldsWithConstraints(String[] index, DataFrameA\n \n         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().size(0).query(config.getSource().getParsedQuery());\n         for (FieldCardinalityConstraint constraint : fieldCardinalityConstraints) {\n+            for (FieldCapabilities fieldCaps : fieldCapabilitiesResponse.getField(constraint.getField()).values()) {", "originalCommit": "7a2b3dda100f9078df61b4f3b8c442a679dec758", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMTI2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53874#discussion_r396531266", "bodyText": "In your example, we'll prefer foo.keyword indeed.\nBut this matters only for fields that have constraints.\nAt the moment, the only field with cardinality constraint is the dependent_variable which we'll take in whatever form the user types it in.\nIf we ever introduce other fields with cardinality constraints, we'll have to ensure they're aggregatable anyway.", "author": "dimitris-athanasiou", "createdAt": "2020-03-23T15:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5Mzg4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53874#discussion_r396593887", "bodyText": "AH! We don't dynamically choose the best multi-field for the dependent_variable. In that case,", "author": "benwtrent", "createdAt": "2020-03-23T16:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjc4MQ=="}], "type": "inlineReview"}]}