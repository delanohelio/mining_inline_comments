{"pr_number": 64120, "pr_title": "[Test] Use InvalidateTokenRequest factory methods", "pr_createdAt": "2020-10-26T06:56:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64120", "timeline": [{"oid": "c1005a79069a14075c1c53441f882ec869f9761f", "url": "https://github.com/elastic/elasticsearch/commit/c1005a79069a14075c1c53441f882ec869f9761f", "message": "[Test] Use InvalidateTokenRequest factory methods\n\nIn the HLRC, InvalidateTokenRequest has 4 factory methods to simplify\nthe construction of requests that use only 1 search criteria.\n\nThis change replaces direct uses of the constructor (within tests)\nwith the relevant factory methods. This is helpful because the\nconstructor takes 4 String arguments, so it is easy to accidentally\ntranspose them and have the test perform the wrong invalidation action\n(as was the case in testExpiredTokensDeletedAfterExpiration where a\nrefreshToken was passed in the first argument, instead of the second).", "committedDate": "2020-10-26T06:50:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0OTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64120#discussion_r511749757", "bodyText": "This was the test bug.", "author": "tvernum", "createdAt": "2020-10-26T06:59:29Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java", "diffHunk": "@@ -189,12 +189,13 @@ public void testExpiredTokensDeletedAfterExpiration() throws Exception {\n \n         // Now the documents are deleted, try to invalidate the access token and refresh token again\n         InvalidateTokenResponse invalidateAccessTokenResponse = restClient.security().invalidateToken(\n-            new InvalidateTokenRequest(accessToken, null, null, null), SECURITY_REQUEST_OPTIONS);\n+            InvalidateTokenRequest.accessToken(accessToken), SECURITY_REQUEST_OPTIONS);\n         assertThat(invalidateAccessTokenResponse.getInvalidatedTokens(), equalTo(0));\n         assertThat(invalidateAccessTokenResponse.getPreviouslyInvalidatedTokens(), equalTo(0));\n         assertThat(invalidateAccessTokenResponse.getErrors(), empty());\n+\n         InvalidateTokenResponse invalidateRefreshTokenResponse = restClient.security().invalidateToken(\n-            new InvalidateTokenRequest(refreshToken, null, null, null), SECURITY_REQUEST_OPTIONS);\n+            InvalidateTokenRequest.refreshToken(refreshToken), SECURITY_REQUEST_OPTIONS);", "originalCommit": "c1005a79069a14075c1c53441f882ec869f9761f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MDE0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64120#discussion_r511760141", "bodyText": "Good catch.", "author": "ywangd", "createdAt": "2020-10-26T07:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0OTc1Nw=="}], "type": "inlineReview"}, {"oid": "a7709322364985fa33647cb6eabea83c8f2e302a", "url": "https://github.com/elastic/elasticsearch/commit/a7709322364985fa33647cb6eabea83c8f2e302a", "message": "Checkstyle: Line length", "committedDate": "2020-10-26T07:06:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MTAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64120#discussion_r511761018", "bodyText": "Not suggesting for you to change it in this PR since it is user visible, but the method name userTokens is confusing.", "author": "ywangd", "createdAt": "2020-10-26T07:31:57Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java", "diffHunk": "@@ -208,7 +209,7 @@ public void testInvalidateAllTokensForUser() throws Exception {\n                 SecuritySettingsSourceField.TEST_PASSWORD.toCharArray()), SECURITY_REQUEST_OPTIONS);\n         }\n         InvalidateTokenResponse invalidateResponse = restClient.security().invalidateToken(\n-            new InvalidateTokenRequest(null, null, null, SecuritySettingsSource.TEST_USER_NAME),\n+            InvalidateTokenRequest.userTokens(SecuritySettingsSource.TEST_USER_NAME),", "originalCommit": "a7709322364985fa33647cb6eabea83c8f2e302a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyMDM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64120#discussion_r512420378", "bodyText": "I agree - I thought the same thing when I converted all these calls.", "author": "tvernum", "createdAt": "2020-10-27T05:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MTAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MTI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64120#discussion_r511761279", "bodyText": "Same for this method name.", "author": "ywangd", "createdAt": "2020-10-26T07:32:39Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java", "diffHunk": "@@ -225,7 +226,7 @@ public void testInvalidateAllTokensForRealm() throws Exception {\n                 SecuritySettingsSourceField.TEST_PASSWORD.toCharArray()), SECURITY_REQUEST_OPTIONS);\n         }\n         InvalidateTokenResponse invalidateResponse = restClient.security().invalidateToken(\n-            new InvalidateTokenRequest(null, null, \"file\", null),\n+            InvalidateTokenRequest.realmTokens(\"file\"),", "originalCommit": "a7709322364985fa33647cb6eabea83c8f2e302a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}