{"pr_number": 62290, "pr_title": "Round up parsers should be based on a list of parsers", "pr_createdAt": "2020-09-14T07:46:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62290", "timeline": [{"oid": "4bb6941624d7975f858df411a6d2516ae93bfe74", "url": "https://github.com/elastic/elasticsearch/commit/4bb6941624d7975f858df411a6d2516ae93bfe74", "message": "Round up parsers should be based on a list of parsers\n\na dateformatter can be created with a list of parsers which are iterated\nduring parsing and the first one that passes will return a parsed date.\nDateMathParser should do the same, when created based on a list of\nnon-rounding parsers it should also iterate over all of them - it is at\nthe moment only taking first element\n\nclosing https://github.com/elastic/elasticsearch/issues/62207", "committedDate": "2020-09-14T07:42:13Z", "type": "commit"}, {"oid": "409c960a27407957295d45cf1f52d41c53172f09", "url": "https://github.com/elastic/elasticsearch/commit/409c960a27407957295d45cf1f52d41c53172f09", "message": "Merge branch 'master' into java_time/round_up_parsers_list", "committedDate": "2020-09-15T06:53:14Z", "type": "commit"}, {"oid": "93bfd72f471b32f7bc415206eb3c972a21d357ee", "url": "https://github.com/elastic/elasticsearch/commit/93bfd72f471b32f7bc415206eb3c972a21d357ee", "message": "Merge branch 'master' into java_time/round_up_parsers_list", "committedDate": "2020-09-16T08:37:33Z", "type": "commit"}, {"oid": "20ba8f3e040efcff9d8091b3a3055c490a219371", "url": "https://github.com/elastic/elasticsearch/commit/20ba8f3e040efcff9d8091b3a3055c490a219371", "message": "revert scope and fix test", "committedDate": "2020-09-16T15:54:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTEwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62290#discussion_r489759105", "bodyText": "How does this differ from the note above mentioning merges with || appending to the list of roundup formatters?", "author": "rjernst", "createdAt": "2020-09-16T21:16:19Z", "path": "server/src/main/java/org/elasticsearch/common/time/JavaDateFormatter.java", "diffHunk": "@@ -113,10 +113,14 @@ JavaDateFormatter getRoundupParser() {\n     private List<DateTimeFormatter> createRoundUpParser(String format,\n                                                         Consumer<DateTimeFormatterBuilder> roundupParserConsumer) {\n         if (format.contains(\"||\") == false) {\n-            DateTimeFormatterBuilder builder = new DateTimeFormatterBuilder();\n-            builder.append(this.parsers.get(0));\n-            roundupParserConsumer.accept(builder);\n-            return Arrays.asList(builder.toFormatter(locale()));\n+            List<DateTimeFormatter> roundUpParsers = new ArrayList<>();\n+            for (DateTimeFormatter parser : this.parsers) {", "originalCommit": "20ba8f3e040efcff9d8091b3a3055c490a219371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4MDk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62290#discussion_r490080992", "bodyText": "so the comment mentions In further merges (with ||) it will only append this one to a list. When probably it should mention this in plural.\nwhen a DateFormatter with multiple parsers like for instance date_time it will now also have a multiple round up parsers. When a date_time is then used in combination with other parsers, it will merge its parsers and round up parsers.\nfor instance date_time||date_time_no_millis\ndate_time has 2 parsers and 2 round up parsers\ndate_time_no_millis also has 4 parsers and round up parsers\ndate_time||date_time_no_millis will merge to have 6 parsers and 6 round up parsers\nI added a test case to confirm that all of them are being used.\nThe reason I initially only taken the first parser ( builder.append(this.parsers.get(0)); ) was that I tested for JavaDateFormatter created for a custom pattern.\nDateFormatter.forPattern(\"YYYY\") where there no multiple parsers\nlet me know if that makes it clear?", "author": "pgomulka", "createdAt": "2020-09-17T08:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTEwNQ=="}], "type": "inlineReview"}, {"oid": "a30b8414c7f6fd0e1f8ddbf2c1c3ba26a22d7084", "url": "https://github.com/elastic/elasticsearch/commit/a30b8414c7f6fd0e1f8ddbf2c1c3ba26a22d7084", "message": "length line", "committedDate": "2020-09-17T08:04:40Z", "type": "commit"}, {"oid": "a40040b45452fe2732f9c92f576d454566dc47cc", "url": "https://github.com/elastic/elasticsearch/commit/a40040b45452fe2732f9c92f576d454566dc47cc", "message": "add a testcase for combining parsers", "committedDate": "2020-09-17T09:24:06Z", "type": "commit"}, {"oid": "2220cd6ef3f458da9198bb8e437067c8834e5347", "url": "https://github.com/elastic/elasticsearch/commit/2220cd6ef3f458da9198bb8e437067c8834e5347", "message": "Merge branch 'master' into java_time/round_up_parsers_list", "committedDate": "2020-09-17T14:39:47Z", "type": "commit"}, {"oid": "dc134ec86caa974d5d15247c3b056cddceccd06f", "url": "https://github.com/elastic/elasticsearch/commit/dc134ec86caa974d5d15247c3b056cddceccd06f", "message": "javadoc", "committedDate": "2020-09-18T07:28:41Z", "type": "commit"}]}