{"pr_number": 64582, "pr_title": "Add query watches api to retrieve multiple watches.", "pr_createdAt": "2020-11-04T11:55:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64582", "timeline": [{"oid": "0e1b6c9720caccb20106599d4bec738f8846583f", "url": "https://github.com/elastic/elasticsearch/commit/0e1b6c9720caccb20106599d4bec738f8846583f", "message": "Add list watches api to retrieve multiple watches.\n\nThis api supports pagination (from / size) and\nquerying and sorting by watch _id and watcher metadata.\n\nThis avoids using .watch index directly.\n\nRelates #62501", "committedDate": "2020-11-04T11:53:24Z", "type": "commit"}, {"oid": "da07e704d48b9f5ba6a43e81aad695ba62ad347a", "url": "https://github.com/elastic/elasticsearch/commit/da07e704d48b9f5ba6a43e81aad695ba62ad347a", "message": "fixed precommit", "committedDate": "2020-11-04T13:22:57Z", "type": "commit"}, {"oid": "3854a5e67aa4246c4a104bbff37659ece8e4b9d3", "url": "https://github.com/elastic/elasticsearch/commit/3854a5e67aa4246c4a104bbff37659ece8e4b9d3", "message": "iter", "committedDate": "2020-11-04T13:39:14Z", "type": "commit"}, {"oid": "68aa70ebacc301670e1c2a74173821b8af25f02f", "url": "https://github.com/elastic/elasticsearch/commit/68aa70ebacc301670e1c2a74173821b8af25f02f", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-11-18T13:00:57Z", "type": "commit"}, {"oid": "2740b8a507dd46506127c894b4fd9cb87d907c4c", "url": "https://github.com/elastic/elasticsearch/commit/2740b8a507dd46506127c894b4fd9cb87d907c4c", "message": "added support for search after", "committedDate": "2020-11-18T13:35:40Z", "type": "commit"}, {"oid": "4ad053f8c3a067feac9c09b197342422b9373b2f", "url": "https://github.com/elastic/elasticsearch/commit/4ad053f8c3a067feac9c09b197342422b9373b2f", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-11-19T12:45:26Z", "type": "commit"}, {"oid": "f47e66ea76146dd325c606d500ac66ac73f2d57a", "url": "https://github.com/elastic/elasticsearch/commit/f47e66ea76146dd325c606d500ac66ac73f2d57a", "message": "added docs", "committedDate": "2020-11-19T15:49:00Z", "type": "commit"}, {"oid": "8c4bf9606b96aae7ef8e2eaf52882d55d94759a9", "url": "https://github.com/elastic/elasticsearch/commit/8c4bf9606b96aae7ef8e2eaf52882d55d94759a9", "message": "handle no .watches index gracefully", "committedDate": "2020-11-19T15:57:32Z", "type": "commit"}, {"oid": "160a64986039f5a3f16a711585da1dcf20b7c394", "url": "https://github.com/elastic/elasticsearch/commit/160a64986039f5a3f16a711585da1dcf20b7c394", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-11-23T12:40:44Z", "type": "commit"}, {"oid": "9507b914297f1033370036d9adea5f646937e1ef", "url": "https://github.com/elastic/elasticsearch/commit/9507b914297f1033370036d9adea5f646937e1ef", "message": "fixed docs", "committedDate": "2020-11-23T14:47:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0MzA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r529743052", "bodyText": "Should we also include a search_after here ?  (or in a seperate test)", "author": "jakelandis", "createdAt": "2020-11-24T17:14:11Z", "path": "x-pack/plugin/watcher/src/internalClusterTest/java/org/elasticsearch/xpack/watcher/test/integration/BasicWatcherTests.java", "diffHunk": "@@ -375,4 +382,79 @@ private void testConditionSearch(WatcherSearchTemplateRequest request) throws Ex\n         timeWarp().trigger(watchName);\n         assertWatchWithMinimumPerformedActionsCount(watchName, 1);\n     }\n+\n+    public void testListWatches() {\n+        int numWatches = 6;\n+        for (int i = 0; i < numWatches; i++) {\n+            PutWatchResponse putWatchResponse = new PutWatchRequestBuilder(client()).setId(\"\" + i)\n+                .setSource(watchBuilder()\n+                    .trigger(schedule(interval(1, IntervalSchedule.Interval.Unit.DAYS)))\n+                    .addAction(\"_logger\", loggingAction(\"log me\"))\n+                    .metadata(Map.of(\"key1\", i, \"key2\", numWatches - i)))\n+                .get();\n+            assertThat(putWatchResponse.isCreated(), is(true));\n+        }\n+        refresh();\n+\n+        ListWatchesAction.Request request =\n+            new ListWatchesAction.Request(0, 2, null, List.of(new FieldSortBuilder(\"metadata.key1\")), null);\n+        ListWatchesAction.Response response = client().execute(ListWatchesAction.INSTANCE, request).actionGet();\n+        assertThat(response.getWatchTotalCount(), equalTo((long) numWatches));\n+        assertThat(response.getWatches().size(), equalTo(2));\n+        assertThat(response.getWatches().get(0).getId(), equalTo(\"0\"));\n+        Map<?, ?> watcherMetadata = (Map<?, ?>) response.getWatches().get(0).getSource().getAsMap().get(\"metadata\");\n+        assertThat(watcherMetadata.get(\"key2\"), equalTo(6));\n+        assertThat(response.getWatches().get(1).getId(), equalTo(\"1\"));\n+        watcherMetadata = (Map<?, ?>) response.getWatches().get(1).getSource().getAsMap().get(\"metadata\");\n+        assertThat(watcherMetadata.get(\"key2\"), equalTo(5));\n+\n+        request = new ListWatchesAction.Request(2, 2, null, List.of(new FieldSortBuilder(\"metadata.key1\")), null);", "originalCommit": "9507b914297f1033370036d9adea5f646937e1ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0ODU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r529748551", "bodyText": "What is this change for ?", "author": "jakelandis", "createdAt": "2020-11-24T17:22:16Z", "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/test/WatcherTestUtils.java", "diffHunk": "@@ -149,24 +152,25 @@ public static WatchExecutionContext createWatchExecutionContext() throws Excepti\n \n \n     public static Watch createTestWatch(String watchName, Client client, HttpClient httpClient, EmailService emailService,\n-                                        WatcherSearchTemplateService searchTemplateService, Logger logger) throws AddressException {\n+                                        WatcherSearchTemplateService searchTemplateService, Logger logger) {\n+        ActionThrottler actionThrottler = new ActionThrottler(Clock.systemUTC(), null, mock(XPackLicenseState.class));", "originalCommit": "9507b914297f1033370036d9adea5f646937e1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIxODc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r530218754", "bodyText": "So the reason this change is needed, is because the ListWatchesResponseTests creates watch instances for testing xcontent serialization and a couple more components are needed to make a watch xcontent serialization work without NPE's being thrown.", "author": "martijnvg", "createdAt": "2020-11-25T09:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0ODU1MQ=="}], "type": "inlineReview"}, {"oid": "84a10e7e5cf39d42fca0c8d5fe505b64bcd62768", "url": "https://github.com/elastic/elasticsearch/commit/84a10e7e5cf39d42fca0c8d5fe505b64bcd62768", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-11-25T08:58:11Z", "type": "commit"}, {"oid": "05d7acde56b212788c9bc792efc6f0cd975b35fc", "url": "https://github.com/elastic/elasticsearch/commit/05d7acde56b212788c9bc792efc6f0cd975b35fc", "message": "added test with search_after", "committedDate": "2020-11-25T09:52:04Z", "type": "commit"}, {"oid": "0b1efecc7b22f4f8dd3750c89d34c5150054124e", "url": "https://github.com/elastic/elasticsearch/commit/0b1efecc7b22f4f8dd3750c89d34c5150054124e", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-12-01T07:51:38Z", "type": "commit"}, {"oid": "836c17d3255673436465e29f8db89db003c6fdfd", "url": "https://github.com/elastic/elasticsearch/commit/836c17d3255673436465e29f8db89db003c6fdfd", "message": "rename", "committedDate": "2020-12-01T08:50:34Z", "type": "commit"}, {"oid": "01dc16a279e11649ac901d258784d9b2193ac943", "url": "https://github.com/elastic/elasticsearch/commit/01dc16a279e11649ac901d258784d9b2193ac943", "message": "renamed comment", "committedDate": "2020-12-01T08:53:31Z", "type": "commit"}, {"oid": "cbc0fe5c9e16b3ade68705c2c42fb43287a6eca8", "url": "https://github.com/elastic/elasticsearch/commit/cbc0fe5c9e16b3ade68705c2c42fb43287a6eca8", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api", "committedDate": "2020-12-03T10:28:16Z", "type": "commit"}, {"oid": "f2a559f113bd4b759afd7b59825eef64233d8610", "url": "https://github.com/elastic/elasticsearch/commit/f2a559f113bd4b759afd7b59825eef64233d8610", "message": "changed url path", "committedDate": "2020-12-03T10:42:46Z", "type": "commit"}, {"oid": "5adf181a273baa3e938bc68cb11b95d2bf690936", "url": "https://github.com/elastic/elasticsearch/commit/5adf181a273baa3e938bc68cb11b95d2bf690936", "message": "adjusted list on non operator list actions", "committedDate": "2020-12-03T12:34:59Z", "type": "commit"}]}