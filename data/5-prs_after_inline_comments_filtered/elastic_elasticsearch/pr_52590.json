{"pr_number": 52590, "pr_title": "ValuesSource refactoring: Wire up SigTerms aggregation", "pr_createdAt": "2020-02-20T19:42:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52590", "timeline": [{"oid": "34bbf51815c85902f1b072a176be12ea254f1775", "url": "https://github.com/elastic/elasticsearch/commit/34bbf51815c85902f1b072a176be12ea254f1775", "message": "ValuesSource refactoring: Wire up SigTerms aggregation", "committedDate": "2020-02-20T19:38:19Z", "type": "commit"}, {"oid": "161ba7c92a5a2e0161d6eaac0b870b6d4cd64186", "url": "https://github.com/elastic/elasticsearch/commit/161ba7c92a5a2e0161d6eaac0b870b6d4cd64186", "message": "Fix yaml test", "committedDate": "2020-02-20T20:30:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM3MzEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52590#discussion_r382373139", "bodyText": "Just noticed I forgot to change this, should be IllegalArgException, will fix in the morning :)", "author": "polyfractal", "createdAt": "2020-02-21T02:56:15Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTermsAggregatorFactory.java", "diffHunk": "@@ -75,17 +78,116 @@\n     private final TermsAggregator.BucketCountThresholds bucketCountThresholds;\n     private final SignificanceHeuristic significanceHeuristic;\n \n-    public SignificantTermsAggregatorFactory(String name,\n-                                             ValuesSourceConfig config,\n-                                             IncludeExclude includeExclude,\n-                                             String executionHint,\n-                                             QueryBuilder filterBuilder,\n-                                             TermsAggregator.BucketCountThresholds bucketCountThresholds,\n-                                             SignificanceHeuristic significanceHeuristic,\n-                                             QueryShardContext queryShardContext,\n-                                             AggregatorFactory parent,\n-                                             AggregatorFactories.Builder subFactoriesBuilder,\n-                                             Map<String, Object> metaData) throws IOException {\n+    static void registerAggregators(ValuesSourceRegistry valuesSourceRegistry) {\n+        valuesSourceRegistry.register(SignificantTermsAggregationBuilder.NAME,\n+            List.of(CoreValuesSourceType.BYTES, CoreValuesSourceType.IP),\n+            SignificantTermsAggregatorFactory.bytesSupplier());\n+\n+        valuesSourceRegistry.register(SignificantTermsAggregationBuilder.NAME,\n+            List.of(CoreValuesSourceType.DATE, CoreValuesSourceType.BOOLEAN, CoreValuesSourceType.NUMERIC),\n+            SignificantTermsAggregatorFactory.numericSupplier());\n+    }\n+\n+    /**\n+     * This supplier is used for all the field types that should be aggregated as bytes/strings,\n+     * including those that need global ordinals\n+     */\n+    private static SignificantTermsAggregatorSupplier bytesSupplier() {\n+        return new SignificantTermsAggregatorSupplier() {\n+            @Override\n+            public Aggregator build(String name,\n+                                    AggregatorFactories factories,\n+                                    ValuesSource valuesSource,\n+                                    DocValueFormat format,\n+                                    TermsAggregator.BucketCountThresholds bucketCountThresholds,\n+                                    IncludeExclude includeExclude,\n+                                    String executionHint,\n+                                    SearchContext context,\n+                                    Aggregator parent,\n+                                    SignificanceHeuristic significanceHeuristic,\n+                                    SignificantTermsAggregatorFactory sigTermsFactory,\n+                                    List<PipelineAggregator> pipelineAggregators,\n+                                    Map<String, Object> metaData) throws IOException {\n+\n+                ExecutionMode execution = null;\n+                if (executionHint != null) {\n+                    execution = ExecutionMode.fromString(executionHint, deprecationLogger);\n+                }\n+                if (valuesSource instanceof ValuesSource.Bytes.WithOrdinals == false) {\n+                    execution = ExecutionMode.MAP;\n+                }\n+                if (execution == null) {\n+                    execution = ExecutionMode.GLOBAL_ORDINALS;\n+                }\n+\n+                if ((includeExclude != null) && (includeExclude.isRegexBased()) && format != DocValueFormat.RAW) {\n+                    throw new IllegalArgumentException(\"Aggregation [\" + name + \"] cannot support regular expression style \"\n+                        + \"include/exclude settings as they can only be applied to string fields. Use an array of values for \"\n+                        + \"include/exclude clauses\");\n+                }\n+\n+                return execution.create(name, factories, valuesSource, format, bucketCountThresholds, includeExclude, context, parent,\n+                    significanceHeuristic, sigTermsFactory, pipelineAggregators, metaData);\n+\n+            }\n+        };\n+    }\n+\n+    /**\n+     * This supplier is used for all fields that expect to be aggregated as a numeric value.\n+     * This includes floating points, and formatted types that use numerics internally for storage (date, boolean, etc)\n+     */\n+    private static SignificantTermsAggregatorSupplier numericSupplier() {\n+        return new SignificantTermsAggregatorSupplier() {\n+            @Override\n+            public Aggregator build(String name,\n+                                    AggregatorFactories factories,\n+                                    ValuesSource valuesSource,\n+                                    DocValueFormat format,\n+                                    TermsAggregator.BucketCountThresholds bucketCountThresholds,\n+                                    IncludeExclude includeExclude,\n+                                    String executionHint,\n+                                    SearchContext context,\n+                                    Aggregator parent,\n+                                    SignificanceHeuristic significanceHeuristic,\n+                                    SignificantTermsAggregatorFactory sigTermsFactory,\n+                                    List<PipelineAggregator> pipelineAggregators,\n+                                    Map<String, Object> metaData) throws IOException {\n+\n+                if ((includeExclude != null) && (includeExclude.isRegexBased())) {\n+                    throw new AggregationExecutionException(\"Aggregation [\" + name + \"] cannot support regular expression style include/exclude \"", "originalCommit": "161ba7c92a5a2e0161d6eaac0b870b6d4cd64186", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf37c60f39c6932500151180a06126fe6969f6ca", "url": "https://github.com/elastic/elasticsearch/commit/cf37c60f39c6932500151180a06126fe6969f6ca", "message": "Tweak exception type", "committedDate": "2020-02-24T16:23:13Z", "type": "commit"}, {"oid": "3174f19d52867e46477751c1c0982b0320ce80c5", "url": "https://github.com/elastic/elasticsearch/commit/3174f19d52867e46477751c1c0982b0320ce80c5", "message": "Merge branch 'feature/extensible-values-source' into vs_sigterms", "committedDate": "2020-02-24T16:52:01Z", "type": "commit"}, {"oid": "6e74e6bf5e9fa5e8267c549b645430dc3c329fb6", "url": "https://github.com/elastic/elasticsearch/commit/6e74e6bf5e9fa5e8267c549b645430dc3c329fb6", "message": "Checkstyle because I'm bad", "committedDate": "2020-02-24T21:26:53Z", "type": "commit"}]}