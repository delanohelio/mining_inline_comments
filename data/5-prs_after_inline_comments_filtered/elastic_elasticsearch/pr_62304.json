{"pr_number": 62304, "pr_title": "[ML] Implement AucRoc metric for classification - HLRC", "pr_createdAt": "2020-09-14T11:24:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62304", "timeline": [{"oid": "74874311fbc2cadf3e18228f0b5ba3b35aef603d", "url": "https://github.com/elastic/elasticsearch/commit/74874311fbc2cadf3e18228f0b5ba3b35aef603d", "message": "[ML] Implement AucRoc metric for classification - HLRC", "committedDate": "2020-09-18T09:12:35Z", "type": "forcePushed"}, {"oid": "43f30795327d709124b662fdc56b51ed7361af70", "url": "https://github.com/elastic/elasticsearch/commit/43f30795327d709124b662fdc56b51ed7361af70", "message": "[ML] Implement AucRoc metric for classification - HLRC", "committedDate": "2020-09-18T09:59:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg2OTg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490869857", "bodyText": "The usual pattern is to let the server decide what the default is when an option is not set. includeCurve should be a Boolean and not written if null.", "author": "davidkyle", "createdAt": "2020-09-18T11:01:23Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/dataframe/evaluation/classification/AucRocMetric.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.ml.dataframe.evaluation.classification;\n+\n+import org.elasticsearch.client.ml.dataframe.evaluation.EvaluationMetric;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n+\n+/**\n+ * Area under the curve (AUC) of the receiver operating characteristic (ROC).\n+ * The ROC curve is a plot of the TPR (true positive rate) against\n+ * the FPR (false positive rate) over a varying threshold.\n+ */\n+public class AucRocMetric implements EvaluationMetric {\n+\n+    public static final String NAME = \"auc_roc\";\n+\n+    public static final ParseField INCLUDE_CURVE = new ParseField(\"include_curve\");\n+    public static final ParseField CLASS_NAME = new ParseField(\"class_name\");\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AucRocMetric, Void> PARSER =\n+        new ConstructingObjectParser<>(NAME, true, args -> new AucRocMetric((Boolean) args[0], (String) args[1]));\n+\n+    static {\n+        PARSER.declareBoolean(optionalConstructorArg(), INCLUDE_CURVE);\n+        PARSER.declareString(optionalConstructorArg(), CLASS_NAME);\n+    }\n+\n+    public static AucRocMetric fromXContent(XContentParser parser) {\n+        return PARSER.apply(parser, null);\n+    }\n+\n+    public static AucRocMetric withCurveForClass(String className) {\n+        return new AucRocMetric(true, className);\n+    }\n+\n+    public static AucRocMetric forClass(String className) {\n+        return new AucRocMetric(false, className);\n+    }\n+\n+    private final boolean includeCurve;\n+    private final String className;\n+\n+    public AucRocMetric(Boolean includeCurve, String className) {\n+        this.includeCurve = includeCurve == null ? false : includeCurve;", "originalCommit": "43f30795327d709124b662fdc56b51ed7361af70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxODg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490918840", "bodyText": "Done for both classification.AucRocMetric and outlierdetection.AucRocMetric.", "author": "przemekwitek", "createdAt": "2020-09-18T12:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg2OTg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3MTA1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490871059", "bodyText": "What does the request mean when className == null? Does that return the results for all classes?", "author": "davidkyle", "createdAt": "2020-09-18T11:03:38Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/dataframe/evaluation/classification/AucRocMetric.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.ml.dataframe.evaluation.classification;\n+\n+import org.elasticsearch.client.ml.dataframe.evaluation.EvaluationMetric;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n+\n+/**\n+ * Area under the curve (AUC) of the receiver operating characteristic (ROC).\n+ * The ROC curve is a plot of the TPR (true positive rate) against\n+ * the FPR (false positive rate) over a varying threshold.\n+ */\n+public class AucRocMetric implements EvaluationMetric {\n+\n+    public static final String NAME = \"auc_roc\";\n+\n+    public static final ParseField INCLUDE_CURVE = new ParseField(\"include_curve\");\n+    public static final ParseField CLASS_NAME = new ParseField(\"class_name\");\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AucRocMetric, Void> PARSER =\n+        new ConstructingObjectParser<>(NAME, true, args -> new AucRocMetric((Boolean) args[0], (String) args[1]));\n+\n+    static {\n+        PARSER.declareBoolean(optionalConstructorArg(), INCLUDE_CURVE);\n+        PARSER.declareString(optionalConstructorArg(), CLASS_NAME);\n+    }\n+\n+    public static AucRocMetric fromXContent(XContentParser parser) {\n+        return PARSER.apply(parser, null);\n+    }\n+\n+    public static AucRocMetric withCurveForClass(String className) {\n+        return new AucRocMetric(true, className);\n+    }\n+\n+    public static AucRocMetric forClass(String className) {\n+        return new AucRocMetric(false, className);\n+    }\n+\n+    private final boolean includeCurve;\n+    private final String className;\n+\n+    public AucRocMetric(Boolean includeCurve, String className) {\n+        this.includeCurve = includeCurve == null ? false : includeCurve;\n+        this.className = className;\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(XContentBuilder builder, ToXContent.Params params) throws IOException {\n+        builder\n+            .startObject()\n+            .field(INCLUDE_CURVE.getPreferredName(), includeCurve);\n+        if (className != null) {", "originalCommit": "43f30795327d709124b662fdc56b51ed7361af70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk1Njg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490956888", "bodyText": "Actually this field is required for the metric to make sense.\nChanged\u00a0class_name\u00a0to non-optional and changed the order of parameters so that the now-required\u00a0class_name\u00a0comes first (before optional include_curve).", "author": "przemekwitek", "createdAt": "2020-09-18T13:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3MTA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3NzYwNg==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490877606", "bodyText": "This was moved to classification.AucRocMetric?\nI think the class is big enough to deserve its own file. Not necessary for this review though", "author": "davidkyle", "createdAt": "2020-09-18T11:16:55Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/dataframe/evaluation/outlierdetection/AucRocMetric.java", "diffHunk": "@@ -87,155 +80,11 @@ public boolean equals(Object o) {\n         if (this == o) return true;\n         if (o == null || getClass() != o.getClass()) return false;\n         AucRocMetric that = (AucRocMetric) o;\n-        return Objects.equals(includeCurve, that.includeCurve);\n+        return includeCurve == that.includeCurve;\n     }\n \n     @Override\n     public int hashCode() {\n         return Objects.hash(includeCurve);\n     }\n-\n-    public static class Result implements EvaluationMetric.Result {", "originalCommit": "43f30795327d709124b662fdc56b51ed7361af70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkzMDUwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62304#discussion_r490930501", "bodyText": "This was moved to classification.AucRocMetric?\n\nYes, it was.\nThe idea is that classification package is the go-to location for all the classification evaluation code.\noutlierdetection evaluation package should have as little code as possible (ideally only a thin facilitation layer above classification evaluation).\n\nI think the class is big enough to deserve its own file. Not necessary for this review though\n\n+1. Let's do it in another PR.", "author": "przemekwitek", "createdAt": "2020-09-18T12:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3NzYwNg=="}], "type": "inlineReview"}, {"oid": "9fa454b050eed406c0540d400cea1844e1853ecd", "url": "https://github.com/elastic/elasticsearch/commit/9fa454b050eed406c0540d400cea1844e1853ecd", "message": "Apply review comments", "committedDate": "2020-09-18T13:44:23Z", "type": "forcePushed"}, {"oid": "f919c8532722349ebe13bb26b93c5cad91509a1a", "url": "https://github.com/elastic/elasticsearch/commit/f919c8532722349ebe13bb26b93c5cad91509a1a", "message": "Add top_classes_field to the Classification evaluation.", "committedDate": "2020-09-30T06:01:59Z", "type": "forcePushed"}, {"oid": "94af19d0020eaf951e75094528982b1a71a4e4a5", "url": "https://github.com/elastic/elasticsearch/commit/94af19d0020eaf951e75094528982b1a71a4e4a5", "message": "[ML] Implement AucRoc metric for classification - HLRC", "committedDate": "2020-09-30T06:57:49Z", "type": "commit"}, {"oid": "6b0d686c6a6f700bb022e6f581f4c8d442af68d1", "url": "https://github.com/elastic/elasticsearch/commit/6b0d686c6a6f700bb022e6f581f4c8d442af68d1", "message": "Apply review comments", "committedDate": "2020-09-30T06:57:50Z", "type": "commit"}, {"oid": "a6c31efcb735261cb16d89c1d023246c02299112", "url": "https://github.com/elastic/elasticsearch/commit/a6c31efcb735261cb16d89c1d023246c02299112", "message": "Add top_classes_field to the Classification evaluation.", "committedDate": "2020-09-30T06:57:50Z", "type": "commit"}, {"oid": "a6c31efcb735261cb16d89c1d023246c02299112", "url": "https://github.com/elastic/elasticsearch/commit/a6c31efcb735261cb16d89c1d023246c02299112", "message": "Add top_classes_field to the Classification evaluation.", "committedDate": "2020-09-30T06:57:50Z", "type": "forcePushed"}]}