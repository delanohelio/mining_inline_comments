{"pr_number": 60969, "pr_title": "Simplify distribution download and extraction", "pr_createdAt": "2020-08-11T14:12:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60969", "timeline": [{"oid": "e88254ac24457bc079d81c2399b640ef5f4f8ad6", "url": "https://github.com/elastic/elasticsearch/commit/e88254ac24457bc079d81c2399b640ef5f4f8ad6", "message": "Do not rely on Extraced.toString", "committedDate": "2020-08-12T13:16:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDcyNA==", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470834724", "bodyText": "Would it better to pass a parameter to the transform indicating the prefix expression to trim off vs having multiple implementations? I'm wondering if that capability might be useful for any other use case. If not, this pattern seems fine to me.", "author": "mark-vieira", "createdAt": "2020-08-14T19:48:58Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/transform/JdkUnzipTransform.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.transform;\n+\n+import org.apache.tools.zip.ZipEntry;\n+import org.elasticsearch.gradle.util.ArchiveUtils;\n+\n+import java.nio.file.Path;\n+\n+public abstract class JdkUnzipTransform extends UnzipTransform {", "originalCommit": "b771fc289249cce9dac121ec68196984a9b31a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0OTMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470949338", "bodyText": "Initially I tried to pass a lambda as transform parameter here which caused serialisation issues. Havn't thought about parameterising the trim method itself (facepalm). Did that now and it looks way better now \ud83d\udc4d", "author": "breskeby", "createdAt": "2020-08-15T07:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNzY4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470837681", "bodyText": "Just to clear my confusion, this can be resolved but not consumed which just means it can't be used by another project, right?", "author": "mark-vieira", "createdAt": "2020-08-14T19:55:58Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/JdkDownloadPlugin.java", "diffHunk": "@@ -41,22 +43,34 @@\n \n     @Override\n     public void apply(Project project) {\n+        Attribute<Boolean> jdkAttribute = Attribute.of(\"jdk\", Boolean.class);\n+        project.getDependencies().getAttributesSchema().attribute(jdkAttribute);\n         project.getDependencies().getArtifactTypes().maybeCreate(ArtifactTypeDefinition.ZIP_TYPE);\n-        project.getDependencies().registerTransform(UnzipTransform.class, transformSpec -> {\n-            transformSpec.getFrom().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.ZIP_TYPE);\n-            transformSpec.getTo().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+        project.getDependencies().registerTransform(JdkUnzipTransform.class, transformSpec -> {\n+            transformSpec.getFrom()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.ZIP_TYPE)\n+                .attribute(jdkAttribute, true);\n+            transformSpec.getTo()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE)\n+                .attribute(jdkAttribute, true);\n+            ;\n         });\n \n         ArtifactTypeDefinition tarArtifactTypeDefinition = project.getDependencies().getArtifactTypes().maybeCreate(\"tar.gz\");\n-        project.getDependencies().registerTransform(SymbolicLinkPreservingUntarTransform.class, transformSpec -> {\n-            transformSpec.getFrom().attribute(ArtifactAttributes.ARTIFACT_FORMAT, tarArtifactTypeDefinition.getName());\n-            transformSpec.getTo().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+        project.getDependencies().registerTransform(JdkSymbolicLinkPreservingUntarTransform.class, transformSpec -> {\n+            transformSpec.getFrom()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, tarArtifactTypeDefinition.getName())\n+                .attribute(jdkAttribute, true);\n+            transformSpec.getTo()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE)\n+                .attribute(jdkAttribute, true);\n         });\n \n         NamedDomainObjectContainer<Jdk> jdksContainer = project.container(Jdk.class, name -> {\n             Configuration configuration = project.getConfigurations().create(\"jdk_\" + name);\n             configuration.setCanBeConsumed(false);", "originalCommit": "b771fc289249cce9dac121ec68196984a9b31a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0MjI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470942280", "bodyText": "exactly", "author": "breskeby", "createdAt": "2020-08-15T05:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNzY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MDk4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470840989", "bodyText": "Man, it's awesome that we don't need this mess anymore.", "author": "mark-vieira", "createdAt": "2020-08-14T20:03:55Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -142,51 +140,6 @@ private Object resolveDependencyNotation(Project p, ElasticsearchDistribution di\n             .orElseGet(() -> dependencyNotation(distribution));\n     }\n \n-    private void setupRootDownload(Project rootProject, ElasticsearchDistribution distribution) {", "originalCommit": "b771fc289249cce9dac121ec68196984a9b31a37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "273660be85e92f8dac2fcacaebe8e6207a5d0e24", "url": "https://github.com/elastic/elasticsearch/commit/273660be85e92f8dac2fcacaebe8e6207a5d0e24", "message": "(WIP) Simplify distribution download and extraction", "committedDate": "2020-08-16T18:26:46Z", "type": "commit"}, {"oid": "4d15cba91096c72d7c559e658323bf15d1469329", "url": "https://github.com/elastic/elasticsearch/commit/4d15cba91096c72d7c559e658323bf15d1469329", "message": "Minor cleanup\n\n- remove unused code\n- fix jdk download func tests", "committedDate": "2020-08-16T18:26:47Z", "type": "commit"}, {"oid": "435dc74f755f0f690c4d8905a17545a501d5c32d", "url": "https://github.com/elastic/elasticsearch/commit/435dc74f755f0f690c4d8905a17545a501d5c32d", "message": "Fix integTests", "committedDate": "2020-08-16T18:26:47Z", "type": "commit"}, {"oid": "b72a6442c18b087f4ea45fa0bf4efc3d326467f6", "url": "https://github.com/elastic/elasticsearch/commit/b72a6442c18b087f4ea45fa0bf4efc3d326467f6", "message": "Port func test to spock specification", "committedDate": "2020-08-16T18:26:47Z", "type": "commit"}, {"oid": "3ff95d55bbf1dd9b0f8e361ff2e1a2c34684de77", "url": "https://github.com/elastic/elasticsearch/commit/3ff95d55bbf1dd9b0f8e361ff2e1a2c34684de77", "message": "Fix conflicting transforms", "committedDate": "2020-08-16T18:26:47Z", "type": "commit"}, {"oid": "7467104b06de75d0fefe82bbccc4d4c6ac386e5c", "url": "https://github.com/elastic/elasticsearch/commit/7467104b06de75d0fefe82bbccc4d4c6ac386e5c", "message": "Do not rely on Extraced.toString", "committedDate": "2020-08-16T18:26:47Z", "type": "commit"}, {"oid": "035c78e4e9875e6ccd2303c2faf0bd10074557ad", "url": "https://github.com/elastic/elasticsearch/commit/035c78e4e9875e6ccd2303c2faf0bd10074557ad", "message": "Fix imports", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "fb5d80db4a85e465f86f4fe8fb7cbe1fa0e28a4a", "url": "https://github.com/elastic/elasticsearch/commit/fb5d80db4a85e465f86f4fe8fb7cbe1fa0e28a4a", "message": "Fix permissions handling in unzip transform", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "38679fe9915040d1ffcd41e27f500971046068ba", "url": "https://github.com/elastic/elasticsearch/commit/38679fe9915040d1ffcd41e27f500971046068ba", "message": "Fix artifact type for bwc publications", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "b380d3a99d06d89c60e8ffeb48c87b286c706583", "url": "https://github.com/elastic/elasticsearch/commit/b380d3a99d06d89c60e8ffeb48c87b286c706583", "message": "Fix build-tool tests and jdk transformation", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "152c3df403293652082347fa175fa1e83bd964f4", "url": "https://github.com/elastic/elasticsearch/commit/152c3df403293652082347fa175fa1e83bd964f4", "message": "Fix conflicting unzip transforms", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "21fae36e5d5d6e5af6c413e7daff324d6bf8de81", "url": "https://github.com/elastic/elasticsearch/commit/21fae36e5d5d6e5af6c413e7daff324d6bf8de81", "message": "Fix handling of chmod on windows in UnzipTransform", "committedDate": "2020-08-16T18:26:48Z", "type": "commit"}, {"oid": "d95c52f11e1f8a8934f60589dee6b401bfb3f48d", "url": "https://github.com/elastic/elasticsearch/commit/d95c52f11e1f8a8934f60589dee6b401bfb3f48d", "message": "Polishing\n\n- make ant dependency explicit\n- share permission handling across unzip and untar transforms", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "e4dd2d2a36950c16c818d93bf13300a2906e1408", "url": "https://github.com/elastic/elasticsearch/commit/e4dd2d2a36950c16c818d93bf13300a2906e1408", "message": "Extends test coverage and polishing", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "e6dc749e0dca15152b34e58620c5ad13e7e0d158", "url": "https://github.com/elastic/elasticsearch/commit/e6dc749e0dca15152b34e58620c5ad13e7e0d158", "message": "Polish test coverage", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "fd237c99c9a98e9942f2e4eb84f6665370353731", "url": "https://github.com/elastic/elasticsearch/commit/fd237c99c9a98e9942f2e4eb84f6665370353731", "message": "Cleanup ElasticsearchDistribution", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "0d453ded0100800c657776c8e955b23baa57c0cd", "url": "https://github.com/elastic/elasticsearch/commit/0d453ded0100800c657776c8e955b23baa57c0cd", "message": "Fix formatting", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "e13442dbc608f18c15e779c8d9f87cee71366e60", "url": "https://github.com/elastic/elasticsearch/commit/e13442dbc608f18c15e779c8d9f87cee71366e60", "message": "Minor polishing", "committedDate": "2020-08-16T18:26:49Z", "type": "commit"}, {"oid": "fdb8ad25727d158f041bf148f27b878a86edf937", "url": "https://github.com/elastic/elasticsearch/commit/fdb8ad25727d158f041bf148f27b878a86edf937", "message": "Leverage transform parameters\n\n- apply review feedback", "committedDate": "2020-08-16T18:26:50Z", "type": "commit"}, {"oid": "fdb8ad25727d158f041bf148f27b878a86edf937", "url": "https://github.com/elastic/elasticsearch/commit/fdb8ad25727d158f041bf148f27b878a86edf937", "message": "Leverage transform parameters\n\n- apply review feedback", "committedDate": "2020-08-16T18:26:50Z", "type": "forcePushed"}]}