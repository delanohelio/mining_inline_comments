{"pr_number": 53998, "pr_title": "[ML] Data frame analytics data counts", "pr_createdAt": "2020-03-23T16:54:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53998", "timeline": [{"oid": "266cd1de3deaecd3a4f394fdd53f3a3192139cd6", "url": "https://github.com/elastic/elasticsearch/commit/266cd1de3deaecd3a4f394fdd53f3a3192139cd6", "message": "[ML] Data frame analytics data counts\n\nThis commit instruments data frame analytics\nwith stats for the data that are being analyzed.\nIn particular, we count training docs, test docs,\nand skipped docs.\n\nIn order to account docs with missing values as skipped\ndocs for analyses that do not support missing values,\nthis commit changes the extractor so that it only ignores\ndocs with missing values when it collects the data summary,\nwhich is used to estimate memory usage.", "committedDate": "2020-03-23T16:33:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxNTg5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53998#discussion_r396615892", "bodyText": "AnalyticsResultProcessor#cancel() should call this.statsPersister.cancel()", "author": "benwtrent", "createdAt": "2020-03-23T17:12:25Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsResultProcessor.java", "diffHunk": "@@ -77,22 +70,21 @@\n     private final StatsHolder statsHolder;\n     private final TrainedModelProvider trainedModelProvider;\n     private final DataFrameAnalyticsAuditor auditor;\n-    private final ResultsPersisterService resultsPersisterService;\n+    private final StatsPersister statsPersister;\n     private final List<ExtractedField> fieldNames;\n     private final CountDownLatch completionLatch = new CountDownLatch(1);\n     private volatile String failure;\n     private volatile boolean isCancelled;\n \n     public AnalyticsResultProcessor(DataFrameAnalyticsConfig analytics, DataFrameRowsJoiner dataFrameRowsJoiner,\n                                     StatsHolder statsHolder, TrainedModelProvider trainedModelProvider,\n-                                    DataFrameAnalyticsAuditor auditor, ResultsPersisterService resultsPersisterService,\n-                                    List<ExtractedField> fieldNames) {\n+                                    DataFrameAnalyticsAuditor auditor, StatsPersister statsPersister, List<ExtractedField> fieldNames) {\n         this.analytics = Objects.requireNonNull(analytics);\n         this.dataFrameRowsJoiner = Objects.requireNonNull(dataFrameRowsJoiner);\n         this.statsHolder = Objects.requireNonNull(statsHolder);\n         this.trainedModelProvider = Objects.requireNonNull(trainedModelProvider);\n         this.auditor = Objects.requireNonNull(auditor);\n-        this.resultsPersisterService = Objects.requireNonNull(resultsPersisterService);\n+        this.statsPersister = Objects.requireNonNull(statsPersister);\n         this.fieldNames = Collections.unmodifiableList(Objects.requireNonNull(fieldNames));\n     }\n ", "originalCommit": "266cd1de3deaecd3a4f394fdd53f3a3192139cd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzMTA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53998#discussion_r396631056", "bodyText": "We call it from AnalyticsProcessManager.stop(), which is the top owner of the persister.", "author": "dimitris-athanasiou", "createdAt": "2020-03-23T17:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxNTg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzMTU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53998#discussion_r396631581", "bodyText": "On second thought, it doesn't hurt also cancelling it from the results processor though. I'll do that.", "author": "dimitris-athanasiou", "createdAt": "2020-03-23T17:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxNTg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY0MDU0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53998#discussion_r396640543", "bodyText": "OK, it just seems weird that the thing using the persister is not also the thing canceling it. Ownership is hard to track.", "author": "benwtrent", "createdAt": "2020-03-23T17:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxNTg5Mg=="}], "type": "inlineReview"}, {"oid": "c852d9af61635119a40c03c24249f6b2cf223c88", "url": "https://github.com/elastic/elasticsearch/commit/c852d9af61635119a40c03c24249f6b2cf223c88", "message": "Cancel stats persister from result processor", "committedDate": "2020-03-23T18:30:40Z", "type": "commit"}, {"oid": "c5d5e69d3d18bc3d1e3401dbd6e11a8136526616", "url": "https://github.com/elastic/elasticsearch/commit/c5d5e69d3d18bc3d1e3401dbd6e11a8136526616", "message": "Merge branch 'master' into df-analytics-data-counts", "committedDate": "2020-03-23T20:27:07Z", "type": "commit"}]}