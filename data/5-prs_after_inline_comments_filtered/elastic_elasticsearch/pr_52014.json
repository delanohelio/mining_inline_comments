{"pr_number": 52014, "pr_title": "[ML] Better error when persistent task assignment disabled", "pr_createdAt": "2020-02-06T19:12:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52014", "timeline": [{"oid": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11", "url": "https://github.com/elastic/elasticsearch/commit/1cc2665eef8f8388d98369e9d99b1c6f7a43fc11", "message": "[ML] Better error when persistent task assignment disabled\n\nChanges the misleading error message when attempting to open\na job while the \"cluster.persistent_tasks.allocation.enable\"\nsetting is set to \"none\" to a clearer message that names the\nsetting.\n\nCloses #51956", "committedDate": "2020-02-06T19:05:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyOTk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52014#discussion_r376029952", "bodyText": "It's not ideal that this is done using contains.  The better solution would be to make Assignments contain a reason number or enum value as well as a text reason.  Then we could check that.  But that's obviously a pretty far-reaching change.  It may be worth waiting until there are more use cases for a reason code so that any implementation can take all the use cases into account.", "author": "droberts195", "createdAt": "2020-02-06T19:15:49Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java", "diffHunk": "@@ -560,7 +561,13 @@ public boolean test(PersistentTasksCustomMetaData.PersistentTask<?> persistentTa\n                         assignment.isAssigned() == false) {\n                     OpenJobAction.JobParams params = (OpenJobAction.JobParams) persistentTask.getParams();\n                     // Assignment has failed on the master node despite passing our \"fast fail\" validation\n-                    exception = makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());\n+                    if (assignment.equals(AWAITING_UPGRADE)) {\n+                        exception = makeCurrentlyBeingUpgradedException(logger, params.getJobId(), assignment.getExplanation());\n+                    } else if (assignment.getExplanation().contains(\"[\" + EnableAssignmentDecider.ALLOCATION_NONE_EXPLANATION + \"]\")) {", "originalCommit": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4eed227c9dccd7f2e8b4c2a839e6b081e0999bab", "url": "https://github.com/elastic/elasticsearch/commit/4eed227c9dccd7f2e8b4c2a839e6b081e0999bab", "message": "Fix test", "committedDate": "2020-02-07T15:47:26Z", "type": "commit"}, {"oid": "3e3de8254ef9be50d314550bb71bd543296c8d5e", "url": "https://github.com/elastic/elasticsearch/commit/3e3de8254ef9be50d314550bb71bd543296c8d5e", "message": "Merge branch 'master' into improve_assignment_disabled_error", "committedDate": "2020-02-07T16:29:21Z", "type": "commit"}]}