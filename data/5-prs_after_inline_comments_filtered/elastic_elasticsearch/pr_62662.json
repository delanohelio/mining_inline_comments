{"pr_number": 62662, "pr_title": "Fix RareClusterStateIT Publication Cancel", "pr_createdAt": "2020-09-18T19:50:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62662", "timeline": [{"oid": "01d768088c1f29e9e109c168c0134caffcc13c42", "url": "https://github.com/elastic/elasticsearch/commit/01d768088c1f29e9e109c168c0134caffcc13c42", "message": "Fix RareClusterStateIT Publication Cancel\n\nWe have to make sure the applier and not the accept state versions allign here.\nOtherwise we can get into the situation where the data node is so slow to process\none version that the next one arrives, gets rejected and the request return with\nack `false` and we fail the assertion that the put mapping request didn't complete.\n\nCloses #62446", "committedDate": "2020-09-18T19:49:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE1OTIzOA==", "url": "https://github.com/elastic/elasticsearch/pull/62662#discussion_r491159238", "bodyText": "Made this whole thing a little less weird to read as well here, the stream + iterator + array size assertion was just weirdly complicated.", "author": "original-brownbear", "createdAt": "2020-09-18T19:51:38Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/coordination/RareClusterStateIT.java", "diffHunk": "@@ -142,17 +140,16 @@ public void onFailure(String source, Exception e) {\n             ActionRequestBuilder<Req, Res> req) throws Exception {\n         // Wait for no publication in progress to not accidentally cancel a publication different from the one triggered by the given\n         // request.\n-        assertBusy(\n-            () -> {\n-                assertFalse(((Coordinator) internalCluster().getCurrentMasterNodeInstance(Discovery.class)).publicationInProgress());\n-                assertThat(StreamSupport.stream(\n-                    internalCluster().getInstances(Discovery.class).spliterator(), false)\n-                    .map(coordinator -> ((Coordinator) coordinator).getLastAcceptedState().version())\n-                    .distinct().toArray(), arrayWithSize(1));\n-            });\n+        final Coordinator masterCoordinator = (Coordinator) internalCluster().getCurrentMasterNodeInstance(Discovery.class);\n+        assertBusy(() -> {\n+            assertFalse(masterCoordinator.publicationInProgress());", "originalCommit": "01d768088c1f29e9e109c168c0134caffcc13c42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}