{"pr_number": 57185, "pr_title": "Ensure default watches are updated for rolling upgrades. ", "pr_createdAt": "2020-05-26T23:15:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57185", "timeline": [{"oid": "15222023755958175b39cbafe68cffd5982fae40", "url": "https://github.com/elastic/elasticsearch/commit/15222023755958175b39cbafe68cffd5982fae40", "message": "For a mixed cluster upgrade (add new version to existing cluster\nthen shutdown old instances), the watches that ship by default\nwith monitoring may not get properly updated to the new version.\nMonitoring watches can only get published if the internal state is\nmarked as dirty. If a node is not master, will also get marked as\nclean (e.g. not dirty).\n\nFor a mixed cluster upgrade, it is possible for the new node to be\nadded, not as master, the internal state gets marked as clean so\nthat no more attempts can be made to publish the watches. This\nhappens on all new nodes. Once the old nodes are de-commissioned\none of the new version nodes in the cluster gets promoted to master.\nHowever, that new master node (with out intervention like restarting\nthe node or removing/adding exporters) will never attempt to re-publish\nsince the internal state was already marked as clean.\n\nThis commit adds a cluster state listener to mark the resource dirty\nwhen a node is promoted to master. This will allow the new resource\nto be published without any intervention.", "committedDate": "2020-05-26T23:11:07Z", "type": "commit"}, {"oid": "7a663f6287acb6f5330834ca039e8bc6970a93aa", "url": "https://github.com/elastic/elasticsearch/commit/7a663f6287acb6f5330834ca039e8bc6970a93aa", "message": "move listener", "committedDate": "2020-05-27T00:34:07Z", "type": "commit"}, {"oid": "8319cf467fa2f56bcec3d5e67075368b1edb5591", "url": "https://github.com/elastic/elasticsearch/commit/8319cf467fa2f56bcec3d5e67075368b1edb5591", "message": "ensure to remove the listener", "committedDate": "2020-05-27T00:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433352977", "bodyText": "The way I read this, the resource will be marked as dirty any time the node becomes master, not just when it has become master after a mixed cluster upgrade. Am I reading that wrong or is that acceptable?", "author": "danhermann", "createdAt": "2020-06-01T16:37:44Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -424,6 +425,14 @@ public HttpExporter(final Config config, final SSLService sslService, final Thre\n \n         // mark resources as dirty after any node failure or license change\n         listener.setResource(resource);\n+\n+        //for a mixed cluster upgrade, ensure that if master changes and this is the master, allow the resources to re-publish\n+        onLocalMasterListener = clusterChangedEvent -> {\n+            if (clusterChangedEvent.nodesDelta().masterNodeChanged() && clusterChangedEvent.localNodeMaster()) {\n+                resource.markDirty();\n+            }\n+        };", "originalCommit": "8319cf467fa2f56bcec3d5e67075368b1edb5591", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM3MTU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433371581", "bodyText": "the resource will be marked as dirty any time the node becomes master\n\nThat is correct. However, I am not concerned about the overhead since marking it dirty it will only check to see if the resource exists (and the license level is OK). It will not re-put the watch... even it if it did, it would be functional no-op (putting the same thing that already exists). This all happens on the monitoring thread too, so no worry about extra work (except setting a boolean) on the cluster state applier thread.", "author": "jakelandis", "createdAt": "2020-06-01T17:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4MjcwMg==", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433382702", "bodyText": "Thanks! LGTM.", "author": "danhermann", "createdAt": "2020-06-01T17:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw=="}], "type": "inlineReview"}]}