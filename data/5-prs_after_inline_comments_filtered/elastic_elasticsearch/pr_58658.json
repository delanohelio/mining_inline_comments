{"pr_number": 58658, "pr_title": "Account for recovery throttling when restoring snapshot", "pr_createdAt": "2020-06-29T11:01:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58658", "timeline": [{"oid": "3fe7aa5696bf2eafd8cacb148d2bed493f5a80b5", "url": "https://github.com/elastic/elasticsearch/commit/3fe7aa5696bf2eafd8cacb148d2bed493f5a80b5", "message": "Use recovery settings for restore", "committedDate": "2020-06-29T10:01:48Z", "type": "commit"}, {"oid": "c224cd8287ff1cd19af47b8affcaaa55f00a72d6", "url": "https://github.com/elastic/elasticsearch/commit/c224cd8287ff1cd19af47b8affcaaa55f00a72d6", "message": "Add docs", "committedDate": "2020-06-29T10:12:39Z", "type": "commit"}, {"oid": "f454a442c09e297d9e4d316fff1898af7996fd93", "url": "https://github.com/elastic/elasticsearch/commit/f454a442c09e297d9e4d316fff1898af7996fd93", "message": "default max_restore_bytes_per_sec to unlimited", "committedDate": "2020-06-29T10:58:16Z", "type": "commit"}, {"oid": "35a1f569752bed83e481b602f201f9fae87f499b", "url": "https://github.com/elastic/elasticsearch/commit/35a1f569752bed83e481b602f201f9fae87f499b", "message": "checkstyle", "committedDate": "2020-06-29T13:36:26Z", "type": "commit"}, {"oid": "f44ad38b27545db9fcda958cb27a34ff0af879a6", "url": "https://github.com/elastic/elasticsearch/commit/f44ad38b27545db9fcda958cb27a34ff0af879a6", "message": "Update docs/plugins/repository-shared-settings.asciidoc\r\n\r\ndoc fix\n\nCo-authored-by: James Rodewig <james.rodewig@elastic.co>", "committedDate": "2020-06-29T13:58:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NzgwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447047809", "bodyText": "recoverySettings.rateLimiter() doesn't stay constant if you completely enable/disable recovery rate limiting. In peer recovery we get it anew for each file chunk sent/received, whereas here a change may only take effect at the start of a blob.", "author": "DaveCTurner", "createdAt": "2020-06-29T15:13:36Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -2032,7 +2037,8 @@ private static InputStream maybeRateLimit(InputStream stream, @Nullable RateLimi\n     }\n \n     public InputStream maybeRateLimitRestores(InputStream stream) {\n-        return maybeRateLimit(stream, restoreRateLimiter, restoreRateLimitingTimeInNanos);\n+        return maybeRateLimit(maybeRateLimit(stream, restoreRateLimiter, restoreRateLimitingTimeInNanos),\n+            recoverySettings.rateLimiter(), restoreRateLimitingTimeInNanos);", "originalCommit": "f44ad38b27545db9fcda958cb27a34ff0af879a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3MDMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447470339", "bodyText": "I've pushed a576d8d", "author": "ywelsch", "createdAt": "2020-06-30T07:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NzgwOQ=="}], "type": "inlineReview"}, {"oid": "a576d8d77ff6b77a04e41011591498d7dc9bc04b", "url": "https://github.com/elastic/elasticsearch/commit/a576d8d77ff6b77a04e41011591498d7dc9bc04b", "message": "More dynamic rate limiting", "committedDate": "2020-06-30T07:30:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4OTQ2NA==", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447489464", "bodyText": "I think this test would have passed before this change, although maybe a bit slower. Doesn't seem to be much slower, however. Can we somehow assert that it really does run at full speed at the end?\n(I couldn't think of a simple way to do this, we can leave it as-is if you can't either)", "author": "DaveCTurner", "createdAt": "2020-06-30T08:02:26Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -2072,6 +2072,57 @@ public void testThrottling() throws Exception {\n             .putNull(INDICES_RECOVERY_MAX_BYTES_PER_SEC_SETTING.getKey()).build()).get();\n     }\n \n+    public void testDynamicRestoreThrottling() throws Exception {", "originalCommit": "a576d8d77ff6b77a04e41011591498d7dc9bc04b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzMjA2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447532061", "bodyText": "I've pushed a5c576b. Let me know what you think", "author": "ywelsch", "createdAt": "2020-06-30T09:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4OTQ2NA=="}], "type": "inlineReview"}, {"oid": "a5c576b18c4f552cc99ffdceef169f6b11932eaa", "url": "https://github.com/elastic/elasticsearch/commit/a5c576b18c4f552cc99ffdceef169f6b11932eaa", "message": "stronger assertions", "committedDate": "2020-06-30T09:07:53Z", "type": "commit"}, {"oid": "e9b5b148ed354750a144f1f0af7c76d65fab2bf7", "url": "https://github.com/elastic/elasticsearch/commit/e9b5b148ed354750a144f1f0af7c76d65fab2bf7", "message": "Merge remote-tracking branch 'elastic/master' into use-recovery-settings-for-restore", "committedDate": "2020-06-30T09:08:15Z", "type": "commit"}, {"oid": "20e364fa60205583d68e7b6cb6dc745e97dc807a", "url": "https://github.com/elastic/elasticsearch/commit/20e364fa60205583d68e7b6cb6dc745e97dc807a", "message": "checkstyle", "committedDate": "2020-06-30T09:30:28Z", "type": "commit"}]}