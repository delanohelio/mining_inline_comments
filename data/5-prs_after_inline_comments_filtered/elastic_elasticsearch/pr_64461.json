{"pr_number": 64461, "pr_title": "Limit the Number of Snapshots in a BlobStoreRepository", "pr_createdAt": "2020-11-02T09:40:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64461", "timeline": [{"oid": "4a290c841b9a77cb86bec63fa402593b328f8059", "url": "https://github.com/elastic/elasticsearch/commit/4a290c841b9a77cb86bec63fa402593b328f8059", "message": "Limit the Number of Snapshots in a BlobStoreRepository\n\nAdds a limit to the maximum number of snapshots that are allowed\nto be added to a snapshot repository as a safety measure of last resort\nagainst repositories that grow to an unmanagable size due to e.g. incorrect SLM\nsettings.", "committedDate": "2020-11-02T09:30:34Z", "type": "commit"}, {"oid": "0a39d31341333382a9b1b177774c2d0c67bb5633", "url": "https://github.com/elastic/elasticsearch/commit/0a39d31341333382a9b1b177774c2d0c67bb5633", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-02T11:37:37Z", "type": "commit"}, {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "url": "https://github.com/elastic/elasticsearch/commit/f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "message": "CR: rename setting", "committedDate": "2020-11-02T11:43:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MTk2OA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515951968", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n          \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Cannot add another snapshot to this repository as it \" +", "author": "DaveCTurner", "createdAt": "2020-11-02T12:55:41Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515952570", "bodyText": "I think we should name the setting in the message (as done here) but think we shouldn't recommend increasing it if you hit the limit and should instead suggest deleting some snapshots and/or adjusting retention settings to bring the snapshot count below the limit.", "author": "DaveCTurner", "createdAt": "2020-11-02T12:56:47Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n+                        \"already contains [\" + existingSnapshotCount + \"] snapshots and is configured to hold up to [\" + maxSnapshotCount +\n+                        \"] snapshots only. Please increase repository setting [\" + MAX_SNAPSHOTS_SETTING.getKey() +", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk2MjA5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515962090", "bodyText": "++ adjusted the exception message", "author": "original-brownbear", "createdAt": "2020-11-02T13:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA=="}], "type": "inlineReview"}, {"oid": "2463271da49c4f8dd3229d6ebc24ed662d96101c", "url": "https://github.com/elastic/elasticsearch/commit/2463271da49c4f8dd3229d6ebc24ed662d96101c", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:13Z", "type": "commit"}, {"oid": "de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "url": "https://github.com/elastic/elasticsearch/commit/de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:26Z", "type": "commit"}, {"oid": "da46ccb71c280207c7429260101ce37904765b6c", "url": "https://github.com/elastic/elasticsearch/commit/da46ccb71c280207c7429260101ce37904765b6c", "message": "Update server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:42Z", "type": "commit"}, {"oid": "990d83bafc710d5b1347d1036d6a1375f6380569", "url": "https://github.com/elastic/elasticsearch/commit/990d83bafc710d5b1347d1036d6a1375f6380569", "message": "adjust exception msg", "committedDate": "2020-11-02T13:05:58Z", "type": "commit"}, {"oid": "80510e2810aca06673d98b6a48ee1c8bfd15e131", "url": "https://github.com/elastic/elasticsearch/commit/80510e2810aca06673d98b6a48ee1c8bfd15e131", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-02T13:46:53Z", "type": "commit"}, {"oid": "aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "url": "https://github.com/elastic/elasticsearch/commit/aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-03T12:00:27Z", "type": "commit"}]}