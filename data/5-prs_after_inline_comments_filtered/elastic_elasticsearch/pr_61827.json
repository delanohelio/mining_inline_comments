{"pr_number": 61827, "pr_title": "Support point in time cross cluster search", "pr_createdAt": "2020-09-02T02:27:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61827", "timeline": [{"oid": "22850fa5a4435b56b80e94a5c7132d341a2677f8", "url": "https://github.com/elastic/elasticsearch/commit/22850fa5a4435b56b80e94a5c7132d341a2677f8", "message": "Support point in time cross cluster search", "committedDate": "2020-09-02T02:17:03Z", "type": "commit"}, {"oid": "e207090bbbada80349a69dd734a7d62aa6eb5065", "url": "https://github.com/elastic/elasticsearch/commit/e207090bbbada80349a69dd734a7d62aa6eb5065", "message": "stylecheck", "committedDate": "2020-09-02T02:45:42Z", "type": "commit"}, {"oid": "81d6b49be1c7be37bf2af420555d3a059c156d85", "url": "https://github.com/elastic/elasticsearch/commit/81d6b49be1c7be37bf2af420555d3a059c156d85", "message": "leftover", "committedDate": "2020-09-02T03:41:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyOTY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r482329658", "bodyText": "I think we should still accept the param if it is set to false ?", "author": "jimczi", "createdAt": "2020-09-02T19:20:05Z", "path": "server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java", "diffHunk": "@@ -308,6 +309,11 @@ static void preparePointInTime(SearchRequest request, NamedWriteableRegistry nam\n         if (request.preference() != null) {\n             validationException = addValidationError(\"[preference] cannot be used with point in time\", validationException);\n         }\n+        if (restRequest.hasParam(\"ccs_minimize_roundtrips\")) {", "originalCommit": "81d6b49be1c7be37bf2af420555d3a059c156d85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MjczMA==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r485852730", "bodyText": "Fixed in 44f14d3", "author": "dnhatn", "createdAt": "2020-09-09T19:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyOTY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzMDEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r482330106", "bodyText": "Why is it needed ?", "author": "jimczi", "createdAt": "2020-09-02T19:20:37Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/TransportOpenPointInTimeAction.java", "diffHunk": "@@ -72,6 +72,7 @@ protected void doExecute(Task task, OpenPointInTimeRequest request, ActionListen\n             .preference(request.preference())\n             .routing(request.routing())\n             .allowPartialSearchResults(false);\n+        searchRequest.setCcsMinimizeRoundtrips(false);", "originalCommit": "81d6b49be1c7be37bf2af420555d3a059c156d85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MzcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r485853723", "bodyText": "We need to disable ccs_minimize_roundtrips because we don't know how to merge a point in time from multiple sub-search requests.", "author": "dnhatn", "createdAt": "2020-09-09T19:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzMDEwNg=="}], "type": "inlineReview"}, {"oid": "293869407ae0e9bcb89c8e93ecc03a0821aa8652", "url": "https://github.com/elastic/elasticsearch/commit/293869407ae0e9bcb89c8e93ecc03a0821aa8652", "message": "Merge branch 'master' into ccs-with-pit", "committedDate": "2020-09-06T18:13:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzNTE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r485235164", "bodyText": "While this is something that we'll need in the future I don't think we can afford adding replicas other than the original one now. There's no chance that the query succeeds there so that's confusing for users (and could faild some tests) if we return a search context missing exception every time there's an exception on the matching node.", "author": "jimczi", "createdAt": "2020-09-08T22:43:52Z", "path": "server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java", "diffHunk": "@@ -535,13 +567,33 @@ private void executeLocalSearch(Task task, SearchTimeProvider timeProvider, Sear\n                 remoteShardIterators.add(shardIterator);\n             }\n         }\n-        return (clusterAlias, nodeId) -> {\n-                Map<String, DiscoveryNode> clusterNodes = clusterToNode.get(clusterAlias);\n-                if (clusterNodes == null) {\n-                    throw new IllegalArgumentException(\"unknown remote cluster: \" + clusterAlias);\n+        return remoteShardIterators;\n+    }\n+\n+    static List<SearchShardIterator> getRemoteShardsIteratorFromPointInTime(Map<String, ClusterSearchShardsResponse> searchShardsResponses,\n+                                                                            SearchContextId searchContextId,\n+                                                                            TimeValue searchContextKeepAlive,\n+                                                                            Map<String, OriginalIndices> remoteClusterIndices) {\n+        final List<SearchShardIterator> remoteShardIterators = new ArrayList<>();\n+        for (Map.Entry<String, ClusterSearchShardsResponse> entry : searchShardsResponses.entrySet()) {\n+            for (ClusterSearchShardsGroup group : entry.getValue().getGroups()) {\n+                final ShardId shardId = group.getShardId();\n+                final String clusterAlias = entry.getKey();\n+                final SearchContextIdForNode perNode = searchContextId.shards().get(shardId);\n+                assert clusterAlias.equals(perNode.getClusterAlias()) : clusterAlias + \" != \" + perNode.getClusterAlias();\n+                final List<String> nodeIds = new ArrayList<>();\n+                nodeIds.add(perNode.getNode()); // always search with the matching node first\n+                for (ShardRouting shard : group.getShards()) {\n+                    if (perNode.getNode().equals(shard.currentNodeId()) == false) {\n+                        nodeIds.add(shard.currentNodeId());", "originalCommit": "293869407ae0e9bcb89c8e93ecc03a0821aa8652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0NjQ2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r485846461", "bodyText": "++. Let's reintroduce this when we implement the retry. See: 0a99df6", "author": "dnhatn", "createdAt": "2020-09-09T19:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzNTE2NA=="}], "type": "inlineReview"}, {"oid": "cc88c83234526df53fc7adf36f77076367a55509", "url": "https://github.com/elastic/elasticsearch/commit/cc88c83234526df53fc7adf36f77076367a55509", "message": "Merge branch 'master' into ccs-with-pit", "committedDate": "2020-09-09T15:50:32Z", "type": "commit"}, {"oid": "f83433bbca3640d23dd8b988d5646553dc3b334b", "url": "https://github.com/elastic/elasticsearch/commit/f83433bbca3640d23dd8b988d5646553dc3b334b", "message": "Fix NPE", "committedDate": "2020-09-09T16:06:36Z", "type": "commit"}, {"oid": "44f14d3785db37de1fa33ec197e3501523d220de", "url": "https://github.com/elastic/elasticsearch/commit/44f14d3785db37de1fa33ec197e3501523d220de", "message": "feedback rest params", "committedDate": "2020-09-09T18:52:22Z", "type": "commit"}, {"oid": "0a99df6e9a3cf1834b19e23bc9f2076358ab94ed", "url": "https://github.com/elastic/elasticsearch/commit/0a99df6e9a3cf1834b19e23bc9f2076358ab94ed", "message": "Do not add unmatched shard routing", "committedDate": "2020-09-09T19:02:47Z", "type": "commit"}, {"oid": "af61fcbceb5928a1440f0b6b3b4020eb93a27574", "url": "https://github.com/elastic/elasticsearch/commit/af61fcbceb5928a1440f0b6b3b4020eb93a27574", "message": "stylecheck", "committedDate": "2020-09-09T19:13:00Z", "type": "commit"}, {"oid": "3e0180448815d3e0ee463e02f9d5be6974b687a7", "url": "https://github.com/elastic/elasticsearch/commit/3e0180448815d3e0ee463e02f9d5be6974b687a7", "message": "accept no params or false for ccs_minimize_roundtrips", "committedDate": "2020-09-09T20:19:01Z", "type": "commit"}, {"oid": "e8a94e95ca9cdc450ec15ade7973705afa3cf0c3", "url": "https://github.com/elastic/elasticsearch/commit/e8a94e95ca9cdc450ec15ade7973705afa3cf0c3", "message": "remove AwaitsFix in async search", "committedDate": "2020-09-09T20:33:40Z", "type": "commit"}, {"oid": "b5658a1368f459ca3a1692c27111b2667a8b1dfa", "url": "https://github.com/elastic/elasticsearch/commit/b5658a1368f459ca3a1692c27111b2667a8b1dfa", "message": "oops", "committedDate": "2020-09-09T21:31:10Z", "type": "commit"}, {"oid": "b3f662483b4179c37f667cc6e3d26c1c9d3b7d5c", "url": "https://github.com/elastic/elasticsearch/commit/b3f662483b4179c37f667cc6e3d26c1c9d3b7d5c", "message": "check if index exists", "committedDate": "2020-09-09T23:22:13Z", "type": "commit"}]}