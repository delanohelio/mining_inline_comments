{"pr_number": 66736, "pr_title": "[ML] Pass extra JSON config files to autodetect", "pr_createdAt": "2020-12-22T12:00:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66736", "timeline": [{"oid": "b160c09f53f34bb9f78f47411d736dbd5ce638b9", "url": "https://github.com/elastic/elasticsearch/commit/b160c09f53f34bb9f78f47411d736dbd5ce638b9", "message": "[ML] Pass extra JSON config files to autodetect\n\nPass JSON files containing rule filters and scheduled\nevents configuration to autodetect.\n\nThis change must not be merged until after elastic/ml-cpp#1640 as the\nC++ backend code must be able to safely consume the new command line\noptions.\n\nRelates elastic/ml-cpp#1253", "committedDate": "2020-12-22T11:47:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMyMDU5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66736#discussion_r547320596", "bodyText": "It's very non-standard in Elasticsearch to have a JSON document whose outermost level is an array.  That's why you've had to hand-craft a writer instead of using standard mechanisms.  I think instead you should use a format similar to the get scheduled events API response, with the document being an object at its outermost level, and containing a field events that is the array of scheduled events.  If you can tolerate the superfluous count you could actually reuse GetCalendarEventsAction.Response to create and print this.  Or create a new very simple ToXContentObject that contains a List<ScheduledEvent> and uses builder.field(\"events\", scheduledEvents) in its toXContent method.\nThen you'll need to change the C++ parser to accept the extra object layer and events field, but there needs to be a second PR on the C++ side anyway and since the current C++ code is disabled this PR can still be merged before the second round of C++ updates.", "author": "droberts195", "createdAt": "2020-12-22T14:51:26Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/writer/ScheduledEventsWriter.java", "diffHunk": "@@ -58,4 +58,21 @@ public void write() throws IOException {\n             ++eventIndex;\n         }\n     }\n+\n+    public void writeJson() throws IOException {\n+        buffer.append('[');\n+        boolean first = true;\n+        for (ScheduledEvent event : scheduledEvents) {\n+            if (first) {\n+                first = false;\n+            } else {\n+                buffer.append(',');\n+            }\n+\n+            try (XContentBuilder contentBuilder = XContentFactory.jsonBuilder()) {\n+                buffer.append(Strings.toString(event.writeJson(bucketSpan, contentBuilder)));\n+            }\n+        }\n+        buffer.append(']');\n+    }", "originalCommit": "b160c09f53f34bb9f78f47411d736dbd5ce638b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78e6aa174ddfbbe6c9fa641f3446a9736aced8f0", "url": "https://github.com/elastic/elasticsearch/commit/78e6aa174ddfbbe6c9fa641f3446a9736aced8f0", "message": "[ML] Attend to code review comments\n\nModified JSON configuration format for both scheduled events and for\nfilters to be objects (rather than arrays).", "committedDate": "2020-12-23T14:52:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI4OTYzMw==", "url": "https://github.com/elastic/elasticsearch/pull/66736#discussion_r551289633", "bodyText": "As we're streaming scheduled events, I think it would be clearer to map these to a ScheduledEventToRuleWriter. Then the RULES ParseField added in ScheduledEvent can move in that writer class.", "author": "dimitris-athanasiou", "createdAt": "2021-01-04T12:31:17Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "diffHunk": "@@ -365,6 +372,28 @@ private void buildFieldConfig(List<String> command) throws IOException {\n         }\n     }\n \n+    private void buildScheduledEventsConfig(List<String> command) throws IOException {\n+        if (scheduledEvents.isEmpty()) {\n+            return;\n+        }\n+        Path eventsConfigFile = Files.createTempFile(env.tmpFile(), \"eventsConfig\", JSON_EXTENSION);\n+        filesToDelete.add(eventsConfigFile);\n+\n+        List<DetectionRuleWriter> detectionRuleWriters = scheduledEvents.stream()", "originalCommit": "78e6aa174ddfbbe6c9fa641f3446a9736aced8f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "234ddbde33a3ed24631d218f7ed5dda59f159f54", "url": "https://github.com/elastic/elasticsearch/commit/234ddbde33a3ed24631d218f7ed5dda59f159f54", "message": "Attend to code review comments", "committedDate": "2021-01-04T13:56:28Z", "type": "commit"}]}