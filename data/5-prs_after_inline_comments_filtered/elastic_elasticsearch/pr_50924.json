{"pr_number": 50924, "pr_title": "Allow installing multiple plugins as a transaction", "pr_createdAt": "2020-01-13T15:39:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50924", "timeline": [{"oid": "464c66695c276a2a4cc2c362a9062560c86df488", "url": "https://github.com/elastic/elasticsearch/commit/464c66695c276a2a4cc2c362a9062560c86df488", "message": "Allow installing multiple plugins as a transaction\n\nThis commit allows the plugin installer to install multiple plugins in a\nsingle invocation. The installation will be treated as a transaction, so\nthat all of the plugins are install successfully, or none of the plugins\nare installed.", "committedDate": "2020-01-13T15:30:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTQyOA==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366101428", "bodyText": "Maybe \"At least one plugin id is required\"?", "author": "rjernst", "createdAt": "2020-01-14T00:35:07Z", "path": "distribution/tools/plugin-cli/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java", "diffHunk": "@@ -206,24 +206,50 @@ protected void printAdditionalHelp(Terminal terminal) {\n \n     @Override\n     protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {\n-        String pluginId = arguments.value(options);\n+        List<String> pluginId = arguments.values(options);\n         final boolean isBatch = options.has(batchOption);\n         execute(terminal, pluginId, isBatch, env);\n     }\n \n     // pkg private for testing\n-    void execute(Terminal terminal, String pluginId, boolean isBatch, Environment env) throws Exception {\n-        if (pluginId == null) {\n-            throw new UserException(ExitCodes.USAGE, \"plugin id is required\");\n+    void execute(Terminal terminal, List<String> pluginIds, boolean isBatch, Environment env) throws Exception {\n+        if (pluginIds.isEmpty()) {\n+            throw new UserException(ExitCodes.USAGE, \"plugin ids are required\");", "originalCommit": "464c66695c276a2a4cc2c362a9062560c86df488", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMxODk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366318977", "bodyText": "I reworded this as you suggest.", "author": "jasontedor", "createdAt": "2020-01-14T12:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNDA2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366104062", "bodyText": "Maybe we should emit each as we go? Dumping at the end seems counter to giving progress, which is the intention of this message IMO.", "author": "rjernst", "createdAt": "2020-01-14T00:46:23Z", "path": "distribution/tools/plugin-cli/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java", "diffHunk": "@@ -206,24 +206,50 @@ protected void printAdditionalHelp(Terminal terminal) {\n \n     @Override\n     protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {\n-        String pluginId = arguments.value(options);\n+        List<String> pluginId = arguments.values(options);\n         final boolean isBatch = options.has(batchOption);\n         execute(terminal, pluginId, isBatch, env);\n     }\n \n     // pkg private for testing\n-    void execute(Terminal terminal, String pluginId, boolean isBatch, Environment env) throws Exception {\n-        if (pluginId == null) {\n-            throw new UserException(ExitCodes.USAGE, \"plugin id is required\");\n+    void execute(Terminal terminal, List<String> pluginIds, boolean isBatch, Environment env) throws Exception {\n+        if (pluginIds.isEmpty()) {\n+            throw new UserException(ExitCodes.USAGE, \"plugin ids are required\");\n         }\n \n-        if (\"x-pack\".equals(pluginId)) {\n-            handleInstallXPack(buildFlavor());\n+        final Set<String> uniquePluginIds = new HashSet<>();\n+        for (final String pluginId : pluginIds) {\n+            if (uniquePluginIds.add(pluginId) == false) {\n+                throw new UserException(ExitCodes.USAGE, \"duplicate plugin id [\" + pluginId + \"]\");\n+            }\n+        }\n+\n+        final List<Path> deleteOnFailure = new ArrayList<>();\n+        final Set<PluginInfo> pluginInfos = new HashSet<>();\n+        for (final String pluginId : pluginIds) {\n+            try {\n+                if (\"x-pack\".equals(pluginId)) {\n+                    handleInstallXPack(buildFlavor());\n+                }\n+\n+                final Path pluginZip = download(terminal, pluginId, env.tmpFile(), isBatch);\n+                final Path extractedZip = unzip(pluginZip, env.pluginsFile());\n+                deleteOnFailure.add(extractedZip);\n+                final PluginInfo pluginInfo = installPlugin(terminal, isBatch, extractedZip, env, deleteOnFailure);\n+                pluginInfos.add(pluginInfo);\n+            } catch (final Exception installProblem) {\n+                try {\n+                    IOUtils.rm(deleteOnFailure.toArray(new Path[0]));\n+                } catch (final IOException exceptionWhileRemovingFiles) {\n+                    installProblem.addSuppressed(exceptionWhileRemovingFiles);\n+                }\n+                throw installProblem;\n+            }\n         }\n \n-        Path pluginZip = download(terminal, pluginId, env.tmpFile(), isBatch);\n-        Path extractedZip = unzip(pluginZip, env.pluginsFile());\n-        install(terminal, isBatch, extractedZip, env);\n+        for (final PluginInfo pluginInfo : pluginInfos) {\n+            terminal.println(\"-> Installed \" + pluginInfo.getName());", "originalCommit": "464c66695c276a2a4cc2c362a9062560c86df488", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEyNDQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366124494", "bodyText": "I\u2019m not sure we should dump as we go since it\u2019s transactional? That is, \u201cinstalled X\u201d is a lie if we remove it if Y failed?", "author": "jasontedor", "createdAt": "2020-01-14T02:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNDA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4MDk1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r370180953", "bodyText": "Relates #51001", "author": "jasontedor", "createdAt": "2020-01-23T15:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNDA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNTE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366105171", "bodyText": "Can we also add tests for the duplicate plugin detection, and failure case wiping the plugins (ie making sure the transactional behavior works)?", "author": "rjernst", "createdAt": "2020-01-14T00:50:56Z", "path": "distribution/tools/plugin-cli/src/test/java/org/elasticsearch/plugins/InstallPluginCommandTests.java", "diffHunk": "@@ -393,6 +401,16 @@ public void testSomethingWorks() throws Exception {\n         assertPlugin(\"fake\", pluginDir, env.v2());\n     }\n \n+    public void testMultipleWorks() throws Exception {", "originalCommit": "464c66695c276a2a4cc2c362a9062560c86df488", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMxODkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366318905", "bodyText": "I pushed tests for this.", "author": "jasontedor", "createdAt": "2020-01-14T12:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNTE3MQ=="}], "type": "inlineReview"}, {"oid": "c15a98c48a02194f22da77caafb42fb05a4c65b4", "url": "https://github.com/elastic/elasticsearch/commit/c15a98c48a02194f22da77caafb42fb05a4c65b4", "message": "Iteration", "committedDate": "2020-01-14T12:48:31Z", "type": "commit"}, {"oid": "6892024ad7955599a7d5613d0a2e9034c6d955e5", "url": "https://github.com/elastic/elasticsearch/commit/6892024ad7955599a7d5613d0a2e9034c6d955e5", "message": "Merge branch 'master' into multiple-plugins", "committedDate": "2020-01-14T14:57:57Z", "type": "commit"}]}