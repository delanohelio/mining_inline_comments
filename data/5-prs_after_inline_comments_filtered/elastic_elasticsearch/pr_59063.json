{"pr_number": 59063, "pr_title": "EQL: Introduce sequencing fetch size", "pr_createdAt": "2020-07-06T11:47:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59063", "timeline": [{"oid": "7bfbcc68c2e51c3d3cc09ded57ae97799448532d", "url": "https://github.com/elastic/elasticsearch/commit/7bfbcc68c2e51c3d3cc09ded57ae97799448532d", "message": "First attempt in adding fetchSize alongside size", "committedDate": "2020-07-06T11:39:13Z", "type": "commit"}, {"oid": "d2238637686567c93950f2943609db5f3f71d8fe", "url": "https://github.com/elastic/elasticsearch/commit/d2238637686567c93950f2943609db5f3f71d8fe", "message": "Integrate size/fetch size as LimitWithOffset within the planExecutor\n\nCombine the request size and pipe declaration with the query into one\nFor eventQuery push the limit into the query, for sequences keep the\nlimit on the sequence but push the fetch size in the queries.", "committedDate": "2020-07-06T11:39:14Z", "type": "commit"}, {"oid": "a7a467731f64ad765b6fc16a8b3572a5f804d7d8", "url": "https://github.com/elastic/elasticsearch/commit/a7a467731f64ad765b6fc16a8b3572a5f804d7d8", "message": "Add fetch size parameter in the rest client API", "committedDate": "2020-07-06T11:39:14Z", "type": "commit"}, {"oid": "0d8c04b2ff3d133a3e8b9d01eb8888c0498f9c47", "url": "https://github.com/elastic/elasticsearch/commit/0d8c04b2ff3d133a3e8b9d01eb8888c0498f9c47", "message": "skip stages only when there are no candidates on the current stage", "committedDate": "2020-07-06T11:39:14Z", "type": "commit"}, {"oid": "9e15b4f51992a6762b32513c48bab96ef8bbe832", "url": "https://github.com/elastic/elasticsearch/commit/9e15b4f51992a6762b32513c48bab96ef8bbe832", "message": "Don't set beginning of follow-up query to avoid them jumping over data", "committedDate": "2020-07-06T11:39:15Z", "type": "commit"}, {"oid": "6c5ca1fea8495c0d7bbee2ed196c335e14ff2272", "url": "https://github.com/elastic/elasticsearch/commit/6c5ca1fea8495c0d7bbee2ed196c335e14ff2272", "message": "Update query next only when at least one result has been returned", "committedDate": "2020-07-06T11:39:15Z", "type": "commit"}, {"oid": "4b3f7efb86104da2abbf16f8592cbb98db219013", "url": "https://github.com/elastic/elasticsearch/commit/4b3f7efb86104da2abbf16f8592cbb98db219013", "message": "Reinitialize pointer when doing desc/asc queries", "committedDate": "2020-07-06T11:39:15Z", "type": "commit"}, {"oid": "e0d2f7d3ef45f961b659cf69a5b6ef1852be351f", "url": "https://github.com/elastic/elasticsearch/commit/e0d2f7d3ef45f961b659cf69a5b6ef1852be351f", "message": "Increase the default size of results in testing", "committedDate": "2020-07-06T11:39:16Z", "type": "commit"}, {"oid": "9c9c8b2b921a57516320e62b676db5c65f8711f9", "url": "https://github.com/elastic/elasticsearch/commit/9c9c8b2b921a57516320e62b676db5c65f8711f9", "message": "Update EQL client test", "committedDate": "2020-07-06T12:50:10Z", "type": "commit"}, {"oid": "9c9c8b2b921a57516320e62b676db5c65f8711f9", "url": "https://github.com/elastic/elasticsearch/commit/9c9c8b2b921a57516320e62b676db5c65f8711f9", "message": "Update EQL client test", "committedDate": "2020-07-06T12:50:10Z", "type": "forcePushed"}, {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8", "url": "https://github.com/elastic/elasticsearch/commit/a108555d478a526c208cb4e25bc6ce85b14c8fe8", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/match-size", "committedDate": "2020-07-06T14:12:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NDM0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450294345", "bodyText": "I would rename the arg to fetchSize", "author": "matriv", "createdAt": "2020-07-06T15:17:18Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -172,14 +175,26 @@ public EqlSearchRequest implicitJoinKeyField(String implicitJoinKeyField) {\n         return this;\n     }\n \n+    public int size() {\n+        return this.size;\n+    }\n+\n+    public EqlSearchRequest size(int size) {\n+        this.size = size;\n+        if (fetchSize <= 0) {\n+            throw new IllegalArgumentException(\"size must be greater than 0\");\n+        }\n+        return this;\n+    }\n+\n     public int fetchSize() {\n         return this.fetchSize;\n     }\n \n     public EqlSearchRequest fetchSize(int size) {", "originalCommit": "a108555d478a526c208cb4e25bc6ce85b14c8fe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMxNTE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450315149", "bodyText": "Will rename it in a follow-up PR. I'd like to merge this in considering it took 3 times due to transient issues and backport it to 7.x", "author": "costin", "createdAt": "2020-07-06T15:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NDM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NTA2OA==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450295068", "bodyText": "Does it make sense to make it a random between let's say 1 and 10?", "author": "matriv", "createdAt": "2020-07-06T15:18:21Z", "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -144,6 +144,9 @@ protected EqlSearchResponse runQuery(String index, String query, boolean isCaseS\n         EqlSearchRequest request = new EqlSearchRequest(testIndexName, query);\n         request.isCaseSensitive(isCaseSensitive);\n         request.tiebreakerField(\"event.sequence\");\n+        // some queries return more than 10 results\n+        request.size(50);\n+        request.fetchSize(2);", "originalCommit": "a108555d478a526c208cb4e25bc6ce85b14c8fe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMxNDc3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450314779", "bodyText": "It does - it has to be 2 since we're talking about a window (1 would work but the algo would have to change - that requires an extra call that I'd rather avoid).\nI've pushed it with 2 just to get the build running enough times with this minimum size - I'll follow-up in the until PR with random.", "author": "costin", "createdAt": "2020-07-06T15:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NTA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMjcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450332718", "bodyText": "@jrodewig A heads-up on these two parameters.\nThe default size of the response changed to 10 from 50 (aligned with that of the search api).\nAdditionally the fetch_size parameters has been introduced to indicate how large the page for sequence matching is. A large page means faster results and less search calls but it does so at the expense of memory (more data needs to be returned).", "author": "costin", "createdAt": "2020-07-06T16:16:27Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -60,6 +61,7 @@\n     static final String KEY_IMPLICIT_JOIN_KEY_FIELD = \"implicit_join_key_field\";\n     static final String KEY_CASE_SENSITIVE = \"case_sensitive\";\n     static final String KEY_SIZE = \"size\";", "originalCommit": "a108555d478a526c208cb4e25bc6ce85b14c8fe8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1NjIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450356201", "bodyText": "Thanks for the heads up. #59085 should already cover the changes to size. I'll work on documenting the fetch_size param.", "author": "jrodewig", "createdAt": "2020-07-06T16:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMjcxOA=="}], "type": "inlineReview"}]}