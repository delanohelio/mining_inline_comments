{"pr_number": 59099, "pr_title": "Fix lookup support in adjacency matrix", "pr_createdAt": "2020-07-06T20:13:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59099", "timeline": [{"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e", "url": "https://github.com/elastic/elasticsearch/commit/6888eb865bc9cc1e2158afffffb9b52917f53d2e", "message": "Fix lookup support in adjacency matrix\n\nThis request:\n```\nPOST /_search\n{\n  \"aggs\": {\n    \"a\": {\n      \"adjacency_matrix\": {\n        \"filters\": {\n          \"1\": {\n            \"terms\": { \"t\": { \"index\": \"lookup\", \"id\": \"1\", \"path\": \"t\" } }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nWould fail with a 500 error and a message like:\n```\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"illegal_state_exception\",\n        \"reason\":\"async actions are left after rewrite\"\n      }\n    ]\n  }\n}\n```\n\nThis fixes that by moving the query rewrite phase from a synchronous\ncall on the data nodes into the standard aggregation rewrite phase which\ncan properly handle the asynchronous actions.", "committedDate": "2020-07-06T20:12:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456685", "bodyText": "I just bumped into this when I was looking at the agg.", "author": "nik9000", "createdAt": "2020-07-06T20:16:31Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregator.java", "diffHunk": "@@ -123,7 +123,7 @@ public boolean equals(Object obj) {\n     }\n \n     private final String[] keys;\n-    private Weight[] filters;\n+    private final Weight[] filters;", "originalCommit": "6888eb865bc9cc1e2158afffffb9b52917f53d2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456834", "bodyText": "These were confusing because above they are referred to without this but below they had it.", "author": "nik9000", "createdAt": "2020-07-06T20:16:49Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregatorFactory.java", "diffHunk": "@@ -50,9 +50,9 @@ public AdjacencyMatrixAggregatorFactory(String name, List<KeyedFilter> filters,\n         keys = new String[filters.size()];\n         for (int i = 0; i < filters.size(); ++i) {\n             KeyedFilter keyedFilter = filters.get(i);\n-            this.keys[i] = keyedFilter.key();\n+            keys[i] = keyedFilter.key();", "originalCommit": "6888eb865bc9cc1e2158afffffb9b52917f53d2e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8f8bdce2f48bfce4a4b4dd46baa696a7774b0eb", "url": "https://github.com/elastic/elasticsearch/commit/e8f8bdce2f48bfce4a4b4dd46baa696a7774b0eb", "message": "Skip old", "committedDate": "2020-07-06T21:58:40Z", "type": "commit"}]}