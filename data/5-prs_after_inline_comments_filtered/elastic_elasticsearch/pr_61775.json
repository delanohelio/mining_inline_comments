{"pr_number": 61775, "pr_title": "Runtime fields to expose _source and stored fields like existing scripts", "pr_createdAt": "2020-09-01T10:49:58Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61775", "timeline": [{"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d", "url": "https://github.com/elastic/elasticsearch/commit/261b92a628e3b35ce58540f17844fcf95dab5c6d", "message": "Runtime fields to expose _source and stored fields like other script fields\n\nThis commit exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source .", "committedDate": "2020-09-01T12:17:32Z", "type": "commit"}, {"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d", "url": "https://github.com/elastic/elasticsearch/commit/261b92a628e3b35ce58540f17844fcf95dab5c6d", "message": "Runtime fields to expose _source and stored fields like other script fields\n\nThis commit exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source .", "committedDate": "2020-09-01T12:17:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481181031", "bodyText": "@javanna and I talked about this over video - I think that this syntax dates back to when we used mvel and the only reason for us to stick with it is backwards compatibility. But that aggregation scripts didn't really support _source before so maybe it isn't worth adding it to runtime fields like this. But we'll talk with a few folks about it before deciding for sure.", "author": "nik9000", "createdAt": "2020-09-01T14:29:43Z", "path": "x-pack/plugin/runtime-fields/qa/rest/src/yamlRestTest/java/org/elasticsearch/xpack/runtimefields/rest/CoreTestsWithRuntimeFieldsIT.java", "diffHunk": "@@ -166,7 +166,7 @@ private static String painlessToLoadFromSource(String name, String type) {\n             return null;\n         }\n         StringBuilder b = new StringBuilder();\n-        b.append(\"def v = source['\").append(name).append(\"'];\\n\");\n+        b.append(\"def v = params._source.\").append(name).append(\";\\n\");", "originalCommit": "261b92a628e3b35ce58540f17844fcf95dab5c6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MzY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481183651", "bodyText": "@stu-elastic @jdconrad @rjernst what should we do here? We do want to give access to _source and stored fields in runtime fields, but we are wondering what the direction is on the long run and what syntax we should use. With this PR we are aligning with what is already supported but maybe that is not a good idea? What are your thoughts on this?", "author": "javanna", "createdAt": "2020-09-01T14:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4ODY5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481188695", "bodyText": "Long-term we want all of these to be top-level parameters, so it's just _source, _fields, etc. This is possible now using getter methods and storing the appropriate values as part of the script during instance creation, but for most contexts it'll require additional deprecation. For runtime fields unless there are objections I would prefer to just start with these as top level variables.", "author": "jdconrad", "createdAt": "2020-09-01T14:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE5MDc4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481190786", "bodyText": "Sounds good, that means I will update this PR to expose source as _source (currently exposes as source) and stored fields as _fields (currently not exposed)", "author": "javanna", "createdAt": "2020-09-01T14:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE5MzM1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481193352", "bodyText": "it may make sense to start the deprecation dance in 7.x for existing scripts, at least that would allow us to have the new syntax in the docs, cause otherwise scripts for runtime fields will look completely different from anything listed in the docs. Or is it acceptable that runtime fields have their own separate scripting syntax in the docs too?", "author": "javanna", "createdAt": "2020-09-01T14:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE5Mzc3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481193776", "bodyText": "I'd like to start that dance in 7.x, yes.", "author": "nik9000", "createdAt": "2020-09-01T14:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzNDY2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481234661", "bodyText": "I'd like to make sure with @rjernst that those are the expected names for exposing these things.", "author": "jdconrad", "createdAt": "2020-09-01T15:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5MzI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481293279", "bodyText": "We want to completely change how source and docvalues are accessed in scripts (see #61388). In the meantime, though, I think we should use existing patterns for access, to make it easier on users writing scripts across different contexts. While there are several ways we have of accessing source currently, the most common is params._source, so I think we should use that until we have a universal fields API.\n\nI think that this syntax dates back to when we used mvel\n\nHistory lesson! In mvel, we had _source. When we added painless, we wanted to deter users from using slow access methods, like source and fields. So we temporarily put these under params. The intent was to eventually formalize a way to access source in a different way in the global namespace of the script. Params was a dynamic place we could stash them in the meantime. However, we never got around to it fixing it (though we are looking at it now with the universal fields API), and params._source has stuck all these years.", "author": "rjernst", "createdAt": "2020-09-01T16:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ=="}], "type": "inlineReview"}, {"oid": "204884d617beaedbcae93750125975ac99226893", "url": "https://github.com/elastic/elasticsearch/commit/204884d617beaedbcae93750125975ac99226893", "message": "Merge branch 'feature/runtime_fields' into enhancement/runtime_fields_source_fields_access", "committedDate": "2020-09-01T21:02:23Z", "type": "commit"}, {"oid": "9d03249b7a5e964301765fd5ed6b3992204ca10c", "url": "https://github.com/elastic/elasticsearch/commit/9d03249b7a5e964301765fd5ed6b3992204ca10c", "message": "address failing test", "committedDate": "2020-09-01T21:03:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzMzY0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481433642", "bodyText": "Do you think it'd be more clear to:\nparams.put(\"_source\", leafSearchLookup.searchLookup());\nparams.put(\"_fields\", leafSearchLookup.fields());\n\n?", "author": "nik9000", "createdAt": "2020-09-01T21:10:47Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/AbstractScriptFieldScript.java", "diffHunk": "@@ -45,13 +49,25 @@\n         );\n     }\n \n+    private static final Map<String, Function<Object, Object>> PARAMS_FUNCTIONS = Map.of(\n+        \"_source\",\n+        value -> ((SourceLookup) value).loadSourceIfNeeded()\n+    );\n+\n     private final Map<String, Object> params;\n     private final LeafSearchLookup leafSearchLookup;\n \n     public AbstractScriptFieldScript(Map<String, Object> params, SearchLookup searchLookup, LeafReaderContext ctx) {\n         this.leafSearchLookup = searchLookup.getLeafSearchLookup(ctx);\n-        // TODO how do other scripts get stored fields exposed? Through asMap? I don't see any getters for them.\n-        this.params = params;\n+        params = new HashMap<>(params);\n+        for (Map.Entry<String, Object> entry : leafSearchLookup.asMap().entrySet()) {\n+            // accessing doc_values through through params._doc and params.doc is deprecated in all existing script contexts,\n+            // it makes little sense to expose it deprecated for runtime fields\n+            if (entry.getKey().equals(\"_doc\") == false && entry.getKey().equals(\"doc\") == false) {\n+                params.put(entry.getKey(), entry.getValue());", "originalCommit": "9d03249b7a5e964301765fd5ed6b3992204ca10c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzNTU2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481435563", "bodyText": "possibly too clear :D", "author": "javanna", "createdAt": "2020-09-01T21:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzMzY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzNjMyOA==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481436328", "bodyText": "I would not rely on asMap(), but instead be explicit as Nik suggests.", "author": "rjernst", "createdAt": "2020-09-01T21:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzMzY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ0MjY5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481442692", "bodyText": "agreed, I already made this change", "author": "javanna", "createdAt": "2020-09-01T21:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzMzY0Mg=="}], "type": "inlineReview"}, {"oid": "aed741eb3bd90f46bf9dbfa20a29d6ed4dc64aca", "url": "https://github.com/elastic/elasticsearch/commit/aed741eb3bd90f46bf9dbfa20a29d6ed4dc64aca", "message": "iter", "committedDate": "2020-09-01T21:24:11Z", "type": "commit"}, {"oid": "05035a4f27bf4c1e124d88ccc040f73a74cc8b06", "url": "https://github.com/elastic/elasticsearch/commit/05035a4f27bf4c1e124d88ccc040f73a74cc8b06", "message": "Merge branch 'feature/runtime_fields' into enhancement/runtime_fields_source_fields_access", "committedDate": "2020-09-02T06:51:19Z", "type": "commit"}]}