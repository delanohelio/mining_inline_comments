{"pr_number": 54439, "pr_title": "Add optimized / direct read stats for non-cached files", "pr_createdAt": "2020-03-30T15:51:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54439", "timeline": [{"oid": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "url": "https://github.com/elastic/elasticsearch/commit/1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "message": "Add optimized / direct read stats for non-cached files", "committedDate": "2020-03-30T15:43:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMTU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400301551", "bodyText": "The \"inner open count\" information is obsolete since #53860 and has been removed", "author": "tlrx", "createdAt": "2020-03-30T15:51:48Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -137,17 +135,17 @@ public int hashCode() {\n         private final Counter cachedBytesRead;\n         private final TimedCounter cachedBytesWritten;\n         private final TimedCounter directBytesRead;\n+        private final TimedCounter optimizedBytesRead;\n \n-        public CacheIndexInputStats(String fileName, long fileLength, long openCount, long innerCount, long closeCount,\n+        public CacheIndexInputStats(String fileName, long fileLength, long openCount, long closeCount,\n                                     Counter forwardSmallSeeks, Counter backwardSmallSeeks,\n                                     Counter forwardLargeSeeks, Counter backwardLargeSeeks,\n                                     Counter contiguousReads, Counter nonContiguousReads,\n                                     Counter cachedBytesRead, TimedCounter cachedBytesWritten,\n-                                    TimedCounter directBytesRead) {\n+                                    TimedCounter directBytesRead, TimedCounter optimizedBytesRead) {\n             this.fileName = fileName;\n             this.fileLength = fileLength;\n             this.openCount = openCount;\n-            this.innerCount = innerCount;", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMjI2NA==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400302264", "bodyText": "This new timed counter is added to track information about optimized read operations executed in DirectBlobContainerIndexInput", "author": "tlrx", "createdAt": "2020-03-30T15:52:45Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -158,13 +156,13 @@ public CacheIndexInputStats(String fileName, long fileLength, long openCount, lo\n             this.cachedBytesRead = cachedBytesRead;\n             this.cachedBytesWritten = cachedBytesWritten;\n             this.directBytesRead = directBytesRead;\n+            this.optimizedBytesRead = optimizedBytesRead;", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMzEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400303139", "bodyText": "offset and length are common attributes and that's why they are added to BaseSearchableSnapshotIndexInput (sorry for the extra noise in ctors)", "author": "tlrx", "createdAt": "2020-03-30T15:53:53Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/BaseSearchableSnapshotIndexInput.java", "diffHunk": "@@ -14,33 +14,90 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n \n public abstract class BaseSearchableSnapshotIndexInput extends BufferedIndexInput {\n \n+    protected final SearchableSnapshotDirectory directory;\n     protected final BlobContainer blobContainer;\n     protected final FileInfo fileInfo;\n     protected final IOContext context;\n+    protected final IndexInputStats stats;\n+    protected final long offset;\n+    protected final long length;", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDE5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400304195", "bodyText": "I noticed this while writing tests: we don't align the buffer size in the same way than BufferedIndexInput would do (ie, based on the IOContext)", "author": "tlrx", "createdAt": "2020-03-30T15:55:18Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -244,7 +244,7 @@ public IndexInput openInput(final String name, final IOContext context) throws I\n         if (useCache && isExcludedFromCache(name) == false) {\n             return new CachedBlobContainerIndexInput(this, fileInfo, context, inputStats);\n         } else {\n-            return new DirectBlobContainerIndexInput(blobContainer, fileInfo, context, uncachedChunkSize, BufferedIndexInput.BUFFER_SIZE);\n+            return new DirectBlobContainerIndexInput(this, fileInfo, context, inputStats, uncachedChunkSize, bufferSize(context));", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxODIxOA==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400818218", "bodyText": "Good catch \ud83d\udc4d", "author": "DaveCTurner", "createdAt": "2020-03-31T10:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDUxMg==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400304512", "bodyText": "This is not necessary but I added it for consistency", "author": "tlrx", "createdAt": "2020-03-30T15:55:46Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CachedBlobContainerIndexInput.java", "diffHunk": "@@ -185,28 +160,26 @@ protected void seekInternal(long pos) throws IOException {\n \n     @Override\n     public CachedBlobContainerIndexInput clone() {\n-        final CachedBlobContainerIndexInput clone = (CachedBlobContainerIndexInput) super.clone();\n-        clone.closed = new AtomicBoolean(false);\n-        clone.isClone = true;\n-        return clone;\n+        return (CachedBlobContainerIndexInput) super.clone();\n     }\n \n     @Override\n     public IndexInput slice(String sliceDescription, long offset, long length) {\n-        if (offset < 0 || length < 0 || offset + length > this.length()) {\n+        if (offset < 0 || length < 0 || offset + length > length()) {\n             throw new IllegalArgumentException(\"slice() \" + sliceDescription + \" out of bounds: offset=\" + offset\n-                + \",length=\" + length + \",fileLength=\" + this.length() + \": \" + this);\n+                + \",length=\" + length + \",fileLength=\" + length() + \": \" + this);\n         }\n-        return new CachedBlobContainerIndexInput(getFullSliceDescription(sliceDescription), directory, fileInfo, context, stats,\n-            this.offset + offset, length, true, cacheFileReference);\n+        final CachedBlobContainerIndexInput slice = new CachedBlobContainerIndexInput(getFullSliceDescription(sliceDescription), directory,\n+            fileInfo, context, stats, this.offset + offset, length, cacheFileReference);\n+        slice.isClone = true;", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDkzNw==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400304937", "bodyText": "This is were \"direct_read_bytes\" are captured for direct index inputs.", "author": "tlrx", "createdAt": "2020-03-30T15:56:20Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/direct/DirectBlobContainerIndexInput.java", "diffHunk": "@@ -118,12 +119,15 @@ private void readInternalBytes(final int part, long pos, final byte[] b, int off\n \n         if (optimizedReadSize < length) {\n             // we did not read everything in an optimized fashion, so read the remainder directly\n+            final long startTimeNanos = directory.statsCurrentTimeNanos();", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNjAyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400306029", "bodyText": "This is were \"optimized_read_bytes\" are captured for direct index inputs. Note that they are only added to stats when the stream is closed. This is useful in case the inner input stream reads all remaining bytes on closing (though there is no test for this).", "author": "tlrx", "createdAt": "2020-03-30T15:57:48Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/direct/DirectBlobContainerIndexInput.java", "diffHunk": "@@ -190,10 +194,38 @@ private int readFromNewSequentialStream(int part, long pos, byte[] b, int offset\n             return 0;\n         }\n \n+        final long startTimeNanos = directory.statsCurrentTimeNanos();\n+\n         // if we open a stream of length streamLength then it will not be completely consumed by this read, so it is worthwhile to open\n         // it and keep it open for future reads\n         final InputStream inputStream = openBlobStream(part, pos, streamLength);\n-        streamForSequentialReads = new StreamForSequentialReads(inputStream, part, pos, streamLength);\n+        streamForSequentialReads = new StreamForSequentialReads(new FilterInputStream(inputStream) {", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjYxMw==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400816613", "bodyText": "As far as I can see, we pass the whole SearchableSnapshotDirectory into the IndexInput so that the IndexInput has access to the current time for stats purposes, leading to this mocking here -- otherwise we could continue to pass in just the BlobContainer. I think it would be neater to keep passing the BlobContainer and either pass in a LongSupplier for the current time, or else attach the current time supplier to the IndexInputStats.", "author": "DaveCTurner", "createdAt": "2020-03-31T10:47:33Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/index/store/direct/DirectBlobContainerIndexInputTests.java", "diffHunk": "@@ -94,7 +96,9 @@ public int read(byte[] b, int off, int len) throws IOException {\n                     };\n                 }\n             });\n-        return new DirectBlobContainerIndexInput(blobContainer, fileInfo, newIOContext(random()), minimumReadSize,\n+        final SearchableSnapshotDirectory directory = mock(SearchableSnapshotDirectory.class);", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk3NTkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400975916", "bodyText": "attach the current time supplier to the IndexInputStats\n\nI like this one, so I pushed 47d7e4c", "author": "tlrx", "createdAt": "2020-03-31T14:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxODA0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400818043", "bodyText": "This also includes the time spent waiting for sequential reads to be requested by the caller. What do you think about timing each read call instead and adding all those timings up?", "author": "DaveCTurner", "createdAt": "2020-03-31T10:50:24Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/direct/DirectBlobContainerIndexInput.java", "diffHunk": "@@ -190,10 +194,38 @@ private int readFromNewSequentialStream(int part, long pos, byte[] b, int offset\n             return 0;\n         }\n \n+        final long startTimeNanos = directory.statsCurrentTimeNanos();\n+\n         // if we open a stream of length streamLength then it will not be completely consumed by this read, so it is worthwhile to open\n         // it and keep it open for future reads\n         final InputStream inputStream = openBlobStream(part, pos, streamLength);\n-        streamForSequentialReads = new StreamForSequentialReads(inputStream, part, pos, streamLength);\n+        streamForSequentialReads = new StreamForSequentialReads(new FilterInputStream(inputStream) {\n+            private int bytesRead = 0;\n+\n+            @Override\n+            public int read() throws IOException {\n+                final int result = super.read();\n+                if (result != -1) {\n+                    bytesRead += result;\n+                }\n+                return result;\n+            }\n+\n+            @Override\n+            public int read(byte[] b, int off, int len) throws IOException {\n+                final int result = super.read(b, off, len);\n+                if (result != -1) {\n+                    bytesRead += result;\n+                }\n+                return result;\n+            }\n+\n+            @Override\n+            public void close() throws IOException {\n+                super.close();\n+                stats.addOptimizedBytesRead(bytesRead, directory.statsCurrentTimeNanos() - startTimeNanos);", "originalCommit": "1263b07456a364c2581c4a7ff75dc7c793c4ec3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkyNzg5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54439#discussion_r400927895", "bodyText": "You're right. I pushed a940930 which accumulates numbers for each read operation before adding the sums when the stream is closed. This way the stat will reflect a single read operation that consumed the total bytes of the stream with a more accurate timing.\nI adapted the test.", "author": "tlrx", "createdAt": "2020-03-31T13:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxODA0Mw=="}], "type": "inlineReview"}, {"oid": "a940930d46d84d61262dcbde76ab4b984ffd7420", "url": "https://github.com/elastic/elasticsearch/commit/a940930d46d84d61262dcbde76ab4b984ffd7420", "message": "more accurate read time", "committedDate": "2020-03-31T13:48:18Z", "type": "commit"}, {"oid": "47d7e4c329d1a568352151b5490c0751717c316b", "url": "https://github.com/elastic/elasticsearch/commit/47d7e4c329d1a568352151b5490c0751717c316b", "message": "Revert blob container", "committedDate": "2020-03-31T14:31:31Z", "type": "commit"}, {"oid": "1029842262f638aba689f290bb75b59317217e0b", "url": "https://github.com/elastic/elasticsearch/commit/1029842262f638aba689f290bb75b59317217e0b", "message": "Merge branch 'feature/searchable-snapshots' into optmized-read-stats", "committedDate": "2020-03-31T15:19:11Z", "type": "commit"}, {"oid": "9b77eaeffaaea73ab54d3fe60c1757fc6c125ae4", "url": "https://github.com/elastic/elasticsearch/commit/9b77eaeffaaea73ab54d3fe60c1757fc6c125ae4", "message": "Merge branch 'feature/searchable-snapshots' into optmized-read-stats", "committedDate": "2020-04-01T08:31:25Z", "type": "commit"}, {"oid": "ea8007888008b00cd881e5a0c546ef2a8cc98f07", "url": "https://github.com/elastic/elasticsearch/commit/ea8007888008b00cd881e5a0c546ef2a8cc98f07", "message": "Adapt test and expose stats", "committedDate": "2020-04-01T10:27:15Z", "type": "commit"}, {"oid": "9c7a0a51cf1d4896ff39a78ed713a67ac10eed19", "url": "https://github.com/elastic/elasticsearch/commit/9c7a0a51cf1d4896ff39a78ed713a67ac10eed19", "message": "Merge remote-tracking branch 'tlrx/optmized-read-stats' into optmized-read-stats", "committedDate": "2020-04-01T10:29:15Z", "type": "commit"}, {"oid": "689eb8c183166f4c589aa6e15b053d6b5d9d1641", "url": "https://github.com/elastic/elasticsearch/commit/689eb8c183166f4c589aa6e15b053d6b5d9d1641", "message": "Only test started shard", "committedDate": "2020-04-01T11:05:50Z", "type": "commit"}]}