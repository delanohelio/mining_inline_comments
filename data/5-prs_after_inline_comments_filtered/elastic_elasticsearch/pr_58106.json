{"pr_number": 58106, "pr_title": "HLRC support for data streams", "pr_createdAt": "2020-06-15T12:38:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58106", "timeline": [{"oid": "06e7b1fe5a905f272cb6523a80cd906782f16579", "url": "https://github.com/elastic/elasticsearch/commit/06e7b1fe5a905f272cb6523a80cd906782f16579", "message": "wip", "committedDate": "2020-06-09T10:01:26Z", "type": "commit"}, {"oid": "6e0b071cc251a9e7070e4e19f165dd3a888418f3", "url": "https://github.com/elastic/elasticsearch/commit/6e0b071cc251a9e7070e4e19f165dd3a888418f3", "message": "wip", "committedDate": "2020-06-09T11:22:05Z", "type": "commit"}, {"oid": "d2e24bcedcc6c1785e9ae7741081403b4b2a1089", "url": "https://github.com/elastic/elasticsearch/commit/d2e24bcedcc6c1785e9ae7741081403b4b2a1089", "message": "tests", "committedDate": "2020-06-15T12:24:09Z", "type": "commit"}, {"oid": "cbbd7e0ebc221bdcfc0106bdc1b32ca59c29d8d9", "url": "https://github.com/elastic/elasticsearch/commit/cbbd7e0ebc221bdcfc0106bdc1b32ca59c29d8d9", "message": "remove unneeded changes", "committedDate": "2020-06-15T12:33:41Z", "type": "commit"}, {"oid": "af52bcc469464dbb452d6584ab90908346ba5fc7", "url": "https://github.com/elastic/elasticsearch/commit/af52bcc469464dbb452d6584ab90908346ba5fc7", "message": "remove unneeded changes", "committedDate": "2020-06-15T12:36:17Z", "type": "commit"}, {"oid": "3a46398e3e0f0082097ee2b49d09a67732f0aea8", "url": "https://github.com/elastic/elasticsearch/commit/3a46398e3e0f0082097ee2b49d09a67732f0aea8", "message": "remove unneeded changes", "committedDate": "2020-06-15T12:37:35Z", "type": "commit"}, {"oid": "7781248459003739274c9178733f5c87f1f9a12f", "url": "https://github.com/elastic/elasticsearch/commit/7781248459003739274c9178733f5c87f1f9a12f", "message": "checkstyle", "committedDate": "2020-06-15T12:48:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3MDczMw==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440270733", "bodyText": "maybe move toString() down as last method?", "author": "martijnvg", "createdAt": "2020-06-15T15:44:01Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/GetDataStreamResponse.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.cluster.metadata.DataStream;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+public class GetDataStreamResponse {\n+\n+\n+    @Override\n+    public String toString() {", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMTk2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440721969", "bodyText": "done", "author": "probakowski", "createdAt": "2020-06-16T09:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3MDczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NTM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440275388", "bodyText": "If I remember correctly, we are trying to move away from using classes from server module in the hlrc module.\nA long refactoring task is to remove the dependency on server module and also if a change happens on the server side, parsing can be lenient in the hlrc side in order to not break apps from integrating with Elasticsearch while upgrading.\nSo with this in mind maybe we should selectively copy DataStream class to hlrc module?\n(this has been done already for other apis in hlrc)", "author": "martijnvg", "createdAt": "2020-06-15T15:50:59Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/GetDataStreamResponse.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.cluster.metadata.DataStream;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+public class GetDataStreamResponse {\n+\n+\n+    @Override\n+    public String toString() {\n+        List<DataStream> thisList = new ArrayList<>(this.dataStreams);\n+        thisList.sort(Comparator.comparing(DataStream::getName));\n+        return \"GetDataStreamResponse [dataStreams=\" + thisList + \"]\";\n+    }\n+\n+    private final List<DataStream> dataStreams;", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjE4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722186", "bodyText": "Good idea, I've added stripped down version to HLRC", "author": "probakowski", "createdAt": "2020-06-16T09:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NjI0OA==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440276248", "bodyText": "hlrc response tests should extend from AbstractResponseTestCase", "author": "martijnvg", "createdAt": "2020-06-15T15:52:16Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/indices/GetDataStreamResponseTests.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.cluster.metadata.DataStream;\n+import org.elasticsearch.common.UUIDs;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.test.ESTestCase;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Locale;\n+\n+import static org.elasticsearch.cluster.metadata.DataStream.getDefaultBackingIndexName;\n+import static org.elasticsearch.test.AbstractXContentTestCase.xContentTester;\n+\n+public class GetDataStreamResponseTests extends ESTestCase {", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjI3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722272", "bodyText": "Done", "author": "probakowski", "createdAt": "2020-06-16T09:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NjI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3Njk5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440276991", "bodyText": "maybe also add corresponding tests in IndicesRequestConvertersTests?", "author": "martijnvg", "createdAt": "2020-06-15T15:53:16Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/IndicesRequestConverters.java", "diffHunk": "@@ -68,6 +71,28 @@\n \n     private IndicesRequestConverters() {}\n \n+    static Request putDataStream(CreateDataStreamRequest createDataStreamRequest) {", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjM5OA==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722398", "bodyText": "Done", "author": "probakowski", "createdAt": "2020-06-16T09:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3Njk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2NzQ5OA==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440467498", "bodyText": "Super minor, but the indentation is off for a few of these methods in this file", "author": "dakrone", "createdAt": "2020-06-15T21:51:51Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/IndicesClient.java", "diffHunk": "@@ -155,6 +159,96 @@ public Cancellable createAsync(CreateIndexRequest createIndexRequest,\n             CreateIndexResponse::fromXContent, listener, emptySet());\n     }\n \n+    /**\n+     * Creates a data stream using the Create Data Stream API.\n+     * See <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-data-streams.html\">\n+     * Data Streams API on elastic.co</a>\n+     * @param createDataStreamRequest the request\n+     * @param options the request options (e.g. headers), use {@link RequestOptions#DEFAULT} if nothing needs to be customized\n+     * @return the response\n+     * @throws IOException in case there is a problem sending the request or parsing back the response\n+     */\n+    public AcknowledgedResponse createDataStream(CreateDataStreamRequest createDataStreamRequest,\n+                                                RequestOptions options) throws IOException {", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjQ3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722477", "bodyText": "Fixed", "author": "probakowski", "createdAt": "2020-06-16T09:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2NzQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2ODUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440468521", "bodyText": "We usually try to avoid single statement if statements if I recall correctly?", "author": "dakrone", "createdAt": "2020-06-15T21:54:25Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/GetDataStreamResponse.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.cluster.metadata.DataStream;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\n+public class GetDataStreamResponse {\n+\n+\n+    @Override\n+    public String toString() {\n+        List<DataStream> thisList = new ArrayList<>(this.dataStreams);\n+        thisList.sort(Comparator.comparing(DataStream::getName));\n+        return \"GetDataStreamResponse [dataStreams=\" + thisList + \"]\";\n+    }\n+\n+    private final List<DataStream> dataStreams;\n+\n+    GetDataStreamResponse() {\n+        dataStreams = new ArrayList<>();\n+    }\n+\n+    GetDataStreamResponse(List<DataStream> dataStreams) {\n+        this.dataStreams = dataStreams;\n+    }\n+\n+    public List<DataStream> getDataStreams() {\n+        return dataStreams;\n+    }\n+\n+\n+    public static GetDataStreamResponse fromXContent(XContentParser parser) throws IOException {\n+        final List<DataStream> templates = new ArrayList<>();\n+        for (XContentParser.Token token = parser.nextToken(); token != XContentParser.Token.END_ARRAY; token = parser.nextToken()) {\n+            if (token == XContentParser.Token.START_OBJECT) {\n+                templates.add(DataStream.fromXContent(parser));\n+            }\n+        }\n+        return new GetDataStreamResponse(templates);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(new HashSet<>(this.dataStreams));\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj)\n+            return true;", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjU3NA==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722574", "bodyText": "Fixed", "author": "probakowski", "createdAt": "2020-06-16T09:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2ODUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2OTMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440469315", "bodyText": "I'm not sure this abstraction is buying us anything, we don't have a need anywhere to deal with a data stream request without caring what type it is, and it looks like none of the subclasses implement the validation validate() method.\nOther than sharing a name they don't have much to tie themselves together, so I think we should remove this class.", "author": "dakrone", "createdAt": "2020-06-15T21:56:21Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/AbstractDataStreamRequest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.client.Validatable;\n+\n+public abstract class AbstractDataStreamRequest implements Validatable {", "originalCommit": "7781248459003739274c9178733f5c87f1f9a12f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440722796", "bodyText": "You're right, I've removed abstract class", "author": "probakowski", "createdAt": "2020-06-16T09:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ2OTMxNQ=="}], "type": "inlineReview"}, {"oid": "878154852222154af1d186c675725a6d9d61f9bb", "url": "https://github.com/elastic/elasticsearch/commit/878154852222154af1d186c675725a6d9d61f9bb", "message": "review comments", "committedDate": "2020-06-16T09:33:43Z", "type": "commit"}, {"oid": "c92740a99588035c86800ddb36498c5c0963033b", "url": "https://github.com/elastic/elasticsearch/commit/c92740a99588035c86800ddb36498c5c0963033b", "message": "Merge branch 'master' into data-streams-hlrc", "committedDate": "2020-06-16T09:39:50Z", "type": "commit"}, {"oid": "36e880211b936d2aefc5f841212c6594b49793d3", "url": "https://github.com/elastic/elasticsearch/commit/36e880211b936d2aefc5f841212c6594b49793d3", "message": "fix template", "committedDate": "2020-06-16T11:59:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNTA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440825073", "bodyText": "maybe just use Tuple class instead of Index class?\n(since Index is also part of server module)\nI think it is also just fine to just have a list of index names here and omit the index uuid (since it only can be used internally).", "author": "martijnvg", "createdAt": "2020-06-16T12:52:36Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/DataStream.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.client.indices;\n+\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.index.Index;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public final class DataStream implements ToXContentObject {\n+\n+    private final String name;\n+    private final String timeStampField;\n+    private final List<Index> indices;", "originalCommit": "36e880211b936d2aefc5f841212c6594b49793d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxODY1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58106#discussion_r440918656", "bodyText": "Yep, that's good idea, I switched it to just index names", "author": "probakowski", "createdAt": "2020-06-16T14:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNTA3Mw=="}], "type": "inlineReview"}, {"oid": "67c40210d220b8a522c177d30747598b18b84fb0", "url": "https://github.com/elastic/elasticsearch/commit/67c40210d220b8a522c177d30747598b18b84fb0", "message": "remove Index dependency", "committedDate": "2020-06-16T14:15:55Z", "type": "commit"}, {"oid": "ec69c01d807715c07a1c798a57320f380d3f19a4", "url": "https://github.com/elastic/elasticsearch/commit/ec69c01d807715c07a1c798a57320f380d3f19a4", "message": "fixed datastream parser", "committedDate": "2020-06-16T14:57:53Z", "type": "commit"}, {"oid": "0cd507cdf77983ff3af4f5b96854f136eab00a0a", "url": "https://github.com/elastic/elasticsearch/commit/0cd507cdf77983ff3af4f5b96854f136eab00a0a", "message": "checkstyle", "committedDate": "2020-06-16T17:16:27Z", "type": "commit"}]}