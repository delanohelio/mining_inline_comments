{"pr_number": 56708, "pr_title": "SlowLoggers using single logger", "pr_createdAt": "2020-05-13T17:59:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56708", "timeline": [{"oid": "ddffec579ba41ba5b4df89cd5c279cf6d7956dda", "url": "https://github.com/elastic/elasticsearch/commit/ddffec579ba41ba5b4df89cd5c279cf6d7956dda", "message": "SlowLoggers using single logger\n\nSlow loggers should use single shared logger as otherwise when index is\ndeleted the log4j logger will remain reachable (log4j is caching) and\nwill create a memory leak.", "committedDate": "2020-05-13T17:57:03Z", "type": "commit"}, {"oid": "d69efa1129edf0feb6184f6450a770678fe9219a", "url": "https://github.com/elastic/elasticsearch/commit/d69efa1129edf0feb6184f6450a770678fe9219a", "message": "search slow log", "committedDate": "2020-05-14T09:03:21Z", "type": "commit"}, {"oid": "f90f51c9d0683545d15aeb7929040fde65801237", "url": "https://github.com/elastic/elasticsearch/commit/f90f51c9d0683545d15aeb7929040fde65801237", "message": "Merge branch '7.x' into slow-log-levels", "committedDate": "2020-05-14T09:26:40Z", "type": "commit"}, {"oid": "07bca35123f0a8090e69917799b4376e078ec013", "url": "https://github.com/elastic/elasticsearch/commit/07bca35123f0a8090e69917799b4376e078ec013", "message": "fix test", "committedDate": "2020-05-14T11:44:17Z", "type": "commit"}, {"oid": "037f92714c4e3a967911a1b748066ec37e06c818", "url": "https://github.com/elastic/elasticsearch/commit/037f92714c4e3a967911a1b748066ec37e06c818", "message": "test case for enum", "committedDate": "2020-05-26T14:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MzkyOA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430843928", "bodyText": "In general I consider Enum#ordinal to be a smell. It\u2019s a maintenance burden (to ensure they\u2019re kept in order, what if you want to insert values (equal or different), what if you want to skip a value, etc.). Even in this simple case I\u2019d avoid as a general best practice and add a dedicated field with a value we fully control. This helps reinforce avoiding the use in our codebase (imagine how dangerous this can be for serialization). From the Javadocs:\n\nMost programmers will have no use for this method. It is designed for use by sophisticated enum-based data structures, such as EnumSet and EnumMap.\n\nLet\u2019s change this.", "author": "jasontedor", "createdAt": "2020-05-27T03:58:59Z", "path": "server/src/main/java/org/elasticsearch/index/SlowLogLevel.java", "diffHunk": "@@ -21,8 +21,16 @@\n import java.util.Locale;\n \n public enum SlowLogLevel {\n-    WARN, TRACE, INFO, DEBUG;\n+    WARN, //most specific - little logging\n+    INFO,\n+    DEBUG,\n+    TRACE; //least specific - lots of logging\n     public static SlowLogLevel parse(String level) {\n         return valueOf(level.toUpperCase(Locale.ROOT));\n     }\n+\n+    boolean isLevelEnabledFor(SlowLogLevel levelToBeUsed) {\n+        // info is less specific then warn\n+        return this.ordinal() >= levelToBeUsed.ordinal();", "originalCommit": "037f92714c4e3a967911a1b748066ec37e06c818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg3NjAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430876023", "bodyText": "Agree - this was a shortcut that should be avoided. I will add a field.", "author": "pgomulka", "createdAt": "2020-05-27T06:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MzkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4NTU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430885564", "bodyText": "I am  also  not sure about the method name.\nI wanted to avoid isMoreSpecificThan or isLessSpecificThan (used in log4j) as they don't seem to be too  obvious to me.\nDo you think we should stick with isLevelEnabledFor for now? any other ideas?", "author": "pgomulka", "createdAt": "2020-05-27T06:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MzkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwNzI3NA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431007274", "bodyText": "I agree, the isMoreSpecificThan and isLessSpecificThan naming is not great. I like your choice of isLevelEnabeldFor.", "author": "jasontedor", "createdAt": "2020-05-27T10:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MzkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTI4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430845282", "bodyText": "then -> than", "author": "jasontedor", "createdAt": "2020-05-27T04:05:18Z", "path": "server/src/main/java/org/elasticsearch/index/IndexingSlowLog.java", "diffHunk": "@@ -149,13 +152,14 @@ public void postIndex(ShardId shardId, Engine.Index indexOperation, Engine.Index\n         if (result.getResultType() == Engine.Result.Type.SUCCESS) {\n             final ParsedDocument doc = indexOperation.parsedDoc();\n             final long tookInNanos = result.getTook();\n-            if (indexWarnThreshold >= 0 && tookInNanos > indexWarnThreshold) {\n+            // when logger level is more specific then WARN AND event is within threshold it should be logged", "originalCommit": "037f92714c4e3a967911a1b748066ec37e06c818", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTQwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430845409", "bodyText": "4010?", "author": "jasontedor", "createdAt": "2020-05-27T04:05:52Z", "path": "server/src/test/java/org/elasticsearch/common/logging/MockAppender.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common.logging;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.appender.AbstractAppender;\n+import org.apache.logging.log4j.core.filter.RegexFilter;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+\n+public class MockAppender extends AbstractAppender {\n+    public LogEvent lastEvent;\n+\n+    public MockAppender(final String name) throws IllegalAccessException {\n+        super(name, RegexFilter.createFilter(\".*(\\n.*)*\", new String[0], false, null, null), null);\n+    }\n+\n+    @Override\n+    public void append(LogEvent event) {//4010", "originalCommit": "037f92714c4e3a967911a1b748066ec37e06c818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4MTAzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430881035", "bodyText": "removed", "author": "pgomulka", "createdAt": "2020-05-27T06:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTk1NA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430845954", "bodyText": "Formatting nit: (){\nThere a few other spacing issues in tests (no space before some commas, etc).", "author": "jasontedor", "createdAt": "2020-05-27T04:08:26Z", "path": "server/src/test/java/org/elasticsearch/common/logging/MockAppender.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common.logging;\n+\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.appender.AbstractAppender;\n+import org.apache.logging.log4j.core.filter.RegexFilter;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+\n+public class MockAppender extends AbstractAppender {\n+    public LogEvent lastEvent;\n+\n+    public MockAppender(final String name) throws IllegalAccessException {\n+        super(name, RegexFilter.createFilter(\".*(\\n.*)*\", new String[0], false, null, null), null);\n+    }\n+\n+    @Override\n+    public void append(LogEvent event) {//4010\n+        lastEvent = event.toImmutable();\n+    }\n+\n+    ParameterizedMessage lastParameterizedMessage() {\n+        return (ParameterizedMessage) lastEvent.getMessage();\n+    }\n+\n+    public LogEvent getLastEventAndReset(){", "originalCommit": "037f92714c4e3a967911a1b748066ec37e06c818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4MTQ2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430881466", "bodyText": "fixed. Will fix the formatting in tests too.", "author": "pgomulka", "createdAt": "2020-05-27T06:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NjY3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430846675", "bodyText": "I think testing can be more comprehensive here? For example, it\u2019s too far off to test every case?", "author": "jasontedor", "createdAt": "2020-05-27T04:11:54Z", "path": "server/src/test/java/org/elasticsearch/index/SlowLogLevelTest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index;\n+\n+import org.elasticsearch.test.ESTestCase;\n+\n+\n+public class SlowLogLevelTest extends ESTestCase {\n+\n+    public void testLevelOrdering(){", "originalCommit": "037f92714c4e3a967911a1b748066ec37e06c818", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4MTk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r430881940", "bodyText": "I don't mind covering all test cases here. Will add all of them", "author": "pgomulka", "createdAt": "2020-05-27T06:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NjY3NQ=="}], "type": "inlineReview"}, {"oid": "db1319c72347d0f5e858db747117567640fe6398", "url": "https://github.com/elastic/elasticsearch/commit/db1319c72347d0f5e858db747117567640fe6398", "message": "test cases and ordering refactor", "committedDate": "2020-05-27T06:47:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwNTUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431005528", "bodyText": "I find it somewhat counterintuitive that the most specific logging level has the lowest \"value\" here. Perhaps change the meaning from \"precedence\" to \"specificity\" and then the values can be:\nWARN(3)\nINFO(2)\nDEBUG(1)\nTRACE(0)\n\nand then the comparison can be <= instead of >= which I find more intuitive. That is:\nSlowLogLevel.TRACE.isLevelEnabledFor(SlowLogLevel.WARN)\n\namounts to a comparison of\n0 <= 3\n\nwhich is true, and makes sense because TRACE is less specific than WARN.", "author": "jasontedor", "createdAt": "2020-05-27T10:07:57Z", "path": "server/src/main/java/org/elasticsearch/index/SlowLogLevel.java", "diffHunk": "@@ -21,8 +21,23 @@\n import java.util.Locale;\n \n public enum SlowLogLevel {\n-    WARN, TRACE, INFO, DEBUG;\n+    WARN(0), //most specific - little logging", "originalCommit": "db1319c72347d0f5e858db747117567640fe6398", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAxNzk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431017980", "bodyText": "I tried to follow the ordering they use in org.apache.logging.log4j.spi.StandardLevel where the lower the number the less logs it will allow. OFF being 0 and trace being highest number.\nBut I also find your reasoning good. The higher the number the more important the log is.\nI am on the fence now :)", "author": "pgomulka", "createdAt": "2020-05-27T10:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwNTUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAzMzgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431033806", "bodyText": "as per our discussion I think we should use your ordering and wording. The more specific the log level the higher the specificity value and less logs.", "author": "pgomulka", "createdAt": "2020-05-27T11:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwNTUyOA=="}], "type": "inlineReview"}, {"oid": "ee27b8800850122ff5a168a64957d6593702b102", "url": "https://github.com/elastic/elasticsearch/commit/ee27b8800850122ff5a168a64957d6593702b102", "message": "additional test cases and renaming of ordering", "committedDate": "2020-05-27T11:02:19Z", "type": "commit"}, {"oid": "33c5be0b43103dc9a374661aaa426123baec4004", "url": "https://github.com/elastic/elasticsearch/commit/33c5be0b43103dc9a374661aaa426123baec4004", "message": "field rename", "committedDate": "2020-05-27T11:48:25Z", "type": "commit"}, {"oid": "d3652dffbb955c4a3dab8f5624fd0ef088a7c1a6", "url": "https://github.com/elastic/elasticsearch/commit/d3652dffbb955c4a3dab8f5624fd0ef088a7c1a6", "message": "unnecessary dot", "committedDate": "2020-05-27T11:53:08Z", "type": "commit"}, {"oid": "af0847f9a34e058f15e96d02fcea887dc9ec1c86", "url": "https://github.com/elastic/elasticsearch/commit/af0847f9a34e058f15e96d02fcea887dc9ec1c86", "message": "formatting", "committedDate": "2020-05-27T11:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEwNDExNA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431104114", "bodyText": "A nit here, sorry: I know this is carried over from the code that you moved, but this is labeled as a Javadoc /** on a private field. It should be a regular comment /*. Also no reason to not make this comment use the full 140 columns that are available. \ud83d\ude07", "author": "jasontedor", "createdAt": "2020-05-27T13:04:39Z", "path": "server/src/main/java/org/elasticsearch/index/IndexingSlowLog.java", "diffHunk": "@@ -76,6 +61,23 @@\n     public static final Setting<SlowLogLevel> INDEX_INDEXING_SLOWLOG_LEVEL_SETTING =\n         new Setting<>(INDEX_INDEXING_SLOWLOG_PREFIX +\".level\", SlowLogLevel.TRACE.name(), SlowLogLevel::parse, Property.Dynamic,\n             Property.IndexScope);\n+\n+    private final Logger indexLogger;\n+    private final Index index;\n+\n+    private boolean reformat;\n+    private long indexWarnThreshold;\n+    private long indexInfoThreshold;\n+    private long indexDebugThreshold;\n+    private long indexTraceThreshold;\n+    /**", "originalCommit": "af0847f9a34e058f15e96d02fcea887dc9ec1c86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEwNDY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431104648", "bodyText": "Nit: space between the // and the start of the comment", "author": "jasontedor", "createdAt": "2020-05-27T13:05:04Z", "path": "server/src/main/java/org/elasticsearch/index/SlowLogLevel.java", "diffHunk": "@@ -21,8 +21,23 @@\n import java.util.Locale;\n \n public enum SlowLogLevel {\n-    WARN, TRACE, INFO, DEBUG;\n+    WARN(3), //most specific - little logging\n+    INFO(2),\n+    DEBUG(1),\n+    TRACE(0); //least specific - lots of logging", "originalCommit": "af0847f9a34e058f15e96d02fcea887dc9ec1c86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEwNjg1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56708#discussion_r431106852", "bodyText": "Maybe we can do this a random number of times, in a loop, say up to 64 or something like that, just to really exercise that no new ones are created?", "author": "jasontedor", "createdAt": "2020-05-27T13:06:53Z", "path": "server/src/test/java/org/elasticsearch/index/IndexingSlowLogTests.java", "diffHunk": "@@ -48,6 +61,141 @@\n import static org.hamcrest.Matchers.startsWith;\n \n public class IndexingSlowLogTests extends ESTestCase {\n+    static MockAppender appender;\n+    static Logger testLogger1 = LogManager.getLogger(IndexingSlowLog.INDEX_INDEXING_SLOWLOG_PREFIX + \".index\");\n+\n+    @BeforeClass\n+    public static void init() throws IllegalAccessException {\n+        appender = new MockAppender(\"trace_appender\");\n+        appender.start();\n+        Loggers.addAppender(testLogger1, appender);\n+    }\n+\n+    @AfterClass\n+    public static void cleanup() {\n+        appender.stop();\n+        Loggers.removeAppender(testLogger1, appender);\n+    }\n+\n+\n+    public void testLevelPrecedence() {\n+        String uuid = UUIDs.randomBase64UUID();\n+        IndexMetadata metadata = createIndexMetadata(SlowLogLevel.WARN, \"index-precedence\", uuid);\n+        IndexSettings settings = new IndexSettings(metadata, Settings.EMPTY);\n+        IndexingSlowLog log = new IndexingSlowLog(settings);\n+\n+\n+        ParsedDocument doc = InternalEngineTests.createParsedDoc(\"1\", null);\n+        Engine.Index index = new Engine.Index(new Term(\"_id\", Uid.encodeId(\"doc_id\")), randomNonNegativeLong(), doc);\n+        Engine.IndexResult result = Mockito.mock(Engine.IndexResult.class);//(0, 0, SequenceNumbers.UNASSIGNED_SEQ_NO, false);\n+        Mockito.when(result.getResultType()).thenReturn(Engine.Result.Type.SUCCESS);\n+\n+        {\n+            //level set to WARN, should only log when WARN limit is breached\n+            Mockito.when(result.getTook()).thenReturn(40L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNull(appender.getLastEventAndReset());\n+\n+            Mockito.when(result.getTook()).thenReturn(41L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNotNull(appender.getLastEventAndReset());\n+\n+        }\n+\n+        {\n+            // level set INFO, should log when INFO level is breached\n+            settings.updateIndexMetadata(createIndexMetadata(SlowLogLevel.INFO, \"index\", uuid));\n+            Mockito.when(result.getTook()).thenReturn(30L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNull(appender.getLastEventAndReset());\n+\n+            Mockito.when(result.getTook()).thenReturn(31L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNotNull(appender.getLastEventAndReset());\n+        }\n+\n+        {\n+            // level set DEBUG, should log when DEBUG level is breached\n+            settings.updateIndexMetadata(createIndexMetadata(SlowLogLevel.DEBUG, \"index\", uuid));\n+            Mockito.when(result.getTook()).thenReturn(20L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNull(appender.getLastEventAndReset());\n+\n+            Mockito.when(result.getTook()).thenReturn(21L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNotNull(appender.getLastEventAndReset());\n+        }\n+\n+        {\n+            // level set TRACE, should log when TRACE level is breached\n+            settings.updateIndexMetadata(createIndexMetadata(SlowLogLevel.TRACE, \"index\", uuid));\n+            Mockito.when(result.getTook()).thenReturn(10L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNull(appender.getLastEventAndReset());\n+\n+            Mockito.when(result.getTook()).thenReturn(11L);\n+            log.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNotNull(appender.getLastEventAndReset());\n+        }\n+    }\n+\n+    public void testTwoLoggersDifferentLevel() {\n+        IndexSettings index1Settings = new IndexSettings(createIndexMetadata(SlowLogLevel.WARN, \"index1\", UUIDs.randomBase64UUID()),\n+            Settings.EMPTY);\n+        IndexingSlowLog log1 = new IndexingSlowLog(index1Settings);\n+\n+        IndexSettings index2Settings = new IndexSettings(createIndexMetadata(SlowLogLevel.TRACE, \"index2\", UUIDs.randomBase64UUID()),\n+            Settings.EMPTY);\n+        IndexingSlowLog log2 = new IndexingSlowLog(index2Settings);\n+\n+\n+        ParsedDocument doc = InternalEngineTests.createParsedDoc(\"1\", null);\n+        Engine.Index index = new Engine.Index(new Term(\"_id\", Uid.encodeId(\"doc_id\")), randomNonNegativeLong(), doc);\n+        Engine.IndexResult result = Mockito.mock(Engine.IndexResult.class);\n+        Mockito.when(result.getResultType()).thenReturn(Engine.Result.Type.SUCCESS);\n+\n+        {\n+            // level set WARN, should not log\n+            Mockito.when(result.getTook()).thenReturn(11L);\n+            log1.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNull(appender.getLastEventAndReset());\n+\n+            // level set TRACE, should log\n+            log2.postIndex(ShardId.fromString(\"[index][123]\"), index, result);\n+            assertNotNull(appender.getLastEventAndReset());\n+        }\n+    }\n+\n+    public void testMultipleSlowLoggersUseSingleLog4jLogger() {\n+        LoggerContext context = (LoggerContext) LogManager.getContext(false);\n+\n+        IndexSettings index1Settings = new IndexSettings(createIndexMetadata(SlowLogLevel.WARN, \"index1\", UUIDs.randomBase64UUID()),\n+            Settings.EMPTY);\n+        IndexingSlowLog log1 = new IndexingSlowLog(index1Settings);\n+\n+        int numberOfLoggersBefore = context.getLoggers().size();\n+\n+\n+        IndexSettings index2Settings = new IndexSettings(createIndexMetadata(SlowLogLevel.TRACE, \"index2\", UUIDs.randomBase64UUID()),\n+            Settings.EMPTY);\n+        IndexingSlowLog log2 = new IndexingSlowLog(index2Settings);\n+        context = (LoggerContext) LogManager.getContext(false);\n+\n+        int numberOfLoggersAfter = context.getLoggers().size();", "originalCommit": "af0847f9a34e058f15e96d02fcea887dc9ec1c86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cba939e68fbb6443f7490094e1429cf516934178", "url": "https://github.com/elastic/elasticsearch/commit/cba939e68fbb6443f7490094e1429cf516934178", "message": "formatting", "committedDate": "2020-05-27T13:21:11Z", "type": "commit"}]}