{"pr_number": 57607, "pr_title": "Share same existsQuery impl throughout mappers", "pr_createdAt": "2020-06-03T14:45:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57607", "timeline": [{"oid": "a83f39b97763047316a602c283bc80c94e0a6be2", "url": "https://github.com/elastic/elasticsearch/commit/a83f39b97763047316a602c283bc80c94e0a6be2", "message": "Most of our field types have the same implementation for their `existsQuery` method which relies on doc_values if present, otherwise it uses a term query against the `_field_names` meta field. This standard implementation is repeated in many different mappers. In a few other mappers, we also rely on norms when they are available.\n\nIdeally, we could have a standard implementation that does the right thing by querying the fastest data structure available (doc_values, norms, otherwise _field_names). This is based on the assumption that fields where we do the query on norms are the few fields that may have norms enabled, and that there is no reason for e.g. querying _field_names when doc_values are available or querying `_field_names` when norms are available. This allows us to remove the same or similar implementation for the `existsQuery` method from many mappers.\n\nOne advantage of having `existsQuery` implemented in each mapper may have been that each mapper also decides whether to create or not the `_field_names` field. Though `_field_names` should only be created whenever `doc_values` are turned off: this assumption is now enforced through an assertion.", "committedDate": "2020-06-03T14:45:39Z", "type": "forcePushed"}, {"oid": "f492369bb6673078fbc0d59ffa44910fb4e005c7", "url": "https://github.com/elastic/elasticsearch/commit/f492369bb6673078fbc0d59ffa44910fb4e005c7", "message": "    Most of our field types have the same implementation for their `existsQuery` method which relies on doc_values if present, otherwise it uses a term query against the `_field_names` meta field. This standard implementation is repeated in many different mappers. In a few other mappers, we also rely on norms when they are available.\n\n    Ideally, we could have a standard implementation that does the right thing by querying the fastest data structure available (doc_values, norms, otherwise _field_names). This is based on the assumption that fields where we do the query on norms are the few fields that may have norms enabled, and that there is no reason for e.g. querying _field_names when doc_values are available or querying `_field_names` when norms are available. This allows us to remove the same or similar implementation for the `existsQuery` method from many mappers.\n\n    One advantage of having `existsQuery` implemented in each mapper may have been that each mapper also decides whether to create or not the `_field_names` field. Though `_field_names` should only be created whenever `doc_values` are turned off: this assumption is now enforced through an assertion.", "committedDate": "2020-06-03T15:51:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE1NTgyNw==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r435155827", "bodyText": "I believe it should be omitNorms() || indexOptions() != IndexOptions.NONE", "author": "jpountz", "createdAt": "2020-06-04T10:34:27Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -312,7 +314,21 @@ public Query regexpQuery(String value, int flags, int maxDeterminizedStates, @Nu\n             + \"] which is of type [\" + typeName() + \"]\");\n     }\n \n-    public abstract Query existsQuery(QueryShardContext context);\n+    /**\n+     * Create a query that matches any document that contains this field.\n+     * The default implementation works for most of the field types and creates a {@link DocValuesFieldExistsQuery} when doc_values\n+     * are available, otherwise a {@link NormsFieldExistsQuery} when norms are available, and in the worst case scenario it consists\n+     * of a {@link TermQuery} against the {@link FieldNamesFieldMapper}.\n+     */\n+    public Query existsQuery(QueryShardContext context) {\n+        if (hasDocValues()) {\n+            return new DocValuesFieldExistsQuery(name());\n+        } else if (omitNorms()) {", "originalCommit": "8336618ab9a513aa77a3dc1bfa1969de1b98572d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4Mzc2MA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r440483760", "bodyText": "I gave up on this, leaving the norms based impl where they are (it's only 3 of them). The standard impl only switches between doc_values and field_names", "author": "javanna", "createdAt": "2020-06-15T22:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE1NTgyNw=="}], "type": "inlineReview"}, {"oid": "896c74c48afe7bf7d2e7f2fc73768071ddc9ebd4", "url": "https://github.com/elastic/elasticsearch/commit/896c74c48afe7bf7d2e7f2fc73768071ddc9ebd4", "message": "Most of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThis commit introduces a standard implementation that does the right thing by querying doc_values when available, _field_names otherwise. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion.", "committedDate": "2020-06-15T22:17:08Z", "type": "forcePushed"}, {"oid": "3c8111020091826f9e5775dc810415f2f5a382a1", "url": "https://github.com/elastic/elasticsearch/commit/3c8111020091826f9e5775dc810415f2f5a382a1", "message": "Share same existsQuery impl throughout mappers\n\nMost of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it queries norms if available or uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThere are field types that only query doc_values, because they always have them, and field types that always query _field_names, because they never have norms nor doc_values. We could apply the same standard logic to all of these field types.\n\nThis commit introduces a standard implementation that does the right thing depending on the data structure that is available. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion.", "committedDate": "2020-09-17T12:43:59Z", "type": "commit"}, {"oid": "3c8111020091826f9e5775dc810415f2f5a382a1", "url": "https://github.com/elastic/elasticsearch/commit/3c8111020091826f9e5775dc810415f2f5a382a1", "message": "Share same existsQuery impl throughout mappers\n\nMost of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it queries norms if available or uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThere are field types that only query doc_values, because they always have them, and field types that always query _field_names, because they never have norms nor doc_values. We could apply the same standard logic to all of these field types.\n\nThis commit introduces a standard implementation that does the right thing depending on the data structure that is available. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion.", "committedDate": "2020-09-17T12:43:59Z", "type": "forcePushed"}, {"oid": "91605ecf345c314df86387a50be0e968264311d8", "url": "https://github.com/elastic/elasticsearch/commit/91605ecf345c314df86387a50be0e968264311d8", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query", "committedDate": "2020-09-17T13:50:33Z", "type": "commit"}, {"oid": "e412dce830823088b963badaaf2badf30fca8f04", "url": "https://github.com/elastic/elasticsearch/commit/e412dce830823088b963badaaf2badf30fca8f04", "message": "address KeywordFieldTypeTests#testexistsQuery", "committedDate": "2020-09-17T14:01:56Z", "type": "commit"}, {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "url": "https://github.com/elastic/elasticsearch/commit/ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "message": "Try out a new base class for the shared existsQuery", "committedDate": "2020-09-17T18:46:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490783595", "bodyText": "This looks like a bug in HistogramFieldMapper, can you open a separate issue for it? I wonder if we should revisit how we build the field names field, and maybe add something to MapperTestCase to ensure that it is always added properly.", "author": "romseygeek", "createdAt": "2020-09-18T08:23:00Z", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/mapper/HistogramFieldMapper.java", "diffHunk": "@@ -285,6 +285,8 @@ public Query existsQuery(QueryShardContext context) {\n             if (hasDocValues()) {\n                 return new DocValuesFieldExistsQuery(name());\n             } else {\n+                //TODO this field differs from all other fields as it never goes into _field_names, so the default impl would not work\n+                //though changing this is problematic for existing indices that don't have this field in _field_names?", "originalCommit": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwMDk5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492800995", "bodyText": "Hopefully the test that I added does this.", "author": "javanna", "createdAt": "2020-09-22T14:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490784798", "bodyText": "The vector is stored in a BinaryDocValuesField, so I think this is fine.", "author": "romseygeek", "createdAt": "2020-09-18T08:24:59Z", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "originalCommit": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MDM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490790394", "bodyText": "ok but then shouldn't it pass doc_values set to true to the super class?", "author": "javanna", "createdAt": "2020-09-18T08:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5NjQ3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490796476", "bodyText": "It looks as though hasDocValues() is used exclusively for a) indexing (which should go away once everything is properly parametrized) and b) building exist queries; it's separate from isAggregatable which is used for field caps. So yes, the vector fields should probably set doc_values to true in the constructor.", "author": "romseygeek", "createdAt": "2020-09-18T08:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk2NzEwOA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490967108", "bodyText": "I opened #62631 to fix this and add tests for it", "author": "javanna", "createdAt": "2020-09-18T13:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490785312", "bodyText": "Same as above", "author": "romseygeek", "createdAt": "2020-09-18T08:25:53Z", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "diffHunk": "@@ -104,6 +104,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "originalCommit": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTQ0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490971446", "bodyText": "this is a bit tricky because the field is no longer supported, fielddataBuilder was removed yet there are doc_values in the index. I will figure it out", "author": "javanna", "createdAt": "2020-09-18T14:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0NDM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491144370", "bodyText": "This is addressed by #62646", "author": "javanna", "createdAt": "2020-09-18T19:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490786341", "bodyText": "Can you add some javadoc just to explain why we need this intermediate class?", "author": "romseygeek", "createdAt": "2020-09-18T08:27:40Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "originalCommit": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MDEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490790132", "bodyText": "I am still hoping that we don't need this class, do you have thoughts? :) I will add javadocs if we decide to keep it.", "author": "javanna", "createdAt": "2020-09-18T08:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490801452", "bodyText": "I'm easy either way, I think.  It might be that adding a base class test would also act as a reminder to implementers?  Something like:\n\nbuild an existsQuery and parse a document with the relevant field\nif its a NormsFieldExistsQuery then check the doc contains a field with norms enabled\nif its a DocValuesFieldExistsQuery then check the doc contains a doc values field\nif its a TermQuery then check the doc contains a field_names field\notherwise we expect a MatchAllDocsQuery or MatchNoDocsQuery\n\nThen mapper implementations that don't actually index anything will throw an error if they don't return a MatchAllDocsQuery or MatchNoDocsQuery", "author": "romseygeek", "createdAt": "2020-09-18T08:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwNDM0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490804343", "bodyText": "I like the idea!", "author": "javanna", "createdAt": "2020-09-18T08:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxNzEwNA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491917104", "bodyText": "I pushed an update that has a new test added to MapperTestCase for this. I think you'll have ideas around how to make it better, it still has some rough edges:\n\nbinary field is special because its exists query don't work unless the field is stored or has doc_values, we end up querying field_names even when it's not there, maybe we should change the implementation to return MatchNoDocsQuery in that case.\nwe are testing only the default settings for each field type. For this reason the inconsistency in Histogram field mapper is not currently caught. It would be nice to test the different combinations around omitNorms and hasDocValues but not all field types allow to set them which requires more specific methods to be overridden etc.\n\nI do still hope that this test is enough to not require the new base class that I added.", "author": "javanna", "createdAt": "2020-09-21T09:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}], "type": "inlineReview"}, {"oid": "86e16a28fceddb79534378ecf29e733a7a7a6e7a", "url": "https://github.com/elastic/elasticsearch/commit/86e16a28fceddb79534378ecf29e733a7a7a6e7a", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query", "committedDate": "2020-09-21T07:34:26Z", "type": "commit"}, {"oid": "07b114d95673b3e4ce809c4d208ad93127004251", "url": "https://github.com/elastic/elasticsearch/commit/07b114d95673b3e4ce809c4d208ad93127004251", "message": "test existsQuery behaviour", "committedDate": "2020-09-21T09:45:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491925426", "bodyText": "I don't think you need to index the document, you can just look at the fields in the parsed doc?", "author": "romseygeek", "createdAt": "2020-09-21T10:03:55Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {", "originalCommit": "07b114d95673b3e4ce809c4d208ad93127004251", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NzAwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491987005", "bodyText": "good point, thanks for raising this, will fix", "author": "javanna", "createdAt": "2020-09-21T11:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMzI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491933240", "bodyText": "I think you can change this to just take MapperService.  Then we have the default testExistsQuery impl which calls this with a minimal mapping; and mappers which have norms or doc_values settings can then have their own tests that call this with the relevant configuration.", "author": "romseygeek", "createdAt": "2020-09-21T10:16:22Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {\n+            QueryShardContext queryShardContext = createQueryShardContext(mapperService);\n+            MappedFieldType fieldType = mapperService.fieldType(\"field\");\n+            assertExistsQuery(fieldType, queryShardContext, reader);\n+        });\n+        assertParseMinimalWarnings();\n+    }\n+\n+    protected void assertExistsQuery(MappedFieldType fieldType, QueryShardContext queryShardContext, IndexReader reader) {", "originalCommit": "07b114d95673b3e4ce809c4d208ad93127004251", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5MzMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492793333", "bodyText": "this is implemented now, thanks for the tip.", "author": "javanna", "createdAt": "2020-09-22T14:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMzI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491939642", "bodyText": "I think the only mappers that need to override this are ones that do not extend ConcreteFieldType, so maybe we can add a check in the test and take a different branch if we know we need to do something different here?", "author": "romseygeek", "createdAt": "2020-09-21T10:28:41Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");", "originalCommit": "07b114d95673b3e4ce809c4d208ad93127004251", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk1OTk2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491959965", "bodyText": "I am overriding this at the moment  in constant keyword and runtime field mapper. there are concrete field types (for instance the ones that throw when calling existsQuery) that don't subclass ConcreteFieldType, which is partly why I don't like to have that base class.\nThis method is really for the field types that should not write the field in the docs at all. Can you expand a bit on what you are suggesting, I am not sure I am getting it?", "author": "javanna", "createdAt": "2020-09-21T11:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2NjkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491966905", "bodyText": "there are concrete field types (for instance the ones that throw when calling existsQuery) that don't subclass ConcreteFieldType\n\nah ok, never mind then, I think I misunderstood what was going on", "author": "romseygeek", "createdAt": "2020-09-21T11:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg=="}], "type": "inlineReview"}, {"oid": "569487729232c370681a74210d95f7b0f1d52013", "url": "https://github.com/elastic/elasticsearch/commit/569487729232c370681a74210d95f7b0f1d52013", "message": "expand tests", "committedDate": "2020-09-21T13:49:05Z", "type": "commit"}, {"oid": "297b5fa803d45d2cba3b61fc770806fde336f9dc", "url": "https://github.com/elastic/elasticsearch/commit/297b5fa803d45d2cba3b61fc770806fde336f9dc", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query", "committedDate": "2020-09-22T14:36:01Z", "type": "commit"}, {"oid": "fbe15de2c6404c2aa8f5e2ce2817b71f873c84fd", "url": "https://github.com/elastic/elasticsearch/commit/fbe15de2c6404c2aa8f5e2ce2817b71f873c84fd", "message": "iter", "committedDate": "2020-09-22T14:42:56Z", "type": "commit"}, {"oid": "b7cd370a8076264a15f12c376d290614eb8adf52", "url": "https://github.com/elastic/elasticsearch/commit/b7cd370a8076264a15f12c376d290614eb8adf52", "message": "add javadocs", "committedDate": "2020-09-22T14:52:26Z", "type": "commit"}, {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5", "url": "https://github.com/elastic/elasticsearch/commit/478d270de64afb0d2c6e57186acf2124bff2e2f5", "message": "spotless", "committedDate": "2020-09-22T14:58:13Z", "type": "commit"}, {"oid": "886d3d08b21fc7bfaee1687aa8f8977992fd0513", "url": "https://github.com/elastic/elasticsearch/commit/886d3d08b21fc7bfaee1687aa8f8977992fd0513", "message": "remove ConcreteMappedFieldType.java", "committedDate": "2020-09-22T15:21:25Z", "type": "commit"}, {"oid": "aa310f6bcebf46297b9a7d47803d432818f217fe", "url": "https://github.com/elastic/elasticsearch/commit/aa310f6bcebf46297b9a7d47803d432818f217fe", "message": "checkstyle", "committedDate": "2020-09-22T15:30:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492809629", "bodyText": "It's annoying that neither this nor ParentJoinFieldMapper actually have tests for existsQuery, but they'll get them once we convert their test classes to MapperTestCase and it works by inspection now.", "author": "romseygeek", "createdAt": "2020-09-22T15:04:05Z", "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "diffHunk": "@@ -123,11 +121,6 @@ public Object valueForDisplay(Object value) {\n             BytesRef binaryValue = (BytesRef) value;\n             return binaryValue.utf8ToString();\n         }\n-\n-        @Override\n-        public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(name());\n-        }\n     }", "originalCommit": "478d270de64afb0d2c6e57186acf2124bff2e2f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgzNTU0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492835543", "bodyText": "agreed", "author": "javanna", "createdAt": "2020-09-22T15:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgzNzU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492837553", "bodyText": "I opened #62774 to convert all the remaining test cases", "author": "romseygeek", "createdAt": "2020-09-22T15:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ=="}], "type": "inlineReview"}, {"oid": "ee2a2b6320327474343f1de12e5c440ffcb85886", "url": "https://github.com/elastic/elasticsearch/commit/ee2a2b6320327474343f1de12e5c440ffcb85886", "message": "fix test", "committedDate": "2020-09-22T15:56:59Z", "type": "commit"}, {"oid": "7da2140b31a9c6961e688a009f17b950e88603d1", "url": "https://github.com/elastic/elasticsearch/commit/7da2140b31a9c6961e688a009f17b950e88603d1", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query", "committedDate": "2020-09-22T15:57:14Z", "type": "commit"}, {"oid": "39cac87a45b52e65a570acf1edd903503dc4400c", "url": "https://github.com/elastic/elasticsearch/commit/39cac87a45b52e65a570acf1edd903503dc4400c", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query", "committedDate": "2020-09-22T18:19:07Z", "type": "commit"}]}