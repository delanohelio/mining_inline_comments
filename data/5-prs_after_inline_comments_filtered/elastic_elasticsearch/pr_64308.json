{"pr_number": 64308, "pr_title": "EQL: [Tests] enable server side debugging", "pr_createdAt": "2020-10-28T17:30:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64308", "timeline": [{"oid": "d8d048c79520843d699cabb010711dcc3e667668", "url": "https://github.com/elastic/elasticsearch/commit/d8d048c79520843d699cabb010711dcc3e667668", "message": "EQL: [Tests] enable server side debugging\n\nRegister a new task `runEqlCorrectnessNode` which enables developers to\nstart an ES node in debug mode, properly restore the correctness data\nand then run queries against it.", "committedDate": "2020-10-28T17:28:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA0MDI3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514040273", "bodyText": "Why removing this method?", "author": "astefan", "createdAt": "2020-10-29T07:06:23Z", "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EsEQLCorrectnessIT.java", "diffHunk": "@@ -105,18 +77,6 @@ public static void logTotalExecutionTime() {\n         LOGGER.info(\"Total time: {} ms\", totalTime);\n     }\n \n-    @AfterClass", "originalCommit": "d8d048c79520843d699cabb010711dcc3e667668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NDcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514154726", "bodyText": "Because when you have a running ES node and you try to execute a single query against it with gradle, the termination of the suite will delete the data, and you'd have to rerun the EqlDataLoader.", "author": "matriv", "createdAt": "2020-10-29T10:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA0MDI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDExMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514050111", "bodyText": "You could load the Properties inside the try() { .... } block.", "author": "astefan", "createdAt": "2020-10-29T07:24:46Z", "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EqlDataLoader.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.elasticsearch.action.admin.cluster.repositories.put.PutRepositoryRequest;\n+import org.elasticsearch.action.admin.cluster.snapshots.restore.RestoreSnapshotRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.Properties;\n+\n+public class EqlDataLoader {\n+\n+    private static final String PROPERTIES_FILENAME = \"config.properties\";\n+\n+    public static void main(String[] args) throws IOException {\n+        // Need to setup the log configuration properly to avoid messages when creating a new RestClient\n+        PluginManager.addPackage(LogConfigurator.class.getPackage().getName());\n+\n+        Properties configuration = loadConfiguration();", "originalCommit": "d8d048c79520843d699cabb010711dcc3e667668", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514050718", "bodyText": "To be 100% correct, I think it should be EqlDataLoader's class loader to load the properties file.", "author": "astefan", "createdAt": "2020-10-29T07:26:23Z", "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EqlDataLoader.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.elasticsearch.action.admin.cluster.repositories.put.PutRepositoryRequest;\n+import org.elasticsearch.action.admin.cluster.snapshots.restore.RestoreSnapshotRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.Properties;\n+\n+public class EqlDataLoader {\n+\n+    private static final String PROPERTIES_FILENAME = \"config.properties\";\n+\n+    public static void main(String[] args) throws IOException {\n+        // Need to setup the log configuration properly to avoid messages when creating a new RestClient\n+        PluginManager.addPackage(LogConfigurator.class.getPackage().getName());\n+\n+        Properties configuration = loadConfiguration();\n+        try (\n+            RestClient client = RestClient.builder(new HttpHost(\"localhost\", 9200))\n+                .setRequestConfigCallback(\n+                    requestConfigBuilder -> requestConfigBuilder.setConnectTimeout(30000000)\n+                        .setConnectionRequestTimeout(30000000)\n+                        .setSocketTimeout(30000000)\n+                )\n+                .setStrictDeprecationMode(true)\n+                .build()\n+        ) {\n+            restoreSnapshot(client, new RestHighLevelClient(client, ignore -> {}, List.of()) {\n+            }, configuration);\n+        }\n+    }\n+\n+    static Properties loadConfiguration() throws IOException {\n+        try (InputStream is = EsEQLCorrectnessIT.class.getClassLoader().getResourceAsStream(PROPERTIES_FILENAME)) {", "originalCommit": "d8d048c79520843d699cabb010711dcc3e667668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NTYzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514155639", "bodyText": "yep, copy paste leftover.", "author": "matriv", "createdAt": "2020-10-29T10:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MjU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514052553", "bodyText": "The highLevelClient has a reference to the rest client already (through getLowLevelClient()), I don't think you need to pass client() here.", "author": "astefan", "createdAt": "2020-10-29T07:30:41Z", "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EsEQLCorrectnessIT.java", "diffHunk": "@@ -72,27 +64,7 @@ public static void init() throws IOException {\n \n     @Before\n     public void restoreDataFromGcsRepo() throws Exception {\n-        if (client().performRequest(new Request(\"HEAD\", \"/\" + CFG.getProperty(\"index_name\"))).getStatusLine().getStatusCode() == 404) {\n-            highLevelClient().snapshot()\n-                .createRepository(\n-                    new PutRepositoryRequest(CFG.getProperty(\"gcs_repo_name\")).type(\"gcs\")\n-                        .settings(\n-                            Settings.builder()\n-                                .put(\"bucket\", CFG.getProperty(\"gcs_bucket_name\"))\n-                                .put(\"base_path\", CFG.getProperty(\"gcs_base_path\"))\n-                                .put(\"client\", CFG.getProperty(\"gcs_client_name\"))\n-                                .build()\n-                        ),\n-                    RequestOptions.DEFAULT\n-                );\n-            highLevelClient().snapshot()\n-                .restore(\n-                    new RestoreSnapshotRequest(CFG.getProperty(\"gcs_repo_name\"), CFG.getProperty(\"gcs_snapshot_name\")).waitForCompletion(\n-                        true\n-                    ),\n-                    RequestOptions.DEFAULT\n-                );\n-        }\n+        EqlDataLoader.restoreSnapshot(client(), highLevelClient(), CFG);", "originalCommit": "d8d048c79520843d699cabb010711dcc3e667668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1NzA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514157072", "bodyText": "Thx, missed that.", "author": "matriv", "createdAt": "2020-10-29T10:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MjU1Mw=="}], "type": "inlineReview"}, {"oid": "bb02aa1701493fc4cfaf73ecb0c32ba36b3595c5", "url": "https://github.com/elastic/elasticsearch/commit/bb02aa1701493fc4cfaf73ecb0c32ba36b3595c5", "message": "Address comments", "committedDate": "2020-10-29T10:39:17Z", "type": "commit"}, {"oid": "350748dd51e016f496a210f671def9291c5abc1c", "url": "https://github.com/elastic/elasticsearch/commit/350748dd51e016f496a210f671def9291c5abc1c", "message": "assert index restored, use new snapshot", "committedDate": "2020-10-30T13:00:01Z", "type": "commit"}, {"oid": "68f3040122fd4252a91664a4a92e8e914a88c6f0", "url": "https://github.com/elastic/elasticsearch/commit/68f3040122fd4252a91664a4a92e8e914a88c6f0", "message": "Merge remote-tracking branch 'upstream/master' into debug-eql-correctness", "committedDate": "2020-10-30T13:48:10Z", "type": "commit"}]}