{"pr_number": 55844, "pr_title": "Improve some Byte Array Handling Spots", "pr_createdAt": "2020-04-28T08:21:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55844", "timeline": [{"oid": "39013946261ff09a720d274616e1e4c6d1382977", "url": "https://github.com/elastic/elasticsearch/commit/39013946261ff09a720d274616e1e4c6d1382977", "message": "Improve some Byte Array Handling Spots\n\nSome small memory-saving improvements in `byte[]` handling.", "committedDate": "2020-04-28T08:18:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyNTAyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55844#discussion_r416425026", "bodyText": "This should be much more efficient here as we mainly use it on strings that are internally coded as UTF-8 already (mapping update requests) so we just do a simple byte[] copy here instead of creating an oversized array and doing char by char work in the BytesRef code", "author": "original-brownbear", "createdAt": "2020-04-28T08:23:35Z", "path": "server/src/main/java/org/elasticsearch/common/compress/CompressedXContent.java", "diffHunk": "@@ -124,7 +116,7 @@ public CompressedXContent(byte[] data) throws IOException {\n     }\n \n     public CompressedXContent(String str) throws IOException {\n-        this(new BytesArray(new BytesRef(str)));\n+        this(new BytesArray(str.getBytes(StandardCharsets.UTF_8)));", "originalCommit": "39013946261ff09a720d274616e1e4c6d1382977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyNjU5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55844#discussion_r416426599", "bodyText": "We get here a lot as part of some snapshot repo operations (when reading index metadata) and it's quite wasteful to first serialize the map to bytes into one buffer only to then compress that buffer to another buffer => just serialize and compress in one go", "author": "original-brownbear", "createdAt": "2020-04-28T08:25:55Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MappingMetadata.java", "diffHunk": "@@ -73,10 +72,9 @@ public MappingMetadata(CompressedXContent mapping) {\n     public MappingMetadata(String type, Map<String, Object> mapping) {\n         this.type = type;\n         try {\n-            XContentBuilder mappingBuilder = XContentFactory.jsonBuilder().map(mapping);\n-            this.source = new CompressedXContent(BytesReference.bytes(mappingBuilder));\n-        }\n-        catch (IOException e) {\n+            this.source = new CompressedXContent(", "originalCommit": "39013946261ff09a720d274616e1e4c6d1382977", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}