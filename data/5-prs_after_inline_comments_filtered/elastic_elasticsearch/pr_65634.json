{"pr_number": 65634, "pr_title": "Add KeyUsage, ExtendedKeyUsage, CipherSuite & Protocol to SSL diagnos\u2026", "pr_createdAt": "2020-11-30T19:55:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65634", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4ODIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533088239", "bodyText": "getKeyUsage() returns boolean[], but we need to decode it into the actual usage types (see the Javadoc for getKeyUsage for a description of each index)\nOutput like\nkeyUsage [true,true,false,false,true,false,true,false,false]\n\nisn't explanatory enough for this diagnostic message.", "author": "tvernum", "createdAt": "2020-12-01T05:51:12Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +413,38 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        return Optional.ofNullable(certificate.getKeyUsage())\n+            .map(keyUsage -> \"keyUsage [\" + Arrays.toString(keyUsage) + \"]\")", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4ODQ0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533088443", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .append(\"] and \")\n          \n          \n            \n                        .append(\"], \")", "author": "tvernum", "createdAt": "2020-12-01T05:51:49Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -178,7 +179,13 @@ public static String getTrustDiagnosticFailure(X509Certificate[] chain, PeerType\n             .append(\" provided a certificate with subject name [\")\n             .append(peerCert.getSubjectX500Principal().getName())\n             .append(\"] and \")", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4ODQ4MA==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533088480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .append(\" and \")\n          \n          \n            \n                        .append(\", \")", "author": "tvernum", "createdAt": "2020-12-01T05:51:58Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -178,7 +179,13 @@ public static String getTrustDiagnosticFailure(X509Certificate[] chain, PeerType\n             .append(\" provided a certificate with subject name [\")\n             .append(peerCert.getSubjectX500Principal().getName())\n             .append(\"] and \")\n-            .append(fingerprintDescription(peerCert));\n+            .append(fingerprintDescription(peerCert))\n+            .append(\" and \")", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MDc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533090766", "bodyText": "getExtendedKeyUsage() returns a List of OIDs.\nFor the standard OIDs (defined here https://tools.ietf.org/html/rfc5280#page-44), we need to decode those OIDs into useful names.\nNon standard OIDs should be left in their dotted notation.", "author": "tvernum", "createdAt": "2020-12-01T05:59:32Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +413,38 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        return Optional.ofNullable(certificate.getKeyUsage())\n+            .map(keyUsage -> \"keyUsage [\" + Arrays.toString(keyUsage) + \"]\")\n+            .orElse(\"no keyUsage\");\n+    }\n+\n+    private static String extendedKeyUsageDescription(X509Certificate certificate) {\n+        try {\n+            return Optional.ofNullable(certificate.getExtendedKeyUsage())\n+                .map(list -> generateExtendedKeyUsageDescription(list))\n+                .orElse(\"no extendedKeyUsage\");\n+        } catch (CertificateParsingException e) {\n+            return \"invalid extendedKeyUsage [\" + e.toString() + \"]\";\n+        }\n+    }\n+\n+    private static String generateExtendedKeyUsageDescription(List<String> list) {\n+        return list.stream()", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MTAwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533091001", "bodyText": "For brevity we can omit articles from the diagnostic\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    message.append(\"; the session supports the cipher suite [\")\n          \n          \n            \n                    message.append(\"; the session supports cipher suite [\")", "author": "tvernum", "createdAt": "2020-12-01T06:00:15Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +413,38 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        return Optional.ofNullable(certificate.getKeyUsage())\n+            .map(keyUsage -> \"keyUsage [\" + Arrays.toString(keyUsage) + \"]\")\n+            .orElse(\"no keyUsage\");\n+    }\n+\n+    private static String extendedKeyUsageDescription(X509Certificate certificate) {\n+        try {\n+            return Optional.ofNullable(certificate.getExtendedKeyUsage())\n+                .map(list -> generateExtendedKeyUsageDescription(list))\n+                .orElse(\"no extendedKeyUsage\");\n+        } catch (CertificateParsingException e) {\n+            return \"invalid extendedKeyUsage [\" + e.toString() + \"]\";\n+        }\n+    }\n+\n+    private static String generateExtendedKeyUsageDescription(List<String> list) {\n+        return list.stream()\n+            .reduce((x, y) -> x + \", \" + y)\n+            .map(str -> \"extendedKeyUsage [\" + str + \"]\")\n+            .orElse(\"no extendedKeyUsage\");\n+    }\n+\n+    private static void addSessionDescription(SSLSession session, StringBuilder message) {\n+        String cipherSuite = Optional.ofNullable(session).map(SSLSession::getCipherSuite).orElse(\"<unknown cipherSuite>\");\n+        String protocol = Optional.ofNullable(session).map(SSLSession::getProtocol).orElse(\"<unknown protocol>\");\n+        message.append(\"; the session supports the cipher suite [\")", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MTEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533091133", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .append(\"] and \")\n          \n          \n            \n                        .append(\"the protocol [\")\n          \n          \n            \n                        .append(\"] and protocol [\")", "author": "tvernum", "createdAt": "2020-12-01T06:00:39Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +413,38 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        return Optional.ofNullable(certificate.getKeyUsage())\n+            .map(keyUsage -> \"keyUsage [\" + Arrays.toString(keyUsage) + \"]\")\n+            .orElse(\"no keyUsage\");\n+    }\n+\n+    private static String extendedKeyUsageDescription(X509Certificate certificate) {\n+        try {\n+            return Optional.ofNullable(certificate.getExtendedKeyUsage())\n+                .map(list -> generateExtendedKeyUsageDescription(list))\n+                .orElse(\"no extendedKeyUsage\");\n+        } catch (CertificateParsingException e) {\n+            return \"invalid extendedKeyUsage [\" + e.toString() + \"]\";\n+        }\n+    }\n+\n+    private static String generateExtendedKeyUsageDescription(List<String> list) {\n+        return list.stream()\n+            .reduce((x, y) -> x + \", \" + y)\n+            .map(str -> \"extendedKeyUsage [\" + str + \"]\")\n+            .orElse(\"no extendedKeyUsage\");\n+    }\n+\n+    private static void addSessionDescription(SSLSession session, StringBuilder message) {\n+        String cipherSuite = Optional.ofNullable(session).map(SSLSession::getCipherSuite).orElse(\"<unknown cipherSuite>\");\n+        String protocol = Optional.ofNullable(session).map(SSLSession::getProtocol).orElse(\"<unknown protocol>\");\n+        message.append(\"; the session supports the cipher suite [\")\n+            .append(cipherSuite)\n+            .append(\"] and \")\n+            .append(\"the protocol [\")", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MTcwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533091705", "bodyText": "We need some of the tests to have real values for all of these.\nAs it is we're only testing the \"no value\" cases, which is the least important case.\nThat will require regenerating some of the certs (and updating the fingerprints) to have key usage properties.\n(see libs/ssl-config/src/test/resources/certs/README.txt)\nand/or changing mockCertificateWithIssuer and session to provide mock values.", "author": "tvernum", "createdAt": "2020-12-01T06:02:26Z", "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java", "diffHunk": "@@ -63,7 +63,8 @@ public void testDiagnosticMessageWhenServerProvidesAFullCertChainThatIsTrusted()\n         final String message = SslDiagnostics.getTrustDiagnosticFailure(chain, SslDiagnostics.PeerType.SERVER, session,\n             \"xpack.http.ssl\", trustIssuers);\n         assertThat(message, Matchers.equalTo(\"failed to establish trust with server at [192.168.1.1];\" +\n-            \" the server provided a certificate with subject name [CN=cert1] and fingerprint [3bebe388a66362784afd6c51a9000961a4e10050];\" +\n+            \" the server provided a certificate with subject name [CN=cert1] and fingerprint [3bebe388a66362784afd6c51a9000961a4e10050] and no keyUsage and no extendedKeyUsage;\" +\n+            \" the session supports the cipher suite [<unknown cipherSuite>] and the protocol [<unknown protocol>];\" +", "originalCommit": "3d8562345254269163e23b1f0397a9f1e6e23e06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwMjY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533602689", "bodyText": "I've edited the mockCertificateWithIssuer and session methods to provide mock values. I attempted to regenerate the cert yesterday without much success, so went with the mocking. Let me know if this works.", "author": "sindhusp", "createdAt": "2020-12-01T17:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MTcwNQ=="}], "type": "inlineReview"}, {"oid": "88ecbd0b204a07415698e693dfad8d3c179b59fe", "url": "https://github.com/elastic/elasticsearch/commit/88ecbd0b204a07415698e693dfad8d3c179b59fe", "message": "Add KeyUsage, ExtendedKeyUsage, CipherSuite & Protocol to SSL diagnostics", "committedDate": "2020-12-01T07:06:16Z", "type": "commit"}, {"oid": "88ecbd0b204a07415698e693dfad8d3c179b59fe", "url": "https://github.com/elastic/elasticsearch/commit/88ecbd0b204a07415698e693dfad8d3c179b59fe", "message": "Add KeyUsage, ExtendedKeyUsage, CipherSuite & Protocol to SSL diagnostics", "committedDate": "2020-12-01T07:06:16Z", "type": "forcePushed"}, {"oid": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "url": "https://github.com/elastic/elasticsearch/commit/f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "message": "Review comments\n\n* Fix formatting\n* Add descriptive keyUsage, extendedKeyUsage msgs\n* Mock cert's keyUsage, extendedKeyUsage\n* Mock session's cipherSuite, protocol", "committedDate": "2020-12-01T17:45:56Z", "type": "commit"}, {"oid": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "url": "https://github.com/elastic/elasticsearch/commit/f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "message": "Review comments\n\n* Fix formatting\n* Add descriptive keyUsage, extendedKeyUsage msgs\n* Mock cert's keyUsage, extendedKeyUsage\n* Mock session's cipherSuite, protocol", "committedDate": "2020-12-01T17:45:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYxMDczNw==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r533610737", "bodyText": "Should I use an enum here too like I've done with ExtendedKeyUsage, for uniformity? I could define the index as the Enum field.", "author": "sindhusp", "createdAt": "2020-12-01T17:56:40Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -415,23 +440,40 @@ private static boolean isSelfIssued(X509Certificate certificate) {\n     }\n \n     private static String keyUsageDescription(X509Certificate certificate) {\n-        return Optional.ofNullable(certificate.getKeyUsage())\n-            .map(keyUsage -> \"keyUsage [\" + Arrays.toString(keyUsage) + \"]\")\n+        boolean[] keyUsage = certificate.getKeyUsage();\n+        if (keyUsage == null || keyUsage.length == 0) {\n+            return \"no keyUsage\";\n+        }\n+\n+        final String[] keyUsageGlossary = {\"digitalSignature\", \"nonRepudiation\", \"keyEncipherment\",", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU3NzA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572577050", "bodyText": "I think either is fine.\nI do like the consistency of having an enum for each, but it would require care so that the ordinals matched correctly.\nI think my personal preference would be to just move this array to be a constant that is declared in the same part of the file as ExtendedKeyUsage", "author": "tvernum", "createdAt": "2021-02-09T03:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYxMDczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU3NjM0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572576348", "bodyText": "e.oid can never be null, because this is an enum with fixed (non-null) values.\nI think it's fine to skip the null check here.\nIf you'd prefer to be safe, you could use this.oid = Objects.requireNonNull(oid); in the constructor.", "author": "tvernum", "createdAt": "2021-02-09T03:55:06Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -151,6 +153,30 @@ boolean isSameCertificate() {\n         }\n     }\n \n+    public enum ExtendedKeyUsage {\n+        serverAuth (\"1.3.6.1.5.5.7.3.1\"),\n+        clientAuth (\"1.3.6.1.5.5.7.3.2\"),\n+        codeSigning (\"1.3.6.1.5.5.7.3.3\"),\n+        emailProtection (\"1.3.6.1.5.5.7.3.4\"),\n+        timeStamping (\"1.3.6.1.5.5.7.3.8\"),\n+        ocspSigning (\"1.3.6.1.5.5.7.3.9\");\n+\n+        private String oid;\n+\n+        private ExtendedKeyUsage(String oid) {\n+            this.oid = oid;\n+        }\n+\n+        public static String decodeOid(String oid) {\n+            for (ExtendedKeyUsage e : values()) {\n+                if (e.oid != null && e.oid.equals(oid)) {", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU3ODIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572578201", "bodyText": "For safety we should check that i < keyUsageGlossary.length", "author": "tvernum", "createdAt": "2021-02-09T04:01:35Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +438,58 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        boolean[] keyUsage = certificate.getKeyUsage();\n+        if (keyUsage == null || keyUsage.length == 0) {\n+            return \"no keyUsage\";\n+        }\n+\n+        final String[] keyUsageGlossary = {\"digitalSignature\", \"nonRepudiation\", \"keyEncipherment\",\n+            \"dataEncipherment\", \"keyAgreement\", \"keyCertSign\", \"cRLSign\", \"encipherOnly\",\n+            \"decipherOnly\"};\n+\n+        List<String> keyUsageDescription = new ArrayList<>();\n+        IntStream.range(0, keyUsage.length).forEach(i -> {\n+            if (keyUsage[i]) {\n+                keyUsageDescription.add(keyUsageGlossary[i]);", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU4MDIwNA==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572580204", "bodyText": "The style use have used here is fine, but I would have written it like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<String> keyUsageDescription = new ArrayList<>();\n          \n          \n            \n                    IntStream.range(0, keyUsage.length).forEach(i -> {\n          \n          \n            \n                        if (keyUsage[i]) {\n          \n          \n            \n                            keyUsageDescription.add(keyUsageGlossary[i]);\n          \n          \n            \n                        }\n          \n          \n            \n                    });\n          \n          \n            \n                    return keyUsageDescription.stream()\n          \n          \n            \n                        .reduce((a, b) -> a + \", \" + b)\n          \n          \n            \n                    String keyUsageDescription = IntStream.range(0, keyUsage.length)\n          \n          \n            \n                      .filter(i -> keyUsage[i])\n          \n          \n            \n                      .map(i -> i < keyUsageGlossary.length ? keyUsageGlossary[i] : \"#\" + i)\n          \n          \n            \n                      .collect(Collectors.joining(\", \"));\n          \n      \n    \n    \n  \n\nAnd then tested whether that was empty or not.", "author": "tvernum", "createdAt": "2021-02-09T04:08:36Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +438,58 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        boolean[] keyUsage = certificate.getKeyUsage();\n+        if (keyUsage == null || keyUsage.length == 0) {\n+            return \"no keyUsage\";\n+        }\n+\n+        final String[] keyUsageGlossary = {\"digitalSignature\", \"nonRepudiation\", \"keyEncipherment\",\n+            \"dataEncipherment\", \"keyAgreement\", \"keyCertSign\", \"cRLSign\", \"encipherOnly\",\n+            \"decipherOnly\"};\n+\n+        List<String> keyUsageDescription = new ArrayList<>();\n+        IntStream.range(0, keyUsage.length).forEach(i -> {\n+            if (keyUsage[i]) {\n+                keyUsageDescription.add(keyUsageGlossary[i]);\n+            }\n+        });\n+        return keyUsageDescription.stream()\n+            .reduce((a, b) -> a + \", \" + b)", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU4MDc3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572580779", "bodyText": "You have this orElse case both here, and in  generateExtendedKeyUsageDescription and I don't think that's necessary.", "author": "tvernum", "createdAt": "2021-02-09T04:10:37Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +438,58 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        boolean[] keyUsage = certificate.getKeyUsage();\n+        if (keyUsage == null || keyUsage.length == 0) {\n+            return \"no keyUsage\";\n+        }\n+\n+        final String[] keyUsageGlossary = {\"digitalSignature\", \"nonRepudiation\", \"keyEncipherment\",\n+            \"dataEncipherment\", \"keyAgreement\", \"keyCertSign\", \"cRLSign\", \"encipherOnly\",\n+            \"decipherOnly\"};\n+\n+        List<String> keyUsageDescription = new ArrayList<>();\n+        IntStream.range(0, keyUsage.length).forEach(i -> {\n+            if (keyUsage[i]) {\n+                keyUsageDescription.add(keyUsageGlossary[i]);\n+            }\n+        });\n+        return keyUsageDescription.stream()\n+            .reduce((a, b) -> a + \", \" + b)\n+            .map(str ->  \"keyUsage [\" + str + \"]\")\n+            .orElse(\"no keyUsage\");\n+    }\n+\n+    private static String extendedKeyUsageDescription(X509Certificate certificate) {\n+        try {\n+            return Optional.ofNullable(certificate.getExtendedKeyUsage())\n+                .map(keyUsage -> generateExtendedKeyUsageDescription(keyUsage))\n+                .orElse(\"no extendedKeyUsage\");", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU4MTA3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65634#discussion_r572581076", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    message.append(\"; the session supports cipher suite [\")\n          \n          \n            \n                    message.append(\"; the session uses cipher suite [\")\n          \n      \n    \n    \n  \n\nStrictly, by the time we get to a session being established it's not really \"supports\", it's \"has selected for use\"", "author": "tvernum", "createdAt": "2021-02-09T04:11:48Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/SslDiagnostics.java", "diffHunk": "@@ -406,4 +438,58 @@ private static boolean checkIssuer(X509Certificate certificate, X509Certificate\n     private static boolean isSelfIssued(X509Certificate certificate) {\n         return certificate.getIssuerX500Principal().equals(certificate.getSubjectX500Principal());\n     }\n+\n+    private static String keyUsageDescription(X509Certificate certificate) {\n+        boolean[] keyUsage = certificate.getKeyUsage();\n+        if (keyUsage == null || keyUsage.length == 0) {\n+            return \"no keyUsage\";\n+        }\n+\n+        final String[] keyUsageGlossary = {\"digitalSignature\", \"nonRepudiation\", \"keyEncipherment\",\n+            \"dataEncipherment\", \"keyAgreement\", \"keyCertSign\", \"cRLSign\", \"encipherOnly\",\n+            \"decipherOnly\"};\n+\n+        List<String> keyUsageDescription = new ArrayList<>();\n+        IntStream.range(0, keyUsage.length).forEach(i -> {\n+            if (keyUsage[i]) {\n+                keyUsageDescription.add(keyUsageGlossary[i]);\n+            }\n+        });\n+        return keyUsageDescription.stream()\n+            .reduce((a, b) -> a + \", \" + b)\n+            .map(str ->  \"keyUsage [\" + str + \"]\")\n+            .orElse(\"no keyUsage\");\n+    }\n+\n+    private static String extendedKeyUsageDescription(X509Certificate certificate) {\n+        try {\n+            return Optional.ofNullable(certificate.getExtendedKeyUsage())\n+                .map(keyUsage -> generateExtendedKeyUsageDescription(keyUsage))\n+                .orElse(\"no extendedKeyUsage\");\n+        } catch (CertificateParsingException e) {\n+            return \"invalid extendedKeyUsage [\" + e.toString() + \"]\";\n+        }\n+    }\n+\n+    private static String generateExtendedKeyUsageDescription(List<String> oids) {\n+        return oids.stream()\n+            .map(ExtendedKeyUsage::decodeOid)\n+            .reduce((x, y) -> x + \", \" + y)\n+            .map(str -> \"extendedKeyUsage [\" + str + \"]\")\n+            .orElse(\"no extendedKeyUsage\");\n+    }\n+\n+    private static void addSessionDescription(SSLSession session, StringBuilder message) {\n+        String cipherSuite = Optional.ofNullable(session)\n+            .map(SSLSession::getCipherSuite)\n+            .orElse(\"<unknown cipherSuite>\");\n+        String protocol = Optional.ofNullable(session)\n+            .map(SSLSession::getProtocol)\n+            .orElse(\"<unknown protocol>\");\n+        message.append(\"; the session supports cipher suite [\")", "originalCommit": "f6af049fcfdf585ddc0d5b3225d95fc769b308c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7c6be0589d92941917bec8392ed080afb072861", "url": "https://github.com/elastic/elasticsearch/commit/a7c6be0589d92941917bec8392ed080afb072861", "message": "Merge branch 'master' into sslDiagnostics", "committedDate": "2021-08-13T03:06:30Z", "type": "commit"}, {"oid": "3752caf8c6081cd012cdb3a92cab7f490a9d161e", "url": "https://github.com/elastic/elasticsearch/commit/3752caf8c6081cd012cdb3a92cab7f490a9d161e", "message": "Tweak implementation and add more tests", "committedDate": "2021-08-13T03:53:48Z", "type": "commit"}, {"oid": "e23a504310b87a7d0de42629840055285b9cb4d1", "url": "https://github.com/elastic/elasticsearch/commit/e23a504310b87a7d0de42629840055285b9cb4d1", "message": "Fix broken test", "committedDate": "2021-08-13T05:13:29Z", "type": "commit"}]}