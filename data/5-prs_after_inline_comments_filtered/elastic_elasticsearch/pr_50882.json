{"pr_number": 50882, "pr_title": "Goodbye and thank you synced flush!", "pr_createdAt": "2020-01-10T22:38:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50882", "timeline": [{"oid": "d4c1fa5dba2bd5491839328232ef92616f340d93", "url": "https://github.com/elastic/elasticsearch/commit/d4c1fa5dba2bd5491839328232ef92616f340d93", "message": "Goodbye and thank you synced flush!", "committedDate": "2020-01-10T22:36:50Z", "type": "commit"}, {"oid": "5341c4d4ddffa023051a00025a6a357fee68f372", "url": "https://github.com/elastic/elasticsearch/commit/5341c4d4ddffa023051a00025a6a357fee68f372", "message": "style", "committedDate": "2020-01-10T23:03:30Z", "type": "commit"}, {"oid": "9386ab135052746353a44ee79eadcfe9dc14da33", "url": "https://github.com/elastic/elasticsearch/commit/9386ab135052746353a44ee79eadcfe9dc14da33", "message": "fix docs in hlrc", "committedDate": "2020-01-10T23:08:34Z", "type": "commit"}, {"oid": "43591b5a8efb9c0624ae2a85f979ab6fc2eead99", "url": "https://github.com/elastic/elasticsearch/commit/43591b5a8efb9c0624ae2a85f979ab6fc2eead99", "message": "Merge branch 'master' into remove-synced-flush", "committedDate": "2020-01-11T00:28:37Z", "type": "commit"}, {"oid": "2fef181effe1703ec63f5302a58bf0526a8ba3a0", "url": "https://github.com/elastic/elasticsearch/commit/2fef181effe1703ec63f5302a58bf0526a8ba3a0", "message": "add breaking change", "committedDate": "2020-01-11T00:38:11Z", "type": "commit"}, {"oid": "c4a346fe68347a4e235369444d2c5483e1f7cbc2", "url": "https://github.com/elastic/elasticsearch/commit/c4a346fe68347a4e235369444d2c5483e1f7cbc2", "message": "Remove synced flush from engine", "committedDate": "2020-01-11T01:52:30Z", "type": "commit"}, {"oid": "c04d2ced43a3d628e3bb9cbcc5ae63ae3c5fbdce", "url": "https://github.com/elastic/elasticsearch/commit/c04d2ced43a3d628e3bb9cbcc5ae63ae3c5fbdce", "message": "remove it from readonly engine", "committedDate": "2020-01-11T01:57:35Z", "type": "commit"}, {"oid": "8afd1db45ca9cf21959ded0ca96ef44d29baff9a", "url": "https://github.com/elastic/elasticsearch/commit/8afd1db45ca9cf21959ded0ca96ef44d29baff9a", "message": "stylecheck", "committedDate": "2020-01-11T02:42:14Z", "type": "commit"}, {"oid": "c37007717983213afc9dea3c82214ee27c0552e8", "url": "https://github.com/elastic/elasticsearch/commit/c37007717983213afc9dea3c82214ee27c0552e8", "message": "keep the api page", "committedDate": "2020-01-11T14:19:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg2MjQ2OA==", "url": "https://github.com/elastic/elasticsearch/pull/50882#discussion_r365862468", "bodyText": "we should still run this command if all nodes are on 7.x? This exercises our ability to read sync markers in 8", "author": "ywelsch", "createdAt": "2020-01-13T15:23:33Z", "path": "qa/full-cluster-restart/src/test/java/org/elasticsearch/upgrades/FullClusterRestartIT.java", "diffHunk": "@@ -680,15 +679,6 @@ public void testRecovery() throws Exception {\n             flushRequest.addParameter(\"wait_if_ongoing\", \"true\");\n             assertOK(client().performRequest(flushRequest));\n \n-            if (randomBoolean()) {\n-                // We had a bug before where we failed to perform peer recovery with sync_id from 5.x to 6.x.\n-                // We added this synced flush so we can exercise different paths of recovery code.\n-                try {", "originalCommit": "c37007717983213afc9dea3c82214ee27c0552e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg2NTE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/50882#discussion_r365865194", "bodyText": "will be removed in a future", "author": "ywelsch", "createdAt": "2020-01-13T15:28:17Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestSyncedFlushAction.java", "diffHunk": "@@ -54,17 +57,43 @@ public String getName() {\n \n     @Override\n     public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n-        IndicesOptions indicesOptions = IndicesOptions.fromRequest(request, IndicesOptions.lenientExpandOpen());\n-        SyncedFlushRequest syncedFlushRequest = new SyncedFlushRequest(Strings.splitStringByCommaToArray(request.param(\"index\")));\n-        syncedFlushRequest.indicesOptions(indicesOptions);\n-        return channel -> client.admin().indices().syncedFlush(syncedFlushRequest, new RestBuilderListener<SyncedFlushResponse>(channel) {\n-            @Override\n-            public RestResponse buildResponse(SyncedFlushResponse results, XContentBuilder builder) throws Exception {\n-                builder.startObject();\n-                results.toXContent(builder, request);\n-                builder.endObject();\n-                return new BytesRestResponse(results.restStatus(), builder);\n-            }\n-        });\n+        FlushRequest flushRequest = new FlushRequest(Strings.splitStringByCommaToArray(request.param(\"index\")));\n+        flushRequest.indicesOptions(IndicesOptions.fromRequest(request, flushRequest.indicesOptions()));\n+        return channel -> client.admin().indices().flush(flushRequest, new SimulateSyncedFlushResponseListener(channel));\n+    }\n+\n+    static final class SimulateSyncedFlushResponseListener extends RestToXContentListener<FlushResponse> {\n+        SimulateSyncedFlushResponseListener(RestChannel channel) {\n+            super(channel);\n+        }\n+\n+        @Override\n+        public RestResponse buildResponse(FlushResponse flushResponse, XContentBuilder builder) throws Exception {\n+            final RestStatus restStatus = flushResponse.getFailedShards() > 0 ? RestStatus.OK : RestStatus.CONFLICT;\n+            final SyncedFlushResponse syncedFlushResponse = new SyncedFlushResponse(flushResponse);\n+            syncedFlushResponse.toXContent(builder, channel.request());\n+            return new BytesRestResponse(restStatus, builder);\n+        }\n+    }\n+\n+    static final class SyncedFlushResponse implements ToXContent {\n+        private final FlushResponse flushResponse;\n+\n+        SyncedFlushResponse(FlushResponse flushResponse) {\n+            this.flushResponse = flushResponse;\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject(\"_shards\");\n+            builder.field(\"warning\", \"Synced flush was removed and a normal flush was performed instead. \"\n+                + \"This transition will be removed a future Elasticsearch version.\");", "originalCommit": "c37007717983213afc9dea3c82214ee27c0552e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg2NjY4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/50882#discussion_r365866683", "bodyText": "what about this todo?", "author": "ywelsch", "createdAt": "2020-01-13T15:31:03Z", "path": "server/src/test/java/org/elasticsearch/indices/recovery/IndexRecoveryIT.java", "diffHunk": "@@ -346,8 +343,7 @@ public void testCancelNewShardRecoveryAndUsesExistingShardCopy() throws Exceptio\n         logger.info(\"--> start node C\");\n         final String nodeC = internalCluster().startNode();\n \n-        // do sync flush to gen sync id\n-        assertThat(client().admin().indices().prepareSyncedFlush(INDEX_NAME).get().failedShards(), equalTo(0));\n+        // TODO: Sync retention leases", "originalCommit": "c37007717983213afc9dea3c82214ee27c0552e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "85af3307bb358370d6656ff07bc8ea21a73fb23c", "url": "https://github.com/elastic/elasticsearch/commit/85af3307bb358370d6656ff07bc8ea21a73fb23c", "message": "Merge branch 'master' into remove-synced-flush", "committedDate": "2020-01-14T04:05:23Z", "type": "commit"}, {"oid": "f148ce2b5789e9193a116e5d3df3e0545ed1b8c0", "url": "https://github.com/elastic/elasticsearch/commit/f148ce2b5789e9193a116e5d3df3e0545ed1b8c0", "message": "revert the engine part", "committedDate": "2020-01-14T04:06:17Z", "type": "commit"}, {"oid": "09d33d8c5871969b6085f93b149b3a18a2fba843", "url": "https://github.com/elastic/elasticsearch/commit/09d33d8c5871969b6085f93b149b3a18a2fba843", "message": "keep sync_id", "committedDate": "2020-01-14T04:09:56Z", "type": "commit"}, {"oid": "4db96c1ad7362b4d16c66cc39f7cfd46830727d4", "url": "https://github.com/elastic/elasticsearch/commit/4db96c1ad7362b4d16c66cc39f7cfd46830727d4", "message": "fix compilation", "committedDate": "2020-01-14T04:27:00Z", "type": "commit"}, {"oid": "5c0959c3483915d2a8eaae60169e27585d904167", "url": "https://github.com/elastic/elasticsearch/commit/5c0959c3483915d2a8eaae60169e27585d904167", "message": "smoother transition", "committedDate": "2020-01-15T19:18:47Z", "type": "commit"}, {"oid": "132a80440566f81e29a9715ff0cad5cdf9e07384", "url": "https://github.com/elastic/elasticsearch/commit/132a80440566f81e29a9715ff0cad5cdf9e07384", "message": "Merge branch 'master' into remove-synced-flush", "committedDate": "2020-01-15T19:20:47Z", "type": "commit"}, {"oid": "a9284b8f9cac2d10b721aa099e099435b7cc4945", "url": "https://github.com/elastic/elasticsearch/commit/a9284b8f9cac2d10b721aa099e099435b7cc4945", "message": "transition test", "committedDate": "2020-01-15T23:02:06Z", "type": "commit"}, {"oid": "bfe2bf2413d8b76ea3b2228b70113a7728c74773", "url": "https://github.com/elastic/elasticsearch/commit/bfe2bf2413d8b76ea3b2228b70113a7728c74773", "message": "sync retention lease", "committedDate": "2020-01-15T23:02:11Z", "type": "commit"}, {"oid": "7f0e334bd820804b45a970578b574ddb71b0fb86", "url": "https://github.com/elastic/elasticsearch/commit/7f0e334bd820804b45a970578b574ddb71b0fb86", "message": "restore synced flush in full cluster restart", "committedDate": "2020-01-16T00:53:49Z", "type": "commit"}, {"oid": "023c753d937f44e8d77693c6c04534d71758aea6", "url": "https://github.com/elastic/elasticsearch/commit/023c753d937f44e8d77693c6c04534d71758aea6", "message": "oops", "committedDate": "2020-01-16T02:39:01Z", "type": "commit"}, {"oid": "8a77dcad82334fc99152b64f788fb5a38c3e1c70", "url": "https://github.com/elastic/elasticsearch/commit/8a77dcad82334fc99152b64f788fb5a38c3e1c70", "message": "new node should not return conflict status", "committedDate": "2020-01-16T03:14:55Z", "type": "commit"}, {"oid": "25ef006e540be04dad43e1904c8ddd17d3ff368b", "url": "https://github.com/elastic/elasticsearch/commit/25ef006e540be04dad43e1904c8ddd17d3ff368b", "message": "fix warning handler", "committedDate": "2020-01-16T03:47:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI5Njc0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50882#discussion_r367296749", "bodyText": "remove the if (randomBoolean()) { here, it's no longer needed", "author": "ywelsch", "createdAt": "2020-01-16T08:55:06Z", "path": "test/framework/src/main/java/org/elasticsearch/test/ESIntegTestCase.java", "diffHunk": "@@ -1404,9 +1403,6 @@ private void postIndexAsyncActions(String[] indices, List<CountDownLatch> inFlig\n                 if (randomBoolean()) {", "originalCommit": "25ef006e540be04dad43e1904c8ddd17d3ff368b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d26b573220bce8b4a273b2a37fe7753d3d54e6a", "url": "https://github.com/elastic/elasticsearch/commit/3d26b573220bce8b4a273b2a37fe7753d3d54e6a", "message": "Merge branch 'master' into remove-synced-flush", "committedDate": "2020-01-16T13:42:37Z", "type": "commit"}, {"oid": "d183f69d4c5a751d7885092d321589a081b790f0", "url": "https://github.com/elastic/elasticsearch/commit/d183f69d4c5a751d7885092d321589a081b790f0", "message": "remove unneeded if", "committedDate": "2020-01-16T13:45:21Z", "type": "commit"}]}