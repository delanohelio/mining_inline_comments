{"pr_number": 52199, "pr_title": "SearchableSnapshotIndexInput should read all bytes", "pr_createdAt": "2020-02-11T13:18:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52199", "timeline": [{"oid": "286063a3f88f102fd163012971bba9782bcbab0f", "url": "https://github.com/elastic/elasticsearch/commit/286063a3f88f102fd163012971bba9782bcbab0f", "message": "SearchableSnapshotIndexInput should read all bytes", "committedDate": "2020-02-11T13:12:36Z", "type": "commit"}, {"oid": "7b50c0817222bbf111c8682ebf7ec354d26582f2", "url": "https://github.com/elastic/elasticsearch/commit/7b50c0817222bbf111c8682ebf7ec354d26582f2", "message": "Revert", "committedDate": "2020-02-11T13:20:36Z", "type": "commit"}, {"oid": "4de4f81846150a0f1edf6174b55823aaac5f6f0a", "url": "https://github.com/elastic/elasticsearch/commit/4de4f81846150a0f1edf6174b55823aaac5f6f0a", "message": "test", "committedDate": "2020-02-11T13:37:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzOTk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377639979", "bodyText": "This means we hit the end of the file, which I think is unexpected. In tests the assertion below will fail; in production we will proceed even though some of the buffer contains its old contents, which would be bad. I think instead we should throw an EOFException here.", "author": "DaveCTurner", "createdAt": "2020-02-11T13:41:23Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -121,9 +121,19 @@ private void readInternalBytes(final int part, long pos, final byte[] b, int off\n             // we did not read everything in an optimized fashion, so read the remainder directly\n             try (InputStream inputStream\n                      = blobContainer.readBlob(fileInfo.partName(part), pos + optimizedReadSize, length - optimizedReadSize)) {\n-                final int directReadSize = inputStream.read(b, offset + optimizedReadSize, length - optimizedReadSize);\n+\n+                int directReadSize = 0;\n+                while ((optimizedReadSize + directReadSize) < length) {\n+                    final int read = inputStream.read(b,\n+                                                      offset + optimizedReadSize + directReadSize,\n+                                                      length - optimizedReadSize - directReadSize);\n+                    if (read == -1) {\n+                        break;", "originalCommit": "7b50c0817222bbf111c8682ebf7ec354d26582f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NjM2OA==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377666368", "bodyText": "I think instead we should throw an EOFException here.\n\nI pushed e06a94b", "author": "tlrx", "createdAt": "2020-02-11T14:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYzOTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY0MDIzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377640235", "bodyText": "Could we extract a method to do this? The two changes to this file look very similar.", "author": "DaveCTurner", "createdAt": "2020-02-11T13:41:54Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -276,10 +286,17 @@ boolean canContinueSequentialRead(int part, long pos) {\n \n         int read(byte[] b, int offset, int length) throws IOException {\n             assert this.pos < maxPos : \"should not try and read from a fully-read stream\";\n-            int read = inputStream.read(b, offset, length);\n-            assert read <= length : read + \" vs \" + length;\n-            pos += read;\n-            return read;\n+            int totalRead = 0;", "originalCommit": "7b50c0817222bbf111c8682ebf7ec354d26582f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NjQ2OA==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377666468", "bodyText": "Sure, done in e06a94b", "author": "tlrx", "createdAt": "2020-02-11T14:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY0MDIzNQ=="}], "type": "inlineReview"}, {"oid": "e06a94b0f558ed2b85fdf1975856141a1d42210e", "url": "https://github.com/elastic/elasticsearch/commit/e06a94b0f558ed2b85fdf1975856141a1d42210e", "message": "apply feedback", "committedDate": "2020-02-11T14:25:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTE5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377719193", "bodyText": "I'm wondering whether we should throw an EOFException if this hits EOF too. Do we need to behave differently here?", "author": "DaveCTurner", "createdAt": "2020-02-11T15:45:02Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -276,7 +296,7 @@ boolean canContinueSequentialRead(int part, long pos) {\n \n         int read(byte[] b, int offset, int length) throws IOException {\n             assert this.pos < maxPos : \"should not try and read from a fully-read stream\";\n-            int read = inputStream.read(b, offset, length);\n+            final int read = readFully(inputStream, b, offset, length, () -> {});", "originalCommit": "e06a94b0f558ed2b85fdf1975856141a1d42210e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMTYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377721611", "bodyText": "Oh no I get it now, we might use this to read past the end of a stream that we previously opened. Never mind.", "author": "DaveCTurner", "createdAt": "2020-02-11T15:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNDAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/52199#discussion_r377724000", "bodyText": "Yes", "author": "tlrx", "createdAt": "2020-02-11T15:52:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTE5Mw=="}], "type": "inlineReview"}, {"oid": "75cad8f5da60f8491cfcc6e9ae5bf00182a4a15d", "url": "https://github.com/elastic/elasticsearch/commit/75cad8f5da60f8491cfcc6e9ae5bf00182a4a15d", "message": "Merge branch 'feature/searchable-snapshots' into S3RetryingInputStream", "committedDate": "2020-02-12T11:36:52Z", "type": "commit"}]}