{"pr_number": 54776, "pr_title": "Fix scripted metric in ccs", "pr_createdAt": "2020-04-05T21:09:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54776", "timeline": [{"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b", "url": "https://github.com/elastic/elasticsearch/commit/99ebd13e4b42f7977ff19b9568566b30d019dc6b", "message": "Fix scripted metric in ccs\n\n`scripted_metric` did not work with cross cluster search because it\nassumed that you'd never perform a partial reduction, serialize the\nresults, and then perform a final reduction. That\nserialized-after-partial-reduction step was broken.\n\nThis is also required to support #54758.", "committedDate": "2020-04-05T21:04:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1ODk1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r404158957", "bodyText": "nit: a partial reduce", "author": "jimczi", "createdAt": "2020-04-06T14:58:07Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -296,7 +296,7 @@ public void testReduceRandom() {\n         ScriptService mockScriptService = mockScriptService();\n         MockBigArrays bigArrays = new MockBigArrays(new MockPageCacheRecycler(Settings.EMPTY), new NoneCircuitBreakerService());\n         if (randomBoolean() && toReduce.size() > 1) {\n-            // sometimes do an incremental reduce\n+            // sometimes do an partial reduce", "originalCommit": "99ebd13e4b42f7977ff19b9568566b30d019dc6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTgxMA==", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r404159810", "bodyText": "Should it simply say that we test the serialization of partially reduced result since you have another change that will make this possible in normal search ?", "author": "jimczi", "createdAt": "2020-04-06T14:59:06Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -312,6 +312,13 @@ public void testReduceRandom() {\n             //check that non final reduction never adds buckets\n             assertThat(reducedBucketCount, lessThanOrEqualTo(initialBucketCount));\n             toReduce = new ArrayList<>(toReduce.subList(r, toReduceSize));\n+            /*\n+             * sometimes simulate cross cluster search by serializing and\n+             * deserializing the partially reduced result.\n+             */", "originalCommit": "99ebd13e4b42f7977ff19b9568566b30d019dc6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE4MzAxNA==", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r404183014", "bodyText": "Sure.", "author": "nik9000", "createdAt": "2020-04-06T15:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTgxMA=="}], "type": "inlineReview"}, {"oid": "89439f9540542c7eaaa5d2dc8b9e3d72498df33b", "url": "https://github.com/elastic/elasticsearch/commit/89439f9540542c7eaaa5d2dc8b9e3d72498df33b", "message": "itr", "committedDate": "2020-04-06T15:33:32Z", "type": "commit"}, {"oid": "2906175c8970168bb8354c31b385d7cbf23aefdf", "url": "https://github.com/elastic/elasticsearch/commit/2906175c8970168bb8354c31b385d7cbf23aefdf", "message": "Merge branch 'master' into ccs_scripted_metric", "committedDate": "2020-04-06T20:30:56Z", "type": "commit"}, {"oid": "f525d4cec333b5e155755f67e731c8eaa5cf6d7e", "url": "https://github.com/elastic/elasticsearch/commit/f525d4cec333b5e155755f67e731c8eaa5cf6d7e", "message": "Sneaky", "committedDate": "2020-04-06T20:41:58Z", "type": "commit"}]}