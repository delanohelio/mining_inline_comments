{"pr_number": 56492, "pr_title": "SQL: Fix serialization of JDBC prep statement date/time params", "pr_createdAt": "2020-05-10T14:26:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56492", "timeline": [{"oid": "8a4eb60a75694d76fb91d3757af9bc22519efb39", "url": "https://github.com/elastic/elasticsearch/commit/8a4eb60a75694d76fb91d3757af9bc22519efb39", "message": "SQL: Fix serialization of JDBC prep statement date/time params\n\nThe Date/Time related query params of a JDBC prepared statement\nserialized using java.util.Date. The rules for serializing\n`java.util.Date` objects though reside in\n`XContentElasticsearchExtension` which is not available in the\njdbc jar as this class is in `server` module. Therefore, a\ncustom extension of the `XContentBuilderExtension` iface has been\nadded to the jdbc module/jar.\n\nMoreover the sql's `qa` project had as dependency the `sql-action`\nmodule which depends on `server` so the `XContentBuilderExtension`\nwas available for the integ tests hiding the real problem.\n\nFixes: #56084", "committedDate": "2020-05-10T14:19:19Z", "type": "commit"}, {"oid": "f818a593d9d230f0337b46d741b9d216a3f62019", "url": "https://github.com/elastic/elasticsearch/commit/f818a593d9d230f0337b46d741b9d216a3f62019", "message": "Fix issue with TIME data type", "committedDate": "2020-05-11T12:29:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxOTQxNg==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423019416", "bodyText": "\ud83d\udc4d", "author": "bpintea", "createdAt": "2020-05-11T12:57:43Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/PreparedStatementTestCase.java", "diffHunk": "@@ -32,10 +47,23 @@ public void testSupportedTypes() throws Exception {\n         byte byteVal = randomByte();\n         short shortVal = randomShort();\n         BigDecimal bigDecimalVal = BigDecimal.valueOf(randomDouble());\n+        long millis = randomNonNegativeLong();\n+        Calendar calendarVal = Calendar.getInstance(randomTimeZone(), Locale.ROOT);\n+        Timestamp timestampVal = new Timestamp(millis);\n+        Timestamp timestampValWithCal = new Timestamp(convertFromCalendarToUTC(timestampVal.getTime(), calendarVal));\n+        Date dateVal = asDate(millis, UTC);\n+        Date dateValWithCal = asDate(convertFromCalendarToUTC(dateVal.getTime(), calendarVal), UTC);\n+        Time timeVal = asTime(millis, UTC);\n+        Time timeValWithCal = asTime(convertFromCalendarToUTC(timeVal.getTime(), calendarVal), UTC);\n+        java.util.Date utilDateVal = new java.util.Date(millis);\n+        LocalDateTime localDateTimeVal = LocalDateTime.ofInstant(Instant.ofEpochMilli(millis), UTC);\n \n         try (Connection connection = esJdbc()) {\n-            try (PreparedStatement statement = connection.prepareStatement(\n-                    \"SELECT ?, ?, ?, ?, ?, ?, ?, ?, ?, ?\")) {\n+            StringJoiner sql = new StringJoiner(\",\", \"SELECT \", \"\");\n+            for (int i = 0; i < 19; i++) {\n+                sql.add(\"?\");\n+            }", "originalCommit": "f818a593d9d230f0337b46d741b9d216a3f62019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxOTY2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423019666", "bodyText": "Just a more concise alternative suggestion: return randomMillis - 2 + i (tho not perfectly equivalent).", "author": "bpintea", "createdAt": "2020-05-11T12:58:10Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/PreparedStatementTestCase.java", "diffHunk": "@@ -207,4 +301,28 @@ public void testSingleParameterMultipleTypes() throws Exception {\n             return result;\n         }\n     }\n+\n+    private static long convertFromCalendarToUTC(long value, Calendar cal) {\n+        if (cal == null) {\n+            return value;\n+        }\n+        Calendar c = (Calendar) cal.clone();\n+        c.setTimeInMillis(value);\n+\n+        ZonedDateTime convertedDateTime = ZonedDateTime\n+            .ofInstant(c.toInstant(), c.getTimeZone().toZoneId())\n+            .withZoneSameLocal(ZoneOffset.UTC);\n+\n+        return convertedDateTime.toInstant().toEpochMilli();\n+    }\n+\n+    private static long testMillis(long randomMillis, int i) {\n+        long millis = randomMillis;\n+        if (i == 1) {\n+            millis -= 1;\n+        } else if (i == 3) {\n+            millis += 1;\n+        }\n+        return millis;", "originalCommit": "f818a593d9d230f0337b46d741b9d216a3f62019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "url": "https://github.com/elastic/elasticsearch/commit/2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "message": "address comments", "committedDate": "2020-05-11T13:16:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0NzU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423247588", "bodyText": "\ud83d\udc4d", "author": "costin", "createdAt": "2020-05-11T18:50:39Z", "path": "x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/JdbcPreparedStatement.java", "diffHunk": "@@ -381,12 +384,9 @@ private void setObject(int parameterIndex, Object x, EsType dataType, String typ\n                     dateToSet = ((Calendar) x).getTime();\n                 } else if (x instanceof Date) {\n                     dateToSet = new java.util.Date(((Date) x).getTime());\n-                } else if (x instanceof LocalDateTime){\n+                } else if (x instanceof LocalDateTime) {\n                     LocalDateTime ldt = (LocalDateTime) x;\n-                    Calendar cal = getDefaultCalendar();\n-                    cal.set(ldt.getYear(), ldt.getMonthValue() - 1, ldt.getDayOfMonth(), ldt.getHour(), ldt.getMinute(), ldt.getSecond());\n-\n-                    dateToSet = cal.getTime();\n+                    dateToSet = new java.util.Date(ldt.toInstant(UTC).toEpochMilli());", "originalCommit": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0ODEyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423248125", "bodyText": "The javadoc is out of place.", "author": "costin", "createdAt": "2020-05-11T18:51:36Z", "path": "x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/XContentSqlExtension.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.jdbc;\n+\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentBuilderExtension;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+/**\n+ * SPI extensions for Elasticsearch-specific classes (like the Lucene or Joda", "originalCommit": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwODc2OA==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423508768", "bodyText": "Oops,  just copy paste from the original class, will fix.", "author": "matriv", "createdAt": "2020-05-12T07:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0ODEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0OTUzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423249535", "bodyText": "Can you please break this method down into 3 different tests? This way if one of them breaks, it will be easier to identify the test that did it.", "author": "costin", "createdAt": "2020-05-11T18:54:09Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/PreparedStatementTestCase.java", "diffHunk": "@@ -66,13 +103,70 @@ public void testSupportedTypes() throws Exception {\n                     assertEquals(byteVal, results.getByte(8));\n                     assertEquals(shortVal, results.getShort(9));\n                     assertEquals(bigDecimalVal, results.getBigDecimal(10));\n+                    assertEquals(timestampVal, results.getTimestamp(11));\n+                    assertEquals(timestampValWithCal, results.getTimestamp(12));\n+                    assertEquals(dateVal, results.getDate(13));\n+                    assertEquals(dateValWithCal, results.getDate(14));\n+                    assertEquals(timeVal, results.getTime(15));\n+                    assertEquals(timeValWithCal, results.getTime(16));\n+                    assertEquals(new Timestamp(calendarVal.getTimeInMillis()), results.getObject(17));\n+                    assertEquals(timestampVal, results.getObject(18));\n+                    assertEquals(timestampVal, results.getObject(19));\n+                    assertFalse(results.next());\n+                }\n+            }\n+        }\n+    }\n+\n+    public void testDateTime() throws IOException, SQLException {", "originalCommit": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTI2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423251261", "bodyText": "The exception change for this method and the rest are noise likely introduced by IDE changes.\nI'm not a fan since it implies the author does not know the type of exception used - it's more valuable to do that in a separate step instead of a regular basis.", "author": "costin", "createdAt": "2020-05-11T18:56:50Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/PreparedStatementTestCase.java", "diffHunk": "@@ -66,13 +103,70 @@ public void testSupportedTypes() throws Exception {\n                     assertEquals(byteVal, results.getByte(8));\n                     assertEquals(shortVal, results.getShort(9));\n                     assertEquals(bigDecimalVal, results.getBigDecimal(10));\n+                    assertEquals(timestampVal, results.getTimestamp(11));\n+                    assertEquals(timestampValWithCal, results.getTimestamp(12));\n+                    assertEquals(dateVal, results.getDate(13));\n+                    assertEquals(dateValWithCal, results.getDate(14));\n+                    assertEquals(timeVal, results.getTime(15));\n+                    assertEquals(timeValWithCal, results.getTime(16));\n+                    assertEquals(new Timestamp(calendarVal.getTimeInMillis()), results.getObject(17));\n+                    assertEquals(timestampVal, results.getObject(18));\n+                    assertEquals(timestampVal, results.getObject(19));\n+                    assertFalse(results.next());\n+                }\n+            }\n+        }\n+    }\n+\n+    public void testDateTime() throws IOException, SQLException {\n+        String mapping = \"\\\"properties\\\":{\\\"id\\\":{\\\"type\\\":\\\"integer\\\"},\\\"birth_date\\\":{\\\"type\\\":\\\"date\\\"}}\";\n+        createIndex(\"emps\", Settings.EMPTY, mapping);\n+        long randomMillis = randomNonNegativeLong();\n+        for (int i = 1; i <= 3; i++) {\n+            int id = 1000 + i;\n+            long testMillis = testMillis(randomMillis, i);\n+            index(\"emps\", \"\" + i, builder -> {\n+                builder.field(\"id\", id);\n+                builder.field(\"birth_date\", testMillis);\n+            });\n+        }\n+\n+        try (Connection connection = esJdbc()) {\n+            try (PreparedStatement statement = connection.prepareStatement(\"SELECT id, birth_date FROM emps WHERE birth_date = ?\")) {\n+                Object dateTimeParam = randomFrom(new Timestamp(randomMillis), new Date(randomMillis));\n+                statement.setObject(1, dateTimeParam);\n+                try (ResultSet results = statement.executeQuery()) {\n+                    assertTrue(results.next());\n+                    assertEquals(1002, results.getInt(1));\n+                    assertEquals(new Timestamp(randomMillis), results.getTimestamp(2));\n+                    assertFalse(results.next());\n+                }\n+            }\n+            try (PreparedStatement statement = connection.prepareStatement(\"SELECT id, birth_date FROM emps WHERE birth_date::date = ?\")) {\n+                statement.setDate(1, new Date(asDate(randomMillis, UTC).getTime()));\n+                try (ResultSet results = statement.executeQuery()) {\n+                    for (int i = 1; i <= 3; i++) {\n+                        assertTrue(results.next());\n+                        assertEquals(1000 + i, results.getInt(1));\n+                        assertEquals(new Timestamp(testMillis(randomMillis, i)), results.getTimestamp(2));\n+                    }\n+                    assertFalse(results.next());\n+                }\n+            }\n+            try (PreparedStatement statement = connection.prepareStatement(\"SELECT id, birth_date FROM emps WHERE birth_date::time = ?\")) {\n+                Time time = JdbcTestUtils.asTime(randomMillis, UTC);\n+                statement.setObject(1, time);\n+                try (ResultSet results = statement.executeQuery()) {\n+                    assertTrue(results.next());\n+                    assertEquals(1002, results.getInt(1));\n+                    assertEquals(new Timestamp(randomMillis), results.getTimestamp(2));\n                     assertFalse(results.next());\n                 }\n             }\n         }\n     }\n \n-    public void testOutOfRangeBigDecimal() throws Exception {\n+    public void testOutOfRangeBigDecimal() throws SQLException {\n         try (Connection connection = esJdbc()) {\n             try (PreparedStatement statement = connection.prepareStatement(\"SELECT ?\")) {\n                 BigDecimal tooLarge = BigDecimal.valueOf(Double.MAX_VALUE).add(BigDecimal.ONE);", "originalCommit": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTU5OA==", "url": "https://github.com/elastic/elasticsearch/pull/56492#discussion_r423251598", "bodyText": "Is this something used somewhere else that could be moved into a DateUtils/TestUtils of sorts?", "author": "costin", "createdAt": "2020-05-11T18:57:26Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/PreparedStatementTestCase.java", "diffHunk": "@@ -207,4 +301,22 @@ public void testSingleParameterMultipleTypes() throws Exception {\n             return result;\n         }\n     }\n+\n+    private static long convertFromCalendarToUTC(long value, Calendar cal) {", "originalCommit": "2fdc2a4f5483c95c91e7a97cd8b92cd32eb2875d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00d80c3100f8725d8facac76e834bfd09509e364", "url": "https://github.com/elastic/elasticsearch/commit/00d80c3100f8725d8facac76e834bfd09509e364", "message": "address comments", "committedDate": "2020-05-12T07:45:11Z", "type": "commit"}, {"oid": "1e66e487dbf6e0929b2048dd42c6817b85a46c7a", "url": "https://github.com/elastic/elasticsearch/commit/1e66e487dbf6e0929b2048dd42c6817b85a46c7a", "message": "fix imports", "committedDate": "2020-05-12T08:04:50Z", "type": "commit"}, {"oid": "448c9b66c9709efacf0e2532cce83e077b57c8e7", "url": "https://github.com/elastic/elasticsearch/commit/448c9b66c9709efacf0e2532cce83e077b57c8e7", "message": "Merge remote-tracking branch 'upstream/master' into fix-56084", "committedDate": "2020-05-12T08:44:15Z", "type": "commit"}]}