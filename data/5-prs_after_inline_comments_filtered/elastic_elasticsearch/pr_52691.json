{"pr_number": 52691, "pr_title": "Avoid NPE in set_security_user without security", "pr_createdAt": "2020-02-24T05:38:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52691", "timeline": [{"oid": "9a3d96ceda692a688e4d2a9c193810c71f153d04", "url": "https://github.com/elastic/elasticsearch/commit/9a3d96ceda692a688e4d2a9c193810c71f153d04", "message": "Avoid NPE in set_security_user without security\n\nIf security was disabled (explicitly), then the SecurityContext would\nbe null, but the set_security_user processor was still registered.\n\nAttempting to define a pipeline that used that processor would fail\nwith an (intentional) NPE. This behaviour, introduced in #52032, is a\nregression from previous releases where the pipeline was allowed, but\nwas no usable.\n\nThis change restores the previous behaviour (with a new warning).", "committedDate": "2020-02-24T05:34:40Z", "type": "commit"}, {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115", "url": "https://github.com/elastic/elasticsearch/commit/de04ed950f80368c4ba966ed396b1a595bfb9115", "message": "Remove unnecessary users/roles", "committedDate": "2020-02-24T05:42:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5ODQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r383098490", "bodyText": "Not sure how feasible or necessary it is to test the warning message. Another nitpick is maybe change \"no security context is available\" to something like \"security is not enabled\" for consistency with other exception message and easier to understand for users.", "author": "ywangd", "createdAt": "2020-02-24T06:19:08Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -34,20 +35,29 @@\n \n     public static final String TYPE = \"set_security_user\";\n \n+    private final Logger logger = LogManager.getLogger();\n+\n     private final SecurityContext securityContext;\n     private final String field;\n     private final Set<Property> properties;\n \n     public\n     SetSecurityUserProcessor(String tag, SecurityContext securityContext, String field, Set<Property> properties) {\n         super(tag);\n-        this.securityContext = Objects.requireNonNull(securityContext, \"security context must be provided\");\n+        this.securityContext = securityContext;\n+        if (this.securityContext == null) {\n+            logger.warn(\"Creating processor [{}] (tag [{}]) on field [{}] but no security context is available\" +\n+                \" - this processor will fail at runtime if it is used\", TYPE, tag, field);", "originalCommit": "de04ed950f80368c4ba966ed396b1a595bfb9115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMjM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r385432388", "bodyText": "I'll come up with something. My concern is trying to diagnose a root cause from secondary symptoms (I know there's no security context, I don't know for sure exactly why that is), but I'll sort something out.", "author": "tvernum", "createdAt": "2020-02-27T23:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5ODQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyMDE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r385020140", "bodyText": "If we are sure, we could state instead of frame it as a Q", "author": "jkakavas", "createdAt": "2020-02-27T09:55:04Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -34,20 +35,29 @@\n \n     public static final String TYPE = \"set_security_user\";\n \n+    private final Logger logger = LogManager.getLogger();\n+\n     private final SecurityContext securityContext;\n     private final String field;\n     private final Set<Property> properties;\n \n     public\n     SetSecurityUserProcessor(String tag, SecurityContext securityContext, String field, Set<Property> properties) {\n         super(tag);\n-        this.securityContext = Objects.requireNonNull(securityContext, \"security context must be provided\");\n+        this.securityContext = securityContext;\n+        if (this.securityContext == null) {\n+            logger.warn(\"Creating processor [{}] (tag [{}]) on field [{}] but no security context is available\" +\n+                \" - this processor will fail at runtime if it is used\", TYPE, tag, field);\n+        }\n         this.field = field;\n         this.properties = properties;\n     }\n \n     @Override\n     public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n+        if (this.securityContext == null) {\n+            throw new IllegalStateException(\"No security context available (is security enabled on this cluster?)\");", "originalCommit": "de04ed950f80368c4ba966ed396b1a595bfb9115", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b1847d479d1fc90ca20209399b8e395a838330d", "url": "https://github.com/elastic/elasticsearch/commit/0b1847d479d1fc90ca20209399b8e395a838330d", "message": "Merge branch 'master' into fix/52474-NPE-set-sec-user-processor", "committedDate": "2020-02-27T23:38:16Z", "type": "commit"}, {"oid": "3068a9ebfe35fb58b20bc9407fbb398145ab0f29", "url": "https://github.com/elastic/elasticsearch/commit/3068a9ebfe35fb58b20bc9407fbb398145ab0f29", "message": "Improve error messages", "committedDate": "2020-02-28T04:29:55Z", "type": "commit"}, {"oid": "f4aec1e6ce714772345ef348570d79102ac4f394", "url": "https://github.com/elastic/elasticsearch/commit/f4aec1e6ce714772345ef348570d79102ac4f394", "message": "Remove unnecessary test cluster config", "committedDate": "2020-02-28T04:34:02Z", "type": "commit"}, {"oid": "4448f5187f3b95fe43e7fabed507e1a4bbd6bbcb", "url": "https://github.com/elastic/elasticsearch/commit/4448f5187f3b95fe43e7fabed507e1a4bbd6bbcb", "message": "Fix line length", "committedDate": "2020-02-28T04:57:23Z", "type": "commit"}, {"oid": "b56cdd93a80a79a619143f1f0b60ae24819a217b", "url": "https://github.com/elastic/elasticsearch/commit/b56cdd93a80a79a619143f1f0b60ae24819a217b", "message": "Merge branch 'master' into fix/52474-NPE-set-sec-user-processor", "committedDate": "2020-03-05T04:27:24Z", "type": "commit"}]}