{"pr_number": 51562, "pr_title": "SQL: Fix ORDER BY YEAR() function", "pr_createdAt": "2020-01-28T20:10:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51562", "timeline": [{"oid": "34d31f33869a8883cd39b9045bea7f781740e1e9", "url": "https://github.com/elastic/elasticsearch/commit/34d31f33869a8883cd39b9045bea7f781740e1e9", "message": "SQL: Fix ORDER BY YEAR() function\n\nPreviously, if `YEAR()` was used as and ORDER BY argument without being\nwrapped with another scalar (e.g. `YEAR(birth_date) + 10`), no script\nordering was used but instead the underlying field (e.g. `birth_date`)\nwas used instead as a performance optimisation. This works correctly if\nYEAR() is the only ORDER BY arg but if further args are used as tie\nbreakers for the ordering wrong results are produced. This is because\n2 rows with the different `birth_date but on the same year are not tied\nas the underlying ordering is on `birth_date` and not on the\n`YEAR(birth_date)`, and the following ORDER BY args are ignored.\n\nRemove this optimisation for `YEAR()` to avoid incorrect results in\nsuch cases.\n\nFixes: #51224", "committedDate": "2020-01-28T20:47:36Z", "type": "commit"}, {"oid": "94251c9b43c0a21f829ff82d23abd55c5859aab1", "url": "https://github.com/elastic/elasticsearch/commit/94251c9b43c0a21f829ff82d23abd55c5859aab1", "message": "adapt test", "committedDate": "2020-01-28T20:54:36Z", "type": "commit"}, {"oid": "94251c9b43c0a21f829ff82d23abd55c5859aab1", "url": "https://github.com/elastic/elasticsearch/commit/94251c9b43c0a21f829ff82d23abd55c5859aab1", "message": "adapt test", "committedDate": "2020-01-28T20:54:36Z", "type": "forcePushed"}, {"oid": "2aa1aee5b0268b432400ff3f001906b765b09f8b", "url": "https://github.com/elastic/elasticsearch/commit/2aa1aee5b0268b432400ff3f001906b765b09f8b", "message": "Merge remote-tracking branch 'upstream/master' into fix-51224", "committedDate": "2020-01-29T11:15:53Z", "type": "commit"}, {"oid": "1875e76cba5d7d0cacdd40c1d6a738c5648b460f", "url": "https://github.com/elastic/elasticsearch/commit/1875e76cba5d7d0cacdd40c1d6a738c5648b460f", "message": "Detect and prevent scalars on nested for ORDER BY", "committedDate": "2020-01-29T17:22:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NjY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372646686", "bodyText": "I think the method can be removed entirely - is it used anywhere else?", "author": "costin", "createdAt": "2020-01-29T21:43:16Z", "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java", "diffHunk": "@@ -39,17 +39,15 @@ protected ScalarFunction(Source source, List<Expression> fields) {\n         super(source, fields);\n     }\n \n-    // used if the function is monotonic and thus does not have to be computed for ordering purposes\n-    // null means the script needs to be used; expression means the field/expression to be used instead\n+    // Every function needs to be translated to a script\n+    // which will be used for the ordering", "originalCommit": "1875e76cba5d7d0cacdd40c1d6a738c5648b460f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NzE2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372647162", "bodyText": "why (fa)?", "author": "costin", "createdAt": "2020-01-29T21:44:13Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -722,16 +722,19 @@ private static void checkForScoreInsideFunctions(LogicalPlan p, Set<Failure> loc\n                 Function.class));\n     }\n \n-    private static void checkNestedUsedInGroupByOrHaving(LogicalPlan p, Set<Failure> localFailures) {\n+    private static void checkNestedUsedInGroupByOrHavingOrOrderBy(LogicalPlan p, Set<Failure> localFailures,\n+                                                                  AttributeMap<Expression> attributeRefs) {\n         List<FieldAttribute> nested = new ArrayList<>();\n-        Consumer<FieldAttribute> match = fa -> {\n+        Consumer<FieldAttribute> match = (fa) -> {", "originalCommit": "1875e76cba5d7d0cacdd40c1d6a738c5648b460f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0ODMzMA==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372648330", "bodyText": "Small nit - this type of call seems to be used 3 times (last time twice) - maybe could be extracted into a small method to avoid repetition.\nMaybe check if it's used anywhere else so even more of a reuse...", "author": "costin", "createdAt": "2020-01-29T21:46:41Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -722,16 +722,19 @@ private static void checkForScoreInsideFunctions(LogicalPlan p, Set<Failure> loc\n                 Function.class));\n     }\n \n-    private static void checkNestedUsedInGroupByOrHaving(LogicalPlan p, Set<Failure> localFailures) {\n+    private static void checkNestedUsedInGroupByOrHavingOrOrderBy(LogicalPlan p, Set<Failure> localFailures,\n+                                                                  AttributeMap<Expression> attributeRefs) {\n         List<FieldAttribute> nested = new ArrayList<>();\n-        Consumer<FieldAttribute> match = fa -> {\n+        Consumer<FieldAttribute> match = (fa) -> {\n             if (fa.isNested()) {\n                 nested.add(fa);\n             }\n         };\n \n         // nested fields shouldn't be used in aggregates or having (yet)\n-        p.forEachDown(a -> a.groupings().forEach(agg -> agg.forEachUp(match, FieldAttribute.class)), Aggregate.class);\n+        p.forEachDown(a -> a.groupings().forEach(agg -> agg.forEachUp(e ->", "originalCommit": "1875e76cba5d7d0cacdd40c1d6a738c5648b460f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "801ca3e00e9efbf285ea92e13a847d443fa644ed", "url": "https://github.com/elastic/elasticsearch/commit/801ca3e00e9efbf285ea92e13a847d443fa644ed", "message": "Address comments - disallow also in WHERE", "committedDate": "2020-01-30T11:46:10Z", "type": "commit"}, {"oid": "e50c2fd143080e6e3ac01f05ff7dcd0beac482cb", "url": "https://github.com/elastic/elasticsearch/commit/e50c2fd143080e6e3ac01f05ff7dcd0beac482cb", "message": "Merge remote-tracking branch 'upstream/master' into fix-51224", "committedDate": "2020-01-30T11:49:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwNzc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372907761", "bodyText": "Typo in the variable name: checkForNestedInFcuntion .", "author": "astefan", "createdAt": "2020-01-30T11:56:24Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -735,33 +740,61 @@ private static void checkForScoreInsideFunctions(LogicalPlan p, Set<Failure> loc\n                 Function.class));\n     }\n \n-    private static void checkNestedUsedInGroupByOrHaving(LogicalPlan p, Set<Failure> localFailures) {\n+    private static void checkNestedUsedInGroupByOrHavingOrWhereOrOrderBy(LogicalPlan p, Set<Failure> localFailures,\n+                                                                         AttributeMap<Expression> attributeRefs) {\n         List<FieldAttribute> nested = new ArrayList<>();\n-        Consumer<FieldAttribute> match = fa -> {\n+        Consumer<FieldAttribute> matchNested = fa -> {\n             if (fa.isNested()) {\n                 nested.add(fa);\n             }\n         };\n+        Consumer<Expression> checkForNested = e ->\n+                attributeRefs.getOrDefault(e, e).forEachUp(matchNested, FieldAttribute.class);\n+        Consumer<ScalarFunction> checkForNestedInFcuntion =  f -> f.arguments().forEach(", "originalCommit": "e50c2fd143080e6e3ac01f05ff7dcd0beac482cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwOTczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372909731", "bodyText": "I don't understand why this logic is removed. We removed the faulty support for sorting on nested fields that needs scripting, but why is this block of code associated with nested fields?", "author": "astefan", "createdAt": "2020-01-30T12:00:31Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryFolder.java", "diffHunk": "@@ -695,21 +695,8 @@ protected PhysicalPlan rule(OrderExec plan) {\n                         // scalar functions typically require script ordering\n                         if (orderExpression instanceof ScalarFunction) {\n                             ScalarFunction sf = (ScalarFunction) orderExpression;\n-                            // is there an expression to order by?\n-                            if (sf.orderBy() != null) {\n-                                Expression orderBy = sf.orderBy();\n-                                if (orderBy instanceof NamedExpression) {\n-                                    orderBy = qContainer.aliases().getOrDefault(orderBy, orderBy);\n-                                    qContainer = qContainer\n-                                            .addSort(new AttributeSort(((NamedExpression) orderBy).toAttribute(), direction, missing));\n-                                } else if (orderBy.foldable() == false) {\n-                                    // ignore constant\n-                                    throw new PlanningException(\"does not know how to order by expression {}\", orderBy);\n-                                }\n-                            } else {", "originalCommit": "e50c2fd143080e6e3ac01f05ff7dcd0beac482cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkxMTg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51562#discussion_r372911866", "bodyText": "This code was especially for Scalar Functions in case the orderBy() didn't return null -> no script creation, instead use the underlying field fo the ordering. The only use case of this was the YEAR() function.", "author": "matriv", "createdAt": "2020-01-30T12:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwOTczMQ=="}], "type": "inlineReview"}, {"oid": "88553dba58f4763a689512272cea93d57fd77bd5", "url": "https://github.com/elastic/elasticsearch/commit/88553dba58f4763a689512272cea93d57fd77bd5", "message": "address comments - typos/formatting", "committedDate": "2020-01-30T12:09:57Z", "type": "commit"}]}