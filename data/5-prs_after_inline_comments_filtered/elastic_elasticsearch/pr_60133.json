{"pr_number": 60133, "pr_title": "Remove typename validation", "pr_createdAt": "2020-07-23T15:42:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60133", "timeline": [{"oid": "f9b2431ebe686d901fc39c15ac1ef1a51f488f09", "url": "https://github.com/elastic/elasticsearch/commit/f9b2431ebe686d901fc39c15ac1ef1a51f488f09", "message": "Remove typename validation (typename is always )", "committedDate": "2020-07-23T15:39:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MDA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/60133#discussion_r459570050", "bodyText": "To be safe we could validate here that the type is equal to _doc. I think it may still be possible to pass through a custom type name using a transport CreateIndexRequest.", "author": "jtibshirani", "createdAt": "2020-07-23T16:18:19Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -307,36 +306,11 @@ private synchronized DocumentMapper internalMerge(String type, CompressedXConten\n         return internalMerge(documentMapper, reason);\n     }\n \n-    static void validateTypeName(String type) {\n-        if (type.length() == 0) {\n-            throw new InvalidTypeNameException(\"mapping type name is empty\");\n-        }\n-        if (type.length() > 255) {\n-            throw new InvalidTypeNameException(\"mapping type name [\" + type + \"] is too long; limit is length 255 but was [\"\n-                + type.length() + \"]\");\n-        }\n-        if (type.charAt(0) == '_' && SINGLE_MAPPING_NAME.equals(type) == false) {\n-            throw new InvalidTypeNameException(\"mapping type name [\" + type + \"] can't start with '_' unless it is called [\"\n-                + SINGLE_MAPPING_NAME + \"]\");\n-        }\n-        if (type.contains(\"#\")) {\n-            throw new InvalidTypeNameException(\"mapping type name [\" + type + \"] should not include '#' in it\");\n-        }\n-        if (type.contains(\",\")) {\n-            throw new InvalidTypeNameException(\"mapping type name [\" + type + \"] should not include ',' in it\");\n-        }\n-        if (type.charAt(0) == '.') {\n-            throw new IllegalArgumentException(\"mapping type name [\" + type + \"] must not start with a '.'\");\n-        }\n-    }\n-\n     private synchronized DocumentMapper internalMerge(DocumentMapper mapper, MergeReason reason) {\n         boolean hasNested = this.hasNested;\n         Map<String, ObjectMapper> fullPathObjectMappers = this.fullPathObjectMappers;\n \n         assert mapper != null;\n-        // check naming\n-        validateTypeName(mapper.type());", "originalCommit": "f9b2431ebe686d901fc39c15ac1ef1a51f488f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3NTM2OA==", "url": "https://github.com/elastic/elasticsearch/pull/60133#discussion_r459575368", "bodyText": "Unfortunately we can't assume that type will be _doc, because we could be updating mappings on a 7x index that had a custom type name.  CreateIndexRequest asserts on the type name in its StreamInput constructor, so I think we should be safe there.", "author": "romseygeek", "createdAt": "2020-07-23T16:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MDA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60133#discussion_r459581592", "bodyText": "Got it, I see the difficulty. I'm okay to merge as-is.", "author": "jtibshirani", "createdAt": "2020-07-23T16:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MDA1MA=="}], "type": "inlineReview"}]}