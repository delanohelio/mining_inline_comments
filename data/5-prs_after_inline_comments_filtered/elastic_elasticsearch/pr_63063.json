{"pr_number": 63063, "pr_title": "[ML] Auditor ensures template is installed before writes", "pr_createdAt": "2020-09-30T11:43:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63063", "timeline": [{"oid": "fd5ad54b6500b6bf4c97bc60766b25848c89df4b", "url": "https://github.com/elastic/elasticsearch/commit/fd5ad54b6500b6bf4c97bc60766b25848c89df4b", "message": "tidy up", "committedDate": "2020-10-02T10:28:29Z", "type": "forcePushed"}, {"oid": "243c49a640c81213a76db094725b4f878227d386", "url": "https://github.com/elastic/elasticsearch/commit/243c49a640c81213a76db094725b4f878227d386", "message": "code style", "committedDate": "2020-10-02T15:22:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5MzY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498893685", "bodyText": "The retrying bulk persister (ResultsPersisterService) would be useful here but is not accessible in this package.\n#62779 fixes that by moving the persister to core but there is some debate about exactly what we should do with ResultsPersisterService and it probably isn't necessary here.", "author": "davidkyle", "createdAt": "2020-10-02T15:29:24Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -83,4 +168,21 @@ private XContentBuilder toXContentBuilder(ToXContent toXContent) {\n             throw new RuntimeException(e);\n         }\n     }\n+\n+    private void writeBacklog() {\n+        BulkRequest bulkRequest = new BulkRequest();\n+        ToXContent doc = backlog.poll();\n+        while (doc != null) {\n+            bulkRequest.add(indexRequest(doc));\n+            doc = backlog.poll();\n+        }\n+\n+        client.bulk(bulkRequest, ActionListener.wrap(", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5NDU3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498894573", "bodyText": "#63024 changes transforms to use a registry which would make this code much simpler", "author": "davidkyle", "createdAt": "2020-10-02T15:30:52Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/notifications/TransformAuditor.java", "diffHunk": "@@ -17,7 +28,38 @@\n  */\n public class TransformAuditor extends AbstractAuditor<TransformAuditMessage> {\n \n-    public TransformAuditor(Client client, String nodeName) {\n-        super(client, nodeName, TransformInternalIndexConstants.AUDIT_INDEX, TRANSFORM_ORIGIN, TransformAuditMessage::new);\n+    public TransformAuditor(Client client, String nodeName, ClusterService clusterService) {\n+        super(new OriginSettingClient(client, TRANSFORM_ORIGIN), TransformInternalIndexConstants.AUDIT_INDEX,\n+            TransformInternalIndexConstants.AUDIT_INDEX,\n+            () -> {\n+                try {\n+                    IndexTemplateMetadata templateMeta = TransformInternalIndex.getAuditIndexTemplateMetadata();", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMjI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498912280", "bodyText": "I know there will be complexity, but we should make sure we don't breach some limit (10k, etc.) The size of the messages will probably be small enough so we don't have to worry about the bulk index byte size.\nBut the queue length is unbounded. We should check bounds somewhere.", "author": "benwtrent", "createdAt": "2020-10-02T16:03:11Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -83,4 +168,21 @@ private XContentBuilder toXContentBuilder(ToXContent toXContent) {\n             throw new RuntimeException(e);\n         }\n     }\n+\n+    private void writeBacklog() {\n+        BulkRequest bulkRequest = new BulkRequest();\n+        ToXContent doc = backlog.poll();\n+        while (doc != null) {\n+            bulkRequest.add(indexRequest(doc));\n+            doc = backlog.poll();\n+        }", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU1NTMzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r499555336", "bodyText": "I do think adding a sane limit (like 100 or something) would be simple enough. The != null while loop could still be on the outside, just need to have an inner conditional (and conditional afterwards) that calls client.bulk and resets the request.\nWill protect against a weird, and pretty nasty edge case.", "author": "benwtrent", "createdAt": "2020-10-05T12:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMjI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2ODAyNw==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r499568027", "bodyText": "I pushed a change to limit the buffer size to 1000, after 1000 messages the oldest ones start getting dropped from the queue. This simplifies the code as there will be at most 1000 messages in the bulk index request.", "author": "davidkyle", "createdAt": "2020-10-05T12:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMjI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU3MjA5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r499572096", "bodyText": "@davidkyle sorry! I didn't see that :D", "author": "benwtrent", "createdAt": "2020-10-05T12:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMjI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzA1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498913057", "bodyText": "Is it possible that we empty the backlog, but then have to add something else to it?\nI know this only happens on template changes, but it seems like setting it to null here is unnecessary and risks an NPE.", "author": "benwtrent", "createdAt": "2020-10-02T16:04:40Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -83,4 +168,21 @@ private XContentBuilder toXContentBuilder(ToXContent toXContent) {\n             throw new RuntimeException(e);\n         }\n     }\n+\n+    private void writeBacklog() {\n+        BulkRequest bulkRequest = new BulkRequest();\n+        ToXContent doc = backlog.poll();\n+        while (doc != null) {\n+            bulkRequest.add(indexRequest(doc));\n+            doc = backlog.poll();\n+        }\n+\n+        client.bulk(bulkRequest, ActionListener.wrap(\n+            bulkItemResponses -> {\n+                backlog = null;\n+                logger.trace(\"Successfully wrote audit message backlog after upgrading template\");", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498913451", "bodyText": "Also, it would be good to log if there were failures. we could just write a warning, and then have the full failure stack be debug or something.", "author": "benwtrent", "createdAt": "2020-10-02T16:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzA1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1MjU0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498952546", "bodyText": "I wanted to hit the NPE in tests and fail in a obvious way. If the logic is sound it should never fail.\nBut yes it should be some sort of assertion so there is no chance of it in production code", "author": "davidkyle", "createdAt": "2020-10-02T17:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxMzA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDYwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498914609", "bodyText": "This synchronized block seems unnecessary.", "author": "benwtrent", "createdAt": "2020-10-02T16:07:44Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -64,16 +100,65 @@ private void onIndexFailure(Exception exception) {\n     }\n \n     private void indexDoc(ToXContent toXContent) {\n+        if (hasLatestTemplate.get()) {\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        if (MlIndexAndAlias.hasIndexTemplate(clusterService.state(), templateName)) {\n+            synchronized (this) {", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1NDMxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498954319", "bodyText": "It is because of the code at line 131\n        synchronized (this) {\n            if (hasLatestTemplate.get() == false) {\n                // synchronized so that hasLatestTemplate does not change value\n                // between the read and adding to the backlog\n                backlog.add(toXContent);\n\nI need to make reading hasLatestTemplate and adding to backlog an atomic operation otherwise hasLatestTemplate could change value between the 2 lines of code.\nNothing can be added to backlog once hasLatestTemplate is true otherwise it may not be written in writeBacklog", "author": "davidkyle", "createdAt": "2020-10-02T17:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498914686", "bodyText": "This synchronized block seems unnecessary.", "author": "benwtrent", "createdAt": "2020-10-02T16:07:53Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -64,16 +100,65 @@ private void onIndexFailure(Exception exception) {\n     }\n \n     private void indexDoc(ToXContent toXContent) {\n+        if (hasLatestTemplate.get()) {\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        if (MlIndexAndAlias.hasIndexTemplate(clusterService.state(), templateName)) {\n+            synchronized (this) {\n+                hasLatestTemplate.set(true);\n+            }\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        ActionListener<Boolean> putTemplateListener = ActionListener.wrap(\n+            r -> {\n+                synchronized (this) {", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTg0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498915841", "bodyText": "This synchronize block makes sense as we don't want multiple callers to put the new template.\nBut, I don't think the if (hasLatestTemplate.get() == false) { warrants the sync blocks for the atomic booleans elsewhere.\nThe read and writes to this value are already protected and none of the other checks do anything mutable to the system.", "author": "benwtrent", "createdAt": "2020-10-02T16:10:00Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -64,16 +100,65 @@ private void onIndexFailure(Exception exception) {\n     }\n \n     private void indexDoc(ToXContent toXContent) {\n+        if (hasLatestTemplate.get()) {\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        if (MlIndexAndAlias.hasIndexTemplate(clusterService.state(), templateName)) {\n+            synchronized (this) {\n+                hasLatestTemplate.set(true);\n+            }\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        ActionListener<Boolean> putTemplateListener = ActionListener.wrap(\n+            r -> {\n+                synchronized (this) {\n+                    hasLatestTemplate.set(true);\n+                }\n+                logger.info(\"Auditor template [{}] successfully installed\", templateName);\n+                writeBacklog();\n+                putTemplateInProgress.set(false);\n+            },\n+            e -> {\n+                logger.warn(\"Error putting latest template [{}]\", templateName);\n+                putTemplateInProgress.set(false);\n+            }\n+        );\n+\n+        synchronized (this) {\n+            if (hasLatestTemplate.get() == false) {", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxODE5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63063#discussion_r498918199", "bodyText": "Seems like it could be a single exchange request.", "author": "benwtrent", "createdAt": "2020-10-02T16:14:43Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -64,16 +100,65 @@ private void onIndexFailure(Exception exception) {\n     }\n \n     private void indexDoc(ToXContent toXContent) {\n+        if (hasLatestTemplate.get()) {\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        if (MlIndexAndAlias.hasIndexTemplate(clusterService.state(), templateName)) {\n+            synchronized (this) {\n+                hasLatestTemplate.set(true);\n+            }\n+            writeDoc(toXContent);\n+            return;\n+        }\n+\n+        ActionListener<Boolean> putTemplateListener = ActionListener.wrap(\n+            r -> {\n+                synchronized (this) {\n+                    hasLatestTemplate.set(true);\n+                }\n+                logger.info(\"Auditor template [{}] successfully installed\", templateName);\n+                writeBacklog();\n+                putTemplateInProgress.set(false);\n+            },\n+            e -> {\n+                logger.warn(\"Error putting latest template [{}]\", templateName);\n+                putTemplateInProgress.set(false);\n+            }\n+        );\n+\n+        synchronized (this) {\n+            if (hasLatestTemplate.get() == false) {\n+                // synchronized so that hasLatestTemplate does not change value\n+                // between the read and adding to the backlog\n+                backlog.add(toXContent);\n+\n+                // stop multiple invocations\n+                if (putTemplateInProgress.get() == false) {\n+                    putTemplateInProgress.set(true);", "originalCommit": "243c49a640c81213a76db094725b4f878227d386", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7b4093b5c3b6e8e68cbab68385d9785b591ad13", "url": "https://github.com/elastic/elasticsearch/commit/f7b4093b5c3b6e8e68cbab68385d9785b591ad13", "message": "Use originsettingclient", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "8b5a6b8e11f25c3edd8427a2029aaab90a308664", "url": "https://github.com/elastic/elasticsearch/commit/8b5a6b8e11f25c3edd8427a2029aaab90a308664", "message": "Add backlog", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "f72c7ce221c0c2bc7f8e0f0cb047905de383d7d2", "url": "https://github.com/elastic/elasticsearch/commit/f72c7ce221c0c2bc7f8e0f0cb047905de383d7d2", "message": "just need the template now", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "0440cb1e576a18b2e4f9fa6a047279a67d70ff20", "url": "https://github.com/elastic/elasticsearch/commit/0440cb1e576a18b2e4f9fa6a047279a67d70ff20", "message": "Use IndexTemplateConfig in auditors", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "b1bb0e6fb21b6181243a64c74aea15c3ced49999", "url": "https://github.com/elastic/elasticsearch/commit/b1bb0e6fb21b6181243a64c74aea15c3ced49999", "message": "Fix test compilation", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "4a969b1e85dc18622c92433545ce19310506b7d2", "url": "https://github.com/elastic/elasticsearch/commit/4a969b1e85dc18622c92433545ce19310506b7d2", "message": "auditor test", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "896e5ca10dab6e74af84b88f0aea1be3638dbbf3", "url": "https://github.com/elastic/elasticsearch/commit/896e5ca10dab6e74af84b88f0aea1be3638dbbf3", "message": "More hacking for tests", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "d25edd2e87488184661cc9bd0b3428447cf10495", "url": "https://github.com/elastic/elasticsearch/commit/d25edd2e87488184661cc9bd0b3428447cf10495", "message": "cluster change?", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "efd8407192dd6ccd056484b0c9e3ef50b75d8cfd", "url": "https://github.com/elastic/elasticsearch/commit/efd8407192dd6ccd056484b0c9e3ef50b75d8cfd", "message": "Revert \"cluster change?\"\n\nThis reverts commit 6a121da64baf897d228fdc9cc83325bb92f893fe.", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "0944d860a769d917677bb03db08e40efc09b33cb", "url": "https://github.com/elastic/elasticsearch/commit/0944d860a769d917677bb03db08e40efc09b33cb", "message": "tidy up", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "8cb88490e9d639fe1be9f0f6b8bc1243d7a29958", "url": "https://github.com/elastic/elasticsearch/commit/8cb88490e9d639fe1be9f0f6b8bc1243d7a29958", "message": "Use Put Template supplier", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "f697ec4995096180f77ee08ad5f9ebc6c67d1a4c", "url": "https://github.com/elastic/elasticsearch/commit/f697ec4995096180f77ee08ad5f9ebc6c67d1a4c", "message": "code style", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "c3d6e73933adbca57d302ce7a538a5e42645c7dd", "url": "https://github.com/elastic/elasticsearch/commit/c3d6e73933adbca57d302ce7a538a5e42645c7dd", "message": "Review comments", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "00b89abd0d4f1dbca0668092d1641ed7766b5342", "url": "https://github.com/elastic/elasticsearch/commit/00b89abd0d4f1dbca0668092d1641ed7766b5342", "message": "Actually use the null backlog object to detect errors in test", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "d74aa5000ba2b7738e37d770cd884dab2a7596be", "url": "https://github.com/elastic/elasticsearch/commit/d74aa5000ba2b7738e37d770cd884dab2a7596be", "message": "drop oldest entries if queue it too large", "committedDate": "2020-10-05T10:18:46Z", "type": "commit"}, {"oid": "d74aa5000ba2b7738e37d770cd884dab2a7596be", "url": "https://github.com/elastic/elasticsearch/commit/d74aa5000ba2b7738e37d770cd884dab2a7596be", "message": "drop oldest entries if queue it too large", "committedDate": "2020-10-05T10:18:46Z", "type": "forcePushed"}]}