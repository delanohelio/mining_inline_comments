{"pr_number": 63465, "pr_title": "Convert WildcardFieldMapper to parametrized form", "pr_createdAt": "2020-10-08T10:58:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63465", "timeline": [{"oid": "f1b65b016e0ae9bbffde45f750aefcf934722b37", "url": "https://github.com/elastic/elasticsearch/commit/f1b65b016e0ae9bbffde45f750aefcf934722b37", "message": "Convert WildcardFieldMapper to parametrized form", "committedDate": "2020-10-08T10:57:15Z", "type": "commit"}, {"oid": "8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "url": "https://github.com/elastic/elasticsearch/commit/8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "message": "Merge branch 'master' into mapper/wildcard", "committedDate": "2020-10-13T10:02:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMTYzNA==", "url": "https://github.com/elastic/elasticsearch/pull/63465#discussion_r503901634", "bodyText": "Was this unused?", "author": "cbuescher", "createdAt": "2020-10-13T12:16:16Z", "path": "x-pack/plugin/wildcard/src/main/java/org/elasticsearch/xpack/wildcard/mapper/WildcardFieldMapper.java", "diffHunk": "@@ -690,12 +634,6 @@ static boolean isMatchAll(Query q) {\n             return q instanceof MatchAllDocsQuery || q instanceof MatchAllButRequireVerificationQuery;\n         }\n \n-        protected String firstNgramToken(String fragment, Analyzer analyzer) {", "originalCommit": "8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxMjcwMw==", "url": "https://github.com/elastic/elasticsearch/pull/63465#discussion_r503912703", "bodyText": "Yes, IntelliJ flagged it up as never called", "author": "romseygeek", "createdAt": "2020-10-13T12:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMTYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMTY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63465#discussion_r503901697", "bodyText": "Just curious because haven't reviews that many of these moves to ParametrizedFieldMapper yet: These errors woll now happen automatically if no Parameter is defined?", "author": "cbuescher", "createdAt": "2020-10-13T12:16:22Z", "path": "x-pack/plugin/wildcard/src/main/java/org/elasticsearch/xpack/wildcard/mapper/WildcardFieldMapper.java", "diffHunk": "@@ -185,115 +172,73 @@ private static int normalize(int codepoint) {\n \n     public static class Defaults {\n         public static final FieldType FIELD_TYPE = new FieldType();\n-\n         static {\n             FIELD_TYPE.setTokenized(false);\n             FIELD_TYPE.setIndexOptions(IndexOptions.DOCS);\n             FIELD_TYPE.setStoreTermVectorOffsets(false);\n             FIELD_TYPE.setOmitNorms(true);\n             FIELD_TYPE.freeze();\n         }\n+        public static final TextSearchInfo TEXT_SEARCH_INFO\n+            = new TextSearchInfo(FIELD_TYPE, null, Lucene.KEYWORD_ANALYZER, Lucene.KEYWORD_ANALYZER);\n         public static final int IGNORE_ABOVE = Integer.MAX_VALUE;\n-        public static final String NULL_VALUE = null;\n     }\n \n-    public static class Builder extends FieldMapper.Builder<Builder> {\n-        protected int ignoreAbove = Defaults.IGNORE_ABOVE;\n-        protected String nullValue = Defaults.NULL_VALUE;\n+    private static WildcardFieldMapper toType(FieldMapper in) {\n+        return (WildcardFieldMapper) in;\n+    }\n \n-        public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE);\n-            builder = this;\n-        }\n+    public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        @Override\n-        public Builder docValues(boolean docValues) {\n-            if (docValues == false) {\n-                throw new MapperParsingException(\"The field [\" + name + \"] cannot have doc values = false\");\n-            }\n-            return this;\n-        }\n+        final Parameter<Integer> ignoreAbove\n+            = Parameter.intParam(\"ignore_above\", true, m -> toType(m).ignoreAbove, Defaults.IGNORE_ABOVE)\n+            .setValidator(v -> {\n+                if (v < 0) {\n+                    throw new IllegalArgumentException(\"[ignore_above] must be positive, got [\" + v + \"]\");\n+                }\n+            });\n+        final Parameter<String> nullValue\n+            = Parameter.stringParam(\"null_value\", false, m -> toType(m).nullValue, null).acceptsNull();\n \n-        @Override\n-        public Builder indexOptions(IndexOptions indexOptions) {\n-            if (indexOptions != IndexOptions.DOCS) {\n-                throw new MapperParsingException(\"The field [\" + name + \"] cannot have indexOptions = \" + indexOptions);\n-            }\n-            return this;\n-        }", "originalCommit": "8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxMzM4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63465#discussion_r503913387", "bodyText": "Yes, for previously 'global' parameters that don't really make sense on a mapper, you'll get a deprecation warning in 7x and an error in master.", "author": "romseygeek", "createdAt": "2020-10-13T12:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwMTY5Nw=="}], "type": "inlineReview"}, {"oid": "7c2190defd42a57fd2385f6cc5a85ff5f3138506", "url": "https://github.com/elastic/elasticsearch/commit/7c2190defd42a57fd2385f6cc5a85ff5f3138506", "message": "Merge remote-tracking branch 'origin/master' into mapper/wildcard", "committedDate": "2020-10-13T12:46:00Z", "type": "commit"}, {"oid": "ec7517c10d0ed3babef383df130d3dd9293b475a", "url": "https://github.com/elastic/elasticsearch/commit/ec7517c10d0ed3babef383df130d3dd9293b475a", "message": "Merge remote-tracking branch 'romseygeek/mapper/wildcard' into mapper/wildcard", "committedDate": "2020-10-13T12:46:16Z", "type": "commit"}]}