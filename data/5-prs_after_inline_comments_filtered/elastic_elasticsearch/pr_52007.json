{"pr_number": 52007, "pr_title": "Make sorting by an agg results a real abstraction", "pr_createdAt": "2020-02-06T16:59:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52007", "timeline": [{"oid": "c4b4dd8f156cc430f56a987d233b259f8a2947c9", "url": "https://github.com/elastic/elasticsearch/commit/c4b4dd8f156cc430f56a987d233b259f8a2947c9", "message": "Make sorting by an agg results a real abstraction\n\nThis removes a bunch of `instanceof`s in favor of two new methods on\n`InernalAggregation`. The default implementations of these methods just\nthrow exceptions explaining that you can't sort on this aggregation.\nThey are overridden by all of the classes that used to have `instanceof`\nchecks against them.\n\nI doubt this is really any faster in practice. The real benefit here is\nthat it is a little more obvious *that* you can sort by the results of\nan aggregation and it should be *much* more obvious where to look at\n*how* aggregations sort themselves.\n\nThere are still a bunch more `instanceof`s in left in `AggregationPath`\nbut those will wait for a followup change.", "committedDate": "2020-02-06T16:49:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2MjA5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52007#discussion_r375962092", "bodyText": "This feels a little sneaky, but nowhere near as sneaky as the old instanceofs. And this stuff seems to only be used internally so I think we're safe here.", "author": "nik9000", "createdAt": "2020-02-06T17:02:05Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalOrder.java", "diffHunk": "@@ -153,8 +153,8 @@ public AggregationPath path() {\n \n             @Override\n             public int compare(Bucket b1, Bucket b2) {\n-                double v1 = path.resolveValue(b1);\n-                double v2 = path.resolveValue(b2);\n+                double v1 = path.resolveValue(((InternalAggregations) b1.getAggregations()));\n+                double v2 = path.resolveValue(((InternalAggregations) b2.getAggregations()));", "originalCommit": "c4b4dd8f156cc430f56a987d233b259f8a2947c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}