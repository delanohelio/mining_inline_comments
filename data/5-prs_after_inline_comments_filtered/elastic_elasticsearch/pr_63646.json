{"pr_number": 63646, "pr_title": "Remove Redundant Cluster State Update Response Classes", "pr_createdAt": "2020-10-14T05:06:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63646", "timeline": [{"oid": "89e621ab2b97274581322ab0be6c4a81560800a7", "url": "https://github.com/elastic/elasticsearch/commit/89e621ab2b97274581322ab0be6c4a81560800a7", "message": "Remove Redundant Cluster State Update Response Classes\n\nThese intermediary response types don't contain any information\noutside of what the shard acknowledged and acknowledged responses\ncontain so this PR removes them.\nAlso, it adds three constants for the three possible states of\n`ShardsAcknowledgedResponse`.\n\nFollow up to #63335", "committedDate": "2020-10-14T05:01:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYyMTE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r506621148", "bodyText": "Please let's not use the term \"simple\". Why isn't this just part of AckedClusterStateUpdateTask?", "author": "rjernst", "createdAt": "2020-10-16T17:30:40Z", "path": "server/src/main/java/org/elasticsearch/cluster/SimpleAckedStateUpdateTask.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.cluster;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.cluster.ack.AckedRequest;\n+import org.elasticsearch.common.Priority;\n+\n+/**\n+ * {@link AckedClusterStateUpdateTask} that responds with a plain {@link AcknowledgedResponse}.\n+ */\n+public abstract class SimpleAckedStateUpdateTask extends AckedClusterStateUpdateTask<AcknowledgedResponse> {", "originalCommit": "89e621ab2b97274581322ab0be6c4a81560800a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY5MTg2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r506691867", "bodyText": "Why isn't this just part of AckedClusterStateUpdateTask?\n\n\ud83e\udd26 yea that's much better :) I pushed 996b582 , thanks!", "author": "original-brownbear", "createdAt": "2020-10-16T19:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYyMTE0OA=="}], "type": "inlineReview"}, {"oid": "6c208148018eb671b4f1ddc79b5daf5dd0579feb", "url": "https://github.com/elastic/elasticsearch/commit/6c208148018eb671b4f1ddc79b5daf5dd0579feb", "message": "Merge remote-tracking branch 'elastic/master' into singleton-ack-cs-resp", "committedDate": "2020-10-16T19:18:48Z", "type": "commit"}, {"oid": "996b5825e685f4faa471a8cb4018f37cd433cd77", "url": "https://github.com/elastic/elasticsearch/commit/996b5825e685f4faa471a8cb4018f37cd433cd77", "message": "CR: simpler", "committedDate": "2020-10-16T19:49:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r510408093", "bodyText": "I don't think this cast should be necessary. If we are saying all response classes for AckedClusterStateUpdateTask should be an AcknowledgedResponse, then why is it a generic? Should the generic be extending AcknowledgedResponse?", "author": "rjernst", "createdAt": "2020-10-22T19:34:38Z", "path": "server/src/main/java/org/elasticsearch/cluster/AckedClusterStateUpdateTask.java", "diffHunk": "@@ -64,8 +65,10 @@ public void onAllNodesAcked(@Nullable Exception e) {\n         listener.onResponse(newResponse(e == null));\n     }\n \n-    protected abstract Response newResponse(boolean acknowledged);\n-\n+    @SuppressWarnings(\"unchecked\")\n+    protected Response newResponse(boolean acknowledged) {\n+        return (Response) AcknowledgedResponse.of(acknowledged);", "originalCommit": "996b5825e685f4faa471a8cb4018f37cd433cd77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3ODMwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r510978301", "bodyText": "I tried this but annoyingly org.elasticsearch.xpack.ilm.action.TransportRemoveIndexLifecyclePolicyAction uses a Response class that doesn't extend AcknowledgedResponse which prevents us from doing this.\nAt least I couldn't find a quick+dry way around the problem for now other than what I had before with subclassing AckedClusterStateUpdateTask but even that was a lot of extra code, the current version seems simplest to me because changing the response in the ILM action isn't so trivial BwC wise?", "author": "original-brownbear", "createdAt": "2020-10-23T15:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgwNjI1NA==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r513806254", "bodyText": "Is that ILM class actually utilizing the \"acked\" part of AckedClusterStateUpdateTask then? It seems odd based on naming alone that there is nothing asked about the response?", "author": "rjernst", "createdAt": "2020-10-28T22:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0NzU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r514147583", "bodyText": "Actually it isn't using any of the acked mechanics so I turned it into a normal update in 926442c and then constrained the type of the response some to actually by an acknowledged response.\nStill need the cast though unfortunately, we can only get around that by sub-classing for plain AcknowledgedResponse I think (this is because the listener might have a more constrained type than AcknowledgedResponse so without the cast the generic type constraints aren't met).", "author": "original-brownbear", "createdAt": "2020-10-29T10:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2MjIyOA==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r516162228", "bodyText": "I only see two classes that concretely implement AckedClusterStateUpdateTask. Yet they seem to override everything. What benefit does the generic type give us? It seems the abstract class could concretely use AcknowledgedResponse, and those two subclasses can override and refine the response type of newResponse.", "author": "rjernst", "createdAt": "2020-11-02T18:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg3Mjk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r516872963", "bodyText": "Fair point, the generic is pointless. I removed it in 8ca8862 . Still requires one annoying case in the constructor, but much nicer IMO.\nWe do have a few more than 2 overrides to the response type though in the anonymous implementations. Some of those look completely redundant (e.g. org.elasticsearch.xpack.core.ilm.action.DeleteLifecycleAction.Response though and could be removed in a follow-up).\nLet me know what you think :)", "author": "original-brownbear", "createdAt": "2020-11-03T18:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwODA5Mw=="}], "type": "inlineReview"}, {"oid": "73740c2152d07afc3835377daa7b89d7983e5d0c", "url": "https://github.com/elastic/elasticsearch/commit/73740c2152d07afc3835377daa7b89d7983e5d0c", "message": "Merge remote-tracking branch 'elastic/master' into singleton-ack-cs-resp", "committedDate": "2020-10-23T15:44:10Z", "type": "commit"}, {"oid": "ea76fae421f7f65310cf29c449b7a5918e87247c", "url": "https://github.com/elastic/elasticsearch/commit/ea76fae421f7f65310cf29c449b7a5918e87247c", "message": "Merge remote-tracking branch 'elastic/master' into singleton-ack-cs-resp", "committedDate": "2020-10-29T07:49:43Z", "type": "commit"}, {"oid": "926442ce81b97820b57fbe5712e645a3ab64275e", "url": "https://github.com/elastic/elasticsearch/commit/926442ce81b97820b57fbe5712e645a3ab64275e", "message": "constrain type more", "committedDate": "2020-10-29T08:44:17Z", "type": "commit"}, {"oid": "eb2210c364301257be4fb7ce627546c704dcb151", "url": "https://github.com/elastic/elasticsearch/commit/eb2210c364301257be4fb7ce627546c704dcb151", "message": "Merge remote-tracking branch 'elastic/master' into singleton-ack-cs-resp", "committedDate": "2020-11-03T15:22:28Z", "type": "commit"}, {"oid": "8ca8862564b95e2facc354970913bec2e4e75027", "url": "https://github.com/elastic/elasticsearch/commit/8ca8862564b95e2facc354970913bec2e4e75027", "message": "drop generic", "committedDate": "2020-11-03T16:58:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNzM5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r516907396", "bodyText": "We could use ? extends here as well so a cast is not necessary?", "author": "rjernst", "createdAt": "2020-11-03T19:31:47Z", "path": "server/src/main/java/org/elasticsearch/cluster/AckedClusterStateUpdateTask.java", "diffHunk": "@@ -29,18 +30,20 @@\n  * An extension interface to {@link ClusterStateUpdateTask} that allows to be notified when\n  * all the nodes have acknowledged a cluster state update request\n  */\n-public abstract class AckedClusterStateUpdateTask<Response> extends ClusterStateUpdateTask implements AckedClusterStateTaskListener {\n+public abstract class AckedClusterStateUpdateTask extends ClusterStateUpdateTask implements AckedClusterStateTaskListener {\n \n-    private final ActionListener<Response> listener;\n+    private final ActionListener<AcknowledgedResponse> listener;", "originalCommit": "8ca8862564b95e2facc354970913bec2e4e75027", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NjI1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63646#discussion_r516946259", "bodyText": "That won't work unfortunately. If we bound by ? extends then it could be that the listener is actually a listener for some subclass of AcknowledgedResponse so that gives a compile time error ... it always seems like this should work though :)", "author": "original-brownbear", "createdAt": "2020-11-03T20:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwNzM5Ng=="}], "type": "inlineReview"}]}