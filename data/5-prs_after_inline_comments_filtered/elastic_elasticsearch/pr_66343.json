{"pr_number": 66343, "pr_title": "[ML] Add log_time to AD data_counts and decide current based on it", "pr_createdAt": "2020-12-15T13:56:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66343", "timeline": [{"oid": "812cb60d94b34389b424ec71fc88419a292d93ac", "url": "https://github.com/elastic/elasticsearch/commit/812cb60d94b34389b424ec71fc88419a292d93ac", "message": "[ML] Add log_time to AD data_counts and decide current based on it\n\nThis commit is fixing a potential bug if we support anomaly detection\nresults index rollover in the future.\n\nIn particular, we determine the current `data_counts` by sorting on the\nlatest record time. However, this is not correct if the job reverts\nto an older model snapshot. To fix this we add `log_time` to `data_counts`\n(similarly to `model_size_stats`) and sort on `log_time` to figure\nout the current counts for the job.", "committedDate": "2020-12-15T13:51:27Z", "type": "commit"}, {"oid": "152cabe50ad2b083056c2570b3773ae61811ffdd", "url": "https://github.com/elastic/elasticsearch/commit/152cabe50ad2b083056c2570b3773ae61811ffdd", "message": "Fix job stats monitoring test", "committedDate": "2020-12-15T14:10:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQyOTQ0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543429441", "bodyText": "unsure the rounding to epoch ms this is really needed. The only time that users will be using this object with actual data is when it is deserialized from the server.", "author": "benwtrent", "createdAt": "2020-12-15T15:10:57Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/process/DataCounts.java", "diffHunk": "@@ -138,31 +145,13 @@ public DataCounts(String jobId, long processedRecordCount, long processedFieldCo\n         this.lastDataTimeStamp = lastDataTimeStamp;\n         this.latestEmptyBucketTimeStamp = latestEmptyBucketTimeStamp;\n         this.latestSparseBucketTimeStamp = latestSparseBucketTimeStamp;\n+        this.logTime = logTime == null ? null : Instant.ofEpochMilli(logTime.toEpochMilli());", "originalCommit": "152cabe50ad2b083056c2570b3773ae61811ffdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzNTgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543435834", "bodyText": "We need it for tests. We use Instant.now() in tests and that includes nanos. We do that everywhere we use Instant.", "author": "dimitris-athanasiou", "createdAt": "2020-12-15T15:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQyOTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzMjgwMw==", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543432803", "bodyText": "Do we have to worry about unmapped type errors?", "author": "benwtrent", "createdAt": "2020-12-15T15:14:52Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -445,6 +445,10 @@ private SearchRequestBuilder createLatestDataCountsSearch(String indexName, Stri\n                 .setIndicesOptions(IndicesOptions.lenientExpandOpen())\n                 // look for both old and new formats\n                 .setQuery(QueryBuilders.idsQuery().addIds(DataCounts.documentId(jobId), DataCounts.v54DocumentId(jobId)))\n+                // We want to sort on log_time. However, this was added a long time later and before that we used to\n+                // sort on latest_record_time. Thus we handle older data counts where no log_time exists and we fall back\n+                // to the prior behaviour.\n+                .addSort(SortBuilders.fieldSort(DataCounts.LOG_TIME.getPreferredName()).order(SortOrder.DESC).missing(0L))", "originalCommit": "152cabe50ad2b083056c2570b3773ae61811ffdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ0MTkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543441905", "bodyText": "Definitely. I tricked myself thinking missing was doing the job unmapped needs to do. Will fix that, thanks for spotting it!", "author": "dimitris-athanasiou", "createdAt": "2020-12-15T15:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzMjgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ0MjY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543442658", "bodyText": "Funny thing, I tested this. I created manually an index .ml-anomalies-fake. It all worked. But I didn't think that that index would pick our mappings due to the template being the new one.", "author": "dimitris-athanasiou", "createdAt": "2020-12-15T15:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzMjgwMw=="}], "type": "inlineReview"}, {"oid": "f50275b338da264e6471a73768d961073790fc31", "url": "https://github.com/elastic/elasticsearch/commit/f50275b338da264e6471a73768d961073790fc31", "message": "Handle unmapped when sorting on log_time", "committedDate": "2020-12-15T15:29:14Z", "type": "commit"}, {"oid": "f96e29cd2207d316f2562f2dff01752964eeafc7", "url": "https://github.com/elastic/elasticsearch/commit/f96e29cd2207d316f2562f2dff01752964eeafc7", "message": "Merge branch 'master' into current-data-counts-should-be-sorting-on-log-time", "committedDate": "2020-12-15T15:57:25Z", "type": "commit"}]}