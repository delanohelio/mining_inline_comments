{"pr_number": 54349, "pr_title": "Preserve final response headers in asynchronous search", "pr_createdAt": "2020-03-27T15:22:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54349", "timeline": [{"oid": "e9f700c2d10543138ee7df2099158fcb0eb7f6ad", "url": "https://github.com/elastic/elasticsearch/commit/e9f700c2d10543138ee7df2099158fcb0eb7f6ad", "message": "Preserve final response headers in asynchronous search\n\nThis change adds the response headers of the original search request\nin the stored response in order to be able to restore them when retrieving a result\nfrom the async-search index. It also ensures that response headers are preserved for\nusers that retrieve a final response on a running search task.\nPartial response can eventually return response headers too but this change only ensures\nthat they are present when the response if final.\n\nRelates #33936", "committedDate": "2020-03-27T15:20:02Z", "type": "commit"}, {"oid": "f83e972696bd2b288adaead47eae65abf9bd10a5", "url": "https://github.com/elastic/elasticsearch/commit/f83e972696bd2b288adaead47eae65abf9bd10a5", "message": "checkstyle", "committedDate": "2020-03-27T15:45:13Z", "type": "commit"}, {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331", "url": "https://github.com/elastic/elasticsearch/commit/dd538b5faf722c706f306756c29eb930e4a8d331", "message": "fix rest api include", "committedDate": "2020-03-27T16:37:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNDYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r402814621", "bodyText": "instead of having these two atomic references, would it make sense to have the headers become part of MutableSearchResponse? I always worry about the complexity added by two independent multi-threaded data structures.", "author": "javanna", "createdAt": "2020-04-03T08:10:19Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -61,7 +63,8 @@\n     private volatile long expirationTimeMillis;\n     private final AtomicBoolean isCancelling = new AtomicBoolean(false);\n \n-    private AtomicReference<MutableSearchResponse> searchResponse;\n+    private final AtomicReference<MutableSearchResponse> searchResponse = new AtomicReference<>();\n+    private final AtomicReference<Map<String, List<String>>> responseHeaders = new AtomicReference<>();", "originalCommit": "dd538b5faf722c706f306756c29eb930e4a8d331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAyODU1NA==", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r404028554", "bodyText": "++, I pushed f6e8ab0", "author": "jimczi", "createdAt": "2020-04-06T11:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNDYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNTgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r402815806", "bodyText": "I am not a fan of boolean flags, this method looks simple enough that we could split in two: getResponse and getResponseWithHeaders or something along those lines?", "author": "javanna", "createdAt": "2020-04-03T08:11:43Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -284,15 +286,24 @@ private void executeCompletionListeners() {\n             }\n             hasCompleted = true;\n         }\n-        AsyncSearchResponse finalResponse = getResponse();\n+        // we don't need to restore the response headers, they should be included in the current\n+        // context since we are called by the search action listener.\n+        AsyncSearchResponse finalResponse = getResponse(false);\n         for (Consumer<AsyncSearchResponse> listener : completionListeners.values()) {\n             listener.accept(finalResponse);\n         }\n         completionListeners.clear();\n     }\n \n-    private AsyncSearchResponse getResponse() {\n+    /**\n+     * Returns the current {@link AsyncSearchResponse} and restores the response headers\n+     * in the local thread context depending on the value of <code>restoreResponseHeaders</code>.\n+     */\n+    private AsyncSearchResponse getResponse(boolean restoreResponseHeaders) {", "originalCommit": "dd538b5faf722c706f306756c29eb930e4a8d331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAyODYwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r404028609", "bodyText": "++, I pushed f6e8ab0", "author": "jimczi", "createdAt": "2020-04-06T11:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNTgwNg=="}], "type": "inlineReview"}, {"oid": "60649c21be4bec1b25a8335cc42d03afbde8b4ce", "url": "https://github.com/elastic/elasticsearch/commit/60649c21be4bec1b25a8335cc42d03afbde8b4ce", "message": "Merge branch 'master' into async_response_headers", "committedDate": "2020-04-06T11:18:30Z", "type": "commit"}, {"oid": "f6e8ab01a0564e371793d79a7d3dd145732783d0", "url": "https://github.com/elastic/elasticsearch/commit/f6e8ab01a0564e371793d79a7d3dd145732783d0", "message": "address comments", "committedDate": "2020-04-06T11:45:18Z", "type": "commit"}, {"oid": "58b3edd0b86a24b60d6e3141b6880d49048e3e67", "url": "https://github.com/elastic/elasticsearch/commit/58b3edd0b86a24b60d6e3141b6880d49048e3e67", "message": "add missing comment", "committedDate": "2020-04-06T11:46:52Z", "type": "commit"}, {"oid": "9cc6ad172d737749596aa42144252f29b3ffc67b", "url": "https://github.com/elastic/elasticsearch/commit/9cc6ad172d737749596aa42144252f29b3ffc67b", "message": "split new rest test in 2", "committedDate": "2020-04-06T13:43:57Z", "type": "commit"}]}