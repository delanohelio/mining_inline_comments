{"pr_number": 56175, "pr_title": "upgrade to Lucene 8.6.0 snapshot", "pr_createdAt": "2020-05-05T08:01:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56175", "timeline": [{"oid": "70c5bde889030c1014eb503756b77ea6ce72f1e2", "url": "https://github.com/elastic/elasticsearch/commit/70c5bde889030c1014eb503756b77ea6ce72f1e2", "message": "upgrade to Lucene 8.6.0 snapshot", "committedDate": "2020-05-05T07:58:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODM4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r419938383", "bodyText": "We should try to read directly into the ByteBuffer instead of materializing a byte[]?", "author": "jpountz", "createdAt": "2020-05-05T08:18:07Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CachedBlobContainerIndexInput.java", "diffHunk": "@@ -319,9 +317,16 @@ private boolean assertRangeIsAlignedWithPart(Tuple<Long, Long> range) {\n         return true;\n     }\n \n-    private int readCacheFile(FileChannel fc, long end, long position, byte[] buffer, int offset, long length) throws IOException {\n+    private int readCacheFile(FileChannel fc, long end, long position, ByteBuffer b, long length) throws IOException {\n         assert assertFileChannelOpen(fc);\n-        int bytesRead = Channels.readFromFileChannel(fc, position, buffer, offset, Math.toIntExact(Math.min(length, end - position)));\n+        int bytesRead;\n+        if (end - position < b.remaining()) {\n+            int l = Math.toIntExact(end - position);\n+            b.put(Channels.readFromFileChannel(fc, position, l));", "originalCommit": "70c5bde889030c1014eb503756b77ea6ce72f1e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2NTAxNA==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r419965014", "bodyText": "If I recall correctly if the size of the data is lower that the remaining size of the byte buffer you get an EOF exception. We are only materialising to a byte[] in that case. Maybe there is a better way?", "author": "iverase", "createdAt": "2020-05-05T09:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzODM4Mw=="}], "type": "inlineReview"}, {"oid": "fdc7138ebe54bb35636e2ff220d14e17887633ab", "url": "https://github.com/elastic/elasticsearch/commit/fdc7138ebe54bb35636e2ff220d14e17887633ab", "message": "remove ON_HEAP_ID_TERMS_INDEX index setting", "committedDate": "2020-05-05T09:12:52Z", "type": "commit"}, {"oid": "3537f63e41ac54533cda46150978d1fe552dd3e8", "url": "https://github.com/elastic/elasticsearch/commit/3537f63e41ac54533cda46150978d1fe552dd3e8", "message": "remove assertions. I believe LUCENE-9276 has removed the need of different update docs paths.", "committedDate": "2020-05-05T09:45:25Z", "type": "commit"}, {"oid": "ef684d14d4e98b5e84a11934058cc2f46f9abb78", "url": "https://github.com/elastic/elasticsearch/commit/ef684d14d4e98b5e84a11934058cc2f46f9abb78", "message": "fix compile error", "committedDate": "2020-05-05T09:57:58Z", "type": "commit"}, {"oid": "8b49fbe0b4dbe06477bb01e8a539441a80aaede6", "url": "https://github.com/elastic/elasticsearch/commit/8b49fbe0b4dbe06477bb01e8a539441a80aaede6", "message": "fix checkStyle", "committedDate": "2020-05-05T10:18:46Z", "type": "commit"}, {"oid": "458f0acbfaf1b844a9a5e3dab2ccb291cde9b41d", "url": "https://github.com/elastic/elasticsearch/commit/458f0acbfaf1b844a9a5e3dab2ccb291cde9b41d", "message": "remove corruption workaround", "committedDate": "2020-05-05T11:07:40Z", "type": "commit"}, {"oid": "5d99a6411fc44574e52968c739240caeb3da0deb", "url": "https://github.com/elastic/elasticsearch/commit/5d99a6411fc44574e52968c739240caeb3da0deb", "message": "remove corruption workaround", "committedDate": "2020-05-05T11:09:36Z", "type": "commit"}, {"oid": "05dc43abffdd1368896377ed5b29f37f92fdbbc8", "url": "https://github.com/elastic/elasticsearch/commit/05dc43abffdd1368896377ed5b29f37f92fdbbc8", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-05T11:09:42Z", "type": "commit"}, {"oid": "b6ac6e23be4df51e5719ce8eb1961596cb6e3296", "url": "https://github.com/elastic/elasticsearch/commit/b6ac6e23be4df51e5719ce8eb1961596cb6e3296", "message": "override consumeTermsMatching in QueryAnalyzer#ResultBuilder", "committedDate": "2020-05-05T12:58:35Z", "type": "commit"}, {"oid": "20ec5f7087604f51ebfe9148db5f421c7d526ce6", "url": "https://github.com/elastic/elasticsearch/commit/20ec5f7087604f51ebfe9148db5f421c7d526ce6", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-05T13:56:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEzODgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420138826", "bodyText": "After removing this, the test times out. I have not found a way to do this in Lucene 8.6 as this is now private in the Index writer. @original-brownbear you were the last one to modify this class, you might have an idea what we can do here?", "author": "iverase", "createdAt": "2020-05-05T14:09:31Z", "path": "qa/evil-tests/src/test/java/org/elasticsearch/index/engine/EvilInternalEngineTests.java", "diffHunk": "@@ -64,21 +64,6 @@ public void testOutOfMemoryErrorWhileMergingIsRethrownAndIsUncaught() throws IOE\n                         public void merge(final MergePolicy.OneMerge merge) throws IOException {\n                             throw new OutOfMemoryError(\"640K ought to be enough for anybody\");\n                         }\n-\n-                        @Override\n-                        public synchronized MergePolicy.OneMerge getNextMerge() {\n-                            /*\n-                             * This will be called when we flush when we will not be ready to return the segments. After the segments are on\n-                             * disk, we can only return them from here once or the merge scheduler will be stuck in a loop repeatedly\n-                             * peeling off the same segments to schedule for merging.\n-                             */\n-                            if (segmentsReference.get() == null) {\n-                                return super.getNextMerge();\n-                            } else {\n-                                final List<SegmentCommitInfo> segments = segmentsReference.getAndSet(null);\n-                                return new MergePolicy.OneMerge(segments);\n-                            }", "originalCommit": "20ec5f7087604f51ebfe9148db5f421c7d526ce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4ODcyNw==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420188727", "bodyText": "The problem is that we need to somehow set a merge policy here that will actually trigger a background merge (the random policy used in this test triggers nothing which is kind of obvious when we only have a single document in the engine).\n=> As far as I understand it we need to craft a merge policy that will actually cause a background merge", "author": "original-brownbear", "createdAt": "2020-05-05T15:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEzODgyNg=="}], "type": "inlineReview"}, {"oid": "b7fcfa1de5e4c1e224e4fcdbe2cdbe4b951a7471", "url": "https://github.com/elastic/elasticsearch/commit/b7fcfa1de5e4c1e224e4fcdbe2cdbe4b951a7471", "message": "read directly into the ByteBuffer instead of materializing a byte[]", "committedDate": "2020-05-05T15:34:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE2MTM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420161378", "bodyText": "nit: no need to break the line", "author": "tlrx", "createdAt": "2020-05-05T14:39:11Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshot.java", "diffHunk": "@@ -219,7 +218,8 @@ private SegmentCommitInfo syncSegment(SegmentCommitInfo segmentCommitInfo, LiveD\n                 SegmentInfo newSegmentInfo = new SegmentInfo(targetDirectory, si.getVersion(), si.getMinVersion(), si.name, si.maxDoc(),\n                     false, si.getCodec(), si.getDiagnostics(), si.getId(), si.getAttributes(), null);\n                 // we drop the sort on purpose since the field we sorted on doesn't exist in the target index anymore.\n-                newInfo = new SegmentCommitInfo(newSegmentInfo, 0, 0, -1, -1, -1);\n+                newInfo = new SegmentCommitInfo(newSegmentInfo, 0, 0, -1,", "originalCommit": "20ec5f7087604f51ebfe9148db5f421c7d526ce6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3NDkzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420174935", "bodyText": "This should be final", "author": "tlrx", "createdAt": "2020-05-05T14:56:16Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CachedBlobContainerIndexInput.java", "diffHunk": "@@ -128,16 +128,14 @@ private CacheFile getCacheFileSafe() throws Exception {\n     }\n \n     @Override\n-    protected void readInternal(final byte[] buffer, final int offset, final int length) throws IOException {\n+    protected void readInternal(ByteBuffer b) throws IOException {\n         ensureContext(ctx -> ctx != CACHE_WARMING_CONTEXT);\n         final long position = getFilePointer() + this.offset;\n-\n+        int length = b.remaining();", "originalCommit": "20ec5f7087604f51ebfe9148db5f421c7d526ce6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2090b8b926184ccc5fc96021c0a746c033223fe6", "url": "https://github.com/elastic/elasticsearch/commit/2090b8b926184ccc5fc96021c0a746c033223fe6", "message": "address review comments", "committedDate": "2020-05-05T17:36:48Z", "type": "commit"}, {"oid": "835b783d42568f6aba38a9a8a8dfce494b694b42", "url": "https://github.com/elastic/elasticsearch/commit/835b783d42568f6aba38a9a8a8dfce494b694b42", "message": "Fix EvilInternalEngineTests, thanks Nhat for the fix!", "committedDate": "2020-05-05T18:06:28Z", "type": "commit"}, {"oid": "e83d3fd566a0f2530bd0b47c1128a61dfc135347", "url": "https://github.com/elastic/elasticsearch/commit/e83d3fd566a0f2530bd0b47c1128a61dfc135347", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-06T08:52:10Z", "type": "commit"}, {"oid": "a7980b5a7e190af19addf37593f54df4a36b8ba2", "url": "https://github.com/elastic/elasticsearch/commit/a7980b5a7e190af19addf37593f54df4a36b8ba2", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-06T09:02:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzNTA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420635055", "bodyText": "This does not restore the original limit if something goes wrong while reading the channel. I think we should duplicate the ByteBuffer first (by using the duplicate() method) and sets a new limit on the duplicate, and only update the position if the read on the duplicate succeed. WDYT?", "author": "tlrx", "createdAt": "2020-05-06T08:47:26Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CachedBlobContainerIndexInput.java", "diffHunk": "@@ -319,9 +317,18 @@ private boolean assertRangeIsAlignedWithPart(Tuple<Long, Long> range) {\n         return true;\n     }\n \n-    private int readCacheFile(FileChannel fc, long end, long position, byte[] buffer, int offset, long length) throws IOException {\n+    private int readCacheFile(FileChannel fc, long end, long position, ByteBuffer b) throws IOException {\n         assert assertFileChannelOpen(fc);\n-        int bytesRead = Channels.readFromFileChannel(fc, position, buffer, offset, Math.toIntExact(Math.min(length, end - position)));\n+        final int bytesRead;\n+        if (end - position < b.remaining()) {\n+            final int originalLimit = b.limit();\n+            b.limit(b.position() + Math.toIntExact(end - position));\n+            bytesRead = Channels.readFromFileChannel(fc, position, b);", "originalCommit": "835b783d42568f6aba38a9a8a8dfce494b694b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzNjM2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420636369", "bodyText": "I also think that removing the length method parameter changes the meaning of the EOFException message", "author": "tlrx", "createdAt": "2020-05-06T08:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzNTA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY3MzM3NA==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r420673374", "bodyText": "I think that was a great catch, I duplicate the buffer in the case we are reading partial buffers and change the position of the original buffer if reading the file was successful. I revert back the change of the length as well.", "author": "iverase", "createdAt": "2020-05-06T09:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzNTA1NQ=="}], "type": "inlineReview"}, {"oid": "a2db1fc3b7d0661d15f85cf41d03b41875c5fd93", "url": "https://github.com/elastic/elasticsearch/commit/a2db1fc3b7d0661d15f85cf41d03b41875c5fd93", "message": "duplicate buffer when reading incomplete buffers", "committedDate": "2020-05-06T09:54:36Z", "type": "commit"}, {"oid": "34f4d9882a3c022e999e88a1e54bb231686ecc12", "url": "https://github.com/elastic/elasticsearch/commit/34f4d9882a3c022e999e88a1e54bb231686ecc12", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-06T12:01:15Z", "type": "commit"}, {"oid": "cdcf4c8f3a25b51d2a6c1b92e510c01706ea0ebb", "url": "https://github.com/elastic/elasticsearch/commit/cdcf4c8f3a25b51d2a6c1b92e510c01706ea0ebb", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-07T07:56:16Z", "type": "commit"}, {"oid": "bb7252bd2bd1631c3c5884298965a341bef0e8f2", "url": "https://github.com/elastic/elasticsearch/commit/bb7252bd2bd1631c3c5884298965a341bef0e8f2", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-08T08:52:52Z", "type": "commit"}, {"oid": "d1cfbb217608c9822f06e04d3e1440472663b398", "url": "https://github.com/elastic/elasticsearch/commit/d1cfbb217608c9822f06e04d3e1440472663b398", "message": "disable BWC for lucene upgrade", "committedDate": "2020-05-08T08:53:57Z", "type": "commit"}, {"oid": "828a81e220495ec9f6199b4609076fbdfda59d60", "url": "https://github.com/elastic/elasticsearch/commit/828a81e220495ec9f6199b4609076fbdfda59d60", "message": "revert disable BWC for lucene upgrade", "committedDate": "2020-05-08T09:20:25Z", "type": "commit"}, {"oid": "ad80d34d916130f59b284f1043408819b43e6a0b", "url": "https://github.com/elastic/elasticsearch/commit/ad80d34d916130f59b284f1043408819b43e6a0b", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-08T10:26:11Z", "type": "commit"}, {"oid": "7c2046d19ff52c9502c75ab95b1b97bf612546bf", "url": "https://github.com/elastic/elasticsearch/commit/7c2046d19ff52c9502c75ab95b1b97bf612546bf", "message": "increase number of docs to make sure we have a tree with plenty of leaf nodes", "committedDate": "2020-05-09T09:51:52Z", "type": "commit"}, {"oid": "a402a2b64eb2e3f3e48411afbfb2730720689ab0", "url": "https://github.com/elastic/elasticsearch/commit/a402a2b64eb2e3f3e48411afbfb2730720689ab0", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-09T09:53:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA3MTQwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r423071408", "bodyText": "This part feels wrong, we should instead use trackTotalHitsUpTo() or fix assertSortResults to no longer fail if the expected hit count is greater than the actual hit count and relation=gte? @mayya-sharipova @jimczi opinions?", "author": "jpountz", "createdAt": "2020-05-11T14:15:52Z", "path": "server/src/test/java/org/elasticsearch/search/query/QueryPhaseTests.java", "diffHunk": "@@ -675,7 +675,7 @@ public void testNumericLongOrDateSortOptimization() throws Exception {\n         searchContext.sort(sortAndFormats);\n         searchContext.parsedQuery(new ParsedQuery(new MatchAllDocsQuery()));\n         searchContext.setTask(new SearchShardTask(123L, \"\", \"\", \"\", null, Collections.emptyMap()));\n-        searchContext.setSize(10);\n+        searchContext.setSize(numDocs);", "originalCommit": "7c2046d19ff52c9502c75ab95b1b97bf612546bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxNjIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r423516211", "bodyText": "Agreed, I think we should fix assertSortResults since the optimization could be disabled (not at the moment) if trackTotalHitsUpTo is greater than or equals to the number  of the docs in the index ?", "author": "jimczi", "createdAt": "2020-05-12T07:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA3MTQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMTkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r423521900", "bodyText": "I am thinking in fixing it like:\n[CORRECTED]\n  // assert score docs are in order and their number is as expected\n    private void assertSortResults(TopDocs topDocs, long expectedNumDocs, boolean isDoubleSort) {\n        if (topDocs.totalHits.relation == TotalHits.Relation.GREATER_THAN_OR_EQUAL_TO) {\n            assertThat(topDocs.totalHits.value, lessThanOrEqualTo(expectedNumDocs));\n        } else {\n            assertEquals(topDocs.totalHits.value, expectedNumDocs);\n        }\n ......\n}\n\n@jimczi wdyt?", "author": "iverase", "createdAt": "2020-05-12T07:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA3MTQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwNjQxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56175#discussion_r423606411", "bodyText": "Looks good", "author": "jimczi", "createdAt": "2020-05-12T09:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA3MTQwOA=="}], "type": "inlineReview"}, {"oid": "195607430d10cfb1a372abb33af9cc99fba360a7", "url": "https://github.com/elastic/elasticsearch/commit/195607430d10cfb1a372abb33af9cc99fba360a7", "message": "assertSortResults no longer fail if the expected hit count is greater than the actual hit count and relation=gte", "committedDate": "2020-05-12T08:12:44Z", "type": "commit"}, {"oid": "690a71f4f4a27868a185953aef968a9541990fd7", "url": "https://github.com/elastic/elasticsearch/commit/690a71f4f4a27868a185953aef968a9541990fd7", "message": "Merge branch 'master' into lucene-8.6.0-snapshot-6c9024f7735", "committedDate": "2020-05-12T08:13:53Z", "type": "commit"}]}