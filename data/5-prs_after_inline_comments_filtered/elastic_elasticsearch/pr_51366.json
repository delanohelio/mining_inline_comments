{"pr_number": 51366, "pr_title": "Use '--cursor-after' flag to get recent journal messages", "pr_createdAt": "2020-01-23T18:20:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51366", "timeline": [{"oid": "e847e53e799d7075dd665f8eadbb23fc1805452c", "url": "https://github.com/elastic/elasticsearch/commit/e847e53e799d7075dd665f8eadbb23fc1805452c", "message": "Use '--since' flag to get recent journal messages\n\nWhen we get Elasticsearch logs from journald, we want to fetch only log\nmessages from the last run. There are two reasons for this. First, if\nthere are many logs, we might get a string that's too large for our\nutility methods. Second, when we're looking for a specific message or\nerror, we almost certainly want to look only at messages from the last\nexecution.\n\nPreviously, we've been trying to do this by clearing out the physical\nfiles under the journald process. But there seems to be some contention\nover these directories: if journald writes a log file in between when\nour deletion command deletes the file and when it deletes the log\ndirectory, the deletion will fail.\n\nIt seems to me that we might be able to use journald's \"--since\" flag to\nretrieve only log messages from the last run, and that this might be\nless likely to fail due to race conditions in file deletion.\n\nUnfortunately, it looks as if the \"--since\" flag has a granularity of\none-second. I've added a two-second sleep to make sure that there's a\nsufficient gap between the test that will read from journald and the\ntest before it.", "committedDate": "2020-01-23T17:50:36Z", "type": "commit"}, {"oid": "17a4324c3c2429456c16934a82258e0999300b6e", "url": "https://github.com/elastic/elasticsearch/commit/17a4324c3c2429456c16934a82258e0999300b6e", "message": "Remove unused import", "committedDate": "2020-01-23T18:31:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0MDMzMg==", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370340332", "bodyText": "Could we just adjust the since time by 2 seconds instead of sleeping?", "author": "rjernst", "createdAt": "2020-01-23T20:34:04Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PackageTests.java", "diffHunk": "@@ -342,10 +341,9 @@ public void test90DoNotCloseStderrWhenQuiet() throws Exception {\n             append(tempConf.resolve(\"elasticsearch.yml\"), \"discovery.zen.ping.unicast.hosts:15172.30.5.3416172.30.5.35, 172.30.5.17]\\n\");\n \n             // Make sure we don't pick up the journal entries for previous ES instances.\n-            clearJournal(sh);\n+            String elasticsearchStartTime = sh.run(\"sleep 2 && date +\\\"%Y-%m-%d %H:%M:%S\\\"\").stdout.trim();", "originalCommit": "17a4324c3c2429456c16934a82258e0999300b6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM1MzMyNA==", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370353324", "bodyText": "I don't think that would guarantee a gap between Elasticsearch journal messages that's wider than the one-second granularity that the --since flag gives us.\nIf we have test A and test B and both check for the same error message, but test B is broken, we want to make sure that test A and test B's journal messages don't occur in the same second. I'm not sure how to guarantee that except by introducing a pause.\nAnother approach might be finding a way to tail journal messages to a test-specific file.", "author": "williamrandolph", "createdAt": "2020-01-23T21:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0MDMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2NzkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370367916", "bodyText": "Some versions of journalctl provide for navigating output with a cursor; I'm going to see if that looks like something we'll have on all platforms.", "author": "williamrandolph", "createdAt": "2020-01-23T21:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0MDMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwMTgzMA==", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370701830", "bodyText": "I think I have a solution that avoids invoking sleep.", "author": "williamrandolph", "createdAt": "2020-01-24T15:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0MDMzMg=="}], "type": "inlineReview"}, {"oid": "083a74eb3494e064817b4def69298debb97522ce", "url": "https://github.com/elastic/elasticsearch/commit/083a74eb3494e064817b4def69298debb97522ce", "message": "Use journald cursors to retrieve recent messages", "committedDate": "2020-01-24T00:00:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwMjU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370702595", "bodyText": "Note: even though this is only invoked in one test on the master branch, I'm going to need it for keystore tests on the feature branch, and it seems like something that could be generally useful later on.", "author": "williamrandolph", "createdAt": "2020-01-24T15:47:24Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Packages.java", "diffHunk": "@@ -332,4 +306,41 @@ public static void restartElasticsearch(Shell sh, Installation installation) thr\n         }\n         assertElasticsearchStarted(sh, installation);\n     }\n+\n+    /**\n+     * A small wrapper for retrieving only recent journald logs for the\n+     * Elasticsearch service. It works by creating a cursor for the logs\n+     * when instantiated, and advancing that cursor when the {@code clear()}\n+     * method is called.\n+     */\n+    public static class JournaldWrapper {", "originalCommit": "083a74eb3494e064817b4def69298debb97522ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}