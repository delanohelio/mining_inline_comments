{"pr_number": 55577, "pr_title": "Fix PemKeyConfigTests ", "pr_createdAt": "2020-04-22T10:08:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55577", "timeline": [{"oid": "45d7dd3e06f95efe9b132d542b159c0891703698", "url": "https://github.com/elastic/elasticsearch/commit/45d7dd3e06f95efe9b132d542b159c0891703698", "message": "Disable encrypted PKCS8 keys test in FIPS\n\nWe can't decrypt these files since PBEKeySpec is not available in\na FIPS 140 security provider", "committedDate": "2020-04-22T10:05:36Z", "type": "commit"}, {"oid": "e4edeb03a69a59a6414703f7ad9e2956210dd5dc", "url": "https://github.com/elastic/elasticsearch/commit/e4edeb03a69a59a6414703f7ad9e2956210dd5dc", "message": "Test with the correct certificates", "committedDate": "2020-04-22T12:37:28Z", "type": "commit"}, {"oid": "85558facbb00090555955ef5f8ba7c561180cd22", "url": "https://github.com/elastic/elasticsearch/commit/85558facbb00090555955ef5f8ba7c561180cd22", "message": "Merge branch 'master' into mute-encrypted-pkcs8-fips", "committedDate": "2020-04-22T18:30:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r413514284", "bodyText": "This is probably a dumb question. This is not possible in FIPS mode because the key is genereated using the PBEKeySpec?", "author": "ywangd", "createdAt": "2020-04-23T05:13:50Z", "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "diffHunk": "@@ -70,6 +70,7 @@ public void testBuildKeyConfigFromPkcs8PemFilesWithoutPassword() throws Exceptio\n     }\n \n     public void testBuildKeyConfigFromPkcs8PemFilesWithPassword() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM, PBE KeySpec is not available\", inFipsJvm());", "originalCommit": "85558facbb00090555955ef5f8ba7c561180cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNjYxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r413826615", "bodyText": "This is not a dumb question. I realize that many times in the FIPS journey the comments and documentation I added made sense to me ( and sometimes not for long after the time when I wrote them ) but are not proper explanations.\nTo start with, we are limited to using only the algorithms defined in PKCS#5 1.5 because of a JDK bug ( that will hopefully be solved in JDK15 ) see :#32021.\nWhen not in FIPS mode, javax.crypto.SecretKeyFactory#generateSecret uses com.sun.crypto.provider.PBEKeyFactory#engineGenerateSecret which can happily consume a PBEKeySpec that has no salt because it uses com.sun.crypto.provider.PBEKey which doesn't have a salt ( the salt is used, but later on by the Cipher ) .\nWhen in FIPS mode, javax.crypto.SecretKeyFactory#generateSecret uses org.bouncycastle.jca.jce.provider.ProvPBE$PBKDF1#engineGenerateSecret that asserts that the PBEKeySpec has a salt and fails if not.\nNow we could restructure our PemUtils code to get the PbeParameterSpec with encryptedPrivateKeyInfo.getAlgParameters().getParameterSpec(AlgorithmParameterSpec.class); and then get the salt and iterations from there so that we could initialize a PBEKeySpec with the password, salt and iteration count so that it works in both SunJCE and BouncyCastle FIPS Provides BUT here's the catch:\nBouncyCastle FIPS provider doesn't support the algorithms that are described in PKCS#5 v1.5 encryption . ( PBE-MD2-DES and PBE-MD5-DES ), so it can't parse them to an AlgorithmParameterSpec.\nIn summary PBE KeySpec is not available is an understatement that made sense 2 years ago but in truth should have been described in detail in an issue that we can keep track of this. I will do this now, thanks for asking!", "author": "jkakavas", "createdAt": "2020-04-23T14:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMwNDg1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r416304853", "bodyText": "Shouldn't our FIPS instructions say that PKCS#8 password protected keys are not supported then?\nIronically, this bug was originally reported by someone trying to set up a FIPS 140-2 compliant cluster.", "author": "tvernum", "createdAt": "2020-04-28T03:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNTQzNg==", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r416405436", "bodyText": "To be fair, we don't support PKCS#5 v2 encrypted PKCS# encoded PEM keys at all and  we don't support PKCS#5 v1.5 encrypted PKCS# encoded PEM keys in FIPS mode. At that time when we discovered this, the issue seemed to cover this since it affected the encryption that is prefered ( v2 ) irrespective to FIPS but you're right this should be marked as a limitation.", "author": "jkakavas", "createdAt": "2020-04-28T07:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}], "type": "inlineReview"}]}