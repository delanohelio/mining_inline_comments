{"pr_number": 53666, "pr_title": "Initial data stream commit", "pr_createdAt": "2020-03-17T14:28:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53666", "timeline": [{"oid": "b537e5968945bd1f8742d5bd317023cd8b48b1ac", "url": "https://github.com/elastic/elasticsearch/commit/b537e5968945bd1f8742d5bd317023cd8b48b1ac", "message": "Initial data stream commit\n\nThis commits adds a data stream feature flag, initial definition of a data stream and\nthe stubs for the data stream create, delete and get APIs. Also simple serialization\ntests are added and a rest test to thest the data stream API stubs.\n\nThis is a large amount of code and mainly mechanical, but this commit should be\nstraightforward to review, because there isn't any real logic.\n\nThe data stream transport and rest action are behind the data stream feature flag and\nare only intialized if the feature flag is enabled. The feature flag is enabled if\nelasticsearch is build as snapshot or a release build and the\n'es.datastreams_feature_flag_registered' is enabled.\n\nThe integ-test-zip sets the feature flag if building a release build, otherwise\nrest tests would fail.\n\nRelates to #53100", "committedDate": "2020-03-17T14:25:55Z", "type": "commit"}, {"oid": "9665ea973a87e389d2d468889408ed6faf756980", "url": "https://github.com/elastic/elasticsearch/commit/9665ea973a87e389d2d468889408ed6faf756980", "message": "fixed hlrc test", "committedDate": "2020-03-17T16:30:02Z", "type": "commit"}, {"oid": "f7200c7c02f1341e3f6cce241973fdf45e9d72f8", "url": "https://github.com/elastic/elasticsearch/commit/f7200c7c02f1341e3f6cce241973fdf45e9d72f8", "message": "ignore bwc until this change has been backported to 7.x branch", "committedDate": "2020-03-17T16:31:21Z", "type": "commit"}, {"oid": "e362eeb669b8d20a6bede467155c6a832e1bf1ad", "url": "https://github.com/elastic/elasticsearch/commit/e362eeb669b8d20a6bede467155c6a832e1bf1ad", "message": "changed data stream apis to be a cluster based action.\n\nbefore this commit the data steams api were indices based actions,\nbut data streams aren't indices, data streams encapsulates indices,\nbut are indices themselves. It is a cluster level attribute, and\ntherefor cluster based action fits best for now.\n\nPerhaps in the future we will have data stream based actions and\nthen this would be a right fit for the data stream crud apis.", "committedDate": "2020-03-17T18:43:26Z", "type": "commit"}, {"oid": "7c22f72413f02e91657181cd5d095e3abe123835", "url": "https://github.com/elastic/elasticsearch/commit/7c22f72413f02e91657181cd5d095e3abe123835", "message": "this should have been part of the previous commit", "committedDate": "2020-03-17T18:50:28Z", "type": "commit"}, {"oid": "ee721c3ae91a235f3acecf42789587e21e418aeb", "url": "https://github.com/elastic/elasticsearch/commit/ee721c3ae91a235f3acecf42789587e21e418aeb", "message": "fixed yaml test", "committedDate": "2020-03-17T20:33:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5Mzk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r394393993", "bodyText": "Do we need to read the optional indices field here for creating a data stream with existing indices?", "author": "danhermann", "createdAt": "2020-03-18T14:36:08Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.action.admin.cluster.datastream;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.action.support.master.TransportMasterNodeAction;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.block.ClusterBlockException;\n+import org.elasticsearch.cluster.block.ClusterBlockLevel;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class CreateDataStreamAction extends ActionType<AcknowledgedResponse> {\n+\n+    public static final CreateDataStreamAction INSTANCE = new CreateDataStreamAction();\n+    public static final String NAME = \"cluster:admin/data_stream/create\";\n+\n+    private CreateDataStreamAction() {\n+        super(NAME, AcknowledgedResponse::new);\n+    }\n+\n+    public static class Request extends MasterNodeRequest<Request> {\n+\n+        private final String name;\n+        private String timestampFieldName;\n+\n+        public Request(String name) {\n+            this.name = name;\n+        }\n+\n+        public void setTimestampFieldName(String timestampFieldName) {\n+            this.timestampFieldName = timestampFieldName;\n+        }\n+\n+        @Override\n+        public ActionRequestValidationException validate() {\n+            return null;\n+        }\n+\n+        public Request(StreamInput in) throws IOException {\n+            super(in);\n+            this.name = in.readString();\n+            this.timestampFieldName = in.readString();\n+        }", "originalCommit": "ee721c3ae91a235f3acecf42789587e21e418aeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5Nzk0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r394397941", "bodyText": "For now this api will only create new empty indices.\nWhen we add the ability to add existing indices to a data stream then we can add an optional indices field here. Makes sense?", "author": "martijnvg", "createdAt": "2020-03-18T14:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5Mzk5Mw=="}], "type": "inlineReview"}, {"oid": "f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "url": "https://github.com/elastic/elasticsearch/commit/f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "message": "Also add feature flag in other modules that run the yaml test if a release build is executed", "committedDate": "2020-03-18T16:05:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3NTkwNA==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395175904", "bodyText": "I think we should move this outside the cluster package? So datastream is a sibling to indices.\nWe might also want to follow the same substructure by adding create package now? Probably easiest to split into subpackages early.", "author": "henningandersen", "createdAt": "2020-03-19T16:54:55Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.action.admin.cluster.datastream;", "originalCommit": "f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3NzU2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395177565", "bodyText": "I am in doubt if we should not add a specific prefix here? No need to look at this now, we can pick that up later.", "author": "henningandersen", "createdAt": "2020-03-19T16:57:17Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.action.admin.cluster.datastream;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.action.support.master.TransportMasterNodeAction;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.block.ClusterBlockException;\n+import org.elasticsearch.cluster.block.ClusterBlockLevel;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class CreateDataStreamAction extends ActionType<AcknowledgedResponse> {\n+\n+    public static final CreateDataStreamAction INSTANCE = new CreateDataStreamAction();\n+    public static final String NAME = \"cluster:admin/data_stream/create\";", "originalCommit": "f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4MDkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395180906", "bodyText": "Same story as for the action names. We should consider whether to include this under indices or under a new \"client\" interface? Will add to our weekly sync, this should not block merging this.", "author": "henningandersen", "createdAt": "2020-03-19T17:02:13Z", "path": "server/src/main/java/org/elasticsearch/client/support/AbstractClient.java", "diffHunk": "@@ -1185,6 +1188,36 @@ public DeleteStoredScriptRequestBuilder prepareDeleteStoredScript(){\n         public DeleteStoredScriptRequestBuilder prepareDeleteStoredScript(String id){\n             return prepareDeleteStoredScript().setId(id);\n         }\n+", "originalCommit": "f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4MjAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395182004", "bodyText": "Rename to DataStreamMetaData (like IndexMetaData)?", "author": "henningandersen", "createdAt": "2020-03-19T17:03:52Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.metadata;\n+\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diff;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public final class DataStream extends AbstractDiffable<DataStream> implements ToXContentObject {", "originalCommit": "f9ce4cdcbc530679c0416b4d7bf0483e83767f13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwMDE1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395200159", "bodyText": "Data stream definitions will be stored in a custom metadata (like ComponentTemplateMetadata). These classes tend to have the Metadata suffix and therfore I think that adding MetaData suffix is confusing here.\nMaybe we can rename this to DataStreamSource? Like how stored scripts are stored? (which also is stored inside a custom metadata).", "author": "martijnvg", "createdAt": "2020-03-19T17:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4MjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NjUxOA==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395496518", "bodyText": "OK. I think I imagined a more native integration into the MetaData (outside Custom). I think the primary purpose of Custom is for extensibility (x-pack/plugins/modules)? In particular, I think MetaData.getAliasAndIndexLookup will need some support of data-streams? It could still look for the Custom metadata pieces, but feels second-class.\nLet us leave this as is for now and tackle above when we get to add the metadata and do the lookups.", "author": "henningandersen", "createdAt": "2020-03-20T08:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4MjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwNzE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395507164", "bodyText": "I think MetaData.getAliasAndIndexLookup will need some support of data-streams?\n\nWe can add a getter on metadata that reads data stream from a custom and then it is as if it is stored as a primary field. The reason why I think we should do this is that, we get serialization, diffability and versioning for free without changing the Metadata class.\n\nIt could still look for the Custom metadata pieces, but feels second-class.\n\nPerhaps we should rename this in the future. Scripts and pipelines and other primary concepts are stored also as custom metadata and these concepts aren't second class either.", "author": "martijnvg", "createdAt": "2020-03-20T09:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4MjAwNA=="}], "type": "inlineReview"}, {"oid": "6586d7c35734fdc8c2446bdc4517685b3babfbd8", "url": "https://github.com/elastic/elasticsearch/commit/6586d7c35734fdc8c2446bdc4517685b3babfbd8", "message": "Reverted the commits that make data stream a cluster based api\n\nThis reverts commit e362eeb669b8d20a6bede467155c6a832e1bf1ad.", "committedDate": "2020-03-19T20:02:02Z", "type": "commit"}, {"oid": "7130a27a40557ec07594d8c0bbc8091cab3e2d38", "url": "https://github.com/elastic/elasticsearch/commit/7130a27a40557ec07594d8c0bbc8091cab3e2d38", "message": "Make data stream crud apis work like a indices based api.", "committedDate": "2020-03-19T21:40:30Z", "type": "commit"}, {"oid": "ce73ee8291a398dffdbc34548d35feb6008e9998", "url": "https://github.com/elastic/elasticsearch/commit/ce73ee8291a398dffdbc34548d35feb6008e9998", "message": "renamed timestamp field", "committedDate": "2020-03-19T21:49:00Z", "type": "commit"}, {"oid": "53c8fd46b159cd491d39f148af8e3d70ac50aed2", "url": "https://github.com/elastic/elasticsearch/commit/53c8fd46b159cd491d39f148af8e3d70ac50aed2", "message": "Merge remote-tracking branch 'es/master' into data-streams-start", "committedDate": "2020-03-20T07:57:25Z", "type": "commit"}, {"oid": "b133074999393f10b0c6f854493157da31a4d1b6", "url": "https://github.com/elastic/elasticsearch/commit/b133074999393f10b0c6f854493157da31a4d1b6", "message": "fixed compile error after merging in master", "committedDate": "2020-03-20T08:07:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5MTg1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395491859", "bodyText": "Maybe add a todo to help the next reader until resolved? Something like:\n// todo: hack until we implement security of data_streams", "author": "henningandersen", "createdAt": "2020-03-20T08:27:20Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/privilege/ClusterPrivilegeResolver.java", "diffHunk": "@@ -193,7 +193,9 @@ public static NamedClusterPrivilege resolve(String name) {\n     }\n \n     public static boolean isClusterAction(String actionName) {\n-        return actionName.startsWith(\"cluster:\") || actionName.startsWith(\"indices:admin/template/\");\n+        return actionName.startsWith(\"cluster:\") ||\n+            actionName.startsWith(\"indices:admin/template/\") ||\n+            actionName.startsWith(\"indices:admin/data_stream/\");", "originalCommit": "7130a27a40557ec07594d8c0bbc8091cab3e2d38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NzQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395497465", "bodyText": "I think the rest classes should move to org.elasticsearch.rest.action.admin.datastreams? Or org.elasticsearch.rest.action.admin.indices.datastream?", "author": "henningandersen", "createdAt": "2020-03-20T08:40:27Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/cluster/RestCreateDataStreamAction.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.rest.action.admin.cluster;", "originalCommit": "b133074999393f10b0c6f854493157da31a4d1b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwNTIxMg==", "url": "https://github.com/elastic/elasticsearch/pull/53666#discussion_r395505212", "bodyText": "yes, I missed that.", "author": "martijnvg", "createdAt": "2020-03-20T08:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ5NzQ2NQ=="}], "type": "inlineReview"}, {"oid": "56c58794a1e2c37067cedf696152604170133c26", "url": "https://github.com/elastic/elasticsearch/commit/56c58794a1e2c37067cedf696152604170133c26", "message": "fixed merge mistake", "committedDate": "2020-03-20T08:48:56Z", "type": "commit"}, {"oid": "1ed4eeaa6ba3618210692ad593c08160d85bca23", "url": "https://github.com/elastic/elasticsearch/commit/1ed4eeaa6ba3618210692ad593c08160d85bca23", "message": "moved setting system property", "committedDate": "2020-03-20T08:51:18Z", "type": "commit"}, {"oid": "9e58488c6c2802d9b142adbbdb047185b58242df", "url": "https://github.com/elastic/elasticsearch/commit/9e58488c6c2802d9b142adbbdb047185b58242df", "message": "applied review comments", "committedDate": "2020-03-20T09:07:02Z", "type": "commit"}]}