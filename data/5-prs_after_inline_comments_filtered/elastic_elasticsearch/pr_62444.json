{"pr_number": 62444, "pr_title": "Add WARN Logging on Slow Transport Message Handling", "pr_createdAt": "2020-09-16T11:49:58Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62444", "timeline": [{"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "url": "https://github.com/elastic/elasticsearch/commit/be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "message": "Add WARN Logging on Slow Transport Message Handling\n\nAdd simple WARN logging on slow inbound tcp messages.", "committedDate": "2020-09-16T11:41:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NzI3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489377276", "bodyText": "Admittedly the chain of setters here is a little hacky but:\n\nDoing it this way made this a much much smaller change than passing the cluster settings directly to the InboundHandler\nI'd do a follow-up of this logic for the outbound path and that would require handling the threshold setting in the TransportService anyway.", "author": "original-brownbear", "createdAt": "2020-09-16T11:52:52Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -71,6 +74,10 @@ void setMessageListener(TransportMessageListener listener) {\n         }\n     }\n \n+    void setSlowLogThreshold(TimeValue slowLogThreshold) {", "originalCommit": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489378593", "bodyText": "300ms since our default resolution on the timer thread is 200ms. This is already plenty IMO (3 requests per second isn't great on a transport thread) but not so low that any cgroup throttling or other system slowness instantly results in massive log spam.", "author": "original-brownbear", "createdAt": "2020-09-16T11:55:06Z", "path": "server/src/main/java/org/elasticsearch/transport/TransportSettings.java", "diffHunk": "@@ -132,6 +132,12 @@\n             Arrays.asList(\"internal:coordination/fault_detection/*\"),\n             Function.identity(), Setting.Property.Dynamic, Setting.Property.NodeScope);\n \n+    // Time that processing an inbound message on a transport thread may take at the most before a warning is logged\n+    public static final Setting<TimeValue> SLOW_OPERATION_THRESHOLD_SETTING =\n+            Setting.positiveTimeSetting(\"transport.slow_operation_logging_threshold\", TimeValue.timeValueMillis(300),", "originalCommit": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyMTgzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489421835", "bodyText": "I'm still a bit concerned about log spam -- we aren't aware of anything that blocks the transport threads for so long today but that might just be because we don't surface it yet, and some configs might be hitting this a lot. #processors threads times 3 messages per second is too much for my taste. WDYT about a simple rate limit to avoid logging more than one of these per ten seconds or something? That'd be enough to point us in the right direction.", "author": "DaveCTurner", "createdAt": "2020-09-16T13:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NzM2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489467367", "bodyText": "I think it might be kind of nice to be able to see bursts here (thinking about spotting something like CPU throttling)? (if you have a time period where there's a bunch of logging across multiple threads for all kinds of messages without a clear pattern or so). I guess we could use something like the log4j burst filter here to capture that kind of thing and still rate limit but what this:\nWe could just do something like a hard 5s timeout above which we always WARN and make this a DEBUG at 300ms?", "author": "original-brownbear", "createdAt": "2020-09-16T14:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxODE5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489518191", "bodyText": "I'd be happy with 5s -- I think this would surface problems bad enough to drop nodes from the cluster without risking too much junk.\nNo need for a separate debug logging threshold IMO -- given that it would need user involvement to see more events in the logs, they may as well just reduce transport.slow_operation_logging_threshold.", "author": "DaveCTurner", "createdAt": "2020-09-16T15:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUyODQ4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489528485", "bodyText": "Fair point -> pushed the change to 5s :)", "author": "original-brownbear", "createdAt": "2020-09-16T15:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjAxMA==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489402010", "bodyText": "It'd be useful to include the phrase warn threshold as this is a useful search term for the logs when investigating general slowness/instability problems:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.warn(\"Slow handling of transport message [{}] took [{}ms]\", message, took);\n          \n          \n            \n                            logger.warn(\"handling inbound transport message [{}] took [{}ms] which is above the warn threshold of [{}ms]\", message, took, logThreshold);", "author": "DaveCTurner", "createdAt": "2020-09-16T12:36:27Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -138,6 +146,12 @@ private void messageReceived(TcpChannel channel, InboundMessage message) throws\n                     }\n                 }\n             }\n+        } finally {\n+            final long took = threadPool.relativeTimeInMillis() - startTime;\n+            final long logThreshold = slowLogThresholdMs;\n+            if (logThreshold > 0 && took > logThreshold) {\n+                logger.warn(\"Slow handling of transport message [{}] took [{}ms]\", message, took);", "originalCommit": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NzU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489467583", "bodyText": "++", "author": "original-brownbear", "createdAt": "2020-09-16T14:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwOTUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489409500", "bodyText": "Could we move the timing up to this level, since the logging on this line may also be a source of slowness?", "author": "DaveCTurner", "createdAt": "2020-09-16T12:48:32Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -71,6 +74,10 @@ void setMessageListener(TransportMessageListener listener) {\n         }\n     }\n \n+    void setSlowLogThreshold(TimeValue slowLogThreshold) {\n+        this.slowLogThresholdMs = slowLogThreshold.getMillis();\n+    }\n+\n     void inboundMessage(TcpChannel channel, InboundMessage message) throws Exception {\n         channel.getChannelStats().markAccessed(threadPool.relativeTimeInMillis());\n         TransportLogger.logInboundMessage(channel, message);", "originalCommit": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NzU1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489467559", "bodyText": "++", "author": "original-brownbear", "createdAt": "2020-09-16T14:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwOTUwMA=="}], "type": "inlineReview"}, {"oid": "8a336d1f3f5a9eaa41f56cc9b5b2d03ffff76755", "url": "https://github.com/elastic/elasticsearch/commit/8a336d1f3f5a9eaa41f56cc9b5b2d03ffff76755", "message": "CR: comments", "committedDate": "2020-09-16T14:14:54Z", "type": "commit"}, {"oid": "df849144407f28e83a6cc6b8873a6e348d44bcb9", "url": "https://github.com/elastic/elasticsearch/commit/df849144407f28e83a6cc6b8873a6e348d44bcb9", "message": "5s it is", "committedDate": "2020-09-16T15:28:23Z", "type": "commit"}]}