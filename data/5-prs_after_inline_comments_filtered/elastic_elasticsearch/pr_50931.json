{"pr_number": 50931, "pr_title": "Add more logging when failing watch history entry fails.", "pr_createdAt": "2020-01-13T17:02:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50931", "timeline": [{"oid": "be61ce56319d954282bb67b0b91093fc14c3b207", "url": "https://github.com/elastic/elasticsearch/commit/be61ce56319d954282bb67b0b91093fc14c3b207", "message": "Add more logging when failing watch history entry fails.\n\nRelates to #30777", "committedDate": "2020-01-13T17:00:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAwOTM0NA==", "url": "https://github.com/elastic/elasticsearch/pull/50931#discussion_r367009344", "bodyText": "you may want add metric=_all to include current and queued watches.\n/_watcher/stats?metric=_all", "author": "jakelandis", "createdAt": "2020-01-15T17:31:14Z", "path": "x-pack/qa/smoke-test-watcher-with-security/src/test/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java", "diffHunk": "@@ -305,39 +305,58 @@ private ObjectPath getWatchHistoryEntry(String watchId) throws Exception {\n \n     private ObjectPath getWatchHistoryEntry(String watchId, String state) throws Exception {\n         final AtomicReference<ObjectPath> objectPathReference = new AtomicReference<>();\n-        assertBusy(() -> {\n-            client().performRequest(new Request(\"POST\", \"/.watcher-history-*/_refresh\"));\n-\n-            try (XContentBuilder builder = jsonBuilder()) {\n-                builder.startObject();\n-                builder.startObject(\"query\").startObject(\"bool\").startArray(\"must\");\n-                builder.startObject().startObject(\"term\").startObject(\"watch_id\").field(\"value\", watchId).endObject().endObject()\n+        try {\n+            assertBusy(() -> {\n+                client().performRequest(new Request(\"POST\", \"/.watcher-history-*/_refresh\"));\n+\n+                try (XContentBuilder builder = jsonBuilder()) {\n+                    builder.startObject();\n+                    builder.startObject(\"query\").startObject(\"bool\").startArray(\"must\");\n+                    builder.startObject().startObject(\"term\").startObject(\"watch_id\").field(\"value\", watchId).endObject().endObject()\n                         .endObject();\n-                if (Strings.isNullOrEmpty(state) == false) {\n-                    builder.startObject().startObject(\"term\").startObject(\"state\").field(\"value\", state).endObject().endObject()\n+                    if (Strings.isNullOrEmpty(state) == false) {\n+                        builder.startObject().startObject(\"term\").startObject(\"state\").field(\"value\", state).endObject().endObject()\n                             .endObject();\n-                }\n-                builder.endArray().endObject().endObject();\n-                builder.startArray(\"sort\").startObject().startObject(\"trigger_event.triggered_time\").field(\"order\", \"desc\").endObject()\n+                    }\n+                    builder.endArray().endObject().endObject();\n+                    builder.startArray(\"sort\").startObject().startObject(\"trigger_event.triggered_time\").field(\"order\", \"desc\").endObject()\n                         .endObject().endArray();\n-                builder.endObject();\n-\n-                Request searchRequest = new Request(\"POST\", \"/.watcher-history-*/_search\");\n-                searchRequest.addParameter(TOTAL_HITS_AS_INT_PARAM, \"true\");\n-                searchRequest.setJsonEntity(Strings.toString(builder));\n-                Response response = client().performRequest(searchRequest);\n-                ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                int totalHits = objectPath.evaluate(\"hits.total\");\n-                assertThat(totalHits, is(greaterThanOrEqualTo(1)));\n-                String watchid = objectPath.evaluate(\"hits.hits.0._source.watch_id\");\n-                assertThat(watchid, is(watchId));\n-                objectPathReference.set(objectPath);\n-            } catch (ResponseException e) {\n-                final String err = \"Failed to perform search of watcher history\";\n-                logger.info(err, e);\n-                fail(err);\n+                    builder.endObject();\n+\n+                    Request searchRequest = new Request(\"POST\", \"/.watcher-history-*/_search\");\n+                    searchRequest.addParameter(TOTAL_HITS_AS_INT_PARAM, \"true\");\n+                    searchRequest.setJsonEntity(Strings.toString(builder));\n+                    Response response = client().performRequest(searchRequest);\n+                    ObjectPath objectPath = ObjectPath.createFromResponse(response);\n+                    int totalHits = objectPath.evaluate(\"hits.total\");\n+                    assertThat(totalHits, is(greaterThanOrEqualTo(1)));\n+                    String watchid = objectPath.evaluate(\"hits.hits.0._source.watch_id\");\n+                    assertThat(watchid, is(watchId));\n+                    objectPathReference.set(objectPath);\n+                } catch (ResponseException e) {\n+                    final String err = \"Failed to perform search of watcher history\";\n+                    logger.info(err, e);\n+                    fail(err);\n+                }\n+            });\n+        } catch (AssertionError ae) {\n+            {\n+                Request request = new Request(\"GET\", \"/_watcher/stats\");", "originalCommit": "be61ce56319d954282bb67b0b91093fc14c3b207", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAxMDY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50931#discussion_r367010697", "bodyText": "When this fails and is stuck for during the assertBusy, may result in alot of .watcher_history... should we increase the default size ?", "author": "jakelandis", "createdAt": "2020-01-15T17:34:01Z", "path": "x-pack/qa/smoke-test-watcher-with-security/src/test/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java", "diffHunk": "@@ -305,39 +305,58 @@ private ObjectPath getWatchHistoryEntry(String watchId) throws Exception {\n \n     private ObjectPath getWatchHistoryEntry(String watchId, String state) throws Exception {\n         final AtomicReference<ObjectPath> objectPathReference = new AtomicReference<>();\n-        assertBusy(() -> {\n-            client().performRequest(new Request(\"POST\", \"/.watcher-history-*/_refresh\"));\n-\n-            try (XContentBuilder builder = jsonBuilder()) {\n-                builder.startObject();\n-                builder.startObject(\"query\").startObject(\"bool\").startArray(\"must\");\n-                builder.startObject().startObject(\"term\").startObject(\"watch_id\").field(\"value\", watchId).endObject().endObject()\n+        try {\n+            assertBusy(() -> {\n+                client().performRequest(new Request(\"POST\", \"/.watcher-history-*/_refresh\"));\n+\n+                try (XContentBuilder builder = jsonBuilder()) {\n+                    builder.startObject();\n+                    builder.startObject(\"query\").startObject(\"bool\").startArray(\"must\");\n+                    builder.startObject().startObject(\"term\").startObject(\"watch_id\").field(\"value\", watchId).endObject().endObject()\n                         .endObject();\n-                if (Strings.isNullOrEmpty(state) == false) {\n-                    builder.startObject().startObject(\"term\").startObject(\"state\").field(\"value\", state).endObject().endObject()\n+                    if (Strings.isNullOrEmpty(state) == false) {\n+                        builder.startObject().startObject(\"term\").startObject(\"state\").field(\"value\", state).endObject().endObject()\n                             .endObject();\n-                }\n-                builder.endArray().endObject().endObject();\n-                builder.startArray(\"sort\").startObject().startObject(\"trigger_event.triggered_time\").field(\"order\", \"desc\").endObject()\n+                    }\n+                    builder.endArray().endObject().endObject();\n+                    builder.startArray(\"sort\").startObject().startObject(\"trigger_event.triggered_time\").field(\"order\", \"desc\").endObject()\n                         .endObject().endArray();\n-                builder.endObject();\n-\n-                Request searchRequest = new Request(\"POST\", \"/.watcher-history-*/_search\");\n-                searchRequest.addParameter(TOTAL_HITS_AS_INT_PARAM, \"true\");\n-                searchRequest.setJsonEntity(Strings.toString(builder));\n-                Response response = client().performRequest(searchRequest);\n-                ObjectPath objectPath = ObjectPath.createFromResponse(response);\n-                int totalHits = objectPath.evaluate(\"hits.total\");\n-                assertThat(totalHits, is(greaterThanOrEqualTo(1)));\n-                String watchid = objectPath.evaluate(\"hits.hits.0._source.watch_id\");\n-                assertThat(watchid, is(watchId));\n-                objectPathReference.set(objectPath);\n-            } catch (ResponseException e) {\n-                final String err = \"Failed to perform search of watcher history\";\n-                logger.info(err, e);\n-                fail(err);\n+                    builder.endObject();\n+\n+                    Request searchRequest = new Request(\"POST\", \"/.watcher-history-*/_search\");\n+                    searchRequest.addParameter(TOTAL_HITS_AS_INT_PARAM, \"true\");\n+                    searchRequest.setJsonEntity(Strings.toString(builder));\n+                    Response response = client().performRequest(searchRequest);\n+                    ObjectPath objectPath = ObjectPath.createFromResponse(response);\n+                    int totalHits = objectPath.evaluate(\"hits.total\");\n+                    assertThat(totalHits, is(greaterThanOrEqualTo(1)));\n+                    String watchid = objectPath.evaluate(\"hits.hits.0._source.watch_id\");\n+                    assertThat(watchid, is(watchId));\n+                    objectPathReference.set(objectPath);\n+                } catch (ResponseException e) {\n+                    final String err = \"Failed to perform search of watcher history\";\n+                    logger.info(err, e);\n+                    fail(err);\n+                }\n+            });\n+        } catch (AssertionError ae) {\n+            {\n+                Request request = new Request(\"GET\", \"/_watcher/stats\");\n+                Response response = client().performRequest(request);\n+                logger.info(\"watcher_stats: {}\", EntityUtils.toString(response.getEntity()));\n             }\n-        });\n+            {\n+                Request request = new Request(\"GET\", \"/_cluster/state\");\n+                Response response = client().performRequest(request);\n+                logger.info(\"cluster_state: {}\", EntityUtils.toString(response.getEntity()));\n+            }\n+            {\n+                Request request = new Request(\"GET\", \"/.watcher-history-*/_search\");", "originalCommit": "be61ce56319d954282bb67b0b91093fc14c3b207", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "368f85a1c16a1c808cd0da458ca58021650d5ff8", "url": "https://github.com/elastic/elasticsearch/commit/368f85a1c16a1c808cd0da458ca58021650d5ff8", "message": "Merge remote-tracking branch 'es/master' into SmokeTestWatcherWithSecurityIT_more_logging", "committedDate": "2020-01-16T08:18:02Z", "type": "commit"}, {"oid": "b2a52e1f2e49aebbc5ef25f4a186a81d5822438a", "url": "https://github.com/elastic/elasticsearch/commit/b2a52e1f2e49aebbc5ef25f4a186a81d5822438a", "message": "iter", "committedDate": "2020-01-16T08:28:01Z", "type": "commit"}]}