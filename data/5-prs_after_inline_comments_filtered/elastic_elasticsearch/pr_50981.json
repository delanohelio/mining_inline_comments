{"pr_number": 50981, "pr_title": "[7.x][ML] Explicitly require a OriginSettingClient in ML results iterators ", "pr_createdAt": "2020-01-14T15:04:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50981", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NDcxNA==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366394714", "bodyText": "Could this snippet be replaced with an appropriate mockSearchResponse call?", "author": "przemekwitek", "createdAt": "2020-01-14T15:13:11Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemoverTests.java", "diffHunk": "@@ -126,13 +140,14 @@ public void testRemoveGivenMultipleBatches() throws IOException {\n \n         AtomicInteger searchCount = new AtomicInteger(0);\n \n-        @SuppressWarnings(\"unchecked\")\n-        ActionFuture<SearchResponse> future = mock(ActionFuture.class);\n-        doAnswer(invocationOnMock -> responses.get(searchCount.getAndIncrement())).when(future).actionGet();\n-        when(client.search(any())).thenReturn(future);\n+        doAnswer(invocationOnMock -> {", "originalCommit": "f31cf7e915966fbf9a1d4aac5a584094fddadf65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwNjI5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366406297", "bodyText": "Yes but I would still need to know which invocation of search is being called so the correct results can be returned. That would probably involve some sort of counter and I don't think it would be any simpler than walking the array.", "author": "davidkyle", "createdAt": "2020-01-14T15:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NDcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NTM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366395359", "bodyText": "Why is this removed? Are there any new client interactions expected after your change?", "author": "przemekwitek", "createdAt": "2020-01-14T15:14:17Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -86,25 +91,22 @@ public void testRemove_GivenJobsWithoutRetentionPolicy() throws IOException {\n \n         listener.waitToCompletion();\n         assertThat(listener.success, is(true));\n-        verify(client).search(any());\n-        Mockito.verifyNoMoreInteractions(client);", "originalCommit": "f31cf7e915966fbf9a1d4aac5a584094fddadf65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwNjc1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366406753", "bodyText": "Yes, the filter client makes many more calls to the inner client.", "author": "davidkyle", "createdAt": "2020-01-14T15:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NjE2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366396162", "bodyText": "Could org.mockito.Mockito.mock be imported to avoid qualified name?", "author": "przemekwitek", "createdAt": "2020-01-14T15:15:39Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredResultsRemoverTests.java", "diffHunk": "@@ -43,58 +41,48 @@\n public class ExpiredResultsRemoverTests extends ESTestCase {\n \n     private Client client;\n+    private OriginSettingClient originSettingClient;\n     private List<DeleteByQueryRequest> capturedDeleteByQueryRequests;\n     private ActionListener<Boolean> listener;\n \n     @Before\n     @SuppressWarnings(\"unchecked\")\n     public void setUpTests() {\n         capturedDeleteByQueryRequests = new ArrayList<>();\n-        client = mock(Client.class);\n-        ThreadPool threadPool = mock(ThreadPool.class);\n-        when(client.threadPool()).thenReturn(threadPool);\n-        when(threadPool.getThreadContext()).thenReturn(new ThreadContext(Settings.EMPTY));\n-        doAnswer(new Answer<Void>() {\n-                 @Override\n-                 public Void answer(InvocationOnMock invocationOnMock) throws Throwable {\n-                     capturedDeleteByQueryRequests.add((DeleteByQueryRequest) invocationOnMock.getArguments()[1]);\n-                     ActionListener<BulkByScrollResponse> listener =\n-                             (ActionListener<BulkByScrollResponse>) invocationOnMock.getArguments()[2];\n-                     listener.onResponse(null);\n-                     return null;\n-                 }\n-             }).when(client).execute(same(DeleteByQueryAction.INSTANCE), any(), any());\n+\n+        client = org.mockito.Mockito.mock(Client.class);", "originalCommit": "f31cf7e915966fbf9a1d4aac5a584094fddadf65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NjgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366396806", "bodyText": "Please remove blank line.", "author": "przemekwitek", "createdAt": "2020-01-14T15:16:48Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/test/MockOriginSettingClient.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.test;\n+\n+", "originalCommit": "f31cf7e915966fbf9a1d4aac5a584094fddadf65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NzM2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50981#discussion_r366397361", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return A OriginSettingClient using a mocked client\n          \n          \n            \n                 * @return An OriginSettingClient using a mocked client", "author": "przemekwitek", "createdAt": "2020-01-14T15:17:44Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/test/MockOriginSettingClient.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.test;\n+\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.mockito.Mockito;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * OriginSettingClient is a final class that cannot be mocked by mockito.\n+ * The solution is to wrap a non-mocked OriginSettingClient around a\n+ * mocked Client. All the mocking should take place on the client parameter.\n+ */\n+public class MockOriginSettingClient {\n+\n+    /**\n+     * Create a OriginSettingClient on a mocked client.\n+     *\n+     * @param client The mocked client\n+     * @param origin Whatever\n+     * @return A OriginSettingClient using a mocked client", "originalCommit": "f31cf7e915966fbf9a1d4aac5a584094fddadf65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9272b600570e5f4990f3b8b5e09ad134a1bfed0", "url": "https://github.com/elastic/elasticsearch/commit/c9272b600570e5f4990f3b8b5e09ad134a1bfed0", "message": "Explicitly require a OriginSettingClient in ML results iterators (#50802)\n\nIn classes where the client is used directly rather than through a call to \r\nexecuteAsyncWithOrigin explicitly require the client to be OriginSettingClient \r\nrather than using the Client interface. \r\n\r\nAlso remove calls to deprecated ClientHelper.clientWithOrigin() method.", "committedDate": "2020-01-14T15:39:34Z", "type": "commit"}, {"oid": "b32e20ca840e54813a2332857e3f220e5f1d59af", "url": "https://github.com/elastic/elasticsearch/commit/b32e20ca840e54813a2332857e3f220e5f1d59af", "message": "Mock settings", "committedDate": "2020-01-14T15:39:34Z", "type": "commit"}, {"oid": "8889922de279b1153f876a584b645491b6f3e1c4", "url": "https://github.com/elastic/elasticsearch/commit/8889922de279b1153f876a584b645491b6f3e1c4", "message": "Address review comments", "committedDate": "2020-01-14T15:39:34Z", "type": "commit"}, {"oid": "8889922de279b1153f876a584b645491b6f3e1c4", "url": "https://github.com/elastic/elasticsearch/commit/8889922de279b1153f876a584b645491b6f3e1c4", "message": "Address review comments", "committedDate": "2020-01-14T15:39:34Z", "type": "forcePushed"}]}