{"pr_number": 55873, "pr_title": "Save memory when numeric terms agg is not top", "pr_createdAt": "2020-04-28T16:30:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55873", "timeline": [{"oid": "45d04b2cd00c5798a24162ef4913d9dccb6ebe8c", "url": "https://github.com/elastic/elasticsearch/commit/45d04b2cd00c5798a24162ef4913d9dccb6ebe8c", "message": "Save memory when numeric terms agg is not top\n\nRight now all implementations of the `terms` agg allocate a new\n`Aggregator` per bucket. This uses a bunch of memory. Exactly how much\nisn't clear but each `Aggregator` ends up making its own objects to read\ndoc values which have non-trivial buffers. And it forces all of it\nsub-aggregations to do the same. We allocate a new `Aggregator` per\nbucket for two reasons:\n\n1. We didn't have an appropriate data structure to track the\n   sub-ordinals of each parent bucket.\n2. You can only make a single call to `runDeferredCollections(long...)`\n   per `Aggregator` which was the only way to delay collection of\n   sub-aggregations.\n\nThis change adds a way to return \"deferred\" aggregations from any\nbucket aggregation and undefers them as part of regular collections.\nThis mechanism allows you to defer without\n`runDeferredCollections(long...)`.\n\nThis change also adds a fairly simplistic data structure to track the\nsub-ordinals for `long`-keyed buckets.\n\nIt uses both of those to power numeric `terms` aggregations and removes\nthe per-bucket allocation of their `Aggregator`. This fairly\nsubstantially reduces memory consumption of numeric `terms` aggregations\nthat are not the \"top level\", especially when those aggregations contain\nmany sub-aggregations.\n\nI picked numeric `terms` aggregations because those have the simplest\nimplementation. At least, I could kind of fit it in my head. And I\nhaven't fully understood the \"bytes\"-based terms aggregations, but I\nimagine I'll be able to make similar optimizations to them in follow up\nchanges.", "committedDate": "2020-04-28T13:39:54Z", "type": "commit"}, {"oid": "f3d9476117ddfdfc9cf51df6cda84622ae992595", "url": "https://github.com/elastic/elasticsearch/commit/f3d9476117ddfdfc9cf51df6cda84622ae992595", "message": "Fix funny test", "committedDate": "2020-04-28T18:39:40Z", "type": "commit"}, {"oid": "3786e8ea7fc6759de29f8c70560af63a15ad4e27", "url": "https://github.com/elastic/elasticsearch/commit/3786e8ea7fc6759de29f8c70560af63a15ad4e27", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-04-28T18:39:56Z", "type": "commit"}, {"oid": "aad9c1a2adca61ea3469ebbcc82b82c5728d8e11", "url": "https://github.com/elastic/elasticsearch/commit/aad9c1a2adca61ea3469ebbcc82b82c5728d8e11", "message": "Oh rollup", "committedDate": "2020-04-28T21:07:31Z", "type": "commit"}, {"oid": "dcc76b971fcbd7a4478bdf1745777e3970112f7a", "url": "https://github.com/elastic/elasticsearch/commit/dcc76b971fcbd7a4478bdf1745777e3970112f7a", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-04-29T14:55:49Z", "type": "commit"}, {"oid": "9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d", "url": "https://github.com/elastic/elasticsearch/commit/9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-04-29T15:22:10Z", "type": "commit"}, {"oid": "9f29f36ebfc1a29cf27c0dc6c8c902b8d9d9cf6d", "url": "https://github.com/elastic/elasticsearch/commit/9f29f36ebfc1a29cf27c0dc6c8c902b8d9d9cf6d", "message": "WIP", "committedDate": "2020-04-29T19:18:46Z", "type": "commit"}, {"oid": "1f5ed9d33fc64d647e42904b17984578f0449dfb", "url": "https://github.com/elastic/elasticsearch/commit/1f5ed9d33fc64d647e42904b17984578f0449dfb", "message": "huh", "committedDate": "2020-04-30T19:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI2MzY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r418263649", "bodyText": "I can revert this.", "author": "nik9000", "createdAt": "2020-04-30T20:16:54Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalMultiBucketAggregation.java", "diffHunk": "@@ -158,19 +158,27 @@ public final InternalAggregation reducePipelines(\n \n     @Override\n     public InternalAggregation copyWithRewritenBuckets(Function<InternalAggregations, InternalAggregations> rewriter) {", "originalCommit": "1f5ed9d33fc64d647e42904b17984578f0449dfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22ad5c4c56c5cc9080fa9ee1b6e9a868a0b1099f", "url": "https://github.com/elastic/elasticsearch/commit/22ad5c4c56c5cc9080fa9ee1b6e9a868a0b1099f", "message": "Cleanup", "committedDate": "2020-05-03T16:29:53Z", "type": "commit"}, {"oid": "da4447601e8a5939a0fdd44b439784ed28f15482", "url": "https://github.com/elastic/elasticsearch/commit/da4447601e8a5939a0fdd44b439784ed28f15482", "message": "Drop docs change", "committedDate": "2020-05-03T17:06:19Z", "type": "commit"}, {"oid": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6", "url": "https://github.com/elastic/elasticsearch/commit/e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6", "message": "Doc method", "committedDate": "2020-05-03T17:21:03Z", "type": "commit"}, {"oid": "c8c83b80eced0169629706d8ef8bf159a1bb883b", "url": "https://github.com/elastic/elasticsearch/commit/c8c83b80eced0169629706d8ef8bf159a1bb883b", "message": "WIP", "committedDate": "2020-05-03T17:27:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzY3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r419133677", "bodyText": "This was missing from some work that I did previously and removing the wrapping of LongTermsAggregator revealed it.", "author": "nik9000", "createdAt": "2020-05-03T17:24:50Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -174,6 +373,9 @@ public Aggregator resolveSortPath(AggregationPath.PathElement next, Iterator<Agg\n \n     @Override\n     public BucketComparator bucketComparator(String key, SortOrder order) {\n+        if (false == this instanceof SingleBucketAggregator) {", "originalCommit": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r419133715", "bodyText": "Without this we get strange test failures around sorting.", "author": "nik9000", "createdAt": "2020-05-03T17:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzY3Nw=="}], "type": "inlineReview"}, {"oid": "1fedfd64286b171df219602f8942afab1e797033", "url": "https://github.com/elastic/elasticsearch/commit/1fedfd64286b171df219602f8942afab1e797033", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-05-03T21:55:50Z", "type": "commit"}, {"oid": "7ae83964d7865efebf22e7f3b06787fe5475e754", "url": "https://github.com/elastic/elasticsearch/commit/7ae83964d7865efebf22e7f3b06787fe5475e754", "message": "Remove useless method", "committedDate": "2020-05-04T13:15:38Z", "type": "commit"}, {"oid": "107c3b5597c787cdc233107133a394b6d8464cce", "url": "https://github.com/elastic/elasticsearch/commit/107c3b5597c787cdc233107133a394b6d8464cce", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-05-04T13:45:25Z", "type": "commit"}, {"oid": "e872b238774841974ccacbc7002e77422b869a90", "url": "https://github.com/elastic/elasticsearch/commit/e872b238774841974ccacbc7002e77422b869a90", "message": "Add tests for nested and reverse nested", "committedDate": "2020-05-04T15:06:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyNDc0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r417424747", "bodyText": "Can you add a comment regarding what the returned boolean means ?", "author": "jimczi", "createdAt": "2020-04-29T15:53:43Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -152,15 +152,53 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n     }\n \n     /**\n-     * Build an aggregation for data that has been collected into {@code bucket}.\n+     * Build an aggregation for data that has been collected into\n+     * {@code owningBucketOrd}.\n+     * <p>\n+     * Bucketing aggregations sometimes delay collecting their results if they\n+     * are selective (like {@code terms}) or if they aren't sure which buckets\n+     * their documents will ultimately fall into\n+     * (like {@code auto_date_histogram}). If they do so then anything they\n+     * return from this method can't be trusted. To turn them into \"real\"\n+     * results you have to make all of the calls to this method that you\n+     * will ever make, then call {@link #runDeferredCollections()}. If that\n+     * returns {@code true} then every aggregation will need to be rewritten\n+     * with {@code InternalAggregation#undefer()}. This entire dance is\n+     * generally accomplished by calling {@link #buildTopLevel()} on each top\n+     * level aggregator. \n      */\n-    public abstract InternalAggregation buildAggregation(long bucket) throws IOException;\n+    public abstract InternalAggregation buildAggregation(long owningBucketOrd) throws IOException;\n+\n+    /**\n+     * Build the result of this aggregation if it is on top level of the\n+     * aggregation tree, properly handling deferred collections. It is only\n+     * correct to call this on aggregations that <strong>are</strong> at the\n+     * top level of the aggregation tree. Calling it for other aggregations\n+     * will trip assertions or return the wrong result. Those aggregtions will\n+     * have {@link #buildAggregation(long)}, {@link #runDeferredCollections()}\n+     * and {@link InternalAggregation#undefer()} called by their parent\n+     * aggregations. \n+     */\n+    public final InternalAggregation buildTopLevel() throws IOException {\n+        assert parent() == null;\n+        InternalAggregation result = buildAggregation(0);\n+        if (runDeferredCollections()) {\n+            return result.undefer();\n+        }\n+        return result;\n+    }\n \n     /**\n      * Build an empty aggregation.\n      */\n     public abstract InternalAggregation buildEmptyAggregation();\n \n+    /**\n+     * Run any deferred collections that are required to\n+     * {@link InternalAggregation#undefer()} this aggregations's results.\n+     */\n+    public abstract boolean runDeferredCollections() throws IOException;", "originalCommit": "9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwODQ1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420408457", "bodyText": "++", "author": "nik9000", "createdAt": "2020-05-05T21:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyNDc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1NjAzOA==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420756038", "bodyText": "It turns out that this isn't needed any more. I've blasted it.", "author": "nik9000", "createdAt": "2020-05-06T12:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyNDc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDg5MA==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420370890", "bodyText": "Can we use aggregator.buildTopLevel() ?", "author": "jimczi", "createdAt": "2020-05-05T20:00:12Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationPhase.java", "diffHunk": "@@ -125,7 +125,7 @@ public void execute(SearchContext context) {\n         for (Aggregator aggregator : context.aggregations().aggregators()) {\n             try {\n                 aggregator.postCollection();\n-                aggregations.add(aggregator.buildAggregation(0));\n+                aggregations.add(aggregator.buildAggregations(new long[] {0})[0]);", "originalCommit": "e872b238774841974ccacbc7002e77422b869a90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQwODk3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420408973", "bodyText": "++", "author": "nik9000", "createdAt": "2020-05-05T21:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MjE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420372156", "bodyText": "I think we should do this on the same pr, otherwise we should add a no-release tag so that we don't forget to do it before a release.", "author": "jimczi", "createdAt": "2020-05-05T20:02:35Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -152,9 +152,43 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n     }\n \n     /**\n-     * Build an aggregation for data that has been collected into {@code bucket}.\n+     * Build an aggregation for data that has been collected into\n+     * {@code owningBucketOrd}.\n+     * @deprecated use {@link #buildAggregations(long[])} instead \n      */\n-    public abstract InternalAggregation buildAggregation(long bucket) throws IOException;\n+    @Deprecated\n+    public InternalAggregation buildAggregation(long owningBucketOrd) throws IOException {\n+        /*\n+         * Temporarily check if it looks like we're being called from a test\n+         * and try to answer with the top level agg. This just prevents us from\n+         * having to modify 1231234134124 tests in one PR.\n+         */", "originalCommit": "e872b238774841974ccacbc7002e77422b869a90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2OTIxNA==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420469214", "bodyText": "I agree here. I don't think the change to calling buildTopLevel() in all the tests will be too distracting", "author": "talevy", "createdAt": "2020-05-05T23:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MjE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3OTQ3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420479477", "bodyText": "", "author": "nik9000", "createdAt": "2020-05-06T00:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MjE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwOTM0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r421109345", "bodyText": "It was only about 40 places! I thought there were a couple hundred. Easy!", "author": "nik9000", "createdAt": "2020-05-06T21:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MjE1Ng=="}], "type": "inlineReview"}, {"oid": "651673c380c6192f1e8130b58feb999e7e1018b6", "url": "https://github.com/elastic/elasticsearch/commit/651673c380c6192f1e8130b58feb999e7e1018b6", "message": "Finish up", "committedDate": "2020-05-06T21:25:28Z", "type": "commit"}, {"oid": "5bb8098b4bec33475d2156e43baeec58349f542f", "url": "https://github.com/elastic/elasticsearch/commit/5bb8098b4bec33475d2156e43baeec58349f542f", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-05-06T21:38:55Z", "type": "commit"}, {"oid": "c7f7db0f2f55a57862e05ea906549cc05cd9466b", "url": "https://github.com/elastic/elasticsearch/commit/c7f7db0f2f55a57862e05ea906549cc05cd9466b", "message": "geo!", "committedDate": "2020-05-06T22:07:08Z", "type": "commit"}, {"oid": "67b0dda1033af295f2903b18ac87435434b13a42", "url": "https://github.com/elastic/elasticsearch/commit/67b0dda1033af295f2903b18ac87435434b13a42", "message": "Merge branch 'master' into sneaky_delay", "committedDate": "2020-05-08T17:17:36Z", "type": "commit"}, {"oid": "7f88ea81d5af81f0ad91c7e23c2b6db39ed3a692", "url": "https://github.com/elastic/elasticsearch/commit/7f88ea81d5af81f0ad91c7e23c2b6db39ed3a692", "message": "Explain", "committedDate": "2020-05-08T17:18:59Z", "type": "commit"}]}