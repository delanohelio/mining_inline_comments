{"pr_number": 64724, "pr_title": "Fix TaskIT", "pr_createdAt": "2020-11-06T15:10:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64724", "timeline": [{"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "url": "https://github.com/elastic/elasticsearch/commit/41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "message": "Fix TaskIT", "committedDate": "2020-11-06T14:40:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3NjkwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r518876909", "bodyText": "Should this get more than a 10s wait?", "author": "original-brownbear", "createdAt": "2020-11-06T16:51:24Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/MachineLearningIT.java", "diffHunk": "@@ -302,7 +306,18 @@ public void testDeleteJob_GivenWaitForCompletionIsFalse() throws Exception {\n         DeleteJobResponse response = execute(deleteJobRequest, machineLearningClient::deleteJob, machineLearningClient::deleteJobAsync);\n \n         assertNull(response.getAcknowledged());\n-        assertNotNull(response.getTask());\n+\n+        final TaskId taskId = response.getTask();\n+        assertNotNull(taskId);\n+\n+        // When wait_for_completion=false the DeleteJobAction stored the task result in the .tasks index. In tests we need to wait\n+        // for the delete job task to complete, otherwise the .tasks index could be created during the execution of a following test.\n+        final GetTaskRequest taskRequest = new GetTaskRequest(taskId.getNodeId(), taskId.getId());\n+        assertBusy(() -> {", "originalCommit": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk2NDU3NA==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r519964574", "bodyText": "Forgot this one, sorry. Yes, 30L sounds better suited.", "author": "tlrx", "createdAt": "2020-11-09T16:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3NjkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODE2OA==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r518878168", "bodyText": "One thing I don't fully understand is, how is this not caught by us ensure that no tasks are running after a test? Shouldn't this task show up in _cat/tasks and the wait we do here run there as a result?", "author": "original-brownbear", "createdAt": "2020-11-06T16:53:29Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/MachineLearningIT.java", "diffHunk": "@@ -302,7 +306,18 @@ public void testDeleteJob_GivenWaitForCompletionIsFalse() throws Exception {\n         DeleteJobResponse response = execute(deleteJobRequest, machineLearningClient::deleteJob, machineLearningClient::deleteJobAsync);\n \n         assertNull(response.getAcknowledged());\n-        assertNotNull(response.getTask());\n+\n+        final TaskId taskId = response.getTask();", "originalCommit": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyOTg0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r519629849", "bodyText": "The way the test works (before this PR) basically fire a job deletion and forgets about it. The delete job action is quite complicated and involves multiple steps, as well as storing the task result, so I suspect that at some point the task manager has no in-flight active tasks and allows to move to the next tests but the store result indexing task is not yet triggered (an registered) and is executed much later.", "author": "tlrx", "createdAt": "2020-11-09T08:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzMDM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r519630390", "bodyText": "(the test failure can be reproduced by executing the two tests one after the other)", "author": "tlrx", "createdAt": "2020-11-09T08:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc5MzYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r519793603", "bodyText": "The way the test works (before this PR) basically fire a job deletion and forgets about it. The delete job action is quite complicated and involves multiple steps, as well as storing the task result, so I suspect that at some point the task manager has no in-flight active tasks and allows to move to the next tests but the store result indexing task is not yet triggered (an registered) and is executed much later.\n\nGot it, that makes sense, thanks! I wonder if the temporary absence of any task should be interpreted as a bug ... regardless LGTM :)", "author": "original-brownbear", "createdAt": "2020-11-09T13:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODE2OA=="}], "type": "inlineReview"}, {"oid": "6d438d67e5b9c8593a1be01632aec1bf0d380023", "url": "https://github.com/elastic/elasticsearch/commit/6d438d67e5b9c8593a1be01632aec1bf0d380023", "message": "30s", "committedDate": "2020-11-09T16:53:32Z", "type": "commit"}, {"oid": "8416606fc85890b441dcd060317563bd3f57efe0", "url": "https://github.com/elastic/elasticsearch/commit/8416606fc85890b441dcd060317563bd3f57efe0", "message": "Merge branch 'master' into fix-64056", "committedDate": "2020-11-09T16:53:51Z", "type": "commit"}]}