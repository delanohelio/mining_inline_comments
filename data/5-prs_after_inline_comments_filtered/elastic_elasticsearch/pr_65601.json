{"pr_number": 65601, "pr_title": "Validate build hash in handshake", "pr_createdAt": "2020-11-30T13:23:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65601", "timeline": [{"oid": "a9c345d900af8101f3d8235967883e745fc89b22", "url": "https://github.com/elastic/elasticsearch/commit/a9c345d900af8101f3d8235967883e745fc89b22", "message": "Validate build hash in handshake\n\nThere is no guarantee of wire compatibility between nodes running\ndifferent builds of the same version, but today we do not validate\nwhether two communicating nodes are compatible or not. This results in\nconfusing failures that look like serialization bugs, and it usually\ntakes nontrivial effort to determine that the failure is in fact due to\nthe user running incompatible builds.\n\nThis commit adds the build hash to the transport service handshake and\nvalidates that matching versions have matching build hashes.\n\nCloses #65249", "committedDate": "2020-11-30T13:21:49Z", "type": "commit"}, {"oid": "c565f89d3fb27e8842c180e5b1f2094121fb7173", "url": "https://github.com/elastic/elasticsearch/commit/c565f89d3fb27e8842c180e5b1f2094121fb7173", "message": "Nit: only accept \"true\" for override property", "committedDate": "2020-11-30T14:10:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4MzM1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65601#discussion_r533583356", "bodyText": "NIT: maybe just put the logic in this method in a static { } block below these two constants to make this easier to read in one go?", "author": "original-brownbear", "createdAt": "2020-12-01T17:15:51Z", "path": "server/src/main/java/org/elasticsearch/transport/TransportService.java", "diffHunk": "@@ -73,10 +75,14 @@\n import java.util.function.Predicate;\n import java.util.function.Supplier;\n \n-public class TransportService extends AbstractLifecycleComponent implements ReportingService<TransportInfo>, TransportMessageListener,\n-    TransportConnectionListener {\n+public class TransportService extends AbstractLifecycleComponent\n+        implements ReportingService<TransportInfo>, TransportMessageListener, TransportConnectionListener {\n+\n     private static final Logger logger = LogManager.getLogger(TransportService.class);\n \n+    private static final String PERMIT_HANDSHAKES_FROM_INCOMPATIBLE_BUILDS_KEY = \"es.unsafely_permit_handshake_from_incompatible_builds\";\n+    private static final boolean PERMIT_HANDSHAKES_FROM_INCOMPATIBLE_BUILDS = getPermitHandshakesFromIncompatibleBuilds();", "originalCommit": "c565f89d3fb27e8842c180e5b1f2094121fb7173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwMzM1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65601#discussion_r533603355", "bodyText": "Ah yeah not sure why I didn't do that. Done in 8132bf3", "author": "DaveCTurner", "createdAt": "2020-12-01T17:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4MzM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4ODA4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65601#discussion_r533588083", "bodyText": "NIT: little much to log two messages for one thing? This seems like it's kind of a dev-only option anyway, why bother with the deprecation logger?", "author": "original-brownbear", "createdAt": "2020-12-01T17:22:30Z", "path": "server/src/main/java/org/elasticsearch/transport/TransportService.java", "diffHunk": "@@ -192,7 +205,14 @@ public TransportService(Settings settings, Transport transport, ThreadPool threa\n             false, false,\n             HandshakeRequest::new,\n             (request, channel, task) -> channel.sendResponse(\n-                new HandshakeResponse(localNode, clusterName, localNode.getVersion())));\n+                new HandshakeResponse(localNode.getVersion(), Build.CURRENT.hash(), localNode, clusterName)));\n+\n+        if (PERMIT_HANDSHAKES_FROM_INCOMPATIBLE_BUILDS) {\n+            logger.warn(\"transport handshakes from incompatible builds are unsafely permitted on this node; remove system property [\" +\n+                    PERMIT_HANDSHAKES_FROM_INCOMPATIBLE_BUILDS_KEY + \"] to resolve this warning\");\n+            DeprecationLogger.getLogger(TransportService.class).deprecate(\"permit_handshake_from_incompatible_builds\",", "originalCommit": "c565f89d3fb27e8842c180e5b1f2094121fb7173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwMjQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/65601#discussion_r533602450", "bodyText": "Ehh I worry we'll get people using this, and the two logs are for two separate aspects. Deprecation logs don't go into the main server log (by default at least) but I think this deserves a visible warning whenever it's used.", "author": "DaveCTurner", "createdAt": "2020-12-01T17:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4ODA4Mw=="}], "type": "inlineReview"}, {"oid": "8132bf33b0b889e84d601a18421fd894e0ed8e36", "url": "https://github.com/elastic/elasticsearch/commit/8132bf33b0b889e84d601a18421fd894e0ed8e36", "message": "Static constructor", "committedDate": "2020-12-01T17:41:38Z", "type": "commit"}]}