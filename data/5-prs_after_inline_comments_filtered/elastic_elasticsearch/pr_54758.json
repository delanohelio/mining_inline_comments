{"pr_number": 54758, "pr_title": "Reduce memory for big aggs run against many shards", "pr_createdAt": "2020-04-03T21:16:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54758", "timeline": [{"oid": "6b6debf81c41d01f26c228aec0c55fbeb770b354", "url": "https://github.com/elastic/elasticsearch/commit/6b6debf81c41d01f26c228aec0c55fbeb770b354", "message": "Reduce memory for big aggs run against many shards\n\nThis changes the behavior of aggregations when search is performed\nagainst enough shards to enable \"batch reduce\" mode. In this case we\nforce always store aggregations in serialized form rather than a\ntraditional java reference. This should shrink the memory usage of large\naggregations at the cost of slightly slowing down aggregations where the\ncoordinating node is also a data node. Because we're only doing this\nwhen there are many shards this is likely to be fairly rare.\n\nAs a side effect this lets us add logs for the memory usage of the aggs\nbuffer:\n```\n[2020-04-03T17:03:57,052][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [1320->448] max [1320]\n[2020-04-03T17:03:57,089][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [1328->448] max [1328]\n[2020-04-03T17:03:57,102][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [1328->448] max [1328]\n[2020-04-03T17:03:57,103][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [1328->448] max [1328]\n[2020-04-03T17:03:57,105][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs final reduction [888] max [1328]\n```\n\nThese are useful, but you need to keep some things in mind before\ntrusting them:\n1. The buffers are oversized ala Lucene's ArrayUtils. This means that we\n   are using more space than we need, but probably not much more.\n2. Before they are merged the aggregations are inflated into their\n   traditional Java objects which *probably* take up a lot more space\n   than the serialized form. That is, after all, the reason why we store\n   them in serialized form in the first place.\n\nAnd, just because I can, here is another example of the log:\n```\n[2020-04-03T17:06:18,731][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [147528->49176] max [147528]\n[2020-04-03T17:06:18,750][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [147528->49176] max [147528]\n[2020-04-03T17:06:18,809][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [147528->49176] max [147528]\n[2020-04-03T17:06:18,827][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs partial reduction [147528->49176] max [147528]\n[2020-04-03T17:06:18,829][TRACE][o.e.a.s.SearchPhaseController] [runTask-0] aggs final reduction [98352] max [147528]\n```\n\nI got that last one by building a ten shard index with a million docs in\nit and running a `sum` in three layers of `terms` aggregations, all on\n`long` fields, and with a `batched_reduce_size` of `3`.", "committedDate": "2020-04-03T21:13:47Z", "type": "commit"}, {"oid": "fbd62a096272821009c09fa2b43087807b0af321", "url": "https://github.com/elastic/elasticsearch/commit/fbd62a096272821009c09fa2b43087807b0af321", "message": "Merge branch 'master' into agg_memory", "committedDate": "2020-04-03T21:48:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Nzc0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r403387743", "bodyText": "I think I should add the task id to the output. That'd help a bit with debugging because setting the task manager to trace logging logs the query. Not that it is a good choice on a busy system, but it could be useful.\nI did look into returning this data in other ways but I couldn't come up with the \"right\" way. And it is super useful to be able to see the partial reduction memory usage. I mean, it'd probably be useful in production. But I think it'll be super useful for me when I'm just hacking on things.", "author": "nik9000", "createdAt": "2020-04-03T23:51:48Z", "path": "server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java", "diffHunk": "@@ -684,15 +697,21 @@ public void consumeResult(SearchPhaseResult result) {\n         private synchronized void consumeInternal(QuerySearchResult querySearchResult) {\n             if (querySearchResult.isNull() == false) {\n                 if (index == bufferSize) {\n+                    InternalAggregations reducedAggs = null;\n                     if (hasAggs) {\n                         List<InternalAggregations> aggs = new ArrayList<>(aggsBuffer.length);\n                         for (int i = 0; i < aggsBuffer.length; i++) {\n                             aggs.add(aggsBuffer[i].get());\n                             aggsBuffer[i] = null; // null the buffer so it can be GCed now.\n                         }\n-                        InternalAggregations reducedAggs = InternalAggregations.topLevelReduce(\n-                                aggs, aggReduceContextBuilder.forPartialReduction());\n-                        aggsBuffer[0] = () -> reducedAggs;\n+                        reducedAggs = InternalAggregations.topLevelReduce(aggs, aggReduceContextBuilder.forPartialReduction());\n+                        aggsBuffer[0] = DelayableWriteable.referencing(reducedAggs)\n+                                .asSerialized(InternalAggregations::new, namedWriteableRegistry);\n+                        long previousBufferSize = aggsCurrentBufferSize;\n+                        aggsMaxBufferSize = Math.max(aggsMaxBufferSize, aggsCurrentBufferSize);\n+                        aggsCurrentBufferSize = aggsBuffer[0].ramBytesUsed();\n+                        logger.trace(\"aggs partial reduction [{}->{}] max [{}]\",", "originalCommit": "4e2a0bf49e3faf98727c9cb6b92793d3a679321e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3MjY0NA==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r403472644", "bodyText": "Now that we have SearchProgressListener I think it'd make more sense to forward this information through that interface and have a default implementation that logs the reduction. That is a little more work but makes it so I can test that we make these calls in a sane way which is nice.", "author": "nik9000", "createdAt": "2020-04-04T13:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Nzc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r403478584", "bodyText": "Another option is to move this information into SearchTask so you can see it in the tasks API. That seems useful.", "author": "nik9000", "createdAt": "2020-04-04T14:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Nzc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzUzNzE5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r403537193", "bodyText": "On the other other hand maybe this is a good start and adding it to the SearchTask would be a good change for a follow up.", "author": "nik9000", "createdAt": "2020-04-04T22:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Nzc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU2Mzc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r405563748", "bodyText": "+1 to add in the SearchTask as a follow up", "author": "jimczi", "createdAt": "2020-04-08T14:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Nzc0Mw=="}], "type": "inlineReview"}, {"oid": "fbd62a096272821009c09fa2b43087807b0af321", "url": "https://github.com/elastic/elasticsearch/commit/fbd62a096272821009c09fa2b43087807b0af321", "message": "Merge branch 'master' into agg_memory", "committedDate": "2020-04-03T21:48:17Z", "type": "forcePushed"}, {"oid": "4118c6ccb0694cc6bd6260606853d52d1bb23981", "url": "https://github.com/elastic/elasticsearch/commit/4118c6ccb0694cc6bd6260606853d52d1bb23981", "message": "Merge branch 'master' into agg_memory", "committedDate": "2020-04-04T22:15:21Z", "type": "commit"}, {"oid": "155bb49f20464372b94b30c75154789ccf44adae", "url": "https://github.com/elastic/elasticsearch/commit/155bb49f20464372b94b30c75154789ccf44adae", "message": "Merge branch 'master' into agg_memory", "committedDate": "2020-04-08T13:07:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUxMzM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r405513341", "bodyText": "I talked to @jimczi and @javanna and this line is a release blocker. We're pretty ok merging it, but not releasing it. Because async_search keeps a hard reference to the aggs passed to it. Actually async search has all kinds of trouble with aggs because it doesn't perform the final reduction until sync search would. But it does return aggs without the final reduction applied if you get the \"progress\" of the search. These aggs are going to be \"funny\". They'll be missing pipeline aggs, for instant. And scripted_metric will be borked in some way. As will a lot of other things. But you'll mostly get something.", "author": "nik9000", "createdAt": "2020-04-08T13:12:38Z", "path": "server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java", "diffHunk": "@@ -705,12 +724,13 @@ private synchronized void consumeInternal(QuerySearchResult querySearchResult) {\n                     index = 1;\n                     if (hasAggs || hasTopDocs) {\n                         progressListener.notifyPartialReduce(SearchProgressListener.buildSearchShards(processedShards),\n-                            topDocsStats.getTotalHits(), hasAggs ? aggsBuffer[0].get() : null, numReducePhases);\n+                            topDocsStats.getTotalHits(), reducedAggs, numReducePhases);", "originalCommit": "155bb49f20464372b94b30c75154789ccf44adae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyOTg2MA==", "url": "https://github.com/elastic/elasticsearch/pull/54758#discussion_r405529860", "bodyText": "Actually async search has all kinds of trouble with aggs because it doesn't perform the final reduction until sync search would. But it does return aggs without the final reduction applied if you get the \"progress\" of the search. These aggs are going to be \"funny\". They'll be missing pipeline aggs, for instant. And scripted_metric will be borked in some way. As will a lot of other things. But you'll mostly get something.\n\nScratch that - it does perform the final reduction when you fetch the result. You could still get weird results because things are missing, but they'll be a lot less weird than I was thinking.", "author": "nik9000", "createdAt": "2020-04-08T13:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUxMzM0MQ=="}], "type": "inlineReview"}]}