{"pr_number": 64884, "pr_title": "Don't keep track of field aliases separately in FieldTypeLookup", "pr_createdAt": "2020-11-10T17:32:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64884", "timeline": [{"oid": "fff36206c5faf007934b0601e535de8832d18d99", "url": "https://github.com/elastic/elasticsearch/commit/fff36206c5faf007934b0601e535de8832d18d99", "message": "Don't keep track of field aliases in FieldTypeLookup\n\nWe currently keep track of field aliases which causes us to do two lookups for every field lookup. Instead, we could keep track of field aliases in the same map where ordinary fields are, by adding an entry that has the name of the field alias, and its corresponding field type is the field that that the alias points to.", "committedDate": "2020-11-10T17:30:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4MDkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/64884#discussion_r520780914", "bodyText": "I think we can extend this to DynamicKeyFieldTypeLookup as well?  Rather than passing the whole alias map, just check for each alias path to see if it matches an existing entry in the dynamicKeyMappers map, and if it does, add a new entry with the alias path and the original dynamic mapper.", "author": "romseygeek", "createdAt": "2020-11-10T18:32:53Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -70,10 +69,12 @@\n             }\n         }\n \n+        final Map<String, String> aliasToConcreteName = new HashMap<>();\n         for (FieldAliasMapper fieldAliasMapper : fieldAliasMappers) {\n             String aliasName = fieldAliasMapper.name();\n             String path = fieldAliasMapper.path();\n             aliasToConcreteName.put(aliasName, path);\n+            fullNameToFieldType.put(aliasName, fullNameToFieldType.get(path));\n         }\n \n         this.dynamicKeyLookup = new DynamicKeyFieldTypeLookup(dynamicKeyMappers, aliasToConcreteName);", "originalCommit": "fff36206c5faf007934b0601e535de8832d18d99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc5OTA2MA==", "url": "https://github.com/elastic/elasticsearch/pull/64884#discussion_r520799060", "bodyText": "I was a bit nervous about adapting DynamicKeyFieldTypeLookup, I did not find a straight-forward replacement for the map, and I am happy to look as a followup", "author": "javanna", "createdAt": "2020-11-10T18:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4MDkxNA=="}], "type": "inlineReview"}]}