{"pr_number": 59530, "pr_title": "Check for ml privilege when using the Inference Aggregation", "pr_createdAt": "2020-07-14T12:52:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59530", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MzA2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454343062", "bodyText": "Does this stop really high privilege users from using inference?  For example, the actions permitted by manage_ml are a subset of those permitted by manage (which means manage everything except security), but literally checking for manage_ml might not return true for a user who has manage.  I may be wrong as I haven't tested it, but it seems likely that the security code will resolve high level cluster privilege names to sets of actions they allow, but not to other high level cluster privilege names.\nYou could check for just GetTrainedModelsAction.NAME here instead to solve that potential problem and also make the later code simpler as you'll only be testing for one privilege:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n          \n          \n            \n                                privRequest.clusterPrivileges(GetTrainedModelsAction.NAME);", "author": "droberts195", "createdAt": "2020-07-14T13:08:53Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");", "originalCommit": "d0cdf0af596975ac32b45490f8ddeb6876467530", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2MTQ4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454361482", "bodyText": "Yes that works", "author": "davidkyle", "createdAt": "2020-07-14T13:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MzA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTE4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454345185", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n          \n          \n            \n                                                    \"to use ml inference\"));\n          \n          \n            \n                                                \"user [\" + username + \"] does not have the privilege to get trained models \" +\n          \n          \n            \n                                                    \"so cannot use ml inference\"));", "author": "droberts195", "createdAt": "2020-07-14T13:12:19Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});\n+                    privRequest.applicationPrivileges(new RoleDescriptor.ApplicationResourcePrivileges[]{});\n+\n+                    ActionListener<HasPrivilegesResponse> privResponseListener = ActionListener.wrap(\n+                        r -> {\n+                            if (hasMlPrivilege(r)) {\n+                                modelLoadAction.accept(client, listener);\n+                            } else {\n+                                listener.onFailure(Exceptions.authorizationError(\n+                                    \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n+                                        \"to use ml inference\"));", "originalCommit": "d0cdf0af596975ac32b45490f8ddeb6876467530", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NzA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454347058", "bodyText": "This method won't be needed if just checking one privilege.", "author": "droberts195", "createdAt": "2020-07-14T13:15:14Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});\n+                    privRequest.applicationPrivileges(new RoleDescriptor.ApplicationResourcePrivileges[]{});\n+\n+                    ActionListener<HasPrivilegesResponse> privResponseListener = ActionListener.wrap(\n+                        r -> {\n+                            if (hasMlPrivilege(r)) {\n+                                modelLoadAction.accept(client, listener);\n+                            } else {\n+                                listener.onFailure(Exceptions.authorizationError(\n+                                    \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n+                                        \"to use ml inference\"));\n+                            }\n+                        },\n+                        listener::onFailure);\n+\n+                    client.execute(HasPrivilegesAction.INSTANCE, privRequest, privResponseListener);\n+                });\n+            } else {\n+                modelLoadAction.accept(client, listener);\n+            }\n         });\n         return new InferencePipelineAggregationBuilder(name, bucketPathMap, loadedModel::get, modelId, inferenceConfig, licenseState);\n     }\n \n+    static boolean hasMlPrivilege(HasPrivilegesResponse privilegesResponse) {", "originalCommit": "d0cdf0af596975ac32b45490f8ddeb6876467530", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MTQ4OA==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454391488", "bodyText": "nit: space after equals", "author": "dimitris-athanasiou", "createdAt": "2020-07-14T14:19:35Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,6 +211,37 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());", "originalCommit": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MTg1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454391856", "bodyText": "Ah, nice! That's what to use when in need to return more than a single thing. I'll use that onwards!", "author": "dimitris-athanasiou", "createdAt": "2020-07-14T14:20:04Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -186,8 +197,9 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n         if (model != null) {\n             return this;\n         }\n+\n         SetOnce<LocalModel> loadedModel = new SetOnce<>();\n-        context.registerAsyncAction((client, listener) -> {\n+        BiConsumer<Client, ActionListener<?>> modelLoadAction = (client, listener) ->", "originalCommit": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454392567", "bodyText": "Do we need to set index and application privileges even though they're empty?", "author": "dimitris-athanasiou", "createdAt": "2020-07-14T14:21:04Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,6 +211,37 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(GetTrainedModelsAction.NAME);\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});", "originalCommit": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2NzgxMA==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454467810", "bodyText": "Yes because of this validation\nhttps://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/user/HasPrivilegesRequest.java#L46", "author": "davidkyle", "createdAt": "2020-07-14T16:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454394137", "bodyText": "Isn't this the same as doing if (mapOfMaps.contains(key)) return true; ?", "author": "dimitris-athanasiou", "createdAt": "2020-07-14T14:23:14Z", "path": "x-pack/plugin/ml/qa/ml-with-security/src/test/java/org/elasticsearch/smoketest/MlWithSecurityInsufficientRoleIT.java", "diffHunk": "@@ -60,5 +80,27 @@ public void test() throws IOException {\n     protected String[] getCredentials() {\n         return new String[]{\"no_ml\", \"x-pack-test-password\"};\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    static boolean containsKey(String key, Map<String, Object> mapOfMaps) {\n+        Set<String> keys = mapOfMaps.keySet();\n+        for (String keyEntry : keys) {", "originalCommit": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2ODAwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454468001", "bodyText": "Ha yeah that might be a simpler way of doing it", "author": "davidkyle", "createdAt": "2020-07-14T16:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDEzNw=="}], "type": "inlineReview"}, {"oid": "638d6be064a4ca035af9cc5158a99a046e83a943", "url": "https://github.com/elastic/elasticsearch/commit/638d6be064a4ca035af9cc5158a99a046e83a943", "message": "Check for ml privilege when using the Inference Aggregation", "committedDate": "2020-07-14T16:21:31Z", "type": "commit"}, {"oid": "7e708ff66552b4286175c828b3789db5173be6a6", "url": "https://github.com/elastic/elasticsearch/commit/7e708ff66552b4286175c828b3789db5173be6a6", "message": "checkstyle", "committedDate": "2020-07-14T16:21:31Z", "type": "commit"}, {"oid": "ddfe3709a7f040ba08e09fc19a5aae491da8c935", "url": "https://github.com/elastic/elasticsearch/commit/ddfe3709a7f040ba08e09fc19a5aae491da8c935", "message": "simply privilege check and change message", "committedDate": "2020-07-14T16:21:31Z", "type": "commit"}, {"oid": "d091c278d5fd55f5aa62f76d621eec4606e2278a", "url": "https://github.com/elastic/elasticsearch/commit/d091c278d5fd55f5aa62f76d621eec4606e2278a", "message": "Address review comments", "committedDate": "2020-07-14T16:21:31Z", "type": "commit"}, {"oid": "d091c278d5fd55f5aa62f76d621eec4606e2278a", "url": "https://github.com/elastic/elasticsearch/commit/d091c278d5fd55f5aa62f76d621eec4606e2278a", "message": "Address review comments", "committedDate": "2020-07-14T16:21:31Z", "type": "forcePushed"}, {"oid": "965d4beacca935f2d45f2178ae321d388afadec6", "url": "https://github.com/elastic/elasticsearch/commit/965d4beacca935f2d45f2178ae321d388afadec6", "message": "adjust for error message getting wrapped", "committedDate": "2020-07-14T18:19:43Z", "type": "commit"}]}