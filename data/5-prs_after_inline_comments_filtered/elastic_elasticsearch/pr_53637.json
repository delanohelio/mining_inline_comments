{"pr_number": 53637, "pr_title": "Use set-based interface for NodesStatsRequest", "pr_createdAt": "2020-03-16T21:56:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53637", "timeline": [{"oid": "0e5ac6e12331acbc773c7ba2f5dea97a767be54d", "url": "https://github.com/elastic/elasticsearch/commit/0e5ac6e12331acbc773c7ba2f5dea97a767be54d", "message": "Add set-based interface for NodesStatsRequest", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "60f8ec664cf23f3d304b43586723136782c11724", "url": "https://github.com/elastic/elasticsearch/commit/60f8ec664cf23f3d304b43586723136782c11724", "message": "Remove unused imports", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "ed0d521bae8c6d5684102f67e486c54703fee9a7", "url": "https://github.com/elastic/elasticsearch/commit/ed0d521bae8c6d5684102f67e486c54703fee9a7", "message": "Add set-based checks to NodesStatsRequestTests", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "12131cdd0ff29d15c833094169d2468867d1a22a", "url": "https://github.com/elastic/elasticsearch/commit/12131cdd0ff29d15c833094169d2468867d1a22a", "message": "Remove old setters from RestNodesStatsAction", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "476f32f7f0a801e080911b90f3da2f82493fc24b", "url": "https://github.com/elastic/elasticsearch/commit/476f32f7f0a801e080911b90f3da2f82493fc24b", "message": "Remove old setters from NodesStatsRequestBuilder", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "27be1a77e4b9f09eac68de7c0ec0087f13a16eef", "url": "https://github.com/elastic/elasticsearch/commit/27be1a77e4b9f09eac68de7c0ec0087f13a16eef", "message": "Remove old getters from TransportNodesStatsAction", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "b17c48a89a1d85d302368031b931341f2da73e9f", "url": "https://github.com/elastic/elasticsearch/commit/b17c48a89a1d85d302368031b931341f2da73e9f", "message": "Remove old getters and setters from tests", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "4efb83c9051ef33f630620bc18517f00531db1c8", "url": "https://github.com/elastic/elasticsearch/commit/4efb83c9051ef33f630620bc18517f00531db1c8", "message": "Remove old getters from NodesStatsRequest", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "61b1215ed6939eeb4f35be7c47b7c9795116ab4c", "url": "https://github.com/elastic/elasticsearch/commit/61b1215ed6939eeb4f35be7c47b7c9795116ab4c", "message": "Remove redundant setter", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "69819c5db1e2b2d8870bfd47d5b5bdc32a45bc8f", "url": "https://github.com/elastic/elasticsearch/commit/69819c5db1e2b2d8870bfd47d5b5bdc32a45bc8f", "message": "Replace various uses of old metric setters", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "c362d49d205295266759eafd0fe597f9d383475d", "url": "https://github.com/elastic/elasticsearch/commit/c362d49d205295266759eafd0fe597f9d383475d", "message": "Remove old metric setters from NodesStatsRequest", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "d06e74f808d655b9bb793625f8f53a0776b7e1d1", "url": "https://github.com/elastic/elasticsearch/commit/d06e74f808d655b9bb793625f8f53a0776b7e1d1", "message": "Make setter variatic instead of set-based", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "9ff0b532361100dbc946297b6c4b6c7722afb377", "url": "https://github.com/elastic/elasticsearch/commit/9ff0b532361100dbc946297b6c4b6c7722afb377", "message": "Add test for exceptions", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "da864a4b1c99115db83b27dca0462994d2c58cf3", "url": "https://github.com/elastic/elasticsearch/commit/da864a4b1c99115db83b27dca0462994d2c58cf3", "message": "Move metric list into stats request", "committedDate": "2020-03-16T20:41:43Z", "type": "commit"}, {"oid": "a743ad8f32d2c3470353d1a37c64f761bdf96391", "url": "https://github.com/elastic/elasticsearch/commit/a743ad8f32d2c3470353d1a37c64f761bdf96391", "message": "Rename deserialization helper method", "committedDate": "2020-03-16T21:35:40Z", "type": "commit"}, {"oid": "dc37c4b3b1d022d0907dbdff0de7fef714e3d744", "url": "https://github.com/elastic/elasticsearch/commit/dc37c4b3b1d022d0907dbdff0de7fef714e3d744", "message": "Update javadoc", "committedDate": "2020-03-16T21:36:15Z", "type": "commit"}, {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "url": "https://github.com/elastic/elasticsearch/commit/cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "message": "Slight refactor", "committedDate": "2020-03-16T21:57:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Mzg5MA==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396693890", "bodyText": "Could we simplify this by using Set.containsAll? Essentially this:\nSet<String> metricsSet = new TreeSet<>(metrics);\nif (Metric.allMetrics().containsAll(metricSet) == false) {\n    Set<String> illegalMetrics = metricsSet.removaAll(Metric.allMetrics());\n    // throw\n}\nrequestMetrics.addAll(metricsSet);", "author": "rjernst", "createdAt": "2020-03-23T19:12:41Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -114,178 +130,65 @@ public NodesStatsRequest indices(boolean indices) {\n     }\n \n     /**\n-     * Should the node OS be returned.\n-     */\n-    public boolean os() {\n-        return Metric.OS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node OS be returned.\n-     */\n-    public NodesStatsRequest os(boolean os) {\n-        addOrRemoveMetric(os, Metric.OS.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node Process be returned.\n-     */\n-    public boolean process() {\n-        return Metric.PROCESS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Process be returned.\n-     */\n-    public NodesStatsRequest process(boolean process) {\n-        addOrRemoveMetric(process, Metric.PROCESS.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node JVM be returned.\n+     * Get the names of requested metrics, excluding indices, which are\n+     * handled separately.\n      */\n-    public boolean jvm() {\n-        return Metric.JVM.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node JVM be returned.\n-     */\n-    public NodesStatsRequest jvm(boolean jvm) {\n-        addOrRemoveMetric(jvm, Metric.JVM.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node Thread Pool be returned.\n-     */\n-    public boolean threadPool() {\n-        return Metric.THREAD_POOL.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Thread Pool be returned.\n-     */\n-    public NodesStatsRequest threadPool(boolean threadPool) {\n-        addOrRemoveMetric(threadPool, Metric.THREAD_POOL.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node file system stats be returned.\n-     */\n-    public boolean fs() {\n-        return Metric.FS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node file system stats be returned.\n-     */\n-    public NodesStatsRequest fs(boolean fs) {\n-        addOrRemoveMetric(fs, Metric.FS.metricName());\n-        return this;\n+    public Set<String> requestedMetrics() {\n+        return Set.copyOf(requestedMetrics);\n     }\n \n     /**\n-     * Should the node Transport be returned.\n+     * Add metric\n      */\n-    public boolean transport() {\n-        return Metric.TRANSPORT.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Transport be returned.\n-     */\n-    public NodesStatsRequest transport(boolean transport) {\n-        addOrRemoveMetric(transport, Metric.TRANSPORT.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node HTTP be returned.\n-     */\n-    public boolean http() {\n-        return Metric.HTTP.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node HTTP be returned.\n-     */\n-    public NodesStatsRequest http(boolean http) {\n-        addOrRemoveMetric(http, Metric.HTTP.metricName());\n-        return this;\n-    }\n-\n-    public boolean breaker() {\n-        return Metric.BREAKER.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node's circuit breaker stats be returned.\n-     */\n-    public NodesStatsRequest breaker(boolean breaker) {\n-        addOrRemoveMetric(breaker, Metric.BREAKER.metricName());\n-        return this;\n-    }\n-\n-    public boolean script() {\n-        return Metric.SCRIPT.containedIn(requestedMetrics);\n-    }\n-\n-    public NodesStatsRequest script(boolean script) {\n-        addOrRemoveMetric(script, Metric.SCRIPT.metricName());\n-        return this;\n-    }\n-\n-\n-    public boolean discovery() {\n-        return Metric.DISCOVERY.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node's discovery stats be returned.\n-     */\n-    public NodesStatsRequest discovery(boolean discovery) {\n-        addOrRemoveMetric(discovery, Metric.DISCOVERY.metricName());\n+    public NodesStatsRequest addMetric(String metric) {\n+        if (Metric.allMetrics().contains(metric) == false) {\n+            throw new IllegalStateException(\"Used an illegal metric: \" + metric);\n+        }\n+        requestedMetrics.add(metric);\n         return this;\n     }\n \n-    public boolean ingest() {\n-        return Metric.INGEST.containedIn(requestedMetrics);\n-    }\n-\n     /**\n-     * Should ingest statistics be returned.\n+     * Add an array of metric names\n      */\n-    public NodesStatsRequest ingest(boolean ingest) {\n-        addOrRemoveMetric(ingest, Metric.INGEST.metricName());\n+    public NodesStatsRequest addMetrics(String... metrics) {\n+        // use sorted set for reliable ordering in error messages\n+        SortedSet<String> illegalMetrics = new TreeSet<>();\n+        Set<String> validMetrics = new HashSet<>();\n+        for (String metric : metrics) {\n+            if (Metric.allMetrics().contains(metric)) {", "originalCommit": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwNzE0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396707143", "bodyText": "Ah, that looks better. I'll do this.", "author": "williamrandolph", "createdAt": "2020-03-23T19:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Mzg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Nzc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396697761", "bodyText": "Why is this moved to here? It seems like an implementation detail that should stay in the stats action. The request should be a opaque list of strings?", "author": "rjernst", "createdAt": "2020-03-23T19:19:36Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -311,11 +214,20 @@ public void writeTo(StreamOutput out) throws IOException {\n         }\n     }\n \n+    public static Map<String, Consumer<NodesStatsRequest>> getDispatchMap() {", "originalCommit": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMDQzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396700435", "bodyText": "Can you elaborate on why this might need to be removed?", "author": "rjernst", "createdAt": "2020-03-23T19:24:28Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -327,15 +239,15 @@ public void writeTo(StreamOutput out) throws IOException {\n         SCRIPT(\"script\"),\n         DISCOVERY(\"discovery\"),\n         INGEST(\"ingest\"),\n-        ADAPTIVE_SELECTION(\"adaptiveSelection\");\n+        ADAPTIVE_SELECTION(\"adaptiveSelection\"); // TODO: Should this be removed?", "originalCommit": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMTYwNA==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396731604", "bodyText": "It definitely doesn't need to be removed. I'll remove the TODO, which was a reminder for me to look into it.", "author": "williamrandolph", "createdAt": "2020-03-23T20:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMDQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMjM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396732346", "bodyText": "Oh, darn. I do need to change it to adaptive_selection, though.", "author": "williamrandolph", "createdAt": "2020-03-23T20:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMDQzNQ=="}], "type": "inlineReview"}, {"oid": "d083ede3220e4b475c6b38d839e30821cf9fcfac", "url": "https://github.com/elastic/elasticsearch/commit/d083ede3220e4b475c6b38d839e30821cf9fcfac", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor", "committedDate": "2020-03-23T19:49:02Z", "type": "commit"}, {"oid": "b877f9fa29ff1a92a1d684fb027686af8b3205c9", "url": "https://github.com/elastic/elasticsearch/commit/b877f9fa29ff1a92a1d684fb027686af8b3205c9", "message": "Simplify set-checking logic.", "committedDate": "2020-03-23T20:23:25Z", "type": "commit"}, {"oid": "25a06b596f66e98e79425910ebc16e5eda97bd1b", "url": "https://github.com/elastic/elasticsearch/commit/25a06b596f66e98e79425910ebc16e5eda97bd1b", "message": "Move dispatch map and change token for adaptive selection", "committedDate": "2020-03-23T20:29:57Z", "type": "commit"}, {"oid": "03d1f0d595549ec13666565a858b081355344d77", "url": "https://github.com/elastic/elasticsearch/commit/03d1f0d595549ec13666565a858b081355344d77", "message": "Remove unused imports", "committedDate": "2020-03-23T21:11:21Z", "type": "commit"}, {"oid": "e88027c6dc2529452005fb05dba849b4e2e7aa95", "url": "https://github.com/elastic/elasticsearch/commit/e88027c6dc2529452005fb05dba849b4e2e7aa95", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor", "committedDate": "2020-03-25T01:10:16Z", "type": "commit"}, {"oid": "982cb768fa9afdcb0aefa89290bf9cfbebbdd946", "url": "https://github.com/elastic/elasticsearch/commit/982cb768fa9afdcb0aefa89290bf9cfbebbdd946", "message": "Disable bwc tests", "committedDate": "2020-03-25T01:39:43Z", "type": "commit"}, {"oid": "c55cdaf7eb9aa0655d47f4d4f7a6ffa35bf381a8", "url": "https://github.com/elastic/elasticsearch/commit/c55cdaf7eb9aa0655d47f4d4f7a6ffa35bf381a8", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor", "committedDate": "2020-03-25T11:17:00Z", "type": "commit"}]}