{"pr_number": 55158, "pr_title": "Don't expand default_field in query_string before required", "pr_createdAt": "2020-04-14T14:21:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55158", "timeline": [{"oid": "7710744d0d37f208dd0244ba7addf120b18c8cbc", "url": "https://github.com/elastic/elasticsearch/commit/7710744d0d37f208dd0244ba7addf120b18c8cbc", "message": "Don't expand default_field in query_string before required\n\nCurrently QueryStringQueryParser already checks if the field limit is breached\nat construction time, which e.g. leads to errors if the default field is set to\n\"*\" or the default is used and there are more fields than the limit, even if the\nquery itself does not use all these fields.\nThis change moves this check to happen after query parsing. QueryStringQueryParser now\nkeeps track of the fields that are actually resolved while parsing. The size of\nthat set is later used to check against the limit set by the\n`indices.query.bool.max_clause_count` setting.\n\nCloses #53789", "committedDate": "2020-04-14T14:00:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410112455", "bodyText": "I don't think this is needed. We can check the limit in QueryStringQueryParser#extractMultiFields, which is called every time we parse a block.", "author": "jimczi", "createdAt": "2020-04-17T09:42:21Z", "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -97,6 +100,9 @@\n     private MultiTermQuery.RewriteMethod fuzzyRewriteMethod;\n     private boolean fuzzyTranspositions = FuzzyQuery.defaultTranspositions;\n \n+    // set of field names this parser targets, used to check limits on expanded field names\n+    private Set<String> queriedFields = new HashSet<>();", "originalCommit": "7710744d0d37f208dd0244ba7addf120b18c8cbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzNTIwNg==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410135206", "bodyText": "My understanding might be off here, but my assumption was that \"extractMultiFields\" gets called for every block, so e.g. for a query string like \"f1:foo f2:bar f3:baz\" it gets called three different times for one field each call. In order to get the number of fields really queried we'd need to at least have a counter somewhere, and in oder to check for duplicates (e.g. \"f1:foo f1:bar f2:baz\" which should only count for two fields) we'd need something to store the field names already used. This is why I introduced this string set here thats filled with each call to extractMultiFields. Does this make sense or what am I missing?", "author": "cbuescher", "createdAt": "2020-04-17T10:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzOTE4OA==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410139188", "bodyText": "I see what you mean but I am not sure that we need to sum all fields. We want to check the limit on each block eagerly, not the total of clauses.", "author": "jimczi", "createdAt": "2020-04-17T10:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5MDM5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410190391", "bodyText": "Ok, just to re-check my understanding, because I might have thought about a different goal in this fix. Assuming we have indices.query.bool.max_clause_count set to 50 and query string like \"foo*:somevalue bar*:otherValue\", and both expressions expand to 40 mapped fields, would we want to accept or reject that? In the end we are targetting 80 fields, so my assumption was that we'd want to sum here, but I'm also fine with another interpretation. Although that can easily lead to the number of fields that are hit by a search can be much larger than the limit?", "author": "cbuescher", "createdAt": "2020-04-17T12:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5Nzk1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410197957", "bodyText": "The goal of this change is to only check the limit per block. So in your case, if the limit is 50 then the parsing would not throw any error since all blocks are within the limit.", "author": "jimczi", "createdAt": "2020-04-17T12:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwMjU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410202569", "bodyText": "Thanks for the clarification, this is indeed different from what I was aiming at. I will adapt the approach and the testing consequently.", "author": "cbuescher", "createdAt": "2020-04-17T12:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMzcwNA==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410113704", "bodyText": "This is not enough, we should check every field expansion not just the last one (when extractMultiFields is called).", "author": "jimczi", "createdAt": "2020-04-17T09:44:48Z", "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -789,6 +798,8 @@ public Query parse(String query) throws ParseException {\n         if (query.trim().isEmpty()) {\n             return Queries.newMatchNoDocsQuery(\"Matching no documents because no terms present\");\n         }\n-        return super.parse(query);\n+        Query result = super.parse(query);\n+        checkForTooManyFields(this.queriedFields.size(), this.context);", "originalCommit": "7710744d0d37f208dd0244ba7addf120b18c8cbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1OTEzOA==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410159138", "bodyText": "My hope with putting this check later here was that we can report something close to the real number of fields used in the query to the user with the error message. I had the check in extractMultiFields earlier but then we throw an error whenever the parsing process exceeds the limit. I was looking for a way to get a more accurate could of the total number of used fields, but I see now that this is too late here. Need to rethink this a bit and adapt tests.", "author": "cbuescher", "createdAt": "2020-04-17T11:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMzcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE5ODg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410198846", "bodyText": "If we do that, I'd prefer to do it in a follow up since that would be breaking (we don't check the sum of unique fields at the moment). Lucene 9 will also check the number of clauses globally so this is probably not needed to implement such checks at this level.", "author": "jimczi", "createdAt": "2020-04-17T12:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMzcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwMzIzOA==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410203238", "bodyText": "Agreed, if there are other clause checks internal to Lucene this isn't needed. I thought it was achievable but see how thats not the case now.", "author": "cbuescher", "createdAt": "2020-04-17T12:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMzcwNA=="}], "type": "inlineReview"}, {"oid": "2086f49b8c6feef30abcb7586cee24a9efeb26c6", "url": "https://github.com/elastic/elasticsearch/commit/2086f49b8c6feef30abcb7586cee24a9efeb26c6", "message": "Merge branch 'master' into fix-53789", "committedDate": "2020-04-17T09:57:59Z", "type": "commit"}, {"oid": "8606ae4cd0102e5b73d8f2da336162c1541acbb4", "url": "https://github.com/elastic/elasticsearch/commit/8606ae4cd0102e5b73d8f2da336162c1541acbb4", "message": "Check field expansion once per block", "committedDate": "2020-04-17T16:23:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MTM2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410341365", "bodyText": "Just out of curiosity: this test shows what to me is a bit counter-intuitive. When we check breaching the limit once per expansion but not in its sum we can easily hit more than indices.query.bool.max_clause_count with a query.", "author": "cbuescher", "createdAt": "2020-04-17T16:40:27Z", "path": "server/src/test/java/org/elasticsearch/search/query/QueryStringIT.java", "diffHunk": "@@ -324,6 +292,74 @@ public void testLimitOnExpandedFieldsButIgnoreUnmappedFields() throws Exception\n         client().prepareSearch(\"ignoreunmappedfields\").setQuery(qb).get();\n     }\n \n+    public void testLimitOnExpandedFields() throws Exception {\n+        XContentBuilder builder = jsonBuilder();\n+        builder.startObject();\n+        {\n+            builder.startObject(\"_doc\");\n+            {\n+                builder.startObject(\"properties\");\n+                {\n+                    for (int i = 0; i < CLUSTER_MAX_CLAUSE_COUNT; i++) {\n+                        builder.startObject(\"field_A\" + i).field(\"type\", \"text\").endObject();\n+                        builder.startObject(\"field_B\" + i).field(\"type\", \"text\").endObject();\n+                    }\n+                    builder.endObject();\n+                }\n+                builder.endObject();\n+            }\n+            builder.endObject();\n+        }\n+\n+        assertAcked(prepareCreate(\"testindex\")\n+                .setSettings(Settings.builder().put(MapperService.INDEX_MAPPING_TOTAL_FIELDS_LIMIT_SETTING.getKey(),\n+                        CLUSTER_MAX_CLAUSE_COUNT + 100))\n+                .setMapping(builder));\n+\n+        client().prepareIndex(\"testindex\").setId(\"1\").setSource(\"field_A0\", \"foo bar baz\").get();\n+        refresh();\n+\n+        // single field shouldn't trigger the limit\n+        doAssertOneHitForQueryString(\"field_A0:foo\");\n+        // expanding to the limit should work\n+        doAssertOneHitForQueryString(\"field_A\\\\*:foo\");\n+        // expanding two blocks to the limit still works\n+        doAssertOneHitForQueryString(\"field_A\\\\*:foo field_B\\\\*:bar\");", "originalCommit": "8606ae4cd0102e5b73d8f2da336162c1541acbb4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3f310fe1bee4187a7b06195d01fb5179382d193", "url": "https://github.com/elastic/elasticsearch/commit/c3f310fe1bee4187a7b06195d01fb5179382d193", "message": "Merge branch 'master' into fix-53789", "committedDate": "2020-04-17T17:00:51Z", "type": "commit"}]}