{"pr_number": 64423, "pr_title": "Allow registering compatible handlers", "pr_createdAt": "2020-10-30T16:01:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64423", "timeline": [{"oid": "e468fdf350c54bcfd63ee9a1f221232478c111bc", "url": "https://github.com/elastic/elasticsearch/commit/e468fdf350c54bcfd63ee9a1f221232478c111bc", "message": "Introduce per endpoint media types", "committedDate": "2020-10-30T09:28:47Z", "type": "commit"}, {"oid": "5cfa11e9db3416a4f7920806977f1333b1c837fa", "url": "https://github.com/elastic/elasticsearch/commit/5cfa11e9db3416a4f7920806977f1333b1c837fa", "message": "Merge branch 'master' into compat/parsed_media_type", "committedDate": "2020-10-30T09:45:06Z", "type": "commit"}, {"oid": "66224e74f5ede806080c282914870ebac7a8c508", "url": "https://github.com/elastic/elasticsearch/commit/66224e74f5ede806080c282914870ebac7a8c508", "message": "allow smile and cbor to parse charset param. See ClientYamlTestExecutionContext:L122", "committedDate": "2020-10-30T10:14:20Z", "type": "commit"}, {"oid": "29b27e805f8e31f7b2e21cd54ae9a2342d9398aa", "url": "https://github.com/elastic/elasticsearch/commit/29b27e805f8e31f7b2e21cd54ae9a2342d9398aa", "message": "javadocs", "committedDate": "2020-10-30T12:37:26Z", "type": "commit"}, {"oid": "46903625a056c3f615d0c593370e3c442b1a99b5", "url": "https://github.com/elastic/elasticsearch/commit/46903625a056c3f615d0c593370e3c442b1a99b5", "message": "fix javadoc", "committedDate": "2020-10-30T12:42:38Z", "type": "commit"}, {"oid": "e7866a982d18f3beecc26a217b600f0fc96ba110", "url": "https://github.com/elastic/elasticsearch/commit/e7866a982d18f3beecc26a217b600f0fc96ba110", "message": "Allow registration of compatible version-1 handlers", "committedDate": "2020-10-30T15:59:56Z", "type": "commit"}, {"oid": "0330d97d2c3722f09530e2ab0546d738981536ef", "url": "https://github.com/elastic/elasticsearch/commit/0330d97d2c3722f09530e2ab0546d738981536ef", "message": "add tests", "committedDate": "2020-11-02T12:27:48Z", "type": "commit"}, {"oid": "78d46603e02134a026b95ac48bfb76704a998e1c", "url": "https://github.com/elastic/elasticsearch/commit/78d46603e02134a026b95ac48bfb76704a998e1c", "message": "Merge branch 'master' into compat/register_compatible_handlers", "committedDate": "2020-11-02T15:00:13Z", "type": "commit"}, {"oid": "bc5de8b5c53664ab70e3e0c45342ea7b3af7398b", "url": "https://github.com/elastic/elasticsearch/commit/bc5de8b5c53664ab70e3e0c45342ea7b3af7398b", "message": "pass version to xcontentbuilder", "committedDate": "2020-11-02T15:19:00Z", "type": "commit"}, {"oid": "f958cdd0d4e1118048051bf20dd7748f517f34bc", "url": "https://github.com/elastic/elasticsearch/commit/f958cdd0d4e1118048051bf20dd7748f517f34bc", "message": "Merge branch 'master' into compat/register_compatible_handlers", "committedDate": "2020-11-02T16:47:19Z", "type": "commit"}, {"oid": "2bda74f773d6b682deaa0c256a3568cbc0c1956c", "url": "https://github.com/elastic/elasticsearch/commit/2bda74f773d6b682deaa0c256a3568cbc0c1956c", "message": "code review follow up", "committedDate": "2020-11-03T12:15:42Z", "type": "commit"}, {"oid": "7779083b4e5ed3301bd75bfc340bff51bae2042c", "url": "https://github.com/elastic/elasticsearch/commit/7779083b4e5ed3301bd75bfc340bff51bae2042c", "message": "minor tweaks", "committedDate": "2020-11-03T12:52:14Z", "type": "commit"}, {"oid": "dd26408343b5633d4981d15207c5a714a8a44e7e", "url": "https://github.com/elastic/elasticsearch/commit/dd26408343b5633d4981d15207c5a714a8a44e7e", "message": "Merge branch 'master' into compat/introduce_per_endpoint_media_types", "committedDate": "2020-11-03T12:52:41Z", "type": "commit"}, {"oid": "94b4a0a85ece16e597818e815d958675e5879125", "url": "https://github.com/elastic/elasticsearch/commit/94b4a0a85ece16e597818e815d958675e5879125", "message": "fix test after exception msg rename", "committedDate": "2020-11-03T13:41:27Z", "type": "commit"}, {"oid": "43855911ed3ec0ad1d245cc398e7d67f59acb975", "url": "https://github.com/elastic/elasticsearch/commit/43855911ed3ec0ad1d245cc398e7d67f59acb975", "message": "rename to header value", "committedDate": "2020-11-03T15:30:35Z", "type": "commit"}, {"oid": "dc61731ba05c6d2338ff46cf3f3bf665b334c525", "url": "https://github.com/elastic/elasticsearch/commit/dc61731ba05c6d2338ff46cf3f3bf665b334c525", "message": "remove charset validation", "committedDate": "2020-11-04T09:24:25Z", "type": "commit"}, {"oid": "4a3138dd46c7826e902f0375e2a61d5aef036c70", "url": "https://github.com/elastic/elasticsearch/commit/4a3138dd46c7826e902f0375e2a61d5aef036c70", "message": "Apply suggestions from code review\n\nCo-authored-by: Jay Modi <jaymode@users.noreply.github.com>", "committedDate": "2020-11-05T07:33:33Z", "type": "commit"}, {"oid": "0b565e566cfb0555b25d02e082105bb482e7e6fd", "url": "https://github.com/elastic/elasticsearch/commit/0b565e566cfb0555b25d02e082105bb482e7e6fd", "message": "javadoc", "committedDate": "2020-11-05T08:02:03Z", "type": "commit"}, {"oid": "b35ad2ce54f0577edd332d8ebedb4fa817475e71", "url": "https://github.com/elastic/elasticsearch/commit/b35ad2ce54f0577edd332d8ebedb4fa817475e71", "message": "Merge branch 'master' into compat/introduce_per_endpoint_media_types", "committedDate": "2020-11-05T08:02:35Z", "type": "commit"}, {"oid": "b908bfebd14c7157aeb7592f17c4907d8e9c6a7f", "url": "https://github.com/elastic/elasticsearch/commit/b908bfebd14c7157aeb7592f17c4907d8e9c6a7f", "message": "Merge branch 'compat/introduce_per_endpoint_media_types' of github.com:pgomulka/elasticsearch into compat/introduce_per_endpoint_media_types", "committedDate": "2020-11-05T08:03:20Z", "type": "commit"}, {"oid": "950ba7b922b323db01e225855604f90d8dcc5286", "url": "https://github.com/elastic/elasticsearch/commit/950ba7b922b323db01e225855604f90d8dcc5286", "message": "Merge branch 'compat/introduce_per_endpoint_media_types' into compat/register_compatible_handlers", "committedDate": "2020-11-05T08:50:14Z", "type": "commit"}, {"oid": "310b735cbeecb65ee6e212ea46d655948236269a", "url": "https://github.com/elastic/elasticsearch/commit/310b735cbeecb65ee6e212ea46d655948236269a", "message": "Merge branch 'master' into compat/register_compatible_handlers", "committedDate": "2020-11-05T08:51:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r517918932", "bodyText": "I really can't remember the use cases where we needed this. (returning a v8 handler when a handler was not present in v7)\n@jaymode   made a comment about this when we were still working on a feature branch https://github.com/elastic/elasticsearch/pull/54197/files#r414959451", "author": "pgomulka", "createdAt": "2020-11-05T09:47:19Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +58,16 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Returns the handler for the given method and version or {@code null} if none exists.\n      */\n-    @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+        if (versionToHandlers == null) {\n+            return null; //method not found\n+        }\n+        final RestHandler handler = versionToHandlers.get(version);\n+        return handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);", "originalCommit": "310b735cbeecb65ee6e212ea46d655948236269a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MjEwMg==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518882102", "bodyText": "I think the reason for this is @Mpdreamz's comment #60516 (comment) where clients plan to send compatible with to all APIs. If this is the case, can we please document this in code/method so we do not lose the information", "author": "jaymode", "createdAt": "2020-11-06T17:00:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NjUwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518966505", "bodyText": "I had to think about this waaay to long :) and wrote a unit test to help me understand\n    /**\n     * We want clients to be able to request compatibility with a prior version for all APIs. If a there does not exist a handler registered\n     * for the prior version, we want to return the current version handler. This effectively means that the current endpoint is compatible\n     * with the prior version, which should be true since if it were not compatible there would be a registered compatible endpoint.\n     */\n    public void testMissingPriorHandlerReturnsCurrentHandler(){\n        RestHandler currentVersionHandler = new CurrentVersionHandler();\n        MethodHandlers methodHandlers = new MethodHandlers(\"path\", currentVersionHandler, RestRequest.Method.PUT, RestRequest.Method.POST);\n        RestHandler handler = methodHandlers.getHandler(RestRequest.Method.PUT, Version.CURRENT.previousMajor());\n        assertThat(handler, sameInstance(currentVersionHandler));\n    }\n\nCan you add a similar comment inline here, and add that test?", "author": "jakelandis", "createdAt": "2020-11-06T19:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MTI5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518971297", "bodyText": "The return can be simplified to:\n        return handler == null ? versionToHandlers.get(Version.CURRENT) : handler;\n\nwith a test:\n    public void testMissingCurrentHandler(){\n        RestHandler previousVersionHandler = new PreviousVersionHandler();\n        MethodHandlers methodHandlers = new MethodHandlers(\"path\", previousVersionHandler, RestRequest.Method.PUT, RestRequest.Method.POST);\n        RestHandler handler = methodHandlers.getHandler(RestRequest.Method.PUT, Version.CURRENT);\n        assertNull(handler);\n    }", "author": "jakelandis", "createdAt": "2020-11-06T19:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc1NDk3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519754971", "bodyText": "to be fair, I am not super convinced about returning the CURRENT.\nif an endpoint did not exist in v7 server version, client would be getting 404 when trying to access it with v7 client.\nWhen he upgrades server to next version and he still uses v7 client, I guess he should be still getting 404?\n@jakelandis I am not sure I understand this:\n\nThis effectively means that the current endpoint is compatible\n* with the prior version, which should be true since if it were not compatible there would be a registered compatible endpoint.\n\nfrom high level point of view, there is no knowledge if there is a compatible endpoint or not. If the handler's code did not change, user has no idea that a response came from v7 code, or if the response is compatible shape from v8 (in ideal 100% compatible handler).\nTHe same for when an endpoint do not exist. Returning 404 from v8 when for not existing in v7 endpoint is 100% compatible in shape and behaviour\n@Mpdreamz any views on this?", "author": "pgomulka", "createdAt": "2020-11-09T11:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg0MDkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519840920", "bodyText": "I think we should return new APIs with compatible requested. Below is a table with my thought for how behaviour should look.\nThe rationale is that in a minor you can add a new API passively, therefor new APIs are compatible (as opposed to non-compatible/breaking). Further, one motivation to add a new API is to replace an old one. With a client sending compatibility all the time, they should be able to fix the compatibility warnings and migrate to the new API. This allows them to do just that.\n\n\n\nscenario\nv7\nv8\nv7 compat / v8 server result\n\n\n\n\nnew in v8\n404\n200\n200 (v8)\n\n\nno change/compat change in v8 (no compat handler)\n200\n200\n200 (v8)\n\n\nremoved in v8 (with compat handler)\n200\n404\n200 (v7)\n\n\nnon passive change (with compat handler)\n200\n200\n200 (v7)", "author": "jakelandis", "createdAt": "2020-11-09T14:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1OTYzMA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519859630", "bodyText": "The rationale is that in a minor you can add a new API passively, therefor new APIs are compatible (as opposed to non-compatible/breaking)\n\ngreat explanation. thank you. I think this was the initial reason we went for that behaviour on a feature branch. I will add a comment about this at least in a test", "author": "pgomulka", "createdAt": "2020-11-09T14:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkwMDQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519900432", "bodyText": "Since clients generate methods for known API's the only way to talk to an API that exists in 8.0 but not (yet) in 7.x is to call transport.Request(url)\nI think the new in v8 case needs some zooming in on:\nnew in v8\n\n\n\naccept/content-type\nv7 compat / v8 server result\n\n\n\n\napplication/json\napplication/json\n\n\napplication/vnd.elasticsearch+json;compatible-with=8\napplication/vnd.elasticsearch+json;compatible-with=8\n\n\napplication/vnd.elasticsearch+json;compatible-with=7\n?\n\n\n\nThe first two seem straight forward the last one not so much It could return a\n\n404, since thats what it did in 7\n200 with application/vnd.elasticsearch+json;compatible-with=7.\n200 with application/vnd.elasticsearch+json;compatible-with=8.\n\nReturning with compatible-with=8 is not what the user requested so seems like an unexpected return.\nReturning with compatible-with=7 since its a new API it can be argued anything is compatible with 7. But this will become a pain to track when e.g a new API gets introduced in 8.0 as experimental and GA's in 8.4.  You potentially get back two different 7 responses for 8.0 and 8.4.\nThat leaves returning a 404.\ncc @elastic/es-clients we have not discussed if the the transport used in the client should default to application/vnd.elasticsearch+json;compatible-with=7 or application/json. I feel that if the transport defaults to application/json but the API methods calling the transport default to the vendor mime type the client user has the least suprises.", "author": "Mpdreamz", "createdAt": "2020-11-09T15:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ1MTgzNw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520451837", "bodyText": "I think with the current approach where we version compatible API per major we won't be able to give a 100% experience of previous version server. And that wasn't a goal - after all we want to achieve the compatible API, not the versioned one.\nI feel all the comments from this \"thread\" are valid and I will summarise them on a separate issue.\nThe current implementation is not returning the right response header yet, so the discussion on new in v8 could continue on the new issue.\nLets use this issue to facilitate the discussion #64852", "author": "pgomulka", "createdAt": "2020-11-10T10:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}], "type": "inlineReview"}, {"oid": "afba70d3cd862b7b3a83536381bf32e5cea575e6", "url": "https://github.com/elastic/elasticsearch/commit/afba70d3cd862b7b3a83536381bf32e5cea575e6", "message": "javadoc and cleanup", "committedDate": "2020-11-05T09:57:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwOTM1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518409358", "bodyText": "not sure i follow the second sentence (Intended to be ...)", "author": "jakelandis", "createdAt": "2020-11-05T22:30:21Z", "path": "server/src/main/java/org/elasticsearch/rest/CompatibleVersion.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+\n+/**\n+ * An interface used to specify a function that returns a compatible API version\n+ * Intended to be used in a code base instead of a plugin.", "originalCommit": "afba70d3cd862b7b3a83536381bf32e5cea575e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NTAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518585018", "bodyText": "right.. I rephrased this, but maybe it is still to vague. let me know\nMy intention was to not describe the actual plugin implementation, but just to mention that this abstract the way we actually provide the logic.\nIt happens that we use a plugin for this, but could if we want to use any class within a server to do this as well (we did in the previous attempts)", "author": "pgomulka", "createdAt": "2020-11-06T08:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwOTM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxNTY0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518415647", "bodyText": "Can you a few unit tests for this class ?", "author": "jakelandis", "createdAt": "2020-11-05T22:44:42Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +31,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version, RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, Version version,  RestRequest.Method... methods) {", "originalCommit": "afba70d3cd862b7b3a83536381bf32e5cea575e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4NTE2MA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518585160", "bodyText": "I also realised that changing the method signature was not necessary.", "author": "pgomulka", "createdAt": "2020-11-06T08:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxNTY0Nw=="}], "type": "inlineReview"}, {"oid": "385f5a9a7538dc44a7052c1c029ac24c70dd20ce", "url": "https://github.com/elastic/elasticsearch/commit/385f5a9a7538dc44a7052c1c029ac24c70dd20ce", "message": "Merge branch 'master' into compat/register_compatible_handlers", "committedDate": "2020-11-06T06:59:03Z", "type": "commit"}, {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "url": "https://github.com/elastic/elasticsearch/commit/836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "message": "tests and javadoc", "committedDate": "2020-11-06T08:09:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Mjk0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518882947", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){\n          \n          \n            \n                public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion) {", "author": "jaymode", "createdAt": "2020-11-06T17:01:30Z", "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,15 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MzU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518883553", "bodyText": "can you add javadocs to this method and the one above?", "author": "jaymode", "createdAt": "2020-11-06T17:02:40Z", "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,15 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){\n+        this.compatibleMajorVersion = compatibleMajorVersion;\n+        return this;\n+    }\n+\n+    public byte getCompatibleMajorVersion() {", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NDAzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518884033", "bodyText": "hmm, I wonder if we should make this a SetOnce or add validation that if it is not some sentinel value that it cannot be changed again? I'm not sure that I like it being mutable with a builder pattern and allowing it to be set multiple times", "author": "jaymode", "createdAt": "2020-11-06T17:03:37Z", "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -48,6 +48,8 @@\n  */\n public final class XContentBuilder implements Closeable, Flushable {\n \n+    private byte compatibleMajorVersion;", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxNTM3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519715376", "bodyText": "with a regular builder pattern I would be ok with the field being mutable, as it is normally used within some narrow code scope.\nWith XContentBuilder we often pass it around so makes sense to protect against some accidental changes.\nI feel like we should assert about this in testing only though.\nI added assert", "author": "pgomulka", "createdAt": "2020-11-09T10:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NDAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTczMg==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885732", "bodyText": "hmm, should we make this non-static like minimumCompatibilityVersion and minimumIndexCompatibilityVersion? Also, please add javadocs :)", "author": "jaymode", "createdAt": "2020-11-06T17:06:42Z", "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -268,6 +269,15 @@ private static Version fromStringSlow(String version) {\n         this.build = (byte) (id % 100);\n         this.luceneVersion = Objects.requireNonNull(luceneVersion);\n         this.toString = major + \".\" + minor + \".\" + revision;\n+        this.previousMajorId = major > 0 ? (major - 1) * 1000000 + 99 : major;\n+    }\n+\n+    public Version previousMajor() {\n+        return Version.fromId(previousMajorId);\n+    }\n+\n+    public static Version minimumRestCompatibilityVersion() {", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTgxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885815", "bodyText": "javadocs please", "author": "jaymode", "createdAt": "2020-11-06T17:06:52Z", "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -268,6 +269,15 @@ private static Version fromStringSlow(String version) {\n         this.build = (byte) (id % 100);\n         this.luceneVersion = Objects.requireNonNull(luceneVersion);\n         this.toString = major + \".\" + minor + \".\" + revision;\n+        this.previousMajorId = major > 0 ? (major - 1) * 1000000 + 99 : major;\n+    }\n+\n+    public Version previousMajor() {", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTk5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885995", "bodyText": "Suggested change", "author": "jaymode", "createdAt": "2020-11-06T17:07:08Z", "path": "server/src/main/java/org/elasticsearch/node/Node.java", "diffHunk": "@@ -539,9 +540,11 @@ protected Node(final Environment initialEnvironment,\n                                                  repositoriesServiceReference::get).stream())\n                 .collect(Collectors.toList());\n \n+", "originalCommit": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f2ea927874ce0e737322b6cfc9f348e1f31fa5b", "url": "https://github.com/elastic/elasticsearch/commit/8f2ea927874ce0e737322b6cfc9f348e1f31fa5b", "message": "javadoc", "committedDate": "2020-11-09T12:05:40Z", "type": "commit"}, {"oid": "d70a0712bc4578e4351e6deb29a6adbb60fd69b6", "url": "https://github.com/elastic/elasticsearch/commit/d70a0712bc4578e4351e6deb29a6adbb60fd69b6", "message": "do not set compatible version twice", "committedDate": "2020-11-09T12:13:22Z", "type": "commit"}, {"oid": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34", "url": "https://github.com/elastic/elasticsearch/commit/87d762f66c418dd238fc1c02d7f7bafc7de0bb34", "message": "Merge branch 'master' into compat/register_compatible_handlers", "committedDate": "2020-11-09T13:12:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg0NTcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519845713", "bodyText": "I am not sure i understand the purpose of this comment here.", "author": "jakelandis", "createdAt": "2020-11-09T14:17:02Z", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -242,7 +250,11 @@ private void dispatchRequest(RestRequest request, RestChannel channel, RestHandl\n                 inFlightRequestsBreaker(circuitBreakerService).addWithoutBreaking(contentLength);\n             }\n             // iff we could reserve bytes for the request we need to send the response also over this channel\n-            responseChannel = new ResourceHandlingHttpChannel(channel, circuitBreakerService, contentLength);\n+            // Using a version from a handler because if no handler was found for requested version,", "originalCommit": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3MzgxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519873813", "bodyText": "my intention was to indicate that even if you requested an applicaiton/vnd.elasticsearch+json;compatible-with=7 but the handler did not exist in 7, the actual resthandler will be used from v8.\nbut that indeed makes no difference, as there would be no compatible serialisation code.\nRemoved the comment.", "author": "pgomulka", "createdAt": "2020-11-09T14:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg0NTcxMw=="}], "type": "inlineReview"}, {"oid": "deff73987b4db898044e43ffae89a02a2ac66b2e", "url": "https://github.com/elastic/elasticsearch/commit/deff73987b4db898044e43ffae89a02a2ac66b2e", "message": "javadocs", "committedDate": "2020-11-09T15:06:50Z", "type": "commit"}, {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "url": "https://github.com/elastic/elasticsearch/commit/4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "message": "Merge remote-tracking branch 'upstream/master' into compat/register_compatible_handlers", "committedDate": "2020-11-10T08:13:25Z", "type": "commit"}, {"oid": "a38ed04c7f9440b72c82eee801c64367fc3c8c17", "url": "https://github.com/elastic/elasticsearch/commit/a38ed04c7f9440b72c82eee801c64367fc3c8c17", "message": "Merge remote-tracking branch 'upstream/master' into compat/register_compatible_handlers", "committedDate": "2020-11-10T15:52:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NDA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520674079", "bodyText": "this assertion is incorrect as it is asserting on the value passed into the method and not the value in the builder.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assert compatibleMajorVersion != 0 : \"Compatible version has already been set\";\n          \n          \n            \n                    assert this.compatibleMajorVersion == 0 : \"Compatible version has already been set\";\n          \n          \n            \n                    if (compatibleMajorVersion == 0) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"Compatible major version must not be equal to 0\");\n          \n          \n            \n                    }", "author": "jaymode", "createdAt": "2020-11-10T15:57:18Z", "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,22 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    /**\n+     * Sets a version used for serialising a response compatible with a previous version.\n+     */\n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion) {\n+        assert compatibleMajorVersion != 0 : \"Compatible version has already been set\";", "originalCommit": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NTU0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520675540", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String toString;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                private final String toString;\n          \n      \n    \n    \n  \n\nThis is a nit but it helps my eyes read the code better when public values are kept together.", "author": "jaymode", "createdAt": "2020-11-10T15:59:06Z", "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -259,6 +259,7 @@ private static Version fromStringSlow(String version) {\n     public final byte build;\n     public final org.apache.lucene.util.Version luceneVersion;\n     private final String toString;\n+    public final int previousMajorId;", "originalCommit": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NjU0OA==", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520676548", "bodyText": "Or you could make value private, which I'd prefer\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String toString;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                private final String toString;\n          \n          \n            \n                private final int previousMajorId;", "author": "jaymode", "createdAt": "2020-11-10T16:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NTU0MA=="}], "type": "inlineReview"}, {"oid": "c39d0bb6e0b1428736b05c0cde01be02598f2252", "url": "https://github.com/elastic/elasticsearch/commit/c39d0bb6e0b1428736b05c0cde01be02598f2252", "message": "Apply suggestions from code review\n\nCo-authored-by: Jay Modi <jaymode@users.noreply.github.com>", "committedDate": "2020-11-10T16:44:09Z", "type": "commit"}, {"oid": "09704f3aa459dcfcdc547279931fc432a44f0c80", "url": "https://github.com/elastic/elasticsearch/commit/09704f3aa459dcfcdc547279931fc432a44f0c80", "message": "Merge branch 'compat/register_compatible_handlers' of github.com:pgomulka/elasticsearch into compat/register_compatible_handlers", "committedDate": "2020-11-10T16:45:20Z", "type": "commit"}, {"oid": "023c8d992d6853b2fa4a3eda248654cb82cee701", "url": "https://github.com/elastic/elasticsearch/commit/023c8d992d6853b2fa4a3eda248654cb82cee701", "message": "xcontentbuilder has the version requested by a user", "committedDate": "2020-11-10T16:47:12Z", "type": "commit"}]}