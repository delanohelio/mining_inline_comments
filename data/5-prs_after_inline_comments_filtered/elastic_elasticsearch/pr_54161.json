{"pr_number": 54161, "pr_title": "Clean up how pipeline aggs check for multi-bucket", "pr_createdAt": "2020-03-25T10:33:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54161", "timeline": [{"oid": "7e14dd54bde6b7cebe1dc73f2a05a064919b71ce", "url": "https://github.com/elastic/elasticsearch/commit/7e14dd54bde6b7cebe1dc73f2a05a064919b71ce", "message": "Clean up how pipeline aggs check for multi-bucket\n\nPipeline aggregations like `stats_bucket`, `sum_bucket`, and\n`percentiles_bucket` only operate on buckets that have multiple buckets.\nThis adds support for those aggregations to `geo_distance`, `ip_range`,\n`auto_date_histogram`, and `rare_terms`.\n\nThis all happened because we used a marker interface to mark compatible\naggs, `MultiBucketAggregationBuilder` and it was fairly easy to forget\nto implement the interface.\n\nThis replaces the marker interface with an abstract method in\n`AggregationBuilder`, `bucketCardinality` which makes you return `NONE`,\n`ONE`, or `MANY`. The `bucket` aggregations can check for `MANY`. At\nthis point `ONE` and `NONE` amount to about the same thing, but I\nsuspect that'll be a useful distinction when validating bucket sorts.\n\nCloses #53215", "committedDate": "2020-03-25T10:26:51Z", "type": "commit"}, {"oid": "af76a7f415a958e151dbd40b0b5d7a441b9787b9", "url": "https://github.com/elastic/elasticsearch/commit/af76a7f415a958e151dbd40b0b5d7a441b9787b9", "message": "Merge branch 'master' into agg_multi_validation", "committedDate": "2020-03-25T13:32:54Z", "type": "commit"}, {"oid": "660e5acb59c3a2c28afb874d49e34afda2238885", "url": "https://github.com/elastic/elasticsearch/commit/660e5acb59c3a2c28afb874d49e34afda2238885", "message": "Update skips", "committedDate": "2020-03-25T13:34:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyMzA4NA==", "url": "https://github.com/elastic/elasticsearch/pull/54161#discussion_r399423084", "bodyText": "Yeah... I wonder if we should set this to NONE for the time being, to prevent people from accidentally using pipelines on composite?  There's an issue flying around somewhere discussing it... but last time we chatted, we decided to punt on the decision.  Some pipelines are theoretically safe (bucket_script, operating on the bucket itself), but others like derivative are totally not kosher.", "author": "polyfractal", "createdAt": "2020-03-27T17:21:32Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregationBuilder.java", "diffHunk": "@@ -147,6 +147,15 @@ public int size() {\n         return size;\n     }\n \n+    @Override\n+    public BucketCardinality bucketCardinality() {\n+        /*\n+         * This might be a bit of a lie though because you can't really use\n+         * pipeline aggregations on composite aggregations.\n+         */\n+        return BucketCardinality.MANY;", "originalCommit": "660e5acb59c3a2c28afb874d49e34afda2238885", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyOTA4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54161#discussion_r399429087", "bodyText": "Yeah. Composite is a weird beast.", "author": "nik9000", "createdAt": "2020-03-27T17:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyMzA4NA=="}], "type": "inlineReview"}, {"oid": "93951b1eabd43444d398e6a57313b142507835ce", "url": "https://github.com/elastic/elasticsearch/commit/93951b1eabd43444d398e6a57313b142507835ce", "message": "Merge branch 'master' into agg_multi_validation", "committedDate": "2020-03-27T19:53:05Z", "type": "commit"}, {"oid": "97c642aeac3b99a06d2c3a1658a81533ff90af70", "url": "https://github.com/elastic/elasticsearch/commit/97c642aeac3b99a06d2c3a1658a81533ff90af70", "message": "Merge branch 'master' into agg_multi_validation", "committedDate": "2020-03-28T11:51:47Z", "type": "commit"}, {"oid": "b3fcbba508469d8022182979683b5df2845e3f6d", "url": "https://github.com/elastic/elasticsearch/commit/b3fcbba508469d8022182979683b5df2845e3f6d", "message": "Nope", "committedDate": "2020-03-28T11:55:54Z", "type": "commit"}]}