{"pr_number": 59366, "pr_title": "Reduce merge map memory overhead in the Variable Width Histogram Aggregation", "pr_createdAt": "2020-07-10T22:26:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59366", "timeline": [{"oid": "4c706833645f769e8a432708c37d24a96717b5a3", "url": "https://github.com/elastic/elasticsearch/commit/4c706833645f769e8a432708c37d24a96717b5a3", "message": "Convert merge map to a UnaryOperator in VWH", "committedDate": "2020-07-10T22:02:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDA0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453354047", "bodyText": "I think you could write this:\nmergeBuckets(newNumbBuckets, buck -> mergeMap[Math.toIntExact(bucket)]);", "author": "nik9000", "createdAt": "2020-07-12T19:28:25Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -107,15 +108,33 @@ public final void collectExistingBucket(LeafBucketCollector subCollector, int do\n      * Refer to that method for documentation about the merge map.\n      */\n     public final void mergeBuckets(long[] mergeMap, long newNumBuckets) {\n+        UnaryOperator<Long> mergeMapOperator = new UnaryOperator<Long>() {\n+            @Override\n+            public Long apply(Long bucket) {\n+                return mergeMap[Math.toIntExact(bucket)];\n+            }\n+        };\n+\n+        mergeBuckets(mergeMapOperator, newNumBuckets);", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDI4OA==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453354288", "bodyText": "Two things, only one is important though:\n\nCould you replace UnaryOperator<Long> with LongUnaryOperator? That'll prevent auto-boxing of the parameter.\nCould you switch the order of the arguments? I think the call sites are a little prettier when the \"function\" argument is last, if possible.", "author": "nik9000", "createdAt": "2020-07-12T19:30:50Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -107,15 +108,33 @@ public final void collectExistingBucket(LeafBucketCollector subCollector, int do\n      * Refer to that method for documentation about the merge map.\n      */\n     public final void mergeBuckets(long[] mergeMap, long newNumBuckets) {\n+        UnaryOperator<Long> mergeMapOperator = new UnaryOperator<Long>() {\n+            @Override\n+            public Long apply(Long bucket) {\n+                return mergeMap[Math.toIntExact(bucket)];\n+            }\n+        };\n+\n+        mergeBuckets(mergeMapOperator, newNumBuckets);\n+    }\n+\n+    /**\n+     * This only tidies up doc counts. Call {@link MergingBucketsDeferringCollector#mergeBuckets(UnaryOperator)} to\n+     * merge the actual ordinals and doc ID deltas.\n+     */\n+    public final void mergeBuckets(UnaryOperator<Long> mergeMap, long newNumBuckets){", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDMxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453354319", "bodyText": "Could you swap to long i?", "author": "nik9000", "createdAt": "2020-07-12T19:31:02Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -107,15 +108,33 @@ public final void collectExistingBucket(LeafBucketCollector subCollector, int do\n      * Refer to that method for documentation about the merge map.\n      */\n     public final void mergeBuckets(long[] mergeMap, long newNumBuckets) {\n+        UnaryOperator<Long> mergeMapOperator = new UnaryOperator<Long>() {\n+            @Override\n+            public Long apply(Long bucket) {\n+                return mergeMap[Math.toIntExact(bucket)];\n+            }\n+        };\n+\n+        mergeBuckets(mergeMapOperator, newNumBuckets);\n+    }\n+\n+    /**\n+     * This only tidies up doc counts. Call {@link MergingBucketsDeferringCollector#mergeBuckets(UnaryOperator)} to\n+     * merge the actual ordinals and doc ID deltas.\n+     */\n+    public final void mergeBuckets(UnaryOperator<Long> mergeMap, long newNumBuckets){\n         try (IntArray oldDocCounts = docCounts) {\n             docCounts = bigArrays.newIntArray(newNumBuckets, true);\n             docCounts.fill(0, newNumBuckets, 0);\n             for (int i = 0; i < oldDocCounts.size(); i++) {", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453354427", "bodyText": "I think it is worth saying what the unary operator does here, that -1 means throw away and otherwise it is the destination index.", "author": "nik9000", "createdAt": "2020-07-12T19:32:25Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -107,15 +108,33 @@ public final void collectExistingBucket(LeafBucketCollector subCollector, int do\n      * Refer to that method for documentation about the merge map.\n      */\n     public final void mergeBuckets(long[] mergeMap, long newNumBuckets) {\n+        UnaryOperator<Long> mergeMapOperator = new UnaryOperator<Long>() {\n+            @Override\n+            public Long apply(Long bucket) {\n+                return mergeMap[Math.toIntExact(bucket)];\n+            }\n+        };\n+\n+        mergeBuckets(mergeMapOperator, newNumBuckets);\n+    }\n+\n+    /**\n+     * This only tidies up doc counts. Call {@link MergingBucketsDeferringCollector#mergeBuckets(UnaryOperator)} to", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDgxOA==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453354818", "bodyText": "I'd have tried to write this:\nmergeBuckets(numClusters, bucket -> {\n  if (i < index) {\n    // The clusters in range {0 ... idx - 1} don't move\n    return 1;\n  }\n  if (i == numClusters - 1) {\n    // The new cluster moves to index\n    return i;\n  }\n  // The clusters in range {index ... numClusters - 1} shift forward\n  return i = 1;\n});\n\nI like the \"inline function declaration\" form of this because it makes it super obvious that it doesn't escape.\nI also like early return instead of else if, but that is totally up to you. Its a matter of style and we don't have a standard.", "author": "nik9000", "createdAt": "2020-07-12T19:36:13Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/VariableWidthHistogramAggregator.java", "diffHunk": "@@ -354,21 +355,22 @@ private void moveLastCluster(int index){\n                 clusterSizes.set(index, holdSize);\n \n                 // Move the underlying buckets\n-                long[] mergeMap = new long[numClusters];\n-                for (int i = 0; i < index; i++) {\n-                    // The clusters in range {0 ... idx - 1} don't move\n-                    mergeMap[i] = i;\n-                }\n-                for (int i = index; i < numClusters - 1; i++) {\n-                    // The clusters in range {index ... numClusters - 1} shift up\n-                    mergeMap[i] = i + 1;\n-                }\n-                // Finally, the new cluster moves to index\n-                mergeMap[numClusters - 1] = index;\n+                UnaryOperator<Long> mergeMap = new UnaryOperator<Long>() {\n+                    @Override\n+                    public Long apply(Long i) {\n+                       if(i < index) {\n+                           // The clusters in range {0 ... idx - 1} don't move\n+                           return i;\n+                       } else if(i == numClusters - 1) {\n+                           // The new cluster moves to index\n+                           return (long)index;\n+                       } else {\n+                           // The clusters in range {index ... numClusters - 1} shift forward\n+                           return i + 1;\n+                       }\n+                    }\n+                };", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkzMDY2NA==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r455930664", "bodyText": "I'm not sure if this would work, since this same function is used in the calls to bothBucketsAggregator::mergeBuckets and MergingBucketsDeferringCollector::mergeBuckets.", "author": "jamesdorfman", "createdAt": "2020-07-16T16:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0NDE5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456144197", "bodyText": "Ah! Well, what you have is just fine too.", "author": "nik9000", "createdAt": "2020-07-17T00:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1NDgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NjYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r453846614", "bodyText": "Could you deprecate this method? I think all callers would be better off with the other method.", "author": "nik9000", "createdAt": "2020-07-13T18:27:59Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -107,15 +108,33 @@ public final void collectExistingBucket(LeafBucketCollector subCollector, int do\n      * Refer to that method for documentation about the merge map.\n      */\n     public final void mergeBuckets(long[] mergeMap, long newNumBuckets) {", "originalCommit": "4c706833645f769e8a432708c37d24a96717b5a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyOTY2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r455929665", "bodyText": "Done! I just marked it as deprecated. Should I also update all other usages of this method?", "author": "jamesdorfman", "createdAt": "2020-07-16T16:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NjYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0Mzk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456143943", "bodyText": "Marking it as deprecated is plenty for this or!", "author": "nik9000", "createdAt": "2020-07-17T00:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NjYxNA=="}], "type": "inlineReview"}, {"oid": "5e90bd4f08e0dd836cd3238b7776a99c62b5c03e", "url": "https://github.com/elastic/elasticsearch/commit/5e90bd4f08e0dd836cd3238b7776a99c62b5c03e", "message": "Change UnaryOperator to LongUnaryOperator (and other similar style fixes) in the mergeBuckets methods", "committedDate": "2020-07-15T06:30:17Z", "type": "commit"}, {"oid": "77ebb6381c72374d3bfed2bc2ab44b18bfb5f122", "url": "https://github.com/elastic/elasticsearch/commit/77ebb6381c72374d3bfed2bc2ab44b18bfb5f122", "message": "Add tests for BucketsAggregator::mergeBuckets", "committedDate": "2020-07-15T06:31:33Z", "type": "commit"}, {"oid": "3b32bafb76fccbfdb523ce61c2da085c95996e0d", "url": "https://github.com/elastic/elasticsearch/commit/3b32bafb76fccbfdb523ce61c2da085c95996e0d", "message": " Add tests for MergingBucketsDeferringCollector::mergeBuckets", "committedDate": "2020-07-16T16:49:06Z", "type": "commit"}, {"oid": "4e8597f4b67fe0de7d701b220257633217917ff6", "url": "https://github.com/elastic/elasticsearch/commit/4e8597f4b67fe0de7d701b220257633217917ff6", "message": "Fix formatting", "committedDate": "2020-07-16T17:06:39Z", "type": "commit"}, {"oid": "71b1797e2bd827bad5bf30c91c8d994a57a3c62b", "url": "https://github.com/elastic/elasticsearch/commit/71b1797e2bd827bad5bf30c91c8d994a57a3c62b", "message": "Remove unused imports", "committedDate": "2020-07-16T19:17:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456548632", "bodyText": "I think it'd be a little cleaner to do this by wrapping the collector that you pass to indexSearcher.search and just us MatchAllDocsQuery instead.", "author": "nik9000", "createdAt": "2020-07-17T16:31:15Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/MergingBucketsDeferringCollectorTests.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket;\n+\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.apache.lucene.document.Document;\n+import org.apache.lucene.document.NumericDocValuesField;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.IndexWriter;\n+import org.apache.lucene.index.IndexWriterConfig;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.search.BulkScorer;\n+import org.apache.lucene.search.ConstantScoreScorer;\n+import org.apache.lucene.search.ConstantScoreWeight;\n+import org.apache.lucene.search.DocIdSetIterator;\n+import org.apache.lucene.search.IndexSearcher;\n+import org.apache.lucene.search.LeafCollector;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.QueryVisitor;\n+import org.apache.lucene.search.ScoreMode;\n+import org.apache.lucene.search.Scorer;\n+import org.apache.lucene.search.Weight;\n+import org.apache.lucene.store.Directory;\n+import org.apache.lucene.util.Bits;\n+import org.elasticsearch.search.aggregations.AggregatorTestCase;\n+import org.elasticsearch.search.aggregations.BucketCollector;\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.elasticsearch.search.aggregations.bucket.MergingBucketsDeferringCollector;\n+import org.elasticsearch.search.internal.SearchContext;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.apache.lucene.util.LuceneTestCase.newDirectory;\n+import static org.mockito.Mockito.when;\n+\n+public class MergingBucketsDeferringCollectorTests extends AggregatorTestCase {\n+\n+    /**\n+     * Usually all documents get collected into ordinal 0 unless they are part of a sub aggregation\n+     * @return a query that collects the i'th document into bucket ordinal i\n+     */\n+    private Query getQueryToCollectIntoDifferentOrdinals() {", "originalCommit": "71b1797e2bd827bad5bf30c91c8d994a57a3c62b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY1NTk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456655985", "bodyText": "Fixed! I overrode one of the methods in MergingBucketsDeferringCollector and now it is a lot cleaner. Is this what you had in mind?\nI'm not sure if wrapping the bucket collector directly would work, since the deferring collector stores the bucket ordinal before it calls the bucket collector's collect method.", "author": "jamesdorfman", "createdAt": "2020-07-17T20:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY5MTE4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456691183", "bodyText": "That isn't quite what I was thinking. I think part of the problem is that I'm sort of stuck in a \"do it like aggs do\" mindset. In that mindset there are two collectors and the MergingBucketsDeferringCollector. One collector emulates the outer aggregator and calls to the MergingBucketsDeferringCollector's collect method, calling merge in some funny shape. And the other bucket emulates the inner aggregation and is just called by the aggregator.\nI've got half of a patch on my laptop that does this but I'm probably going to stop for the day. I'll try and post it this weekend.", "author": "nik9000", "createdAt": "2020-07-17T21:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgxNzg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r456817857", "bodyText": "I was thinking something like this. There is a collector that just counts and a collector the distributes bucket ords and merges. And the MergingBucketsDeferringCollector sits between them.\nTwo neat things:\n\nI think I found a bug! I don't think it actually comes up in production because you have to throw away buckets using the merge method while collecting buckets and I think we only do that in the rare_terms aggregators and they only merge after all the collections are done.\nMy test only really covers the variable-width histogram style of merging, not the rare_terms style. But I think that is pretty ok. Its is the harder style.", "author": "nik9000", "createdAt": "2020-07-18T18:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1ODAxNw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r458958017", "bodyText": "Sorry for my delayed response, I had a very hectic start of week!\nVery cool, that is definitely a lot cleaner, thanks for the patch! I've added it and filed a corresponding bug.\nThat's a strange bug by the way...", "author": "jamesdorfman", "createdAt": "2020-07-22T17:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMTM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59366#discussion_r459421373", "bodyText": "Sorry for my delayed response, I had a very hectic start of week!\n\nIts cool! Thanks for getting back to me!\n\nThat's a strange bug by the way...\n\nIt's sneaky! I'm hoping we really don't actually hit it. But it is the kind of thing that happens without unit tests, I think.", "author": "nik9000", "createdAt": "2020-07-23T12:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU0ODYzMg=="}], "type": "inlineReview"}, {"oid": "8df97487b7b236914f3158c4279cc0d55282424d", "url": "https://github.com/elastic/elasticsearch/commit/8df97487b7b236914f3158c4279cc0d55282424d", "message": "Wrap the MergingBucketsDeferringCollector and remove the need to implement a custom query, in MergingBucketsDeferringCollectorTests", "committedDate": "2020-07-17T18:38:38Z", "type": "commit"}, {"oid": "db73958d4a2ab0bf5bf9c3526bebbbe3ed9f0719", "url": "https://github.com/elastic/elasticsearch/commit/db73958d4a2ab0bf5bf9c3526bebbbe3ed9f0719", "message": "Merge with master and resolve merge conflicts", "committedDate": "2020-07-17T19:47:07Z", "type": "commit"}, {"oid": "e286f0a83c83e6204ab5bb7f0bb3d4b9b8a4faa1", "url": "https://github.com/elastic/elasticsearch/commit/e286f0a83c83e6204ab5bb7f0bb3d4b9b8a4faa1", "message": "Resolve merge conflict", "committedDate": "2020-07-17T20:15:20Z", "type": "commit"}, {"oid": "822dfd624c1bf4105a731a846b4d1056fddffe89", "url": "https://github.com/elastic/elasticsearch/commit/822dfd624c1bf4105a731a846b4d1056fddffe89", "message": "Add patch from @nik9000 to make the MergingBucketsDeferringCollectorTests much cleaner", "committedDate": "2020-07-22T17:14:29Z", "type": "commit"}, {"oid": "c675f685aad3af44020e3886037e5f6b3fb134d9", "url": "https://github.com/elastic/elasticsearch/commit/c675f685aad3af44020e3886037e5f6b3fb134d9", "message": "Merge branch 'master' into vwh_efficient_merge_map", "committedDate": "2020-07-24T13:00:44Z", "type": "commit"}]}