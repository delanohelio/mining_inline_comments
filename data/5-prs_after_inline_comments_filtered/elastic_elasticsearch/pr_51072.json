{"pr_number": 51072, "pr_title": "[Transform] Improve force stop robustness in case of an error", "pr_createdAt": "2020-01-15T21:50:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51072", "timeline": [{"oid": "dde880a23e86a966534ec63fc50205345874df83", "url": "https://github.com/elastic/elasticsearch/commit/dde880a23e86a966534ec63fc50205345874df83", "message": "make it possible to stop dangling transforms", "committedDate": "2020-01-15T19:53:04Z", "type": "commit"}, {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a", "url": "https://github.com/elastic/elasticsearch/commit/77df1c75c3edcef04fe723e1266a82f3522efe5a", "message": "test task removal after internal index deletion", "committedDate": "2020-01-15T21:36:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyNDg1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367324856", "bodyText": "I wonder if we dangling is a bit vague here for users. Should we rephrase to Detected transforms [{0}] without matching configs?", "author": "dimitris-athanasiou", "createdAt": "2020-01-16T09:54:46Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/TransformMessages.java", "diffHunk": "@@ -17,6 +17,7 @@\n             \"Interrupted while waiting for transform [{0}] to stop\";\n     public static final String REST_PUT_TRANSFORM_EXISTS = \"Transform with id [{0}] already exists\";\n     public static final String REST_UNKNOWN_TRANSFORM = \"Transform with id [{0}] could not be found\";\n+    public static final String REST_STOP_TRANSFORM_WITHOUT_CONFIG = \"Detected dangling transforms [{0}]. Use force to stop/delete them.\";", "originalCommit": "77df1c75c3edcef04fe723e1266a82f3522efe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367328011", "bodyText": "Could transformId be \"foo-*\"? If yes, then this is not going to work.", "author": "dimitris-athanasiou", "createdAt": "2020-01-16T10:00:54Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -127,6 +134,25 @@ static void validateTaskState(ClusterState state, List<String> transformIds, boo\n         }\n     }\n \n+    static Tuple<Set<String>, Set<String>> findTasksWithoutConfig(ClusterState state, String transformId) {\n+        PersistentTasksCustomMetaData tasks = state.metaData().custom(PersistentTasksCustomMetaData.TYPE);\n+\n+        Set<String> taskIds = new HashSet<>();\n+        Set<String> executorNodes = new HashSet<>();\n+\n+        Predicate<PersistentTask<?>> taskMatcher = Strings.isAllOrWildcard(new String[] { transformId }) ? t -> true : t -> {\n+            TransformTaskParams transformParams = (TransformTaskParams) t.getParams();\n+            return transformParams.getId().equals(transformId);", "originalCommit": "77df1c75c3edcef04fe723e1266a82f3522efe5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM4OTU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367389595", "bodyText": "yes, that was my intention. In this situation I think you either have 1 transform that is broken or you want to rest everything. Supporting such patterns makes it very complicated and its dangerous, too.\nHowever, I will add a check and throw an exception if someone tries to call it with \"my_id*\".", "author": "hendrikmuhs", "createdAt": "2020-01-16T12:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5Mzk3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367393975", "bodyText": "hmm, this gets complicated. I changed my mind and will allow it.", "author": "hendrikmuhs", "createdAt": "2020-01-16T12:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMDA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367330058", "bodyText": "Rename to runningTasksAndNodes? Just so it's clear what's what when we later get each part of the tuple.", "author": "dimitris-athanasiou", "createdAt": "2020-01-16T10:05:09Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -160,7 +186,31 @@ protected void doExecute(Task task, Request request, ActionListener<Response> li\n                     request.setExpandedIds(new HashSet<>(hitsAndIds.v2()));\n                     request.setNodes(TransformNodes.transformTaskNodes(hitsAndIds.v2(), state));\n                     super.doExecute(task, request, finalListener);\n-                }, listener::onFailure)\n+                }, e -> {\n+                    if (e instanceof ResourceNotFoundException) {\n+                        Tuple<Set<String>, Set<String>> runningTasks = findTasksWithoutConfig(state, request.getId());", "originalCommit": "77df1c75c3edcef04fe723e1266a82f3522efe5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "557b0bef5f73b1cc328473314b7bc52f48b91390", "url": "https://github.com/elastic/elasticsearch/commit/557b0bef5f73b1cc328473314b7bc52f48b91390", "message": "apply review suggestions", "committedDate": "2020-01-16T12:44:05Z", "type": "commit"}]}