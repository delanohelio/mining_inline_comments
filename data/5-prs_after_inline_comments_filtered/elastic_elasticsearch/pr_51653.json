{"pr_number": 51653, "pr_title": "Fix SnapshotLifecycleServiceTests.testPolicyCRUD", "pr_createdAt": "2020-01-29T23:07:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51653", "timeline": [{"oid": "4f4d868d9edc1e00b0ae5ffb11e967f55df32958", "url": "https://github.com/elastic/elasticsearch/commit/4f4d868d9edc1e00b0ae5ffb11e967f55df32958", "message": "Fix SnapshotLifecycleServiceTests.testPolicyCRUD", "committedDate": "2020-01-29T23:05:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NDcyMA==", "url": "https://github.com/elastic/elasticsearch/pull/51653#discussion_r372694720", "bodyText": "This will eventually fail, the contains matcher requires exact matching; so it'll fail and complain with:\njava.lang.AssertionError: \nExpected: iterable containing [\"foo-2\"]\n     but: item 0: was \"foo-1\"\n\nIt should be changed to check that it has \"foo-2\", but can have anything else also.", "author": "dakrone", "createdAt": "2020-01-29T23:53:18Z", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleServiceTests.java", "diffHunk": "@@ -206,13 +207,20 @@ public void testPolicyCRUD() throws Exception {\n             sls.clusterChanged(event);\n             assertThat(sls.getScheduler().scheduledJobIds(), equalTo(Collections.singleton(\"foo-2\")));\n \n+            CopyOnWriteArrayList<String> triggeredJobs = new CopyOnWriteArrayList<>();\n             trigger.set(e -> {\n-                // Make sure the job got updated\n-                assertThat(e.getJobName(), equalTo(\"foo-2\"));\n+                triggeredJobs.add(e.getJobName());\n                 triggerCount.incrementAndGet();\n             });\n             clock.fastForwardSeconds(1);\n \n+            // Let's make sure the job got updated\n+            // We don't simply assert that triggeredJobs has one element with value \"foo-2\" because of a race condition that can see the\n+            // list containing <foo-2, foo-1>. This can happen because when we update the policy to version 2 (ie. to foo-2) we will\n+            // cancel the existing policy (foo-1) without waiting for the thread executing foo-1 to actually interrupt\n+            // (see org.elasticsearch.common.util.concurrent.FutureUtils#cancel) which means that foo-1 could actually get to be\n+            // rescheduled and re-run before it is indeed cancelled.\n+            assertBusy(() -> assertThat(triggeredJobs, contains(\"foo-2\")));", "originalCommit": "4f4d868d9edc1e00b0ae5ffb11e967f55df32958", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgzMDEyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51653#discussion_r372830125", "bodyText": "Ah, that's correct (and why it hadn't failed locally - contains is very much overloaded)\nThanks @dakrone , I pushed a fix to use hasItem", "author": "andreidan", "createdAt": "2020-01-30T09:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NDcyMA=="}], "type": "inlineReview"}, {"oid": "e6175f89a4c77a059c65b2303694e5ad22525474", "url": "https://github.com/elastic/elasticsearch/commit/e6175f89a4c77a059c65b2303694e5ad22525474", "message": "Use hasItem instead of contains", "committedDate": "2020-01-30T09:07:22Z", "type": "commit"}]}