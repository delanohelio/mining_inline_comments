{"pr_number": 57937, "pr_title": "Serialize Get Mappings Response on Generic ThreadPool", "pr_createdAt": "2020-06-10T15:34:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57937", "timeline": [{"oid": "b4f87baf2197c384a2e3b6e0ed66f997fdd53c33", "url": "https://github.com/elastic/elasticsearch/commit/b4f87baf2197c384a2e3b6e0ed66f997fdd53c33", "message": "Serialize Get Mappings Response on Generic ThreadPool\n\nFor large responses to the get mappings request, the serialization\nto XContent can be extremely slow (serializing mappings is expensive since\nwe have to decompress and deserialize the mapping source).\nTo not introduce instability on the IO thread handling the get mappings response\nwe should move the serialization to the generic pool.\nThe trade-off of introducing one or two new context switches for responses that are\nsmall enough to not cause trouble on the transport thread to prevent instability\nin case of a large number of mappings in the cluster seems worth it.", "committedDate": "2020-06-10T15:26:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzNDQ5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57937#discussion_r473934493", "bodyText": "WDYT about checking for a timeout again here before we do all the serialisation work? If we use a bounded threadpool then these things might pile up, so aborting early might be a helpful way to push back.", "author": "DaveCTurner", "createdAt": "2020-08-20T12:32:49Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestGetMappingAction.java", "diffHunk": "@@ -62,13 +71,21 @@ public RestChannelConsumer prepareRequest(final RestRequest request, final NodeC\n         getMappingsRequest.indicesOptions(IndicesOptions.fromRequest(request, getMappingsRequest.indicesOptions()));\n         getMappingsRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", getMappingsRequest.masterNodeTimeout()));\n         getMappingsRequest.local(request.paramAsBoolean(\"local\", getMappingsRequest.local()));\n-        return channel -> client.admin().indices().getMappings(getMappingsRequest, new RestBuilderListener<>(channel) {\n+        return channel -> client.admin().indices().getMappings(getMappingsRequest, new RestActionListener<>(channel) {\n+\n             @Override\n-            public RestResponse buildResponse(final GetMappingsResponse response, final XContentBuilder builder) throws Exception {\n-                builder.startObject();\n-                response.toXContent(builder, request);\n-                builder.endObject();\n-                return new BytesRestResponse(RestStatus.OK, builder);\n+            protected void processResponse(GetMappingsResponse getMappingsResponse) {\n+                // Process serialization on GENERIC pool since the serialization of the raw mappings to XContent can be too slow to execute\n+                // on an IO thread\n+                threadPool.generic().execute(ActionRunnable.wrap(this, l -> new RestBuilderListener<GetMappingsResponse>(channel) {\n+                    @Override\n+                    public RestResponse buildResponse(final GetMappingsResponse response, final XContentBuilder builder) throws Exception {", "originalCommit": "b4f87baf2197c384a2e3b6e0ed66f997fdd53c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk3NzkyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57937#discussion_r473977925", "bodyText": "\ud83d\udc4d  how about 0bd68d4 ? :)", "author": "original-brownbear", "createdAt": "2020-08-20T13:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzNDQ5Mw=="}], "type": "inlineReview"}, {"oid": "0bd68d4d6be52152133889a5504bf1ff96874906", "url": "https://github.com/elastic/elasticsearch/commit/0bd68d4d6be52152133889a5504bf1ff96874906", "message": "timeout", "committedDate": "2020-08-20T13:32:47Z", "type": "commit"}]}