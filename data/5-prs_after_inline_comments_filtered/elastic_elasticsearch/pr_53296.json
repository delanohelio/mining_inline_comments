{"pr_number": 53296, "pr_title": "Fix composite agg sort bug", "pr_createdAt": "2020-03-09T16:58:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53296", "timeline": [{"oid": "a86c88cfb465e8a28693828447215b458a5eb79b", "url": "https://github.com/elastic/elasticsearch/commit/a86c88cfb465e8a28693828447215b458a5eb79b", "message": "Fix composite agg sort bug\n\nWhen an composite aggregation is run against an index with a sort that\n*starts* with the \"source\" fields from the composite but has additional\nfields it'd blow up in while trying to decide if it could use the sort.\nThis changes it to decide that it *can* use the sort.\n\nCloses #52480", "committedDate": "2020-03-09T16:53:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMTUyMw==", "url": "https://github.com/elastic/elasticsearch/pull/53296#discussion_r389831523", "bodyText": "You can still hit the bug if the source configs is smaller than the index sort ? Since we're looking for the biggest prefix of the index sort maybe we could leave the for loop as it is but add a check that breaks the loop if the source configs length is reached:\nif (i >= sourceConfigs.length) {\n  break;\n}", "author": "jimczi", "createdAt": "2020-03-09T17:06:54Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregator.java", "diffHunk": "@@ -202,7 +202,8 @@ private Sort buildIndexSortPrefix(LeafReaderContext context) throws IOException\n             return null;\n         }\n         List<SortField> sortFields = new ArrayList<>();\n-        for (int i = 0; i < indexSort.getSort().length; i++) {\n+        int max = Math.min(indexSort.getSort().length, sourceConfigs.length);", "originalCommit": "a86c88cfb465e8a28693828447215b458a5eb79b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzNTkzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53296#discussion_r389835935", "bodyText": "I think the way I have it covers both cases, right?", "author": "nik9000", "createdAt": "2020-03-09T17:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMTUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzOTMwMA==", "url": "https://github.com/elastic/elasticsearch/pull/53296#discussion_r389839300", "bodyText": "oh right, I read the variable named max and thought that you were extracting the max of the length :(", "author": "jimczi", "createdAt": "2020-03-09T17:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMTUyMw=="}], "type": "inlineReview"}, {"oid": "4cd354f4594062cac633de3cd810228ebcd0078a", "url": "https://github.com/elastic/elasticsearch/commit/4cd354f4594062cac633de3cd810228ebcd0078a", "message": "Randomly shorten the sort as well", "committedDate": "2020-03-09T17:22:06Z", "type": "commit"}, {"oid": "d47387bbbbf46af6ab0e02acd688587d8e1fb5a7", "url": "https://github.com/elastic/elasticsearch/commit/d47387bbbbf46af6ab0e02acd688587d8e1fb5a7", "message": "Revert \"Randomly shorten the sort as well\"\n\nThis reverts commit 4cd354f4594062cac633de3cd810228ebcd0078a.", "committedDate": "2020-03-09T17:24:14Z", "type": "commit"}, {"oid": "1d00fa93f319154f6b28fb3802b5166ab6ec9a33", "url": "https://github.com/elastic/elasticsearch/commit/1d00fa93f319154f6b28fb3802b5166ab6ec9a33", "message": "Merge branch 'master' into composit_sorted", "committedDate": "2020-03-09T17:25:55Z", "type": "commit"}, {"oid": "9b8dbe1e19fa40468f07813b2bd78244197cc78c", "url": "https://github.com/elastic/elasticsearch/commit/9b8dbe1e19fa40468f07813b2bd78244197cc78c", "message": "Rename", "committedDate": "2020-03-09T20:36:52Z", "type": "commit"}, {"oid": "523708dcaea417fe0aa57f73cf5c2e5c09f656e9", "url": "https://github.com/elastic/elasticsearch/commit/523708dcaea417fe0aa57f73cf5c2e5c09f656e9", "message": "Skip?", "committedDate": "2020-03-09T20:37:24Z", "type": "commit"}, {"oid": "e3e352c7b8491bb2b25d3e3fb6f19ac5d5045ed0", "url": "https://github.com/elastic/elasticsearch/commit/e3e352c7b8491bb2b25d3e3fb6f19ac5d5045ed0", "message": "Updateskip", "committedDate": "2020-03-09T20:53:23Z", "type": "commit"}]}