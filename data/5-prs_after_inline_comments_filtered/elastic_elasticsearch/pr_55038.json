{"pr_number": 55038, "pr_title": "Scripting: Deprecate general cache settings", "pr_createdAt": "2020-04-09T23:54:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55038", "timeline": [{"oid": "feaab71f5d2279e72734ba0a6c9e9f9c7ec3a853", "url": "https://github.com/elastic/elasticsearch/commit/feaab71f5d2279e72734ba0a6c9e9f9c7ec3a853", "message": "Scripting: Deprecate general cache settings", "committedDate": "2020-04-02T22:49:22Z", "type": "commit"}, {"oid": "1542a26407bec46ae63e21ed06139737ec4cc1c3", "url": "https://github.com/elastic/elasticsearch/commit/1542a26407bec46ae63e21ed06139737ec4cc1c3", "message": "Add script.disable_max_compilations_rate setting", "committedDate": "2020-04-09T15:37:10Z", "type": "commit"}, {"oid": "260cea3653b6fc604e8076e389d4ed2db51ee652", "url": "https://github.com/elastic/elasticsearch/commit/260cea3653b6fc604e8076e389d4ed2db51ee652", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate", "committedDate": "2020-04-09T15:37:17Z", "type": "commit"}, {"oid": "d586a3421de7e4da5620a707cf8d00b49771a9dc", "url": "https://github.com/elastic/elasticsearch/commit/d586a3421de7e4da5620a707cf8d00b49771a9dc", "message": "Move construction to ScriptCache", "committedDate": "2020-04-09T17:52:53Z", "type": "commit"}, {"oid": "601c58720c2d8112a1d5c229d6a6ef1ba4355064", "url": "https://github.com/elastic/elasticsearch/commit/601c58720c2d8112a1d5c229d6a6ef1ba4355064", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate", "committedDate": "2020-04-09T17:53:40Z", "type": "commit"}, {"oid": "dabdcb408b5dc3e76e2cbfe336c52c9b354f193d", "url": "https://github.com/elastic/elasticsearch/commit/dabdcb408b5dc3e76e2cbfe336c52c9b354f193d", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate", "committedDate": "2020-04-09T18:18:56Z", "type": "commit"}, {"oid": "816047a36150a0bf06ec46c75068d89e3af11469", "url": "https://github.com/elastic/elasticsearch/commit/816047a36150a0bf06ec46c75068d89e3af11469", "message": "Use ScriptService to do updates of CacheHolder", "committedDate": "2020-04-09T23:30:48Z", "type": "commit"}, {"oid": "2a824765b82da021e09489314d609979a3a88e55", "url": "https://github.com/elastic/elasticsearch/commit/2a824765b82da021e09489314d609979a3a88e55", "message": "Remove fallbacks", "committedDate": "2020-04-09T23:53:57Z", "type": "commit"}, {"oid": "16888fb7ca6bd944cfd4f80a52d8cd7635e4ed98", "url": "https://github.com/elastic/elasticsearch/commit/16888fb7ca6bd944cfd4f80a52d8cd7635e4ed98", "message": "Add SCRIPT_DISABLE_MAX_COMPILATIONS_RATE_SETTING to ClusterSettings", "committedDate": "2020-04-10T17:33:16Z", "type": "commit"}, {"oid": "76ebe3a78adc03f989fda797ec937ce4fa1c1a5a", "url": "https://github.com/elastic/elasticsearch/commit/76ebe3a78adc03f989fda797ec937ce4fa1c1a5a", "message": "Node scope", "committedDate": "2020-04-10T18:53:07Z", "type": "commit"}, {"oid": "8c2e723f36c5eecee046419711d39c611fb711c8", "url": "https://github.com/elastic/elasticsearch/commit/8c2e723f36c5eecee046419711d39c611fb711c8", "message": "Use back compat", "committedDate": "2020-04-10T19:07:49Z", "type": "commit"}, {"oid": "98b6bb41b1906815dbc900c1419ef9769fea005d", "url": "https://github.com/elastic/elasticsearch/commit/98b6bb41b1906815dbc900c1419ef9769fea005d", "message": "8.0 for bwc", "committedDate": "2020-04-10T19:32:21Z", "type": "commit"}, {"oid": "b6497e5760084fb0440e31f3ea175cd7b2c930ba", "url": "https://github.com/elastic/elasticsearch/commit/b6497e5760084fb0440e31f3ea175cd7b2c930ba", "message": "script.max_compilations_rate=2048/1m -> script.disable_max_compilations_rate=true in docker compose", "committedDate": "2020-04-14T20:01:00Z", "type": "commit"}, {"oid": "2373a6bbab40c818e1838bcf7885be23a24b5a13", "url": "https://github.com/elastic/elasticsearch/commit/2373a6bbab40c818e1838bcf7885be23a24b5a13", "message": "do not guard in esnode", "committedDate": "2020-04-14T20:18:39Z", "type": "commit"}, {"oid": "e1436177705fa7f628ecc774e92c29c135522864", "url": "https://github.com/elastic/elasticsearch/commit/e1436177705fa7f628ecc774e92c29c135522864", "message": "Doc update", "committedDate": "2020-04-14T20:24:08Z", "type": "commit"}, {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c", "url": "https://github.com/elastic/elasticsearch/commit/b61dd0647de95bc8f67044ce92bb0cb89655e40c", "message": "isSnapshotBuild() -> systemProperty 'es.script.disable_max_compilations_rate', 'true'", "committedDate": "2020-04-14T21:57:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NDI5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r410364292", "bodyText": "Rename to cache", "author": "stu-elastic", "createdAt": "2020-04-17T17:23:29Z", "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -688,25 +691,25 @@ ScriptCacheStats cacheStats() {\n                 return new ScriptCacheStats(general.stats());\n             }\n             Map<String, ScriptStats> context = new HashMap<>(contextCache.size());\n-            for (ScriptContext<?> ctx: contexts) {\n-                context.put(ctx.name, contextCache.get(ctx.name).get().stats());\n+            for (String name: contextCache.keySet()) {\n+                context.put(name, contextCache.get(name).get().stats());\n             }\n             return new ScriptCacheStats(context);\n         }\n \n         /**\n-         * Update settings for the context cache, if we're in the context cache mode otherwise no-op.\n+         * Update a single context cache if we're in the context cache mode otherwise no-op.\n          */\n-        void updateContextSettings(Settings settings, ScriptContext<?> context) {\n+        void set(String name, ScriptCache context) {", "originalCommit": "b61dd0647de95bc8f67044ce92bb0cb89655e40c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4ODIwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r411688200", "bodyText": "Make this package protected.", "author": "stu-elastic", "createdAt": "2020-04-20T20:59:29Z", "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -576,89 +583,85 @@ public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n \n-    /**\n-     * Container for the ScriptCache(s).  This class operates in two modes:\n-     * 1) general mode, if the general script cache is configured.  There are no context caches in this case.\n-     * 2) context mode, if the context script cache is configured.  There is no general cache in this case.\n-     */\n-    static class CacheHolder {\n-        final ScriptCache general;\n-        final Map<String, AtomicReference<ScriptCache>> contextCache;\n+    void setCacheHolder(Settings settings, AtomicReference<CacheHolder> cacheHolder) {", "originalCommit": "b61dd0647de95bc8f67044ce92bb0cb89655e40c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58077162ccff688a0cb926c6f13aab026762228e", "url": "https://github.com/elastic/elasticsearch/commit/58077162ccff688a0cb926c6f13aab026762228e", "message": "Do not use snapshot in gradle to set max_compilations_rate", "committedDate": "2020-04-20T23:36:11Z", "type": "commit"}, {"oid": "4532e51f4020691783802bb6b264e39822072d5b", "url": "https://github.com/elastic/elasticsearch/commit/4532e51f4020691783802bb6b264e39822072d5b", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate", "committedDate": "2020-04-20T23:37:45Z", "type": "commit"}, {"oid": "36eff0682e6dfad19418a9b3710288bb5c8aae50", "url": "https://github.com/elastic/elasticsearch/commit/36eff0682e6dfad19418a9b3710288bb5c8aae50", "message": "Expose cacheHolder as package private", "committedDate": "2020-04-21T01:10:33Z", "type": "commit"}, {"oid": "760fdb76192efced0fb0dae770b4afe2cb321cb7", "url": "https://github.com/elastic/elasticsearch/commit/760fdb76192efced0fb0dae770b4afe2cb321cb7", "message": "monospace 75/5m in cbreaker docs, single space in using", "committedDate": "2020-04-21T17:20:08Z", "type": "commit"}, {"oid": "5d2c9ea88c9183b45fcdd66f679a17d6e8718d12", "url": "https://github.com/elastic/elasticsearch/commit/5d2c9ea88c9183b45fcdd66f679a17d6e8718d12", "message": "More detail in general compilation rate error", "committedDate": "2020-04-21T20:10:14Z", "type": "commit"}, {"oid": "bb2fdbaab3917971d6664f968dedf90bb0b7dbae", "url": "https://github.com/elastic/elasticsearch/commit/bb2fdbaab3917971d6664f968dedf90bb0b7dbae", "message": "Test: don't modify defaultConfig on upgrade", "committedDate": "2020-04-21T23:39:16Z", "type": "commit"}, {"oid": "6ceb9233ccd121cf7285abf34abdcdb298d23812", "url": "https://github.com/elastic/elasticsearch/commit/6ceb9233ccd121cf7285abf34abdcdb298d23812", "message": "Merge 58ec9c3\n\nMerge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate", "committedDate": "2020-04-22T15:37:33Z", "type": "commit"}]}