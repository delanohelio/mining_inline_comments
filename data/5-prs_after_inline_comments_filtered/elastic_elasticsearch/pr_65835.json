{"pr_number": 65835, "pr_title": "Remove more usages of .watches system index.", "pr_createdAt": "2020-12-03T17:03:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65835", "timeline": [{"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf", "url": "https://github.com/elastic/elasticsearch/commit/e8616a11af06c3f3130f9598288694ec66e80ccf", "message": "Remove more usages of .watches system index.\n\nMake use of the new query watches api to simply list watches or\nto delete all watches using the delete watch api.\n\nRelates to #62501", "committedDate": "2020-12-03T16:03:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzY4OA==", "url": "https://github.com/elastic/elasticsearch/pull/65835#discussion_r535683688", "bodyText": "nit: I assume this would be a programmers error, if so can this just be a Java assert instead of an assertThat to help differentiate between something that is being tested and a self documenting sanity check. Also, why Less ? should be it be not equal ?", "author": "jakelandis", "createdAt": "2020-12-03T22:16:23Z", "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "diffHunk": "@@ -70,18 +75,23 @@ public final void stopWatcher() throws Exception {\n                     throw new AssertionError(\"unknown state[\" + state + \"]\");\n             }\n         }, 60, TimeUnit.SECONDS);\n+        deleteAllWatcherData();\n+    }\n+\n+    public static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n \n-        Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n-        deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n-        deleteWatchesIndexRequest.setOptions(\n-            expectWarnings(\n-                \"this request accesses system indices: [.watches], but in a future major \"\n-                    + \"version, direct access to system indices will be prevented by default\"\n-            )\n-        );\n-        ESRestTestCase.adminClient().performRequest(deleteWatchesIndexRequest);\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assertThat(\"Less watches requested than exist in total\", watches.size(), equalTo(totalCount));", "originalCommit": "e8616a11af06c3f3130f9598288694ec66e80ccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyNjA2NA==", "url": "https://github.com/elastic/elasticsearch/pull/65835#discussion_r535926064", "bodyText": "Right, I will adjust the worden and turn this into an assert.", "author": "martijnvg", "createdAt": "2020-12-04T08:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzY4OA=="}], "type": "inlineReview"}, {"oid": "a010cd8af6e4d0523d247ac6928ae0370633a5d9", "url": "https://github.com/elastic/elasticsearch/commit/a010cd8af6e4d0523d247ac6928ae0370633a5d9", "message": "Merge remote-tracking branch 'es/master' into remove_more_usages_of_.watches_system_index", "committedDate": "2020-12-04T08:54:10Z", "type": "commit"}, {"oid": "b57906e84c631e2b143e5e9b60aac598333463aa", "url": "https://github.com/elastic/elasticsearch/commit/b57906e84c631e2b143e5e9b60aac598333463aa", "message": "adjust assertion", "committedDate": "2020-12-04T08:54:46Z", "type": "commit"}, {"oid": "c9d8280fa321c06569d387f3a8e277f275f02eb7", "url": "https://github.com/elastic/elasticsearch/commit/c9d8280fa321c06569d387f3a8e277f275f02eb7", "message": "removed unused import", "committedDate": "2020-12-04T08:59:04Z", "type": "commit"}]}