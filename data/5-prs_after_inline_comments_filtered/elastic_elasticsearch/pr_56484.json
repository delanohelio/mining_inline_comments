{"pr_number": 56484, "pr_title": "Support multiple tokens on LHS in stemmer_override rules (#56113)", "pr_createdAt": "2020-05-09T09:35:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56484", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r424443079", "bodyText": "One suggestion: maybe we could use splitSmart(input, \",\", true) here, I believe this would allow to cover the (admittedly very unlikely) case where ppl need a comma in their rules. I believe a rule like a\\\\,b would then be resolved to a key a,b. If you think thats worth the troube we'd also need a small test for this (see other comment around unit testing).", "author": "cbuescher", "createdAt": "2020-05-13T13:36:46Z", "path": "modules/analysis-common/src/main/java/org/elasticsearch/analysis/common/StemmerOverrideTokenFilterFactory.java", "diffHunk": "@@ -57,19 +57,23 @@ public TokenStream create(TokenStream tokenStream) {\n \n     static void parseRules(List<String> rules, StemmerOverrideFilter.Builder builder, String mappingSep) {\n         for (String rule : rules) {\n-            String key, override;\n-            List<String> mapping = Strings.splitSmart(rule, mappingSep, false);\n-            if (mapping.size() == 2) {\n-                key = mapping.get(0).trim();\n-                override = mapping.get(1).trim();\n-            } else {\n+            List<String> sides = Strings.splitSmart(rule, mappingSep, false);\n+            if (sides.size() != 2) {\n                 throw new RuntimeException(\"Invalid Keyword override Rule:\" + rule);\n             }\n \n-            if (key.isEmpty() || override.isEmpty()) {\n+            List<String> keys = Strings.splitSmart(sides.get(0), \",\", false);", "originalCommit": "9f29f73db8a3a685c293932c764a48f1c98ce04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzYxMg==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r426303612", "bodyText": "@cbuescher\nUgh... Honestly, I didn't even look at what splitSmart does and I simply used that because it was used to split rules on =>. Now I took a look (although that helper itself does not have any test) and I'm confused.\nUnlike String.split splitSmart does not return empty tokens. So the result of splitting this:\n=>one=>two=>=>\n\nis [one, two] which is considered a valid rule. IMO it should not.\nI believe a regular String.split should be used. If we want to support \"a\\\\,b\" tokens then we should split on \"\"(?<!\\\\\\\\),\" regexp and then we should unescape each token before adding it - this is something that I would normally use StringEscapeUtils.unescapeJava from apache commons-text, but you don't seem to use it. What do you suggest in this case? Do you have a similar helper?", "author": "telendt", "createdAt": "2020-05-17T20:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMjg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r427402855", "bodyText": "=>one=>two=>=>\n\nGood point, maybe we should use simple String.split for the LHS/RHS separation and reject invalid patterns indeed.\nFor the LHS split on , I'm find both ways. If \"splitSmart\" works for this and supports escaping we can still consider using that, but simple String splitting on , is also fine if other solutions add too much complexity. I don't think we really need to support commas in LHS entries if its too complicated.", "author": "cbuescher", "createdAt": "2020-05-19T15:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzU4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r424443585", "bodyText": "Could you add unit testing for this (and the later) exception?", "author": "cbuescher", "createdAt": "2020-05-13T13:37:26Z", "path": "modules/analysis-common/src/main/java/org/elasticsearch/analysis/common/StemmerOverrideTokenFilterFactory.java", "diffHunk": "@@ -57,19 +57,23 @@ public TokenStream create(TokenStream tokenStream) {\n \n     static void parseRules(List<String> rules, StemmerOverrideFilter.Builder builder, String mappingSep) {\n         for (String rule : rules) {\n-            String key, override;\n-            List<String> mapping = Strings.splitSmart(rule, mappingSep, false);\n-            if (mapping.size() == 2) {\n-                key = mapping.get(0).trim();\n-                override = mapping.get(1).trim();\n-            } else {\n+            List<String> sides = Strings.splitSmart(rule, mappingSep, false);\n+            if (sides.size() != 2) {\n                 throw new RuntimeException(\"Invalid Keyword override Rule:\" + rule);", "originalCommit": "9f29f73db8a3a685c293932c764a48f1c98ce04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyNzI0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r425027241", "bodyText": "Sure, I'll do it tonight.", "author": "telendt", "createdAt": "2020-05-14T10:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyNzcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r425027719", "bodyText": "BTW - what do you need about having more precise error messages (telling exactly what's wrong)?", "author": "telendt", "createdAt": "2020-05-14T10:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAzNTI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r425035240", "bodyText": "Sure, feel free to extend the message with more details if you think its helpful and doesn't add to much complexity.", "author": "cbuescher", "createdAt": "2020-05-14T10:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MzU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1ODU4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r424458586", "bodyText": "Since this is a static method, it should be possible to unit test it directly. I think it would also be an improvement to make it return the StemmerOverrideFilter.Builder instead of passing it in and adding to it inside the method. That way you could use the returned builder to create a StemmerOverrideMap from it, which I think can be queried for testing. Its a Lucene class so not so easy to directly work with, but I lifted some parts from StemmerOverrideFilter and something like this should work:\n       StemmerOverrideMap map = builder.build();\n        BytesReader fstReader = map.getBytesReader();\n        final Arc<BytesRef> scratchArc = new FST.Arc<>();\n        String key = \"something\"\n        BytesRef bytesRef = map.get(key.toCharArray(), key.length() , scratchArc, fstReader);\n        assertEquals(\"someValue\", bytesRef.utf8ToString());\n\nIt would be nice to test a few more cases (with commas, trimming of whitespaces etc...) and the exception cases in a new unit test for StemmerOverrideTokenFilterFactory (that is a new StemmerOverrideTokenFilterFactoryTests) in the analysis-common module.", "author": "cbuescher", "createdAt": "2020-05-13T13:57:10Z", "path": "modules/analysis-common/src/main/java/org/elasticsearch/analysis/common/StemmerOverrideTokenFilterFactory.java", "diffHunk": "@@ -57,19 +57,23 @@ public TokenStream create(TokenStream tokenStream) {\n \n     static void parseRules(List<String> rules, StemmerOverrideFilter.Builder builder, String mappingSep) {", "originalCommit": "9f29f73db8a3a685c293932c764a48f1c98ce04e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyODY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r425028670", "bodyText": "@cbuescher yes, the only reason I didn't write any tests was that I didn't find any unit test classes for this token filter. But I agree that it needs it, even more now that there is some extra logic.\nI'll take a look how you test token filters and address your comments.", "author": "telendt", "createdAt": "2020-05-14T10:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1ODU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAzODczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r425038731", "bodyText": "I think there's no need to emulate what other token filters are testing at this point (unless you like to), just adding StemmerOverrideTokenFilterFactoryTests to org.elasticsearch.analysis.common and add tests for the static method should be okay. Looks like most similar \"*FactoryTests\" extend ESTokenStreamTestCase, which might be a good idea to do as well, then it might be easier to add more test functionality going forward. There's some more info on how to run certain tests only in the TESTING.asciidoc, if you have other questions let me know.", "author": "cbuescher", "createdAt": "2020-05-14T10:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1ODU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNTE2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r426305165", "bodyText": "@cbuescher is it really worth to use the complicated StemmerOverrideMap lookup API to verify that parseRules added the right key and value?\nTo test unhappy cases I would simply try to instantiate StemmerOverrideTokenFilterFactory and check if it throws (I would do it with a loop and expectThrows as you don't seem to use JUnit's parameterized tests).\nHappy case (valid rules) could be tested with analysis output of its TokenStream.", "author": "telendt", "createdAt": "2020-05-17T21:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1ODU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM5OTQwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r427399408", "bodyText": "Sure, use anything you think makes sense. The StemmerOverrideMap API was just a thought.  Any approach that is easy to set up and read and that doesn't need to spin up a whole cluster (i.e. integration test) is fine. Testing some valid and invalid cases is the most important thing I think.", "author": "cbuescher", "createdAt": "2020-05-19T15:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1ODU4Ng=="}], "type": "inlineReview"}, {"oid": "4afbdf58b48e722b838036c7b2c5cc006dc2f87a", "url": "https://github.com/elastic/elasticsearch/commit/4afbdf58b48e722b838036c7b2c5cc006dc2f87a", "message": "Support multiple tokens on LHS in stemmer_override rules (#56113)\n\nThis commit adds support for rules with multiple tokens on LHS, also\nknown as \"contraction rules\", into stemmer override token\nfilter. Contraction rules are handy into translating multiple\ninflected words into the same root form. One side effect of this change is\nthat it brings stemmer override rules format closer to synonym rules\nformat so that it makes it easier to translate one into another.\n\nThis change also makes rules parser more strict so that it should\ncatch more errors which were previously accepted.", "committedDate": "2020-05-28T21:21:55Z", "type": "forcePushed"}, {"oid": "91be65109cd5612955a6dbb70812abbf1e76cd29", "url": "https://github.com/elastic/elasticsearch/commit/91be65109cd5612955a6dbb70812abbf1e76cd29", "message": "Support multiple tokens on LHS in stemmer_override rules (#56113)\n\nThis commit adds support for rules with multiple tokens on LHS, also\nknown as \"contraction rules\", into stemmer override token\nfilter. Contraction rules are handy into translating multiple\ninflected words into the same root form. One side effect of this change is\nthat it brings stemmer override rules format closer to synonym rules\nformat so that it makes it easier to translate one into another.\n\nThis change also makes stemmer override rules parser more strict so\nthat it should catch more errors which were previously accepted.", "committedDate": "2020-05-28T21:25:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0MDMyNA==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r432140324", "bodyText": "This case was valid before when split still happened with smartSplit but it's not anymore.", "author": "telendt", "createdAt": "2020-05-28T21:41:32Z", "path": "modules/analysis-common/src/test/java/org/elasticsearch/analysis/common/StemmerOverrideTokenFilterFactoryTests.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.analysis.common;\n+\n+import org.apache.lucene.analysis.Tokenizer;\n+import org.apache.lucene.analysis.core.WhitespaceTokenizer;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.index.analysis.AnalysisTestsHelper;\n+import org.elasticsearch.index.analysis.TokenFilterFactory;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.ESTokenStreamTestCase;\n+import org.junit.Rule;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.List;\n+\n+public class StemmerOverrideTokenFilterFactoryTests extends ESTokenStreamTestCase {\n+    @Rule\n+    public ExpectedException expectedException = ExpectedException.none();\n+\n+    public TokenFilterFactory create(String... rules) throws IOException {\n+        ESTestCase.TestAnalysis analysis = AnalysisTestsHelper.createTestAnalysisFromSettings(\n+            Settings.builder()\n+                .put(\"index.analysis.filter.my_stemmer_override.type\", \"stemmer_override\")\n+                .putList(\"index.analysis.filter.my_stemmer_override.rules\", rules)\n+                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toString())\n+                .build(),\n+            new CommonAnalysisPlugin());\n+\n+        return analysis.tokenFilter.get(\"my_stemmer_override\");\n+    }\n+\n+    public void testRuleError() {\n+        for (String rule : List.of(\n+            \"\",        // empty\n+            \"a\",       // no arrow\n+            \"a=>b=>c\", // multiple arrows\n+            \"=>a=>b\",  // multiple arrows", "originalCommit": "91be65109cd5612955a6dbb70812abbf1e76cd29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "32c3fc50ca4cdb8919bdde03967d3bf3256fa7c8", "url": "https://github.com/elastic/elasticsearch/commit/32c3fc50ca4cdb8919bdde03967d3bf3256fa7c8", "message": "Support multiple tokens on LHS in stemmer_override rules (#56113)\n\nThis commit adds support for rules with multiple tokens on LHS, also\nknown as \"contraction rules\", into stemmer override token\nfilter. Contraction rules are handy into translating multiple\ninflected words into the same root form. One side effect of this change is\nthat it brings stemmer override rules format closer to synonym rules\nformat so that it makes it easier to translate one into another.\n\nThis change also makes stemmer override rules parser more strict so\nthat it should catch more errors which were previously accepted.", "committedDate": "2020-05-29T14:43:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU2NjA0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r432566042", "bodyText": "Another small complaint coming from CI here:\n\"Forbidden method invocation: java.lang.String#format(java.lang.String,java.lang.Object[]) [Uses default locale]\"\nThe \"forbiddenAPIs\" plugin is configured to require several string-related methods to specify the locale explicitely, e.g. using Locale.ROOT here would work.", "author": "cbuescher", "createdAt": "2020-05-29T15:32:56Z", "path": "modules/analysis-common/src/test/java/org/elasticsearch/analysis/common/StemmerOverrideTokenFilterFactoryTests.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.analysis.common;\n+\n+import org.apache.lucene.analysis.Tokenizer;\n+import org.apache.lucene.analysis.core.WhitespaceTokenizer;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.index.analysis.AnalysisTestsHelper;\n+import org.elasticsearch.index.analysis.TokenFilterFactory;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.ESTokenStreamTestCase;\n+import org.junit.Rule;\n+import org.junit.rules.ExpectedException;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.util.List;\n+\n+public class StemmerOverrideTokenFilterFactoryTests extends ESTokenStreamTestCase {\n+    @Rule\n+    public ExpectedException expectedException = ExpectedException.none();\n+\n+    public static TokenFilterFactory create(String... rules) throws IOException {\n+        ESTestCase.TestAnalysis analysis = AnalysisTestsHelper.createTestAnalysisFromSettings(\n+            Settings.builder()\n+                .put(\"index.analysis.filter.my_stemmer_override.type\", \"stemmer_override\")\n+                .putList(\"index.analysis.filter.my_stemmer_override.rules\", rules)\n+                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toString())\n+                .build(),\n+            new CommonAnalysisPlugin());\n+\n+        return analysis.tokenFilter.get(\"my_stemmer_override\");\n+    }\n+\n+    public void testRuleError() {\n+        for (String rule : List.of(\n+            \"\",        // empty\n+            \"a\",       // no arrow\n+            \"a=>b=>c\", // multiple arrows\n+            \"=>a=>b\",  // multiple arrows\n+            \"a=>\",     // no override\n+            \"a=>b,c\",  // multiple overrides\n+            \"=>a\",     // no keys\n+            \"a,=>b\"    // empty key\n+        )) {\n+            expectThrows(RuntimeException.class, String.format(\"Should fail for invalid rule: '%s'\", rule), () -> create(rule));", "originalCommit": "32c3fc50ca4cdb8919bdde03967d3bf3256fa7c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU3MTc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/56484#discussion_r432571798", "bodyText": "ok, I've just pushed a fix", "author": "telendt", "createdAt": "2020-05-29T15:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU2NjA0Mg=="}], "type": "inlineReview"}, {"oid": "d9a882ad71d69b78b23a40e97a00752db2f1fd2b", "url": "https://github.com/elastic/elasticsearch/commit/d9a882ad71d69b78b23a40e97a00752db2f1fd2b", "message": "Support multiple tokens on LHS in stemmer_override rules (#56113)\n\nThis commit adds support for rules with multiple tokens on LHS, also\nknown as \"contraction rules\", into stemmer override token\nfilter. Contraction rules are handy into translating multiple\ninflected words into the same root form. One side effect of this change is\nthat it brings stemmer override rules format closer to synonym rules\nformat so that it makes it easier to translate one into another.\n\nThis change also makes stemmer override rules parser more strict so\nthat it should catch more errors which were previously accepted.", "committedDate": "2020-05-29T15:41:48Z", "type": "commit"}, {"oid": "d9a882ad71d69b78b23a40e97a00752db2f1fd2b", "url": "https://github.com/elastic/elasticsearch/commit/d9a882ad71d69b78b23a40e97a00752db2f1fd2b", "message": "Support multiple tokens on LHS in stemmer_override rules (#56113)\n\nThis commit adds support for rules with multiple tokens on LHS, also\nknown as \"contraction rules\", into stemmer override token\nfilter. Contraction rules are handy into translating multiple\ninflected words into the same root form. One side effect of this change is\nthat it brings stemmer override rules format closer to synonym rules\nformat so that it makes it easier to translate one into another.\n\nThis change also makes stemmer override rules parser more strict so\nthat it should catch more errors which were previously accepted.", "committedDate": "2020-05-29T15:41:48Z", "type": "forcePushed"}, {"oid": "e649e51b41a8de43d54710770d38a962afd04222", "url": "https://github.com/elastic/elasticsearch/commit/e649e51b41a8de43d54710770d38a962afd04222", "message": "Merge branch 'master' into stemmer-overrride-multiple-tokens-rule", "committedDate": "2020-05-29T16:09:16Z", "type": "commit"}]}