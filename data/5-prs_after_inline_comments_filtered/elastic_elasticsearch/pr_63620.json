{"pr_number": 63620, "pr_title": "Introduce quota-aware filesystem ES plugin", "pr_createdAt": "2020-10-13T15:07:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63620", "timeline": [{"oid": "3a6ec3f2147435a387225c4e928fd0e65397a614", "url": "https://github.com/elastic/elasticsearch/commit/3a6ec3f2147435a387225c4e928fd0e65397a614", "message": "First import", "committedDate": "2020-08-19T13:30:50Z", "type": "commit"}, {"oid": "4e6a69cdf02bf07f943fec0fdc9abf56caee41d7", "url": "https://github.com/elastic/elasticsearch/commit/4e6a69cdf02bf07f943fec0fdc9abf56caee41d7", "message": "WIP - moving quota-aware-fs to a plugin", "committedDate": "2020-08-19T13:30:50Z", "type": "commit"}, {"oid": "70334a1b9c7c480c673a36293fd3189484b0f7b2", "url": "https://github.com/elastic/elasticsearch/commit/70334a1b9c7c480c673a36293fd3189484b0f7b2", "message": "Check test now passes", "committedDate": "2020-08-19T13:34:31Z", "type": "commit"}, {"oid": "1a8ed4e3ae5424c9ed144b2e5ada338d3ce3d114", "url": "https://github.com/elastic/elasticsearch/commit/1a8ed4e3ae5424c9ed144b2e5ada338d3ce3d114", "message": "Introduce bootstrap-only plugins", "committedDate": "2020-08-24T10:27:55Z", "type": "commit"}, {"oid": "6946f70beed030bb5af98e0b1c2c344ab8d582f1", "url": "https://github.com/elastic/elasticsearch/commit/6946f70beed030bb5af98e0b1c2c344ab8d582f1", "message": "WIP - trying to write an IT", "committedDate": "2020-08-25T10:59:33Z", "type": "commit"}, {"oid": "1fe9839a07aa8fe6f7c7b139302981b14d91f635", "url": "https://github.com/elastic/elasticsearch/commit/1fe9839a07aa8fe6f7c7b139302981b14d91f635", "message": "Fruitless tweaks", "committedDate": "2020-08-25T14:43:13Z", "type": "commit"}, {"oid": "ff7f7275f38cedbe3a39b90a05d36976315f1fc9", "url": "https://github.com/elastic/elasticsearch/commit/ff7f7275f38cedbe3a39b90a05d36976315f1fc9", "message": "Add logic to enable the plugin", "committedDate": "2020-09-03T13:11:56Z", "type": "commit"}, {"oid": "ca50d586e95885d946d53a7f6dac8415dc093ae9", "url": "https://github.com/elastic/elasticsearch/commit/ca50d586e95885d946d53a7f6dac8415dc093ae9", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-09-14T12:44:43Z", "type": "commit"}, {"oid": "d03dd02f83cff1f40c410078568ae1c5631118ee", "url": "https://github.com/elastic/elasticsearch/commit/d03dd02f83cff1f40c410078568ae1c5631118ee", "message": "Fixes to get ES running with quota enforcement", "committedDate": "2020-09-14T14:27:34Z", "type": "commit"}, {"oid": "5d3a6dd884425d313df5d20460cf413f67fcdc2d", "url": "https://github.com/elastic/elasticsearch/commit/5d3a6dd884425d313df5d20460cf413f67fcdc2d", "message": "Always require system property to set quota fs properties URI", "committedDate": "2020-09-14T15:17:59Z", "type": "commit"}, {"oid": "0d9e88e94788563dd32136329d6669f576382228", "url": "https://github.com/elastic/elasticsearch/commit/0d9e88e94788563dd32136329d6669f576382228", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-09-16T14:00:12Z", "type": "commit"}, {"oid": "5c19a8cf286479b73dbd2554b39e077edfdfd265", "url": "https://github.com/elastic/elasticsearch/commit/5c19a8cf286479b73dbd2554b39e077edfdfd265", "message": "WIP - packaging test for quota fs plugin", "committedDate": "2020-09-18T10:57:07Z", "type": "commit"}, {"oid": "d5231d8d0f75e1c4daaf848870bbe7b2229229d7", "url": "https://github.com/elastic/elasticsearch/commit/d5231d8d0f75e1c4daaf848870bbe7b2229229d7", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-09-22T14:00:59Z", "type": "commit"}, {"oid": "db6db5bf86d9f7f719e8d0aaa355a087be912f1a", "url": "https://github.com/elastic/elasticsearch/commit/db6db5bf86d9f7f719e8d0aaa355a087be912f1a", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-12T14:51:19Z", "type": "commit"}, {"oid": "49107849e65a12c80c745e1f98e82d006365d48a", "url": "https://github.com/elastic/elasticsearch/commit/49107849e65a12c80c745e1f98e82d006365d48a", "message": "Cleanups", "committedDate": "2020-10-13T10:18:51Z", "type": "commit"}, {"oid": "a9e26aee38d88172f62b601895c996b28f00bea0", "url": "https://github.com/elastic/elasticsearch/commit/a9e26aee38d88172f62b601895c996b28f00bea0", "message": "Remove unnecessary test file", "committedDate": "2020-10-13T10:21:46Z", "type": "commit"}, {"oid": "addeeebc61d0165c18ca80fc1d5d3249da51b31f", "url": "https://github.com/elastic/elasticsearch/commit/addeeebc61d0165c18ca80fc1d5d3249da51b31f", "message": "Also test refreshes", "committedDate": "2020-10-13T10:53:00Z", "type": "commit"}, {"oid": "740fa3d7fb5ef32be70ce86b13f004e24007415c", "url": "https://github.com/elastic/elasticsearch/commit/740fa3d7fb5ef32be70ce86b13f004e24007415c", "message": "Tweak", "committedDate": "2020-10-13T12:48:41Z", "type": "commit"}, {"oid": "176b49373594ab01f5c824b754a3e3ed4287357d", "url": "https://github.com/elastic/elasticsearch/commit/176b49373594ab01f5c824b754a3e3ed4287357d", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-13T13:08:21Z", "type": "commit"}, {"oid": "76e8b7a5cebbc26b3aa0b25f0e1f07d6151d0f4e", "url": "https://github.com/elastic/elasticsearch/commit/76e8b7a5cebbc26b3aa0b25f0e1f07d6151d0f4e", "message": "Add comment", "committedDate": "2020-10-13T13:39:37Z", "type": "commit"}, {"oid": "889d39c7e3d60f6e90746d9bf0c935ca8b08714b", "url": "https://github.com/elastic/elasticsearch/commit/889d39c7e3d60f6e90746d9bf0c935ca8b08714b", "message": "Revert changes to run pkg tests on Darwin", "committedDate": "2020-10-13T13:46:07Z", "type": "commit"}, {"oid": "e57c25e85d0e60012e931b8ddd8e7365a755140f", "url": "https://github.com/elastic/elasticsearch/commit/e57c25e85d0e60012e931b8ddd8e7365a755140f", "message": "More cleanup", "committedDate": "2020-10-13T13:58:44Z", "type": "commit"}, {"oid": "5999ac8086c640351162a480c07232c084da6438", "url": "https://github.com/elastic/elasticsearch/commit/5999ac8086c640351162a480c07232c084da6438", "message": "Add test", "committedDate": "2020-10-13T14:58:17Z", "type": "commit"}, {"oid": "99dd544ad4359d21b490d3a23e91bbcc4284bf1e", "url": "https://github.com/elastic/elasticsearch/commit/99dd544ad4359d21b490d3a23e91bbcc4284bf1e", "message": "Support creating symlinks in quota-aware fs plugin", "committedDate": "2020-10-13T15:02:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MzE0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504053146", "bodyText": "This naming is a bit confusing, specifically the \"only\" part. Other plugins are not \"bootstrap\" plugins, so this plugin is not \"only\" a bootstrap plugin. Perhaps instead we could have a \"type\" attribute or something like that which defaults to \"isolated\", and then have this alternative value \"bootstrap\"?", "author": "rjernst", "createdAt": "2020-10-13T15:35:04Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/plugin/PluginPropertiesExtension.java", "diffHunk": "@@ -105,6 +107,14 @@ public void setHasNativeController(boolean hasNativeController) {\n         this.hasNativeController = hasNativeController;\n     }\n \n+    public boolean isBootstrapOnly() {", "originalCommit": "99dd544ad4359d21b490d3a23e91bbcc4284bf1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMjI1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504722259", "bodyText": "I've changed to a \"type\" as you suggested.", "author": "pugnascotia", "createdAt": "2020-10-14T14:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MzE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1NTcxMA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504055710", "bodyText": "I don't understand what advantages a marker interface gives here. A bootstrap plugin's purpose is to add code to the root classloader, so that it can be used by the jdk and other parts of the system that are loaded before plugins are loaded. I don't see a reason why these plugins should have a Plugin class at all?", "author": "rjernst", "createdAt": "2020-10-13T15:38:22Z", "path": "server/src/main/java/org/elasticsearch/plugins/BootstrapPlugin.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.plugins;\n+\n+/**\n+ * Bootstrap plugins are not loaded during normal Elasticsearch operation. This\n+ * interface exists to make this explicit.\n+ */\n+public interface BootstrapPlugin {", "originalCommit": "99dd544ad4359d21b490d3a23e91bbcc4284bf1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMzA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504723056", "bodyText": "Ah...I think I originally added it, thinking I'd use it to filter out bootstrap plugins, but of course you need to load the plugin to inspect it \ud83e\udd26. I should have removed it earlier, but it's gone now.", "author": "pugnascotia", "createdAt": "2020-10-14T14:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1NTcxMA=="}], "type": "inlineReview"}, {"oid": "dd90399786535d7743d21c5a57b6f73a03568dba", "url": "https://github.com/elastic/elasticsearch/commit/dd90399786535d7743d21c5a57b6f73a03568dba", "message": "Generalise the bootstrap plugin mechanism", "committedDate": "2020-10-14T13:28:29Z", "type": "commit"}, {"oid": "e0d0fffa6a71c4befcad1baa8a470ca415ee680f", "url": "https://github.com/elastic/elasticsearch/commit/e0d0fffa6a71c4befcad1baa8a470ca415ee680f", "message": "Use enums for plugin type", "committedDate": "2020-10-14T14:08:53Z", "type": "commit"}, {"oid": "9855478fe8cb3ba89784650279e5a9de18cf7e7a", "url": "https://github.com/elastic/elasticsearch/commit/9855478fe8cb3ba89784650279e5a9de18cf7e7a", "message": "Prohibit isolated plugins from specifying java.opts at runtime", "committedDate": "2020-10-14T14:09:14Z", "type": "commit"}, {"oid": "41eb079b78d5984825eb89f747f6cc8690eef896", "url": "https://github.com/elastic/elasticsearch/commit/41eb079b78d5984825eb89f747f6cc8690eef896", "message": "Compilation fix", "committedDate": "2020-10-14T14:31:11Z", "type": "commit"}, {"oid": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "url": "https://github.com/elastic/elasticsearch/commit/2289280379b7f96330b5e630c9da1bfbf085f7ac", "message": "Checkstyle", "committedDate": "2020-10-14T15:06:17Z", "type": "commit"}, {"oid": "f7920aca0049651c071648a0e6c631c34669994e", "url": "https://github.com/elastic/elasticsearch/commit/f7920aca0049651c071648a0e6c631c34669994e", "message": "Formatting", "committedDate": "2020-10-14T15:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2MjQ5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504862492", "bodyText": "Just a note for future thinking there. We moved away from building all plugins and making them available to packaging tests, under the assumption plugins don't have platform specific behavior. Quota aware fs is a special case, I guess, but if we have any more cases like this, we should rethink how we model packaging tests for these plugins so as not to need special sysprops/setup for every one.", "author": "rjernst", "createdAt": "2020-10-14T17:49:01Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -78,6 +78,9 @@\n     private static final String BWC_DISTRIBUTION_SYSPROP = \"tests.bwc-distribution\";\n     private static final String EXAMPLE_PLUGIN_SYSPROP = \"tests.example-plugin\";\n \n+    private static final String QUOTA_AWARE_FS_PLUGIN_CONFIGURATION = \"quotaAwareFsPlugin\";\n+    private static final String QUOTA_AWARE_FS_PLUGIN_SYSPROP = \"tests.quota-aware-fs-plugin\";", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2ODc2OA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504868768", "bodyText": "Could we not use Booleans.parseBoolean?", "author": "rjernst", "createdAt": "2020-10-14T17:59:16Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginInfo.java", "diffHunk": "@@ -172,36 +183,45 @@ public static PluginInfo readFromProperties(final Path path) throws IOException\n             extendedPlugins = Arrays.asList(Strings.delimitedListToStringArray(extendedString, \",\"));\n         }\n \n-        final String hasNativeControllerValue = propsMap.remove(\"has.native.controller\");\n-        final boolean hasNativeController;\n-        if (hasNativeControllerValue == null) {\n-            hasNativeController = false;\n-        } else {\n-            switch (hasNativeControllerValue) {\n-                case \"true\":\n-                    hasNativeController = true;\n-                    break;\n-                case \"false\":\n-                    hasNativeController = false;\n-                    break;\n-                default:\n-                    final String message = String.format(\n-                            Locale.ROOT,\n-                            \"property [%s] must be [%s], [%s], or unspecified but was [%s]\",\n-                            \"has_native_controller\",\n-                            \"true\",\n-                            \"false\",\n-                            hasNativeControllerValue);\n-                    throw new IllegalArgumentException(message);\n-            }\n+        final boolean hasNativeController = parseBooleanValue(\"has.native.controller\", propsMap.remove(\"has.native.controller\"));\n+\n+        final String typeString = propsMap.remove(\"type\");\n+        if (Strings.isNullOrEmpty(typeString)) {\n+            throw new IllegalArgumentException(\"property [type] is missing for plugin [\" + name + \"]\");\n         }\n \n+        final PluginType type = PluginType.valueOf(typeString.toUpperCase());\n+\n+        final String javaOpts = propsMap.remove(\"java.opts\");\n+\n         if (propsMap.isEmpty() == false) {\n             throw new IllegalArgumentException(\"Unknown properties in plugin descriptor: \" + propsMap.keySet());\n         }\n \n         return new PluginInfo(name, description, version, esVersion, javaVersionString,\n-                              classname, extendedPlugins, hasNativeController);\n+                              classname, extendedPlugins, hasNativeController, type, javaOpts);\n+    }\n+\n+    private static boolean parseBooleanValue(String name, String rawValue) {", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTA4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r505429089", "bodyText": "Boolean.parseBoolean never throws an exception, so we'd lose the validation part.", "author": "pugnascotia", "createdAt": "2020-10-15T10:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2ODc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NzIwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r505887206", "bodyText": "I didn't mean the parse method from Boolean, I mean that from o.e.c.Booleans, which throws an error on non true/false values.", "author": "rjernst", "createdAt": "2020-10-15T21:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2ODc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTI5NA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504869294", "bodyText": "I think this will break a lot of plugin authors who have static plugin properties. Can we instead default type to isolated?", "author": "rjernst", "createdAt": "2020-10-14T18:00:08Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginInfo.java", "diffHunk": "@@ -172,36 +183,45 @@ public static PluginInfo readFromProperties(final Path path) throws IOException\n             extendedPlugins = Arrays.asList(Strings.delimitedListToStringArray(extendedString, \",\"));\n         }\n \n-        final String hasNativeControllerValue = propsMap.remove(\"has.native.controller\");\n-        final boolean hasNativeController;\n-        if (hasNativeControllerValue == null) {\n-            hasNativeController = false;\n-        } else {\n-            switch (hasNativeControllerValue) {\n-                case \"true\":\n-                    hasNativeController = true;\n-                    break;\n-                case \"false\":\n-                    hasNativeController = false;\n-                    break;\n-                default:\n-                    final String message = String.format(\n-                            Locale.ROOT,\n-                            \"property [%s] must be [%s], [%s], or unspecified but was [%s]\",\n-                            \"has_native_controller\",\n-                            \"true\",\n-                            \"false\",\n-                            hasNativeControllerValue);\n-                    throw new IllegalArgumentException(message);\n-            }\n+        final boolean hasNativeController = parseBooleanValue(\"has.native.controller\", propsMap.remove(\"has.native.controller\"));\n+\n+        final String typeString = propsMap.remove(\"type\");\n+        if (Strings.isNullOrEmpty(typeString)) {\n+            throw new IllegalArgumentException(\"property [type] is missing for plugin [\" + name + \"]\");", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTI1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r505429252", "bodyText": "It now defaults to isolated.", "author": "pugnascotia", "createdAt": "2020-10-15T10:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTUzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504869536", "bodyText": "Can we error if java opts is set for non bootstrap plugins?", "author": "rjernst", "createdAt": "2020-10-14T18:00:34Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginInfo.java", "diffHunk": "@@ -172,36 +183,45 @@ public static PluginInfo readFromProperties(final Path path) throws IOException\n             extendedPlugins = Arrays.asList(Strings.delimitedListToStringArray(extendedString, \",\"));\n         }\n \n-        final String hasNativeControllerValue = propsMap.remove(\"has.native.controller\");\n-        final boolean hasNativeController;\n-        if (hasNativeControllerValue == null) {\n-            hasNativeController = false;\n-        } else {\n-            switch (hasNativeControllerValue) {\n-                case \"true\":\n-                    hasNativeController = true;\n-                    break;\n-                case \"false\":\n-                    hasNativeController = false;\n-                    break;\n-                default:\n-                    final String message = String.format(\n-                            Locale.ROOT,\n-                            \"property [%s] must be [%s], [%s], or unspecified but was [%s]\",\n-                            \"has_native_controller\",\n-                            \"true\",\n-                            \"false\",\n-                            hasNativeControllerValue);\n-                    throw new IllegalArgumentException(message);\n-            }\n+        final boolean hasNativeController = parseBooleanValue(\"has.native.controller\", propsMap.remove(\"has.native.controller\"));\n+\n+        final String typeString = propsMap.remove(\"type\");\n+        if (Strings.isNullOrEmpty(typeString)) {\n+            throw new IllegalArgumentException(\"property [type] is missing for plugin [\" + name + \"]\");\n         }\n \n+        final PluginType type = PluginType.valueOf(typeString.toUpperCase());\n+\n+        final String javaOpts = propsMap.remove(\"java.opts\");", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTc4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r505429780", "bodyText": "I actually had that in, then removed it because of the validation I added to bin/elasticsearch, but I've put it back in to be on the safe side.", "author": "pugnascotia", "createdAt": "2020-10-15T10:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2OTg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504869876", "bodyText": "nit: only -> plugin", "author": "rjernst", "createdAt": "2020-10-14T18:01:06Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -349,31 +350,36 @@ static void checkForFailedPluginRemovals(final Path pluginsDirectory) throws IOE\n     private static Set<Bundle> findBundles(final Path directory, String type) throws IOException {\n         final Set<Bundle> bundles = new HashSet<>();\n         for (final Path plugin : findPluginDirs(directory)) {\n-            final Bundle bundle = readPluginBundle(bundles, plugin, type);\n-            bundles.add(bundle);\n+            final Bundle bundle = readPluginBundle(plugin, type);\n+            if (bundle.plugin.getType() == PluginType.BOOTSTRAP) {\n+                logger.trace(\"--- skipping bootstrap only [{}] [{}]\", type, plugin.toAbsolutePath());", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3MDM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r504870346", "bodyText": "nit: this trace is going to produce a string every time. the message should be wrapped in a lambda?", "author": "rjernst", "createdAt": "2020-10-14T18:02:02Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -349,31 +350,36 @@ static void checkForFailedPluginRemovals(final Path pluginsDirectory) throws IOE\n     private static Set<Bundle> findBundles(final Path directory, String type) throws IOException {\n         final Set<Bundle> bundles = new HashSet<>();\n         for (final Path plugin : findPluginDirs(directory)) {\n-            final Bundle bundle = readPluginBundle(bundles, plugin, type);\n-            bundles.add(bundle);\n+            final Bundle bundle = readPluginBundle(plugin, type);\n+            if (bundle.plugin.getType() == PluginType.BOOTSTRAP) {\n+                logger.trace(\"--- skipping bootstrap only [{}] [{}]\", type, plugin.toAbsolutePath());\n+            } else {\n+                if (bundles.add(bundle) == false) {\n+                    throw new IllegalStateException(\"duplicate \" + type + \": \" + bundle.plugin);\n+                }\n+                if (type.equals(\"module\") && bundle.plugin.getName().startsWith(\"test-\") && Build.CURRENT.isSnapshot() == false) {\n+                    throw new IllegalStateException(\"external test module [\" + plugin.getFileName() + \"] found in non-snapshot build\");\n+                }\n+            }\n         }\n \n+        logger.trace(\n+            \"findBundles(\" + type + \") returning: \" + bundles.stream().map(b -> b.plugin.getName()).sorted().collect(Collectors.toList())", "originalCommit": "2289280379b7f96330b5e630c9da1bfbf085f7ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTk4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r505429984", "bodyText": "I've wrapped it in a lambda.", "author": "pugnascotia", "createdAt": "2020-10-15T10:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3MDM0Ng=="}], "type": "inlineReview"}, {"oid": "4631fdb6e7de04ea7b1d39fe06bc6a94bc89dc80", "url": "https://github.com/elastic/elasticsearch/commit/4631fdb6e7de04ea7b1d39fe06bc6a94bc89dc80", "message": "Lots of compilation fixes, apply review feedback", "committedDate": "2020-10-15T09:58:53Z", "type": "commit"}, {"oid": "0ec64e6d1c86c133d0fceca56d746516c94d2594", "url": "https://github.com/elastic/elasticsearch/commit/0ec64e6d1c86c133d0fceca56d746516c94d2594", "message": "Add tests", "committedDate": "2020-10-15T10:16:17Z", "type": "commit"}, {"oid": "0b16b6b92c312ae9ad4344ddf5bee0cb417e0e89", "url": "https://github.com/elastic/elasticsearch/commit/0b16b6b92c312ae9ad4344ddf5bee0cb417e0e89", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-15T10:30:37Z", "type": "commit"}, {"oid": "d32346e9c594fe43ab984bb0fa860be9cb2160ff", "url": "https://github.com/elastic/elasticsearch/commit/d32346e9c594fe43ab984bb0fa860be9cb2160ff", "message": "Don't load quota-aware-fs plugin for docs:integTest", "committedDate": "2020-10-15T11:18:26Z", "type": "commit"}, {"oid": "67cd8738f16b353e441924f561f7b1b925bd5eaa", "url": "https://github.com/elastic/elasticsearch/commit/67cd8738f16b353e441924f561f7b1b925bd5eaa", "message": "Address review feedback", "committedDate": "2020-10-16T10:43:54Z", "type": "commit"}, {"oid": "409d5c6b4f2dfca25f28fda3b570a981ce0dac4c", "url": "https://github.com/elastic/elasticsearch/commit/409d5c6b4f2dfca25f28fda3b570a981ce0dac4c", "message": "Process bootstrap plugin in JvmOptionsParser", "committedDate": "2020-10-16T12:52:12Z", "type": "commit"}, {"oid": "d0bcca1bc146ad402e503ddb77f56274812e969c", "url": "https://github.com/elastic/elasticsearch/commit/d0bcca1bc146ad402e503ddb77f56274812e969c", "message": "Refactor BootstrapJvmOptions for unit testing", "committedDate": "2020-10-16T14:27:43Z", "type": "commit"}, {"oid": "dfb8bcec433cb2e943349b49c9615d6b51cee7b0", "url": "https://github.com/elastic/elasticsearch/commit/dfb8bcec433cb2e943349b49c9615d6b51cee7b0", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-16T14:28:16Z", "type": "commit"}, {"oid": "02201c7ab020c93dde4dd42c34703ffc27b6fb58", "url": "https://github.com/elastic/elasticsearch/commit/02201c7ab020c93dde4dd42c34703ffc27b6fb58", "message": "Checkstyle", "committedDate": "2020-10-16T14:33:03Z", "type": "commit"}, {"oid": "bf3f52f5c15c040c3b91632439cb89db27fb2121", "url": "https://github.com/elastic/elasticsearch/commit/bf3f52f5c15c040c3b91632439cb89db27fb2121", "message": "Use java.nio.file due to checkstyle", "committedDate": "2020-10-16T15:37:51Z", "type": "commit"}, {"oid": "231800e276bbc9a37ba374ebbf8c1c357596682b", "url": "https://github.com/elastic/elasticsearch/commit/231800e276bbc9a37ba374ebbf8c1c357596682b", "message": "Windows fix", "committedDate": "2020-10-16T19:39:01Z", "type": "commit"}, {"oid": "f066f4acf527c44d9936a8e5f4c757948272e5ad", "url": "https://github.com/elastic/elasticsearch/commit/f066f4acf527c44d9936a8e5f4c757948272e5ad", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-16T19:39:05Z", "type": "commit"}, {"oid": "e1870faa80d2a6c73e4189e3c40cc42ddc02b656", "url": "https://github.com/elastic/elasticsearch/commit/e1870faa80d2a6c73e4189e3c40cc42ddc02b656", "message": "Fix test", "committedDate": "2020-10-19T08:55:02Z", "type": "commit"}, {"oid": "6b57ebe8735f29eadb7d3ed2168a10bf5e753857", "url": "https://github.com/elastic/elasticsearch/commit/6b57ebe8735f29eadb7d3ed2168a10bf5e753857", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-19T08:55:24Z", "type": "commit"}, {"oid": "dd721d3eb73241e8587129e891c615007c909ece", "url": "https://github.com/elastic/elasticsearch/commit/dd721d3eb73241e8587129e891c615007c909ece", "message": "Also update elasticsearch-service.bat", "committedDate": "2020-10-19T09:37:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMDIxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r507620215", "bodyText": "Now that this is becoming a plugin and as such is released for every ES version, it could just use the Lucene version in ES", "author": "beiske", "createdAt": "2020-10-19T09:55:30Z", "path": "plugins/quota-aware-fs/src/main/java/org/elasticsearch/fs/quotaaware/QuotaAwareFileSystemProvider.java", "diffHunk": "@@ -0,0 +1,464 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.fs.quotaaware;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+import java.nio.channels.AsynchronousFileChannel;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.SeekableByteChannel;\n+import java.nio.file.AccessMode;\n+import java.nio.file.CopyOption;\n+import java.nio.file.DirectoryStream;\n+import java.nio.file.DirectoryStream.Filter;\n+import java.nio.file.FileStore;\n+import java.nio.file.FileSystem;\n+import java.nio.file.LinkOption;\n+import java.nio.file.OpenOption;\n+import java.nio.file.Path;\n+import java.nio.file.ProviderMismatchException;\n+import java.nio.file.StandardOpenOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileAttributeView;\n+import java.nio.file.spi.FileSystemProvider;\n+import java.security.AccessController;\n+import java.security.PrivilegedActionException;\n+import java.security.PrivilegedExceptionAction;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.FutureTask;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.stream.StreamSupport;\n+\n+/**\n+ * QuotaAwareFileSystemProvider is intended to be used as a wrapper around the\n+ * default file system provider of the JVM.\n+ *\n+ * It augments the default file system by allowing to report total size and\n+ * remaining capacity according to some externally defined quota that is not\n+ * readily available to the JVM. Essentially it is a workaround for containers\n+ * that see the size of the host volume and not the effective quota available to\n+ * them. It will however never report larger capacity than what the underlying\n+ * file system sees.\n+ *\n+ * In application usage:\n+ * <ol>\n+ * <li>Include this project in the class path</li>\n+ * <li>Specify this argument at JVM boot:\n+ * <code>-Djava.nio.file.spi.DefaultFileSystemProvider=co.elastic.cloud.quotaawarefs.QuotaAwareFileSystemProvider</code>\n+ * </li>\n+ * <li>Have some external system check the quota usage and\n+ * write it to the path specified by the system property {@value #QUOTA_PATH_KEY}.</li>\n+ * </ol>\n+ *\n+ * In any case the quota file must be a {@link Properties} file with the\n+ * properties <code>total</code> and <code>remaining</code>. Both properties are\n+ * {@link Long} values, parsed according to {@link Long#parseLong(String)} and\n+ * assumed to be in bytes.\n+ *\n+ * Sample format:\n+ *\n+ * <pre>\n+ * {@code\n+ * total=5000\n+ * remaining=200\n+ * }\n+ * </pre>\n+ */\n+public class QuotaAwareFileSystemProvider extends FileSystemProvider implements AutoCloseable {\n+\n+    private static final int CHECK_PERIOD = 1000;\n+\n+    private final class RefreshLimitsTask extends TimerTask {\n+        @Override\n+        public void run() {\n+            try {\n+                assert timerThread == Thread.currentThread() : \"QuotaAwareFileSystemProvider doesn't support multithreaded timer.\";\n+                refreshLimits();\n+            } catch (Exception e) {\n+                // Canceling from the timer Thread guarantees last execution,\n+                // so no need to check for duplicate error\n+                error.set(e);\n+                timer.cancel();\n+            }\n+        }\n+\n+    }\n+\n+    static final String QUOTA_PATH_KEY = \"es.fs.quota.file\";\n+\n+    private final FileSystemProvider delegate;\n+    private final Path configPath;\n+\n+    private volatile long total = Long.MAX_VALUE;\n+    private volatile long remaining = Long.MAX_VALUE;\n+\n+    private final Timer timer;\n+\n+    private final ConcurrentHashMap<FileSystem, QuotaAwareFileSystem> systemsCache = new ConcurrentHashMap<>();\n+    private final ConcurrentHashMap<FileStore, QuotaAwareFileStore> storesCache = new ConcurrentHashMap<>();\n+    private final AtomicBoolean closed = new AtomicBoolean(false);\n+    private final AtomicReference<Throwable> error = new AtomicReference<>();\n+\n+    private static final AtomicInteger NEXT_SERIAL = new AtomicInteger(0);\n+    private final String timerThreadName = \"QuotaAwareFSTimer-\" + NEXT_SERIAL.getAndIncrement();\n+    private final Thread timerThread;\n+\n+    public QuotaAwareFileSystemProvider(FileSystemProvider delegate) throws Exception {\n+        this(delegate, URI.create(getUri()));\n+    }\n+\n+    private static String getUri() {\n+        final String property = System.getProperty(QUOTA_PATH_KEY);\n+        if (property == null) {\n+            throw new IllegalArgumentException(\n+                \"Property \"\n+                    + QUOTA_PATH_KEY\n+                    + \" must be set to a URI in order to use the quota filesystem provider, e.g. using -D\"\n+                    + QUOTA_PATH_KEY\n+                    + \"=file://path/to/fsquota.properties\"\n+            );\n+        }\n+\n+        return property;\n+    }\n+\n+    public QuotaAwareFileSystemProvider(FileSystemProvider delegate, URI config) throws Exception {\n+        if (delegate instanceof QuotaAwareFileSystemProvider) {\n+            throw new IllegalArgumentException(\"Delegate provider cannot be an instance of QuotaAwareFileSystemProvider\");\n+        }\n+        this.delegate = delegate;\n+        configPath = delegate.getPath(config);\n+        refreshLimits(); // Ensures that a parseable file exists before\n+                         // timer is created\n+        timer = new Timer(timerThreadName, true);\n+        try {\n+            timerThread = getThreadFromTimer(timer).get();\n+            timer.schedule(new RefreshLimitsTask(), CHECK_PERIOD, CHECK_PERIOD);\n+        } catch (Exception e1) {\n+            if (e1 instanceof InterruptedException) {\n+                Thread.currentThread().interrupt(); // Restore interrupted flag\n+            }\n+            try {\n+                // Avoid thread leak if this failed to start\n+                timer.cancel();\n+            } catch (Exception e2) {\n+                e1.addSuppressed(e2);\n+            }\n+            throw e1;\n+        }\n+    }\n+\n+    /**\n+     * Extracts the {@link Thread} used by a {@link Timer}.\n+     *\n+     * Ideally {@link Timer} would provide necessary health checks or error\n+     * handling support that this would not be required.\n+     *\n+     * @param timer\n+     *            The {@link Timer} instance to extract thread from\n+     * @return the Thread used by the given timer\n+     * @throws IllegalStateException\n+     *             if Timer is cancelled.\n+     */\n+    private static Future<Thread> getThreadFromTimer(Timer timer) {\n+        FutureTask<Thread> timerThreadFuture = new FutureTask<>(() -> Thread.currentThread());\n+        timer.schedule(new TimerTask() {\n+            @Override\n+            public void run() {\n+                timerThreadFuture.run();\n+            }\n+        }, 0);\n+        return timerThreadFuture;\n+    }\n+\n+    /**\n+     * Performs a single attempt at reading the required files.\n+     *\n+     * @throws PrivilegedActionException if something goes wrong\n+     * @throws IOException if something goes wrong\n+     *\n+     * @throws IllegalStateException\n+     *             if security manager denies reading the property file\n+     * @throws IllegalStateException\n+     *             if the property file cannot be parsed\n+     */\n+    private void refreshLimits() throws IOException, PrivilegedActionException {\n+        try (InputStream newInputStream = AccessController.doPrivileged(new PrivilegedExceptionAction<InputStream>() {\n+            @Override\n+            public InputStream run() throws Exception {\n+                return delegate.newInputStream(configPath, StandardOpenOption.READ);\n+            }\n+        })) {\n+            Properties properties = new Properties();\n+            properties.load(newInputStream);\n+            total = Long.parseLong(properties.getProperty(\"total\"));\n+            remaining = Long.parseLong(properties.getProperty(\"remaining\"));\n+        }\n+    }\n+\n+    @Override\n+    public String getScheme() {\n+        return \"file\";\n+    }\n+\n+    @Override\n+    public FileSystem newFileSystem(URI uri, Map<String, ?> env) throws IOException {\n+        // Delegate handles throwing exception if filesystem already exists\n+        return getFS(delegate.newFileSystem(uri, env));\n+\n+    }\n+\n+    private QuotaAwareFileSystem getFS(FileSystem fileSystem) {\n+        return systemsCache.computeIfAbsent(fileSystem, (delegate) -> new QuotaAwareFileSystem(this, delegate));\n+    }\n+\n+    @Override\n+    public FileSystem getFileSystem(URI uri) {\n+        // Delegate handles throwing exception if filesystem doesn't exist, but\n+        // delegate may also have precreated filesystems, like the default file\n+        // system.\n+        return getFS(delegate.getFileSystem(uri));\n+    }\n+\n+    @Override\n+    public Path getPath(URI uri) {\n+        return ensureWrapped(delegate.getPath(uri));\n+    }\n+\n+    private Path ensureWrapped(Path path) {\n+        if (path instanceof QuotaAwarePath) {\n+            assert path.getFileSystem().provider() == this;\n+            // Delegate may use this instance to create the path when this\n+            // instance is installed as the default provider.\n+            // This is safe because nested QuotaAwareProviders are prohibited,\n+            // otherwise this would require unwrapping.\n+            return path;\n+        } else {\n+            return new QuotaAwarePath(getFS(path.getFileSystem()), path);\n+        }\n+    }\n+\n+    @Override\n+    public SeekableByteChannel newByteChannel(Path path, Set<? extends OpenOption> options, FileAttribute<?>... attrs) throws IOException {\n+        return delegate.newByteChannel(QuotaAwarePath.unwrap(path), options, attrs);\n+    }\n+\n+    @Override\n+    public DirectoryStream<Path> newDirectoryStream(Path dir, Filter<? super Path> filter) throws IOException {\n+        return new DirectoryStream<Path>() {\n+            DirectoryStream<Path> stream = delegate.newDirectoryStream(QuotaAwarePath.unwrap(dir), filter);\n+\n+            @Override\n+            public void close() throws IOException {\n+                stream.close();\n+            }\n+\n+            @Override\n+            public Iterator<Path> iterator() {\n+                return StreamSupport.stream(stream.spliterator(), false).map(QuotaAwareFileSystemProvider.this::ensureWrapped).iterator();\n+            }\n+        };\n+    }\n+\n+    @Override\n+    public void createDirectory(Path dir, FileAttribute<?>... attrs) throws IOException {\n+        delegate.createDirectory(QuotaAwarePath.unwrap(dir), attrs);\n+    }\n+\n+    @Override\n+    public void delete(Path path) throws IOException {\n+        delegate.delete(QuotaAwarePath.unwrap(path));\n+    }\n+\n+    @Override\n+    public void copy(Path source, Path target, CopyOption... options) throws IOException {\n+        delegate.copy(QuotaAwarePath.unwrap(source), QuotaAwarePath.unwrap(target), options);\n+    }\n+\n+    @Override\n+    public void move(Path source, Path target, CopyOption... options) throws IOException {\n+        delegate.move(QuotaAwarePath.unwrap(source), QuotaAwarePath.unwrap(target), options);\n+    }\n+\n+    @Override\n+    public boolean isSameFile(Path path, Path path2) throws IOException {\n+        return delegate.isSameFile(QuotaAwarePath.unwrap(path), QuotaAwarePath.unwrap(path2));\n+    }\n+\n+    @Override\n+    public boolean isHidden(Path path) throws IOException {\n+        return delegate.isHidden(QuotaAwarePath.unwrap(path));\n+    }\n+\n+    @Override\n+    public QuotaAwareFileStore getFileStore(Path path) throws IOException {\n+        return getFileStore(delegate.getFileStore(QuotaAwarePath.unwrap(path)));\n+    }\n+\n+    QuotaAwareFileStore getFileStore(FileStore store) {\n+        return storesCache.computeIfAbsent(store, (fs) -> new QuotaAwareFileStore(QuotaAwareFileSystemProvider.this, fs));\n+    }\n+\n+    @Override\n+    public void checkAccess(Path path, AccessMode... modes) throws IOException {\n+        delegate.checkAccess(QuotaAwarePath.unwrap(path), modes);\n+    }\n+\n+    @Override\n+    public <V extends FileAttributeView> V getFileAttributeView(Path path, Class<V> type, LinkOption... options) {\n+        return delegate.getFileAttributeView(QuotaAwarePath.unwrap(path), type, options);\n+    }\n+\n+    @Override\n+    public <A extends BasicFileAttributes> A readAttributes(Path path, Class<A> type, LinkOption... options) throws IOException {\n+        try {\n+            return delegate.readAttributes(QuotaAwarePath.unwrap(path), type, options);\n+        } catch (ProviderMismatchException e) {\n+            throw new IllegalArgumentException(\"Failed to read attributes for path: [\" + path + \"]\", e);\n+        }\n+    }\n+\n+    @Override\n+    public Map<String, Object> readAttributes(Path path, String attributes, LinkOption... options) throws IOException {\n+        return delegate.readAttributes(QuotaAwarePath.unwrap(path), attributes, options);\n+    }\n+\n+    @Override\n+    public void setAttribute(Path path, String attribute, Object value, LinkOption... options) throws IOException {\n+        delegate.setAttribute(QuotaAwarePath.unwrap(path), attribute, value, options);\n+    }\n+\n+    long getTotal() {\n+        ensureHealth();\n+        return total;\n+    }\n+\n+    void ensureHealth() throws AssertionError {\n+        boolean timerIsAlive = timerThread.isAlive();\n+        Throwable cause = error.get();\n+        if (cause != null || !timerIsAlive) {\n+            throw new AssertionError(\"The quota aware filesystem has failed\", cause);\n+        }\n+    }\n+\n+    long getRemaining() {\n+        ensureHealth();\n+        return remaining;\n+    }\n+\n+    @Override\n+    public FileChannel newFileChannel(Path path, Set<? extends OpenOption> options, FileAttribute<?>... attrs) throws IOException {\n+        return delegate.newFileChannel(QuotaAwarePath.unwrap(path), options, attrs);\n+    }\n+\n+    @Override\n+    public AsynchronousFileChannel newAsynchronousFileChannel(\n+        Path path,\n+        Set<? extends OpenOption> options,\n+        ExecutorService executor,\n+        FileAttribute<?>... attrs\n+    ) throws IOException {\n+        return delegate.newAsynchronousFileChannel(QuotaAwarePath.unwrap(path), options, executor, attrs);\n+    }\n+\n+    /**\n+     * Normally only used in testing. Avoids thread leak when life cycle of this\n+     * object doesn't follow that of the JVM.\n+     *\n+     * @throws IOException if something goes wrong\n+     */\n+    @Override\n+    public void close() throws IOException {\n+        if (closed.compareAndSet(false, true)) {\n+            timer.cancel();\n+\n+            // If there was a currently executing task wait for it, to\n+            // avoid false positives on file handle leak.\n+            try {\n+                timerThread.join();\n+            } catch (InterruptedException e) {\n+                Thread.currentThread().interrupt(); // Restore interrupted flag\n+            }\n+\n+            try {\n+                // Inlined org.apache.lucene.util.IOUtils.close(...) to", "originalCommit": "dd721d3eb73241e8587129e891c615007c909ece", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MTY2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r507651661", "bodyText": "Ah, I meant to do that, thanks Konrad.", "author": "pugnascotia", "createdAt": "2020-10-19T10:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYyMDIxNQ=="}], "type": "inlineReview"}, {"oid": "37ecce2b1263bedc89bea25c338e05736c3bf14f", "url": "https://github.com/elastic/elasticsearch/commit/37ecce2b1263bedc89bea25c338e05736c3bf14f", "message": "Fix serialisation", "committedDate": "2020-10-19T10:44:04Z", "type": "commit"}, {"oid": "e91bcfb9b3935859e630d285f910ea2d9eaf0df8", "url": "https://github.com/elastic/elasticsearch/commit/e91bcfb9b3935859e630d285f910ea2d9eaf0df8", "message": "De-inline Lucene's IOUtils.close", "committedDate": "2020-10-19T10:49:19Z", "type": "commit"}, {"oid": "841bd8fb9615f279de503e1dbd198cf33bcb60e0", "url": "https://github.com/elastic/elasticsearch/commit/841bd8fb9615f279de503e1dbd198cf33bcb60e0", "message": "Test fix", "committedDate": "2020-10-19T12:56:47Z", "type": "commit"}, {"oid": "39424c13401fd5fc55ececb9bd5cb498a700e545", "url": "https://github.com/elastic/elasticsearch/commit/39424c13401fd5fc55ececb9bd5cb498a700e545", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-19T12:57:01Z", "type": "commit"}, {"oid": "2dba9dee54397f457d4d35cb0aa269ee687eee89", "url": "https://github.com/elastic/elasticsearch/commit/2dba9dee54397f457d4d35cb0aa269ee687eee89", "message": "Merge branch 'master' into quota-aware-fs", "committedDate": "2020-10-19T18:49:38Z", "type": "commit"}, {"oid": "824b22b7c9fe5bff5b548b1ea85b0f82a4a369de", "url": "https://github.com/elastic/elasticsearch/commit/824b22b7c9fe5bff5b548b1ea85b0f82a4a369de", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-20T08:22:47Z", "type": "commit"}, {"oid": "d80d1161c639d683a7b291e03a33580223614084", "url": "https://github.com/elastic/elasticsearch/commit/d80d1161c639d683a7b291e03a33580223614084", "message": "Merge branch 'master' into quota-aware-fs", "committedDate": "2020-10-20T10:05:15Z", "type": "commit"}, {"oid": "3585d82b0e42172e6c3e82270a5ad95ab1b7d181", "url": "https://github.com/elastic/elasticsearch/commit/3585d82b0e42172e6c3e82270a5ad95ab1b7d181", "message": "Ignore quota-aware-fs in qa:smoke-test-plugins", "committedDate": "2020-10-20T10:35:07Z", "type": "commit"}, {"oid": "eac24a9407a2d69cbdc0f328d086dc73a4ad8046", "url": "https://github.com/elastic/elasticsearch/commit/eac24a9407a2d69cbdc0f328d086dc73a4ad8046", "message": "Yet more test fixes", "committedDate": "2020-10-20T12:32:37Z", "type": "commit"}, {"oid": "baabd62b36210d703f69838547b279461255d535", "url": "https://github.com/elastic/elasticsearch/commit/baabd62b36210d703f69838547b279461255d535", "message": "And another test fix", "committedDate": "2020-10-20T15:18:59Z", "type": "commit"}, {"oid": "eb2cf448861ac68aa380801e6d9a5f8b679c870a", "url": "https://github.com/elastic/elasticsearch/commit/eb2cf448861ac68aa380801e6d9a5f8b679c870a", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-20T15:19:13Z", "type": "commit"}, {"oid": "abbdbb1d3de3330f9681d5d532e5a36be37ebaed", "url": "https://github.com/elastic/elasticsearch/commit/abbdbb1d3de3330f9681d5d532e5a36be37ebaed", "message": "Add docs for quota-aware-fs plugin", "committedDate": "2020-10-21T13:36:35Z", "type": "commit"}, {"oid": "f907e2fa1a8d7234360c944f00ea42a352b66016", "url": "https://github.com/elastic/elasticsearch/commit/f907e2fa1a8d7234360c944f00ea42a352b66016", "message": "Update docs/plugins/quota-aware-fs.asciidoc\r\n\r\nFix ref syntax\n\nCo-authored-by: James Rodewig <40268737+jrodewig@users.noreply.github.com>", "committedDate": "2020-10-21T13:58:55Z", "type": "commit"}, {"oid": "0f707e1dabd8c2af87283d435a52fe7262700fd1", "url": "https://github.com/elastic/elasticsearch/commit/0f707e1dabd8c2af87283d435a52fe7262700fd1", "message": "Prevent fs activity causing flaky quota tests\n\nThe test QuotaAwareFileSystemProviderTests.testFileStoreNotLimited\nrelied on the host's disk space totals not changing in the course of the\ntest. This has mostly always been true, but then failed in CI. Prevent\nthis from reoccurring by introducing a FilesystemProvider that takes\na snapshot of the disk totals upon creation.", "committedDate": "2020-10-22T09:32:44Z", "type": "commit"}, {"oid": "ef86e4a113f983736df712c5735963b5175bcd79", "url": "https://github.com/elastic/elasticsearch/commit/ef86e4a113f983736df712c5735963b5175bcd79", "message": "Checkstyle", "committedDate": "2020-10-22T14:12:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQxNzc0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r510417742", "bodyText": "docs please", "author": "rjernst", "createdAt": "2020-10-22T19:52:22Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/plugin/PluginType.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.plugin;\n+\n+/* Mirrors org.elasticsearch.plugins.PluginType */\n+\n+import java.util.Locale;\n+\n+public enum PluginType {", "originalCommit": "ef86e4a113f983736df712c5735963b5175bcd79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0NDQyMw==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r511844423", "bodyText": "Docs added.", "author": "pugnascotia", "createdAt": "2020-10-26T10:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQxNzc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMzQ0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r510423446", "bodyText": "This class shouldn't be necessary anymore?", "author": "rjernst", "createdAt": "2020-10-22T20:02:46Z", "path": "plugins/quota-aware-fs/src/main/java/org/elasticsearch/fs/quotaaware/QuotaAwareFsPlugin.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.fs.quotaaware;\n+\n+import org.elasticsearch.plugins.Plugin;\n+\n+/**\n+ * This plugin adds support for passing information to Elasticsearch about\n+ * filesystem quotas, so that any mechanisms that need to know about free /\n+ * used space can perform accurate calculation with respect to the disk\n+ * space that is actually available to Elasticsearch.\n+ */\n+public class QuotaAwareFsPlugin extends Plugin {", "originalCommit": "ef86e4a113f983736df712c5735963b5175bcd79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0NDU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r511844560", "bodyText": "Good spot, I've removed it.", "author": "pugnascotia", "createdAt": "2020-10-26T10:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyMzQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNTc2OA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r510425768", "bodyText": "This should be 7.11?", "author": "rjernst", "createdAt": "2020-10-22T20:07:14Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginInfo.java", "diffHunk": "@@ -49,6 +50,8 @@\n     public static final String ES_PLUGIN_PROPERTIES = \"plugin-descriptor.properties\";\n     public static final String ES_PLUGIN_POLICY = \"plugin-security.policy\";\n \n+    private static final Version QUOTA_FS_PLUGIN_SUPPORT = Version.CURRENT;", "originalCommit": "ef86e4a113f983736df712c5735963b5175bcd79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0NzA4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r511847083", "bodyText": "I can't do that until the changes are backported - I learnt that the hard way on another branch.", "author": "pugnascotia", "createdAt": "2020-10-26T10:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA1OTk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r513059964", "bodyText": "This can be done. There are 2 ways to handle the backports. One is to put CURRENT in master, change it on the backport, then go back to master and change all the occurrences. The other is to put the intended version in master and disable bwc tests (there is a global flag in the root build.gradle), backport, then re-enable bwc tests in master after the backport is complete. The latter has the advantages that the backport can be tested locally before committing to master, as well as only a single place to change (the bwc flag) on followup, instead of potentially multiple versioned conditional statements.", "author": "rjernst", "createdAt": "2020-10-27T22:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNTc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MjU4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63620#discussion_r513372580", "bodyText": "I believe this is the only place that I reference a version. I'll go for the former route I think.", "author": "pugnascotia", "createdAt": "2020-10-28T11:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyNTc2OA=="}], "type": "inlineReview"}, {"oid": "1e490e3c24bdc0e37f5001464755198ac84ebb7e", "url": "https://github.com/elastic/elasticsearch/commit/1e490e3c24bdc0e37f5001464755198ac84ebb7e", "message": "Merge remote-tracking branch 'upstream/master' into quota-aware-fs", "committedDate": "2020-10-26T09:13:14Z", "type": "commit"}, {"oid": "aac38f459ff4ef4f3425f8aaace8b5982fa8fd67", "url": "https://github.com/elastic/elasticsearch/commit/aac38f459ff4ef4f3425f8aaace8b5982fa8fd67", "message": "Remove QuotaAwareFsPlugin, drop classname req for bootstrap plugins", "committedDate": "2020-10-26T10:05:01Z", "type": "commit"}, {"oid": "6fbb76af3165714ff8d34689c76669b30ee9556e", "url": "https://github.com/elastic/elasticsearch/commit/6fbb76af3165714ff8d34689c76669b30ee9556e", "message": "Omit classname from bootstrap plugin descriptor", "committedDate": "2020-10-26T10:08:06Z", "type": "commit"}, {"oid": "feb8a05c8b54bede0ca7ef9b91f8dbd81abc1b4d", "url": "https://github.com/elastic/elasticsearch/commit/feb8a05c8b54bede0ca7ef9b91f8dbd81abc1b4d", "message": "Handle missing plugin classname when loading plugins", "committedDate": "2020-10-26T11:50:12Z", "type": "commit"}]}