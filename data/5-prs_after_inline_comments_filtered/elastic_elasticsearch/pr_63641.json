{"pr_number": 63641, "pr_title": "Dependency Graph gradle Task", "pr_createdAt": "2020-10-13T19:59:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63641", "timeline": [{"oid": "89783c7b401bbd6043d1d0b342f4efcb37542de6", "url": "https://github.com/elastic/elasticsearch/commit/89783c7b401bbd6043d1d0b342f4efcb37542de6", "message": "snyk-depgraph-poc", "committedDate": "2020-10-13T14:39:42Z", "type": "commit"}, {"oid": "c5d2bd93df093575ca7b266e409034d5b31a86c5", "url": "https://github.com/elastic/elasticsearch/commit/c5d2bd93df093575ca7b266e409034d5b31a86c5", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-10-13T14:40:20Z", "type": "commit"}, {"oid": "09bdf2291d39423697857dccf783b02394db8091", "url": "https://github.com/elastic/elasticsearch/commit/09bdf2291d39423697857dccf783b02394db8091", "message": "Fix precommit checks", "committedDate": "2020-10-13T18:58:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Mzg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r504553871", "bodyText": "this adds a implicit dependency to the JavaPlugin. we should shield this by putting this within a\nproject.getPlugins().withType(JavaPlugin.class, p -> {\n                        t.setRuntimeConfiguration(project.getConfigurations().getByName(JavaPlugin.RUNTIME_CLASSPATH_CONFIGURATION_NAME));\n\n});\n        ```", "author": "breskeby", "createdAt": "2020-10-14T09:59:27Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphPlugin.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.elasticsearch.gradle.dependencies.CompileOnlyResolvePlugin;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+public class DependenciesGraphPlugin implements Plugin<Project> {\n+\n+    public void apply(Project project) {\n+        project.getPlugins().apply(CompileOnlyResolvePlugin.class);\n+        TaskProvider<DependenciesGraphTask> depsGraph = project.getTasks().register(\"dependenciesGraph\", DependenciesGraphTask.class);\n+        depsGraph.configure(t -> {\n+            t.setRuntimeConfiguration(project.getConfigurations().getByName(JavaPlugin.RUNTIME_CLASSPATH_CONFIGURATION_NAME));", "originalCommit": "09bdf2291d39423697857dccf783b02394db8091", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7eed49eccf178dad94ea2ef99f3b35b8d8a8ee93", "url": "https://github.com/elastic/elasticsearch/commit/7eed49eccf178dad94ea2ef99f3b35b8d8a8ee93", "message": "Address feedback", "committedDate": "2020-10-14T19:49:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkzMzMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r504933321", "bodyText": "Depending on how we can pass secrets from Jenkins to a gradle task, this can be changed/adapted. I'm up for suggestions on how to deal with this", "author": "jkakavas", "createdAt": "2020-10-14T19:52:07Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphTask.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.util.EntityUtils;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.artifacts.DependencySet;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ProjectDependency;\n+import org.gradle.api.tasks.options.Option;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A task to generate a dependency graph of our runtime dependencies and push that via\n+ * an API call to a given endpoint of a SCA tool/service.\n+ * The graph is built according to the specification in https://github.com/snyk/dep-graph#depgraphdata\n+ *\n+ * Due to the nature of our dependency resolution in gradle, we are abusing the aforementioned graph definition as\n+ * the graph we construct has a single root ( the subproject ) and all dependencies are children of that root,\n+ * irrespective of if they are direct dependencies or transitive ones ( that should be children of other children ).\n+ * Although we end up lacking some contextual information, this allows us to scan and monitor only the dependencies\n+ * that are bundled and used in runtime.\n+ */\n+public class DependenciesGraphTask extends DefaultTask {\n+\n+    private Configuration runtimeConfiguration;\n+    private Configuration compileOnlyConfiguration;\n+    private String url;\n+    private String token;\n+\n+    @InputFiles\n+    public Configuration getRuntimeConfiguration() {\n+        return runtimeConfiguration;\n+    }\n+\n+    @InputFiles\n+    public Configuration getCompileOnlyConfiguration() {\n+        return compileOnlyConfiguration;\n+    }\n+\n+    public void setRuntimeConfiguration(Configuration runtimeConfiguration) {\n+        this.runtimeConfiguration = runtimeConfiguration;\n+    }\n+\n+    public void setCompileOnlyConfiguration(Configuration compileOnlyConfiguration) {\n+        this.compileOnlyConfiguration = compileOnlyConfiguration;\n+    }\n+\n+    @Option(option = \"url\", description = \"The API endpoint to call with the dependency graph\")\n+    public void setUrl(String url) {\n+        this.url = url;\n+    }\n+\n+    @Input\n+    public String getUrl() {\n+        return this.url;\n+    }\n+\n+    @Option(option = \"token\", description = \"The API KEY used to authenticate to the API\")", "originalCommit": "7eed49eccf178dad94ea2ef99f3b35b8d8a8ee93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk3MTQ4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r507971489", "bodyText": "Yeah, we probably dont' want to use a CLI option, as this would leak the secret into the build logs. Given that we can probably ditch the @Option bit here and simply read it from something like an environment variable which we can inject into the build.", "author": "mark-vieira", "createdAt": "2020-10-19T18:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkzMzMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0ODAyMg==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r508048022", "bodyText": "Why are we including compile-only dependencies? These aren't bundled with Elasticsearch so I'm not sure we should be including them in our report. Security vulnerabilities, by definition, should only be applicable to runtime code.", "author": "mark-vieira", "createdAt": "2020-10-19T20:39:24Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphTask.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.util.EntityUtils;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.artifacts.DependencySet;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ProjectDependency;\n+import org.gradle.api.tasks.options.Option;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A task to generate a dependency graph of our runtime dependencies and push that via\n+ * an API call to a given endpoint of a SCA tool/service.\n+ * The graph is built according to the specification in https://github.com/snyk/dep-graph#depgraphdata\n+ *\n+ * Due to the nature of our dependency resolution in gradle, we are abusing the aforementioned graph definition as\n+ * the graph we construct has a single root ( the subproject ) and all dependencies are children of that root,\n+ * irrespective of if they are direct dependencies or transitive ones ( that should be children of other children ).\n+ * Although we end up lacking some contextual information, this allows us to scan and monitor only the dependencies\n+ * that are bundled and used in runtime.\n+ */\n+public class DependenciesGraphTask extends DefaultTask {\n+\n+    private Configuration runtimeConfiguration;\n+    private Configuration compileOnlyConfiguration;", "originalCommit": "7eed49eccf178dad94ea2ef99f3b35b8d8a8ee93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5ODQ5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r510298499", "bodyText": "We are not including them, we are resolving them here so that we can exclude them. See https://github.com/elastic/elasticsearch/pull/63641/files#diff-09a991b3b2c89b70a65e2e26cccdb4ee8c24ce440f82706e44aa79948dad51c1R119", "author": "jkakavas", "createdAt": "2020-10-22T16:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0ODAyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5OTIzNw==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r510299237", "bodyText": "The resolving runtime dependencies process is picked up from our dependenciesInfo task", "author": "jkakavas", "createdAt": "2020-10-22T16:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA0ODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1MTY5MA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r508051690", "bodyText": "Since this task performs network operations, we should probably explicitly fail if a user attempts to run it in offline mode, similarly to what we do for the verifyVersions task.", "author": "mark-vieira", "createdAt": "2020-10-19T20:46:13Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphTask.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.util.EntityUtils;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.artifacts.DependencySet;\n+import org.gradle.api.artifacts.ModuleVersionIdentifier;\n+import org.gradle.api.artifacts.ProjectDependency;\n+import org.gradle.api.tasks.options.Option;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A task to generate a dependency graph of our runtime dependencies and push that via\n+ * an API call to a given endpoint of a SCA tool/service.\n+ * The graph is built according to the specification in https://github.com/snyk/dep-graph#depgraphdata\n+ *\n+ * Due to the nature of our dependency resolution in gradle, we are abusing the aforementioned graph definition as\n+ * the graph we construct has a single root ( the subproject ) and all dependencies are children of that root,\n+ * irrespective of if they are direct dependencies or transitive ones ( that should be children of other children ).\n+ * Although we end up lacking some contextual information, this allows us to scan and monitor only the dependencies\n+ * that are bundled and used in runtime.\n+ */\n+public class DependenciesGraphTask extends DefaultTask {\n+\n+    private Configuration runtimeConfiguration;\n+    private Configuration compileOnlyConfiguration;\n+    private String url;\n+    private String token;\n+\n+    @InputFiles\n+    public Configuration getRuntimeConfiguration() {\n+        return runtimeConfiguration;\n+    }\n+\n+    @InputFiles\n+    public Configuration getCompileOnlyConfiguration() {\n+        return compileOnlyConfiguration;\n+    }\n+\n+    public void setRuntimeConfiguration(Configuration runtimeConfiguration) {\n+        this.runtimeConfiguration = runtimeConfiguration;\n+    }\n+\n+    public void setCompileOnlyConfiguration(Configuration compileOnlyConfiguration) {\n+        this.compileOnlyConfiguration = compileOnlyConfiguration;\n+    }\n+\n+    @Option(option = \"url\", description = \"The API endpoint to call with the dependency graph\")\n+    public void setUrl(String url) {\n+        this.url = url;\n+    }\n+\n+    @Input\n+    public String getUrl() {\n+        return this.url;\n+    }\n+\n+    @Option(option = \"token\", description = \"The API KEY used to authenticate to the API\")\n+    public void setToken(String token) {\n+        this.token = token;\n+    }\n+\n+    @Input\n+    public String getToken() {\n+        return this.token;\n+    }\n+\n+    @TaskAction\n+    void generateDependenciesGraph() {\n+        final DependencySet runtimeDependencies = runtimeConfiguration.getAllDependencies();\n+        final Set<String> packages = new HashSet<>();\n+        final Set<String> nodes = new HashSet<>();\n+        final Set<String> nodeIds = new HashSet<>();\n+        final Set<String> compileOnlyArtifacts = compileOnlyConfiguration.getResolvedConfiguration()\n+            .getResolvedArtifacts()\n+            .stream()\n+            .map(a -> {\n+                ModuleVersionIdentifier id = a.getModuleVersion().getId();\n+                return id.getGroup() + \":\" + id.getName() + \"@\" + id.getVersion();\n+            })\n+            .collect(Collectors.toSet());\n+        for (final Dependency dependency : runtimeDependencies) {\n+            final String id = dependency.getGroup() + \":\" + dependency.getName();\n+            final String versionedId = id + \"@\" + dependency.getVersion();\n+            final StringBuilder packageString = new StringBuilder();\n+            final StringBuilder nodeString = new StringBuilder();\n+            if (compileOnlyArtifacts.contains(versionedId)) {\n+                continue;\n+            }\n+            if (dependency instanceof ProjectDependency) {\n+                continue;\n+            }\n+            packageString.append(\"{\\\"id\\\": \\\"\")\n+                .append(versionedId)\n+                .append(\"\\\",\\\"info\\\": {\\\"name\\\": \\\"\")\n+                .append(id)\n+                .append(\"\\\",\\\"version\\\": \\\"\")\n+                .append(dependency.getVersion())\n+                .append(\"\\\"}}\");\n+            packages.add(packageString.toString());\n+            nodeString.append(\"{\\\"nodeId\\\": \\\"\")\n+                .append(versionedId)\n+                .append(\"\\\",\\\"pkgId\\\": \\\"\")\n+                .append(versionedId)\n+                .append(\"\\\",\\\"deps\\\": []}\");\n+            nodes.add(nodeString.toString());\n+            nodeIds.add(\"{\\\"nodeId\\\": \\\"\" + versionedId + \"\\\"}\");\n+        }\n+        // We add one package and one node for each dependency, it suffices to check packages.\n+        if (packages.size() > 0) {\n+            final String projectName = \"elastic/elasticsearch\" + getProject().getPath();\n+            final StringBuilder output = new StringBuilder();\n+            output.append(\"{\\\"depGraph\\\": {\\\"schemaVersion\\\": \\\"1.2.0\\\",\\\"pkgManager\\\": {\\\"name\\\": \\\"gradle\\\"},\\\"pkgs\\\": [\")\n+                .append(\"{\\\"id\\\": \\\"\")\n+                .append(projectName)\n+                .append(\"@0.0.0\")\n+                .append(\"\\\", \\\"info\\\": {\\\"name\\\": \\\"\")\n+                .append(projectName)\n+                .append(\"\\\", \\\"version\\\": \\\"0.0.0\\\"}},\")\n+                .append(String.join(\",\", packages))\n+                .append(\"],\\\"graph\\\": {\\\"rootNodeId\\\": \\\"\")\n+                .append(projectName)\n+                .append(\"@0.0.0\")\n+                .append(\"\\\",\\\"nodes\\\": [\")\n+                .append(\"{\\\"nodeId\\\": \\\"\")\n+                .append(projectName)\n+                .append(\"@0.0.0\")\n+                .append(\"\\\",\\\"pkgId\\\": \\\"\")\n+                .append(projectName)\n+                .append(\"@0.0.0\")\n+                .append(\"\\\",\\\"deps\\\": [\")\n+                .append(String.join(\",\", nodeIds))\n+                .append(\"]},\")\n+                .append(String.join(\",\", nodes))\n+                .append(\"]}}}\");\n+            getLogger().debug(\"Dependency Graph: \" + output.toString());\n+            try (CloseableHttpClient client = HttpClients.createDefault()) {", "originalCommit": "7eed49eccf178dad94ea2ef99f3b35b8d8a8ee93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI5OTUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r510299503", "bodyText": "Thanks, will do", "author": "jkakavas", "createdAt": "2020-10-22T16:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1MTY5MA=="}], "type": "inlineReview"}, {"oid": "dae9d6f4f6165f9c5f273c5a8a3fcdffda95b0c8", "url": "https://github.com/elastic/elasticsearch/commit/dae9d6f4f6165f9c5f273c5a8a3fcdffda95b0c8", "message": "address feedback", "committedDate": "2020-10-29T21:38:27Z", "type": "commit"}, {"oid": "1e76307bd6eee0e7fd170064b161864d6f95046f", "url": "https://github.com/elastic/elasticsearch/commit/1e76307bd6eee0e7fd170064b161864d6f95046f", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-10-29T21:38:31Z", "type": "commit"}, {"oid": "fe11254bfcd995a77ef47a4cd153a1ffc720bd56", "url": "https://github.com/elastic/elasticsearch/commit/fe11254bfcd995a77ef47a4cd153a1ffc720bd56", "message": "add dependency ( how meta.. )", "committedDate": "2020-10-29T21:50:42Z", "type": "commit"}, {"oid": "eeb78339b4ec45332bf95ca569772eadeeb88dcf", "url": "https://github.com/elastic/elasticsearch/commit/eeb78339b4ec45332bf95ca569772eadeeb88dcf", "message": "Move offline logic to the Task", "committedDate": "2020-10-30T19:48:04Z", "type": "commit"}, {"oid": "bf3a3a7fe12ac72133043698ce7f91955ea29432", "url": "https://github.com/elastic/elasticsearch/commit/bf3a3a7fe12ac72133043698ce7f91955ea29432", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-10-30T19:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NTQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516195432", "bodyText": "Can we make these properties on the task, and then set them in the plugin?", "author": "mark-vieira", "createdAt": "2020-11-02T19:08:47Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphTask.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.util.EntityUtils;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.artifacts.DependencySet;\n+import org.gradle.api.artifacts.ProjectDependency;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * A task to generate a dependency graph of our runtime dependencies and push that via\n+ * an API call to a given endpoint of a SCA tool/service.\n+ * The graph is built according to the specification in https://github.com/snyk/dep-graph#depgraphdata\n+ *\n+ * Due to the nature of our dependency resolution in gradle, we are abusing the aforementioned graph definition as\n+ * the graph we construct has a single root ( the subproject ) and all dependencies are children of that root,\n+ * irrespective of if they are direct dependencies or transitive ones ( that should be children of other children ).\n+ * Although we end up lacking some contextual information, this allows us to scan and monitor only the dependencies\n+ * that are bundled and used in runtime.\n+ */\n+public class DependenciesGraphTask extends DefaultTask {\n+\n+    private Configuration runtimeConfiguration;\n+    private Configuration compileOnlyConfiguration;\n+\n+    @InputFiles\n+    public Configuration getRuntimeConfiguration() {\n+        return runtimeConfiguration;\n+    }\n+\n+    @InputFiles\n+    public Configuration getCompileOnlyConfiguration() {\n+        return compileOnlyConfiguration;\n+    }\n+\n+    public void setRuntimeConfiguration(Configuration runtimeConfiguration) {\n+        this.runtimeConfiguration = runtimeConfiguration;\n+    }\n+\n+    public void setCompileOnlyConfiguration(Configuration compileOnlyConfiguration) {\n+        this.compileOnlyConfiguration = compileOnlyConfiguration;\n+    }\n+\n+    @TaskAction\n+    void generateDependenciesGraph() {\n+\n+        if (getProject().getGradle().getStartParameter().isOffline()) {\n+            throw new GradleException(\"Must run in online mode in order to submit the dependency graph to the SCA service\");\n+        }\n+        final String url = System.getenv(\"SCA_URL\");\n+        final String token = System.getenv(\"SCA_TOKEN\");\n+        if (null == url || null == token) {", "originalCommit": "bf3a3a7fe12ac72133043698ce7f91955ea29432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNDU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516514564", "bodyText": "Sure thing. What's the benefit of that ? i.e. why do we prefer to do that in the plugin?", "author": "jkakavas", "createdAt": "2020-11-03T09:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NTQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUyMzI3MA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516523270", "bodyText": "The thing I dislike about this is that if the env vars are not set , this now fails with\n* What went wrong:\nSome problems were found with the configuration of task ':rest-api-spec:dependenciesGraph' (type 'DependenciesGraphTask').\n> No value has been specified for property 'token'.\n> No value has been specified for property 'url'.\n\ninstead of the Gradle exception with the proper message before.\nIs there any way to add a more user friendly message to the Task failing if an @Input is passed as null ? I guess I can also annotate those as @Optional and do the null check myself but it sounds like a bad solution as these are not optional at all :)", "author": "jkakavas", "createdAt": "2020-11-03T09:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NTQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1NDU5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516854593", "bodyText": "Sure thing. What's the benefit of that ? i.e. why do we prefer to do that in the plugin?\n\nThe general pattern is that plugins should \"wire\" up tasks. So reaching out to environment variables should be done in the \"wiring\" no in the implementation of the task.\n\nIs there any way to add a more user friendly message to the Task failing if an @input is passed as null ? I guess I can also annotate those as @optional and do the null check myself but it sounds like a bad solution as these are not optional at all :)\n\nThey are optional in the sense that they aren't required unless the task is actually going to execute. So what we instead need to do is add a task graph listener that explodes if a) that task is included in the graph for execution and b) the environment variables are missing (example). In that check we can throw a useful message, including mentioning the task(s) that require the environment variables.", "author": "mark-vieira", "createdAt": "2020-11-03T17:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NTQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NzMwMA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516947300", "bodyText": "Thanks for explaining Mark !", "author": "jkakavas", "createdAt": "2020-11-03T20:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NTQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5NjEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516196106", "bodyText": "Where did we land on this? I thought we decided this could be removed?", "author": "mark-vieira", "createdAt": "2020-11-02T19:10:08Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphPlugin.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.elasticsearch.gradle.dependencies.CompileOnlyResolvePlugin;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+public class DependenciesGraphPlugin implements Plugin<Project> {\n+\n+    public void apply(Project project) {\n+        project.getPlugins().apply(CompileOnlyResolvePlugin.class);\n+        TaskProvider<DependenciesGraphTask> depsGraph = project.getTasks().register(\"dependenciesGraph\", DependenciesGraphTask.class);\n+        depsGraph.configure(t -> {\n+            project.getPlugins().withType(JavaPlugin.class, p -> {\n+                t.setRuntimeConfiguration(project.getConfigurations().getByName(JavaPlugin.RUNTIME_CLASSPATH_CONFIGURATION_NAME));\n+                t.setCompileOnlyConfiguration(", "originalCommit": "bf3a3a7fe12ac72133043698ce7f91955ea29432", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16401875c990e49de1aca2a61bd7c8f1d1dd270a", "url": "https://github.com/elastic/elasticsearch/commit/16401875c990e49de1aca2a61bd7c8f1d1dd270a", "message": "additional feedback", "committedDate": "2020-11-03T09:08:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNTYwNA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516515604", "bodyText": "I don't see us throwing from other plugins so I'm not sure if this is a good practice or not. I prefer this as it throws a meaningful error instead of the Task failing with \"url is missing\" and \"token is missing\"", "author": "jkakavas", "createdAt": "2020-11-03T09:10:42Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphPlugin.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.gradle.api.GradleException;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+public class DependenciesGraphPlugin implements Plugin<Project> {\n+\n+    public void apply(Project project) {\n+        final String url = System.getenv(\"SCA_URL\");\n+        final String token = System.getenv(\"SCA_TOKEN\");\n+        if (null == url || null == token) {\n+            throw new GradleException(\"The environment variables SCA_URL and SCA_TOKEN need to be set before this task is run\");", "originalCommit": "16401875c990e49de1aca2a61bd7c8f1d1dd270a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxOTA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516519099", "bodyText": "Ok, the subsequent failure made me realize there is a good reason why we don't throw in plugins :)", "author": "jkakavas", "createdAt": "2020-11-03T09:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNTYwNA=="}], "type": "inlineReview"}, {"oid": "c46bb0cd1261cca79a547ceb10de3ac1db3bb0e0", "url": "https://github.com/elastic/elasticsearch/commit/c46bb0cd1261cca79a547ceb10de3ac1db3bb0e0", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-11-03T09:11:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNzI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516517299", "bodyText": "Can we make these properties on the task, and then set them in the plugin?\n\nNot entirely sure if this is what you had in mind. If not, please elaborate on what your suggestion is. I'm not clear on whether or not we should annotate those as Input", "author": "jkakavas", "createdAt": "2020-11-03T09:13:34Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphTask.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.entity.StringEntity;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.util.EntityUtils;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.artifacts.DependencySet;\n+import org.gradle.api.artifacts.ProjectDependency;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.TaskAction;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * A task to generate a dependency graph of our runtime dependencies and push that via\n+ * an API call to a given endpoint of a SCA tool/service.\n+ * The graph is built according to the specification in https://github.com/snyk/dep-graph#depgraphdata\n+ *\n+ * Due to the nature of our dependency resolution in gradle, we are abusing the aforementioned graph definition as\n+ * the graph we construct has a single root ( the subproject ) and all dependencies are children of that root,\n+ * irrespective of if they are direct dependencies or transitive ones ( that should be children of other children ).\n+ * Although we end up lacking some contextual information, this allows us to scan and monitor only the dependencies\n+ * that are bundled and used in runtime.\n+ */\n+public class DependenciesGraphTask extends DefaultTask {\n+\n+    private Configuration runtimeConfiguration;\n+    private String token;\n+    private String url;\n+\n+    @Input\n+    public String getUrl() {\n+        return url;\n+    }\n+\n+    public void setUrl(String url) {\n+        this.url = url;\n+    }\n+\n+    @Input", "originalCommit": "16401875c990e49de1aca2a61bd7c8f1d1dd270a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxODc2MA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516518760", "bodyText": "Ok, the subsequent failure made me realize we need to annotate them.", "author": "jkakavas", "createdAt": "2020-11-03T09:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNzI5OQ=="}], "type": "inlineReview"}, {"oid": "37c7d3c8ccbc579a130d93334ffd64490aed88ee", "url": "https://github.com/elastic/elasticsearch/commit/37c7d3c8ccbc579a130d93334ffd64490aed88ee", "message": "Throw only when task is to be run", "committedDate": "2020-11-03T20:48:45Z", "type": "commit"}, {"oid": "dfba293f1ba87be245a29ef1b2a98c8a2fa6dc5e", "url": "https://github.com/elastic/elasticsearch/commit/dfba293f1ba87be245a29ef1b2a98c8a2fa6dc5e", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-11-03T20:49:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516968055", "bodyText": "Let's make the message \"The environment variables SCA_URL and SCA_TOKEN need to be set before task \" + t.getPath() +\" can run\" as it won't be clear to the user what we mean by \"this task\" w/o that context.", "author": "mark-vieira", "createdAt": "2020-11-03T21:33:19Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphPlugin.java", "diffHunk": "@@ -41,5 +38,13 @@ public void apply(Project project) {\n                 t.setUrl(url);\n             });\n         });\n+\n+        project.getGradle().getTaskGraph().whenReady(graph -> {\n+            if (graph.getAllTasks().stream().anyMatch(t -> t instanceof DependenciesGraphTask)) {\n+                if (url == null || token == null) {\n+                    throw new GradleException(\"The environment variables SCA_URL and SCA_TOKEN need to be set before this task is run\");", "originalCommit": "dfba293f1ba87be245a29ef1b2a98c8a2fa6dc5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NzQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516977467", "bodyText": "My thinking was that one either\n\nruns the task for the whole project (gradlew -q dependenciesTask) so that in the DependenciesGraphPlugin ,if we filter for instanceof DependenciesGraphTask we will get all the subprojects. Then which one do you add to the message ( which will be shown N times )\nruns the task for one project (gradlew -q x-pack:plugin:core:dependenciesTask ) so they know what \"this task\" is", "author": "jkakavas", "createdAt": "2020-11-03T21:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4Nzk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516987943", "bodyText": "I would just error on the first task it finds. In any case the \"solution\" is the same for all the others so it's not like we are short-circuiting some other error that'll encounter.", "author": "mark-vieira", "createdAt": "2020-11-03T22:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5MjUyMA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r516992520", "bodyText": "Sure, makes sense. It's just a comment to whether printing the task name in the message is helpful here or not. So it's either someone ran this for all subprojects and we will show a random X:dependenciesTask in the error message, or someone ran this as a specific task, so they know what \"this task\" is (context is there), so showing the task is not that helpful\nI can add this if you think we should though, happy to wrap this up either way we decide", "author": "jkakavas", "createdAt": "2020-11-03T22:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwOTA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r517009055", "bodyText": "Yeah, you could argue in this case folks will be explicitly running those tasks, but I think it's worthwhile to confirm, since there are likely other upstream tasks run here and when in doubt, better to be explicit \ud83d\ude04", "author": "mark-vieira", "createdAt": "2020-11-03T23:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4OTQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r517189429", "bodyText": "I still think that printing\n* What went wrong:\nFailed to notify task execution graph listener.\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :x-pack:plugin:core:dependenciesGraph can run\n....\n....\n....\n....\nN times\n\nwhen someone just ran ./gradlew -q x-pack:plugin:core:dependenciesGraph and\n* What went wrong:\nFailed to notify task execution graph listener.\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :benchmarks:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :benchmarks:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :benchmarks:dependenciesGraph can run\n> The environment variables SCA_URL and SCA_TOKEN need to be set before task :benchmarks:dependenciesGraph can run\n...\n...\n...\nN times\n\nwhen someone ran ./gradlew -q dependenciesGraph ,\nis a bit on the extreme explicitness side, but I'll comply and pick another hill :)", "author": "jkakavas", "createdAt": "2020-11-04T09:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU0NTg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r517545884", "bodyText": "Haha, you are absolutely right. The reason for this is because we are registering that task graph listener multiple times, in fact, every time the plugin is applied. The the task execution graph is \"global\" so you actually only need do this once. We can solve this by putting that logic into a separate plugin, and applying that plugin only to the root project. Plugin application is idempotent so we can apply it to the root project over and over but it'll only actually evaluate once. We do this elsewhere when we want to register \"global\" listeners by a) defining a plugin in an inner class b) adding some logic to that plugin to error if we mistakenly apply it to a project that isn't the root project c) apply that new plugin from the \"outer\" plugin\nhttps://github.com/elastic/elasticsearch/blob/master/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java#L138", "author": "mark-vieira", "createdAt": "2020-11-04T18:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1NjA5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r519856091", "bodyText": "Nice, thanks! I took a swing at this ( Apologies this is dragging but it's low priority - since we got the first graph in manually - and I'm taking long cycles before spending time on it again )", "author": "jkakavas", "createdAt": "2020-11-09T14:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2ODA1NQ=="}], "type": "inlineReview"}, {"oid": "279930900caf41b425d096127e5ea892baa60dde", "url": "https://github.com/elastic/elasticsearch/commit/279930900caf41b425d096127e5ea892baa60dde", "message": "Best effort at printing failing task", "committedDate": "2020-11-04T09:15:45Z", "type": "commit"}, {"oid": "34d1d5380110309bdc99da5c80a0896f2281fcbe", "url": "https://github.com/elastic/elasticsearch/commit/34d1d5380110309bdc99da5c80a0896f2281fcbe", "message": "line length", "committedDate": "2020-11-04T09:22:13Z", "type": "commit"}, {"oid": "72299b078664c9263d5e50b333b2493294dba553", "url": "https://github.com/elastic/elasticsearch/commit/72299b078664c9263d5e50b333b2493294dba553", "message": "line length", "committedDate": "2020-11-04T09:22:19Z", "type": "commit"}, {"oid": "831fe0635aa67a08c1a1aa6ee56892767bef5278", "url": "https://github.com/elastic/elasticsearch/commit/831fe0635aa67a08c1a1aa6ee56892767bef5278", "message": "add a hook plugin and add that to the root project so that it gets evaluated only once", "committedDate": "2020-11-09T14:27:40Z", "type": "commit"}, {"oid": "9badab13a99760f6331476fb495a8d32b842f463", "url": "https://github.com/elastic/elasticsearch/commit/9badab13a99760f6331476fb495a8d32b842f463", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-11-09T14:28:11Z", "type": "commit"}, {"oid": "a29e4d4a34aa862cf6676190de997f7f934f100e", "url": "https://github.com/elastic/elasticsearch/commit/a29e4d4a34aa862cf6676190de997f7f934f100e", "message": "spotless", "committedDate": "2020-11-09T14:32:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MzQ2NA==", "url": "https://github.com/elastic/elasticsearch/pull/63641#discussion_r520153464", "bodyText": "nit: can we do this as the very first line in the apply() method? This is a somewhat unwritten convention.", "author": "mark-vieira", "createdAt": "2020-11-09T22:11:50Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DependenciesGraphPlugin.java", "diffHunk": "@@ -42,22 +42,37 @@ public void apply(Project project) {\n                 t.setUrl(url);\n             });\n         });\n+        project.getRootProject().getPluginManager().apply(DependenciesGraphHookPlugin.class);", "originalCommit": "a29e4d4a34aa862cf6676190de997f7f934f100e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "156714cc051c541f57fef4bbbe71ce4e3ed3d9de", "url": "https://github.com/elastic/elasticsearch/commit/156714cc051c541f57fef4bbbe71ce4e3ed3d9de", "message": "move statement", "committedDate": "2020-11-12T21:04:52Z", "type": "commit"}, {"oid": "82601100223f06187417d9284239b34b8e49cebd", "url": "https://github.com/elastic/elasticsearch/commit/82601100223f06187417d9284239b34b8e49cebd", "message": "Merge remote-tracking branch 'origin/master' into snyk-api-task", "committedDate": "2020-11-12T21:08:13Z", "type": "commit"}, {"oid": "e99aa30d268663b4956ab99009f2eae1142022b8", "url": "https://github.com/elastic/elasticsearch/commit/e99aa30d268663b4956ab99009f2eae1142022b8", "message": "merges are hard", "committedDate": "2020-11-12T21:16:39Z", "type": "commit"}]}