{"pr_number": 54367, "pr_title": "Add warnings/errors when V2 templates would match same indices as V1", "pr_createdAt": "2020-03-27T21:29:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54367", "timeline": [{"oid": "36d132ced766516795d7579c6b0435f4a2e710a8", "url": "https://github.com/elastic/elasticsearch/commit/36d132ced766516795d7579c6b0435f4a2e710a8", "message": "Add warnings/errors when V2 templates would match same indices as V1\n\nWith the introduction of V2 index templates, we want to warn users that templates they put in place\nmight not take precedence (because v2 templates are going to \"win\"). This adds this validation at\n`PUT` time for both V1 and V2 templates with the following rules:\n\n** When creating or updating a V2 template\n- If the v2 template would match indices for an existing v1 template or templates, provide a\nwarning (through the deprecation logging so it shows up to the client) as well as logging the\nwarning\n\nThe v2 warning looks like:\n\n```\nindex template [my-v2-template] has index patterns [foo-*] matching patterns from existing older\ntemplates [old-v1-template,match-all-template] with patterns (old-v1-template =>\n[foo*],match-all-template => [*]); this template [my-v2-template] will take\nprecedence during new index creation\n```\n\n** When creating a V1 template\n- If the v1 template is for index patterns of `\"*\"` and a v2 template exists, warn that the v2\ntemplate may take precedence\n- If the v1 template is for index patterns other than all indices, and a v2 template exists that\nwould match, throw an error preventing creation of the v1 template\n\n** When updating a V1 template (without changing its existing `index_patterns`!)\n- If the v1 template is for index patterns that would match an existing v2 template, warn that the\nv2 template may take precedence.\n\nThe v1 warning looks like:\n\n```\ntemplate [my-v1-template] has index patterns [*] matching patterns from existing index templates\n[existing-v2-template] with patterns (existing-v2-template => [foo*]); this template [my-v1-template] may be ignored in favor of an index template at index creation time\n```\n\nAnd the v1 error looks like:\n\n```\ntemplate [my-v1-template] has index patterns [foo*] matching patterns from existing index templates\n[existing-v2-template] with patterns (existing-v2-template => [f*]), use index templates (/_index_template) instead\n```\n\nRelates to #53101", "committedDate": "2020-03-27T21:25:38Z", "type": "commit"}, {"oid": "e8ba3cf09b79467b4e3bf040db4fa7a558b289f4", "url": "https://github.com/elastic/elasticsearch/commit/e8ba3cf09b79467b4e3bf040db4fa7a558b289f4", "message": "Remove v2 index and component templates when cleaning up tests", "committedDate": "2020-03-27T22:19:38Z", "type": "commit"}, {"oid": "cd1d76d1550a59f21427102dd9633e80cb076b0f", "url": "https://github.com/elastic/elasticsearch/commit/cd1d76d1550a59f21427102dd9633e80cb076b0f", "message": "Finish half-finished comment sentence", "committedDate": "2020-03-27T22:30:55Z", "type": "commit"}, {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72", "url": "https://github.com/elastic/elasticsearch/commit/f2dbda0adf291fd154d81b04dd2b52484c90fb72", "message": "Guard template removal and ignore for earlier versions of ES", "committedDate": "2020-03-27T22:33:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNDY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400014648", "bodyText": "I think we should overlapping v2 templates with the same priority in the same way (but then throw an error) (in another change)", "author": "martijnvg", "createdAt": "2020-03-30T08:32:19Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -272,6 +280,21 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n         }\n \n+        Map<String, List<String>> overlaps = findConflictingV1Templates(currentState, name, template.indexPatterns());\n+        if (overlaps.size() > 0) {", "originalCommit": "f2dbda0adf291fd154d81b04dd2b52484c90fb72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMjc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400212758", "bodyText": "Good idea, I'll add a TODO item to add this validation to the meta issue.", "author": "dakrone", "createdAt": "2020-03-30T13:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNDY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNTQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400015467", "bodyText": "\ud83d\udc4d This method makes validating overlapping templates really easy for index templates v2 :)", "author": "martijnvg", "createdAt": "2020-03-30T08:33:40Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -281,6 +304,48 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             .build();\n     }\n \n+    /**\n+     * Return a map of v1 template names to their index patterns for v1 templates that would overlap\n+     * with the given v2 template's index patterns.\n+     */\n+    static Map<String, List<String>> findConflictingV1Templates(final ClusterState state, final String candidateName,\n+                                                                final List<String> indexPatterns) {\n+        Automaton v2automaton = Regex.simpleMatchToAutomaton(indexPatterns.toArray(Strings.EMPTY_ARRAY));", "originalCommit": "f2dbda0adf291fd154d81b04dd2b52484c90fb72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400018314", "bodyText": "I would have expected that this change was needed in the change that added component templates and not in this change? (not questioning the need for it, but timing)", "author": "martijnvg", "createdAt": "2020-03-30T08:38:34Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -549,9 +549,29 @@ private void wipeCluster() throws Exception {\n                         adminClient().performRequest(new Request(\"DELETE\", \"_template/\" + template));\n                     }\n                 }\n+                try {\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_index_template/*\"));\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_component_template/*\"));", "originalCommit": "f2dbda0adf291fd154d81b04dd2b52484c90fb72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2Mjc0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400262745", "bodyText": "So the index and component templates hung around after YAML tests, but because there was never any warnings/errors, and because they aren't actually used for index creation yet, they didn't cause any errors. This is required now because they were hanging around and then the regular template stuff caused errors/warnings.", "author": "dakrone", "createdAt": "2020-03-30T15:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3ODM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400678340", "bodyText": "thanks, makes sense.", "author": "martijnvg", "createdAt": "2020-03-31T06:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA=="}], "type": "inlineReview"}, {"oid": "3fcba1d9933e8331b2f0bb30febc87011f6bf3f1", "url": "https://github.com/elastic/elasticsearch/commit/3fcba1d9933e8331b2f0bb30febc87011f6bf3f1", "message": "Merge branch 'master' into itv2-version-conflict-checks", "committedDate": "2020-03-30T15:02:35Z", "type": "commit"}]}