{"pr_number": 50643, "pr_title": "Add the new 'maintenance' privilege containing 4 actions (#29998)", "pr_createdAt": "2020-01-06T09:23:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50643", "timeline": [{"oid": "363f1ff89b7035e422fe4a471925f212fa3d4ba1", "url": "https://github.com/elastic/elasticsearch/commit/363f1ff89b7035e422fe4a471925f212fa3d4ba1", "message": "Add the new 'maintenance' privilege containing 4 actions (#29998)", "committedDate": "2020-01-06T09:20:45Z", "type": "commit"}, {"oid": "3421673d4db8a19df88e1ff1790c6c162bd92533", "url": "https://github.com/elastic/elasticsearch/commit/3421673d4db8a19df88e1ff1790c6c162bd92533", "message": "Fix merge conflict", "committedDate": "2020-01-07T00:24:11Z", "type": "commit"}, {"oid": "22f758896edc9e9176ce65f8fe0f05c6ce30340d", "url": "https://github.com/elastic/elasticsearch/commit/22f758896edc9e9176ce65f8fe0f05c6ce30340d", "message": "Fix merge conflict", "committedDate": "2020-01-07T06:45:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MDU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r363990549", "bodyText": "The test that it's failing {\"type\":\"security_exception\",\"reason\":\"action [indices:admin/refresh[s]] is unauthorized for user [u15]\"}}]}} hints that indices:admin/refresh[s] is unauthorized.\nThe refresh action translates into shard wise sub-actions, which are also authorized by themselves.\nYou need to add replace indices:admin/refresh with indices:admin/refresh*.", "author": "albertzaharovits", "createdAt": "2020-01-07T22:51:15Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/privilege/IndexPrivilege.java", "diffHunk": "@@ -66,6 +66,8 @@\n         CloseIndexAction.NAME + \"*\");\n     private static final Automaton MANAGE_LEADER_INDEX_AUTOMATON = patterns(ForgetFollowerAction.NAME + \"*\");\n     private static final Automaton MANAGE_ILM_AUTOMATON = patterns(\"indices:admin/ilm/*\");\n+    private static final Automaton MAINTENANCE_AUTOMATON = patterns(\"indices:admin/refresh\", \"indices:admin/flush\",", "originalCommit": "22f758896edc9e9176ce65f8fe0f05c6ce30340d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYyNjY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r364626671", "bodyText": "This should be:\nprivate static final Automaton MAINTENANCE_AUTOMATON = patterns(\"indices:admin/refresh*\", \"indices:admin/flush*\", \"indices:admin/synced_flush\", \"indices:admin/forcemerge*\");\n\nThe motive is that, as mentioned above, a cluster action might spawn other actions, both on the node first handling the request as well as other nodes on the cluster. Every such action is authorized individually, i.e. the authorization status of the parent action is not consulted. For example, for the refresh (and flush) action translate to indices:admin/refresh[s] (and indices:admin/flush[s]) actions for every index shard, which are then translated into indices:admin/refresh[p] and indices:admin/refresh[r] for the primary and replica shards. The maintenance privilege should grant all these action types, and we customary add the wildcard star to the name of the originating action instead of iterating all the sub-action names.", "author": "albertzaharovits", "createdAt": "2020-01-09T09:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MDU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY2MTIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r364661233", "bodyText": "I don't think we need this fluff. This is testing the authorization of composite requests but refresh and flush are not part of those composite type of requests.\nIn addition to assertUserIsAllowed(\"u15\", \"maintenance\", \"a\"); I would also check that crud is not allowed, and we should also test that other users in this class don't have the maintenance priv (right now it only checks the positive case).", "author": "albertzaharovits", "createdAt": "2020-01-09T10:23:38Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java", "diffHunk": "@@ -385,6 +391,18 @@ public void testUserU14() throws Exception {\n                 \"GET\", \"/\" + randomIndex() + \"/_mtermvectors\", \"{ \\\"docs\\\" : [ { \\\"_id\\\": \\\"1\\\" }, { \\\"_id\\\": \\\"2\\\" } ] }\");\n     }\n \n+    public void testUser15() throws Exception {\n+        assertUserIsAllowed(\"u15\", \"maintenance\", \"a\");\n+\n+        assertAccessIsAllowed(\"u15\",\n+            \"GET\", \"/\" + randomIndex() + \"/_msearch\", \"{}\\n{ \\\"query\\\" : { \\\"match_all\\\" : {} } }\\n\");\n+        assertAccessIsAllowed(\"u15\", \"POST\", \"/\" + randomIndex() + \"/_mget\", \"{ \\\"ids\\\" : [ \\\"1\\\", \\\"2\\\" ] } \");\n+        assertAccessIsDenied(\"u15\", \"PUT\",\n+            \"/\" + randomIndex() + \"/_bulk\", \"{ \\\"index\\\" : { \\\"_id\\\" : \\\"123\\\" } }\\n{ \\\"foo\\\" : \\\"bar\\\" }\\n\");\n+        assertAccessIsAllowed(\"u15\",\n+            \"GET\", \"/\" + randomIndex() + \"/_mtermvectors\", \"{ \\\"docs\\\" : [ { \\\"_id\\\": \\\"1\\\" }, { \\\"_id\\\": \\\"2\\\" } ] }\");", "originalCommit": "22f758896edc9e9176ce65f8fe0f05c6ce30340d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY2MTQ0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r364661447", "bodyText": "Should be assertAccessIsDenied, right?", "author": "albertzaharovits", "createdAt": "2020-01-09T10:24:08Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java", "diffHunk": "@@ -419,6 +437,23 @@ private void assertUserExecutes(String user, String action, String index, boolea\n                 }\n                 break;\n \n+            case \"maintenance\" :\n+                if (userIsAllowed) {\n+                    assertUserIsDenied(user, \"crud\", index);\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_refresh\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_flush\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_flush/synced\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_forcemerge\");\n+                } else {\n+                    assertUserIsDenied(user, \"crud\", index);\n+                    assertAccessIsDenied(user, \"PUT\", \"/\" + index);\n+                    assertAccessIsDenied(user, \"POST\", \"/\" + index + \"/_refresh\");\n+                    assertAccessIsDenied(user, \"POST\", \"/\" + index + \"/_flush\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_flush/synced\");", "originalCommit": "22f758896edc9e9176ce65f8fe0f05c6ce30340d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "73f5763bda10813d7c8a461d279ea6027f6623b3", "url": "https://github.com/elastic/elasticsearch/commit/73f5763bda10813d7c8a461d279ea6027f6623b3", "message": "Apply code review - fixed failed test (#29998)", "committedDate": "2020-01-09T21:23:50Z", "type": "commit"}, {"oid": "0ddc277ad8ca755c8bbeaccc69046fe260c3efff", "url": "https://github.com/elastic/elasticsearch/commit/0ddc277ad8ca755c8bbeaccc69046fe260c3efff", "message": "Fix merge conflict - increase cluster (#29998)", "committedDate": "2020-01-09T21:31:54Z", "type": "commit"}, {"oid": "844c4b13ecb2d9fd58914e7587f03e64d569940e", "url": "https://github.com/elastic/elasticsearch/commit/844c4b13ecb2d9fd58914e7587f03e64d569940e", "message": "Merge branch 'master' into master", "committedDate": "2020-01-09T21:32:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0NTMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r365345314", "bodyText": "Please move this to the testUser11 function and do it for the b and c indices, i.e.\nassertUserIsDenied(\"u11\", \"maintenance\", \"b\");, assertUserIsDenied(\"u11\", \"maintenance\", \"c\"); .", "author": "albertzaharovits", "createdAt": "2020-01-10T17:26:29Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java", "diffHunk": "@@ -385,6 +391,13 @@ public void testUserU14() throws Exception {\n                 \"GET\", \"/\" + randomIndex() + \"/_mtermvectors\", \"{ \\\"docs\\\" : [ { \\\"_id\\\": \\\"1\\\" }, { \\\"_id\\\": \\\"2\\\" } ] }\");\n     }\n \n+    public void testUserU15() throws Exception {\n+        assertUserIsAllowed(\"u15\", \"maintenance\", \"a\");\n+        assertUserIsDenied(\"u15\", \"crud\", \"a\");\n+\n+        assertUserIsDenied(\"u11\", \"maintenance\", \"a\");", "originalCommit": "844c4b13ecb2d9fd58914e7587f03e64d569940e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1a6208a5d12b957024cdde9b2f4b3296e44d03e", "url": "https://github.com/elastic/elasticsearch/commit/e1a6208a5d12b957024cdde9b2f4b3296e44d03e", "message": "Polish message and test (#29998)", "committedDate": "2020-01-10T21:40:16Z", "type": "commit"}, {"oid": "cecd284494df3d3241feeb08fb03263b8da131c4", "url": "https://github.com/elastic/elasticsearch/commit/cecd284494df3d3241feeb08fb03263b8da131c4", "message": "Merge branch 'master' into master", "committedDate": "2020-01-16T21:31:06Z", "type": "commit"}, {"oid": "8a9779ac29b42f1ff1342a413b2b96bd769bbc9e", "url": "https://github.com/elastic/elasticsearch/commit/8a9779ac29b42f1ff1342a413b2b96bd769bbc9e", "message": "Merge branch 'master' into master", "committedDate": "2020-01-27T11:30:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1OTg2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r371559862", "bodyText": "Minor:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        entry(\"maintenance\",MAINTENANCE));\n          \n          \n            \n                        entry(\"maintenance\", MAINTENANCE));", "author": "tvernum", "createdAt": "2020-01-28T00:39:56Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/privilege/IndexPrivilege.java", "diffHunk": "@@ -102,7 +105,8 @@\n             entry(\"read_cross_cluster\", READ_CROSS_CLUSTER),\n             entry(\"manage_follow_index\", MANAGE_FOLLOW_INDEX),\n             entry(\"manage_leader_index\", MANAGE_LEADER_INDEX),\n-            entry(\"manage_ilm\", MANAGE_ILM));\n+            entry(\"manage_ilm\", MANAGE_ILM),\n+            entry(\"maintenance\",MAINTENANCE));", "originalCommit": "8a9779ac29b42f1ff1342a413b2b96bd769bbc9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTUxNg==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r371561516", "bodyText": "I think this this is what we want.\nA user being allowed maintenance should not imply anything about whether they are/aren't allowed crud.", "author": "tvernum", "createdAt": "2020-01-28T00:46:29Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java", "diffHunk": "@@ -419,6 +432,22 @@ private void assertUserExecutes(String user, String action, String index, boolea\n                 }\n                 break;\n \n+            case \"maintenance\" :\n+                if (userIsAllowed) {\n+                    assertUserIsDenied(user, \"crud\", index);", "originalCommit": "8a9779ac29b42f1ff1342a413b2b96bd769bbc9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY4ODc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r371688755", "bodyText": "@tvernum the first and second statement made me a bit confuse. but it looks like the explanation has precedence. so I will remove them.", "author": "amirhmd", "createdAt": "2020-01-28T09:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyMzYwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r372123605", "bodyText": "Sorry, somehow I dropped a word. It should have said:\n\nI don't think this is what we want.\n\nYour fix is correct.", "author": "tvernum", "createdAt": "2020-01-28T23:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTUzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50643#discussion_r371561531", "bodyText": "Per above.", "author": "tvernum", "createdAt": "2020-01-28T00:46:32Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/integration/IndexPrivilegeTests.java", "diffHunk": "@@ -419,6 +432,22 @@ private void assertUserExecutes(String user, String action, String index, boolea\n                 }\n                 break;\n \n+            case \"maintenance\" :\n+                if (userIsAllowed) {\n+                    assertUserIsDenied(user, \"crud\", index);\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_refresh\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_flush\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_flush/synced\");\n+                    assertAccessIsAllowed(user, \"POST\", \"/\" + index + \"/_forcemerge\");\n+                } else {\n+                    assertUserIsDenied(user, \"crud\", index);", "originalCommit": "8a9779ac29b42f1ff1342a413b2b96bd769bbc9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "746d4d7e6d43ef9a4b5241ed4e806357869fd519", "url": "https://github.com/elastic/elasticsearch/commit/746d4d7e6d43ef9a4b5241ed4e806357869fd519", "message": "Polish and remove unnecessary crud check in test (#29998)", "committedDate": "2020-01-28T09:55:58Z", "type": "commit"}]}