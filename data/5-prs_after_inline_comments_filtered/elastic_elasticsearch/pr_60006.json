{"pr_number": 60006, "pr_title": "Fix BwC Snapshot INIT Path", "pr_createdAt": "2020-07-21T18:32:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60006", "timeline": [{"oid": "5c11739d194f97131340826cf9ffacc46aa80e5c", "url": "https://github.com/elastic/elasticsearch/commit/5c11739d194f97131340826cf9ffacc46aa80e5c", "message": "Fix BwC Snapshot INIT Path\n\nThere were two subtle bugs here from backporting #56911 to 7.x.\n\n1. We passed `null` for the `shards` map which isn't nullable any longer\nwhen creating `SnapshotsInProgress.Entry`, fixed by just passing an empty map\nlike the `null` handling did in the past.\n2. The removal of a failed `INIT` state snapshot from the cluster state tried\nremoving it from the finalization loop (the set of repository names that are\ncurrently finalizing). This will trip an assertion since the snapshot failed\nbefore its repository was put into the set. I made the logic ignore the set\nin case we remove a failed `INIT` state snapshot to restore the old logic to\nexactly as it was before the concurrent snapshots backport to be on the safe\nside here.\n\nAlso, added tests that explicitly call the old code paths because as can be seen\nfrom initially missing this, the BwC tests will only run in the configuration new\nversion master, old version nodes ever so often and having a deterministic test\nfor the old state machine seems the safest bet here.\n\nCloses #59986", "committedDate": "2020-07-21T18:29:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NDg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/60006#discussion_r458554848", "bodyText": "maybe refomulate this as (listener == null && repositoryData == null) == false?", "author": "ywelsch", "createdAt": "2020-07-22T06:05:53Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1422,12 +1422,17 @@ private static ClusterState stateWithoutSnapshot(ClusterState state, Snapshot sn\n      * used when the snapshot fails for some reason. During normal operation the snapshot repository will remove the\n      * {@link SnapshotsInProgress.Entry} from the cluster state once it's done finalizing the snapshot.\n      *\n-     * @param snapshot snapshot that failed\n-     * @param failure  exception that failed the snapshot\n+     * @param snapshot       snapshot that failed\n+     * @param failure        exception that failed the snapshot\n+     * @param repositoryData repository data or {@code null} when cleaning up a BwC snapshot that never fully initialized\n+     * @param listener       listener to invoke when done with, only passed by the BwC path that has {@code repositoryData} set to\n+     *                       {@code null}\n      */\n     private void removeFailedSnapshotFromClusterState(Snapshot snapshot, Exception failure, @Nullable RepositoryData repositoryData,\n                                                       @Nullable CleanupAfterErrorListener listener) {\n         assert failure != null : \"Failure must be supplied\";\n+        assert (listener == null || repositoryData == null) && (repositoryData != null || listener != null) :", "originalCommit": "5c11739d194f97131340826cf9ffacc46aa80e5c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a66dcd2b15a03ae54206b1e28c71bfb6b065e07e", "url": "https://github.com/elastic/elasticsearch/commit/a66dcd2b15a03ae54206b1e28c71bfb6b065e07e", "message": "reformulate assertion", "committedDate": "2020-07-22T07:19:39Z", "type": "commit"}]}