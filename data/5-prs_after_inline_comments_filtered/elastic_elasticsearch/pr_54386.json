{"pr_number": 54386, "pr_title": "Fix updating include_in_parent/include_in_root of nested field.", "pr_createdAt": "2020-03-29T15:15:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54386", "timeline": [{"oid": "4847553468baa8820dc7f070fb59501bccbeaf7e", "url": "https://github.com/elastic/elasticsearch/commit/4847553468baa8820dc7f070fb59501bccbeaf7e", "message": "Fix updating include_in_parent/include_in_root of nested field throws no error", "committedDate": "2020-03-29T15:07:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4NDU0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r400384545", "bodyText": "I think it would be clearer to check this directly in the doMerge method, near the place where we ensure that the nested setting doesn't change on line 454. We could even factor out a method like checkNestedParameters(Nested mergeWith) that performs all the relevant checks.\nI'm not sure why we decided to call checkEnabledFieldChange within the loop instead of directly in doMerge as we do for the other parameters. I'll follow up on that separately.", "author": "jtibshirani", "createdAt": "2020-03-30T17:56:07Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ObjectMapper.java", "diffHunk": "@@ -490,6 +490,16 @@ private static void checkEnabledFieldChange(ObjectMapper mergeWith, Mapper merge\n                 final String path = mergeWith.fullPath() + \".\" + mergeWithObjectMapper.simpleName() + \".enabled\";\n                 throw new MapperException(\"Can't update attribute for type [\" + path + \"] in index mapping\");\n             }\n+\n+            if (mergeIntoObjectMapper.nested().isIncludeInParent() != mergeWithObjectMapper.nested().isIncludeInParent()) {", "originalCommit": "4847553468baa8820dc7f070fb59501bccbeaf7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM4OTA0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r400389043", "bodyText": "I think a message like this would be clearer: \"The [include_in_parent] parameter can't be updated for the nested object mapping [user].\"", "author": "jtibshirani", "createdAt": "2020-03-30T18:03:24Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ObjectMapper.java", "diffHunk": "@@ -490,6 +490,16 @@ private static void checkEnabledFieldChange(ObjectMapper mergeWith, Mapper merge\n                 final String path = mergeWith.fullPath() + \".\" + mergeWithObjectMapper.simpleName() + \".enabled\";\n                 throw new MapperException(\"Can't update attribute for type [\" + path + \"] in index mapping\");\n             }\n+\n+            if (mergeIntoObjectMapper.nested().isIncludeInParent() != mergeWithObjectMapper.nested().isIncludeInParent()) {\n+                final String path = mergeWith.fullPath() + \".\" + mergeWithObjectMapper.simpleName() + \".include_in_parent\";\n+                throw new MapperException(\"Can't update attribute for type [\" + path + \"] in index mapping\");", "originalCommit": "4847553468baa8820dc7f070fb59501bccbeaf7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM5Mzc3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r400393775", "bodyText": "It's great that you put together a real unit test. But for consistency with the rest of this class and how we currently test mapping behavior, we should perform these checks using higher-level services like MapperService. You can take a look at testParentObjectMapperAreNested in this class for a simple example. The test case testLimitOfNestedFieldsPerIndex shows how to merge in a new mapping.", "author": "jtibshirani", "createdAt": "2020-03-30T18:10:59Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/NestedObjectMapperTests.java", "diffHunk": "@@ -742,4 +743,36 @@ public void testReorderParent() throws IOException {\n         assertThat(doc.docs().get(1).get(\"nested1.field2\"), equalTo(\"4\"));\n         assertThat(doc.docs().get(2).get(\"field\"), equalTo(\"value\"));\n     }\n+\n+    public void testMergeNestedMappings() {", "originalCommit": "4847553468baa8820dc7f070fb59501bccbeaf7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f995fb7743d997088959648907879ad07e946198", "url": "https://github.com/elastic/elasticsearch/commit/f995fb7743d997088959648907879ad07e946198", "message": "Merge remote-tracking branch 'origin/master' into patch#53792", "committedDate": "2020-04-04T06:33:51Z", "type": "commit"}, {"oid": "8c7f1746f4298831be1edef26dc1cb3501a9e173", "url": "https://github.com/elastic/elasticsearch/commit/8c7f1746f4298831be1edef26dc1cb3501a9e173", "message": "modify the test method", "committedDate": "2020-04-04T09:47:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3Njk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r406376977", "bodyText": "Instead of creating two different indices, then merging the object mappers, I think it would be more realistic to create one index, then call MapperService.merge with a mapping update. You can look at testLimitOfNestedFieldsPerIndex in this class for an example of how to perform the merge.", "author": "jtibshirani", "createdAt": "2020-04-09T17:54:47Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/NestedObjectMapperTests.java", "diffHunk": "@@ -742,4 +742,40 @@ public void testReorderParent() throws IOException {\n         assertThat(doc.docs().get(1).get(\"nested1.field2\"), equalTo(\"4\"));\n         assertThat(doc.docs().get(2).get(\"field\"), equalTo(\"value\"));\n     }\n+\n+    public void testMergeNestedMappings() throws  IOException {\n+        MapperService mapperService = createIndex(\"index1\", Settings.EMPTY, jsonBuilder().startObject()", "originalCommit": "8c7f1746f4298831be1edef26dc1cb3501a9e173", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "77bdee97891ed232e54d32d1305f160e4b440e92", "url": "https://github.com/elastic/elasticsearch/commit/77bdee97891ed232e54d32d1305f160e4b440e92", "message": "Merge remote-tracking branch 'origin/master' into patch#53792", "committedDate": "2020-04-10T09:40:10Z", "type": "commit"}, {"oid": "009da6a702329d28e1721e0a53542e519c962167", "url": "https://github.com/elastic/elasticsearch/commit/009da6a702329d28e1721e0a53542e519c962167", "message": "Modify test code for the change", "committedDate": "2020-04-10T13:14:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyODU5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r406828597", "bodyText": "Let's try to simplify the definition of mapping1 and mapping2:\n\nWe can remove the 'supplier' function, and just define a String mapping directly.\nThere's no need to catch and rewrap the IOException, since this method includes throws IOException in its signature.\n\nI see that you took inspiration from testLimitOfNestedFieldsPerIndex -- apologies that the method wasn't the best example.", "author": "jtibshirani", "createdAt": "2020-04-10T16:14:05Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/NestedObjectMapperTests.java", "diffHunk": "@@ -742,4 +742,43 @@ public void testReorderParent() throws IOException {\n         assertThat(doc.docs().get(1).get(\"nested1.field2\"), equalTo(\"4\"));\n         assertThat(doc.docs().get(2).get(\"field\"), equalTo(\"value\"));\n     }\n+\n+    public void testMergeNestedMappings() throws IOException {\n+        MapperService mapperService = createIndex(\"index1\", Settings.EMPTY, jsonBuilder().startObject()\n+            .startObject(\"properties\")\n+                .startObject(\"nested1\")\n+                    .field(\"type\", \"nested\")\n+                .endObject()\n+            .endObject().endObject()).mapperService();\n+\n+        Function<String, String> mapping1 = type -> {", "originalCommit": "009da6a702329d28e1721e0a53542e519c962167", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MTIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54386#discussion_r409461209", "bodyText": "OK, I will change that.", "author": "gaobinlong", "createdAt": "2020-04-16T10:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgyODU5Nw=="}], "type": "inlineReview"}, {"oid": "addca5de628cebbfb583f0414f64bddce3262ee3", "url": "https://github.com/elastic/elasticsearch/commit/addca5de628cebbfb583f0414f64bddce3262ee3", "message": "Modify the test code", "committedDate": "2020-04-16T12:14:57Z", "type": "commit"}, {"oid": "4a8ac95ec2da1f6045716c93a1c691e4ffe30cfc", "url": "https://github.com/elastic/elasticsearch/commit/4a8ac95ec2da1f6045716c93a1c691e4ffe30cfc", "message": "Merge remote-tracking branch 'origin/master' into patch#53792", "committedDate": "2020-04-16T14:02:53Z", "type": "commit"}]}