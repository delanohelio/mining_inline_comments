{"pr_number": 54926, "pr_title": "Deprecate serializing PipelineAggregators", "pr_createdAt": "2020-04-07T21:34:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54926", "timeline": [{"oid": "01d0d449a463850b8f43b61dfda813e04bfad53b", "url": "https://github.com/elastic/elasticsearch/commit/01d0d449a463850b8f43b61dfda813e04bfad53b", "message": "Deprecate serializing PipelineAggregators\n\n`PipelineAggregator`s are only sent across the wire for backwards\ncompatibility with 7.7.0. `PipelineAggregator` needs to continue to\nimplement `NamedWriteable` for backwards compatibility but pipeline\naggregations created after 7.7.0 need not implement any of the methods\nin that interface because we'll never attempt to call them. So this\ncreates implementations in `PipelineAggregator` (the base class) that\njust throw exceptions.", "committedDate": "2020-04-07T21:28:22Z", "type": "commit"}, {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7", "url": "https://github.com/elastic/elasticsearch/commit/761ba29cba4a7878af05375cc250a85f23fd89f7", "message": "Merge branch 'master' into pipeline_drop_dep", "committedDate": "2020-04-08T13:01:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NTUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r405665503", "bodyText": "Hmm, I think these exception messages are a bit confusing.  If I understand correctly, this path theoretically should never happen because e.g. InternalAggregations won't serialize pipelines in 7.8+, so read/write on the aggregator 7.8+ should never be invoked.\nI think we should probably change the message to \"Cannot (de)serialize pipeline aggregator from stream because pipelines are not serialized after 7.8\" or something to that effect.  That way if a user does see this, it won't confuse them; the current message may make them think the aggregation itself is no longer supported (due to the node being 7.8+ to reach that statement, but the message saying \"before 7.8\").\nI think we need to throw a 5xx error too, because if we get here we are firmly in the server-side going pear shaped and not the fault of a client/user.  Perhaps IllegalStateException?", "author": "polyfractal", "createdAt": "2020-04-08T16:45:14Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalArgumentException(\"[\" + getClass() + \"] is not supported on versions before 7.8.0\");", "originalCommit": "761ba29cba4a7878af05375cc250a85f23fd89f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4Mjg3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r405682874", "bodyText": "Makes sense to me!", "author": "nik9000", "createdAt": "2020-04-08T17:12:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NTUwMw=="}], "type": "inlineReview"}, {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d", "url": "https://github.com/elastic/elasticsearch/commit/bbbc216507c26406c2a8a3475754b1a89b870d7d", "message": "Update exception", "committedDate": "2020-04-09T14:09:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjUwNA==", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r406242504", "bodyText": "Typo: \"because it 7.8.0\" :)", "author": "polyfractal", "createdAt": "2020-04-09T14:24:26Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalStateException(\"Cannot deserialize pipeline [\" + getClass() + \"] because it 7.8.0\");", "originalCommit": "bbbc216507c26406c2a8a3475754b1a89b870d7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NDUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r406254500", "bodyText": "\u2764\ufe0f", "author": "nik9000", "createdAt": "2020-04-09T14:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjUwNA=="}], "type": "inlineReview"}, {"oid": "0966deca17e5124418895754b42a2cb4bbf161b4", "url": "https://github.com/elastic/elasticsearch/commit/0966deca17e5124418895754b42a2cb4bbf161b4", "message": "Merge branch 'master' into pipeline_drop_dep", "committedDate": "2020-04-09T15:16:11Z", "type": "commit"}, {"oid": "509461191c21c1333b2904955f99aca3359fc3ed", "url": "https://github.com/elastic/elasticsearch/commit/509461191c21c1333b2904955f99aca3359fc3ed", "message": "Words are hard", "committedDate": "2020-04-09T15:16:49Z", "type": "commit"}]}