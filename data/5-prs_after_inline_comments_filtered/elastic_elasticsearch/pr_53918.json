{"pr_number": 53918, "pr_title": "[ML] Introduce a \"starting\" datafeed state for lazy jobs", "pr_createdAt": "2020-03-21T14:09:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53918", "timeline": [{"oid": "c386dc2030d5923ee14394840f51951282e3fc5f", "url": "https://github.com/elastic/elasticsearch/commit/c386dc2030d5923ee14394840f51951282e3fc5f", "message": "[ML] Introduce a \"starting\" datafeed state for lazy jobs\n\nIt is possible for ML jobs to open lazily if the \"allow_lazy_open\"\noption in the job config is set to true.  Such jobs wait in the\n\"opening\" state until a node has sufficient capacity to run them.\n\nThis commit fixes the bug that prevented datafeeds for jobs lazily\nwaiting assignment from being started.  The state of such datafeeds\nis \"starting\", and they can be stopped by the stop datafeed API\nwhile in this state with or without force.\n\nRelates #53763", "committedDate": "2020-03-21T14:02:49Z", "type": "commit"}, {"oid": "a08fda32aa7b60d881b46b54ec9fad3a550cd639", "url": "https://github.com/elastic/elasticsearch/commit/a08fda32aa7b60d881b46b54ec9fad3a550cd639", "message": "Lazy open/start needs to return true for UI", "committedDate": "2020-03-21T14:39:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396052452", "bodyText": "Do we want to return \"opened\": true even though the job is not in the opened state yet?", "author": "dimitris-athanasiou", "createdAt": "2020-03-22T04:12:07Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java", "diffHunk": "@@ -554,6 +554,7 @@ public boolean test(PersistentTasksCustomMetaData.PersistentTask<?> persistentTa\n \n                 // This means we are awaiting a new node to be spun up, ok to return back to the user to await node creation\n                 if (assignment != null && assignment.equals(JobNodeSelector.AWAITING_LAZY_ASSIGNMENT)) {\n+                    opened = true;", "originalCommit": "a08fda32aa7b60d881b46b54ec9fad3a550cd639", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA2ODY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396068697", "bodyText": "This is what I changed my mind on - look at the difference between the two commits on this PR to see.\nIf we return \"opened\" : false\" for lazy jobs then the UI as it stands won't start the datafeed - see https://github.com/elastic/kibana/blob/33af1c154beeef8a80bb2f2b3279ab62632ab664/x-pack/plugins/ml/server/models/job_service/datafeeds.ts#L84-L97 and https://github.com/elastic/kibana/blob/33af1c154beeef8a80bb2f2b3279ab62632ab664/x-pack/plugins/ml/server/models/job_service/datafeeds.ts#L57-L59\nYou could say that the UI should be changed to accept \"opened\" : false as an acceptable response to start the datafeed if the job is a lazy job, but that's not great becasue:\n\nCurrently that part of the UI source code does not have access to the job configs\nThere are two ways of specifying laziness (the global lazy nodes setting and the per-job laziness setting), and even if the UI were changed to check the per-job setting it couldn't make a sensible decision on the global lazy nodes setting\n\nSo, the response from the open job endpoint has to be sufficient for the UI to answer the question \"is it appropriate to start the datafeed?\"\nI think there are two options:\n\nLeave the response with a single opened field that basically answers that question and change the docs to say that\nRevert the second commit on this PR and instead add a second field, \"awaiting_lazy_assignment\": true, to all three responses (i.e. open anomaly detection job, start datafeed, start data frame analytics job) and change the UI to || the two booleans for the result of its openJob() function\n\nInterestingly start data frame analytics currently does return true for lazily assigned jobs - see \n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\n    \n    \n         Line 404\n      in\n      d2740c2\n    \n    \n    \n    \n\n        \n          \n           listener.onResponse(new AcknowledgedResponse(true)); \n        \n    \n  \n\n - so there was an inconsistency there before.\nWhich do you prefer?", "author": "droberts195", "createdAt": "2020-03-22T08:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA4NDk1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396084957", "bodyText": "May I suggest a 3rd option?\nWe can stick to interpreting \"opened\" and \"started\" as \"it is now opened|started\".\nThe UI could simply check the status code for 200 to interpret \"the request to open|start was successful\" as it doesn't care about whether it is already \"opened|started\" by the time it receives the response.", "author": "dimitris-athanasiou", "createdAt": "2020-03-22T11:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExMDg5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396110892", "bodyText": "Yes, sure, that is another option.  I think that would be a trivial change in the UI code because already >= 400 status codes go through a different control path so it would basically be removing a single if.\nI noticed that docs currently don't mention the possibility that opened could be false; it's currently documented that opened is always true, like an acknowledged response but with the field name changed.  So doing it this way would mean updating the docs (which is not a problem if we go this way).\nThe final thing to consider is that starting a data frame analytics job does currently return an acknowledged response with a value hardcoded to true.  So if it's important for the response to say whether the job was lazily opened then maybe in a followup PR we should change data frame analytics to return started with a true or false value depending on whether it was lazily assigned for consistency?\nNone of these options are particularly difficult to implement so I will wait until Monday morning once others have had a chance to comment before making any more code changes to avoid unnecessary churn.", "author": "droberts195", "createdAt": "2020-03-22T16:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExMTMwMw==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396111303", "bodyText": "Cool. Note that I don't feel strongly about whether opened is true when the job started lazily. I just wonder if it could be misleading. If we conclude that we're not concerned with this, then the simplest thing is to do what the PR is doing already.", "author": "dimitris-athanasiou", "createdAt": "2020-03-22T16:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMyOTA5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396329092", "bodyText": "Parity with analytics and anomaly is useful, as is treatment for the UI.\nSo opened: true plus a docs change seems acceptable.\nIs there a possibility to add a second response status:opening?\nWe document that opened: true|false means that the instruction to open the job has been accepted (I suspect we would use acknoweldged:true if we were designing today) . And we can use the status to explain if this is happening immediately or slowly. Just a thought.", "author": "sophiec20", "createdAt": "2020-03-23T09:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwNzM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396607373", "bodyText": "I suspect we would use acknoweldged:true if we were designing today\n\nYes, I think the least BWC-breaking way we can move towards that is to always have opened: true and that is what is documented (the documentation currently says the value is always true).\n\nIs there a possibility to add a second response status:opening?\n\nThis is quite similar to the awaiting_lazy_assignment: true of my second option (although in my second option I was proposing to switch back to opened:false as well, which I think we are now agreeing is not the way to go).\nI prefer awaiting_lazy_assignment: true over status:opening because if I was an end user and saw:\n{\n  \"opened\": true,\n  \"status\": \"opening\"\n}\n\nthen I would probably have to read the docs to work out how to interpret that.  Also:\n{\n  \"opened\": true,\n  \"status\": \"opened\"\n}\n\nis what most users would see, and that looks like it contains redundancy.\nWhereas:\n{\n  \"opened\": true,\n  \"awaiting_lazy_assignment\": true\n}\n\nand:\n{\n  \"opened\": true,\n  \"awaiting_lazy_assignment\": false\n}\n\nseem easier to interpret without reading the docs.\nSo unless anyone strongly objects I will eventually implement that.  But I'd rather get this PR merged ASAP since it fixes a nasty bug and then add awaiting_lazy_assignment across both job types and datafeeds in a different PR.  It will touch quite a few files (since it means HLRC and docs changes for 3 endpoints) and will obscure the main fix in this PR.", "author": "droberts195", "createdAt": "2020-03-23T17:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3Nzc2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396677765", "bodyText": "Agreed, let's merge PR to fix the bug.\nAnd let's treat the second field as a separate discussion for a future release.", "author": "sophiec20", "createdAt": "2020-03-23T18:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA1NDM0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r397054349", "bodyText": "I opened #54067 to discuss what to do in 7.8.", "author": "droberts195", "createdAt": "2020-03-24T10:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg=="}], "type": "inlineReview"}, {"oid": "23e48cfa54ffa44cd128237f2c780a3228914f5f", "url": "https://github.com/elastic/elasticsearch/commit/23e48cfa54ffa44cd128237f2c780a3228914f5f", "message": "Adjust test result", "committedDate": "2020-03-23T12:04:21Z", "type": "commit"}, {"oid": "e31bea92ab7cb43cd154fa875b67cd8bf7c62870", "url": "https://github.com/elastic/elasticsearch/commit/e31bea92ab7cb43cd154fa875b67cd8bf7c62870", "message": "Revert test response format change", "committedDate": "2020-03-23T14:08:03Z", "type": "commit"}, {"oid": "85e5fbc8ff30c6f339e216317f46a630c56f8bda", "url": "https://github.com/elastic/elasticsearch/commit/85e5fbc8ff30c6f339e216317f46a630c56f8bda", "message": "opened is now pointless as it's just the inverse of shouldCancel", "committedDate": "2020-03-23T15:39:34Z", "type": "commit"}]}