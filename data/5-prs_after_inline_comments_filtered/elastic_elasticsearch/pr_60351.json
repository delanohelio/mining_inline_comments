{"pr_number": 60351, "pr_title": "Improve error msg for CCS request on node without remote cluster role", "pr_createdAt": "2020-07-29T03:48:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60351", "timeline": [{"oid": "4aebad97ce9607971ebc24d2b6b73df184864747", "url": "https://github.com/elastic/elasticsearch/commit/4aebad97ce9607971ebc24d2b6b73df184864747", "message": "Reroute CCS request to node with remote cluster role", "committedDate": "2020-07-29T03:42:17Z", "type": "commit"}, {"oid": "23ed3b78190fdf0f0f8065c932b7d199a64e7aa9", "url": "https://github.com/elastic/elasticsearch/commit/23ed3b78190fdf0f0f8065c932b7d199a64e7aa9", "message": "revert", "committedDate": "2020-07-29T16:53:10Z", "type": "commit"}, {"oid": "b29e943280e1442b5d6bdde9d7f9db693304b9d0", "url": "https://github.com/elastic/elasticsearch/commit/b29e943280e1442b5d6bdde9d7f9db693304b9d0", "message": "improve error message", "committedDate": "2020-07-29T17:58:09Z", "type": "commit"}, {"oid": "d42358a8451688d3098b16de781947e983bb720d", "url": "https://github.com/elastic/elasticsearch/commit/d42358a8451688d3098b16de781947e983bb720d", "message": "Merge branch 'master' into ccs-role", "committedDate": "2020-07-29T17:59:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60351#discussion_r463458651", "bodyText": "I am not too sure about IllegalStateException here. It's more like a user error as they should rather send the request to another node? Maybe IllegalArgumentException would be more appropriate but I am not 100% happy with it either", "author": "javanna", "createdAt": "2020-07-31T07:50:05Z", "path": "server/src/main/java/org/elasticsearch/transport/RemoteClusterAware.java", "diffHunk": "@@ -73,6 +79,10 @@ protected RemoteClusterAware(Settings settings) {\n         for (String index : requestIndices) {\n             int i = index.indexOf(RemoteClusterService.REMOTE_CLUSTER_INDEX_SEPARATOR);\n             if (i >= 0) {\n+                if (isRemoteClusterClientEnabled == false) {\n+                    assert remoteClusterNames.isEmpty() : remoteClusterNames;\n+                    throw new IllegalStateException(\"node [\" + nodeName + \"] does not have the remote cluster client role enabled\");", "originalCommit": "d42358a8451688d3098b16de781947e983bb720d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMDUxOA==", "url": "https://github.com/elastic/elasticsearch/pull/60351#discussion_r469610518", "bodyText": "Yes, I think we should consider it a bad request. I've adjusted it in 78ba655.", "author": "dnhatn", "createdAt": "2020-08-12T23:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MDAyMA==", "url": "https://github.com/elastic/elasticsearch/pull/60351#discussion_r463460020", "bodyText": "would it be possible to verify what status code would get returned to users at the REST layer?", "author": "javanna", "createdAt": "2020-07-31T07:53:20Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/ccs/CCSRemoteClusterClientRoleIT.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.ccs;\n+\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.index.query.MatchAllQueryBuilder;\n+import org.elasticsearch.test.AbstractMultiClustersTestCase;\n+import org.elasticsearch.test.InternalTestCluster;\n+import org.elasticsearch.test.NodeRoles;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertHitCount;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class CCSRemoteClusterClientRoleIT extends AbstractMultiClustersTestCase {\n+\n+    @Override\n+    protected Collection<String> remoteClusterAlias() {\n+        return List.of(\"cluster_a\");\n+    }\n+\n+    private int indexDocs(Client client, String index) {\n+        assertAcked(client.admin().indices().prepareCreate(index));\n+        int numDocs = between(1, 10);\n+        for (int i = 0; i < numDocs; i++) {\n+            client.prepareIndex(index).setSource(\"f\", \"v\").get();\n+        }\n+        client.admin().indices().prepareRefresh(index).get();\n+        return numDocs;\n+    }\n+\n+    public void testRemoteClusterClientRole() throws Exception {\n+        final int demoDocs = indexDocs(client(LOCAL_CLUSTER), \"demo\");\n+        final int prodDocs = indexDocs(client(\"cluster_a\"), \"prod\");\n+        final InternalTestCluster localCluster = cluster(LOCAL_CLUSTER);\n+        if (randomBoolean()) {\n+            localCluster.startDataOnlyNode();\n+        }\n+        final String nodeWithoutRemoteClusterClientRole = localCluster.startNode(NodeRoles.onlyRole(DiscoveryNodeRole.DATA_ROLE));\n+        final IllegalStateException error = expectThrows(IllegalStateException.class, () ->\n+            localCluster.client(nodeWithoutRemoteClusterClientRole)\n+                .prepareSearch(\"demo\", \"cluster_a:prod\")\n+                .setQuery(new MatchAllQueryBuilder())\n+                .setAllowPartialSearchResults(false)\n+                .setSize(1000)\n+                .get());\n+        assertThat(error.getMessage(),\n+            equalTo(\"node [\" + nodeWithoutRemoteClusterClientRole + \"] does not have the remote cluster client role enabled\"));", "originalCommit": "d42358a8451688d3098b16de781947e983bb720d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMzgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/60351#discussion_r469613816", "bodyText": "I've strengthened the assertion in 78ba655. I don't know how to verify the rest status in this IT test. Any suggestion?", "author": "dnhatn", "createdAt": "2020-08-13T00:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MDAyMA=="}], "type": "inlineReview"}, {"oid": "2c2099bc4a7c1618160f2fb32bf3f44ed635a315", "url": "https://github.com/elastic/elasticsearch/commit/2c2099bc4a7c1618160f2fb32bf3f44ed635a315", "message": "Merge branch 'master' into ccs-role", "committedDate": "2020-08-12T22:23:28Z", "type": "commit"}, {"oid": "78ba655192c7788b0082da15526f0ba0bcc79691", "url": "https://github.com/elastic/elasticsearch/commit/78ba655192c7788b0082da15526f0ba0bcc79691", "message": "throw bad_request instead", "committedDate": "2020-08-12T23:52:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NTgwNA==", "url": "https://github.com/elastic/elasticsearch/pull/60351#discussion_r469965804", "bodyText": "this needs updating?", "author": "javanna", "createdAt": "2020-08-13T13:50:16Z", "path": "server/src/test/java/org/elasticsearch/transport/RemoteClusterServiceTests.java", "diffHunk": "@@ -218,6 +221,18 @@ public void testGroupIndices() throws IOException {\n         }\n     }\n \n+    public void testGroupIndicesWithoutRemoteClusterClientRole() throws Exception {\n+        final Settings settings = onlyRoles(Settings.builder().put(Node.NODE_NAME_SETTING.getKey(), \"node-1\").build(),\n+            Sets.newHashSet(DiscoveryNodeRole.DATA_ROLE));\n+        try (RemoteClusterService service = new RemoteClusterService(settings, null)) {\n+            assertFalse(service.isEnabled());\n+            assertFalse(service.isCrossClusterSearchEnabled());\n+            final IllegalStateException error = expectThrows(IllegalStateException.class,", "originalCommit": "78ba655192c7788b0082da15526f0ba0bcc79691", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8128fb09d62a2de46df3ba760635ab7a11370e9d", "url": "https://github.com/elastic/elasticsearch/commit/8128fb09d62a2de46df3ba760635ab7a11370e9d", "message": "fix test", "committedDate": "2020-08-13T14:02:31Z", "type": "commit"}]}