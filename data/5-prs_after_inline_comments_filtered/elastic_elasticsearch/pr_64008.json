{"pr_number": 64008, "pr_title": "Allow shrink in the hot phase for ILM policies", "pr_createdAt": "2020-10-21T15:44:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64008", "timeline": [{"oid": "7e6e90f2e9ec14d93b573f4874389f9b8606548f", "url": "https://github.com/elastic/elasticsearch/commit/7e6e90f2e9ec14d93b573f4874389f9b8606548f", "message": "getOrDefault with null is just get", "committedDate": "2020-10-21T15:31:00Z", "type": "commit"}, {"oid": "8a8b2d999f7f84a98c3df612c97221af3c47c9de", "url": "https://github.com/elastic/elasticsearch/commit/8a8b2d999f7f84a98c3df612c97221af3c47c9de", "message": "Map.of makes this immutable\n\nand lets us drop the static initializer", "committedDate": "2020-10-21T15:31:00Z", "type": "commit"}, {"oid": "10219f0cd5ab599ee62f2973ff4a714d02ef5ed0", "url": "https://github.com/elastic/elasticsearch/commit/10219f0cd5ab599ee62f2973ff4a714d02ef5ed0", "message": "Refactor a bit\n\nto allow the possibility that there could be more actions in the hot\nphase that require rollover, rather than only just forcemerge.", "committedDate": "2020-10-21T15:31:00Z", "type": "commit"}, {"oid": "bd1bebc79e8d687b48e97294905e944a54420f11", "url": "https://github.com/elastic/elasticsearch/commit/bd1bebc79e8d687b48e97294905e944a54420f11", "message": "Allow shrink in the hot phase\n\nas long as there's an accompanying rollover.", "committedDate": "2020-10-21T15:31:00Z", "type": "commit"}, {"oid": "7066d58b1b77316cb735f29ea0101b52f9691349", "url": "https://github.com/elastic/elasticsearch/commit/7066d58b1b77316cb735f29ea0101b52f9691349", "message": "Tidy up some whitespace", "committedDate": "2020-10-21T15:31:00Z", "type": "commit"}, {"oid": "315f569ac20698d9fdf79056ec9a607b24b786f9", "url": "https://github.com/elastic/elasticsearch/commit/315f569ac20698d9fdf79056ec9a607b24b786f9", "message": "Update the shrink docs to match", "committedDate": "2020-10-21T17:11:39Z", "type": "commit"}, {"oid": "4c40a1ab3abcd34aa41f6c7ce2fb368b8190d86c", "url": "https://github.com/elastic/elasticsearch/commit/4c40a1ab3abcd34aa41f6c7ce2fb368b8190d86c", "message": "Add a yamlRestTest for the changes", "committedDate": "2020-10-21T17:27:48Z", "type": "commit"}, {"oid": "fe5c39094ee298b6fea76a014f8230b7f1364442", "url": "https://github.com/elastic/elasticsearch/commit/fe5c39094ee298b6fea76a014f8230b7f1364442", "message": "Minor refactor\n\nInline forceMergeActionWithCodec in place of its only caller.", "committedDate": "2020-10-28T20:58:15Z", "type": "commit"}, {"oid": "0a537aaf5a4245d4b38f269a99495d87a28f588d", "url": "https://github.com/elastic/elasticsearch/commit/0a537aaf5a4245d4b38f269a99495d87a28f588d", "message": "Add an integration test", "committedDate": "2020-10-29T14:15:52Z", "type": "commit"}, {"oid": "c5e71e6efb62c076091fcf224e544a1d126116b5", "url": "https://github.com/elastic/elasticsearch/commit/c5e71e6efb62c076091fcf224e544a1d126116b5", "message": "More docs changes\n\nMove forcemerge after rollover, since that's when it'll actually\nexecute. Add shrink to the hot phase. Migrate was missing in the warm\nand cold phases, fix that.", "committedDate": "2020-10-29T14:26:48Z", "type": "commit"}, {"oid": "6910ceb29900abe3563ac9195114188b636bf10b", "url": "https://github.com/elastic/elasticsearch/commit/6910ceb29900abe3563ac9195114188b636bf10b", "message": "Merge branch 'master' into add-shrink-to-hot-phase", "committedDate": "2020-10-29T14:35:29Z", "type": "commit"}, {"oid": "2d9c307e63a94c4eaca1a9e8996459e1b591b869", "url": "https://github.com/elastic/elasticsearch/commit/2d9c307e63a94c4eaca1a9e8996459e1b591b869", "message": "Oops, drop an extraneous assertOK", "committedDate": "2020-10-29T16:41:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyMTkzNg==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514421936", "bodyText": "This will not compile on backport (which is fine, just wanted to let you know since you asked about this previously)", "author": "dakrone", "createdAt": "2020-10-29T17:03:22Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/TimeseriesLifecycleType.java", "diffHunk": "@@ -50,14 +50,13 @@\n     static final Set<String> VALID_WARM_ACTIONS = Sets.newHashSet(ORDERED_VALID_WARM_ACTIONS);\n     static final Set<String> VALID_COLD_ACTIONS = Sets.newHashSet(ORDERED_VALID_COLD_ACTIONS);\n     static final Set<String> VALID_DELETE_ACTIONS = Sets.newHashSet(ORDERED_VALID_DELETE_ACTIONS);\n-    private static final Map<String, Set<String>> ALLOWED_ACTIONS = new HashMap<>();\n+    private static final Map<String, Set<String>> ALLOWED_ACTIONS = Map.of(", "originalCommit": "2d9c307e63a94c4eaca1a9e8996459e1b591b869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzNDA3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514434076", "bodyText": "+1, I've pregamed that and I'm ready to do the backport dance.", "author": "joegallo", "createdAt": "2020-10-29T17:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyMTkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MTYyNg==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514481626", "bodyText": "We do have these utility classes in the 7.x branch that provide these functions in a Java8-compatible way so that backports are easier. They're also packaged as a multi-release JAR so that in JVMs that are 9 or later, they use the Java libraries instead, so there's no downside to using them when running with later JVMs.", "author": "danhermann", "createdAt": "2020-10-29T18:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyMTkzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ5MDM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514490373", "bodyText": "@danhermann the utility classes are unfortunately not that helpful, since to use they the Map.of needs to be fully qualified, or java.util.Map<String, Set<String>> has to be specified to fully qualify the jdk classes, which I think is more awkward than just changing on backport.", "author": "dakrone", "createdAt": "2020-10-29T18:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyMTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDM1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514424358", "bodyText": "This change is a little out of the scope of this PR, you did discover that we're missing a method below this one that has\npublic void testForceMergeActionWithCompressionCodec() throws Exception {\n    forceMergeActionWithCodec(\"best_compression\");\n}\nSo I think we should not apply this change in this PR", "author": "dakrone", "createdAt": "2020-10-29T17:07:01Z", "path": "x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/TimeSeriesLifecycleActionsIT.java", "diffHunk": "@@ -467,10 +467,6 @@ public void forceMergeActionWithCodec(String codec) throws Exception {\n         expectThrows(ResponseException.class, () -> indexDocument(client(), index));\n     }\n \n-    public void testForceMergeAction() throws Exception {\n-        forceMergeActionWithCodec(null);\n-    }", "originalCommit": "2d9c307e63a94c4eaca1a9e8996459e1b591b869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMzY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514433689", "bodyText": "+1, I'll back that out on this PR, and then open a new PR that adds the missing test.", "author": "joegallo", "createdAt": "2020-10-29T17:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzNzUxMA==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514437510", "bodyText": "563720a for the revert", "author": "joegallo", "createdAt": "2020-10-29T17:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxODk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514518963", "bodyText": "#64377 for the new test", "author": "joegallo", "createdAt": "2020-10-29T19:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDM1OA=="}], "type": "inlineReview"}, {"oid": "563720a2d0030f9592ef81a369d5effa4592d6b5", "url": "https://github.com/elastic/elasticsearch/commit/563720a2d0030f9592ef81a369d5effa4592d6b5", "message": "Revert \"Minor refactor\"\n\nThis reverts commit fe5c39094ee298b6fea76a014f8230b7f1364442.", "committedDate": "2020-10-29T17:25:13Z", "type": "commit"}]}