{"pr_number": 64524, "pr_title": "Remove ValueFetcher depedendency from MapperService", "pr_createdAt": "2020-11-03T12:24:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64524", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516638289", "bodyText": "Why not using QueryShardContext ? We could also remove the SearchLookup argument.", "author": "jimczi", "createdAt": "2020-11-03T12:43:21Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -105,7 +105,7 @@ public MappedFieldType(String name, boolean isIndexed, boolean isStored,\n      * for metadata fields, field types should not throw {@link UnsupportedOperationException} since this\n      * could cause a search retrieving multiple fields (like \"fields\": [\"*\"]) to fail.\n      */\n-    public abstract ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, @Nullable String format);\n+    public abstract ValueFetcher valueFetcher(ValueFetcher.Context valueFetcherContext, SearchLookup searchLookup, @Nullable String format);", "originalCommit": "362aceb76c8625d3d9d1df01c8a49421196826c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0MTM5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516641392", "bodyText": "Why not using QueryShardContext ? We could also remove the SearchLookup argument.\n\nI'd prefer not to use QueryShardContext everywhere. It really is \"too big\" as it is.\nFor what it is worth, we could totally add SearchLookup to ValueFetcher.Context if we wanted.\nBut I've made three attempts at this change so far and we didn't like them so I'm kind of done having opinions here. Do whatever makes folks happy.", "author": "nik9000", "createdAt": "2020-11-03T12:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0ODQ3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516648477", "bodyText": "QueryShardContext is a huge object that I don't think we want to spread around more than it already is. While we remove the dependency from MapperService, I think that we should try and be careful with encapsulation and who gets access to what. sourcePath is currently not exposed anywhere other than MapperService, and we will have to find a way to expose it so we can progress with removing direct MapperService usages, but we want to be careful with adding new methods to all of the existing contexts, that already have many methods.", "author": "javanna", "createdAt": "2020-11-03T13:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMDU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516810584", "bodyText": "I updated and added QueryShardContext as an argument. I am not sure about SearchLookup because it needs to retrieved specifically through QueryShardContext#newFetchLookup and reused. Looks like we should improve this as its confusing that you can get the lookup also from the context, though it would be the wrong one. I will leave this for another time though.", "author": "javanna", "createdAt": "2020-11-03T16:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyMzEwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516923107", "bodyText": "+1 to solve this as a follow up.", "author": "jimczi", "createdAt": "2020-11-03T20:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0MDE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516640156", "bodyText": "I'm not sure that this is better than my last attempt. I think it's up to @jtibshirani to make the call on this one.", "author": "nik9000", "createdAt": "2020-11-03T12:46:46Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ValueFetcher.java", "diffHunk": "@@ -50,4 +51,8 @@\n      * Update the leaf reader used to fetch values.\n      */\n     default void setNextReader(LeafReaderContext context) {}\n+\n+    interface Context {", "originalCommit": "362aceb76c8625d3d9d1df01c8a49421196826c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0OTY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516649652", "bodyText": "I think that the difference is subtle, but I believe this should address the concerns around tracking usages. At the same time we are introducing a lightweight abstraction that clearly encapsulates what is needed to fetch values, which is much harder to read when functions are carried around. I would love for Julie to have a look and let us know what she thinks though.", "author": "javanna", "createdAt": "2020-11-03T13:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0MDE1Ng=="}], "type": "inlineReview"}, {"oid": "e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "url": "https://github.com/elastic/elasticsearch/commit/e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "message": "Remove ValueFetcher depedendency from MapperService\n\nThe signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\n\nSuch use of MapperService can be replaced with exposing the QueryShardContext which encapsulates the MapperService.", "committedDate": "2020-11-03T16:28:36Z", "type": "commit"}, {"oid": "e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "url": "https://github.com/elastic/elasticsearch/commit/e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "message": "Remove ValueFetcher depedendency from MapperService\n\nThe signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\n\nSuch use of MapperService can be replaced with exposing the QueryShardContext which encapsulates the MapperService.", "committedDate": "2020-11-03T16:28:36Z", "type": "forcePushed"}, {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530", "url": "https://github.com/elastic/elasticsearch/commit/db473a53a3deca5ffd864f3be823a268d1dd7530", "message": "fix test", "committedDate": "2020-11-03T16:42:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzM4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516843389", "bodyText": "If we're passing QueryShardContext I think that means we can avoid passing SearchLookup here?", "author": "romseygeek", "createdAt": "2020-11-03T17:37:51Z", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeatureFieldMapper.java", "diffHunk": "@@ -114,11 +114,11 @@ public Query existsQuery(QueryShardContext context) {\n         }\n \n         @Override\n-        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+        public ValueFetcher valueFetcher(QueryShardContext context, SearchLookup searchLookup, String format) {", "originalCommit": "db473a53a3deca5ffd864f3be823a268d1dd7530", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NjUzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516886533", "bodyText": "see my comment above, I don't think so, because we need to pass through the fetch lookup that is created in FetchContext?", "author": "javanna", "createdAt": "2020-11-03T18:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyOTI2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r517229269", "bodyText": "One nit: maybe this should be sourcePaths, given that it can return more than one?", "author": "romseygeek", "createdAt": "2020-11-04T10:05:29Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -270,6 +270,14 @@ public ObjectMapper getObjectMapper(String name) {\n         return mapperService.getObjectMapper(name);\n     }\n \n+    public boolean isMetadataField(String field) {\n+        return mapperService.isMetadataField(field);\n+    }\n+\n+    public Set<String> sourcePath(String fullName) {", "originalCommit": "db473a53a3deca5ffd864f3be823a268d1dd7530", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTE4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r517239185", "bodyText": "yes, in my iterations I did both, I went for singular for consistency with the name of the method in MapperService. I don't know what is more important between using the same name or using the correct name here. Maybe we should rename both as a followup?", "author": "javanna", "createdAt": "2020-11-04T10:21:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyOTI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1MzAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r517253023", "bodyText": "+1 for a followup", "author": "romseygeek", "createdAt": "2020-11-04T10:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyOTI2OQ=="}], "type": "inlineReview"}]}