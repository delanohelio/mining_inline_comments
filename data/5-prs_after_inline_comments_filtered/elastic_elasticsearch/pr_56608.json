{"pr_number": 56608, "pr_title": "Relax Assertion About SnapshotsService Listeners", "pr_createdAt": "2020-05-12T14:10:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56608", "timeline": [{"oid": "44a82596300ec71ce8e99a8444ca8d5d86646ced", "url": "https://github.com/elastic/elasticsearch/commit/44a82596300ec71ce8e99a8444ca8d5d86646ced", "message": "Relax Assertion About SnapshotsService Listeners\n\nThis assertion is too strict. A snapshot will be removed from the cluster state\non the CS thread before it is removed from the listeners map on the snapshot thread pool.\nThroughout the removal from the cluster state and listener map, the snapshot is tracked\nin `endingSnapshots` though, so we can relax the assertion accordingly and are still able\nto catch leaked listeners.\n\nCloses #56607", "committedDate": "2020-05-12T14:05:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3NDIxNw==", "url": "https://github.com/elastic/elasticsearch/pull/56608#discussion_r423774217", "bodyText": "The synchronization here isn't 100% necessary, could as well just copy the map before checking the listener key-set, but I figured the logic (and worst case assertion message) is a little easier to follow if we prevent concurrently starting another snapshot finalization.", "author": "original-brownbear", "createdAt": "2020-05-12T14:22:05Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -430,11 +431,15 @@ public void applyClusterState(ClusterChangedEvent event) {\n     private boolean assertConsistentWithClusterState(ClusterState state) {\n         final SnapshotsInProgress snapshotsInProgress = state.custom(SnapshotsInProgress.TYPE);\n         if (snapshotsInProgress != null && snapshotsInProgress.entries().isEmpty() == false) {\n-            final Set<Snapshot> runningSnapshots =\n-                snapshotsInProgress.entries().stream().map(SnapshotsInProgress.Entry::snapshot).collect(Collectors.toSet());\n-            final Set<Snapshot> snapshotListenerKeys = snapshotCompletionListeners.keySet();\n-            assert runningSnapshots.containsAll(snapshotListenerKeys) : \"Saw completion listeners for unknown snapshots in \"\n-                + snapshotListenerKeys + \" but running snapshots are \" + runningSnapshots;\n+            synchronized (endingSnapshots) {", "originalCommit": "44a82596300ec71ce8e99a8444ca8d5d86646ced", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}