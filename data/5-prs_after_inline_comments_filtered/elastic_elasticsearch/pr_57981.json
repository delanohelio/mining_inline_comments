{"pr_number": 57981, "pr_title": "Update to lucene snapshot e7c625430ed", "pr_createdAt": "2020-06-11T11:26:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57981", "timeline": [{"oid": "ab6bd1e6cfe8bc799109367d7a45efdce7db8325", "url": "https://github.com/elastic/elasticsearch/commit/ab6bd1e6cfe8bc799109367d7a45efdce7db8325", "message": "Update to lucene snapshot e7c625430ed", "committedDate": "2020-06-11T11:19:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcxNzQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57981#discussion_r438717478", "bodyText": "This test is now failing - @iverase could you take a look?", "author": "romseygeek", "createdAt": "2020-06-11T11:27:27Z", "path": "server/src/test/java/org/elasticsearch/search/query/QueryPhaseTests.java", "diffHunk": "@@ -774,14 +776,16 @@ public void testIndexHasNoDuplicateData() throws IOException {\n                 LongPoint.encodeDimension(value, longBytes, 0);\n                 w.add(longBytes, docId);\n             }\n-            long indexFP;\n-            try (IndexOutput out = dir.createOutput(\"bkd\", IOContext.DEFAULT)) {\n-                indexFP = w.finish(out);\n+            try (IndexOutput metaout = dir.createOutput(\"bkdmeta\", IOContext.DEFAULT);\n+                 IndexOutput indexout = dir.createOutput(\"bkdindex\", IOContext.DEFAULT);\n+                 IndexOutput dataout = dir.createOutput(\"bkddata\", IOContext.DEFAULT)) {\n+                w.finish(metaout, indexout, dataout).run();\n             }\n-            try (IndexInput in = dir.openInput(\"bkd\", IOContext.DEFAULT)) {\n-                in.seek(indexFP);\n-                BKDReader r = new BKDReader(in);\n-                assertFalse(pointsHaveDuplicateData(r, r.getDocCount()/2));\n+            try (IndexInput metain = dir.openInput(\"bkdmeta\", IOContext.DEFAULT);\n+                 IndexInput indexin = dir.openInput(\"bkdindex\", IOContext.DEFAULT);\n+                 IndexInput datain = dir.openInput(\"bkddata\", IOContext.DEFAULT)) {\n+                BKDReader r = new BKDReader(metain, indexin, datain);\n+                assertTrue(pointsHaveDuplicateData(r, r.getDocCount() / 2));", "originalCommit": "ab6bd1e6cfe8bc799109367d7a45efdce7db8325", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMTI2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57981#discussion_r438721262", "bodyText": "You need to change the finish method to something like:\nRunnable finalizer = writer.finish(metaOut, indexOut, dataOut);\n      if (finalizer != null) {\n        metaout.writeInt(fieldInfo.number);\n        finalizer.run();\n      }", "author": "iverase", "createdAt": "2020-06-11T11:36:37Z", "path": "server/src/test/java/org/elasticsearch/search/query/QueryPhaseTests.java", "diffHunk": "@@ -748,14 +748,16 @@ public void testIndexHasDuplicateData() throws IOException {\n                 LongPoint.encodeDimension(value, longBytes, 0);\n                 w.add(longBytes, docId);\n             }\n-            long indexFP;\n-            try (IndexOutput out = dir.createOutput(\"bkd\", IOContext.DEFAULT)) {\n-                indexFP = w.finish(out);\n+            try (IndexOutput metaout = dir.createOutput(\"bkdmeta\", IOContext.DEFAULT);\n+                 IndexOutput indexout = dir.createOutput(\"bkdindex\", IOContext.DEFAULT);\n+                 IndexOutput dataout = dir.createOutput(\"bkddata\", IOContext.DEFAULT)) {\n+                w.finish(metaout, indexout, dataout).run();", "originalCommit": "ab6bd1e6cfe8bc799109367d7a45efdce7db8325", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyNTE2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57981#discussion_r438725167", "bodyText": "Or even better like this:\n        Runnable finalizer = w.finish(metaout, indexout, dataout);\n        long indexFP = metaout.getFilePointer();\n        finalizer.run();\n\nThen when you call the reader you need to make sure retain is in the right position:\nmetain.seek(indexFP);", "author": "iverase", "createdAt": "2020-06-11T11:45:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyMTI2Mg=="}], "type": "inlineReview"}, {"oid": "decfe6a4e0aa4104bd58752612277fc63b03358b", "url": "https://github.com/elastic/elasticsearch/commit/decfe6a4e0aa4104bd58752612277fc63b03358b", "message": "doh", "committedDate": "2020-06-11T12:18:36Z", "type": "commit"}, {"oid": "bcafaae5a8266ec14148fa57d508536421087af7", "url": "https://github.com/elastic/elasticsearch/commit/bcafaae5a8266ec14148fa57d508536421087af7", "message": "Codec changes", "committedDate": "2020-06-11T12:33:28Z", "type": "commit"}]}