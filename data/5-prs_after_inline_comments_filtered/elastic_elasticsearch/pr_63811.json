{"pr_number": 63811, "pr_title": "Fix broken parent and child aggregator", "pr_createdAt": "2020-10-16T14:34:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63811", "timeline": [{"oid": "609ecb628372bd955817fbaab85693131cba29c9", "url": "https://github.com/elastic/elasticsearch/commit/609ecb628372bd955817fbaab85693131cba29c9", "message": "Fix broken parent and child aggregator\n\nIn #57892 I broke *some* sub-aggregations inside of the `parent` and\n`child` aggregator, specifically any sub-aggregations that do work in\nthe `postCollect` phase. This fixes it by delaying the post collect\nphase of aggs under `parent` and `child` until `beforeBuildingBuckets`\nbecause, well, we haven't done *any* collection until after that phase.", "committedDate": "2020-10-16T14:31:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MzU3NA==", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506493574", "bodyText": "I think we'd be better off removing postCollection entirely and replacing it with beforeBuildingBuckets because it is very similar but it has access to the buckets we actually want.", "author": "nik9000", "createdAt": "2020-10-16T14:37:01Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java", "diffHunk": "@@ -250,9 +250,12 @@ public SearchContext context() {\n \n     /**\n      * Called after collection of all document is done.\n+     * <p>\n+     * Warning: this is not final only to allow the parent join aggregator\n+     * to delay this until building buckets.\n      */\n     @Override\n-    public final void postCollection() throws IOException {\n+    public void postCollection() throws IOException {", "originalCommit": "609ecb628372bd955817fbaab85693131cba29c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}