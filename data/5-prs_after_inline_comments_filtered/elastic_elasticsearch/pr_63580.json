{"pr_number": 63580, "pr_title": "Fix testMasterFailoverDuringCloneStep1", "pr_createdAt": "2020-10-12T22:41:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63580", "timeline": [{"oid": "02fdce6a3eee485f838d8ed451de7da7c9434cd5", "url": "https://github.com/elastic/elasticsearch/commit/02fdce6a3eee485f838d8ed451de7da7c9434cd5", "message": "Fix testMasterFailoverDuringCloneStep1\n\nAssuming the clone failed when the request failed is not sufficient.\nThere are failure modes where the request fails but the clone still works out\nbecause the data node resent the requeest after the first clone had already been\nfailed and removed from the cluster state when master was restarted.\n\nCloses #63473", "committedDate": "2020-10-12T22:28:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63580#discussion_r503570106", "bodyText": "It's mildly annoying that we have to do this kind of thing again (we had this issue in tests with the snapshot INIT step as well). There is a reasonable fix here I think (I'll try it when I can find some time but probably not too soon) but for now I opted to just fix the test.", "author": "original-brownbear", "createdAt": "2020-10-12T22:44:00Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/CloneSnapshotIT.java", "diffHunk": "@@ -377,6 +378,9 @@ public void testMasterFailoverDuringCloneStep1() throws Exception {\n \n         awaitNoMoreRunningOperations(internalCluster().getMasterName());\n \n+        // Check if the clone operation worked out by chance as a result of the clone request being retried because of the master failover\n+        cloneSucceeded = cloneSucceeded ||", "originalCommit": "02fdce6a3eee485f838d8ed451de7da7c9434cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczNDgzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63580#discussion_r503734839", "bodyText": "Maybe add a //TODO or a descriptive comment somewhere in the code?", "author": "tlrx", "createdAt": "2020-10-13T07:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1Njc5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63580#discussion_r503856791", "bodyText": "Added :) in the relevant spots in 060020a", "author": "original-brownbear", "createdAt": "2020-10-13T10:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDEwNg=="}], "type": "inlineReview"}, {"oid": "e9780218f136092c1b9d1f47b9d9cdf91419e23b", "url": "https://github.com/elastic/elasticsearch/commit/e9780218f136092c1b9d1f47b9d9cdf91419e23b", "message": "Merge remote-tracking branch 'elastic/master' into 63473", "committedDate": "2020-10-13T10:45:20Z", "type": "commit"}, {"oid": "060020a04246dbe318b8ae5e358d51d7f97fa497", "url": "https://github.com/elastic/elasticsearch/commit/060020a04246dbe318b8ae5e358d51d7f97fa497", "message": "CR: add TODOs", "committedDate": "2020-10-13T10:55:31Z", "type": "commit"}]}