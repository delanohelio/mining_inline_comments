{"pr_number": 62979, "pr_title": "Avoid Redundantly Loading Monitoring Templates on CS Applier Thread (#62913)", "pr_createdAt": "2020-09-28T19:14:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62979", "timeline": [{"oid": "547199357b5aa746d921cae207b4f0aa7a8faab3", "url": "https://github.com/elastic/elasticsearch/commit/547199357b5aa746d921cae207b4f0aa7a8faab3", "message": "Avoid Redundantly Loading Monitoring Templates on CS Applier Thread (#62913)\n\nThis refactors the loading of monitoring templates slightly so that they aren't loaded over and\r\nover again (from disk) on CS updates. This isn't an important optimization in production for obvious\r\nreasons since it only affects the install stage, but this turned out to cause some slow CS applies\r\nin tests.\r\n\r\nRelates #62853", "committedDate": "2020-09-28T19:09:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIxMTg4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62979#discussion_r496211889", "bodyText": "Should you use the static templateName import here and throughout? It looks like you might be mix 'n matching.", "author": "joegallo", "createdAt": "2020-09-28T20:26:29Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/local/LocalExporter.java", "diffHunk": "@@ -237,13 +232,12 @@ LocalBulk resolveBulk(ClusterState clusterState, boolean clusterStateChange) {\n      * monitoring cluster (this one, as the local exporter) is not setup yet.\n      *\n      * @param clusterState The current cluster state.\n-     * @param templates All template names that should exist.\n      * @return {@code true} indicates that all resources are available and the exporter can be used. {@code false} to stop and wait.\n      */\n-    private boolean setupIfNotElectedMaster(final ClusterState clusterState, final Set<String> templates) {\n+    private boolean setupIfNotElectedMaster(final ClusterState clusterState) {\n         // any required template is not yet installed in the given cluster state, we'll wait.\n-        for (final String template : templates) {\n-            if (hasTemplate(clusterState, template) == false) {\n+        for (final String template : MonitoringTemplateUtils.TEMPLATE_IDS) {\n+            if (hasTemplate(clusterState, MonitoringTemplateUtils.templateName(template)) == false) {", "originalCommit": "547199357b5aa746d921cae207b4f0aa7a8faab3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIxMjE0NA==", "url": "https://github.com/elastic/elasticsearch/pull/62979#discussion_r496212144", "bodyText": "Ah, this is a backport PR -- nevermind me!", "author": "joegallo", "createdAt": "2020-09-28T20:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIxMTg4OQ=="}], "type": "inlineReview"}]}