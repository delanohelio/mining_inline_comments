{"pr_number": 65599, "pr_title": "Use scriptless fields in CoreTestTranslator", "pr_createdAt": "2020-11-30T13:02:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65599", "timeline": [{"oid": "4a6e3417b9ce4980f7f28e6abec47079d0fa2b86", "url": "https://github.com/elastic/elasticsearch/commit/4a6e3417b9ce4980f7f28e6abec47079d0fa2b86", "message": "Use scriptless fields rather than ad-hoc painless load-from-source scripts", "committedDate": "2020-11-30T12:59:50Z", "type": "commit"}, {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "url": "https://github.com/elastic/elasticsearch/commit/ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "message": "spotless", "committedDate": "2020-11-30T13:10:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU4ODAwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532588005", "bodyText": "this seems wrong but it's irrelevant because the tests that use it are disabled. I plan on replacing the dynamic template with dynamic:runtime", "author": "javanna", "createdAt": "2020-11-30T13:15:46Z", "path": "x-pack/plugin/runtime-fields/qa/src/main/java/org/elasticsearch/xpack/runtimefields/test/CoreTestTranslater.java", "diffHunk": "@@ -118,15 +90,11 @@ private static String painlessToLoadFromSource(String name, String type) {\n \n     // TODO there isn't yet a way to create fields in the runtime section from a dynamic template\n     protected static Map<String, Object> dynamicTemplateToAddRuntimeFields(String type) {\n-        return Map.ofEntries(\n-            Map.entry(\"type\", \"runtime\"),\n-            Map.entry(\"runtime_type\", type),\n-            Map.entry(\"script\", painlessToLoadFromSource(\"{name}\", type))\n-        );\n+        return Map.ofEntries(Map.entry(\"type\", \"runtime\"), Map.entry(\"runtime_type\", type));", "originalCommit": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzE4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532603183", "bodyText": "This is a tricksy bit - it's breaking one test, search/30_limits/Regexp length limit, I think because it's looking for the source value of name.keyword which of course doesn't exist.", "author": "romseygeek", "createdAt": "2020-11-30T13:40:05Z", "path": "x-pack/plugin/runtime-fields/qa/core-with-search/src/yamlRestTest/java/org/elasticsearch/xpack/runtimefields/test/search/CoreTestsWithSearchRuntimeFieldsIT.java", "diffHunk": "@@ -173,43 +173,43 @@ protected boolean handleIndex(IndexRequest index) {\n                             continue;\n                         }\n                         if (value instanceof Boolean) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"boolean\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"boolean\"));\n                             continue;\n                         }\n                         if (value instanceof Long || value instanceof Integer) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"long\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"long\"));\n                             continue;\n                         }\n                         if (value instanceof Double) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"double\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"double\"));\n                             continue;\n                         }\n                         if (false == value instanceof String) {\n                             continue;\n                         }\n                         try {\n                             Long.parseLong(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"long\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"long\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         try {\n                             Double.parseDouble(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"double\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"double\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         try {\n                             DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.parse(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"date\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"date\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         // Strings are funny, the regular dynamic mapping puts them in \"name.keyword\" so we follow along.\n-                        indexRuntimeMappings.put(name + \".keyword\", runtimeFieldLoadingFromSource(name, \"keyword\"));\n+                        indexRuntimeMappings.put(name + \".keyword\", runtimeFieldLoadingFromSource(\"keyword\"));", "originalCommit": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzODIyOA==", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532638228", "bodyText": "Field names doesn't seem to be the problem.\nwas \"{root_cause=[{type=too_long_frame_exception, reason=An HTTP line is larger than 4096 bytes.}], type=too_long_frame_exception, reason=An HTTP line is larger than 4096 bytes.}\"", "author": "romseygeek", "createdAt": "2020-11-30T14:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc1MzQzNA==", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532753434", "bodyText": "you can get that exception if you make a stack overflow.", "author": "nik9000", "createdAt": "2020-11-30T17:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc1Mzk2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532753961", "bodyText": "Generating the error for the stack overflow blows out something else.", "author": "nik9000", "createdAt": "2020-11-30T17:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzE4Mw=="}], "type": "inlineReview"}, {"oid": "c1b5b73b9224beb5567829f9b15fe2c81cf59717", "url": "https://github.com/elastic/elasticsearch/commit/c1b5b73b9224beb5567829f9b15fe2c81cf59717", "message": "Merge remote-tracking branch 'origin/master' into runtime/core-test-translator", "committedDate": "2020-12-01T10:29:31Z", "type": "commit"}, {"oid": "92f7675dec158bbd7684ae1a1852b50b59fa0e3b", "url": "https://github.com/elastic/elasticsearch/commit/92f7675dec158bbd7684ae1a1852b50b59fa0e3b", "message": "Divide up test", "committedDate": "2020-12-01T12:43:08Z", "type": "commit"}, {"oid": "f61a939d8cb11d161caaf9723e86b4f597f2c289", "url": "https://github.com/elastic/elasticsearch/commit/f61a939d8cb11d161caaf9723e86b4f597f2c289", "message": "Revert \"Divide up test\"\n\nThis reverts commit 92f7675dec158bbd7684ae1a1852b50b59fa0e3b.", "committedDate": "2020-12-02T09:14:50Z", "type": "commit"}, {"oid": "3c97d2633f1a155dca4f396d3f2c4dfaecc06061", "url": "https://github.com/elastic/elasticsearch/commit/3c97d2633f1a155dca4f396d3f2c4dfaecc06061", "message": "Mute 30_limits test", "committedDate": "2020-12-02T09:18:36Z", "type": "commit"}]}