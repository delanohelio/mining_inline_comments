{"pr_number": 66204, "pr_title": "limit the depth of nested bool queries", "pr_createdAt": "2020-12-11T14:41:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66204", "timeline": [{"oid": "bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "url": "https://github.com/elastic/elasticsearch/commit/bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "message": "limit the depth of nested bool queries", "committedDate": "2020-12-12T02:51:56Z", "type": "commit"}, {"oid": "bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "url": "https://github.com/elastic/elasticsearch/commit/bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "message": "limit the depth of nested bool queries", "committedDate": "2020-12-12T02:51:56Z", "type": "forcePushed"}, {"oid": "6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "url": "https://github.com/elastic/elasticsearch/commit/6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "message": "limit the depth of nested bool queries", "committedDate": "2020-12-14T04:39:33Z", "type": "commit"}, {"oid": "6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "url": "https://github.com/elastic/elasticsearch/commit/6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "message": "limit the depth of nested bool queries", "committedDate": "2020-12-14T04:39:33Z", "type": "forcePushed"}, {"oid": "261b06d8eb298d4208240b6d7b51c36503b249cd", "url": "https://github.com/elastic/elasticsearch/commit/261b06d8eb298d4208240b6d7b51c36503b249cd", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth", "committedDate": "2020-12-26T12:31:33Z", "type": "commit"}, {"oid": "34e739d250a2313d24a78ffff418f8fc99a2dbd6", "url": "https://github.com/elastic/elasticsearch/commit/34e739d250a2313d24a78ffff418f8fc99a2dbd6", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-26T15:15:36Z", "type": "forcePushed"}, {"oid": "5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "url": "https://github.com/elastic/elasticsearch/commit/5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-26T15:18:03Z", "type": "forcePushed"}, {"oid": "e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "url": "https://github.com/elastic/elasticsearch/commit/e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-26T15:19:29Z", "type": "forcePushed"}, {"oid": "50e4606fab3f1c0b611932af8314c9d00ee214a7", "url": "https://github.com/elastic/elasticsearch/commit/50e4606fab3f1c0b611932af8314c9d00ee214a7", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-26T15:21:22Z", "type": "forcePushed"}, {"oid": "a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "url": "https://github.com/elastic/elasticsearch/commit/a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-27T02:38:35Z", "type": "forcePushed"}, {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e", "url": "https://github.com/elastic/elasticsearch/commit/335bc1a1012af1a3c4d621584de65613863dc18e", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-27T02:40:17Z", "type": "commit"}, {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e", "url": "https://github.com/elastic/elasticsearch/commit/335bc1a1012af1a3c4d621584de65613863dc18e", "message": " put bool depth check in the parsing stage", "committedDate": "2020-12-27T02:40:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk2Nzg0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r551967845", "bodyText": "should we call this setting max_nested_depth?", "author": "mayya-sharipova", "createdAt": "2021-01-05T14:32:26Z", "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -269,6 +270,9 @@\n     public static final Setting<Integer> INDICES_MAX_CLAUSE_COUNT_SETTING = Setting.intSetting(\"indices.query.bool.max_clause_count\",\n             1024, 1, Integer.MAX_VALUE, Setting.Property.NodeScope);\n \n+    public static final Setting<Integer> INDICES_MAX_CLAUSE_NESTED_SETTING = Setting.intSetting(\"indices.query.bool.max_nested_count\",", "originalCommit": "335bc1a1012af1a3c4d621584de65613863dc18e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk2ODE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r551968148", "bodyText": "should we can this function setMaxNestedDepth and also for corresponding error message?", "author": "mayya-sharipova", "createdAt": "2021-01-05T14:32:53Z", "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -91,6 +92,17 @@ public BoolQueryBuilder(StreamInput in) throws IOException {\n         minimumShouldMatch = in.readOptionalString();\n     }\n \n+    /**\n+     * Set the maximum number of nested permitted per BooleanQuery.\n+     * Default value is 20.\n+     */\n+    public static void setMaxClauseCount(int maxNestedCount) {", "originalCommit": "335bc1a1012af1a3c4d621584de65613863dc18e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAyMDI5OA==", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r552020298", "bodyText": "may be an error message should be more detailed including what setting should be modified:\n\"the nested depth of the query exceeds the maximum nested depth for bool queries set in [\" + the name of the setting", "author": "mayya-sharipova", "createdAt": "2021-01-05T15:53:17Z", "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -288,8 +300,12 @@ private static void doXArrayContent(ParseField field, List<QueryBuilder> clauses\n         PARSER.declareFloat(BoolQueryBuilder::boost, BOOST_FIELD);\n     }\n \n-    public static BoolQueryBuilder fromXContent(XContentParser parser) throws IOException, ParsingException {\n-        return PARSER.parse(parser, null);\n+    public static BoolQueryBuilder fromXContent(XContentParser parser, Integer nestedDepth) throws IOException, ParsingException {\n+        nestedDepth++;\n+        if (nestedDepth > maxNestedCount) {\n+            throw new IllegalArgumentException(\"maxNestedDepth is set to \" + maxNestedCount + \", but current depth is \" + nestedDepth);\n+        }", "originalCommit": "335bc1a1012af1a3c4d621584de65613863dc18e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAyMDY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r552020668", "bodyText": "should it be maxNestedDepth?", "author": "mayya-sharipova", "createdAt": "2021-01-05T15:53:48Z", "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -59,6 +59,7 @@\n     private static final ParseField MUST = new ParseField(\"must\");\n     private static final ParseField MINIMUM_SHOULD_MATCH = new ParseField(\"minimum_should_match\");\n     private static final ParseField ADJUST_PURE_NEGATIVE = new ParseField(\"adjust_pure_negative\");\n+    private static int maxNestedCount = 20;", "originalCommit": "335bc1a1012af1a3c4d621584de65613863dc18e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5b583341479fdc14dde29083e391ab47ae4a962", "url": "https://github.com/elastic/elasticsearch/commit/d5b583341479fdc14dde29083e391ab47ae4a962", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth", "committedDate": "2021-01-06T14:01:34Z", "type": "commit"}, {"oid": "fdc5faffdbb54c575ccd356f805b394c9e27d435", "url": "https://github.com/elastic/elasticsearch/commit/fdc5faffdbb54c575ccd356f805b394c9e27d435", "message": "add test and doc", "committedDate": "2021-01-07T14:17:05Z", "type": "commit"}, {"oid": "fdc5faffdbb54c575ccd356f805b394c9e27d435", "url": "https://github.com/elastic/elasticsearch/commit/fdc5faffdbb54c575ccd356f805b394c9e27d435", "message": "add test and doc", "committedDate": "2021-01-07T14:17:05Z", "type": "forcePushed"}, {"oid": "042041e6bdba02dcf1f81974ed700d8ca92f6028", "url": "https://github.com/elastic/elasticsearch/commit/042041e6bdba02dcf1f81974ed700d8ca92f6028", "message": "add test and doc", "committedDate": "2021-01-07T14:24:59Z", "type": "commit"}, {"oid": "042041e6bdba02dcf1f81974ed700d8ca92f6028", "url": "https://github.com/elastic/elasticsearch/commit/042041e6bdba02dcf1f81974ed700d8ca92f6028", "message": "add test and doc", "committedDate": "2021-01-07T14:24:59Z", "type": "forcePushed"}, {"oid": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc", "url": "https://github.com/elastic/elasticsearch/commit/62785d4ecb28c91e3b132ffad4e0bab32594ccfc", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth", "committedDate": "2021-01-10T01:49:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA3ODQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r555078420", "bodyText": "The format of assertEquals is assertEquals(expected, actual), so we should write:\nassertEquals(\"The nested...\", e.getCause().getCause().getMessage());", "author": "mayya-sharipova", "createdAt": "2021-01-11T14:20:26Z", "path": "server/src/test/java/org/elasticsearch/index/query/BoolQueryBuilderTests.java", "diffHunk": "@@ -447,4 +450,17 @@ public void testMustRewrite() throws IOException {\n                 () -> boolQuery.toQuery(context));\n         assertEquals(\"Rewrite first\", e.getMessage());\n     }\n+\n+    public void testExceedMaxNestedDepth() throws IOException {\n+        BoolQueryBuilder query = new BoolQueryBuilder();\n+        query.should(new BoolQueryBuilder().should(new BoolQueryBuilder().should(RandomQueryBuilder.createQuery(random()))));\n+        BoolQueryBuilder.setMaxNestedDepth(2);\n+        try (XContentParser parser = createParser(JsonXContent.jsonXContent, query.toString())) {\n+            XContentParseException e = expectThrows(XContentParseException.class,\n+                () -> parseInnerQueryBuilder(parser));\n+            assertThat(e.getCause().getCause(), Matchers.instanceOf(IllegalArgumentException.class));\n+            assertEquals(e.getCause().getCause().getMessage(), \"The nested depth of the query exceeds the maximum nested depth for bool queries set in [\" +\n+                INDICES_MAX_NESTED_DEPTH_SETTING.getKey() + \"]\");", "originalCommit": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "edb278b64ffb7129400da170fd5b60c790df48e9", "url": "https://github.com/elastic/elasticsearch/commit/edb278b64ffb7129400da170fd5b60c790df48e9", "message": "address comments", "committedDate": "2021-01-11T15:21:18Z", "type": "commit"}, {"oid": "68ba7961db7a1fe795ee423d0d09d54d22402d10", "url": "https://github.com/elastic/elasticsearch/commit/68ba7961db7a1fe795ee423d0d09d54d22402d10", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth", "committedDate": "2021-01-11T15:24:38Z", "type": "commit"}]}