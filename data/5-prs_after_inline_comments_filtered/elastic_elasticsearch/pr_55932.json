{"pr_number": 55932, "pr_title": "Consolidate DelayableWriteable", "pr_createdAt": "2020-04-29T13:05:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55932", "timeline": [{"oid": "8dc10cd83365642bd9aaa12daebd66042aca388a", "url": "https://github.com/elastic/elasticsearch/commit/8dc10cd83365642bd9aaa12daebd66042aca388a", "message": "adapt constructors visibility", "committedDate": "2020-04-29T08:24:54Z", "type": "commit"}, {"oid": "0bb27c0dc341fc58e0882063dd60e2238d6d6313", "url": "https://github.com/elastic/elasticsearch/commit/0bb27c0dc341fc58e0882063dd60e2238d6d6313", "message": "fix javadocs", "committedDate": "2020-04-29T08:25:13Z", "type": "commit"}, {"oid": "9e72338551e31598dce2a113f8d2f662edf84161", "url": "https://github.com/elastic/elasticsearch/commit/9e72338551e31598dce2a113f8d2f662edf84161", "message": "address generics warning", "committedDate": "2020-04-29T08:25:34Z", "type": "commit"}, {"oid": "0c0924af494f6187bc2529506a364fdeb6dc230c", "url": "https://github.com/elastic/elasticsearch/commit/0c0924af494f6187bc2529506a364fdeb6dc230c", "message": "make reference final", "committedDate": "2020-04-29T08:25:48Z", "type": "commit"}, {"oid": "80f97aafe5bf0496fcef101740f7dd16d62fdd52", "url": "https://github.com/elastic/elasticsearch/commit/80f97aafe5bf0496fcef101740f7dd16d62fdd52", "message": "reword exception error to make it more generic", "committedDate": "2020-04-29T08:27:04Z", "type": "commit"}, {"oid": "cc9f81e8e70e91b9f4e11e617d5eb752fd94c775", "url": "https://github.com/elastic/elasticsearch/commit/cc9f81e8e70e91b9f4e11e617d5eb752fd94c775", "message": "Remove the need for implementing Supplier and rename get to expand", "committedDate": "2020-04-29T08:38:37Z", "type": "commit"}, {"oid": "7a3fa7ad35d9c18f7e1d5fdacd88197df2795647", "url": "https://github.com/elastic/elasticsearch/commit/7a3fa7ad35d9c18f7e1d5fdacd88197df2795647", "message": "fix comment", "committedDate": "2020-04-29T10:09:29Z", "type": "commit"}, {"oid": "0bf6aa81fbd8a551fcd65d09f50417dd18cbdbfe", "url": "https://github.com/elastic/elasticsearch/commit/0bf6aa81fbd8a551fcd65d09f50417dd18cbdbfe", "message": "reword error message and isolate need for try and catch", "committedDate": "2020-04-29T10:09:29Z", "type": "commit"}, {"oid": "5138660e78593451392921cc9601f84e13eefe2c", "url": "https://github.com/elastic/elasticsearch/commit/5138660e78593451392921cc9601f84e13eefe2c", "message": "javadocs", "committedDate": "2020-04-29T12:57:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417298525", "bodyText": "I was wondering, is it just DelayedWriteable or DelayedReadWriteable ? Because it's not that you can choose to delay its reading, it's the only way that it works?", "author": "javanna", "createdAt": "2020-04-29T13:06:03Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -28,10 +28,23 @@\n import java.util.function.Supplier;\n \n /**\n- * A holder for {@link Writeable}s that can delays reading the underlying\n- * {@linkplain Writeable} when it is read from a remote node.\n+ * A holder for {@link Writeable}s that delays reading the underlying object\n+ * on the receiving end. To be used for objects that use a lot of memory hence\n+ * it is desirable to keep them around only for a limited amount of time.\n+ * The node that produces the {@link Writeable} calls {@link #referencing(Writeable)}\n+ * to create a {@link DelayableWriteable} that serializes the inner object\n+ * first to a buffer and writes the content of the buffer to the {@link StreamOutput}.\n+ * The receiver node calls {@link #delayed(Reader, StreamInput)} to create a\n+ * {@link DelayableWriteable} that reads the buffer from the @link {@link StreamInput}\n+ * but delays creating the actual object by calling {@link #expand()} when needed.\n+ * Multiple {@link DelayableWriteable}s coming from different nodes may be buffered\n+ * on the receiver end, which may hold a mix of {@link DelayableWriteable}s that were\n+ * produced locally (hence expanded) as well as received form another node (hence subject\n+ * to delayed expansion). When such objects are buffered for some time it is desirable\n+ * to force their buffering in serialized format by calling\n+ * {@link #asSerialized(Reader, NamedWriteableRegistry)}.\n  */\n-public abstract class DelayableWriteable<T extends Writeable> implements Supplier<T>, Writeable {\n+public abstract class DelayableWriteable<T extends Writeable> implements Writeable {", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwNTY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417305649", "bodyText": "I guess so. I figured Writeable was the name for things that we threw across the wire and calling it Delayed was enough to imply that it delayed reading because that was sort of the only thing you could delay.\nAt this point, given how we use it, it might be more correct to call it PotentiallySerializedWriteable. But that is kind of mouthful. I think the whole \"Delayed\" bit of the name was perfect for the first PR that built it but it is less and less perfect now.", "author": "nik9000", "createdAt": "2020-04-29T13:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0MjY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417342670", "bodyText": "but why Delayed VS Delayable for instance?", "author": "javanna", "createdAt": "2020-04-29T14:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0Nzk1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417347956", "bodyText": "Because the referencing implementation isn't delayed.", "author": "nik9000", "createdAt": "2020-04-29T14:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MzIxMw==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417383213", "bodyText": "I find that that is a lie :) because writeTo will always do the two steps serialization that will allow for delaying the deserialization on the other side. The point is that referencing is only on the producer side hence you never read into referencing from the stream? Maybe a bit of a philosophical discussion.", "author": "javanna", "createdAt": "2020-04-29T14:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4NjcwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417386708", "bodyText": "I think we should rename it to something like SerializedReference or MaybeSerializedReference so maybe its not an issue then. I get where you are coming from though. The name is icky now.", "author": "nik9000", "createdAt": "2020-04-29T15:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI5ODkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417298920", "bodyText": "should we rename this to readDelayedWriteable ? also depending on the rename proposed above...", "author": "javanna", "createdAt": "2020-04-29T13:06:40Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -42,7 +55,7 @@\n     /**\n      * Build a {@linkplain DelayableWriteable} that copies a buffer from\n      * the provided {@linkplain StreamInput} and deserializes the buffer\n-     * when {@link Supplier#get()} is called.\n+     * when {@link #expand()} is called.\n      */\n     public static <T extends Writeable> DelayableWriteable<T> delayed(Writeable.Reader<T> reader, StreamInput in) throws IOException {", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMDY0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417300647", "bodyText": "I was wondering, is it an option to keep a reference to the original stream input so that we do not need this if and we can avoid exposing the new namedWriteableRegistry getter in StreamInput?", "author": "javanna", "createdAt": "2020-04-29T13:09:33Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -136,20 +156,20 @@ public void writeTo(StreamOutput out) throws IOException {\n                  * differences in the wire protocol. This ain't efficient but\n                  * it should be quite rare.\n                  */\n-                referencing(get()).writeTo(out);\n+                referencing(expand()).writeTo(out);\n             }\n         }\n \n         @Override\n-        public T get() {\n+        public T expand() {\n             try {\n                 try (StreamInput in = registry == null ?\n                         serialized.streamInput() : new NamedWriteableAwareStreamInput(serialized.streamInput(), registry)) {", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwOTIzNw==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417309237", "bodyText": "I think we could keep a reference to the original StreamInput but we'd still need to read the serialized bytes from it.\nI wonder if keeping a reference to the StreamInput would keep a reference to its underlying storage. If it did then it'd probably be bad to keep the reference.", "author": "nik9000", "createdAt": "2020-04-29T13:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMDY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0MzExNg==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417343116", "bodyText": "yea it did sound risky to me as well, and what we do instead looks fine to me.", "author": "javanna", "createdAt": "2020-04-29T14:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwMDY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwNjk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417306992", "bodyText": "Its more that deserializing it is inefficient compared to leaving it serialized. \"Big\" objects are fine to deserialize if they are no bigger when you deserialize them.", "author": "nik9000", "createdAt": "2020-04-29T13:19:18Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -28,10 +28,23 @@\n import java.util.function.Supplier;\n \n /**\n- * A holder for {@link Writeable}s that can delays reading the underlying\n- * {@linkplain Writeable} when it is read from a remote node.\n+ * A holder for {@link Writeable}s that delays reading the underlying object\n+ * on the receiving end. To be used for objects that use a lot of memory hence\n+ * it is desirable to keep them around only for a limited amount of time.", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0MTc3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417341777", "bodyText": "good point, will rephrase.", "author": "javanna", "createdAt": "2020-04-29T14:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwNjk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwNzA3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417307070", "bodyText": "s/is/may be/ ?", "author": "nik9000", "createdAt": "2020-04-29T13:19:25Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -28,10 +28,23 @@\n import java.util.function.Supplier;\n \n /**\n- * A holder for {@link Writeable}s that can delays reading the underlying\n- * {@linkplain Writeable} when it is read from a remote node.\n+ * A holder for {@link Writeable}s that delays reading the underlying object\n+ * on the receiving end. To be used for objects that use a lot of memory hence\n+ * it is desirable to keep them around only for a limited amount of time.\n+ * The node that produces the {@link Writeable} calls {@link #referencing(Writeable)}\n+ * to create a {@link DelayableWriteable} that serializes the inner object\n+ * first to a buffer and writes the content of the buffer to the {@link StreamOutput}.\n+ * The receiver node calls {@link #delayed(Reader, StreamInput)} to create a\n+ * {@link DelayableWriteable} that reads the buffer from the @link {@link StreamInput}\n+ * but delays creating the actual object by calling {@link #expand()} when needed.\n+ * Multiple {@link DelayableWriteable}s coming from different nodes may be buffered\n+ * on the receiver end, which may hold a mix of {@link DelayableWriteable}s that were\n+ * produced locally (hence expanded) as well as received form another node (hence subject\n+ * to delayed expansion). When such objects are buffered for some time it is desirable", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwNzQwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417307400", "bodyText": "Thanks for this change!", "author": "nik9000", "createdAt": "2020-04-29T13:19:58Z", "path": "server/src/main/java/org/elasticsearch/common/io/stream/DelayableWriteable.java", "diffHunk": "@@ -75,17 +93,19 @@ public void writeTo(StreamOutput out) throws IOException {\n         }\n \n         @Override\n-        public T get() {\n+        public T expand() {\n             return reference;\n         }\n \n         @Override\n         public Serialized<T> asSerialized(Reader<T> reader, NamedWriteableRegistry registry) {\n+            BytesStreamOutput buffer;\n             try {\n-                return new Serialized<T>(reader, Version.CURRENT, registry, writeToBuffer(Version.CURRENT).bytes());\n+                buffer = writeToBuffer(Version.CURRENT);\n             } catch (IOException e) {\n-                throw new RuntimeException(\"unexpected error expanding aggregations\", e);\n+                throw new RuntimeException(\"unexpected error writing writeable to buffer\", e);", "originalCommit": "5138660e78593451392921cc9601f84e13eefe2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ceace45fee475060f8cf44bc02809337013b59f3", "url": "https://github.com/elastic/elasticsearch/commit/ceace45fee475060f8cf44bc02809337013b59f3", "message": "reword javadocs", "committedDate": "2020-04-29T14:15:32Z", "type": "commit"}, {"oid": "02a0358082c6c25cbcf8d96d4a9936c4fda1af6e", "url": "https://github.com/elastic/elasticsearch/commit/02a0358082c6c25cbcf8d96d4a9936c4fda1af6e", "message": "Merge branch 'master' into enhancement/delayed_writeable", "committedDate": "2020-04-29T21:09:06Z", "type": "commit"}, {"oid": "022ae2908e01dfc6874d02a03d10c881ce9ba7fc", "url": "https://github.com/elastic/elasticsearch/commit/022ae2908e01dfc6874d02a03d10c881ce9ba7fc", "message": "adapt to async search changes", "committedDate": "2020-04-30T09:25:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MDUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55932#discussion_r417880509", "bodyText": "FYI @nik9000 I removed the uncertainty around producing right-ish aggs. I find that if certain aggs don't work it's a bug that we should fix like we did with scripted metric. The approach here around partial aggs is the correct one hence we should not have doubts about it :)", "author": "javanna", "createdAt": "2020-04-30T09:33:01Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -379,18 +379,16 @@ public void onPartialReduce(List<SearchShard> shards, TotalHits totalHits,\n                 reducedAggs = () -> null;\n             } else {\n                 /*\n-                 * Keep a reference to the serialiazed form of the partially\n+                 * Keep a reference to the serialized form of the partially\n                  * reduced aggs and reduce it on the fly when someone asks\n-                 * for it. This will produce right-ish aggs. Much more right\n-                 * than if you don't do the final reduce. Its important that", "originalCommit": "022ae2908e01dfc6874d02a03d10c881ce9ba7fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}