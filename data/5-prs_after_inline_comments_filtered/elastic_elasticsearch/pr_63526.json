{"pr_number": 63526, "pr_title": "Bugfix in InternalOrder.CompoundOrder", "pr_createdAt": "2020-10-10T16:47:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63526", "timeline": [{"oid": "94f517998ce6e3da3418347d3ad88d5a7ec22226", "url": "https://github.com/elastic/elasticsearch/commit/94f517998ce6e3da3418347d3ad88d5a7ec22226", "message": "Bugfix in InternalOrder.CompoundOrder\n\nIf the constructor InternalOrder.CompoundOrder was called with an empty\ncompoundOrder, then comparator() returned a comparator that would crash.\n(An alternative fix could be to ensure that `comparators` is always\nnonempty. However, checks such as (orders.size() >= 1) on line 388 and\nthe lack of any comment to the contrary suggest that it might be better\nto have code that works in the empty case too.)", "committedDate": "2020-10-10T16:43:08Z", "type": "commit"}, {"oid": "70818166d09f9eecf997f48b21198680dc9fbec2", "url": "https://github.com/elastic/elasticsearch/commit/70818166d09f9eecf997f48b21198680dc9fbec2", "message": "Added a check in the constructor of CompoundOrder", "committedDate": "2020-10-20T18:27:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1MjY4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63526#discussion_r508752684", "bodyText": "Now that we're sure comparators will never be empty, do you think it is worth making these two changes?", "author": "nik9000", "createdAt": "2020-10-20T18:36:30Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalOrder.java", "diffHunk": "@@ -185,25 +188,27 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n                     .map(oe -> oe.partiallyBuiltBucketComparator(ordinalReader, aggregator))\n                     .collect(toList());\n             return (lhs, rhs) -> {\n-                Iterator<Comparator<T>> itr = comparators.iterator();\n-                int result;\n-                do {\n-                    result = itr.next().compare(lhs, rhs);\n-                } while (result == 0 && itr.hasNext());\n-                return result;\n+                for (Comparator<T> c : comparators) {\n+                    int result = c.compare(lhs, rhs);\n+                    if (result != 0) {\n+                        return result;\n+                    }\n+                }\n+                return 0;", "originalCommit": "70818166d09f9eecf997f48b21198680dc9fbec2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc2MDA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63526#discussion_r508760052", "bodyText": "These changes aren't necessary, yes. I would keep them because (a) the new code is about the same complexity as the old one and (b) in case the nonempty restriction gets dropped in the future you don't need to remember to update these places.\nBut, it's a minor thing, so I'd say it's up to you if you want it or not.", "author": "rgrig", "createdAt": "2020-10-20T18:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1MjY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5NjQzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63526#discussion_r508796436", "bodyText": "Yeah, I think this fine, sure. I'll keep it!", "author": "nik9000", "createdAt": "2020-10-20T19:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1MjY4NA=="}], "type": "inlineReview"}, {"oid": "b2987a7fdcfd76bfecf26b1a5a4932334d96ad03", "url": "https://github.com/elastic/elasticsearch/commit/b2987a7fdcfd76bfecf26b1a5a4932334d96ad03", "message": "Merge branch 'master' into master", "committedDate": "2020-10-21T13:05:39Z", "type": "commit"}, {"oid": "1be2800f8870eaec9434dde365955058d08566f0", "url": "https://github.com/elastic/elasticsearch/commit/1be2800f8870eaec9434dde365955058d08566f0", "message": "Removed unused import.", "committedDate": "2020-10-21T17:29:11Z", "type": "commit"}, {"oid": "e2138675e2b8d0249670668785128691e0b4ebdc", "url": "https://github.com/elastic/elasticsearch/commit/e2138675e2b8d0249670668785128691e0b4ebdc", "message": "Merge branch 'master' of github.com:rgrig/elasticsearch", "committedDate": "2020-10-21T17:29:23Z", "type": "commit"}, {"oid": "1a25284b12da87874d91a04f5be417149421735c", "url": "https://github.com/elastic/elasticsearch/commit/1a25284b12da87874d91a04f5be417149421735c", "message": "Merge branch 'master' into master", "committedDate": "2020-10-21T18:40:11Z", "type": "commit"}]}