{"pr_number": 50908, "pr_title": "Check for deprecations when analyzers are built", "pr_createdAt": "2020-01-13T11:32:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50908", "timeline": [{"oid": "54c659cfe923d0a86e547bd0d963a0cad4e88a98", "url": "https://github.com/elastic/elasticsearch/commit/54c659cfe923d0a86e547bd0d963a0cad4e88a98", "message": "Check for deprecations when analyzers are built", "committedDate": "2020-01-13T11:24:48Z", "type": "commit"}, {"oid": "1ca8b8bc73c1722622ce87e8f20d000c9eca98cc", "url": "https://github.com/elastic/elasticsearch/commit/1ca8b8bc73c1722622ce87e8f20d000c9eca98cc", "message": "checkstyle; tests", "committedDate": "2020-01-13T12:09:57Z", "type": "commit"}, {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "url": "https://github.com/elastic/elasticsearch/commit/bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "message": "Add version check", "committedDate": "2020-01-13T14:43:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365880318", "bodyText": "Just a small observation: I thought this checks that the normalize method in DeprecatedTokenFilterFactory, so I tried changing it but the test didn't fail, do you know why?", "author": "cbuescher", "createdAt": "2020-01-13T15:55:14Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/TransportAnalyzeActionTests.java", "diffHunk": "@@ -492,4 +512,28 @@ public void testExceedSetMaxTokenLimit() {\n         assertEquals(e.getMessage(), \"The number of tokens produced by calling _analyze has exceeded the allowed maximum of [\"\n             + idxMaxTokenCount + \"].\" + \" This limit can be set by changing the [index.analyze.max_token_count] index level setting.\");\n     }\n+\n+    public void testDeprecationWarnings() throws IOException {\n+        AnalyzeAction.Request req = new AnalyzeAction.Request();\n+        req.tokenizer(\"standard\");\n+        req.addTokenFilter(\"lowercase\");\n+        req.addTokenFilter(\"deprecated\");\n+        req.text(\"test text\");\n+\n+        AnalyzeAction.Response analyze =\n+            TransportAnalyzeAction.analyze(req, registry, mockIndexService(), maxTokenCount);\n+        assertEquals(2, analyze.getTokens().size());\n+        assertWarnings(\"Using deprecated token filter [deprecated]\");\n+\n+        // normalizer\n+        req = new AnalyzeAction.Request();\n+        req.addTokenFilter(\"lowercase\");\n+        req.addTokenFilter(\"deprecated\");\n+        req.text(\"text\");\n+\n+        analyze =\n+            TransportAnalyzeAction.analyze(req, registry, mockIndexService(), maxTokenCount);\n+        assertEquals(1, analyze.getTokens().size());\n+        assertWarnings(\"Using deprecated token filter [deprecated]\");", "originalCommit": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4NDkwMw==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365884903", "bodyText": "Because the default implementation of normalize delegates to create, so we get the warning from there instead.", "author": "romseygeek", "createdAt": "2020-01-13T16:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwMTgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365901801", "bodyText": "So that sounds like the \"normalize()\" method isn't actualy tested here? I saw we cover that in some other test though, so fine with whatever you decide doing here, I was just curious if this could be checked here through the \"_analyze\" API as well, but no problem it its too tricky I.", "author": "cbuescher", "createdAt": "2020-01-13T16:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNjU3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365906579", "bodyText": "No, it's tested, but in order to make it fail you can't just remove the method (because that then delegates to create()), you have to have an implementation that doesn't emit a warning", "author": "romseygeek", "createdAt": "2020-01-13T16:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNzA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365907052", "bodyText": "Oh, I've just realised that we're talking about the AnalyzeAction - this always uses create() rather than normalize(), and we should probably change that.", "author": "romseygeek", "createdAt": "2020-01-13T16:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MjA2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365992062", "bodyText": "we should probably change that\n\nThis can most likely be done in a follow up PR though, I just wanted to understand whats going on here and which of the two methods in the DeprecatedTokenFilterFactory in this test is supposed to fire the warning, currently they emit the same text so its hard to tell which code path is checked.", "author": "cbuescher", "createdAt": "2020-01-13T19:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyNzM5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r366027396", "bodyText": "We also throw exceptions in some cases so it's not only about deprecations ?", "author": "jimczi", "createdAt": "2020-01-13T21:05:39Z", "path": "server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java", "diffHunk": "@@ -626,4 +632,17 @@ private void processNormalizerFactory(\n         NamedAnalyzer normalizer = new NamedAnalyzer(name, normalizerFactory.scope(), normalizerF);\n         normalizers.put(name, normalizer);\n     }\n+\n+    // Deprecation warnings are emitted when actual TokenStreams are built; this is usually\n+    // too late to be useful, so we build an empty tokenstream at construction time and\n+    // use it, to ensure that warnings are emitted immediately.", "originalCommit": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyNzcyNw==", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r366027727", "bodyText": "Can you also add a test that throws an exception ?", "author": "jimczi", "createdAt": "2020-01-13T21:06:29Z", "path": "server/src/test/java/org/elasticsearch/index/analysis/AnalysisRegistryTests.java", "diffHunk": "@@ -264,4 +271,90 @@ public void testEnsureCloseInvocationProperlyDelegated() throws IOException {\n         registry.close();\n         verify(mock).close();\n     }\n+\n+    public void testDeprecations() throws IOException {", "originalCommit": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "494147055697679e63b1eb80493fc448970bb92e", "url": "https://github.com/elastic/elasticsearch/commit/494147055697679e63b1eb80493fc448970bb92e", "message": "Add tests for exceptions as well", "committedDate": "2020-01-14T09:36:51Z", "type": "commit"}, {"oid": "9a18f6205e2b798be4230b684a20e4cbf5c0117c", "url": "https://github.com/elastic/elasticsearch/commit/9a18f6205e2b798be4230b684a20e4cbf5c0117c", "message": "Merge remote-tracking branch 'origin/master' into analysis/deprecations-check", "committedDate": "2020-01-14T09:54:33Z", "type": "commit"}, {"oid": "d938eaa2ddfa66beb28535a6c6226bc1fce50322", "url": "https://github.com/elastic/elasticsearch/commit/d938eaa2ddfa66beb28535a6c6226bc1fce50322", "message": "checkstyle", "committedDate": "2020-01-14T10:21:54Z", "type": "commit"}]}