{"pr_number": 65904, "pr_title": "[ML] remove thread sleep from results persister ", "pr_createdAt": "2020-12-04T21:08:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65904", "timeline": [{"oid": "e29974b5414c38bdf655d6455b8ab422e204973c", "url": "https://github.com/elastic/elasticsearch/commit/e29974b5414c38bdf655d6455b8ab422e204973c", "message": "[ML] remove thread sleep from results persister\nHaving a thread sleep in a recurring action may cause issues on node shutdown.\nWhat if the thread is sleeping while a nice shutdown is occurring? Since these retry timeouts\ncan extend to a larger period of time, we should instead use scheduled tasks + the threadpool.\nThis allows the retries to be effectively canceled instead of waiting for a thread to wake back up.\n\ncloses https://github.com/elastic/elasticsearch/issues/65890", "committedDate": "2020-12-04T20:21:10Z", "type": "commit"}, {"oid": "ef2e1529f42a47c58b16ed2c35e68422b943c2ef", "url": "https://github.com/elastic/elasticsearch/commit/ef2e1529f42a47c58b16ed2c35e68422b943c2ef", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-remove-thread-sleep-from-results-persister", "committedDate": "2020-12-04T20:36:38Z", "type": "commit"}, {"oid": "5e2b3bac4c20bae3734a29406e9d958b07be4ecf", "url": "https://github.com/elastic/elasticsearch/commit/5e2b3bac4c20bae3734a29406e9d958b07be4ecf", "message": "fixing tests", "committedDate": "2020-12-04T21:07:33Z", "type": "commit"}, {"oid": "8cf3f8490c7b3f33b243ee2840cf7ec3cbde6d25", "url": "https://github.com/elastic/elasticsearch/commit/8cf3f8490c7b3f33b243ee2840cf7ec3cbde6d25", "message": "fixing tests", "committedDate": "2020-12-07T18:49:37Z", "type": "commit"}, {"oid": "d3a79f667f5688f14e0164b6059ac9577f25282f", "url": "https://github.com/elastic/elasticsearch/commit/d3a79f667f5688f14e0164b6059ac9577f25282f", "message": "clearing up retry logging and fixing delay", "committedDate": "2020-12-07T20:04:15Z", "type": "commit"}, {"oid": "024b129bea847019ce907f5863cdd4cce638974e", "url": "https://github.com/elastic/elasticsearch/commit/024b129bea847019ce907f5863cdd4cce638974e", "message": "fixing test", "committedDate": "2020-12-07T21:23:38Z", "type": "commit"}, {"oid": "b2145476a8fefd0fe57514ef3dd2ef303d5eabeb", "url": "https://github.com/elastic/elasticsearch/commit/b2145476a8fefd0fe57514ef3dd2ef303d5eabeb", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-remove-thread-sleep-from-results-persister", "committedDate": "2020-12-07T21:23:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMzgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537813831", "bodyText": "Good catch, it was sending the wrong bulkRequest before", "author": "davidkyle", "createdAt": "2020-12-07T20:34:54Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/ResultsPersisterService.java", "diffHunk": "@@ -123,82 +120,70 @@ public BulkResponse bulkIndexWithRetry(BulkRequest bulkRequest,\n                                            String jobId,\n                                            Supplier<Boolean> shouldRetry,\n                                            Consumer<String> retryMsgHandler) {\n-        return bulkIndexWithRetry(bulkRequest, jobId, shouldRetry, retryMsgHandler,\n-            providedBulkRequest -> client.bulk(providedBulkRequest).actionGet());\n+        return bulkIndexWithRetry(bulkRequest,\n+            jobId,\n+            shouldRetry,\n+            retryMsgHandler,\n+            client::bulk);\n     }\n \n     public BulkResponse bulkIndexWithHeadersWithRetry(Map<String, String> headers,\n                                                       BulkRequest bulkRequest,\n                                                       String jobId,\n                                                       Supplier<Boolean> shouldRetry,\n                                                       Consumer<String> retryMsgHandler) {\n-        return bulkIndexWithRetry(bulkRequest, jobId, shouldRetry, retryMsgHandler,\n-            providedBulkRequest -> ClientHelper.executeWithHeaders(\n-                headers, ClientHelper.ML_ORIGIN, client, () -> client.execute(BulkAction.INSTANCE, bulkRequest).actionGet()));\n+        return bulkIndexWithRetry(bulkRequest,\n+            jobId,\n+            shouldRetry,\n+            retryMsgHandler,\n+            (providedBulkRequest, listener) -> ClientHelper.executeWithHeadersAsync(\n+                headers,\n+                ClientHelper.ML_ORIGIN,\n+                client,\n+                BulkAction.INSTANCE,\n+                providedBulkRequest,", "originalCommit": "d3a79f667f5688f14e0164b6059ac9577f25282f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxODc1MA==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537818750", "bodyText": "is this comment out of date?", "author": "davidkyle", "createdAt": "2020-12-07T20:43:29Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/ResultsPersisterService.java", "diffHunk": "@@ -208,48 +193,195 @@ private static boolean isIrrecoverable(Exception ex) {\n         return IRRECOVERABLE_REST_STATUSES.contains(status(t));\n     }\n \n-    /**\n-     * {@link RetryContext} object handles logic that is executed between consecutive retries of an action.\n-     *\n-     * Note that it does not execute the action itself.\n-     */\n-    private class RetryContext {\n+    @SuppressWarnings(\"NonAtomicOperationOnVolatileField\")\n+    private static class BulkRequestRewriter {\n+        private volatile BulkRequest bulkRequest;\n+        BulkRequestRewriter(BulkRequest initialRequest) {\n+            this.bulkRequest = initialRequest;\n+        }\n+\n+        void rewriteRequest(BulkResponse bulkResponse) {\n+            if (bulkResponse.hasFailures() == false) {\n+                return;\n+            }\n+            // To lines to make it obvious that this is two operations and non-atomic", "originalCommit": "d3a79f667f5688f14e0164b6059ac9577f25282f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk1MDU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537950581", "bodyText": "definitely :D", "author": "benwtrent", "createdAt": "2020-12-08T00:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxODc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDE0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537870143", "bodyText": "I don't understand why this is now required. Does it have to be part of this change?", "author": "davidkyle", "createdAt": "2020-12-07T22:09:07Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MlSingleNodeTestCase.java", "diffHunk": "@@ -128,11 +149,66 @@ protected void waitForMlTemplates() throws Exception {\n         return responseHolder.get();\n     }\n \n+    protected static ThreadPool mockThreadPool() {\n+        ThreadPool tp = mock(ThreadPool.class);\n+        ExecutorService executor = mock(ExecutorService.class);\n+        doAnswer(invocationOnMock -> {\n+            ((Runnable) invocationOnMock.getArguments()[0]).run();\n+            return null;\n+        }).when(executor).execute(any(Runnable.class));\n+        when(tp.executor(any(String.class))).thenReturn(executor);\n+        doAnswer(invocationOnMock -> {\n+            ((Runnable) invocationOnMock.getArguments()[0]).run();\n+            return null;\n+        }).when(tp).schedule(\n+            any(Runnable.class), any(TimeValue.class), any(String.class)\n+        );\n+        return tp;\n+    }\n+\n+\n     public static void assertNoException(AtomicReference<Exception> error) throws Exception {\n         if (error.get() == null) {\n             return;\n         }\n         throw error.get();\n     }\n \n+    public static class MockPainlessScriptEngine extends MockScriptEngine {", "originalCommit": "b2145476a8fefd0fe57514ef3dd2ef303d5eabeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk1MDgwNA==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537950804", "bodyText": "I noticed log spam when it wasn't around. This and the other changes (including more plugins) got rid of a bunch of log spam for the single node tests.", "author": "benwtrent", "createdAt": "2020-12-08T00:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MTc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r537871744", "bodyText": "I'm not convinced this class is bringing much to the party.\nprivate volatile BulkRequest bulkRequest; could be a field in BulkRetryableAction and buildNewRequestFromFailures could be called directly.", "author": "davidkyle", "createdAt": "2020-12-07T22:11:50Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/ResultsPersisterService.java", "diffHunk": "@@ -208,48 +193,195 @@ private static boolean isIrrecoverable(Exception ex) {\n         return IRRECOVERABLE_REST_STATUSES.contains(status(t));\n     }\n \n-    /**\n-     * {@link RetryContext} object handles logic that is executed between consecutive retries of an action.\n-     *\n-     * Note that it does not execute the action itself.\n-     */\n-    private class RetryContext {\n+    @SuppressWarnings(\"NonAtomicOperationOnVolatileField\")\n+    private static class BulkRequestRewriter {", "originalCommit": "b2145476a8fefd0fe57514ef3dd2ef303d5eabeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMyMjE3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r538322172", "bodyText": "could be a field in BulkRetryableAction and buildNewRequestFromFailures could be called directly.\n\nNo, it cannot. Because the action is passed via super the super is ctor'd before the child class is. So, references DIRECTLY to the child class methods is not possible.\nThis class guaruntees things are constructed and mutable inside the lambda passed to super.", "author": "benwtrent", "createdAt": "2020-12-08T12:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MTc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA5MjQwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r538092409", "bodyText": "Could you please add some unit indication? Like minimumDelayMillis()?", "author": "przemekwitek", "createdAt": "2020-12-08T07:20:47Z", "path": "server/src/main/java/org/elasticsearch/action/support/RetryableAction.java", "diffHunk": "@@ -118,6 +118,10 @@ protected long calculateDelay(long previousDelay) {\n         return Math.min(previousDelay * 2, Integer.MAX_VALUE);\n     }\n \n+    protected long minimumDelay() {", "originalCommit": "d3a79f667f5688f14e0164b6059ac9577f25282f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMxNzM4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65904#discussion_r538317387", "bodyText": "100%", "author": "benwtrent", "createdAt": "2020-12-08T12:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA5MjQwOQ=="}], "type": "inlineReview"}, {"oid": "e17cc9d466dd61e376a82a2539d4628dcc20842c", "url": "https://github.com/elastic/elasticsearch/commit/e17cc9d466dd61e376a82a2539d4628dcc20842c", "message": "addressing PR comments", "committedDate": "2020-12-08T12:44:27Z", "type": "commit"}, {"oid": "94687f2a2cf0c40730c6bdb2715e90fb8b1b2177", "url": "https://github.com/elastic/elasticsearch/commit/94687f2a2cf0c40730c6bdb2715e90fb8b1b2177", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-remove-thread-sleep-from-results-persister", "committedDate": "2020-12-08T12:44:33Z", "type": "commit"}]}