{"pr_number": 53924, "pr_title": "Introduce formal role for remote cluster client", "pr_createdAt": "2020-03-21T22:02:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53924", "timeline": [{"oid": "ca60574ea4cfaee742338c3bba86dbffcf96a539", "url": "https://github.com/elastic/elasticsearch/commit/ca60574ea4cfaee742338c3bba86dbffcf96a539", "message": "Introduce formal role for remote cluster client\n\nThis commit introduce a formal role for identifying nodes that are\ncapable of making connections to remote clusters.", "committedDate": "2020-03-21T22:00:49Z", "type": "commit"}, {"oid": "c0fd36ad818b1c3343f9b44f70cd57fa0b46866d", "url": "https://github.com/elastic/elasticsearch/commit/c0fd36ad818b1c3343f9b44f70cd57fa0b46866d", "message": "Fix logging", "committedDate": "2020-03-21T23:19:58Z", "type": "commit"}, {"oid": "4c8dab749b76a25da2daa0f21420f8aa8f6ac738", "url": "https://github.com/elastic/elasticsearch/commit/4c8dab749b76a25da2daa0f21420f8aa8f6ac738", "message": "Fix logging", "committedDate": "2020-03-21T23:31:23Z", "type": "commit"}, {"oid": "fceee1b56b55ffd5b4f732cb0c8efa92399a575c", "url": "https://github.com/elastic/elasticsearch/commit/fceee1b56b55ffd5b4f732cb0c8efa92399a575c", "message": "Fix test", "committedDate": "2020-03-21T23:47:15Z", "type": "commit"}, {"oid": "7ef398395cea56b8a3af390c5df77d0e90779643", "url": "https://github.com/elastic/elasticsearch/commit/7ef398395cea56b8a3af390c5df77d0e90779643", "message": "Fix imports", "committedDate": "2020-03-22T01:27:54Z", "type": "commit"}, {"oid": "d9938e5e077b20878f348f52e3ff053ad3ccc29c", "url": "https://github.com/elastic/elasticsearch/commit/d9938e5e077b20878f348f52e3ff053ad3ccc29c", "message": "Fix imports", "committedDate": "2020-03-22T01:35:55Z", "type": "commit"}, {"oid": "407c7b16ff1194f166cf368f50db40ceba700c1e", "url": "https://github.com/elastic/elasticsearch/commit/407c7b16ff1194f166cf368f50db40ceba700c1e", "message": "Fix imports", "committedDate": "2020-03-22T01:52:34Z", "type": "commit"}, {"oid": "8dd2df54b9ae87e503971abb680980eb5fd7d3c6", "url": "https://github.com/elastic/elasticsearch/commit/8dd2df54b9ae87e503971abb680980eb5fd7d3c6", "message": "Fix tests", "committedDate": "2020-03-22T12:09:07Z", "type": "commit"}, {"oid": "91cb86a1d8123dcb739262e94461836eecb47c07", "url": "https://github.com/elastic/elasticsearch/commit/91cb86a1d8123dcb739262e94461836eecb47c07", "message": "Fix imports", "committedDate": "2020-03-22T13:50:31Z", "type": "commit"}, {"oid": "ee52c2fcb0bd6f26d5262838938b995ab2661252", "url": "https://github.com/elastic/elasticsearch/commit/ee52c2fcb0bd6f26d5262838938b995ab2661252", "message": "Fix tests", "committedDate": "2020-03-22T15:25:58Z", "type": "commit"}, {"oid": "8c0216aa8774e6b7314f542b8a3bce009538561a", "url": "https://github.com/elastic/elasticsearch/commit/8c0216aa8774e6b7314f542b8a3bce009538561a", "message": "Fix imports", "committedDate": "2020-03-22T15:50:02Z", "type": "commit"}, {"oid": "da81d3fb8a7c011b4459c3d4f87d2c8952bd4002", "url": "https://github.com/elastic/elasticsearch/commit/da81d3fb8a7c011b4459c3d4f87d2c8952bd4002", "message": "Merge branch 'master' into remote-cluster-client-role", "committedDate": "2020-03-23T21:09:46Z", "type": "commit"}, {"oid": "389f5e238d3ce169a5f7e159c33b1f3d869af30a", "url": "https://github.com/elastic/elasticsearch/commit/389f5e238d3ce169a5f7e159c33b1f3d869af30a", "message": "Merge remote-tracking branch 'elastic/master' into remote-cluster-client-role", "committedDate": "2020-03-23T22:34:47Z", "type": "commit"}, {"oid": "0647f12b10abafe1e2836ca0499b461d1768a1c5", "url": "https://github.com/elastic/elasticsearch/commit/0647f12b10abafe1e2836ca0499b461d1768a1c5", "message": "Update", "committedDate": "2020-03-23T22:36:48Z", "type": "commit"}, {"oid": "acba939510cfb91e907669925cd77945f8be20d3", "url": "https://github.com/elastic/elasticsearch/commit/acba939510cfb91e907669925cd77945f8be20d3", "message": "Fix tests", "committedDate": "2020-03-24T01:30:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMzAyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53924#discussion_r397413029", "bodyText": "Shouldn't this be based on version? At what point would this get updated? Perhaps we could use a map of role to min version (or a predicate) and iterate over them checking each role when serializing against the version of the output stream?", "author": "rjernst", "createdAt": "2020-03-24T19:38:31Z", "path": "server/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodeRole.java", "diffHunk": "@@ -134,10 +134,21 @@ public final String toString() {\n \n     };\n \n+    public static final DiscoveryNodeRole REMOTE_CLUSTER_CLIENT_ROLE = new DiscoveryNodeRole(\"remote_cluster_client\", \"r\") {\n+\n+        @Override\n+        protected Setting<Boolean> roleSetting() {\n+            return Node.NODE_REMOTE_CLUSTER_CLIENT;\n+        }\n+\n+    };\n+\n     /**\n      * The built-in node roles.\n      */\n-    public static Set<DiscoveryNodeRole> BUILT_IN_ROLES = Set.of(DATA_ROLE, INGEST_ROLE, MASTER_ROLE);\n+    public static Set<DiscoveryNodeRole> BUILT_IN_ROLES = Set.of(DATA_ROLE, INGEST_ROLE, MASTER_ROLE, REMOTE_CLUSTER_CLIENT_ROLE);\n+\n+    static Set<DiscoveryNodeRole> LEGACY_ROLES = Set.of(DATA_ROLE, INGEST_ROLE, MASTER_ROLE);", "originalCommit": "acba939510cfb91e907669925cd77945f8be20d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQyODA2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53924#discussion_r397428069", "bodyText": "No, this shouldn't be based on version. We have two things:\n\nvery old nodes before we made roles pluggable that only understand three roles: master, data, and ingest\nnew nodes after we made roles pluggable that understand the roles they are built with us, but also understand that other nodes might send them roles that they don't understand\nfor example, a 7.6.0 node today while it doesn't have a role built-in for remote_cluster_client, does have the ability to receive that role from a 7.7.0 node, and represent it accordingly\nhowever, a 7.0.0 node, before we made roles pluggable, has no possibility of understanding a remote_cluster_client role, it would blow up if it sees it", "author": "jasontedor", "createdAt": "2020-03-24T20:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMzAyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNTIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/53924#discussion_r397505234", "bodyText": "Thanks for the explanation", "author": "rjernst", "createdAt": "2020-03-24T22:41:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMzAyOQ=="}], "type": "inlineReview"}]}