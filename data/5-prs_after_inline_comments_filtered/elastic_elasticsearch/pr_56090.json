{"pr_number": 56090, "pr_title": "Fix smtp.ssl.trust setting for watcher email", "pr_createdAt": "2020-05-04T00:09:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56090", "timeline": [{"oid": "c32311557332513ddf23967e39ab43dac4284778", "url": "https://github.com/elastic/elasticsearch/commit/c32311557332513ddf23967e39ab43dac4284778", "message": "Fix smtp.ssl.trust setting for watcher email\n\nThe ssl.trust setting for Watcher provides a list of hostnames that\nshould be automatically trusted for SSL hostname verification. It was\naccidentally broken when we added the full ssl.* settings for email\nnotifications (see #45272)\n\nThis commit corrects this, so the setting is once again respected,\nas long as none of the other ssl settings are configured for email\nnotifications.\n\nResolves: #52153", "committedDate": "2020-05-04T00:04:27Z", "type": "commit"}, {"oid": "21e6cc8aa0aa95eb5e72ef0c1f65bac76f1d4ed3", "url": "https://github.com/elastic/elasticsearch/commit/21e6cc8aa0aa95eb5e72ef0c1f65bac76f1d4ed3", "message": "Merge branch 'master' into fix/52153-mail-ssl-trust", "committedDate": "2020-05-04T00:31:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUwMTgwNA==", "url": "https://github.com/elastic/elasticsearch/pull/56090#discussion_r419501804", "bodyText": "The word \"explicit\" is a bit vague to me. Both \"mail.smtp.ssl\" and \"xpack.notification.email.ssl\" feel explicit to me. Also isExplicitlyConfigured means  \"xpack.notification.email.ssl\" is not empty, which is opposite to what it means here.\nMaybe change it to something like:\nSpecific smtp SSL settings [{}] of account [{}] will be ignored due to notification SSL settings [{}].\nOr we could even drop the word \"Specific\" and just say \"smtp ...\", since it feels odds for specific settings to be overridden by more general settings.", "author": "ywangd", "createdAt": "2020-05-04T14:59:31Z", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/notification/email/Account.java", "diffHunk": "@@ -197,6 +200,15 @@ private void setContextClassLoader(final ClassLoader classLoader) {\n                 throw new SettingsException(msg);\n             }\n             if (sslSocketFactory != null) {\n+                String sslKeys = smtp.properties.keySet().stream()\n+                    .map(String::valueOf)\n+                    .filter(key -> key.startsWith(\"mail.smtp.ssl.\"))\n+                    .collect(Collectors.joining(\",\"));\n+                if (sslKeys.isEmpty() == false) {\n+                    logger.warn(\"Account [{}] has explicit SSL settings [{}] which will be ignored\" +\n+                            \" due to notification SSL settings in [{}]\",", "originalCommit": "21e6cc8aa0aa95eb5e72ef0c1f65bac76f1d4ed3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUwNTgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/56090#discussion_r419505826", "bodyText": "Is this accurate? The verfication_mode should be set to full in the below code since ssl.trust gets overridden?", "author": "ywangd", "createdAt": "2020-05-04T15:05:00Z", "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailSslTests.java", "diffHunk": "@@ -125,6 +125,52 @@ public void testCanSendMessageToSmtpServerByDisablingVerification() throws Excep\n         }\n     }\n \n+    public void testCanSendMessageToSmtpServerUsingSmtpSslTrust() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM with verification mode None\", inFipsJvm());\n+        List<MimeMessage> messages = new ArrayList<>();\n+        server.addListener(messages::add);\n+        try {\n+            final Settings.Builder settings = Settings.builder()\n+                .put(\"xpack.notification.email.account.test.smtp.ssl.trust\", \"localhost\");\n+            final MockSecureSettings secureSettings = new MockSecureSettings();\n+            ExecutableEmailAction emailAction = buildEmailAction(settings, secureSettings);\n+\n+            WatchExecutionContext ctx = WatcherTestUtils.createWatchExecutionContext();\n+            emailAction.execute(\"my_action_id\", ctx, Payload.EMPTY);\n+\n+            assertThat(messages, hasSize(1));\n+        } finally {\n+            server.clearListeners();\n+        }\n+    }\n+\n+    /**\n+     * This orderining could be considered to be backwards (the global \"notification\" settings take precedence\n+     * over the account level \"smtp.ssl.trust\" setting) but smtp.ssl.trust was ignored for a period of time (see #52153)\n+     * so this is the least breaking way to resolve that.\n+     */\n+    public void testNotificationSslSettingsOverrideSmtpSslTrust() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM with verification mode None\", inFipsJvm());", "originalCommit": "21e6cc8aa0aa95eb5e72ef0c1f65bac76f1d4ed3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "319804ea93dcf3c8a0d5c36897a7a16fc91e426a", "url": "https://github.com/elastic/elasticsearch/commit/319804ea93dcf3c8a0d5c36897a7a16fc91e426a", "message": "Address feedback", "committedDate": "2020-05-28T04:31:20Z", "type": "commit"}, {"oid": "20f29cb8f1e86765588906f0f27cbb822e068e9a", "url": "https://github.com/elastic/elasticsearch/commit/20f29cb8f1e86765588906f0f27cbb822e068e9a", "message": "Merge branch 'master' into fix/52153-mail-ssl-trust", "committedDate": "2020-05-28T04:43:57Z", "type": "commit"}]}