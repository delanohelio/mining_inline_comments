{"pr_number": 62287, "pr_title": "Add example settings to sample security realm", "pr_createdAt": "2020-09-14T04:58:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62287", "timeline": [{"oid": "e1df11c1ac39f42eb4f7d3708b53b208b419f401", "url": "https://github.com/elastic/elasticsearch/commit/e1df11c1ac39f42eb4f7d3708b53b208b419f401", "message": "Add example settings to sample security realm\n\nThis change adds configurable settings to the `CustomRealm` in the QA\nproject as the correct declaration and use of settings can be a source\nof confusion in custom realms.\n\nThe \"username\" \"password\" and \"roles\" are now all configurable, which\ndemonstrates the use of a simple string setting (\"username\") a secure\nsetting (\"password\") and a more complex list setting (\"roles\").", "committedDate": "2020-09-14T04:54:37Z", "type": "commit"}, {"oid": "9138f6f26d2b31adb71401dab28dd05f595b7036", "url": "https://github.com/elastic/elasticsearch/commit/9138f6f26d2b31adb71401dab28dd05f595b7036", "message": "Merge branch 'master' into sample-realm-config", "committedDate": "2020-09-14T05:46:08Z", "type": "commit"}, {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286", "url": "https://github.com/elastic/elasticsearch/commit/5101a1573891df47b36fe644b965c0cb9cdb0286", "message": "Merge branch 'master' into sample-realm-config", "committedDate": "2020-09-15T01:24:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA0MzIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r492043220", "bodyText": "Unless you are intentionally showing that password here can bypass the \"at last 6-chars\" policy, I'd prefer it to be compliant for consistency.", "author": "ywangd", "createdAt": "2020-09-21T13:27:19Z", "path": "x-pack/qa/security-example-spi-extension/src/test/java/org/elasticsearch/example/realm/CustomRealmTests.java", "diffHunk": "@@ -17,26 +18,56 @@\n import org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken;\n import org.elasticsearch.xpack.core.security.user.User;\n \n+import java.util.List;\n+\n import static org.elasticsearch.xpack.core.security.authc.RealmSettings.getFullSettingKey;\n+import static org.hamcrest.Matchers.arrayContaining;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.notNullValue;\n \n public class CustomRealmTests extends ESTestCase {\n-    public void testAuthenticate() {\n+\n+    public void testAuthenticateDefaultConfig() {\n         Settings globalSettings = Settings.builder().put(\"path.home\", createTempDir()).build();\n         final RealmConfig.RealmIdentifier realmIdentifier = new RealmConfig.RealmIdentifier(CustomRealm.TYPE, \"test\");\n         CustomRealm realm = new CustomRealm(new RealmConfig(\n             realmIdentifier,\n             Settings.builder().put(globalSettings).put(getFullSettingKey(realmIdentifier, RealmSettings.ORDER_SETTING), 0).build(),\n             TestEnvironment.newEnvironment(globalSettings), new ThreadContext(globalSettings)));\n-        SecureString password = CustomRealm.KNOWN_PW.clone();\n-        UsernamePasswordToken token = new UsernamePasswordToken(CustomRealm.KNOWN_USER, password);\n+        SecureString password = CustomRealm.DEFAULT_KNOWN_PW.clone();\n+        UsernamePasswordToken token = new UsernamePasswordToken(CustomRealm.DEFAULT_KNOWN_USER, password);\n+        PlainActionFuture<AuthenticationResult> plainActionFuture = new PlainActionFuture<>();\n+        realm.authenticate(token, plainActionFuture);\n+        User user = plainActionFuture.actionGet().getUser();\n+        assertThat(user, notNullValue());\n+        assertThat(List.of(user.roles()), equalTo(CustomRealm.DEFAULT_ROLES));\n+        assertThat(user.principal(), equalTo(CustomRealm.DEFAULT_KNOWN_USER));\n+    }\n+\n+    public void testAuthenticateCustomConfig() {\n+        final RealmConfig.RealmIdentifier realmIdentifier = new RealmConfig.RealmIdentifier(CustomRealm.TYPE, \"test\");\n+        MockSecureSettings secureSettings = new MockSecureSettings();\n+        secureSettings.setString(getFullSettingKey(realmIdentifier.getName(), CustomRealm.PASSWORD_SETTING), \"12345\");", "originalCommit": "5101a1573891df47b36fe644b965c0cb9cdb0286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2MTcwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r499361701", "bodyText": "I'm disappointed that my film references are being lost here, but will do.", "author": "tvernum", "createdAt": "2020-10-05T06:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA0MzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1OTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r492059757", "bodyText": "This is rather a question for my learning. Why are these needed here? This configures the threadContext to always contain the right headers of username and password. Does that mean transport client can always connect without providing credentials?", "author": "ywangd", "createdAt": "2020-09-21T13:49:21Z", "path": "x-pack/qa/security-example-spi-extension/src/javaRestTest/java/org/elasticsearch/example/realm/CustomRealmIT.java", "diffHunk": "@@ -23,12 +23,16 @@\n  */\n public class CustomRealmIT extends ESRestTestCase {\n \n+    // These are configured in build.gradle\n+    public static final String USERNAME= \"test_user\";\n+    public static final String PASSWORD = \"secret_password\";\n+\n     @Override\n     protected Settings restClientSettings() {\n         return Settings.builder()\n-                .put(ThreadContext.PREFIX + \".\" + CustomRealm.USER_HEADER, CustomRealm.KNOWN_USER)\n-                .put(ThreadContext.PREFIX + \".\" + CustomRealm.PW_HEADER, CustomRealm.KNOWN_PW.toString())\n-                .build();\n+            .put(ThreadContext.PREFIX + \".\" + CustomRealm.USER_HEADER, USERNAME)\n+            .put(ThreadContext.PREFIX + \".\" + CustomRealm.PW_HEADER, PASSWORD)", "originalCommit": "5101a1573891df47b36fe644b965c0cb9cdb0286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2MzQ1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r499363453", "bodyText": "This is for rest client not transport client, but it follow the same patterns as transport client (so it's a bit confusing).\nIn ESRestTestCase, rather than configure a client in code, the pattern is to configure the headers in a Settings object that is used to configure the client.\nThis is setting the username & password that the default client uses so that it can connect to the external cluster.", "author": "tvernum", "createdAt": "2020-10-05T06:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1OTc1Nw=="}], "type": "inlineReview"}, {"oid": "73104d7b3882ba23d2849129ff27a90ee481078d", "url": "https://github.com/elastic/elasticsearch/commit/73104d7b3882ba23d2849129ff27a90ee481078d", "message": "Merge branch 'master' into sample-realm-config", "committedDate": "2020-10-05T06:04:26Z", "type": "commit"}, {"oid": "4ff74fd0160ee47e36942fc2620c6235f03eda30", "url": "https://github.com/elastic/elasticsearch/commit/4ff74fd0160ee47e36942fc2620c6235f03eda30", "message": "Address feedback", "committedDate": "2020-10-05T06:24:52Z", "type": "commit"}]}