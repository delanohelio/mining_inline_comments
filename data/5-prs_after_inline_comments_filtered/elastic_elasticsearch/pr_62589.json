{"pr_number": 62589, "pr_title": "Add index.routing.allocation.include._tier_preference setting", "pr_createdAt": "2020-09-17T22:43:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62589", "timeline": [{"oid": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "url": "https://github.com/elastic/elasticsearch/commit/872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "message": "Add index.routing.allocation.prefer._tier setting\n\nThis commit adds the `index.routing.allocation.prefer._tier` setting to the\n`DataTierAllocationDecider`. This special-purpose allocation setting lets a user specify a\npreference-based list of tiers for an index to be assigned to. For example, if the setting were set\nto:\n\n```\n\"index.routing.allocation.prefer._tier\": \"data_hot,data_warm,data_content\"\n```\n\nIf the cluster contains any nodes with the `data_hot` role, the decider will only allow them to be\nallocated on the `data_hot` node(s). If there are no `data_hot` nodes, but there are `data_warm` and\n`data_content` nodes, then the index will be allowed to be allocated on `data_warm` nodes.\n\nThis allows us to specify an index's preference for tier(s) without causing the index to be\nunassigned if no nodes of a preferred tier are available.\n\nSubsequent work will change the ILM migration to make additional use of this setting.\n\nRelates to #60848", "committedDate": "2020-09-17T22:38:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0MzM2NA==", "url": "https://github.com/elastic/elasticsearch/pull/62589#discussion_r490943364", "bodyText": "would this be better named as preferedAvailableTier or preferedPresentTier?", "author": "andreidan", "createdAt": "2020-09-18T13:19:28Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/cluster/routing/allocation/DataTierAllocationDecider.java", "diffHunk": "@@ -186,6 +231,29 @@ private Decision shouldClusterFilter(DiscoveryNode node, RoutingAllocation alloc\n         OR\n     }\n \n+    /**\n+     * Given a string of comma-separated prioritized tiers (highest priority\n+     * first) and an allocation, find the highest priority tier for which nodes\n+     * exist. If no nodes for any of the tiers are available, returns an empty\n+     * {@code Optional<String>}.\n+     */\n+    private static Optional<String> preferredTier(String prioritizedTiers, RoutingAllocation allocation) {", "originalCommit": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0NTI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/62589#discussion_r490945278", "bodyText": "should we make both these methods as default visible and add unit tests?", "author": "andreidan", "createdAt": "2020-09-18T13:22:31Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/cluster/routing/allocation/DataTierAllocationDecider.java", "diffHunk": "@@ -186,6 +231,29 @@ private Decision shouldClusterFilter(DiscoveryNode node, RoutingAllocation alloc\n         OR\n     }\n \n+    /**\n+     * Given a string of comma-separated prioritized tiers (highest priority\n+     * first) and an allocation, find the highest priority tier for which nodes\n+     * exist. If no nodes for any of the tiers are available, returns an empty\n+     * {@code Optional<String>}.\n+     */\n+    private static Optional<String> preferredTier(String prioritizedTiers, RoutingAllocation allocation) {\n+        String[] tiers = Strings.tokenizeToStringArray(prioritizedTiers, \",\");\n+        return Arrays.stream(tiers).filter(tier -> tierNodesPresent(tier, allocation)).findFirst();\n+    }\n+\n+    private static boolean tierNodesPresent(String singleTier, RoutingAllocation allocation) {", "originalCommit": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "55ae5ea48b3c335a031859d5d4dbf6147fdbff73", "url": "https://github.com/elastic/elasticsearch/commit/55ae5ea48b3c335a031859d5d4dbf6147fdbff73", "message": "Rename setting to `index.routing.allocation.include._tier_preference`", "committedDate": "2020-09-18T16:00:49Z", "type": "commit"}, {"oid": "5e7897a37d234d2bfb503519cdb5c21e93b7c7ba", "url": "https://github.com/elastic/elasticsearch/commit/5e7897a37d234d2bfb503519cdb5c21e93b7c7ba", "message": "Add unit tests for static methods", "committedDate": "2020-09-18T16:24:23Z", "type": "commit"}, {"oid": "3f88f2e2be81374aa6e995f7d4603eefb13860e0", "url": "https://github.com/elastic/elasticsearch/commit/3f88f2e2be81374aa6e995f7d4603eefb13860e0", "message": "Add unit tests for integration between preference and include/require/exclude", "committedDate": "2020-09-18T16:36:03Z", "type": "commit"}, {"oid": "0401cb75ca4830acc2a0fcb39b027998ad0fc0d8", "url": "https://github.com/elastic/elasticsearch/commit/0401cb75ca4830acc2a0fcb39b027998ad0fc0d8", "message": "Merge branch 'master' into dt-allow-preference-for-tier", "committedDate": "2020-09-18T17:01:33Z", "type": "commit"}, {"oid": "d5bdfa4a6778a92e59a42fe0ce76644caf63a9f8", "url": "https://github.com/elastic/elasticsearch/commit/d5bdfa4a6778a92e59a42fe0ce76644caf63a9f8", "message": "Fix tests\n\nDiscoveryNodeFilters needs to ignore all _tier* attributes, not just _tier", "committedDate": "2020-09-18T17:42:14Z", "type": "commit"}, {"oid": "b79e6523fee7e4cce12fe8473710cb312701daf5", "url": "https://github.com/elastic/elasticsearch/commit/b79e6523fee7e4cce12fe8473710cb312701daf5", "message": "Fix tests for setting rename", "committedDate": "2020-09-18T18:10:44Z", "type": "commit"}]}