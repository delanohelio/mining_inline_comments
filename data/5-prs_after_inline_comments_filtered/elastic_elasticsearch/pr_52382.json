{"pr_number": 52382, "pr_title": "Geo shape query vs geo point", "pr_createdAt": "2020-02-14T19:51:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52382", "timeline": [{"oid": "fdc8379fe5f1af4068c3ec098fe3f681e109c02f", "url": "https://github.com/elastic/elasticsearch/commit/fdc8379fe5f1af4068c3ec098fe3f681e109c02f", "message": "refactor make doCreateTestQueryBuilder(boolean indexedShape) abstract", "committedDate": "2020-03-11T12:24:59Z", "type": "commit"}, {"oid": "3db5f95fcdd7a1baf3e0b96ae2f6f586bba601c9", "url": "https://github.com/elastic/elasticsearch/commit/3db5f95fcdd7a1baf3e0b96ae2f6f586bba601c9", "message": "added @iverase patch", "committedDate": "2020-03-13T07:56:35Z", "type": "commit"}, {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "url": "https://github.com/elastic/elasticsearch/commit/7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "message": "fix style violations", "committedDate": "2020-03-13T08:17:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5MjE4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392092186", "bodyText": "@djptek this is my fault but I think is more correct to call it AbstractSearchableGeometryFieldType?", "author": "iverase", "createdAt": "2020-03-13T08:38:59Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,33 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearcheableGeometryFieldType extends MappedFieldType {\n+", "originalCommit": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5MjY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392092652", "bodyText": "In this subclass we can remove setGeometryQueryBuilder and geometryQueryBuilder methods?", "author": "iverase", "createdAt": "2020-03-13T08:40:15Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,33 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearcheableGeometryFieldType extends MappedFieldType {\n+\n+        protected QueryProcessor geometryQueryBuilder;\n+\n+        protected AbstractSearcheableGeometryFieldType() {\n+        }\n+\n+        protected AbstractSearcheableGeometryFieldType(AbstractSearcheableGeometryFieldType ref) {\n+            super(ref);\n+        }\n+        public void setGeometryQueryBuilder(QueryProcessor geometryQueryBuilder)  {\n+            this.geometryQueryBuilder = geometryQueryBuilder;\n+        }\n+\n+        public QueryProcessor geometryQueryBuilder() {\n+            return geometryQueryBuilder;\n+        }\n+    }\n+\n+    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends AbstractSearcheableGeometryFieldType {", "originalCommit": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1f1a4b4a13d31165043e0ef65fe6561e26dbb96", "url": "https://github.com/elastic/elasticsearch/commit/e1f1a4b4a13d31165043e0ef65fe6561e26dbb96", "message": "fix classname typo", "committedDate": "2020-03-13T08:46:52Z", "type": "commit"}, {"oid": "bf79c774938d1e799acd87475ac98767145b8c5b", "url": "https://github.com/elastic/elasticsearch/commit/bf79c774938d1e799acd87475ac98767145b8c5b", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-13T09:45:59Z", "type": "commit"}, {"oid": "51dcb707a169c3e2c2de098a9441e0f1cbb85662", "url": "https://github.com/elastic/elasticsearch/commit/51dcb707a169c3e2c2de098a9441e0f1cbb85662", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-13T09:47:02Z", "type": "commit"}, {"oid": "4251742678c4a72da0ac74d2daa5a151383c14ad", "url": "https://github.com/elastic/elasticsearch/commit/4251742678c4a72da0ac74d2daa5a151383c14ad", "message": "remove copycat methods from child class", "committedDate": "2020-03-13T10:54:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ5MTkyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392491925", "bodyText": "Since GeoPointFieldMapper doesn't inherit from AbstractGeometryFieldMapper I would prefer AbstractSearchableGeometryFieldType to be in a separate file. It's not longer confined to AbstractGeometryFieldMapper and its derivatives, so doesn't make much sense making it an inner class. It would be also good to add some javadocs to it explaining the purpose of this class for future readers. Basically, something as simple as \"a base class for geometry types that supports shape query builder\" should help.", "author": "imotov", "createdAt": "2020-03-13T21:31:35Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,34 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearchableGeometryFieldType extends MappedFieldType {", "originalCommit": "4251742678c4a72da0ac74d2daa5a151383c14ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDE5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392514197", "bodyText": "thanks @imotov that's done", "author": "djptek", "createdAt": "2020-03-13T22:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ5MTkyNQ=="}], "type": "inlineReview"}, {"oid": "bd9cb07fba2a506162e2ab5db7cbb101a3a2eb99", "url": "https://github.com/elastic/elasticsearch/commit/bd9cb07fba2a506162e2ab5db7cbb101a3a2eb99", "message": "added AbstractSearchableGeometryFieldType as separate file", "committedDate": "2020-03-13T22:31:05Z", "type": "commit"}, {"oid": "7dcfa6ece9a4535e561aca05309f0c7d562918a6", "url": "https://github.com/elastic/elasticsearch/commit/7dcfa6ece9a4535e561aca05309f0c7d562918a6", "message": "add Licenseheaders", "committedDate": "2020-03-14T07:52:51Z", "type": "commit"}, {"oid": "3b49c3d001242ef47ea75f9145aec08967762082", "url": "https://github.com/elastic/elasticsearch/commit/3b49c3d001242ef47ea75f9145aec08967762082", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-14T08:40:58Z", "type": "commit"}, {"oid": "6358862b0d8e12ecf6af59be7a065b12e9c72b2a", "url": "https://github.com/elastic/elasticsearch/commit/6358862b0d8e12ecf6af59be7a065b12e9c72b2a", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-14T08:41:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2OTE3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392569176", "bodyText": "Shouldn't be move the query processor interface in this class as well?", "author": "iverase", "createdAt": "2020-03-14T08:49:46Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractSearchableGeometryFieldType.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+/**\n+ * a base class for geometry types that support shape query builder\n+ */\n+public abstract class AbstractSearchableGeometryFieldType extends MappedFieldType {\n+\n+    protected AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder;\n+\n+    protected AbstractSearchableGeometryFieldType() {\n+    }\n+\n+    protected AbstractSearchableGeometryFieldType(AbstractSearchableGeometryFieldType ref) {\n+        super(ref);\n+    }\n+\n+    public void setGeometryQueryBuilder(AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder)  {\n+        this.geometryQueryBuilder = geometryQueryBuilder;\n+    }\n+\n+    public AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder() {", "originalCommit": "6358862b0d8e12ecf6af59be7a065b12e9c72b2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3NjQ4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392576487", "bodyText": "@iverase done", "author": "djptek", "createdAt": "2020-03-14T10:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2OTE3Ng=="}], "type": "inlineReview"}, {"oid": "01548bb8db6184a9af8776e2a244c8726f958946", "url": "https://github.com/elastic/elasticsearch/commit/01548bb8db6184a9af8776e2a244c8726f958946", "message": "move AbstractGeometryFieldMapper.QueryProcessor to AbstractSearchableGeometryFieldType", "committedDate": "2020-03-14T10:58:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwOTg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393809866", "bodyText": "I think we should we add testing for GeometryCollection. But I'm okay with it coming in a separate PR.", "author": "nknize", "createdAt": "2020-03-17T16:29:48Z", "path": "server/src/test/java/org/elasticsearch/index/query/GeoShapeQueryBuilderGeoPointTests.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.index.query;\n+\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.ShapeBuilder;\n+import org.elasticsearch.test.geo.RandomShapeGenerator;\n+\n+public class GeoShapeQueryBuilderGeoPointTests extends GeoShapeQueryBuilderTests {\n+\n+    protected String fieldName() {\n+        return GEO_POINT_FIELD_NAME;\n+    }\n+\n+    protected GeoShapeQueryBuilder doCreateTestQueryBuilder(boolean indexedShape) {\n+        RandomShapeGenerator.ShapeType shapeType = RandomShapeGenerator.ShapeType.POLYGON;", "originalCommit": "01548bb8db6184a9af8776e2a244c8726f958946", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMDI5OA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393810298", "bodyText": "Lets add support here for GeometryCollection as well (separate PR is fine).", "author": "nknize", "createdAt": "2020-03-17T16:30:24Z", "path": "server/src/test/java/org/elasticsearch/index/query/GeoShapeQueryBuilderGeoShapeTests.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.index.query;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.ShapeBuilder;\n+import org.elasticsearch.test.geo.RandomShapeGenerator;\n+\n+public class GeoShapeQueryBuilderGeoShapeTests extends GeoShapeQueryBuilderTests {\n+\n+    protected String fieldName() {\n+        return GEO_SHAPE_FIELD_NAME;\n+    }\n+\n+    protected GeoShapeQueryBuilder doCreateTestQueryBuilder(boolean indexedShape) {\n+        RandomShapeGenerator.ShapeType shapeType = randomFrom(\n+            RandomShapeGenerator.ShapeType.POINT,", "originalCommit": "01548bb8db6184a9af8776e2a244c8726f958946", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMTIyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393811223", "bodyText": "Same: lets add testing for GeometryCollection.", "author": "nknize", "createdAt": "2020-03-17T16:31:48Z", "path": "server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java", "diffHunk": "@@ -19,23 +19,158 @@\n \n package org.elasticsearch.search.geo;\n \n+import org.elasticsearch.action.search.SearchAction;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.SearchRequestBuilder;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.CoordinatesBuilder;\n+import org.elasticsearch.common.geo.builders.LineStringBuilder;\n+import org.elasticsearch.common.geo.builders.MultiLineStringBuilder;\n+import org.elasticsearch.common.geo.builders.MultiPointBuilder;\n+import org.elasticsearch.common.geo.builders.PointBuilder;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.geometry.Line;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.query.GeoShapeQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+\n+import static org.hamcrest.Matchers.containsString;\n \n public class GeoPointShapeQueryTests extends GeoQueryTests {", "originalCommit": "01548bb8db6184a9af8776e2a244c8726f958946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg2MzA3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393863071", "bodyText": "Opened & self-assigned issue #53686", "author": "djptek", "createdAt": "2020-03-17T17:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMTIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzU2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393813563", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (validContentTypes().contains(fieldType.typeName()) == false) {\n          \n          \n            \n                    List<String> validContentTypes = validContentTypes()\n          \n          \n            \n                    if (validContentTypes.contains(fieldType.typeName()) == false) {", "author": "nknize", "createdAt": "2020-03-17T16:35:21Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (validContentTypes().contains(fieldType.typeName()) == false) {", "originalCommit": "01548bb8db6184a9af8776e2a244c8726f958946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxNTc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393815755", "bodyText": "I was afraid of this danger biting us. I'm not much a fan of validContentTypes() returning a new List instance for every call. So maybe we should consider making a static variable within each of the derived builders (that only calls this method once)? I'm okay changing that in a follow up PR, but lets change this method now to only call validContentTypes once.", "author": "nknize", "createdAt": "2020-03-17T16:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393813888", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes())\n          \n          \n            \n                            \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes)", "author": "nknize", "createdAt": "2020-03-17T16:35:52Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (validContentTypes().contains(fieldType.typeName()) == false) {\n             throw new QueryShardException(context,\n-                \"Field [\" + fieldName + \"] is not of type [\" + queryFieldType() + \"] but of type [\" + fieldType.typeName() + \"]\");\n+                \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes())", "originalCommit": "01548bb8db6184a9af8776e2a244c8726f958946", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1acc0f09d9d8f680fa67f7398ac0f8d1bce57998", "url": "https://github.com/elastic/elasticsearch/commit/1acc0f09d9d8f680fa67f7398ac0f8d1bce57998", "message": "use static to avoid (re-)creating lists", "committedDate": "2020-03-17T17:41:49Z", "type": "commit"}, {"oid": "15f8497c647e632a92081531bd452bcb2cdf90b5", "url": "https://github.com/elastic/elasticsearch/commit/15f8497c647e632a92081531bd452bcb2cdf90b5", "message": "add reference to shapes NOT supported for geo_shape query vs geo_point fields", "committedDate": "2020-03-17T17:42:37Z", "type": "commit"}, {"oid": "833ac0d13f19b60a6bfc1a3e1d7eeb51d9cab94b", "url": "https://github.com/elastic/elasticsearch/commit/833ac0d13f19b60a6bfc1a3e1d7eeb51d9cab94b", "message": "Update x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java\n\nCo-Authored-By: Nick Knize <nknize@gmail.com>", "committedDate": "2020-03-17T17:52:15Z", "type": "commit"}, {"oid": "2facb66286bd942ec9b34cf9d40c71c102f9f2c9", "url": "https://github.com/elastic/elasticsearch/commit/2facb66286bd942ec9b34cf9d40c71c102f9f2c9", "message": "+; ;-)", "committedDate": "2020-03-17T17:57:38Z", "type": "commit"}, {"oid": "5df014a6d4d29d850d986b93588be346260684c8", "url": "https://github.com/elastic/elasticsearch/commit/5df014a6d4d29d850d986b93588be346260684c8", "message": "merge upstream", "committedDate": "2020-03-17T19:37:25Z", "type": "commit"}, {"oid": "8f3f90bbf06c61a0c91e4df64a7a7bc02484191a", "url": "https://github.com/elastic/elasticsearch/commit/8f3f90bbf06c61a0c91e4df64a7a7bc02484191a", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-17T19:37:56Z", "type": "commit"}, {"oid": "e986c92c0557c0df10330e6a5b3e8c7c5e9b7c05", "url": "https://github.com/elastic/elasticsearch/commit/e986c92c0557c0df10330e6a5b3e8c7c5e9b7c05", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-17T20:11:34Z", "type": "commit"}, {"oid": "a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "url": "https://github.com/elastic/elasticsearch/commit/a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-15T18:05:23Z", "type": "commit"}, {"oid": "478cee77cd823009bf0f7ac7a622e09ca3efc35f", "url": "https://github.com/elastic/elasticsearch/commit/478cee77cd823009bf0f7ac7a622e09ca3efc35f", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-18T17:17:59Z", "type": "commit"}, {"oid": "ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "url": "https://github.com/elastic/elasticsearch/commit/ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-19T12:34:44Z", "type": "commit"}, {"oid": "5d3c189b8cdaf9d644af94399d15e6207a19594d", "url": "https://github.com/elastic/elasticsearch/commit/5d3c189b8cdaf9d644af94399d15e6207a19594d", "message": "WIP writing GeoPointShapeQueryTests.java", "committedDate": "2019-11-19T19:58:13Z", "type": "commit"}, {"oid": "ab60f0679b0837885dde114f8870e6484ba4077d", "url": "https://github.com/elastic/elasticsearch/commit/ab60f0679b0837885dde114f8870e6484ba4077d", "message": "Added Failing Test testIndexPointsFilterRectangle\n in Class org.elasticsearch.search.geo.GeoPointShapeQueryTests", "committedDate": "2019-11-20T19:07:45Z", "type": "commit"}, {"oid": "c22308fa23135907331c969f1f16459789b0eccd", "url": "https://github.com/elastic/elasticsearch/commit/c22308fa23135907331c969f1f16459789b0eccd", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2019-11-20T19:20:10Z", "type": "commit"}, {"oid": "443441c728982862c9cf5112afc231ea6f9683e8", "url": "https://github.com/elastic/elasticsearch/commit/443441c728982862c9cf5112afc231ea6f9683e8", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2019-11-21T20:16:16Z", "type": "commit"}, {"oid": "24b95358fca9a5b1f266651ac507fe17115a5e35", "url": "https://github.com/elastic/elasticsearch/commit/24b95358fca9a5b1f266651ac507fe17115a5e35", "message": "permit GeoShapeQueryBuilder to accept a geo_point -> class_cast_exception raised, see org.elasticsearch.index.query.QueryShardContext.toQuery", "committedDate": "2019-11-23T19:40:19Z", "type": "commit"}, {"oid": "59c1bfcd37b42af01746e17c7a55a1557142aac1", "url": "https://github.com/elastic/elasticsearch/commit/59c1bfcd37b42af01746e17c7a55a1557142aac1", "message": "added @Override protected XContentBuilder createMapping\nin GeoPointShapeQueryTests", "committedDate": "2019-12-02T18:03:56Z", "type": "commit"}, {"oid": "192ad15e5e73a57e8b909360130fb14c8ca458c4", "url": "https://github.com/elastic/elasticsearch/commit/192ad15e5e73a57e8b909360130fb14c8ca458c4", "message": "merged upstream including 418edc6 types fixes", "committedDate": "2020-01-07T08:59:26Z", "type": "commit"}, {"oid": "ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "url": "https://github.com/elastic/elasticsearch/commit/ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "message": "repeat refactor post type removal and remove remaining types from GeoShapeQueryTests.java", "committedDate": "2020-01-07T15:26:12Z", "type": "commit"}, {"oid": "0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "url": "https://github.com/elastic/elasticsearch/commit/0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "message": "tidy GeoPointShapeQueryTests.java", "committedDate": "2020-01-07T15:27:59Z", "type": "commit"}, {"oid": "6d68e7febd1033882c125def51cc604e8ecaeac1", "url": "https://github.com/elastic/elasticsearch/commit/6d68e7febd1033882c125def51cc604e8ecaeac1", "message": "interim checkin, still failing tests", "committedDate": "2020-01-08T10:06:11Z", "type": "commit"}, {"oid": "2d880c260540139a356be59d161d99436ac9070a", "url": "https://github.com/elastic/elasticsearch/commit/2d880c260540139a356be59d161d99436ac9070a", "message": "GeoShapeQueryTests.java passing tests", "committedDate": "2020-01-08T11:11:41Z", "type": "commit"}, {"oid": "e275f3eb0a771fd11aa967b4d7653f7f64276a87", "url": "https://github.com/elastic/elasticsearch/commit/e275f3eb0a771fd11aa967b4d7653f7f64276a87", "message": "GeoShapeQueryTests.java extends GeoQueryTests", "committedDate": "2020-01-08T11:21:19Z", "type": "commit"}, {"oid": "316c7b18e843fef85c668aaf3aefdb69d9909b17", "url": "https://github.com/elastic/elasticsearch/commit/316c7b18e843fef85c668aaf3aefdb69d9909b17", "message": "refactored + tests passing", "committedDate": "2020-01-08T11:35:58Z", "type": "commit"}, {"oid": "e7e5e7b86c853314445938090fc4782fbd58b45e", "url": "https://github.com/elastic/elasticsearch/commit/e7e5e7b86c853314445938090fc4782fbd58b45e", "message": "refactored + tests passing", "committedDate": "2020-01-08T11:43:10Z", "type": "commit"}, {"oid": "d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "url": "https://github.com/elastic/elasticsearch/commit/d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "message": "reset GeoShapeQueryBuilder.java for future PR", "committedDate": "2020-01-08T11:58:43Z", "type": "commit"}, {"oid": "e54c867b82cebac4bf144ccdf2a1c45961f509e9", "url": "https://github.com/elastic/elasticsearch/commit/e54c867b82cebac4bf144ccdf2a1c45961f509e9", "message": "improved refactoring see: https://github.com/elastic/elasticsearch/pull/50737#pullrequestreview-340443408", "committedDate": "2020-01-09T18:29:03Z", "type": "commit"}, {"oid": "9025578d4fb3b94aefb2b37671e699abff1df3f8", "url": "https://github.com/elastic/elasticsearch/commit/9025578d4fb3b94aefb2b37671e699abff1df3f8", "message": "refactor", "committedDate": "2020-01-14T14:03:34Z", "type": "commit"}, {"oid": "13e8b00752d45d9290cb8f2d715cf8702a582f94", "url": "https://github.com/elastic/elasticsearch/commit/13e8b00752d45d9290cb8f2d715cf8702a582f94", "message": "Merge branch 'djptek-geo-shape-query-vs-geo-point'\n\nGeoShapeQueryTests refactored adding superclass and sibling to accomodate new test coverage as part of adaptation of geo_shape query to work on geo_point fields", "committedDate": "2020-01-24T13:31:26Z", "type": "commit"}, {"oid": "83504d1866b1ab048cfd8ac1967e63586f964ec5", "url": "https://github.com/elastic/elasticsearch/commit/83504d1866b1ab048cfd8ac1967e63586f964ec5", "message": "merged refactor changes to upstream", "committedDate": "2020-01-24T15:16:45Z", "type": "commit"}, {"oid": "4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "url": "https://github.com/elastic/elasticsearch/commit/4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "message": "rectified Checkstyle rule violations", "committedDate": "2020-01-24T15:58:12Z", "type": "commit"}, {"oid": "322db3fbe2bf01174bc9a4ba5182e63edb87ec0f", "url": "https://github.com/elastic/elasticsearch/commit/322db3fbe2bf01174bc9a4ba5182e63edb87ec0f", "message": "merge to upstream", "committedDate": "2020-01-31T16:54:54Z", "type": "commit"}, {"oid": "fa64b522092f30e49b5be39b644c798205e585dc", "url": "https://github.com/elastic/elasticsearch/commit/fa64b522092f30e49b5be39b644c798205e585dc", "message": "add @iverase patch with thanks", "committedDate": "2020-02-12T13:32:39Z", "type": "commit"}, {"oid": "ca4ef1acf1af620de255f441ed57e05eb80aea32", "url": "https://github.com/elastic/elasticsearch/commit/ca4ef1acf1af620de255f441ed57e05eb80aea32", "message": "tidied patch, added geo_shape vs circle test and implmented visitor", "committedDate": "2020-02-12T17:29:32Z", "type": "commit"}, {"oid": "4683d5b38cee3ae84a75edfdfb6c8e35fff92b5a", "url": "https://github.com/elastic/elasticsearch/commit/4683d5b38cee3ae84a75edfdfb6c8e35fff92b5a", "message": "added tests, all OK EXCEPT testQueryLinearRing()", "committedDate": "2020-02-13T18:26:07Z", "type": "commit"}, {"oid": "09ac81863a357fdc855dfb44feaf4270a06692c0", "url": "https://github.com/elastic/elasticsearch/commit/09ac81863a357fdc855dfb44feaf4270a06692c0", "message": "LinearRing test OK", "committedDate": "2020-02-14T17:13:27Z", "type": "commit"}, {"oid": "364d9f80ff50f217e3dcdd3ee0cba333512fb95e", "url": "https://github.com/elastic/elasticsearch/commit/364d9f80ff50f217e3dcdd3ee0cba333512fb95e", "message": "document geo_shape vs geo_point", "committedDate": "2020-02-14T19:13:03Z", "type": "commit"}, {"oid": "d77f793026f88e2fb1a621b8abe6a5ab275165fd", "url": "https://github.com/elastic/elasticsearch/commit/d77f793026f88e2fb1a621b8abe6a5ab275165fd", "message": "fix unused imports", "committedDate": "2020-02-14T19:26:07Z", "type": "commit"}, {"oid": "cb0a526b96cd0879f8996c405378dd42f7d56339", "url": "https://github.com/elastic/elasticsearch/commit/cb0a526b96cd0879f8996c405378dd42f7d56339", "message": "Merge branch 'master' of https://github.com/djptek/elasticsearch", "committedDate": "2020-02-14T19:31:58Z", "type": "commit"}, {"oid": "77c866405a2056581bfc0ff62fbf7bedbb31e6d3", "url": "https://github.com/elastic/elasticsearch/commit/77c866405a2056581bfc0ff62fbf7bedbb31e6d3", "message": "fixed marge", "committedDate": "2020-02-14T19:46:02Z", "type": "commit"}, {"oid": "3577ca2cbcc9a63d3b8137e6fae0d61a7f4137b2", "url": "https://github.com/elastic/elasticsearch/commit/3577ca2cbcc9a63d3b8137e6fae0d61a7f4137b2", "message": "fix imports", "committedDate": "2020-02-14T20:46:53Z", "type": "commit"}, {"oid": "5bb9f9a92ceb8bbe0253a49a88282f1a7431e40c", "url": "https://github.com/elastic/elasticsearch/commit/5bb9f9a92ceb8bbe0253a49a88282f1a7431e40c", "message": "fix docs reference", "committedDate": "2020-02-14T20:56:12Z", "type": "commit"}, {"oid": "0753166fd0935995107637b994b5f0eba9183cd4", "url": "https://github.com/elastic/elasticsearch/commit/0753166fd0935995107637b994b5f0eba9183cd4", "message": "fix unused import", "committedDate": "2020-02-14T21:29:34Z", "type": "commit"}, {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff", "url": "https://github.com/elastic/elasticsearch/commit/a81c7c195325da4c3d2d1ae7028034998ab071ff", "message": "fix failing test 1/2", "committedDate": "2020-02-15T10:53:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922452", "bodyText": "I think this is wrong. GeoShapeIndexer works on geo_shape fields and CIRCLE is not a supported geometry for indexing.", "author": "iverase", "createdAt": "2020-02-16T18:17:47Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/GeoShapeIndexer.java", "diffHunk": "@@ -79,7 +79,10 @@ public Geometry prepareForIndexing(Geometry geometry) {\n         return geometry.visit(new GeometryVisitor<>() {\n             @Override\n             public Geometry visit(Circle circle) {\n-                throw new UnsupportedOperationException(\"CIRCLE geometry is not supported\");\n+                double[] latlon = new double[]{circle.getX(), circle.getY()};\n+                normalizePoint(latlon);\n+                double radius = circle.getRadiusMeters();\n+                return new Circle(latlon[0], latlon[1], radius);", "originalCommit": "a81c7c195325da4c3d2d1ae7028034998ab071ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyNjg0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380126842", "bodyText": "Sorry, I had misunderstood that, I've rolled back the change", "author": "djptek", "createdAt": "2020-02-17T11:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0MjA2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380142060", "bodyText": "I understand now why you did this. I think we need to find a different solution, for example we should not be calling this class before creating the geo_shape query but another processor. Note that this processor is in charge for example in break a polygon when it crosses the dateline.", "author": "iverase", "createdAt": "2020-02-17T12:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMTM5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380231392", "bodyText": "I opened a PR to help this implementation", "author": "iverase", "createdAt": "2020-02-17T15:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI1OTAzMg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r381259032", "bodyText": "PR Merged", "author": "djptek", "createdAt": "2020-02-19T12:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922567", "bodyText": "We cannot hardcode those values. This method is called for geo_shape and shape queries, therefore we use queryFieldType() to get the underlaying fields. I think the solution here is to change the signature of queryFieldType() method to return an arrays of fields.", "author": "iverase", "createdAt": "2020-02-16T18:19:31Z", "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -197,9 +198,13 @@ protected GeoShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<G\n \n     @Override\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false &&\n+            fieldType.typeName().equals(GeoPointFieldMapper.CONTENT_TYPE) == false) {\n             throw new QueryShardException(context,\n-                \"Field [\" + fieldName + \"] is not of type [\" + queryFieldType() + \"] but of type [\" + fieldType.typeName() + \"]\");\n+                \"Field [\" + fieldName + \"] is of unsupported type [\" + fieldType.typeName() + \"]. [\"\n+                + NAME + \"] query supports the following types [\"\n+                + GeoShapeFieldMapper.CONTENT_TYPE + \", \"\n+                + GeoPointFieldMapper.CONTENT_TYPE + \"]\");", "originalCommit": "a81c7c195325da4c3d2d1ae7028034998ab071ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MTc2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380151760", "bodyText": "Agree, there is already List validContentTypes() so I have encapsulated the supported types there to avoid doing anything drastic with Reflection. queryFieldType is essentially redundant, so I changed the signature to List, pointed this to ValidContentTypes() and then deprecated.", "author": "djptek", "createdAt": "2020-02-17T12:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922697", "bodyText": "geo_shape queries over geo_shape fields do not support circle queries. It should be an error.", "author": "iverase", "createdAt": "2020-02-16T18:20:48Z", "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoShapeQueryProcessor.java", "diffHunk": "@@ -86,7 +87,9 @@ protected Query getVectorQueryFromShape(Geometry queryShape, String fieldName, S\n \n         @Override\n         public Query visit(Circle circle) {\n-            throw new QueryShardException(context, \"Field [\" + fieldName + \"] found and unknown shape Circle\");\n+            // use Point visitor", "originalCommit": "a81c7c195325da4c3d2d1ae7028034998ab071ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1NTA4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380155088", "bodyText": "Sorry, I had misunderstood that, I've rolled back the change", "author": "djptek", "createdAt": "2020-02-17T12:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjY5Nw=="}], "type": "inlineReview"}, {"oid": "0d2f25bdd08588a7a7b67613b032610168d03d30", "url": "https://github.com/elastic/elasticsearch/commit/0d2f25bdd08588a7a7b67613b032610168d03d30", "message": "Update GeoShapeIndexer.java\n\nrollback Circle Visitor, this is not supported", "committedDate": "2020-02-17T11:22:28Z", "type": "commit"}, {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "url": "https://github.com/elastic/elasticsearch/commit/8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "message": "removed CIRCLE", "committedDate": "2020-02-17T13:34:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MDI4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380240285", "bodyText": "+1", "author": "iverase", "createdAt": "2020-02-17T15:19:12Z", "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -169,12 +170,13 @@ public SpatialStrategy strategy() {\n \n     @Override\n     protected List validContentTypes() {\n-        return Arrays.asList(GeoShapeFieldMapper.CONTENT_TYPE);\n+        return Arrays.asList(GeoShapeFieldMapper.CONTENT_TYPE, GeoPointFieldMapper.CONTENT_TYPE);", "originalCommit": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MTY5NA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380241694", "bodyText": "You cannot change the signature of the method and deprecate it. In any case I think this an internal API so we probably can just remove the method all together (I will check).", "author": "iverase", "createdAt": "2020-02-17T15:21:55Z", "path": "server/src/main/java/org/elasticsearch/index/query/AbstractGeometryQueryBuilder.java", "diffHunk": "@@ -341,7 +341,8 @@ public boolean ignoreUnmapped() {\n     /** builds the appropriate lucene shape query */\n     protected abstract Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType);\n     /** returns expected content type for this query */\n-    protected abstract String queryFieldType();\n+    @Deprecated\n+    protected abstract List queryFieldType();", "originalCommit": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0OTUzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380249539", "bodyText": "It is only used in the place where I have replaced it so I will remove for simplicity", "author": "djptek", "createdAt": "2020-02-17T15:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI1NTExNg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380255116", "bodyText": "It used used as well in the XPack spatial module, you need to reflect these changes there as well.", "author": "iverase", "createdAt": "2020-02-17T15:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MTY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM3NDQ3MA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380374470", "bodyText": "Thanks, that's fixed now, I hadn't grepped through X-Pack", "author": "djptek", "createdAt": "2020-02-17T21:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MTY5NA=="}], "type": "inlineReview"}, {"oid": "71617b58c2289639788e31a1f7e25618451b4a87", "url": "https://github.com/elastic/elasticsearch/commit/71617b58c2289639788e31a1f7e25618451b4a87", "message": "List validContentTypes() populated and tests updated", "committedDate": "2020-02-17T15:31:33Z", "type": "commit"}, {"oid": "3706e85e0f5c9af5c22a7fb9f80a82cd5ab3f0d6", "url": "https://github.com/elastic/elasticsearch/commit/3706e85e0f5c9af5c22a7fb9f80a82cd5ab3f0d6", "message": "removal of String queryFieldType()", "committedDate": "2020-02-17T15:48:58Z", "type": "commit"}, {"oid": "dc0f943d1968fbcc2e3144f8da48de5c428a651e", "url": "https://github.com/elastic/elasticsearch/commit/dc0f943d1968fbcc2e3144f8da48de5c428a651e", "message": "fix testIgnoreUnmapped()", "committedDate": "2020-02-17T15:59:16Z", "type": "commit"}, {"oid": "73ca89d2ae495abc0aa1df3011388e902ce68118", "url": "https://github.com/elastic/elasticsearch/commit/73ca89d2ae495abc0aa1df3011388e902ce68118", "message": "back out docs changes and synch xpack", "committedDate": "2020-02-17T22:25:50Z", "type": "commit"}, {"oid": "f1569db7dcb1a9ce7fdf67afd163295ad8fb2ecd", "url": "https://github.com/elastic/elasticsearch/commit/f1569db7dcb1a9ce7fdf67afd163295ad8fb2ecd", "message": "fix xpack compile issue", "committedDate": "2020-02-18T12:14:03Z", "type": "commit"}, {"oid": "8094a4a2d200290d46bc8b6644df017f9600e562", "url": "https://github.com/elastic/elasticsearch/commit/8094a4a2d200290d46bc8b6644df017f9600e562", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-02-19T10:57:33Z", "type": "commit"}, {"oid": "df876736951b2f2548d45a2277ba937a14b9d92b", "url": "https://github.com/elastic/elasticsearch/commit/df876736951b2f2548d45a2277ba937a14b9d92b", "message": "merge 30316d6d6409a359431d47094c497c482118a226", "committedDate": "2020-02-19T11:14:33Z", "type": "commit"}, {"oid": "22a6b2f275644fea15ed46b5cc9d517f47dfc7fb", "url": "https://github.com/elastic/elasticsearch/commit/22a6b2f275644fea15ed46b5cc9d517f47dfc7fb", "message": " remove unused imports", "committedDate": "2020-02-19T13:32:09Z", "type": "commit"}, {"oid": "322290a72e7ac8f4cf6b3f4537f7638a4372aff6", "url": "https://github.com/elastic/elasticsearch/commit/322290a72e7ac8f4cf6b3f4537f7638a4372aff6", "message": "rollback geo-shape-query.asciidoc", "committedDate": "2020-02-19T16:32:31Z", "type": "commit"}, {"oid": "b2789356ae320b7978efac38ac3bda793c461c37", "url": "https://github.com/elastic/elasticsearch/commit/b2789356ae320b7978efac38ac3bda793c461c37", "message": "remove unused import", "committedDate": "2020-02-19T16:41:35Z", "type": "commit"}, {"oid": "43be178ef3b4cf275c030bab3140ed7aab3f4e4b", "url": "https://github.com/elastic/elasticsearch/commit/43be178ef3b4cf275c030bab3140ed7aab3f4e4b", "message": "restore xpack...ShapeQueryBuilder.validContentTypes to shape", "committedDate": "2020-02-19T21:25:19Z", "type": "commit"}, {"oid": "8d8ac102265476f9558876ed210e785f96b92046", "url": "https://github.com/elastic/elasticsearch/commit/8d8ac102265476f9558876ed210e785f96b92046", "message": "remove unused imports", "committedDate": "2020-02-19T21:58:42Z", "type": "commit"}, {"oid": "ca122121ddadfeacc722f7aff7c77655d9544112", "url": "https://github.com/elastic/elasticsearch/commit/ca122121ddadfeacc722f7aff7c77655d9544112", "message": "restore missing import", "committedDate": "2020-02-19T22:07:08Z", "type": "commit"}, {"oid": "f555309de00e37f1f9b93a765eb59d55fc160434", "url": "https://github.com/elastic/elasticsearch/commit/f555309de00e37f1f9b93a765eb59d55fc160434", "message": "include geo_point in geo-shape-query docs", "committedDate": "2020-02-20T07:52:45Z", "type": "commit"}, {"oid": "13afa49d20edaab2a411d1f47297b9eb8e6080eb", "url": "https://github.com/elastic/elasticsearch/commit/13afa49d20edaab2a411d1f47297b9eb8e6080eb", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-02-20T08:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxMzMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r382013339", "bodyText": "We should not be using here the GeoShapeIndexer. Instead we should be calling the GeoPolygon decomposer in the visitor.", "author": "iverase", "createdAt": "2020-02-20T13:57:20Z", "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.geo.Polygon;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.GeoShapeIndexer;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        GeoShapeIndexer geometryIndexer = new GeoShapeIndexer(true, fieldName);", "originalCommit": "13afa49d20edaab2a411d1f47297b9eb8e6080eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4OTg5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r382089891", "bodyText": "OK, I'm working on that", "author": "djptek", "createdAt": "2020-02-20T15:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxMzMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc4NDc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r384784797", "bodyText": "@iverase GeoShapeIndexer removed from method, now calling GeoPolygonDecomposer.decomposePolygon (for Polygon only)\n\n3 x tests added\n\nGeoShapeQueryTests.testPolygonSpanningDateline()\nGeoShapeQueryTests.testMultiPolygonSpanningDateline()\nGeoShapeQueryTests.testRectangleSpanningDateline()", "author": "djptek", "createdAt": "2020-02-26T21:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxMzMzOQ=="}], "type": "inlineReview"}, {"oid": "eaaaba83526487ff40733abc4619993799a9dffa", "url": "https://github.com/elastic/elasticsearch/commit/eaaaba83526487ff40733abc4619993799a9dffa", "message": "merge upstream", "committedDate": "2020-02-21T11:56:22Z", "type": "commit"}, {"oid": "50550b4f098fd13b9768ce2f4edd38d72de29a15", "url": "https://github.com/elastic/elasticsearch/commit/50550b4f098fd13b9768ce2f4edd38d72de29a15", "message": "update tests", "committedDate": "2020-02-21T12:08:28Z", "type": "commit"}, {"oid": "eff1b6f5fb61774bfb3607d7ba5e3cebc52d24a5", "url": "https://github.com/elastic/elasticsearch/commit/eff1b6f5fb61774bfb3607d7ba5e3cebc52d24a5", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-02-21T12:09:26Z", "type": "commit"}, {"oid": "1c68db61a5e7a158b0463f9d243e0e451af6872d", "url": "https://github.com/elastic/elasticsearch/commit/1c68db61a5e7a158b0463f9d243e0e451af6872d", "message": "remove the GeometryIndexer and call the Decomposers on the visitor", "committedDate": "2020-02-26T16:46:50Z", "type": "commit"}, {"oid": "6ce856b316468bf72a853ef807426690cc8bca5c", "url": "https://github.com/elastic/elasticsearch/commit/6ce856b316468bf72a853ef807426690cc8bca5c", "message": "fix imports", "committedDate": "2020-02-26T17:37:16Z", "type": "commit"}, {"oid": "8b713a125e7b293bc5ad3dca3bcf7a084bd59801", "url": "https://github.com/elastic/elasticsearch/commit/8b713a125e7b293bc5ad3dca3bcf7a084bd59801", "message": "added tests testPolygonSpanningDateline() testMultiPolygonSpanningDateline()", "committedDate": "2020-02-26T18:54:19Z", "type": "commit"}, {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "url": "https://github.com/elastic/elasticsearch/commit/83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "message": "added testRectangleSpanningDateline", "committedDate": "2020-02-26T20:34:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r384951726", "bodyText": "I think we should move this logic inside the visitor and decompose the polygons in the methods visit(MultiPolygon multiPolygon) and visit(Polygon polygon). Note that the query accepts an array and therefore the boolean query is not necessary.", "author": "iverase", "createdAt": "2020-02-27T07:28:14Z", "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoPolygonDecomposer;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Polygon;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import java.util.ArrayList;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        ShapeVisitor shapeVisitor = new ShapeVisitor(context, fieldName, relation);\n+        if (queryShape.type().equals(ShapeType.POLYGON)) {\n+            ArrayList<org.elasticsearch.geometry.Polygon> collector = new ArrayList<>();", "originalCommit": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NTU0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385265547", "bodyText": "I removed GeoPolygonDecomposer.decomposePolygon() prior to pushing this down & tests passed OK where I had expected a fail.  I added an additional point to GeoShapeQueryTests.testPolygonSpanningDateline() to validate that a polygon spanning the dateline matched intersecting documents on both sides and did not match non-intersecting documents on both sides - the test is currently passing without decomposePolygon() , I'm looking into how and why", "author": "djptek", "createdAt": "2020-02-27T17:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NTA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385295058", "bodyText": "I guess it is because the method lives in GeoShapeQueryTests so it is only testing geo_shape field. Try to move it down to geoQueryTests (you might need to change the way you are indexing the points)", "author": "iverase", "createdAt": "2020-02-27T18:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYwMjY4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385602682", "bodyText": "Tests were in GeoShapeGeoShape, I've pushed up, working on the refactor now", "author": "djptek", "createdAt": "2020-02-28T09:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg3MTY0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385871646", "bodyText": "Done - by the way, in VectorGeoPointShapeQueryProcessor.ShapeVisitor the methods\nvisit(MultiPolygon multiPolygon)\nvisit(Polygon polygon)\nare both using (successfully)\norg.apache.lucene.geo.Polygon\nThis is the right level to introduce the Lucene classes, correct?", "author": "djptek", "createdAt": "2020-02-28T19:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MjI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385042286", "bodyText": "For readability we prefer == false rather than !", "author": "iverase", "createdAt": "2020-02-27T10:35:09Z", "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -197,9 +193,11 @@ protected GeoShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<G\n \n     @Override\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (!validContentTypes().contains(fieldType.typeName())) {", "originalCommit": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIwNDY0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385204647", "bodyText": "OK, done", "author": "djptek", "createdAt": "2020-02-27T16:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MjI4Ng=="}], "type": "inlineReview"}, {"oid": "798a16f9911f8e943d3a74dfa8af0164115a517c", "url": "https://github.com/elastic/elasticsearch/commit/798a16f9911f8e943d3a74dfa8af0164115a517c", "message": "change != to == false", "committedDate": "2020-02-27T16:14:02Z", "type": "commit"}, {"oid": "fc609787df1ce3eec2f9cece66220ccf813b631d", "url": "https://github.com/elastic/elasticsearch/commit/fc609787df1ce3eec2f9cece66220ccf813b631d", "message": "commented out Decompose, tests passing, hardened tests, still passing", "committedDate": "2020-02-27T17:30:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYxMjIzNg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385612236", "bodyText": "== false", "author": "iverase", "createdAt": "2020-02-28T10:14:36Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (!validContentTypes().contains(fieldType.typeName())) {", "originalCommit": "fc609787df1ce3eec2f9cece66220ccf813b631d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYzMzAwNg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385633006", "bodyText": "Done", "author": "djptek", "createdAt": "2020-02-28T10:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYxMjIzNg=="}], "type": "inlineReview"}, {"oid": "783276af7a1b034d45781589696579a9464ddf55", "url": "https://github.com/elastic/elasticsearch/commit/783276af7a1b034d45781589696579a9464ddf55", "message": "refactor tests, testMultiPolygonSpanningDateline() now failing", "committedDate": "2020-02-28T10:56:15Z", "type": "commit"}, {"oid": "f084f7299800c791862a5031550b7b6dea4c0ca5", "url": "https://github.com/elastic/elasticsearch/commit/f084f7299800c791862a5031550b7b6dea4c0ca5", "message": "ShapeQueryBuilder change ! to == false", "committedDate": "2020-02-28T10:58:24Z", "type": "commit"}, {"oid": "cb44b3b9ff02c93b57152a6c42c99631a22f0679", "url": "https://github.com/elastic/elasticsearch/commit/cb44b3b9ff02c93b57152a6c42c99631a22f0679", "message": "tests still failing", "committedDate": "2020-02-28T12:25:30Z", "type": "commit"}, {"oid": "57faaed2d21e5f23e9b8cef14a571e95398270be", "url": "https://github.com/elastic/elasticsearch/commit/57faaed2d21e5f23e9b8cef14a571e95398270be", "message": "working, pending refactor", "committedDate": "2020-02-28T18:41:07Z", "type": "commit"}, {"oid": "9b9a33e3999a7085843fede5aa79c5d534d39479", "url": "https://github.com/elastic/elasticsearch/commit/9b9a33e3999a7085843fede5aa79c5d534d39479", "message": "fixed imports etc.", "committedDate": "2020-02-28T19:03:23Z", "type": "commit"}, {"oid": "99be3be2542c19bbcdcf8c35552e379a28c35bc0", "url": "https://github.com/elastic/elasticsearch/commit/99be3be2542c19bbcdcf8c35552e379a28c35bc0", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-02-29T08:11:16Z", "type": "commit"}, {"oid": "b98a6a9d300613cdcb184ac6be1d2eca488b24be", "url": "https://github.com/elastic/elasticsearch/commit/b98a6a9d300613cdcb184ac6be1d2eca488b24be", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-02-29T08:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNDM0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386014347", "bodyText": "The second loop is not necessary. You can just create one collector and pass the same array to the decomposer.", "author": "iverase", "createdAt": "2020-02-29T09:09:50Z", "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoPolygonDecomposer;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import java.util.ArrayList;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        ShapeVisitor shapeVisitor = new ShapeVisitor(context, fieldName, relation);\n+        return queryShape.visit(shapeVisitor);\n+    }\n+\n+    private class ShapeVisitor implements GeometryVisitor<Query, RuntimeException> {\n+        QueryShardContext context;\n+        MappedFieldType fieldType;\n+        String fieldName;\n+        ShapeRelation relation;\n+\n+        ShapeVisitor(QueryShardContext context, String fieldName, ShapeRelation relation) {\n+            this.context = context;\n+            this.fieldType = context.fieldMapper(fieldName);\n+            this.fieldName = fieldName;\n+            this.relation = relation;\n+        }\n+\n+        @Override\n+        public Query visit(Circle circle) {\n+            return LatLonPoint.newDistanceQuery(fieldName, circle.getLat(), circle.getLon(), circle.getRadiusMeters());\n+        }\n+\n+        @Override\n+        public Query visit(GeometryCollection<?> collection) {\n+            BooleanQuery.Builder bqb = new BooleanQuery.Builder();\n+            visit(bqb, collection);\n+            return bqb.build();\n+        }\n+\n+        private void visit(BooleanQuery.Builder bqb, GeometryCollection<?> collection) {\n+            BooleanClause.Occur occur = BooleanClause.Occur.FILTER;\n+            for (Geometry shape : collection) {\n+                bqb.add(shape.visit(this), occur);\n+            }\n+        }\n+\n+        @Override\n+        public Query visit(org.elasticsearch.geometry.Line line) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.LINESTRING + \" queries\");\n+        }\n+\n+        @Override\n+        // don't think this is called directly\n+        public Query visit(LinearRing ring) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + ShapeType.LINEARRING + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiLine multiLine) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.MULTILINESTRING + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiPoint multiPoint) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.MULTIPOINT + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiPolygon multiPolygon) {\n+            ArrayList<org.apache.lucene.geo.Polygon> polygonArrayList = new ArrayList<>();\n+            for (int i = 0; i < multiPolygon.size(); i++) {\n+                ArrayList<org.elasticsearch.geometry.Polygon> collector = new ArrayList<>();", "originalCommit": "b98a6a9d300613cdcb184ac6be1d2eca488b24be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNjYyMg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386016622", "bodyText": "I took a look inside the decomposer and saw that could work - my concern was that a future modification to the decomposer could potentially modify rather than append to the collector. I've moved the second loop out to unpack the collector to an array via toLucenePolygon()", "author": "djptek", "createdAt": "2020-02-29T09:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNDM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzNTY4NA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386035684", "bodyText": "The idea to have a collector is that, you do not need to create many lists. Actually I think the decomposer has a method that accepts a Muti-polygon so even this loop is not necessary?", "author": "iverase", "createdAt": "2020-02-29T15:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNDM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2MDYzNA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386060634", "bodyText": "my bad, I hadn't seen that one, I've moved that to  GeoPolygonDecomposer.decomposeMultiPolygon", "author": "djptek", "createdAt": "2020-02-29T22:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNDM0Nw=="}], "type": "inlineReview"}, {"oid": "ed0000365ba6206d359334a7e70e8e49adfceb6f", "url": "https://github.com/elastic/elasticsearch/commit/ed0000365ba6206d359334a7e70e8e49adfceb6f", "message": "use single collector", "committedDate": "2020-02-29T09:43:17Z", "type": "commit"}, {"oid": "830635f97d1da476952eef96d3ff12809912d8e3", "url": "https://github.com/elastic/elasticsearch/commit/830635f97d1da476952eef96d3ff12809912d8e3", "message": "use single collector", "committedDate": "2020-02-29T09:49:54Z", "type": "commit"}, {"oid": "024175390fb0ca1a87c2bf271f94f1e9c4ca4366", "url": "https://github.com/elastic/elasticsearch/commit/024175390fb0ca1a87c2bf271f94f1e9c4ca4366", "message": "use GeoPolygonDecomposer.decomposeMultiPolygon", "committedDate": "2020-02-29T22:36:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI2NDczMg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386264732", "bodyText": "left over from merging?", "author": "iverase", "createdAt": "2020-03-02T09:00:22Z", "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoShapeQueryProcessor.java", "diffHunk": "@@ -1,4 +1,4 @@\n-/*\n+/*uto-merging server/src/main/java/org/elasticsearch/index/mapper/GeoPointFieldMapper.java", "originalCommit": "024175390fb0ca1a87c2bf271f94f1e9c4ca4366", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ5NDY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386494697", "bodyText": "fixed, thx", "author": "djptek", "createdAt": "2020-03-02T16:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI2NDczMg=="}], "type": "inlineReview"}, {"oid": "5807864a3a3e61f0aff8e9d3f18ece5c431a73e1", "url": "https://github.com/elastic/elasticsearch/commit/5807864a3a3e61f0aff8e9d3f18ece5c431a73e1", "message": "add GeoQueryTests.testIndexPointsIndexedRectangle()", "committedDate": "2020-03-02T11:44:40Z", "type": "commit"}, {"oid": "8ed8bfe372a5883718ff7e62a80408ba3c6103d2", "url": "https://github.com/elastic/elasticsearch/commit/8ed8bfe372a5883718ff7e62a80408ba3c6103d2", "message": "clean stray comment", "committedDate": "2020-03-02T14:59:55Z", "type": "commit"}, {"oid": "9391222d01b39221416210e52053ddc557971ead", "url": "https://github.com/elastic/elasticsearch/commit/9391222d01b39221416210e52053ddc557971ead", "message": "add docValues optimisation to visit(MultiPolygon multiPolygon) and visit(Polygon polygon)", "committedDate": "2020-03-02T17:49:30Z", "type": "commit"}, {"oid": "e21dcc843880c49081d4620856309c0dca4be76d", "url": "https://github.com/elastic/elasticsearch/commit/e21dcc843880c49081d4620856309c0dca4be76d", "message": "clarify imports to distinguish Polygon vs Lucene Polygon", "committedDate": "2020-03-02T17:55:30Z", "type": "commit"}, {"oid": "27f4101d159083b73bf5019b5acfa4fb2e7e988f", "url": "https://github.com/elastic/elasticsearch/commit/27f4101d159083b73bf5019b5acfa4fb2e7e988f", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-02T18:43:46Z", "type": "commit"}, {"oid": "6dfbc18a41d8e106e0be1ec2b755e13333a0f925", "url": "https://github.com/elastic/elasticsearch/commit/6dfbc18a41d8e106e0be1ec2b755e13333a0f925", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-02T18:46:48Z", "type": "commit"}, {"oid": "0932589aa82894821785ef0b3833efad63b24027", "url": "https://github.com/elastic/elasticsearch/commit/0932589aa82894821785ef0b3833efad63b24027", "message": "added dvQuery to visit(Rectangle) visit(Circle)", "committedDate": "2020-03-02T20:51:02Z", "type": "commit"}, {"oid": "291115644665a718ea0011979c9bd7f180de0893", "url": "https://github.com/elastic/elasticsearch/commit/291115644665a718ea0011979c9bd7f180de0893", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-02T21:28:22Z", "type": "commit"}, {"oid": "110f58fa5c5be62e0a99c57eb6bf9dc0c441f963", "url": "https://github.com/elastic/elasticsearch/commit/110f58fa5c5be62e0a99c57eb6bf9dc0c441f963", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-02T21:29:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r387200394", "bodyText": "That feels a bit awkward. I think that should go into  AbstractGeometryFieldMapper.AbstractGeometryFieldType if we need to clone it. I think the reason it is not cloned there already is that we override it always in setupFileds anyway. But cloning it in AbstractGeometryFieldType seems like a logical thing to do here.", "author": "imotov", "createdAt": "2020-03-03T18:09:29Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/GeoPointFieldMapper.java", "diffHunk": "@@ -213,12 +216,13 @@ protected void parseCreateField(ParseContext context, List<IndexableField> field\n         throw new UnsupportedOperationException(\"Parsing is implemented in parse(), this method should NEVER be called\");\n     }\n \n-    public static class GeoPointFieldType extends MappedFieldType {\n+    public static class GeoPointFieldType extends AbstractGeometryFieldMapper.AbstractGeometryFieldType<Geometry, Geometry> {\n         public GeoPointFieldType() {\n         }\n \n         GeoPointFieldType(GeoPointFieldType ref) {\n             super(ref);\n+            this.geometryQueryBuilder  = ref.geometryQueryBuilder;", "originalCommit": "110f58fa5c5be62e0a99c57eb6bf9dc0c441f963", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwNzgzMg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r387307832", "bodyText": "OK, on it", "author": "djptek", "createdAt": "2020-03-03T21:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5OTA4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r387799082", "bodyText": "still working on the refactor, if #53099 is a better alternative I'm fine to go with that", "author": "djptek", "createdAt": "2020-03-04T16:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU4NTk3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r389585973", "bodyText": "@imotov @iverase I'm putting the refactor on hold pending outcome of review on #53099 which looks preferable to me, for the following reason: it looks like I'd also have to add SearchableGeometryQueryBuilder, which makes the Geo related classes in index.query diverge further from how the rest of the queries are built", "author": "djptek", "createdAt": "2020-03-09T10:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxMzAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392613036", "bodyText": "Refactored with help from a patch from @iversase thanks!", "author": "djptek", "createdAt": "2020-03-14T19:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA=="}], "type": "inlineReview"}, {"oid": "1ddb6e940c21a5be4ce17dedefed9827c782562a", "url": "https://github.com/elastic/elasticsearch/commit/1ddb6e940c21a5be4ce17dedefed9827c782562a", "message": "refactor to add GeoShapeQueryBuilder tests specific to geo_shape, geo_point", "committedDate": "2020-03-09T17:54:50Z", "type": "commit"}, {"oid": "ab708cff915dab10d6ee80efae3e757736363a22", "url": "https://github.com/elastic/elasticsearch/commit/ab708cff915dab10d6ee80efae3e757736363a22", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-09T20:14:50Z", "type": "commit"}, {"oid": "0803f8749edb1102a4180865170cb1946172ddb8", "url": "https://github.com/elastic/elasticsearch/commit/0803f8749edb1102a4180865170cb1946172ddb8", "message": "WIP refactor GeoShapeQueryBuilderTests", "committedDate": "2020-03-09T21:18:11Z", "type": "commit"}, {"oid": "d64b9dda5b9641309e6f95e968345e563e84ca67", "url": "https://github.com/elastic/elasticsearch/commit/d64b9dda5b9641309e6f95e968345e563e84ca67", "message": "added test overrides in GeoShapeQueryBuilderGeoPointTests", "committedDate": "2020-03-10T17:50:15Z", "type": "commit"}, {"oid": "253c3223d2372b09bd55e8d1a55de8d1bca73d18", "url": "https://github.com/elastic/elasticsearch/commit/253c3223d2372b09bd55e8d1a55de8d1bca73d18", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-10T18:32:38Z", "type": "commit"}, {"oid": "e25dc29398021dfdbcac20fdecb3c8477dfff72b", "url": "https://github.com/elastic/elasticsearch/commit/e25dc29398021dfdbcac20fdecb3c8477dfff72b", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-10T18:33:18Z", "type": "commit"}, {"oid": "06f755dbe762ac28cdc7740bd70061d5da071ff5", "url": "https://github.com/elastic/elasticsearch/commit/06f755dbe762ac28cdc7740bd70061d5da071ff5", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-11T11:24:11Z", "type": "commit"}, {"oid": "f88c8dfc676b68285feaaffeb6a7775663afffe6", "url": "https://github.com/elastic/elasticsearch/commit/f88c8dfc676b68285feaaffeb6a7775663afffe6", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2020-03-11T11:24:32Z", "type": "commit"}, {"oid": "cebf279027aba1eaf9f8db63212fbbee5e3275ad", "url": "https://github.com/elastic/elasticsearch/commit/cebf279027aba1eaf9f8db63212fbbee5e3275ad", "message": "override doCreateTestQueryBuilder() in GeoShapeQueryBuilderTests", "committedDate": "2020-03-11T12:05:10Z", "type": "commit"}]}