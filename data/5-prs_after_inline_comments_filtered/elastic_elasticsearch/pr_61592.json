{"pr_number": 61592, "pr_title": "Avoid packaging / unpacking cycle when using local current distributions", "pr_createdAt": "2020-08-26T15:54:58Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61592", "timeline": [{"oid": "7b6e5704768ed8282d458230a00ef8940d5156e2", "url": "https://github.com/elastic/elasticsearch/commit/7b6e5704768ed8282d458230a00ef8940d5156e2", "message": "Setup local distributions faster\n\n- avoid packaging/unpackaging cycle when relying on locally build distributions\n- Move more logic into distribution/archives", "committedDate": "2020-09-02T16:27:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483864429", "bodyText": "Do we really need this interface? Could we not just use Supplier<CopySpec>?", "author": "mark-vieira", "createdAt": "2020-09-04T22:12:13Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/DistributionArchive.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.gradle.api.Named;\n+import org.gradle.api.file.CopySpec;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+\n+public class DistributionArchive implements Named {\n+\n+    private TaskProvider<? extends AbstractArchiveTask> archiveTask;\n+    private TaskProvider<Copy> explodedDistTask;\n+    private final String name;\n+\n+    public DistributionArchive(TaskProvider<? extends AbstractArchiveTask> archiveTask, TaskProvider<Copy> explodedDistTask, String name) {\n+        this.archiveTask = archiveTask;\n+        this.explodedDistTask = explodedDistTask;\n+        this.name = name;\n+    }\n+\n+    public void setArchiveClassifier(String classifier) {\n+        this.archiveTask.configure(abstractArchiveTask -> abstractArchiveTask.getArchiveClassifier().set(classifier));\n+    }\n+\n+    public void content(ContentProvider p) {\n+        this.archiveTask.configure(t -> { t.with(p.provide()); });\n+        this.explodedDistTask.configure(t -> { t.with(p.provide()); });\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public TaskProvider<? extends AbstractArchiveTask> getArchiveTask() {\n+        return archiveTask;\n+    }\n+\n+    public TaskProvider<Copy> getExplodedArchiveTask() {\n+        return explodedDistTask;\n+    }\n+\n+    interface ContentProvider {", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MTE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484991149", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-09-08T15:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDc2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483864762", "bodyText": "Having per-distribution sub-projects means we can build them in parallel.", "author": "mark-vieira", "createdAt": "2020-09-04T22:13:51Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MTIzNw==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484991237", "bodyText": "Added", "author": "breskeby", "createdAt": "2020-09-08T15:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MDM1MA==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483870350", "bodyText": "I'm not sure we need the \"build\" prefix convention here for container entries. The DSL is meant to describe a distribution, the the task that eventually constructs it. The latter is an implementation detail handled by the plugin. I think it makes more sense to create a darwinTar and then the plugin incidentally creates a buildDarwinTar task.", "author": "mark-vieira", "createdAt": "2020-09-04T22:39:12Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));\n+            });\n+        });\n+        project.getExtensions().add(\"distribution_archives\", container);\n+    }\n+\n+    private void configureGeneralTaskDefaults(Project project) {\n+        // common config across all copy / archive tasks\n+        project.getTasks().withType(AbstractCopyTask.class).configureEach(t -> {\n+            t.dependsOn(project.getTasks().withType(EmptyDirTask.class));\n+            t.setIncludeEmptyDirs(true);\n+            t.setDirMode(0755);\n+            t.setFileMode(0644);\n+        });\n+\n+        // common config across all archives\n+        project.getTasks().withType(AbstractArchiveTask.class).configureEach(t -> {\n+            String subdir = buildTaskToSubprojectName(t.getName());\n+            t.getDestinationDirectory().set(project.file(subdir + \"/build/distributions\"));\n+            t.getArchiveBaseName().set(subdir.contains(\"oss\") ? \"elasticsearch-oss\" : \"elasticsearch\");\n+        });\n+    }\n+\n+    private void configureTarDefaults(Project project) {\n+        // common config across all tars\n+        project.getTasks().withType(SymbolicLinkPreservingTar.class).configureEach(t -> {\n+            t.getArchiveExtension().set(\"tar.gz\");\n+            t.setCompression(Compression.GZIP);\n+        });\n+    }\n+\n+    private void registerEmptyDirectoryTasks(Project project) {\n+        // CopySpec does not make it easy to create an empty directory so we\n+        // create the directory that we want, and then point CopySpec to its\n+        // parent to copy to the root of the distribution\n+        File logsDir = new File(project.getBuildDir(), \"logs-hack/logs\");\n+        project.getExtensions().add(\"logsDir\", new File(project.getBuildDir(), \"logs-hack/logs\"));\n+        project.getTasks().register(\"createLogsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(logsDir);\n+            t.setDirMode(0755);\n+        });\n+\n+        File pluginsDir = new File(project.getBuildDir(), \"plugins-hack/plugins\");\n+        project.getExtensions().add(\"pluginsDir\", pluginsDir);\n+        project.getTasks().register(\"createPluginsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(pluginsDir);\n+            t.setDirMode(0755);\n+        });\n+\n+        File jvmOptionsDir = new File(project.getBuildDir(), \"jvm-options-hack/jvm.options.d\");\n+        project.getExtensions().add(\"jvmOptionsDir\", jvmOptionsDir);\n+        project.getTasks().register(\"createJvmOptionsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(jvmOptionsDir);\n+            t.setDirMode(0750);\n+        });\n+    }\n+\n+    private String buildTaskToSubprojectName(String taskName) {\n+        return taskName.substring(\"build\".length()).replaceAll(\"[A-Z]\", \"-$0\").toLowerCase().substring(1);", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MTM2MA==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484991360", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-09-08T15:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MDM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTExMQ==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483871111", "bodyText": "Is there no public API to accomplish this?", "author": "mark-vieira", "createdAt": "2020-09-04T22:42:46Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIzNDc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484234744", "bodyText": "Unfortunately there isn't as far as I can tell. I also reached out to the gradle folks in slack and in the forum at https://discuss.gradle.org/t/registering-a-directory-type-variant-backed-by-a-custom-copy-task/37486/2 but so far no feedback", "author": "breskeby", "createdAt": "2020-09-07T07:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MTkwMw==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484991903", "bodyText": "I changed the implementation here to rely on a different configuration for the explodedDist. This allows us to not rely on internal api and makes the setup a bit simpler", "author": "breskeby", "createdAt": "2020-09-08T15:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483871637", "bodyText": "Shouldn't these be extra properties instead of extensions? I assume there's not too much difference but extensions end up get decorated by Gradle at runtime which we probably don't need in this case.", "author": "mark-vieira", "createdAt": "2020-09-04T22:45:28Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));\n+            });\n+        });\n+        project.getExtensions().add(\"distribution_archives\", container);\n+    }\n+\n+    private void configureGeneralTaskDefaults(Project project) {\n+        // common config across all copy / archive tasks\n+        project.getTasks().withType(AbstractCopyTask.class).configureEach(t -> {\n+            t.dependsOn(project.getTasks().withType(EmptyDirTask.class));\n+            t.setIncludeEmptyDirs(true);\n+            t.setDirMode(0755);\n+            t.setFileMode(0644);\n+        });\n+\n+        // common config across all archives\n+        project.getTasks().withType(AbstractArchiveTask.class).configureEach(t -> {\n+            String subdir = buildTaskToSubprojectName(t.getName());\n+            t.getDestinationDirectory().set(project.file(subdir + \"/build/distributions\"));\n+            t.getArchiveBaseName().set(subdir.contains(\"oss\") ? \"elasticsearch-oss\" : \"elasticsearch\");\n+        });\n+    }\n+\n+    private void configureTarDefaults(Project project) {\n+        // common config across all tars\n+        project.getTasks().withType(SymbolicLinkPreservingTar.class).configureEach(t -> {\n+            t.getArchiveExtension().set(\"tar.gz\");\n+            t.setCompression(Compression.GZIP);\n+        });\n+    }\n+\n+    private void registerEmptyDirectoryTasks(Project project) {\n+        // CopySpec does not make it easy to create an empty directory so we\n+        // create the directory that we want, and then point CopySpec to its\n+        // parent to copy to the root of the distribution\n+        File logsDir = new File(project.getBuildDir(), \"logs-hack/logs\");\n+        project.getExtensions().add(\"logsDir\", new File(project.getBuildDir(), \"logs-hack/logs\"));", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MTk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484991992", "bodyText": "good point. fixed.", "author": "breskeby", "createdAt": "2020-09-08T15:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MjM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483872363", "bodyText": "I think this should be resolveArchiveFormat.", "author": "mark-vieira", "createdAt": "2020-09-04T22:49:15Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -124,13 +124,22 @@ void setupDistributions(Project project) {\n             dependencies.add(distribution.configuration.getName(), resolvedDependency);\n             // no extraction allowed for rpm, deb or docker\n             if (distribution.getType().shouldExtract()) {\n+                distribution.configuration.getAttributes()\n+                    .attribute(ArtifactAttributes.ARTIFACT_FORMAT, resolveArtifactFormat(distribution));\n                 // The extracted configuration depends on the artifact directly but has\n                 // an artifact transform registered to resolve it as an unpacked folder.\n                 dependencies.add(distribution.getExtracted().getName(), resolvedDependency);\n             }\n         }\n     }\n \n+    private String resolveArtifactFormat(ElasticsearchDistribution distribution) {", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MjA2MA==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484992060", "bodyText": "changed", "author": "breskeby", "createdAt": "2020-09-08T15:02:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MjM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MzI0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483873249", "bodyText": "Is this strictly required? If we don't add any attributes shouldn't it default to to a particular variant? If not, any way we can avoid having to explicitly determine the archive type here and use something generic for both zip and tar?", "author": "mark-vieira", "createdAt": "2020-09-04T22:53:42Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -124,13 +124,22 @@ void setupDistributions(Project project) {\n             dependencies.add(distribution.configuration.getName(), resolvedDependency);\n             // no extraction allowed for rpm, deb or docker\n             if (distribution.getType().shouldExtract()) {\n+                distribution.configuration.getAttributes()", "originalCommit": "e76b07ef39845fadc683321d4dc5431aa72a3119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MjU0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r484992543", "bodyText": "I changed the providing setup to rely on different configurations instead (default and extended). This means we do not need that bit anymore", "author": "breskeby", "createdAt": "2020-09-08T15:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MzI0OQ=="}], "type": "inlineReview"}, {"oid": "bbab2765373ab822f0d93d8cdd735bed9657a73a", "url": "https://github.com/elastic/elasticsearch/commit/bbab2765373ab822f0d93d8cdd735bed9657a73a", "message": "Extract distribution archives defaults into plugin\n\nExtracting more stuff from the distribution/archives scripts into a testable plugin\n\n- Added basic test coverage", "committedDate": "2020-09-08T13:12:16Z", "type": "commit"}, {"oid": "7d3390ec1f7b1b85d62ab784373d71fc8890f03a", "url": "https://github.com/elastic/elasticsearch/commit/7d3390ec1f7b1b85d62ab784373d71fc8890f03a", "message": "Setup local distributions faster\n\n- avoid packaging/unpackaging cycle when relying on locally build distributions\n- Move more logic into distribution/archives", "committedDate": "2020-09-08T13:12:16Z", "type": "commit"}, {"oid": "c656c89615b0418c8d2289e53e6488e862095407", "url": "https://github.com/elastic/elasticsearch/commit/c656c89615b0418c8d2289e53e6488e862095407", "message": "Provide DSL for setting up distribution archives\n\n- provide directory variant per distribution archive", "committedDate": "2020-09-08T13:12:16Z", "type": "commit"}, {"oid": "cafe5b8624ad4c4dda9a688973209a0c9611b33b", "url": "https://github.com/elastic/elasticsearch/commit/cafe5b8624ad4c4dda9a688973209a0c9611b33b", "message": "Cleanup archives build script", "committedDate": "2020-09-08T13:12:16Z", "type": "commit"}, {"oid": "1ef9a89de7252c471cff7093562c791a06e264d9", "url": "https://github.com/elastic/elasticsearch/commit/1ef9a89de7252c471cff7093562c791a06e264d9", "message": "Fix consuming dependencies to distribution archives\n\n- polishing", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "f3c372dd700281debaaf7eaff19b963f108b8d8b", "url": "https://github.com/elastic/elasticsearch/commit/f3c372dd700281debaaf7eaff19b963f108b8d8b", "message": "Do not resolve dependencies in toString", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "747fecb0876d0823bb6b8c8cb19affd9a176737a", "url": "https://github.com/elastic/elasticsearch/commit/747fecb0876d0823bb6b8c8cb19affd9a176737a", "message": "Do not rely on toString to resolve file path", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "66d893eaa44100800392751253ddf82831ec72c0", "url": "https://github.com/elastic/elasticsearch/commit/66d893eaa44100800392751253ddf82831ec72c0", "message": "Explicitly set dist config artifact format", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "56d3599a19b04bd586b0c6dfa3478ee76d875f62", "url": "https://github.com/elastic/elasticsearch/commit/56d3599a19b04bd586b0c6dfa3478ee76d875f62", "message": "Only declare explicit artifact format for extractable distributions", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "51fe969d01e9a639eed112f10bf493ba9d6d181f", "url": "https://github.com/elastic/elasticsearch/commit/51fe969d01e9a639eed112f10bf493ba9d6d181f", "message": "Do not rely on toString in DistroPlugin", "committedDate": "2020-09-08T13:12:17Z", "type": "commit"}, {"oid": "2f31e06a5c866f03aea03528b66de869ab8eba25", "url": "https://github.com/elastic/elasticsearch/commit/2f31e06a5c866f03aea03528b66de869ab8eba25", "message": "Apply review feedback\n\n- expose explodedDist in separate configuration\n- redo namings\n- minor renamings", "committedDate": "2020-09-08T13:12:18Z", "type": "commit"}, {"oid": "ebe4c020cb1d5082695b3e037adc4dc1707f49e1", "url": "https://github.com/elastic/elasticsearch/commit/ebe4c020cb1d5082695b3e037adc4dc1707f49e1", "message": "Fix docker sources", "committedDate": "2020-09-08T13:12:18Z", "type": "commit"}, {"oid": "370b8108265dd1f263e23ab91f192981ea2bffd9", "url": "https://github.com/elastic/elasticsearch/commit/370b8108265dd1f263e23ab91f192981ea2bffd9", "message": "Fix imports", "committedDate": "2020-09-08T13:12:18Z", "type": "commit"}, {"oid": "45380869a84b81807414d7880b94b3ca073c75ab", "url": "https://github.com/elastic/elasticsearch/commit/45380869a84b81807414d7880b94b3ca073c75ab", "message": "Explicitly request default configuratino for docker sources", "committedDate": "2020-09-08T13:12:18Z", "type": "commit"}, {"oid": "45380869a84b81807414d7880b94b3ca073c75ab", "url": "https://github.com/elastic/elasticsearch/commit/45380869a84b81807414d7880b94b3ca073c75ab", "message": "Explicitly request default configuratino for docker sources", "committedDate": "2020-09-08T13:12:18Z", "type": "forcePushed"}, {"oid": "2625ed720a806f7b7bae1fa4e00fe1ada09830cb", "url": "https://github.com/elastic/elasticsearch/commit/2625ed720a806f7b7bae1fa4e00fe1ada09830cb", "message": "Fix resolveAllDependencies\n\nwhen relying on variants and artifacts we must make the requested configuration explicit", "committedDate": "2020-09-09T08:39:07Z", "type": "commit"}, {"oid": "c0aebf8f0cd59e6fd0edba90d0d7d61317ee3d93", "url": "https://github.com/elastic/elasticsearch/commit/c0aebf8f0cd59e6fd0edba90d0d7d61317ee3d93", "message": "Minor polishing", "committedDate": "2020-09-09T08:45:37Z", "type": "commit"}]}