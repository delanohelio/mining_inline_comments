{"pr_number": 50903, "pr_title": "[Transform] correctly retrieve checkpoints from remote indices", "pr_createdAt": "2020-01-13T10:28:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50903", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk3ODIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50903#discussion_r365978201", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public int size() {\n          \n          \n            \n                    public int numClusters() {\n          \n      \n    \n    \n  \n\nOr something. I thought size() was meant to be the number of total resolved indices, but instead it is used to help allocate the grouped listener.", "author": "benwtrent", "createdAt": "2020-01-13T19:13:31Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/checkpoint/RemoteClusterResolver.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.transform.checkpoint;\n+\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.transport.RemoteClusterAware;\n+import org.elasticsearch.transport.RemoteConnectionStrategy;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+\n+/**\n+ * Maintain a list of remote clusters (aliases) and provide the ability to resolve.\n+ */\n+class RemoteClusterResolver extends RemoteClusterAware {\n+\n+    private final CopyOnWriteArraySet<String> clusters;\n+\n+    class ResolvedIndices {\n+        private final Map<String, List<String>> remoteIndicesPerClusterAlias;\n+        private final List<String> localIndices;\n+\n+        ResolvedIndices(Map<String, List<String>> remoteIndicesPerClusterAlias, List<String> localIndices) {\n+            this.localIndices = localIndices;\n+            this.remoteIndicesPerClusterAlias = remoteIndicesPerClusterAlias;\n+        }\n+\n+        public Map<String, List<String>> getRemoteIndicesPerClusterAlias() {\n+            return remoteIndicesPerClusterAlias;\n+        }\n+\n+        public List<String> getLocalIndices() {\n+            return localIndices;\n+        }\n+\n+        public int size() {", "originalCommit": "85140ab5c0162e697b910e9b76fa3c3ba525edbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk4MjIwMw==", "url": "https://github.com/elastic/elasticsearch/pull/50903#discussion_r365982203", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"\",\n          \n          \n            \n                                LOCAL_CLUSTER_GROUP_KEY,", "author": "benwtrent", "createdAt": "2020-01-13T19:21:47Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/checkpoint/DefaultCheckpointProvider.java", "diffHunk": "@@ -84,13 +93,61 @@ public void createNextCheckpoint(final TransformCheckpoint lastCheckpoint, final\n     }\n \n     protected void getIndexCheckpoints(ActionListener<Map<String, long[]>> listener) {\n+        try {\n+            ResolvedIndices resolvedIndexes = remoteClusterResolver.resolve(transformConfig.getSource().getIndex());\n+            ActionListener<Map<String, long[]>> groupedListener = listener;\n+\n+            if (resolvedIndexes.size() > 1) {\n+                ActionListener<Collection<Map<String, long[]>>> mergeMapsListener = ActionListener.wrap(indexCheckpoints -> {\n+                    listener.onResponse(\n+                        indexCheckpoints.stream()\n+                            .flatMap(m -> m.entrySet().stream())\n+                            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()))\n+                    );\n+                }, listener::onFailure);\n+\n+                groupedListener = new GroupedActionListener<>(mergeMapsListener, resolvedIndexes.size());\n+            }\n+\n+            if (resolvedIndexes.getLocalIndices().isEmpty() == false) {\n+                getCheckpointsFromOneCluster(\n+                    client,\n+                    transformConfig.getHeaders(),\n+                    resolvedIndexes.getLocalIndices().toArray(new String[0]),\n+                    \"\",", "originalCommit": "85140ab5c0162e697b910e9b76fa3c3ba525edbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "881e882d6f4c133ba05eb8153778c70f397bf850", "url": "https://github.com/elastic/elasticsearch/commit/881e882d6f4c133ba05eb8153778c70f397bf850", "message": "correctly retrieve checkpoints from remote indices", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "864d454923504fe0415b7c33c478a8725854a6ef", "url": "https://github.com/elastic/elasticsearch/commit/864d454923504fe0415b7c33c478a8725854a6ef", "message": "improve RemoteClusterResolver", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "3fc72587eb7656fe0c82cf58a10420e29ef6a9b9", "url": "https://github.com/elastic/elasticsearch/commit/3fc72587eb7656fe0c82cf58a10420e29ef6a9b9", "message": "do not mock Settings", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "628fed16c1f049ce9cde1567a28cc32fda7940a3", "url": "https://github.com/elastic/elasticsearch/commit/628fed16c1f049ce9cde1567a28cc32fda7940a3", "message": "fix NPE when mocking cluster settings", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "7c4bf5c4c302d6ee186a033723b952bd17d015a0", "url": "https://github.com/elastic/elasticsearch/commit/7c4bf5c4c302d6ee186a033723b952bd17d015a0", "message": "remove debug leftover", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "4cf7691852923f8a5e116858e6bc1ca073edc78a", "url": "https://github.com/elastic/elasticsearch/commit/4cf7691852923f8a5e116858e6bc1ca073edc78a", "message": "apply review suggestions", "committedDate": "2020-01-14T10:40:36Z", "type": "commit"}, {"oid": "4cf7691852923f8a5e116858e6bc1ca073edc78a", "url": "https://github.com/elastic/elasticsearch/commit/4cf7691852923f8a5e116858e6bc1ca073edc78a", "message": "apply review suggestions", "committedDate": "2020-01-14T10:40:36Z", "type": "forcePushed"}]}