{"pr_number": 63985, "pr_title": "Cleanup Snapshot ITs Further", "pr_createdAt": "2020-10-21T10:59:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63985", "timeline": [{"oid": "0ec9cb79c249ab12e77ac8b2b1c51dbcb3ee3dc2", "url": "https://github.com/elastic/elasticsearch/commit/0ec9cb79c249ab12e77ac8b2b1c51dbcb3ee3dc2", "message": "Cleanup Snapshot ITs Further\n\nDrying up a few more spots and extracting tests that use their own custom plugins to separate\nclasses to make the giant `DedicatedClusterSnapshotRestoreIT` suite a little more digestable.", "committedDate": "2020-10-21T10:56:07Z", "type": "commit"}, {"oid": "576d27c32141b26640bb1209cf6a52176c9a6e58", "url": "https://github.com/elastic/elasticsearch/commit/576d27c32141b26640bb1209cf6a52176c9a6e58", "message": "Merge remote-tracking branch 'elastic/master' into more-snapshot-test-improvements", "committedDate": "2020-11-16T09:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NzE0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63985#discussion_r524247146", "bodyText": "I know this test is muted but I'd expect an expectThrows() here.", "author": "tlrx", "createdAt": "2020-11-16T12:55:13Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotBrokenSettingsIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.snapshots;\n+\n+import org.apache.lucene.util.LuceneTestCase;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.plugins.Plugin;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+@LuceneTestCase.AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/37485\")\n+public class SnapshotBrokenSettingsIT extends AbstractSnapshotIntegTestCase {\n+\n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        return Collections.singletonList(BrokenSettingPlugin.class);\n+    }\n+\n+    public void testExceptionWhenRestoringPersistentSettings() {\n+        logger.info(\"--> start 2 nodes\");\n+        internalCluster().startNodes(2);\n+\n+        Client client = client();\n+        Consumer<String> setSettingValue = value -> client.admin().cluster().prepareUpdateSettings().setPersistentSettings(\n+                Settings.builder().put(BrokenSettingPlugin.BROKEN_SETTING.getKey(), value)).execute().actionGet();\n+\n+        Consumer<String> assertSettingValue = value -> assertThat(client.admin().cluster().prepareState().setRoutingTable(false)\n+                .setNodes(false).execute().actionGet().getState().getMetadata().persistentSettings()\n+                .get(BrokenSettingPlugin.BROKEN_SETTING.getKey()), equalTo(value));\n+\n+        logger.info(\"--> set test persistent setting\");\n+        setSettingValue.accept(\"new value\");\n+        assertSettingValue.accept(\"new value\");\n+\n+        createRepository(\"test-repo\", \"fs\");\n+        createFullSnapshot(\"test-repo\", \"test-snap\");\n+        assertThat(getSnapshot(\"test-repo\", \"test-snap\").state(), equalTo(SnapshotState.SUCCESS));\n+\n+        logger.info(\"--> change the test persistent setting and break it\");\n+        setSettingValue.accept(\"new value 2\");\n+        assertSettingValue.accept(\"new value 2\");\n+        BrokenSettingPlugin.breakSetting();\n+\n+        logger.info(\"--> restore snapshot\");\n+        try {\n+            client.admin().cluster().prepareRestoreSnapshot(\"test-repo\", \"test-snap\").setRestoreGlobalState(true)", "originalCommit": "576d27c32141b26640bb1209cf6a52176c9a6e58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NzQ4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63985#discussion_r524247489", "bodyText": "Can we add the node name?", "author": "tlrx", "createdAt": "2020-11-16T12:55:36Z", "path": "test/framework/src/main/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -539,17 +539,17 @@ protected SnapshotInfo getSnapshot(String repository, String snapshot) {\n         return snapshotInfos.get(0);\n     }\n \n+    protected static ThreadPoolStats.Stats snapshotThreadPoolStats(final String node) {\n+        return StreamSupport.stream(internalCluster().getInstance(ThreadPool.class, node).stats().spliterator(), false)\n+                .filter(threadPool -> threadPool.getName().equals(ThreadPool.Names.SNAPSHOT))\n+                .findFirst()\n+                .orElseThrow(() -> new AssertionError(\"Failed to find snapshot pool\"));", "originalCommit": "576d27c32141b26640bb1209cf6a52176c9a6e58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2902bfc518bf3ffa153c83d6d661821323afc51f", "url": "https://github.com/elastic/elasticsearch/commit/2902bfc518bf3ffa153c83d6d661821323afc51f", "message": "Merge remote-tracking branch 'elastic/master' into more-snapshot-test-improvements", "committedDate": "2020-11-16T14:13:30Z", "type": "commit"}, {"oid": "1bade1164f7f3825ce013f73e13e4e12f9c698e9", "url": "https://github.com/elastic/elasticsearch/commit/1bade1164f7f3825ce013f73e13e4e12f9c698e9", "message": "cr: comments", "committedDate": "2020-11-16T14:19:14Z", "type": "commit"}]}