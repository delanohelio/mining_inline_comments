{"pr_number": 62216, "pr_title": "Speed up Version Checks", "pr_createdAt": "2020-09-10T12:36:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62216", "timeline": [{"oid": "457d4d622fc78cd0b1b7700198e5e1f016658bad", "url": "https://github.com/elastic/elasticsearch/commit/457d4d622fc78cd0b1b7700198e5e1f016658bad", "message": "Speed up Version Checks\n\nThe `fromId` method would show up in profiling and JIT analysis as not-inlinable because it's too large\nin the contexts it's used in in many cases and was consuming a surprising amount of cycles for computing the\nmin compat versions.\n\n-> extract cold path from `fromId` to make JIT happy and cache minimumg compatible versions to fields.", "committedDate": "2020-09-10T12:30:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxMTI2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62216#discussion_r486511261", "bodyText": "technically shouldn't we declare these as volatile?", "author": "jaymode", "createdAt": "2020-09-10T17:24:53Z", "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -285,6 +286,14 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         static final List<Version> DECLARED_VERSIONS = Collections.unmodifiableList(getDeclaredVersions(Version.class));\n     }\n \n+    // lazy initialized because we don't yet have the declared versions ready when instantiating the cached Version\n+    // instances\n+    private Version minCompatVersion;", "originalCommit": "457d4d622fc78cd0b1b7700198e5e1f016658bad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyNDU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62216#discussion_r486524567", "bodyText": "technically shouldn't we declare these as volatile?\n\nI figured no because we don't actively deduplicate this value so if we recompute it a few times (and realistically this is probably almost never going to happen) at startup it doesn't hurt but we pay the overhead in method size for volatile forever. But this was coded wrong even under that assumption now that I look at it again. I pushed 153763a so that it's safe even if out of order reads were to ever occur.", "author": "original-brownbear", "createdAt": "2020-09-10T17:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxMTI2MQ=="}], "type": "inlineReview"}, {"oid": "7e9a5cd8badba23ca27c903e8f584034ca54efcf", "url": "https://github.com/elastic/elasticsearch/commit/7e9a5cd8badba23ca27c903e8f584034ca54efcf", "message": "Merge remote-tracking branch 'elastic/master' into faster-id-looks", "committedDate": "2020-09-10T17:36:19Z", "type": "commit"}, {"oid": "153763ada87eb9392ad7198d04816ecf641658da", "url": "https://github.com/elastic/elasticsearch/commit/153763ada87eb9392ad7198d04816ecf641658da", "message": "ordering is mysterious", "committedDate": "2020-09-10T17:40:34Z", "type": "commit"}]}