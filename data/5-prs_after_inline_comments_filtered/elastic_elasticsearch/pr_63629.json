{"pr_number": 63629, "pr_title": "Gradle - compatible REST test plugin - adopt bwc artifact", "pr_createdAt": "2020-10-13T16:15:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63629", "timeline": [{"oid": "0def7a71f04577997923b4d7b695aeb2843fab17", "url": "https://github.com/elastic/elasticsearch/commit/0def7a71f04577997923b4d7b695aeb2843fab17", "message": "initial support", "committedDate": "2020-10-13T15:30:42Z", "type": "commit"}, {"oid": "1a5adbbf958505e5791f9d80a29ce20e25bb7ed4", "url": "https://github.com/elastic/elasticsearch/commit/1a5adbbf958505e5791f9d80a29ce20e25bb7ed4", "message": "minor change to support jar file", "committedDate": "2020-10-13T16:14:33Z", "type": "commit"}, {"oid": "74963c8de3692b936d6052405de84e025d64a86e", "url": "https://github.com/elastic/elasticsearch/commit/74963c8de3692b936d6052405de84e025d64a86e", "message": "remove test code", "committedDate": "2020-10-13T16:16:28Z", "type": "commit"}, {"oid": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "url": "https://github.com/elastic/elasticsearch/commit/0df3e61688cb5842d23ac1a65df8ddacba220ee4", "message": "fix precommit", "committedDate": "2020-10-13T16:32:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504314374", "bodyText": "I forget what the plan is for expanding this beyond just hard-coding this to only test against minor. I think we need some infra for being able to download rest test artifacts but we could also do test against \"staged\" right now.  I think a better intermediare step would be to use BwcVersions.forPreviousUnreleased here to iterate over any existing unreleased BWC branches.", "author": "mark-vieira", "createdAt": "2020-10-13T23:25:40Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -73,84 +74,54 @@ public void apply(Project project) {\n         ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n         testCluster.setTestDistribution(TestDistribution.DEFAULT);\n \n-        // TODO: once https://github.com/elastic/elasticsearch/pull/62473 lands refactor this to reference the checkoutDir as an artifact\n-        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n-        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n-            .getBuildDir()\n-            .toPath()\n-            .resolve(\"bwc\")\n-            .resolve(\"checkout-\" + priorMajorVersion + \".x\");\n-\n         // copy compatible rest specs\n-        Configuration compatSpec = project.getConfigurations().create(\"compatSpec\");\n-        Configuration xpackCompatSpec = project.getConfigurations().create(\"xpackCompatSpec\");\n-        Configuration additionalCompatSpec = project.getConfigurations().create(\"additionalCompatSpec\");\n+        Configuration bwcMinorConfig = project.getConfigurations().create(\"bwcMinor\");\n+        Dependency bwcMinor = project.getDependencies().project(Map.of(\"path\", \":distribution:bwc:minor\", \"configuration\", \"checkout\"));", "originalCommit": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504898648", "bodyText": "The plan is to (manually) deploy zip artifacts that include all of the tests and apis that are found in source for prior releases (and introduce a new task for new releases). Then we can iterate over all of the latest of bugfix version per minor.  We will also want to iterate over the latest bugfix and staged too, which will need to be sourced from git just like here.\nI am hesitant to introduce that right now because I think all previous released and bugfix/staged would live under a different lifecycle task (which can be introduced later). The tests against BWC minor are wired in via check so that normal YAML tests will run, followed by the compatible YAML tests. I believe that we need to keep at least one compatible test as part of the primary check per project and for now it is bwc:minor , but in future (for performance reasons) we may want to consider to be previous released minor.\nI think it will all get there before release, but holding off a little bit on the introduction of the new lifecycle allow me to focus on a few other things first.", "author": "jakelandis", "createdAt": "2020-10-14T18:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkyNDA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504924073", "bodyText": "The way we handle BWC checks wrt lifecycle tasks now is that we have a bwcTestSnapshots which is wired to check and this task tests only snapshot bwc versions, so in this case for master that would be 7.x, 7.10 and 7.9 (until it goes GA). All release versions are tested explicity and not when running check. I think we want to continue with this pattern of check running all active dev code.", "author": "mark-vieira", "createdAt": "2020-10-14T19:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NjkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504986917", "bodyText": "I think the primary difference here is that this will be applied for each and every project, as opposed to a special purpose project. For example, I make a change to the reindex module, do we want to have to checkout 3 branches of source code and run 3 additional test clusters ? (same applies for every module/plugin)\nToday, most dev workflows don't result in executing the bwcTestSnapshots, resulting in CI to run the that special purpose project(s). I think we should introduce a new task(s) to run the full compat set of tests that will be run via CI, but we need to be careful with how much additional testing per (normal) project.\nI think my comfort level is 1 additional set of REST tests per project that are executed via :myproject:check, and rely on CI job(s) for the rest of the compatibility. I believe that testing against bwc:minor or the latest release will be sufficient for the majority of the cases and can rely on special CI jobs for the long tail.", "author": "jakelandis", "createdAt": "2020-10-14T21:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5NjgwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504996809", "bodyText": "Ah, I see what you are saying. That being said, I think even effectively doubling the rest tests across the board is a bit much since the vast majority of changes are unlikely to impact REST compatibility. I think in terms of task lifecycle we probably want to completely decouple this stuff from check or introduce some other more lightweight variant for folks to run locally. We'll also most likely end up splitting all this into it's own CI jobs.\nDo we have runtimes on this stuff?", "author": "mark-vieira", "createdAt": "2020-10-14T21:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAzMDczNw==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r505030737", "bodyText": "The runtimes will be approximately equal to the normal yamlRestTests.\nfor example: https://gradle-enterprise.elastic.co/s/p65q5te3ybeni/tests?search=yamlRestTest (part1)\nand https://gradle-enterprise.elastic.co/s/72gyujegdjpp2/tests?search=yamlRestTest (part2)\n\nI think in terms of task lifecycle we probably want to completely decouple this stuff from check or introduce some other more lightweight variant for folks to run locally.\n\nI am good with that especially after double checking the runtimes.  I don't know of a way to make a light weight check that would be effective ... if we decouple with check we should probably introduce a compatTestSnapshots that runs the equivalent of bwcTestSnapshots (sourcing from the possible 3 git sources) in a separate CI job run per PR. Additionally we would want a compatTestAll that would not run per PR but likely a dedicated job.\nAll good conversations, but abit outside the scope of this PR and can decouple the check and introduce separate lifecycle tasks in future PR.", "author": "jakelandis", "createdAt": "2020-10-14T22:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwNzg4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r505907880", "bodyText": "I wonder if we should consider these tests \"bwc\" tests for the purposes of the bwc_tests_enabled flag. We already have some logic to separate out bwc testing into its own job, as well as allow devs to disable bwc testing when in the process of backporting BWC changes. We don't necessarily have to do that now though, we can leave this as a TODO.", "author": "mark-vieira", "createdAt": "2020-10-15T22:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDc0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504314742", "bodyText": "Why are we doing this in the task configuration? I think this should be up where we create the configuration and dependency.", "author": "mark-vieira", "createdAt": "2020-10-13T23:26:50Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -73,84 +74,54 @@ public void apply(Project project) {\n         ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n         testCluster.setTestDistribution(TestDistribution.DEFAULT);\n \n-        // TODO: once https://github.com/elastic/elasticsearch/pull/62473 lands refactor this to reference the checkoutDir as an artifact\n-        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n-        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n-            .getBuildDir()\n-            .toPath()\n-            .resolve(\"bwc\")\n-            .resolve(\"checkout-\" + priorMajorVersion + \".x\");\n-\n         // copy compatible rest specs\n-        Configuration compatSpec = project.getConfigurations().create(\"compatSpec\");\n-        Configuration xpackCompatSpec = project.getConfigurations().create(\"xpackCompatSpec\");\n-        Configuration additionalCompatSpec = project.getConfigurations().create(\"additionalCompatSpec\");\n+        Configuration bwcMinorConfig = project.getConfigurations().create(\"bwcMinor\");\n+        Dependency bwcMinor = project.getDependencies().project(Map.of(\"path\", \":distribution:bwc:minor\", \"configuration\", \"checkout\"));\n+\n         Provider<CopyRestApiTask> copyCompatYamlSpecTask = project.getTasks()\n             .register(\"copyRestApiCompatSpecsTask\", CopyRestApiTask.class, task -> {\n+                project.getDependencies().add(bwcMinorConfig.getName(), bwcMinor);", "originalCommit": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMzkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504533920", "bodyText": "+1", "author": "breskeby", "createdAt": "2020-10-14T09:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNDc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNTIxMw==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504315213", "bodyText": "shouldn't we really be referencing config here instead of bwcMinorConfig even though they are almost certain to be the same?", "author": "mark-vieira", "createdAt": "2020-10-13T23:28:20Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -73,84 +74,54 @@ public void apply(Project project) {\n         ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n         testCluster.setTestDistribution(TestDistribution.DEFAULT);\n \n-        // TODO: once https://github.com/elastic/elasticsearch/pull/62473 lands refactor this to reference the checkoutDir as an artifact\n-        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n-        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n-            .getBuildDir()\n-            .toPath()\n-            .resolve(\"bwc\")\n-            .resolve(\"checkout-\" + priorMajorVersion + \".x\");\n-\n         // copy compatible rest specs\n-        Configuration compatSpec = project.getConfigurations().create(\"compatSpec\");\n-        Configuration xpackCompatSpec = project.getConfigurations().create(\"xpackCompatSpec\");\n-        Configuration additionalCompatSpec = project.getConfigurations().create(\"additionalCompatSpec\");\n+        Configuration bwcMinorConfig = project.getConfigurations().create(\"bwcMinor\");\n+        Dependency bwcMinor = project.getDependencies().project(Map.of(\"path\", \":distribution:bwc:minor\", \"configuration\", \"checkout\"));\n+\n         Provider<CopyRestApiTask> copyCompatYamlSpecTask = project.getTasks()\n             .register(\"copyRestApiCompatSpecsTask\", CopyRestApiTask.class, task -> {\n+                project.getDependencies().add(bwcMinorConfig.getName(), bwcMinor);\n+                task.dependsOn(bwcMinorConfig);\n+                task.coreConfig = bwcMinorConfig;\n+                task.xpackConfig = bwcMinorConfig;\n+                task.additionalConfig = bwcMinorConfig;\n                 task.includeCore.set(extension.restApi.getIncludeCore());\n                 task.includeXpack.set(extension.restApi.getIncludeXpack());\n                 task.sourceSetName = SOURCE_SET_NAME;\n                 task.skipHasRestTestCheck = true;\n-                task.coreConfig = compatSpec;\n-                project.getDependencies()\n-                    .add(\n-                        task.coreConfig.getName(),\n-                        project.files(checkoutDir.resolve(\"rest-api-spec/src/main/resources\").resolve(RELATIVE_API_PATH))\n-                    );\n-                task.xpackConfig = xpackCompatSpec;\n-                project.getDependencies()\n-                    .add(\n-                        task.xpackConfig.getName(),\n-                        project.files(checkoutDir.resolve(\"x-pack/plugin/src/test/resources\").resolve(RELATIVE_API_PATH))\n-                    );\n-                task.additionalConfig = additionalCompatSpec;\n-                // per project can define custom specifications\n-                project.getDependencies()\n-                    .add(\n-                        task.additionalConfig.getName(),\n-                        project.files(\n-                            getCompatProjectPath(project, checkoutDir).resolve(\"src/yamlRestTest/resources\").resolve(RELATIVE_API_PATH)\n-                        )\n-                    );\n-                task.dependsOn(task.coreConfig);\n-                task.dependsOn(task.xpackConfig);\n-                task.dependsOn(task.additionalConfig);\n-                task.dependsOn(\":distribution:bwc:minor:checkoutBwcBranch\");\n+                task.coreConfigToFileTree = config -> project.fileTree(\n+                    bwcMinorConfig.getSingleFile().toPath().resolve(\"rest-api-spec/src/main/resources\").resolve(RELATIVE_API_PATH)", "originalCommit": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMxNTUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504315521", "bodyText": "Should we make the spec folders constants as well?", "author": "mark-vieira", "createdAt": "2020-10-13T23:29:19Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/YamlRestCompatTestPlugin.java", "diffHunk": "@@ -73,84 +74,54 @@ public void apply(Project project) {\n         ElasticsearchCluster testCluster = createTestCluster(project, yamlCompatTestSourceSet);\n         testCluster.setTestDistribution(TestDistribution.DEFAULT);\n \n-        // TODO: once https://github.com/elastic/elasticsearch/pull/62473 lands refactor this to reference the checkoutDir as an artifact\n-        int priorMajorVersion = VersionProperties.getElasticsearchVersion().getMajor() - 1;\n-        final Path checkoutDir = project.findProject(\":distribution:bwc:minor\")\n-            .getBuildDir()\n-            .toPath()\n-            .resolve(\"bwc\")\n-            .resolve(\"checkout-\" + priorMajorVersion + \".x\");\n-\n         // copy compatible rest specs\n-        Configuration compatSpec = project.getConfigurations().create(\"compatSpec\");\n-        Configuration xpackCompatSpec = project.getConfigurations().create(\"xpackCompatSpec\");\n-        Configuration additionalCompatSpec = project.getConfigurations().create(\"additionalCompatSpec\");\n+        Configuration bwcMinorConfig = project.getConfigurations().create(\"bwcMinor\");\n+        Dependency bwcMinor = project.getDependencies().project(Map.of(\"path\", \":distribution:bwc:minor\", \"configuration\", \"checkout\"));\n+\n         Provider<CopyRestApiTask> copyCompatYamlSpecTask = project.getTasks()\n             .register(\"copyRestApiCompatSpecsTask\", CopyRestApiTask.class, task -> {\n+                project.getDependencies().add(bwcMinorConfig.getName(), bwcMinor);\n+                task.dependsOn(bwcMinorConfig);\n+                task.coreConfig = bwcMinorConfig;\n+                task.xpackConfig = bwcMinorConfig;\n+                task.additionalConfig = bwcMinorConfig;\n                 task.includeCore.set(extension.restApi.getIncludeCore());\n                 task.includeXpack.set(extension.restApi.getIncludeXpack());\n                 task.sourceSetName = SOURCE_SET_NAME;\n                 task.skipHasRestTestCheck = true;\n-                task.coreConfig = compatSpec;\n-                project.getDependencies()\n-                    .add(\n-                        task.coreConfig.getName(),\n-                        project.files(checkoutDir.resolve(\"rest-api-spec/src/main/resources\").resolve(RELATIVE_API_PATH))\n-                    );\n-                task.xpackConfig = xpackCompatSpec;\n-                project.getDependencies()\n-                    .add(\n-                        task.xpackConfig.getName(),\n-                        project.files(checkoutDir.resolve(\"x-pack/plugin/src/test/resources\").resolve(RELATIVE_API_PATH))\n-                    );\n-                task.additionalConfig = additionalCompatSpec;\n-                // per project can define custom specifications\n-                project.getDependencies()\n-                    .add(\n-                        task.additionalConfig.getName(),\n-                        project.files(\n-                            getCompatProjectPath(project, checkoutDir).resolve(\"src/yamlRestTest/resources\").resolve(RELATIVE_API_PATH)\n-                        )\n-                    );\n-                task.dependsOn(task.coreConfig);\n-                task.dependsOn(task.xpackConfig);\n-                task.dependsOn(task.additionalConfig);\n-                task.dependsOn(\":distribution:bwc:minor:checkoutBwcBranch\");\n+                task.coreConfigToFileTree = config -> project.fileTree(\n+                    bwcMinorConfig.getSingleFile().toPath().resolve(\"rest-api-spec/src/main/resources\").resolve(RELATIVE_API_PATH)", "originalCommit": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzMjIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/63629#discussion_r504532233", "bodyText": "Not strictly related but since we're here: can we change this task to use the ProjectLayout Service here instead of referencing the project object. This helps us moving (slowly) towards supporting the gradle configuration cache (https://docs.gradle.org/current/userguide/configuration_cache.html) You can inject the service e.g. via constructor and annotating that constructor with @Inject", "author": "breskeby", "createdAt": "2020-10-14T09:24:34Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -117,21 +122,21 @@ public FileTree getInputDir() {\n         FileTree xpackFileTree = null;\n         if (includeXpack.get().isEmpty() == false) {\n             xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n-            xpackFileTree = xpackConfig.getAsFileTree().matching(xpackPatternSet);\n+            xpackFileTree = xpackConfigToFileTree.apply(xpackConfig).matching(xpackPatternSet);\n         }\n         boolean projectHasYamlRestTests = skipHasRestTestCheck || projectHasYamlRestTests();\n         if (includeCore.get().isEmpty() == false || projectHasYamlRestTests) {\n             if (BuildParams.isInternal()) {\n                 corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n-                coreFileTree = coreConfig.getAsFileTree().matching(corePatternSet); // directory on disk\n+                coreFileTree = coreConfigToFileTree.apply(coreConfig).matching(corePatternSet); // directory on disk\n             } else {\n                 coreFileTree = coreConfig.getAsFileTree(); // jar file\n             }\n         }\n \n         ConfigurableFileCollection fileCollection = additionalConfig == null\n             ? getProject().files(coreFileTree, xpackFileTree)", "originalCommit": "0df3e61688cb5842d23ac1a65df8ddacba220ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2a508ece1b306b1d25c228c093e852b74660eaa", "url": "https://github.com/elastic/elasticsearch/commit/b2a508ece1b306b1d25c228c093e852b74660eaa", "message": "dependency location, and constant for paths", "committedDate": "2020-10-14T18:29:24Z", "type": "commit"}, {"oid": "23946713acba68e06f2b16e9f1dc4291e5d8b821", "url": "https://github.com/elastic/elasticsearch/commit/23946713acba68e06f2b16e9f1dc4291e5d8b821", "message": "use projectLayout", "committedDate": "2020-10-14T19:21:30Z", "type": "commit"}, {"oid": "dd15c83e96761f22544a98e43aab6e8bdd14d54f", "url": "https://github.com/elastic/elasticsearch/commit/dd15c83e96761f22544a98e43aab6e8bdd14d54f", "message": "spotless", "committedDate": "2020-10-15T13:39:42Z", "type": "commit"}, {"oid": "c682c1cbcc75355a85f03a06db3862feb72133e2", "url": "https://github.com/elastic/elasticsearch/commit/c682c1cbcc75355a85f03a06db3862feb72133e2", "message": "Merge branch 'master' into adopt_bwc_artifact", "committedDate": "2020-10-20T17:02:49Z", "type": "commit"}]}