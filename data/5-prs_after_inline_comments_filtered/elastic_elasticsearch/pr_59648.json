{"pr_number": 59648, "pr_title": "Extensibility for Composite Agg", "pr_createdAt": "2020-07-15T18:08:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59648", "timeline": [{"oid": "b9946179372285cdd445c29b7ebd7366f819e458", "url": "https://github.com/elastic/elasticsearch/commit/b9946179372285cdd445c29b7ebd7366f819e458", "message": "use the new field-based resolver for composite", "committedDate": "2020-07-14T14:31:28Z", "type": "commit"}, {"oid": "bac2f68549353915bdb9d57c1ece75561ad29b70", "url": "https://github.com/elastic/elasticsearch/commit/bac2f68549353915bdb9d57c1ece75561ad29b70", "message": "Move SingleDimensionVS creation onto CompositeVSConfig", "committedDate": "2020-07-15T17:01:08Z", "type": "commit"}, {"oid": "f1becefa8b2a52fbaf475f769efebcf593438dc5", "url": "https://github.com/elastic/elasticsearch/commit/f1becefa8b2a52fbaf475f769efebcf593438dc5", "message": "Make SingleDimensionVS creation injectable", "committedDate": "2020-07-15T21:45:23Z", "type": "commit"}, {"oid": "ead736d0721ce1c15a864b977ca043f9024d6aca", "url": "https://github.com/elastic/elasticsearch/commit/ead736d0721ce1c15a864b977ca043f9024d6aca", "message": "Add composite lookup to the VS Registry", "committedDate": "2020-07-20T18:13:01Z", "type": "commit"}, {"oid": "98332148ecd2b13232ccc202ed5db7dc44c9a1c7", "url": "https://github.com/elastic/elasticsearch/commit/98332148ecd2b13232ccc202ed5db7dc44c9a1c7", "message": "Drop unnecessary null conversions", "committedDate": "2020-07-20T20:49:12Z", "type": "commit"}, {"oid": "78fecf0d2263b724e9f351fd2f6336cd5724c133", "url": "https://github.com/elastic/elasticsearch/commit/78fecf0d2263b724e9f351fd2f6336cd5724c133", "message": "Make CompositeBucketStrategy immutable", "committedDate": "2020-07-21T14:33:43Z", "type": "commit"}, {"oid": "9c55c777d8b5657bdc147d4593087a66f8a1110f", "url": "https://github.com/elastic/elasticsearch/commit/9c55c777d8b5657bdc147d4593087a66f8a1110f", "message": "Wire up DateHisto composites", "committedDate": "2020-07-21T20:46:47Z", "type": "commit"}, {"oid": "880ed6b8725614e22507a7be956565174c8ef07f", "url": "https://github.com/elastic/elasticsearch/commit/880ed6b8725614e22507a7be956565174c8ef07f", "message": "Wire up histogram", "committedDate": "2020-07-22T18:51:51Z", "type": "commit"}, {"oid": "08006e3ee4144a6503bedcdd33adc38b3a3a03d4", "url": "https://github.com/elastic/elasticsearch/commit/08006e3ee4144a6503bedcdd33adc38b3a3a03d4", "message": "Wire up geotile", "committedDate": "2020-07-22T19:22:40Z", "type": "commit"}, {"oid": "267c2bbf15edcc55b0f1cc4fe89694a2cf1e4c07", "url": "https://github.com/elastic/elasticsearch/commit/267c2bbf15edcc55b0f1cc4fe89694a2cf1e4c07", "message": "make name a top level parameter", "committedDate": "2020-07-22T19:51:15Z", "type": "commit"}, {"oid": "482eb61374d188b0c69ddce302ec4439f084a0c3", "url": "https://github.com/elastic/elasticsearch/commit/482eb61374d188b0c69ddce302ec4439f084a0c3", "message": "wire up terms", "committedDate": "2020-07-23T14:44:19Z", "type": "commit"}, {"oid": "7275e46055ca0bf24534f59340d8656cd68c72e2", "url": "https://github.com/elastic/elasticsearch/commit/7275e46055ca0bf24534f59340d8656cd68c72e2", "message": "Fix failing doc test", "committedDate": "2020-07-28T15:21:21Z", "type": "commit"}, {"oid": "89c30020a8f0eae84e03e1f496776c88f558eddb", "url": "https://github.com/elastic/elasticsearch/commit/89c30020a8f0eae84e03e1f496776c88f558eddb", "message": "Terms should support boolean", "committedDate": "2020-07-29T13:31:39Z", "type": "commit"}, {"oid": "4546d99d59507a4bb908f133ece47087763adf2b", "url": "https://github.com/elastic/elasticsearch/commit/4546d99d59507a4bb908f133ece47087763adf2b", "message": "test rename", "committedDate": "2020-07-29T17:59:50Z", "type": "commit"}, {"oid": "1a035d5d0591a41e443e0db46bcb57c6529d6edc", "url": "https://github.com/elastic/elasticsearch/commit/1a035d5d0591a41e443e0db46bcb57c6529d6edc", "message": "Merge branch 'master' into composite-date-vst", "committedDate": "2020-07-29T19:05:18Z", "type": "commit"}, {"oid": "e4678328430fb30a7507d9418a82002a1f62747c", "url": "https://github.com/elastic/elasticsearch/commit/e4678328430fb30a7507d9418a82002a1f62747c", "message": "Tests and default VST for geopoint", "committedDate": "2020-07-29T21:10:25Z", "type": "commit"}, {"oid": "3c6bc4aceed62eebb534cc57e96e73f95bb6733a", "url": "https://github.com/elastic/elasticsearch/commit/3c6bc4aceed62eebb534cc57e96e73f95bb6733a", "message": "Additional unmapped tests", "committedDate": "2020-07-30T16:02:51Z", "type": "commit"}, {"oid": "c87db76194af5089f7d827d353c0c5d4366ed029", "url": "https://github.com/elastic/elasticsearch/commit/c87db76194af5089f7d827d353c0c5d4366ed029", "message": "Move default VST in line with how single value does it", "committedDate": "2020-07-30T16:37:21Z", "type": "commit"}, {"oid": "ef398db887558b6336c340093d09142b686eb25a", "url": "https://github.com/elastic/elasticsearch/commit/ef398db887558b6336c340093d09142b686eb25a", "message": "Rename value type to match intended use", "committedDate": "2020-07-30T17:10:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1MDM5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r463150399", "bodyText": "This preserves the existing behavior (i.e. it tracks composite usage like it was tracked before setting up the registry). It might be worth more detailed tracking, since we can capture what key types and values sources are being used.   But this PR is big enough already, and we don't have a clear plan for composite usage tracking, so I'm leaving it be for now.  Can open a ticket if folks think it's worth tinkering with, or we can just leave it alone.", "author": "not-napoleon", "createdAt": "2020-07-30T17:17:17Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregationBuilder.java", "diffHunk": "@@ -61,6 +62,14 @@\n         PARSER.declareObject(CompositeAggregationBuilder::aggregateAfter, (p, context) -> p.map(), AFTER_FIELD_NAME);\n     }\n \n+    public static void registerAggregators(ValuesSourceRegistry.Builder builder) {\n+        DateHistogramValuesSourceBuilder.register(builder);\n+        HistogramValuesSourceBuilder.register(builder);\n+        GeoTileGridValuesSourceBuilder.register(builder);\n+        TermsValuesSourceBuilder.register(builder);\n+        builder.registerUsage(NAME);", "originalCommit": "ef398db887558b6336c340093d09142b686eb25a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NTAwNw==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r465895007", "bodyText": "\ud83d\udc4d to preserving the original behavior for now.", "author": "nik9000", "createdAt": "2020-08-05T17:40:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1MDM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NTc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r463155766", "bodyText": "It's definitely a little weird that CompositeValuesSourceConfig is both the object that holds this function, and a parameter to this function.  I'm pretty confidant that there's a less tangled way to do this.  My plan is to land this initial change to get stuff into the registry at all, and try to neaten up this edge in a follow up PR.", "author": "not-napoleon", "createdAt": "2020-07-30T17:26:32Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeValuesSourceConfig.java", "diffHunk": "@@ -19,13 +19,29 @@\n \n package org.elasticsearch.search.aggregations.bucket.composite;\n \n+import org.apache.lucene.index.IndexReader;\n import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.util.BigArrays;\n import org.elasticsearch.index.mapper.MappedFieldType;\n import org.elasticsearch.search.DocValueFormat;\n import org.elasticsearch.search.aggregations.support.ValuesSource;\n import org.elasticsearch.search.sort.SortOrder;\n \n-class CompositeValuesSourceConfig {\n+import java.util.function.LongConsumer;\n+\n+public class CompositeValuesSourceConfig {\n+\n+    @FunctionalInterface\n+    public interface SingleDimensionValuesSourceProvider {\n+        SingleDimensionValuesSource<?> createValuesSource(\n+            BigArrays bigArrays,\n+            IndexReader reader,\n+            int size,\n+            LongConsumer addRequestCircuitBreakerBytes,\n+            CompositeValuesSourceConfig config", "originalCommit": "ef398db887558b6336c340093d09142b686eb25a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzODAzMA==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r465938030", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-08-05T18:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE1NTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2NTM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r463165341", "bodyText": "We should be able to do this now,  but I didn't.", "author": "not-napoleon", "createdAt": "2020-07-30T17:44:08Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/DateHistogramValuesSourceBuilder.java", "diffHunk": "@@ -246,25 +253,61 @@ public DateHistogramValuesSourceBuilder offset(long offset) {\n         return this;\n     }\n \n+    public static void register(ValuesSourceRegistry.Builder builder) {\n+        builder.registerComposite(\n+            TYPE,\n+            List.of(CoreValuesSourceType.DATE, CoreValuesSourceType.NUMERIC),\n+            ((valuesSourceConfig, compositeBucketStrategy, name, hasScript, format, missingBucket, order) -> {\n+                ValuesSource.Numeric numeric = (ValuesSource.Numeric) valuesSourceConfig.getValuesSource();\n+                // TODO once composite is plugged in to the values source registry or at least understands Date values source types use it", "originalCommit": "ef398db887558b6336c340093d09142b686eb25a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9119051112725d6ef80ea0e7f6d678379f1dbec", "url": "https://github.com/elastic/elasticsearch/commit/c9119051112725d6ef80ea0e7f6d678379f1dbec", "message": "Few cleanup bits", "committedDate": "2020-07-30T20:05:15Z", "type": "commit"}, {"oid": "709ee18027ada4bf0129fac20b03d2414695c811", "url": "https://github.com/elastic/elasticsearch/commit/709ee18027ada4bf0129fac20b03d2414695c811", "message": "Fix tests", "committedDate": "2020-08-03T17:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NDI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r464644260", "bodyText": "It seems to me that this should be an interface that returns a T extends ValuesSource given a ValuesSource.\nexamples\n    interface StrategyApplier<T extends ValuesSource, R extends ValuesSource> {\n\n        R build(T valueSource);\n\n    }\n\n    //Terms one\n    public static class None implements StrategyApplier<ValuesSource, ValuesSource> {\n        @Override\n        public ValuesSource build(ValuesSource valuesSource) {\n            return valuesSource;\n        }\n    }\n\n    //Geotile one\n    public static class Geo implements StrategyApplier<ValuesSource.GeoPoint, CellIdSource> {\n\n        private final int precision;\n        private final GeoBoundingBox boundingBox;\n        \n        public Geo(int precision, GeoBoundingBox boundingBox) {\n            this.precision = precision;\n            this.boundingBox = boundingBox;\n        }\n\n        @Override\n        public CellIdSource build(ValuesSource.GeoPoint valueSource) {\n            return new CellIdSource(\n                valueSource,\n                precision,\n                boundingBox,\n                GeoTileUtils::longEncode\n            );\n        }\n    }\n\n\nThese appliers could constructed in your innerBuild objects. You will have to cast things, but it is doing that anyways in the register methods.\nThis seems cleaner to me than asserting on a strategy enum and having this pseudo union type.", "author": "benwtrent", "createdAt": "2020-08-03T20:27:54Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeBucketStrategy.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations.bucket.composite;\n+\n+import org.elasticsearch.common.Rounding;\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+\n+/**\n+ * This class acts as a bit of syntactic sugar to let us pass in the rounding info for dates or the interval for numeric histograms as one\n+ * class, to save needing three different interfaces.  Sometimes I miss C-style Union structures.\n+ */\n+public class CompositeBucketStrategy {", "originalCommit": "709ee18027ada4bf0129fac20b03d2414695c811", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY2ODI0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r464668246", "bodyText": "The problem is that we can't say that Geo always takes a ValuesSource.GeoPoint.  The whole goal here is to allow plugging in values sources from plugins without needing to touch the main aggregation code.  If we hard cast from innerBuilder, that breaks.  The hard casts need to happen in the registered CompositeSuppliers.  What I can do, and what we did for the other aggs, is instead of having one CompositeSupplier which takes this union thing, I can have four CompositeSupplier classes, one for each agg type, which take the appropriate rounding information.  I'd avoided doing that because it caused a lot of confusion when I did it last time, but maybe it's better than this?  IDK.\nI'll code it up and we can compare.", "author": "not-napoleon", "createdAt": "2020-08-03T21:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NDI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5ODY1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r464998657", "bodyText": "@not-napoleon\n\nThe problem is that we can't say that Geo always takes a ValuesSource.GeoPoint\n\nOk, maybe I misunderstand, but the geo composite strategy requires a CellIdSource, which requires a ValuesSource.GeoPoint.\nIf you are adding flexibility somewhere, I don't see it.", "author": "benwtrent", "createdAt": "2020-08-04T12:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NDI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3NTMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r465075314", "bodyText": "CellIdSource is just a way of turning a GeoPoint into a Long.  What GeoTileValuesSource requires is a function that yields longs, for which we currently pass in CellIdSource#longValues().  Before this change, that was the only option, and was hard-coded in CompositeAggregator.  Essentially, we assumed that if you asked for a GeoTile composite, you must be using a geo point.\nThe flexibility comes from being able to look up that logic at run time, rather than hard code it at compile time.  So, in the Spatial plugin, we have a class GeoShapeCellSourceId.  This change allows us to add a lookup that says \"if you have a GeoShape, use the GeoShape version of CellSourceId instead\".  That's done via that register method, which maps a values source type to a supplier function.  We can't put that logic directly into innerBuilder without adding a compile time dependency on the module, which we want to avoid.\nAlthough I haven't written an example in here (in the interest of time and smaller change sets), the idea is that plugins which define new ValuesSourceTypes, like Spatial defines GeoShape as a values source type, would register those types along with logic for how to turn those into what the key generation functions want.  In this way of thinking, it's \"safe\" to cast a values source from within a registered supplier function, because we know what type of the mapping key for that function, which indicates the type of values source we're getting.  It's not safe to cast from innerBuilder, because at that point we don't know what types we have, since a plugin could have added types at run time.  Make sense?\nIt's a little tricky to follow for composite because composite uses ValuesSource to mean three different things.  I'm going to do some follow up work to clean up some of that terminology.", "author": "not-napoleon", "createdAt": "2020-08-04T14:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NDI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NDUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r465944524", "bodyText": "I wonder if it'd make sense to move the have three methods on CompositeSupplier that map to these three ctors. Each supplier could implement the strategy it supports and throw an exception for the ones it doesn't?", "author": "nik9000", "createdAt": "2020-08-05T19:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NDI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NDYwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r465894605", "bodyText": "While you are here could you remove the extra (?", "author": "nik9000", "createdAt": "2020-08-05T17:40:03Z", "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -468,8 +468,12 @@ private ValuesSourceRegistry registerAggregations(List<SearchPlugin> plugins) {\n                     .setAggregatorRegistrar(GeoCentroidAggregationBuilder::registerAggregators), builder);\n         registerAggregation(new AggregationSpec(ScriptedMetricAggregationBuilder.NAME, ScriptedMetricAggregationBuilder::new,\n                 ScriptedMetricAggregationBuilder.PARSER).addResultReader(InternalScriptedMetric::new), builder);\n-        registerAggregation((new AggregationSpec(CompositeAggregationBuilder.NAME, CompositeAggregationBuilder::new,\n-                CompositeAggregationBuilder.PARSER).addResultReader(InternalComposite::new)), builder);\n+        registerAggregation(\n+            (new AggregationSpec(CompositeAggregationBuilder.NAME, CompositeAggregationBuilder::new, CompositeAggregationBuilder.PARSER)", "originalCommit": "709ee18027ada4bf0129fac20b03d2414695c811", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcf3ae9904ad7591ddcb5b826765f8728289afea", "url": "https://github.com/elastic/elasticsearch/commit/fcf3ae9904ad7591ddcb5b826765f8728289afea", "message": "Replace union with a bunch of interfaces", "committedDate": "2020-08-05T20:41:31Z", "type": "commit"}, {"oid": "617cbebca29d31f8dff4914662ab859bb6c68ca4", "url": "https://github.com/elastic/elasticsearch/commit/617cbebca29d31f8dff4914662ab859bb6c68ca4", "message": "Change key type to supplier class", "committedDate": "2020-08-05T21:56:36Z", "type": "commit"}, {"oid": "feb8f08efc4921b63af79d794aa440a47d95c9f1", "url": "https://github.com/elastic/elasticsearch/commit/feb8f08efc4921b63af79d794aa440a47d95c9f1", "message": "casting magic", "committedDate": "2020-08-05T22:20:29Z", "type": "commit"}, {"oid": "70eba12a41be3ee1ae28485d750ca8d8e53f0bcf", "url": "https://github.com/elastic/elasticsearch/commit/70eba12a41be3ee1ae28485d750ca8d8e53f0bcf", "message": "remove extra parens", "committedDate": "2020-08-05T22:21:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzODYyMA==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r466038620", "bodyText": "@nik9000 - What do you think is the right thing to throw from here?  This would be a startup-time error to plugin authors indicating that they loaded a miss-matched supplier.  Thinking about it, throwing from registration is pretty scary. If the plugin doesn't catch this, we could utterly break its whole registration process.", "author": "not-napoleon", "createdAt": "2020-08-05T22:27:00Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceRegistry.java", "diffHunk": "@@ -78,6 +85,48 @@ public void register(String aggregationName, List<ValuesSourceType> valuesSource\n             }\n         }\n \n+        /**\n+         * Register a new key generation function for the\n+         * {@link org.elasticsearch.search.aggregations.bucket.composite.CompositeAggregation}.\n+         * @param supplierClass the subclass of {@link CompositeSupplier} associated with the {@link CompositeValuesSourceBuilder} type this\n+         *                      mapping is being registered for\n+         * @param valuesSourceType the {@link ValuesSourceType} this mapping applies to\n+         * @param compositeSupplier A function returning an appropriate\n+         *                          {@link org.elasticsearch.search.aggregations.bucket.composite.CompositeValuesSourceConfig}\n+         */\n+        public void registerComposite(\n+            Class<? extends CompositeSupplier> supplierClass,\n+            ValuesSourceType valuesSourceType,\n+            CompositeSupplier compositeSupplier\n+        ) {\n+            // TODO: Assert is almost definitely wrong here, but I don't know what the right thing to throw is.\n+            assert compositeSupplier.getClass() == supplierClass;", "originalCommit": "70eba12a41be3ee1ae28485d750ca8d8e53f0bcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwODc0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r466408746", "bodyText": "public <T extend CompositeSupplier> registerComposite(Class<T> supplierClass, ValuesSourceType vst, T compositeSupplier)\n\nwould make it fail at compile time. Unless the caller does mean things with type erasure. And if they do that then the deserve all the terrible failure they'll get.", "author": "nik9000", "createdAt": "2020-08-06T13:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzODYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzOTIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r466039233", "bodyText": "@nik9000 In this model, we no longer have convenient access to the composite key type name here, so we can't throw a well formed error message.  I kind of feel like this means we should be using the CompositeValuesSourceBuilder class as the key here, since we can at least use reflection to get a name out of that.  I don't love it though.  Thoughts?", "author": "not-napoleon", "createdAt": "2020-08-05T22:28:42Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceRegistry.java", "diffHunk": "@@ -139,6 +195,21 @@ public AggregatorSupplier getAggregator(ValuesSourceConfig valuesSourceConfig, S\n         throw  new AggregationExecutionException(\"Unregistered Aggregation [\" + aggregationName + \"]\");\n     }\n \n+    public <T extends CompositeSupplier> T getComposite(Class<T> supplierClass, ValuesSourceConfig config) {\n+        if (supplierClass != null && compositeRegistry.containsKey(supplierClass)) {\n+            CompositeSupplier supplier = compositeRegistry.get(supplierClass).get(config.valueSourceType());\n+            if (supplier == null) {\n+                // TODO: Fix this error message! The class name of the supplier isn't going to mean anything to a user\n+                throw new IllegalArgumentException(\n+                    config.getDescription() + \" is not supported for composite source [\" + supplierClass.getCanonicalName() + \"]\"", "originalCommit": "70eba12a41be3ee1ae28485d750ca8d8e53f0bcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwNzM0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59648#discussion_r466407345", "bodyText": "I see what you mean. I guess you could put the nice name on the supplierClass somehow. That seems like overkill though.\nBy using the builder as the key do you mean that it'd have some Class<? extends CompositeSupplier> supplierClass method on it? Maybe that isn't too bad? Or maybe we could just pass the name of the supplier in here and declare it as \"for error messages\".", "author": "nik9000", "createdAt": "2020-08-06T13:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzOTIzMw=="}], "type": "inlineReview"}, {"oid": "7fe2ba1ae0e67ae4c6aa2dbc2b8ab5e94f6226a8", "url": "https://github.com/elastic/elasticsearch/commit/7fe2ba1ae0e67ae4c6aa2dbc2b8ab5e94f6226a8", "message": "make missmatched suppliers a compile time error", "committedDate": "2020-08-06T13:55:40Z", "type": "commit"}, {"oid": "5db9b63e83c42d580c6680f4d7a4790e6089124f", "url": "https://github.com/elastic/elasticsearch/commit/5db9b63e83c42d580c6680f4d7a4790e6089124f", "message": "add the composite name back to the registry", "committedDate": "2020-08-06T15:02:43Z", "type": "commit"}, {"oid": "9b009a42d006cf33643af406d9286aa37625d753", "url": "https://github.com/elastic/elasticsearch/commit/9b009a42d006cf33643af406d9286aa37625d753", "message": "minor cleanup", "committedDate": "2020-08-06T15:03:58Z", "type": "commit"}, {"oid": "e2fb3ef22c38f624f8798dcd5aeffe3aa212926e", "url": "https://github.com/elastic/elasticsearch/commit/e2fb3ef22c38f624f8798dcd5aeffe3aa212926e", "message": "use constant registry keys in the builders", "committedDate": "2020-08-06T15:30:23Z", "type": "commit"}]}