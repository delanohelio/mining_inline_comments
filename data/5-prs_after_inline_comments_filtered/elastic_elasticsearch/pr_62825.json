{"pr_number": 62825, "pr_title": "Fail with correct error if first backing index exists when auto creating data stream", "pr_createdAt": "2020-09-23T12:38:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62825", "timeline": [{"oid": "7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8", "url": "https://github.com/elastic/elasticsearch/commit/7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8", "message": "Fail with correct error if first backing index exists when auto creating data stream.\n\nToday if a data stream is auto created, but an index with same name as the\nfirst backing index already exists then internally that error is ignored,\nwhich then result that later in the execution of a bulk request, the\nbulk item fails due to that the data stream hasn't been auto created.\n\nThis situation can only occur if an index with same is created that\nwill be the backing index of a data stream prior to the creation\nof the data stream.", "committedDate": "2020-09-23T12:36:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYwMzc4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62825#discussion_r493603782", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ElasticsearchStatusException(\"data stream could not be created, because backing index [{}] already exists\",\n          \n          \n            \n                        throw new ElasticsearchStatusException(\"data stream could not be created because backing index [{}] already exists\",", "author": "danhermann", "createdAt": "2020-09-23T13:44:32Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -147,7 +149,15 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n             new CreateIndexClusterStateUpdateRequest(\"initialize_data_stream\", firstBackingIndexName, firstBackingIndexName)\n                 .dataStreamName(request.name)\n                 .settings(Settings.builder().put(\"index.hidden\", true).build());\n-        currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n+        try {\n+            currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n+        } catch (ResourceAlreadyExistsException e) {\n+            // Rethrow as ElasticsearchStatusException, so that bulk transport action doesn't ignore it during\n+            // auto index/data stream creation.\n+            // (otherwise bulk execution fails later, because data stream will also not have been created)\n+            throw new ElasticsearchStatusException(\"data stream could not be created, because backing index [{}] already exists\",", "originalCommit": "7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ac9e06cab0b41869070dbc6f70b1f74519bf343c", "url": "https://github.com/elastic/elasticsearch/commit/ac9e06cab0b41869070dbc6f70b1f74519bf343c", "message": "adjust wording of the exception message\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>", "committedDate": "2020-09-23T14:00:43Z", "type": "commit"}, {"oid": "a59b21c55f57b42e41c90aceb7e50da73ffb7e88", "url": "https://github.com/elastic/elasticsearch/commit/a59b21c55f57b42e41c90aceb7e50da73ffb7e88", "message": "spotless", "committedDate": "2020-09-23T14:06:28Z", "type": "commit"}, {"oid": "1b124fd4d44e77b55b7736688f8bdd235a0da861", "url": "https://github.com/elastic/elasticsearch/commit/1b124fd4d44e77b55b7736688f8bdd235a0da861", "message": "Merge remote-tracking branch 'es/master' into fail_with_descriptive_error_if_backing_index_already_exists", "committedDate": "2020-09-23T14:06:44Z", "type": "commit"}, {"oid": "fd27530d5e928011ad9a98aefd5eca3e760051b4", "url": "https://github.com/elastic/elasticsearch/commit/fd27530d5e928011ad9a98aefd5eca3e760051b4", "message": "adjust tests", "committedDate": "2020-09-23T14:30:42Z", "type": "commit"}, {"oid": "422742e99df726a9ed18e9d91a4481b3dade59b5", "url": "https://github.com/elastic/elasticsearch/commit/422742e99df726a9ed18e9d91a4481b3dade59b5", "message": "spotless", "committedDate": "2020-09-23T14:35:48Z", "type": "commit"}, {"oid": "d4496245ebb7727723ce675abd22f26f0dfe81cc", "url": "https://github.com/elastic/elasticsearch/commit/d4496245ebb7727723ce675abd22f26f0dfe81cc", "message": "Merge branch 'master' into fail_with_descriptive_error_if_backing_index_already_exists", "committedDate": "2020-09-24T08:24:35Z", "type": "commit"}, {"oid": "82818eb510f371458098d50e74418ccffc79f133", "url": "https://github.com/elastic/elasticsearch/commit/82818eb510f371458098d50e74418ccffc79f133", "message": "Merge branch 'master' into fail_with_descriptive_error_if_backing_index_already_exists", "committedDate": "2020-09-24T09:29:49Z", "type": "commit"}]}