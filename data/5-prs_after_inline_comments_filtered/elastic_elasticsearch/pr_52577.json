{"pr_number": 52577, "pr_title": "Adds recall@k metric to rank eval API", "pr_createdAt": "2020-02-20T15:46:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52577", "timeline": [{"oid": "131dad5f97aab72e7e9bb327559a4149729c643a", "url": "https://github.com/elastic/elasticsearch/commit/131dad5f97aab72e7e9bb327559a4149729c643a", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to use a new confusion matrix class to calculate top-k set-based metrics. Other metrics can be built ontop of this in addition.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-20T18:22:16Z", "type": "forcePushed"}, {"oid": "095aadc00668c634ade91230b00264e806170c18", "url": "https://github.com/elastic/elasticsearch/commit/095aadc00668c634ade91230b00264e806170c18", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to use a new confusion matrix class to calculate top-k set-based metrics. Other metrics can be built ontop of this in addition.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-20T18:42:32Z", "type": "forcePushed"}, {"oid": "678083784cbdd862d8211d02b6ccb6432d26233e", "url": "https://github.com/elastic/elasticsearch/commit/678083784cbdd862d8211d02b6ccb6432d26233e", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to use a new confusion matrix class to calculate top-k set-based metrics. Other metrics can be built ontop of this in addition.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-21T10:27:43Z", "type": "forcePushed"}, {"oid": "073163e884aaf60599ec18a501e2a35e650d62cc", "url": "https://github.com/elastic/elasticsearch/commit/073163e884aaf60599ec18a501e2a35e650d62cc", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to use a new confusion matrix class to calculate top-k set-based metrics. Other metrics can be built ontop of this in addition.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-21T17:01:38Z", "type": "forcePushed"}, {"oid": "202bfc657c8d44f4b4de8d3b2352c62105a44223", "url": "https://github.com/elastic/elasticsearch/commit/202bfc657c8d44f4b4de8d3b2352c62105a44223", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to use a new confusion matrix class to calculate top-k set-based metrics. Other metrics can be built ontop of this in addition.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-24T09:36:46Z", "type": "forcePushed"}, {"oid": "2ce3448f59e9f72157537437eef21f8795331c6f", "url": "https://github.com/elastic/elasticsearch/commit/2ce3448f59e9f72157537437eef21f8795331c6f", "message": "Removes confusion matrix abstraction in rank eval\n\nThis was added to see if it would make reasoning about set-based metrics easier. Since we only calculate precision and recall at k for now, it doesn't seem worth it. So it's been removed for now and code is comparable between precision and recall calculations.", "committedDate": "2020-02-24T14:02:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDY5NA==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383500694", "bodyText": "Small typo, changes -> changed", "author": "jtibshirani", "createdAt": "2020-02-24T20:37:58Z", "path": "modules/rank-eval/src/main/java/org/elasticsearch/index/rankeval/RecallAtK.java", "diffHunk": "@@ -0,0 +1,280 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.rankeval;\n+\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.search.SearchHit;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.OptionalInt;\n+\n+import javax.naming.directory.SearchResult;\n+\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n+import static org.elasticsearch.index.rankeval.EvaluationMetric.joinHitsWithRatings;\n+\n+/**\n+ * Metric implementing Recall@K\n+ * (https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval)#Recall).<br>\n+ * By default documents with a rating equal or bigger than 1 are considered to\n+ * be \"relevant\" for this calculation. This value can be changes using the", "originalCommit": "7670da49f4973e2a92dd7b73dc229281606c982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc1ODk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383758985", "bodyText": "Copy-paste error. I fixed this in PrecisionAtK as well.", "author": "joshdevins", "createdAt": "2020-02-25T09:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMjA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383502099", "bodyText": "I think this can be private, as well as shouldCountUnlabeled.", "author": "jtibshirani", "createdAt": "2020-02-24T20:41:04Z", "path": "modules/rank-eval/src/main/java/org/elasticsearch/index/rankeval/RecallAtK.java", "diffHunk": "@@ -0,0 +1,280 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.rankeval;\n+\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.search.SearchHit;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.OptionalInt;\n+\n+import javax.naming.directory.SearchResult;\n+\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n+import static org.elasticsearch.index.rankeval.EvaluationMetric.joinHitsWithRatings;\n+\n+/**\n+ * Metric implementing Recall@K\n+ * (https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval)#Recall).<br>\n+ * By default documents with a rating equal or bigger than 1 are considered to\n+ * be \"relevant\" for this calculation. This value can be changes using the\n+ * relevant_rating_threshold` parameter.<br>\n+ * The `k` parameter (defaults to 10) controls the search window size.\n+ */\n+public class RecallAtK implements EvaluationMetric {\n+\n+    public static final String NAME = \"recall\";\n+\n+    private static final int DEFAULT_RELEVANT_RATING_THRESHOLD = 1;\n+    private static final int DEFAULT_K = 10;\n+\n+    private static final ParseField RELEVANT_RATING_THRESHOLD_FIELD = new ParseField(\"relevant_rating_threshold\");\n+    private static final ParseField K_FIELD = new ParseField(\"k\");\n+\n+    private final int relevantRatingThreshold;\n+    private final int k;\n+\n+    /**\n+     * Metric implementing Recall@K.\n+     * @param relevantRatingThreshold\n+     *            ratings equal or above this value will be considered relevant.\n+     * @param k\n+     *            controls the window size for the search results the metric takes into account\n+     */\n+    public RecallAtK(int relevantRatingThreshold, int k) {\n+        if (relevantRatingThreshold < 0) {\n+            throw new IllegalArgumentException(\"Relevant rating threshold for precision must be positive integer.\");\n+        }\n+        if (k <= 0) {\n+            throw new IllegalArgumentException(\"Window size k must be positive.\");\n+        }\n+        this.relevantRatingThreshold = relevantRatingThreshold;\n+        this.k = k;\n+    }\n+\n+    public RecallAtK() {\n+        this(DEFAULT_RELEVANT_RATING_THRESHOLD, DEFAULT_K);\n+    }\n+\n+    RecallAtK(StreamInput in) throws IOException {\n+        this(in.readVInt(), in.readVInt());\n+    }\n+\n+    private static final ConstructingObjectParser<RecallAtK, Void> PARSER = new ConstructingObjectParser<>(NAME, args -> {\n+        Integer relevantRatingThreshold = (Integer) args[0];\n+        Integer k = (Integer) args[1];\n+        return new RecallAtK(\n+            relevantRatingThreshold == null ? DEFAULT_RELEVANT_RATING_THRESHOLD : relevantRatingThreshold,\n+            k == null ? DEFAULT_K : k);\n+    });\n+\n+    static {\n+        PARSER.declareInt(optionalConstructorArg(), RELEVANT_RATING_THRESHOLD_FIELD);\n+        PARSER.declareInt(optionalConstructorArg(), K_FIELD);\n+    }\n+\n+    public static RecallAtK fromXContent(XContentParser parser) {\n+        return PARSER.apply(parser, null);\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeVInt(getRelevantRatingThreshold());\n+        out.writeVInt(getK());\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+        builder.startObject();\n+        builder.startObject(NAME);\n+        builder.field(RELEVANT_RATING_THRESHOLD_FIELD.getPreferredName(), getRelevantRatingThreshold());\n+        builder.field(K_FIELD.getPreferredName(), getK());\n+        builder.endObject();\n+        builder.endObject();\n+        return builder;\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        return NAME;\n+    }\n+\n+    /**\n+     * Return the rating threshold above which ratings are considered to be\n+     * \"relevant\" for this metric. Defaults to 1.\n+     */\n+    public int getRelevantRatingThreshold() {\n+        return relevantRatingThreshold;\n+    }\n+\n+    /**\n+     * Binarizes a rating based on the relevant rating threshold.\n+     */\n+    boolean isRelevant(int rating) {", "originalCommit": "7670da49f4973e2a92dd7b73dc229281606c982c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMjc1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383502751", "bodyText": "Small comment, there are some inconsistencies about whether we name tests using AtK or AtFive. Maybe we could actually drop this prefix, since it's clear from the test class? Tests would just be named like testCalculation, testIgnoreOneResult, etc.", "author": "jtibshirani", "createdAt": "2020-02-24T20:42:28Z", "path": "modules/rank-eval/src/test/java/org/elasticsearch/index/rankeval/PrecisionAtKTests.java", "diffHunk": "@@ -58,7 +58,7 @@ public void testPrecisionAtFiveCalculation() {\n         assertEquals(1, ((PrecisionAtK.Detail) evaluated.getMetricDetails()).getRetrieved());\n     }\n \n-    public void testPrecisionAtFiveIgnoreOneResult() {\n+    public void testPrecisionAtKIgnoreOneResult() {", "originalCommit": "7670da49f4973e2a92dd7b73dc229281606c982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc2MzczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383763731", "bodyText": "I was trying to improve the test names in PrecisionAtK which I found not clear between the test/method name and the details of the test. I added the AtFive when the test was specifically not using the default k since it better describes the test case. I'm happy to drop all those though and simplify the names though, it looks much simpler that way!", "author": "joshdevins", "createdAt": "2020-02-25T09:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMjc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTQ2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383505461", "bodyText": "I think we should also update the createTestItem method in this class to make sure we include a random RecallAtK object.", "author": "jtibshirani", "createdAt": "2020-02-24T20:48:09Z", "path": "modules/rank-eval/src/test/java/org/elasticsearch/index/rankeval/RankEvalSpecTests.java", "diffHunk": "@@ -149,6 +149,7 @@ private static RankEvalSpec copy(RankEvalSpec original) throws IOException {\n         List<NamedWriteableRegistry.Entry> namedWriteables = new ArrayList<>();\n         namedWriteables.add(new NamedWriteableRegistry.Entry(QueryBuilder.class, MatchAllQueryBuilder.NAME, MatchAllQueryBuilder::new));\n         namedWriteables.add(new NamedWriteableRegistry.Entry(EvaluationMetric.class, PrecisionAtK.NAME, PrecisionAtK::new));\n+        namedWriteables.add(new NamedWriteableRegistry.Entry(EvaluationMetric.class, RecallAtK.NAME, RecallAtK::new));", "originalCommit": "7670da49f4973e2a92dd7b73dc229281606c982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc2NzA2NA==", "url": "https://github.com/elastic/elasticsearch/pull/52577#discussion_r383767064", "bodyText": "Oops, missed this. Thanks! I think I did it correctly, check the next commit and let me know.", "author": "joshdevins", "createdAt": "2020-02-25T09:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTQ2MQ=="}], "type": "inlineReview"}, {"oid": "9f7db8f79511e51f692a611ddeb4d8c9e92a8b6a", "url": "https://github.com/elastic/elasticsearch/commit/9f7db8f79511e51f692a611ddeb4d8c9e92a8b6a", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to match\nthe new metric.\n\nRecall@k is an important metric to use for learning to rank (LTR)\nuse-cases. Candidate generation or first ranking phase ranking functions\nare often optimized for high recall, in order to generate as many\nrelevant candidates in the top-k as possible for a second phase of\nranking. Adding this metric allows tuning that base query for LTR.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-26T10:27:49Z", "type": "commit"}, {"oid": "9f7db8f79511e51f692a611ddeb4d8c9e92a8b6a", "url": "https://github.com/elastic/elasticsearch/commit/9f7db8f79511e51f692a611ddeb4d8c9e92a8b6a", "message": "Adds recall@k metric to rank eval API\n\nThis change adds the recall@k metric and refactors precision@k to match\nthe new metric.\n\nRecall@k is an important metric to use for learning to rank (LTR)\nuse-cases. Candidate generation or first ranking phase ranking functions\nare often optimized for high recall, in order to generate as many\nrelevant candidates in the top-k as possible for a second phase of\nranking. Adding this metric allows tuning that base query for LTR.\n\nSee: https://github.com/elastic/elasticsearch/issues/51676", "committedDate": "2020-02-26T10:27:49Z", "type": "forcePushed"}, {"oid": "a6f0027c7634aeb63ba016b4ffb7a12fb8e19cd1", "url": "https://github.com/elastic/elasticsearch/commit/a6f0027c7634aeb63ba016b4ffb7a12fb8e19cd1", "message": "Fixes a docs typo from copy-paste", "committedDate": "2020-02-26T17:06:28Z", "type": "commit"}]}