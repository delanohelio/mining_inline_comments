{"pr_number": 53562, "pr_title": "Create new `geo` module and migrate geo_shape registration", "pr_createdAt": "2020-03-13T20:23:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53562", "timeline": [{"oid": "aab920f48cfb83fa9b61190845d35a72dc081c8b", "url": "https://github.com/elastic/elasticsearch/commit/aab920f48cfb83fa9b61190845d35a72dc081c8b", "message": "Create new spatial-extras module and migrate geo_shape registration\n\nThis commit introduces a new spatial-extras module that is intended\nto be contain all the geo-spatial-specific features in server.\n\nAs a first step, the responsibility of registering the geo_shape\nfield mapper is moved to this module.", "committedDate": "2020-03-13T20:19:45Z", "type": "commit"}, {"oid": "fe11a26684d2e834877eaa3aca7e51dac3501384", "url": "https://github.com/elastic/elasticsearch/commit/fe11a26684d2e834877eaa3aca7e51dac3501384", "message": "cover more test cases and take ownership of exists yaml tests", "committedDate": "2020-03-13T20:43:38Z", "type": "commit"}, {"oid": "fae51f52ba2fe002e63820b9f633857601c22133", "url": "https://github.com/elastic/elasticsearch/commit/fae51f52ba2fe002e63820b9f633857601c22133", "message": "more tests", "committedDate": "2020-03-13T21:06:31Z", "type": "commit"}, {"oid": "e7d8efdc0820259dd987792b71f718721426b36c", "url": "https://github.com/elastic/elasticsearch/commit/e7d8efdc0820259dd987792b71f718721426b36c", "message": "more fixes", "committedDate": "2020-03-13T22:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMzA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392513097", "bodyText": "I think there is room to pull the TestGeoShapeFieldMapperPlugin to the parent test class and inherited by those that need it or need to extend to include more plugins. I could see it stay either way since it is fairly low impact and the dependency is expected to go away", "author": "talevy", "createdAt": "2020-03-13T22:27:19Z", "path": "modules/mapper-extras/src/test/java/org/elasticsearch/index/query/RankFeatureQueryBuilderTests.java", "diffHunk": "@@ -52,7 +52,7 @@ protected void initializeAdditionalMappings(MapperService mapperService) throws\n \n     @Override\n     protected Collection<Class<? extends Plugin>> getPlugins() {\n-        return Collections.singleton(MapperExtrasPlugin.class);\n+        return List.of(MapperExtrasPlugin.class, TestGeoShapeFieldMapperPlugin.class);", "originalCommit": "e7d8efdc0820259dd987792b71f718721426b36c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff1024d1acd96c4a17a628b83fd604ffe8cb67ac", "url": "https://github.com/elastic/elasticsearch/commit/ff1024d1acd96c4a17a628b83fd604ffe8cb67ac", "message": "fix enrich test", "committedDate": "2020-03-13T22:38:03Z", "type": "commit"}, {"oid": "99d4240eb9b54ad7afd360db78a30c5c183a81d9", "url": "https://github.com/elastic/elasticsearch/commit/99d4240eb9b54ad7afd360db78a30c5c183a81d9", "message": "add empty unit tests", "committedDate": "2020-03-13T22:43:55Z", "type": "commit"}, {"oid": "3d9fb1227a1a21544454bb811f1de39fa7ba5a45", "url": "https://github.com/elastic/elasticsearch/commit/3d9fb1227a1a21544454bb811f1de39fa7ba5a45", "message": "add license header", "committedDate": "2020-03-13T22:44:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxODY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392518658", "bodyText": "Why changing to these newer methods? It will make backporting more difficult and should probably be done separately if we want to clean this up in master.", "author": "rjernst", "createdAt": "2020-03-13T22:50:09Z", "path": "modules/mapper-extras/src/test/java/org/elasticsearch/index/query/RankFeatureQueryBuilderTests.java", "diffHunk": "@@ -52,7 +52,7 @@ protected void initializeAdditionalMappings(MapperService mapperService) throws\n \n     @Override\n     protected Collection<Class<? extends Plugin>> getPlugins() {\n-        return Collections.singleton(MapperExtrasPlugin.class);\n+        return List.of(MapperExtrasPlugin.class, TestGeoShapeFieldMapperPlugin.class);", "originalCommit": "3d9fb1227a1a21544454bb811f1de39fa7ba5a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxODk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392518988", "bodyText": "This also seems like it at least warrants a followup issue for cleanup. I don't see why we should need geo mappers inside tests of all these other modules?", "author": "rjernst", "createdAt": "2020-03-13T22:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxODY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNTA0MA==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392525040", "bodyText": "++", "author": "talevy", "createdAt": "2020-03-13T23:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxODY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392519689", "bodyText": "You can do this in a single line with Collections.singletonMap", "author": "rjernst", "createdAt": "2020-03-13T22:54:36Z", "path": "modules/spatial-extras/src/main/java/org/elasticsearch/spatial/SpatialExtrasPlugin.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.spatial;\n+\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoShapeFieldMapper;\n+import org.elasticsearch.index.mapper.Mapper;\n+import org.elasticsearch.plugins.MapperPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+public class SpatialExtrasPlugin extends Plugin implements MapperPlugin {\n+\n+    @Override\n+    public Map<String, Mapper.TypeParser> getMappers() {\n+        Map<String, Mapper.TypeParser> mappers = new LinkedHashMap<>();\n+        mappers.put(GeoShapeFieldMapper.CONTENT_TYPE, new AbstractGeometryFieldMapper.TypeParser());\n+        return Collections.unmodifiableMap(mappers);", "originalCommit": "3d9fb1227a1a21544454bb811f1de39fa7ba5a45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNTE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53562#discussion_r392525169", "bodyText": "thought about it, but wanted to make sure the tests passed first", "author": "talevy", "createdAt": "2020-03-13T23:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTY4OQ=="}], "type": "inlineReview"}, {"oid": "136a2cf2e7351b30c54d35cd68422293da2996aa", "url": "https://github.com/elastic/elasticsearch/commit/136a2cf2e7351b30c54d35cd68422293da2996aa", "message": "moar", "committedDate": "2020-03-13T23:21:37Z", "type": "commit"}, {"oid": "d7f2279943a71b176efad56bc274ce48ffd54fa9", "url": "https://github.com/elastic/elasticsearch/commit/d7f2279943a71b176efad56bc274ce48ffd54fa9", "message": "singletonmap", "committedDate": "2020-03-13T23:25:05Z", "type": "commit"}, {"oid": "ad4a4bdd1f1cb7a3b6e33cdb4b289d22992c2a96", "url": "https://github.com/elastic/elasticsearch/commit/ad4a4bdd1f1cb7a3b6e33cdb4b289d22992c2a96", "message": "List.of -> Arrays.asList", "committedDate": "2020-03-13T23:44:40Z", "type": "commit"}, {"oid": "c954df7df5a5c502960e9330bfa9a3b36d3a8d3d", "url": "https://github.com/elastic/elasticsearch/commit/c954df7df5a5c502960e9330bfa9a3b36d3a8d3d", "message": "refactor spatial-extras to geo", "committedDate": "2020-03-18T20:17:12Z", "type": "commit"}, {"oid": "f6d68f61eb857c81491928b80f26bbc9094ec787", "url": "https://github.com/elastic/elasticsearch/commit/f6d68f61eb857c81491928b80f26bbc9094ec787", "message": "Merge branch 'master' into spatial-extras", "committedDate": "2020-03-18T20:25:53Z", "type": "commit"}, {"oid": "3daf04645b39dacf408bd97b0198266154726864", "url": "https://github.com/elastic/elasticsearch/commit/3daf04645b39dacf408bd97b0198266154726864", "message": "spotless apply", "committedDate": "2020-03-18T20:28:40Z", "type": "commit"}, {"oid": "e45d92c30c797aec328adc3017d636e015000f9f", "url": "https://github.com/elastic/elasticsearch/commit/e45d92c30c797aec328adc3017d636e015000f9f", "message": "added TestGeoShapeFieldMapperPlugin to PinnedQueryBuilderTests", "committedDate": "2020-03-23T20:10:19Z", "type": "commit"}, {"oid": "e93f6a0b6ffb7a7a22aa20dfd4fc441486a56ebe", "url": "https://github.com/elastic/elasticsearch/commit/e93f6a0b6ffb7a7a22aa20dfd4fc441486a56ebe", "message": "Merge remote-tracking branch 'elastic/master' into spatial-extras", "committedDate": "2020-03-31T22:53:56Z", "type": "commit"}, {"oid": "4329d0e5c5d9781e6697cefef10376e5f3708b0d", "url": "https://github.com/elastic/elasticsearch/commit/4329d0e5c5d9781e6697cefef10376e5f3708b0d", "message": "fix checkstyle", "committedDate": "2020-03-31T23:10:32Z", "type": "commit"}, {"oid": "40ce9d7335f27c709a23e81e2750546f18836bfd", "url": "https://github.com/elastic/elasticsearch/commit/40ce9d7335f27c709a23e81e2750546f18836bfd", "message": "fix percolator query test", "committedDate": "2020-03-31T23:41:54Z", "type": "commit"}, {"oid": "508b17504e9a621ad866eec5d91b63c80b770675", "url": "https://github.com/elastic/elasticsearch/commit/508b17504e9a621ad866eec5d91b63c80b770675", "message": "Merge remote-tracking branch 'elastic/master' into spatial-extras", "committedDate": "2020-04-01T21:42:07Z", "type": "commit"}, {"oid": "64c0bea9caccbc6e5929e64ad5002ab295cae21e", "url": "https://github.com/elastic/elasticsearch/commit/64c0bea9caccbc6e5929e64ad5002ab295cae21e", "message": "try to make Percolator test happy", "committedDate": "2020-04-01T23:40:37Z", "type": "commit"}, {"oid": "558d32df3250300df50869c7d167bf5e988db61c", "url": "https://github.com/elastic/elasticsearch/commit/558d32df3250300df50869c7d167bf5e988db61c", "message": "make gradle happy", "committedDate": "2020-04-02T01:00:13Z", "type": "commit"}, {"oid": "252d8e101e15f5e54f1e82e553f9f3abb5c15144", "url": "https://github.com/elastic/elasticsearch/commit/252d8e101e15f5e54f1e82e553f9f3abb5c15144", "message": "fix ShapeQueryBuilderTests", "committedDate": "2020-04-02T02:25:45Z", "type": "commit"}, {"oid": "4ccb497ba4e99e01a9ef901fefea5831aef4fba5", "url": "https://github.com/elastic/elasticsearch/commit/4ccb497ba4e99e01a9ef901fefea5831aef4fba5", "message": "no client-only nodes in percolator tests", "committedDate": "2020-04-02T20:27:25Z", "type": "commit"}, {"oid": "dbc9414d5a6a6300061df8eab6c52aa120e669ba", "url": "https://github.com/elastic/elasticsearch/commit/dbc9414d5a6a6300061df8eab6c52aa120e669ba", "message": "Merge remote-tracking branch 'elastic/master' into spatial-extras", "committedDate": "2020-04-02T21:19:37Z", "type": "commit"}, {"oid": "f1a4136d2bbe36461cfdd5484dc41f6d67657623", "url": "https://github.com/elastic/elasticsearch/commit/f1a4136d2bbe36461cfdd5484dc41f6d67657623", "message": "stop using smile in percolator test, no valid UTF8", "committedDate": "2020-04-03T17:15:51Z", "type": "commit"}, {"oid": "61f2b1357b3978eab337f6c24934dd18fa79b81f", "url": "https://github.com/elastic/elasticsearch/commit/61f2b1357b3978eab337f6c24934dd18fa79b81f", "message": "fix unsused imports", "committedDate": "2020-04-03T18:17:27Z", "type": "commit"}, {"oid": "917e538c2fec840430e841fba1a15b82e35aa0c2", "url": "https://github.com/elastic/elasticsearch/commit/917e538c2fec840430e841fba1a15b82e35aa0c2", "message": "Merge remote-tracking branch 'elastic/master' into spatial-extras", "committedDate": "2020-04-03T19:31:08Z", "type": "commit"}, {"oid": "be57a8051aae866d9aa195d9c89036e37720c17d", "url": "https://github.com/elastic/elasticsearch/commit/be57a8051aae866d9aa195d9c89036e37720c17d", "message": "Merge remote-tracking branch 'elastic/master' into spatial-extras", "committedDate": "2020-04-07T17:19:50Z", "type": "commit"}]}