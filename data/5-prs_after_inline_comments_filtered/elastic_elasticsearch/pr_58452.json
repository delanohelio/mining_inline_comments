{"pr_number": 58452, "pr_title": "Validate that REST API names do not contain keywords", "pr_createdAt": "2020-06-23T15:47:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58452", "timeline": [{"oid": "0c63c724dd5404a232e5eddf4cc14770e286b85d", "url": "https://github.com/elastic/elasticsearch/commit/0c63c724dd5404a232e5eddf4cc14770e286b85d", "message": "Validate REST API names do not contain keywords\n\nIf an API name (or components of a name) overlaps with a reserved word\nin the programming language for an ES client, then its possible for code\nthat is generated from the API will not compile. This change adds\nvalidation to check for such overlaps.", "committedDate": "2020-06-23T15:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4NjA4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58452#discussion_r444486085", "bodyText": "Although I guess this \"builder\" type pattern of chaining dependsOn works, I find it a bit odd. Just to placate my neurosis let's just do dependsOn(validateRestSpecTask, validateNoKeywordsTask) as I just find it easier to grok what's happening using the vararg method.", "author": "mark-vieira", "createdAt": "2020-06-23T20:25:40Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ValidateRestSpecPlugin.java", "diffHunk": "@@ -39,6 +39,16 @@ public void apply(Project project) {\n                 }));\n                 task.setJsonSchema(new File(project.getRootDir(), \"rest-api-spec/src/main/resources/schema.json\"));\n             });\n-        project.getTasks().named(\"precommit\").configure(t -> t.dependsOn(validateRestSpecTask));\n+\n+        Provider<ValidateJsonNoKeywordsTask> validateNoKeywordsTask = project.getTasks()\n+            .register(\"validateNoKeywords\", ValidateJsonNoKeywordsTask.class, task -> {\n+                task.setInputFiles(Util.getJavaTestAndMainSourceResources(project, filter -> {\n+                    filter.include(DOUBLE_STAR + \"/rest-api-spec/api/\" + DOUBLE_STAR + \"/*.json\");\n+                    filter.exclude(DOUBLE_STAR + \"/_common.json\");\n+                }));\n+                task.setJsonKeywords(new File(project.getRootDir(), \"rest-api-spec/src/main/resources/keywords.json\"));\n+            });\n+\n+        project.getTasks().named(\"precommit\").configure(t -> t.dependsOn(validateRestSpecTask).dependsOn(validateNoKeywordsTask));", "originalCommit": "0c63c724dd5404a232e5eddf4cc14770e286b85d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4NjYyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/58452#discussion_r444486625", "bodyText": "FYI, new File(project.getRootDir(), ...) can simply be replaced by project.file(\"rest-api-spec/src/main/resources/keywords.json\".", "author": "mark-vieira", "createdAt": "2020-06-23T20:26:46Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ValidateRestSpecPlugin.java", "diffHunk": "@@ -39,6 +39,16 @@ public void apply(Project project) {\n                 }));\n                 task.setJsonSchema(new File(project.getRootDir(), \"rest-api-spec/src/main/resources/schema.json\"));\n             });\n-        project.getTasks().named(\"precommit\").configure(t -> t.dependsOn(validateRestSpecTask));\n+\n+        Provider<ValidateJsonNoKeywordsTask> validateNoKeywordsTask = project.getTasks()\n+            .register(\"validateNoKeywords\", ValidateJsonNoKeywordsTask.class, task -> {\n+                task.setInputFiles(Util.getJavaTestAndMainSourceResources(project, filter -> {\n+                    filter.include(DOUBLE_STAR + \"/rest-api-spec/api/\" + DOUBLE_STAR + \"/*.json\");\n+                    filter.exclude(DOUBLE_STAR + \"/_common.json\");\n+                }));\n+                task.setJsonKeywords(new File(project.getRootDir(), \"rest-api-spec/src/main/resources/keywords.json\"));", "originalCommit": "0c63c724dd5404a232e5eddf4cc14770e286b85d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MDE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/58452#discussion_r444490148", "bodyText": "I wonder if it makes sense to add an mustRunAfter ordering rule so that we run this after validating the schema. Essentially, if the spec format is busted we are likely to have issues running this task.", "author": "mark-vieira", "createdAt": "2020-06-23T20:33:45Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ValidateRestSpecPlugin.java", "diffHunk": "@@ -39,6 +39,16 @@ public void apply(Project project) {\n                 }));\n                 task.setJsonSchema(new File(project.getRootDir(), \"rest-api-spec/src/main/resources/schema.json\"));\n             });\n-        project.getTasks().named(\"precommit\").configure(t -> t.dependsOn(validateRestSpecTask));\n+\n+        Provider<ValidateJsonNoKeywordsTask> validateNoKeywordsTask = project.getTasks()\n+            .register(\"validateNoKeywords\", ValidateJsonNoKeywordsTask.class, task -> {\n+                task.setInputFiles(Util.getJavaTestAndMainSourceResources(project, filter -> {", "originalCommit": "0c63c724dd5404a232e5eddf4cc14770e286b85d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MTU5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58452#discussion_r444491597", "bodyText": "Let's add a setter for this and set the default value in the plugin.", "author": "mark-vieira", "createdAt": "2020-06-23T20:36:41Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ValidateJsonNoKeywordsTask.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.precommit;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.file.FileCollection;\n+import org.gradle.api.tasks.InputFile;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputFile;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.work.ChangeType;\n+import org.gradle.work.Incremental;\n+import org.gradle.work.InputChanges;\n+\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.LinkedHashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.StreamSupport;\n+\n+/**\n+ * Incremental task to validate that the API names in set of JSON files do not contain\n+ * programming language keywords.\n+ * <p>\n+ * The keywords are defined in a JSON file, although it's worth noting that what is and isn't a\n+ * keyword depends on the language and sometimes the context in which a keyword is used. For example,\n+ * `delete` is an operator in JavaScript, but it isn't in the keywords list for JavaScript or\n+ * TypeScript because it's OK to use `delete` as a method name.\n+ */\n+public class ValidateJsonNoKeywordsTask extends DefaultTask {\n+\n+    private final ObjectMapper mapper = new ObjectMapper().configure(JsonParser.Feature.ALLOW_COMMENTS, true);\n+    private File jsonKeywords;\n+    private FileCollection inputFiles;\n+\n+    @Incremental\n+    @InputFiles\n+    public FileCollection getInputFiles() {\n+        return inputFiles;\n+    }\n+\n+    public void setInputFiles(FileCollection inputFiles) {\n+        this.inputFiles = inputFiles;\n+    }\n+\n+    @InputFile\n+    public File getJsonKeywords() {\n+        return jsonKeywords;\n+    }\n+\n+    public void setJsonKeywords(File jsonKeywords) {\n+        this.jsonKeywords = jsonKeywords;\n+    }\n+\n+    @OutputFile\n+    public File getReport() {", "originalCommit": "0c63c724dd5404a232e5eddf4cc14770e286b85d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "17126fd5fa0cea08c27fc67e7b41fc381786e985", "url": "https://github.com/elastic/elasticsearch/commit/17126fd5fa0cea08c27fc67e7b41fc381786e985", "message": "Address review feedback", "committedDate": "2020-06-24T09:12:22Z", "type": "commit"}, {"oid": "f565d9d1682c0ff1b1d3c50bb814b3fa06d55cc8", "url": "https://github.com/elastic/elasticsearch/commit/f565d9d1682c0ff1b1d3c50bb814b3fa06d55cc8", "message": "Fix running validate-rest-spec for other projects", "committedDate": "2020-06-24T20:24:38Z", "type": "commit"}, {"oid": "a9da5f05c1c798fc11703c30273ece6efd84f03a", "url": "https://github.com/elastic/elasticsearch/commit/a9da5f05c1c798fc11703c30273ece6efd84f03a", "message": "Another fix", "committedDate": "2020-06-24T20:54:18Z", "type": "commit"}]}