{"pr_number": 51130, "pr_title": "Expose master timeout for ILM actions", "pr_createdAt": "2020-01-16T20:48:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51130", "timeline": [{"oid": "b5a80cf19beca2e89dbc17bb811cba5f672d49cd", "url": "https://github.com/elastic/elasticsearch/commit/b5a80cf19beca2e89dbc17bb811cba5f672d49cd", "message": "Master timeout in ILM actions", "committedDate": "2020-01-08T22:04:52Z", "type": "commit"}, {"oid": "9b229119797efc66723089951703af8753dac5c7", "url": "https://github.com/elastic/elasticsearch/commit/9b229119797efc66723089951703af8753dac5c7", "message": "Tests", "committedDate": "2020-01-13T22:36:23Z", "type": "commit"}, {"oid": "4823366bc1a6202b929e0dc8a15b606d529db3d9", "url": "https://github.com/elastic/elasticsearch/commit/4823366bc1a6202b929e0dc8a15b606d529db3d9", "message": "Merge remote-tracking branch 'origin/master' into ilm-master-timeout", "committedDate": "2020-01-14T21:24:38Z", "type": "commit"}, {"oid": "f93a9099dc4e1dd616b1027c18ed2bd92521d909", "url": "https://github.com/elastic/elasticsearch/commit/f93a9099dc4e1dd616b1027c18ed2bd92521d909", "message": "Additional tests/refactoring", "committedDate": "2020-01-15T12:21:02Z", "type": "commit"}, {"oid": "7bd6d9a8c8dd9352398b3b740b965def1327b179", "url": "https://github.com/elastic/elasticsearch/commit/7bd6d9a8c8dd9352398b3b740b965def1327b179", "message": "Spelling fix", "committedDate": "2020-01-15T12:33:48Z", "type": "commit"}, {"oid": "6b63fcca5355fd9c175785697074a8e8aed0ec38", "url": "https://github.com/elastic/elasticsearch/commit/6b63fcca5355fd9c175785697074a8e8aed0ec38", "message": "Moved setting to LifecycleSettings", "committedDate": "2020-01-16T20:36:31Z", "type": "commit"}, {"oid": "5540736da148514725cab163c77b873159a0eb64", "url": "https://github.com/elastic/elasticsearch/commit/5540736da148514725cab163c77b873159a0eb64", "message": "Changed evaluateCondition method", "committedDate": "2020-01-16T20:48:19Z", "type": "commit"}, {"oid": "9d3c67f65d76ebb3231a735f7b716dbf81996f95", "url": "https://github.com/elastic/elasticsearch/commit/9d3c67f65d76ebb3231a735f7b716dbf81996f95", "message": "Unused imports removed", "committedDate": "2020-01-16T21:11:23Z", "type": "commit"}, {"oid": "9bcf64b35b099f9b8721881ce3c80cf10063a8dc", "url": "https://github.com/elastic/elasticsearch/commit/9bcf64b35b099f9b8721881ce3c80cf10063a8dc", "message": "Compilation fixed", "committedDate": "2020-01-16T21:37:59Z", "type": "commit"}, {"oid": "264f5a4ad9e7e8c198c34521aec2999afe2d9fea", "url": "https://github.com/elastic/elasticsearch/commit/264f5a4ad9e7e8c198c34521aec2999afe2d9fea", "message": "Unused imports removed", "committedDate": "2020-01-16T22:12:47Z", "type": "commit"}, {"oid": "55fbd4cfe088dbd26dae178c18a73c203a9e78c8", "url": "https://github.com/elastic/elasticsearch/commit/55fbd4cfe088dbd26dae178c18a73c203a9e78c8", "message": "Test fix", "committedDate": "2020-01-16T22:38:56Z", "type": "commit"}, {"oid": "090b6b470982040fc29a4fd701d5a221260d6939", "url": "https://github.com/elastic/elasticsearch/commit/090b6b470982040fc29a4fd701d5a221260d6939", "message": "Merge branch 'master' into ilm-master-timeout", "committedDate": "2020-01-16T22:59:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MTM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r367851394", "bodyText": "Could we call the listener here directly? ie. listener.onFailure(new UnsupportedOperationException())", "author": "andreidan", "createdAt": "2020-01-17T09:52:59Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/AsyncWaitStep.java", "diffHunk": "@@ -28,11 +29,21 @@ protected Client getClient() {\n         return client;\n     }\n \n-    public abstract void evaluateCondition(IndexMetaData indexMetaData, Listener listener);\n+    public void evaluateCondition(Settings settings, IndexMetaData indexMetaData, Listener listener){\n+        evaluateCondition(indexMetaData, listener);\n+    }\n+\n+    public void evaluateCondition(IndexMetaData indexMetaData, Listener listener){\n+        try {\n+            throw new UnsupportedOperationException();\n+        } catch (UnsupportedOperationException e) {\n+            listener.onFailure(e);\n+        }", "originalCommit": "090b6b470982040fc29a4fd701d5a221260d6939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NzgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r367857816", "bodyText": "On second thought, would it make sense to have only one method? ie. add the Settings as parameter? Or even more, maybe pass the timeout directly (as currently that's the only reason we want to modify this signature) ?", "author": "andreidan", "createdAt": "2020-01-17T10:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1ODM0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368158349", "bodyText": "I think it would make more sense to change the single, abstract, method. We should be able to pass in the Settings where necessary and just ignore them on the steps that don't need them.", "author": "dakrone", "createdAt": "2020-01-17T22:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MTM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzMzY3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368933677", "bodyText": "I didn't want to change classes that don't need timeout and this parameter is useless for them. But you are right that this is messy, I refectored it back to single abstract method with TimeValue masterTimeout parameter as suggested by @andreidan", "author": "probakowski", "createdAt": "2020-01-21T10:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MTM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MzkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r367853905", "bodyText": "We don't work with null cluster states so I think this null check could be dropped. Or is there a particular case where a null ClusterState is passed in?", "author": "andreidan", "createdAt": "2020-01-17T09:58:20Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/Step.java", "diffHunk": "@@ -60,14 +64,21 @@ public boolean equals(Object obj) {\n         }\n         Step other = (Step) obj;\n         return Objects.equals(key, other.key) &&\n-                Objects.equals(nextStepKey, other.nextStepKey);\n+            Objects.equals(nextStepKey, other.nextStepKey);\n     }\n \n     @Override\n     public String toString() {\n         return key + \" => \" + nextStepKey;\n     }\n \n+    protected TimeValue getMasterTimeout(ClusterState clusterState){\n+        if(clusterState == null){", "originalCommit": "090b6b470982040fc29a4fd701d5a221260d6939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1ODg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368158846", "bodyText": "I think this should be Objects.requireNonNull(clusterState, \"cannot determine master timeout when cluster state is null\");, even though I agree and think it won't be possible (could still be possible if someone invokes it incorrectly)", "author": "dakrone", "createdAt": "2020-01-17T22:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MzkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNDIwNg==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368934206", "bodyText": "null cluster states were used by multiple tests, I've fixed them to use empty/minimal cluster state instead and method use Objects.requireNonNull now", "author": "probakowski", "createdAt": "2020-01-21T10:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MzkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1OTA3MA==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368159070", "bodyText": "This method can be static", "author": "dakrone", "createdAt": "2020-01-17T22:17:04Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/Step.java", "diffHunk": "@@ -60,14 +64,21 @@ public boolean equals(Object obj) {\n         }\n         Step other = (Step) obj;\n         return Objects.equals(key, other.key) &&\n-                Objects.equals(nextStepKey, other.nextStepKey);\n+            Objects.equals(nextStepKey, other.nextStepKey);\n     }\n \n     @Override\n     public String toString() {\n         return key + \" => \" + nextStepKey;\n     }\n \n+    protected TimeValue getMasterTimeout(ClusterState clusterState){", "originalCommit": "090b6b470982040fc29a4fd701d5a221260d6939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNDQ1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368934455", "bodyText": "You're right, changed", "author": "probakowski", "createdAt": "2020-01-21T10:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1OTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1OTgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368159800", "bodyText": "can this use the getMasterTimeout method instead?", "author": "dakrone", "createdAt": "2020-01-17T22:19:32Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/WaitForRolloverReadyStep.java", "diffHunk": "@@ -113,7 +119,8 @@ public void evaluateCondition(IndexMetaData indexMetaData, Listener listener) {\n                 \"index [%s] is not the write index for alias [%s]\", indexMetaData.getIndex().getName(), rolloverAlias)));\n         }\n \n-        RolloverRequest rolloverRequest = new RolloverRequest(rolloverAlias, null);\n+        RolloverRequest rolloverRequest = new RolloverRequest(rolloverAlias, null)\n+            .masterNodeTimeout(LifecycleSettings.LIFECYCLE_STEP_MASTER_TIMEOUT_SETTING.get(settings));", "originalCommit": "090b6b470982040fc29a4fd701d5a221260d6939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNDg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368934871", "bodyText": "I pass now timeout value directly from caller (which uses getMasterTimeout", "author": "probakowski", "createdAt": "2020-01-21T10:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE1OTgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368164132", "bodyText": "I think we can do all this without mocking. I think by subclassing NoOpClient to check the executed request's master node timeout we can essentially do this check. I think this will be cleaner and less likely to break in the future than mocks.", "author": "dakrone", "createdAt": "2020-01-17T22:34:54Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/AbstractStepMasterTimeoutTestCase.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ilm;\n+\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.client.AdminClient;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.IndicesAdminClient;\n+import org.elasticsearch.cluster.ClusterName;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.metadata.IndexMetaData;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.junit.Before;\n+import org.mockito.Mockito;\n+import org.mockito.stubbing.Stubber;\n+\n+import static org.elasticsearch.xpack.core.ilm.LifecycleSettings.LIFECYCLE_STEP_MASTER_TIMEOUT;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public abstract class AbstractStepMasterTimeoutTestCase<T extends AsyncActionStep> extends AbstractStepTestCase<T> {\n+\n+    protected Client client;\n+    protected AdminClient adminClient;\n+    protected IndicesAdminClient indicesClient;\n+\n+    @Before\n+    public void setup() {\n+        client = Mockito.mock(Client.class);\n+        adminClient = Mockito.mock(AdminClient.class);\n+        Mockito.when(client.admin()).thenReturn(adminClient);\n+        indicesClient = Mockito.mock(IndicesAdminClient.class);\n+        Mockito.when(adminClient.indices()).thenReturn(indicesClient);\n+    }\n+\n+    public void testMasterTimeout() {\n+        checkMasterTimeout(TimeValue.timeValueSeconds(30),\n+            ClusterState.builder(ClusterName.DEFAULT).metaData(MetaData.builder().build()).build());\n+        checkMasterTimeout(TimeValue.timeValueSeconds(10),\n+            ClusterState.builder(ClusterName.DEFAULT)\n+                .metaData(MetaData.builder()\n+                    .persistentSettings(Settings.builder().put(LIFECYCLE_STEP_MASTER_TIMEOUT, \"10s\").build())\n+                    .build())\n+                .build());\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    private void checkMasterTimeout(TimeValue timeValue, ClusterState currentClusterState) {\n+        IndexMetaData indexMetadata = getIndexMetaData();\n+\n+        Stubber checkTimeout = Mockito.doAnswer(invocation -> {", "originalCommit": "090b6b470982040fc29a4fd701d5a221260d6939", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkzNTExNg==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368935116", "bodyText": "Yes, this is much better idea, changed", "author": "probakowski", "createdAt": "2020-01-21T10:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDEzMg=="}], "type": "inlineReview"}, {"oid": "7cc4dc5cc8b6c8e74898652a60434ebd013b67cf", "url": "https://github.com/elastic/elasticsearch/commit/7cc4dc5cc8b6c8e74898652a60434ebd013b67cf", "message": "PR review comments", "committedDate": "2020-01-20T22:48:44Z", "type": "commit"}, {"oid": "e2be19695280d9de1cc312fc8a946bc9d6f09483", "url": "https://github.com/elastic/elasticsearch/commit/e2be19695280d9de1cc312fc8a946bc9d6f09483", "message": "PR review comments", "committedDate": "2020-01-21T10:50:13Z", "type": "commit"}, {"oid": "2be49726e8717d4a53e5779f71a5ef5bfa603796", "url": "https://github.com/elastic/elasticsearch/commit/2be49726e8717d4a53e5779f71a5ef5bfa603796", "message": "Unused imports removed", "committedDate": "2020-01-21T11:02:12Z", "type": "commit"}, {"oid": "4d16cd68d9e44c1fa28e3ee9def7620b72d48d41", "url": "https://github.com/elastic/elasticsearch/commit/4d16cd68d9e44c1fa28e3ee9def7620b72d48d41", "message": "Merge branch 'master' into ilm-master-timeout", "committedDate": "2020-01-21T11:29:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5OTE0NA==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r368999144", "bodyText": "Most subclasses already shadow these mockings/instances in the tests where they are applicable. I think this base class should not attempt to instantiate more than it uses/templates (ie. ThreadPool) and if we decide to centralise all the mocks/stubs in the base class I think we should remove the re-declaration from the tests (eg. OpenFollowerIndexStepTests, RolloverStepTests etc). I think that could be a follow-up PR to reduce the scope of this one, so I propose we remove the mocks/stubs from the base class for now.\nWhat do you think?", "author": "andreidan", "createdAt": "2020-01-21T13:28:58Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/AbstractStepMasterTimeoutTestCase.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ilm;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.client.AdminClient;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.IndicesAdminClient;\n+import org.elasticsearch.cluster.ClusterName;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.metadata.IndexMetaData;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.test.client.NoOpClient;\n+import org.elasticsearch.threadpool.TestThreadPool;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.mockito.Mockito;\n+\n+import static org.elasticsearch.xpack.core.ilm.LifecycleSettings.LIFECYCLE_STEP_MASTER_TIMEOUT;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public abstract class AbstractStepMasterTimeoutTestCase<T extends AsyncActionStep> extends AbstractStepTestCase<T> {\n+\n+    protected Client client;\n+    protected AdminClient adminClient;\n+    protected IndicesAdminClient indicesClient;\n+    protected ThreadPool pool;\n+\n+    @Before\n+    public void setup() {\n+        client = Mockito.mock(Client.class);", "originalCommit": "4d16cd68d9e44c1fa28e3ee9def7620b72d48d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NTgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r369875806", "bodyText": "That makes sense. This change was mostly due to the fact that I needed to overwrite client used in tests from AbstractStepMasterTimeoutTestCase - client was passed on instance creation in createRandomInstance. For now on I reverted client initialization but added visible-for-testing method AsyncActionStep#setClient that lets you overwrite client after creation.\nI'll follow up soon with PR for centralizing this initialization and this method can be removed then.", "author": "probakowski", "createdAt": "2020-01-23T00:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5OTE0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA1Njk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/51130#discussion_r370056980", "bodyText": "Thanks for making the change @probakowski\nI think now it's at least explicit (I found it rather confusing to see what client is used where before) but I agree it'll be nice to centralise the initialization process.", "author": "andreidan", "createdAt": "2020-01-23T11:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk5OTE0NA=="}], "type": "inlineReview"}, {"oid": "32d263e8beb3c7a4bde54b2f8cac36e99ea90b6d", "url": "https://github.com/elastic/elasticsearch/commit/32d263e8beb3c7a4bde54b2f8cac36e99ea90b6d", "message": "PR review comments", "committedDate": "2020-01-23T00:03:21Z", "type": "commit"}, {"oid": "393111ee9bca08ab1e5d4ba0c9db90cbf57d8b00", "url": "https://github.com/elastic/elasticsearch/commit/393111ee9bca08ab1e5d4ba0c9db90cbf57d8b00", "message": "Removed unnecessary changes", "committedDate": "2020-01-23T00:05:54Z", "type": "commit"}, {"oid": "fd0a50709fd4f4c1370da98b0f2f694b92946b4a", "url": "https://github.com/elastic/elasticsearch/commit/fd0a50709fd4f4c1370da98b0f2f694b92946b4a", "message": "Merge branch 'master' into ilm-master-timeout", "committedDate": "2020-01-23T00:19:47Z", "type": "commit"}, {"oid": "6fc450fe3ffe869c85f1c1c1457f5753dfbbc0ca", "url": "https://github.com/elastic/elasticsearch/commit/6fc450fe3ffe869c85f1c1c1457f5753dfbbc0ca", "message": "Setup/teardown renamed", "committedDate": "2020-01-23T01:05:15Z", "type": "commit"}]}