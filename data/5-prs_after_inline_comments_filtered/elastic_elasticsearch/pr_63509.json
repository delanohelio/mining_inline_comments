{"pr_number": 63509, "pr_title": "Returning tokenGroups attribute as SID string instead of byte array", "pr_createdAt": "2020-10-08T20:43:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63509", "timeline": [{"oid": "2b3e6328131bbd42920cf8fa886c58966ce80f14", "url": "https://github.com/elastic/elasticsearch/commit/2b3e6328131bbd42920cf8fa886c58966ce80f14", "message": "Returning tokenGroups attribute as SID string instead of byte array (AD metadata)\n\nResolves: #61173", "committedDate": "2020-10-08T20:19:14Z", "type": "commit"}, {"oid": "987b66d09c7d584a04832b7248583aa5db5481a1", "url": "https://github.com/elastic/elasticsearch/commit/987b66d09c7d584a04832b7248583aa5db5481a1", "message": "Returning tokenGroups attribute as SID string instead of byte array (AD metadata)\n\nResolves: #61173", "committedDate": "2020-10-12T18:13:59Z", "type": "commit"}, {"oid": "00ff8bd9c4eed392dea5dd4a1f25672fa78b5174", "url": "https://github.com/elastic/elasticsearch/commit/00ff8bd9c4eed392dea5dd4a1f25672fa78b5174", "message": "Merge branch 'TokenGroupSID' of github.com:BigPandaToo/elasticsearch into TokenGroupSID", "committedDate": "2020-10-12T18:14:24Z", "type": "commit"}, {"oid": "a6614084dd3d7bc5879a1138398d80d9799d5b52", "url": "https://github.com/elastic/elasticsearch/commit/a6614084dd3d7bc5879a1138398d80d9799d5b52", "message": "Adding test", "committedDate": "2020-10-12T18:17:39Z", "type": "commit"}, {"oid": "f1940f88cacd5a2784b81f92af6088c16d72cf99", "url": "https://github.com/elastic/elasticsearch/commit/f1940f88cacd5a2784b81f92af6088c16d72cf99", "message": "Adding test", "committedDate": "2020-10-12T18:25:14Z", "type": "commit"}, {"oid": "815da0bc7339b14d93203cd2b77e2d343b4a998d", "url": "https://github.com/elastic/elasticsearch/commit/815da0bc7339b14d93203cd2b77e2d343b4a998d", "message": "Adding test", "committedDate": "2020-10-12T18:44:10Z", "type": "commit"}, {"oid": "441e2f97e1c3bb230d60d1baab29939913fe301b", "url": "https://github.com/elastic/elasticsearch/commit/441e2f97e1c3bb230d60d1baab29939913fe301b", "message": "Merge branch 'master' into TokenGroupSID", "committedDate": "2020-10-12T20:10:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNDI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r503514286", "bodyText": "This method looks very specific to the added test and its name is rather generic. I suggest we move the code to testResolveTokenGroupsSID , WDYT?", "author": "jkakavas", "createdAt": "2020-10-12T20:21:56Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectoryGroupsResolverTests.java", "diffHunk": "@@ -117,6 +155,12 @@ private void assertValidSidQuery(Filter query, String[] expectedSids) {\n         }\n     }\n \n+    private Map<String, Object> resolve(Collection<Attribute> attributes, LdapMetadataResolver resolver) throws Exception {", "originalCommit": "441e2f97e1c3bb230d60d1baab29939913fe301b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2OTAwMg==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504169002", "bodyText": "Changed", "author": "BigPandaToo", "createdAt": "2020-10-13T18:25:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNDI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNzM5OA==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r503517398", "bodyText": "groupSIDs -- > metadata or something similar that indicates that this the user metadata ( that contain tokenGroups )", "author": "jkakavas", "createdAt": "2020-10-12T20:29:45Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectoryGroupsResolverTests.java", "diffHunk": "@@ -53,6 +64,33 @@ public void testResolveSubTree() throws Exception {\n                 containsString(\"Supers\")));\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public void testResolveTokenGroupsSID() throws Exception {\n+        Settings settings = Settings.builder()\n+            .put(\"xpack.security.authc.realms.active_directory.ad.group_search.base_dn\", \"DC=ad,DC=test,DC=elasticsearch,DC=com\")\n+            .put(\"xpack.security.authc.realms.active_directory.ad.domain_name\", \"ad.test.elasticsearch.com\")\n+            .put(\"path.home\", createTempDir())\n+            .put(RealmSettings.getFullSettingKey(REALM_ID, RealmSettings.ORDER_SETTING), 0)\n+            .put(getFullSettingKey(REALM_ID, LdapMetadataResolverSettings.ADDITIONAL_METADATA_SETTING), \"tokenGroups\")\n+            .build();\n+        RealmConfig config = new RealmConfig(REALM_ID, settings, TestEnvironment.newEnvironment(settings), new ThreadContext(settings));\n+        LdapMetadataResolver resolver = new LdapMetadataResolver(config, true);\n+        Map<String, Object> groupSIDs = resolve(null, resolver);", "originalCommit": "441e2f97e1c3bb230d60d1baab29939913fe301b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3MjgwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504272805", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-13T21:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxNzM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxODkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r503518914", "bodyText": "I think my original suggestion as to where we should put this test was misleading, sorry for that.  Probably ActiveDirectorySessionFactoryTests is a more proper place for this to live since it has to do with a specific attribute being properly added as metadata ( even though the attribute is groups related )", "author": "jkakavas", "createdAt": "2020-10-12T20:33:45Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectoryGroupsResolverTests.java", "diffHunk": "@@ -53,6 +64,33 @@ public void testResolveSubTree() throws Exception {\n                 containsString(\"Supers\")));\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public void testResolveTokenGroupsSID() throws Exception {", "originalCommit": "441e2f97e1c3bb230d60d1baab29939913fe301b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3Mjg5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504272896", "bodyText": "Moved", "author": "BigPandaToo", "createdAt": "2020-10-13T21:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxODkxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMTA1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r503521051", "bodyText": "How about we return a String here instead of a list with one item if tokenGroups contains only 1 value, similar to what we do for all other attributes ( see below ) ?", "author": "jkakavas", "createdAt": "2020-10-12T20:39:40Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ldap/support/LdapMetadataResolver.java", "diffHunk": "@@ -76,8 +78,13 @@ private Attribute findAttribute(Collection<Attribute> attributes, String name) {\n                                 attr -> attr.getName(),\n                                 attr -> {\n                                     final String[] values = attr.getValues();\n+                                    if(attr.getName().equals(TOKEN_GROUPS)) {\n+                                        return Arrays.stream(attr.getValueByteArrays())\n+                                            .map((sidBytes) -> convertToString(sidBytes))\n+                                            .collect(Collectors.toList());", "originalCommit": "441e2f97e1c3bb230d60d1baab29939913fe301b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3Mjk1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504272956", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-10-13T21:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyMTA1MQ=="}], "type": "inlineReview"}, {"oid": "06970469a9d56b7bd2c3eda70de905cb93daf2fb", "url": "https://github.com/elastic/elasticsearch/commit/06970469a9d56b7bd2c3eda70de905cb93daf2fb", "message": "Fixing test", "committedDate": "2020-10-13T16:49:24Z", "type": "commit"}, {"oid": "db3cf573efd69a5b5f74a845dcae9231b04fd1bb", "url": "https://github.com/elastic/elasticsearch/commit/db3cf573efd69a5b5f74a845dcae9231b04fd1bb", "message": "Merge branch 'TokenGroupSID' of github.com:BigPandaToo/elasticsearch into TokenGroupSID", "committedDate": "2020-10-13T16:50:01Z", "type": "commit"}, {"oid": "e73f3f21e93a4693677ee0734fbd7a4847aa4f7b", "url": "https://github.com/elastic/elasticsearch/commit/e73f3f21e93a4693677ee0734fbd7a4847aa4f7b", "message": "Fixing test", "committedDate": "2020-10-13T18:16:13Z", "type": "commit"}, {"oid": "ba713f83998681825d7f082418c1c0746c1b16b5", "url": "https://github.com/elastic/elasticsearch/commit/ba713f83998681825d7f082418c1c0746c1b16b5", "message": "Addressing PR comments", "committedDate": "2020-10-13T21:19:48Z", "type": "commit"}, {"oid": "bcca77fd41d39b93f593bcc88f4e0b1b242d861f", "url": "https://github.com/elastic/elasticsearch/commit/bcca77fd41d39b93f593bcc88f4e0b1b242d861f", "message": "Nit fix", "committedDate": "2020-10-13T21:35:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwMDg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504400848", "bodyText": "nit: extra line", "author": "jkakavas", "createdAt": "2020-10-14T04:55:03Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectoryGroupsResolverTests.java", "diffHunk": "@@ -17,11 +17,13 @@\n import java.util.List;\n import java.util.regex.Pattern;\n \n+\n import static org.hamcrest.Matchers.containsInAnyOrder;\n import static org.hamcrest.Matchers.containsString;\n import static org.hamcrest.Matchers.hasItem;\n import static org.hamcrest.Matchers.is;\n \n+", "originalCommit": "bcca77fd41d39b93f593bcc88f4e0b1b242d861f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwMTY5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504401691", "bodyText": "Convention in our codebase is to use camel case so metadataGroupSIDs here", "author": "jkakavas", "createdAt": "2020-10-14T04:58:30Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectorySessionFactoryTests.java", "diffHunk": "@@ -367,6 +375,35 @@ public void testADLookup() throws Exception {\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public void testResolveTokenGroupsSID() throws Exception {\n+        Settings settings = Settings.builder()\n+            .put(\"path.home\", createTempDir())\n+            .put(RealmSettings.getFullSettingKey(REALM_ID, RealmSettings.ORDER_SETTING), 0)\n+            .put(buildAdSettings(REALM_ID, AD_LDAP_URL, AD_DOMAIN, \"CN=Users,DC=ad,DC=test,DC=elasticsearch,DC=com\",\n+                LdapSearchScope.SUB_TREE, false))\n+            .put(ActiveDirectorySessionFactorySettings.AD_GROUP_SEARCH_BASEDN_SETTING, \"DC=ad,DC=test,DC=elasticsearch,DC=com\")\n+            .put(ActiveDirectorySessionFactorySettings.AD_GROUP_SEARCH_SCOPE_SETTING, LdapSearchScope.SUB_TREE)\n+            .put(getFullSettingKey(REALM_ID, LdapMetadataResolverSettings.ADDITIONAL_METADATA_SETTING), \"tokenGroups\")\n+            .build();\n+        RealmConfig config = configureRealm(\"ad-test\", LdapRealmSettings.AD_TYPE, settings);\n+        final PlainActionFuture<Map<String, Object>> future = new PlainActionFuture<>();\n+        LdapMetadataResolver resolver = new LdapMetadataResolver(config, true);\n+        try (ActiveDirectorySessionFactory sessionFactory = getActiveDirectorySessionFactory(config, sslService, threadPool)) {\n+            String userName = \"ironman\";\n+            try (LdapSession ldap = session(sessionFactory, userName, SECURED_PASSWORD)) {\n+                assertConnectionCanReconnect(ldap.getConnection());\n+                resolver.resolve(ldap.getConnection(), BRUCE_BANNER_DN, TimeValue.timeValueSeconds(1), logger, null, future);\n+                Map<String, Object> metadata_groupSIDs = future.get();", "originalCommit": "bcca77fd41d39b93f593bcc88f4e0b1b242d861f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQwNjg2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63509#discussion_r504406863", "bodyText": "Since we're not using a bind user in the settings we should probably use an ldap session that is created for the user that we search foe and resolve its attributes, so use hulk here instead", "author": "jkakavas", "createdAt": "2020-10-14T05:17:33Z", "path": "x-pack/qa/third-party/active-directory/src/test/java/org/elasticsearch/xpack/security/authc/ldap/ActiveDirectorySessionFactoryTests.java", "diffHunk": "@@ -367,6 +375,35 @@ public void testADLookup() throws Exception {\n         }\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public void testResolveTokenGroupsSID() throws Exception {\n+        Settings settings = Settings.builder()\n+            .put(\"path.home\", createTempDir())\n+            .put(RealmSettings.getFullSettingKey(REALM_ID, RealmSettings.ORDER_SETTING), 0)\n+            .put(buildAdSettings(REALM_ID, AD_LDAP_URL, AD_DOMAIN, \"CN=Users,DC=ad,DC=test,DC=elasticsearch,DC=com\",\n+                LdapSearchScope.SUB_TREE, false))\n+            .put(ActiveDirectorySessionFactorySettings.AD_GROUP_SEARCH_BASEDN_SETTING, \"DC=ad,DC=test,DC=elasticsearch,DC=com\")\n+            .put(ActiveDirectorySessionFactorySettings.AD_GROUP_SEARCH_SCOPE_SETTING, LdapSearchScope.SUB_TREE)\n+            .put(getFullSettingKey(REALM_ID, LdapMetadataResolverSettings.ADDITIONAL_METADATA_SETTING), \"tokenGroups\")\n+            .build();\n+        RealmConfig config = configureRealm(\"ad-test\", LdapRealmSettings.AD_TYPE, settings);\n+        final PlainActionFuture<Map<String, Object>> future = new PlainActionFuture<>();\n+        LdapMetadataResolver resolver = new LdapMetadataResolver(config, true);\n+        try (ActiveDirectorySessionFactory sessionFactory = getActiveDirectorySessionFactory(config, sslService, threadPool)) {\n+            String userName = \"ironman\";", "originalCommit": "bcca77fd41d39b93f593bcc88f4e0b1b242d861f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df56ed31c299e6e7ca948bf9b5fe932c351f54ad", "url": "https://github.com/elastic/elasticsearch/commit/df56ed31c299e6e7ca948bf9b5fe932c351f54ad", "message": "Nit fixes", "committedDate": "2020-10-14T10:25:32Z", "type": "commit"}]}