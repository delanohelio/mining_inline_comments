{"pr_number": 64841, "pr_title": "Add validation in policy files for missing codebases", "pr_createdAt": "2020-11-10T00:28:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64841", "timeline": [{"oid": "a0b30e166b721ad6bdaca82c0b4ba8434f073a14", "url": "https://github.com/elastic/elasticsearch/commit/a0b30e166b721ad6bdaca82c0b4ba8434f073a14", "message": "Add validation in policy files for missing codebases\n\nElasticsearch plugins can add a java security policy file to grant\nadditional permissions. These policy files can contain permission grants\nfor specific jar files, which are specified through system properties.\nUnfortunately the java policy parser is lenient when a system property\nis missing, meaning we can't know if there is a typo or grant for a no\nlonger relevant jar file.\n\nThis commit adds validation to the policy parsing by overriding the\nsystem properties and tracking when a missing system property is used.", "committedDate": "2020-11-10T00:22:16Z", "type": "commit"}, {"oid": "651c719e7a1470b4178d788ee1389ead86616e1d", "url": "https://github.com/elastic/elasticsearch/commit/651c719e7a1470b4178d788ee1389ead86616e1d", "message": "cleanup", "committedDate": "2020-11-10T00:28:39Z", "type": "commit"}, {"oid": "c579f17150934e3a773c4de87e2eb21f272fd00b", "url": "https://github.com/elastic/elasticsearch/commit/c579f17150934e3a773c4de87e2eb21f272fd00b", "message": "always add necessary codebases if they are needed", "committedDate": "2020-11-10T00:58:20Z", "type": "commit"}, {"oid": "dfa70b5754b3d9a1de682fd2d7a9130320109fd0", "url": "https://github.com/elastic/elasticsearch/commit/dfa70b5754b3d9a1de682fd2d7a9130320109fd0", "message": "checkstyle", "committedDate": "2020-11-10T01:08:14Z", "type": "commit"}, {"oid": "7be3b5feefd2c4e95dee942c2c58fa9b5a0b23d1", "url": "https://github.com/elastic/elasticsearch/commit/7be3b5feefd2c4e95dee942c2c58fa9b5a0b23d1", "message": "add test codebases file for plugins", "committedDate": "2020-11-10T21:49:04Z", "type": "commit"}, {"oid": "28273067136787577fa9453b642df1ed41a6c336", "url": "https://github.com/elastic/elasticsearch/commit/28273067136787577fa9453b642df1ed41a6c336", "message": "account for policy file being in a jar", "committedDate": "2020-11-10T22:15:35Z", "type": "commit"}, {"oid": "26fdd3a20d4d69ec0ef53b1a777f8c98f4c90ffe", "url": "https://github.com/elastic/elasticsearch/commit/26fdd3a20d4d69ec0ef53b1a777f8c98f4c90ffe", "message": "test codebases", "committedDate": "2020-11-10T23:43:09Z", "type": "commit"}, {"oid": "b5da711bfd7278f78b059debe37f2ee5cc99a0ad", "url": "https://github.com/elastic/elasticsearch/commit/b5da711bfd7278f78b059debe37f2ee5cc99a0ad", "message": "checkstyle", "committedDate": "2020-11-11T01:05:26Z", "type": "commit"}, {"oid": "9d5226a4ac623a1c8cfc87dc93265597412d11d1", "url": "https://github.com/elastic/elasticsearch/commit/9d5226a4ac623a1c8cfc87dc93265597412d11d1", "message": "remove debug", "committedDate": "2020-11-11T01:36:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ2MDA1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64841#discussion_r524460051", "bodyText": "I wonder for safety/strictness if we should change .jar to .jar!? Could also even include the path separator.", "author": "jaymode", "createdAt": "2020-11-16T17:50:20Z", "path": "test/framework/src/main/java/org/elasticsearch/bootstrap/BootstrapForTesting.java", "diffHunk": "@@ -234,11 +239,30 @@ private static void addClassCodebase(Map<String, URL> codebases, String name, St\n                 Assert.class.getProtectionDomain().getCodeSource().getLocation()\n         ));\n         codebases.removeAll(excluded);\n+        final Map<String, URL> codebasesMap = PolicyUtil.getCodebaseJarMap(codebases);\n \n         // parse each policy file, with codebase substitution from the classpath\n         final List<Policy> policies = new ArrayList<>(pluginPolicies.size());\n         for (URL policyFile : pluginPolicies) {\n-            policies.add(PolicyUtil.readPolicy(policyFile, PolicyUtil.getCodebaseJarMap(codebases)));\n+            Map<String, URL> policyCodebases = codebasesMap;\n+\n+            // if the codebases file is inside a jar, then we don't need to load it since the jar will\n+            // have already been read from the classpath\n+            if (policyFile.toString().contains(\".jar\") == false) {", "originalCommit": "9d5226a4ac623a1c8cfc87dc93265597412d11d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9123b33b11d2b2aa36f76ca2b79c33a5f7448b89", "url": "https://github.com/elastic/elasticsearch/commit/9123b33b11d2b2aa36f76ca2b79c33a5f7448b89", "message": "Isolate sql cli tests with dedicated testcase\n\nThe sql cli tests build on ESTestCase, but this triggers security\nmanager initialization for tests. However, this is unrealistic for the\nsql cli both because it does not run with security manager, and the\ncli only picks up the server jar that contains the policy and security\nmanager bootstrapping code unintentionally. Removing the depdnence on\nthe server code would be ideal, but until that can happen, this commit\nstarts the separation by adding a dedicated testcase for these tests\nwhich does not use BootstrapForTesting.", "committedDate": "2020-11-17T02:46:43Z", "type": "commit"}, {"oid": "b90f89975e8487cf2abe6cdb5fb707ecf2fe4f65", "url": "https://github.com/elastic/elasticsearch/commit/b90f89975e8487cf2abe6cdb5fb707ecf2fe4f65", "message": "Merge branch 'master' into plugin_permission_list6", "committedDate": "2020-11-17T02:55:25Z", "type": "commit"}, {"oid": "d05caeb8217fcb5fbfb95d0d15e7f82f1c1e836e", "url": "https://github.com/elastic/elasticsearch/commit/d05caeb8217fcb5fbfb95d0d15e7f82f1c1e836e", "message": "Merge branch 'master' into plugin_permission_list6", "committedDate": "2020-11-17T19:51:34Z", "type": "commit"}, {"oid": "84e06af87d5da827deba1a7e6b8ae0cec138b898", "url": "https://github.com/elastic/elasticsearch/commit/84e06af87d5da827deba1a7e6b8ae0cec138b898", "message": "refine jar FS check", "committedDate": "2020-11-17T19:52:47Z", "type": "commit"}]}