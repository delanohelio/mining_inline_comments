{"pr_number": 50962, "pr_title": "QL: Remove implicit conversion inside Literal", "pr_createdAt": "2020-01-14T10:32:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50962", "timeline": [{"oid": "f27fbb036967ee88a67f4ba5533088128e016e91", "url": "https://github.com/elastic/elasticsearch/commit/f27fbb036967ee88a67f4ba5533088128e016e91", "message": "QL: Remove implicit conversion inside Literal\n\nLiteral constructor makes an implicit conversion for each value given\nwhich turns out has some subtle side-effects.\nImprove MathProcessors to preserve numeric type where possible\nFix bug on issue compatibility between date and intervals\nPreserve the source when folding inside the Optimizer", "committedDate": "2020-01-14T10:31:19Z", "type": "commit"}, {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b", "url": "https://github.com/elastic/elasticsearch/commit/02340f996b5076d5e1cd6fa267cdf75ca269474b", "message": "Fix broken tests", "committedDate": "2020-01-14T11:44:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366429011", "bodyText": "Is this case tested?", "author": "matriv", "createdAt": "2020-01-14T16:09:54Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/math/MathProcessor.java", "diffHunk": "@@ -21,17 +23,38 @@\n     \n     public enum MathOperation {\n         ABS((Object l) -> {\n-            if (l instanceof Float) {\n-                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n-            }\n             if (l instanceof Double) {\n                 return Math.abs(((Double) l).doubleValue());\n             }\n+            if (l instanceof Float) {\n+                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n+            }\n+\n+            // fallback to integer\n             long lo = ((Number) l).longValue();\n-            //handles the corner-case of Long.MIN_VALUE\n-            return lo >= 0 ? lo : lo == Long.MIN_VALUE ? Double.valueOf(Long.MAX_VALUE) : -lo;\n-        }),\n \n+            if (lo == Long.MIN_VALUE) {\n+                throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");", "originalCommit": "02340f996b5076d5e1cd6fa267cdf75ca269474b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjU1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366546559", "bodyText": "It is now", "author": "costin", "createdAt": "2020-01-14T20:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366429132", "bodyText": "This also?", "author": "matriv", "createdAt": "2020-01-14T16:10:07Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/math/MathProcessor.java", "diffHunk": "@@ -21,17 +23,38 @@\n     \n     public enum MathOperation {\n         ABS((Object l) -> {\n-            if (l instanceof Float) {\n-                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n-            }\n             if (l instanceof Double) {\n                 return Math.abs(((Double) l).doubleValue());\n             }\n+            if (l instanceof Float) {\n+                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n+            }\n+\n+            // fallback to integer\n             long lo = ((Number) l).longValue();\n-            //handles the corner-case of Long.MIN_VALUE\n-            return lo >= 0 ? lo : lo == Long.MIN_VALUE ? Double.valueOf(Long.MAX_VALUE) : -lo;\n-        }),\n \n+            if (lo == Long.MIN_VALUE) {\n+                throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");\n+            }\n+\n+            lo = lo < 0 ? -lo : lo;\n+\n+            if (l instanceof Integer) {\n+                if (lo == Integer.MIN_VALUE) {\n+                    throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");", "originalCommit": "02340f996b5076d5e1cd6fa267cdf75ca269474b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0NjY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366546662", "bodyText": "Added basic test", "author": "costin", "createdAt": "2020-01-14T20:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTEzMg=="}], "type": "inlineReview"}, {"oid": "96124d543eaed24031a6ed84c177896e58fc87f3", "url": "https://github.com/elastic/elasticsearch/commit/96124d543eaed24031a6ed84c177896e58fc87f3", "message": "Merge remote-tracking branch 'remotes/upstream/master' into ql/datatype-refactor", "committedDate": "2020-01-14T19:28:23Z", "type": "commit"}, {"oid": "a32da608c0e40af877634ec7f47eb28d3ea60998", "url": "https://github.com/elastic/elasticsearch/commit/a32da608c0e40af877634ec7f47eb28d3ea60998", "message": "Add basic tests for ABS", "committedDate": "2020-01-14T20:02:09Z", "type": "commit"}]}