{"pr_number": 63710, "pr_title": "SQL: Fix incorrect parameter resolution", "pr_createdAt": "2020-10-15T00:16:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63710", "timeline": [{"oid": "620d8b458b5de4955dc6ba032119bd2b8e9212f5", "url": "https://github.com/elastic/elasticsearch/commit/620d8b458b5de4955dc6ba032119bd2b8e9212f5", "message": "SQL: Fix incorrect parameter resolution\n\nParameters in the SQL query marked as `?` turn into an `UnresolvedAlias`\nin the parsed tree, aliasing (without a name) the `Literal` representing\nthe passed in parameter value.\n\nFor example in the query `SELECT ? FROM test` with a single integer\n(value = 100) parameter the ? turns into an `UnresolvedAlias\n(child=Literal(100))` or if we try to print it back into SQL, `SELECT\n100 as ? FROM test`.\n\nA problem arises when multiple `?` is in the query, since the `SELECT ?,\n? FROM test` query with integer parameters (value=100, 200) will turn\ninto `SELECT 100 as ?, 200 as ? FROM test`. You guessed it correctly,\nname conflict is the underlying issue.\n\nThe `UnresolvedAlias`es will be assigned the same name and are turned\ninto `Alias(name=\"?\")` objects by the `Analyzer`.\nThe problem ultimately comes down to the fact that `Alias`es in the\n`QueryFolder`. The `Alias`es eventually put into an `AttributeMap`,\nbut not directly. First the collection of `Alias`es gets turned into a\n`java.util.LinkedHashMap<Attribute, Expression>` which later get's\nturned an `AttributeMap`. The key in the map gets created using `Alias\n.toAttribute()`, but the `LinkedHashMap<>` uses the `Attribute.equals()`\n and `Attribute.hashCode()` methods which only take into the account the\n`name` field of the attribute vs `Attribute.semanticEquals()` and\n`Attribute.semanticHash()` that take into account the `name` and `id`\nfields (used by the `AttributeMap`).\nThe name-based equality check in the `LinkedHashMap` essentially\nde-duplicates the `Alias`es based on the name and that is why one of the\nattributes cannot be resolved (resolution uses both `name` and `id`).\n\nThis fix deprecates the `AttributeMap(Map)` constructor, makes sure that\nthe `AttributeMap`s are populated from `Stream`s or `Iterable`s\ndirectly, so no deduplication happens based on the names of the\n`Attribute`s.\n\nNote: The `SELECT 100 as ?, 200 as ? FROM test` query will result in two\ncolumns named as `?` in the results. Alternatively I could have just\ngenerated different names for the `UnresolvedAlias` objects, but that\nwould just hide the above mentioned bug in the code.\n\nFix #56013", "committedDate": "2020-10-15T00:10:24Z", "type": "commit"}, {"oid": "40254dc1d530031a17807c971c84102d8d389c59", "url": "https://github.com/elastic/elasticsearch/commit/40254dc1d530031a17807c971c84102d8d389c59", "message": "Import fixes (checkstyle errors)", "committedDate": "2020-10-15T00:21:00Z", "type": "commit"}, {"oid": "4d0568e008441aab892921705269325b23a80e5d", "url": "https://github.com/elastic/elasticsearch/commit/4d0568e008441aab892921705269325b23a80e5d", "message": "Revert of the previous changes", "committedDate": "2020-10-27T20:54:17Z", "type": "commit"}, {"oid": "db8ad10afa59bb41f8812941724f190f2da38f1e", "url": "https://github.com/elastic/elasticsearch/commit/db8ad10afa59bb41f8812941724f190f2da38f1e", "message": "Merge remote-tracking branch 'origin/master' into fix/56013", "committedDate": "2020-10-27T20:55:09Z", "type": "commit"}, {"oid": "03e9a75458a09086a5e7d7ea1e8cb852caea2135", "url": "https://github.com/elastic/elasticsearch/commit/03e9a75458a09086a5e7d7ea1e8cb852caea2135", "message": "SQL: Fix incorrect parameter resolution\n\nFor example in the query `SELECT ? FROM test` with a single integer\n(value = 100) parameter the ? turns into an `UnresolvedAlias\n(child=Literal(100))` or if we try to print it back into SQL, `SELECT\n100 as ? FROM test`.\n\nA problem arises when multiple `?` is in the query with the same type.\nFor example the `SELECT ?, ? FROM test` query with integer parameters\n(value=100, 200) will turn into `SELECT 100 as ?, 200 as ? FROM test`.\n\nThis commit changes the way aliases are assigned: the first unaliased\nparameter will stay `?`, but from the 2nd unaliased parameter literal\na counter will be added to the alias (`?2`, `?3`, ...).\n\nCallout: This will introduce a change for the users: a query with\nmultiple unaliased parameters (but each parameter with different\ntypes) successfully executed before and returned the results with\nmultiple `?` columns (although must have accessed via index from the\nresult set instead of alias).\n\nFix #56013", "committedDate": "2020-10-27T21:10:51Z", "type": "commit"}, {"oid": "7ae10b2cc250d7449b1389f0fabcbad477834e4e", "url": "https://github.com/elastic/elasticsearch/commit/7ae10b2cc250d7449b1389f0fabcbad477834e4e", "message": "Moved down the modifications into the `SqlParser`", "committedDate": "2020-10-28T20:34:04Z", "type": "commit"}, {"oid": "b61461d7c52872dceac82dc4318f0142f79a5fbc", "url": "https://github.com/elastic/elasticsearch/commit/b61461d7c52872dceac82dc4318f0142f79a5fbc", "message": "Refactor: using SqlParameter instead of Tuple", "committedDate": "2020-10-28T21:53:57Z", "type": "commit"}, {"oid": "94d734d9e209731aff1ab4bd9dd0a5798db4d85b", "url": "https://github.com/elastic/elasticsearch/commit/94d734d9e209731aff1ab4bd9dd0a5798db4d85b", "message": "Switched to the faster implementation of the parameter lookup.", "committedDate": "2020-10-28T21:53:58Z", "type": "commit"}, {"oid": "c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "url": "https://github.com/elastic/elasticsearch/commit/c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "message": "Doc fix", "committedDate": "2020-10-28T22:00:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwMzQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514003465", "bodyText": "Please revert. The PRs should contain the minimal number of changes needed and not affect the rest of the code", "author": "costin", "createdAt": "2020-10-29T06:05:54Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Analyzer.java", "diffHunk": "@@ -956,8 +956,7 @@ private boolean hasUnresolvedAliases(List<? extends NamedExpression> expressions\n \n         private List<NamedExpression> assignAliases(List<? extends NamedExpression> exprs) {\n             List<NamedExpression> newExpr = new ArrayList<>(exprs.size());\n-            for (int i = 0; i < exprs.size(); i++) {\n-                NamedExpression expr = exprs.get(i);\n+            for (NamedExpression expr : exprs) {\n                 NamedExpression transformed = (NamedExpression) expr.transformUp(ua -> {", "originalCommit": "c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMwMzg0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514303845", "bodyText": "Thanks, leftover from prev commits.", "author": "palesz", "createdAt": "2020-10-29T14:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwMzQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwNjcxNA==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514006714", "bodyText": "Incorrect style (use == false instead of !).\nI'm not sure what this check tries to prevent...", "author": "costin", "createdAt": "2020-10-29T06:11:44Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -767,6 +777,16 @@ private SqlTypedParamValue param(TerminalNode node) {\n         return params.get(token);\n     }\n \n+    private SqlParser.SqlParameter param(ParserRuleContext ctx) {\n+        if (!ctx.getStart().equals(ctx.getStop())) {\n+            throw new ParsingException(source(ctx), \"Single PARAM literal expected\");", "originalCommit": "c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MTY5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514151695", "bodyText": "style: any reason why this is not part of checkStyle and the precommit checks?\nI will remove this check, it was more like a sanity check (during unit & integ test) for me to see if there are any possibility where the start and stop token won't be the same. This should never happen.", "author": "palesz", "createdAt": "2020-10-29T10:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwNjcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwNzMyMA==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514007320", "bodyText": "incorrect formatting paramIndex + 1", "author": "costin", "createdAt": "2020-10-29T06:12:58Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/SqlParser.java", "diffHunk": "@@ -240,26 +261,28 @@ public void syntaxError(Recognizer<?, ?> recognizer, Object offendingSymbol, int\n     private static class ParametrizedTokenSource implements TokenSource {\n \n         private TokenSource delegate;\n-        private Map<Token, SqlTypedParamValue> paramTokens;\n-        private int param;\n+        private Map<Token, SqlParameter> paramTokens;\n+        private int paramIndex;\n         private List<SqlTypedParamValue> params;\n \n-        ParametrizedTokenSource(TokenSource delegate, Map<Token, SqlTypedParamValue> paramTokens, List<SqlTypedParamValue> params) {\n+        ParametrizedTokenSource(TokenSource delegate,\n+                                Map<Token, SqlParameter> paramTokens,\n+                                List<SqlTypedParamValue> params) {\n             this.delegate = delegate;\n             this.paramTokens = paramTokens;\n             this.params = params;\n-            param = 0;\n+            paramIndex = 0;\n         }\n \n         @Override\n         public Token nextToken() {\n             Token token = delegate.nextToken();\n             if (token.getType() == SqlBaseLexer.PARAM) {\n-                if (param >= params.size()) {\n+                if (paramIndex >= params.size()) {\n                     throw new ParsingException(\"Not enough actual parameters {} \", params.size());\n                 }\n-                paramTokens.put(token, params.get(param));\n-                param++;\n+                paramTokens.put(token, new SqlParameter(paramIndex+1, params.get(paramIndex)));", "originalCommit": "c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MjQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514152448", "bodyText": "style: will do, again would be great to add it to checkStyle", "author": "palesz", "createdAt": "2020-10-29T10:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAwNzMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3OTI4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514279287", "bodyText": "In *QL (and Elasticsearch) codebase, the general style for these assertions is either assertThat(X, instanceof(Y)) (more in ES) or assertTrue(X instanceof Y) (more in *QL). Mockito isA seems to be used in the x-pack Security plugin only. I'd suggest going with a *QL-wide consistent approach and use the assertTrue variant, if it's not too much trouble.", "author": "astefan", "createdAt": "2020-10-29T13:58:48Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/parser/ParamLiteralTests.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.parser;\n+\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.ql.expression.Alias;\n+import org.elasticsearch.xpack.ql.expression.Literal;\n+import org.elasticsearch.xpack.ql.expression.NamedExpression;\n+import org.elasticsearch.xpack.ql.expression.predicate.operator.comparison.LessThan;\n+import org.elasticsearch.xpack.ql.plan.logical.Filter;\n+import org.elasticsearch.xpack.ql.plan.logical.LogicalPlan;\n+import org.elasticsearch.xpack.ql.plan.logical.Project;\n+import org.elasticsearch.xpack.sql.proto.SqlTypedParamValue;\n+\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.ql.type.DateUtils.UTC;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.everyItem;\n+import static org.hamcrest.Matchers.isA;\n+import static org.hamcrest.Matchers.startsWith;\n+\n+public class ParamLiteralTests extends ESTestCase {\n+\n+    private final SqlParser parser = new SqlParser();\n+\n+    private LogicalPlan parse(String sql, SqlTypedParamValue... parameters) {\n+        return parser.createStatement(sql, List.of(parameters), UTC);\n+    }\n+\n+    public void testMultipleParamLiteralsWithUnresolvedAliases() {\n+        LogicalPlan logicalPlan = parse(\"SELECT ?, ? FROM test\",\n+            new SqlTypedParamValue(\"integer\", 100),\n+            new SqlTypedParamValue(\"integer\", 200)\n+        );\n+        List<? extends NamedExpression> projections = ((Project) logicalPlan.children().get(0)).projections();\n+        assertThat(projections, everyItem(isA(Alias.class)));\n+        assertThat(projections.get(0).toString(), startsWith(\"100 AS ?1#\"));\n+        assertThat(projections.get(1).toString(), startsWith(\"200 AS ?2#\"));\n+    }\n+\n+    public void testMultipleParamLiteralsWithUnresolvedAliasesAndWhereClause() {\n+        LogicalPlan logicalPlan = parse(\"SELECT ?, ? FROM test WHERE 1 < ?\",\n+            new SqlTypedParamValue(\"integer\", 100),\n+            new SqlTypedParamValue(\"integer\", 200),\n+            new SqlTypedParamValue(\"integer\", 300)\n+        );\n+        Project project = (Project) logicalPlan.children().get(0);\n+        List<? extends NamedExpression> projections = project.projections();\n+        assertThat(projections, everyItem(isA(Alias.class)));\n+        assertThat(projections.get(0).toString(), startsWith(\"100 AS ?1#\"));\n+        assertThat(projections.get(1).toString(), startsWith(\"200 AS ?2#\"));\n+        assertThat(project.children().get(0), isA(Filter.class));\n+        Filter filter = (Filter) project.children().get(0);\n+        assertThat(filter.condition(), isA(LessThan.class));\n+        LessThan condition = (LessThan) filter.condition();\n+        assertThat(condition.left(), isA(Literal.class));", "originalCommit": "c205e9d2d14405b17b26f111a0e5263bd70e1fb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDMxNjM4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r514316381", "bodyText": "or assertEquals(Literal.class, condition.left().getClass()", "author": "matriv", "createdAt": "2020-10-29T14:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3OTI4Nw=="}], "type": "inlineReview"}, {"oid": "f2e46de012f0c77bb8f84e21a61a952b01afaee9", "url": "https://github.com/elastic/elasticsearch/commit/f2e46de012f0c77bb8f84e21a61a952b01afaee9", "message": "PR suggestions and moved changes mostly to `visitParamLiteral`\n\nNote: Now the `visitParamLiteral` reads into the parent context.", "committedDate": "2020-10-30T15:08:47Z", "type": "commit"}, {"oid": "2cefcc611792a6c16eb79e4ef434a86eb3038c9c", "url": "https://github.com/elastic/elasticsearch/commit/2cefcc611792a6c16eb79e4ef434a86eb3038c9c", "message": "Root cause fixed", "committedDate": "2020-10-30T19:58:21Z", "type": "commit"}, {"oid": "fa1d31c6ecbc60b53d812ba980b044de72ffcd6f", "url": "https://github.com/elastic/elasticsearch/commit/fa1d31c6ecbc60b53d812ba980b044de72ffcd6f", "message": "Revert unnecessary changes", "committedDate": "2020-10-30T19:58:35Z", "type": "commit"}, {"oid": "ecd308794a8583727f517f06da8a485655cc6eaa", "url": "https://github.com/elastic/elasticsearch/commit/ecd308794a8583727f517f06da8a485655cc6eaa", "message": "Cleanups", "committedDate": "2020-10-30T20:04:21Z", "type": "commit"}, {"oid": "541b4c9ce0029709f6cb126292f3cd9884fe416b", "url": "https://github.com/elastic/elasticsearch/commit/541b4c9ce0029709f6cb126292f3cd9884fe416b", "message": "Removed the `System.out.println` calls", "committedDate": "2020-11-02T14:49:30Z", "type": "commit"}, {"oid": "6bb184d19de61dcb3af708505aebf30d578f31dd", "url": "https://github.com/elastic/elasticsearch/commit/6bb184d19de61dcb3af708505aebf30d578f31dd", "message": "Additional tests and `AttributeMap.builder` name changes", "committedDate": "2020-11-03T15:18:06Z", "type": "commit"}, {"oid": "9cd3dc057757003b20d03367b234dde4f65c7c39", "url": "https://github.com/elastic/elasticsearch/commit/9cd3dc057757003b20d03367b234dde4f65c7c39", "message": "Additional tests and `AttributeMap.builder` name changes", "committedDate": "2020-11-03T15:44:12Z", "type": "commit"}, {"oid": "09cfe08be5deb9463f097cba05dd0b74047cc538", "url": "https://github.com/elastic/elasticsearch/commit/09cfe08be5deb9463f097cba05dd0b74047cc538", "message": "Merge remote-tracking branch 'origin/master' into fix/56013", "committedDate": "2020-11-03T15:56:45Z", "type": "commit"}, {"oid": "f7fead3119f0d0ea7d8c3c90f1d75930d7a739ed", "url": "https://github.com/elastic/elasticsearch/commit/f7fead3119f0d0ea7d8c3c90f1d75930d7a739ed", "message": "Whitespace revert", "committedDate": "2020-11-03T16:00:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMDE5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r516800192", "bodyText": "Will merge these two lines before squash.", "author": "palesz", "createdAt": "2020-11-03T16:32:57Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -189,11 +189,12 @@ public Verifier(Metrics metrics) {\n             plan.forEachExpressionsUp(e -> {\n                 if (e instanceof Alias) {\n                     Alias a = (Alias) e;\n-                    collectRefs.put(a.toAttribute(), a.child());\n+                    Attribute attr = a.toAttribute();\n+                    collectRefs.put(attr, a.child());", "originalCommit": "f7fead3119f0d0ea7d8c3c90f1d75930d7a739ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyNjUxMw==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r516926513", "bodyText": "You need the checks to pass before merging so you'll have to do it anyway, better do it sooner rather than later.", "author": "costin", "createdAt": "2020-11-03T20:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMDE5Mg=="}], "type": "inlineReview"}, {"oid": "bee8a7dd25ed44fbf719471786fa4238fda66b14", "url": "https://github.com/elastic/elasticsearch/commit/bee8a7dd25ed44fbf719471786fa4238fda66b14", "message": "PR suggestions", "committedDate": "2020-11-03T22:40:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNTk2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r517005961", "bodyText": "Maybe also check the returned values with get() from the map, can be done in the next PR though.", "author": "matriv", "createdAt": "2020-11-03T23:01:42Z", "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/expression/AttributeMapTests.java", "diffHunk": "@@ -37,6 +38,47 @@ private static Attribute a(String name) {\n         return new AttributeMap<>(map);\n     }\n \n+    public void testAttributeMapWithSameAliasesCanResolveAttributes() {\n+        Alias param1 = createIntParameterAlias(1, 100);\n+        Alias param2 = createIntParameterAlias(2, 100);\n+        assertTrue(param1.equals(param2));\n+        assertTrue(param1.semanticEquals(param2));\n+        // equality on literals\n+        assertTrue(param1.child().equals(param2.child()));\n+        assertTrue(param1.child().semanticEquals(param2.child()));\n+        assertTrue(param1.toAttribute().equals(param2.toAttribute()));\n+        assertFalse(param1.toAttribute().semanticEquals(param2.toAttribute()));\n+\n+        Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n+        for (Alias a : List.of(param1, param2)) {\n+            collectRefs.put(a.toAttribute(), a.child());\n+        }\n+        // we can look up the same item by both attributes\n+        assertNotNull(collectRefs.get(param1.toAttribute()));\n+        assertNotNull(collectRefs.get(param2.toAttribute()));\n+        AttributeMap<Expression> attributeMap = new AttributeMap<>(collectRefs);\n+\n+        // validate that all Alias can be e\n+        assertTrue(attributeMap.containsKey(param1.toAttribute()));\n+        assertFalse(attributeMap.containsKey(param2.toAttribute())); // results in unknown attribute exception\n+\n+        AttributeMap.Builder<Expression> mapBuilder = AttributeMap.builder();\n+        for (Alias a : List.of(param1, param2)) {\n+            mapBuilder.put(a.toAttribute(), a.child());\n+        }\n+        AttributeMap<Expression> newAttributeMap = mapBuilder.build();\n+\n+        assertTrue(newAttributeMap.containsKey(param1.toAttribute()));\n+        assertTrue(newAttributeMap.containsKey(param2.toAttribute())); // no more unknown attribute exception", "originalCommit": "bee8a7dd25ed44fbf719471786fa4238fda66b14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMxOTQwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63710#discussion_r517319405", "bodyText": "nit: \"~ wrapper collided\" or some other comment correction (can be the next PR, obv.)", "author": "bpintea", "createdAt": "2020-11-04T12:49:31Z", "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/expression/AttributeMapTests.java", "diffHunk": "@@ -37,6 +38,47 @@ private static Attribute a(String name) {\n         return new AttributeMap<>(map);\n     }\n \n+    public void testAttributeMapWithSameAliasesCanResolveAttributes() {\n+        Alias param1 = createIntParameterAlias(1, 100);\n+        Alias param2 = createIntParameterAlias(2, 100);\n+        assertTrue(param1.equals(param2));\n+        assertTrue(param1.semanticEquals(param2));\n+        // equality on literals\n+        assertTrue(param1.child().equals(param2.child()));\n+        assertTrue(param1.child().semanticEquals(param2.child()));\n+        assertTrue(param1.toAttribute().equals(param2.toAttribute()));\n+        assertFalse(param1.toAttribute().semanticEquals(param2.toAttribute()));\n+\n+        Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n+        for (Alias a : List.of(param1, param2)) {\n+            collectRefs.put(a.toAttribute(), a.child());\n+        }\n+        // we can look up the same item by both attributes\n+        assertNotNull(collectRefs.get(param1.toAttribute()));\n+        assertNotNull(collectRefs.get(param2.toAttribute()));\n+        AttributeMap<Expression> attributeMap = new AttributeMap<>(collectRefs);\n+\n+        // validate that all Alias can be e", "originalCommit": "bee8a7dd25ed44fbf719471786fa4238fda66b14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "62a2f90cb60aeec78236f9df9550b49dbbd9fd30", "url": "https://github.com/elastic/elasticsearch/commit/62a2f90cb60aeec78236f9df9550b49dbbd9fd30", "message": "Merge remote-tracking branch 'origin/master' into fix/56013", "committedDate": "2020-11-04T15:46:42Z", "type": "commit"}]}