{"pr_number": 55437, "pr_title": "Fix certutil http for empty password with JDK 11 and lower", "pr_createdAt": "2020-04-20T05:44:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55437", "timeline": [{"oid": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "url": "https://github.com/elastic/elasticsearch/commit/0a4431ddc55480d58581bb299bc1c7d9bca342fd", "message": "Support empty keystore password for JDK 11 and lower", "committedDate": "2020-04-20T05:37:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEwODQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r411108490", "bodyText": "Commands other than http do not have issue with empty password because of the withPassword(...) wrapper. These empty strings are just added here for completeness.\n\n  \n    \n      elasticsearch/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java\n    \n    \n        Lines 928 to 940\n      in\n      c5b923a\n    \n    \n    \n    \n\n        \n          \n           private static <T, E extends Exception> T withPassword(String description, char[] password, Terminal terminal, \n        \n\n        \n          \n                                                                  CheckedFunction<char[], T, E> body) throws E { \n        \n\n        \n          \n               if (password == null) { \n        \n\n        \n          \n                   char[] promptedValue = terminal.readSecret(\"Enter password for \" + description + \" : \"); \n        \n\n        \n          \n                   try { \n        \n\n        \n          \n                       return body.apply(promptedValue); \n        \n\n        \n          \n                   } finally { \n        \n\n        \n          \n                       Arrays.fill(promptedValue, (char) 0); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } else { \n        \n\n        \n          \n                   return body.apply(password); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "ywangd", "createdAt": "2020-04-20T05:47:29Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateToolTests.java", "diffHunk": "@@ -563,10 +563,10 @@ public void testCreateCaAndMultipleInstances() throws Exception {\n \n         final int days = randomIntBetween(7, 1500);\n \n-        final String caPassword = randomAlphaOfLengthBetween(4, 16);\n-        final String node1Password = randomAlphaOfLengthBetween(4, 16);\n-        final String node2Password = randomAlphaOfLengthBetween(4, 16);\n-        final String node3Password = randomAlphaOfLengthBetween(4, 16);\n+        final String caPassword = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node1Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node2Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node3Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTExMTAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r411111011", "bodyText": "This change is the fix. But is there any reason this was intentionally set to null for empty char array? I wonder whether the change would introduce any subtle side effect. @tvernum", "author": "ywangd", "createdAt": "2020-04-20T05:54:33Z", "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommand.java", "diffHunk": "@@ -864,7 +864,7 @@ private boolean askCertSigningRequest(Terminal terminal) {\n             terminal.println(\"IT IS IMPORTANT THAT YOU REMEMBER THIS PASSWORD AND KEEP IT SECURE\");\n             terminal.println(\"\");\n             final char[] password = readPassword(terminal, \"CA password: \", true);\n-            return new CertificateTool.CAInfo(caCert, keyPair.getPrivate(), true, password.length == 0 ? null : password);\n+            return new CertificateTool.CAInfo(caCert, keyPair.getPrivate(), true, password);", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIxODI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412218280", "bodyText": "Inspecting the uses of this returned CAInfo instance, I am pretty sure this change is not impactful.\nHowever, looking at this other use of CAInfo, there seems to be a pattern where a null value is used to signal that a password prompt is further required. I believe the original code here intended for this same behavior.", "author": "albertzaharovits", "createdAt": "2020-04-21T14:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTExMTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzOTAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412239003", "bodyText": "My preference would have been a simple if in the code.", "author": "albertzaharovits", "createdAt": "2020-04-21T14:33:25Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java", "diffHunk": "@@ -589,7 +590,16 @@ private String formatIpAddress(byte[] addr) throws UnknownHostException {\n     private String randomPassword() {\n         // We want to assert that this password doesn't end up in any output files, so we need to make sure we\n         // don't randomly generate a real word.\n-        return randomAlphaOfLength(4) + randomFrom('~', '*', '%', '$', '|') + randomAlphaOfLength(4);\n+        return randomFrom(\n+            \"\",\n+            randomAlphaOfLength(4) + randomFrom('~', '*', '%', '$', '|') + randomAlphaOfLength(4)\n+        );\n+    }\n+\n+    private void runForNonEmptyPattern(String pattern, Runnable runnable) {\n+        if (\"\".equals(pattern) == false) {\n+            runnable.run();\n+        }\n     }", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NzIwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412587208", "bodyText": "Sure I removed it and replaced with if check in the call sites.", "author": "ywangd", "createdAt": "2020-04-22T00:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzOTAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI0NjcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412246726", "bodyText": "I would've not included the empty password in the list of shouldNotContain, but it's just a personal preference.", "author": "albertzaharovits", "createdAt": "2020-04-21T14:42:20Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java", "diffHunk": "@@ -699,11 +709,11 @@ private void verifyKibanaDirectory(Path zipRoot, boolean expectCAFile, Iterable<\n         assertThat(kibanaReadme, containsString(\"https://\"));\n         assertThat(kibanaReadme, containsString(\"elasticsearch-ca.pem\"));\n         readmeShouldContain.forEach(s -> assertThat(kibanaReadme, containsString(s)));\n-        shouldNotContain.forEach(s -> assertThat(kibanaReadme, not(containsString(s))));\n+        shouldNotContain.forEach(s -> runForNonEmptyPattern(s, () -> assertThat(kibanaReadme, not(containsString(s)))));\n \n         assertThat(kibanaYml, containsString(\"elasticsearch.ssl.certificateAuthorities: [ \\\"config/elasticsearch-ca.pem\\\" ]\"));\n         assertThat(kibanaYml, containsString(\"https://\"));\n-        shouldNotContain.forEach(s -> assertThat(kibanaYml, not(containsString(s))));\n+        shouldNotContain.forEach(s -> runForNonEmptyPattern(s, () -> assertThat(kibanaYml, not(containsString(s)))));\n     }", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NzQxNg==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412587416", "bodyText": "Makes sense. The list is not filtered before passed in.", "author": "ywangd", "createdAt": "2020-04-22T00:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI0NjcyNg=="}], "type": "inlineReview"}, {"oid": "ad06cd29ac38f46a9c0cfd469349b85b60cfaa75", "url": "https://github.com/elastic/elasticsearch/commit/ad06cd29ac38f46a9c0cfd469349b85b60cfaa75", "message": "Address feedback.", "committedDate": "2020-04-22T00:41:01Z", "type": "commit"}, {"oid": "d0e767099863baf7b01a8a408ff078fe6dba23c8", "url": "https://github.com/elastic/elasticsearch/commit/d0e767099863baf7b01a8a408ff078fe6dba23c8", "message": "Merge remote-tracking branch 'origin/master' into es-55386-p12-null-password", "committedDate": "2020-04-22T00:41:58Z", "type": "commit"}]}