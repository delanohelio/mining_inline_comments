{"pr_number": 58882, "pr_title": "Eagerly compile condition script at processor creation", "pr_createdAt": "2020-07-01T22:17:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58882", "timeline": [{"oid": "37fc357d269a5c748dbd3c6b69b692b869363d22", "url": "https://github.com/elastic/elasticsearch/commit/37fc357d269a5c748dbd3c6b69b692b869363d22", "message": "Eagerly compile condition script at processor creation\n\nIngest script processors were changed to eagerly compile their scripts\nwhen the ingest pipeline is saved, but conditional scripts were missed.\nThis commit adds eager compilation to ingest conditional scripts, which\nwill help surface errors before runtime, as well as adds tests for each\ncase we might encounter between inline and stored script compilation\nfailures.\n\ncloses #58864", "committedDate": "2020-07-01T22:16:50Z", "type": "commit"}, {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a", "url": "https://github.com/elastic/elasticsearch/commit/a9d23354cc1ba239d4481309f29b298b204ead6a", "message": "checkstyle", "committedDate": "2020-07-01T22:28:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA==", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656154", "bodyText": "should the other test code use this too?", "author": "talevy", "createdAt": "2020-07-01T22:52:21Z", "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,", "originalCommit": "a9d23354cc1ba239d4481309f29b298b204ead6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448679286", "bodyText": "It can, but I wanted to keep this PR small. We can migrate other uses to this later as necessary.", "author": "rjernst", "createdAt": "2020-07-02T00:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448680525", "bodyText": "\ud83d\udc4d was mostly wondering, as it seemed convenient", "author": "talevy", "createdAt": "2020-07-02T00:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjI4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656283", "bodyText": "compilation issue here?", "author": "talevy", "createdAt": "2020-07-01T22:52:46Z", "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,\n+                                                      Map<String, StoredScriptSource> storedLookup) {\n+        ScriptEngine engine = new ScriptEngine() {\n+            @Override\n+            public String getType() {\n+                return \"lang\";\n+            }\n+\n+            @Override\n+            public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+                return context.factoryClazz.cast(compile.apply(code));\n+            }\n+\n+            @Override\n+            public Set<ScriptContext<?>> getSupportedContexts() {\n+                return Set.of(context);\n+            }\n+        };\n+        return new MockScriptService(Settings.EMPTY, Map.of(\"lang\", engine), Map.of(context.name, context)) {\n+            @Override\n+            public StoredScriptSource getScriptFromClusterState(String id) {", "originalCommit": "a9d23354cc1ba239d4481309f29b298b204ead6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16f54aa31b0137f3e6886c569eaad05cf1d64b6b", "url": "https://github.com/elastic/elasticsearch/commit/16f54aa31b0137f3e6886c569eaad05cf1d64b6b", "message": "fix test compile", "committedDate": "2020-07-01T23:08:22Z", "type": "commit"}, {"oid": "8c9179bb593c4c2d84b76ce5cc9204b1e87e0246", "url": "https://github.com/elastic/elasticsearch/commit/8c9179bb593c4c2d84b76ce5cc9204b1e87e0246", "message": "checkstyle", "committedDate": "2020-07-01T23:53:26Z", "type": "commit"}]}