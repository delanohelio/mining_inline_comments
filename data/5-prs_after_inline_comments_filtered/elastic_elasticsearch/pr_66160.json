{"pr_number": 66160, "pr_title": "Improve FieldFetcher retrieval of fields", "pr_createdAt": "2020-12-10T11:47:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66160", "timeline": [{"oid": "b600744061d467a5b7ac2209afb58f9a63965141", "url": "https://github.com/elastic/elasticsearch/commit/b600744061d467a5b7ac2209afb58f9a63965141", "message": "Improve FieldFetcher retrieval of fields\n\nCurrently FieldFetcher stores all the FieldContexts that are later used to\nretrieve the fields in a List. This has the disadvantage that the same field\npath can be retrieved several times (e.g. if multiple patterns match the same\npath or if similar paths are defined several times e.g. with different formats).\nCurrently the last value to be retrieved \"wins\" and gets returned. We might as\nwell de-duplicate the FieldContexts by using a map internally, keyed by the\nfield path that is going to be retrieved, to avoid more work later.", "committedDate": "2020-12-10T11:42:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ1MzA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/66160#discussion_r540453098", "bodyText": "I think it'd make sense to use a LinkedHashMap here -- then the fields would come back in the order requested. For example if you passed \"fields\": [ \"name\", \"title\"], then it'd be nice to return\n\"fields\": {\n  \"name\": [ \"christoph\"],\n  \"title\": [ \"engineer\" ]\n}\n\nWe wouldn't make a formal guarantee about order (since it's a JSON map), I think it helps readability for debugging, etc.", "author": "jtibshirani", "createdAt": "2020-12-10T19:52:22Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FieldFetcher.java", "diffHunk": "@@ -48,7 +48,7 @@ public static FieldFetcher create(QueryShardContext context,\n                                       SearchLookup searchLookup,\n                                       Collection<FieldAndFormat> fieldAndFormats) {\n \n-        List<FieldContext> fieldContexts = new ArrayList<>();\n+        Map<String, FieldContext> fieldContexts = new HashMap<>();", "originalCommit": "b600744061d467a5b7ac2209afb58f9a63965141", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ1MzI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/66160#discussion_r540453278", "bodyText": "Could we remove this set, and instead rely on fieldContexts.containsKey(...)?", "author": "jtibshirani", "createdAt": "2020-12-10T19:52:38Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FieldFetcher.java", "diffHunk": "@@ -48,7 +48,7 @@ public static FieldFetcher create(QueryShardContext context,\n                                       SearchLookup searchLookup,\n                                       Collection<FieldAndFormat> fieldAndFormats) {\n \n-        List<FieldContext> fieldContexts = new ArrayList<>();\n+        Map<String, FieldContext> fieldContexts = new HashMap<>();\n         List<String> unmappedFetchPattern = new ArrayList<>();\n         Set<String> mappedToExclude = new HashSet<>();", "originalCommit": "b600744061d467a5b7ac2209afb58f9a63965141", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODI2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66160#discussion_r542308267", "bodyText": "Sure, great unintended side effect", "author": "cbuescher", "createdAt": "2020-12-14T11:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ1MzI3OA=="}], "type": "inlineReview"}, {"oid": "fb1bd84bab7f6ecbb7acf896b6448ab9e54384ad", "url": "https://github.com/elastic/elasticsearch/commit/fb1bd84bab7f6ecbb7acf896b6448ab9e54384ad", "message": "iter", "committedDate": "2020-12-14T11:25:57Z", "type": "commit"}, {"oid": "afea33ecc1e30cc6e6bd218ebb0b8b9fb6b0a423", "url": "https://github.com/elastic/elasticsearch/commit/afea33ecc1e30cc6e6bd218ebb0b8b9fb6b0a423", "message": "Merge branch 'master' into ff-list-to-set", "committedDate": "2020-12-14T11:55:28Z", "type": "commit"}]}