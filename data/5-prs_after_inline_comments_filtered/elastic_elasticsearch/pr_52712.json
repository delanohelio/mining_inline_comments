{"pr_number": 52712, "pr_title": "[Transform] implement node.transform to control where to run a transform", "pr_createdAt": "2020-02-24T15:45:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52712", "timeline": [{"oid": "71b427d0baf4761ab2eec8b84dd44e66503781e6", "url": "https://github.com/elastic/elasticsearch/commit/71b427d0baf4761ab2eec8b84dd44e66503781e6", "message": "document node.transform", "committedDate": "2020-02-25T09:28:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc5NTg2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r383795862", "bodyText": "nit: two strings appended on same line could be made into a single string", "author": "droberts195", "createdAt": "2020-02-25T10:38:04Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java", "diffHunk": "@@ -296,13 +321,40 @@ protected XPackLicenseState getLicenseState() {\n         // the transform services should have been created\n         assert transformServices.get() != null;\n \n-        return Collections.singletonList(new TransformPersistentTasksExecutor(client, transformServices.get(), threadPool, clusterService,\n-            settingsModule.getSettings(), expressionResolver));\n+        return Collections.singletonList(\n+            new TransformPersistentTasksExecutor(\n+                client,\n+                transformServices.get(),\n+                threadPool,\n+                clusterService,\n+                settingsModule.getSettings(),\n+                expressionResolver\n+            )\n+        );\n     }\n \n     @Override\n     public List<Setting<?>> getSettings() {\n-        return Collections.singletonList(NUM_FAILURE_RETRIES_SETTING);\n+        return Collections.unmodifiableList(Arrays.asList(TRANSFORM_ENABLED_NODE, NUM_FAILURE_RETRIES_SETTING));\n+    }\n+\n+    @Override\n+    public Settings additionalSettings() {\n+        String transformEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_ENABLED_NODE_ATTR;\n+        String transformRemoteEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_REMOTE_ENABLED_NODE_ATTR;\n+\n+        if (settings.get(transformEnabledNodeAttribute) != null || settings.get(transformRemoteEnabledNodeAttribute) != null) {\n+            throw new IllegalArgumentException(\n+                \"Directly setting transform node attributes is not permitted,\" + \" please use the documented node settings instead\"", "originalCommit": "4fb49f86e6f6e96fddf4b507ae68efe8a1f88ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc5ODQ2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r383798460", "bodyText": "It should return Settings.EMPTY here if enabled == false.\nSame as ML does in \n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\n    \n    \n         Line 463\n      in\n      0d1e67d\n    \n    \n    \n    \n\n        \n          \n           return Settings.EMPTY;", "author": "droberts195", "createdAt": "2020-02-25T10:42:51Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java", "diffHunk": "@@ -296,13 +321,40 @@ protected XPackLicenseState getLicenseState() {\n         // the transform services should have been created\n         assert transformServices.get() != null;\n \n-        return Collections.singletonList(new TransformPersistentTasksExecutor(client, transformServices.get(), threadPool, clusterService,\n-            settingsModule.getSettings(), expressionResolver));\n+        return Collections.singletonList(\n+            new TransformPersistentTasksExecutor(\n+                client,\n+                transformServices.get(),\n+                threadPool,\n+                clusterService,\n+                settingsModule.getSettings(),\n+                expressionResolver\n+            )\n+        );\n     }\n \n     @Override\n     public List<Setting<?>> getSettings() {\n-        return Collections.singletonList(NUM_FAILURE_RETRIES_SETTING);\n+        return Collections.unmodifiableList(Arrays.asList(TRANSFORM_ENABLED_NODE, NUM_FAILURE_RETRIES_SETTING));\n+    }\n+\n+    @Override\n+    public Settings additionalSettings() {\n+        String transformEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_ENABLED_NODE_ATTR;\n+        String transformRemoteEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_REMOTE_ENABLED_NODE_ATTR;\n+\n+        if (settings.get(transformEnabledNodeAttribute) != null || settings.get(transformRemoteEnabledNodeAttribute) != null) {\n+            throw new IllegalArgumentException(\n+                \"Directly setting transform node attributes is not permitted,\" + \" please use the documented node settings instead\"\n+            );\n+        }\n+", "originalCommit": "4fb49f86e6f6e96fddf4b507ae68efe8a1f88ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgwMzM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r383803370", "bodyText": "I think this should only be checked for nodes that are on versions earlier than 7.7.\nTo match the documentation transforms should run on nodes that are defined as transform nodes, regardless of whether they are also data nodes.\nAnd then since we didn't have transform nodes prior to 7.7 the BWC logic should be that pre-7.7 nodes are transform nodes if and only if they are data nodes.", "author": "droberts195", "createdAt": "2020-02-25T10:51:33Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformPersistentTasksExecutor.java", "diffHunk": "@@ -97,11 +100,69 @@ public TransformPersistentTasksExecutor(\n             logger.debug(reason);\n             return new PersistentTasksCustomMetaData.Assignment(null, reason);\n         }\n-        DiscoveryNode discoveryNode = selectLeastLoadedNode(\n-            clusterState,\n-            (node) -> node.isDataNode() && node.getVersion().onOrAfter(params.getVersion())\n-        );\n-        return discoveryNode == null ? NO_NODE_FOUND : new PersistentTasksCustomMetaData.Assignment(discoveryNode.getId(), \"\");\n+        DiscoveryNode discoveryNode = selectLeastLoadedNode(clusterState, (node) -> nodeCanRunThisTransform(node, params, null));\n+\n+        if (discoveryNode == null) {\n+            Map<String, String> explainWhyAssignmentFailed = new TreeMap<>();\n+            for (DiscoveryNode node : clusterState.getNodes()) {\n+                nodeCanRunThisTransform(node, params, explainWhyAssignmentFailed);\n+            }\n+            String reason = \"Not starting transform [\"\n+                + params.getId()\n+                + \"], reasons [\"\n+                + explainWhyAssignmentFailed.entrySet().stream().map(e -> e.getKey() + \":\" + e.getValue()).collect(Collectors.joining(\"|\"))\n+                + \"]\";\n+\n+            logger.debug(reason);\n+            return new PersistentTasksCustomMetaData.Assignment(null, reason);\n+        }\n+\n+        return new PersistentTasksCustomMetaData.Assignment(discoveryNode.getId(), \"\");\n+    }\n+\n+    public static boolean nodeCanRunThisTransform(DiscoveryNode node, TransformTaskParams params, Map<String, String> explain) {\n+        // data node?\n+        if (node.isDataNode() == false) {", "originalCommit": "4fb49f86e6f6e96fddf4b507ae68efe8a1f88ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg1NTU0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r383855546", "bodyText": "I realised that in my previous review where I suggested not taking node.data into account in the assignment that this could cause a surprise to users who don't adjust their elasticsearch.yml after upgrading to 7.7, because it would mean transforms would start running on all types of nodes instead of just data nodes.\nSo an additional change I would suggest to prevent this is that the default value of node.transform be xpack.transform.enabled && node.data.  In other words, if node.transform is not explicitly specified then it is false if either xpack.transform.enabled is false or node.data is false, and true otherwise.\nThis complex default value can be implemented using the Setting factory method that takes a Function for the default value: \n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/common/settings/Setting.java\n    \n    \n         Line 1264\n      in\n      012746d\n    \n    \n    \n    \n\n        \n          \n           public static Setting<Boolean> boolSetting(String key, Function<Settings, String> defaultValueFn, Property... properties) {", "author": "droberts195", "createdAt": "2020-02-25T12:44:44Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java", "diffHunk": "@@ -137,6 +139,23 @@\n         Setting.Property.Dynamic\n     );\n \n+    /**\n+     * Node attributes for transform, automatically created and retrievable via cluster state.\n+     * These attributes should never be set directly, use the node setting counter parts instead.\n+     */\n+    public static final String TRANSFORM_ENABLED_NODE_ATTR = \"transform.node\";\n+    public static final String TRANSFORM_REMOTE_ENABLED_NODE_ATTR = \"transform.remote_connect\";\n+\n+    /**\n+     * Setting whether transform (the coordinator task) can run on this node and REST API's are available,\n+     * respects xpack.transform.enabled (for the whole plugin) as fallback\n+     */\n+    public static final Setting<Boolean> TRANSFORM_ENABLED_NODE = Setting.boolSetting(\n+        \"node.transform\",\n+        XPackSettings.TRANSFORM_ENABLED,", "originalCommit": "4fb49f86e6f6e96fddf4b507ae68efe8a1f88ad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYyMTQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r385621478", "bodyText": "In the ML plugin we ban these node attributes even when the plugin is disabled.  In other words the enabled == false check comes after the check that throws this error.  I think it's best because otherwise you can get the weird situation where somebody sets the node attribute directly when the plugin is disabled on a node and then other nodes in the cluster might assign transform persistent tasks to the node.  Such tasks wouldn't do anything because no plugin would be watching for them on the node they're assigned to.\n(Of course, this is an extreme edge case and unlikely to ever happen.  It also ties in with the conversation about whether it should be permitted to disable plugins on just a subset of nodes.  Moving to a world where transforms is always enabled will simplify things a lot.)", "author": "droberts195", "createdAt": "2020-02-28T10:34:36Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java", "diffHunk": "@@ -296,13 +322,44 @@ protected XPackLicenseState getLicenseState() {\n         // the transform services should have been created\n         assert transformServices.get() != null;\n \n-        return Collections.singletonList(new TransformPersistentTasksExecutor(client, transformServices.get(), threadPool, clusterService,\n-            settingsModule.getSettings(), expressionResolver));\n+        return Collections.singletonList(\n+            new TransformPersistentTasksExecutor(\n+                client,\n+                transformServices.get(),\n+                threadPool,\n+                clusterService,\n+                settingsModule.getSettings(),\n+                expressionResolver\n+            )\n+        );\n     }\n \n     @Override\n     public List<Setting<?>> getSettings() {\n-        return Collections.singletonList(NUM_FAILURE_RETRIES_SETTING);\n+        return Collections.unmodifiableList(Arrays.asList(TRANSFORM_ENABLED_NODE, NUM_FAILURE_RETRIES_SETTING));\n+    }\n+\n+    @Override\n+    public Settings additionalSettings() {\n+        String transformEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_ENABLED_NODE_ATTR;\n+        String transformRemoteEnabledNodeAttribute = \"node.attr.\" + TRANSFORM_REMOTE_ENABLED_NODE_ATTR;\n+\n+        if (enabled == false) {\n+            return Settings.EMPTY;\n+        }\n+\n+        if (settings.get(transformEnabledNodeAttribute) != null || settings.get(transformRemoteEnabledNodeAttribute) != null) {\n+            throw new IllegalArgumentException(\n+                \"Directly setting transform node attributes is not permitted, please use the documented node settings instead\"", "originalCommit": "24c50424852b1e6fdb48fb69227325b64b6d6d26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYyODA2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52712#discussion_r385628060", "bodyText": "I would use the phrase not a transform node instead of transform not enabled.  Users can see this reason and not a transform node more clearly ties the reason to the node.transform setting and the docs about transform nodes.  It's also more consistent with not a data node from line 136.", "author": "droberts195", "createdAt": "2020-02-28T10:48:12Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformPersistentTasksExecutor.java", "diffHunk": "@@ -99,9 +102,88 @@ public TransformPersistentTasksExecutor(\n         }\n         DiscoveryNode discoveryNode = selectLeastLoadedNode(\n             clusterState,\n-            (node) -> node.isDataNode() && node.getVersion().onOrAfter(params.getVersion())\n+            (node) -> node.getVersion().onOrAfter(Version.V_8_0_0)\n+                ? nodeCanRunThisTransform(node, params, null)\n+                : nodeCanRunThisTransformPre77(node, params, null)\n         );\n-        return discoveryNode == null ? NO_NODE_FOUND : new PersistentTasksCustomMetaData.Assignment(discoveryNode.getId(), \"\");\n+\n+        if (discoveryNode == null) {\n+            Map<String, String> explainWhyAssignmentFailed = new TreeMap<>();\n+            for (DiscoveryNode node : clusterState.getNodes()) {\n+                if (node.getVersion().onOrAfter(Version.V_8_0_0)) { // todo: V_7_7_0, remove from 8.0\n+                    nodeCanRunThisTransform(node, params, explainWhyAssignmentFailed);\n+                } else {\n+                    nodeCanRunThisTransformPre77(node, params, explainWhyAssignmentFailed);\n+                }\n+            }\n+            String reason = \"Not starting transform [\"\n+                + params.getId()\n+                + \"], reasons [\"\n+                + explainWhyAssignmentFailed.entrySet().stream().map(e -> e.getKey() + \":\" + e.getValue()).collect(Collectors.joining(\"|\"))\n+                + \"]\";\n+\n+            logger.debug(reason);\n+            return new PersistentTasksCustomMetaData.Assignment(null, reason);\n+        }\n+\n+        return new PersistentTasksCustomMetaData.Assignment(discoveryNode.getId(), \"\");\n+    }\n+\n+    // todo: this can be removed for 8.0 after backport\n+    public static boolean nodeCanRunThisTransformPre77(DiscoveryNode node, TransformTaskParams params, Map<String, String> explain) {\n+        if (node.isDataNode() == false) {\n+            if (explain != null) {\n+                explain.put(node.getId(), \"not a data node\");\n+            }\n+            return false;\n+        }\n+\n+        // version of the transform run on a node that has at least the same version\n+        if (node.getVersion().onOrAfter(params.getVersion()) == false) {\n+            if (explain != null) {\n+                explain.put(\n+                    node.getId(),\n+                    \"node has version: \" + node.getVersion() + \" but transform requires at least \" + params.getVersion()\n+                );\n+            }\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+\n+    public static boolean nodeCanRunThisTransform(DiscoveryNode node, TransformTaskParams params, Map<String, String> explain) {\n+        // version of the transform run on a node that has at least the same version\n+        if (node.getVersion().onOrAfter(params.getVersion()) == false) {\n+            if (explain != null) {\n+                explain.put(\n+                    node.getId(),\n+                    \"node has version: \" + node.getVersion() + \" but transform requires at least \" + params.getVersion()\n+                );\n+            }\n+            return false;\n+        }\n+\n+        final Map<String, String> nodeAttributes = node.getAttributes();\n+\n+        // transform enabled?\n+        if (Boolean.parseBoolean(nodeAttributes.get(Transform.TRANSFORM_ENABLED_NODE_ATTR)) == false) {\n+            if (explain != null) {\n+                explain.put(node.getId(), \"transform not enabled\");", "originalCommit": "24c50424852b1e6fdb48fb69227325b64b6d6d26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b526860cd42678292e2ed1a3ff24da269218146e", "url": "https://github.com/elastic/elasticsearch/commit/b526860cd42678292e2ed1a3ff24da269218146e", "message": "implement transform node attributes to disable transform on certain nodes\nand test which nodes are allowed to do remote connections", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "0e5f828a030e54f66d2ee6269ac3fb91efc73481", "url": "https://github.com/elastic/elasticsearch/commit/0e5f828a030e54f66d2ee6269ac3fb91efc73481", "message": "checkstyle", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "1d89040cb5b413d7abf03af1aab69c0492291f77", "url": "https://github.com/elastic/elasticsearch/commit/1d89040cb5b413d7abf03af1aab69c0492291f77", "message": "prepare BWC", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "32cb5a19fd6c855913cab4ae5f1a81b3cd91dc71", "url": "https://github.com/elastic/elasticsearch/commit/32cb5a19fd6c855913cab4ae5f1a81b3cd91dc71", "message": "document node.transform", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "b2cae58a91a5d6f31b2135690d7671b234d785e6", "url": "https://github.com/elastic/elasticsearch/commit/b2cae58a91a5d6f31b2135690d7671b234d785e6", "message": "check only for 8.0.0 until its backported", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "5add54e23ccece0e7912e1ba1ce314c7b8beff67", "url": "https://github.com/elastic/elasticsearch/commit/5add54e23ccece0e7912e1ba1ce314c7b8beff67", "message": "fix optional boolean value", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "442e895aafec7ba19fbb7193a546a7565d1ac51c", "url": "https://github.com/elastic/elasticsearch/commit/442e895aafec7ba19fbb7193a546a7565d1ac51c", "message": "change node.transform, so that dedicated transform nodes are possible", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "0808be3d0206949c726d4398c639fedf21394d23", "url": "https://github.com/elastic/elasticsearch/commit/0808be3d0206949c726d4398c639fedf21394d23", "message": "fix NPE in usage retrieval if task state is null\n\nfixes #48734", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "f4ef13f956100e91331c28f22d021b7c933a7ebf", "url": "https://github.com/elastic/elasticsearch/commit/f4ef13f956100e91331c28f22d021b7c933a7ebf", "message": "avoid network call to all nodes in case no tasks are running", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "ad232f4d57e089aa8eb03db1e83143bac3f8e1bc", "url": "https://github.com/elastic/elasticsearch/commit/ad232f4d57e089aa8eb03db1e83143bac3f8e1bc", "message": "Update docs/reference/settings/transform-settings.asciidoc\n\nCo-Authored-By: David Roberts <dave.roberts@elastic.co>", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "2de91c12f6fcdd6eba9ea69ecb662d62396d67d7", "url": "https://github.com/elastic/elasticsearch/commit/2de91c12f6fcdd6eba9ea69ecb662d62396d67d7", "message": "add a note for dedicated coordinating/master nodes", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "52e706ab809891e4008a135b55c4caa66fc3851b", "url": "https://github.com/elastic/elasticsearch/commit/52e706ab809891e4008a135b55c4caa66fc3851b", "message": "Revert \"avoid network call to all nodes in case no tasks are running\"\n\nThis reverts commit 870e716671680714a00728ef47c838747b27540d.", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "a5bfaf8ac09a320f7afd71249622da5d37616c26", "url": "https://github.com/elastic/elasticsearch/commit/a5bfaf8ac09a320f7afd71249622da5d37616c26", "message": "Update docs/reference/settings/transform-settings.asciidoc", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "0ea364b0a3f2d7471faca097a8f6d906fcd822be", "url": "https://github.com/elastic/elasticsearch/commit/0ea364b0a3f2d7471faca097a8f6d906fcd822be", "message": "Update TransformPersistentTasksExecutor.java", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "f957b34ac3da5c537a991c7f5cf45653ccfcf212", "url": "https://github.com/elastic/elasticsearch/commit/f957b34ac3da5c537a991c7f5cf45653ccfcf212", "message": "Update Transform.java", "committedDate": "2020-02-28T15:41:04Z", "type": "commit"}, {"oid": "1a807580a3976c5f004769ff8f24731952aa341a", "url": "https://github.com/elastic/elasticsearch/commit/1a807580a3976c5f004769ff8f24731952aa341a", "message": "fix tests after renamings", "committedDate": "2020-02-28T15:41:05Z", "type": "commit"}, {"oid": "1a807580a3976c5f004769ff8f24731952aa341a", "url": "https://github.com/elastic/elasticsearch/commit/1a807580a3976c5f004769ff8f24731952aa341a", "message": "fix tests after renamings", "committedDate": "2020-02-28T15:41:05Z", "type": "forcePushed"}]}