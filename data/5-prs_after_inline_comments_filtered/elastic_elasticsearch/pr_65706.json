{"pr_number": 65706, "pr_title": "Adds a consistent shard index to ShardSearchRequest", "pr_createdAt": "2020-12-01T21:28:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65706", "timeline": [{"oid": "f666fa70242dda37a15ab158dfba27beddf5abae", "url": "https://github.com/elastic/elasticsearch/commit/f666fa70242dda37a15ab158dfba27beddf5abae", "message": "Adds a consistent shard index to ShardSearchRequest\n\nThis change ensures that the shard index that is used to tiebreak documents with identical sort\nremains consistent between two requests that target the same shards. The index is now always computed from the\nnatural order of the shards in the search request.\nThis change also adds the consistent shard index to the ShardSearchRequest. That allows the slice builder\nto use this information to build more balanced slice query.\n\nRelates #56828", "committedDate": "2020-12-01T21:26:53Z", "type": "commit"}, {"oid": "0ccc78de9b31b8e145f0083795478afd4746315c", "url": "https://github.com/elastic/elasticsearch/commit/0ccc78de9b31b8e145f0083795478afd4746315c", "message": "fix number of shards in slice builder", "committedDate": "2020-12-01T22:02:29Z", "type": "commit"}, {"oid": "a99e113de0c4bf7962e81c9d1b0b0da16f214315", "url": "https://github.com/elastic/elasticsearch/commit/a99e113de0c4bf7962e81c9d1b0b0da16f214315", "message": "fix tests", "committedDate": "2020-12-01T23:57:26Z", "type": "commit"}, {"oid": "02ae5402bf3bbbaf00492f248a846619d38a3c68", "url": "https://github.com/elastic/elasticsearch/commit/02ae5402bf3bbbaf00492f248a846619d38a3c68", "message": "restore randomization", "committedDate": "2020-12-02T00:05:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2ODYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/65706#discussion_r534468614", "bodyText": "I guess a case when shardIdex() = -1 (when a coordinating node is v < 8.0)  and there is a preference or indexRouting present in scroll slice is a very rare case, and we can disregard it.", "author": "mayya-sharipova", "createdAt": "2020-12-02T20:43:46Z", "path": "server/src/main/java/org/elasticsearch/search/slice/SliceBuilder.java", "diffHunk": "@@ -205,40 +197,14 @@ public int hashCode() {\n      * @param context Additional information needed to build the query\n      */\n     @SuppressWarnings(\"rawtypes\")\n-    public Query toFilter(ClusterService clusterService, ShardSearchRequest request, QueryShardContext context) {\n+    public Query toFilter(ShardSearchRequest request, QueryShardContext context) {\n         final MappedFieldType type = context.getFieldType(field);\n         if (type == null) {\n             throw new IllegalArgumentException(\"field \" + field + \" not found\");\n         }\n \n-        int shardId = request.shardId().id();\n-        int numShards = context.getIndexSettings().getNumberOfShards();\n-        if (request.preference() != null || request.indexRoutings().length > 0) {\n-            GroupShardsIterator<ShardIterator> group = buildShardIterator(clusterService, request);\n-            assert group.size() <= numShards : \"index routing shards: \" + group.size() +\n-                \" cannot be greater than total number of shards: \" + numShards;\n-            if (group.size() < numShards) {\n-                /*\n-                 * The routing of this request targets a subset of the shards of this index so we need to we retrieve\n-                 * the original {@link GroupShardsIterator} and compute the request shard id and number of\n-                 * shards from it.\n-                 */\n-                numShards = group.size();\n-                int ord = 0;\n-                shardId = -1;\n-                // remap the original shard id with its index (position) in the sorted shard iterator.\n-                for (ShardIterator it : group) {\n-                    assert it.shardId().getIndex().equals(request.shardId().getIndex());\n-                    if (request.shardId().equals(it.shardId())) {\n-                        shardId = ord;\n-                        break;\n-                    }\n-                    ++ord;\n-                }\n-                assert shardId != -1 : \"shard id: \" + request.shardId().getId() + \" not found in index shard routing\";\n-            }\n-        }\n-\n+        int shardIndex = request.shardIndex() != -1 ? request.shardIndex() : request.shardId().id();", "originalCommit": "02ae5402bf3bbbaf00492f248a846619d38a3c68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMwNzg3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65706#discussion_r537307875", "bodyText": "Yes, that's my reasoning too.", "author": "jimczi", "createdAt": "2020-12-07T08:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2ODYxNA=="}], "type": "inlineReview"}]}