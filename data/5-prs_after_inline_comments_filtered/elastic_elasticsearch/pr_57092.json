{"pr_number": 57092, "pr_title": "Flatten ReleaseableBytesReference Object Trees", "pr_createdAt": "2020-05-24T08:47:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57092", "timeline": [{"oid": "5a8b2382003449a06091c40a3a32299c3f59140a", "url": "https://github.com/elastic/elasticsearch/commit/5a8b2382003449a06091c40a3a32299c3f59140a", "message": "Flatten ReleaseableBytesReference Object Trees\n\nWhen slicing a releasable bytes reference we would create a new counter\nevery time and pass the original reference chain to the new slice on every\nslice invocation. This would lead to extremely deep reference chains and\nneedlessly uses a dedicated counter for every slice when all the slices\neventually just refer to the same underlying bytes and `Releasable`.\nThis commit tracks the ref count wrapper with its releasable in a separate\nobject that can be passed around on every slicing, making the slices' tree\nas flat as the original releasable bytes reference.\n\nAlso, we were needlessly creating a redundant releasable bytes reference from\na releasable bytes-stream-output that we never actually used for releasing (all code\nthat uses it just releases the stream itself instead).", "committedDate": "2020-05-24T08:40:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwNzk0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57092#discussion_r429807949", "bodyText": "I would prefer to move this call to the private ReleasableBytesReference constructor.", "author": "ywelsch", "createdAt": "2020-05-25T08:37:48Z", "path": "server/src/main/java/org/elasticsearch/common/bytes/ReleasableBytesReference.java", "diffHunk": "@@ -34,41 +33,44 @@\n  * An extension to {@link BytesReference} that requires releasing its content. This\n  * class exists to make it explicit when a bytes reference needs to be released, and when not.\n  */\n-public final class ReleasableBytesReference extends AbstractRefCounted implements Releasable, BytesReference {\n+public final class ReleasableBytesReference implements Releasable, BytesReference {\n \n     public static final Releasable NO_OP = () -> {};\n     private final BytesReference delegate;\n-    private final Releasable releasable;\n+    private final AbstractRefCounted refCounted;\n \n     public ReleasableBytesReference(BytesReference delegate, Releasable releasable) {\n-        super(\"bytes-reference\");\n         this.delegate = delegate;\n-        this.releasable = releasable;\n+        this.refCounted = new RefCountedReleasable(releasable);\n+    }\n+\n+    private ReleasableBytesReference(BytesReference delegate, AbstractRefCounted refCounted) {\n+        this.delegate = delegate;\n+        this.refCounted = refCounted;\n     }\n \n     public static ReleasableBytesReference wrap(BytesReference reference) {\n         return new ReleasableBytesReference(reference, NO_OP);\n     }\n \n-    @Override\n-    protected void closeInternal() {\n-        Releasables.close(releasable);\n+    public int refCount() {\n+        return refCounted.refCount();\n     }\n \n     public ReleasableBytesReference retain() {\n-        incRef();\n+        refCounted.incRef();\n         return this;\n     }\n \n     public ReleasableBytesReference retainedSlice(int from, int length) {\n         BytesReference slice = delegate.slice(from, length);\n-        incRef();\n-        return new ReleasableBytesReference(slice, this);\n+        refCounted.incRef();", "originalCommit": "5a8b2382003449a06091c40a3a32299c3f59140a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "483911044ce6319601fa98c6041d75b6963b58df", "url": "https://github.com/elastic/elasticsearch/commit/483911044ce6319601fa98c6041d75b6963b58df", "message": "Merge remote-tracking branch 'elastic/master' into flatten-releaseable-bytes-refs", "committedDate": "2020-05-25T08:41:30Z", "type": "commit"}, {"oid": "e7d419ca3dcb509c5858382ea823ca9b71f48427", "url": "https://github.com/elastic/elasticsearch/commit/e7d419ca3dcb509c5858382ea823ca9b71f48427", "message": "CR: increse ref elsewhere", "committedDate": "2020-05-25T08:47:00Z", "type": "commit"}]}