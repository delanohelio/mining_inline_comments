{"pr_number": 53821, "pr_title": "[ML] adjusting feature importance mapping for multi-class support", "pr_createdAt": "2020-03-19T17:40:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53821", "timeline": [{"oid": "e078a86294fe2d17703c6b3d894ba43bb8429936", "url": "https://github.com/elastic/elasticsearch/commit/e078a86294fe2d17703c6b3d894ba43bb8429936", "message": "[ML] adjusting feature importance mapping for multi-class support", "committedDate": "2020-03-19T17:36:07Z", "type": "commit"}, {"oid": "d439e202f20d77e6c94cb69d191aeef0e6118e38", "url": "https://github.com/elastic/elasticsearch/commit/d439e202f20d77e6c94cb69d191aeef0e6118e38", "message": "removing nested type for now", "committedDate": "2020-03-20T13:54:03Z", "type": "commit"}, {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "url": "https://github.com/elastic/elasticsearch/commit/b7cd8df470542a791a650b42d3dde5dfe93dc04a", "message": "Unmuting tests for feature importance integration", "committedDate": "2020-03-20T14:08:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MjExMg==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396262112", "bodyText": "Suggested change", "author": "przemekwitek", "createdAt": "2020-03-23T07:53:08Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/MapUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ *//*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml.dataframe.analyses;\n+\n+import org.elasticsearch.index.mapper.KeywordFieldMapper;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+final class MapUtils {\n+", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MzkzNw==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396263937", "bodyText": "You could put the hasEntry assertion into allOf in line 257 where the other hasEntry assertions are.", "author": "przemekwitek", "createdAt": "2020-03-23T07:57:33Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/ClassificationTests.java", "diffHunk": "@@ -244,39 +243,45 @@ public void testFieldCardinalityLimitsIsNonEmpty() {\n     }\n \n     public void testGetExplicitlyMappedFields() {\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"), is(anEmptyMap()));\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"), is(anEmptyMap()));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n         assertThat(\n             new Classification(\"foo\").getExplicitlyMappedFields(Collections.singletonMap(\"foo\", \"not_a_map\"), \"results\"),\n-            is(anEmptyMap()));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n-                \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        Map<String, Object> explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"bar\", \"baz\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"bar\", \"baz\"))));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                new HashMap<>() {{\n-                    put(\"foo\", new HashMap<>() {{\n-                        put(\"type\", \"alias\");\n-                        put(\"path\", \"bar\");\n-                    }});\n-                    put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n-                }},\n-                \"results\"),\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMDM2OA==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396420368", "bodyText": "no, it doesn't work because they are not all of the same type.", "author": "benwtrent", "createdAt": "2020-03-23T12:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MzkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzMjcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396432715", "bodyText": "Ok, understand.", "author": "przemekwitek", "createdAt": "2020-03-23T13:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MzkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NDA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396264099", "bodyText": "Same here.", "author": "przemekwitek", "createdAt": "2020-03-23T07:57:51Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/ClassificationTests.java", "diffHunk": "@@ -244,39 +243,45 @@ public void testFieldCardinalityLimitsIsNonEmpty() {\n     }\n \n     public void testGetExplicitlyMappedFields() {\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"), is(anEmptyMap()));\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"), is(anEmptyMap()));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n         assertThat(\n             new Classification(\"foo\").getExplicitlyMappedFields(Collections.singletonMap(\"foo\", \"not_a_map\"), \"results\"),\n-            is(anEmptyMap()));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n-                \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        Map<String, Object> explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"bar\", \"baz\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"bar\", \"baz\"))));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                new HashMap<>() {{\n-                    put(\"foo\", new HashMap<>() {{\n-                        put(\"type\", \"alias\");\n-                        put(\"path\", \"bar\");\n-                    }});\n-                    put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n-                }},\n-                \"results\"),\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));\n+\n+        explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            new HashMap<>() {{\n+                put(\"foo\", new HashMap<>() {{\n+                    put(\"type\", \"alias\");\n+                    put(\"path\", \"bar\");\n+                }});\n+                put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n+            }},\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"type\", \"long\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"type\", \"long\"))));\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyMDU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396420577", "bodyText": "same as above, I initially did this but it wouldn't compile for some reason.", "author": "benwtrent", "createdAt": "2020-03-23T12:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NDA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTIxNw==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396265217", "bodyText": "You could use more idiomatic hasSize(greaterThan(0)) here.", "author": "przemekwitek", "createdAt": "2020-03-23T08:00:28Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -86,11 +87,13 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(resultsObject.containsKey(predictedClassField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n             assertThat(resultsObject.get(\"is_training\"), is(destDoc.containsKey(DEPENDENT_VARIABLE_FIELD)));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396265719", "bodyText": "findAny() returns Optional so you could use it as a subject and the assertion would be isPresent from OptionalMatchers.", "author": "przemekwitek", "createdAt": "2020-03-23T08:01:38Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -86,11 +87,13 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(resultsObject.containsKey(predictedClassField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n             assertThat(resultsObject.get(\"is_training\"), is(destDoc.containsKey(DEPENDENT_VARIABLE_FIELD)));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));\n             assertThat(\n-                resultsObject.toString(),\n-                resultsObject.containsKey(\"feature_importance.\" + NUMERICAL_FEATURE_FIELD)\n-                    || resultsObject.containsKey(\"feature_importance.\" + DISCRETE_NUMERICAL_FEATURE_FIELD),\n-                is(true));\n+                importanceArray.stream().filter(m -> NUMERICAL_FEATURE_FIELD.equals(m.get(\"feature_name\"))\n+                    || DISCRETE_NUMERICAL_FEATURE_FIELD.equals(m.get(\"feature_name\"))).findAny().orElse(null),", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyNDEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396424131", "bodyText": "from what I can tell, our version of hamcrest does not have this.", "author": "benwtrent", "createdAt": "2020-03-23T12:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyNjUxMA==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396426510", "bodyText": "It's our (i.e. elasticsearch) class: org.elasticsearch.test.hamcrest.OptionalMatchers", "author": "przemekwitek", "createdAt": "2020-03-23T12:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyNjg4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396426887", "bodyText": "found it! Will update in a sec.", "author": "benwtrent", "createdAt": "2020-03-23T12:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NjAxMw==", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396266013", "bodyText": "You could use more idiomatic hasSize(greaterThan(0)) here.", "author": "przemekwitek", "createdAt": "2020-03-23T08:02:24Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -107,7 +106,9 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(getFieldValue(resultsObject, predictedClassField), is(in(KEYWORD_FIELD_VALUES)));\n             assertThat(getFieldValue(resultsObject, \"is_training\"), is(destDoc.containsKey(KEYWORD_FIELD)));\n             assertTopClasses(resultsObject, 2, KEYWORD_FIELD, KEYWORD_FIELD_VALUES);\n-            assertThat(resultsObject.keySet().stream().filter(k -> k.startsWith(\"feature_importance.\")).findAny().isPresent(), is(true));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));", "originalCommit": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d2e7683658ff0ec0dd5b6f644daaaf23ab258bb", "url": "https://github.com/elastic/elasticsearch/commit/6d2e7683658ff0ec0dd5b6f644daaaf23ab258bb", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-analysis-adjust-feature-importance-format", "committedDate": "2020-03-23T12:39:40Z", "type": "commit"}, {"oid": "b1d0367c4b562e3ac317c9d955843e35512557e9", "url": "https://github.com/elastic/elasticsearch/commit/b1d0367c4b562e3ac317c9d955843e35512557e9", "message": "addressing pr comments", "committedDate": "2020-03-23T12:48:22Z", "type": "commit"}, {"oid": "8e887eaa4f1607cba6309c9788cf3d4e3c4a7cb2", "url": "https://github.com/elastic/elasticsearch/commit/8e887eaa4f1607cba6309c9788cf3d4e3c4a7cb2", "message": "addressing PR comment", "committedDate": "2020-03-23T13:01:18Z", "type": "commit"}]}