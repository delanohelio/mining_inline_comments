{"pr_number": 50856, "pr_title": "Fix testSkipRefreshIfShardIsRefreshingAlready", "pr_createdAt": "2020-01-10T14:15:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50856", "timeline": [{"oid": "66a6dee721ea3a438b8d436738bf5b12e0c7729e", "url": "https://github.com/elastic/elasticsearch/commit/66a6dee721ea3a438b8d436738bf5b12e0c7729e", "message": "Fix testSkipRefreshIfShardIsRefreshingAlready\n\nThe test checked queue size and active count, however,\nThreadPoolExecutor pulls out the request from the queue before marking\nthe worker active, risking that we think all tasks are done when they\nare not. Now check on completed-tasks metric instead, which is\nguaranteed to be monotonic.\n\nRelates #50769", "committedDate": "2020-01-10T14:11:40Z", "type": "commit"}, {"oid": "1b8867eba3c804db2852bed662c16248c5b0d79c", "url": "https://github.com/elastic/elasticsearch/commit/1b8867eba3c804db2852bed662c16248c5b0d79c", "message": "Removed print statement.", "committedDate": "2020-01-10T14:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI1NzE0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50856#discussion_r365257142", "bodyText": "I guess this is a leftover.", "author": "dnhatn", "createdAt": "2020-01-10T14:25:14Z", "path": "server/src/test/java/org/elasticsearch/indices/IndexingMemoryControllerTests.java", "diffHunk": "@@ -432,20 +432,20 @@ protected long getShardWritingBytes(IndexShard shard) {\n             }\n         };\n         int iterations = randomIntBetween(10, 100);\n+        ThreadPoolStats.Stats beforeStats = getRefreshThreadPoolStats();\n         for (int i = 0; i < iterations; i++) {\n             controller.forceCheck();\n         }\n         assertBusy(() -> {\n             ThreadPoolStats.Stats stats = getRefreshThreadPoolStats();\n-            assertThat(stats.getQueue(), equalTo(0));\n-            assertThat(stats.getActive(), equalTo(1));\n+            assertThat(stats.getCompleted(), equalTo(beforeStats.getCompleted() + iterations - 1));\n         });\n         refreshLatch.get().countDown(); // allow refresh\n         assertBusy(() -> {\n             ThreadPoolStats.Stats stats = getRefreshThreadPoolStats();\n-            assertThat(stats.getQueue(), equalTo(0));\n-            assertThat(stats.getActive(), equalTo(0));\n+            assertThat(stats.getCompleted(), equalTo(beforeStats.getCompleted() + iterations));\n         });\n+        System.out.println(shard.refreshStats().getTotal());", "originalCommit": "66a6dee721ea3a438b8d436738bf5b12e0c7729e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI2MDEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50856#discussion_r365260131", "bodyText": "Yes, thanks, fixed in 1b8867e", "author": "henningandersen", "createdAt": "2020-01-10T14:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI1NzE0Mg=="}], "type": "inlineReview"}]}