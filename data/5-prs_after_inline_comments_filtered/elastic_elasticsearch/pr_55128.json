{"pr_number": 55128, "pr_title": "[ML] adding prediction_field_type to inference config", "pr_createdAt": "2020-04-13T19:09:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55128", "timeline": [{"oid": "16713a7d4d0dd7cd11110a96d916b4a6ba8fa0aa", "url": "https://github.com/elastic/elasticsearch/commit/16713a7d4d0dd7cd11110a96d916b4a6ba8fa0aa", "message": "[ML] adding predicted_field_type to inference config", "committedDate": "2020-04-13T19:00:57Z", "type": "commit"}, {"oid": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "url": "https://github.com/elastic/elasticsearch/commit/54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "message": "Merge branch 'master' into feature/ml-inference-handle-different-target-field-typs", "committedDate": "2020-04-13T19:26:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwMjgyMw==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408102823", "bodyText": "Could you add class-level comment?", "author": "przemekwitek", "createdAt": "2020-04-14T12:39:40Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictedFieldType.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+public enum PredictedFieldType implements Writeable {", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwMjk5MA==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408102990", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final double EPS = 1.0E-9;\n          \n          \n            \n                private static final double EPS = 1.0E-9;", "author": "przemekwitek", "createdAt": "2020-04-14T12:39:52Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictedFieldType.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+public enum PredictedFieldType implements Writeable {\n+\n+    STRING,\n+    NUMBER,\n+    BOOLEAN;\n+\n+    private static final double EPS = 1.0E-9;", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwMzU0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408103545", "bodyText": "Could fromString and toString methods be next to each other so that it's easier to examine whether they are compatible?", "author": "przemekwitek", "createdAt": "2020-04-14T12:40:42Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictedFieldType.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+public enum PredictedFieldType implements Writeable {\n+\n+    STRING,\n+    NUMBER,\n+    BOOLEAN;\n+\n+    private static final double EPS = 1.0E-9;\n+    public static PredictedFieldType fromString(String name) {\n+        return valueOf(name.trim().toUpperCase(Locale.ROOT));\n+    }\n+\n+    public static PredictedFieldType fromStream(StreamInput in) throws IOException {\n+        return in.readEnum(PredictedFieldType.class);\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeEnum(this);\n+    }\n+\n+    @Override\n+    public String toString() {", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNzg1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408207856", "bodyText": "I prefer to keep public static methods near the top and member methods together.\nThe class is small enough that you don't have to scroll as it is to look at both methods", "author": "benwtrent", "createdAt": "2020-04-14T15:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwMzU0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNDg5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408104892", "bodyText": "IMO switch(this) would result in more readable code here.", "author": "przemekwitek", "createdAt": "2020-04-14T12:42:46Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictedFieldType.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+public enum PredictedFieldType implements Writeable {\n+\n+    STRING,\n+    NUMBER,\n+    BOOLEAN;\n+\n+    private static final double EPS = 1.0E-9;\n+    public static PredictedFieldType fromString(String name) {\n+        return valueOf(name.trim().toUpperCase(Locale.ROOT));\n+    }\n+\n+    public static PredictedFieldType fromStream(StreamInput in) throws IOException {\n+        return in.readEnum(PredictedFieldType.class);\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeEnum(this);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return name().toLowerCase(Locale.ROOT);\n+    }\n+\n+    public Object transformPredictedValue(Double value, String stringRep) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if(this == STRING) {", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408106239", "bodyText": "Can it be the case the value is greater than 1.0?", "author": "przemekwitek", "createdAt": "2020-04-14T12:44:43Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictedFieldType.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+public enum PredictedFieldType implements Writeable {\n+\n+    STRING,\n+    NUMBER,\n+    BOOLEAN;\n+\n+    private static final double EPS = 1.0E-9;\n+    public static PredictedFieldType fromString(String name) {\n+        return valueOf(name.trim().toUpperCase(Locale.ROOT));\n+    }\n+\n+    public static PredictedFieldType fromStream(StreamInput in) throws IOException {\n+        return in.readEnum(PredictedFieldType.class);\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeEnum(this);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return name().toLowerCase(Locale.ROOT);\n+    }\n+\n+    public Object transformPredictedValue(Double value, String stringRep) {\n+        if (value == null) {\n+            return null;\n+        }\n+        if(this == STRING) {\n+            return stringRep == null ? value.toString() : stringRep;\n+        }\n+        if(this == BOOLEAN) {\n+            return (1.0 - value) < EPS;", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODQwMw==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408248403", "bodyText": "added boundary checks and an exception if it is out of bounds.", "author": "benwtrent", "createdAt": "2020-04-14T15:54:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408106979", "bodyText": "Is it possible to unify and use predictedFieldType or predictionFieldType throughout the codebase?", "author": "przemekwitek", "createdAt": "2020-04-14T12:45:55Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/ClassificationConfig.java", "diffHunk": "@@ -27,15 +27,17 @@\n     public static final ParseField NUM_TOP_CLASSES = new ParseField(\"num_top_classes\");\n     public static final ParseField TOP_CLASSES_RESULTS_FIELD = new ParseField(\"top_classes_results_field\");\n     public static final ParseField NUM_TOP_FEATURE_IMPORTANCE_VALUES = new ParseField(\"num_top_feature_importance_values\");\n+    public static final ParseField PREDICTION_FIELD_TYPE = new ParseField(\"prediction_field_type\");\n     private static final Version MIN_SUPPORTED_VERSION = Version.V_7_6_0;\n \n     public static ClassificationConfig EMPTY_PARAMS =\n-        new ClassificationConfig(0, DEFAULT_RESULTS_FIELD, DEFAULT_TOP_CLASSES_RESULTS_FIELD, null);\n+        new ClassificationConfig(0, DEFAULT_RESULTS_FIELD, DEFAULT_TOP_CLASSES_RESULTS_FIELD, null, null);\n \n     private final int numTopClasses;\n     private final String topClassesResultsField;\n     private final String resultsField;\n     private final int numTopFeatureImportanceValues;\n+    private final PredictedFieldType predictedFieldType;", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNzMzNg==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408117336", "bodyText": "One suggestion that would help keeping the strings \"string\", \"int\", \"bool\" in one class would be as follows:\n\nMake Classification.getPredictionFieldType method return the new PredictedFieldType enum.\nHere (i.e. in AnalyticsResultProcessor) remove the translation in lines 277-285 (maybe keep the null -> STRING translation)\nThere (i.e. in Classification) in getParams method translate the enum to appropriate string (\"string\", \"int\", \"bool\").", "author": "przemekwitek", "createdAt": "2020-04-14T13:01:47Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsResultProcessor.java", "diffHunk": "@@ -255,14 +259,36 @@ private InferenceConfig buildInferenceConfig(TargetType targetType) {\n                     .setNumTopFeatureImportanceValues(regression.getBoostedTreeParams().getNumTopFeatureImportanceValues())\n                     .build();\n             default:\n-                setAndReportFailure(ExceptionsHelper.serverError(\n+                throw ExceptionsHelper.serverError(\n                     \"process created a model with an unsupported target type [{}]\",\n                     null,\n-                    targetType));\n-                return null;\n+                    targetType);\n         }\n     }\n \n+    PredictedFieldType getPredictedFieldType(Classification classification) {", "originalCommit": "54bac3378fcce7a7777b25b8c5e5e0ace8439b8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06e7d3e563a00788a1eec03a0c8ca321bcec478f", "url": "https://github.com/elastic/elasticsearch/commit/06e7d3e563a00788a1eec03a0c8ca321bcec478f", "message": "addressing PR comments", "committedDate": "2020-04-14T15:53:43Z", "type": "commit"}, {"oid": "e327c18689364543e580c0ce5ec2894846938352", "url": "https://github.com/elastic/elasticsearch/commit/e327c18689364543e580c0ce5ec2894846938352", "message": "Merge branch 'feature/ml-inference-handle-different-target-field-typs' of github.com:benwtrent/elasticsearch into feature/ml-inference-handle-different-target-field-typs", "committedDate": "2020-04-14T15:53:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYwMjMwNA==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408602304", "bodyText": "Could areClose be used here as well for clarity?", "author": "przemekwitek", "createdAt": "2020-04-15T06:11:20Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictionFieldType.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+/**\n+ * The type of the predicted field.\n+ * This modifies how the predicted class values are written for classification models\n+ */\n+public enum PredictionFieldType implements Writeable {\n+\n+    STRING,\n+    NUMBER,\n+    BOOLEAN;\n+\n+    private static final double EPS = 1.0E-9;\n+\n+    public static PredictionFieldType fromString(String name) {\n+        return valueOf(name.trim().toUpperCase(Locale.ROOT));\n+    }\n+\n+    public static PredictionFieldType fromStream(StreamInput in) throws IOException {\n+        return in.readEnum(PredictionFieldType.class);\n+    }\n+\n+    @Override\n+    public void writeTo(StreamOutput out) throws IOException {\n+        out.writeEnum(this);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return name().toLowerCase(Locale.ROOT);\n+    }\n+\n+    public Object transformPredictedValue(Double value, String stringRep) {\n+        if (value == null) {\n+            return null;\n+        }\n+        switch(this) {\n+            case STRING:\n+                return stringRep == null ? value.toString() : stringRep;\n+            case BOOLEAN:\n+                if ((areClose(value, 1.0D) || areClose(value, 0.0D)) == false) {\n+                    throw new IllegalArgumentException(\n+                        \"Cannot transform numbers other than 0.0 or 1.0 to boolean. Provided number [\" + value + \"]\");\n+                }\n+                return (1.0D - value) <= EPS;", "originalCommit": "e327c18689364543e580c0ce5ec2894846938352", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYwMzAzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55128#discussion_r408603035", "bodyText": "s/predicted/prediction/\n?", "author": "przemekwitek", "createdAt": "2020-04-15T06:13:36Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictionFieldType.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+\n+/**\n+ * The type of the predicted field.", "originalCommit": "e327c18689364543e580c0ce5ec2894846938352", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46d592c7984756c15cf877cd4e2a1079ca6175e1", "url": "https://github.com/elastic/elasticsearch/commit/46d592c7984756c15cf877cd4e2a1079ca6175e1", "message": "addressing commentts", "committedDate": "2020-04-15T11:13:28Z", "type": "commit"}, {"oid": "ca5c285b1c63b12a8b9e1fc5d863ed9f56049887", "url": "https://github.com/elastic/elasticsearch/commit/ca5c285b1c63b12a8b9e1fc5d863ed9f56049887", "message": "Merge branch 'master' into feature/ml-inference-handle-different-target-field-typs", "committedDate": "2020-04-15T11:33:13Z", "type": "commit"}]}