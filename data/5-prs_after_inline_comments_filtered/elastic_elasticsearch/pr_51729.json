{"pr_number": 51729, "pr_title": "Don't Upload Redundant Shard Files", "pr_createdAt": "2020-01-31T09:20:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51729", "timeline": [{"oid": "76eea5abe4f44577077b49c496d7faa699f2c0d3", "url": "https://github.com/elastic/elasticsearch/commit/76eea5abe4f44577077b49c496d7faa699f2c0d3", "message": "Don't Upload Redundant Shard Files\n\nSegment(s) info blobs are already stored with their full content\nin the \"hash\" field in the shard snapshot metadata as long as they are\nsmaller than 1MB. We can make use of this fact and never upload them\nphysically to the repo.\nThis saves a non-trivial number of uploads and downloads when restoring\nand might also lower the latency of searchable snapshots since they can save\nphyiscally loading this information as well.", "committedDate": "2020-01-31T09:17:08Z", "type": "commit"}, {"oid": "6d557a32cc63edc35db02746df828f9025865169", "url": "https://github.com/elastic/elasticsearch/commit/6d557a32cc63edc35db02746df828f9025865169", "message": "assert contents are equal", "committedDate": "2020-01-31T13:38:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4Mjk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r373482955", "bodyText": "It's a little annoying but if we run this test with more than a single shard, then it might be that we get shards that aren't corrupted because they contain no documents now as well as no physical data files because only the .si and segments_N are uploaded for the empty shards.", "author": "original-brownbear", "createdAt": "2020-01-31T13:39:56Z", "path": "server/src/test/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -1035,7 +1035,8 @@ public void testUnrestorableFilesDuringRestore() throws Exception {\n         final String indexName = \"unrestorable-files\";\n         final int maxRetries = randomIntBetween(1, 10);\n \n-        Settings createIndexSettings = Settings.builder().put(SETTING_ALLOCATION_MAX_RETRY.getKey(), maxRetries).build();\n+        Settings createIndexSettings = Settings.builder().put(SETTING_ALLOCATION_MAX_RETRY.getKey(), maxRetries)", "originalCommit": "6d557a32cc63edc35db02746df828f9025865169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NDQ0NA==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r373484444", "bodyText": "This simply doesn't match up now and I figured what really matters in these tests is the consistency of the numbers. I didn't want to adjust the results for the file counts to filter out the files that weren't physically uploaded since they are still uploaded as part of the metadata technically.\nWe do have a bunch of other tests that verify all the files are there and incrementality works as expected so I figured this adjustment is good enough.", "author": "original-brownbear", "createdAt": "2020-01-31T13:43:08Z", "path": "server/src/test/java/org/elasticsearch/snapshots/DedicatedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -1132,11 +1132,11 @@ public void testSnapshotTotalAndIncrementalSizes() throws IOException {\n \n         SnapshotStats stats = snapshots.get(0).getStats();\n \n-        assertThat(stats.getTotalFileCount(), is(snapshot0FileCount));\n-        assertThat(stats.getTotalSize(), is(snapshot0FileSize));\n+        assertThat(stats.getTotalFileCount(), greaterThanOrEqualTo(snapshot0FileCount));", "originalCommit": "6d557a32cc63edc35db02746df828f9025865169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4NjI4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r373486281", "bodyText": "Still need to have virtual blob here so that the logic/assertions in BlobStoreIndexShardSnapshot(s) works without format change and things stay BwC. Technically we could do without this kind of \"ID\", but then we'd have to go through the whole dance of only updating the format and not uploading the blob once all the snapshots are newer than version X. If we do it this way, we get the benefit of faster restores and snapshots right away since the meta hash works the same way in 6.x already hence even in 7.7 all possible restores should work out.", "author": "original-brownbear", "createdAt": "2020-01-31T13:47:19Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -179,7 +180,9 @@\n \n     private static final String SNAPSHOT_INDEX_CODEC = \"snapshots\";\n \n-    private static final String DATA_BLOB_PREFIX = \"__\";\n+    private static final String UPLOADED_DATA_BLOB_PREFIX = \"__\";\n+\n+    private static final String VIRTUAL_DATA_BLOB_PREFIX = \"v__\";", "originalCommit": "6d557a32cc63edc35db02746df828f9025865169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f721efb8476988d9058b6f02d5c86437ee5f1cb1", "url": "https://github.com/elastic/elasticsearch/commit/f721efb8476988d9058b6f02d5c86437ee5f1cb1", "message": "Merge remote-tracking branch 'elastic/master' into optimize-away-needless-uploads", "committedDate": "2020-01-31T14:08:44Z", "type": "commit"}, {"oid": "c12ed6961ec23b3e8e819308781880c0ee3de4ce", "url": "https://github.com/elastic/elasticsearch/commit/c12ed6961ec23b3e8e819308781880c0ee3de4ce", "message": "offset", "committedDate": "2020-01-31T14:16:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwMzk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r376403987", "bodyText": "can you add some Javadocs here explaining what virtual data blobs are?", "author": "ywelsch", "createdAt": "2020-02-07T14:00:40Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -179,7 +180,9 @@\n \n     private static final String SNAPSHOT_INDEX_CODEC = \"snapshots\";\n \n-    private static final String DATA_BLOB_PREFIX = \"__\";\n+    private static final String UPLOADED_DATA_BLOB_PREFIX = \"__\";\n+\n+    private static final String VIRTUAL_DATA_BLOB_PREFIX = \"v__\";", "originalCommit": "c12ed6961ec23b3e8e819308781880c0ee3de4ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNDgwNA==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r376404804", "bodyText": "can you assert here that the content is indeed the same? EDIT: happens below. This might be too subtle otherwise. Perhaps also add a method to StoreFileMetaData that marks these files specially, so that it's more obvious to identify the files.", "author": "ywelsch", "createdAt": "2020-02-07T14:02:32Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1516,6 +1519,9 @@ public void snapshotShard(Store store, MapperService mapperService, SnapshotId s\n                     }\n                 }\n \n+                // We can skip writing blobs where the metadata hash is equal to the blob's contents because we store the hash/contents\n+                // directly in the shard level metadata in this case\n+                final boolean needsWrite = md.hash().length != md.length();", "originalCommit": "c12ed6961ec23b3e8e819308781880c0ee3de4ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUyNTcxMA==", "url": "https://github.com/elastic/elasticsearch/pull/51729#discussion_r376525710", "bodyText": "Done in 8794541 ... actually found a way to make this even safer via the checksum test just in case some will use this method elsewhere or something changes in the future. Maybe take another look before I merge?", "author": "original-brownbear", "createdAt": "2020-02-07T17:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNDgwNA=="}], "type": "inlineReview"}, {"oid": "61a468e0f7fb61a95e199633fac4e4593950ba6b", "url": "https://github.com/elastic/elasticsearch/commit/61a468e0f7fb61a95e199633fac4e4593950ba6b", "message": "Merge remote-tracking branch 'elastic/master' into optimize-away-needless-uploads", "committedDate": "2020-02-07T14:41:27Z", "type": "commit"}, {"oid": "87945413f0095d4674079bf0745a6f3b176fd510", "url": "https://github.com/elastic/elasticsearch/commit/87945413f0095d4674079bf0745a6f3b176fd510", "message": "CR: Javadoc + method on store file metadata", "committedDate": "2020-02-07T15:51:30Z", "type": "commit"}]}