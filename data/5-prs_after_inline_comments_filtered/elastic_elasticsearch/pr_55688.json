{"pr_number": 55688, "pr_title": "Fix (de)serialization of async search failures", "pr_createdAt": "2020-04-23T18:17:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55688", "timeline": [{"oid": "d660d3c9507e42841f7dae137672f8f1859365af", "url": "https://github.com/elastic/elasticsearch/commit/d660d3c9507e42841f7dae137672f8f1859365af", "message": "Fix (de)serialization of async search failures\n\nThe (de)serialization code of the async search response\ncannot handle exceptions that extend ElasticsearchException (e.g. ScriptException).\nThis commit fixes this bug by serializing the error with the more generic\nStreamInput#writeException.", "committedDate": "2020-04-23T18:16:36Z", "type": "commit"}, {"oid": "3b600aa694e33aea247ce990bfe67a61d9f06bf5", "url": "https://github.com/elastic/elasticsearch/commit/3b600aa694e33aea247ce990bfe67a61d9f06bf5", "message": "fix fetch shard failures too", "committedDate": "2020-04-23T19:10:33Z", "type": "commit"}, {"oid": "204c718eabb44fccb3e0e3506b15fc81ebdd0de8", "url": "https://github.com/elastic/elasticsearch/commit/204c718eabb44fccb3e0e3506b15fc81ebdd0de8", "message": "missing change", "committedDate": "2020-04-23T19:16:46Z", "type": "commit"}, {"oid": "081b81e69b912db221f87c91b15c6b5abf96b8ec", "url": "https://github.com/elastic/elasticsearch/commit/081b81e69b912db221f87c91b15c6b5abf96b8ec", "message": "Merge branch 'master' into async_search_failure", "committedDate": "2020-04-23T19:22:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3NjIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414076220", "bodyText": "leftover?", "author": "jpountz", "createdAt": "2020-04-23T19:46:11Z", "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchResponseTests.java", "diffHunk": "@@ -95,7 +96,7 @@ protected AsyncSearchResponse copyInstance(AsyncSearchResponse instance, Version\n     }\n \n     static AsyncSearchResponse randomAsyncSearchResponse(String searchId, SearchResponse searchResponse) {\n-        int rand = randomIntBetween(0, 2);\n+        int rand = randomIntBetween(2, 2);", "originalCommit": "081b81e69b912db221f87c91b15c6b5abf96b8ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA4OTk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414089980", "bodyText": "thanks", "author": "jimczi", "createdAt": "2020-04-23T20:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3NjIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3ODU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414078569", "bodyText": "maybe add a comment explaining why we have this != null?", "author": "jpountz", "createdAt": "2020-04-23T19:49:58Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -349,8 +349,10 @@ protected void onQueryFailure(int shardIndex, SearchShardTarget shardTarget, Exc\n         }\n \n         @Override\n-        protected void onFetchFailure(int shardIndex, Exception exc) {\n+        protected void onFetchFailure(int shardIndex, SearchShardTarget shardTarget, Exception exc) {\n             checkCancellation();\n+            searchResponse.get().addShardFailure(shardIndex,\n+                new ShardSearchFailure(exc, shardTarget.getNodeId() != null ? shardTarget : null));", "originalCommit": "081b81e69b912db221f87c91b15c6b5abf96b8ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MDA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414090073", "bodyText": "I added 2451996", "author": "jimczi", "createdAt": "2020-04-23T20:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3ODU2OQ=="}], "type": "inlineReview"}, {"oid": "245199625184a56b58d3e0524ccb55958b6ba494", "url": "https://github.com/elastic/elasticsearch/commit/245199625184a56b58d3e0524ccb55958b6ba494", "message": "address review", "committedDate": "2020-04-23T20:00:28Z", "type": "commit"}]}