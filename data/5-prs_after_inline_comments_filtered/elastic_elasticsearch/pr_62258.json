{"pr_number": 62258, "pr_title": "Fix projects that failed to build within Intellij", "pr_createdAt": "2020-09-10T21:30:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62258", "timeline": [{"oid": "eabcb42da61308945289fec78db9644b162afce4", "url": "https://github.com/elastic/elasticsearch/commit/eabcb42da61308945289fec78db9644b162afce4", "message": "iniitial fix", "committedDate": "2020-09-10T18:25:46Z", "type": "commit"}, {"oid": "933852c75f496a17e8f1f23c33ad983c2bdc028f", "url": "https://github.com/elastic/elasticsearch/commit/933852c75f496a17e8f1f23c33ad983c2bdc028f", "message": "xperamint", "committedDate": "2020-09-10T20:53:04Z", "type": "commit"}, {"oid": "b0b5b365cd3d79b52e7b187d025d383881df8db5", "url": "https://github.com/elastic/elasticsearch/commit/b0b5b365cd3d79b52e7b187d025d383881df8db5", "message": "move xpack rest test back to test", "committedDate": "2020-09-10T21:09:33Z", "type": "commit"}, {"oid": "e71f397799b5051c82f240e585d90e8b8220c3e0", "url": "https://github.com/elastic/elasticsearch/commit/e71f397799b5051c82f240e585d90e8b8220c3e0", "message": "minor typo fix", "committedDate": "2020-09-10T21:13:03Z", "type": "commit"}, {"oid": "a273b94469ed00dcc3f3885134804b1da6c4f388", "url": "https://github.com/elastic/elasticsearch/commit/a273b94469ed00dcc3f3885134804b1da6c4f388", "message": "fix x-pack rest testss", "committedDate": "2020-09-10T21:25:56Z", "type": "commit"}, {"oid": "0c952a0e02f10c11cbff85b03ed71e8f02e500a2", "url": "https://github.com/elastic/elasticsearch/commit/0c952a0e02f10c11cbff85b03ed71e8f02e500a2", "message": "fix over reaching intellij refactor", "committedDate": "2020-09-10T21:29:02Z", "type": "commit"}, {"oid": "6760bfa26bb90793383a9c669bffd0a2814d6fa5", "url": "https://github.com/elastic/elasticsearch/commit/6760bfa26bb90793383a9c669bffd0a2814d6fa5", "message": "fix name", "committedDate": "2020-09-10T21:31:39Z", "type": "commit"}, {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164", "url": "https://github.com/elastic/elasticsearch/commit/e6b3090d4521edb21d5dc17d4179d462a29c3164", "message": "attempt to preserve git history and fix jar hell", "committedDate": "2020-09-10T21:43:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MzEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486653139", "bodyText": "There are not any actual changes to this file...just renamed and moved back to the test source set.\nI think this change this makes sense since independent of any other reason since there are a few runners that extend this... however the real reason i am introducing this is that I could not figure out how to get Intellij to share classes x-project and x-non-standard source set...it works fine from the test sourceset, but when shared from the custom source set (yamlRestTest) Intellij seems to have issues (the command line works fine).", "author": "jakelandis", "createdAt": "2020-09-10T21:49:27Z", "path": "x-pack/plugin/src/test/java/org/elasticsearch/xpack/test/rest/AbstractXPackRestTest.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.test.rest;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import com.carrotsearch.randomizedtesting.annotations.TimeoutSuite;\n+import org.apache.http.HttpStatus;\n+import org.apache.lucene.util.TimeUnits;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.CheckedFunction;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.common.xcontent.support.XContentMapValues;\n+import org.elasticsearch.plugins.MetadataUpgrader;\n+import org.elasticsearch.test.SecuritySettingsSourceField;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestResponse;\n+import org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase;\n+import org.elasticsearch.xpack.core.ml.MlConfigIndex;\n+import org.elasticsearch.xpack.core.ml.MlMetaIndex;\n+import org.elasticsearch.xpack.core.ml.integration.MlRestTestStateCleaner;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndex;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndexFields;\n+import org.elasticsearch.xpack.core.ml.notifications.NotificationsIndex;\n+import org.elasticsearch.xpack.core.rollup.job.RollupJob;\n+import org.elasticsearch.xpack.core.transform.transforms.persistence.TransformInternalIndexConstants;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Supplier;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.Collections.singletonMap;\n+import static org.elasticsearch.common.xcontent.support.XContentMapValues.extractValue;\n+import static org.elasticsearch.rest.action.search.RestSearchAction.TOTAL_HITS_AS_INT_PARAM;\n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+/** Runs rest tests against external cluster */\n+// TODO: Remove this timeout increase once this test suite is broken up\n+@TimeoutSuite(millis = 60 * TimeUnits.MINUTE)\n+public class AbstractXPackRestTest extends ESClientYamlSuiteTestCase {", "originalCommit": "e6b3090d4521edb21d5dc17d4179d462a29c3164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MjkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486692915", "bodyText": "I believe that's due to setting up the source sets correctly. This should work, and we do it in other places.", "author": "mark-vieira", "createdAt": "2020-09-10T23:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MzEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MjYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r487992614", "bodyText": "I believe that's due to setting up the source sets correctly. This should work, and we do it in other places.\n\nI'm not sure I follow the comment... I tried a variety of ways to get Intellij to honor the configuration, it always works when defined in the test sourceset , but fails with identical config with a different sourceset name. I am sure I am missing something (or there is a bug in intellij), but not sure what. I don't believe it is related to the GradleUtils comment below since it is a different failure that addresses. Is there something specific you would like me to try ?  I think this changes as-is actually a net positive change, with the benefit that it does not show red squiggly lines in Intellij.", "author": "jakelandis", "createdAt": "2020-09-14T14:49:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MzEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1NDYwMA==", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486654600", "bodyText": "this doesn't seem to have any functional impact, just noticed I missed this before and I think it is a bit more correct.", "author": "jakelandis", "createdAt": "2020-09-10T21:52:50Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/GradleUtils.java", "diffHunk": "@@ -155,7 +155,7 @@ public static void setupIdeForTestSourceSet(Project project, SourceSet testSourc\n         project.getPluginManager().withPlugin(\"idea\", p -> {\n             IdeaModel idea = project.getExtensions().getByType(IdeaModel.class);\n             idea.getModule().setTestSourceDirs(testSourceSet.getJava().getSrcDirs());\n-            idea.getModule().getScopes().put(\"TEST\", Map.of(\"plus\", List.of(runtimeClasspathConfiguration)));\n+            idea.getModule().getScopes().put(testSourceSet.getName(), Map.of(\"plus\", List.of(runtimeClasspathConfiguration)));", "originalCommit": "e6b3090d4521edb21d5dc17d4179d462a29c3164", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87c2493a517df0373e2a94331464e385e5e79db8", "url": "https://github.com/elastic/elasticsearch/commit/87c2493a517df0373e2a94331464e385e5e79db8", "message": "use GradleUtils.extendSourceSet", "committedDate": "2020-09-14T20:59:18Z", "type": "commit"}, {"oid": "d2aceefdca367551f18857514e13cad68f55636a", "url": "https://github.com/elastic/elasticsearch/commit/d2aceefdca367551f18857514e13cad68f55636a", "message": "add support to extend eager test task classpaths", "committedDate": "2020-09-14T22:26:27Z", "type": "commit"}, {"oid": "61f288d7c507c51f50d7f23f3119141d9dd1a275", "url": "https://github.com/elastic/elasticsearch/commit/61f288d7c507c51f50d7f23f3119141d9dd1a275", "message": "undo example", "committedDate": "2020-09-14T22:30:06Z", "type": "commit"}, {"oid": "54b3373c1e2c352171831f1f08cb01780b658663", "url": "https://github.com/elastic/elasticsearch/commit/54b3373c1e2c352171831f1f08cb01780b658663", "message": "Merge remote-tracking branch 'upstream/master' into fix_intellij_build", "committedDate": "2020-09-14T22:32:12Z", "type": "commit"}]}