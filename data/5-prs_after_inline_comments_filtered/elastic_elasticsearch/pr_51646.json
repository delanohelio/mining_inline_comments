{"pr_number": 51646, "pr_title": "[ML] Fix possible race condition starting datafeed", "pr_createdAt": "2020-01-29T19:53:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51646", "timeline": [{"oid": "99d355de538007e14da660e1811257e696e28324", "url": "https://github.com/elastic/elasticsearch/commit/99d355de538007e14da660e1811257e696e28324", "message": "[ML] Fix possible race condition starting datafeed\n\nDatafeeds being closed while starting could result in and NPE. This was\nhandled as any other failure, masking out the NPE. However, this\nconflicts with the changes in #50886.\n\nRelated to #50886 and #51302", "committedDate": "2020-01-29T19:51:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5Nzg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51646#discussion_r372597865", "bodyText": "Putting in a sleep(100) before this line provokes the NPE.", "author": "henningandersen", "createdAt": "2020-01-29T19:54:02Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedManager.java", "diffHunk": "@@ -520,7 +520,12 @@ private void runTask(TransportStartDatafeedAction.DatafeedTask task) {\n             // a context with sufficient permissions would coincidentally be in force in some single node\n             // tests, leading to bugs not caught in CI due to many tests running in single node test clusters.\n             try (ThreadContext.StoredContext ignore = threadPool.getThreadContext().stashContext()) {\n-                innerRun(runningDatafeedsOnThisNode.get(task.getAllocationId()), task.getDatafeedStartTime(), task.getEndTime());\n+                Holder holder = runningDatafeedsOnThisNode.get(task.getAllocationId());", "originalCommit": "99d355de538007e14da660e1811257e696e28324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYwMTExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51646#discussion_r372601119", "bodyText": "We use the terms \u201cstarted\u201d and \u201cstopped\u201d with datafeeds instead of \u201copened\u201d and \u201cclosed\u201d, so please could you change those two words in this message.", "author": "droberts195", "createdAt": "2020-01-29T20:01:02Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/DatafeedManager.java", "diffHunk": "@@ -520,7 +520,12 @@ private void runTask(TransportStartDatafeedAction.DatafeedTask task) {\n             // a context with sufficient permissions would coincidentally be in force in some single node\n             // tests, leading to bugs not caught in CI due to many tests running in single node test clusters.\n             try (ThreadContext.StoredContext ignore = threadPool.getThreadContext().stashContext()) {\n-                innerRun(runningDatafeedsOnThisNode.get(task.getAllocationId()), task.getDatafeedStartTime(), task.getEndTime());\n+                Holder holder = runningDatafeedsOnThisNode.get(task.getAllocationId());\n+                if (holder != null) {\n+                    innerRun(holder, task.getDatafeedStartTime(), task.getEndTime());\n+                } else {\n+                    logger.warn(\"Datafeed [{}] was closed while being opened\", task.getDatafeedId());", "originalCommit": "99d355de538007e14da660e1811257e696e28324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8978dd8cb9e8cdae19f2d079caee1b335547c46", "url": "https://github.com/elastic/elasticsearch/commit/b8978dd8cb9e8cdae19f2d079caee1b335547c46", "message": "Fix message according to review.", "committedDate": "2020-01-29T20:06:46Z", "type": "commit"}]}