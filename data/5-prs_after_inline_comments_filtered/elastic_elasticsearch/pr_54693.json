{"pr_number": 54693, "pr_title": "Delete backing indices with data stream", "pr_createdAt": "2020-04-02T23:10:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54693", "timeline": [{"oid": "9544f0f0bcebca9d0a60002321feed9f20e35f07", "url": "https://github.com/elastic/elasticsearch/commit/9544f0f0bcebca9d0a60002321feed9f20e35f07", "message": "Delete backing indices with data stream", "committedDate": "2020-04-02T23:08:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0OTY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54693#discussion_r402749662", "bodyText": "I think we should rather collect the indices to remove to avoid excessive reroute calls.", "author": "henningandersen", "createdAt": "2020-04-03T05:49:11Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/DeleteDataStreamAction.java", "diffHunk": "@@ -165,10 +173,17 @@ static ClusterState removeDataStream(ClusterState currentState, Request request)\n                 }\n                 throw new ResourceNotFoundException(\"data_streams matching [\" + request.name + \"] not found\");\n             }\n-            Metadata.Builder metadata = Metadata.builder(currentState.metadata());\n+            List<String> dataStreamsToRemove = new ArrayList<>();\n             for (String dataStreamName : dataStreams) {\n                 logger.info(\"removing data stream [{}]\", dataStreamName);\n-                metadata.removeDataStream(dataStreamName);\n+                DataStream dataStream = currentState.metadata().dataStreams().get(dataStreamName);\n+                assert dataStream != null;\n+                currentState = deleteIndexService.deleteIndices(currentState, new HashSet<>(dataStream.getIndices()));", "originalCommit": "9544f0f0bcebca9d0a60002321feed9f20e35f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1MTU0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54693#discussion_r402751547", "bodyText": "Maybe use randomSubSetOf to have 0-2 indices randomly? I think we still need to also support the case where there are no indices.", "author": "henningandersen", "createdAt": "2020-04-03T05:55:54Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/datastream/DeleteDataStreamRequestTests.java", "diffHunk": "@@ -62,21 +74,93 @@ public void testValidateRequestWithoutName() {\n \n     public void testDeleteDataStream() {\n         final String dataStreamName = \"my-data-stream\";\n-        DataStream existingDataStream = new DataStream(dataStreamName, \"timestamp\", Collections.emptyList());\n-        ClusterState cs = ClusterState.builder(new ClusterName(\"_name\"))\n-            .metadata(Metadata.builder().dataStreams(Map.of(dataStreamName, existingDataStream)).build()).build();\n-        DeleteDataStreamAction.Request req = new DeleteDataStreamAction.Request(dataStreamName);\n+        final List<String> otherIndices = List.of(\"foo\", \"bar\", \"baz\");\n+\n+        ClusterState cs = getClusterState(\n+            List.of(new Tuple<>(dataStreamName, List.of(", "originalCommit": "9544f0f0bcebca9d0a60002321feed9f20e35f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc3NzEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/54693#discussion_r402777122", "bodyText": "As a follow up we need to take into account that indices can be removed from a data stream (except the last/most current index). So we should either check here that the backing index really exists or in the delete index api also modify a data stream if the index is part of a data stream", "author": "martijnvg", "createdAt": "2020-04-03T07:08:43Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/DeleteDataStreamAction.java", "diffHunk": "@@ -165,10 +173,17 @@ static ClusterState removeDataStream(ClusterState currentState, Request request)\n                 }\n                 throw new ResourceNotFoundException(\"data_streams matching [\" + request.name + \"] not found\");\n             }\n-            Metadata.Builder metadata = Metadata.builder(currentState.metadata());\n+            List<String> dataStreamsToRemove = new ArrayList<>();\n             for (String dataStreamName : dataStreams) {\n                 logger.info(\"removing data stream [{}]\", dataStreamName);\n-                metadata.removeDataStream(dataStreamName);\n+                DataStream dataStream = currentState.metadata().dataStreams().get(dataStreamName);\n+                assert dataStream != null;\n+                currentState = deleteIndexService.deleteIndices(currentState, new HashSet<>(dataStream.getIndices()));", "originalCommit": "9544f0f0bcebca9d0a60002321feed9f20e35f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eca9ddd3d4e616ab5171e8c4a678f7dc3389506f", "url": "https://github.com/elastic/elasticsearch/commit/eca9ddd3d4e616ab5171e8c4a678f7dc3389506f", "message": "Merge branch 'master' into delete_backing_indices_with_data_stream", "committedDate": "2020-04-03T20:03:19Z", "type": "commit"}, {"oid": "4ce939a3d8d2b7976565c02a6adf78c6fd9f6a30", "url": "https://github.com/elastic/elasticsearch/commit/4ce939a3d8d2b7976565c02a6adf78c6fd9f6a30", "message": "review comments", "committedDate": "2020-04-03T20:07:03Z", "type": "commit"}]}