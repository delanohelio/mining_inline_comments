{"pr_number": 52839, "pr_title": "Upgrade GCS SDK to 1.104.0", "pr_createdAt": "2020-02-26T17:47:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52839", "timeline": [{"oid": "c03bab4107463fdc0f7b0191a9199a4ed3500437", "url": "https://github.com/elastic/elasticsearch/commit/c03bab4107463fdc0f7b0191a9199a4ed3500437", "message": "Upgrade GCS SDK to 1.104.0\n\nUpgrading the GCS SDK to the most recent version.\nAdjusting (i.e. improving) the REST mock accordingly.\nThis should significantly boost performance by pulling in\nhttps://github.com/googleapis/java-core/issues/86 in some cases.", "committedDate": "2020-02-26T17:46:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY1OTE1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52839#discussion_r384659151", "bodyText": "This got way increased in googleapis/java-core#86 :)", "author": "original-brownbear", "createdAt": "2020-02-26T17:48:28Z", "path": "plugins/repository-gcs/src/test/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobContainerRetriesTests.java", "diffHunk": "@@ -331,7 +333,7 @@ public void testWriteBlobWithReadTimeouts() {\n \n     public void testWriteLargeBlob() throws IOException {\n         // See {@link BaseWriteChannel#DEFAULT_CHUNK_SIZE}\n-        final int defaultChunkSize = 8 * 256 * 1024;\n+        final int defaultChunkSize = 60 * 256 * 1024;", "originalCommit": "c03bab4107463fdc0f7b0191a9199a4ed3500437", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY1OTM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52839#discussion_r384659388", "bodyText": "For some reason the toBuilder keeps track of all settings but these two in the latest version so we have to manually set these again.", "author": "original-brownbear", "createdAt": "2020-02-26T17:48:56Z", "path": "plugins/repository-gcs/src/test/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStoreRepositoryTests.java", "diffHunk": "@@ -199,6 +199,8 @@ StorageOptions createStorageOptions(final GoogleCloudStorageClientSettings clien\n                                                     final HttpTransportOptions httpTransportOptions) {\n                     StorageOptions options = super.createStorageOptions(clientSettings, httpTransportOptions);\n                     return options.toBuilder()\n+                        .setHost(options.getHost())", "originalCommit": "c03bab4107463fdc0f7b0191a9199a4ed3500437", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY1OTkyNw==", "url": "https://github.com/elastic/elasticsearch/pull/52839#discussion_r384659927", "bodyText": "There seems to be a behavior change with retries here. The retries are now executed across multiple different TCP connections instead of reusing the same connection. This means we can't key them by the full address including the port any longer because that would allow for more retries than we assume.", "author": "original-brownbear", "createdAt": "2020-02-26T17:50:00Z", "path": "plugins/repository-gcs/src/test/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStoreRepositoryTests.java", "diffHunk": "@@ -266,7 +268,7 @@ protected String requestUniqueId(HttpExchange exchange) {\n             }\n \n             final String range = exchange.getRequestHeaders().getFirst(\"Content-Range\");\n-            return exchange.getRemoteAddress().toString()\n+            return exchange.getRemoteAddress().getHostString()", "originalCommit": "c03bab4107463fdc0f7b0191a9199a4ed3500437", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY2MDQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52839#discussion_r384660465", "bodyText": "The new SDK isn't just sending END_OF_PART${uuid} so this needed to become a little smarter.\nSee related SDK code https://github.com/googleapis/google-http-java-client/blob/master/google-http-client/src/main/java/com/google/api/client/http/MultipartContent.java#L35", "author": "original-brownbear", "createdAt": "2020-02-26T17:50:59Z", "path": "test/fixtures/gcs-fixture/src/main/java/fixture/gcs/GoogleCloudStorageHttpHandler.java", "diffHunk": "@@ -298,9 +298,10 @@ private String httpServerUrl(final HttpExchange exchange) {\n                 skippedEmptyLine = markAndContinue && endPos == startPos;\n                 startPos = endPos;\n             } else {\n-                // removes the trailing end \"\\r\\n--__END_OF_PART__--\\r\\n\" which is 23 bytes long\n-                int len = fullRequestBody.length() - startPos - 23;\n-                content = Tuple.tuple(name, fullRequestBody.slice(startPos, len));\n+                while (isEndOfPart(fullRequestBody, endPos) == false) {", "originalCommit": "c03bab4107463fdc0f7b0191a9199a4ed3500437", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}