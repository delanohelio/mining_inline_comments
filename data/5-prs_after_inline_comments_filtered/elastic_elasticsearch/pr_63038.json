{"pr_number": 63038, "pr_title": "Move SLM history to data stream", "pr_createdAt": "2020-09-29T21:18:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63038", "timeline": [{"oid": "bf485ceef4637443400d855aaef96b4d0a2c1b1e", "url": "https://github.com/elastic/elasticsearch/commit/bf485ceef4637443400d855aaef96b4d0a2c1b1e", "message": "Move SLM history to data stream", "committedDate": "2020-09-29T21:14:37Z", "type": "commit"}, {"oid": "82d140da0799f67458a6b5c3c0bf4a6eee4304d7", "url": "https://github.com/elastic/elasticsearch/commit/82d140da0799f67458a6b5c3c0bf4a6eee4304d7", "message": "fix test", "committedDate": "2020-09-29T21:45:33Z", "type": "commit"}, {"oid": "dc7564e73da9b1694498bf1314b8d10ca398b711", "url": "https://github.com/elastic/elasticsearch/commit/dc7564e73da9b1694498bf1314b8d10ca398b711", "message": "fix tests", "committedDate": "2020-09-29T23:22:31Z", "type": "commit"}, {"oid": "672f19813c4ed9e58048689056bc541305417f05", "url": "https://github.com/elastic/elasticsearch/commit/672f19813c4ed9e58048689056bc541305417f05", "message": "fix tests", "committedDate": "2020-09-30T08:48:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1MzMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/63038#discussion_r497753314", "bodyText": "I think this should be a bit more descriptive about why it failed (such as mentioning that the data stream and template were missing) since we don't have an exception in this case", "author": "dakrone", "createdAt": "2020-09-30T19:36:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/slm/history/SnapshotHistoryStore.java", "diffHunk": "@@ -59,85 +56,29 @@ public void putAsync(SnapshotHistoryItem item) {\n                 SLM_HISTORY_INDEX_ENABLED_SETTING.getKey(), item);\n             return;\n         }\n-        logger.trace(\"about to index snapshot history item in index [{}]: [{}]\", SLM_HISTORY_ALIAS, item);\n-        ensureHistoryIndex(client, clusterService.state(), ActionListener.wrap(createdIndex -> {\n-            try (XContentBuilder builder = XContentFactory.jsonBuilder()) {\n-                item.toXContent(builder, ToXContent.EMPTY_PARAMS);\n-                IndexRequest request = new IndexRequest(SLM_HISTORY_ALIAS)\n-                    .source(builder);\n-                client.index(request, ActionListener.wrap(indexResponse -> {\n-                    logger.debug(\"successfully indexed snapshot history item with id [{}] in index [{}]: [{}]\",\n-                        indexResponse.getId(), SLM_HISTORY_ALIAS, item);\n-                }, exception -> {\n-                    logger.error(new ParameterizedMessage(\"failed to index snapshot history item in index [{}]: [{}]\",\n-                        SLM_HISTORY_ALIAS, item), exception);\n-                }));\n-            } catch (IOException exception) {\n+        logger.trace(\"about to index snapshot history item in index [{}]: [{}]\", SLM_HISTORY_DATA_STREAM, item);\n+        Metadata metadata = clusterService.state().getMetadata();\n+        if (metadata.dataStreams().containsKey(SLM_HISTORY_DATA_STREAM) == false &&\n+            metadata.templatesV2().containsKey(SLM_TEMPLATE_NAME) == false) {\n+            logger.error(new ParameterizedMessage(\"failed to index snapshot history item in index [{}]: [{}]\",", "originalCommit": "672f19813c4ed9e58048689056bc541305417f05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxNDg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63038#discussion_r497814888", "bodyText": "You are right, I reworded error message", "author": "probakowski", "createdAt": "2020-09-30T21:36:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1MzMxNA=="}], "type": "inlineReview"}, {"oid": "414a11368a626c84392848ead16a977518e20bca", "url": "https://github.com/elastic/elasticsearch/commit/414a11368a626c84392848ead16a977518e20bca", "message": "better error message", "committedDate": "2020-09-30T21:32:14Z", "type": "commit"}]}