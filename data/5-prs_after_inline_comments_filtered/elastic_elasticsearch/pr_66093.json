{"pr_number": 66093, "pr_title": "Sort field tiebreaker for PIT (point in time) readers", "pr_createdAt": "2020-12-09T10:28:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66093", "timeline": [{"oid": "b34df5401b29b0a3fa64c05f20efcf096b88bc5b", "url": "https://github.com/elastic/elasticsearch/commit/b34df5401b29b0a3fa64c05f20efcf096b88bc5b", "message": "Sort field tiebreaker for PIT (point in time) readers\n\nThis commit introduces a new sort field called `_shard_doc` that\ncan be used in conjunction with a PIT to consistently tiebreak\nidentical sort values. The sort value is a numeric long that is\ncomposed of the ordinal of the shard (assigned by the coordinating node)\nand the internal Lucene document ID. These two values are consistent within\na PIT so this sort criteria can be used as the tiebreaker of any search\nrequests.\nSince this sort criteria is stable we'd like to add it automatically to any\nsorted search requests that use a PIT but we also need to expose it explicitly\nin order to be able to:\n* Reverse the order of the tiebreaking, useful to search \"before\" `search_after`.\n* Force the primary sort to use it in order to benefit from the `search_after` optimization when sorting by index order (to be released in Lucene 8.8.\n\nI plan to add the documentation and the automatic configuration for PIT in a follow up since this change is already big.\n\nRelates #56828", "committedDate": "2020-12-09T10:07:28Z", "type": "commit"}, {"oid": "e58ab36deb52dd7afb0c0723e244447ea8e1ac95", "url": "https://github.com/elastic/elasticsearch/commit/e58ab36deb52dd7afb0c0723e244447ea8e1ac95", "message": "unrelated change", "committedDate": "2020-12-09T10:29:19Z", "type": "commit"}, {"oid": "3a456557e5409e9072cc940a37ea79499a831a08", "url": "https://github.com/elastic/elasticsearch/commit/3a456557e5409e9072cc940a37ea79499a831a08", "message": "fix typo", "committedDate": "2020-12-09T10:29:56Z", "type": "commit"}, {"oid": "53153aa287e6db1ef35528a36ea043e0fafc1a1e", "url": "https://github.com/elastic/elasticsearch/commit/53153aa287e6db1ef35528a36ea043e0fafc1a1e", "message": "fix typo", "committedDate": "2020-12-09T10:30:47Z", "type": "commit"}, {"oid": "fd55bdb62002f62514d486e89d07e8e4532a5e00", "url": "https://github.com/elastic/elasticsearch/commit/fd55bdb62002f62514d486e89d07e8e4532a5e00", "message": "unrelated change", "committedDate": "2020-12-09T10:36:13Z", "type": "commit"}, {"oid": "813ae3795f69c7adc212d3163bcaff1688d4d92b", "url": "https://github.com/elastic/elasticsearch/commit/813ae3795f69c7adc212d3163bcaff1688d4d92b", "message": "fix conflict", "committedDate": "2020-12-09T11:57:59Z", "type": "commit"}, {"oid": "5d8f0c92a688a28a011f615728184fed7c52c9b5", "url": "https://github.com/elastic/elasticsearch/commit/5d8f0c92a688a28a011f615728184fed7c52c9b5", "message": "fix typo", "committedDate": "2020-12-09T17:29:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzNjQ3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66093#discussion_r540436476", "bodyText": "should we put any message in this exception?", "author": "mayya-sharipova", "createdAt": "2020-12-10T19:25:42Z", "path": "server/src/main/java/org/elasticsearch/search/sort/FieldSortBuilder.java", "diffHunk": "@@ -321,8 +327,15 @@ private static NumericType resolveNumericType(String value) {\n \n     @Override\n     public SortFieldAndFormat build(QueryShardContext context) throws IOException {\n+        final boolean reverse = order == SortOrder.DESC;\n+\n         if (DOC_FIELD_NAME.equals(fieldName)) {\n-            return order == SortOrder.DESC ? SORT_DOC_REVERSE : SORT_DOC;\n+            return reverse ? SORT_DOC_REVERSE : SORT_DOC;\n+        } else if (SHARD_DOC_FIELD_NAME.equals(fieldName)) {\n+            if (context.getShardRequestIndex() == -1) {\n+                throw new IllegalArgumentException(\"\");", "originalCommit": "5d8f0c92a688a28a011f615728184fed7c52c9b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3MzYzOA==", "url": "https://github.com/elastic/elasticsearch/pull/66093#discussion_r540473638", "bodyText": "It's a leftover, the shard request index is guaranteed to be greater than 0 at this point. I removed the check and the exception in 5af84f5", "author": "jimczi", "createdAt": "2020-12-10T20:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzNjQ3Ng=="}], "type": "inlineReview"}, {"oid": "5af84f589bb04c8b63798f5d8c2ce1522af3b912", "url": "https://github.com/elastic/elasticsearch/commit/5af84f589bb04c8b63798f5d8c2ce1522af3b912", "message": "fix rest test and remove leftover", "committedDate": "2020-12-10T20:24:02Z", "type": "commit"}, {"oid": "f632d0ab8f2d030b690a6818d2c4eca43c8cf68e", "url": "https://github.com/elastic/elasticsearch/commit/f632d0ab8f2d030b690a6818d2c4eca43c8cf68e", "message": "Merge branch 'master' into shard_doc_sort_field", "committedDate": "2020-12-10T20:24:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1Mjk0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66093#discussion_r540552946", "bodyText": "since _shard_doc field is a user-facing now, do we want add checks for its correctness, for example ensure that topShardIndex >=0 and  a doc part of the value is also >=0? May be better to do this check in SearchAfterBuilder?", "author": "mayya-sharipova", "createdAt": "2020-12-10T22:45:18Z", "path": "server/src/main/java/org/elasticsearch/search/sort/ShardDocSortField.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.sort;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.search.FieldComparator;\n+import org.apache.lucene.search.LeafFieldComparator;\n+import org.apache.lucene.search.SortField;\n+import org.apache.lucene.search.comparators.DocComparator;\n+\n+ /**\n+  * A {@link SortField} that first compares the shard index and then uses the document number (_doc)\n+  * to tiebreak if the value is the same.\n+  **/\n+public class ShardDocSortField extends SortField {\n+    public static final String NAME = \"_shard_doc\";\n+\n+    private final int shardRequestIndex;\n+\n+    public ShardDocSortField(int shardRequestIndex, boolean reverse) {\n+        super(NAME, Type.LONG, reverse);\n+        assert shardRequestIndex >= 0;\n+        this.shardRequestIndex = shardRequestIndex;\n+    }\n+\n+    int getShardRequestIndex() {\n+        return shardRequestIndex;\n+    }\n+\n+    @Override\n+    public FieldComparator<?> getComparator(int numHits, int sortPos) {\n+        final DocComparator delegate = new DocComparator(numHits, false, sortPos);\n+\n+        return new FieldComparator<Long>() {\n+            @Override\n+            public int compare(int slot1, int slot2) {\n+                return delegate.compare(slot1, slot2);\n+            }\n+\n+            @Override\n+            public int compareValues(Long first, Long second) {\n+                return Long.compare(first, second);\n+            }\n+\n+            @Override\n+            public void setTopValue(Long value) {\n+                int topShardIndex = (int) (value >> 32);", "originalCommit": "f632d0ab8f2d030b690a6818d2c4eca43c8cf68e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "509df9fccc7c54287785b2fd56afcd6a6d1b6bb7", "url": "https://github.com/elastic/elasticsearch/commit/509df9fccc7c54287785b2fd56afcd6a6d1b6bb7", "message": "Merge branch 'master' into shard_doc_sort_field", "committedDate": "2020-12-18T07:52:20Z", "type": "commit"}, {"oid": "9de14e92d93b5479c0852f61954db2e736ee6cc4", "url": "https://github.com/elastic/elasticsearch/commit/9de14e92d93b5479c0852f61954db2e736ee6cc4", "message": "fix compil", "committedDate": "2020-12-18T08:00:07Z", "type": "commit"}, {"oid": "c7a279c3cd6c47161a75337e7b2f82778e0238c9", "url": "https://github.com/elastic/elasticsearch/commit/c7a279c3cd6c47161a75337e7b2f82778e0238c9", "message": "fix mock in  tests", "committedDate": "2020-12-18T08:47:12Z", "type": "commit"}]}