{"pr_number": 65606, "pr_title": "Add search runtime_mappings to datafeed configuration", "pr_createdAt": "2020-11-30T13:49:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65606", "timeline": [{"oid": "2f982bd16092ff3e8e92778a5f917e30ecc5cfd5", "url": "https://github.com/elastic/elasticsearch/commit/2f982bd16092ff3e8e92778a5f917e30ecc5cfd5", "message": "Revert \"Add test for datafeed aggs\"\n\nThis reverts commit 9233485160f416a15187941f19912c7e58f2a105.", "committedDate": "2020-11-30T23:27:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533343996", "bodyText": "It might be better to say object instead of map in this error message, as the user reading the message is thinking of the JSON structure rather than the Java structure.", "author": "droberts195", "createdAt": "2020-12-01T11:39:18Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "diffHunk": "@@ -824,6 +853,28 @@ void validateScriptFields() {\n             }\n         }\n \n+        /**\n+         * Perform a light check that the structure resembles runtime_mappings.\n+         * The full check cannot happen until search\n+         */\n+        void validateRuntimeMappings() {\n+            for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {\n+                // top level objects are fields\n+                String fieldName = entry.getKey();\n+                if (entry.getValue() instanceof Map) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Map<String, Object> propNode = new HashMap<>(((Map<String, Object>) entry.getValue()));\n+                    Object typeNode = propNode.get(\"type\");\n+                    if (typeNode == null) {\n+                        throw ExceptionsHelper.badRequestException(\"No type specified for runtime field [\" + fieldName + \"]\");\n+                    }\n+                } else {\n+                    throw ExceptionsHelper.badRequestException(\"Expected map for runtime field [\" + fieldName + \"] \" +", "originalCommit": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQxODQxNw==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533418417", "bodyText": "map is consistent with the language used here\n\n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/index/mapper/RuntimeFieldType.java\n    \n    \n         Line 91\n      in\n      af2f084\n    \n    \n    \n    \n\n        \n          \n           throw new MapperParsingException(\"Expected map for runtime field [\" + fieldName + \"] definition but got a \"", "author": "davidkyle", "createdAt": "2020-12-01T13:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMzA0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r534003049", "bodyText": "It's still wrong - the word \"map\" does not appear anywhere in this page: https://www.json.org/json-en.html\nIt sounds like there is going to be a separate PR to correct this throughout the runtime fields code though, so all instances can be fixed in one go.", "author": "droberts195", "createdAt": "2020-12-02T09:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345233", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "author": "droberts195", "createdAt": "2020-12-01T11:41:37Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -38,6 +40,8 @@ public static void validate(DatafeedConfig datafeedConfig, Job job, NamedXConten\n         if (delayedDataCheckConfig.isEnabled()) {\n             checkValidDelayedDataCheckConfig(bucketSpan, delayedDataCheckConfig);\n         }\n+\n+        checkTimeFieldIsNotARuntimeField(datafeedConfig, job.getDataDescription().getTimeField());", "originalCommit": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTM0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345348", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "author": "droberts195", "createdAt": "2020-12-01T11:41:48Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -97,4 +101,16 @@ private static void checkFrequencyIsMultipleOfHistogramInterval(DatafeedConfig d\n             }\n         }\n     }\n+\n+    private static void checkTimeFieldIsNotARuntimeField(DatafeedConfig datafeedConfig, String timeField) {\n+        Map<String, Object> runtimeMappings = datafeedConfig.getRuntimeMappings();\n+        for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {", "originalCommit": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NzIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533347209", "bodyText": "SearchSourceBuilder.RUNTIME_MAPPINGS_FIELD.getPreferredName()?", "author": "droberts195", "createdAt": "2020-12-01T11:45:16Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/job/persistence/ElasticsearchMappingsTests.java", "diffHunk": "@@ -75,7 +75,8 @@\n             ElasticsearchMappings.NESTED,\n             ElasticsearchMappings.PROPERTIES,\n             ElasticsearchMappings.TYPE,\n-            ElasticsearchMappings.WHITESPACE\n+            ElasticsearchMappings.WHITESPACE,\n+            \"runtime_mappings\"", "originalCommit": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0ODc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533348761", "bodyText": "This shouldn't be necessary.  I thought we ignored the time format in the data description when using a datafeed.  If deleting this line makes the test fail then something unexpected is happening somewhere.", "author": "droberts195", "createdAt": "2020-12-01T11:48:14Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java", "diffHunk": "@@ -145,6 +152,68 @@ public void testLookbackOnlyDataStream() throws Exception {\n         waitUntilJobIsClosed(job.getId());\n     }\n \n+    public void testLookbackOnlyRuntimeMapping() throws Exception {\n+        client().admin().indices().prepareCreate(\"data-1\")\n+            .setMapping(\"time\", \"type=date\")\n+            .get();\n+        long numDocs = randomIntBetween(32, 2048);\n+        long now = System.currentTimeMillis();\n+        long oneWeekAgo = now - 604800000;\n+        long twoWeeksAgo = oneWeekAgo - 604800000;\n+        indexDocs(logger, \"data-1\", numDocs, twoWeeksAgo, oneWeekAgo);\n+\n+        DataDescription.Builder dataDescription = new DataDescription.Builder();\n+        dataDescription.setTimeFormat(\"yyyy-MM-dd HH:mm:ss\");", "originalCommit": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b98567d6a8b25087445b74a8b09fab7d127a185e", "url": "https://github.com/elastic/elasticsearch/commit/b98567d6a8b25087445b74a8b09fab7d127a185e", "message": "Add runtime mappings to datafeed and extractors", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "9fa77f888071408926ab49437016d8dc89a044a5", "url": "https://github.com/elastic/elasticsearch/commit/9fa77f888071408926ab49437016d8dc89a044a5", "message": "Rollup search does not work with RT fields", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "2b879180edf8afdd3e72d66f029041735bfaf983", "url": "https://github.com/elastic/elasticsearch/commit/2b879180edf8afdd3e72d66f029041735bfaf983", "message": "Testing", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "a29ff35fd9a2c6173c6cc7472b1494873e6df6d8", "url": "https://github.com/elastic/elasticsearch/commit/a29ff35fd9a2c6173c6cc7472b1494873e6df6d8", "message": "don't request RT fields in field caps", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "1fd4b666441b5961180ba07b5b3073d030e21a45", "url": "https://github.com/elastic/elasticsearch/commit/1fd4b666441b5961180ba07b5b3073d030e21a45", "message": "Testing", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "a72baf9ec95c88adb7bafea8139109e5655a77e9", "url": "https://github.com/elastic/elasticsearch/commit/a72baf9ec95c88adb7bafea8139109e5655a77e9", "message": "Tidy up", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "b7c8cf7616b30d93529065d6be21956da0b6b816", "url": "https://github.com/elastic/elasticsearch/commit/b7c8cf7616b30d93529065d6be21956da0b6b816", "message": "Add test for datafeed aggs", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "ed78e23a9dfcf9f863cfe23ade0b88cac7e0c801", "url": "https://github.com/elastic/elasticsearch/commit/ed78e23a9dfcf9f863cfe23ade0b88cac7e0c801", "message": "Preview datafeed aggs test", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "fda46c5603f0e180789766de7bbe650ff327d306", "url": "https://github.com/elastic/elasticsearch/commit/fda46c5603f0e180789766de7bbe650ff327d306", "message": "Revert \"Add test for datafeed aggs\"\n\nThis reverts commit 9233485160f416a15187941f19912c7e58f2a105.", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "98f65ac4645231be714cd57ead050416126d5c9f", "url": "https://github.com/elastic/elasticsearch/commit/98f65ac4645231be714cd57ead050416126d5c9f", "message": "Fix up the yaml test", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "url": "https://github.com/elastic/elasticsearch/commit/9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "message": "Nits", "committedDate": "2020-12-01T13:49:25Z", "type": "commit"}, {"oid": "9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "url": "https://github.com/elastic/elasticsearch/commit/9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "message": "Nits", "committedDate": "2020-12-01T13:49:25Z", "type": "forcePushed"}]}