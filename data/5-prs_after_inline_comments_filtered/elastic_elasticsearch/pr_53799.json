{"pr_number": 53799, "pr_title": "Improve async search's tasks cancellation", "pr_createdAt": "2020-03-19T13:59:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53799", "timeline": [{"oid": "d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7", "url": "https://github.com/elastic/elasticsearch/commit/d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7", "message": "Improve async search's tasks cancellation\n\nThis commit adds an explicit cancellation of the search task if\nthe initial async search submit task is cancelled (connection closed by the user).\nThis was previously done through the cancellation of the parent task but we don't\nhandle grand-children cancellation yet so we have to manually cancel the search task\nin order to ensure that shard actions are cancelled too.\nThis change can be considered as a workaround until #50990 is fixed.", "committedDate": "2020-03-19T13:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NTAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/53799#discussion_r395665036", "bodyText": "shall we still set the parent task id anyways just for the consistency of the tasks tree, or is it required that we don't do so?", "author": "javanna", "createdAt": "2020-03-20T14:16:09Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -77,15 +79,16 @@\n     AsyncSearchTask(long id,\n                     String type,\n                     String action,\n-                    TaskId parentTaskId,\n+                    CancellableTask submitTask,\n                     TimeValue keepAlive,\n                     Map<String, String> originHeaders,\n                     Map<String, String> taskHeaders,\n                     AsyncSearchId searchId,\n                     Client client,\n                     ThreadPool threadPool,\n                     Supplier<InternalAggregation.ReduceContext> aggReduceContextSupplier) {\n-        super(id, type, action, \"async_search\", parentTaskId, taskHeaders);\n+        super(id, type, action, \"async_search\", TaskId.EMPTY_TASK_ID, taskHeaders);", "originalCommit": "d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MzU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53799#discussion_r396673577", "bodyText": "++, I pushed e3f892e", "author": "jimczi", "createdAt": "2020-03-23T18:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NTAzNg=="}], "type": "inlineReview"}, {"oid": "e3f892ebf24ae0e4997ca3b73dc43f1761dc3667", "url": "https://github.com/elastic/elasticsearch/commit/e3f892ebf24ae0e4997ca3b73dc43f1761dc3667", "message": "address review", "committedDate": "2020-03-23T17:56:07Z", "type": "commit"}, {"oid": "b1c052a19209f37e5bc8c05dfb5647e5dc0b56bc", "url": "https://github.com/elastic/elasticsearch/commit/b1c052a19209f37e5bc8c05dfb5647e5dc0b56bc", "message": "Merge branch 'master' into async_search_submit_cancellation", "committedDate": "2020-03-23T18:33:18Z", "type": "commit"}, {"oid": "d177d965346d0a489962bbd109823314ce39d37d", "url": "https://github.com/elastic/elasticsearch/commit/d177d965346d0a489962bbd109823314ce39d37d", "message": "Merge branch 'master' into async_search_submit_cancellation", "committedDate": "2020-03-24T01:07:18Z", "type": "commit"}, {"oid": "d74592ddb2eeca0102f558719f0164c5260bdf66", "url": "https://github.com/elastic/elasticsearch/commit/d74592ddb2eeca0102f558719f0164c5260bdf66", "message": "set the parent task id on the submit search request", "committedDate": "2020-03-24T01:50:54Z", "type": "commit"}]}