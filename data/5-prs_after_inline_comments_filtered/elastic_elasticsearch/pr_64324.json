{"pr_number": 64324, "pr_title": "Serialize can contain data with roles", "pr_createdAt": "2020-10-29T02:19:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64324", "timeline": [{"oid": "4cb5ee4f4f1e63e83d5baa04f80d744083285938", "url": "https://github.com/elastic/elasticsearch/commit/4cb5ee4f4f1e63e83d5baa04f80d744083285938", "message": "Serialize can contain data with roles\n\nThis commit internalizes whether or not a role represents the ability to\ncontain data. In the future, this will let us remove the compatibility\nrole notion.", "committedDate": "2020-10-29T02:19:02Z", "type": "commit"}, {"oid": "27c835834d50354317e8772750c24c7d2aa9c920", "url": "https://github.com/elastic/elasticsearch/commit/27c835834d50354317e8772750c24c7d2aa9c920", "message": "Fix equals and hash code", "committedDate": "2020-10-29T02:20:35Z", "type": "commit"}, {"oid": "a76b204b70d4fabd6573919e46d9f109df598b9c", "url": "https://github.com/elastic/elasticsearch/commit/a76b204b70d4fabd6573919e46d9f109df598b9c", "message": "Fix toString", "committedDate": "2020-10-29T02:21:24Z", "type": "commit"}, {"oid": "52cec92ebb3c5b59ad38595008d364c96b6079a1", "url": "https://github.com/elastic/elasticsearch/commit/52cec92ebb3c5b59ad38595008d364c96b6079a1", "message": "Fix tests", "committedDate": "2020-10-29T03:43:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64324#discussion_r514443552", "bodyText": "Once this is backported, do you plan to change this to not use getCompatibilityRole and remove that straightaway? (in 7.10.0 I mean)", "author": "dakrone", "createdAt": "2020-10-29T17:35:07Z", "path": "server/src/main/java/org/elasticsearch/cluster/node/DiscoveryNode.java", "diffHunk": "@@ -288,6 +294,9 @@ public void writeTo(StreamOutput out) throws IOException {\n             final DiscoveryNodeRole compatibleRole = role.getCompatibilityRole(out.getVersion());\n             out.writeString(compatibleRole.roleName());\n             out.writeString(compatibleRole.roleNameAbbreviation());\n+            if (out.getVersion().onOrAfter(Version.V_8_0_0)) {\n+                out.writeBoolean(compatibleRole.canContainData());", "originalCommit": "52cec92ebb3c5b59ad38595008d364c96b6079a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NTY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/64324#discussion_r514445668", "bodyText": "I might be missing something, but I don't think we can remove it straightaway because masters on older versions still need to be told these nodes with the data_* roles can hold data, and I think sending the compatible role is the only way? I think we have to wait to remove compatible role until we are no longer communicating with master nodes that do not understand the \"can contain data\" field.", "author": "jasontedor", "createdAt": "2020-10-29T17:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ1ODMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/64324#discussion_r514458338", "bodyText": "You're not missing something, you're correct. We'll still need it for pre-7.10 versions. I suppose we could remove it for master only since we do specify that only the latest 7.x release can do a rolling upgrade to 8.0, but otherwise we couldn't remove it from 7.x.", "author": "dakrone", "createdAt": "2020-10-29T17:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ1OTMwOA==", "url": "https://github.com/elastic/elasticsearch/pull/64324#discussion_r514459308", "bodyText": "Okay, I like the idea of removing it from master right away. I'll pick that up in a follow-up.", "author": "jasontedor", "createdAt": "2020-10-29T17:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU1Mg=="}], "type": "inlineReview"}]}