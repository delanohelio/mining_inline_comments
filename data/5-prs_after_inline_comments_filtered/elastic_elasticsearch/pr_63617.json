{"pr_number": 63617, "pr_title": "Add supports for upper and lower values on boxplot based on the IQR value", "pr_createdAt": "2020-10-13T14:24:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63617", "timeline": [{"oid": "bcd29a2f3c95ee7013509c797c8d543f935d1f99", "url": "https://github.com/elastic/elasticsearch/commit/bcd29a2f3c95ee7013509c797c8d543f935d1f99", "message": "experimenting", "committedDate": "2020-08-31T13:14:44Z", "type": "commit"}, {"oid": "bad48b3b340ab259906acfabe2052ab9c7a0b25a", "url": "https://github.com/elastic/elasticsearch/commit/bad48b3b340ab259906acfabe2052ab9c7a0b25a", "message": "function to find IQR based whisker values", "committedDate": "2020-09-14T15:17:35Z", "type": "commit"}, {"oid": "05e6d1f9c7cd66d4d85096b5e8cb0992442a7a22", "url": "https://github.com/elastic/elasticsearch/commit/05e6d1f9c7cd66d4d85096b5e8cb0992442a7a22", "message": "replace enum switch with abstract method", "committedDate": "2020-09-15T13:22:47Z", "type": "commit"}, {"oid": "2ad2e6ff7925b5ad71758af719207c1fccc480c1", "url": "https://github.com/elastic/elasticsearch/commit/2ad2e6ff7925b5ad71758af719207c1fccc480c1", "message": "null handling", "committedDate": "2020-09-15T17:42:24Z", "type": "commit"}, {"oid": "3ef7773611ed5d434f54423bfd47bebb1a505ab6", "url": "https://github.com/elastic/elasticsearch/commit/3ef7773611ed5d434f54423bfd47bebb1a505ab6", "message": "add output format testing", "committedDate": "2020-09-24T18:40:22Z", "type": "commit"}, {"oid": "0b8549470f3fd5d5f0a18a8bc1c011153488b97d", "url": "https://github.com/elastic/elasticsearch/commit/0b8549470f3fd5d5f0a18a8bc1c011153488b97d", "message": "Merge branch 'master' into boxplot_iqr", "committedDate": "2020-10-12T20:04:43Z", "type": "commit"}, {"oid": "940ff1e447ff74e37e9e7bc7a686f418d268d38e", "url": "https://github.com/elastic/elasticsearch/commit/940ff1e447ff74e37e9e7bc7a686f418d268d38e", "message": "Update docs and fix doc tests", "committedDate": "2020-10-19T19:29:43Z", "type": "commit"}, {"oid": "c5e4459112098a3db0dd34a3c4d1702665a4f66f", "url": "https://github.com/elastic/elasticsearch/commit/c5e4459112098a3db0dd34a3c4d1702665a4f66f", "message": "Merge branch 'master' into boxplot_iqr", "committedDate": "2020-10-19T19:48:47Z", "type": "commit"}, {"oid": "4fef801bb3a7a4ad038f971d37477544bcd73fdc", "url": "https://github.com/elastic/elasticsearch/commit/4fef801bb3a7a4ad038f971d37477544bcd73fdc", "message": "Merge branch 'master' into boxplot_iqr\n\n Conflicts:\n\tx-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplotTests.java", "committedDate": "2020-11-02T17:40:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1NzczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63617#discussion_r516857731", "bodyText": "Nice!", "author": "imotov", "createdAt": "2020-11-03T18:01:26Z", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplot.java", "diffHunk": "@@ -25,8 +27,83 @@\n public class InternalBoxplot extends InternalNumericMetricsAggregation.MultiValue implements Boxplot {\n \n     enum Metrics {\n+        MIN {", "originalCommit": "4fef801bb3a7a4ad038f971d37477544bcd73fdc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1OTIzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63617#discussion_r516859236", "bodyText": "I think it might be a good idea to make this a constant and give it a short explanation....", "author": "imotov", "createdAt": "2020-11-03T18:04:12Z", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplot.java", "diffHunk": "@@ -36,39 +113,48 @@ public String value() {\n             return name().toLowerCase(Locale.ROOT);\n         }\n \n-        double value(InternalBoxplot boxplot) {\n-            switch (this) {\n-                case MIN:\n-                    return boxplot.getMin();\n-                case MAX:\n-                    return boxplot.getMax();\n-                case Q1:\n-                    return boxplot.getQ1();\n-                case Q2:\n-                    return boxplot.getQ2();\n-                case Q3:\n-                    return boxplot.getQ3();\n-                default:\n-                    throw new IllegalArgumentException(\"Unknown value [\" + this.value() + \"] in the boxplot aggregation\");\n-            }\n+        abstract double value(InternalBoxplot boxplot);\n+\n+        abstract double value(TDigestState state);\n+    }\n+\n+    /**\n+     * For a given TDigest, find the \"whisker\" valeus, such that the upper whisker is (close to) the highest observed value less than\n+     * q3 + 1.5 * IQR and the lower whisker is (close to) the lowest observed value greater than q1 - 1.5 * IQR.  Since we don't track\n+     * observed values directly, this function returns the centroid according to the above logic.\n+     *\n+     * @param state - an initialized TDigestState representing the observed data.\n+     * @return - two doubles in an array, where whiskers[0] is the lower whisker and whiskers[1] is the upper whisker.\n+     */\n+    public static double[] whiskers(TDigestState state) {\n+        double[] results = new double[2];\n+        results[0] = Double.NaN;\n+        results[1] = Double.NaN;\n+        if (state == null) {\n+            return results;\n         }\n \n-        double value(TDigestState state) {\n-            switch (this) {\n-                case MIN:\n-                    return state == null ? Double.NEGATIVE_INFINITY : state.getMin();\n-                case MAX:\n-                    return state == null ? Double.POSITIVE_INFINITY : state.getMax();\n-                case Q1:\n-                    return state == null ? Double.NaN : state.quantile(0.25);\n-                case Q2:\n-                    return state == null ? Double.NaN : state.quantile(0.5);\n-                case Q3:\n-                    return state == null ? Double.NaN : state.quantile(0.75);\n-                default:\n-                    throw new IllegalArgumentException(\"Unknown value [\" + this.value() + \"] in the boxplot aggregation\");\n+        double q3 = state.quantile(0.75);\n+        double q1 = state.quantile(0.25);\n+        double iqr = q3 - q1;\n+        double upper = q3 + (1.5 * iqr);\n+        double lower = q1 - (1.5 * iqr);", "originalCommit": "4fef801bb3a7a4ad038f971d37477544bcd73fdc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d78449be213b6981313a69c751be97654f261b7", "url": "https://github.com/elastic/elasticsearch/commit/2d78449be213b6981313a69c751be97654f261b7", "message": "response to PR feedback", "committedDate": "2020-11-04T16:31:55Z", "type": "commit"}, {"oid": "7216c49d8ac1093987a49ea0edffafaaf1b7f319", "url": "https://github.com/elastic/elasticsearch/commit/7216c49d8ac1093987a49ea0edffafaaf1b7f319", "message": "Merge branch 'master' into boxplot_iqr", "committedDate": "2020-11-04T18:38:09Z", "type": "commit"}]}