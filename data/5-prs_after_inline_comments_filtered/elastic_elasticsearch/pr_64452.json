{"pr_number": 64452, "pr_title": "Add validation of the SLM schedule frequency", "pr_createdAt": "2020-10-30T23:35:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64452", "timeline": [{"oid": "c79c3d9c60ac57d79da31f0eaef482446845cd61", "url": "https://github.com/elastic/elasticsearch/commit/c79c3d9c60ac57d79da31f0eaef482446845cd61", "message": "Reorganize testValidation a bit\n\nmostly just whitespace", "committedDate": "2020-11-03T18:34:11Z", "type": "commit"}, {"oid": "b6f24be4afb667a7c213eae8378ae89e446c08c7", "url": "https://github.com/elastic/elasticsearch/commit/b6f24be4afb667a7c213eae8378ae89e446c08c7", "message": "Add a happy path test", "committedDate": "2020-11-03T18:34:54Z", "type": "commit"}, {"oid": "1fb45477fe57441d48bd776d8a13921014ae8dad", "url": "https://github.com/elastic/elasticsearch/commit/1fb45477fe57441d48bd776d8a13921014ae8dad", "message": "Add the slm.minimum_interval setting\n\nIt represents the minimum allowable scheduled time from when one\nsnapshot starts to when the next snapshot following it will\nstart. Defaults to 15 minutes.", "committedDate": "2020-11-03T18:35:41Z", "type": "commit"}, {"oid": "4b7b737658cd33ee3595b80e1cbd02203fdc3a65", "url": "https://github.com/elastic/elasticsearch/commit/4b7b737658cd33ee3595b80e1cbd02203fdc3a65", "message": "Add a method for getting the interval of a policy", "committedDate": "2020-11-03T18:50:31Z", "type": "commit"}, {"oid": "1f321e0c89adc30b63c64fa7be3d98469bbebf90", "url": "https://github.com/elastic/elasticsearch/commit/1f321e0c89adc30b63c64fa7be3d98469bbebf90", "message": "Validate slm policies against the minimum interval", "committedDate": "2020-11-03T18:51:05Z", "type": "commit"}, {"oid": "b4d4cfc2f620e830f77f575a1f2c45009e1d17b6", "url": "https://github.com/elastic/elasticsearch/commit/b4d4cfc2f620e830f77f575a1f2c45009e1d17b6", "message": "Make the tests pass again", "committedDate": "2020-11-03T18:51:38Z", "type": "commit"}, {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "url": "https://github.com/elastic/elasticsearch/commit/a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "message": "Add a test of the minimum interval validation", "committedDate": "2020-11-03T18:51:38Z", "type": "commit"}, {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "url": "https://github.com/elastic/elasticsearch/commit/a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "message": "Add a test of the minimum interval validation", "committedDate": "2020-11-03T18:51:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NzA3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r516997076", "bodyText": "Since this is public, can you add javadocs and perhaps rather than returning a long we could take this opportunity and return a TimeValue so that we never have unit mismatch issues?", "author": "dakrone", "createdAt": "2020-11-03T22:39:18Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/slm/SnapshotLifecyclePolicy.java", "diffHunk": "@@ -133,6 +133,17 @@ public long calculateNextExecution() {\n         return schedule.getNextValidTimeAfter(System.currentTimeMillis());\n     }\n \n+    public long calculateNextInterval() {", "originalCommit": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwNTQwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517505405", "bodyText": "\u2705, f766e94", "author": "joegallo", "createdAt": "2020-11-04T17:18:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NzA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5Nzc3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r516997776", "bodyText": "We should include what the limit for frequency is in the error message, and perhaps something like:\ninvalid schedule [*/1 * * * ?]: schedule would be too frequent, executing more frequently than [15m] interval\n\n(the wording doesn't have to be exactly that, just an example)", "author": "dakrone", "createdAt": "2020-11-03T22:40:58Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotLifecycleService.java", "diffHunk": "@@ -234,6 +236,20 @@ public static void validateRepositoryExists(final String repository, final Clust\n             .orElseThrow(() -> new IllegalArgumentException(\"no such repository [\" + repository + \"]\"));\n     }\n \n+    /**\n+     * Validates that the interval between snapshots is not smaller than the minimum interval\n+     * (see {@link LifecycleSettings#SLM_MINIMUM_INTERVAL_SETTING})\n+     * @throws IllegalArgumentException if the interval is less than the minimum\n+     */\n+    public static void validateMinimumInterval(final SnapshotLifecyclePolicy lifecycle, final ClusterState state) {\n+        TimeValue minimumInterval = LifecycleSettings.SLM_MINIMUM_INTERVAL_SETTING.get(state.metadata().settings());\n+        long minimumIntervalMillis = minimumInterval.getMillis();\n+        long nextInterval = lifecycle.calculateNextInterval();\n+        if (nextInterval >= 0 && minimumIntervalMillis > 0 && nextInterval < minimumIntervalMillis) {\n+            throw new IllegalArgumentException(\"invalid schedule [\" + lifecycle.getSchedule() + \"]: too frequent\");", "originalCommit": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0NDE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517444156", "bodyText": "\ud83d\udc4d, how about 2798b78?", "author": "joegallo", "createdAt": "2020-11-04T15:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5Nzc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNjQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517006420", "bodyText": "Since it's static (yay), can you add a unit test for this method to SnapshotLifecycleServiceTests?", "author": "dakrone", "createdAt": "2020-11-03T23:03:04Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotLifecycleService.java", "diffHunk": "@@ -234,6 +236,20 @@ public static void validateRepositoryExists(final String repository, final Clust\n             .orElseThrow(() -> new IllegalArgumentException(\"no such repository [\" + repository + \"]\"));\n     }\n \n+    /**\n+     * Validates that the interval between snapshots is not smaller than the minimum interval\n+     * (see {@link LifecycleSettings#SLM_MINIMUM_INTERVAL_SETTING})\n+     * @throws IllegalArgumentException if the interval is less than the minimum\n+     */\n+    public static void validateMinimumInterval(final SnapshotLifecyclePolicy lifecycle, final ClusterState state) {", "originalCommit": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0NDk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517444988", "bodyText": "\u2705, 4526dc7", "author": "joegallo", "createdAt": "2020-11-04T15:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNjQyMA=="}], "type": "inlineReview"}, {"oid": "2798b78608197e770d3bbf02e2639076da30de1c", "url": "https://github.com/elastic/elasticsearch/commit/2798b78608197e770d3bbf02e2639076da30de1c", "message": "Make the error message more specific\n\nand check for that message in the test", "committedDate": "2020-11-04T14:57:54Z", "type": "commit"}, {"oid": "4526dc70c1f13659fb0a0c5ef596c8a660280098", "url": "https://github.com/elastic/elasticsearch/commit/4526dc70c1f13659fb0a0c5ef596c8a660280098", "message": "Add tests for validateMinimumInterval", "committedDate": "2020-11-04T15:50:24Z", "type": "commit"}, {"oid": "f766e94552081052681296341e601cf64f1752fb", "url": "https://github.com/elastic/elasticsearch/commit/f766e94552081052681296341e601cf64f1752fb", "message": "Change return type and add a docstring", "committedDate": "2020-11-04T17:03:41Z", "type": "commit"}, {"oid": "0033bc74728f3d44d7083fea3456d513f0b84c16", "url": "https://github.com/elastic/elasticsearch/commit/0033bc74728f3d44d7083fea3456d513f0b84c16", "message": "Merge branch 'master' into validate-slm-schedule-frequency", "committedDate": "2020-11-04T17:19:16Z", "type": "commit"}]}