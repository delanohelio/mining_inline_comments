{"pr_number": 59293, "pr_title": "Make data streams a basic licensed feature.", "pr_createdAt": "2020-07-09T12:01:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59293", "timeline": [{"oid": "da3e678ff2d47aa22564fb3d3c4142e6ea69bbc8", "url": "https://github.com/elastic/elasticsearch/commit/da3e678ff2d47aa22564fb3d3c4142e6ea69bbc8", "message": "Make data streams a basic licensed feature.\n\n* Create new data-stream xpack module.\n* Move TimestampFieldMapper to the new module,\n  this results in storing a composable index template\n  with data stream definition only to work with default\n  distribution. This way data streams can only be used\n  with default distribution, since a data stream can\n  currently only be created if a matching composable index\n  template exists with a data stream definition.\n\nIn a follow up the data stream transport and\nrest actions can be moved to the xpack data-stream module.", "committedDate": "2020-07-09T09:37:55Z", "type": "commit"}, {"oid": "336b11e57715e8e67637c55d08a4e357a0f1c76e", "url": "https://github.com/elastic/elasticsearch/commit/336b11e57715e8e67637c55d08a4e357a0f1c76e", "message": "move more data stream yaml tests", "committedDate": "2020-07-09T10:14:56Z", "type": "commit"}, {"oid": "e9868a3b3c6ac115adae0f465ba8ddb6f96abf48", "url": "https://github.com/elastic/elasticsearch/commit/e9868a3b3c6ac115adae0f465ba8ddb6f96abf48", "message": "copied resolve index yaml to data stream module and modify the existing to not use data streams", "committedDate": "2020-07-09T10:21:53Z", "type": "commit"}, {"oid": "36f132909177a46e6502599ab8063bd7882095eb", "url": "https://github.com/elastic/elasticsearch/commit/36f132909177a46e6502599ab8063bd7882095eb", "message": "moved more integ tests to xpack module", "committedDate": "2020-07-09T10:36:44Z", "type": "commit"}, {"oid": "7daa879adb94433877dc1b19ce0fd9ec5b87a35a", "url": "https://github.com/elastic/elasticsearch/commit/7daa879adb94433877dc1b19ce0fd9ec5b87a35a", "message": "Added test that verifies behaviour if composable index template is used with data steam definition and it isn't supported.", "committedDate": "2020-07-09T11:21:53Z", "type": "commit"}, {"oid": "e23ae67c6bdbae68a03eac6e88ddb85a0f0969b3", "url": "https://github.com/elastic/elasticsearch/commit/e23ae67c6bdbae68a03eac6e88ddb85a0f0969b3", "message": "fixed checkstyle issues", "committedDate": "2020-07-09T11:32:32Z", "type": "commit"}, {"oid": "8eeb789b0629468f3a12e41c8372742656e40f6a", "url": "https://github.com/elastic/elasticsearch/commit/8eeb789b0629468f3a12e41c8372742656e40f6a", "message": "Remove interface and move validate() method to MetadataFieldMapper class", "committedDate": "2020-07-09T11:38:52Z", "type": "commit"}, {"oid": "3f5754d708ab7e0579dc3227546a23cbd4b39cc1", "url": "https://github.com/elastic/elasticsearch/commit/3f5754d708ab7e0579dc3227546a23cbd4b39cc1", "message": "fixed test", "committedDate": "2020-07-09T11:42:39Z", "type": "commit"}, {"oid": "c2f64a4a51b293ee40092bb9752949d383b61fc3", "url": "https://github.com/elastic/elasticsearch/commit/c2f64a4a51b293ee40092bb9752949d383b61fc3", "message": "added jdocs", "committedDate": "2020-07-09T11:45:13Z", "type": "commit"}, {"oid": "7d230965f27ea203a9d8b9719f81549f1e685b9d", "url": "https://github.com/elastic/elasticsearch/commit/7d230965f27ea203a9d8b9719f81549f1e685b9d", "message": "include mock repo plugin", "committedDate": "2020-07-09T11:57:44Z", "type": "commit"}, {"oid": "001a9a433c9cc8f82c786198a9c5cdd5c32d6102", "url": "https://github.com/elastic/elasticsearch/commit/001a9a433c9cc8f82c786198a9c5cdd5c32d6102", "message": "removed apache license headers", "committedDate": "2020-07-09T12:03:00Z", "type": "commit"}, {"oid": "fbcf34e8e7151ea300256ad77423fbc14fc42481", "url": "https://github.com/elastic/elasticsearch/commit/fbcf34e8e7151ea300256ad77423fbc14fc42481", "message": "moved test to its own class. (setup logic got in the way)", "committedDate": "2020-07-09T12:16:22Z", "type": "commit"}, {"oid": "1dec7181610b78758da230a684f5410ca00b2c0a", "url": "https://github.com/elastic/elasticsearch/commit/1dec7181610b78758da230a684f5410ca00b2c0a", "message": "Merge remote-tracking branch 'es/master' into move_data_streams_to_xpack", "committedDate": "2020-07-09T13:04:46Z", "type": "commit"}, {"oid": "203e0aef38973211dbdb6569b80c24087cc32c26", "url": "https://github.com/elastic/elasticsearch/commit/203e0aef38973211dbdb6569b80c24087cc32c26", "message": "move forgotten data stream tests to xpack module", "committedDate": "2020-07-09T13:38:08Z", "type": "commit"}, {"oid": "6b2a7e2867835e149d9a205ce4e61eb2633b93d4", "url": "https://github.com/elastic/elasticsearch/commit/6b2a7e2867835e149d9a205ce4e61eb2633b93d4", "message": "checkstyle!", "committedDate": "2020-07-09T15:00:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4NzU4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59293#discussion_r452287582", "bodyText": "I think we should fail with a parsing error like \"[index_template] unknown field [data_stream]\" to make it clearer that the entire data stream configuration is unsupported, rather than just the @timestamp part", "author": "dakrone", "createdAt": "2020-07-09T15:05:38Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -1136,7 +1137,15 @@ private static void validateCompositeTemplate(final ClusterState state,\n                         validateTimestampFieldMapping(tsFieldName, mapperService);\n                     }\n                 } catch (Exception e) {\n-                    throw new IllegalArgumentException(\"invalid composite mappings for [\" + templateName + \"]\", e);\n+                    final String expectedMessageIfDataStreamsIsUsedAndNotSupported =\n+                        \"Failed to parse mapping: Root mapping definition has unsupported parameters:  [_timestamp : {path=@timestamp}]\";\n+                    if (expectedMessageIfDataStreamsIsUsedAndNotSupported.equals(e.getMessage())) {\n+                        // Fail like a parsing expection, since we will be moving data_stream template out of server module and\n+                        // then we would fail with the same error message, like we do here.\n+                        throw new XContentParseException(\"[index_template] unknown field [@timestamp]\");", "originalCommit": "6b2a7e2867835e149d9a205ce4e61eb2633b93d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "59dc7a95f6f06b9ae8601b2f48168660face7e01", "url": "https://github.com/elastic/elasticsearch/commit/59dc7a95f6f06b9ae8601b2f48168660face7e01", "message": "moved more rest tests", "committedDate": "2020-07-09T21:14:37Z", "type": "commit"}, {"oid": "ded46a997a6c9b06b15981578beefe272fd06dd5", "url": "https://github.com/elastic/elasticsearch/commit/ded46a997a6c9b06b15981578beefe272fd06dd5", "message": "fixed a test and moved unit tests to data stream module, because these relied on _timestamp field mapper.", "committedDate": "2020-07-09T21:28:43Z", "type": "commit"}, {"oid": "1278568ba6cb5acd7781482290be6a3b8bc90c0d", "url": "https://github.com/elastic/elasticsearch/commit/1278568ba6cb5acd7781482290be6a3b8bc90c0d", "message": "fixed error message", "committedDate": "2020-07-09T21:34:09Z", "type": "commit"}, {"oid": "e556c5a6652c42cd9fa17b1d91f045b4c00b7ed0", "url": "https://github.com/elastic/elasticsearch/commit/e556c5a6652c42cd9fa17b1d91f045b4c00b7ed0", "message": "Merge remote-tracking branch 'es/master' into move_data_streams_to_xpack", "committedDate": "2020-07-09T21:53:04Z", "type": "commit"}, {"oid": "f24b019cb8c3ddd7f662c9ff7e531a2b436f4f51", "url": "https://github.com/elastic/elasticsearch/commit/f24b019cb8c3ddd7f662c9ff7e531a2b436f4f51", "message": "removed unused imports", "committedDate": "2020-07-10T09:32:15Z", "type": "commit"}, {"oid": "7357635954bebd0f5c5b2272cecdf619ef54f282", "url": "https://github.com/elastic/elasticsearch/commit/7357635954bebd0f5c5b2272cecdf619ef54f282", "message": "Merge remote-tracking branch 'es/master' into move_data_streams_to_xpack", "committedDate": "2020-07-10T09:32:39Z", "type": "commit"}, {"oid": "5355a2f61b9444563decd2a1d725afe666fbeede", "url": "https://github.com/elastic/elasticsearch/commit/5355a2f61b9444563decd2a1d725afe666fbeede", "message": "fixed unit tests", "committedDate": "2020-07-10T13:14:41Z", "type": "commit"}, {"oid": "9ef96c835c2ede0b7334d2abe74255e1adb100de", "url": "https://github.com/elastic/elasticsearch/commit/9ef96c835c2ede0b7334d2abe74255e1adb100de", "message": "moved full restart test", "committedDate": "2020-07-10T13:23:51Z", "type": "commit"}, {"oid": "2d117b2ea0994aecf980c3329a2e80c41cc0977d", "url": "https://github.com/elastic/elasticsearch/commit/2d117b2ea0994aecf980c3329a2e80c41cc0977d", "message": "moved data stream rolling upgrade test", "committedDate": "2020-07-10T16:43:52Z", "type": "commit"}, {"oid": "d3913f5d3370dcbbb7a5c60f91dec731af812f44", "url": "https://github.com/elastic/elasticsearch/commit/d3913f5d3370dcbbb7a5c60f91dec731af812f44", "message": "moved data stream css tests", "committedDate": "2020-07-10T17:26:48Z", "type": "commit"}, {"oid": "c00ae23e82f6decb3ff8f40e288cb55d3be99d96", "url": "https://github.com/elastic/elasticsearch/commit/c00ae23e82f6decb3ff8f40e288cb55d3be99d96", "message": "Merge remote-tracking branch 'es/master' into move_data_streams_to_xpack", "committedDate": "2020-07-10T17:59:53Z", "type": "commit"}, {"oid": "249979ec220df6d9d6e5a7c40851cf37138e408c", "url": "https://github.com/elastic/elasticsearch/commit/249979ec220df6d9d6e5a7c40851cf37138e408c", "message": "fixed issues after merge", "committedDate": "2020-07-10T18:08:09Z", "type": "commit"}, {"oid": "9f037a391b6d641751b72826aa0cbcc2ce4a3773", "url": "https://github.com/elastic/elasticsearch/commit/9f037a391b6d641751b72826aa0cbcc2ce4a3773", "message": "removed unneeded stuff", "committedDate": "2020-07-10T18:12:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NTA2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59293#discussion_r453375066", "bodyText": "Instead of relying on an exception with a specific message, what if we proactively checked if the timestamp mapper existed? We could do something like\nboolean timestampMapperExists = tempIndexService.mapperService().isMetadataField(\"_timestamp\");\n\nand then throw if there's a data_stream definition but no _timestamp metadata mapper.", "author": "jtibshirani", "createdAt": "2020-07-12T23:14:44Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -1136,7 +1137,15 @@ private static void validateCompositeTemplate(final ClusterState state,\n                         validateTimestampFieldMapping(tsFieldName, mapperService);\n                     }\n                 } catch (Exception e) {\n-                    throw new IllegalArgumentException(\"invalid composite mappings for [\" + templateName + \"]\", e);\n+                    final String expectedMessageIfDataStreamsIsUsedAndNotSupported =", "originalCommit": "9f037a391b6d641751b72826aa0cbcc2ce4a3773", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUwNDgzMw==", "url": "https://github.com/elastic/elasticsearch/pull/59293#discussion_r453504833", "bodyText": "Thanks. This is less fragile than checking the exception message.", "author": "martijnvg", "createdAt": "2020-07-13T09:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3NTA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM3OTU1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59293#discussion_r453379552", "bodyText": "Now that we're moving this to the data streams plugin, should we update the naming to be specific to data streams? Calling it something like _data_stream_timestamp could also avoid confusion with the _timestamp metadata mapper we used to provide.", "author": "jtibshirani", "createdAt": "2020-07-12T23:57:34Z", "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/mapper/TimestampFieldMapper.java", "diffHunk": "@@ -1,23 +1,10 @@\n /*\n- * Licensed to Elasticsearch under one or more contributor\n- * license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright\n- * ownership. Elasticsearch licenses this file to you under\n- * the Apache License, Version 2.0 (the \"License\"); you may\n- * not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n  */\n \n-package org.elasticsearch.index.mapper;\n+package org.elasticsearch.xpack.datastreams.mapper;", "originalCommit": "9f037a391b6d641751b72826aa0cbcc2ce4a3773", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aac9ba93af0e460a280b06c99692afa971a194cb", "url": "https://github.com/elastic/elasticsearch/commit/aac9ba93af0e460a280b06c99692afa971a194cb", "message": "Merge remote-tracking branch 'es/master' into move_data_streams_to_xpack", "committedDate": "2020-07-13T04:55:30Z", "type": "commit"}, {"oid": "b4b7501020eb9000ea1b32aa490321fd338958e5", "url": "https://github.com/elastic/elasticsearch/commit/b4b7501020eb9000ea1b32aa490321fd338958e5", "message": "renamed timestamp field mapper", "committedDate": "2020-07-13T05:33:49Z", "type": "commit"}, {"oid": "8f3cb5c4741add60b0ab84330738a59ec64af54b", "url": "https://github.com/elastic/elasticsearch/commit/8f3cb5c4741add60b0ab84330738a59ec64af54b", "message": "more robust check", "committedDate": "2020-07-13T05:47:40Z", "type": "commit"}, {"oid": "21cb1c998b77546545fb8334fe471ac426b11a81", "url": "https://github.com/elastic/elasticsearch/commit/21cb1c998b77546545fb8334fe471ac426b11a81", "message": "fixed tests and use feature flag", "committedDate": "2020-07-13T06:02:08Z", "type": "commit"}, {"oid": "718bdcb9c6f10eea1fec1c3d80bd38320c670eb7", "url": "https://github.com/elastic/elasticsearch/commit/718bdcb9c6f10eea1fec1c3d80bd38320c670eb7", "message": "spotless formatting", "committedDate": "2020-07-13T06:08:23Z", "type": "commit"}, {"oid": "aa727bfa9048312ff1b917843b7f44d466e43c7c", "url": "https://github.com/elastic/elasticsearch/commit/aa727bfa9048312ff1b917843b7f44d466e43c7c", "message": "fixed tests", "committedDate": "2020-07-13T06:40:30Z", "type": "commit"}, {"oid": "355c99a71da3a24a52b29368d098263fa1847159", "url": "https://github.com/elastic/elasticsearch/commit/355c99a71da3a24a52b29368d098263fa1847159", "message": "fixed rename", "committedDate": "2020-07-13T06:57:16Z", "type": "commit"}, {"oid": "1a1485032b35f2fe7ae1676e6c39a19af85ab0c6", "url": "https://github.com/elastic/elasticsearch/commit/1a1485032b35f2fe7ae1676e6c39a19af85ab0c6", "message": "mute bwc tests,\nthe timestamp meta field mapper is renamed from `_timestamp` to `_data_streams_timestamp`", "committedDate": "2020-07-13T07:06:41Z", "type": "commit"}]}