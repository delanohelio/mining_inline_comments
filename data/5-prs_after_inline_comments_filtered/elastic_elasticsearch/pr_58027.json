{"pr_number": 58027, "pr_title": "Check for degenerated lines when calculating the centroid", "pr_createdAt": "2020-06-12T08:52:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58027", "timeline": [{"oid": "76387cf50624c8c1d753646f3a1277cfa21f35e1", "url": "https://github.com/elastic/elasticsearch/commit/76387cf50624c8c1d753646f3a1277cfa21f35e1", "message": "Check for degenerated lines when calculating the centroid", "committedDate": "2020-06-12T08:49:09Z", "type": "commit"}, {"oid": "271ca0ff7fb434b7088db6f318c4e98c0fcd2a37", "url": "https://github.com/elastic/elasticsearch/commit/271ca0ff7fb434b7088db6f318c4e98c0fcd2a37", "message": "typo", "committedDate": "2020-06-12T09:04:37Z", "type": "commit"}, {"oid": "05544d1843f6aafe33897991094361cc1b82950c", "url": "https://github.com/elastic/elasticsearch/commit/05544d1843f6aafe33897991094361cc1b82950c", "message": "update logic of how we calculate centroid of lines", "committedDate": "2020-06-12T14:46:29Z", "type": "commit"}, {"oid": "6b0a5c86e1de77e19f0ef3710ac5e060ed33fe2a", "url": "https://github.com/elastic/elasticsearch/commit/6b0a5c86e1de77e19f0ef3710ac5e060ed33fe2a", "message": "update logic of how we calculate centroid of rectangle", "committedDate": "2020-06-15T06:48:08Z", "type": "commit"}, {"oid": "b46aa84f57ab94e8226c1371a0795bd9ba6530ad", "url": "https://github.com/elastic/elasticsearch/commit/b46aa84f57ab94e8226c1371a0795bd9ba6530ad", "message": "Merge branch 'master' into degeneratedLine", "committedDate": "2020-06-15T07:58:57Z", "type": "commit"}, {"oid": "0d5e50f3c7f38553f1814397f82997fc28b1c385", "url": "https://github.com/elastic/elasticsearch/commit/0d5e50f3c7f38553f1814397f82997fc28b1c385", "message": "update logic of how we calculate centroid of rectangle", "committedDate": "2020-06-15T08:15:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3MTY5MA==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440471690", "bodyText": "a point should have a weight of 1?", "author": "talevy", "createdAt": "2020-06-15T22:02:06Z", "path": "x-pack/plugin/spatial/src/test/java/org/elasticsearch/xpack/spatial/index/fielddata/CentroidCalculatorTests.java", "diffHunk": "@@ -250,7 +258,7 @@ public void testPolygonAsPoint() {\n         CentroidCalculator calculator = new CentroidCalculator(polygon);\n         assertThat(calculator.getX(), equalTo(GeoUtils.normalizeLon(point.getX())));\n         assertThat(calculator.getY(), equalTo(GeoUtils.normalizeLat(point.getY())));\n-        assertThat(calculator.sumWeight(), equalTo(1.0));\n+        assertThat(calculator.sumWeight(), equalTo(3.0));", "originalCommit": "0d5e50f3c7f38553f1814397f82997fc28b1c385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY2MDc1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440660753", "bodyText": "This is a bit of a fake test as we are trying to compute the centroid of a polygon which all points are the same. This is an invalid polygon and we should never get here. I think it is ok to consider in this case that the centroid is the sum of the centroid of each point. It has no practical consequences.", "author": "iverase", "createdAt": "2020-06-16T08:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3MTY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxNTAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440915003", "bodyText": "OK", "author": "talevy", "createdAt": "2020-06-16T14:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3MTY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3MjI1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440472251", "bodyText": "good find!", "author": "talevy", "createdAt": "2020-06-15T22:03:28Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/fielddata/CentroidCalculator.java", "diffHunk": "@@ -224,18 +224,18 @@ public Void visit(Polygon polygon) {\n \n         @Override\n         public Void visit(Rectangle rectangle) {\n-            double sumX = rectangle.getMaxX() + rectangle.getMinX();\n-            double sumY = rectangle.getMaxY() + rectangle.getMinY();\n             double diffX = rectangle.getMaxX() - rectangle.getMinX();\n             double diffY = rectangle.getMaxY() - rectangle.getMinY();\n-            if (diffX != 0 && diffY != 0) {\n-                calculator.addCoordinate(sumX / 2, sumY / 2, Math.abs(diffX * diffY), DimensionalShapeType.POLYGON);\n-            } else if (diffX != 0) {\n-                calculator.addCoordinate(sumX / 2, rectangle.getMinY(), diffX, DimensionalShapeType.LINE);\n-            } else if (diffY != 0) {\n-                calculator.addCoordinate(rectangle.getMinX(), sumY / 2, diffY, DimensionalShapeType.LINE);\n+            double rectWeight = Math.abs(diffX * diffY);\n+            if (rectWeight != 0) {\n+                double sumX = rectangle.getMaxX() + rectangle.getMinX();\n+                double sumY = rectangle.getMaxY() + rectangle.getMinY();\n+                calculator.addCoordinate(sumX / 2, sumY / 2, rectWeight, DimensionalShapeType.POLYGON);\n             } else {\n-                visitPoint(rectangle.getMinX(), rectangle.getMinY());\n+                // degenerated rectangle, transform to Line", "originalCommit": "0d5e50f3c7f38553f1814397f82997fc28b1c385", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3NDYxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440474619", "bodyText": "Do we believe this is right?\nIf a line segment has repeating sections where the weight is effectively zero, then we could potentially be counting multiple points per Line?", "author": "talevy", "createdAt": "2020-06-15T22:09:21Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/fielddata/CentroidCalculator.java", "diffHunk": "@@ -246,22 +246,20 @@ private void visitPoint(double x, double y) {\n         }\n \n         private void visitLine(int length, CoordinateSupplier x, CoordinateSupplier y) {\n-            // check line has length\n-            double originDiffX = x.get(0) - x.get(1);\n-            double originDiffY = y.get(0) - y.get(1);\n-            if (originDiffX != 0 || originDiffY != 0) {\n-                // a line's centroid is calculated by summing the center of each\n-                // line segment weighted by the line segment's length in degrees\n-                for (int i = 0; i < length - 1; i++) {\n-                    double diffX = x.get(i) - x.get(i + 1);\n-                    double diffY = y.get(i) - y.get(i + 1);\n-                    double xAvg = (x.get(i) + x.get(i + 1)) / 2;\n-                    double yAvg = (y.get(i) + y.get(i + 1)) / 2;\n-                    double weight = Math.sqrt(diffX * diffX + diffY * diffY);\n+            // a line's centroid is calculated by summing the center of each\n+            // line segment weighted by the line segment's length in degrees\n+            for (int i = 0; i < length - 1; i++) {\n+                double diffX = x.get(i) - x.get(i + 1);\n+                double diffY = y.get(i) - y.get(i + 1);\n+                double xAvg = (x.get(i) + x.get(i + 1)) / 2;\n+                double yAvg = (y.get(i) + y.get(i + 1)) / 2;\n+                double weight = Math.sqrt(diffX * diffX + diffY * diffY);\n+                if (weight == 0) {\n+                    // degenerated line, it can be considered a point\n+                    visitPoint(x.get(i), y.get(i));", "originalCommit": "0d5e50f3c7f38553f1814397f82997fc28b1c385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY2MjE0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440662146", "bodyText": "I think it is ok. If there is one segment with length, the centroid of the points will be discarded. If all points are equivalent, then it will be weight by the number of points. I think it is the right thing to do.", "author": "iverase", "createdAt": "2020-06-16T08:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3NDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxNTMzMg==", "url": "https://github.com/elastic/elasticsearch/pull/58027#discussion_r440915332", "bodyText": "OK. just wanted to be sure! thanks", "author": "talevy", "createdAt": "2020-06-16T14:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3NDYxOQ=="}], "type": "inlineReview"}]}