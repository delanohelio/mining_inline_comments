{"pr_number": 65905, "pr_title": "Autodetermine heap settings based on node roles and total system memory", "pr_createdAt": "2020-12-04T22:38:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65905", "timeline": [{"oid": "0098632dca165a583e0b46f0eba38c99d0c648aa", "url": "https://github.com/elastic/elasticsearch/commit/0098632dca165a583e0b46f0eba38c99d0c648aa", "message": "Autodetermine heap settings based on node roles and total system memory\n\nThis commit expands our JVM egonomics to also automatically determine\nappropriate heap size based on the total available system memory as well\nas the roles assigned to the node. Role determination is done via a\nnaive parsing of elasticsearch.yml. No settings validation is done and\nonly the 'node.roles' setting is taken into consideration.\n\nFor heap purposes a node falls into one of four (4) categories:\n\n1. A 'master-only' node. This is a node with only the 'master' role.\n2. A 'ml-only' node. Similarly, a node with only the 'ml' role.\n3. A 'data' node. This is basically the 'other' case. A node with any\nset of roles other than only master or only ml is considered a 'data'\nnode, to include things like coordinating-only or \"tie-breaker\" nodes.\n4. Unknown. This is the case if legacy settings are used. In this\nscenario we fallback to the old default heap options of 1GB.\n\nIn all cases we short-circuit if a user provides explicit heap options\nso we only ever auto-determine heap if no existing heap options exist.\nStarting with this commit the default heap settings (1GB) are now\nremoved from the default jvm.options which means we'll start auto-\nsetting heap as the new default.", "committedDate": "2020-12-04T22:37:26Z", "type": "commit"}, {"oid": "045ddea34d0e032772e1aedc8afd8fa045c7360c", "url": "https://github.com/elastic/elasticsearch/commit/045ddea34d0e032772e1aedc8afd8fa045c7360c", "message": "Fix spotless", "committedDate": "2020-12-04T22:55:28Z", "type": "commit"}, {"oid": "c57b8a9b470b376d6f8fdde98a465c3950764713", "url": "https://github.com/elastic/elasticsearch/commit/c57b8a9b470b376d6f8fdde98a465c3950764713", "message": "Fix existing packaging tests", "committedDate": "2020-12-05T00:18:46Z", "type": "commit"}, {"oid": "372d7e833c04d53c9380bd7ab308d2dac806e6b2", "url": "https://github.com/elastic/elasticsearch/commit/372d7e833c04d53c9380bd7ab308d2dac806e6b2", "message": "More packaging test fixes", "committedDate": "2020-12-05T01:06:58Z", "type": "commit"}, {"oid": "6c49f4864fb83b0b90dafe0b0b83a9ed9d5f86c5", "url": "https://github.com/elastic/elasticsearch/commit/6c49f4864fb83b0b90dafe0b0b83a9ed9d5f86c5", "message": "More fixes", "committedDate": "2020-12-05T01:40:57Z", "type": "commit"}, {"oid": "afe45b7e4a09d17ea5038a46b05189b58bc2ff97", "url": "https://github.com/elastic/elasticsearch/commit/afe45b7e4a09d17ea5038a46b05189b58bc2ff97", "message": "Set heap size when starting windows service in packaging tests", "committedDate": "2020-12-05T02:58:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUyMjUzOA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r536522538", "bodyText": "The intention here was to then specifically add a docker packaging test which leverages this to set the container memory limit and assert that the auto configured heap is as we'd expect.", "author": "mark-vieira", "createdAt": "2020-12-05T05:58:42Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/DockerRun.java", "diffHunk": "@@ -75,6 +76,13 @@ public DockerRun uid(Integer uid, Integer gid) {\n         return this;\n     }\n \n+    public DockerRun memory(String memoryLimit) {", "originalCommit": "afe45b7e4a09d17ea5038a46b05189b58bc2ff97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NDA2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r537464065", "bodyText": "Are we going to add such a test?", "author": "pugnascotia", "createdAt": "2020-12-07T12:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUyMjUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExNTUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r540115528", "bodyText": "To close the loop here - @rjernst wrote a basic, and I've fleshed it out and debugged it locally. All good now, I think.", "author": "pugnascotia", "createdAt": "2020-12-10T12:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUyMjUzOA=="}], "type": "inlineReview"}, {"oid": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "url": "https://github.com/elastic/elasticsearch/commit/bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "message": "Add some better exception handling for poorly formatted config files", "committedDate": "2020-12-05T06:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MDQ1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r537450453", "bodyText": "Javadoc comments on the test cases help to ensure that the implementation of test matches its intent.", "author": "pugnascotia", "createdAt": "2020-12-07T11:58:06Z", "path": "distribution/tools/launchers/src/test/java/org/elasticsearch/tools/launchers/MachineDependentHeapTests.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.hamcrest.Matchers.empty;\n+import static org.junit.Assert.assertThat;\n+\n+public class MachineDependentHeapTests extends LaunchersTestCase {\n+\n+    public void testDetermineHeapSize() throws IOException {", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1NzcyNA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539957724", "bodyText": "While I agree this can be helpful on complex tests, I think it is overkill on simple tests, such as these, that the name of the class and method generally make obvious what is being tested. In this particular case, I've renamed the method to testDefaultHeapSize() since it is testing the default when no configuration exists.", "author": "rjernst", "createdAt": "2020-12-10T08:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MDQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1Mzg5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r537453895", "bodyText": "My preference is to use assertThat pretty much everywhere these days. Not saying you should change it, but I find the messages it generates to be more readable.", "author": "pugnascotia", "createdAt": "2020-12-07T12:03:39Z", "path": "distribution/tools/launchers/src/test/java/org/elasticsearch/tools/launchers/NodeRoleParserTests.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.function.Consumer;\n+\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.DATA;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.MASTER_ONLY;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.ML_ONLY;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.UNKNOWN;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.fail;\n+\n+public class NodeRoleParserTests extends LaunchersTestCase {\n+\n+    public void testMasterOnlyNode() {\n+        MachineDependentHeap.MachineNodeRole nodeRole = parseConfig(sb -> sb.append(\"node.roles: [master]\"));\n+        assertEquals(nodeRole, MASTER_ONLY);", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1NDUwNw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539954507", "bodyText": "Changed to assertThat.", "author": "rjernst", "createdAt": "2020-12-10T08:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1Mzg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NDkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r537454917", "bodyText": "Can we have tests for garbage input and invalid YAML too? I was going to suggest a JSON config, but the parser ought to parse that quite happily \ud83d\ude04", "author": "pugnascotia", "createdAt": "2020-12-07T12:05:18Z", "path": "distribution/tools/launchers/src/test/java/org/elasticsearch/tools/launchers/NodeRoleParserTests.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.function.Consumer;\n+\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.DATA;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.MASTER_ONLY;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.ML_ONLY;\n+import static org.elasticsearch.tools.launchers.MachineDependentHeap.MachineNodeRole.UNKNOWN;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.fail;\n+\n+public class NodeRoleParserTests extends LaunchersTestCase {", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MTc5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539951793", "bodyText": "Added a test for invalid yaml (which is the same as garbage)", "author": "rjernst", "createdAt": "2020-12-10T07:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NjU1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r537456553", "bodyText": "This changes makes me uncomfortable. Is it not possible that we might happen to calculate the heap to be this size, causing the test to fail?", "author": "pugnascotia", "createdAt": "2020-12-07T12:08:02Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/ArchiveTests.java", "diffHunk": "@@ -311,7 +311,7 @@ public void test73CustomJvmOptionsDirectoryFilesWithoutOptionsExtensionIgnored()\n             startElasticsearch();\n \n             final String nodesResponse = makeRequest(Request.Get(\"http://localhost:9200/_nodes\"));\n-            assertThat(nodesResponse, containsString(\"\\\"heap_init_in_bytes\\\":1073741824\"));\n+            assertThat(nodesResponse, not(containsString(\"\\\"heap_init_in_bytes\\\":536870912\")));", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0NTgwMg==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539945802", "bodyText": "I've rewritten the test to pass a bogus option, so that java should fail to start if the option is used.", "author": "rjernst", "createdAt": "2020-12-10T07:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NjU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMjQxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r538012419", "bodyText": "I don't think check is sufficient. A user can also set -XX:MaxHeapSize and -XX:MinHeapSize for which -Xmx and -Xms are synonyms.\nNote that in JvmErgonomics#choose we start up a second JVM and extract whether or not a setting was passed in on the command line. We might want to reuse that here and then check if MinHeapSize or MaxHeapSize are passed on the command line. This might be more reliable?", "author": "jasontedor", "createdAt": "2020-12-08T03:47:21Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/MachineDependentHeap.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.error.YAMLException;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n+\n+/**\n+ * Determines optimal default heap settings based on available system memory and assigned node roles.\n+ */\n+public final class MachineDependentHeap {\n+    private static final long GB = 1024L * 1024L * 1024L; // 1GB\n+    private static final long MAX_HEAP_SIZE = GB * 31; // 31GB\n+    private static final long MAX_ML_HEAP_SIZE = GB * 2; // 2GB\n+    private static final long MIN_HEAP_SIZE = 1024 * 1024 * 128; // 128MB\n+    private static final int DEFAULT_HEAP_SIZE_MB = 1024;\n+    private static final String ELASTICSEARCH_YML = \"elasticsearch.yml\";\n+\n+    private final SystemMemoryInfo systemMemoryInfo;\n+\n+    public MachineDependentHeap(SystemMemoryInfo systemMemoryInfo) {\n+        this.systemMemoryInfo = systemMemoryInfo;\n+    }\n+\n+    /**\n+     * Calculate heap options.\n+     *\n+     * @param configDir path to config directory\n+     * @param userDefinedJvmOptions JVM arguments provided by the user\n+     * @return final heap options, or an empty collection if user provided heap options are to be used\n+     * @throws IOException if unable to load elasticsearch.yml\n+     */\n+    public List<String> determineHeapSettings(Path configDir, List<String> userDefinedJvmOptions) throws IOException {\n+        if (userDefinedJvmOptions.stream().anyMatch(s -> s.startsWith(\"-Xms\") || s.startsWith(\"-Xmx\"))) {", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzNzY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539937662", "bodyText": "I've moved the method to find the final options so it is reused here.", "author": "rjernst", "createdAt": "2020-12-10T07:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMjQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMjg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r538012884", "bodyText": "I wonder if this should contain the full path? Or if we should return UNKNOWN and let startup fail us here too?", "author": "jasontedor", "createdAt": "2020-12-08T03:48:52Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/MachineDependentHeap.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.error.YAMLException;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n+\n+/**\n+ * Determines optimal default heap settings based on available system memory and assigned node roles.\n+ */\n+public final class MachineDependentHeap {\n+    private static final long GB = 1024L * 1024L * 1024L; // 1GB\n+    private static final long MAX_HEAP_SIZE = GB * 31; // 31GB\n+    private static final long MAX_ML_HEAP_SIZE = GB * 2; // 2GB\n+    private static final long MIN_HEAP_SIZE = 1024 * 1024 * 128; // 128MB\n+    private static final int DEFAULT_HEAP_SIZE_MB = 1024;\n+    private static final String ELASTICSEARCH_YML = \"elasticsearch.yml\";\n+\n+    private final SystemMemoryInfo systemMemoryInfo;\n+\n+    public MachineDependentHeap(SystemMemoryInfo systemMemoryInfo) {\n+        this.systemMemoryInfo = systemMemoryInfo;\n+    }\n+\n+    /**\n+     * Calculate heap options.\n+     *\n+     * @param configDir path to config directory\n+     * @param userDefinedJvmOptions JVM arguments provided by the user\n+     * @return final heap options, or an empty collection if user provided heap options are to be used\n+     * @throws IOException if unable to load elasticsearch.yml\n+     */\n+    public List<String> determineHeapSettings(Path configDir, List<String> userDefinedJvmOptions) throws IOException {\n+        if (userDefinedJvmOptions.stream().anyMatch(s -> s.startsWith(\"-Xms\") || s.startsWith(\"-Xmx\"))) {\n+            // User has explicitly set memory settings so we use those\n+            return Collections.emptyList();\n+        }\n+\n+        Path config = configDir.resolve(ELASTICSEARCH_YML);\n+        try (InputStream in = Files.newInputStream(config)) {\n+            return determineHeapSettings(in);\n+        }\n+    }\n+\n+    List<String> determineHeapSettings(InputStream config) {\n+        MachineNodeRole nodeRole = NodeRoleParser.parse(config);\n+\n+        try {\n+            long availableSystemMemory = systemMemoryInfo.availableSystemMemory();\n+            return options(nodeRole.heap(availableSystemMemory));\n+        } catch (SystemMemoryInfo.SystemMemoryInfoException e) {\n+            // If unable to determine system memory (ex: incompatible jdk version) fallback to defaults\n+            return options(DEFAULT_HEAP_SIZE_MB);\n+        }\n+    }\n+\n+    private static List<String> options(int heapSize) {\n+        return List.of(\"-Xms\" + heapSize + \"m\", \"-Xmx\" + heapSize + \"m\");\n+    }\n+\n+    /**\n+     * Parses role information from elasticsearch.yml and determines machine node role.\n+     */\n+    static class NodeRoleParser {\n+        private static final Set<String> LEGACY_ROLE_SETTINGS = Set.of(\n+            \"node.master\",\n+            \"node.ingest\",\n+            \"node.data\",\n+            \"node.voting_only\",\n+            \"node.ml\",\n+            \"node.transform\",\n+            \"node.remote_cluster_client\"\n+        );\n+\n+        @SuppressWarnings(\"unchecked\")\n+        public static MachineNodeRole parse(InputStream config) {\n+            Yaml yaml = new Yaml();\n+            Map<String, Object> root;\n+            try {\n+                root = yaml.load(config);\n+            } catch (ClassCastException ex) {\n+                // Strangely formatted config, so just return defaults and let startup settings validation catch the problem\n+                return MachineNodeRole.UNKNOWN;\n+            } catch (YAMLException ex) {\n+                throw new IllegalStateException(\"Unable to parse elasticsearch.yml:\", ex);", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkzODQwNA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539938404", "bodyText": "I like returning UNKOWN and letting Elasticsearch handle the misconfiguration.", "author": "rjernst", "createdAt": "2020-12-10T07:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMjg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzE2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r538013163", "bodyText": "Return UNKNOWN and let Elasticsearch handle it?", "author": "jasontedor", "createdAt": "2020-12-08T03:49:45Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/MachineDependentHeap.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.error.YAMLException;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n+\n+/**\n+ * Determines optimal default heap settings based on available system memory and assigned node roles.\n+ */\n+public final class MachineDependentHeap {\n+    private static final long GB = 1024L * 1024L * 1024L; // 1GB\n+    private static final long MAX_HEAP_SIZE = GB * 31; // 31GB\n+    private static final long MAX_ML_HEAP_SIZE = GB * 2; // 2GB\n+    private static final long MIN_HEAP_SIZE = 1024 * 1024 * 128; // 128MB\n+    private static final int DEFAULT_HEAP_SIZE_MB = 1024;\n+    private static final String ELASTICSEARCH_YML = \"elasticsearch.yml\";\n+\n+    private final SystemMemoryInfo systemMemoryInfo;\n+\n+    public MachineDependentHeap(SystemMemoryInfo systemMemoryInfo) {\n+        this.systemMemoryInfo = systemMemoryInfo;\n+    }\n+\n+    /**\n+     * Calculate heap options.\n+     *\n+     * @param configDir path to config directory\n+     * @param userDefinedJvmOptions JVM arguments provided by the user\n+     * @return final heap options, or an empty collection if user provided heap options are to be used\n+     * @throws IOException if unable to load elasticsearch.yml\n+     */\n+    public List<String> determineHeapSettings(Path configDir, List<String> userDefinedJvmOptions) throws IOException {\n+        if (userDefinedJvmOptions.stream().anyMatch(s -> s.startsWith(\"-Xms\") || s.startsWith(\"-Xmx\"))) {\n+            // User has explicitly set memory settings so we use those\n+            return Collections.emptyList();\n+        }\n+\n+        Path config = configDir.resolve(ELASTICSEARCH_YML);\n+        try (InputStream in = Files.newInputStream(config)) {\n+            return determineHeapSettings(in);\n+        }\n+    }\n+\n+    List<String> determineHeapSettings(InputStream config) {\n+        MachineNodeRole nodeRole = NodeRoleParser.parse(config);\n+\n+        try {\n+            long availableSystemMemory = systemMemoryInfo.availableSystemMemory();\n+            return options(nodeRole.heap(availableSystemMemory));\n+        } catch (SystemMemoryInfo.SystemMemoryInfoException e) {\n+            // If unable to determine system memory (ex: incompatible jdk version) fallback to defaults\n+            return options(DEFAULT_HEAP_SIZE_MB);\n+        }\n+    }\n+\n+    private static List<String> options(int heapSize) {\n+        return List.of(\"-Xms\" + heapSize + \"m\", \"-Xmx\" + heapSize + \"m\");\n+    }\n+\n+    /**\n+     * Parses role information from elasticsearch.yml and determines machine node role.\n+     */\n+    static class NodeRoleParser {\n+        private static final Set<String> LEGACY_ROLE_SETTINGS = Set.of(\n+            \"node.master\",\n+            \"node.ingest\",\n+            \"node.data\",\n+            \"node.voting_only\",\n+            \"node.ml\",\n+            \"node.transform\",\n+            \"node.remote_cluster_client\"\n+        );\n+\n+        @SuppressWarnings(\"unchecked\")\n+        public static MachineNodeRole parse(InputStream config) {\n+            Yaml yaml = new Yaml();\n+            Map<String, Object> root;\n+            try {\n+                root = yaml.load(config);\n+            } catch (ClassCastException ex) {\n+                // Strangely formatted config, so just return defaults and let startup settings validation catch the problem\n+                return MachineNodeRole.UNKNOWN;\n+            } catch (YAMLException ex) {\n+                throw new IllegalStateException(\"Unable to parse elasticsearch.yml:\", ex);\n+            }\n+\n+            if (root != null) {\n+                Map<String, Object> map = flatten(root, null);\n+\n+                if (hasLegacySettings(map.keySet())) {\n+                    // We don't attempt to auto-determine heap if legacy role settings are used\n+                    return MachineNodeRole.UNKNOWN;\n+                } else {\n+                    List<String> roles = null;\n+                    try {\n+                        if (map.containsKey(\"node.roles\")) {\n+                            roles = (List<String>) map.get(\"node.roles\");\n+                        }\n+                    } catch (ClassCastException ex) {\n+                        throw new IllegalStateException(\"Unable to parse elasticsearch.yml. Expected 'node.roles' to be a list.\");", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r538013422", "bodyText": "Why is voting only included here? And what about transform nodes? Can we check with the ML team how those should be handled?", "author": "jasontedor", "createdAt": "2020-12-08T03:50:40Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/MachineDependentHeap.java", "diffHunk": "@@ -0,0 +1,247 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.tools.launchers;\n+\n+import org.yaml.snakeyaml.Yaml;\n+import org.yaml.snakeyaml.error.YAMLException;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n+\n+/**\n+ * Determines optimal default heap settings based on available system memory and assigned node roles.\n+ */\n+public final class MachineDependentHeap {\n+    private static final long GB = 1024L * 1024L * 1024L; // 1GB\n+    private static final long MAX_HEAP_SIZE = GB * 31; // 31GB\n+    private static final long MAX_ML_HEAP_SIZE = GB * 2; // 2GB\n+    private static final long MIN_HEAP_SIZE = 1024 * 1024 * 128; // 128MB\n+    private static final int DEFAULT_HEAP_SIZE_MB = 1024;\n+    private static final String ELASTICSEARCH_YML = \"elasticsearch.yml\";\n+\n+    private final SystemMemoryInfo systemMemoryInfo;\n+\n+    public MachineDependentHeap(SystemMemoryInfo systemMemoryInfo) {\n+        this.systemMemoryInfo = systemMemoryInfo;\n+    }\n+\n+    /**\n+     * Calculate heap options.\n+     *\n+     * @param configDir path to config directory\n+     * @param userDefinedJvmOptions JVM arguments provided by the user\n+     * @return final heap options, or an empty collection if user provided heap options are to be used\n+     * @throws IOException if unable to load elasticsearch.yml\n+     */\n+    public List<String> determineHeapSettings(Path configDir, List<String> userDefinedJvmOptions) throws IOException {\n+        if (userDefinedJvmOptions.stream().anyMatch(s -> s.startsWith(\"-Xms\") || s.startsWith(\"-Xmx\"))) {\n+            // User has explicitly set memory settings so we use those\n+            return Collections.emptyList();\n+        }\n+\n+        Path config = configDir.resolve(ELASTICSEARCH_YML);\n+        try (InputStream in = Files.newInputStream(config)) {\n+            return determineHeapSettings(in);\n+        }\n+    }\n+\n+    List<String> determineHeapSettings(InputStream config) {\n+        MachineNodeRole nodeRole = NodeRoleParser.parse(config);\n+\n+        try {\n+            long availableSystemMemory = systemMemoryInfo.availableSystemMemory();\n+            return options(nodeRole.heap(availableSystemMemory));\n+        } catch (SystemMemoryInfo.SystemMemoryInfoException e) {\n+            // If unable to determine system memory (ex: incompatible jdk version) fallback to defaults\n+            return options(DEFAULT_HEAP_SIZE_MB);\n+        }\n+    }\n+\n+    private static List<String> options(int heapSize) {\n+        return List.of(\"-Xms\" + heapSize + \"m\", \"-Xmx\" + heapSize + \"m\");\n+    }\n+\n+    /**\n+     * Parses role information from elasticsearch.yml and determines machine node role.\n+     */\n+    static class NodeRoleParser {\n+        private static final Set<String> LEGACY_ROLE_SETTINGS = Set.of(\n+            \"node.master\",\n+            \"node.ingest\",\n+            \"node.data\",\n+            \"node.voting_only\",\n+            \"node.ml\",\n+            \"node.transform\",\n+            \"node.remote_cluster_client\"\n+        );\n+\n+        @SuppressWarnings(\"unchecked\")\n+        public static MachineNodeRole parse(InputStream config) {\n+            Yaml yaml = new Yaml();\n+            Map<String, Object> root;\n+            try {\n+                root = yaml.load(config);\n+            } catch (ClassCastException ex) {\n+                // Strangely formatted config, so just return defaults and let startup settings validation catch the problem\n+                return MachineNodeRole.UNKNOWN;\n+            } catch (YAMLException ex) {\n+                throw new IllegalStateException(\"Unable to parse elasticsearch.yml:\", ex);\n+            }\n+\n+            if (root != null) {\n+                Map<String, Object> map = flatten(root, null);\n+\n+                if (hasLegacySettings(map.keySet())) {\n+                    // We don't attempt to auto-determine heap if legacy role settings are used\n+                    return MachineNodeRole.UNKNOWN;\n+                } else {\n+                    List<String> roles = null;\n+                    try {\n+                        if (map.containsKey(\"node.roles\")) {\n+                            roles = (List<String>) map.get(\"node.roles\");\n+                        }\n+                    } catch (ClassCastException ex) {\n+                        throw new IllegalStateException(\"Unable to parse elasticsearch.yml. Expected 'node.roles' to be a list.\");\n+                    }\n+\n+                    if (roles == null || roles.isEmpty()) {\n+                        // If roles are missing or empty (coordinating node) assume defaults and consider this a data node\n+                        return MachineNodeRole.DATA;\n+                    } else if (containsOnly(roles, \"master\", \"voting_only\")) {\n+                        return MachineNodeRole.MASTER_ONLY;\n+                    } else if (containsOnly(roles, \"ml\", \"voting_only\")) {\n+                        return MachineNodeRole.ML_ONLY;", "originalCommit": "bf25202cf78c5b360fc7e2d1cff286a62b44b56f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0MTg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539941848", "bodyText": "Not sure what was intended here, but I've removed the voting_only from both master and ML cases.", "author": "rjernst", "createdAt": "2020-12-10T07:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0NzM3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r539947379", "bodyText": "After looking through the unit tests, it appears this was intended to support an ML node being a voting only node. However, I think there was confusion in what voting_only does, since it actually requires the master role as well. So I think removing them was correct.", "author": "rjernst", "createdAt": "2020-12-10T07:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUyODkyNg==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r542528926", "bodyText": "The intention here is that any node can have the voting_only role as well, and I believe cloud will do this to ensure there is an available tiebreaker node. Essentially, for the purposes of assigning memory based on the amount of work the node will do, the voting_only role is irrelevant, and if an ML node has the role, it should still be considered ML_ONLY. The scenario with master is much less likely however so we can probably remove it.", "author": "mark-vieira", "createdAt": "2020-12-14T16:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkyOTg2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r542929861", "bodyText": "voting_only must be used in combination with master. So it's not possible to have ml+voting_only and nothing else, it would be ml+master+voting_only. For a master+voting_only, you would never have this, since there would be no point to not make the node a normal master eligible node. The point of voting only is to make the node a master voter in combination with other node roles yet do a little extra work to tiebreak, but as far as configuration, the voting_only has to always be specified with master. (at least this is my understanding)", "author": "rjernst", "createdAt": "2020-12-14T23:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMDQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/65905#discussion_r542930427", "bodyText": "Ah, understood.", "author": "mark-vieira", "createdAt": "2020-12-14T23:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMzQyMg=="}], "type": "inlineReview"}, {"oid": "6ba5c66318d81adc42aca83a54e82ecb066391cb", "url": "https://github.com/elastic/elasticsearch/commit/6ba5c66318d81adc42aca83a54e82ecb066391cb", "message": "restore heap defaults in jvm.options", "committedDate": "2020-12-09T00:13:49Z", "type": "commit"}, {"oid": "8e6966c9ebf7afe7fd6fc1bfe8bc18f73fa9427a", "url": "https://github.com/elastic/elasticsearch/commit/8e6966c9ebf7afe7fd6fc1bfe8bc18f73fa9427a", "message": "Reuse findFinalOptions from ergonomics", "committedDate": "2020-12-10T07:30:30Z", "type": "commit"}, {"oid": "e3726e7afb59403f23130dd7ec1cee4735f592d5", "url": "https://github.com/elastic/elasticsearch/commit/e3726e7afb59403f23130dd7ec1cee4735f592d5", "message": "cleanup role responses", "committedDate": "2020-12-10T07:41:03Z", "type": "commit"}, {"oid": "2efc239694714b29e57022f371723c0eff288e4c", "url": "https://github.com/elastic/elasticsearch/commit/2efc239694714b29e57022f371723c0eff288e4c", "message": "address tests", "committedDate": "2020-12-10T08:10:36Z", "type": "commit"}, {"oid": "5daf41c8567939999e9dc0b0ce8facb06ca36ac0", "url": "https://github.com/elastic/elasticsearch/commit/5daf41c8567939999e9dc0b0ce8facb06ca36ac0", "message": "docker test", "committedDate": "2020-12-10T08:30:14Z", "type": "commit"}, {"oid": "c6f432a559c40f5b99831b380fcf4a1bcd1026fe", "url": "https://github.com/elastic/elasticsearch/commit/c6f432a559c40f5b99831b380fcf4a1bcd1026fe", "message": "Fix up Docker test", "committedDate": "2020-12-10T12:04:21Z", "type": "commit"}, {"oid": "d44c784910cd45cecf7d54ca5800b707db84636d", "url": "https://github.com/elastic/elasticsearch/commit/d44c784910cd45cecf7d54ca5800b707db84636d", "message": "More fixes", "committedDate": "2020-12-10T12:26:04Z", "type": "commit"}, {"oid": "1c7565c7b0d2a6324bd9bcd3d35e5ff77bf84a7d", "url": "https://github.com/elastic/elasticsearch/commit/1c7565c7b0d2a6324bd9bcd3d35e5ff77bf84a7d", "message": "Merge branch 'master' into HEAD", "committedDate": "2020-12-11T00:11:51Z", "type": "commit"}, {"oid": "8ca205399baef8e825a0cc8d16a0b0f43952da6e", "url": "https://github.com/elastic/elasticsearch/commit/8ca205399baef8e825a0cc8d16a0b0f43952da6e", "message": "checkstyle", "committedDate": "2020-12-11T00:12:13Z", "type": "commit"}, {"oid": "8ca205399baef8e825a0cc8d16a0b0f43952da6e", "url": "https://github.com/elastic/elasticsearch/commit/8ca205399baef8e825a0cc8d16a0b0f43952da6e", "message": "checkstyle", "committedDate": "2020-12-11T00:12:13Z", "type": "forcePushed"}, {"oid": "f3d025bb2a336efbef9d12921761acb165c91368", "url": "https://github.com/elastic/elasticsearch/commit/f3d025bb2a336efbef9d12921761acb165c91368", "message": "spotless", "committedDate": "2020-12-11T18:47:11Z", "type": "commit"}, {"oid": "ec827f0d03766376f1d394f001b300ad6b9f5919", "url": "https://github.com/elastic/elasticsearch/commit/ec827f0d03766376f1d394f001b300ad6b9f5919", "message": "null guard", "committedDate": "2020-12-12T19:52:18Z", "type": "commit"}, {"oid": "75cb18b89e105b375dffd6e972fc31a4b76f5c34", "url": "https://github.com/elastic/elasticsearch/commit/75cb18b89e105b375dffd6e972fc31a4b76f5c34", "message": "Add fix for earlier jdks which used InitialHeap instead of MinHeap", "committedDate": "2020-12-14T19:04:57Z", "type": "commit"}, {"oid": "c36892b9bcef9baf189e1af4a4fcf0cc7c418eb0", "url": "https://github.com/elastic/elasticsearch/commit/c36892b9bcef9baf189e1af4a4fcf0cc7c418eb0", "message": "Merge branch 'master' into machine-dependent-heap", "committedDate": "2020-12-14T22:55:16Z", "type": "commit"}, {"oid": "88a81a11a80cc2805b74913c0f337bc28c4c4474", "url": "https://github.com/elastic/elasticsearch/commit/88a81a11a80cc2805b74913c0f337bc28c4c4474", "message": "Remove Xmx/Xms from jvm.options", "committedDate": "2020-12-14T23:27:40Z", "type": "commit"}, {"oid": "ca7e564d081a87aaef734ee1557d6a9d49c5f810", "url": "https://github.com/elastic/elasticsearch/commit/ca7e564d081a87aaef734ee1557d6a9d49c5f810", "message": "Set 1g heap for packaging tests by default", "committedDate": "2020-12-15T20:34:27Z", "type": "commit"}, {"oid": "755cfac1b1a6264fc5f5670f6ff865b765fe5f99", "url": "https://github.com/elastic/elasticsearch/commit/755cfac1b1a6264fc5f5670f6ff865b765fe5f99", "message": "guard for no installation yet when setting heap to 1g", "committedDate": "2020-12-15T20:43:49Z", "type": "commit"}, {"oid": "1c3552e932da0d30917c079f3895af56677619ad", "url": "https://github.com/elastic/elasticsearch/commit/1c3552e932da0d30917c079f3895af56677619ad", "message": "fix format oops", "committedDate": "2020-12-15T20:54:19Z", "type": "commit"}, {"oid": "472df8f75c1727dde1e609070b7f43200312e985", "url": "https://github.com/elastic/elasticsearch/commit/472df8f75c1727dde1e609070b7f43200312e985", "message": "tweak tests overriding heap", "committedDate": "2020-12-15T21:32:21Z", "type": "commit"}, {"oid": "759e76f28f8a9bb9a2b16f6d92b2b20b8f26e483", "url": "https://github.com/elastic/elasticsearch/commit/759e76f28f8a9bb9a2b16f6d92b2b20b8f26e483", "message": "Use temp config directory when appropriate", "committedDate": "2020-12-15T22:05:32Z", "type": "commit"}, {"oid": "7c7e71eb160cb291c9161cd7d321138420bba1a0", "url": "https://github.com/elastic/elasticsearch/commit/7c7e71eb160cb291c9161cd7d321138420bba1a0", "message": "Merge branch 'master' into machine-dependent-heap", "committedDate": "2020-12-15T22:24:32Z", "type": "commit"}, {"oid": "f407562d4b85716e165e9ec03ef9dd5582017f7e", "url": "https://github.com/elastic/elasticsearch/commit/f407562d4b85716e165e9ec03ef9dd5582017f7e", "message": "More packaging test fixes", "committedDate": "2020-12-15T23:10:29Z", "type": "commit"}, {"oid": "8c45424c412778c490c2003b557515835a1eabcb", "url": "https://github.com/elastic/elasticsearch/commit/8c45424c412778c490c2003b557515835a1eabcb", "message": "Even more packaging test fixes for platform-specific line separators", "committedDate": "2020-12-15T23:53:04Z", "type": "commit"}, {"oid": "557af6ac10194906115e51d7c367a136dfd2a1f1", "url": "https://github.com/elastic/elasticsearch/commit/557af6ac10194906115e51d7c367a136dfd2a1f1", "message": "Fix forbidden apis", "committedDate": "2020-12-16T00:06:09Z", "type": "commit"}, {"oid": "47baa29d5749677223abf936b1343c2f4babae8b", "url": "https://github.com/elastic/elasticsearch/commit/47baa29d5749677223abf936b1343c2f4babae8b", "message": "Only create parent when required", "committedDate": "2020-12-16T00:08:28Z", "type": "commit"}, {"oid": "b6032e8b286b56b31a2221dc59ecf053dd60782a", "url": "https://github.com/elastic/elasticsearch/commit/b6032e8b286b56b31a2221dc59ecf053dd60782a", "message": "No need to set default args since we do it in PackagingTestCase setup", "committedDate": "2020-12-16T00:32:49Z", "type": "commit"}, {"oid": "bce1e4f665fdb76a09542eeed842ec1aeafb9012", "url": "https://github.com/elastic/elasticsearch/commit/bce1e4f665fdb76a09542eeed842ec1aeafb9012", "message": "Fix docker packaging tests", "committedDate": "2020-12-16T01:13:24Z", "type": "commit"}, {"oid": "f6fed4b0c9b8654deec58e3fef1419f45cd63946", "url": "https://github.com/elastic/elasticsearch/commit/f6fed4b0c9b8654deec58e3fef1419f45cd63946", "message": "Ensure we add a newline so we can safely append to this file", "committedDate": "2020-12-16T01:24:37Z", "type": "commit"}, {"oid": "41f7d4dbe54f488ad3d48c5d6827fe4227f86feb", "url": "https://github.com/elastic/elasticsearch/commit/41f7d4dbe54f488ad3d48c5d6827fe4227f86feb", "message": "Merge branch 'master' into machine-dependent-heap", "committedDate": "2020-12-16T03:44:13Z", "type": "commit"}, {"oid": "7068cd02844673e2ab8b7ce790ee3cd029c9a103", "url": "https://github.com/elastic/elasticsearch/commit/7068cd02844673e2ab8b7ce790ee3cd029c9a103", "message": "Fix packaging test when heap is overriden", "committedDate": "2020-12-16T04:17:00Z", "type": "commit"}, {"oid": "df4ba2e47887567ee1b4d6995b906cc5190cfab7", "url": "https://github.com/elastic/elasticsearch/commit/df4ba2e47887567ee1b4d6995b906cc5190cfab7", "message": "Fix checkstyle", "committedDate": "2020-12-16T04:24:38Z", "type": "commit"}, {"oid": "2a53668d694b0846ee888b694d529e6fd1a057d4", "url": "https://github.com/elastic/elasticsearch/commit/2a53668d694b0846ee888b694d529e6fd1a057d4", "message": "remove heap options before removing rpm", "committedDate": "2020-12-16T05:30:16Z", "type": "commit"}, {"oid": "9b1cf77d6d76c307d4f95cf4cad6996f9634204b", "url": "https://github.com/elastic/elasticsearch/commit/9b1cf77d6d76c307d4f95cf4cad6996f9634204b", "message": "Fix rpm tests", "committedDate": "2020-12-16T06:22:22Z", "type": "commit"}]}