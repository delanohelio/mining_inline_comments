{"pr_number": 52218, "pr_title": "[ML] Adds feature importance option to inference processor", "pr_createdAt": "2020-02-11T15:48:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52218", "timeline": [{"oid": "cd41c83b7fc8fd7602fe30ab2233c771508ad2b9", "url": "https://github.com/elastic/elasticsearch/commit/cd41c83b7fc8fd7602fe30ab2233c771508ad2b9", "message": "[ML] Adds feature importance to models via SHAP value calculations", "committedDate": "2020-02-11T15:42:16Z", "type": "commit"}, {"oid": "83ec74ddafa12d3547f33b4143f5f5c991673cdb", "url": "https://github.com/elastic/elasticsearch/commit/83ec74ddafa12d3547f33b4143f5f5c991673cdb", "message": "updating inference processor doc", "committedDate": "2020-02-11T15:59:10Z", "type": "commit"}, {"oid": "6162b49543578710c96e44ee3e095b8772d10dbf", "url": "https://github.com/elastic/elasticsearch/commit/6162b49543578710c96e44ee3e095b8772d10dbf", "message": "Merge branch 'master' into feature/ml-inference-feature-importance", "committedDate": "2020-02-11T19:08:01Z", "type": "commit"}, {"oid": "3761a6fe18ec0edb9af48b5a33d06483900d8c06", "url": "https://github.com/elastic/elasticsearch/commit/3761a6fe18ec0edb9af48b5a33d06483900d8c06", "message": "minor fix ups", "committedDate": "2020-02-12T19:03:53Z", "type": "commit"}, {"oid": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b", "url": "https://github.com/elastic/elasticsearch/commit/7ca4875d52c5c4f8f196907dbf8fde8af289a81b", "message": "Merge branch 'feature/ml-inference-feature-importance' of github.com:benwtrent/elasticsearch into feature/ml-inference-feature-importance", "committedDate": "2020-02-12T19:04:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkxMTMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/52218#discussion_r378911314", "bodyText": "If it is possible that this can be called from two different threads around the same time then there is a bigger problem that making this synchronized will not solve.  In the private featureImportance(List<Double>, Map<String, String> featureDecoder) method above it would be possible for a simultaneous call to calculateNodeEstimatesIfNeeded() has changed maxDepth but not nodeEstimates at the time when these members are being read in featureImportance().\nIf multithreaded access to Tree objects is possible then the featureImportance(List<Double>, Map<String, String> featureDecoder) method needs to be synchronized and this method needs a comment saying it must only be called from featureImportance(List<Double>, Map<String, String> featureDecoder).  Then nodeEstimates and maxDepth wouldn't need to be volatile.", "author": "droberts195", "createdAt": "2020-02-13T14:55:53Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/tree/Tree.java", "diffHunk": "@@ -261,12 +267,146 @@ public void validate() {\n         detectCycle();\n     }\n \n+    @Override\n+    public Map<String, Double> featureImportance(Map<String, Object> fields, Map<String, String> featureDecoder) {\n+        if (nodes.stream().allMatch(n -> n.getNumberSamples() == 0)) {\n+            throw ExceptionsHelper.badRequestException(\"[tree_structure.number_samples] must be greater than zero for feature importance\");\n+        }\n+        List<Double> features = featureNames.stream()\n+            .map(f -> InferenceHelpers.toDouble(MapHelper.dig(f, fields)))\n+            .collect(Collectors.toList());\n+        return featureImportance(features, featureDecoder);\n+    }\n+\n+    private Map<String, Double> featureImportance(List<Double> fieldValues, Map<String, String> featureDecoder) {\n+        calculateNodeEstimatesIfNeeded();\n+        double[] featureImportance = new double[fieldValues.size()];\n+        ShapPath initialPath = new ShapPath(this.maxDepth + 1);\n+        shapRecursive(fieldValues, this.nodeEstimates, initialPath, 0, 1.0, 1.0, -1, featureImportance);\n+        return InferenceHelpers.decodeFeatureImportances(featureDecoder,\n+            IntStream.range(0, featureImportance.length)\n+                .boxed()\n+                .collect(Collectors.toMap(featureNames::get, i -> featureImportance[i])));\n+    }\n+\n+    //TODO synchronized?", "originalCommit": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxOTMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/52218#discussion_r379019306", "bodyText": "@droberts195 I do think this will be accessible via multiple threads. Multiple docs can come into different pipelines on the same node referencing the same model. So, they would all hit the same instance in cache.\nI am going to get this synchronized, and also add a node to the classes saying that they must be MT safe.", "author": "benwtrent", "createdAt": "2020-02-13T17:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkxMTMxNA=="}], "type": "inlineReview"}, {"oid": "2d14185f8c5e6ec5a033903055edfeecdc4054ac", "url": "https://github.com/elastic/elasticsearch/commit/2d14185f8c5e6ec5a033903055edfeecdc4054ac", "message": "synchronizing depth and estimation calculation", "committedDate": "2020-02-13T19:47:05Z", "type": "commit"}, {"oid": "9ae4e03462ca4c580b19958327c113586be99079", "url": "https://github.com/elastic/elasticsearch/commit/9ae4e03462ca4c580b19958327c113586be99079", "message": "adjusting algorithm for faster performance", "committedDate": "2020-02-20T21:11:53Z", "type": "commit"}, {"oid": "9cec51f2266f8609205dfb441baefe869825c7fa", "url": "https://github.com/elastic/elasticsearch/commit/9cec51f2266f8609205dfb441baefe869825c7fa", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-inference-feature-importance", "committedDate": "2020-02-20T21:14:57Z", "type": "commit"}, {"oid": "8a672238e28f8d188cd29c6c454f0686f557b0cd", "url": "https://github.com/elastic/elasticsearch/commit/8a672238e28f8d188cd29c6c454f0686f557b0cd", "message": "fixing initialization and copy forward", "committedDate": "2020-02-21T15:06:25Z", "type": "commit"}, {"oid": "65c798a297d48935e0e80ffef7642aaf5916c498", "url": "https://github.com/elastic/elasticsearch/commit/65c798a297d48935e0e80ffef7642aaf5916c498", "message": "Merge branch 'master' into feature/ml-inference-feature-importance", "committedDate": "2020-02-21T15:12:04Z", "type": "commit"}, {"oid": "cc761612fb517de8654b42866b04c1270520f0ca", "url": "https://github.com/elastic/elasticsearch/commit/cc761612fb517de8654b42866b04c1270520f0ca", "message": "fixing docs", "committedDate": "2020-02-21T19:15:48Z", "type": "commit"}, {"oid": "c8b7fd0c735060da37a7b170836e7f4fce62e89a", "url": "https://github.com/elastic/elasticsearch/commit/c8b7fd0c735060da37a7b170836e7f4fce62e89a", "message": "erge branch 'feature/ml-inference-feature-importance' of github.com:benwtrent/elasticsearch into feature/ml-inference-feature-importance", "committedDate": "2020-02-21T19:15:59Z", "type": "commit"}, {"oid": "01638f80566ca1371103d96c0a6e4164977e48fc", "url": "https://github.com/elastic/elasticsearch/commit/01638f80566ca1371103d96c0a6e4164977e48fc", "message": "making infer MT safe", "committedDate": "2020-02-21T20:34:11Z", "type": "commit"}]}