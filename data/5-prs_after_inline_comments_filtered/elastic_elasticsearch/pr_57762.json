{"pr_number": 57762, "pr_title": "Make ValuesSourceConfig behave like a config object", "pr_createdAt": "2020-06-05T19:09:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57762", "timeline": [{"oid": "5eea513a5773854825a43686db453bbe42c90637", "url": "https://github.com/elastic/elasticsearch/commit/5eea513a5773854825a43686db453bbe42c90637", "message": "Make VSConfig immutable", "committedDate": "2020-06-02T19:56:49Z", "type": "commit"}, {"oid": "f607a15eb574b624a2bdcc5b39655a5ddbf00466", "url": "https://github.com/elastic/elasticsearch/commit/f607a15eb574b624a2bdcc5b39655a5ddbf00466", "message": "stop passing values sources to things that already have VSConfigs", "committedDate": "2020-06-03T18:56:06Z", "type": "commit"}, {"oid": "18f09e36600416b1a7e71ba242f140149c380f57", "url": "https://github.com/elastic/elasticsearch/commit/18f09e36600416b1a7e71ba242f140149c380f57", "message": "rename for clarity", "committedDate": "2020-06-03T20:22:53Z", "type": "commit"}, {"oid": "b5298aa5ea3a12edb4d6bd667424d04cb91b077c", "url": "https://github.com/elastic/elasticsearch/commit/b5298aa5ea3a12edb4d6bd667424d04cb91b077c", "message": "checkpoint", "committedDate": "2020-06-04T15:53:23Z", "type": "commit"}, {"oid": "fed635e36114ac82051f8d7d4f05f3303c673e5c", "url": "https://github.com/elastic/elasticsearch/commit/fed635e36114ac82051f8d7d4f05f3303c673e5c", "message": "checkpoint", "committedDate": "2020-06-04T16:06:13Z", "type": "commit"}, {"oid": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "url": "https://github.com/elastic/elasticsearch/commit/93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "message": "Simplify a bunch of metric constructors", "committedDate": "2020-06-05T18:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyMzMyMg==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436123322", "bodyText": "This'd probably be a little cleaner as a private final method with early returns.", "author": "nik9000", "createdAt": "2020-06-05T19:32:48Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -269,8 +275,36 @@ public ValuesSourceConfig(\n         this.unmapped = unmapped;\n         this.script = script;\n         this.scriptValueType = scriptValueType;\n+        this.missing = missing;\n+        this.timeZone = timeZone;\n+        this.format = format == null ? DocValueFormat.RAW : format;\n         this.nowSupplier = nowSupplier;\n \n+        if (!valid()) {\n+            // TODO: resolve no longer generates invalid configs.  Once VSConfig is immutable, we can drop this check\n+            throw new IllegalStateException(\n+                \"value source config is invalid; must have either a field context or a script or marked as unwrapped\");\n+        }\n+\n+        final ValuesSource vs;", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyMzg3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436123872", "bodyText": "Isn't |= the compound bitwise-or-then-assign operator?", "author": "nik9000", "createdAt": "2020-06-05T19:34:20Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -285,8 +319,12 @@ public FieldContext fieldContext() {\n         return script;\n     }\n \n-    public boolean unmapped() {\n-        return unmapped;\n+    /**\n+     * Returns true if the values source configured by this object can yield values.  We might not be able to yield values if, for example,\n+     * the specified field does not exist on this index.\n+     */\n+    public boolean hasValues() {\n+        return fieldContext != null || script != null || missing != null;", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzMzUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436133524", "bodyText": "Ignore this. On my browser |= and != look very similar.", "author": "nik9000", "createdAt": "2020-06-05T19:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyMzg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyNDUyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436124529", "bodyText": "Run it through the code-formatter?", "author": "nik9000", "createdAt": "2020-06-05T19:35:52Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -154,10 +154,9 @@ private static ValuesSourceConfig internalResolve(QueryShardContext context,\n         if (valuesSourceType == null) {\n             valuesSourceType = defaultValueSourceType;\n         }\n-        config = new ValuesSourceConfig(valuesSourceType, fieldContext, unmapped, aggregationScript, scriptValueType, context::nowInMillis);\n-        config.format(resolveFormat(format, valuesSourceType, timeZone, fieldType));\n-        config.missing(missing);\n-        config.timezone(timeZone);\n+        DocValueFormat docValueFormat = resolveFormat(format, valuesSourceType, timeZone, fieldType);\n+        config = new ValuesSourceConfig(valuesSourceType, fieldContext, unmapped, aggregationScript, scriptValueType, missing,", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyNDYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436124611", "bodyText": "Can this be final too?", "author": "nik9000", "createdAt": "2020-06-05T19:36:02Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -239,18 +241,19 @@ public static ValuesSourceConfig resolveFieldOnly(MappedFieldType fieldType,\n      * Convenience method for creating unmapped configs\n      */\n     public static ValuesSourceConfig resolveUnmapped(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {\n-        return new ValuesSourceConfig(valuesSourceType, null, true, null, null, queryShardContext::nowInMillis);\n+        return new ValuesSourceConfig(valuesSourceType, null, true, null, null, null, null, null, queryShardContext::nowInMillis);\n     }\n \n     private final ValuesSourceType valuesSourceType;\n-    private FieldContext fieldContext;\n-    private AggregationScript.LeafFactory script;\n-    private ValueType scriptValueType;\n-    private boolean unmapped;\n-    private DocValueFormat format = DocValueFormat.RAW;\n-    private Object missing;\n-    private ZoneId timeZone;\n-    private LongSupplier nowSupplier;\n+    private final FieldContext fieldContext;\n+    private final AggregationScript.LeafFactory script;\n+    private final ValueType scriptValueType;\n+    private final boolean unmapped;\n+    private final DocValueFormat format;\n+    private final Object missing;\n+    private final ZoneId timeZone;\n+    private final LongSupplier nowSupplier;\n+    private ValuesSource valuesSource;", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY2NzczNA==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436667734", "bodyText": "\ud83d\udc4d to getting the prepared rounding in the ctor.", "author": "nik9000", "createdAt": "2020-06-08T12:50:31Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java", "diffHunk": "@@ -76,18 +75,21 @@ public long minDocCount() {\n     }\n \n     @Override\n-    protected Aggregator doCreateInternal(ValuesSource valuesSource,\n-                                            SearchContext searchContext,\n-                                            Aggregator parent,\n-                                            boolean collectsFromSingleBucket,\n-                                            Map<String, Object> metadata) throws IOException {\n+    protected Aggregator doCreateInternal(\n+        SearchContext searchContext,\n+        Aggregator parent,\n+        boolean collectsFromSingleBucket,\n+        Map<String, Object> metadata) throws IOException {\n         AggregatorSupplier aggregatorSupplier = queryShardContext.getValuesSourceRegistry().getAggregator(config,\n             DateHistogramAggregationBuilder.NAME);\n         if (aggregatorSupplier instanceof DateHistogramAggregationSupplier == false) {\n             throw new AggregationExecutionException(\"Registry miss-match - expected DateHistogramAggregationSupplier, found [\" +\n                 aggregatorSupplier.getClass().toString() + \"]\");\n         }\n-        Rounding.Prepared preparedRounding = valuesSource.roundingPreparer(queryShardContext.getIndexReader()).apply(shardRounding);\n+        // TODO: Is there a reason not to get the prepared rounding in the supplier itself?", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3MjY5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436672699", "bodyText": "Can this be a ctor reference like the others? It looks like it from here.", "author": "nik9000", "createdAt": "2020-06-08T12:58:00Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java", "diffHunk": "@@ -106,17 +105,16 @@ protected XPackLicenseState getLicenseState() {\n \n     private static void registerGeoShapeBoundsAggregator(ValuesSourceRegistry.Builder builder) {\n         builder.register(GeoBoundsAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),\n-            (GeoBoundsAggregatorSupplier) (name, aggregationContext, parent, valuesSource, wrapLongitude, metadata)\n-                -> new GeoShapeBoundsAggregator(name, aggregationContext, parent, (GeoShapeValuesSource) valuesSource,\n-                wrapLongitude, metadata));\n+            (GeoBoundsAggregatorSupplier) (name, aggregationContext, parent, valuesSourceConfig, wrapLongitude, metadata)\n+                -> new GeoShapeBoundsAggregator(name, aggregationContext, parent, valuesSourceConfig, wrapLongitude, metadata));", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NDQwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436674401", "bodyText": "I think it'd be a little cleaner to make a \"wrapper\" MetricAggregatorSupplier that checks the license state and calls a ctor reference if it is allowed.", "author": "nik9000", "createdAt": "2020-06-08T12:59:46Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java", "diffHunk": "@@ -106,17 +105,16 @@ protected XPackLicenseState getLicenseState() {\n \n     private static void registerGeoShapeBoundsAggregator(ValuesSourceRegistry.Builder builder) {\n         builder.register(GeoBoundsAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),\n-            (GeoBoundsAggregatorSupplier) (name, aggregationContext, parent, valuesSource, wrapLongitude, metadata)\n-                -> new GeoShapeBoundsAggregator(name, aggregationContext, parent, (GeoShapeValuesSource) valuesSource,\n-                wrapLongitude, metadata));\n+            (GeoBoundsAggregatorSupplier) (name, aggregationContext, parent, valuesSourceConfig, wrapLongitude, metadata)\n+                -> new GeoShapeBoundsAggregator(name, aggregationContext, parent, valuesSourceConfig, wrapLongitude, metadata));\n     }\n \n     private void registerGeoShapeCentroidAggregator(ValuesSourceRegistry.Builder builder) {\n         builder.register(GeoCentroidAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),\n-            (GeoCentroidAggregatorSupplier) (name, aggregationContext, parent, valuesSource, metadata)\n+            (MetricAggregatorSupplier) (name, valuesSourceConfig, aggregationContext, parent, metadata)", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4NzI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r438387299", "bodyText": "I'm +0 on this right now.  It doesn't come up that often, and I'm not sure the wrapper actually makes it any clearer.  If you feel strongly, I can do it (or would be happy to review your version if you like), but I don't think it's a big gain over what we have now personally.", "author": "not-napoleon", "createdAt": "2020-06-10T20:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3MTgxOA==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r438471818", "bodyText": "If we only do it once I guess it doesn't buy much. I think it'd be a little clearer that we're just checking the license and then doing the ctor reference thing, but its no big deal.", "author": "nik9000", "createdAt": "2020-06-11T00:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NDQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NTUwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436675501", "bodyText": "This is a super long number of arguments! I'm glad we don't call the ctor very much though.", "author": "nik9000", "createdAt": "2020-06-08T13:00:52Z", "path": "x-pack/plugin/spatial/src/test/java/org/elasticsearch/xpack/spatial/SpatialPluginTests.java", "diffHunk": "@@ -35,8 +35,8 @@ public void testGeoCentroidLicenseCheck() {\n             List<Consumer<ValuesSourceRegistry.Builder>> registrar = plugin.getAggregationExtentions();\n             registrar.forEach(c -> c.accept(registryBuilder));\n             ValuesSourceRegistry registry = registryBuilder.build();\n-            GeoCentroidAggregatorSupplier centroidSupplier = (GeoCentroidAggregatorSupplier) registry.getAggregator(\n-                new ValuesSourceConfig(GeoShapeValuesSourceType.instance(), null, false, null, null, null),\n+            MetricAggregatorSupplier centroidSupplier = (MetricAggregatorSupplier) registry.getAggregator(\n+                new ValuesSourceConfig(GeoShapeValuesSourceType.instance(), null, true, null, null, null, null, null, null),", "originalCommit": "93cf920dbc2510f3fc54236dc7613c2ad57c3ee4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NDAxMg==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436694012", "bodyText": "Yeah, outside of testing, the only thing that should be calling that constructor is the various resolve factory methods, which are what the rest of the framework should call.  Not that they don't have a lot of arguments too.  I suppose we could have a default constructor for tests, but I don't like adding production code that's only supposed to be called from tests.", "author": "not-napoleon", "createdAt": "2020-06-08T13:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NTUwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5OTc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436699799", "bodyText": "How often do we call it in tests? It doesn't look like we call it directly very often. I think mostly we use the production resolution framework.", "author": "nik9000", "createdAt": "2020-06-08T13:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NTUwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NzQ3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436867473", "bodyText": "Correct, there's only a handful of cases we call the constructor from tests.  I meant I didn't want to add a new test-only constructor just to clean up this case.", "author": "not-napoleon", "createdAt": "2020-06-08T17:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NTUwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3MTI3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57762#discussion_r436871276", "bodyText": "I'm happy with that, yeah.", "author": "nik9000", "createdAt": "2020-06-08T17:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY3NTUwMQ=="}], "type": "inlineReview"}, {"oid": "657458dc8bae079e8d3f34ee6a3c6e4043fcf198", "url": "https://github.com/elastic/elasticsearch/commit/657458dc8bae079e8d3f34ee6a3c6e4043fcf198", "message": "Fix unmapped for ArrayVS", "committedDate": "2020-06-09T18:24:50Z", "type": "commit"}, {"oid": "a539a4bc9f9553678832134b6c9a6d193f2ad17a", "url": "https://github.com/elastic/elasticsearch/commit/a539a4bc9f9553678832134b6c9a6d193f2ad17a", "message": "Response to PR feedback", "committedDate": "2020-06-10T20:54:34Z", "type": "commit"}, {"oid": "01b072af501cf0a2803823f9935e7ff663f6f794", "url": "https://github.com/elastic/elasticsearch/commit/01b072af501cf0a2803823f9935e7ff663f6f794", "message": "checkstyle", "committedDate": "2020-06-10T21:24:52Z", "type": "commit"}, {"oid": "4893dd3298f07d90ed4e2c31e0735e051ad60aa2", "url": "https://github.com/elastic/elasticsearch/commit/4893dd3298f07d90ed4e2c31e0735e051ad60aa2", "message": "put nulls back in composite", "committedDate": "2020-06-11T14:29:48Z", "type": "commit"}, {"oid": "8d8f7e6396589e54dc204be00f2fbf501452751e", "url": "https://github.com/elastic/elasticsearch/commit/8d8f7e6396589e54dc204be00f2fbf501452751e", "message": "Make VSConfig immutable", "committedDate": "2020-06-11T14:54:49Z", "type": "commit"}, {"oid": "8bdb55f506d9a61492e9688d5e17a6c740cc8bd0", "url": "https://github.com/elastic/elasticsearch/commit/8bdb55f506d9a61492e9688d5e17a6c740cc8bd0", "message": "stop passing values sources to things that already have VSConfigs", "committedDate": "2020-06-11T15:13:53Z", "type": "commit"}, {"oid": "b415fea5706c60f10ad8caf44855c312e2e102e0", "url": "https://github.com/elastic/elasticsearch/commit/b415fea5706c60f10ad8caf44855c312e2e102e0", "message": "rename for clarity", "committedDate": "2020-06-11T15:13:54Z", "type": "commit"}, {"oid": "b0507df5510ad4c49d7b233af6ae25250a65308e", "url": "https://github.com/elastic/elasticsearch/commit/b0507df5510ad4c49d7b233af6ae25250a65308e", "message": "checkpoint", "committedDate": "2020-06-11T15:13:54Z", "type": "commit"}, {"oid": "e72f9200f87d899e622d8e99910f78133cc90ae8", "url": "https://github.com/elastic/elasticsearch/commit/e72f9200f87d899e622d8e99910f78133cc90ae8", "message": "checkpoint", "committedDate": "2020-06-11T15:13:54Z", "type": "commit"}, {"oid": "502d9668d64f9e1decfe265e47a42ca78d478b73", "url": "https://github.com/elastic/elasticsearch/commit/502d9668d64f9e1decfe265e47a42ca78d478b73", "message": "Simplify a bunch of metric constructors", "committedDate": "2020-06-11T15:31:17Z", "type": "commit"}, {"oid": "4356558d6e9121c5aaa95230dcf7427f5ce2fe7a", "url": "https://github.com/elastic/elasticsearch/commit/4356558d6e9121c5aaa95230dcf7427f5ce2fe7a", "message": "Fix unmapped for ArrayVS", "committedDate": "2020-06-11T15:31:18Z", "type": "commit"}, {"oid": "c884369785fc3715ffe0b6603cdc1b70b089c5bf", "url": "https://github.com/elastic/elasticsearch/commit/c884369785fc3715ffe0b6603cdc1b70b089c5bf", "message": "Response to PR feedback", "committedDate": "2020-06-11T15:31:18Z", "type": "commit"}, {"oid": "92c796d9db9206eef0ce0ff0d1532c48c874860d", "url": "https://github.com/elastic/elasticsearch/commit/92c796d9db9206eef0ce0ff0d1532c48c874860d", "message": "checkstyle", "committedDate": "2020-06-11T15:31:18Z", "type": "commit"}, {"oid": "60c3d0aab543c0a1e80ac328d0d3845f9ed063be", "url": "https://github.com/elastic/elasticsearch/commit/60c3d0aab543c0a1e80ac328d0d3845f9ed063be", "message": "put nulls back in composite", "committedDate": "2020-06-11T15:31:18Z", "type": "commit"}, {"oid": "d67236aa4a9fa43ffcbc820f4dc9afbd8f0696eb", "url": "https://github.com/elastic/elasticsearch/commit/d67236aa4a9fa43ffcbc820f4dc9afbd8f0696eb", "message": "Merge branch 'vs-refactor-vs-config-cleanup' of github.com:not-napoleon/elasticsearch into vs-refactor-vs-config-cleanup\n\n Conflicts:\n\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTermsAggregatorFactory.java", "committedDate": "2020-06-11T15:32:34Z", "type": "commit"}, {"oid": "08bdfd4970bb2a0afa372551e0ae9965914306ad", "url": "https://github.com/elastic/elasticsearch/commit/08bdfd4970bb2a0afa372551e0ae9965914306ad", "message": "Merge branch 'master' into vs-refactor-vs-config-cleanup", "committedDate": "2020-06-11T17:34:22Z", "type": "commit"}]}