{"pr_number": 52298, "pr_title": "Continue realizing sorting by aggregations", "pr_createdAt": "2020-02-13T00:21:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52298", "timeline": [{"oid": "f82a6a526bee6469c849e4a417b8d37e6d75dc7a", "url": "https://github.com/elastic/elasticsearch/commit/f82a6a526bee6469c849e4a417b8d37e6d75dc7a", "message": "Continue realizing sorting by aggregations\n\nThis drops more of the `instanceof`s from `AggregationPath`. There are\nstill a couple in `AggregationPath`. And I ended up moving two into\n`BucketsAggregator`, but I think this is still an improvement!", "committedDate": "2020-02-12T22:49:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4Nzc4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52298#discussion_r378587782", "bodyText": "I'm not super thrilled about this, but it is how it used to work and I wanted to keep this change fairly contained.", "author": "nik9000", "createdAt": "2020-02-13T00:21:47Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -163,4 +165,24 @@ public final void close() {\n         }\n     }\n \n+    @Override\n+    public Aggregator resolveSortPath(AggregationPath.PathElement next, Iterator<AggregationPath.PathElement> path) {\n+        if (this instanceof SingleBucketAggregator) {", "originalCommit": "f82a6a526bee6469c849e4a417b8d37e6d75dc7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgwNDk0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52298#discussion_r382804945", "bodyText": "\ud83d\udc4d", "author": "polyfractal", "createdAt": "2020-02-21T21:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4Nzc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4ODQxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52298#discussion_r378588419", "bodyText": "I'm not super comfortable with this name, but I think it'll fall away in a followup change. When I dig into that last instanceof in resolveTopmostAggregator.", "author": "nik9000", "createdAt": "2020-02-13T00:24:06Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -91,6 +93,53 @@ public static boolean descendsFromBucketAggregator(Aggregator parent) {\n      */\n     public abstract Aggregator subAggregator(String name);\n \n+    /**\n+     * Resolve the next step of the sort path as though this aggregation\n+     * supported sorting. This is usually the \"first step\" when resolving\n+     * a sort path because most aggs that support sorting their buckets\n+     * aren't valid in the middle of a sort path.\n+     * <p>\n+     * For example, the {@code terms} aggs supports sorting its buckets, but\n+     * that sort path itself can't contain a different {@code terms}\n+     * aggregation.\n+     */\n+    public final Aggregator resolveSortPathOnValidAgg(AggregationPath.PathElement next, Iterator<AggregationPath.PathElement> path) {", "originalCommit": "f82a6a526bee6469c849e4a417b8d37e6d75dc7a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}