{"pr_number": 53029, "pr_title": "[ML] Fix minor race condition in dataframe analytics _stop", "pr_createdAt": "2020-03-02T19:34:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53029", "timeline": [{"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "url": "https://github.com/elastic/elasticsearch/commit/ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "message": "[ML] Fix minor race condition in dataframe analytics _start", "committedDate": "2020-03-02T19:25:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0Mjg4MA==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386842880", "bodyText": "Should we wait the same way for .ml-state*?", "author": "przemekwitek", "createdAt": "2020-03-03T07:41:02Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -572,7 +582,10 @@ protected AllocatedPersistentTask createTask(\n             String id = params.getId();\n \n             List<String> unavailableIndices =\n-                verifyIndicesPrimaryShardsAreActive(clusterState, resolver, AnomalyDetectorsIndex.configIndexName());\n+                verifyIndicesPrimaryShardsAreActive(clusterState,", "originalCommit": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386900855", "bodyText": "I feel like I'm missing something obvious here. The .ml-stats index is created by  DataFrameAnalyticsManager.execute called from TaskExecutor.nodeOperation.   But TaskExecutor.getAssignment which runs first is expecting the index to exist and as far as I can tell it hasn't been created yet. Could that be because of the leniency in verifyIndicesPrimaryShardsAreActive\nresolver.concreteIndexNames(clusterState, IndicesOptions.lenientExpandOpen(), indexNames);", "author": "davidkyle", "createdAt": "2020-03-03T09:42:06Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -572,7 +582,10 @@ protected AllocatedPersistentTask createTask(\n             String id = params.getId();\n \n             List<String> unavailableIndices =\n-                verifyIndicesPrimaryShardsAreActive(clusterState, resolver, AnomalyDetectorsIndex.configIndexName());\n+                verifyIndicesPrimaryShardsAreActive(clusterState,\n+                    resolver,\n+                    AnomalyDetectorsIndex.configIndexName(),\n+                    MlStatsIndex.indexPattern());", "originalCommit": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk0MzQxNA==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386943414", "bodyText": "Yes, arguably we could prevent assignment if the required indices exist but are not usable at the time an assignment decision is made.  But the changes currently in this PR will not fix #53007.\n\nwe could prevent assignment if the required indices exist but are not usable at the time an assignment decision is made\n\nA side effect of this would be that the start datafeed API would fail in some cases where if it had waited a fraction of a second it would have succeeded.  I am not sure that's a good idea.  It certainly deserves a discussion.", "author": "droberts195", "createdAt": "2020-03-03T10:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NzIzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386967231", "bodyText": "For Transforms we get the stats directly from the task if it is running else the index is searched. Could we not do the same here? In which case .ml-stats would not be touched until the DFA has finished.\nI think for anomaly detection we created most of the indices on node start (apart from the results index) which is one way of solving the problem but is heavy handed and still required checks that the index was active.", "author": "davidkyle", "createdAt": "2020-03-03T11:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk5NDk3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386994972", "bodyText": "There is a scenario y'all are not thinking about.\nWhat if the previously created index is just not available due to the nodes being down?\nIts fine being lenient in verifyIndicesPrimaryShardsAreActive if the index does not exist at all. This is because we will create it.\nBut, if it already exists and its primary shard is not assigned, that is a bigger issue. One warranting the task not being assigned to a node.\n\nFor Transforms we get the stats directly from the task if it is running else the index is searched. Could we not do the same here?\n\nWe could. I can look into that.\nRegardless of waiting for the indices to be created before returning from _start, I think the changes in verifyIndicesPrimaryShardsAreActive are necessary and good.", "author": "benwtrent", "createdAt": "2020-03-03T12:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwMDMyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r387000325", "bodyText": "What if the previously created index is just not available due to the nodes being down?\n\nThis is what I was referring to in #53029 (comment)\nSo it solves one problem but creates another:\n\nA side effect of this would be that the start datafeed API would fail in some cases where if it had waited a fraction of a second it would have succeeded. I am not sure that's a good idea. It certainly deserves a discussion.\n\nI think if we do this we should do it consistently for anomaly detection and data frame analytics, so that both or neither assign tasks when the necessary indices exist but are not available.\n@dimitris-athanasiou I think you originally added some of these checks.  Do you have any extra insights?", "author": "droberts195", "createdAt": "2020-03-03T12:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwMjM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r387002378", "bodyText": "A side effect of this would be that the start datafeed API would fail in some cases where if it had waited a fraction of a second it would have succeeded.\n\nIt won't fail. It just won't get assigned a node. Which means that it will attempt to get assigned again in a little bit\nThis is exactly what we do for anomaly detectors. We verify primary shards are active for the necessary indices. Even for ones created by the task. If the index does not exist, we don't bother checking for the primary shard. If the index does exist, but the shard is not allocated, then we don't assign it to a node. The task attempt to assign itself again later.", "author": "benwtrent", "createdAt": "2020-03-03T12:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA0MzA5MA==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r387043090", "bodyText": "For Transforms we get the stats directly from the task if it is running else the index is searched.\n\nWe already get the stats for running tasks from in-memory.\n\n@dimitris-athanasiou I think you originally added some of these checks. Do you have any extra insights?\n\nI think not checking whether the state and stats indices have their primaries active there is an omission. But it is not the cause of this error.\n@droberts195, @benwtrent and myself discussed this further and we decided we will need to add debugging in order to understand what exactly is going on as it is currently not perfectly clear.", "author": "dimitris-athanasiou", "createdAt": "2020-03-03T14:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA2NTU3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r387065571", "bodyText": "changes in verifyIndicesPrimaryShardsAreActive are necessary and good.\n\nYes I agree this is what we do for AD and we should check the same indices here.", "author": "davidkyle", "createdAt": "2020-03-03T14:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ=="}], "type": "inlineReview"}, {"oid": "8af55ceff2d12ba717013d378431bf4eba06306b", "url": "https://github.com/elastic/elasticsearch/commit/8af55ceff2d12ba717013d378431bf4eba06306b", "message": "fixing _stop race condition", "committedDate": "2020-03-04T13:14:16Z", "type": "commit"}, {"oid": "32706def39a245beeae9e43a353cd5b79ab764ae", "url": "https://github.com/elastic/elasticsearch/commit/32706def39a245beeae9e43a353cd5b79ab764ae", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-dataframe-fix-start-race-condition", "committedDate": "2020-03-04T13:23:19Z", "type": "commit"}, {"oid": "17d3067bd04e12e1cc2ad3e4cc6e990a95de23cf", "url": "https://github.com/elastic/elasticsearch/commit/17d3067bd04e12e1cc2ad3e4cc6e990a95de23cf", "message": "fixing test", "committedDate": "2020-03-04T16:11:59Z", "type": "commit"}, {"oid": "3544450337d1794cdf2664f2640406a95dc45a67", "url": "https://github.com/elastic/elasticsearch/commit/3544450337d1794cdf2664f2640406a95dc45a67", "message": "fixing bad handling of stop during reindex", "committedDate": "2020-03-04T19:41:16Z", "type": "commit"}, {"oid": "fa633bc73cedfcb3795f1d0fb86ab8d5206d599a", "url": "https://github.com/elastic/elasticsearch/commit/fa633bc73cedfcb3795f1d0fb86ab8d5206d599a", "message": "Merge branch 'master' into feature/ml-dataframe-fix-start-race-condition", "committedDate": "2020-03-04T19:51:08Z", "type": "commit"}]}