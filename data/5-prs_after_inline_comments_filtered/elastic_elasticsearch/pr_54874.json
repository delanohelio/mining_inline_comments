{"pr_number": 54874, "pr_title": "[ML] Cancel reindex task from correct thread context", "pr_createdAt": "2020-04-07T11:31:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54874", "timeline": [{"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15", "url": "https://github.com/elastic/elasticsearch/commit/94d7a75e1c0da981fe6a4d4999695339d9bebc15", "message": "[ML] Cancel reindex task from correct thread context\n\nWhen a data frame analytics job is stopped, if the reindexing\ntask was still in progress we cancel it. Cancelling it should\nbe done from the same context as when we executed the reindexing\ntask. That means from a thread context with ML origin.", "committedDate": "2020-04-07T11:27:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MzMxMA==", "url": "https://github.com/elastic/elasticsearch/pull/54874#discussion_r404763310", "bodyText": "I guess I need to learn more about context/origins etc.\nWhat are the rules one should follow when spawning requests from ML code?\nI've seen at least two ways of setting ML_ORIGIN, namely threadContext.stashWithOrigin(ML_ORIGIN) and using OriginSettingClient.\nAlso, it is possible not to set the origin (like this code before your fix). Could we make it so that all ML calls set the origin?", "author": "przemekwitek", "createdAt": "2020-04-07T12:19:13Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -161,7 +162,11 @@ private void cancelReindexingTask(String reason, TimeValue timeout) {\n         cancelReindex.setTaskId(reindexTaskId);\n         cancelReindex.setReason(reason);\n         cancelReindex.setTimeout(timeout);\n-        CancelTasksResponse cancelReindexResponse = client.admin().cluster().cancelTasks(cancelReindex).actionGet();\n+\n+        // We need to cancel the reindexing task within context with ML origin as we started the task\n+        // from the same context\n+        CancelTasksResponse cancelReindexResponse = cancelTaskWithinMlOriginContext(cancelReindex);", "originalCommit": "94d7a75e1c0da981fe6a4d4999695339d9bebc15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NDQ5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54874#discussion_r404774495", "bodyText": "stashWithOrigin and OriginSettingClient both do the same thing.\n\nCould we make it so that all ML calls set the origin?\n\nNo, some calls we make need to run with the credentials of the user who called an endpoint or the user who created or updated a job.  We need to make sure that ML isn't a means to gain access to data you shouldn't have access to.  But the internal housekeeping ML does execute with ML_ORIGIN.", "author": "droberts195", "createdAt": "2020-04-07T12:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MzMxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NTIwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54874#discussion_r404795205", "bodyText": "Ok, thanks!", "author": "przemekwitek", "createdAt": "2020-04-07T13:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MzMxMA=="}], "type": "inlineReview"}, {"oid": "8e6f4917136f8b0b85fe14d8e6e2ab308e319126", "url": "https://github.com/elastic/elasticsearch/commit/8e6f4917136f8b0b85fe14d8e6e2ab308e319126", "message": "Merge branch 'master' into cancel-reindex-task-from-correct-thread-context", "committedDate": "2020-04-07T13:39:56Z", "type": "commit"}]}