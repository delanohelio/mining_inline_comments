{"pr_number": 61408, "pr_title": "Stop opening PING conns to remote clusters", "pr_createdAt": "2020-08-21T09:57:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61408", "timeline": [{"oid": "f28468f9168c0cdb650e999188414943c1095756", "url": "https://github.com/elastic/elasticsearch/commit/f28468f9168c0cdb650e999188414943c1095756", "message": "Stop opening PING conns to remote clusters\n\nToday a remote cluster connection comprises a `PING` and a `REG`\nchannel. The `PING` channel is only used for health checks between the\nelected master and the members of its own cluster, so is unused in a\nremote cluster connection. This commit removes this unused connection.", "committedDate": "2020-08-21T09:53:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxMDUzNg==", "url": "https://github.com/elastic/elasticsearch/pull/61408#discussion_r474610536", "bodyText": "NIT: could we do a normal .get to not lose the full stack trace if this ever fails and maybe use 10s for the timeout just because we upped so many of these 5s ones to 10s+ eventually?", "author": "original-brownbear", "createdAt": "2020-08-21T10:21:27Z", "path": "server/src/test/java/org/elasticsearch/transport/RemoteClusterConnectionTests.java", "diffHunk": "@@ -462,6 +463,36 @@ public void testCollectNodes() throws Exception {\n         }\n     }\n \n+    public void testNoChannelsExceptREG() throws Exception {\n+        List<DiscoveryNode> knownNodes = new CopyOnWriteArrayList<>();\n+        try (MockTransportService seedTransport = startTransport(\"seed_node\", knownNodes, Version.CURRENT)) {\n+            DiscoveryNode seedNode = seedTransport.getLocalDiscoNode();\n+            knownNodes.add(seedTransport.getLocalDiscoNode());\n+            try (MockTransportService service = MockTransportService.createNewService(Settings.EMPTY, Version.CURRENT, threadPool, null)) {\n+                service.start();\n+                service.acceptIncomingRequests();\n+                String clusterAlias = \"test-cluster\";\n+                Settings settings = buildRandomSettings(clusterAlias, addresses(seedNode));\n+\n+                try (RemoteClusterConnection connection = new RemoteClusterConnection(settings, clusterAlias, service)) {\n+                    PlainActionFuture<Void> plainActionFuture = new PlainActionFuture<>();\n+                    connection.ensureConnected(plainActionFuture);\n+                    plainActionFuture.actionGet(5000);", "originalCommit": "f28468f9168c0cdb650e999188414943c1095756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a813b9c942ab3b17949cfbaf4640e956ed24930d", "url": "https://github.com/elastic/elasticsearch/commit/a813b9c942ab3b17949cfbaf4640e956ed24930d", "message": "CR", "committedDate": "2020-08-21T10:28:49Z", "type": "commit"}]}