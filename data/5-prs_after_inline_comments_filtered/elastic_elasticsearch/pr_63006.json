{"pr_number": 63006, "pr_title": "[Transform] fix issue in TransformIndexerStateTests.testStopAtCheckpoint", "pr_createdAt": "2020-09-29T13:15:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63006", "timeline": [{"oid": "3a980bb9107ce16ae0da12e9538c0a304a82ff35", "url": "https://github.com/elastic/elasticsearch/commit/3a980bb9107ce16ae0da12e9538c0a304a82ff35", "message": "improve counting the number of times the deferred listener is called\n\nfixes #62996", "committedDate": "2020-09-29T13:09:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MjQzNw==", "url": "https://github.com/elastic/elasticsearch/pull/63006#discussion_r496752437", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n          \n          \n            \n                            timesStopAtCheckpointChanged += (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "author": "benwtrent", "createdAt": "2020-09-29T14:14:09Z", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java", "diffHunk": "@@ -412,20 +412,29 @@ public void testStopAtCheckpoint() throws Exception {\n             CountDownLatch searchLatch = indexer.createAwaitForSearchLatch(1);\n \n             List<CountDownLatch> responseLatches = new ArrayList<>();\n+            int timesStopAtCheckpointChanged = 0;\n+            // default stopAtCheckpoint is false\n+            boolean previousStopAtCheckpoint = false;\n+\n             for (int i = 0; i < 3; ++i) {\n                 CountDownLatch latch = new CountDownLatch(1);\n                 boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "originalCommit": "3a980bb9107ce16ae0da12e9538c0a304a82ff35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MjgyMg==", "url": "https://github.com/elastic/elasticsearch/pull/63006#discussion_r496752822", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n          \n          \n            \n                            timesStopAtCheckpointChanged += (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "author": "benwtrent", "createdAt": "2020-09-29T14:14:37Z", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java", "diffHunk": "@@ -412,20 +412,29 @@ public void testStopAtCheckpoint() throws Exception {\n             CountDownLatch searchLatch = indexer.createAwaitForSearchLatch(1);\n \n             List<CountDownLatch> responseLatches = new ArrayList<>();\n+            int timesStopAtCheckpointChanged = 0;\n+            // default stopAtCheckpoint is false\n+            boolean previousStopAtCheckpoint = false;\n+\n             for (int i = 0; i < 3; ++i) {\n                 CountDownLatch latch = new CountDownLatch(1);\n                 boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n+                previousStopAtCheckpoint = stopAtCheckpoint;\n                 countResponse(listener -> setStopAtCheckpoint(indexer, stopAtCheckpoint, listener), latch);\n                 responseLatches.add(latch);\n             }\n \n             // now let the indexer run again\n             searchLatch.countDown();\n \n-            // this time call it 3 times\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n+            // call it 3 times again\n+            for (int i = 0; i < 3; ++i) {\n+                boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "originalCommit": "3a980bb9107ce16ae0da12e9538c0a304a82ff35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf166b0e894c06a62416fbf21d97acc26652030b", "url": "https://github.com/elastic/elasticsearch/commit/bf166b0e894c06a62416fbf21d97acc26652030b", "message": "Update x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>", "committedDate": "2020-09-29T15:07:22Z", "type": "commit"}, {"oid": "fd03fbf97e6b5917dac43a2d1c0f11fcddc6f11b", "url": "https://github.com/elastic/elasticsearch/commit/fd03fbf97e6b5917dac43a2d1c0f11fcddc6f11b", "message": "Update x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>", "committedDate": "2020-09-29T15:07:29Z", "type": "commit"}]}