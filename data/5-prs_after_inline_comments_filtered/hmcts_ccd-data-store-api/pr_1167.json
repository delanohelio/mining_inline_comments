{"pr_number": 1167, "pr_title": "RDM-9868 DefaultValue for Complex fields", "pr_createdAt": "2020-10-15T08:32:47Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/1167", "timeline": [{"oid": "6c9457483e689807521a34db8ecd53d3c1973aca", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6c9457483e689807521a34db8ecd53d3c1973aca", "message": "RDM-9868 Always populate defaultValue in event triggers", "committedDate": "2020-10-14T22:50:27Z", "type": "commit"}, {"oid": "ca94cc5edbd4ae960924066f735aaa59daafdf83", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ca94cc5edbd4ae960924066f735aaa59daafdf83", "message": "RDM-9868 Tests for DefaultStartEventOperation", "committedDate": "2020-10-15T13:41:32Z", "type": "commit"}, {"oid": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "url": "https://github.com/hmcts/ccd-data-store-api/commit/751e7f3eaecb19c5f6417443a9ee03483b447a67", "message": "RDM-9868 Tests for CaseEventDefinition", "committedDate": "2020-10-15T14:18:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE2NDM0OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506164349", "bodyText": "\ud83d\udc4d", "author": "mario-paniccia", "createdAt": "2020-10-16T08:24:46Z", "path": "src/main/java/uk/gov/hmcts/ccd/config/JacksonUtils.java", "diffHunk": "@@ -29,7 +36,7 @@ private JacksonUtils(){\n         .build();\n \n \n-    public static HashMap<String, JsonNode> convertValue(Object from) {\n+    public static Map<String, JsonNode> convertValue(Object from) {", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjI4OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506206288", "bodyText": "mmm not sure whether it's the best thing in terms of separation of concerns having a definition object having logic to build/manipulate case JSON data. I would have thought this is more responsibility of a CaseService class", "author": "mario-paniccia", "createdAt": "2020-10-16T09:13:42Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/CaseEventDefinition.java", "diffHunk": "@@ -205,4 +214,29 @@ public void setCanSaveDraft(Boolean canSaveDraft) {\n             .filter(f -> f.getCaseFieldId().equals(caseFieldId))\n             .findFirst();\n     }\n+\n+    public Map<String, JsonNode> buildJsonNodeFromCaseFieldsWithDefaultValue() {\n+        Map<String, JsonNode> data = new HashMap<>();\n+\n+        getCaseFields().forEach(\n+            caseField -> {\n+\n+                List<JsonNode> collect = caseField.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(e -> e.getDefaultValue() != null)\n+                    .filter(e -> !e.getReference().isBlank())\n+                    .map(caseEventFieldComplex -> JacksonUtils.buildFromDottedPath(caseEventFieldComplex.getReference(),\n+                                                                                   caseEventFieldComplex.getDefaultValue())).collect(toList());\n+\n+                ObjectNode objectNode = MAPPER.getNodeFactory().objectNode();\n+                collect.forEach(e -> {\n+                    String next = e.fieldNames().next();\n+                    objectNode.set(next, e.findValue(next));\n+                });\n+                if (!collect.isEmpty()) { // to prevent construct like \"FieldA\": {}\n+                    data.put(caseField.getCaseFieldId(), objectNode);\n+                }\n+            });\n+\n+        return data;\n+    }", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5MTY1Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506291652", "bodyText": "Not a problem. Can move it to the Service layer. Was just thinking of 'anemic domain model'", "author": "rafalkalita", "createdAt": "2020-10-16T10:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjI4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5ODE0Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506298146", "bodyText": "Yes, Good to move this logic to service class", "author": "kiran-yenigala-hmcts", "createdAt": "2020-10-16T11:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIwNjI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzNDkxMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506234910", "bodyText": "mmm isn't it a bit too late to set the default values in the operation classes? For example, when invoking a MidEvent callback CCD sends to the midevent callback the case data, here:\n\n  \n    \n      ccd-data-store-api/src/main/java/uk/gov/hmcts/ccd/domain/service/createevent/MidEventCallback.java\n    \n    \n         Line 69\n      in\n      80adc76\n    \n    \n    \n    \n\n        \n          \n           CaseDetails caseDetailsBefore = null; \n        \n    \n  \n\n\nWith this implementation the callback is not receiving the default value right?", "author": "mario-paniccia", "createdAt": "2020-10-16T09:50:44Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/startevent/DefaultStartEventOperation.java", "diffHunk": "@@ -1,10 +1,11 @@\n package uk.gov.hmcts.ccd.domain.service.startevent;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n import com.google.common.collect.Maps;", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNDgyOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506304829", "bodyText": "@mario-paniccia\nDo we need to worry about the mid event callback, as we default values will be populated in the about to start event callback already....", "author": "kiran-yenigala-hmcts", "createdAt": "2020-10-16T11:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzNDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNDk3Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506334972", "bodyText": "This thing is that the MidEven also sends the caseDetailsBefore fields, which should contain the case data before the modifications done in the event. Now, should that case data contain default values? In my opinion yes. If we say this fields is defaulted to a value, then in CCD that field has got that initial value.", "author": "mario-paniccia", "createdAt": "2020-10-16T11:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzNDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM1NzI1NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506357255", "bodyText": "@rafalkalita let's ask Nigel please. It would also be ok for now to ignore this comment.", "author": "mario-paniccia", "createdAt": "2020-10-16T12:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzNDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQzNDA4MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506434080", "bodyText": "Nigel confirmed we do not need this: \"Defaults only work for start event so not for midevent\"", "author": "rafalkalita", "createdAt": "2020-10-16T13:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzNDkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0MzkyMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506243922", "bodyText": "probably better having the CaseService create methods and get case methods setting the defaults? we could pass the whole caseTypeDefinition.\nThe idea is that all the operations use the CaseService class, and it's the service class the only one responsible for setting the defaults, rather than the various operations. This would eliminate potential bugs where we get the case from the service but forget to set the defaults. And would also reduce duplication", "author": "mario-paniccia", "createdAt": "2020-10-16T09:58:36Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/startevent/DefaultStartEventOperation.java", "diffHunk": "@@ -76,12 +80,15 @@ public StartEventResult triggerStartForCaseType(final String caseTypeId,\n \n         final CaseTypeDefinition caseTypeDefinition = getCaseType(caseTypeId);\n \n+        final Map<String, JsonNode> data = Maps.newHashMap();\n+\n+        CaseDetails newCaseDetails = caseService\n+            .createNewCaseDetails(caseTypeId, caseTypeDefinition.getJurisdictionId(), data);", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2MTU4Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506361582", "bodyText": "We can ignore this comment.\nRafal correctly pointed out that since we consider the defaulting a concept only related to events, it's ok to leave to the Operation the responsibility to do the defaulting, rather than the create methods and get case methods of the CaseService class. Because we don't want defaulting to apply every time a case is retrieved.", "author": "mario-paniccia", "createdAt": "2020-10-16T12:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0MzkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0OTc1Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506249757", "bodyText": "mmm perhaps line 99\nfinal CaseDetails caseDetails = getCaseDetails(caseReference);\nshould already return the case with the default values? We should change getCaseDetails to use the Service rather than the Repository directly, and have the CaseService dealing with defaulting", "author": "mario-paniccia", "createdAt": "2020-10-16T10:03:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/startevent/DefaultStartEventOperation.java", "diffHunk": "@@ -99,6 +106,9 @@ public StartEventResult triggerStartForCase(final String caseReference,\n ", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2MTg5OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506361898", "bodyText": "we can ignore this", "author": "mario-paniccia", "createdAt": "2020-10-16T12:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0OTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNzkzNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506307937", "bodyText": "We are just validating null value, what if user changes the OrgPolicyRole, that means if user enters any other value in this field, we need to check whether that case-role exists or not", "author": "kiran-yenigala-hmcts", "createdAt": "2020-10-16T11:16:07Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -98,12 +96,10 @@ private void validateContent(final CaseDataContent content,\n             int length = referenceArray.length;\n             String nodeReference = length > 1 ? referenceArray[length - 2] : referenceArray[length - 1];\n             List<JsonNode> parentNodes = caseFieldNode.findParents(nodeReference);\n-            parentNodes.stream().forEach(parentNode -> {\n+            parentNodes.forEach(parentNode -> {\n                 JsonNode orgPolicyNode = findOrgPolicyNode(nodeReference, parentNode, length);\n                 if (orgPolicyNode.isNull()) {\n                     errorList.add(caseFieldId + \" cannot have an empty value.\");\n-                } else if (!defaultValue.equalsIgnoreCase(orgPolicyNode.textValue())) {", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQzNDg4MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506434880", "bodyText": "Confirmed with Nigel we need it. Implementing.", "author": "rafalkalita", "createdAt": "2020-10-16T13:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNzkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1NDg5Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506554896", "bodyText": "Done", "author": "rafalkalita", "createdAt": "2020-10-16T15:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNzkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyNjc1NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506326754", "bodyText": "can we do this check before line 230", "author": "kiran-yenigala-hmcts", "createdAt": "2020-10-16T11:40:13Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/model/definition/CaseEventDefinition.java", "diffHunk": "@@ -205,4 +214,29 @@ public void setCanSaveDraft(Boolean canSaveDraft) {\n             .filter(f -> f.getCaseFieldId().equals(caseFieldId))\n             .findFirst();\n     }\n+\n+    public Map<String, JsonNode> buildJsonNodeFromCaseFieldsWithDefaultValue() {\n+        Map<String, JsonNode> data = new HashMap<>();\n+\n+        getCaseFields().forEach(\n+            caseField -> {\n+\n+                List<JsonNode> collect = caseField.getCaseEventFieldComplexDefinitions().stream()\n+                    .filter(e -> e.getDefaultValue() != null)\n+                    .filter(e -> !e.getReference().isBlank())\n+                    .map(caseEventFieldComplex -> JacksonUtils.buildFromDottedPath(caseEventFieldComplex.getReference(),\n+                                                                                   caseEventFieldComplex.getDefaultValue())).collect(toList());\n+\n+                ObjectNode objectNode = MAPPER.getNodeFactory().objectNode();\n+                collect.forEach(e -> {\n+                    String next = e.fieldNames().next();\n+                    objectNode.set(next, e.findValue(next));\n+                });\n+                if (!collect.isEmpty()) { // to prevent construct like \"FieldA\": {}", "originalCommit": "751e7f3eaecb19c5f6417443a9ee03483b447a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1NDY3OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506554678", "bodyText": "done", "author": "rafalkalita", "createdAt": "2020-10-16T15:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyNjc1NA=="}], "type": "inlineReview"}, {"oid": "1b5f2acf4b6191248bf760f1bd5b031a1dafb6cf", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1b5f2acf4b6191248bf760f1bd5b031a1dafb6cf", "message": "RDM-9868 Move CaseEventDefinition logic to the CaseService", "committedDate": "2020-10-16T13:13:29Z", "type": "commit"}, {"oid": "74a519562bf74a3a20efe4866a5b5bd4516ebd28", "url": "https://github.com/hmcts/ccd-data-store-api/commit/74a519562bf74a3a20efe4866a5b5bd4516ebd28", "message": "RDM-9868 Add a caseRole check to the orgPolicyRole field", "committedDate": "2020-10-16T14:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5NTU2MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506495561", "bodyText": "Probably nothing to do with your PR @rafalkalita, but I just noticed that we are adding custom validation rules (for the organisation) in this class. But this class is a generic one! Why is a method like:\nprivate void validateOrganisationPolicy(String caseTypeId, CaseDataContent content) {\nhere?", "author": "mario-paniccia", "createdAt": "2020-10-16T14:39:04Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -62,15 +69,15 @@ private void validateOrganisationPolicy(String caseTypeId, CaseDataContent conte\n         caseDefinitionRepository.getCaseType(caseTypeId)\n             .findCaseEvent(content.getEventId())\n             .ifPresent(caseEventDefinition -> caseEventDefinition.getCaseFields()\n-                .stream()\n                 .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n                     .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n                     .forEach(cefcDefinition -> {\n                         String reference = cefcDefinition.getReference();\n-                        validateContent(content, eventFieldDefinition.getCaseFieldId(),\n-                            reference,\n-                            cefcDefinition.getDefaultValue(),\n-                            errorList);\n+                        validateContent(content,", "originalCommit": "74a519562bf74a3a20efe4866a5b5bd4516ebd28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwNDE4Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1167#discussion_r506504187", "bodyText": "this is getting very complex....", "author": "mario-paniccia", "createdAt": "2020-10-16T14:48:34Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -62,15 +69,15 @@ private void validateOrganisationPolicy(String caseTypeId, CaseDataContent conte\n         caseDefinitionRepository.getCaseType(caseTypeId)\n             .findCaseEvent(content.getEventId())\n             .ifPresent(caseEventDefinition -> caseEventDefinition.getCaseFields()\n-                .stream()\n                 .forEach(eventFieldDefinition -> eventFieldDefinition.getCaseEventFieldComplexDefinitions().stream()\n                     .filter(cefcDefinition -> isOrgPolicyCaseAssignedRole(cefcDefinition.getReference()))\n                     .forEach(cefcDefinition -> {\n                         String reference = cefcDefinition.getReference();\n-                        validateContent(content, eventFieldDefinition.getCaseFieldId(),\n-                            reference,\n-                            cefcDefinition.getDefaultValue(),\n-                            errorList);\n+                        validateContent(content,", "originalCommit": "74a519562bf74a3a20efe4866a5b5bd4516ebd28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1658c9afec2f470a4c7b333ed1da7351f2bf7ce", "url": "https://github.com/hmcts/ccd-data-store-api/commit/c1658c9afec2f470a4c7b333ed1da7351f2bf7ce", "message": "RDM-9868 Clean up and move isEmpty check up in the code", "committedDate": "2020-10-16T15:37:38Z", "type": "commit"}, {"oid": "1041ec75e5caf17d038dad9a4d2323a581859edf", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1041ec75e5caf17d038dad9a4d2323a581859edf", "message": "Merge branch 'develop' into RDM-9868", "committedDate": "2020-10-16T15:38:17Z", "type": "commit"}, {"oid": "cccdae164b9a3638691eefd33f75ad3b23a34d13", "url": "https://github.com/hmcts/ccd-data-store-api/commit/cccdae164b9a3638691eefd33f75ad3b23a34d13", "message": "RDM-9868 Address checkstyle issues", "committedDate": "2020-10-16T15:48:20Z", "type": "commit"}, {"oid": "47a76a9a1803b5635cb9cc0de8c9196b2fe8db88", "url": "https://github.com/hmcts/ccd-data-store-api/commit/47a76a9a1803b5635cb9cc0de8c9196b2fe8db88", "message": "RDM-9868 Address checkstyle issues", "committedDate": "2020-10-16T16:10:10Z", "type": "commit"}, {"oid": "4d403d81104b84bc0ae4f068952a78e9c1d6d30b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4d403d81104b84bc0ae4f068952a78e9c1d6d30b", "message": "RDM-9868 Adjust FTs", "committedDate": "2020-10-19T07:43:10Z", "type": "commit"}]}