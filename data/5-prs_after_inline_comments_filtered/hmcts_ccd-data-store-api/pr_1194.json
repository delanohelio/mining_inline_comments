{"pr_number": 1194, "pr_title": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORG\u2026", "pr_createdAt": "2020-11-04T13:57:13Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/1194", "timeline": [{"oid": "738a5d16c91e26c41302b3fa9dcac951e799b94b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/738a5d16c91e26c41302b3fa9dcac951e799b94b", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-04T13:59:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM2MjM3Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r517362376", "bodyText": "It would be good trying to add this class for all custom validators which extends from DataFieldIdValidator or  PredefinedTypeFieldValidator .  That would lead to deleting  DataFieldIdValidator class.\nValidationContext should be available for all validators  types. regardless its data us use or not.", "author": "Thor-tech-of-metal", "createdAt": "2020-11-04T14:00:02Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/ValidationContext.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package uk.gov.hmcts.ccd.domain.types;", "originalCommit": "738a5d16c91e26c41302b3fa9dcac951e799b94b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzMTIwMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r517931201", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    caseTypeService.validateData(content.getData(), caseTypeDefinition, createValidationContext(caseTypeId, content));\n          \n          \n            \n                    caseTypeService.validateData(createValidationContext(content, caseTypeDefinition));\n          \n      \n    \n    \n  \n\nif it's not a big change, why don't you refactor the method to take only 1 parameter the ValidationContext that contains everything?", "author": "mario-paniccia", "createdAt": "2020-11-05T10:06:06Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -59,78 +54,10 @@\n                 + \" is not found in case type definition\");\n         }\n         content.setData(fieldProcessorService.processData(content.getData(), caseTypeDefinition, content.getEventId()));\n-        caseTypeService.validateData(content.getData(), caseTypeDefinition);\n-        validateOrganisationPolicy(caseTypeId, content);\n+        caseTypeService.validateData(content.getData(), caseTypeDefinition, createValidationContext(caseTypeId, content));", "originalCommit": "738a5d16c91e26c41302b3fa9dcac951e799b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk1MjQ3Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r517952477", "bodyText": "Yes , It was on the radar.  I want to do that", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T10:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzMTIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzMzU4Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522033587", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzMTIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0ODcxMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r517948712", "bodyText": "this class is a Singleton, so it's shared between many threads. It's not safe to set the validation context in an instance variable.\nYou need to pass that to the validate method:\nvalidate(data, caseFieldDefinitions, CaseDataValidator.EMPTY_STRING, validationContext);", "author": "mario-paniccia", "createdAt": "2020-11-05T10:33:59Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidator.java", "diffHunk": "@@ -26,14 +26,17 @@\n     private static final String FIELD_SEPARATOR = \".\";\n \n     private List<FieldValidator> validators;\n+    private ValidationContext validationContext;\n \n     @Inject\n     public CaseDataValidator(final List<FieldValidator> validators) {\n         this.validators = validators;\n     }\n \n     public List<ValidationResult> validate(final Map<String, JsonNode> data,\n-                                           final List<CaseFieldDefinition> caseFieldDefinitions) {\n+                                           final List<CaseFieldDefinition> caseFieldDefinitions,\n+                                           final ValidationContext validationContext) {\n+        this.validationContext = validationContext;", "originalCommit": "738a5d16c91e26c41302b3fa9dcac951e799b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyNjM1NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518026354", "bodyText": "Yes , DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0ODcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MDk3Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r517960972", "bodyText": "can we simplify by just using\n@Named", "author": "mario-paniccia", "createdAt": "2020-11-05T10:53:40Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.definition.CachedCaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.data.definition.CaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named(\"OrgPolicyCaseAssignedRole\")", "originalCommit": "738a5d16c91e26c41302b3fa9dcac951e799b94b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAwNTM2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518005360", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:13:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk2MDk3Mg=="}], "type": "inlineReview"}, {"oid": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "url": "https://github.com/hmcts/ccd-data-store-api/commit/284dafbb27c8004ee2a59016553ba528d93f0ff1", "message": "RDM-9868: renaming and small refactoring", "committedDate": "2020-11-05T11:52:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMjMxNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518012315", "bodyText": "I forgot to remove line 9 can you remove it please", "author": "mario-paniccia", "createdAt": "2020-11-05T12:25:53Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CustomTypes.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+/**\n+ * Custom types IDs\n+ */\n+public enum CustomTypes {\n+\n+    CASE_LINK_TEXT_CASE_REFERENCE(\"TextCaseReference\"),\n+    ORG_POLICY_CASE_ASSIGNED_ROLE(\"OrgPolicyCaseAssignedRole\");", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyNjkxOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518026919", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:51:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxMjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNDM2Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518014362", "bodyText": "is it possible to remove this method and pass the validationContext in the validate method as a parameter?", "author": "mario-paniccia", "createdAt": "2020-11-05T12:29:33Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/FieldIdBasedValidator.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+/**\n+ * A validator that is associated to a field id, rather than the field type. Can be used in predefined complex types\n+ * such as OrganisationPolicy as an easy way to add custom validation for its sub-fields, without having to introduce\n+ * new ad-hoc custom types.\n+ * If a custom type needs to be introduced for predefined complex type sub-field, then prefer using a CustomTypeValidator\n+ * to add additional validation logic\n+ */\n+public interface FieldIdBasedValidator extends FieldValidator {\n+\n+    void setValidationContext(ValidationContext validationContext);", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNTE0NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522035144", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNDM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNDY2NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518014664", "bodyText": "is it possible to remove this and pass the validation context around as a parameter to the validate method?", "author": "mario-paniccia", "createdAt": "2020-11-05T12:30:05Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidator.java", "diffHunk": "@@ -124,10 +129,19 @@ public CaseDataValidator(final List<FieldValidator> validators) {\n                     new RuntimeException(\"System error: No validator found for \" + fieldType.getType()));\n     }\n \n-    private boolean isPredefinedTypeFieldValidator(FieldValidator validator, String fieldID) {\n-        if (validator instanceof PredefinedTypeFieldValidator) {\n-            String predefinedId = ((PredefinedTypeFieldValidator) validator).getPredefinedFieldId();\n-            return predefinedId.equals(fieldID);\n+    private boolean isCustomTypeValidator(FieldValidator validator, String fieldTypeId) {\n+        if (validator instanceof CustomTypeValidator) {\n+            String customTypeId = ((CustomTypeValidator) validator).getCustomTypeId();\n+            return customTypeId.equals(fieldTypeId);\n+        }\n+        return false;\n+    }\n+\n+    private boolean isFieldIdBasedValidator(FieldValidator validator, String fieldId) {\n+        if (validator instanceof FieldIdBasedValidator) {\n+            ((FieldIdBasedValidator) validator).setValidationContext(validationContext);", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNTc5Mw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522035793", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNDY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNjk2OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518016968", "bodyText": "forgot to change this, this should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return CustomTypes.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n          \n          \n            \n                    return PredefinedFieldsIDs.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n          \n      \n    \n    \n  \n\nforgot to change that", "author": "mario-paniccia", "createdAt": "2020-11-05T12:34:21Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.definition.CachedCaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.data.definition.CaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named(\"OrgPolicyCaseAssignedRole\")\n+@Singleton\n+public class OrgPolicyCaseAssignedRoleValidator implements FieldIdBasedValidator {\n+\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final CaseRoleRepository caseRoleRepository;\n+    private ValidationContext validationContext;\n+\n+    @Inject\n+    public OrgPolicyCaseAssignedRoleValidator(\n+        @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) final CaseDefinitionRepository caseDefinitionRepository,\n+        @Qualifier(CachedCaseRoleRepository.QUALIFIER) final CaseRoleRepository caseRoleRepository\n+    ) {\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.caseRoleRepository = caseRoleRepository;\n+    }\n+\n+    @Override\n+    public String getFieldId() {\n+        return CustomTypes.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTUxMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518021513", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNjk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxOTQ1NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518019454", "bodyText": "if errors is empty why you need to create a new empty list?\nI think you can remove this block", "author": "mario-paniccia", "createdAt": "2020-11-05T12:38:43Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.definition.CachedCaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.data.definition.CaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named(\"OrgPolicyCaseAssignedRole\")\n+@Singleton\n+public class OrgPolicyCaseAssignedRoleValidator implements FieldIdBasedValidator {\n+\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final CaseRoleRepository caseRoleRepository;\n+    private ValidationContext validationContext;\n+\n+    @Inject\n+    public OrgPolicyCaseAssignedRoleValidator(\n+        @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) final CaseDefinitionRepository caseDefinitionRepository,\n+        @Qualifier(CachedCaseRoleRepository.QUALIFIER) final CaseRoleRepository caseRoleRepository\n+    ) {\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.caseRoleRepository = caseRoleRepository;\n+    }\n+\n+    @Override\n+    public String getFieldId() {\n+        return CustomTypes.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(String dataFieldId, JsonNode dataValue, CaseFieldDefinition caseFieldDefinition) {\n+        caseFieldDefinition.getFieldTypeDefinition();\n+        return validateOrganisationPolicy(dataValue, caseFieldDefinition);\n+    }\n+\n+    @Override\n+    public void setValidationContext(ValidationContext validationContext) {\n+        this.validationContext = validationContext;\n+    }\n+\n+    private List<ValidationResult> validateOrganisationPolicy(JsonNode dataValue, CaseFieldDefinition caseFieldDefinition) {\n+        final String caseTypeId = validationContext.getCaseTypeId();\n+        final Set<String> caseRoles = caseRoleRepository.getCaseRoles(caseTypeId);\n+        final List<ValidationResult> errors = new ArrayList<>();\n+        validateContent(caseFieldDefinition.getId(), dataValue, caseRoles, errors);\n+        if (errors.isEmpty()) {\n+            return Collections.emptyList();\n+        }", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyNzgxMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518027812", "bodyText": "All validators return  return Collections.emptyList(); , when there is no error", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxOTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3MzY0NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520573644", "bodyText": "not sure I understand this", "author": "mario-paniccia", "createdAt": "2020-11-10T13:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxOTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTcwMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518021703", "bodyText": "is this used?", "author": "mario-paniccia", "createdAt": "2020-11-05T12:42:47Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.definition.CachedCaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.data.definition.CaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named(\"OrgPolicyCaseAssignedRole\")\n+@Singleton\n+public class OrgPolicyCaseAssignedRoleValidator implements FieldIdBasedValidator {\n+\n+    private final CaseDefinitionRepository caseDefinitionRepository;\n+    private final CaseRoleRepository caseRoleRepository;\n+    private ValidationContext validationContext;\n+\n+    @Inject\n+    public OrgPolicyCaseAssignedRoleValidator(\n+        @Qualifier(CachedCaseDefinitionRepository.QUALIFIER) final CaseDefinitionRepository caseDefinitionRepository,\n+        @Qualifier(CachedCaseRoleRepository.QUALIFIER) final CaseRoleRepository caseRoleRepository\n+    ) {\n+        this.caseDefinitionRepository = caseDefinitionRepository;\n+        this.caseRoleRepository = caseRoleRepository;\n+    }\n+\n+    @Override\n+    public String getFieldId() {\n+        return CustomTypes.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(String dataFieldId, JsonNode dataValue, CaseFieldDefinition caseFieldDefinition) {\n+        caseFieldDefinition.getFieldTypeDefinition();\n+        return validateOrganisationPolicy(dataValue, caseFieldDefinition);\n+    }\n+\n+    @Override\n+    public void setValidationContext(ValidationContext validationContext) {\n+        this.validationContext = validationContext;\n+    }\n+\n+    private List<ValidationResult> validateOrganisationPolicy(JsonNode dataValue, CaseFieldDefinition caseFieldDefinition) {\n+        final String caseTypeId = validationContext.getCaseTypeId();\n+        final Set<String> caseRoles = caseRoleRepository.getCaseRoles(caseTypeId);\n+        final List<ValidationResult> errors = new ArrayList<>();\n+        validateContent(caseFieldDefinition.getId(), dataValue, caseRoles, errors);\n+        if (errors.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return errors;\n+    }\n+\n+    private void validateContent(final String caseFieldId, final JsonNode orgPolicyRoleNode, final Set<String> caseRoles, final List<ValidationResult> errors) {\n+\n+        if (orgPolicyRoleNode.isNull()) {\n+            errors.add(new ValidationResult(validationContext.getPath() + \" organisation role cannot have an empty value.\", caseFieldId));\n+        } else if (!caseRolesContainsCaseInsensitive(caseRoles, orgPolicyRoleNode)) {\n+            errors.add(new ValidationResult(validationContext.getPath() + \" The value  \" + orgPolicyRoleNode.textValue() + \" is not a valid organisation role.\", caseFieldId));\n+        }\n+    }\n+\n+    private boolean caseRolesContainsCaseInsensitive(Set<String> caseRoles, JsonNode orgPolicyRoleNode) {\n+        return caseRoles.stream().anyMatch(e -> e.equalsIgnoreCase(orgPolicyRoleNode.textValue()));\n+    }\n+\n+    private String getOrganisationFieldName(String fieldPath){\n+        return \"\";\n+    }", "originalCommit": "284dafbb27c8004ee2a59016553ba528d93f0ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyODMyMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518028320", "bodyText": "NO this dead code that I have forgotten to delete", "author": "Thor-tech-of-metal", "createdAt": "2020-11-05T12:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjUwMA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522036500", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTcwMw=="}], "type": "inlineReview"}, {"oid": "6825e66cdac0ee892db4c879965b19140728c00c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6825e66cdac0ee892db4c879965b19140728c00c", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-05T14:59:05Z", "type": "commit"}, {"oid": "4b944ed00d2b92625e312ee6af19239acc5c6307", "url": "https://github.com/hmcts/ccd-data-store-api/commit/4b944ed00d2b92625e312ee6af19239acc5c6307", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-05T16:26:52Z", "type": "commit"}, {"oid": "74a80b3008c143b166d1e3452817237d6761d9e4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/74a80b3008c143b166d1e3452817237d6761d9e4", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-06T11:58:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NzYzMQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518797631", "bodyText": "not used", "author": "mario-paniccia", "createdAt": "2020-11-06T14:47:09Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/ValidationContext.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseTypeDefinition;\n+import uk.gov.hmcts.ccd.domain.model.std.CaseDataContent;\n+\n+import java.util.Map;\n+\n+public class ValidationContext {\n+\n+    private final CaseDataContent currentCaseDataContent;\n+    private final String caseTypeId;\n+    private final CaseTypeDefinition caseTypeDefinition;\n+    private final Map<String, JsonNode> data;\n+    private String fieldId;\n+    private String path;\n+    private JsonNode dataValue;\n+    private CaseFieldDefinition caseFieldDefinition;\n+\n+    public ValidationContext() {\n+        this(null, null, null, null);\n+    }", "originalCommit": "74a80b3008c143b166d1e3452817237d6761d9e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NTA4OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r519875088", "bodyText": "It is used by  Test for  previous Validators which does not use  ValidationContext", "author": "Thor-tech-of-metal", "createdAt": "2020-11-09T14:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NzYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNjg1OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522036858", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5NzYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMTY4NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518821684", "bodyText": "Looking at how this is invoked from CreateCaseEventService.createCaseEvent()\nI think this could have been a little bug here. We were passing to validateOrganisationPolicy content, but that might not contain the most up to date case data. We should be using data instead", "author": "mario-paniccia", "createdAt": "2020-11-06T15:22:42Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -139,7 +66,10 @@ private boolean hasEventId(CaseTypeDefinition caseTypeDefinition, String eventId\n     public void validateData(Map<String, JsonNode> data,\n                              CaseTypeDefinition caseTypeDefinition,\n                              final CaseDataContent content) {\n-        caseTypeService.validateData(data, caseTypeDefinition);\n-        validateOrganisationPolicy(caseTypeDefinition.getId(), content);", "originalCommit": "74a80b3008c143b166d1e3452817237d6761d9e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0MDI1NA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518840254", "bodyText": "Given the above, if we pass the whole CaseDataContent to the ValidationContext, we risk devs using caseDataContent.getData() rather than the more up to date data.\nTherefore I think it would be better to do this:\ncreateValidationContext(Map<String, JsonNode> data, CaseTypeDefinition caseTypeDefinition, String eventId)\n\nwhere data will contain\nMap<String, JsonNode> data\nlet's have a chat about this", "author": "mario-paniccia", "createdAt": "2020-11-06T15:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMTY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzODY2OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522038668", "bodyText": "DONE/ Discussed", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMTY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMjg0MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r518822841", "bodyText": "String caseTypeId is not needed, you are already passing CaseTypeDefinition caseTypeDefinition you can get it from there", "author": "mario-paniccia", "createdAt": "2020-11-06T15:24:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -139,7 +66,10 @@ private boolean hasEventId(CaseTypeDefinition caseTypeDefinition, String eventId\n     public void validateData(Map<String, JsonNode> data,\n                              CaseTypeDefinition caseTypeDefinition,\n                              final CaseDataContent content) {\n-        caseTypeService.validateData(data, caseTypeDefinition);\n-        validateOrganisationPolicy(caseTypeDefinition.getId(), content);\n+        caseTypeService.validateData(createValidationContext(caseTypeDefinition.getId(), content, data, caseTypeDefinition));\n+    }\n+\n+    public ValidationContext createValidationContext(String caseTypeId, CaseDataContent content, Map<String, JsonNode> data, CaseTypeDefinition caseTypeDefinition) {", "originalCommit": "74a80b3008c143b166d1e3452817237d6761d9e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzOTQ1Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r522039457", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T11:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMjg0MQ=="}], "type": "inlineReview"}, {"oid": "0fe6f11983639584a10b7735f4b9bf37daaba171", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0fe6f11983639584a10b7735f4b9bf37daaba171", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-09T11:45:55Z", "type": "commit"}, {"oid": "3684e4f82ea0630236856c073e415f537898f37e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3684e4f82ea0630236856c073e415f537898f37e", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-09T14:49:50Z", "type": "commit"}, {"oid": "59e5d34ee02fff3980d1c6adc18fbe5b1bd61ee8", "url": "https://github.com/hmcts/ccd-data-store-api/commit/59e5d34ee02fff3980d1c6adc18fbe5b1bd61ee8", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-09T16:50:45Z", "type": "commit"}, {"oid": "fdb4fb06e67a32193f38a7bd647d745b2bf51b0b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/fdb4fb06e67a32193f38a7bd647d745b2bf51b0b", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T09:42:43Z", "type": "commit"}, {"oid": "21aeaf31e1e54ee4af7129cfb2fad1ae262f7b94", "url": "https://github.com/hmcts/ccd-data-store-api/commit/21aeaf31e1e54ee4af7129cfb2fad1ae262f7b94", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T09:46:02Z", "type": "commit"}, {"oid": "2c7c8a3a018ed7dd6e467e814477d6ef23b79202", "url": "https://github.com/hmcts/ccd-data-store-api/commit/2c7c8a3a018ed7dd6e467e814477d6ef23b79202", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T10:00:31Z", "type": "commit"}, {"oid": "e3c5628d6207ddfa5d650f82f3fb90255d01c420", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e3c5628d6207ddfa5d650f82f3fb90255d01c420", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T10:16:19Z", "type": "commit"}, {"oid": "12aec069b940704e878a6c16448f9c0e9c91d62c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/12aec069b940704e878a6c16448f9c0e9c91d62c", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T11:39:40Z", "type": "commit"}, {"oid": "bed41790e7d9f76c5f8ce529b0838525f24eda61", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bed41790e7d9f76c5f8ce529b0838525f24eda61", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T12:04:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MDAwMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520540003", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    validateData(new ValidationContext(caseTypeDefinition,data));\n          \n          \n            \n                    validateData(new ValidationContext(caseTypeDefinition, data));", "author": "mario-paniccia", "createdAt": "2020-11-10T12:55:12Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/common/CaseTypeService.java", "diffHunk": "@@ -69,6 +68,10 @@ public void validateData(final Map<String, JsonNode> data,\n         }\n     }\n \n+    public void validateData(final Map<String, JsonNode> data, final CaseTypeDefinition caseTypeDefinition) {\n+        validateData(new ValidationContext(caseTypeDefinition,data));", "originalCommit": "bed41790e7d9f76c5f8ce529b0838525f24eda61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3MDcwMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521970703", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MDAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MTM5MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520541391", "bodyText": "we could just use the Validation constructor here maybe", "author": "mario-paniccia", "createdAt": "2020-11-10T12:57:29Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -59,78 +48,12 @@\n                 + \" is not found in case type definition\");\n         }\n         content.setData(fieldProcessorService.processData(content.getData(), caseTypeDefinition, content.getEventId()));\n-        caseTypeService.validateData(content.getData(), caseTypeDefinition);\n-        validateOrganisationPolicy(caseTypeId, content);\n+        caseTypeService.validateData(\n+            createValidationContext(content.getData(), caseTypeDefinition)", "originalCommit": "bed41790e7d9f76c5f8ce529b0838525f24eda61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3Mjg3Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521972872", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MjA2OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520542069", "bodyText": "we could just use the Validation constructor here maybe", "author": "mario-paniccia", "createdAt": "2020-11-10T12:58:35Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperation.java", "diffHunk": "@@ -139,7 +62,13 @@ private boolean hasEventId(CaseTypeDefinition caseTypeDefinition, String eventId\n     public void validateData(Map<String, JsonNode> data,\n                              CaseTypeDefinition caseTypeDefinition,\n                              final CaseDataContent content) {\n-        caseTypeService.validateData(data, caseTypeDefinition);\n-        validateOrganisationPolicy(caseTypeDefinition.getId(), content);\n+        caseTypeService.validateData(\n+            createValidationContext(data, caseTypeDefinition)", "originalCommit": "bed41790e7d9f76c5f8ce529b0838525f24eda61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3MzM3OQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521973379", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0MjA2OQ=="}], "type": "inlineReview"}, {"oid": "88b047bb7db208126eac7792a9fa67dd8ee119df", "url": "https://github.com/hmcts/ccd-data-store-api/commit/88b047bb7db208126eac7792a9fa67dd8ee119df", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-10T13:03:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0OTU1MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520549550", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        validationContext.getDataValue(),\n          \n          \n            \n                        validationContext.getFieldValue(),", "author": "mario-paniccia", "createdAt": "2020-11-10T13:10:36Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/BaseTypeValidator.java", "diffHunk": "@@ -15,4 +18,16 @@ default Boolean isNullOrEmpty(final JsonNode dataValue) {\n             || (dataValue.isTextual() && (null == dataValue.asText() || dataValue.asText().trim().length() == 0))\n             || (dataValue.isObject() && dataValue.toString().equals(\"{}\"));\n     }\n+\n+    default List<ValidationResult> validate(ValidationContext validationContext) {\n+        return validate(\n+            validationContext.getFieldId(),\n+            validationContext.getDataValue(),", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NDg1OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521974858", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0OTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0OTcwOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520549709", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        validationContext.getCaseFieldDefinition()\n          \n          \n            \n                        validationContext.getFieldDefinition()", "author": "mario-paniccia", "createdAt": "2020-11-10T13:10:52Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/BaseTypeValidator.java", "diffHunk": "@@ -15,4 +18,16 @@ default Boolean isNullOrEmpty(final JsonNode dataValue) {\n             || (dataValue.isTextual() && (null == dataValue.asText() || dataValue.asText().trim().length() == 0))\n             || (dataValue.isObject() && dataValue.toString().equals(\"{}\"));\n     }\n+\n+    default List<ValidationResult> validate(ValidationContext validationContext) {\n+        return validate(\n+            validationContext.getFieldId(),\n+            validationContext.getDataValue(),\n+            validationContext.getCaseFieldDefinition()", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NjMyOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521976329", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0OTcwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3MjYzMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520572633", "bodyText": "maybe it would be less confusing to introduce a new class FieldValidationContext and not mix everything inside the ValidationContext?\nlet's discuss about it", "author": "mario-paniccia", "createdAt": "2020-11-10T13:46:02Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/FieldValidator.java", "diffHunk": "@@ -2,12 +2,6 @@\n \n import java.util.List;\n \n-import com.fasterxml.jackson.databind.JsonNode;\n-import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n-\n public interface FieldValidator {\n-\n-    List<ValidationResult> validate(final String dataFieldId,\n-                                    final JsonNode dataValue,\n-                                    final CaseFieldDefinition caseFieldDefinition);\n+    List<ValidationResult> validate(ValidationContext validationContext);", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY4OTczMw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520689733", "bodyText": "what's the point of having the ValidationContext object if we've left this method as is with all the parameters?\nthe goal of introducing a ValidationContext object is so that you can simplify to:\nvalidateSimpleField(validationContext)", "author": "mario-paniccia", "createdAt": "2020-11-10T16:17:32Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidator.java", "diffHunk": "@@ -74,48 +80,71 @@ public CaseDataValidator(final List<FieldValidator> validators) {\n             return validate(\n                 JacksonUtils.convertValue(dataValue),\n                 caseFieldDefinition.getFieldTypeDefinition().getComplexFields(),\n-                fieldIdPrefix + dataFieldId + FIELD_SEPARATOR);\n+                fieldIdPrefix + dataFieldId + FIELD_SEPARATOR, validationContext\n+            );\n         } else if (BaseType.get(COLLECTION) == fieldType) {\n             final List<ValidationResult> validationResults =\n-                validateSimpleField(dataFieldId, dataValue, caseFieldDefinition, fieldIdPrefix, fieldType);\n+                validateSimpleField(\n+                    dataFieldId, dataValue,\n+                    caseFieldDefinition,\n+                    fieldIdPrefix,\n+                    fieldType,\n+                    validationContext", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTg0OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r520759848", "bodyText": "This is the old code that I did not want to refactor, later in validateSimpleField()  we set all values in the validationContext instance.  I can set the values in validationContext  before calling validateSimpleField(), refactor validateSimpleField() to be like that  validateSimpleField(validationContext) .", "author": "Thor-tech-of-metal", "createdAt": "2020-11-10T17:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY4OTczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1NDA2Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521254067", "bodyText": "Since we're now providing the validationContext, can we remove data and caseFieldDefinitions from the signature? From above it looks like we are just passing the values for those from the validationContext anyway.", "author": "danlysiak", "createdAt": "2020-11-11T10:15:24Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidator.java", "diffHunk": "@@ -32,14 +32,18 @@ public CaseDataValidator(final List<FieldValidator> validators) {\n         this.validators = validators;\n     }\n \n-    public List<ValidationResult> validate(final Map<String, JsonNode> data,\n-                                           final List<CaseFieldDefinition> caseFieldDefinitions) {\n-        return validate(data, caseFieldDefinitions, CaseDataValidator.EMPTY_STRING);\n+    public List<ValidationResult> validate(final ValidationContext validationContext) {\n+        return validate(\n+            validationContext.getData(),\n+            validationContext.getCaseTypeDefinition().getCaseFieldDefinitions(),\n+            CaseDataValidator.EMPTY_STRING, validationContext)\n+            ;\n     }\n \n     public List<ValidationResult> validate(final Map<String, JsonNode> data,\n                                            final List<CaseFieldDefinition> caseFieldDefinitions,\n-                                           final String fieldIdPrefix) {\n+                                           final String fieldIdPrefix,\n+                                           final ValidationContext validationContext) {", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NjczNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521976737", "bodyText": "This is the old code that I did not want to refactor, later in validateSimpleField() we set all values in the validationContext instance. I can set the values in validationContext before calling validateSimpleField(), refactor validateSimpleField() to be like that validateSimpleField(validationContext) .", "author": "Thor-tech-of-metal", "createdAt": "2020-11-12T09:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1NDA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTQwMg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521311402", "bodyText": "Just thinking, could this return the PredefinedFieldsIDs enum instead, if every predefined one will be defined there anyway?", "author": "danlysiak", "createdAt": "2020-11-11T12:04:27Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/FieldIdBasedValidator.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+/**\n+ * A validator that is associated to a field id, rather than the field type. Can be used in predefined complex types\n+ * such as OrganisationPolicy as an easy way to add custom validation for its sub-fields, without having to introduce\n+ * new ad-hoc custom types.\n+ * If a custom type needs to be introduced for predefined complex type sub-field, then prefer using\n+ * a CustomTypeValidator\n+ * to add additional validation logic\n+ */\n+\n+@SuppressWarnings(\"checkstyle:SummaryJavadoc\")\n+public interface FieldIdBasedValidator extends FieldValidator {\n+\n+    /**\n+     * @return the field id to which the validator is associated\n+     */\n+    String getFieldId();", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQwNTg5Nw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521405897", "bodyText": "We might have more  subclasses of this one other than OrgPolicyCaseAssignedRoleValidator. The idea is that evey subclass has its own implementation of one particular instance of  PredefinedFieldsIDs enum", "author": "Thor-tech-of-metal", "createdAt": "2020-11-11T14:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NTAwNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521375004", "bodyText": "Could use String.format() instead for these errors. And currently this resolves (I think?) to something like OrgPolicyFieldName.CaseAssignedRole The value [CLAIMANT] is not a valid organisation role.", "author": "danlysiak", "createdAt": "2020-11-11T13:57:02Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named\n+@Singleton\n+public class OrgPolicyCaseAssignedRoleValidator implements FieldIdBasedValidator {\n+\n+    private final CaseRoleRepository caseRoleRepository;\n+\n+    @Inject\n+    public OrgPolicyCaseAssignedRoleValidator(\n+        @Qualifier(CachedCaseRoleRepository.QUALIFIER) final CaseRoleRepository caseRoleRepository\n+    ) {\n+        this.caseRoleRepository = caseRoleRepository;\n+    }\n+\n+    @Override\n+    public String getFieldId() {\n+        return PredefinedFieldsIDs.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(ValidationContext validationContext) {\n+        return validateOrganisationPolicy(validationContext);\n+    }\n+\n+    private List<ValidationResult> validateOrganisationPolicy(ValidationContext validationContext) {\n+        final String caseTypeId = validationContext.getCaseTypeId();\n+        final Set<String> caseRoles = caseRoleRepository.getCaseRoles(caseTypeId);\n+        final List<ValidationResult> errors = new ArrayList<>();\n+        validateContent(validationContext, caseRoles, errors);\n+        if (errors.isEmpty()) {\n+            return Collections.emptyList();\n+        }\n+        return errors;\n+    }\n+\n+    private void validateContent(ValidationContext validationContext, final Set<String> caseRoles,\n+                                 final List<ValidationResult> errors) {\n+\n+        final JsonNode orgPolicyRoleNode = validationContext.getDataValue();\n+        if (orgPolicyRoleNode.isNull()) {\n+            errors.add(new ValidationResult(validationContext.getPath()\n+                + \" organisation role cannot have an empty value.\", validationContext.getFieldId()));\n+        } else if (!caseRolesContainsCaseInsensitive(caseRoles, orgPolicyRoleNode)) {\n+            errors.add(new ValidationResult(validationContext.getPath()\n+                + \" The value  \" + orgPolicyRoleNode.textValue()", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQwNjQyOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521406429", "bodyText": "DONE", "author": "Thor-tech-of-metal", "createdAt": "2020-11-11T14:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NTAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NjU5OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521376598", "bodyText": "Could possibly do without having the caseTypeId variable since it's easily derived?", "author": "danlysiak", "createdAt": "2020-11-11T13:59:28Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/ValidationContext.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseTypeDefinition;\n+\n+import java.util.Map;\n+\n+public class ValidationContext {\n+\n+    private final String caseTypeId;\n+    private final CaseTypeDefinition caseTypeDefinition;\n+    private final Map<String, JsonNode> data;\n+    private String fieldId;\n+    private String path;\n+    private JsonNode dataValue;\n+    private CaseFieldDefinition caseFieldDefinition;\n+\n+    public ValidationContext(\n+        CaseTypeDefinition caseTypeDefinition,\n+        Map<String, JsonNode> data\n+    ) {\n+        this.caseTypeId = caseTypeDefinition.getId();", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MDg2Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521440866", "bodyText": "yeap Good DONE.", "author": "Thor-tech-of-metal", "createdAt": "2020-11-11T15:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NjU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxMzg3Ng==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521413876", "bodyText": "better to avoid plural names in class naming conventions", "author": "kiran-yenigala-hmcts", "createdAt": "2020-11-11T14:54:30Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/PredefinedFieldsIDs.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+/**\n+ * IDs of fields in predefined complex types.\n+ */\n+public enum PredefinedFieldsIDs {", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MDAyNw==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521440027", "bodyText": ":) Let me check it", "author": "Thor-tech-of-metal", "createdAt": "2020-11-11T15:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxMzg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxNjgxNA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521416814", "bodyText": "validationContext.getCaseFieldDefinition can be used, no need to pass caseFieldDefinition parameter\nif we have to use validationContext, need to populate the object,\nvalidationContext.setPath(fieldIdPrefix);\nvalidationContext.setDataValue(dataValue);\nvalidationContext.setCaseFieldDefinition(caseFieldDefinition);\nvalidationContext.setFieldId(fieldId);\nInstead of this, can't we provide the constructor with all the required data...", "author": "kiran-yenigala-hmcts", "createdAt": "2020-11-11T14:58:46Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidator.java", "diffHunk": "@@ -139,33 +176,43 @@ private boolean isBaseTypeValidator(FieldValidator validator, BaseType fieldType\n         return false;\n     }\n \n-    private List<ValidationResult> validateCollectionItem(FieldTypeDefinition fieldTypeDefinition, JsonNode item,\n-                                                          String fieldIdPrefix, String index) {\n+    private List<ValidationResult> validateCollectionItem(\n+        FieldTypeDefinition fieldTypeDefinition,\n+        JsonNode item,\n+        String fieldIdPrefix,\n+        String index,\n+        ValidationContext validationContext\n+    ) {\n         final String itemFieldId = fieldIdPrefix + index;\n \n         final JsonNode itemValue = item.get(CollectionValidator.VALUE);\n \n         if (null == itemValue) {\n             return Collections.emptyList();\n         }\n-\n         if (shouldTreatAsValueNode(fieldTypeDefinition, itemValue)) {\n             if (!BaseType.contains(fieldTypeDefinition.getType())) {\n-                return Collections.singletonList(new ValidationResult(\"Unknown Type:\"\n-                    + fieldTypeDefinition.getType(), itemFieldId));\n+                return Collections.singletonList(\n+                    new ValidationResult(\"Unknown Type:\" + fieldTypeDefinition.getType(), itemFieldId)\n+                );\n             }\n-\n             final BaseType baseType = BaseType.get(fieldTypeDefinition.getType());\n-\n             final CaseFieldDefinition caseFieldDefinition = new CaseFieldDefinition();\n             caseFieldDefinition.setFieldTypeDefinition(fieldTypeDefinition);\n             caseFieldDefinition.setId(index);\n-            return validateSimpleField(index, itemValue, caseFieldDefinition, fieldIdPrefix, baseType);\n+            return validateSimpleField(\n+                                        index,\n+                                        itemValue,\n+                                        caseFieldDefinition,\n+                                        fieldIdPrefix,\n+                                        baseType,\n+                                        validationContext", "originalCommit": "88b047bb7db208126eac7792a9fa67dd8ee119df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MDUxNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r521440515", "bodyText": "mmmmm No we are trying to void it , cos these values can change among the multiple iterations of the recursive calls in CaseDataValidator.java. that is why we keep  setting for each iteration per singleton validator.", "author": "Thor-tech-of-metal", "createdAt": "2020-11-11T15:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxNjgxNA=="}], "type": "inlineReview"}, {"oid": "b165fb9b3d19d4f4c4494aa672293405e892e70a", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b165fb9b3d19d4f4c4494aa672293405e892e70a", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-11T15:45:54Z", "type": "commit"}, {"oid": "43f19bd6966615b751caccdddf3d21db898dc8e7", "url": "https://github.com/hmcts/ccd-data-store-api/commit/43f19bd6966615b751caccdddf3d21db898dc8e7", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-11T15:59:20Z", "type": "commit"}, {"oid": "ad45e5046c5125784cbbedeee34e8d57c6f30f1f", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ad45e5046c5125784cbbedeee34e8d57c6f30f1f", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939", "committedDate": "2020-11-11T16:02:19Z", "type": "commit"}, {"oid": "8b48116ada8487619165614171bba454d4b0966b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8b48116ada8487619165614171bba454d4b0966b", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-12T09:58:57Z", "type": "commit"}, {"oid": "7d3df3f8688a093bf6b38750bdff92fde23733ab", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7d3df3f8688a093bf6b38750bdff92fde23733ab", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939", "committedDate": "2020-11-12T10:00:15Z", "type": "commit"}, {"oid": "ce0fe97d29caa876ead39a013183f0f9f6df4171", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ce0fe97d29caa876ead39a013183f0f9f6df4171", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-12T10:41:45Z", "type": "commit"}, {"oid": "d1732d18ebdd001b75472b70b497cc598a7d6be3", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d1732d18ebdd001b75472b70b497cc598a7d6be3", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-12T11:13:03Z", "type": "commit"}, {"oid": "e79be0fc2510de4bfbabee16d01627ee109cfcd5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/e79be0fc2510de4bfbabee16d01627ee109cfcd5", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-12T12:34:20Z", "type": "commit"}, {"oid": "6a8c70370417d3aeef23d7f15faab9fadb804c57", "url": "https://github.com/hmcts/ccd-data-store-api/commit/6a8c70370417d3aeef23d7f15faab9fadb804c57", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-12T12:42:48Z", "type": "commit"}, {"oid": "946a30b48c5e54d39a22aab23d3d9d2bc19cf537", "url": "https://github.com/hmcts/ccd-data-store-api/commit/946a30b48c5e54d39a22aab23d3d9d2bc19cf537", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939\n\n\u0001 Conflicts:\n\u0001\tdependency-check-suppressions.xml", "committedDate": "2020-11-13T10:13:32Z", "type": "commit"}, {"oid": "d71319464016cbccc1f3def71e9e23275f237906", "url": "https://github.com/hmcts/ccd-data-store-api/commit/d71319464016cbccc1f3def71e9e23275f237906", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939", "committedDate": "2020-11-13T13:44:21Z", "type": "commit"}, {"oid": "9486626e8b488afcdcce3304af6ab14b04b55109", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9486626e8b488afcdcce3304af6ab14b04b55109", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-13T15:42:22Z", "type": "commit"}, {"oid": "23c756b66ca59a246a2e17eb0d2eaf0baac28578", "url": "https://github.com/hmcts/ccd-data-store-api/commit/23c756b66ca59a246a2e17eb0d2eaf0baac28578", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-13T16:23:36Z", "type": "commit"}, {"oid": "23c756b66ca59a246a2e17eb0d2eaf0baac28578", "url": "https://github.com/hmcts/ccd-data-store-api/commit/23c756b66ca59a246a2e17eb0d2eaf0baac28578", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-13T16:23:36Z", "type": "forcePushed"}, {"oid": "0b0d7457983e6def0d4505de389d08ed97c1abf7", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0b0d7457983e6def0d4505de389d08ed97c1abf7", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939", "committedDate": "2020-11-16T10:43:50Z", "type": "commit"}, {"oid": "9fadb15ccbad6e0c561ce65a67f67a531ac42fa2", "url": "https://github.com/hmcts/ccd-data-store-api/commit/9fadb15ccbad6e0c561ce65a67f67a531ac42fa2", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-16T10:49:27Z", "type": "commit"}, {"oid": "aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "url": "https://github.com/hmcts/ccd-data-store-api/commit/aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-16T12:09:27Z", "type": "commit"}, {"oid": "83a51d549503ee59f1538ff206cdeaf4c553140e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/83a51d549503ee59f1538ff206cdeaf4c553140e", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939", "committedDate": "2020-11-16T14:23:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4NzQzNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r524287435", "bodyText": "Do we need to run this through the TextValidator first before the custom validation in this class, otherwise we are losing those basic validations? (i.e. do the same as what TextCaseReferenceCaseLinkValidator does)", "author": "danlysiak", "createdAt": "2020-11-16T14:00:26Z", "path": "src/main/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidator.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import uk.gov.hmcts.ccd.data.caseaccess.CachedCaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+@Named\n+@Singleton\n+public class OrgPolicyCaseAssignedRoleValidator implements FieldIdBasedValidator {\n+\n+    private final CaseRoleRepository caseRoleRepository;\n+\n+    @Inject\n+    public OrgPolicyCaseAssignedRoleValidator(\n+        @Qualifier(CachedCaseRoleRepository.QUALIFIER) final CaseRoleRepository caseRoleRepository\n+    ) {\n+        this.caseRoleRepository = caseRoleRepository;\n+    }\n+\n+    @Override\n+    public String getFieldId() {\n+        return PredefinedFieldsIDs.ORG_POLICY_CASE_ASSIGNED_ROLE.getId();\n+    }\n+\n+    @Override\n+    public List<ValidationResult> validate(ValidationContext validationContext) {", "originalCommit": "aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA4NjkzOQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r525086939", "bodyText": "\ud83d\udc4d", "author": "mario-paniccia", "createdAt": "2020-11-17T11:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4NzQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyMjExOA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r528622118", "bodyText": "well TextCaseReferenceCaseLinkValidator has business requirements that force a relationship with TextValidator. Regular expression, Min and max and others.    OrgPolicyCaseAssignedRoleValidator we only have isEmpty , then the validations are different .  I don't see the benefit of forcing a chain of validations calls and injection only for one validation.", "author": "Thor-tech-of-metal", "createdAt": "2020-11-23T11:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4NzQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5MjkzNQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r524292935", "bodyText": "Is this used?", "author": "danlysiak", "createdAt": "2020-11-16T14:08:51Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/common/CaseTypeServiceTest.java", "diffHunk": "@@ -152,5 +154,13 @@ void shouldThrowCaseValidationException() {\n             assertThrows(CaseValidationException.class, () -> subject.validateData(data, caseTypeDefinition));\n         }\n     }\n+\n+    private ValidationContext getValidationContext(\n+        Map<String, JsonNode> values, List<CaseFieldDefinition> caseFieldDefinitions) {\n+\n+        final CaseTypeDefinition caseTypeDefinition = new CaseTypeDefinition();\n+        caseTypeDefinition.setCaseFieldDefinitions(caseFieldDefinitions);\n+        return new ValidationContext(caseTypeDefinition, values);\n+    }", "originalCommit": "aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAzMDA5NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r525030095", "bodyText": "This class was marked as red by Sonar.", "author": "Thor-tech-of-metal", "createdAt": "2020-11-17T10:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5MjkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NTE1OA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r524295158", "bodyText": "Can we make this and all other tests currently using contains check for equality instead? Looks like we can always know what the values should be so should be able to check for an exact match.", "author": "danlysiak", "createdAt": "2020-11-16T14:11:59Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/types/OrgPolicyCaseAssignedRoleValidatorTest.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package uk.gov.hmcts.ccd.domain.types;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+import uk.gov.hmcts.ccd.data.caseaccess.CaseRoleRepository;\n+import uk.gov.hmcts.ccd.data.definition.CaseDefinitionRepository;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseFieldDefinition;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseTypeDefinition;\n+import uk.gov.hmcts.ccd.test.CaseFieldDefinitionBuilder;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.junit.jupiter.api.Assertions.assertAll;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.when;\n+\n+@DisplayName(\"OrgPolicyCaseAssignedRoleValidator\")\n+class OrgPolicyCaseAssignedRoleValidatorTest {\n+\n+    private static final JsonNodeFactory NODE_FACTORY = JsonNodeFactory.instance;\n+    private static final String FIELD_ID = \"TEST_FIELD_ID\";\n+\n+    @Mock\n+    private CaseDefinitionRepository definitionRepository;\n+\n+    @Mock\n+    private CaseRoleRepository caseRoleRepository;\n+\n+    private OrgPolicyCaseAssignedRoleValidator validator;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+\n+        when(definitionRepository.getBaseTypes()).thenReturn(Collections.emptyList());\n+        BaseType.setCaseDefinitionRepository(definitionRepository);\n+        BaseType.initialise();\n+        validator = new OrgPolicyCaseAssignedRoleValidator(caseRoleRepository);\n+    }\n+\n+\n+    @Test\n+    @DisplayName(\"should fail due to incorrect organisation role\")\n+    void failDueToIncorrectOrganisationRole() {\n+\n+        final CaseFieldDefinition caseFieldDefinition = caseField().build();\n+        caseFieldDefinition.setId(\"TEST\");\n+        final JsonNode validValue = NODE_FACTORY.textNode(\"XXXX\");\n+        ValidationContext validationContext1 = createValidationContext(caseFieldDefinition, validValue);\n+        final List<ValidationResult> validResult = validator.validate(validationContext1);\n+\n+        assertAll(\n+            () -> assertThat(\"Expected input to be valid\", validResult, hasSize(1)),\n+            () -> assertTrue(validResult.get(0).getErrorMessage()\n+                .contains(\"The value XXXX is not a valid organisation role.\"))", "originalCommit": "aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyMzM4NQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r528623385", "bodyText": "yeap , I agree \u261d\ufe0f", "author": "Thor-tech-of-metal", "createdAt": "2020-11-23T11:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5NTE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI5OTE5Mg==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r524299192", "bodyText": "I think if all these edited tests in this class have now been moved over to the validator test one (which I think they have?) then no longer need them in here anymore? \ud83d\ude03", "author": "danlysiak", "createdAt": "2020-11-16T14:17:50Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/service/validate/DefaultValidateCaseFieldsOperationTest.java", "diffHunk": "@@ -202,36 +206,48 @@ void shouldValidate_when_organisation_has_correct_roles_complex() throws Excepti\n \n     @Test\n     void should_fail_validate_when_organisation_has_null_role() throws Exception {", "originalCommit": "aa3022ae0340518c11ab26eb2e1d3eb6dd3fc8ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMwMzQ2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/1194#discussion_r524303460", "bodyText": "Just wondering..why is this now 2 - is a change expected in the number of errors from this test? (Sorry, bit hard to understand the context since not many changes were made around this and it's mostly old code \ud83d\ude04 )", "author": "danlysiak", "createdAt": "2020-11-16T14:23:26Z", "path": "src/test/java/uk/gov/hmcts/ccd/domain/types/CaseDataValidatorTest.java", "diffHunk": "@@ -177,8 +190,9 @@ public void unknownType() throws Exception {\n                 \"}\";\n         final Map<String, JsonNode> values = MAPPER.readValue(data, new TypeReference<HashMap<String, JsonNode>>() {\n         });\n-        final List<ValidationResult> result = caseDataValidator.validate(values, caseFields);\n-        assertEquals(result.toString(), 1, result.size());\n+        final ValidationContext validationContext = getValidationContext(values);\n+        final List<ValidationResult> result = caseDataValidator.validate(validationContext);\n+        assertEquals(result.toString(), 2, result.size());", "originalCommit": "83a51d549503ee59f1538ff206cdeaf4c553140e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3fa177f67316061a55e7ea62d493d4c787ed4581", "url": "https://github.com/hmcts/ccd-data-store-api/commit/3fa177f67316061a55e7ea62d493d4c787ed4581", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-16T15:01:56Z", "type": "commit"}, {"oid": "0ed24c773fd708188a275b2f1d91456c972c562a", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0ed24c773fd708188a275b2f1d91456c972c562a", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-16T15:40:08Z", "type": "commit"}, {"oid": "1f6611fc5ada0577a2e5296f16b875bad7badd08", "url": "https://github.com/hmcts/ccd-data-store-api/commit/1f6611fc5ada0577a2e5296f16b875bad7badd08", "message": " RDM-9939: Re-factor DefaultValidateCaseFieldsOperation to remove ORGANISATION_POLICY_ROLE logic\n    \u00a0\u00a0[RDM-9939] (https://tools.hmcts.net/jira/browse/RDM-9939).", "committedDate": "2020-11-16T22:09:57Z", "type": "commit"}, {"oid": "64f84a8f716b5366468df20934ca2e87112052f4", "url": "https://github.com/hmcts/ccd-data-store-api/commit/64f84a8f716b5366468df20934ca2e87112052f4", "message": "Merge branch 'develop' of github.com:hmcts/ccd-data-store-api into RDM-9939\n\n\u0001 Conflicts:\n\u0001\tdependency-check-suppressions.xml", "committedDate": "2020-11-19T10:55:43Z", "type": "commit"}]}