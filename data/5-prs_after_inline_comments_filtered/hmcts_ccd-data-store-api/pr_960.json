{"pr_number": 960, "pr_title": "RDM-8598 - Integration tests for external search API", "pr_createdAt": "2020-05-28T19:41:21Z", "pr_url": "https://github.com/hmcts/ccd-data-store-api/pull/960", "timeline": [{"oid": "ee04b18575fd00c31ea183236f97abdb4187024e", "url": "https://github.com/hmcts/ccd-data-store-api/commit/ee04b18575fd00c31ea183236f97abdb4187024e", "message": "RDM-8598 - Introduce embedded ES for integration testing; including configuration/data load and sample test", "committedDate": "2020-05-28T19:38:09Z", "type": "commit"}, {"oid": "32c9b1f80366fff3721c4be06e9de0f6e147bc38", "url": "https://github.com/hmcts/ccd-data-store-api/commit/32c9b1f80366fff3721c4be06e9de0f6e147bc38", "message": "Conditional ES config", "committedDate": "2020-05-28T21:59:11Z", "type": "commit"}, {"oid": "89c70db669e45235ce898c60a1d6de95a8e9a592", "url": "https://github.com/hmcts/ccd-data-store-api/commit/89c70db669e45235ce898c60a1d6de95a8e9a592", "message": "Remove non-required stop", "committedDate": "2020-05-28T22:08:28Z", "type": "commit"}, {"oid": "bcda3f02e466858a91acbacc51a49b4f51843775", "url": "https://github.com/hmcts/ccd-data-store-api/commit/bcda3f02e466858a91acbacc51a49b4f51843775", "message": "Init ES data only when required", "committedDate": "2020-05-29T08:37:18Z", "type": "commit"}, {"oid": "fe99f5bb00fd4f4f5421432b66934fc5ae8db636", "url": "https://github.com/hmcts/ccd-data-store-api/commit/fe99f5bb00fd4f4f5421432b66934fc5ae8db636", "message": "Merge branch 'RDM-8325' into RDM-8598", "committedDate": "2020-06-09T13:07:27Z", "type": "commit"}, {"oid": "5b6e07290eb42d73ac7ffc64b0468ea77debe351", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5b6e07290eb42d73ac7ffc64b0468ea77debe351", "message": "RDM-8598 - Integration tests for external ES search endpoint", "committedDate": "2020-06-12T10:31:08Z", "type": "commit"}, {"oid": "0d903cec2456867c09145d68c48ca5ea9372d1ba", "url": "https://github.com/hmcts/ccd-data-store-api/commit/0d903cec2456867c09145d68c48ca5ea9372d1ba", "message": "Checkstyle", "committedDate": "2020-06-12T10:38:59Z", "type": "commit"}, {"oid": "884a998d9d149e08c14338b1b8e6df56dc887b77", "url": "https://github.com/hmcts/ccd-data-store-api/commit/884a998d9d149e08c14338b1b8e6df56dc887b77", "message": "RDM-8608 Suppress CVE-2020-13692", "committedDate": "2020-06-12T11:12:17Z", "type": "commit"}, {"oid": "b9a1161c158ce594be61f3aa607f12313b77b46b", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b9a1161c158ce594be61f3aa607f12313b77b46b", "message": "Unused import", "committedDate": "2020-06-12T11:17:23Z", "type": "commit"}, {"oid": "7e8b82403f702daaa53b0670e601de6e70e51167", "url": "https://github.com/hmcts/ccd-data-store-api/commit/7e8b82403f702daaa53b0670e601de6e70e51167", "message": "RDM-8598 - Further integration tests", "committedDate": "2020-06-16T08:20:48Z", "type": "commit"}, {"oid": "a057d0a1f95e1cf02a7275d25e665a7f762b25b9", "url": "https://github.com/hmcts/ccd-data-store-api/commit/a057d0a1f95e1cf02a7275d25e665a7f762b25b9", "message": "RDM-8598 - Cleanup and new test", "committedDate": "2020-06-16T12:14:39Z", "type": "commit"}, {"oid": "5d6542e45239051714bbd621ac866207e595fcd5", "url": "https://github.com/hmcts/ccd-data-store-api/commit/5d6542e45239051714bbd621ac866207e595fcd5", "message": "Fix intermittent failing pipeline tests", "committedDate": "2020-06-16T12:20:19Z", "type": "commit"}, {"oid": "8c18a09addc78df4ba8d3008b18644992bbb25cd", "url": "https://github.com/hmcts/ccd-data-store-api/commit/8c18a09addc78df4ba8d3008b18644992bbb25cd", "message": "Merge branch 'RDM-8325' into RDM-8598", "committedDate": "2020-06-17T10:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ1NDE2MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/960#discussion_r441454160", "bodyText": "Is this test working as expected? - when trying this locally I get a 500 response with Problem getting case type version for 'casetypeA,casetypeB'.", "author": "noronhaa", "createdAt": "2020-06-17T10:44:27Z", "path": "src/test/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpointESIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package uk.gov.hmcts.ccd.endpoint.std;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.context.SecurityContext;\n+import org.springframework.security.core.context.SecurityContextHolder;\n+import org.springframework.test.web.servlet.MockMvc;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.test.web.servlet.setup.MockMvcBuilders;\n+import org.springframework.web.context.WebApplicationContext;\n+import uk.gov.hmcts.ccd.ElasticsearchBaseTest;\n+import uk.gov.hmcts.ccd.MockUtils;\n+import uk.gov.hmcts.ccd.data.casedetails.SecurityClassification;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.search.CaseSearchResult;\n+\n+import javax.inject.Inject;\n+import java.util.Map;\n+\n+import static org.elasticsearch.index.query.QueryBuilders.*;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.startsWith;\n+import static org.junit.jupiter.api.Assertions.assertAll;\n+import static org.mockito.Mockito.doReturn;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+import static uk.gov.hmcts.ccd.test.ElasticsearchTestHelper.*;\n+\n+class CaseSearchEndpointESIT extends ElasticsearchBaseTest {\n+\n+    private static final String POST_SEARCH_CASES = \"/searchCases\";\n+    private static final String CASE_TYPE_ID_PARAM = \"ctid\";\n+\n+    @Inject\n+    private WebApplicationContext wac;\n+    private MockMvc mockMvc;\n+\n+    @Mock\n+    private Authentication authentication;\n+\n+    @Mock\n+    private SecurityContext securityContext;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+\n+        doReturn(authentication).when(securityContext).getAuthentication();\n+        SecurityContextHolder.setContext(securityContext);\n+\n+        MockUtils.setSecurityAuthorities(authentication, AUTOTEST1_PUBLIC, AUTOTEST2_PUBLIC);\n+\n+        mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();\n+    }\n+\n+    @Nested\n+    class CrossCaseTypeSearch {\n+\n+        @Test // Note that cross case type searches do NOT return case data\n+        void shouldReturnAllCasesForAllSpecifiedCaseTypes() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchAllQuery())\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, caseTypesParam(CASE_TYPE_A, CASE_TYPE_B))\n+                .content(searchRequest))\n+                .andExpect(status().is(200))", "originalCommit": "5d6542e45239051714bbd621ac866207e595fcd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ1OTI0MA==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/960#discussion_r441459240", "bodyText": "This should be available now so we should uncomment this line", "author": "noronhaa", "createdAt": "2020-06-17T10:54:32Z", "path": "src/test/java/uk/gov/hmcts/ccd/endpoint/std/CaseSearchEndpointESIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package uk.gov.hmcts.ccd.endpoint.std;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Nested;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+import org.springframework.http.MediaType;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.context.SecurityContext;\n+import org.springframework.security.core.context.SecurityContextHolder;\n+import org.springframework.test.web.servlet.MockMvc;\n+import org.springframework.test.web.servlet.MvcResult;\n+import org.springframework.test.web.servlet.setup.MockMvcBuilders;\n+import org.springframework.web.context.WebApplicationContext;\n+import uk.gov.hmcts.ccd.ElasticsearchBaseTest;\n+import uk.gov.hmcts.ccd.MockUtils;\n+import uk.gov.hmcts.ccd.data.casedetails.SecurityClassification;\n+import uk.gov.hmcts.ccd.domain.model.definition.CaseDetails;\n+import uk.gov.hmcts.ccd.domain.model.search.CaseSearchResult;\n+\n+import javax.inject.Inject;\n+import java.util.Map;\n+\n+import static org.elasticsearch.index.query.QueryBuilders.*;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.startsWith;\n+import static org.junit.jupiter.api.Assertions.assertAll;\n+import static org.mockito.Mockito.doReturn;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+import static uk.gov.hmcts.ccd.test.ElasticsearchTestHelper.*;\n+\n+class CaseSearchEndpointESIT extends ElasticsearchBaseTest {\n+\n+    private static final String POST_SEARCH_CASES = \"/searchCases\";\n+    private static final String CASE_TYPE_ID_PARAM = \"ctid\";\n+\n+    @Inject\n+    private WebApplicationContext wac;\n+    private MockMvc mockMvc;\n+\n+    @Mock\n+    private Authentication authentication;\n+\n+    @Mock\n+    private SecurityContext securityContext;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+\n+        doReturn(authentication).when(securityContext).getAuthentication();\n+        SecurityContextHolder.setContext(securityContext);\n+\n+        MockUtils.setSecurityAuthorities(authentication, AUTOTEST1_PUBLIC, AUTOTEST2_PUBLIC);\n+\n+        mockMvc = MockMvcBuilders.webAppContextSetup(wac).build();\n+    }\n+\n+    @Nested\n+    class CrossCaseTypeSearch {\n+\n+        @Test // Note that cross case type searches do NOT return case data\n+        void shouldReturnAllCasesForAllSpecifiedCaseTypes() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchAllQuery())\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, caseTypesParam(CASE_TYPE_A, CASE_TYPE_B))\n+                .content(searchRequest))\n+                .andExpect(status().is(200))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            CaseSearchResult caseSearchResult = mapper.readValue(responseAsString, CaseSearchResult.class);\n+\n+            assertAll(\n+                () -> assertThat(caseSearchResult.getTotal(), is(3L)),\n+                () -> assertThat(caseSearchResult.getCaseReferences(CASE_TYPE_A).size(), is(2)),\n+                () -> assertThat(caseSearchResult.getCaseReferences(CASE_TYPE_B).size(), is(1)),\n+                () -> assertThat(caseSearchResult.getCases().get(0).getData().size(), is(0)),\n+                () -> assertThat(caseSearchResult.getCases().get(1).getData().size(), is(0)),\n+                () -> assertThat(caseSearchResult.getCases().get(2).getData().size(), is(0))\n+            );\n+        }\n+\n+        @Test\n+        void shouldReturnRequestedAliasSource() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchAllQuery())\n+                .source(alias(TEXT_ALIAS))\n+                .sort(CREATED_DATE)\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, caseTypesParam(CASE_TYPE_A, CASE_TYPE_B))\n+                .content(searchRequest))\n+                .andExpect(status().is(200))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            CaseSearchResult caseSearchResult = mapper.readValue(responseAsString, CaseSearchResult.class);\n+\n+            assertAll(\n+                () -> assertThat(caseSearchResult.getTotal(), is(3L)),\n+                () -> assertThat(caseSearchResult.getCases().get(0).getData().get(TEXT_ALIAS).asText(), is(TEXT_VALUE)),\n+                () -> assertThat(caseSearchResult.getCases().get(1).getData().get(TEXT_ALIAS).asText(), is(\"CCC TextValue\")),\n+                () -> assertThat(caseSearchResult.getCases().get(2).getData().get(TEXT_ALIAS).asText(), is(\"BBB TextValue\")),\n+                () -> assertThat(caseSearchResult.getCases().get(0).getData().size(), is(1)),\n+                () -> assertThat(caseSearchResult.getCases().get(1).getData().size(), is(1)),\n+                () -> assertThat(caseSearchResult.getCases().get(2).getData().size(), is(1))\n+            );\n+        }\n+\n+        @Test // Note that the size and sort is applied to each separate case type then results combined\n+        void shouldReturnPaginatedResults() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchAllQuery())\n+                .sort(CREATED_DATE)\n+                .size(1)\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, caseTypesParam(CASE_TYPE_A, CASE_TYPE_B))\n+                .content(searchRequest))\n+                .andExpect(status().is(200))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            CaseSearchResult caseSearchResult = mapper.readValue(responseAsString, CaseSearchResult.class);\n+\n+            assertAll(\n+                () -> assertThat(caseSearchResult.getTotal(), is(3L)),\n+                () -> assertThat(caseSearchResult.getCases().size(), is(2)) // = Size * Number of case types\n+            );\n+        }\n+\n+        @Test\n+        void shouldQueryOnAliasField() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchQuery(alias(FIXED_LIST_ALIAS), FIXED_LIST_VALUE))\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, caseTypesParam(CASE_TYPE_A, CASE_TYPE_B))\n+                .content(searchRequest))\n+                .andExpect(status().is(200))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            CaseSearchResult caseSearchResult = mapper.readValue(responseAsString, CaseSearchResult.class);\n+\n+            assertAll(\n+                () -> assertThat(caseSearchResult.getTotal(), is(2L)),\n+                () -> assertThat(caseSearchResult.getCases().get(0).getReference(), is(1588866820969121L)),\n+                () -> assertThat(caseSearchResult.getCases().get(1).getReference(), is(1588870615652827L))\n+            );\n+        }\n+    }\n+\n+    @Nested\n+    class SingleCaseTypeSearch {\n+\n+        @Test\n+        void shouldReturnAllCaseDetails() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(boolQuery()\n+                    .must(matchQuery(caseData(NUMBER_FIELD), NUMBER_VALUE)) // ES Double\n+                    .must(matchQuery(caseData(YES_OR_NO_FIELD), YES_OR_NO_VALUE)) // ES Keyword\n+                    .must(matchQuery(caseData(TEXT_FIELD), TEXT_VALUE)) // ES Text\n+                    .must(matchQuery(caseData(DATE_FIELD), DATE_VALUE)) // ES Date\n+                    .must(matchQuery(caseData(PHONE_FIELD), PHONE_VALUE)) // ES Phone\n+                    .must(matchQuery(caseData(COUNTRY_FIELD), COUNTRY_VALUE)) // Complex\n+                    .must(matchQuery(caseData(COLLECTION_FIELD) + VALUE_SUFFIX, COLLECTION_VALUE)) // Collection\n+                    .must(matchQuery(STATE, STATE_VALUE)))\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, CASE_TYPE_A)\n+                .content(searchRequest))\n+                .andExpect(status().is(200))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            CaseSearchResult caseSearchResult = mapper.readValue(responseAsString, CaseSearchResult.class);\n+\n+            CaseDetails caseDetails = caseSearchResult.getCases().get(0);\n+            assertAll(\n+                () -> assertThat(caseSearchResult.getTotal(), is(1L)),\n+                () -> assertExampleCaseMetadata(caseDetails),\n+                () -> assertExampleCaseData(caseDetails)\n+            );\n+        }\n+\n+        @Test\n+        void shouldErrorWhenInvalidCaseTypeIsProvided() throws Exception {\n+            String searchRequest = ElasticsearchTestRequest.builder()\n+                .query(matchAllQuery())\n+                .build().toJsonString();\n+\n+            MvcResult result = mockMvc.perform(post(POST_SEARCH_CASES)\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .param(CASE_TYPE_ID_PARAM, \"INVALID\")\n+                .content(searchRequest))\n+                .andExpect(status().is(404))\n+                .andReturn();\n+\n+            String responseAsString = result.getResponse().getContentAsString();\n+            JsonNode exceptionNode = mapper.readTree(responseAsString);\n+\n+            assertAll(\n+                () -> assertThat(exceptionNode.get(\"message\").asText(),\n+                    startsWith(\"Resource not found when getting case type definition for INVALID\"))\n+            );\n+        }\n+\n+        public void assertExampleCaseMetadata(CaseDetails caseDetails) {\n+            assertAll(\n+                () -> assertThat(caseDetails.getJurisdiction(), is(\"AUTOTEST1\")),\n+                () -> assertThat(caseDetails.getCaseTypeId(), is(CASE_TYPE_A)),\n+                () -> assertThat(caseDetails.getCreatedDate().toString(), is(\"2020-05-07T15:53:40.974\")),\n+                () -> assertThat(caseDetails.getLastModified().toString(), is(\"2020-06-09T13:17:06.542\")),\n+                // () -> assertThat(caseDetails.getLastStateModifiedDate().toString(), is(\"TBC\")), // TODO: After RDM-8552 available", "originalCommit": "5d6542e45239051714bbd621ac866207e595fcd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NTk2MQ==", "url": "https://github.com/hmcts/ccd-data-store-api/pull/960#discussion_r441475961", "bodyText": "Merged in latest and uncommented.", "author": "danlysiak", "createdAt": "2020-06-17T11:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ1OTI0MA=="}], "type": "inlineReview"}, {"oid": "b534756e02f56eb596ad01526ba6dbaeca564359", "url": "https://github.com/hmcts/ccd-data-store-api/commit/b534756e02f56eb596ad01526ba6dbaeca564359", "message": "Merge branch 'RDM-8325' into RDM-8598", "committedDate": "2020-06-17T11:08:38Z", "type": "commit"}, {"oid": "f6b1e5ac62f24a1a178056e3b2bce44bc89e618c", "url": "https://github.com/hmcts/ccd-data-store-api/commit/f6b1e5ac62f24a1a178056e3b2bce44bc89e618c", "message": "RDM-8598 - Address TODOs following merge", "committedDate": "2020-06-17T11:26:34Z", "type": "commit"}]}