{"pr_number": 5064, "pr_title": "Send SIGINT for bazel test processes", "pr_createdAt": "2020-11-18T19:14:14Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/5064", "timeline": [{"oid": "61a21932f256808e9538fa4350080091516c9814", "url": "https://github.com/flutter/flutter-intellij/commit/61a21932f256808e9538fa4350080091516c9814", "message": "Send SIGINT for bazel test processes", "committedDate": "2020-11-18T19:11:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxNzM4OQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5064#discussion_r526417389", "bodyText": "Add a comment indicating why softKill should be preferred.\nYour comment for this CL is about the right level of granularity.\nSIGKILL is currently sent when a test process is stopped, but this can't be routed to remote processes spawned from the original one.", "author": "jacob314", "createdAt": "2020-11-18T21:00:53Z", "path": "src/io/flutter/utils/MostlySilentOsProcessHandler.java", "diffHunk": "@@ -30,14 +32,33 @@\n  * for more information.\n  */\n public class MostlySilentOsProcessHandler extends OSProcessHandler {\n+  private boolean softKill;", "originalCommit": "61a21932f256808e9538fa4350080091516c9814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODA2MA==", "url": "https://github.com/flutter/flutter-intellij/pull/5064#discussion_r526418060", "bodyText": "Can we verify whether we were able to kill the process and fail if we weren't able to?", "author": "jacob314", "createdAt": "2020-11-18T21:02:09Z", "path": "src/io/flutter/utils/MostlySilentOsProcessHandler.java", "diffHunk": "@@ -30,14 +32,33 @@\n  * for more information.\n  */\n public class MostlySilentOsProcessHandler extends OSProcessHandler {\n+  private boolean softKill;\n+\n   public MostlySilentOsProcessHandler(@NotNull GeneralCommandLine commandLine)\n+    throws ExecutionException {\n+    this(commandLine, false);\n+  }\n+\n+  public MostlySilentOsProcessHandler(@NotNull GeneralCommandLine commandLine, boolean softKill)\n     throws ExecutionException {\n     super(commandLine);\n+    this.softKill = softKill;\n   }\n \n   @NotNull\n   @Override\n   protected BaseOutputReader.Options readerOptions() {\n     return BaseOutputReader.Options.forMostlySilentProcess();\n   }\n+\n+  @Override\n+  protected void doDestroyProcess() {\n+    final Process process = getProcess();\n+    if (softKill && SystemInfo.isUnix && shouldDestroyProcessRecursively() && processCanBeKilledByOS(process)) {\n+      UnixProcessManager.sendSigIntToProcessTree(process);", "originalCommit": "61a21932f256808e9538fa4350080091516c9814", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2MTY1NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5064#discussion_r526461655", "bodyText": "UnixProcessManager.sendSigIntToProcessTree will log a warning message and return false if the process isn't killed - what's a reasonable action to take if that's the case? Throw an exception or call super.doDestroyProcess?", "author": "helin24", "createdAt": "2020-11-18T22:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ2NDgzNQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5064#discussion_r526464835", "bodyText": "Lets kill the process completely but also log a message to analytics so we can diagnose what went wrong.", "author": "jacob314", "createdAt": "2020-11-18T22:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODA2MA=="}], "type": "inlineReview"}, {"oid": "8d9d151bfacbb90d701b61774833e9fa90f1b841", "url": "https://github.com/flutter/flutter-intellij/commit/8d9d151bfacbb90d701b61774833e9fa90f1b841", "message": "Add comment and log if unable to kill process", "committedDate": "2020-11-18T22:59:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MTY2NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5064#discussion_r526491665", "bodyText": "don't need the full command line string which might identify the user, just the file name.", "author": "jacob314", "createdAt": "2020-11-18T23:31:13Z", "path": "src/io/flutter/utils/MostlySilentOsProcessHandler.java", "diffHunk": "@@ -30,14 +33,43 @@\n  * for more information.\n  */\n public class MostlySilentOsProcessHandler extends OSProcessHandler {\n+  /*\n+  This determines whether a soft kill (SIGINT) is sent to the process on destroy, instead of the default SIGKILL. SIGKILL can't be routed\n+  to remote processes spawned from the original one.\n+   */\n+  private boolean softKill;\n+  private GeneralCommandLine commandLine;\n+\n   public MostlySilentOsProcessHandler(@NotNull GeneralCommandLine commandLine)\n+    throws ExecutionException {\n+    this(commandLine, false);\n+  }\n+\n+  public MostlySilentOsProcessHandler(@NotNull GeneralCommandLine commandLine, boolean softKill)\n     throws ExecutionException {\n     super(commandLine);\n+    this.softKill = softKill;\n+    this.commandLine = commandLine;\n   }\n \n   @NotNull\n   @Override\n   protected BaseOutputReader.Options readerOptions() {\n     return BaseOutputReader.Options.forMostlySilentProcess();\n   }\n+\n+  @Override\n+  protected void doDestroyProcess() {\n+    final Process process = getProcess();\n+    if (softKill && SystemInfo.isUnix && shouldDestroyProcessRecursively() && processCanBeKilledByOS(process)) {\n+      final boolean result = UnixProcessManager.sendSigIntToProcessTree(process);\n+      if (!result) {\n+        FlutterInitializer.getAnalytics().sendEvent(\"process\", \"process kill failed: \" + this.commandLine.getCommandLineString());", "originalCommit": "8d9d151bfacbb90d701b61774833e9fa90f1b841", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46c3851f447ae12977ec0a1bd98f8e3ea1af0444", "url": "https://github.com/flutter/flutter-intellij/commit/46c3851f447ae12977ec0a1bd98f8e3ea1af0444", "message": "Remove command line str logging, may contain private info", "committedDate": "2020-11-18T23:49:59Z", "type": "commit"}]}