{"pr_number": 5112, "pr_title": "Add devtools service", "pr_createdAt": "2020-12-09T22:01:01Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/5112", "timeline": [{"oid": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "url": "https://github.com/flutter/flutter-intellij/commit/d54d9554bfaa91e906466af5b152ff8fd8fe1447", "message": "Add devtools service", "committedDate": "2020-12-09T22:29:05Z", "type": "commit"}, {"oid": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "url": "https://github.com/flutter/flutter-intellij/commit/d54d9554bfaa91e906466af5b152ff8fd8fe1447", "message": "Add devtools service", "committedDate": "2020-12-09T22:29:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzODk2OA==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r539838968", "bodyText": "no need for an inner class. Nust write as a Lambda.", "author": "jacob314", "createdAt": "2020-12-10T04:36:57Z", "path": "src/io/flutter/run/daemon/DaemonApi.java", "diffHunk": "@@ -404,6 +408,14 @@ RestartResult parseResult(JsonElement result) {\n     }\n   }\n \n+  private static class DaemonShutdown extends Params<Boolean> {", "originalCommit": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMzY5NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540433695", "bodyText": "I think I'm not doing this correctly - see above (ln 77). A class is required that implements parseResult, is there a way to do that with a lambda?", "author": "helin24", "createdAt": "2020-12-10T19:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzODk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3ODMxNA==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540578314", "bodyText": "ah you are right. I missed the extends.", "author": "jacob314", "createdAt": "2020-12-10T23:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzODk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzOTQ0NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r539839445", "bodyText": "have you tested that this code gracefully handles changing your flutter project?", "author": "jacob314", "createdAt": "2020-12-10T04:38:25Z", "path": "src/io/flutter/run/daemon/DevToolsService.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.run.daemon;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessHandler;\n+import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.project.ProjectManager;\n+import com.intellij.openapi.project.ProjectManagerListener;\n+import com.intellij.openapi.util.io.FileUtil;\n+import com.intellij.openapi.vfs.CharsetToolkit;\n+import io.flutter.FlutterUtils;\n+import io.flutter.android.IntelliJAndroidSdk;\n+import io.flutter.bazel.Workspace;\n+import io.flutter.bazel.WorkspaceCache;\n+import io.flutter.sdk.FlutterSdk;\n+import io.flutter.sdk.FlutterSdkUtil;\n+import io.flutter.utils.MostlySilentOsProcessHandler;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.jetbrains.lang.dart.ide.runner.server.vmService.VmServiceWrapper.LOG;\n+\n+public class DevToolsService {\n+  private class DevToolsServiceListener implements DaemonEvent.Listener {\n+  }\n+\n+  @NotNull private final Project project;\n+  private DaemonApi daemonApi;\n+  private ProcessHandler process;\n+  private DevToolsInstance devToolsInstance;\n+\n+  @NotNull\n+  public static DevToolsService getInstance(@NotNull final Project project) {\n+    return ServiceManager.getService(project, DevToolsService.class);\n+  }\n+\n+  private DevToolsService(@NotNull final Project project) {\n+    this.project = project;\n+    try {", "originalCommit": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMzM0NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540433345", "bodyText": "Hmm.. I'm not sure what this would look like, i.e. how does someone change the project? If they open a new project, the project will get its own devtools server.", "author": "helin24", "createdAt": "2020-12-10T19:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzOTQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NDgwNQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540444805", "bodyText": "if you have two projects open,  having two devtools servers is fine. what I'm worried about is if you open a new project and close your existing project. do we make sure we stop the first devtools server?", "author": "jacob314", "createdAt": "2020-12-10T19:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzOTQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUyNzE2Nw==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540527167", "bodyText": "Oh right, I used ProjectManager.getInstance().addProjectManagerListener to listen for project closing. In there daemon.shutdown is called, which stops the devtools server.", "author": "helin24", "createdAt": "2020-12-10T21:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTgzOTQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MDIxMw==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r539840213", "bodyText": "what happens if the flutter sdk changes once this is already initialized?", "author": "jacob314", "createdAt": "2020-12-10T04:40:48Z", "path": "src/io/flutter/run/daemon/DevToolsService.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.run.daemon;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessHandler;\n+import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.project.ProjectManager;\n+import com.intellij.openapi.project.ProjectManagerListener;\n+import com.intellij.openapi.util.io.FileUtil;\n+import com.intellij.openapi.vfs.CharsetToolkit;\n+import io.flutter.FlutterUtils;\n+import io.flutter.android.IntelliJAndroidSdk;\n+import io.flutter.bazel.Workspace;\n+import io.flutter.bazel.WorkspaceCache;\n+import io.flutter.sdk.FlutterSdk;\n+import io.flutter.sdk.FlutterSdkUtil;\n+import io.flutter.utils.MostlySilentOsProcessHandler;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.jetbrains.lang.dart.ide.runner.server.vmService.VmServiceWrapper.LOG;\n+\n+public class DevToolsService {\n+  private class DevToolsServiceListener implements DaemonEvent.Listener {\n+  }\n+\n+  @NotNull private final Project project;\n+  private DaemonApi daemonApi;\n+  private ProcessHandler process;\n+  private DevToolsInstance devToolsInstance;\n+\n+  @NotNull\n+  public static DevToolsService getInstance(@NotNull final Project project) {\n+    return ServiceManager.getService(project, DevToolsService.class);\n+  }\n+\n+  private DevToolsService(@NotNull final Project project) {\n+    this.project = project;\n+    try {\n+      final GeneralCommandLine command = chooseCommand(project);\n+      assert command != null;\n+      this.process = new MostlySilentOsProcessHandler(command);\n+      daemonApi = new DaemonApi(process);\n+      daemonApi.listen(process, new DevToolsServiceListener());\n+      daemonApi.devToolsServe().thenAccept((DaemonApi.DevToolsAddress address) -> {\n+        if (!project.isOpen()) {\n+          // We should skip starting DevTools (and doing any UI work) if the project has been closed.\n+          return;\n+        }\n+        if (address == null) {\n+          LOG.error(\"DevTools address was null\");\n+        }\n+        else {\n+          devToolsInstance = new DevToolsInstance(address.host, address.port);\n+        }\n+      });\n+    }\n+    catch (ExecutionException e) {\n+      e.printStackTrace();\n+    }\n+\n+    ProjectManager.getInstance().addProjectManagerListener(project, new ProjectManagerListener() {\n+      @Override\n+      public void projectClosing(@NotNull Project project) {\n+        daemonApi.daemonShutdown();\n+        if (!process.isProcessTerminated()) {\n+          process.destroyProcess();\n+        }\n+      }\n+    });\n+  }\n+\n+  private static GeneralCommandLine chooseCommand(@NotNull final Project project) {\n+    final String androidHome = IntelliJAndroidSdk.chooseAndroidHome(project, false);\n+\n+    // Use daemon script if this is a bazel project.\n+    final Workspace workspace = WorkspaceCache.getInstance(project).get();\n+    if (workspace != null) {\n+      final String script = workspace.getDaemonScript();\n+      if (script != null) {\n+        return createCommand(workspace.getRoot().getPath(), script, ImmutableList.of(), androidHome);\n+      }\n+\n+    }\n+\n+    // Otherwise, use the Flutter SDK.\n+    final FlutterSdk sdk = FlutterSdk.getFlutterSdk(project);", "originalCommit": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMzQ5NA==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540433494", "bodyText": "At this point nothing - the server will keep running and presumably there aren't many cases where users need a different version of devtools while working on a project. Are you thinking of some situations where this would be a problem?", "author": "helin24", "createdAt": "2020-12-10T19:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MDIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NDA2OQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540444069", "bodyText": "if you changed your flutter sdk the version of the devtools server much change so you want to make sure you have the one from the new sdk not the old one.", "author": "jacob314", "createdAt": "2020-12-10T19:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MDIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUyOTkxOQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540529919", "bodyText": "Hmm... I'm not sure how to manage this situation. Do we have examples elsewhere of checking whether the flutter sdk has changed?\nI'm also not sure about whether users change their flutter SDK frequently enough to monitor for this? My guess was that SDK would change if users update their flutter version or if they have multiple flutter downloads, but it would also surprise me that the implementation of DevTools would change significantly enough between those versions that a user would need the newest DevTools while in the middle of working on a project. Sounds like there may be some cases I'm not thinking of?", "author": "helin24", "createdAt": "2020-12-10T22:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MDIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MTc0NQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r539841745", "bodyText": "why are we passing android home in. That seems like it has nothing to do with serving devtools. We should either share this code with the regular code to launch the daemon or remove code that is unrelated to the launching a daemon just to serve devtools.", "author": "jacob314", "createdAt": "2020-12-10T04:45:36Z", "path": "src/io/flutter/run/daemon/DevToolsService.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.run.daemon;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessHandler;\n+import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.project.ProjectManager;\n+import com.intellij.openapi.project.ProjectManagerListener;\n+import com.intellij.openapi.util.io.FileUtil;\n+import com.intellij.openapi.vfs.CharsetToolkit;\n+import io.flutter.FlutterUtils;\n+import io.flutter.android.IntelliJAndroidSdk;\n+import io.flutter.bazel.Workspace;\n+import io.flutter.bazel.WorkspaceCache;\n+import io.flutter.sdk.FlutterSdk;\n+import io.flutter.sdk.FlutterSdkUtil;\n+import io.flutter.utils.MostlySilentOsProcessHandler;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.jetbrains.lang.dart.ide.runner.server.vmService.VmServiceWrapper.LOG;\n+\n+public class DevToolsService {\n+  private class DevToolsServiceListener implements DaemonEvent.Listener {\n+  }\n+\n+  @NotNull private final Project project;\n+  private DaemonApi daemonApi;\n+  private ProcessHandler process;\n+  private DevToolsInstance devToolsInstance;\n+\n+  @NotNull\n+  public static DevToolsService getInstance(@NotNull final Project project) {\n+    return ServiceManager.getService(project, DevToolsService.class);\n+  }\n+\n+  private DevToolsService(@NotNull final Project project) {\n+    this.project = project;\n+    try {\n+      final GeneralCommandLine command = chooseCommand(project);\n+      assert command != null;\n+      this.process = new MostlySilentOsProcessHandler(command);\n+      daemonApi = new DaemonApi(process);\n+      daemonApi.listen(process, new DevToolsServiceListener());\n+      daemonApi.devToolsServe().thenAccept((DaemonApi.DevToolsAddress address) -> {\n+        if (!project.isOpen()) {\n+          // We should skip starting DevTools (and doing any UI work) if the project has been closed.\n+          return;\n+        }\n+        if (address == null) {\n+          LOG.error(\"DevTools address was null\");\n+        }\n+        else {\n+          devToolsInstance = new DevToolsInstance(address.host, address.port);\n+        }\n+      });\n+    }\n+    catch (ExecutionException e) {\n+      e.printStackTrace();\n+    }\n+\n+    ProjectManager.getInstance().addProjectManagerListener(project, new ProjectManagerListener() {\n+      @Override\n+      public void projectClosing(@NotNull Project project) {\n+        daemonApi.daemonShutdown();\n+        if (!process.isProcessTerminated()) {\n+          process.destroyProcess();\n+        }\n+      }\n+    });\n+  }\n+\n+  private static GeneralCommandLine chooseCommand(@NotNull final Project project) {\n+    final String androidHome = IntelliJAndroidSdk.chooseAndroidHome(project, false);", "originalCommit": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMzQyMQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r540433421", "bodyText": "Ah I didn't understand why this was relevant for DeviceService (where I copied this code from), but I think I can just delete this.", "author": "helin24", "createdAt": "2020-12-10T19:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MTc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0MjUyOQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5112#discussion_r539842529", "bodyText": "How can a caller of this know whether the devtools instance has started yet or not?\nPerhaps vend a CompletableFuture with the devToolsInstance or a boolean indicating the service has started.", "author": "jacob314", "createdAt": "2020-12-10T04:48:05Z", "path": "src/io/flutter/run/daemon/DevToolsService.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.run.daemon;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessHandler;\n+import com.intellij.openapi.components.ServiceManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.project.ProjectManager;\n+import com.intellij.openapi.project.ProjectManagerListener;\n+import com.intellij.openapi.util.io.FileUtil;\n+import com.intellij.openapi.vfs.CharsetToolkit;\n+import io.flutter.FlutterUtils;\n+import io.flutter.android.IntelliJAndroidSdk;\n+import io.flutter.bazel.Workspace;\n+import io.flutter.bazel.WorkspaceCache;\n+import io.flutter.sdk.FlutterSdk;\n+import io.flutter.sdk.FlutterSdkUtil;\n+import io.flutter.utils.MostlySilentOsProcessHandler;\n+import org.jetbrains.annotations.NotNull;\n+\n+import static com.jetbrains.lang.dart.ide.runner.server.vmService.VmServiceWrapper.LOG;\n+\n+public class DevToolsService {\n+  private class DevToolsServiceListener implements DaemonEvent.Listener {\n+  }\n+\n+  @NotNull private final Project project;\n+  private DaemonApi daemonApi;\n+  private ProcessHandler process;\n+  private DevToolsInstance devToolsInstance;", "originalCommit": "d54d9554bfaa91e906466af5b152ff8fd8fe1447", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "adf5fe0c7c96d9aff50770a61ac95acbc7cd3f99", "url": "https://github.com/flutter/flutter-intellij/commit/adf5fe0c7c96d9aff50770a61ac95acbc7cd3f99", "message": "Make instance completable, remove android_home", "committedDate": "2020-12-10T19:20:36Z", "type": "commit"}, {"oid": "f79f5fce1e4abeaeac5a1e2d2b946e0a1ea6ed91", "url": "https://github.com/flutter/flutter-intellij/commit/f79f5fce1e4abeaeac5a1e2d2b946e0a1ea6ed91", "message": "Add null command check for unit tests", "committedDate": "2020-12-10T19:34:05Z", "type": "commit"}, {"oid": "bea3318a9686935410da2457860c0d18a60e724b", "url": "https://github.com/flutter/flutter-intellij/commit/bea3318a9686935410da2457860c0d18a60e724b", "message": "Fix tests", "committedDate": "2020-12-10T22:22:03Z", "type": "commit"}, {"oid": "10592e78baca6d6588c214b1d2b45238eca0fb66", "url": "https://github.com/flutter/flutter-intellij/commit/10592e78baca6d6588c214b1d2b45238eca0fb66", "message": "Revert to DaemonShutdown class", "committedDate": "2020-12-10T23:35:51Z", "type": "commit"}]}