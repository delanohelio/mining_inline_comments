{"pr_number": 216, "pr_title": "Validate input values when updating IDP claims config", "pr_createdAt": "2020-10-20T09:05:41Z", "pr_url": "https://github.com/wso2/identity-api-server/pull/216", "timeline": [{"oid": "cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "url": "https://github.com/wso2/identity-api-server/commit/cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "message": "Validate input values when updating IDP claims config", "committedDate": "2020-10-20T09:05:02Z", "type": "commit"}, {"oid": "90ef844c9f65a7ca50719a01ca71e8c70a3d319d", "url": "https://github.com/wso2/identity-api-server/commit/90ef844c9f65a7ca50719a01ca71e8c70a3d319d", "message": "[FIX] Formatting issue", "committedDate": "2020-10-20T10:06:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4MDI4OQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508380289", "bodyText": "Can use CollectionUtils.isEmpty", "author": "janakamarasena", "createdAt": "2020-10-20T10:15:35Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2775,119 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        String userClaimURI = claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (claimMappings == null || claimMappings.isEmpty()) {", "originalCommit": "90ef844c9f65a7ca50719a01ca71e8c70a3d319d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4MjYzOQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508382639", "bodyText": "can userClaimURI or roleClaimURI be null?", "author": "janakamarasena", "createdAt": "2020-10-20T10:19:40Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2775,119 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        String userClaimURI = claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (claimMappings == null || claimMappings.isEmpty()) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (claimURIs.add(userClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            if (claimURIs.add(roleClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            return;\n+        }\n+        validateUserAndRoleClaims(userClaimURI, roleClaimURI, claimMappings);\n+\n+        // Validate LocalClaim objects against local claim URIs.\n+        List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+        Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+        for (org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping claimMapping : claimMappings) {\n+\n+            // If a claim URI can be added to the existing claimURIs, then that's a not existing URI.\n+            if (claimURIs.add(claimMapping.getLocalClaim().getUri())) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_CLAIM_URI.getCode(),\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_CLAIM_URI.getDescription());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Validate whether the userClaimURI and the roleClaimURI align with the claim mappings.\n+     *\n+     * @param userClaimURI  User claim URI.\n+     * @param roleClaimURI  Role claim URI.\n+     * @param claimMappings List of claim mapping for the IDP.\n+     * @throws IdentityProviderManagementClientException If the serClaimURI and the roleClaimURI does not match with\n+     *                                                   the claim mappings.\n+     */\n+    private void validateUserAndRoleClaims(String userClaimURI, String roleClaimURI,\n+                                List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings)\n+            throws IdentityProviderManagementClientException {\n+\n+        boolean isValidUserClaimURI = false;\n+        boolean isValidRoleClaimURI = false;\n+        for (org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping claimMapping : claimMappings) {\n+            if (userClaimURI.equals(claimMapping.getIdpClaim())) {", "originalCommit": "90ef844c9f65a7ca50719a01ca71e8c70a3d319d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0Nzc5Mg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508347792", "bodyText": "duplicate code", "author": "pulasthi7", "createdAt": "2020-10-20T09:25:57Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.common/src/main/java/org/wso2/carbon/identity/api/server/idp/common/Constants.java", "diffHunk": "@@ -116,6 +116,16 @@\n         ERROR_CODE_OUTBOUND_PROVISIONING_CONFIG_NOT_FOUND(\"60029\", \"Unable to update Outbound \" +\n                 \"Provisioning Connector\", \"Outbound Provisioning Connector properties have not specified \" +\n                 \"for connector : %s\"),\n+        ERROR_CODE_INVALID_USER_CLAIM_URI(\"60030\", \"Invalid user ID claim URI\",\n+                \"User ID claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_INVALID_ROLE_CLAIM_URI(\"60031\", \"Invalid role claim URI\",\n+                \"Role claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_NOT_EXISTING_CLAIM_URI(\"IDP-60032\", \"Invalid claim URI\",\n+                \"One or more local claim URIs does not exist\"),\n+        ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI(\"IDP-60033\", \"Invlaid user ID claim URI\",\n+                \"User ID claim URI is not a local claim for tenant: %s\"),\n+        ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI(\"IDP-60033\", \"Invalid role claim URI\",", "originalCommit": "cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0ODgyMg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508348822", "bodyText": "any reason to use 9 here instead 56? If so shall we move this to the relevant place so that the codes are ordered", "author": "pulasthi7", "createdAt": "2020-10-20T09:27:26Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.common/src/main/java/org/wso2/carbon/identity/api/server/idp/common/Constants.java", "diffHunk": "@@ -213,7 +223,10 @@\n                 \"Error occurred while updating the IDP template with identifier %s.\"),\n         ERROR_CODE_ERROR_RETRIEVING_IDP_TEMPLATE(\"65054\", \"Unable to retrieve IDP template.\",\n                 \"Error occurred while retrieving the IDP template with identifier %s\"),\n-        ERROR_CODE_ERROR_INVALID_SEARCH_FILTER(\"65055\", \"Search request validation failed.\", \"Invalid search filter.\");\n+        ERROR_CODE_ERROR_INVALID_SEARCH_FILTER(\"65055\", \"Search request validation failed.\",\n+                \"Invalid search filter.\"),\n+        ERROR_CODE_VALIDATING_LOCAL_CLAIM_URIS(\"IDP-65009\", \"Error while validation local claim URIs\",", "originalCommit": "cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM0OTk2Nw==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508349967", "bodyText": "better to use contains() instead", "author": "pulasthi7", "createdAt": "2020-10-20T09:29:03Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2775,119 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        String userClaimURI = claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (claimMappings == null || claimMappings.isEmpty()) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (claimURIs.add(userClaimURI)) {", "originalCommit": "cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM1MDI1Ng==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508350256", "bodyText": "better to use contains()", "author": "pulasthi7", "createdAt": "2020-10-20T09:29:31Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2775,119 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        String userClaimURI = claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (claimMappings == null || claimMappings.isEmpty()) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (claimURIs.add(userClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            if (claimURIs.add(roleClaimURI)) {", "originalCommit": "cf89cbfe61738f04e0bf4d2ab0a71b117dde4c19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1Nzk1Ng==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508457956", "bodyText": "Use the util method Collections.emptyList() instead", "author": "pulasthi7", "createdAt": "2020-10-20T12:28:18Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2775,119 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        String userClaimURI = claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (claimMappings == null || claimMappings.isEmpty()) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (claimURIs.add(userClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            if (claimURIs.add(roleClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            return;\n+        }\n+        validateUserAndRoleClaims(userClaimURI, roleClaimURI, claimMappings);\n+\n+        // Validate LocalClaim objects against local claim URIs.\n+        List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+        Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+        for (org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping claimMapping : claimMappings) {\n+\n+            // If a claim URI can be added to the existing claimURIs, then that's a not existing URI.\n+            if (claimURIs.add(claimMapping.getLocalClaim().getUri())) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_CLAIM_URI.getCode(),\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_CLAIM_URI.getDescription());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Validate whether the userClaimURI and the roleClaimURI align with the claim mappings.\n+     *\n+     * @param userClaimURI  User claim URI.\n+     * @param roleClaimURI  Role claim URI.\n+     * @param claimMappings List of claim mapping for the IDP.\n+     * @throws IdentityProviderManagementClientException If the serClaimURI and the roleClaimURI does not match with\n+     *                                                   the claim mappings.\n+     */\n+    private void validateUserAndRoleClaims(String userClaimURI, String roleClaimURI,\n+                                List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings)\n+            throws IdentityProviderManagementClientException {\n+\n+        boolean isValidUserClaimURI = false;\n+        boolean isValidRoleClaimURI = false;\n+        for (org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping claimMapping : claimMappings) {\n+            if (userClaimURI.equals(claimMapping.getIdpClaim())) {\n+                isValidUserClaimURI = true;\n+            }\n+            if (roleClaimURI.equals(claimMapping.getIdpClaim())) {\n+                isValidRoleClaimURI = true;\n+            }\n+        }\n+        if (!isValidUserClaimURI) {\n+            throw new IdentityProviderManagementClientException(\n+                    Constants.ErrorMessage.ERROR_CODE_INVALID_USER_CLAIM_URI.getCode(),\n+                    String.format(Constants.ErrorMessage.ERROR_CODE_INVALID_USER_CLAIM_URI.getDescription(),\n+                            userClaimURI));\n+        }\n+        if (!isValidRoleClaimURI) {\n+            throw new IdentityProviderManagementClientException(\n+                    Constants.ErrorMessage.ERROR_CODE_INVALID_ROLE_CLAIM_URI.getCode(),\n+                    String.format(Constants.ErrorMessage.ERROR_CODE_INVALID_ROLE_CLAIM_URI.getMessage(), roleClaimURI));\n+        }\n+    }\n+\n+    /**\n+     * Get the local claim URIs of the tenant.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @return List of local claim URIs.\n+     * @throws IdentityProviderManagementServerException If an error occurred while getting the claims list.\n+     */\n+    private List<LocalClaim> getLocalClaimURIs(String tenantDomain) throws IdentityProviderManagementServerException {\n+\n+        try {\n+            List<LocalClaim> localClaimsList =\n+                    IdentityProviderServiceHolder.getClaimMetadataManagementService().getLocalClaims(tenantDomain);\n+            if (localClaimsList.isEmpty()) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"No local claims found for tenant:\" + tenantDomain + \".Therefore, skipping \" +\n+                            \"local claim URI validation.\");\n+                }\n+                return new ArrayList<>();", "originalCommit": "90ef844c9f65a7ca50719a01ca71e8c70a3d319d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "url": "https://github.com/wso2/identity-api-server/commit/ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "message": "Addressing comments", "committedDate": "2020-10-20T15:21:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0Mjg5NQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508642895", "bodyText": "Shoudn't this be not contains?\n!claimURIs.contains(userClaimURI)", "author": "IsuraD", "createdAt": "2020-10-20T15:55:46Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2776,125 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        if (claims == null) {\n+            return;\n+        }\n+        String userClaimURI = claims.getUserIdClaim() == null ? null : claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim() == null ? null : claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (CollectionUtils.isEmpty(claimMappings)) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (StringUtils.isNotBlank(userClaimURI) && claimURIs.contains(userClaimURI)) {", "originalCommit": "ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczMDg2MQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508730861", "bodyText": "Fixed in f44b32e", "author": "somindatommy", "createdAt": "2020-10-20T18:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0Mjg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0MzE4NQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508643185", "bodyText": "Shoudn't this be not contains?\n!claimURIs.contains(roleClaimURI)", "author": "IsuraD", "createdAt": "2020-10-20T15:56:02Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2776,125 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        if (claims == null) {\n+            return;\n+        }\n+        String userClaimURI = claims.getUserIdClaim() == null ? null : claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim() == null ? null : claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (CollectionUtils.isEmpty(claimMappings)) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (StringUtils.isNotBlank(userClaimURI) && claimURIs.contains(userClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            if (StringUtils.isNotBlank(roleClaimURI) && claimURIs.contains(roleClaimURI)) {", "originalCommit": "ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczMDc4Mg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508730782", "bodyText": "Fixed in f44b32e", "author": "somindatommy", "createdAt": "2020-10-20T18:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0MzE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0ODk4MQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508648981", "bodyText": "Shoud be not contain?\nif (!claimURIs.contains(claimMapping.getLocalClaim().getUri())) {", "author": "IsuraD", "createdAt": "2020-10-20T16:01:52Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2772,4 +2776,125 @@ private static String includeData(Constants.ErrorMessage error, String data) {\n         }\n         return message;\n     }\n+\n+    /**\n+     * Validate the claim configs of an IDP.\n+     *\n+     * @param tenantDomain Tenant domain.\n+     * @param claims       Claim configs.\n+     * @throws IdentityProviderManagementException If an error while validating the claim configs or if an invalid\n+     *                                             config is found.\n+     */\n+    private void validateClaims(String tenantDomain, Claims claims) throws IdentityProviderManagementException {\n+\n+        if (claims == null) {\n+            return;\n+        }\n+        String userClaimURI = claims.getUserIdClaim() == null ? null : claims.getUserIdClaim().getUri();\n+        String roleClaimURI = claims.getRoleClaim() == null ? null : claims.getRoleClaim().getUri();\n+        List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings = claims.getMappings();\n+\n+        // EMPTY claimMappings indicate that the IDP is using local claim dialect.\n+        if (CollectionUtils.isEmpty(claimMappings)) {\n+            List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+            Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+            // Validate userClaimURI and roleClaimURI.\n+            if (StringUtils.isNotBlank(userClaimURI) && claimURIs.contains(userClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_USER_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            if (StringUtils.isNotBlank(roleClaimURI) && claimURIs.contains(roleClaimURI)) {\n+                throw new IdentityProviderManagementClientException(\n+                        Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getCode(),\n+                        String.format(Constants.ErrorMessage.ERROR_CODE_NOT_EXISTING_ROLE_CLAIM_URI.getDescription(),\n+                                tenantDomain));\n+            }\n+            return;\n+        }\n+        validateUserAndRoleClaims(userClaimURI, roleClaimURI, claimMappings);\n+\n+        // Validate LocalClaim objects against local claim URIs.\n+        List<LocalClaim> localClaimsList = getLocalClaimURIs(tenantDomain);\n+        Set<String> claimURIs = localClaimsList.stream().map(LocalClaim::getClaimURI).collect(Collectors.toSet());\n+        for (org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping claimMapping : claimMappings) {\n+\n+            // If a claim URI can be added to the existing claimURIs, then that's a not existing URI.\n+            if (claimURIs.contains(claimMapping.getLocalClaim().getUri())) {", "originalCommit": "ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczMDcwNg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508730706", "bodyText": "Fixed in f44b32e", "author": "somindatommy", "createdAt": "2020-10-20T18:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0ODk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1NTIyOQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508655229", "bodyText": "grammer :  URIs does not exist", "author": "IsuraD", "createdAt": "2020-10-20T16:08:08Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.common/src/main/java/org/wso2/carbon/identity/api/server/idp/common/Constants.java", "diffHunk": "@@ -116,6 +116,16 @@\n         ERROR_CODE_OUTBOUND_PROVISIONING_CONFIG_NOT_FOUND(\"60029\", \"Unable to update Outbound \" +\n                 \"Provisioning Connector\", \"Outbound Provisioning Connector properties have not specified \" +\n                 \"for connector : %s\"),\n+        ERROR_CODE_INVALID_USER_CLAIM_URI(\"60030\", \"Invalid user ID claim URI\",\n+                \"User ID claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_INVALID_ROLE_CLAIM_URI(\"60031\", \"Invalid role claim URI\",\n+                \"Role claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_NOT_EXISTING_CLAIM_URI(\"IDP-60032\", \"Invalid claim URI\",\n+                \"One or more local claim URIs does not exist\"),", "originalCommit": "ee3ee198465d08f2d8a69a1ddcc4f5a61588dbc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczMDQwMQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508730401", "bodyText": "Fixed in f44b32e", "author": "somindatommy", "createdAt": "2020-10-20T18:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1NTIyOQ=="}], "type": "inlineReview"}, {"oid": "f44b32e0efda15349b0bbf3d014763ee0b8297ad", "url": "https://github.com/wso2/identity-api-server/commit/f44b32e0efda15349b0bbf3d014763ee0b8297ad", "message": "Refactoring validation logic", "committedDate": "2020-10-20T17:59:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2OTcwMg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508969702", "bodyText": "Shall we rename to isUserClaimURINotDefined, isRoleClaimURINotDefined", "author": "IsuraD", "createdAt": "2020-10-21T03:37:36Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.v1/src/main/java/org/wso2/carbon/identity/api/server/idp/v1/core/ServerIdpManagementService.java", "diffHunk": "@@ -2842,26 +2842,32 @@ private void validateUserAndRoleClaims(String userClaimURI, String roleClaimURI,\n                                List<org.wso2.carbon.identity.api.server.idp.v1.model.ClaimMapping> claimMappings)\n             throws IdentityProviderManagementClientException {\n \n-        boolean isUserClaimURISpecified = StringUtils.isNotBlank(userClaimURI);\n-        boolean isRoleClaimURISpecified = StringUtils.isNotBlank(roleClaimURI);\n-        boolean isValidUserClaimURI = false;\n-        boolean isValidRoleClaimURI = false;\n+        /*\n+         * Not defining the userId claim or role claim is a valid claim update scenario. Therefore, considering it as a\n+         * valid claim URI. When the claims are defined, initial validation is considered as false (Invalid).\n+         */\n+        boolean isValidUserClaimURI = StringUtils.isBlank(userClaimURI);", "originalCommit": "f44b32e0efda15349b0bbf3d014763ee0b8297ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3MDI0Ng==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508970246", "bodyText": "or. better to use\nboolean isUserClaimURIDefined = StringUtils.isNotBlank(userClaimURI);\nboolean isRoleClaimURIDefined = StringUtils.isNotBlank(roleClaimURI);", "author": "IsuraD", "createdAt": "2020-10-21T03:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk2OTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NTA0NQ==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508975045", "bodyText": "why do these codes have the prefix and the previous ones don't?", "author": "pulasthi7", "createdAt": "2020-10-21T03:58:52Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.common/src/main/java/org/wso2/carbon/identity/api/server/idp/common/Constants.java", "diffHunk": "@@ -116,6 +116,16 @@\n         ERROR_CODE_OUTBOUND_PROVISIONING_CONFIG_NOT_FOUND(\"60029\", \"Unable to update Outbound \" +\n                 \"Provisioning Connector\", \"Outbound Provisioning Connector properties have not specified \" +\n                 \"for connector : %s\"),\n+        ERROR_CODE_INVALID_USER_CLAIM_URI(\"60030\", \"Invalid user ID claim URI\",\n+                \"User ID claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_INVALID_ROLE_CLAIM_URI(\"60031\", \"Invalid role claim URI\",\n+                \"Role claim URI: %s does not match with the claim mappings\"),\n+        ERROR_CODE_NOT_EXISTING_CLAIM_URI(\"IDP-60032\", \"Invalid claim URI\",", "originalCommit": "f44b32e0efda15349b0bbf3d014763ee0b8297ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMjMzMg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r509002332", "bodyText": "Fixed in 0d758b5", "author": "somindatommy", "createdAt": "2020-10-21T05:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NTA0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMjY0NA==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r509002644", "bodyText": "Ideally, they should have the code. AFAIK at the time of the initial implementation, the scenario prefix concept was not there.", "author": "somindatommy", "createdAt": "2020-10-21T05:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NTA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NTIwMg==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r508975202", "bodyText": "Similar as above comment here", "author": "pulasthi7", "createdAt": "2020-10-21T03:59:35Z", "path": "components/org.wso2.carbon.identity.api.server.idp/org.wso2.carbon.identity.api.server.idp.common/src/main/java/org/wso2/carbon/identity/api/server/idp/common/Constants.java", "diffHunk": "@@ -213,7 +223,10 @@\n                 \"Error occurred while updating the IDP template with identifier %s.\"),\n         ERROR_CODE_ERROR_RETRIEVING_IDP_TEMPLATE(\"65054\", \"Unable to retrieve IDP template.\",\n                 \"Error occurred while retrieving the IDP template with identifier %s\"),\n-        ERROR_CODE_ERROR_INVALID_SEARCH_FILTER(\"65055\", \"Search request validation failed.\", \"Invalid search filter.\");\n+        ERROR_CODE_ERROR_INVALID_SEARCH_FILTER(\"65055\", \"Search request validation failed.\",\n+                \"Invalid search filter.\"),\n+        ERROR_CODE_VALIDATING_LOCAL_CLAIM_URIS(\"IDP-65056\", \"Error while validation local claim URIs\",", "originalCommit": "f44b32e0efda15349b0bbf3d014763ee0b8297ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAwMjk1NA==", "url": "https://github.com/wso2/identity-api-server/pull/216#discussion_r509002954", "bodyText": "Addressed in the previous comment. I have not specified the existing code for ERROR_CODE_ERROR_INVALID_SEARCH_FILTER", "author": "somindatommy", "createdAt": "2020-10-21T05:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk3NTIwMg=="}], "type": "inlineReview"}, {"oid": "0d758b5bfff01a26c5caa8d68cf92ad084d86927", "url": "https://github.com/wso2/identity-api-server/commit/0d758b5bfff01a26c5caa8d68cf92ad084d86927", "message": "Refactoring validation logic and improving error codes", "committedDate": "2020-10-21T05:39:18Z", "type": "commit"}]}