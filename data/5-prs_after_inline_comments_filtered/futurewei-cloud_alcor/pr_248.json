{"pr_number": 248, "pr_title": "Microsevice Integration of Port Manager and Data-Plane Manager", "pr_createdAt": "2020-06-12T04:29:17Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/248", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNjA3MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439206071", "bodyText": "@chenpiaoping Check a few latest commits that were not included here: https://github.com/futurewei-cloud/alcor/pull/244/commits, particularly this one cdbd96e", "author": "xieus", "createdAt": "2020-06-12T04:55:01Z", "path": "web/src/main/java/com/futurewei/alcor/web/entity/dataplane/InternalPortEntity.java", "diffHunk": "@@ -15,24 +15,27 @@\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n import com.futurewei.alcor.web.entity.route.RouteEntity;\n-import com.futurewei.alcor.web.entity.vpc.VpcEntity;\n import lombok.Data;\n \n+import java.util.ArrayList;\n import java.util.List;\n-import java.util.Set;\n \n @Data\n-public class InternalPortEntityNB extends PortEntity {\n+public class InternalPortEntity extends PortEntity {\n \n-  @JsonProperty(\"routes\")\n-  private List<RouteEntity> routes;\n+    @JsonProperty(\"routes\")\n+    private List<RouteEntity> routes;\n \n-  @JsonProperty(\"neighbor_info\")\n-  private List<NeighborInfo> neighborIps;\n+    @JsonProperty(\"neighbor_info\")\n+    private List<NeighborInfo> neighborInfos;\n \n-  @JsonProperty(\"binding_host_ip\")\n-  private String bindingHostIP;\n+    @JsonProperty(\"binding_host_ip\")\n+    private String bindingHostIP;\n \n-  private Set<InternalSubnetEntityNB> subnetEntities;", "originalCommit": "752095bf4025e071d1dbb3baf638cb488c5d27ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIyNTY1Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439225652", "bodyText": "Why does InternalPortEntity need the fields vpcEntities and subnetEntities\uff1fDon't they conflict with vpcEntities and subnetEntities in NetworkConfiguration?", "author": "chenpiaoping", "createdAt": "2020-06-12T06:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNjA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0NjAwMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439246002", "bodyText": "Good question. Asked the same question when I saw them at the first place. Those two fields are internal fields which are not exposed to other services (port manager don't have to pass to DPM. DPM uses those two fields for internal bookkeeping purpose. @haboy52581", "author": "xieus", "createdAt": "2020-06-12T07:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNjA3MQ=="}], "type": "inlineReview"}, {"oid": "6dca6f3d3452f04ceed9a12e3230355ebbd5ea00", "url": "https://github.com/futurewei-cloud/alcor/commit/6dca6f3d3452f04ceed9a12e3230355ebbd5ea00", "message": "Integration of Port Manager and Data-Plane Manager", "committedDate": "2020-06-12T06:40:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0OTczMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439249731", "bodyText": "Lock on portCache may not be sufficient. If multiple ports (in the same vpc) are created in separate calls, those calls will operate on different portCache row but the same neighborCache row.", "author": "xieus", "createdAt": "2020-06-12T07:18:31Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/repo/PortRepository.java", "diffHunk": "@@ -18,62 +18,199 @@\n import com.futurewei.alcor.common.db.CacheException;\n import com.futurewei.alcor.common.db.CacheFactory;\n import com.futurewei.alcor.common.db.ICache;\n-import com.futurewei.alcor.common.db.repo.ICacheRepository;\n+import com.futurewei.alcor.common.db.Transaction;\n+import com.futurewei.alcor.portmanager.entity.PortNeighbors;\n+import com.futurewei.alcor.web.entity.dataplane.NeighborInfo;\n import com.futurewei.alcor.web.entity.port.PortEntity;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.context.annotation.ComponentScan;\n import org.springframework.stereotype.Repository;\n import javax.annotation.PostConstruct;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n import java.util.stream.Collectors;\n \n @ComponentScan(value=\"com.futurewei.alcor.common.db\")\n @Repository\n-public class PortRepository implements ICacheRepository<PortEntity> {\n+public class PortRepository {\n     private static final Logger LOG = LoggerFactory.getLogger(PortRepository.class);\n \n-    private ICache<String, PortEntity> cache;\n+    private ICache<String, PortEntity> portCache;\n+    private ICache<String, PortNeighbors> neighborCache;\n \n     @Autowired\n     public PortRepository(CacheFactory cacheFactory) {\n-        cache = cacheFactory.getCache(PortEntity.class);\n+        portCache = cacheFactory.getCache(PortEntity.class);\n     }\n \n     @PostConstruct\n     private void init() {\n         LOG.info(\"PortRepository init done\");\n     }\n \n-    @Override\n-    public PortEntity findItem(String id) throws CacheException {\n-        return cache.get(id);\n+    public PortEntity findPortEntity(String portId) throws CacheException {\n+        return portCache.get(portId);\n     }\n \n-    @Override\n-    public Map<String, PortEntity> findAllItems() throws CacheException {\n-        return cache.getAll();\n+    public Map<String, PortEntity> findAllPortEntities() throws CacheException {\n+        return portCache.getAll();\n     }\n \n-    @Override\n-    public void addItem(PortEntity portEntity) throws CacheException {\n-        cache.put(portEntity.getId(), portEntity);\n+    public void createPortAndNeighbor(PortEntity portEntity, NeighborInfo neighborInfo) throws Exception {\n+        try (Transaction tx = portCache.getTransaction().start()) {", "originalCommit": "752095bf4025e071d1dbb3baf638cb488c5d27ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzA3MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439253071", "bodyText": "This lock can lock multiple caches, It should be taken out of the cache.", "author": "chenpiaoping", "createdAt": "2020-06-12T07:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0OTczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI2MTQzNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439261437", "bodyText": "oh could you pls point me to the right codes that explain a bit more about multi-cache locking? Just out of curiosity.", "author": "xieus", "createdAt": "2020-06-12T07:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0OTczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI2NzI1NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439267255", "bodyText": "https://github.com/futurewei-cloud/alcor/blob/master/lib/src/main/java/com/futurewei/alcor/common/db/ignite/IgniteTransaction.java", "author": "chenpiaoping", "createdAt": "2020-06-12T07:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0OTczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzExNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439253117", "bodyText": "Try to use \"this.getNodeInfos\" if possible.", "author": "xieus", "createdAt": "2020-06-12T07:26:42Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -146,21 +205,25 @@ public PortWebJson createPort(String projectId, PortWebJson portWebJson) throws\n         portEntity.setProjectId(projectId);\n \n         try {\n-            createPortAsync(portEntity, executor, rollbacks);\n+            this.createPortAsync(portEntity, executor, rollbacks, true);\n \n             //Wait for all async functions to finish\n             List<Object> entities = executor.joinAll();\n             entities.add(portEntity);\n \n-            //Build GoalState and Send it to DPM\n+            NeighborInfo neighborInfo = null;\n             if (portEntity.getBindingHostId() != null) {\n-                Goalstate.GoalState goalState = GoalStateUtil.buildGoalState(entities, Common.OperationType.CREATE);\n+                Map<String, NodeInfo> nodeInfoMap = getNodeInfos(entities);", "originalCommit": "752095bf4025e071d1dbb3baf638cb488c5d27ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI2NzczNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439267735", "bodyText": "ok", "author": "chenpiaoping", "createdAt": "2020-06-12T07:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1MzExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI1NTY5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439255692", "bodyText": "Confirmed. This is needed. @chenpiaoping @haboy52581", "author": "xieus", "createdAt": "2020-06-12T07:32:43Z", "path": "web/src/main/java/com/futurewei/alcor/web/entity/dataplane/NeighborInfo.java", "diffHunk": "@@ -26,4 +25,50 @@\n \n   @JsonProperty(\"port_id\")\n   private String portId;\n+\n+  @JsonProperty(\"port_mac\")\n+  private String portMac;", "originalCommit": "752095bf4025e071d1dbb3baf638cb488c5d27ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3815368b1ab385394b9f84e3a4d667fc4af90ac8", "url": "https://github.com/futurewei-cloud/alcor/commit/3815368b1ab385394b9f84e3a4d667fc4af90ac8", "message": "rebase from master", "committedDate": "2020-06-12T07:54:35Z", "type": "commit"}, {"oid": "3815368b1ab385394b9f84e3a4d667fc4af90ac8", "url": "https://github.com/futurewei-cloud/alcor/commit/3815368b1ab385394b9f84e3a4d667fc4af90ac8", "message": "rebase from master", "committedDate": "2020-06-12T07:54:35Z", "type": "forcePushed"}, {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "url": "https://github.com/futurewei-cloud/alcor/commit/6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "message": "if no security group is configured in port, bind it to the default security group", "committedDate": "2020-06-12T10:08:17Z", "type": "commit"}, {"oid": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "url": "https://github.com/futurewei-cloud/alcor/commit/6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "message": "if no security group is configured in port, bind it to the default security group", "committedDate": "2020-06-12T10:08:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ0MzA0Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/248#discussion_r439443046", "bodyText": "Do we disable temporarily for some reason?", "author": "xieus", "createdAt": "2020-06-12T14:11:23Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/PortManagerApplication.java", "diffHunk": "@@ -1,13 +1,10 @@\n package com.futurewei.alcor.portmanager;\n \n-import org.mybatis.spring.annotation.MapperScan;\n import org.springframework.boot.SpringApplication;\n import org.springframework.boot.autoconfigure.SpringBootApplication;\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n \n @SpringBootApplication\n-@EnableTransactionManagement", "originalCommit": "6f5a81f32cc854a84f4a4e5437540bb89262b7f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7148558ea03dbb2b2eb2241cdd3fc6fea3ac2ded", "url": "https://github.com/futurewei-cloud/alcor/commit/7148558ea03dbb2b2eb2241cdd3fc6fea3ac2ded", "message": "Add dpm service url in port manager config file", "committedDate": "2020-06-12T15:32:09Z", "type": "commit"}]}