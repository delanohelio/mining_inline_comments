{"pr_number": 180, "pr_title": "[Microservice] Port Manager", "pr_createdAt": "2020-04-29T09:00:39Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/180", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2NDg3OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r417464878", "bodyText": "Remove lines.", "author": "xieus", "createdAt": "2020-04-29T16:53:05Z", "path": "lib/src/main/java/com/futurewei/alcor/common/entity/HostState.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.common.entity;\n+\n+public class HostState {\n+    private String hostIp;\n+    private String dpType;\n+\n+", "originalCommit": "e3499a55996576c7acb48f49b724e5c3df2c8667", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MTMwOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r417471308", "bodyText": "Need an indent", "author": "xieus", "createdAt": "2020-04-29T17:02:48Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/exception/AllocateIpAddrException.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.exception;\n+\n+import org.springframework.http.HttpStatus;\n+import org.springframework.web.bind.annotation.ResponseStatus;\n+\n+@ResponseStatus(code= HttpStatus.INTERNAL_SERVER_ERROR, reason=\"Allocate ip address error\")\n+public class AllocateIpAddrException extends Exception {", "originalCommit": "e3499a55996576c7acb48f49b724e5c3df2c8667", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r418344753", "bodyText": "The idea of using a rollback stack to keep track of potential rollback call is good.\nThe issue, however, is that it might not work in current implementation. If an exception is thrown before rollbacks.push(ipAddressRollback), then the stack doesn't have ipAddressRollback therefore won't be able to trigger rollback during exception handling.", "author": "xieus", "createdAt": "2020-04-30T23:27:49Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,572 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+\n+import com.futurewei.alcor.common.entity.*;\n+import com.futurewei.alcor.common.rest.IpAddressRest;\n+import com.futurewei.alcor.common.rest.MacAddressRest;\n+import com.futurewei.alcor.common.rest.VpcRest;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.portmanager.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.portmanager.utils.Ipv6AddrUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.common.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    @Autowired\n+    private IpAddressRest ipAddressRest;\n+\n+    @Autowired\n+    private MacAddressRest macAddressRest;\n+\n+    @Autowired\n+    private VpcRest vpcRest;\n+\n+    private int getIpVersion(String ipAddress) throws Exception {\n+        if (Ipv4AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV4.getVersion();\n+        } else if (Ipv6AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV6.getVersion();\n+        } else {\n+            throw new IpAddrInvalidException();\n+        }\n+    }\n+\n+    private String getRangeIdBySubnetId(String subnetId, int ipVersion) throws Exception {\n+        if (IpVersion.IPV4.getVersion() == ipVersion) {\n+            return subnetId; //FIXME:return the right rangeId get from subnet manager\n+        } else if (IpVersion.IPV6.getVersion() == ipVersion) {\n+            return subnetId; //FIXME:return the right rangeId get from subnet manager\n+        }\n+\n+        throw new IpVersionInvalidException();\n+    }\n+\n+    private void verifyIpAddresses(List<PortState.FixedIp> fixedIps, Stack<PortStateRollback> rollbacks) throws Exception {\n+        for (PortState.FixedIp fixedIp: fixedIps) {\n+            int ipVersion = getIpVersion(fixedIp.getIpAddress());\n+            String rangeId = getRangeIdBySubnetId(fixedIp.getSubnetId(), ipVersion);\n+\n+            IpAddrRequest result = ipAddressRest.allocateIpAddress(rangeId, fixedIp.getIpAddress());\n+\n+            AllocateIpAddrRollback ipAddressRollback = new AllocateIpAddrRollback(ipAddressRest);\n+            ipAddressRollback.putAllocatedIpAddress(result);\n+            rollbacks.push(ipAddressRollback);\n+        }\n+    }\n+\n+    private String getRangeIdForPort(String vpcId) {\n+        return \"range1\";\n+    }\n+\n+    private void allocateIpAddress(PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {", "originalCommit": "5df17053c8b70c90f14fbb5ad4673f1d96582b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIwNjQ5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421206493", "bodyText": "Yes, we can consider it in two cases. First, if an exception occurs before receiving the rest response, there is no need to roll back. Second, if an exception occurs after receiving the rest response, it needs to be rolled back, so we need to ensure that there is no exception between the rest response and rollbacks.push (). In fact, rollbacks.push () is executed after receiving the rest response, so we can assume that there will be no exception between them.", "author": "chenpiaoping", "createdAt": "2020-05-07T02:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA2MTA2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422061064", "bodyText": "I want to deal with the rollbacks of various operations in a unified way by a common method. This method does not need to judge whether the operation needs to be rolled back, and does not need to care about what to be rolled back, this should be concerned by the operation itself. There may be a better way, do you have any good suggestions?", "author": "chenpiaoping", "createdAt": "2020-05-08T10:09:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NTI2Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422795262", "bodyText": "@chenpiaoping I miss your previous comment in this thread. Unifying the rollback is a good idea but depending on how we are going to do it.\nRegarding the first case, let us say Service A => Service B, and the modify (POST or PUT or DELETE) request has been sent but no yet received a response, an exception is received at this time. It is still necessary that Service A send roolback to Service B.", "author": "xieus", "createdAt": "2020-05-11T05:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5NjQyNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422896427", "bodyText": "Oh, this is indeed a big problem. Does subnet manager have the same problem?", "author": "chenpiaoping", "createdAt": "2020-05-11T09:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2ODM2MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422968361", "bodyText": "https://github.com/futurewei-cloud/alcor/pull/180/commits/0a4c96a05592534af52680abe72f9d5d6f364d28\uff0cThis commit is going to solve this problem.", "author": "chenpiaoping", "createdAt": "2020-05-11T11:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2MzExNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423463116", "bodyText": "Thanks let me check it.", "author": "xieus", "createdAt": "2020-05-12T05:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NDc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r418346874", "bodyText": "The calls into various downstream microservices remain serial and sync.\nOne recommended way is to async call into multiple microservices in parallel. See the implementation of Subnet Manager for an example.\nhttps://github.com/futurewei-cloud/alcor/blob/a4db5c2b368e1a500f4defd62de174d375419392/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "author": "xieus", "createdAt": "2020-04-30T23:34:41Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,572 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+\n+import com.futurewei.alcor.common.entity.*;\n+import com.futurewei.alcor.common.rest.IpAddressRest;\n+import com.futurewei.alcor.common.rest.MacAddressRest;\n+import com.futurewei.alcor.common.rest.VpcRest;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.portmanager.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.portmanager.utils.Ipv6AddrUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.common.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    @Autowired\n+    private IpAddressRest ipAddressRest;\n+\n+    @Autowired\n+    private MacAddressRest macAddressRest;\n+\n+    @Autowired\n+    private VpcRest vpcRest;\n+\n+    private int getIpVersion(String ipAddress) throws Exception {\n+        if (Ipv4AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV4.getVersion();\n+        } else if (Ipv6AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV6.getVersion();\n+        } else {\n+            throw new IpAddrInvalidException();\n+        }\n+    }\n+\n+    private String getRangeIdBySubnetId(String subnetId, int ipVersion) throws Exception {\n+        if (IpVersion.IPV4.getVersion() == ipVersion) {\n+            return subnetId; //FIXME:return the right rangeId get from subnet manager\n+        } else if (IpVersion.IPV6.getVersion() == ipVersion) {\n+            return subnetId; //FIXME:return the right rangeId get from subnet manager\n+        }\n+\n+        throw new IpVersionInvalidException();\n+    }\n+\n+    private void verifyIpAddresses(List<PortState.FixedIp> fixedIps, Stack<PortStateRollback> rollbacks) throws Exception {\n+        for (PortState.FixedIp fixedIp: fixedIps) {\n+            int ipVersion = getIpVersion(fixedIp.getIpAddress());\n+            String rangeId = getRangeIdBySubnetId(fixedIp.getSubnetId(), ipVersion);\n+\n+            IpAddrRequest result = ipAddressRest.allocateIpAddress(rangeId, fixedIp.getIpAddress());\n+\n+            AllocateIpAddrRollback ipAddressRollback = new AllocateIpAddrRollback(ipAddressRest);\n+            ipAddressRollback.putAllocatedIpAddress(result);\n+            rollbacks.push(ipAddressRollback);\n+        }\n+    }\n+\n+    private String getRangeIdForPort(String vpcId) {\n+        return \"range1\";\n+    }\n+\n+    private void allocateIpAddress(PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {\n+        String rangeId = getRangeIdForPort(portState.getVpcId());\n+\n+        IpAddrRequest result = ipAddressRest.allocateIpAddress(rangeId, null);\n+\n+        List<PortState.FixedIp> fixedIps = new ArrayList<>();\n+        PortState.FixedIp fixedIp = new PortState.FixedIp();\n+\n+        fixedIp.setSubnetId(result.getSubnetId());\n+        fixedIp.setIpAddress(result.getIp());\n+        fixedIps.add(fixedIp);\n+\n+        portState.setFixedIps(fixedIps);\n+\n+        AllocateIpAddrRollback ipAddressRollback = new AllocateIpAddrRollback(ipAddressRest);\n+        ipAddressRollback.putAllocatedIpAddress(result);\n+        rollbacks.push(ipAddressRollback);\n+    }\n+\n+    private void allocateMacAddress(String projectId, PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {\n+        MacStateJson result = macAddressRest.allocateMacAddress(projectId, portState.getVpcId(), portState.getId());\n+        portState.setMacAddress(result.getMacState().getMacAddress());\n+\n+        MacState macState = new MacState();\n+        macState.setProjectId(projectId);\n+        macState.setVpcId(portState.getVpcId());\n+        macState.setMacAddress(portState.getMacAddress());\n+\n+        AllocateMacAddrRollback rollback = new AllocateMacAddrRollback(macAddressRest);\n+        rollback.putAllocatedMacAddress(macState);\n+\n+        rollbacks.push(rollback);\n+    }\n+\n+    private void verifyMacAddress(String projectId, PortState portState, Stack<PortStateRollback> rollbacks) {\n+        //FIXME: Not support yet\n+    }\n+\n+    private void releaseMacAddress(String projectId, PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {\n+        macAddressRest.releaseMacAddress(portState.getMacAddress());\n+\n+        MacState macState = new MacState();\n+        macState.setProjectId(projectId);\n+        macState.setVpcId(portState.getVpcId());\n+        macState.setMacAddress(portState.getMacAddress());\n+\n+        ReleaseMacAddrRollback rollback = new ReleaseMacAddrRollback(macAddressRest);\n+        rollback.putReleasedMacAddress(macState);\n+\n+        rollbacks.push(rollback);\n+    }\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks)\n+            throws Exception {\n+        while (!rollbacks.isEmpty()) {\n+            rollbacks.pop().doRollback();\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    private void setDefaultValue(PortState portState) {\n+        if (portState.getId() == null) {\n+            portState.setId(\"\");\n+        }\n+\n+        if (portState.getProjectId() == null) {\n+            portState.setProjectId(\"\");\n+        }\n+\n+        if (portState.getName() == null) {\n+            portState.setName(\"\");\n+        }\n+        if (portState.getDescription() == null) {\n+            portState.setDescription(\"\");\n+        }\n+        if (portState.getVpcId() == null) {\n+            portState.setVpcId(\"\");\n+        }\n+\n+        if (portState.getTenantId() == null) {\n+            portState.setTenantId(\"\");\n+        }\n+\n+        if (portState.getMacAddress() == null) {\n+            portState.setMacAddress(\"\");\n+        }\n+\n+        if (portState.getVethName() == null) {\n+            portState.setVethName(\"\");\n+        }\n+\n+        if (portState.getDeviceId() == null) {\n+            portState.setDeviceId(\"\");\n+        }\n+\n+        if (portState.getDeviceOwner() == null) {\n+            portState.setDeviceOwner(\"\");\n+        }\n+\n+        if (portState.getStatus() == null) {\n+            portState.setStatus(\"\");\n+        }\n+\n+        if (portState.getFixedIps() == null) {\n+            portState.setFixedIps(new ArrayList<>());\n+        }\n+\n+        if (portState.getAllowedAddressPairs() == null) {\n+            portState.setAllowedAddressPairs(new ArrayList<>());\n+        }\n+\n+        if (portState.getExtraDhcpOpts() == null) {\n+            portState.setExtraDhcpOpts(new ArrayList<>());\n+        }\n+\n+        if (portState.getSecurityGroups() == null) {\n+            portState.setSecurityGroups(new ArrayList<>());\n+        }\n+\n+        if (portState.getBindingHostId() == null) {\n+            portState.setBindingHostId(\"\");\n+        }\n+\n+        if (portState.getBindingProfile() == null) {\n+            portState.setBindingProfile(\"\");\n+        }\n+\n+        if (portState.getBindingVnicType() == null) {\n+            portState.setBindingVnicType(\"\");\n+        }\n+\n+        if (portState.getNetworkNamespace() == null) {\n+            portState.setNetworkNamespace(\"\");\n+        }\n+\n+        if (portState.getDnsName() == null) {\n+            portState.setDnsName(\"\");\n+        }\n+\n+        if (portState.getDnsAssignment() == null) {\n+            portState.setDnsAssignment(new ArrayList<>());\n+        }\n+    }\n+\n+    private PortStateJson tryCreatePortState(String projectId, PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {", "originalCommit": "5df17053c8b70c90f14fbb5ad4673f1d96582b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIwNzIzMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421207232", "bodyText": "Okay, I will do that.", "author": "chenpiaoping", "createdAt": "2020-05-07T02:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5NTM2Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422795367", "bodyText": "Thanks.", "author": "xieus", "createdAt": "2020-05-11T05:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMjU4OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424902589", "bodyText": "Nice work on support Async with a generic AsyncExecutor class. Like it!", "author": "xieus", "createdAt": "2020-05-14T06:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNTQ0MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424905441", "bodyText": "If this mechanism is approved by you, I will move it to the lib directory", "author": "chenpiaoping", "createdAt": "2020-05-14T06:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNDA3Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424914077", "bodyText": "Sure. Go for it :-)", "author": "xieus", "createdAt": "2020-05-14T07:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0Njg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM1MDU5Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r418350596", "bodyText": "It is a good idea to put all common entity classes out of an invidiual microservice.\nInstead of storing them in AlcorCommonLib, we recommend to store the entity classes in AlcorWeb which is under /web directory.", "author": "xieus", "createdAt": "2020-04-30T23:47:36Z", "path": "lib/src/main/java/com/futurewei/alcor/common/entity/DeviceOwner.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package com.futurewei.alcor.common.entity;", "originalCommit": "5df17053c8b70c90f14fbb5ad4673f1d96582b23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MDEyMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r418360122", "bodyText": "This is a good util class. Move to common lib so that IP manager could use it as well?", "author": "xieus", "createdAt": "2020-05-01T00:22:16Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/utils/Ipv4AddrUtil.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+\n+package com.futurewei.alcor.portmanager.utils;\n+\n+public class Ipv4AddrUtil {", "originalCommit": "5df17053c8b70c90f14fbb5ad4673f1d96582b23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIwNjc0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421206745", "bodyText": "Good idea.", "author": "chenpiaoping", "createdAt": "2020-05-07T02:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MDEyMg=="}], "type": "inlineReview"}, {"oid": "81f0cda3fe739a072adc184ad8af4cc2e9b5aec4", "url": "https://github.com/futurewei-cloud/alcor/commit/81f0cda3fe739a072adc184ad8af4cc2e9b5aec4", "message": "call multiple microservices in parallel", "committedDate": "2020-05-07T07:26:53Z", "type": "forcePushed"}, {"oid": "6fefe4690cfe4c56b5165b807e818a900dd2bbb5", "url": "https://github.com/futurewei-cloud/alcor/commit/6fefe4690cfe4c56b5165b807e818a900dd2bbb5", "message": "add some UTs for port-manager", "committedDate": "2020-05-07T08:40:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421943107", "bodyText": "We should verify Subnet ID, instead of Vpc Id here.", "author": "xieus", "createdAt": "2020-05-08T05:17:13Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,421 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.*;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.web.rest.MacAddressRest;\n+import com.futurewei.alcor.web.rest.VpcRest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.*;\n+import java.util.concurrent.CompletableFuture;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    @Autowired\n+    private IpAddressRest ipAddressRest;\n+\n+    @Autowired\n+    private MacAddressRest macAddressRest;\n+\n+    @Autowired\n+    private VpcRest vpcRest;\n+\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks)\n+            throws Exception {\n+        while (!rollbacks.isEmpty()) {\n+            rollbacks.pop().doRollback();\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    private void tryCreatePortState(PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {\n+        //Verify VPC ID", "originalCommit": "3f9347ed0faa742999aa8f14c53002f017baece6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2MDQ5Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421960496", "bodyText": "@xieus  But port may not have a Subnet ID. In this case, we need to find a suitable subnet for port, and assign an ip address to port from that subnet.", "author": "chenpiaoping", "createdAt": "2020-05-08T06:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4MTAwMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421981000", "bodyText": "Correct. We have multiple cases to cover, most of the cases would require to verify subnet ID.\nhttps://docs.openstack.org/api-ref/network/v2/?expanded=create-port-detail#ports\n(1) If a user specifies a subnet ID in the optional fixed_ips field, then we have to verify that subnet Id\n(2) If the user doesn't give any fixed_ips, we handle it as you suggested.", "author": "xieus", "createdAt": "2020-05-08T07:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4Njg2NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421986865", "bodyText": "@xieus  For the first case, I think we need to get the range ID by  Subnet ID (At this point, the Subnet ID will be verified), and then assign an ip address from the ip range. At present, Subnet manager have not provided an interface to obtain the Range ID by the Subnet ID. I discussed this with kevin, and he said he would think about it.", "author": "chenpiaoping", "createdAt": "2020-05-08T07:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk5MDI5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421990292", "bodyText": "I think we could make this verification simple by calling the regular Get /subnets/{subnet_id} and the response includes the range ids. @kevin-zhonghao", "author": "xieus", "createdAt": "2020-05-08T07:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk5NTA4OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421995088", "bodyText": "That would be nice\uff0cBut for the second case, how do i get a suitable Range ID?", "author": "chenpiaoping", "createdAt": "2020-05-08T07:40:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk5ODM2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421998369", "bodyText": "Simple solution: random pick one subnet\n(subnet may run out of ips so need retry a few times if such a case is hit)\nComprehensive solution: Pick subnet based on ip utilization.\nWe have the ip utilization data for ip range, we could possibly populate that info to VPC manager and pick a subnet with more available ips.", "author": "xieus", "createdAt": "2020-05-08T07:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzOTMzMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422439333", "bodyText": "@xieus To reduce interaction with other microservices, we can add an interface to ip manager. The parameter of this interface is that Vpc ID. This interface will selects an ip range based on Vpc ID and assigns an ip address from that ip range. Is that okay?", "author": "chenpiaoping", "createdAt": "2020-05-09T01:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1ODA1NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422458055", "bodyText": "@chenpiaoping Does IP manager has the VPC id?", "author": "xieus", "createdAt": "2020-05-09T06:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1OTI2Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422459263", "bodyText": "No, not yet.", "author": "chenpiaoping", "createdAt": "2020-05-09T06:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1OTc1OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422459759", "bodyText": "Okay the db key is range id in IP Manager, and subnet ID is part of the value. If we need to VPC Id there, we expect to see inefficient query if we try to get range by vpc id. Any other thoughts?", "author": "xieus", "createdAt": "2020-05-09T06:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDI1MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422460251", "bodyText": "@chenpiaoping Regarding the API to query RangeId by SubnetId, the current Subnet Manager supports that.\nYou could use the API\nGET /project/{projectId}/subnets/{subnetId}\nSample Response:\n{\n\"subnet\": {\n\"availability_zone\": \"string\",\n\"cidr\": \"string\",\n\"description\": \"string\",\n\"dhcp_enable\": true,\n\"dns_list\": [\n\"string\"\n],\n\"gateway_ip\": \"string\",\n\"id\": \"string\",\n\"ipv4_range_id\": \"string\",\n\"ipv6_range_id\": \"string\",\n\"mac_address\": \"string\",\n\"name\": \"string\",\n\"primary_dns\": \"string\",\n\"project_id\": \"string\",\n\"routes\": [\n{\n\"associatedTableId\": \"string\",\n\"associatedType\": \"MAIN\",\n\"description\": \"string\",\n\"destination\": \"string\",\n\"id\": \"string\",\n\"name\": \"string\",\n\"priority\": 0,\n\"project_id\": \"string\",\n\"target\": \"string\"\n}\n],\n\"secondary_dns\": \"string\",\n\"vpc_id\": \"string\"\n}\n}\nwhere ipv4_range_id and ipv6_range_id are what you are looking for :-)", "author": "xieus", "createdAt": "2020-05-09T06:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDU4MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422460580", "bodyText": "Thanks, I found this API. I've submitted a new commit for this.", "author": "chenpiaoping", "createdAt": "2020-05-09T06:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MTY1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422461653", "bodyText": "In order to avoid the problem of inefficient query, another idea is that we can create a table to store the mapping between vpc id and rang id, but we need to write this table at the same time when we create or delete an ip range.", "author": "chenpiaoping", "createdAt": "2020-05-09T07:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc3NjIwMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422776203", "bodyText": "One discipline is that we follow the same workflows for both case (1) and case (2).\nYou could either go to SubnetManager to verify subnetId or vpcId, retrieve the range id, and then go to IP manager,\nOR, build a mapping in IP manager from VpcId to rangeID as well as SubnetId to RangeId, and only need go to IP manager.", "author": "xieus", "createdAt": "2020-05-11T04:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3MzQzNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422973437", "bodyText": "Yes, for the case of going to SubnetManager to retrieve a range id,  Since SubnetManager do not know whether there is an available ip address in the range, we may need to go to SubnetManager many times to obtain a available range.", "author": "chenpiaoping", "createdAt": "2020-05-11T11:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMzczMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423433730", "bodyText": "@xieus Ip manager provides an interface that randomly assigns ip addresses according to vpcId. Is this solution okay? I'm ready to develop.", "author": "chenpiaoping", "createdAt": "2020-05-12T03:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2NzA0OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423467048", "bodyText": "@chenpiaoping Rethinking the issue, we might have to pick the option of \" go to SubnetManager to verify subnetId or vpcId, retrieve the range id, and then go to IP manager\".\nThe reason is that PortManager needs to visit both RouteManager and IPManager to retrieve routes and to allocate ip, respectively. SubnetManger is the source of truth to retrieve the routes under the subnet and to get the ip range id under the same subnet.\nTherefore, the workflow is like this:\n\n\nPort Manager => SubnetManager\n1.1 If Subnet Id is known, send and verify subnet Id, retrieve routes under the subnet (as SubnetManager has the latest routes) and to get range Id\n1.2 Otherwise, send vpc id to SubnetManager, SubnetManager picks one subnet, and the rest is the same as Step 1.1\n\n\nPort Manager => Ip Manager, send the range id from Step 1, and allocate ip from the given range.\n\n\nCurrently, Step 1.1 needs a new API from SubnetManager. @kevin-zhonghao and I will work to create one in a parallel PR (#181).", "author": "xieus", "createdAt": "2020-05-12T05:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NTA1Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423485056", "bodyText": "@xieus  I have submitted the code, but it is a little different from what you described. Can you review it?", "author": "chenpiaoping", "createdAt": "2020-05-12T06:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0MzEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r421945577", "bodyText": "Need two more calls:\n(1) One into RouteManager to get the routing rules of the subnet that this port belong to. The list of routing rules is the superset of Neutron router and could include SNAT/DNAT rules.\nFor now, I would recommend you to look into Subnet implementation regarding how to call RouteManager.\n\n  \n    \n      alcor/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java\n    \n    \n         Line 120\n      in\n      2ae412f\n    \n    \n    \n    \n\n        \n          \n           @Override \n        \n    \n  \n\n\n(2) The other into NodeManager which is under development.\nPR: https://github.com/futurewei-cloud/alcor/pull/185/files\nThe API you could be interested in is GET /nodes/{nodeid}.", "author": "xieus", "createdAt": "2020-05-08T05:26:23Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,421 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.*;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.web.rest.MacAddressRest;\n+import com.futurewei.alcor.web.rest.VpcRest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.*;\n+import java.util.concurrent.CompletableFuture;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    @Autowired\n+    private IpAddressRest ipAddressRest;\n+\n+    @Autowired\n+    private MacAddressRest macAddressRest;\n+\n+    @Autowired\n+    private VpcRest vpcRest;\n+\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks)\n+            throws Exception {\n+        while (!rollbacks.isEmpty()) {\n+            rollbacks.pop().doRollback();\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    private void tryCreatePortState(PortState portState, Stack<PortStateRollback> rollbacks) throws Exception {\n+        //Verify VPC ID\n+        VpcRestWrap vpcRestWrap = new VpcRestWrap(vpcRest, rollbacks);\n+        CompletableFuture vpcFuture = AsyncExecutor.execute(vpcRestWrap::verifyVpc, portState);\n+\n+        CompletableFuture ipFuture;\n+        IpAddressRestWrap ipAddressRestWrap = new IpAddressRestWrap(ipAddressRest, rollbacks);\n+\n+        if (portState.getFixedIps() == null) {\n+            ipFuture = AsyncExecutor.execute(ipAddressRestWrap::allocateIpAddress, portState);\n+        } else {\n+            ipFuture = AsyncExecutor.execute(ipAddressRestWrap::verifyIpAddresses, portState.getFixedIps());\n+        }\n+\n+        //Generate uuid for port\n+        if (portState.getId() == null) {\n+            portState.setId(UUID.randomUUID().toString());\n+        }\n+\n+        CompletableFuture macFuture;\n+        MacAddressRestWrap macAddressRestWrap = new MacAddressRestWrap(macAddressRest, rollbacks);\n+\n+        if (portState.getMacAddress() == null) {\n+            macFuture = AsyncExecutor.execute(macAddressRestWrap::allocateMacAddress, portState);\n+        } else {\n+            macFuture = AsyncExecutor.execute(macAddressRestWrap::verifyMacAddress, portState);\n+        }\n+\n+        //Verify security group\n+\n+        //If port binds host, to send it's information to host\n+", "originalCommit": "3f9347ed0faa742999aa8f14c53002f017baece6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDIyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422040223", "bodyText": "Should I get route info from RouteManager or from SubnetManager? I found that RouteManager only has the interface to get route info by Vpc ID(/ vpcs/ {vpcId} / routes/ {routeId}), and there is no interface to get route info by Subnet ID. However, SubnetManager will store route info, which will be stored in RouteManager,  VpcManager. Will it take up too much memory?", "author": "chenpiaoping", "createdAt": "2020-05-08T09:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1NDQ3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422054473", "bodyText": "For the interaction with node manager, Can i come back to do it after the development of node manager finish?", "author": "chenpiaoping", "createdAt": "2020-05-08T09:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1ODUwNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422458504", "bodyText": "@chenpiaoping Regarding NodeManager, PR #185 is under review and should be merged pretty soon so I would recommend to write the codes based on the current APIs. You could comment out for now and test only when NodeManager is merged. Should be soon.", "author": "xieus", "createdAt": "2020-05-09T06:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1ODY1MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422458650", "bodyText": "Regarding routing rules, I suggest to still go to RouteManager as that is the ultimate source of truth for routing information.\nI think your point is very good. We possibly need to add a new API in RouteManager to allow query by SubnetId.  Add @kevin-zhonghao for awareness.", "author": "xieus", "createdAt": "2020-05-09T06:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1ODk0MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422458940", "bodyText": "Regarding memory usage of storing routes in SubnetManager and VpcManager that might occupy too much memory,  we haven't seen that case yet so storing routes in the upstream microservices could cut the latency for GET.\nIf you find such a case, let me know and we could quickly revisit this design.", "author": "xieus", "createdAt": "2020-05-09T06:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1OTUwMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422459501", "bodyText": "okay, xieus.", "author": "chenpiaoping", "createdAt": "2020-05-09T06:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NTU3Nw=="}], "type": "inlineReview"}, {"oid": "f67e948570f7683e08f14ad8c5dac384fb18e1c5", "url": "https://github.com/futurewei-cloud/alcor/commit/f67e948570f7683e08f14ad8c5dac384fb18e1c5", "message": "verify subnet id and get range id by subnet id", "committedDate": "2020-05-08T09:51:57Z", "type": "forcePushed"}, {"oid": "c4923b2d500e8dc46d35d6cc565cf8ce33e9a34a", "url": "https://github.com/futurewei-cloud/alcor/commit/c4923b2d500e8dc46d35d6cc565cf8ce33e9a34a", "message": "move rest bean to restwrap dir", "committedDate": "2020-05-09T04:10:37Z", "type": "forcePushed"}, {"oid": "dd0e760565a7a8a64d7f3f342f6e448a56afcb96", "url": "https://github.com/futurewei-cloud/alcor/commit/dd0e760565a7a8a64d7f3f342f6e448a56afcb96", "message": "verify binding host id", "committedDate": "2020-05-09T07:58:33Z", "type": "forcePushed"}, {"oid": "8c4831b4993c07e4c391fadf8579aaba6a2043ac", "url": "https://github.com/futurewei-cloud/alcor/commit/8c4831b4993c07e4c391fadf8579aaba6a2043ac", "message": "add mock ignite server & fix and enable ip manager UTs", "committedDate": "2020-05-09T09:40:47Z", "type": "forcePushed"}, {"oid": "b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "url": "https://github.com/futurewei-cloud/alcor/commit/b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "message": "add maven-surefire-plugin back to ip manager", "committedDate": "2020-05-11T02:46:01Z", "type": "forcePushed"}, {"oid": "b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "url": "https://github.com/futurewei-cloud/alcor/commit/b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "message": "add maven-surefire-plugin back to ip manager", "committedDate": "2020-05-11T02:46:01Z", "type": "forcePushed"}, {"oid": "b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "url": "https://github.com/futurewei-cloud/alcor/commit/b3f39f0e0390c43ae44e5341c260ce5f0f2762fd", "message": "add maven-surefire-plugin back to ip manager", "committedDate": "2020-05-11T02:46:01Z", "type": "forcePushed"}, {"oid": "583b28c432a97d9cf89271792b23eb79543df739", "url": "https://github.com/futurewei-cloud/alcor/commit/583b28c432a97d9cf89271792b23eb79543df739", "message": "add maven-surefire-plugin back to ip manager", "committedDate": "2020-05-11T03:57:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5ODU3OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422798579", "bodyText": "Could we change the default Ignite port to some numbers other than 10800 and use that new default number in the application.properties? This could prevent conflicting with a running Ignite container on the 10800 port.", "author": "xieus", "createdAt": "2020-05-11T05:59:26Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/MockIgniteServer.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.common.db.ignite;\n+\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.IgniteException;\n+import org.apache.ignite.Ignition;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+\n+public class MockIgniteServer {\n+    private static Ignite igniteServer;\n+\n+    @BeforeClass\n+    public static void init() {\n+        try {\n+            igniteServer = Ignition.start();", "originalCommit": "583b28c432a97d9cf89271792b23eb79543df739", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgyODI1MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r422828250", "bodyText": "That's a good idea. Let me check the ignite doc.", "author": "chenpiaoping", "createdAt": "2020-05-11T07:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5ODU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMjM1NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423502354", "bodyText": "Thanks for making the change.", "author": "xieus", "createdAt": "2020-05-12T06:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc5ODU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423468253", "bodyText": "@chenpiaoping I think the MockIgniteServer and MockRedisServer are very good change which we want to merge to Master quick as other services could start using that.\nIs it possible that we split this PR into two by creating a new PR solely on the Mock change, which is supposed to consist of just a few files? Let me know.", "author": "xieus", "createdAt": "2020-05-12T05:21:03Z", "path": "lib/src/main/java/com/futurewei/alcor/common/db/ignite/MockIgniteServer.java", "diffHunk": "@@ -18,25 +18,35 @@\n import org.apache.ignite.Ignite;\n import org.apache.ignite.IgniteException;\n import org.apache.ignite.Ignition;\n+import org.apache.ignite.configuration.ClientConnectorConfiguration;", "originalCommit": "26ab3f418fe721e2ea7f79a597cef0e38626f8ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4ODUzMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423488531", "bodyText": "If there is no problem with this PR so far, I think we can merge it into the master,  I'll come back and add the part of interaction with route manager and dataplane later.", "author": "chenpiaoping", "createdAt": "2020-05-12T06:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5MjMzMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423492330", "bodyText": "It's a bit troublesome to split MockIgniteServer from this PR, because many of the UTs of ip manager are based on MockIgniteServer.", "author": "chenpiaoping", "createdAt": "2020-05-12T06:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5NDk5NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423494994", "bodyText": "@chenpiaoping This PR is kind of huge with over 100 files change.  Some files are still under review.\nLet us check in small change first.", "author": "xieus", "createdAt": "2020-05-12T06:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMzc4Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423503782", "bodyText": "@chenpiaoping I miss your last comment about this PR has dependency on the MockService. In this case, it is okay to keep MockService here. Let me try to review the rest and merge soon then.", "author": "xieus", "createdAt": "2020-05-12T06:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNTg4NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423505884", "bodyText": "Thanks, xieus.", "author": "chenpiaoping", "createdAt": "2020-05-12T07:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2ODI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5Mjk3OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423492978", "bodyText": "These are critical parameters. Need comments.", "author": "xieus", "createdAt": "2020-05-12T06:34:50Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/config/ThreadPoolExecutorConfig.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.futurewei.alcor.portmanager.config;\n+\n+public class ThreadPoolExecutorConfig {\n+\n+    public static int corePoolSize = 10;", "originalCommit": "8d778d48bd1830a5f8c3aaf2d67c71477019051a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ5MzMwNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423493304", "bodyText": "Like it!", "author": "xieus", "createdAt": "2020-05-12T06:35:37Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/exception/AllocateIpAddrException.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.exception;\n+\n+import org.springframework.http.HttpStatus;\n+import org.springframework.web.bind.annotation.ResponseStatus;\n+\n+@ResponseStatus(code= HttpStatus.INTERNAL_SERVER_ERROR, reason=\"Allocate ip address error\")", "originalCommit": "8d778d48bd1830a5f8c3aaf2d67c71477019051a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNTYwOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423505609", "bodyText": "This could move to /lib once proven to be reliable in IP manager.", "author": "xieus", "createdAt": "2020-05-12T07:02:28Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/executor/AsyncExecutor.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.executor;\n+\n+import com.futurewei.alcor.portmanager.config.ThreadPoolExecutorConfig;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.concurrent.*;\n+import java.util.function.Supplier;\n+\n+public class AsyncExecutor {", "originalCommit": "8d778d48bd1830a5f8c3aaf2d67c71477019051a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NzA0Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424877043", "bodyText": "@chenpiaoping Could we move the AsycExecutor at this time?", "author": "xieus", "createdAt": "2020-05-14T05:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwODIyMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r423508221", "bodyText": "We could verify the input parameters in the controller level.", "author": "xieus", "createdAt": "2020-05-12T07:07:49Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.controller;\n+\n+\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.PortStateJson;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.web.bind.annotation.*;\n+\n+import java.util.List;\n+\n+\n+@RestController\n+public class PortController {\n+    @Autowired\n+    PortService portService;\n+\n+    @PostMapping({\"/project/{project_id}/ports\", \"v4/{project_id}/ports\"})\n+    @ResponseBody\n+    @ResponseStatus(HttpStatus.CREATED)\n+    public PortStateJson createPortState(@PathVariable(\"project_id\") String projectId,\n+                                         @RequestBody PortStateJson portStateJson) throws Exception {\n+        return portService.createPortState(projectId, portStateJson);", "originalCommit": "8d778d48bd1830a5f8c3aaf2d67c71477019051a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ac75b6171e17614a20c8f296f76d4642b042073", "url": "https://github.com/futurewei-cloud/alcor/commit/0ac75b6171e17614a20c8f296f76d4642b042073", "message": "enable UTs", "committedDate": "2020-05-12T12:50:29Z", "type": "forcePushed"}, {"oid": "2070f1f335f496b739541fb6fd7ba6e33ac8c8a5", "url": "https://github.com/futurewei-cloud/alcor/commit/2070f1f335f496b739541fb6fd7ba6e33ac8c8a5", "message": "update doc for ip manager", "committedDate": "2020-05-13T07:48:15Z", "type": "forcePushed"}, {"oid": "b8d9989b395de8bc4fdba44e530188c01846b435", "url": "https://github.com/futurewei-cloud/alcor/commit/b8d9989b395de8bc4fdba44e530188c01846b435", "message": "skips UTs when packaging", "committedDate": "2020-05-13T08:19:03Z", "type": "commit"}, {"oid": "6a05874e118a248435c3251c58ecd6a6f237cd31", "url": "https://github.com/futurewei-cloud/alcor/commit/6a05874e118a248435c3251c58ecd6a6f237cd31", "message": "port manager architecture", "committedDate": "2020-05-13T08:19:11Z", "type": "commit"}, {"oid": "c3ce731685c0474e73988d0d5c0dc8854d60211d", "url": "https://github.com/futurewei-cloud/alcor/commit/c3ce731685c0474e73988d0d5c0dc8854d60211d", "message": "call multiple microservices in parallel", "committedDate": "2020-05-13T08:19:22Z", "type": "commit"}, {"oid": "e1bc6ff0bb5fb74cdaa533f518e583321013e793", "url": "https://github.com/futurewei-cloud/alcor/commit/e1bc6ff0bb5fb74cdaa533f518e583321013e793", "message": "add some UTs for port-manager", "committedDate": "2020-05-13T08:19:25Z", "type": "commit"}, {"oid": "fe0e3fb067eb206900d45560d5096ee0c853c0e6", "url": "https://github.com/futurewei-cloud/alcor/commit/fe0e3fb067eb206900d45560d5096ee0c853c0e6", "message": "verify subnet id and get range id by subnet id", "committedDate": "2020-05-13T08:19:27Z", "type": "commit"}, {"oid": "836ac39bc526d1148db8e69801258ef4fc01137a", "url": "https://github.com/futurewei-cloud/alcor/commit/836ac39bc526d1148db8e69801258ef4fc01137a", "message": "move rest bean to restwrap dir", "committedDate": "2020-05-13T08:19:30Z", "type": "commit"}, {"oid": "228001558f2005dfcbf9de7712bba725362df3d4", "url": "https://github.com/futurewei-cloud/alcor/commit/228001558f2005dfcbf9de7712bba725362df3d4", "message": "verify binding host id", "committedDate": "2020-05-13T08:19:32Z", "type": "commit"}, {"oid": "4a173eb4b8c39b0eaa6b17f97f703b6e4f59f07a", "url": "https://github.com/futurewei-cloud/alcor/commit/4a173eb4b8c39b0eaa6b17f97f703b6e4f59f07a", "message": "add mock ignite server & fix and enable ip manager UTs", "committedDate": "2020-05-13T08:19:34Z", "type": "commit"}, {"oid": "17520158cb77fcdc488698be23b648521c16437f", "url": "https://github.com/futurewei-cloud/alcor/commit/17520158cb77fcdc488698be23b648521c16437f", "message": "add maven-surefire-plugin back to ip manager", "committedDate": "2020-05-13T08:19:35Z", "type": "commit"}, {"oid": "4b0af3b0410ff78bd8e9dbc293b4bee89a48db1d", "url": "https://github.com/futurewei-cloud/alcor/commit/4b0af3b0410ff78bd8e9dbc293b4bee89a48db1d", "message": "rebase from master and fix UTs failure", "committedDate": "2020-05-13T08:19:37Z", "type": "commit"}, {"oid": "717fcaa025665d5a089c7c3b6dd22d10e2a02e6f", "url": "https://github.com/futurewei-cloud/alcor/commit/717fcaa025665d5a089c7c3b6dd22d10e2a02e6f", "message": "fix the problem of rollback failure", "committedDate": "2020-05-13T08:19:39Z", "type": "commit"}, {"oid": "00ffaa636f8a11d4233a3dddc2c4badba7373c90", "url": "https://github.com/futurewei-cloud/alcor/commit/00ffaa636f8a11d4233a3dddc2c4badba7373c90", "message": "allocate ip address from ip manager by vpc id", "committedDate": "2020-05-13T08:20:49Z", "type": "commit"}, {"oid": "4c5f611d8e98c22df6ae421794e672a0317ec7f9", "url": "https://github.com/futurewei-cloud/alcor/commit/4c5f611d8e98c22df6ae421794e672a0317ec7f9", "message": "enable UTs", "committedDate": "2020-05-13T08:20:54Z", "type": "commit"}, {"oid": "7a10d9063ab54ed71f9849d8b89a0b3b3c2b21bd", "url": "https://github.com/futurewei-cloud/alcor/commit/7a10d9063ab54ed71f9849d8b89a0b3b3c2b21bd", "message": "add some UTs for port manager", "committedDate": "2020-05-13T08:20:55Z", "type": "commit"}, {"oid": "b014ec928f933f8e8427dce09da60cb0e032f96d", "url": "https://github.com/futurewei-cloud/alcor/commit/b014ec928f933f8e8427dce09da60cb0e032f96d", "message": "update doc for ip manager", "committedDate": "2020-05-13T08:20:57Z", "type": "commit"}, {"oid": "ba946ebd2798b3326a6307fb17ef50fb6197bfad", "url": "https://github.com/futurewei-cloud/alcor/commit/ba946ebd2798b3326a6307fb17ef50fb6197bfad", "message": "add port_manager service to pom.xml", "committedDate": "2020-05-13T08:20:57Z", "type": "commit"}, {"oid": "edcb48d722b2beec8e959615f65376d65346f52c", "url": "https://github.com/futurewei-cloud/alcor/commit/edcb48d722b2beec8e959615f65376d65346f52c", "message": "add Dockerfile for port manager", "committedDate": "2020-05-13T08:40:59Z", "type": "forcePushed"}, {"oid": "dbb419c5b3c6087f8975f271c322b48ae92d0fa5", "url": "https://github.com/futurewei-cloud/alcor/commit/dbb419c5b3c6087f8975f271c322b48ae92d0fa5", "message": "rebase from master and add Dockerfile for port manager", "committedDate": "2020-05-13T08:55:01Z", "type": "forcePushed"}, {"oid": "dbb419c5b3c6087f8975f271c322b48ae92d0fa5", "url": "https://github.com/futurewei-cloud/alcor/commit/dbb419c5b3c6087f8975f271c322b48ae92d0fa5", "message": "rebase from master and add Dockerfile for port manager", "committedDate": "2020-05-13T08:55:01Z", "type": "commit"}, {"oid": "e77f3fd5635cc8b7687ab49ed987498ab399bf7c", "url": "https://github.com/futurewei-cloud/alcor/commit/e77f3fd5635cc8b7687ab49ed987498ab399bf7c", "message": "move ip entities to entity/ip dir(conflict with entities of subnet manager)", "committedDate": "2020-05-13T10:39:41Z", "type": "forcePushed"}, {"oid": "9a550424019175616ecb83c2c653f5f0af385bc5", "url": "https://github.com/futurewei-cloud/alcor/commit/9a550424019175616ecb83c2c653f5f0af385bc5", "message": "move entities to web service(conflict with entities of subnet manager)", "committedDate": "2020-05-13T12:39:22Z", "type": "forcePushed"}, {"oid": "6221dee4850cc67fadc56d5203a39ae51bd42865", "url": "https://github.com/futurewei-cloud/alcor/commit/6221dee4850cc67fadc56d5203a39ae51bd42865", "message": "move entities to web service(conflict with entities of subnet manager)", "committedDate": "2020-05-13T12:43:35Z", "type": "forcePushed"}, {"oid": "885c7ec257a5041782f9da096a096bbe57bc34cb", "url": "https://github.com/futurewei-cloud/alcor/commit/885c7ec257a5041782f9da096a096bbe57bc34cb", "message": "move entities to web service(conflict with entities of subnet manager)", "committedDate": "2020-05-13T12:52:34Z", "type": "forcePushed"}, {"oid": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "url": "https://github.com/futurewei-cloud/alcor/commit/0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "message": "move entities to web service(conflict with entities of subnet manager)", "committedDate": "2020-05-13T13:01:24Z", "type": "forcePushed"}, {"oid": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "url": "https://github.com/futurewei-cloud/alcor/commit/0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "message": "move entities to web service(conflict with entities of subnet manager)", "committedDate": "2020-05-13T13:01:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MzczNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424543737", "bodyText": "It would fit into the scope of AlcorLib. Let us move it there.", "author": "xieus", "createdAt": "2020-05-13T15:47:54Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/utils/BeanUtil.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.utils;\n+\n+import org.springframework.beans.BeansException;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.context.ApplicationContextAware;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class BeanUtil implements ApplicationContextAware {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxNTk5Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424815996", "bodyText": "yes, I thought too, but it didn't work.", "author": "chenpiaoping", "createdAt": "2020-05-14T01:10:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MzczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NTg1MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424875851", "bodyText": "Is this because of \"@component\" that you will need to launch this bean within the scope of AlcorPortManager?", "author": "xieus", "createdAt": "2020-05-14T05:18:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MzczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MzAxMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424893012", "bodyText": "Oh, maybe, Let me have a try.", "author": "chenpiaoping", "createdAt": "2020-05-14T06:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MzczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0ODA0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424548044", "bodyText": "I would suggest to rename it to AbstractRestClient.", "author": "xieus", "createdAt": "2020-05-13T15:53:47Z", "path": "web/src/main/java/com/futurewei/alcor/web/rest/AbstractRest.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.rest;\n+\n+import org.springframework.web.client.RestTemplate;\n+\n+abstract class AbstractRest {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NDE0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424894144", "bodyText": "The name your suggest sounds more reasonable, should we also rename all the XXXRest to XXXRestClient?", "author": "chenpiaoping", "createdAt": "2020-05-14T06:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0ODA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMTA2OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424901068", "bodyText": "@chenpiaoping Sure. The comment applies to other classes in the same directory and the directory itself (rest=>restClient).", "author": "xieus", "createdAt": "2020-05-14T06:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0ODA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0ODU3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424548570", "bodyText": "I would suggest to rename it to VpcRestClient. Similar suggestion applies to classes in the same directory.", "author": "xieus", "createdAt": "2020-05-13T15:54:32Z", "path": "web/src/main/java/com/futurewei/alcor/web/rest/VpcRest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.web.rest;\n+\n+import com.futurewei.alcor.web.entity.vpc.VpcStateJson;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class VpcRest extends AbstractRest {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NDkyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424894923", "bodyText": "ok", "author": "chenpiaoping", "createdAt": "2020-05-14T06:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0ODU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2NjYwOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424766609", "bodyText": "Recommend to use\n\nIpManagerRestClient\nSubnetManagerRestClient", "author": "xieus", "createdAt": "2020-05-13T22:27:27Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/restwrap/IpAddressRestWrap.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.restwrap;\n+\n+import com.futurewei.alcor.common.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.common.utils.Ipv6AddrUtil;\n+import com.futurewei.alcor.portmanager.exception.RangeIdNotFoundException;\n+import com.futurewei.alcor.portmanager.exception.VerifySubnetException;\n+import com.futurewei.alcor.portmanager.rollback.AbstractIpAddrRollback;\n+import com.futurewei.alcor.portmanager.utils.BeanUtil;\n+import com.futurewei.alcor.web.entity.ip.IpAddrRequest;\n+import com.futurewei.alcor.web.entity.ip.IpVersion;\n+import com.futurewei.alcor.web.entity.port.PortState;\n+import com.futurewei.alcor.web.entity.SubnetStateJson;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.portmanager.exception.IpAddrInvalidException;\n+import com.futurewei.alcor.portmanager.exception.IpVersionInvalidException;\n+import com.futurewei.alcor.portmanager.rollback.AllocateIpAddrRollback;\n+import com.futurewei.alcor.portmanager.rollback.PortStateRollback;\n+import com.futurewei.alcor.portmanager.rollback.ReleaseIpAddrRollback;\n+import com.futurewei.alcor.web.rest.SubnetRest;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Stack;\n+\n+public class IpAddressRestWrap {\n+    private IpAddressRest ipAddressRest;\n+    private SubnetRest subnetRest;", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MDM5OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424880398", "bodyText": "In general, direct type casting is not recommended for downcasting.\nCould you try cast() and isInstance() methods for safer downcasting?\nA reference: https://www.baeldung.com/java-type-casting", "author": "xieus", "createdAt": "2020-05-14T05:34:03Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/restwrap/IpAddressRestWrap.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.restwrap;\n+\n+import com.futurewei.alcor.common.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.common.utils.Ipv6AddrUtil;\n+import com.futurewei.alcor.portmanager.exception.RangeIdNotFoundException;\n+import com.futurewei.alcor.portmanager.exception.VerifySubnetException;\n+import com.futurewei.alcor.portmanager.rollback.AbstractIpAddrRollback;\n+import com.futurewei.alcor.portmanager.utils.BeanUtil;\n+import com.futurewei.alcor.web.entity.ip.IpAddrRequest;\n+import com.futurewei.alcor.web.entity.ip.IpVersion;\n+import com.futurewei.alcor.web.entity.port.PortState;\n+import com.futurewei.alcor.web.entity.SubnetStateJson;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.portmanager.exception.IpAddrInvalidException;\n+import com.futurewei.alcor.portmanager.exception.IpVersionInvalidException;\n+import com.futurewei.alcor.portmanager.rollback.AllocateIpAddrRollback;\n+import com.futurewei.alcor.portmanager.rollback.PortStateRollback;\n+import com.futurewei.alcor.portmanager.rollback.ReleaseIpAddrRollback;\n+import com.futurewei.alcor.web.rest.SubnetRest;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Stack;\n+\n+public class IpAddressRestWrap {\n+    private IpAddressRest ipAddressRest;\n+    private SubnetRest subnetRest;\n+    private Stack<PortStateRollback> rollbacks;\n+    private String projectId;\n+\n+    public IpAddressRestWrap(Stack<PortStateRollback> rollbacks, String projectId) {\n+        ipAddressRest = BeanUtil.getBean(IpAddressRest.class);\n+        subnetRest = BeanUtil.getBean(SubnetRest.class);\n+        this.rollbacks = rollbacks;\n+        this.projectId = projectId;\n+    }\n+\n+    private int getIpVersion(String ipAddress) throws Exception {\n+        if (Ipv4AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV4.getVersion();\n+        } else if (Ipv6AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV6.getVersion();\n+        } else {\n+            throw new IpAddrInvalidException();\n+        }\n+    }\n+\n+    private String getRangeIdBySubnetId(String subnetId, int ipVersion) throws Exception {\n+        SubnetStateJson subnetStateJson = subnetRest.getSubnetState(projectId, subnetId);\n+        if (subnetStateJson == null || subnetStateJson.getSubnet() == null) {\n+            throw new VerifySubnetException();\n+        }\n+\n+        if (IpVersion.IPV4.getVersion() == ipVersion) {\n+            return subnetStateJson.getSubnet().getIpV4RangeId();\n+        } else if (IpVersion.IPV6.getVersion() == ipVersion) {\n+            return subnetStateJson.getSubnet().getIpV4RangeId();\n+        }\n+\n+        throw new IpVersionInvalidException();\n+    }\n+\n+    private void addIpAddrRollback(AbstractIpAddrRollback rollback, IpAddrRequest ipAddr) {\n+        if (rollback instanceof AllocateIpAddrRollback) {\n+            rollback.putAllocatedIpAddress(ipAddr);\n+        } else {\n+            rollback.putReleasedIpAddress(ipAddr);\n+        }\n+\n+        rollbacks.push(rollback);\n+    }\n+\n+    public List<IpAddrRequest> allocateIpAddress(Object args) throws Exception {\n+        List<IpAddrRequest> ipAddrRequests = new ArrayList<>();\n+        PortState portState = (PortState)args;\n+\n+        IpAddrRequest result = ipAddressRest.allocateIpAddress(IpVersion.IPV4,\n+                portState.getVpcId(), null, null);\n+\n+        List<PortState.FixedIp> fixedIps = new ArrayList<>();\n+        PortState.FixedIp fixedIp = new PortState.FixedIp(result.getSubnetId(), result.getIp());\n+\n+        fixedIps.add(fixedIp);\n+        portState.setFixedIps(fixedIps);\n+\n+        addIpAddrRollback(new AllocateIpAddrRollback(ipAddressRest), result);\n+\n+        ipAddrRequests.add(result);\n+\n+        return ipAddrRequests;\n+    }\n+\n+    public List<IpAddrRequest> verifyIpAddresses(Object args) throws Exception {\n+        List<IpAddrRequest> ipAddrRequests = new ArrayList<>();\n+        List<PortState.FixedIp> fixedIps = (List<PortState.FixedIp>)args;", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyODIxNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424928216", "bodyText": "Don't worry, an exception will be thrown if there is a type conversion error, which is exactly what I expected when the type conversion failed.", "author": "chenpiaoping", "createdAt": "2020-05-14T07:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MjQyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424882423", "bodyText": "How about Ipv6? Could we use sth like \"portState.IpVersion\" instead of fixing with IPv4?", "author": "xieus", "createdAt": "2020-05-14T05:41:10Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/restwrap/IpAddressRestWrap.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.restwrap;\n+\n+import com.futurewei.alcor.common.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.common.utils.Ipv6AddrUtil;\n+import com.futurewei.alcor.portmanager.exception.RangeIdNotFoundException;\n+import com.futurewei.alcor.portmanager.exception.VerifySubnetException;\n+import com.futurewei.alcor.portmanager.rollback.AbstractIpAddrRollback;\n+import com.futurewei.alcor.portmanager.utils.BeanUtil;\n+import com.futurewei.alcor.web.entity.ip.IpAddrRequest;\n+import com.futurewei.alcor.web.entity.ip.IpVersion;\n+import com.futurewei.alcor.web.entity.port.PortState;\n+import com.futurewei.alcor.web.entity.SubnetStateJson;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.portmanager.exception.IpAddrInvalidException;\n+import com.futurewei.alcor.portmanager.exception.IpVersionInvalidException;\n+import com.futurewei.alcor.portmanager.rollback.AllocateIpAddrRollback;\n+import com.futurewei.alcor.portmanager.rollback.PortStateRollback;\n+import com.futurewei.alcor.portmanager.rollback.ReleaseIpAddrRollback;\n+import com.futurewei.alcor.web.rest.SubnetRest;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Stack;\n+\n+public class IpAddressRestWrap {\n+    private IpAddressRest ipAddressRest;\n+    private SubnetRest subnetRest;\n+    private Stack<PortStateRollback> rollbacks;\n+    private String projectId;\n+\n+    public IpAddressRestWrap(Stack<PortStateRollback> rollbacks, String projectId) {\n+        ipAddressRest = BeanUtil.getBean(IpAddressRest.class);\n+        subnetRest = BeanUtil.getBean(SubnetRest.class);\n+        this.rollbacks = rollbacks;\n+        this.projectId = projectId;\n+    }\n+\n+    private int getIpVersion(String ipAddress) throws Exception {\n+        if (Ipv4AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV4.getVersion();\n+        } else if (Ipv6AddrUtil.formatCheck(ipAddress)) {\n+            return IpVersion.IPV6.getVersion();\n+        } else {\n+            throw new IpAddrInvalidException();\n+        }\n+    }\n+\n+    private String getRangeIdBySubnetId(String subnetId, int ipVersion) throws Exception {\n+        SubnetStateJson subnetStateJson = subnetRest.getSubnetState(projectId, subnetId);\n+        if (subnetStateJson == null || subnetStateJson.getSubnet() == null) {\n+            throw new VerifySubnetException();\n+        }\n+\n+        if (IpVersion.IPV4.getVersion() == ipVersion) {\n+            return subnetStateJson.getSubnet().getIpV4RangeId();\n+        } else if (IpVersion.IPV6.getVersion() == ipVersion) {\n+            return subnetStateJson.getSubnet().getIpV4RangeId();\n+        }\n+\n+        throw new IpVersionInvalidException();\n+    }\n+\n+    private void addIpAddrRollback(AbstractIpAddrRollback rollback, IpAddrRequest ipAddr) {\n+        if (rollback instanceof AllocateIpAddrRollback) {\n+            rollback.putAllocatedIpAddress(ipAddr);\n+        } else {\n+            rollback.putReleasedIpAddress(ipAddr);\n+        }\n+\n+        rollbacks.push(rollback);\n+    }\n+\n+    public List<IpAddrRequest> allocateIpAddress(Object args) throws Exception {\n+        List<IpAddrRequest> ipAddrRequests = new ArrayList<>();\n+        PortState portState = (PortState)args;\n+\n+        IpAddrRequest result = ipAddressRest.allocateIpAddress(IpVersion.IPV4,", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5ODkxNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424898915", "bodyText": "There is no ipVersion field in portState, do you think only ipv4 address is assigned to port by default, or both ipv4 and ipv6 addresses are assigned?", "author": "chenpiaoping", "createdAt": "2020-05-14T06:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MjQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMjAwMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424902000", "bodyText": "I see. Ipv4v6 is something we need to support as well. Maybe put it in your backlog and do it when you get a chance.", "author": "xieus", "createdAt": "2020-05-14T06:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MjQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MjkyNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424882924", "bodyText": "allocateIpAddress => allocateRandomIpAddress\nverifyIpAddresses=> allocateFixedIpAddress", "author": "xieus", "createdAt": "2020-05-14T05:42:52Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,392 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.NodeRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.port.*;\n+import com.futurewei.alcor.web.entity.host.*;\n+import com.futurewei.alcor.web.entity.RouterState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks) {\n+        while (!rollbacks.isEmpty()) {\n+            PortStateRollback rollback = rollbacks.pop();\n+\n+            try {\n+                rollback.doRollback();\n+            } catch (Exception e) {\n+                LOG.error(\"{} roll back failed: {}\", rollback, e);\n+            }\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    public PortStateJson createPortState(String projectId, PortStateJson portStateJson) throws Exception {\n+        LOG.debug(\"Create port state, projectId: {}, PortStateJson: {}\", projectId, portStateJson);\n+\n+        Stack<PortStateRollback> rollbacks = new Stack<>();\n+        AsyncExecutor executor = new AsyncExecutor();\n+\n+        PortState portState = portStateJson.getPortState();\n+        portState.setProjectId(projectId);\n+\n+        try {\n+            //Verify VPC ID\n+            VpcRestWrap vpcRestWrap = new VpcRestWrap(rollbacks);\n+            executor.runAsync(vpcRestWrap::verifyVpc, portState);\n+\n+            IpAddressRestWrap ipAddressRestWrap = new IpAddressRestWrap(rollbacks, portState.getProjectId());\n+            if (portState.getFixedIps() == null) {\n+                executor.runAsync(ipAddressRestWrap::allocateIpAddress, portState);\n+            } else {\n+                executor.runAsync(ipAddressRestWrap::verifyIpAddresses, portState.getFixedIps());", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5OTk5OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424899999", "bodyText": "sounds reasonable.", "author": "chenpiaoping", "createdAt": "2020-05-14T06:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4MjkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4Mzc4MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424883781", "bodyText": "allocateMacAddress => allocateRandomMacAddress\nverifyMacAddress => allocateFixedMacAddress", "author": "xieus", "createdAt": "2020-05-14T05:45:55Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,392 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.NodeRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.port.*;\n+import com.futurewei.alcor.web.entity.host.*;\n+import com.futurewei.alcor.web.entity.RouterState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks) {\n+        while (!rollbacks.isEmpty()) {\n+            PortStateRollback rollback = rollbacks.pop();\n+\n+            try {\n+                rollback.doRollback();\n+            } catch (Exception e) {\n+                LOG.error(\"{} roll back failed: {}\", rollback, e);\n+            }\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    public PortStateJson createPortState(String projectId, PortStateJson portStateJson) throws Exception {\n+        LOG.debug(\"Create port state, projectId: {}, PortStateJson: {}\", projectId, portStateJson);\n+\n+        Stack<PortStateRollback> rollbacks = new Stack<>();\n+        AsyncExecutor executor = new AsyncExecutor();\n+\n+        PortState portState = portStateJson.getPortState();\n+        portState.setProjectId(projectId);\n+\n+        try {\n+            //Verify VPC ID\n+            VpcRestWrap vpcRestWrap = new VpcRestWrap(rollbacks);\n+            executor.runAsync(vpcRestWrap::verifyVpc, portState);\n+\n+            IpAddressRestWrap ipAddressRestWrap = new IpAddressRestWrap(rollbacks, portState.getProjectId());\n+            if (portState.getFixedIps() == null) {\n+                executor.runAsync(ipAddressRestWrap::allocateIpAddress, portState);\n+            } else {\n+                executor.runAsync(ipAddressRestWrap::verifyIpAddresses, portState.getFixedIps());\n+            }\n+\n+            //Generate uuid for port\n+            if (portState.getId() == null) {\n+                portState.setId(UUID.randomUUID().toString());\n+            }\n+\n+            MacAddressRestWrap macAddressRestWrap = new MacAddressRestWrap(rollbacks);\n+            if (portState.getMacAddress() == null) {\n+                executor.runAsync(macAddressRestWrap::allocateMacAddress, portState);\n+            } else {\n+                executor.runAsync(macAddressRestWrap::verifyMacAddress, portState);", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjIwMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424886203", "bodyText": "API (2) in Mac manager actually could set a fixed mac address in the rest body (the impl might not be there but at least the interface has that).\nRef: https://github.com/futurewei-cloud/alcor/blob/master/docs/design/mac_manager.adoc", "author": "xieus", "createdAt": "2020-05-14T05:54:12Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/restwrap/MacAddressRestWrap.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.restwrap;\n+\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.utils.BeanUtil;\n+import com.futurewei.alcor.web.entity.mac.MacState;\n+import com.futurewei.alcor.web.entity.mac.MacStateJson;\n+import com.futurewei.alcor.web.entity.port.PortState;\n+import com.futurewei.alcor.web.rest.MacAddressRest;\n+import java.util.Stack;\n+\n+public class MacAddressRestWrap {\n+    private MacAddressRest macAddressRest;\n+    private Stack<PortStateRollback> rollbacks;\n+\n+    public MacAddressRestWrap(Stack<PortStateRollback> rollbacks) {\n+        macAddressRest = BeanUtil.getBean(MacAddressRest.class);\n+        this.rollbacks = rollbacks;\n+    }\n+\n+    private void addMacAddrRollback(AbstractMacAddrRollback rollback, MacState macState) {\n+        if (rollback instanceof AllocateMacAddrRollback) {\n+            rollback.putAllocatedMacAddress(macState);\n+        } else {\n+            rollback.putReleasedMacAddress(macState);\n+        }\n+\n+        rollbacks.push(rollback);\n+    }\n+\n+    public MacStateJson allocateMacAddress(Object args) throws Exception {\n+        PortState portState = (PortState)args;\n+\n+        MacStateJson result = macAddressRest.allocateMacAddress(portState.getProjectId(), portState.getVpcId(), portState.getId());\n+        portState.setMacAddress(result.getMacState().getMacAddress());\n+\n+        MacState macState = new MacState();\n+        macState.setProjectId(portState.getProjectId());\n+        macState.setVpcId(portState.getVpcId());\n+        macState.setMacAddress(portState.getMacAddress());\n+\n+        addMacAddrRollback(new AllocateMacAddrRollback(macAddressRest), macState);\n+\n+        return result;\n+    }\n+\n+    public MacStateJson verifyMacAddress(Object args) {\n+        //FIXME: Not support yet\n+        return null;", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMDY5MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424900691", "bodyText": "that would be nice.", "author": "chenpiaoping", "createdAt": "2020-05-14T06:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTE4OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424889189", "bodyText": "Hmm, this is really tricky. We will need a good Timeout story to upper bound the rollback.", "author": "xieus", "createdAt": "2020-05-14T06:03:31Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,392 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.NodeRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.port.*;\n+import com.futurewei.alcor.web.entity.host.*;\n+import com.futurewei.alcor.web.entity.RouterState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks) {\n+        while (!rollbacks.isEmpty()) {\n+            PortStateRollback rollback = rollbacks.pop();\n+\n+            try {\n+                rollback.doRollback();\n+            } catch (Exception e) {\n+                LOG.error(\"{} roll back failed: {}\", rollback, e);\n+            }\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    public PortStateJson createPortState(String projectId, PortStateJson portStateJson) throws Exception {\n+        LOG.debug(\"Create port state, projectId: {}, PortStateJson: {}\", projectId, portStateJson);\n+\n+        Stack<PortStateRollback> rollbacks = new Stack<>();\n+        AsyncExecutor executor = new AsyncExecutor();\n+\n+        PortState portState = portStateJson.getPortState();\n+        portState.setProjectId(projectId);\n+\n+        try {\n+            //Verify VPC ID\n+            VpcRestWrap vpcRestWrap = new VpcRestWrap(rollbacks);\n+            executor.runAsync(vpcRestWrap::verifyVpc, portState);\n+\n+            IpAddressRestWrap ipAddressRestWrap = new IpAddressRestWrap(rollbacks, portState.getProjectId());\n+            if (portState.getFixedIps() == null) {\n+                executor.runAsync(ipAddressRestWrap::allocateIpAddress, portState);\n+            } else {\n+                executor.runAsync(ipAddressRestWrap::verifyIpAddresses, portState.getFixedIps());\n+            }\n+\n+            //Generate uuid for port\n+            if (portState.getId() == null) {\n+                portState.setId(UUID.randomUUID().toString());\n+            }\n+\n+            MacAddressRestWrap macAddressRestWrap = new MacAddressRestWrap(rollbacks);\n+            if (portState.getMacAddress() == null) {\n+                executor.runAsync(macAddressRestWrap::allocateMacAddress, portState);\n+            } else {\n+                executor.runAsync(macAddressRestWrap::verifyMacAddress, portState);\n+            }\n+\n+            //Verify security group\n+\n+            //Verify Binding Host ID\n+            if (portState.getBindingHostId() != null) {\n+                NodeRestWrap nodeRestWrap = new NodeRestWrap(rollbacks);\n+                nodeRestWrap.verifyHost(portState.getBindingHostId());\n+            }\n+\n+            //Wait for all async functions to finish\n+            executor.joinAll();\n+\n+            //Persist portState\n+            portRepository.addItem(portState);\n+        } catch (Exception e) {\n+            /**\n+            When an exception occurs, we need to roll back all asynchronous operations,", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MjkyOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424892929", "bodyText": "Looks like we'll need a bit more time for updatePortState. It is fine and let us do it in next PR.", "author": "xieus", "createdAt": "2020-05-14T06:14:42Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/implement/PortServiceImpl.java", "diffHunk": "@@ -0,0 +1,392 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service.implement;\n+\n+import com.futurewei.alcor.portmanager.executor.AsyncExecutor;\n+import com.futurewei.alcor.portmanager.exception.*;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.portmanager.restwrap.IpAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.MacAddressRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.NodeRestWrap;\n+import com.futurewei.alcor.portmanager.restwrap.VpcRestWrap;\n+import com.futurewei.alcor.portmanager.rollback.*;\n+import com.futurewei.alcor.portmanager.service.PortService;\n+import com.futurewei.alcor.web.entity.port.*;\n+import com.futurewei.alcor.web.entity.host.*;\n+import com.futurewei.alcor.web.entity.RouterState;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.stereotype.Service;\n+import java.util.*;\n+\n+@Service\n+@ComponentScan(value=\"com.futurewei.alcor.web.rest\")\n+public class PortServiceImpl implements PortService {\n+    private static final Logger LOG = LoggerFactory.getLogger(PortServiceImpl.class);\n+\n+    @Autowired\n+    private PortRepository portRepository;\n+\n+    private void getDefaultSecurityGroup(PortState portState) {\n+        //FIXME: send get tenant default security group\n+        String defaultSgId =  \"tenant-default-security-group-id\";\n+\n+        List<String> securityGroups = new ArrayList<>();\n+        securityGroups.add(defaultSgId);\n+\n+        portState.setSecurityGroups(securityGroups);\n+    }\n+\n+    private void verifySecurityGroup(PortState portState) {\n+        List<String> securityGroups = portState.getSecurityGroups();\n+        String tenantId = portState.getTenantId();\n+\n+        for (String securityGroup: securityGroups) {\n+            //FIXME: send verify tenant security group\n+        }\n+    }\n+\n+    private void unbindSecurityGroups(PortState portState) {\n+\n+    }\n+\n+    private void bindSecurityGroups(PortState portState) {\n+        verifySecurityGroup(portState);\n+\n+        //FIXME: Not support yet\n+    }\n+\n+    private void rollBackAllOperations(Stack<PortStateRollback> rollbacks) {\n+        while (!rollbacks.isEmpty()) {\n+            PortStateRollback rollback = rollbacks.pop();\n+\n+            try {\n+                rollback.doRollback();\n+            } catch (Exception e) {\n+                LOG.error(\"{} roll back failed: {}\", rollback, e);\n+            }\n+        }\n+    }\n+\n+    private HostState getHostState(String hostId) {\n+        return null;\n+    }\n+\n+    private void addPortToHost(String hostId) {\n+        HostState hostState = getHostState(hostId);\n+\n+        //FIXME: Add port to Host\n+    }\n+\n+    public PortStateJson createPortState(String projectId, PortStateJson portStateJson) throws Exception {\n+        LOG.debug(\"Create port state, projectId: {}, PortStateJson: {}\", projectId, portStateJson);\n+\n+        Stack<PortStateRollback> rollbacks = new Stack<>();\n+        AsyncExecutor executor = new AsyncExecutor();\n+\n+        PortState portState = portStateJson.getPortState();\n+        portState.setProjectId(projectId);\n+\n+        try {\n+            //Verify VPC ID\n+            VpcRestWrap vpcRestWrap = new VpcRestWrap(rollbacks);\n+            executor.runAsync(vpcRestWrap::verifyVpc, portState);\n+\n+            IpAddressRestWrap ipAddressRestWrap = new IpAddressRestWrap(rollbacks, portState.getProjectId());\n+            if (portState.getFixedIps() == null) {\n+                executor.runAsync(ipAddressRestWrap::allocateIpAddress, portState);\n+            } else {\n+                executor.runAsync(ipAddressRestWrap::verifyIpAddresses, portState.getFixedIps());\n+            }\n+\n+            //Generate uuid for port\n+            if (portState.getId() == null) {\n+                portState.setId(UUID.randomUUID().toString());\n+            }\n+\n+            MacAddressRestWrap macAddressRestWrap = new MacAddressRestWrap(rollbacks);\n+            if (portState.getMacAddress() == null) {\n+                executor.runAsync(macAddressRestWrap::allocateMacAddress, portState);\n+            } else {\n+                executor.runAsync(macAddressRestWrap::verifyMacAddress, portState);\n+            }\n+\n+            //Verify security group\n+\n+            //Verify Binding Host ID\n+            if (portState.getBindingHostId() != null) {\n+                NodeRestWrap nodeRestWrap = new NodeRestWrap(rollbacks);\n+                nodeRestWrap.verifyHost(portState.getBindingHostId());\n+            }\n+\n+            //Wait for all async functions to finish\n+            executor.joinAll();\n+\n+            //Persist portState\n+            portRepository.addItem(portState);\n+        } catch (Exception e) {\n+            /**\n+            When an exception occurs, we need to roll back all asynchronous operations,\n+            and some asynchronous may not be finished yet.if we roll back at this time,\n+             they may not be completed until the rollback operation is completed.\n+             as a result, they cannot be rolled back.\n+             */\n+            executor.waitAll();\n+            rollBackAllOperations(rollbacks);\n+            throw e;\n+        }\n+\n+        LOG.info(\"Create port state success, projectId: {}, PortStateJson: {}\", projectId, portStateJson);\n+\n+        return portStateJson;\n+    }\n+\n+    private RouterState getRouterState(String routerId) {\n+        return null;\n+    }\n+\n+    private void verifyRouter(String deviceId, String tenantId) throws Exception {\n+        RouterState routerState = getRouterState(deviceId);\n+\n+        if (routerState == null) {\n+            throw new RouterNotFoundException();\n+        }\n+\n+        if (!tenantId.equals(routerState.getTenantId())) {\n+            throw new RouterNotOwnedByTenant();\n+        }\n+    }\n+\n+    private Map<String, Set<String>> fixedIpsToMap(List<PortState.FixedIp> fixedIps) {\n+        Map<String, Set<String>> subnetIpsMap = new HashMap<>();\n+\n+        for (PortState.FixedIp fixedIp: fixedIps) {\n+            if (subnetIpsMap.containsKey(fixedIp.getSubnetId())) {\n+                subnetIpsMap.get(fixedIp.getSubnetId()).add(fixedIp.getIpAddress());\n+            } else {\n+                Set<String> ips = new HashSet<>();\n+                ips.add(fixedIp.getIpAddress());\n+                subnetIpsMap.put(fixedIp.getSubnetId(), ips);\n+            }\n+        }\n+\n+        return subnetIpsMap;\n+    }\n+\n+    private List<PortState.FixedIp> fixedIpsCompare(List<PortState.FixedIp> fixedIps1, List<PortState.FixedIp> fixedIps2) {\n+        List<PortState.FixedIp> addFixedIps = new ArrayList<>();\n+        Map<String, Set<String>> subnetIpsMap = fixedIpsToMap(fixedIps2);\n+\n+        for (PortState.FixedIp fixedIp: fixedIps1) {\n+            String subnetId = fixedIp.getSubnetId();\n+            String ipAddress = fixedIp.getIpAddress();\n+            if (subnetIpsMap.containsKey(subnetId)) {\n+                if (!subnetIpsMap.get(subnetId).contains(ipAddress)) {\n+                    addFixedIps.add(fixedIp);\n+                }\n+            } else {\n+                addFixedIps.add(fixedIp);\n+            }\n+        }\n+\n+        return addFixedIps;\n+    }\n+\n+    private void updateSecurityGroup(PortState portState, PortState oldPortState) throws Exception {\n+        String deviceOwner = portState.getDeviceOwner();\n+\n+        //Network device interface does not need security groups\n+        if (deviceOwner != null && deviceOwner.indexOf(\"network\") > 0) {\n+            throw new UpdateSecurityGroupException();\n+        }\n+\n+        //Verify request security groups valid\n+        verifySecurityGroup(portState);\n+\n+        //Delete old security groups binding\n+        unbindSecurityGroups(oldPortState);\n+\n+        //Create security groups binding for port\n+        bindSecurityGroups(portState);\n+\n+        oldPortState.setSecurityGroups(portState.getSecurityGroups());\n+    }\n+\n+    private void UpdateExtraDhcpOpts(PortState portState, PortState portStateOld) {\n+\n+    }\n+\n+    private void updatePortToHost(PortState portState) {\n+\n+    }\n+\n+    public PortStateJson updatePortState(String projectId, String portId, PortStateJson portStateJson) throws Exception {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MzI3Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424893272", "bodyText": "We will need the bulk create API.", "author": "xieus", "createdAt": "2020-05-14T06:15:35Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/service/PortService.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.service;\n+\n+\n+import com.futurewei.alcor.web.entity.port.PortStateJson;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.List;\n+\n+@Service\n+public interface PortService {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NzUxNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424897516", "bodyText": "vpc/port/mac/ip/mac are in their own sub-dictionary in com.futurewei.alcor.web.entity.\nsubnet and route are still one level up.\n\nLet us create the same sub-dictionary for subnet and route. Later we could ask other microservices to use the new web classes path and retire the existing ones.", "author": "xieus", "createdAt": "2020-05-14T06:27:12Z", "path": "services/port_manager/src/test/java/com/futurewei/alcor/portmanager/controller/PortControllerTest.java", "diffHunk": "@@ -0,0 +1,335 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.controller;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.futurewei.alcor.portmanager.config.UnitTestConfig;\n+import com.futurewei.alcor.portmanager.repo.PortRepository;\n+import com.futurewei.alcor.web.entity.port.*;\n+import com.futurewei.alcor.web.entity.mac.*;\n+import com.futurewei.alcor.web.entity.vpc.*;", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMzk0OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424903949", "bodyText": "subnet and route are still one level up.--->This will cause other microservices to fail to compile. or I need to modify the code of other microservices. Can I do this in the next PR?", "author": "chenpiaoping", "createdAt": "2020-05-14T06:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NzUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNjIzNw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424906237", "bodyText": "I would suggest you to add two new sub-dictionaries, one for subnet and the other for route, copy those web classes to the new dictionaries, and reference only in PortManager.\nWe would ask other microservice owners to make the change pointing to the new classes and then remove old/existing ones.", "author": "xieus", "createdAt": "2020-05-14T06:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NzUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNzA5MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424907090", "bodyText": "Got it.", "author": "chenpiaoping", "createdAt": "2020-05-14T06:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NzUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMDI5MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424900290", "bodyText": "Maybe rename it to \"IpAddressRestWrapper\". It applies to other classes in the same directory and the directory itself.", "author": "xieus", "createdAt": "2020-05-14T06:34:16Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/restwrap/IpAddressRestWrap.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.portmanager.restwrap;\n+\n+import com.futurewei.alcor.common.utils.Ipv4AddrUtil;\n+import com.futurewei.alcor.common.utils.Ipv6AddrUtil;\n+import com.futurewei.alcor.portmanager.exception.RangeIdNotFoundException;\n+import com.futurewei.alcor.portmanager.exception.VerifySubnetException;\n+import com.futurewei.alcor.portmanager.rollback.AbstractIpAddrRollback;\n+import com.futurewei.alcor.portmanager.utils.BeanUtil;\n+import com.futurewei.alcor.web.entity.ip.IpAddrRequest;\n+import com.futurewei.alcor.web.entity.ip.IpVersion;\n+import com.futurewei.alcor.web.entity.port.PortState;\n+import com.futurewei.alcor.web.entity.SubnetStateJson;\n+import com.futurewei.alcor.web.rest.IpAddressRest;\n+import com.futurewei.alcor.portmanager.exception.IpAddrInvalidException;\n+import com.futurewei.alcor.portmanager.exception.IpVersionInvalidException;\n+import com.futurewei.alcor.portmanager.rollback.AllocateIpAddrRollback;\n+import com.futurewei.alcor.portmanager.rollback.PortStateRollback;\n+import com.futurewei.alcor.portmanager.rollback.ReleaseIpAddrRollback;\n+import com.futurewei.alcor.web.rest.SubnetRest;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Stack;\n+\n+public class IpAddressRestWrap {", "originalCommit": "0a23e9a6c01b9e9739544cc9dbda1e4f23816cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNzU3NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424917574", "bodyText": "I always think wrap or wrapper is not a good name. Do you have any good suggestions?", "author": "chenpiaoping", "createdAt": "2020-05-14T07:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMDI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkyMjg1Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r424922857", "bodyText": "A few options:\n\nIpAddressRestCoordinator\nIpAddressRestWorker\nIpAddressRestTask\n\n@chenpiaoping It is up to you :-)", "author": "xieus", "createdAt": "2020-05-14T07:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMDI5MA=="}], "type": "inlineReview"}, {"oid": "5843fe701503ff2f9edef48d83723d3d26266945", "url": "https://github.com/futurewei-cloud/alcor/commit/5843fe701503ff2f9edef48d83723d3d26266945", "message": "made some optimizations according to the review suggestions", "committedDate": "2020-05-14T11:34:17Z", "type": "forcePushed"}, {"oid": "5b84398db6881e2b59f4578ee858b81dec38879e", "url": "https://github.com/futurewei-cloud/alcor/commit/5b84398db6881e2b59f4578ee858b81dec38879e", "message": "made some optimizations according to the review suggestions", "committedDate": "2020-05-14T11:36:13Z", "type": "forcePushed"}, {"oid": "aa8c0f97a1364612491af1d5515bd90884372a80", "url": "https://github.com/futurewei-cloud/alcor/commit/aa8c0f97a1364612491af1d5515bd90884372a80", "message": "made some optimizations according to the review suggestions", "committedDate": "2020-05-14T11:41:43Z", "type": "forcePushed"}, {"oid": "aa8c0f97a1364612491af1d5515bd90884372a80", "url": "https://github.com/futurewei-cloud/alcor/commit/aa8c0f97a1364612491af1d5515bd90884372a80", "message": "made some optimizations according to the review suggestions", "committedDate": "2020-05-14T11:41:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA3Nzg0MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425077841", "bodyText": "Very nice comments! Thank you.", "author": "xieus", "createdAt": "2020-05-14T11:52:27Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/controller/PortController.java", "diffHunk": "@@ -30,6 +30,16 @@\n     @Autowired\n     PortService portService;\n \n+    /**\n+     * Create a port, and call the interfaces of each micro-service according to the", "originalCommit": "aa8c0f97a1364612491af1d5515bd90884372a80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3394dd38f58f096974315ff0a9a06ee779d97b1e", "url": "https://github.com/futurewei-cloud/alcor/commit/3394dd38f58f096974315ff0a9a06ee779d97b1e", "message": "Merge branch 'master' into port-manager", "committedDate": "2020-05-14T11:58:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425081070", "bodyText": "@chenpiaoping, my previous comment may not be 100% clear. I meant that IPv4 only and Ipv4v6 should both be supported, with IPv4 only the default option.", "author": "xieus", "createdAt": "2020-05-14T11:58:53Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/proxy/IpManagerProxy.java", "diffHunk": "@@ -84,27 +84,47 @@ private void addIpAddrRollback(AbstractIpAddrRollback rollback, IpAddrRequest ip\n         rollbacks.push(rollback);\n     }\n \n-    public List<IpAddrRequest> allocateIpAddress(Object args) throws Exception {\n+    /**\n+     * Allocate a random ipv4 and ipv6 address from ip manager service\n+     * @param args PortState\n+     * @return A list of IpAddrRequest\n+     * @throws Exception Rest request exception", "originalCommit": "aa8c0f97a1364612491af1d5515bd90884372a80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NDc2Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425084762", "bodyText": "I see, should i revert it?", "author": "chenpiaoping", "createdAt": "2020-05-14T12:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NzA0Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425087047", "bodyText": "Those are good change. Maybe by default we only trigger Ipv4 allocation, but add one more flag to trigger additional Ipv6 allocation.\nNeutron may or may not have this field. Let me quickly check.", "author": "xieus", "createdAt": "2020-05-14T12:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5MDY3Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425090676", "bodyText": "I think if there is ipv6 subnet in the vpc, the ipv6 address will be assigned.", "author": "chenpiaoping", "createdAt": "2020-05-14T12:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5MTgxMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425091812", "bodyText": "My current implementation may not be very reasonable.", "author": "chenpiaoping", "createdAt": "2020-05-14T12:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5Nzc5NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425097795", "bodyText": "It is totally fine, we do the development and design in an iterative/agile way: When we find it something not right, we change it quickly.\nMy current thinking is: This should be a consistent behavior on VPC level. If a VPC allows Ipv6, every of its Subnets will have Ipv6 ranges therefore trigger Ipv4v6 allocation here.\nIn our Subnet Object, there is a Ipv4RangeId and a Ipv6RangeId. Therefore our logic could be that if the Ipv6RangeId is not null, we allocate Ipv6 here. Does this make sense?", "author": "xieus", "createdAt": "2020-05-14T12:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTg3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425099870", "bodyText": "Agree with you, but i think i need to make some changes in ip manager.", "author": "chenpiaoping", "createdAt": "2020-05-14T12:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMTE1NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425101155", "bodyText": "It's time for me to get off work, will do it tomorrow.", "author": "chenpiaoping", "createdAt": "2020-05-14T12:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMjA5NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425102094", "bodyText": "I see. Might not be a small change considering here requires a full set of UTs.\nLet us comment out Ipv6 allocation part in this PR, and continue to improve it in next PR.", "author": "xieus", "createdAt": "2020-05-14T12:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4MTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NDk5OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425084998", "bodyText": "is this a macAddress or macId?", "author": "xieus", "createdAt": "2020-05-14T12:06:35Z", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/MacManagerRestClient.java", "diffHunk": "@@ -40,11 +40,12 @@ public void releaseMacAddress(String macAddress) throws Exception {\n         restTemplate.delete(url);\n     }\n \n-    public MacStateJson allocateMacAddress(String projectId, String vpcId, String portId) throws Exception {\n+    public MacStateJson allocateMacAddress(String projectId, String vpcId, String portId, String mac) throws Exception {", "originalCommit": "aa8c0f97a1364612491af1d5515bd90884372a80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NTgyMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425085822", "bodyText": "macAddress", "author": "chenpiaoping", "createdAt": "2020-05-14T12:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NDk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NjI3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425086273", "bodyText": "Let me rename it.", "author": "chenpiaoping", "createdAt": "2020-05-14T12:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NDk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIyNjIzMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/180#discussion_r425226231", "bodyText": "No worries. I made changes to expedite the merge.", "author": "xieus", "createdAt": "2020-05-14T15:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4NDk5OA=="}], "type": "inlineReview"}, {"oid": "c5060b0df148762d920344a35e2880f22ecc4f77", "url": "https://github.com/futurewei-cloud/alcor/commit/c5060b0df148762d920344a35e2880f22ecc4f77", "message": "Add Swagger doc/ui support", "committedDate": "2020-05-14T14:25:26Z", "type": "commit"}, {"oid": "b08ac39a8a5ac38db55fde37265657d84eb7a8ae", "url": "https://github.com/futurewei-cloud/alcor/commit/b08ac39a8a5ac38db55fde37265657d84eb7a8ae", "message": "Turn on partial UTs and change rest field from port_state to port", "committedDate": "2020-05-14T15:15:45Z", "type": "commit"}, {"oid": "7a618600d092dd762c92c13388bae5d4f0442bc5", "url": "https://github.com/futurewei-cloud/alcor/commit/7a618600d092dd762c92c13388bae5d4f0442bc5", "message": "Rename mac to macAddress in MacManagerRestClient and MacManagerProxy", "committedDate": "2020-05-14T15:26:35Z", "type": "commit"}]}