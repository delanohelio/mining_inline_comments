{"pr_number": 458, "pr_title": "[Data Plane Mgr] UT Test Automation - Part III", "pr_createdAt": "2020-10-30T22:48:38Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/458", "timeline": [{"oid": "24b9b76ae349f277ac55f1cc11e81636d1569b6d", "url": "https://github.com/futurewei-cloud/alcor/commit/24b9b76ae349f277ac55f1cc11e81636d1569b6d", "message": "commit message", "committedDate": "2020-10-07T21:49:22Z", "type": "commit"}, {"oid": "08ec421662ef56559a388e6c7308aa47cfd07a6b", "url": "https://github.com/futurewei-cloud/alcor/commit/08ec421662ef56559a388e6c7308aa47cfd07a6b", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-07T22:00:25Z", "type": "commit"}, {"oid": "2507b8fc44a4ca94da310b73c11453cec9f2504b", "url": "https://github.com/futurewei-cloud/alcor/commit/2507b8fc44a4ca94da310b73c11453cec9f2504b", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-15T17:12:49Z", "type": "commit"}, {"oid": "8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "url": "https://github.com/futurewei-cloud/alcor/commit/8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-15T23:33:06Z", "type": "commit"}, {"oid": "d9d2a5822429286e2b01ce0842f16cb70dc5168f", "url": "https://github.com/futurewei-cloud/alcor/commit/d9d2a5822429286e2b01ce0842f16cb70dc5168f", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-16T16:57:50Z", "type": "commit"}, {"oid": "daba98ee8949b91b2b77f74c6fbb30529355ee51", "url": "https://github.com/futurewei-cloud/alcor/commit/daba98ee8949b91b2b77f74c6fbb30529355ee51", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-20T00:03:13Z", "type": "commit"}, {"oid": "b813735c5032b70928a2304007875824f5ccedca", "url": "https://github.com/futurewei-cloud/alcor/commit/b813735c5032b70928a2304007875824f5ccedca", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-22T17:43:05Z", "type": "commit"}, {"oid": "9e649da5263b3e609ee4e4c21c3edac6eac09f2e", "url": "https://github.com/futurewei-cloud/alcor/commit/9e649da5263b3e609ee4e4c21c3edac6eac09f2e", "message": " update", "committedDate": "2020-10-23T01:13:41Z", "type": "commit"}, {"oid": "add587475fe3ade06c29b61fe062edd51f629ce0", "url": "https://github.com/futurewei-cloud/alcor/commit/add587475fe3ade06c29b61fe062edd51f629ce0", "message": "update", "committedDate": "2020-10-23T10:27:49Z", "type": "commit"}, {"oid": "fc32dde750943a6a0e25c27049fe2189a49b1252", "url": "https://github.com/futurewei-cloud/alcor/commit/fc32dde750943a6a0e25c27049fe2189a49b1252", "message": "update", "committedDate": "2020-10-23T22:48:14Z", "type": "commit"}, {"oid": "9b4e7171d324a2550e5df3e159976a6e37796512", "url": "https://github.com/futurewei-cloud/alcor/commit/9b4e7171d324a2550e5df3e159976a6e37796512", "message": "update", "committedDate": "2020-10-28T19:29:25Z", "type": "commit"}, {"oid": "fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "url": "https://github.com/futurewei-cloud/alcor/commit/fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-28T19:40:54Z", "type": "commit"}, {"oid": "e44875aa2fa685b2252647f413c704dce7a21611", "url": "https://github.com/futurewei-cloud/alcor/commit/e44875aa2fa685b2252647f413c704dce7a21611", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-29T18:42:59Z", "type": "commit"}, {"oid": "8d43f2c18ce09a7e8841102fc1dbed24477b4e6d", "url": "https://github.com/futurewei-cloud/alcor/commit/8d43f2c18ce09a7e8841102fc1dbed24477b4e6d", "message": "update", "committedDate": "2020-10-30T22:41:38Z", "type": "commit"}, {"oid": "98dcf0dbb1c950ee71a0d663a7042cbce30d24ed", "url": "https://github.com/futurewei-cloud/alcor/commit/98dcf0dbb1c950ee71a0d663a7042cbce30d24ed", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-30T22:44:46Z", "type": "commit"}, {"oid": "b78dc9067badc5f44b32e2aef12e59c41d9825fa", "url": "https://github.com/futurewei-cloud/alcor/commit/b78dc9067badc5f44b32e2aef12e59c41d9825fa", "message": "Merge branch 'new_master' into feature/dpm_auto_test_third_version\n\n# Conflicts:\n#\tservices/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/utils/GoalStateManager.java", "committedDate": "2020-10-30T22:46:44Z", "type": "commit"}, {"oid": "606dc9400b6378ca79a15eea08539e0ff76dd114", "url": "https://github.com/futurewei-cloud/alcor/commit/606dc9400b6378ca79a15eea08539e0ff76dd114", "message": "update", "committedDate": "2020-11-02T22:58:54Z", "type": "commit"}, {"oid": "ecab50a6787ed4330f3562c4c424565d5439379d", "url": "https://github.com/futurewei-cloud/alcor/commit/ecab50a6787ed4330f3562c4c424565d5439379d", "message": "update", "committedDate": "2020-11-03T04:41:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMDg4MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516430881", "bodyText": "I think we could revert the change as it is related to PR #418 .", "author": "xieus", "createdAt": "2020-11-03T05:10:13Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/utils/GoalStateManager.java", "diffHunk": "@@ -46,418 +46,418 @@\n public class GoalStateManager {\n     public static final int FORMAT_REVISION_NUMBER = 1;\n     @Autowired private GoalStateService goalStateService;\n-  private static final Logger LOG = LoggerFactory.getLogger();\n-\n-  private void printNetworkConfiguration(NetworkConfiguration networkConfiguration)\n-  {\n-    LOG.log(Level.INFO,\n-            \"### networkConf str: \"+networkConfiguration.toString());\n-    ExclusionStrategy myExclusionStrategy =\n-            new ExclusionStrategy() {\n-              @Override\n-              public boolean shouldSkipField(FieldAttributes fa) {\n-                return fa.getName().equals(\"tenantId\");\n-              }\n-\n-              @Override\n-              public boolean shouldSkipClass(Class<?> clazz) {\n-                return false;\n-              }\n-            };\n-    Gson gson = new GsonBuilder().setExclusionStrategies(myExclusionStrategy).create();\n-    LOG.log(Level.INFO,\"###############\");\n-    LOG.log(Level.INFO,gson.toJson(networkConfiguration));\n-  }\n-  /**\n-   * transform client of dpm msg to aca protobuf format\n-   *\n-   * @param networkConfiguration  msg to be transformmed\n-   * @return Map<String, Goalstate.GoalState>\n-   * @throws RuntimeException Various exceptions that may occur during the send process\n-   */\n-  public Map<String, Goalstate.GoalState> transformNorthToSouth(\n-      NetworkConfiguration networkConfiguration) throws RuntimeException {\n-    // print entry input\n-    printNetworkConfiguration(networkConfiguration);\n-\n-    Map<String, Set<String>> portsInSameSubnetMap = new HashMap<>();\n-\n-    Map<String, Set<NeighborInfo>> neighborInfoInSameSubenetMap = new HashMap<>();\n-\n-    InternalPortEntity[] portStatesArr =\n-        networkConfiguration.getPortEntities().toArray(new InternalPortEntity[0]);\n-    InternalSubnetEntity[] subnetArr =\n-        networkConfiguration.getSubnets().toArray(new InternalSubnetEntity[0]);\n-    com.futurewei.alcor.web.entity.vpc.VpcEntity[] vpcArr =\n-        networkConfiguration.getVpcs().toArray(new com.futurewei.alcor.web.entity.vpc.VpcEntity[0]);\n-\n-    // TODO need to v2 subnet and vpc part when logic is\n-    //  clear and integration done\n-    Map<String, List<InternalPortEntity>> mapGroupedByHostIp = new HashMap();\n-    Map<String, InternalSubnetEntity> subnetMap = new HashMap<>();\n-    Map<String, InternalPortEntity> portMap = new HashMap<>();\n-    Map<String, com.futurewei.alcor.web.entity.vpc.VpcEntity> vpcMap = new HashMap<>();\n-    // construct map from list\n-    for (InternalSubnetEntity s : subnetArr) {\n-      subnetMap.put(s.getId(), s);\n+    private static final Logger LOG = LoggerFactory.getLogger();\n+\n+    private void printNetworkConfiguration(NetworkConfiguration networkConfiguration)", "originalCommit": "ecab50a6787ed4330f3562c4c424565d5439379d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1NDM3NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516854375", "bodyText": "Sure", "author": "kevin-zhonghao", "createdAt": "2020-11-03T17:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMDg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzk2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r517837969", "bodyText": "I think we could revert the change as it is related to PR #418 .\n\n@kevin-zhonghao I think this PR still contains payload from PR #418, which should not be included in this PR.", "author": "xieus", "createdAt": "2020-11-05T07:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMDg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMDk5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516430992", "bodyText": "Let us remove if not needed.", "author": "xieus", "createdAt": "2020-11-03T05:10:48Z", "path": "services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java", "diffHunk": "@@ -355,31 +416,38 @@ private InternalSubnetEntity getInternalSubnetEntity(NetworkConfiguration networ\n      * @throws Exception\n      */\n     private void buildSubnetState(NetworkConfiguration networkConfig, Goalstate.GoalState.Builder goalStateBuilder) throws Exception {\n-        List<Port.PortState> portStates = goalStateBuilder.getPortStatesList();\n-        if (portStates == null || portStates.size() == 0) {\n+        List<InternalSubnetEntity> subnets = networkConfig.getSubnets();\n+        if (subnets == null || subnets.size() == 0) {\n             return;\n         }\n-\n-        List<InternalSubnetEntity> subnetEntities = new ArrayList<>();\n-        List<String> subnetIdsInFixedIP = new ArrayList<>();\n-        for (Port.PortState portState: portStates) {\n-            for (Port.PortConfiguration.FixedIp fixedIp: portState.getConfiguration().getFixedIpsList()) {\n-                if (!subnetIdsInFixedIP.contains(fixedIp.getSubnetId())) {\n-                    InternalSubnetEntity internalSubnetEntity = getInternalSubnetEntity(\n-                            networkConfig, fixedIp.getSubnetId());\n-                    subnetEntities.add(internalSubnetEntity);\n-                    subnetIdsInFixedIP.add(fixedIp.getSubnetId());\n-                }\n-            }\n-        }\n-\n-        for (InternalSubnetEntity subnetEntity: subnetEntities) {\n+//        List<Port.PortState> portStates = goalStateBuilder.getPortStatesList();\n+//        if (portStates == null || portStates.size() == 0) {\n+//            return;\n+//        }\n+//\n+//        List<InternalSubnetEntity> subnetEntities = new ArrayList<>();\n+//        List<String> subnetIdsInFixedIP = new ArrayList<>();\n+//        for (Port.PortState portState: portStates) {\n+//            for (Port.PortConfiguration.FixedIp fixedIp: portState.getConfiguration().getFixedIpsList()) {\n+//                if (!subnetIdsInFixedIP.contains(fixedIp.getSubnetId())) {\n+//                    InternalSubnetEntity internalSubnetEntity = getInternalSubnetEntity(\n+//                            networkConfig, fixedIp.getSubnetId());\n+//                    subnetEntities.add(internalSubnetEntity);\n+//                    subnetIdsInFixedIP.add(fixedIp.getSubnetId());\n+//                }\n+//            }", "originalCommit": "ecab50a6787ed4330f3562c4c424565d5439379d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkzNzk2MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516937960", "bodyText": "Sure", "author": "kevin-zhonghao", "createdAt": "2020-11-03T20:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMDk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMTQ4NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516431485", "bodyText": "@kevin-zhonghao As this change is a pretty big change, could you please generate a few input and output using the UT framework? Let us review them together tomorrow.", "author": "xieus", "createdAt": "2020-11-03T05:13:04Z", "path": "services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java", "diffHunk": "@@ -79,21 +120,35 @@ public NetworkConfiguration autoGenerateUTsInput(int operationType,\n             InternalRouterInfo routerInfo = new InternalRouterInfo();\n             InternalRouterConfiguration internalRouterConfiguration = new InternalRouterConfiguration();\n             List<InternalSubnetRoutingTable> subnet_routing_tables = new ArrayList<>();\n+            for (int i = 0; i < subnetNum; i ++) {", "originalCommit": "ecab50a6787ed4330f3562c4c424565d5439379d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkzODEwNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/458#discussion_r516938106", "bodyText": "NP", "author": "kevin-zhonghao", "createdAt": "2020-11-03T20:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQzMTQ4NQ=="}], "type": "inlineReview"}, {"oid": "deb44dc701592f4c8bd8bca2ac8e55fd6f2dfbea", "url": "https://github.com/futurewei-cloud/alcor/commit/deb44dc701592f4c8bd8bca2ac8e55fd6f2dfbea", "message": "update", "committedDate": "2020-11-03T18:02:34Z", "type": "commit"}, {"oid": "1c5cfefbc856e9d708ce1f07bf009600770ba5ce", "url": "https://github.com/futurewei-cloud/alcor/commit/1c5cfefbc856e9d708ce1f07bf009600770ba5ce", "message": "update", "committedDate": "2020-11-03T21:47:55Z", "type": "commit"}, {"oid": "a9c3a47d74ba5fffbe13746ee4e33af0fbb394fe", "url": "https://github.com/futurewei-cloud/alcor/commit/a9c3a47d74ba5fffbe13746ee4e33af0fbb394fe", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-11-03T23:40:18Z", "type": "commit"}, {"oid": "b8bb56aaab6ca179b7a2350dc250db5d1171aac7", "url": "https://github.com/futurewei-cloud/alcor/commit/b8bb56aaab6ca179b7a2350dc250db5d1171aac7", "message": "update", "committedDate": "2020-11-04T22:14:10Z", "type": "commit"}, {"oid": "a6c1884a4c1e5fd3c318b3b8b82d2a649ac32d28", "url": "https://github.com/futurewei-cloud/alcor/commit/a6c1884a4c1e5fd3c318b3b8b82d2a649ac32d28", "message": "update", "committedDate": "2020-11-04T22:16:23Z", "type": "commit"}, {"oid": "f058bd1edef55af8ab0e25cb7b043fa6c04c272f", "url": "https://github.com/futurewei-cloud/alcor/commit/f058bd1edef55af8ab0e25cb7b043fa6c04c272f", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-11-05T07:42:35Z", "type": "commit"}, {"oid": "2b8370972be6937aa3555f6b9d5a760e4869c90c", "url": "https://github.com/futurewei-cloud/alcor/commit/2b8370972be6937aa3555f6b9d5a760e4869c90c", "message": "Merge branch 'new_master' into feature/dpm_auto_test_third_version", "committedDate": "2020-11-05T07:43:32Z", "type": "commit"}, {"oid": "febead8c7c92ba36b71e9dcae04b30687a5e70ba", "url": "https://github.com/futurewei-cloud/alcor/commit/febead8c7c92ba36b71e9dcae04b30687a5e70ba", "message": "update", "committedDate": "2020-11-05T07:51:11Z", "type": "commit"}, {"oid": "d82aafacebc7a6654f1da149c6e10e35e21eac8e", "url": "https://github.com/futurewei-cloud/alcor/commit/d82aafacebc7a6654f1da149c6e10e35e21eac8e", "message": "update", "committedDate": "2020-11-05T07:54:28Z", "type": "commit"}, {"oid": "6575a7e076ead174daa745107070c21af6b6ad54", "url": "https://github.com/futurewei-cloud/alcor/commit/6575a7e076ead174daa745107070c21af6b6ad54", "message": "update", "committedDate": "2020-11-05T07:57:09Z", "type": "commit"}, {"oid": "df0f5cef9d55969ec7caafcce72cf9ec934b1dcf", "url": "https://github.com/futurewei-cloud/alcor/commit/df0f5cef9d55969ec7caafcce72cf9ec934b1dcf", "message": "update", "committedDate": "2020-11-05T07:58:15Z", "type": "commit"}]}