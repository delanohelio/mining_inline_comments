{"pr_number": 206, "pr_title": "[MAC Manager] Enhance UTs, exception handling, and comments", "pr_createdAt": "2020-05-20T19:56:03Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/206", "timeline": [{"oid": "1645a5318fb80a959062e7bef6fb7e641e40a94b", "url": "https://github.com/futurewei-cloud/alcor/commit/1645a5318fb80a959062e7bef6fb7e641e40a94b", "message": "[Micro services] MAC manager", "committedDate": "2020-05-09T06:22:50Z", "type": "commit"}, {"oid": "a0360124c0907ec52d7c71752a21e4733050b473", "url": "https://github.com/futurewei-cloud/alcor/commit/a0360124c0907ec52d7c71752a21e4733050b473", "message": "[Micro services] MAC manager - updated pom.xml", "committedDate": "2020-05-14T01:04:02Z", "type": "commit"}, {"oid": "d03f84e5ee39c8087f44b382b89518e9c5e25343", "url": "https://github.com/futurewei-cloud/alcor/commit/d03f84e5ee39c8087f44b382b89518e9c5e25343", "message": "[Micro services] MAC manager - updated pom.xml & configuration", "committedDate": "2020-05-14T01:19:25Z", "type": "commit"}, {"oid": "250783f74b70faea9b56d3f333bfd1fb70b91118", "url": "https://github.com/futurewei-cloud/alcor/commit/250783f74b70faea9b56d3f333bfd1fb70b91118", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor", "committedDate": "2020-05-14T01:24:13Z", "type": "commit"}, {"oid": "1e2844486ff79f07ef70979a8a66a3ec2db85390", "url": "https://github.com/futurewei-cloud/alcor/commit/1e2844486ff79f07ef70979a8a66a3ec2db85390", "message": "Merge branch 'master' into eunju/macmanager", "committedDate": "2020-05-14T01:27:29Z", "type": "commit"}, {"oid": "b321524166cd46663f401a02aeac381467d4a270", "url": "https://github.com/futurewei-cloud/alcor/commit/b321524166cd46663f401a02aeac381467d4a270", "message": "[Micro serices] MAC manager - add config file", "committedDate": "2020-05-14T02:14:58Z", "type": "commit"}, {"oid": "bbd468611102b1da0500bc42aaf45b01d512627d", "url": "https://github.com/futurewei-cloud/alcor/commit/bbd468611102b1da0500bc42aaf45b01d512627d", "message": "Merge branch 'master' of https://github.com/kimeunju108/alcor into eunju/macmanager", "committedDate": "2020-05-14T02:18:12Z", "type": "commit"}, {"oid": "8e67eab0e9220d93a49cf9604dcfff9ccaacc72f", "url": "https://github.com/futurewei-cloud/alcor/commit/8e67eab0e9220d93a49cf9604dcfff9ccaacc72f", "message": "[Micro services] MAC manager - moved swagger config to config package", "committedDate": "2020-05-14T02:37:18Z", "type": "commit"}, {"oid": "7ba14adf2d30a932aede4036083335a88c03a98d", "url": "https://github.com/futurewei-cloud/alcor/commit/7ba14adf2d30a932aede4036083335a88c03a98d", "message": "[Micro services] MAC manager - moved swagger config to config package", "committedDate": "2020-05-14T02:44:49Z", "type": "commit"}, {"oid": "ec5b631f7249ae903b8bd7a3b347e2cb37dd6d88", "url": "https://github.com/futurewei-cloud/alcor/commit/ec5b631f7249ae903b8bd7a3b347e2cb37dd6d88", "message": "Merge branch 'master' of https://github.com/kimeunju108/alcor into eunju/macmanager", "committedDate": "2020-05-14T02:46:36Z", "type": "commit"}, {"oid": "dc7677fd7665869a43cdb9fe5ec7b2e1ae60c604", "url": "https://github.com/futurewei-cloud/alcor/commit/dc7677fd7665869a43cdb9fe5ec7b2e1ae60c604", "message": "[Micro services] MAC manager - removed duplicated dependency", "committedDate": "2020-05-14T03:14:43Z", "type": "commit"}, {"oid": "e9b82d8ef5f87c72ffb70203a3e3bdf15536baeb", "url": "https://github.com/futurewei-cloud/alcor/commit/e9b82d8ef5f87c72ffb70203a3e3bdf15536baeb", "message": "Merge branch 'master' of https://github.com/kimeunju108/alcor", "committedDate": "2020-05-14T18:49:43Z", "type": "commit"}, {"oid": "875f1d4a8d24855cec4a067030023c78950eb797", "url": "https://github.com/futurewei-cloud/alcor/commit/875f1d4a8d24855cec4a067030023c78950eb797", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor", "committedDate": "2020-05-15T22:56:24Z", "type": "commit"}, {"oid": "133845817ea97098e511709c6c1f23326379ae5b", "url": "https://github.com/futurewei-cloud/alcor/commit/133845817ea97098e511709c6c1f23326379ae5b", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor", "committedDate": "2020-05-16T14:20:30Z", "type": "commit"}, {"oid": "1698986e4276c8969c832de7a8532db1b69cac14", "url": "https://github.com/futurewei-cloud/alcor/commit/1698986e4276c8969c832de7a8532db1b69cac14", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor", "committedDate": "2020-05-20T18:56:27Z", "type": "commit"}, {"oid": "db0ae3f61a17a784d40a5245f120d242d8b821d8", "url": "https://github.com/futurewei-cloud/alcor/commit/db0ae3f61a17a784d40a5245f120d242d8b821d8", "message": "[Micro services] MAC manager - Updated UTs with mock repositories & mokito, Added exceptions and comments", "committedDate": "2020-05-20T19:39:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NzA2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428457064", "bodyText": "Please add brief comments here to describe the algorithm.", "author": "xieus", "createdAt": "2020-05-21T05:46:53Z", "path": "services/mac_manager/src/main/java/com/futurewei/alcor/macmanager/service/implement/MacServiceImpl.java", "diffHunk": "@@ -62,236 +65,337 @@\n     @Value(\"${macmanager.retrylimit}\")\n     private long nRetryLimit;\n \n-    public MacState getMacStateByMacAddress(String macAddress) throws Exception {\n+    /**\n+     * get MacState\n+     *\n+     * @param macAddress\n+     * @return MAC address allocation state\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     */\n+    public MacState getMacStateByMacAddress(String macAddress) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacAddressInvalidException {\n         MacState macState = null;\n         if (macAddress == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n         try {\n             macState = macStateRepository.findItem(macAddress);\n+        } catch (CacheException e) {\n+            logger.error(\"MacService getMacStateByMacAddress() exception:\", e);\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n         } catch (Exception e) {\n+            logger.error(\"MacService getMacStateByMacAddress() exception:\", e);\n+        }\n+        return macState;\n+    }\n+\n+    /**\n+     * create a MacState in default MAC range\n+     *\n+     * @param macState MAC allocation state\n+     * @return MAC allocation state with an allocated MAC address\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws MacRangeInvalidException               mac range to create a new MAC address is null or not existing     *\n+     * @throws MacAddressUniquenessViolationException MAC address is not unique. MAC address should be allocated to only one port\n+     * @throws MacAddressFullException                All MAC addresses are created.\n+     * @throws MacAddressRetryLimitExceedException    MAC addresss creation is tried more than limit\n+     */\n+    public MacState createMacState(MacState macState) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacRangeInvalidException, MacAddressUniquenessViolationException, MacAddressFullException, MacAddressRetryLimitExceedException {\n+        if (macState == null)\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+        String rangeId = MacManagerConstant.DEFAULT_RANGE;\n+        try {\n+            macState = createMacStateInRange(rangeId, macState);\n+        } catch (CacheException e) {\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION);\n+        } catch (MacRangeInvalidException | MacAddressUniquenessViolationException | MacAddressFullException | MacAddressRetryLimitExceedException e) {\n             throw e;\n         }\n         return macState;\n     }\n \n-    public MacState createMacState(MacState macState) throws Exception {\n+    /**\n+     * create a MacState\n+     *\n+     * @param macState MAC allocation state\n+     * @param rangeId  MAC address range to create\n+     * @return MAC allocation state with an allocated MAC address\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws MacRangeInvalidException               mac range to create a new MAC address is null or not existing\n+     * @throws MacAddressUniquenessViolationException MAC address is not unique. MAC address should be allocated to only one port\n+     * @throws MacAddressFullException                All MAC addresses are created.\n+     * @throws MacAddressRetryLimitExceedException    MAC addresss creation is tried more than limit\n+     */\n+    @Override\n+    public MacState createMacStateInRange(String rangeId, MacState macState) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacRangeInvalidException, MacAddressUniquenessViolationException, MacAddressRetryLimitExceedException, MacAddressFullException {\n         if (macState == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n         MacAddress macAddress = new MacAddress();\n         if (macState.getState() == null)\n-            macState.setState(MacUtil.MAC_STATE_ACTIVE);\n+            macState.setState(MacManagerConstant.MAC_STATE_ACTIVE);\n         else if (macState.getState().trim().length() == 0)\n-            macState.setState(MacUtil.MAC_STATE_ACTIVE);\n-        if (macPoolRepository.getSize() < (nMacPoolSize - 10)) {\n-            CompletableFuture<Long> completableFuture = CompletableFuture.supplyAsync(() -> {\n-                long n = 0;\n-                try {\n-                    n = generateMacInPool(20);\n-                } catch (Exception e) {\n+            macState.setState(MacManagerConstant.MAC_STATE_ACTIVE);\n \n+        try {\n+            MacRange range = macRangeRepository.findItem(rangeId);\n+            if (range == null) {", "originalCommit": "db0ae3f61a17a784d40a5245f120d242d8b821d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg3Mzk2OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428873968", "bodyText": "Done\n//MAC address is generated in a MAC range betwen from ~ to, if there is no active user defined MAC range, by default default MAC range is applied.\n//Default MAC range: name is defined MacManagerConstant class, range is entire oui range. e.g.)\n// if oui=AA-BB-CC then default MAC range is AA-BB-CC-00-00-00 ~ AA-BB-CC-FF-FF-FF.", "author": "kimeunju108", "createdAt": "2020-05-21T19:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NzA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MTkxNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428941915", "bodyText": "Thanks. You could add those comments along with the codes, instead of in the PR.", "author": "xieus", "createdAt": "2020-05-21T22:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NzA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MzM3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428943370", "bodyText": "I added the comment to the code, too. This is just for your comfort.", "author": "kimeunju108", "createdAt": "2020-05-21T22:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NzA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0NDEwOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428944108", "bodyText": "See it now. Thanks.", "author": "xieus", "createdAt": "2020-05-21T22:12:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1NzA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1ODAwOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428458009", "bodyText": "These three lines could be grouped as a method like \"inactivateMacAddressBit\" or so.", "author": "xieus", "createdAt": "2020-05-21T05:50:15Z", "path": "services/mac_manager/src/main/java/com/futurewei/alcor/macmanager/service/implement/MacServiceImpl.java", "diffHunk": "@@ -62,236 +65,337 @@\n     @Value(\"${macmanager.retrylimit}\")\n     private long nRetryLimit;\n \n-    public MacState getMacStateByMacAddress(String macAddress) throws Exception {\n+    /**\n+     * get MacState\n+     *\n+     * @param macAddress\n+     * @return MAC address allocation state\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     */\n+    public MacState getMacStateByMacAddress(String macAddress) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacAddressInvalidException {\n         MacState macState = null;\n         if (macAddress == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n         try {\n             macState = macStateRepository.findItem(macAddress);\n+        } catch (CacheException e) {\n+            logger.error(\"MacService getMacStateByMacAddress() exception:\", e);\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n         } catch (Exception e) {\n+            logger.error(\"MacService getMacStateByMacAddress() exception:\", e);\n+        }\n+        return macState;\n+    }\n+\n+    /**\n+     * create a MacState in default MAC range\n+     *\n+     * @param macState MAC allocation state\n+     * @return MAC allocation state with an allocated MAC address\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws MacRangeInvalidException               mac range to create a new MAC address is null or not existing     *\n+     * @throws MacAddressUniquenessViolationException MAC address is not unique. MAC address should be allocated to only one port\n+     * @throws MacAddressFullException                All MAC addresses are created.\n+     * @throws MacAddressRetryLimitExceedException    MAC addresss creation is tried more than limit\n+     */\n+    public MacState createMacState(MacState macState) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacRangeInvalidException, MacAddressUniquenessViolationException, MacAddressFullException, MacAddressRetryLimitExceedException {\n+        if (macState == null)\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+        String rangeId = MacManagerConstant.DEFAULT_RANGE;\n+        try {\n+            macState = createMacStateInRange(rangeId, macState);\n+        } catch (CacheException e) {\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION);\n+        } catch (MacRangeInvalidException | MacAddressUniquenessViolationException | MacAddressFullException | MacAddressRetryLimitExceedException e) {\n             throw e;\n         }\n         return macState;\n     }\n \n-    public MacState createMacState(MacState macState) throws Exception {\n+    /**\n+     * create a MacState\n+     *\n+     * @param macState MAC allocation state\n+     * @param rangeId  MAC address range to create\n+     * @return MAC allocation state with an allocated MAC address\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws MacRangeInvalidException               mac range to create a new MAC address is null or not existing\n+     * @throws MacAddressUniquenessViolationException MAC address is not unique. MAC address should be allocated to only one port\n+     * @throws MacAddressFullException                All MAC addresses are created.\n+     * @throws MacAddressRetryLimitExceedException    MAC addresss creation is tried more than limit\n+     */\n+    @Override\n+    public MacState createMacStateInRange(String rangeId, MacState macState) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, MacRangeInvalidException, MacAddressUniquenessViolationException, MacAddressRetryLimitExceedException, MacAddressFullException {\n         if (macState == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n         MacAddress macAddress = new MacAddress();\n         if (macState.getState() == null)\n-            macState.setState(MacUtil.MAC_STATE_ACTIVE);\n+            macState.setState(MacManagerConstant.MAC_STATE_ACTIVE);\n         else if (macState.getState().trim().length() == 0)\n-            macState.setState(MacUtil.MAC_STATE_ACTIVE);\n-        if (macPoolRepository.getSize() < (nMacPoolSize - 10)) {\n-            CompletableFuture<Long> completableFuture = CompletableFuture.supplyAsync(() -> {\n-                long n = 0;\n-                try {\n-                    n = generateMacInPool(20);\n-                } catch (Exception e) {\n+            macState.setState(MacManagerConstant.MAC_STATE_ACTIVE);\n \n+        try {\n+            MacRange range = macRangeRepository.findItem(rangeId);\n+            if (range == null) {\n+                if (rangeId.equals(MacManagerConstant.DEFAULT_RANGE)) {\n+                    range = createDefaultRange(oui);\n+                    createMacRange(range);\n+                } else {\n+                    throw new MacRangeInvalidException(MacManagerConstant.MAC_EXCEPTION_RANGE_NOT_EXISTING);\n                 }\n-                return n;\n-            });\n-            long l = completableFuture.get();\n-            completableFuture.thenAccept(System.out::println);\n-            completableFuture.join();\n-            logger.info(\"{} New MAC addresses were created.\", l);\n-        }\n-\n-        String strMacAddress = allocateMacState(macState);\n-        if (strMacAddress != null) {\n-            macState.setMacAddress(strMacAddress);\n-            macStateRepository.addItem(macState);\n-        } else {\n-            try {\n-                String nic = generateNic();\n+            } else if (range.getState().equals(MacManagerConstant.MAC_RANGE_STATE_ACTIVE) == false) {\n+                throw new MacRangeInvalidException(MacManagerConstant.MAC_EXCEPTION_RANGE_NOT_ACTIVE);\n+            }\n+            if (macPoolRepository.getSize(rangeId) < (nMacPoolSize - 10)) {\n+                CompletableFuture<Long> completableFuture = CompletableFuture.supplyAsync(() -> {\n+                    long n = 0;\n+                    try {\n+                        n = generateMacInPool(rangeId, 20);\n+                    } catch (Exception e) {\n+                        logger.error(\"MacService createMacState() exception:\", e);\n+                    }\n+                    return n;\n+                });\n+                long l = completableFuture.get();\n+                completableFuture.thenAccept(System.out::println);\n+                completableFuture.join();\n+                logger.info(\"{} New MAC addresses were created.\", l);\n+            }\n+            String strMacAddress = allocateMacState(rangeId, macState);\n+            if (strMacAddress != null) {\n+                macState.setMacAddress(strMacAddress);\n+                macStateRepository.addItem(macState);\n+            } else {\n+                String nic = generateNic(rangeId);\n                 macAddress.setOui(oui);\n                 macAddress.setNic(nic);\n                 macState.setMacAddress(macAddress.getMacAddress());\n                 MacState macState2 = macStateRepository.findItem(macAddress.getMacAddress());\n                 if (macStateRepository.findItem(macAddress.getMacAddress()) != null)\n-                    throw (new UniquenessViolationException(MacUtil.MAC_EXCEPTION_UNIQUENESSSS_VILOATION + macAddress.getMacAddress() + macState2.getProjectId()));\n+                    throw (new MacAddressUniquenessViolationException(MacManagerConstant.MAC_EXCEPTION_UNIQUENESSSS_VILOATION + macAddress.getMacAddress() + macState2.getProjectId()));\n                 else\n                     macStateRepository.addItem(macState);\n-            } catch (Exception e) {\n-                throw e;\n             }\n+        } catch (CacheException e) {\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION);\n+        } catch (MacAddressFullException | MacAddressRetryLimitExceedException e) {\n+            throw e;\n+        } catch (InterruptedException | ExecutionException e) {\n+            logger.error(\"MacService generateMacInPool() exception:\", e);\n         }\n         return macState;\n     }\n \n+    /**\n+     * update a MacState\n+     *\n+     * @param macAddress MAC address\n+     * @param macState   MAC allocation state with new data\n+     * @return MAC allocation state\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws ParameterUnexpectedValueException      macAddress is not equal to macState mac address\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws ResourceNotFoundException              there is not mac state with macAddress\n+     */\n     @Override\n-    public MacState updateMacState(String macAddress, MacState macState) throws Exception {\n+    public MacState updateMacState(String macAddress, MacState macState) throws ParameterNullOrEmptyException, ParameterUnexpectedValueException, MacRepositoryTransactionErrorException, ResourceNotFoundException {\n         if (macAddress == null || macState == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n         if (macAddress.equals(macState.getMacAddress()) == false)\n-            throw (new ParameterUnexpectedValueException(MacUtil.MAC_EXCEPTION_PARAMETER_INVALID));\n-        if (macStateRepository.findItem(macAddress) != null) {\n-            macStateRepository.addItem(macState);\n-        } else {\n-            throw (new ResourceNotFoundException(MacUtil.MAC_EXCEPTION_MAC_NOT_EXISTING));\n+            throw (new ParameterUnexpectedValueException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_INVALID));\n+        try {\n+            if (macStateRepository.findItem(macAddress) != null) {\n+                macStateRepository.addItem(macState);\n+            } else {\n+                ResourceNotFoundException e = new ResourceNotFoundException(MacManagerConstant.MAC_EXCEPTION_MAC_NOT_EXISTING);\n+                logger.error(\"MacService updateMacState() exception:\", e);\n+                throw (e);\n+            }\n+        } catch (CacheException e) {\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION);\n         }\n         return macState;\n     }\n \n-    public String releaseMacState(String macAddress) throws Exception {\n+    /**\n+     * release MAC address from an allocation and put it back to MAC address pool\n+     *\n+     * @param macAddress MAC address\n+     * @return MAC address\n+     * @throws ParameterNullOrEmptyException          parameter macAddress is null or empty\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws ResourceNotFoundException              there is not mac state to release macAddress\n+     */\n+    @Override\n+    public String releaseMacState(String macAddress) throws ParameterNullOrEmptyException, MacRepositoryTransactionErrorException, ResourceNotFoundException {\n+        String strMacAddress = null;\n         if (macAddress == null)\n-            throw (new ParameterNullOrEmptyException(MacUtil.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n-        MacState macState = macStateRepository.findItem(macAddress);\n-        if (macState == null) {\n-            throw (new ResourceNotFoundException(MacUtil.MAC_EXCEPTION_MAC_NOT_EXISTING));\n-        } else {\n-            try {\n-                macStateRepository.deleteItem(macAddress);\n-                macPoolRepository.addItem(new MacAddress(macAddress));\n-            } catch (Exception e) {\n-                throw e;\n+            throw (new ParameterNullOrEmptyException(MacManagerConstant.MAC_EXCEPTION_PARAMETER_NULL_EMPTY));\n+        try {\n+            MacState macState = macStateRepository.findItem(macAddress);\n+            if (macState == null) {\n+                throw (new ResourceNotFoundException(MacManagerConstant.MAC_EXCEPTION_MAC_NOT_EXISTING));\n+            } else {\n+                try {\n+                    macStateRepository.deleteItem(macAddress);\n+                    MacAddress mac = new MacAddress(macAddress);", "originalCommit": "db0ae3f61a17a784d40a5245f120d242d8b821d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg3Mzk2MQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428873961", "bodyText": "These three lines are grouped in a method :  private void inactivateMacAddressBit(String macAddress) throws MacRepositoryTransactionErrorException", "author": "kimeunju108", "createdAt": "2020-05-21T19:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1ODAwOQ=="}], "type": "inlineReview"}, {"oid": "bdda663a630eead7c2be695099801bfea25aa5fc", "url": "https://github.com/futurewei-cloud/alcor/commit/bdda663a630eead7c2be695099801bfea25aa5fc", "message": "[Micro services] MAC manager - added comments on Default Mac Range", "committedDate": "2020-05-21T19:51:36Z", "type": "commit"}, {"oid": "e63302ea7ce01d86bef113b824e3f6ccfa8717a2", "url": "https://github.com/futurewei-cloud/alcor/commit/e63302ea7ce01d86bef113b824e3f6ccfa8717a2", "message": "[Micro services] MAC mamager - check pom file", "committedDate": "2020-05-21T20:15:34Z", "type": "commit"}, {"oid": "426be901784a6928b57ac25840157eab4d2d4c65", "url": "https://github.com/futurewei-cloud/alcor/commit/426be901784a6928b57ac25840157eab4d2d4c65", "message": "[Micro services] MAC manager - added a comment about default MAC anager", "committedDate": "2020-05-21T20:24:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjMxNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/206#discussion_r428942316", "bodyText": "Let us use something other than \"from\" :-)", "author": "xieus", "createdAt": "2020-05-21T22:07:08Z", "path": "services/mac_manager/src/main/java/com/futurewei/alcor/macmanager/service/implement/MacServiceImpl.java", "diffHunk": "@@ -300,61 +404,204 @@ private boolean isValidRange(MacRange macRange) {\n         return from < to;\n     }\n \n+    /**\n+     * create a default MAC range\n+     *\n+     * @param oui unique id of an organization\n+     * @return default MAC range\n+     * @throws\n+     */\n     private MacRange createDefaultRange(String oui) {\n-        String rangeId = MacUtil.DEFAULT_RANGE;\n-        long nNicLength = (long)Math.pow(2,MacAddress.NIC_LENGTH);\n-        String strFrom  = MacAddress.longToMac(0);\n-        String strTo = MacAddress.longToMac(nNicLength - 1);\n+        String rangeId = MacManagerConstant.DEFAULT_RANGE;\n+        MacAddress macAddress = new MacAddress(oui, null);\n+        long nNicLength = (long) Math.pow(2, macAddress.getNicLength());\n+        String strFrom = MacAddress.longToNic(0, macAddress.getNicLength());\n+        String strTo = MacAddress.longToNic(nNicLength - 1, macAddress.getNicLength());\n         String from = new MacAddress(oui, strFrom).getMacAddress();\n         String to = new MacAddress(oui, strTo).getMacAddress();\n-        String state = MacUtil.MAC_RANGE_STATE_ACTIVE;\n-        BitSet bitSet = new BitSet((int)nNicLength);\n+        String state = MacManagerConstant.MAC_RANGE_STATE_ACTIVE;\n+        BitSet bitSet = new BitSet((int) nNicLength);\n         MacRange defaultRange = new MacRange(rangeId, from, to, state);\n         defaultRange.setBitSet(bitSet);\n         return defaultRange;\n     }\n \n-    private long generateMacInPool(int n) throws Exception {\n-        Exception exception = null;\n+    /**\n+     * generate MAC addresses in MAC pool in advance\n+     *\n+     * @param rangeId MAC range id\n+     * @param n       the number of MAC addresses to generate\n+     * @return the number of MAC addresses generated\n+     * @throws MacAddressRetryLimitExceedException MAC address generation is tried more than limit\n+     */\n+    private long generateMacInPool(String rangeId, int n) throws MacAddressRetryLimitExceedException {\n+        MacAddressRetryLimitExceedException exception = null;\n         long nReturn = 0;\n         ArrayList<String> list = new ArrayList<String>();\n         if (n < 1) return nReturn;\n         MacAddress macAddress = new MacAddress();\n         for (int i = 0; i < n; i++) {\n             try {\n-                String nic = generateNic();\n+                String nic = generateNic(rangeId);\n                 macAddress.setOui(oui);\n                 macAddress.setNic(nic);\n                 String strMacAddress = macAddress.getMacAddress();\n                 MacState macState = macStateRepository.findItem(strMacAddress);\n                 if (macState == null) {\n-                    updateMacAllocationStatus(strMacAddress);\n-                    macPoolRepository.addItem(new MacAddress(strMacAddress));\n+                    macPoolRepository.addItem(rangeId, strMacAddress);\n                     nReturn++;\n                 }\n-            } catch (RetryLimitExceedException e) {\n+            } catch (MacAddressRetryLimitExceedException e) {\n                 exception = e;\n+            } catch (Exception e) {\n+                logger.error(\"MacService generateMacInPool() exception:\", e);\n             }\n         }\n         if (exception != null)\n             throw exception;\n         return nReturn;\n     }\n \n-    private void updateMacAllocationStatus(String strMacAddress) throws Exception {\n-        MacRange deafultRange = getMacRangeByMacRangeId(MacUtil.DEFAULT_RANGE);\n-        BitSet bitSet = deafultRange.getBitSet();\n-        int ndx = macToIndex(deafultRange, strMacAddress);\n-        bitSet.set(ndx);\n-        macRangeRepository.addItem(deafultRange);\n+    /**\n+     * generate a new NIC(Network Interface Unit) of a MAC address\n+     *\n+     * @param rangeId MAC range id\n+     * @return new NIC string\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     * @throws MacAddressFullException                ALL MAC addresses are used and there is no more avaialble\n+     * @throws MacAddressRetryLimitExceedException    MAC address generation is tried more than limit\n+     */\n+    private String generateNic(String rangeId) throws MacRepositoryTransactionErrorException, MacAddressFullException, MacAddressRetryLimitExceedException {\n+        String nic = null;\n+        MacAddress macAddress = new MacAddress(oui, null);\n+        Long from = (long) 0;\n+        Long to = (long) 0;\n+        int nNicLength = macAddress.getNicLength();\n+        long randomNic = -1;\n+        MacRange macRange = null;\n+        try {\n+            macRange = macRangeRepository.findItem(rangeId);\n+        } catch (CacheException e) {\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n+        }\n+        if (macRange != null) {\n+            from = MacAddress.macToLong(new MacAddress(macRange.getFrom()).getNic());\n+            to = MacAddress.macToLong(new MacAddress(macRange.getTo()).getNic());\n+        }\n+        long nAavailableMac = availableMac(from, to);\n+        if (nAavailableMac == 0) {\n+            throw new MacAddressFullException(MacManagerConstant.MAC_EXCEPTION_FULL_EXCEPTION);\n+        } else {\n+            int i = 0;\n+            while (nic == null && i < nRetryLimit) {\n+                long randomNum = ThreadLocalRandom.current().nextLong(0, nAavailableMac);\n+                randomNic = getRandomNicFromBitSet(from, randomNum);\n+                String nicTemp = MacAddress.hexToNic(Long.toHexString(randomNic), nNicLength);\n+                macAddress.setNic(nicTemp);\n+                try {\n+                    if ((macStateRepository.findItem(macAddress.getMacAddress()) == null) && (macPoolRepository.findItem(rangeId, macAddress.getMacAddress()) == null)) {\n+                        nic = nicTemp;\n+                        i++;\n+                    }\n+                } catch (CacheException e) {\n+                    throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n+                }\n+            }\n+            if (nic == null)\n+                throw new MacAddressRetryLimitExceedException(MacManagerConstant.MAC_EXCEPTION_RETRY_LIMIT_EXCEED);\n+            if (randomNic >= 0) {\n+                try {\n+                    updateBitSet(randomNic, true);\n+                } catch (CacheException e) {\n+                    throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n+                }\n+            }\n+        }\n+        return nic;\n+    }\n+\n+    /**\n+     * update tracking information of avaialble MAC addresses\n+     *\n+     * @param nic    network interface card id of a MAC address\n+     * @param bValue true if used, false otherwise\n+     * @return\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     */\n+    private void updateBitSet(long nic, boolean bValue) throws MacRepositoryTransactionErrorException {\n+        try {\n+            MacRange deafultRange = getMacRangeByMacRangeId(MacManagerConstant.DEFAULT_RANGE);\n+            BitSet bitSet = deafultRange.getBitSet();\n+            if (bValue)\n+                bitSet.set((int) nic);\n+            else\n+                bitSet.clear((int) nic);\n+            deafultRange.setBitSet(bitSet);\n+            macRangeRepository.addItem(deafultRange);\n+        } catch (CacheException e) {\n+            logger.error(\"MacService getRandomNicFromBitSet() exception:\", e);\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n+        } catch (Exception e) {\n+            logger.error(\"MacService getRandomNicFromBitSet() exception:\", e);\n+        }\n+    }\n+\n+    /**\n+     * provide how many MAC addresses\n+     *\n+     * @param from start MAC address to compute\n+     * @param to   end MAC address to compute\n+     * @return the number of available MAC addresses between from and to\n+     * @throws MacRepositoryTransactionErrorException error during repository transaction\n+     */\n+    private long availableMac(long from, long to) throws MacRepositoryTransactionErrorException {\n+        long nAvailable = 0;\n+        String rangeId = MacManagerConstant.DEFAULT_RANGE;\n+        try {\n+            MacRange range = getMacRangeByMacRangeId(rangeId);\n+            BitSet bitSet = range.getBitSet();\n+            BitSet bitSet2 = bitSet.get((int) from, (int) to);\n+            long nTotal = to - from;\n+            nAvailable = nTotal - bitSet2.cardinality();\n+        } catch (CacheException e) {\n+            logger.error(\"MacService availableMac() exception:\", e);\n+            throw new MacRepositoryTransactionErrorException(MacManagerConstant.MAC_EXCEPTION_REPOSITORY_EXCEPTION, e);\n+        } catch (Exception e) {\n+            logger.error(\"MacService availableMac() exception:\", e);\n+        }\n+        return nAvailable;\n     }\n \n-    private int macToIndex(MacRange range, String strMac) {\n-        int ndx = 0;\n-        MacAddress mac = new MacAddress(strMac);\n-        long nMac1 = MacAddress.macToLong(strMac);\n-        long nMac2 = MacAddress.macToLong(range.getFrom());\n-        ndx = (int) (nMac1 - nMac2);\n-        return ndx;\n+    /**\n+     * pick a MAC address randomly among available MAC addresses\n+     *\n+     * @param from start MAC address", "originalCommit": "db0ae3f61a17a784d40a5245f120d242d8b821d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}