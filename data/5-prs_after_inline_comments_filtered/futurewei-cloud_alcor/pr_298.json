{"pr_number": 298, "pr_title": "[Elastic IP Manager] Support EIP and Port Association", "pr_createdAt": "2020-07-15T18:44:43Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/298", "timeline": [{"oid": "84af1079c35daf1bb16319a3535300ee067280f3", "url": "https://github.com/futurewei-cloud/alcor/commit/84af1079c35daf1bb16319a3535300ee067280f3", "message": "upload codes about associating eip with a port", "committedDate": "2020-07-15T18:33:05Z", "type": "commit"}, {"oid": "38dc779c99f1453b575dd60da732aec78a00b7a2", "url": "https://github.com/futurewei-cloud/alcor/commit/38dc779c99f1453b575dd60da732aec78a00b7a2", "message": "upload codes about associating eip with a port", "committedDate": "2020-07-15T18:40:54Z", "type": "commit"}, {"oid": "5b0ede336c43129b7c8c54002c14df4c7cebee06", "url": "https://github.com/futurewei-cloud/alcor/commit/5b0ede336c43129b7c8c54002c14df4c7cebee06", "message": "Merge branch 'elasticip_associate_port' of https://github.com/Eric-Yuan/alcor into elasticip_associate_port", "committedDate": "2020-07-15T18:41:57Z", "type": "commit"}, {"oid": "1a0c894366d5aee633aab5cd3a83458486d819d6", "url": "https://github.com/futurewei-cloud/alcor/commit/1a0c894366d5aee633aab5cd3a83458486d819d6", "message": "upload codes about associating eip with a port", "committedDate": "2020-07-15T18:53:10Z", "type": "commit"}, {"oid": "b6bca7ddfe9b13076aef4dde87e7a0956bac0eaf", "url": "https://github.com/futurewei-cloud/alcor/commit/b6bca7ddfe9b13076aef4dde87e7a0956bac0eaf", "message": "Merge branch 'elasticip_associate_port' of https://github.com/Eric-Yuan/alcor into elasticip_associate_port", "committedDate": "2020-07-15T18:55:08Z", "type": "commit"}, {"oid": "b5b65d47ff27373451c8edcde148c355268b4f70", "url": "https://github.com/futurewei-cloud/alcor/commit/b5b65d47ff27373451c8edcde148c355268b4f70", "message": "modify the replication and ignite host values in k8s deploy yaml in according to other micro services.", "committedDate": "2020-07-16T07:01:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMDE2Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456400167", "bodyText": "is it possible to give the conflicted ip address here? If so it would help for debugging in production.", "author": "xieus", "createdAt": "2020-07-17T12:06:34Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/exception/elasticip/ElasticIpAssociateConflict.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\r\n+Copyright 2020 The Alcor Authors.\r\n+\r\n+Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+        you may not use this file except in compliance with the License.\r\n+        You may obtain a copy of the License at\r\n+\r\n+        http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+        Unless required by applicable law or agreed to in writing, software\r\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+        See the License for the specific language governing permissions and\r\n+        limitations under the License.\r\n+*/\r\n+\r\n+package com.futurewei.alcor.elasticipmanager.exception.elasticip;\r\n+\r\n+import org.springframework.http.HttpStatus;\r\n+import org.springframework.web.bind.annotation.ResponseStatus;\r\n+\r\n+@ResponseStatus(code= HttpStatus.BAD_REQUEST, reason=\"The associate port or private ip has already associated with \" +\r\n+        \"another elastic ip\")\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxMTg0Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457011842", "bodyText": "OK, the ResponseStatus announce seems not support paramters, I could try another way to throw the exception.", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMDE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODAyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456408023", "bodyText": "Possibly we would need to document the current supported scenarios.\nLet us investigate further for IPv6 EIP to see if we want to support in the near future.", "author": "xieus", "createdAt": "2020-07-17T12:24:14Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/utils/ElasticIpControllerUtils.java", "diffHunk": "@@ -104,9 +103,13 @@ public static void createElasticIpParameterProcess(String projectId, ElasticIpIn\n                 throw new ElasticIpNoPortIdException();\r\n             }\r\n         } else {\r\n-            if (elasticIpInfo.getPrivateIpVersion() != null &&\r\n-                    isIpVersionInvalid(elasticIpInfo.getPrivateIpVersion())) {\r\n-                throw new ElasticIpPipVersionException();\r\n+            if (elasticIpInfo.getPrivateIpVersion() != null) {\r\n+                if (elasticIpInfo.getPrivateIpVersion().equals(IpVersion.IPV6.getVersion())) {\r\n+                    throw new ElasticIpIPv6PIPNotSupported();\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNDExMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457014110", "bodyText": "We could support IPv6 EIP, but we might not support a EIP associate with a IPv6 fixed IP. I could take more investigation here.", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0NzQ2OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457047469", "bodyText": "Cool thank you.", "author": "xieus", "createdAt": "2020-07-20T04:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkyMzkyMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457923922", "bodyText": "Done", "author": "Eric-Yuan", "createdAt": "2020-07-21T08:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODU5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456408592", "bodyText": "Question: which scenarios is the eip's private ip version invalid?", "author": "xieus", "createdAt": "2020-07-17T12:25:16Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/utils/ElasticIpControllerUtils.java", "diffHunk": "@@ -104,9 +103,13 @@ public static void createElasticIpParameterProcess(String projectId, ElasticIpIn\n                 throw new ElasticIpNoPortIdException();\r\n             }\r\n         } else {\r\n-            if (elasticIpInfo.getPrivateIpVersion() != null &&\r\n-                    isIpVersionInvalid(elasticIpInfo.getPrivateIpVersion())) {\r\n-                throw new ElasticIpPipVersionException();\r\n+            if (elasticIpInfo.getPrivateIpVersion() != null) {\r\n+                if (elasticIpInfo.getPrivateIpVersion().equals(IpVersion.IPV6.getVersion())) {\r\n+                    throw new ElasticIpIPv6PIPNotSupported();\r\n+                }\r\n+                if (isIpVersionInvalid(elasticIpInfo.getPrivateIpVersion())) {\r\n+                    throw new ElasticIpPipVersionException();\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNDcyOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457014729", "bodyText": "user specify a value neither 4 nor 6?", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MjI2MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r458062260", "bodyText": "In another PR (will upload soon), I will remove the private ip version attribute from EIP. Seems that attribute is not necessary", "author": "Eric-Yuan", "createdAt": "2020-07-21T12:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1MTYzMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r458551630", "bodyText": "Cool.", "author": "xieus", "createdAt": "2020-07-22T05:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwODU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwOTQ2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456409464", "bodyText": "Very comprehensive test case! Like it a lot \ud83d\udc4d", "author": "xieus", "createdAt": "2020-07-17T12:27:10Z", "path": "services/elastic_ip_manager/src/test/java/com/futurewei/alcor/elasticipmanager/ElasticIpControllerTests.java", "diffHunk": "@@ -1017,6 +1030,117 @@ public void elasticIpRange_updateNameAndDescription() throws Exception {\n         this.cleanRange();\n     }\n \n+    @Test\n+    public void elasticIp_associateWithPort() throws Exception {", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNDc5MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457014790", "bodyText": "thanks", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwOTQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQxNzExNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456417116", "bodyText": "We could try to collect some perf numnber for EIP Mgr. @Eric-Yuan", "author": "xieus", "createdAt": "2020-07-17T12:42:15Z", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/ElasticIpManagerRestClient.java", "diffHunk": "@@ -1,11 +1,77 @@\n+/*\r\n+Copyright 2019 The Alcor Authors.\r\n+\r\n+Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+        you may not use this file except in compliance with the License.\r\n+        You may obtain a copy of the License at\r\n+\r\n+        http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+        Unless required by applicable law or agreed to in writing, software\r\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+        See the License for the specific language governing permissions and\r\n+        limitations under the License.\r\n+*/\r\n+\r\n package com.futurewei.alcor.web.restclient;\r\n \r\n+import com.fasterxml.jackson.databind.ObjectMapper;\r\n+import com.futurewei.alcor.common.stats.DurationStatistics;\r\n+import com.futurewei.alcor.common.utils.ControllerUtil;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpInfo;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpInfoWrapper;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpsInfoWrapper;\r\n import org.springframework.beans.factory.annotation.Value;\r\n+import org.springframework.http.*;\r\n+import org.springframework.util.MimeType;\r\n+import org.springframework.util.MimeTypeUtils;\r\n+import org.springframework.web.client.RestClientException;\r\n+import org.springframework.web.client.RestTemplate;\r\n+\r\n+import java.util.Map;\r\n \r\n public class ElasticIpManagerRestClient extends AbstractRestClient {\r\n     @Value(\"${microservices.elasticip.service.url:#{\\\"\\\"}}\")\r\n     private String elasticIpManagerUrl;\r\n \r\n+    @DurationStatistics\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyNzg0Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456427846", "bodyText": "Line 79-89 in the new file (I am unable to comment there directly):\nIn the current algorithm, we look into all ranges and pick the first one matching the request ip's version. Pulling all ranges from repo is fine when the number of ranges is limited.\nOne concern is that the first few ranges could be drained very quickly, which causes the following requests takes more time to find one available ip as it will need to check more and more ranges. We could think of adding ip availability stats for each range, and pick the one with least utilization.\nNot high priority. I would recommend us to run some perf/scalability test to see. @Eric-Yuan", "author": "xieus", "createdAt": "2020-07-17T13:03:11Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/service/implement/ElasticIpServiceImpl.java", "diffHunk": "@@ -86,9 +93,11 @@ public ElasticIpInfo createElasticIp(ElasticIpInfo request) throws Exception {\n         eip.setElasticIp(ipAddress);", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMDc2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456430764", "bodyText": "Recommend to rename it to ElasticIpAssociatedIpNotFound()", "author": "xieus", "createdAt": "2020-07-17T13:08:45Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/service/implement/ElasticIpServiceImpl.java", "diffHunk": "@@ -258,6 +269,56 @@ public ElasticIpInfo updateElasticIp(ElasticIpInfo request) throws Exception {\n         return new ElasticIpInfo(eip);\n     }\n \n+    private Map<String, ElasticIp> getElasticIpsByPortId(String projectId, String portId) {\n+\n+        Map<String, Object[]> filter = new HashMap<>();\n+        filter.put(\"project_id\", new Object[] {projectId});\n+        filter.put(\"port_id\", new Object[] {portId});\n+\n+        return elasticIpRepo.findAllItems(filter);\n+    }\n+\n+    private String getAssociatedPortIp(String projectId, String portId, Integer ipVersion, String ipAddress)\n+            throws Exception {\n+        PortManagerProxy portManagerProxy = new PortManagerProxy(projectId);\n+        PortEntity port = portManagerProxy.getPortById(portId);\n+\n+        List<PortEntity.FixedIp> fixedIps = port.getFixedIps();\n+        List<String> fixedIpv4List = new ArrayList<>();\n+        for (PortEntity.FixedIp fixedIp: fixedIps) {\n+            if (Ipv4AddrUtil.formatCheck(fixedIp.getIpAddress())) {\n+                fixedIpv4List.add(fixedIp.getIpAddress());\n+            }\n+        }\n+\n+        if (fixedIpv4List.isEmpty()) {\n+            throw new ElasticIpPipNotFound();\n+        }\n+\n+        String associatedIp;\n+        if (ipAddress != null) {\n+            if (fixedIpv4List.contains(ipAddress)) {\n+                associatedIp = ipAddress;\n+            } else {\n+                throw new ElasticIpPipNotFound();", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456432246", "bodyText": "I am trying to understand why port with multi-ips are invalid here.\nFor a port with multiple private ips, one could be considered as primary ip and the rest are secondary. The EIP could be associated with the primary pip.", "author": "xieus", "createdAt": "2020-07-17T13:11:33Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/service/implement/ElasticIpServiceImpl.java", "diffHunk": "@@ -258,6 +269,56 @@ public ElasticIpInfo updateElasticIp(ElasticIpInfo request) throws Exception {\n         return new ElasticIpInfo(eip);\n     }\n \n+    private Map<String, ElasticIp> getElasticIpsByPortId(String projectId, String portId) {\n+\n+        Map<String, Object[]> filter = new HashMap<>();\n+        filter.put(\"project_id\", new Object[] {projectId});\n+        filter.put(\"port_id\", new Object[] {portId});\n+\n+        return elasticIpRepo.findAllItems(filter);\n+    }\n+\n+    private String getAssociatedPortIp(String projectId, String portId, Integer ipVersion, String ipAddress)\n+            throws Exception {\n+        PortManagerProxy portManagerProxy = new PortManagerProxy(projectId);\n+        PortEntity port = portManagerProxy.getPortById(portId);\n+\n+        List<PortEntity.FixedIp> fixedIps = port.getFixedIps();\n+        List<String> fixedIpv4List = new ArrayList<>();\n+        for (PortEntity.FixedIp fixedIp: fixedIps) {\n+            if (Ipv4AddrUtil.formatCheck(fixedIp.getIpAddress())) {\n+                fixedIpv4List.add(fixedIp.getIpAddress());\n+            }\n+        }\n+\n+        if (fixedIpv4List.isEmpty()) {\n+            throw new ElasticIpPipNotFound();\n+        }\n+\n+        String associatedIp;\n+        if (ipAddress != null) {\n+            if (fixedIpv4List.contains(ipAddress)) {\n+                associatedIp = ipAddress;\n+            } else {\n+                throw new ElasticIpPipNotFound();\n+            }\n+        } else {\n+            if (fixedIpv4List.size() > 1) {\n+                throw new ElasticIpMultipleFixedIpFound();", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNzA1OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457017059", "bodyText": "That is reference from Neutron. Neutron will throw errors when associate an EIP with a multi addresses port and not specifing which address is actually associated with.  I could investigate further in primary ip in a port.", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0Njk5OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457046998", "bodyText": "Some references:\n\n\nAWS allows multiple private IPv4s assigned to a network interface, and each private IPv4 address can be associated with a single Elastic IP address, and vice versa.\nLink: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/MultipleIP.html#StepThreeEIP\n\n\nAzure allows similar configurations. Each VM may have multiple NICs, and every NIC attached to a VM has one or more IP configurations associated to it. Each configuration is assigned one static or dynamic private IP address. Each configuration may also have one public IP address (either dynamic or static) associated to it.\nLink: https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-multiple-ip-addresses-portal", "author": "xieus", "createdAt": "2020-07-20T04:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA5NzUzNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457097534", "bodyText": "Thanks, that detailly references are very helpful. For now we support each fixed ip to be associated with a indepandent EIP, but not recognize the primary ip of the fixed ips and could not automatically choose a fixed ip to be associated. Mightbe we could simply choose the first fixed ip when not specified, or we might think add a optional 'primary' attribute in fixed ip.", "author": "Eric-Yuan", "createdAt": "2020-07-20T06:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkyMzY0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457923645", "bodyText": "Done. I removed the limitation", "author": "Eric-Yuan", "createdAt": "2020-07-21T08:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NzU2Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r458557567", "bodyText": "The current implementation looks good.\nAdding a new primary attribute to the fixed IP is ideal but requires more thinking as it involves change in multiple services. Let us discuss together with other team members and roll out a mid-term plan.", "author": "xieus", "createdAt": "2020-07-22T06:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzIyMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456433220", "bodyText": "It would be a good idea to include the conflicted ip in the exception message.", "author": "xieus", "createdAt": "2020-07-17T13:13:17Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/service/implement/ElasticIpServiceImpl.java", "diffHunk": "@@ -258,6 +269,56 @@ public ElasticIpInfo updateElasticIp(ElasticIpInfo request) throws Exception {\n         return new ElasticIpInfo(eip);\n     }\n \n+    private Map<String, ElasticIp> getElasticIpsByPortId(String projectId, String portId) {\n+\n+        Map<String, Object[]> filter = new HashMap<>();\n+        filter.put(\"project_id\", new Object[] {projectId});\n+        filter.put(\"port_id\", new Object[] {portId});\n+\n+        return elasticIpRepo.findAllItems(filter);\n+    }\n+\n+    private String getAssociatedPortIp(String projectId, String portId, Integer ipVersion, String ipAddress)\n+            throws Exception {\n+        PortManagerProxy portManagerProxy = new PortManagerProxy(projectId);\n+        PortEntity port = portManagerProxy.getPortById(portId);\n+\n+        List<PortEntity.FixedIp> fixedIps = port.getFixedIps();\n+        List<String> fixedIpv4List = new ArrayList<>();\n+        for (PortEntity.FixedIp fixedIp: fixedIps) {\n+            if (Ipv4AddrUtil.formatCheck(fixedIp.getIpAddress())) {\n+                fixedIpv4List.add(fixedIp.getIpAddress());\n+            }\n+        }\n+\n+        if (fixedIpv4List.isEmpty()) {\n+            throw new ElasticIpPipNotFound();\n+        }\n+\n+        String associatedIp;\n+        if (ipAddress != null) {\n+            if (fixedIpv4List.contains(ipAddress)) {\n+                associatedIp = ipAddress;\n+            } else {\n+                throw new ElasticIpPipNotFound();\n+            }\n+        } else {\n+            if (fixedIpv4List.size() > 1) {\n+                throw new ElasticIpMultipleFixedIpFound();\n+            }\n+            associatedIp = fixedIpv4List.get(0);\n+        }\n+\n+        Map<String, ElasticIp> associatedEips = this.getElasticIpsByPortId(projectId, projectId);\n+        for (ElasticIp eip: associatedEips.values()) {\n+            if (associatedIp.equals(eip.getPrivateIp())) {\n+                throw new ElasticIpAssociateConflict();", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNzExNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457017114", "bodyText": "OK, I will try", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAzOTM0OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457039349", "bodyText": "Thanks.", "author": "xieus", "createdAt": "2020-07-20T04:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkyMjU2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457922564", "bodyText": "Done", "author": "Eric-Yuan", "createdAt": "2020-07-21T08:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzg5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456433893", "bodyText": "getElasticIpsByPortId(projectId, portId)\nI think we need a UT here :-)", "author": "xieus", "createdAt": "2020-07-17T13:14:29Z", "path": "services/elastic_ip_manager/src/main/java/com/futurewei/alcor/elasticipmanager/service/implement/ElasticIpServiceImpl.java", "diffHunk": "@@ -258,6 +269,56 @@ public ElasticIpInfo updateElasticIp(ElasticIpInfo request) throws Exception {\n         return new ElasticIpInfo(eip);\n     }\n \n+    private Map<String, ElasticIp> getElasticIpsByPortId(String projectId, String portId) {\n+\n+        Map<String, Object[]> filter = new HashMap<>();\n+        filter.put(\"project_id\", new Object[] {projectId});\n+        filter.put(\"port_id\", new Object[] {portId});\n+\n+        return elasticIpRepo.findAllItems(filter);\n+    }\n+\n+    private String getAssociatedPortIp(String projectId, String portId, Integer ipVersion, String ipAddress)\n+            throws Exception {\n+        PortManagerProxy portManagerProxy = new PortManagerProxy(projectId);\n+        PortEntity port = portManagerProxy.getPortById(portId);\n+\n+        List<PortEntity.FixedIp> fixedIps = port.getFixedIps();\n+        List<String> fixedIpv4List = new ArrayList<>();\n+        for (PortEntity.FixedIp fixedIp: fixedIps) {\n+            if (Ipv4AddrUtil.formatCheck(fixedIp.getIpAddress())) {\n+                fixedIpv4List.add(fixedIp.getIpAddress());\n+            }\n+        }\n+\n+        if (fixedIpv4List.isEmpty()) {\n+            throw new ElasticIpPipNotFound();\n+        }\n+\n+        String associatedIp;\n+        if (ipAddress != null) {\n+            if (fixedIpv4List.contains(ipAddress)) {\n+                associatedIp = ipAddress;\n+            } else {\n+                throw new ElasticIpPipNotFound();\n+            }\n+        } else {\n+            if (fixedIpv4List.size() > 1) {\n+                throw new ElasticIpMultipleFixedIpFound();\n+            }\n+            associatedIp = fixedIpv4List.get(0);\n+        }\n+\n+        Map<String, ElasticIp> associatedEips = this.getElasticIpsByPortId(projectId, projectId);", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNzE1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457017153", "bodyText": "Sure", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzkyMjM4OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457922389", "bodyText": "Done", "author": "Eric-Yuan", "createdAt": "2020-07-21T08:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzc0OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456437748", "bodyText": "Oh EIP calls itself! Could we handle those calls internally or ask other instance to handle is better?", "author": "xieus", "createdAt": "2020-07-17T13:21:34Z", "path": "web/src/main/java/com/futurewei/alcor/web/restclient/ElasticIpManagerRestClient.java", "diffHunk": "@@ -1,11 +1,77 @@\n+/*\r\n+Copyright 2019 The Alcor Authors.\r\n+\r\n+Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+        you may not use this file except in compliance with the License.\r\n+        You may obtain a copy of the License at\r\n+\r\n+        http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+        Unless required by applicable law or agreed to in writing, software\r\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+        See the License for the specific language governing permissions and\r\n+        limitations under the License.\r\n+*/\r\n+\r\n package com.futurewei.alcor.web.restclient;\r\n \r\n+import com.fasterxml.jackson.databind.ObjectMapper;\r\n+import com.futurewei.alcor.common.stats.DurationStatistics;\r\n+import com.futurewei.alcor.common.utils.ControllerUtil;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpInfo;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpInfoWrapper;\r\n+import com.futurewei.alcor.web.entity.elasticip.ElasticIpsInfoWrapper;\r\n import org.springframework.beans.factory.annotation.Value;\r\n+import org.springframework.http.*;\r\n+import org.springframework.util.MimeType;\r\n+import org.springframework.util.MimeTypeUtils;\r\n+import org.springframework.web.client.RestClientException;\r\n+import org.springframework.web.client.RestTemplate;\r\n+\r\n+import java.util.Map;\r\n \r\n public class ElasticIpManagerRestClient extends AbstractRestClient {\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxMTE4OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457011188", "bodyText": "Seems I don't get the point... This rest client is for port microservice, when delete a port or a fixed ip of it is removed, the port microservice should notify elastic ip manager to remove the related associations.", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:19:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAzODE5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457038193", "bodyText": "hmm, I thought this client is for EIP mgr to call itself. Never mind then.", "author": "xieus", "createdAt": "2020-07-20T04:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MDc3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r456440773", "bodyText": "We could perf testing this method especially when elasticIps = elasticIpManagerRestClient.getElasticIps(this.projectId, filters) returns a lot of eips.\nIt involves at least two self-calls which are not parallel at this time.", "author": "xieus", "createdAt": "2020-07-17T13:26:34Z", "path": "services/port_manager/src/main/java/com/futurewei/alcor/portmanager/proxy/ElasticIpManagerProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\r\n+Copyright 2019 The Alcor Authors.\r\n+\r\n+Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+        you may not use this file except in compliance with the License.\r\n+        You may obtain a copy of the License at\r\n+\r\n+        http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+        Unless required by applicable law or agreed to in writing, software\r\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+        See the License for the specific language governing permissions and\r\n+        limitations under the License.\r\n+*/\r\n+\r\n+package com.futurewei.alcor.portmanager.proxy;\r\n+\r\n+import com.futurewei.alcor.common.utils.SpringContextUtil;\r\n+import com.futurewei.alcor.web.entity.elasticip.*;\r\n+import com.futurewei.alcor.web.restclient.ElasticIpManagerRestClient;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+\r\n+public class ElasticIpManagerProxy {\r\n+\r\n+    private String projectId;\r\n+\r\n+    private ElasticIpManagerRestClient elasticIpManagerRestClient;\r\n+\r\n+    public ElasticIpManagerProxy(String projectId) {\r\n+        this.projectId = projectId;\r\n+        elasticIpManagerRestClient = SpringContextUtil.getBean(ElasticIpManagerRestClient.class);\r\n+    }\r\n+\r\n+    /**\r\n+     * Update the elastic ip association info when port deleted or ip address deleted\r\n+     * @param arg1 Port id\r\n+     * @param arg2 Private ip\r\n+     * @return List<ElasticIpInfoWrapper></>\r\n+     * @throws Exception Rest request exception\r\n+     */\r\n+    public List<ElasticIpInfoWrapper> portIpDeleteEventProcess(Object arg1, Object arg2) throws Exception {\r", "originalCommit": "b5b65d47ff27373451c8edcde148c355268b4f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxODQ0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457018445", "bodyText": "self-calls means extra added calls compared with one integrated controller?", "author": "Eric-Yuan", "createdAt": "2020-07-20T03:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MDc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAzNzAzOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457037039", "bodyText": "Correct. It trigger calls to its own API of EIP mgr, and the call might get load balanced to other instances. This is a well-accepted pattern, just need to pay attention to its performance impact :-)", "author": "xieus", "createdAt": "2020-07-20T04:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MDc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAzOTEzNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/298#discussion_r457039135", "bodyText": "I read your other comments and now I understand your point. This proxy is in Port Mgr so there is no self-call. Never mind.", "author": "xieus", "createdAt": "2020-07-20T04:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MDc3Mw=="}], "type": "inlineReview"}, {"oid": "a18c3a705101d409fc1ee03a6c1f0c2b74a48212", "url": "https://github.com/futurewei-cloud/alcor/commit/a18c3a705101d409fc1ee03a6c1f0c2b74a48212", "message": "Fixed some issues according to the review comments\n1) use a support custom defined message exception instead of the former fixed message exception\n2) cancel the limitation of specifying an ipv6 private ip\n3) cancel the limitation of associating a multi fixed ips port and not specifying the private ip to be associated\n4) fixed a bug that allocated ip would not be released when a exception occurs at associating port process", "committedDate": "2020-07-21T08:21:29Z", "type": "commit"}, {"oid": "2189e1ef866ca0f29b38863b3187e3b1ff778190", "url": "https://github.com/futurewei-cloud/alcor/commit/2189e1ef866ca0f29b38863b3187e3b1ff778190", "message": "Fixed some issues according to the review comments\n1) use a support custom defined message exception instead of the former fixed message exception\n2) cancel the limitation of specifying an ipv6 private ip\n3) cancel the limitation of associating a multi fixed ips port and not specifying the private ip to be associated\n4) fixed a bug that allocated ip would not be released when a exception occurs at associating port process", "committedDate": "2020-07-22T01:44:59Z", "type": "commit"}, {"oid": "68249bca96570d69fd34e17c69a95bc37087e870", "url": "https://github.com/futurewei-cloud/alcor/commit/68249bca96570d69fd34e17c69a95bc37087e870", "message": "Merge branch 'elasticip_associate_port' of https://github.com/Eric-Yuan/alcor into elasticip_associate_port", "committedDate": "2020-07-22T01:45:12Z", "type": "commit"}, {"oid": "b308687f24f4a12458cabe76d36397b19be7a156", "url": "https://github.com/futurewei-cloud/alcor/commit/b308687f24f4a12458cabe76d36397b19be7a156", "message": "Merge branch 'elasticip_associate_port' of https://github.com/Eric-Yuan/alcor into elasticip_associate_port", "committedDate": "2020-07-22T01:55:40Z", "type": "commit"}, {"oid": "94bbd8c2676d5bf96bbf4619ed579ce94f2178b0", "url": "https://github.com/futurewei-cloud/alcor/commit/94bbd8c2676d5bf96bbf4619ed579ce94f2178b0", "message": "Merge branch 'elasticip_associate_port' of https://github.com/Eric-Yuan/alcor into elasticip_associate_port", "committedDate": "2020-07-22T01:55:51Z", "type": "commit"}]}