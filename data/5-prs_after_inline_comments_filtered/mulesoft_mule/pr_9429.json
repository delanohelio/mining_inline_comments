{"pr_number": 9429, "pr_title": "MULE-18644: ValueProvider, Metadata fails due token is expired with OAuth Authorization Code Grant", "pr_createdAt": "2020-09-17T05:37:03Z", "pr_url": "https://github.com/mulesoft/mule/pull/9429", "timeline": [{"oid": "d4a77b42051c8d93653cb8cb9a0867c530da5fda", "url": "https://github.com/mulesoft/mule/commit/d4a77b42051c8d93653cb8cb9a0867c530da5fda", "message": "progress", "committedDate": "2020-09-15T17:20:09Z", "type": "commit"}, {"oid": "5c09eefdc5f906ce26e08b93db2ca91f9859be37", "url": "https://github.com/mulesoft/mule/commit/5c09eefdc5f906ce26e08b93db2ca91f9859be37", "message": "progress.", "committedDate": "2020-09-15T17:20:09Z", "type": "commit"}, {"oid": "6e2617102ad34d7b5fb60e40b73bd678d2418a6d", "url": "https://github.com/mulesoft/mule/commit/6e2617102ad34d7b5fb60e40b73bd678d2418a6d", "message": "MULE-18644", "committedDate": "2020-09-16T18:19:46Z", "type": "commit"}, {"oid": "942f4fcff936adebc9c294dbd80afd78539acb96", "url": "https://github.com/mulesoft/mule/commit/942f4fcff936adebc9c294dbd80afd78539acb96", "message": "self review", "committedDate": "2020-09-16T18:42:16Z", "type": "commit"}, {"oid": "dec369bb5d49e80abcb9da996b54f10d6a1dbf36", "url": "https://github.com/mulesoft/mule/commit/dec369bb5d49e80abcb9da996b54f10d6a1dbf36", "message": "refactor util", "committedDate": "2020-09-17T05:19:15Z", "type": "commit"}, {"oid": "97cde479d35d9726aef4c6337e470ca85d79ef89", "url": "https://github.com/mulesoft/mule/commit/97cde479d35d9726aef4c6337e470ca85d79ef89", "message": "reword", "committedDate": "2020-09-17T05:36:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMDM4Mg==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490330382", "bodyText": "Unify with the definition of the variable\nSet<MetadataKey> metadataKeys = context instanceOf ConnectionProviderAwareMetadaContext...", "author": "gabrieldalborgo", "createdAt": "2020-09-17T15:10:39Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/MetadataKeysDelegate.java", "diffHunk": "@@ -85,11 +87,11 @@\n     try {\n       final Map<Integer, ParameterModel> partsByOrder = getPartOrderMapping(keyParts);\n       Set<MetadataKey> metadataKeys;\n-      if (keyResolver instanceof PartialTypeKeysResolver && hasInitialLevel(partialKey, partsByOrder, reflectionCache)) {\n-        metadataKeys = singleton(((PartialTypeKeysResolver) keyResolver).resolveChilds(context, partialKey));\n-      } else {\n-        metadataKeys = keyResolver.getKeys(context);\n-      }\n+\n+      metadataKeys = context instanceof ConnectionProviderAwareMetadataContext", "originalCommit": "97cde479d35d9726aef4c6337e470ca85d79ef89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c781ccdf6ad47cef795e9c1c246e4e29c5e548e", "url": "https://github.com/mulesoft/mule/commit/6c781ccdf6ad47cef795e9c1c246e4e29c5e548e", "message": "fix test", "committedDate": "2020-09-17T15:54:08Z", "type": "commit"}, {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "url": "https://github.com/mulesoft/mule/commit/dc28d2062fc835a17173811a8cf2fba2c74fde94", "message": "Adds requested changes", "committedDate": "2020-09-17T16:07:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDE1NA==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490994154", "bodyText": "why 4.3.1?", "author": "marianogonzalez", "createdAt": "2020-09-18T14:36:48Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/ConnectionProviderAwareMetadataContext.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.metadata;\n+\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.metadata.MetadataContext;\n+\n+import java.util.Optional;\n+\n+/**\n+ * A {@link MetadataContext} which is aware of the {@link ConnectionProvider} used to provide its connection.\n+ *\n+ * @since 4.4.0, 4.3.1", "originalCommit": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyMDcyNA==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r491020724", "bodyText": "This should be cherry-picked to solve this issue for 4.3.x versions. If we decide that that is not necessary, we can add it only in 4.4.0.", "author": "ndinu", "createdAt": "2020-09-18T15:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyMTcxNg==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r491021716", "bodyText": "the bug cannot be reproduced without OCS, which will only be available with 4.4.0", "author": "marianogonzalez", "createdAt": "2020-09-18T15:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyNDcwMw==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r491024703", "bodyText": "\ud83d\udc4d", "author": "ndinu", "createdAt": "2020-09-18T15:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDE1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDMxNw==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490994317", "bodyText": "why the specialization intstead of adding this to the general metadataContext ?", "author": "marianogonzalez", "createdAt": "2020-09-18T14:37:04Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/ConnectionProviderAwareMetadataContext.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.metadata;\n+\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.metadata.MetadataContext;\n+\n+import java.util.Optional;\n+\n+/**\n+ * A {@link MetadataContext} which is aware of the {@link ConnectionProvider} used to provide its connection.\n+ *\n+ * @since 4.4.0, 4.3.1\n+ */\n+public interface ConnectionProviderAwareMetadataContext extends MetadataContext {", "originalCommit": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyMjAyMQ==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r491022021", "bodyText": "MetadataContext is an api interface that developers use when resolving metadata. We don't want them to access to the instance of the connection provider. This ConnectionProviderAwareMetadataContext is an internal interface.", "author": "ndinu", "createdAt": "2020-09-18T15:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5Njc4NA==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490996784", "bodyText": "this ternary construct is all over the place. Generalize it more.", "author": "marianogonzalez", "createdAt": "2020-09-18T14:40:46Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/MetadataKeysDelegate.java", "diffHunk": "@@ -84,12 +86,11 @@\n \n     try {\n       final Map<Integer, ParameterModel> partsByOrder = getPartOrderMapping(keyParts);\n-      Set<MetadataKey> metadataKeys;\n-      if (keyResolver instanceof PartialTypeKeysResolver && hasInitialLevel(partialKey, partsByOrder, reflectionCache)) {\n-        metadataKeys = singleton(((PartialTypeKeysResolver) keyResolver).resolveChilds(context, partialKey));\n-      } else {\n-        metadataKeys = keyResolver.getKeys(context);\n-      }\n+      Set<MetadataKey> metadataKeys = context instanceof ConnectionProviderAwareMetadataContext\n+          ? getWithTokenRefreshIfNecessary(((ConnectionProviderAwareMetadataContext) context).getConnectionProvider()", "originalCommit": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyMzMxNQ==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r491023315", "bodyText": "Do you mean like having a util method that receives the context and a supplier and have this instanceof logic there?", "author": "ndinu", "createdAt": "2020-09-18T15:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5Njc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NzQxOQ==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490997419", "bodyText": "jdoc", "author": "marianogonzalez", "createdAt": "2020-09-18T14:41:44Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/connectivity/oauth/ExtensionsOAuthUtils.java", "diffHunk": "@@ -92,9 +94,12 @@ public static ClientCredentialsLocation toCredentialsLocation(CredentialsPlaceme\n \n   public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(ExecutionContextAdapter operationContext) {\n     ConfigurationInstance config = ((ConfigurationInstance) operationContext.getConfiguration().get());\n-    ConnectionProvider provider =\n-        unwrapProviderWrapper(config.getConnectionProvider().get(), OAuthConnectionProviderWrapper.class);\n-    return provider instanceof OAuthConnectionProviderWrapper ? (OAuthConnectionProviderWrapper) provider : null;\n+    return getOAuthConnectionProvider(config.getConnectionProvider().get());\n+  }\n+\n+  public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(ConnectionProvider provider) {", "originalCommit": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NzkwNQ==", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490997905", "bodyText": "add jdoc and rename to withRefreshToken", "author": "marianogonzalez", "createdAt": "2020-09-18T14:42:27Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/connectivity/oauth/ExtensionsOAuthUtils.java", "diffHunk": "@@ -195,19 +200,57 @@ public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(Executio\n     }\n   }\n \n+  public static <T> T getWithTokenRefreshIfNecessary(ConnectionProvider connectionProvider, CheckedSupplier<T> supplier)", "originalCommit": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42b3836213d97acc8523710a6a67848f948751b7", "url": "https://github.com/mulesoft/mule/commit/42b3836213d97acc8523710a6a67848f948751b7", "message": "Adds feedback changes", "committedDate": "2020-09-18T16:46:19Z", "type": "commit"}]}