{"pr_number": 8641, "pr_title": "MULE-18051: Improve SDK performance by using generated bytecode instead of reflection", "pr_createdAt": "2020-02-10T22:56:11Z", "pr_url": "https://github.com/mulesoft/mule/pull/8641", "timeline": [{"oid": "44781103701471a6e921811cfdbe97920c43accc", "url": "https://github.com/mulesoft/mule/commit/44781103701471a6e921811cfdbe97920c43accc", "message": "hell yeah!", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "657b77ade7f327cbd7bd3c6922028bf462cb00e1", "url": "https://github.com/mulesoft/mule/commit/657b77ade7f327cbd7bd3c6922028bf462cb00e1", "message": "update dependency", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "121ee3ad1d254313d44ce2d3966fad96f4cf74b9", "url": "https://github.com/mulesoft/mule/commit/121ee3ad1d254313d44ce2d3966fad96f4cf74b9", "message": "fix", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "3b5d62148446014ff69d297baeeb0400fd3f5682", "url": "https://github.com/mulesoft/mule/commit/3b5d62148446014ff69d297baeeb0400fd3f5682", "message": "curated prototype", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "5ac073057cf859eeea259451b5e91205048bc660", "url": "https://github.com/mulesoft/mule/commit/5ac073057cf859eeea259451b5e91205048bc660", "message": "rename and clean up", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "065c2ad044b08667130715b95ea049cc166a89fe", "url": "https://github.com/mulesoft/mule/commit/065c2ad044b08667130715b95ea049cc166a89fe", "message": "bug fixes", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "362111e0957c9667f9d8fdcc7cbd5ef318bb5026", "url": "https://github.com/mulesoft/mule/commit/362111e0957c9667f9d8fdcc7cbd5ef318bb5026", "message": "bybye autoboxing", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "7b42a0d80062c20649b8b96c90b29187d0786486", "url": "https://github.com/mulesoft/mule/commit/7b42a0d80062c20649b8b96c90b29187d0786486", "message": "format", "committedDate": "2020-02-10T21:45:28Z", "type": "commit"}, {"oid": "ea2dbd36d345d4adb7bd3f8dc1fbba3942b03919", "url": "https://github.com/mulesoft/mule/commit/ea2dbd36d345d4adb7bd3f8dc1fbba3942b03919", "message": "debug tools", "committedDate": "2020-02-10T21:45:29Z", "type": "commit"}, {"oid": "13d1b113911c9f602ca95368a80db9c7129a0f02", "url": "https://github.com/mulesoft/mule/commit/13d1b113911c9f602ca95368a80db9c7129a0f02", "message": "working", "committedDate": "2020-02-10T21:45:29Z", "type": "commit"}, {"oid": "a35923044087ead42da665f04e34bbb13c3896f1", "url": "https://github.com/mulesoft/mule/commit/a35923044087ead42da665f04e34bbb13c3896f1", "message": "format", "committedDate": "2020-02-10T21:58:41Z", "type": "commit"}, {"oid": "1f327d802f845db4e9e023b934928112a0e922e8", "url": "https://github.com/mulesoft/mule/commit/1f327d802f845db4e9e023b934928112a0e922e8", "message": "MULE-18051: Improve SDK performance by using generated bytecode instead of reflection", "committedDate": "2020-02-10T22:55:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxNzc0Mg==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377617742", "bodyText": "add serialVersion uuid", "author": "elrodro83", "createdAt": "2020-02-11T12:58:27Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/exception/SdkMethodInvocationException.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.exception;\n+\n+import org.mule.runtime.api.exception.MuleRuntimeException;\n+\n+/**\n+ * Signals that the SDK invoked an extension's method which threw an exception. The exception thrown will be available as\n+ * the cause.\n+ * <p>\n+ * Because this is a {@link MuleRuntimeException}, it will not automatically fill the stack trace, providing a performance\n+ * boost.\n+ *\n+ * @since 4.3.0\n+ */\n+public class SdkMethodInvocationException extends MuleRuntimeException {", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxODE0Nw==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377618147", "bodyText": "this is true also for MuleException. Did you make it a MuleRuntimeException because of this or do you actually need this to be a runtime exception?", "author": "elrodro83", "createdAt": "2020-02-11T12:59:15Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/exception/SdkMethodInvocationException.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.exception;\n+\n+import org.mule.runtime.api.exception.MuleRuntimeException;\n+\n+/**\n+ * Signals that the SDK invoked an extension's method which threw an exception. The exception thrown will be available as\n+ * the cause.\n+ * <p>\n+ * Because this is a {@link MuleRuntimeException}, it will not automatically fill the stack trace, providing a performance", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2Nzg5Mg==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377667892", "bodyText": "I need it to be a Runtime one", "author": "marianogonzalez", "createdAt": "2020-02-11T14:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxODE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxODI4MA==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377618280", "bodyText": "is this removal related to this change?", "author": "elrodro83", "createdAt": "2020-02-11T12:59:34Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/exception/TooManyConfigsException.java", "diffHunk": "@@ -1,45 +0,0 @@\n-/*\n- * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n- * The software in this package is published under the terms of the CPAL v1.0\n- * license, a copy of which has been included with this distribution in the\n- * LICENSE.txt file.\n- */\n-package org.mule.runtime.module.extension.internal.runtime.exception;\n-\n-import static org.mule.runtime.api.i18n.I18nMessageFactory.createStaticMessage;\n-import org.mule.runtime.api.exception.MuleRuntimeException;\n-import org.mule.runtime.api.meta.model.ExtensionModel;\n-import org.mule.runtime.api.meta.model.config.ConfigurationModel;\n-\n-/**\n- * Exception to signal that too many configs are eligible for executing a component and thus the user should manually select one\n- *\n- * @since 4.0\n- */\n-public class TooManyConfigsException extends MuleRuntimeException {\n-\n-  private final ExtensionModel extensionModel;\n-  private final ConfigurationModel configurationModel;\n-  private final int configsCount;\n-\n-  public TooManyConfigsException(String message, ExtensionModel extensionModel, ConfigurationModel configurationModel,", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NDcwNA==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377664704", "bodyText": "no. It was dead code I came by", "author": "marianogonzalez", "createdAt": "2020-02-11T14:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxODI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDY1Ng==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377620656", "bodyText": "the file should only be generated if a certain troubleshooting flag is enabled", "author": "elrodro83", "createdAt": "2020-02-11T13:04:43Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/GeneratedClass.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.execution;\n+\n+import java.io.File;\n+\n+/**\n+ * Represents a class that was dynamically generated at runtime\n+ *\n+ * @param <T> the generic type of the generated class\n+ * @since 4.3.0\n+ */\n+public final class GeneratedClass<T> {\n+\n+  private final Class<T> generatedClass;\n+  private final File byteCodeFile;", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NTI3NQ==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377665275", "bodyText": "The underlying classloader is an URLClassLoader. How can you load the class otherwise?", "author": "marianogonzalez", "createdAt": "2020-02-11T14:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDY1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4OTQ0Ng==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377689446", "bodyText": "good point", "author": "elrodro83", "createdAt": "2020-02-11T15:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDgzNw==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377620837", "bodyText": "what's the point of this?", "author": "elrodro83", "createdAt": "2020-02-11T13:05:08Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/GeneratedInstance.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.execution;\n+\n+/**\n+ * Represents an instance of a {@link GeneratedClass}\n+ *\n+ * @param <T> the generic type of the generated instance\n+ * @since 4.3.0\n+ */\n+public final class GeneratedInstance<T> {", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NTQyMA==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377665420", "bodyText": "being able to write the test case :)", "author": "marianogonzalez", "createdAt": "2020-02-11T14:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMjk1NA==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377622954", "bodyText": "this seems to be called concurrently. Replace the map with a ConcurrentHashMap", "author": "elrodro83", "createdAt": "2020-02-11T13:09:30Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/execution/executor/MethodExecutorGenerator.java", "diffHunk": "@@ -0,0 +1,265 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.execution.executor;\n+\n+import static java.lang.System.identityHashCode;\n+import static java.util.Arrays.asList;\n+import static net.bytebuddy.description.modifier.FieldManifestation.FINAL;\n+import static net.bytebuddy.description.modifier.Visibility.PRIVATE;\n+import static net.bytebuddy.description.modifier.Visibility.PUBLIC;\n+import static net.bytebuddy.description.type.TypeDescription.Generic.Builder.parameterizedType;\n+import static net.bytebuddy.dynamic.loading.ClassLoadingStrategy.Default.INJECTION;\n+import static net.bytebuddy.dynamic.scaffold.subclass.ConstructorStrategy.Default.NO_CONSTRUCTORS;\n+import static net.bytebuddy.implementation.bytecode.member.FieldAccess.forField;\n+import static net.bytebuddy.implementation.bytecode.member.MethodReturn.VOID;\n+import static net.bytebuddy.matcher.ElementMatchers.isConstructor;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+import static org.mule.runtime.api.i18n.I18nMessageFactory.createStaticMessage;\n+import static org.mule.runtime.core.api.util.FileUtils.TEMP_DIR;\n+\n+import org.mule.runtime.api.exception.MuleRuntimeException;\n+import org.mule.runtime.core.internal.util.CompositeClassLoader;\n+import org.mule.runtime.extension.api.runtime.operation.ExecutionContext;\n+import org.mule.runtime.module.extension.internal.runtime.execution.ArgumentResolverDelegate;\n+import org.mule.runtime.module.extension.internal.runtime.execution.GeneratedClass;\n+import org.mule.runtime.module.extension.internal.runtime.execution.GeneratedInstance;\n+import org.mule.runtime.module.extension.internal.runtime.resolver.ArgumentResolver;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Parameter;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import net.bytebuddy.ByteBuddy;\n+import net.bytebuddy.description.field.FieldDescription;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription.ForLoadedType;\n+import net.bytebuddy.dynamic.DynamicType;\n+import net.bytebuddy.dynamic.DynamicType.Builder.MethodDefinition.ParameterDefinition.Annotatable;\n+import net.bytebuddy.dynamic.DynamicType.Unloaded;\n+import net.bytebuddy.dynamic.scaffold.InstrumentedType;\n+import net.bytebuddy.implementation.Implementation;\n+import net.bytebuddy.implementation.MethodCall;\n+import net.bytebuddy.implementation.MethodCall.ArgumentLoader;\n+import net.bytebuddy.implementation.bytecode.ByteCodeAppender;\n+import net.bytebuddy.implementation.bytecode.StackManipulation;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner;\n+import net.bytebuddy.implementation.bytecode.member.FieldAccess;\n+import net.bytebuddy.implementation.bytecode.member.MethodInvocation;\n+import net.bytebuddy.implementation.bytecode.member.MethodVariableAccess;\n+\n+/**\n+ * Uses bytecode manipulation to dynamically generate {@link MethodExecutor} classes that invoke a given method.\n+ *\n+ * @since 4.3.0\n+ */\n+public class MethodExecutorGenerator {\n+\n+  private static final String TARGET_INSTANCE_FIELD_NAME = \"__targetInstance\";\n+  private final Map<String, GeneratedClass<MethodExecutor>> executorClasses = new HashMap<>();\n+  private final int instanceId = identityHashCode(this);\n+\n+  /**\n+   * Creates a {@link GeneratedInstance} pointing to a dynamic {@link MethodExecutor} that executes the given {@code method}.\n+   * <p>\n+   * Each invocation to this method will return a new {@link GeneratedInstance} pointing to unique instances. However, all\n+   * invocations pointing to the same {@code method} will share the same underlying {@link GeneratedClass}\n+   *\n+   * @param targetInstance           the instance on which the method is to be executed\n+   * @param method                   the method to be invoked\n+   * @param argumentResolverDelegate the {@link ArgumentResolverDelegate} that provides the {@link ArgumentResolver resolvers}\n+   * @return a {@link GeneratedInstance}\n+   * @throws Exception if the instance cannot be generated\n+   */\n+  public GeneratedInstance<MethodExecutor> generate(Object targetInstance,\n+                                                    Method method,\n+                                                    ArgumentResolverDelegate argumentResolverDelegate)\n+      throws Exception {\n+\n+    GeneratedClass<MethodExecutor> generatedClass = getExecutorClass(method, targetInstance);\n+    List<Object> args = new ArrayList<>();\n+    args.add(targetInstance);\n+    args.addAll(asList(argumentResolverDelegate.getArgumentResolvers()));\n+\n+    MethodExecutor instance = (MethodExecutor) generatedClass.getGeneratedClass().getConstructors()[0]\n+        .newInstance(args.toArray(new Object[args.size()]));\n+\n+    return new GeneratedInstance<>(instance, generatedClass);\n+  }\n+\n+  private GeneratedClass<MethodExecutor> getExecutorClass(Method method, Object targetInstance) {\n+    String generatorName = getGeneratorName(method);\n+    return executorClasses.computeIfAbsent(generatorName, key -> generateExecutorClass(key, method, targetInstance));", "originalCommit": "1f327d802f845db4e9e023b934928112a0e922e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2NTY4Ng==", "url": "https://github.com/mulesoft/mule/pull/8641#discussion_r377665686", "bodyText": "no. This is not called concurrently. But I will do the change anyway just in case", "author": "marianogonzalez", "createdAt": "2020-02-11T14:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMjk1NA=="}], "type": "inlineReview"}, {"oid": "d74846fbb35d20ffc91084b60c9740247567f59d", "url": "https://github.com/mulesoft/mule/commit/d74846fbb35d20ffc91084b60c9740247567f59d", "message": "feedback", "committedDate": "2020-02-11T14:29:43Z", "type": "commit"}, {"oid": "2458c912939cd5f0ca86bb319b2a8397a8dd6208", "url": "https://github.com/mulesoft/mule/commit/2458c912939cd5f0ca86bb319b2a8397a8dd6208", "message": "sonar feedback", "committedDate": "2020-02-11T14:52:30Z", "type": "commit"}, {"oid": "a3be93bac2ca7e0710f9e77b325275190014bffb", "url": "https://github.com/mulesoft/mule/commit/a3be93bac2ca7e0710f9e77b325275190014bffb", "message": "more feedback", "committedDate": "2020-02-11T15:22:27Z", "type": "commit"}, {"oid": "2a909026c4c400af129aca214915aae487373e47", "url": "https://github.com/mulesoft/mule/commit/2a909026c4c400af129aca214915aae487373e47", "message": "dependency management", "committedDate": "2020-02-11T16:54:32Z", "type": "commit"}, {"oid": "38b4ab1f34b3ed3ba10435adb75ab305c8371847", "url": "https://github.com/mulesoft/mule/commit/38b4ab1f34b3ed3ba10435adb75ab305c8371847", "message": "jdooc", "committedDate": "2020-02-11T16:56:21Z", "type": "commit"}, {"oid": "6ec1ce2f88d10e61428c50e55b02cfb58dd063fc", "url": "https://github.com/mulesoft/mule/commit/6ec1ce2f88d10e61428c50e55b02cfb58dd063fc", "message": "empty line", "committedDate": "2020-02-11T16:57:12Z", "type": "commit"}, {"oid": "154d82373bd3a57c136e88e9cc843d282796736c", "url": "https://github.com/mulesoft/mule/commit/154d82373bd3a57c136e88e9cc843d282796736c", "message": "salvenme de esta", "committedDate": "2020-02-11T20:24:13Z", "type": "commit"}]}