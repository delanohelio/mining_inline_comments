{"pr_number": 9555, "pr_title": "MULE-18895: Avoid cursor re-management with PayloadStatistics decorators", "pr_createdAt": "2020-10-14T15:35:44Z", "pr_url": "https://github.com/mulesoft/mule/pull/9555", "timeline": [{"oid": "8a70b0b9ddf1bd720dbd48020fdb5e5ee89713a8", "url": "https://github.com/mulesoft/mule/commit/8a70b0b9ddf1bd720dbd48020fdb5e5ee89713a8", "message": "LongAdder, this addresses the contention issue.", "committedDate": "2020-10-15T13:47:42Z", "type": "forcePushed"}, {"oid": "cce772c99a2756b25a30e56263d53254b852d8d1", "url": "https://github.com/mulesoft/mule/commit/cce772c99a2756b25a30e56263d53254b852d8d1", "message": "remove returns", "committedDate": "2020-10-16T03:40:43Z", "type": "commit"}, {"oid": "38fa8d7a28907826a4f4b9535b289c4904d166fb", "url": "https://github.com/mulesoft/mule/commit/38fa8d7a28907826a4f4b9535b289c4904d166fb", "message": "no lambdas referencing outer scope", "committedDate": "2020-10-16T03:40:44Z", "type": "commit"}, {"oid": "f1c8cb9b912631330b8f45c6125cd866d2fa44ca", "url": "https://github.com/mulesoft/mule/commit/f1c8cb9b912631330b8f45c6125cd866d2fa44ca", "message": "LongAdder and propagate int instead of long", "committedDate": "2020-10-16T03:40:46Z", "type": "commit"}, {"oid": "539c38e411eb2fcdf16f332dffe2232415b05ea5", "url": "https://github.com/mulesoft/mule/commit/539c38e411eb2fcdf16f332dffe2232415b05ea5", "message": "Revert \"LongAdder and propagate int instead of long\"\n\nThis reverts commit 035766836c563ec429ff6ef3118190f9e6901dfe.", "committedDate": "2020-10-16T03:40:48Z", "type": "commit"}, {"oid": "a9992fc7922d00ab94fcba69193531cf1e5a98c9", "url": "https://github.com/mulesoft/mule/commit/a9992fc7922d00ab94fcba69193531cf1e5a98c9", "message": "Revert \"no lambdas referencing outer scope\"\n\nThis reverts commit 713d31af033a642d77aada12cd5674d48a411320.", "committedDate": "2020-10-16T03:40:49Z", "type": "commit"}, {"oid": "1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47", "url": "https://github.com/mulesoft/mule/commit/1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47", "message": "LongAdder, this addresses the contention issue.", "committedDate": "2020-10-16T03:40:51Z", "type": "commit"}, {"oid": "3baff324209781cdc06032ba8ea9319ee5d3f8e2", "url": "https://github.com/mulesoft/mule/commit/3baff324209781cdc06032ba8ea9319ee5d3f8e2", "message": "avoid double manage", "committedDate": "2020-10-16T03:40:53Z", "type": "commit"}, {"oid": "bac755acd30e196d93997aa695162079d67402d4", "url": "https://github.com/mulesoft/mule/commit/bac755acd30e196d93997aa695162079d67402d4", "message": "yet another decorator", "committedDate": "2020-10-16T03:40:54Z", "type": "commit"}, {"oid": "17decfea53bc069d4a79d3d422d86046eb199178", "url": "https://github.com/mulesoft/mule/commit/17decfea53bc069d4a79d3d422d86046eb199178", "message": "Revert \"LongAdder, this addresses the contention issue.\"\n\nThis reverts commit 1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47.", "committedDate": "2020-10-16T03:41:09Z", "type": "commit"}, {"oid": "17decfea53bc069d4a79d3d422d86046eb199178", "url": "https://github.com/mulesoft/mule/commit/17decfea53bc069d4a79d3d422d86046eb199178", "message": "Revert \"LongAdder, this addresses the contention issue.\"\n\nThis reverts commit 1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47.", "committedDate": "2020-10-16T03:41:09Z", "type": "forcePushed"}, {"oid": "6f53ea2cccb50848a3374db2f7ac4c02d06b0648", "url": "https://github.com/mulesoft/mule/commit/6f53ea2cccb50848a3374db2f7ac4c02d06b0648", "message": "fix format", "committedDate": "2020-10-16T13:39:59Z", "type": "commit"}, {"oid": "d904f6aaf9ee96626976cf5e8510e6030dc9461c", "url": "https://github.com/mulesoft/mule/commit/d904f6aaf9ee96626976cf5e8510e6030dc9461c", "message": "dg", "committedDate": "2020-10-16T15:02:28Z", "type": "commit"}, {"oid": "f2d46af5da10255b60c60b4d4e1fce866419f6b8", "url": "https://github.com/mulesoft/mule/commit/f2d46af5da10255b60c60b4d4e1fce866419f6b8", "message": "asdf", "committedDate": "2020-10-16T15:23:51Z", "type": "commit"}, {"oid": "da3332a8e5b071747dbd22de0581ee6a8921ac59", "url": "https://github.com/mulesoft/mule/commit/da3332a8e5b071747dbd22de0581ee6a8921ac59", "message": "dsfggs", "committedDate": "2020-10-16T15:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MTA3OQ==", "url": "https://github.com/mulesoft/mule/pull/9555#discussion_r506551079", "bodyText": "functionality", "author": "fsgonz", "createdAt": "2020-10-16T15:34:49Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/management/stats/PayloadStatisticsTestCase.java", "diffHunk": "@@ -766,6 +772,45 @@ public void flowProcessMediatorCollectionItems() throws Exception {\n     verify(sourcePolicy).process(any(), any(), any());\n   }\n \n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that managing a decorator of a cursor provider returns the same instance instead of attempting to manage it again.\")\n+  public void managedProviderNotManagedTwice() throws MuleException {\n+    final DefaultStreamingManager streamingManager = new DefaultStreamingManager();\n+    initialiseIfNeeded(streamingManager, muleContext);\n+\n+    final ManagedCursorStreamProvider provider = mock(ManagedCursorStreamProvider.class);\n+    when(provider.isManaged()).thenCallRealMethod();\n+    final InputDecoratedCursorStreamProvider decoratedProvider =\n+        new InputDecoratedCursorStreamProvider(provider, decoratorFactory.componentDecoratorFactory(component1), CORR_ID);\n+\n+    final CursorProvider managed = streamingManager.manage(decoratedProvider, testEvent());\n+\n+    assertThat(managed, is(sameInstance(decoratedProvider)));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")", "originalCommit": "da3332a8e5b071747dbd22de0581ee6a8921ac59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MjMzMQ==", "url": "https://github.com/mulesoft/mule/pull/9555#discussion_r506552331", "bodyText": "so that", "author": "fsgonz", "createdAt": "2020-10-16T15:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MTA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MTIxNg==", "url": "https://github.com/mulesoft/mule/pull/9555#discussion_r506551216", "bodyText": "functionality", "author": "fsgonz", "createdAt": "2020-10-16T15:34:57Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/management/stats/PayloadStatisticsTestCase.java", "diffHunk": "@@ -766,6 +772,45 @@ public void flowProcessMediatorCollectionItems() throws Exception {\n     verify(sourcePolicy).process(any(), any(), any());\n   }\n \n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that managing a decorator of a cursor provider returns the same instance instead of attempting to manage it again.\")\n+  public void managedProviderNotManagedTwice() throws MuleException {\n+    final DefaultStreamingManager streamingManager = new DefaultStreamingManager();\n+    initialiseIfNeeded(streamingManager, muleContext);\n+\n+    final ManagedCursorStreamProvider provider = mock(ManagedCursorStreamProvider.class);\n+    when(provider.isManaged()).thenCallRealMethod();\n+    final InputDecoratedCursorStreamProvider decoratedProvider =\n+        new InputDecoratedCursorStreamProvider(provider, decoratorFactory.componentDecoratorFactory(component1), CORR_ID);\n+\n+    final CursorProvider managed = streamingManager.manage(decoratedProvider, testEvent());\n+\n+    assertThat(managed, is(sameInstance(decoratedProvider)));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")\n+  public void managedCursorInputNotManagedTwice() throws MuleException {\n+    final InputStream stream = mock(CursorStream.class);\n+    final InputStream decorated =\n+        decoratorFactory.componentDecoratorFactory(component1).decorateInput(stream, CORR_ID);\n+\n+    assertThat(decorated, instanceOf(CursorStream.class));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")", "originalCommit": "da3332a8e5b071747dbd22de0581ee6a8921ac59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc968976e59a153c97a1378883c574797182ba32", "url": "https://github.com/mulesoft/mule/commit/cc968976e59a153c97a1378883c574797182ba32", "message": "fix typos", "committedDate": "2020-10-16T16:32:26Z", "type": "commit"}]}