{"pr_number": 9439, "pr_title": "MULE-18777: Multiple reconnections of a source must not occur at the same time", "pr_createdAt": "2020-09-18T15:41:11Z", "pr_url": "https://github.com/mulesoft/mule/pull/9439", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r491163983", "bodyText": "why moving this from here to line 312? also, does the doOn vs doAfter change really fix the race condition or just makes it less likely?", "author": "marianogonzalez", "createdAt": "2020-09-18T20:03:02Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -323,7 +323,6 @@ public void onException(ConnectionException exception) {\n     reconnectionAction\n         .doOnSuccess(v -> onReconnectionSuccessful())\n         .doOnError(this::onReconnectionFailed)\n-        .doAfterTerminate(() -> reconnecting.set(false))", "originalCommit": "2a0bf368b05fd2ee48b1d20616736da7e638089c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2OTM0NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r491169344", "bodyText": "Moving it to line 312 will make it apply only to sources that implement Reconnectable. Other cases are covered by the doWork method (line 548)", "author": "gabrieldalborgo", "createdAt": "2020-09-18T20:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NzM0NQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492277345", "bodyText": "this seems to be tackling a symptom rather than the root cause. What's the real problem been solved here? Moving this should have no effect, as no two reconnection tasks should be overlapping. If they do, then the bug is a prior race condition", "author": "marianogonzalez", "createdAt": "2020-09-21T18:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5MjE4OQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492292189", "bodyText": "What I saw, is that the reconnecting variable is being released (at this point) before the source onStart method ends (which runs asyncrhonously sometimes). And if at the source onStart method a connection exception is notified through the source callback, another reconnection overlaps the current one.", "author": "gabrieldalborgo", "createdAt": "2020-09-21T19:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyNjg4NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492326884", "bodyText": "right, but the ting is that reconnection is always asynchronous, with the only exception of sources that implement the Reconnectable interface. So maybe it's not about moving this but about how could the overlap happen in the first place. I could well argue that it's really the doWork method the one which shouldn't be changing the variable and that the actual bug is the overlap, which you're merely hiding here.\nI think you should start by getting good functional tests since the issue seems to revolve exclusively around reconnectable sources which is not something I'm seeing properly replicated on your tests cases.", "author": "marianogonzalez", "createdAt": "2020-09-21T20:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzNTY4Mg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492335682", "bodyText": "I just pushed the test that I forgot before", "author": "gabrieldalborgo", "createdAt": "2020-09-21T20:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk2MDg4NQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r495960885", "bodyText": "Change rollbacked, isn't the right fix.", "author": "gabrieldalborgo", "createdAt": "2020-09-28T13:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Mzk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2NDA0MA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r491164040", "bodyText": "where's the test case for this?", "author": "marianogonzalez", "createdAt": "2020-09-18T20:03:11Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -309,7 +309,7 @@ public void onException(ConnectionException exception) {\n                 exception);\n \n     Mono<Void> reconnectionAction = sourceAdapter.getReconnectionAction(exception)\n-        .map(p -> from(retryPolicyTemplate.applyPolicy(p, retryScheduler)))\n+        .map(p -> from(retryPolicyTemplate.applyPolicy(p, retryScheduler)).doOnTerminate(() -> reconnecting.set(false)))", "originalCommit": "2a0bf368b05fd2ee48b1d20616736da7e638089c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2Njk3NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r491166974", "bodyText": "I'm working on it. This PR is to validate that this fix does not break any tests", "author": "gabrieldalborgo", "createdAt": "2020-09-18T20:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2NDA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyOTczNQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492229735", "bodyText": "This case is covered by: org.mule.test.module.extension.source.CustomReconnectionSourceTestCase.successfulCustomReconnection", "author": "gabrieldalborgo", "createdAt": "2020-09-21T17:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2NDA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NDkwMA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492274900", "bodyText": "don't swallow this exception", "author": "marianogonzalez", "createdAt": "2020-09-21T18:50:25Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicReference<Integer> countStartedSources = new AtomicReference<>(0);\n+\n+  private void delay(Long millis) {\n+    try {\n+      Thread.sleep(millis);\n+    } catch (InterruptedException e) {\n+      e.printStackTrace();", "originalCommit": "85560d8b0bd71e096c2b29e6d38513979caf5880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NTI3NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492275274", "bodyText": "all tests in this class are flaky", "author": "marianogonzalez", "createdAt": "2020-09-21T18:51:07Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {", "originalCommit": "85560d8b0bd71e096c2b29e6d38513979caf5880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NjE5OQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492276199", "bodyText": "Use AtomicInteger instead", "author": "marianogonzalez", "createdAt": "2020-09-21T18:52:49Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicReference<Integer> countStartedSources = new AtomicReference<>(0);", "originalCommit": "85560d8b0bd71e096c2b29e6d38513979caf5880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3NjQzOA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r492276438", "bodyText": "all tests in this class seem to be testing the implementation rather than behavior", "author": "marianogonzalez", "createdAt": "2020-09-21T18:53:18Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {", "originalCommit": "85560d8b0bd71e096c2b29e6d38513979caf5880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d528d749478fc3c1a4beb38bda70e14198338d7a", "url": "https://github.com/mulesoft/mule/commit/d528d749478fc3c1a4beb38bda70e14198338d7a", "message": "Update reconnection extension models & schemas", "committedDate": "2020-09-21T20:43:25Z", "type": "forcePushed"}, {"oid": "8bdaed074a580c739d9d62b80df1c93bebb088d9", "url": "https://github.com/mulesoft/mule/commit/8bdaed074a580c739d9d62b80df1c93bebb088d9", "message": "Fix", "committedDate": "2020-09-23T12:01:48Z", "type": "commit"}, {"oid": "6c61a4f2fe9ed3c0dcf3f6a99854c31c8d277b23", "url": "https://github.com/mulesoft/mule/commit/6c61a4f2fe9ed3c0dcf3f6a99854c31c8d277b23", "message": "Fix for reconnectable sources", "committedDate": "2020-09-23T12:01:48Z", "type": "commit"}, {"oid": "497d80c4dee1274be90104060c1dc77ed998deb9", "url": "https://github.com/mulesoft/mule/commit/497d80c4dee1274be90104060c1dc77ed998deb9", "message": "Update reconnection extension models & schemas", "committedDate": "2020-09-23T13:04:39Z", "type": "commit"}, {"oid": "000358c376eb49e221debbc0f2f34d79bd499b38", "url": "https://github.com/mulesoft/mule/commit/000358c376eb49e221debbc0f2f34d79bd499b38", "message": "Revert \"Fix for reconnectable sources\"\n\nThis reverts commit 2a0bf368b05fd2ee48b1d20616736da7e638089c.", "committedDate": "2020-09-23T13:04:39Z", "type": "commit"}, {"oid": "06d46a28bb98e1fda0db297df833304bc9a7b2e4", "url": "https://github.com/mulesoft/mule/commit/06d46a28bb98e1fda0db297df833304bc9a7b2e4", "message": "Revert \"Fix\"\n\nThis reverts commit 6b894cb9972073ca448670437bb061d4075176bf.", "committedDate": "2020-09-23T13:04:39Z", "type": "commit"}, {"oid": "875526fda20f21a9005425c005d3659042f74b1c", "url": "https://github.com/mulesoft/mule/commit/875526fda20f21a9005425c005d3659042f74b1c", "message": "Refactor", "committedDate": "2020-09-23T13:04:39Z", "type": "commit"}, {"oid": "2f7ae9a6c7c8d204cdd8e1fc4b0f04d7df89d4b1", "url": "https://github.com/mulesoft/mule/commit/2f7ae9a6c7c8d204cdd8e1fc4b0f04d7df89d4b1", "message": "Add test", "committedDate": "2020-09-23T13:04:39Z", "type": "commit"}, {"oid": "2f7ae9a6c7c8d204cdd8e1fc4b0f04d7df89d4b1", "url": "https://github.com/mulesoft/mule/commit/2f7ae9a6c7c8d204cdd8e1fc4b0f04d7df89d4b1", "message": "Add test", "committedDate": "2020-09-23T13:04:39Z", "type": "forcePushed"}, {"oid": "389822214de31d1b516933efcf46e0733483d4db", "url": "https://github.com/mulesoft/mule/commit/389822214de31d1b516933efcf46e0733483d4db", "message": "Increase delay", "committedDate": "2020-09-23T20:08:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5OTA5NQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494299095", "bodyText": "I think we should make the test shorter, can we guarantee that the issue is fixed waiting less than 30 secs?", "author": "ndinu", "createdAt": "2020-09-24T13:04:02Z", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -88,6 +89,23 @@ public void reconnectSource() throws Exception {\n     });\n   }\n \n+  @Test\n+  public void doNotStartSourceTwiceAfterExceptionOnReconnection() throws Exception {\n+    ((Startable) getFlowConstruct(\"otherReconnectForever\")).start();\n+    check(5000, 1000, () -> !capturedEvents.isEmpty());\n+    switchOtherFail();\n+\n+    checkNot(30000, 1000, () -> {", "originalCommit": "389822214de31d1b516933efcf46e0733483d4db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNzAxNQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494307015", "bodyText": "Let me try it", "author": "gabrieldalborgo", "createdAt": "2020-09-24T13:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5OTA5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1NzQ3Mw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494357473", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T14:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5OTA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTk4MQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494301981", "bodyText": "Does it need to wait this much?", "author": "ndinu", "createdAt": "2020-09-24T13:08:24Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);\n+    delay(1000L);\n+    doStart(sourceCallback);\n+  }\n+\n+  private void doStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    ReconnectableConnection connection = connectionProvider.connect();\n+    this.scheduler = schedulerService.ioScheduler();\n+\n+    if (ReconnectableConnectionProvider.otherFail) {\n+      delay(10000L);", "originalCommit": "389822214de31d1b516933efcf46e0733483d4db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwOTI2Mg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494309262", "bodyText": "With 200ms (and maybe less) is enough, but I set a ridiculous value to avoid the test became flaky. Do you you think that is not necessary or not a good approach?", "author": "gabrieldalborgo", "createdAt": "2020-09-24T13:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNjkyNQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494316925", "bodyText": "I think that the wait here will make the tests take longer, and we should avoid it if possible. If less than 200ms is enough, maybe we can use 1 second?", "author": "ndinu", "createdAt": "2020-09-24T13:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1NzY0Mw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494357643", "bodyText": "Done.", "author": "gabrieldalborgo", "createdAt": "2020-09-24T14:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwMTk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNDY0Mg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494314642", "bodyText": "Is there any way to also check that reconnection was triggered twice and simultaneously? From what I understand this test can also pass if only 1 reconnection is made (which is unlikely due to the Thread sleeps but could also happen if code is changed later on in the Extension Message Source).", "author": "SebaElizalde", "createdAt": "2020-09-24T13:26:07Z", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -88,6 +89,23 @@ public void reconnectSource() throws Exception {\n     });\n   }\n \n+  @Test\n+  public void doNotStartSourceTwiceAfterExceptionOnReconnection() throws Exception {\n+    ((Startable) getFlowConstruct(\"otherReconnectForever\")).start();\n+    check(5000, 1000, () -> !capturedEvents.isEmpty());\n+    switchOtherFail();\n+\n+    checkNot(30000, 1000, () -> {\n+      synchronized (capturedEvents) {\n+        return capturedEvents.stream()\n+            .map(event -> (Integer) event.getMessage().getPayload().getValue())\n+            .filter(startedSources -> startedSources > 1)", "originalCommit": "389822214de31d1b516933efcf46e0733483d4db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMyODkxMg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494328912", "bodyText": "That is what this test does. The variable startedSources is counting how many sources are starting at the same time. I will rename it to something like currentStartedSources", "author": "gabrieldalborgo", "createdAt": "2020-09-24T13:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1Nzc2Nw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494357767", "bodyText": "Done.", "author": "gabrieldalborgo", "createdAt": "2020-09-24T14:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxNDY0Mg=="}], "type": "inlineReview"}, {"oid": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "url": "https://github.com/mulesoft/mule/commit/2451d5a87fa8f4f82f145fdda9e53c7373910461", "message": "Changes", "committedDate": "2020-09-24T14:16:34Z", "type": "commit"}, {"oid": "11bac11e873808572fc11878fd2b99d93dd6a019", "url": "https://github.com/mulesoft/mule/commit/11bac11e873808572fc11878fd2b99d93dd6a019", "message": "Fix", "committedDate": "2020-09-24T19:42:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1MjQ1OQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494552459", "bodyText": "we have a ton of interfaces like this already. Simply reuse ReactiveReconnectionCallback", "author": "marianogonzalez", "createdAt": "2020-09-24T19:13:15Z", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -581,6 +601,45 @@ public Object getWorkOwner() {\n     }\n   }\n \n+  private class WithCompletionCallback implements RetryCallback {\n+\n+    private final CompletionCallback completionCallback;\n+    private final RetryCallback delegate;\n+\n+    WithCompletionCallback(RetryCallback delegate, CompletionCallback completionCallback) {\n+      this.delegate = delegate;\n+      this.completionCallback = completionCallback;\n+    }\n+\n+    @Override\n+    public void doWork(RetryContext context) throws Exception {\n+      try {\n+        delegate.doWork(context);\n+        this.completionCallback.success();\n+      } catch (Exception ex) {\n+        this.completionCallback.error(ex);\n+        throw ex;\n+      }\n+    }\n+\n+    @Override\n+    public String getWorkDescription() {\n+      return delegate.getWorkDescription();\n+    }\n+\n+    @Override\n+    public Object getWorkOwner() {\n+      return delegate.getWorkOwner();\n+    }\n+  }\n+\n+  private interface CompletionCallback {", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwOTk1OQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494609959", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1MjQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1MzI0Mw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494553243", "bodyText": "sleeps make this flaky. Use latches instead", "author": "marianogonzalez", "createdAt": "2020-09-24T19:14:45Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);\n+    doStart(sourceCallback);\n+  }\n+\n+  private void doStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    ReconnectableConnection connection = connectionProvider.connect();\n+    this.scheduler = schedulerService.ioScheduler();\n+\n+    if (ReconnectableConnectionProvider.otherFail) {\n+      delay(1000L);", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1Mzk4NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494553984", "bodyText": "why not simlpy addAndGet(-1) ?", "author": "marianogonzalez", "createdAt": "2020-09-24T19:16:07Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);\n+    doStart(sourceCallback);\n+  }\n+\n+  private void doStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    ReconnectableConnection connection = connectionProvider.connect();\n+    this.scheduler = schedulerService.ioScheduler();\n+\n+    if (ReconnectableConnectionProvider.otherFail) {\n+      delay(1000L);\n+      sourceCallback.onConnectionException(new ConnectionException(new RuntimeException(), connection));\n+      ReconnectableConnectionProvider.otherFail = !ReconnectableConnectionProvider.otherFail;\n+      throw new RuntimeException(\"Fail starting source\");\n+    }\n+\n+    scheduleWithFixedDelay.set(this.scheduler.scheduleWithFixedDelay(() -> {\n+      if (ReconnectableConnectionProvider.otherFail) {\n+        sourceCallback.onConnectionException(new ConnectionException(new RuntimeException(), connection));\n+      } else {\n+        sourceCallback.handle(Result.<Integer, Void>builder().output(countStartedSources.get()).build());\n+      }\n+    }, 0, 1000, MILLISECONDS));\n+  }\n+\n+  @Override\n+  public void onStop() {\n+    countStartedSources.accumulateAndGet(-1, Integer::sum);", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDAxMQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610011", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1Mzk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1Nzg0Ng==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494557846", "bodyText": "why is this in an atomic reference? I don't see the need and you're taking no value out of it", "author": "marianogonzalez", "createdAt": "2020-09-24T19:23:35Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDA5MQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610091", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1Nzg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MDAxOA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494560018", "bodyText": "= false", "author": "marianogonzalez", "createdAt": "2020-09-24T19:27:46Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);\n+    doStart(sourceCallback);\n+  }\n+\n+  private void doStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    ReconnectableConnection connection = connectionProvider.connect();\n+    this.scheduler = schedulerService.ioScheduler();\n+\n+    if (ReconnectableConnectionProvider.otherFail) {\n+      delay(1000L);\n+      sourceCallback.onConnectionException(new ConnectionException(new RuntimeException(), connection));\n+      ReconnectableConnectionProvider.otherFail = !ReconnectableConnectionProvider.otherFail;", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDIxMQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610211", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MDAxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MjA0Ng==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494562046", "bodyText": "addAndGet(1)", "author": "marianogonzalez", "createdAt": "2020-09-24T19:31:25Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDIzOQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610239", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MjA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MjkzMg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494562932", "bodyText": "pushing and capturing an integer to the flow is probalby going to lead to a flaky test. Specially since you are using a source which fails exactly once every one a day and you're forcing a sleep which happens to be the exact half of the reconnection frequency.", "author": "marianogonzalez", "createdAt": "2020-09-24T19:33:11Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private final AtomicReference<ScheduledFuture<?>> scheduleWithFixedDelay = new AtomicReference<>();\n+\n+  private Scheduler scheduler;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+\n+  @Override\n+  public void onStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    countStartedSources.accumulateAndGet(1, Integer::sum);\n+    doStart(sourceCallback);\n+  }\n+\n+  private void doStart(SourceCallback<Integer, Void> sourceCallback) throws MuleException {\n+    ReconnectableConnection connection = connectionProvider.connect();\n+    this.scheduler = schedulerService.ioScheduler();\n+\n+    if (ReconnectableConnectionProvider.otherFail) {\n+      delay(1000L);\n+      sourceCallback.onConnectionException(new ConnectionException(new RuntimeException(), connection));\n+      ReconnectableConnectionProvider.otherFail = !ReconnectableConnectionProvider.otherFail;\n+      throw new RuntimeException(\"Fail starting source\");\n+    }\n+\n+    scheduleWithFixedDelay.set(this.scheduler.scheduleWithFixedDelay(() -> {\n+      if (ReconnectableConnectionProvider.otherFail) {\n+        sourceCallback.onConnectionException(new ConnectionException(new RuntimeException(), connection));\n+      } else {\n+        sourceCallback.handle(Result.<Integer, Void>builder().output(countStartedSources.get()).build());", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MzcyNg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494563726", "bodyText": "use a more meaningful name", "author": "marianogonzalez", "createdAt": "2020-09-24T19:34:46Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/OtherReconnectionSource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import javax.inject.Inject;\n+\n+public class OtherReconnectionSource extends Source<Integer, Void> {", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDI4Ng==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610286", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MzcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2Mzg4NQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494563885", "bodyText": "use a more meaningful name", "author": "marianogonzalez", "createdAt": "2020-09-24T19:35:05Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/ReconnectableConnectionProvider.java", "diffHunk": "@@ -28,6 +28,7 @@\n public class ReconnectableConnectionProvider implements CachedConnectionProvider<ReconnectableConnection> {\n \n   public static volatile boolean fail;\n+  public static volatile boolean otherFail;", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDMwNA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610304", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2Mzg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2NDU0NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494564544", "bodyText": "this test depends greatly on ReconnectableConnectionProvider.otherFail. The initial value of that flag should be set of doSetUp()", "author": "marianogonzalez", "createdAt": "2020-09-24T19:36:27Z", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -88,6 +89,23 @@ public void reconnectSource() throws Exception {\n     });\n   }\n \n+  @Test\n+  public void doNotStartSourceTwiceAfterExceptionOnReconnection() throws Exception {\n+    ((Startable) getFlowConstruct(\"otherReconnectForever\")).start();", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMTg2Ng==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494611866", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2NDU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2NDgxMg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494564812", "bodyText": "meaninful name", "author": "marianogonzalez", "createdAt": "2020-09-24T19:36:57Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/ReconnectionOperations.java", "diffHunk": "@@ -39,6 +40,10 @@ public void switchConnection() {\n     fail = !fail;\n   }\n \n+  public void switchOtherFail() {", "originalCommit": "2451d5a87fa8f4f82f145fdda9e53c7373910461", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYxMDM4NA==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r494610384", "bodyText": "Done", "author": "gabrieldalborgo", "createdAt": "2020-09-24T21:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2NDgxMg=="}], "type": "inlineReview"}, {"oid": "e336fcf133fae4f2048dfe9d19c79140e54cb260", "url": "https://github.com/mulesoft/mule/commit/e336fcf133fae4f2048dfe9d19c79140e54cb260", "message": "Requested changes", "committedDate": "2020-09-24T22:34:25Z", "type": "commit"}, {"oid": "8050160443e71801a4c2ffb1f1d7be245e424262", "url": "https://github.com/mulesoft/mule/commit/8050160443e71801a4c2ffb1f1d7be245e424262", "message": "Update extension model & schema", "committedDate": "2020-09-28T13:55:28Z", "type": "commit"}, {"oid": "8ead0d8c135f76c567914b3c9bdee77050b24422", "url": "https://github.com/mulesoft/mule/commit/8ead0d8c135f76c567914b3c9bdee77050b24422", "message": "Remove unused imports", "committedDate": "2020-09-28T14:01:27Z", "type": "commit"}, {"oid": "546747a492f17370653d0cbab2e6769f66e737ef", "url": "https://github.com/mulesoft/mule/commit/546747a492f17370653d0cbab2e6769f66e737ef", "message": "Use sleep at source test extension", "committedDate": "2020-09-28T16:44:12Z", "type": "commit"}, {"oid": "bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "url": "https://github.com/mulesoft/mule/commit/bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "message": "Change test", "committedDate": "2020-09-29T17:29:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkyOTcyMQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496929721", "bodyText": "use constants for the values.", "author": "fsgonz", "createdAt": "2020-09-29T17:52:27Z", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -88,6 +92,16 @@ public void reconnectSource() throws Exception {\n     });\n   }\n \n+  @Test\n+  public void doNotStartSourceTwiceAfterExceptionOnReconnection() throws Exception {\n+    ((Startable) getFlowConstruct(\"reconnectAfterFailure\")).start();\n+    check(5000, 1000, () -> !capturedEvents.isEmpty());", "originalCommit": "bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkzMDA3MQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496930071", "bodyText": "use constants for the values. Is there a reason why the checknot is different from the check (5000 vs 4000?)", "author": "fsgonz", "createdAt": "2020-09-29T17:53:04Z", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -88,6 +92,16 @@ public void reconnectSource() throws Exception {\n     });\n   }\n \n+  @Test\n+  public void doNotStartSourceTwiceAfterExceptionOnReconnection() throws Exception {\n+    ((Startable) getFlowConstruct(\"reconnectAfterFailure\")).start();\n+    check(5000, 1000, () -> !capturedEvents.isEmpty());\n+    FallibleReconnectableSource.fail = true;\n+    checkNot(4000, 500, () -> FallibleReconnectableSource.simultaneouslyStartedSources);", "originalCommit": "bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk0NjA4Nw==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496946087", "bodyText": "No, there isn't. I will change it to 5000 again, so there is no confusion", "author": "gabrieldalborgo", "createdAt": "2020-09-29T18:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkzMDA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkzMDQxMg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496930412", "bodyText": "add jdoc.", "author": "fsgonz", "createdAt": "2020-09-29T17:53:40Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/FallibleReconnectableSource.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.api.util.concurrent.Latch;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.inject.Inject;\n+\n+public class FallibleReconnectableSource extends Source<Void, Void> {", "originalCommit": "bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkzNTQzMQ==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496935431", "bodyText": "Shouldn't this verify that there are two countedStartedSources simultaneously in the onStart instead of substracting in the onStop. What you need to verify is that the onStart is not executed again until the firs one ended.", "author": "fsgonz", "createdAt": "2020-09-29T18:01:58Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/FallibleReconnectableSource.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.api.util.concurrent.Latch;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.inject.Inject;\n+\n+public class FallibleReconnectableSource extends Source<Void, Void> {\n+\n+  public static volatile boolean fail = false;\n+  public static volatile boolean simultaneouslyStartedSources = false;\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private Scheduler scheduler;\n+  private ScheduledFuture<?> scheduleWithFixedDelay;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+  private static final Latch latch = new Latch();\n+\n+  @Override\n+  public void onStart(SourceCallback<Void, Void> sourceCallback) throws MuleException {\n+    if (countStartedSources.addAndGet(1) > 1) {", "originalCommit": "bc7d81bb2c4cdb433e7941e25264e4cb045d945a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29b78fb10f9edb265c674a7a9f0dff6b2648b931", "url": "https://github.com/mulesoft/mule/commit/29b78fb10f9edb265c674a7a9f0dff6b2648b931", "message": "Requested changes", "committedDate": "2020-09-29T18:21:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTU1Ng==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496955556", "bodyText": "Why make this fail again? In case you want to retry that a new reconnection triggers a new start on the source should this be a onConnectionException.", "author": "fsgonz", "createdAt": "2020-09-29T18:36:41Z", "path": "tests/test-extensions/reconnection-ext/src/main/java/org/mule/extension/test/extension/reconnection/FallibleReconnectableSource.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.extension.test.extension.reconnection;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.scheduler.Scheduler;\n+import org.mule.runtime.api.scheduler.SchedulerService;\n+import org.mule.runtime.api.util.concurrent.Latch;\n+import org.mule.runtime.extension.api.annotation.param.Connection;\n+import org.mule.runtime.extension.api.runtime.operation.Result;\n+import org.mule.runtime.extension.api.runtime.source.Source;\n+import org.mule.runtime.extension.api.runtime.source.SourceCallback;\n+\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import javax.inject.Inject;\n+\n+/**\n+ * This class represents a {@link Source} that can fail starting repeatedly and after all reconnect successfully.\n+ * Also keeps in track if multiple instances were starting at the same time.\n+ */\n+public class FallibleReconnectableSource extends Source<Void, Void> {\n+\n+  public static volatile boolean fail = false;\n+  public static volatile boolean simultaneouslyStartedSources = false;\n+\n+  @Connection\n+  ConnectionProvider<ReconnectableConnection> connectionProvider;\n+\n+  @Inject\n+  SchedulerService schedulerService;\n+\n+  private Scheduler scheduler;\n+  private ScheduledFuture<?> scheduleWithFixedDelay;\n+\n+  private static final AtomicInteger countStartedSources = new AtomicInteger(0);\n+  private static final Latch latch = new Latch();\n+\n+  @Override\n+  public void onStart(SourceCallback<Void, Void> sourceCallback) throws MuleException {\n+    if (countStartedSources.addAndGet(1) > 1) {\n+      simultaneouslyStartedSources = true;\n+    }\n+    try {\n+      doStart(sourceCallback);\n+    } finally {\n+      countStartedSources.addAndGet(-1);\n+    }\n+  }\n+\n+  private void doStart(SourceCallback<Void, Void> sourceCallback) throws MuleException {\n+    if (fail) {\n+      await();\n+      fail = false;\n+      throw new RuntimeException(\"Fail starting source\");", "originalCommit": "29b78fb10f9edb265c674a7a9f0dff6b2648b931", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1Njc4Mg==", "url": "https://github.com/mulesoft/mule/pull/9439#discussion_r496956782", "bodyText": "As per slack, this has the same effect.", "author": "fsgonz", "createdAt": "2020-09-29T18:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTU1Ng=="}], "type": "inlineReview"}]}