{"pr_number": 9231, "pr_title": "MULE-18573: CursorProvider key collision at CursorProvider cache", "pr_createdAt": "2020-08-20T14:36:13Z", "pr_url": "https://github.com/mulesoft/mule/pull/9231", "timeline": [{"oid": "226d4bd33e394323658fce8b293e655ecd2b2d7d", "url": "https://github.com/mulesoft/mule/commit/226d4bd33e394323658fce8b293e655ecd2b2d7d", "message": "Revert \"MULE-18506: [Rollback] MULE-18370: Key collision at ManagedCursorProvider cache (#8950)\"\n\nThis reverts commit 882165b82de8f81356735a14ee56fbcaadc40f1e.", "committedDate": "2020-08-21T22:13:34Z", "type": "commit"}, {"oid": "44968c2af70722c1d8d33c9534738c6ac4b3b7d3", "url": "https://github.com/mulesoft/mule/commit/44968c2af70722c1d8d33c9534738c6ac4b3b7d3", "message": "Foreach updateTypedValueForStreaming [wip]", "committedDate": "2020-08-21T22:13:34Z", "type": "commit"}, {"oid": "566c5b1a66102431eb1f3427d42bb9d3bf1952d9", "url": "https://github.com/mulesoft/mule/commit/566c5b1a66102431eb1f3427d42bb9d3bf1952d9", "message": "Add foreach testing", "committedDate": "2020-08-21T22:13:34Z", "type": "commit"}, {"oid": "f35182df750028f15ec94d660da8f61ca907f38a", "url": "https://github.com/mulesoft/mule/commit/f35182df750028f15ec94d660da8f61ca907f38a", "message": "Parallel foreach updateTypedValueForStreaming", "committedDate": "2020-08-21T22:13:34Z", "type": "commit"}, {"oid": "b63ffb7db86b0ce6ff583b2ad2a7f7fda3cda3d6", "url": "https://github.com/mulesoft/mule/commit/b63ffb7db86b0ce6ff583b2ad2a7f7fda3cda3d6", "message": "Add logging", "committedDate": "2020-08-21T22:13:34Z", "type": "commit"}, {"oid": "b63ffb7db86b0ce6ff583b2ad2a7f7fda3cda3d6", "url": "https://github.com/mulesoft/mule/commit/b63ffb7db86b0ce6ff583b2ad2a7f7fda3cda3d6", "message": "Add logging", "committedDate": "2020-08-21T22:13:34Z", "type": "forcePushed"}, {"oid": "df2115e69f7292c664ec20ea74ada7559ee5415a", "url": "https://github.com/mulesoft/mule/commit/df2115e69f7292c664ec20ea74ada7559ee5415a", "message": "remove unused method", "committedDate": "2020-08-21T22:18:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyNjMyMA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r475626320", "bodyText": "42 is a nice number", "author": "marianogonzalez", "createdAt": "2020-08-24T13:54:26Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/CursorUtilTestCase.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.sameInstance;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.mule.runtime.core.internal.streaming.CursorUtils.unwrap;\n+\n+import org.mule.runtime.api.streaming.CursorProvider;\n+import org.mule.tck.junit4.AbstractMuleTestCase;\n+\n+import org.junit.Test;\n+\n+public class CursorUtilTestCase extends AbstractMuleTestCase {\n+\n+  @Test\n+  public void unwrapNonDecoratedProvider() {\n+    CursorProvider provider = mock(CursorProvider.class);\n+    assertThat(unwrap(provider), is(sameInstance(provider)));\n+  }\n+\n+  @Test\n+  public void unwrapOneLevelDecorator() {\n+    CursorProvider provider = mock(CursorProvider.class);\n+    CursorProviderDecorator decorator = mock(CursorProviderDecorator.class);\n+    when(decorator.getDelegate()).thenReturn(provider);\n+\n+    assertThat(unwrap(decorator), is(sameInstance(provider)));\n+  }\n+\n+  @Test\n+  public void unwrap10thLevelDecorator() {\n+    CursorProvider provider = mock(CursorProvider.class);\n+    CursorProviderDecorator decorator = mock(CursorProviderDecorator.class);\n+    when(decorator.getDelegate()).thenReturn(provider);\n+\n+    for (int i = 0; i < 9; i++) {", "originalCommit": "df2115e69f7292c664ec20ea74ada7559ee5415a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzMTAzMg==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r475631032", "bodyText": "remove this, It will hurt performance. If you really need this info for troubleshooting, then take an approach similar to the one taken for tracking close() operations", "author": "marianogonzalez", "createdAt": "2020-08-24T13:58:09Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/EventStreamingState.java", "diffHunk": "@@ -32,30 +41,39 @@\n    * @return the {@link ManagedCursorProvider} that must continue to be used\n    */\n   public ManagedCursorProvider addProvider(ManagedCursorProvider provider, StreamingGhostBuster ghostBuster) {\n-    final int hash = identityHashCode(provider.getDelegate());\n-    ManagedCursorProvider managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+    final int id = provider.getId();\n+    ManagedCursorProvider managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n \n     // This can happen when a foreach component splits a text document using a stream.\n     // Iteration N might try to manage the same root provider that was already managed in iteration N-1, but the\n     // managed decorator from that previous iteration has been collected, which causes the weak reference to yield\n     // a null value. In which case we simply track it again.\n     if (managedProvider == null) {\n-      synchronized (provider.getDelegate()) {\n-        managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+      synchronized (unwrap(provider)) {\n+        managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n         if (managedProvider == null) {\n-          providers.invalidate(hash);\n-          managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+          providers.invalidate(id);\n+          managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n         }\n       }\n     }\n \n     return managedProvider;\n   }\n \n-  private ManagedCursorProvider getOrAddManagedProvider(int hash,\n+  private ManagedCursorProvider getOrAddManagedProvider(int id,\n                                                         ManagedCursorProvider provider,\n                                                         StreamingGhostBuster ghostBuster) {\n-    return providers.get(hash, k -> ghostBuster.track(provider)).get();\n+    return providers.get(id, k -> {\n+      if (LOGGER.isDebugEnabled()) {", "originalCommit": "df2115e69f7292c664ec20ea74ada7559ee5415a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzMTM5Ng==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r475631396", "bodyText": "String.format is a quite expensive operation. In this case, you're better of using the slf4j {} notation", "author": "marianogonzalez", "createdAt": "2020-08-24T13:58:28Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/EventStreamingState.java", "diffHunk": "@@ -32,30 +41,39 @@\n    * @return the {@link ManagedCursorProvider} that must continue to be used\n    */\n   public ManagedCursorProvider addProvider(ManagedCursorProvider provider, StreamingGhostBuster ghostBuster) {\n-    final int hash = identityHashCode(provider.getDelegate());\n-    ManagedCursorProvider managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+    final int id = provider.getId();\n+    ManagedCursorProvider managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n \n     // This can happen when a foreach component splits a text document using a stream.\n     // Iteration N might try to manage the same root provider that was already managed in iteration N-1, but the\n     // managed decorator from that previous iteration has been collected, which causes the weak reference to yield\n     // a null value. In which case we simply track it again.\n     if (managedProvider == null) {\n-      synchronized (provider.getDelegate()) {\n-        managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+      synchronized (unwrap(provider)) {\n+        managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n         if (managedProvider == null) {\n-          providers.invalidate(hash);\n-          managedProvider = getOrAddManagedProvider(hash, provider, ghostBuster);\n+          providers.invalidate(id);\n+          managedProvider = getOrAddManagedProvider(id, provider, ghostBuster);\n         }\n       }\n     }\n \n     return managedProvider;\n   }\n \n-  private ManagedCursorProvider getOrAddManagedProvider(int hash,\n+  private ManagedCursorProvider getOrAddManagedProvider(int id,\n                                                         ManagedCursorProvider provider,\n                                                         StreamingGhostBuster ghostBuster) {\n-    return providers.get(hash, k -> ghostBuster.track(provider)).get();\n+    return providers.get(id, k -> {\n+      if (LOGGER.isDebugEnabled()) {\n+        CursorProvider innerDelegate = unwrap(provider);\n+        Optional<ComponentLocation> originatingLocation = provider.getOriginatingLocation();\n+        LOGGER.debug(format(\"Added ManagedCursorProvider: %s for delegate: %s opened by: %s\", k, identityHashCode(innerDelegate),", "originalCommit": "df2115e69f7292c664ec20ea74ada7559ee5415a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzODE5NA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r475638194", "bodyText": "shouldn't this start with:\nif (cursorProvider instanceof IdentifiableCursorProviderDecorator) {\n  return IdentifiableCursorProviderDecorator;\n}\n\nOtherwise you will be created new decorators unnecessarily", "author": "marianogonzalez", "createdAt": "2020-08-24T14:06:07Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/IdentifiableCursorProviderDecorator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.Integer.MIN_VALUE;\n+\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+import org.mule.runtime.api.streaming.bytes.CursorStream;\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.api.streaming.object.CursorIterator;\n+import org.mule.runtime.api.streaming.object.CursorIteratorProvider;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * A decorator that turns any {@link CursorProvider} into an {@link IdentifiableCursorProvider}.\n+ * <p>\n+ * If the decoratee is already an {@link IdentifiableCursorProvider} or ({@link CursorProviderDecorator} of one), then this\n+ * decorator will yield the same id as the input identifiable provider. If this is not the case, an ID will be generaetd.\n+ * <p>\n+ * Instances are to be created through the {@link #of(CursorProvider)} factory method.\n+ *\n+ * @param <T> the generic {@link Cursor} type as defined in {@link CursorProvider}\n+ * @since 4.3.0 - 4.2.3\n+ */\n+public abstract class IdentifiableCursorProviderDecorator<T extends Cursor> extends CursorProviderDecorator<T>\n+    implements IdentifiableCursorProvider<T> {\n+\n+  private static final transient AtomicInteger ID_GENERATOR = new AtomicInteger(MIN_VALUE);\n+\n+  private final int id;\n+\n+  /**\n+   * Creates a new decorator for the given {@code cursorProvider}.\n+   * <p>\n+   * If the {@code cursorProvider} is already an {@link IdentifiableCursorProvider}, then the returned decorator will yield the\n+   * same id as the input {@code cursorProvider}. If {@code cursorProvider} is a {@link CursorProviderDecorator}, then the\n+   * {@link CursorProviderDecorator#getDelegate()} will be recursively be tested to find if any delegate in the chain is\n+   * identifiable. If such delegate is found, then the same {@code id} will be reused. Otherwise, one will be generated.\n+   *\n+   * @param cursorProvider the decoratee\n+   * @param <T>            the generic {@link Cursor} type\n+   * @return a new decorator.\n+   */\n+  public static <T extends Cursor> IdentifiableCursorProviderDecorator<T> of(CursorProvider<T> cursorProvider) {\n+    final CursorProvider<T> root = cursorProvider;", "originalCommit": "df2115e69f7292c664ec20ea74ada7559ee5415a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYzODUxNQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r475638515", "bodyText": "there's already an SP for doing this in a more global fashion. Remove this", "author": "marianogonzalez", "createdAt": "2020-08-24T14:06:40Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/StreamingGhostBuster.java", "diffHunk": "@@ -113,6 +119,13 @@ private void bustGhosts() {\n \n   private void bust(StreamingWeakReference ghost) {\n     try {\n+      if (LOGGER.isDebugEnabled()) {", "originalCommit": "df2115e69f7292c664ec20ea74ada7559ee5415a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0e695e9f4c835d61ff216c488f774df53c7746b", "url": "https://github.com/mulesoft/mule/commit/f0e695e9f4c835d61ff216c488f774df53c7746b", "message": "review + sonar", "committedDate": "2020-08-25T12:53:14Z", "type": "commit"}, {"oid": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "url": "https://github.com/mulesoft/mule/commit/db0789f87a782cc13d91f8989c5d868b804fd9b1", "message": "format", "committedDate": "2020-08-25T12:56:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY0OTM0NQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476649345", "bodyText": "flaky. Use PollingProber", "author": "marianogonzalez", "createdAt": "2020-08-25T18:21:29Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/StreamingGhostBusterTestCase.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.System.gc;\n+import static java.lang.Thread.sleep;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.nullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.initialiseIfNeeded;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.startIfNeeded;\n+import static org.mule.runtime.core.internal.streaming.IdentifiableCursorProviderDecorator.of;\n+import static org.mule.test.allure.AllureConstants.StreamingFeature.STREAMING;\n+\n+import io.qameta.allure.Feature;\n+import org.junit.Test;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.core.internal.streaming.bytes.ManagedCursorStreamProvider;\n+import org.mule.tck.junit4.AbstractMuleContextTestCase;\n+\n+import java.lang.ref.WeakReference;\n+\n+@Feature(STREAMING)\n+public class StreamingGhostBusterTestCase extends AbstractMuleContextTestCase {\n+\n+  private StreamingGhostBuster ghostBuster;\n+\n+  @Override\n+  protected void doSetUp() throws Exception {\n+    ghostBuster = new StreamingGhostBuster();\n+    initialiseIfNeeded(ghostBuster, true, muleContext);\n+    startIfNeeded(ghostBuster);\n+  }\n+\n+  @Override\n+  protected void doTearDown() throws MuleException {\n+    ghostBuster.stop();\n+    ghostBuster.dispose();\n+  }\n+\n+  @Test\n+  public void releaseResourcesWhenReferenceIsCollected() {\n+    MutableStreamingStatistics statistics = mock(MutableStreamingStatistics.class);\n+    CursorStreamProvider provider = mock(CursorStreamProvider.class);\n+    ManagedCursorStreamProvider managedCursorProvider = new ManagedCursorStreamProvider(of(provider), statistics);\n+\n+    WeakReference<ManagedCursorProvider> reference = ghostBuster.track(managedCursorProvider);\n+\n+    // Force GC collection\n+    managedCursorProvider = null;\n+    gc();\n+    assertThat(reference.get(), is(nullValue()));\n+\n+    try {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1MDIxOA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476650218", "bodyText": "weird that this is here. Doesn't this make more sense in CursorManager?", "author": "marianogonzalez", "createdAt": "2020-08-25T18:23:03Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/CursorUtils.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.Boolean.getBoolean;\n+import static org.mule.runtime.api.util.MuleSystemProperties.STREAMING_VERBOSE_PROPERTY;\n+\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+\n+/**\n+ * Utilities for handling {@link Cursor cursors}\n+ *\n+ * @since 4.3.0 - 4.2.3\n+ */\n+public final class CursorUtils {\n+\n+  private CursorUtils() {}\n+\n+  public static final boolean STREAMING_VERBOSE = getBoolean(STREAMING_VERBOSE_PROPERTY);", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTMxMA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661310", "bodyText": "@Issue", "author": "elrodro83", "createdAt": "2020-08-25T18:43:09Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/routing/ForeachTestCase.java", "diffHunk": "@@ -456,6 +461,51 @@ public void empty() throws Exception {\n     assertThat(processedEvents, hasSize(0));\n   }\n \n+  @Test", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTM5OA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661398", "bodyText": "@Issue", "author": "elrodro83", "createdAt": "2020-08-25T18:43:18Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/routing/ForeachTestCase.java", "diffHunk": "@@ -456,6 +461,51 @@ public void empty() throws Exception {\n     assertThat(processedEvents, hasSize(0));\n   }\n \n+  @Test\n+  public void muleMessageContainingACursorStreamShouldBeManagedByCursorManager() throws Exception {\n+    AtomicReference<CoreEvent> eventReference = new AtomicReference<>();\n+    foreach = createForeach();\n+    InternalTestProcessor capturedEventProcessor = event -> {\n+      eventReference.set(event);\n+      return event;\n+    };\n+    foreach.setMessageProcessors(asList(capturedEventProcessor));\n+    initialiseIfNeeded(foreach, muleContext);\n+\n+    CursorProvider cursorProvider = mock(CursorStreamProvider.class);\n+\n+    CoreEvent input = eventBuilder(muleContext).message(of(singletonList(of(cursorProvider)))).build();\n+    CoreEvent result = process(foreach, input);\n+\n+    assertThat(result.getMessage(), equalTo(input.getMessage()));\n+    assertThat(eventReference.get().getMessage().getPayload().getValue(), is(instanceOf(ManagedCursorProvider.class)));\n+    ManagedCursorProvider managedCursorProvider =\n+        (ManagedCursorProvider) eventReference.get().getMessage().getPayload().getValue();\n+    assertThat(unwrap(managedCursorProvider), is(sameInstance(cursorProvider)));\n+  }\n+\n+  @Test\n+  public void cursorStreamShouldBeManagedByCursorManager() throws Exception {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTU1MA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661550", "bodyText": "@Issue", "author": "elrodro83", "createdAt": "2020-08-25T18:43:34Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/routing/ParallelForEachTestCase.java", "diffHunk": "@@ -177,6 +182,31 @@ public void customTargetDefaultPayload() throws Exception {\n     assertThat(resultList, hasSize(2));\n   }\n \n+  @Test\n+  @Description(\"Cursor provider should be managed by cursor manager inside parallel-foreach.\")", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MTUzMA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476741530", "bodyText": "and it's missing here...", "author": "elrodro83", "createdAt": "2020-08-25T21:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTY1OA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661658", "bodyText": "allure", "author": "elrodro83", "createdAt": "2020-08-25T18:43:46Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/CursorUtilTestCase.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.sameInstance;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.mule.runtime.core.internal.streaming.CursorUtils.unwrap;\n+\n+import org.mule.runtime.api.streaming.CursorProvider;\n+import org.mule.tck.junit4.AbstractMuleTestCase;\n+\n+import org.junit.Test;\n+\n+public class CursorUtilTestCase extends AbstractMuleTestCase {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MTY1Nw==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476741657", "bodyText": "@Issue in this class tests", "author": "elrodro83", "createdAt": "2020-08-25T21:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTczMQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661731", "bodyText": "allure", "author": "elrodro83", "createdAt": "2020-08-25T18:43:55Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/IdentifiableCursorProviderDecoratorTestCase.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static org.hamcrest.CoreMatchers.instanceOf;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.sameInstance;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.withSettings;\n+import static org.mule.runtime.core.internal.streaming.CursorUtils.unwrap;\n+\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.api.streaming.object.CursorIteratorProvider;\n+import org.mule.tck.junit4.AbstractMuleTestCase;\n+\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+public class IdentifiableCursorProviderDecoratorTestCase extends AbstractMuleTestCase {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MTg5MQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476741891", "bodyText": "@Issue in the tests", "author": "elrodro83", "createdAt": "2020-08-25T21:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTg5Nw==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661897", "bodyText": "@Story", "author": "elrodro83", "createdAt": "2020-08-25T18:44:11Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/StreamingGhostBusterTestCase.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.System.gc;\n+import static java.lang.Thread.sleep;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.nullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.initialiseIfNeeded;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.startIfNeeded;\n+import static org.mule.runtime.core.internal.streaming.IdentifiableCursorProviderDecorator.of;\n+import static org.mule.test.allure.AllureConstants.StreamingFeature.STREAMING;\n+\n+import io.qameta.allure.Feature;\n+import org.junit.Test;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.core.internal.streaming.bytes.ManagedCursorStreamProvider;\n+import org.mule.tck.junit4.AbstractMuleContextTestCase;\n+\n+import java.lang.ref.WeakReference;\n+\n+@Feature(STREAMING)\n+public class StreamingGhostBusterTestCase extends AbstractMuleContextTestCase {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MTk0Mg==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476661942", "bodyText": "@Issue", "author": "elrodro83", "createdAt": "2020-08-25T18:44:16Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/streaming/StreamingGhostBusterTestCase.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.System.gc;\n+import static java.lang.Thread.sleep;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.nullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.initialiseIfNeeded;\n+import static org.mule.runtime.core.api.lifecycle.LifecycleUtils.startIfNeeded;\n+import static org.mule.runtime.core.internal.streaming.IdentifiableCursorProviderDecorator.of;\n+import static org.mule.test.allure.AllureConstants.StreamingFeature.STREAMING;\n+\n+import io.qameta.allure.Feature;\n+import org.junit.Test;\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.core.internal.streaming.bytes.ManagedCursorStreamProvider;\n+import org.mule.tck.junit4.AbstractMuleContextTestCase;\n+\n+import java.lang.ref.WeakReference;\n+\n+@Feature(STREAMING)\n+public class StreamingGhostBusterTestCase extends AbstractMuleContextTestCase {\n+\n+  private StreamingGhostBuster ghostBuster;\n+\n+  @Override\n+  protected void doSetUp() throws Exception {\n+    ghostBuster = new StreamingGhostBuster();\n+    initialiseIfNeeded(ghostBuster, true, muleContext);\n+    startIfNeeded(ghostBuster);\n+  }\n+\n+  @Override\n+  protected void doTearDown() throws MuleException {\n+    ghostBuster.stop();\n+    ghostBuster.dispose();\n+  }\n+\n+  @Test\n+  public void releaseResourcesWhenReferenceIsCollected() {", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MzAyMA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476663020", "bodyText": "4.4, 4.3.1, 4.2.3", "author": "elrodro83", "createdAt": "2020-08-25T18:46:13Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/CursorProviderDecorator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import org.mule.runtime.api.component.location.ComponentLocation;\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Base class for applying the decorator pattern over instances of a {@link CursorProvider}.\n+ * <p>\n+ * All decorators <b>MUST</b> extend this class so that the framework can leeverate the {@link #getDelegate()} method in order\n+ * to traverse the decorators chain in order to asses if certain behaviors are already applied or to reach the originally wrapped\n+ * instance.\n+ *\n+ * @param <T> the generic {@link Cursor} type as defined in {@link CursorProvider}\n+ * @since 4.3.0 - 4.2.3", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MzIyMA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476663220", "bodyText": "4.4, 4.3.1, 4.2.3", "author": "elrodro83", "createdAt": "2020-08-25T18:46:34Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/CursorUtils.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.Boolean.getBoolean;\n+import static org.mule.runtime.api.util.MuleSystemProperties.STREAMING_VERBOSE_PROPERTY;\n+\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+\n+/**\n+ * Utilities for handling {@link Cursor cursors}\n+ *\n+ * @since 4.3.0 - 4.2.3", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2MzM0MQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476663341", "bodyText": "leeverate -> leverage", "author": "elrodro83", "createdAt": "2020-08-25T18:46:48Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/CursorProviderDecorator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import org.mule.runtime.api.component.location.ComponentLocation;\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Base class for applying the decorator pattern over instances of a {@link CursorProvider}.\n+ * <p>\n+ * All decorators <b>MUST</b> extend this class so that the framework can leeverate the {@link #getDelegate()} method in order", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NzM5Mg==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476667392", "bodyText": "4.4, 4.3.1, 4.2.3", "author": "elrodro83", "createdAt": "2020-08-25T18:53:47Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/IdentifiableCursorProvider.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+\n+/**\n+ * A Cursor provider that contains an ID that can unequivocally identifies it.\n+ *\n+ * @param <T> the generic {@link Cursor} type as defined in {@link CursorProvider}\n+ * @since 4.3.0 - 4.2.3", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NzUwOQ==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476667509", "bodyText": "4.4, 4.3.1, 4.2.3", "author": "elrodro83", "createdAt": "2020-08-25T18:54:00Z", "path": "core/src/main/java/org/mule/runtime/core/internal/streaming/IdentifiableCursorProviderDecorator.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.streaming;\n+\n+import static java.lang.Integer.MIN_VALUE;\n+\n+import org.mule.runtime.api.streaming.Cursor;\n+import org.mule.runtime.api.streaming.CursorProvider;\n+import org.mule.runtime.api.streaming.bytes.CursorStream;\n+import org.mule.runtime.api.streaming.bytes.CursorStreamProvider;\n+import org.mule.runtime.api.streaming.object.CursorIterator;\n+import org.mule.runtime.api.streaming.object.CursorIteratorProvider;\n+\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * A decorator that turns any {@link CursorProvider} into an {@link IdentifiableCursorProvider}.\n+ * <p>\n+ * If the decoratee is already an {@link IdentifiableCursorProvider} or ({@link CursorProviderDecorator} of one), then this\n+ * decorator will yield the same id as the input identifiable provider. If this is not the case, an ID will be generaetd.\n+ * <p>\n+ * Instances are to be created through the {@link #of(CursorProvider)} factory method.\n+ *\n+ * @param <T> the generic {@link Cursor} type as defined in {@link CursorProvider}\n+ * @since 4.3.0 - 4.2.3", "originalCommit": "db0789f87a782cc13d91f8989c5d868b804fd9b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4927ab90c90b8312d17a7b2ef6ee4780420a626", "url": "https://github.com/mulesoft/mule/commit/c4927ab90c90b8312d17a7b2ef6ee4780420a626", "message": "more review", "committedDate": "2020-08-25T21:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc0MTQ2MA==", "url": "https://github.com/mulesoft/mule/pull/9231#discussion_r476741460", "bodyText": "this test was previous", "author": "elrodro83", "createdAt": "2020-08-25T21:14:59Z", "path": "core-tests/src/test/java/org/mule/runtime/core/internal/routing/ParallelForEachTestCase.java", "diffHunk": "@@ -128,6 +134,7 @@ public void defaultTarget() throws Exception {\n \n   @Test\n   @Description(\"When a custom target is configured the router result is set in a variable and the input event is output.\")\n+  @Issue(\"MULE-18573\")", "originalCommit": "c4927ab90c90b8312d17a7b2ef6ee4780420a626", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fa094f0e797ad71b263c90eb4747de6b68e1d04", "url": "https://github.com/mulesoft/mule/commit/9fa094f0e797ad71b263c90eb4747de6b68e1d04", "message": "more more review", "committedDate": "2020-08-25T21:39:33Z", "type": "commit"}, {"oid": "194d2b0860d4949ae671203c99616e50cb980e72", "url": "https://github.com/mulesoft/mule/commit/194d2b0860d4949ae671203c99616e50cb980e72", "message": "set @Issue at method", "committedDate": "2020-08-25T21:47:45Z", "type": "commit"}, {"oid": "a7da0d4a6842148bd9a2cee0431a18f9bf135cca", "url": "https://github.com/mulesoft/mule/commit/a7da0d4a6842148bd9a2cee0431a18f9bf135cca", "message": "one more @Issue", "committedDate": "2020-08-25T21:53:03Z", "type": "commit"}]}