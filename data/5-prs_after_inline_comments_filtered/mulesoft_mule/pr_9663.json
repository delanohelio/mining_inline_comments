{"pr_number": 9663, "pr_title": "EE-7459: Migrate ClassloadingTroubleshootingTestCase as DeploymentTestCase", "pr_createdAt": "2020-11-01T21:48:40Z", "pr_url": "https://github.com/mulesoft/mule/pull/9663", "timeline": [{"oid": "f6e383613b2ce936fd19f722e9adda41e08786ec", "url": "https://github.com/mulesoft/mule/commit/f6e383613b2ce936fd19f722e9adda41e08786ec", "message": "EE-7459: Migrate ClassloadingTroubleshootingTestCase as DeploymentTestCase", "committedDate": "2020-10-30T19:07:58Z", "type": "commit"}, {"oid": "0ea45621c8405d88c01f3660d4599d394d88054c", "url": "https://github.com/mulesoft/mule/commit/0ea45621c8405d88c01f3660d4599d394d88054c", "message": "Set domain dependency correctly", "committedDate": "2020-10-30T19:07:58Z", "type": "commit"}, {"oid": "ece93c45be31eab0ba517bc179723f3db90213e6", "url": "https://github.com/mulesoft/mule/commit/ece93c45be31eab0ba517bc179723f3db90213e6", "message": "fixes", "committedDate": "2020-10-30T19:07:59Z", "type": "commit"}, {"oid": "f30a647e1a4927ce0afc0cfead10a2efe8c1f20d", "url": "https://github.com/mulesoft/mule/commit/f30a647e1a4927ce0afc0cfead10a2efe8c1f20d", "message": "Test against lightweight classloader", "committedDate": "2020-10-30T19:07:59Z", "type": "commit"}, {"oid": "4f8285306c164d2489d96299cfa84c321bbb276e", "url": "https://github.com/mulesoft/mule/commit/4f8285306c164d2489d96299cfa84c321bbb276e", "message": "Reset logger after test", "committedDate": "2020-10-30T21:12:54Z", "type": "commit"}, {"oid": "726a62f2f160a16d13893c94cd451fe6ca9128ad", "url": "https://github.com/mulesoft/mule/commit/726a62f2f160a16d13893c94cd451fe6ca9128ad", "message": "wip", "committedDate": "2020-10-30T21:14:41Z", "type": "commit"}, {"oid": "579b74449069b9cb6cc80eacaad8636aba9a1efb", "url": "https://github.com/mulesoft/mule/commit/579b74449069b9cb6cc80eacaad8636aba9a1efb", "message": "Memory appender", "committedDate": "2020-11-01T20:40:53Z", "type": "commit"}, {"oid": "8ceefb7e34962b97b7fcb6a0c54577bf8858c325", "url": "https://github.com/mulesoft/mule/commit/8ceefb7e34962b97b7fcb6a0c54577bf8858c325", "message": "minor changes", "committedDate": "2020-11-01T21:32:37Z", "type": "commit"}, {"oid": "fad9795db676e3358116b6ae870f1bb62a9785e5", "url": "https://github.com/mulesoft/mule/commit/fad9795db676e3358116b6ae870f1bb62a9785e5", "message": "Fix tests", "committedDate": "2020-11-02T14:23:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0NTc3NA==", "url": "https://github.com/mulesoft/mule/pull/9663#discussion_r516145774", "bodyText": "this is not a classifier", "author": "elrodro83", "createdAt": "2020-11-02T17:38:47Z", "path": "modules/artifact/src/test/java/org/mule/runtime/module/artifact/builder/AbstractDependencyFileBuilder.java", "diffHunk": "@@ -210,6 +213,15 @@ public T withClassifier(String classifier) {\n     return getThis();\n   }\n \n+  /**\n+   * @param scope the maven classifier", "originalCommit": "fad9795db676e3358116b6ae870f1bb62a9785e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0NjEwNw==", "url": "https://github.com/mulesoft/mule/pull/9663#discussion_r516146107", "bodyText": "what's the point of this?", "author": "elrodro83", "createdAt": "2020-11-02T17:39:20Z", "path": "modules/deployment-model-impl/src/test/java/org/mule/runtime/module/deployment/impl/internal/builder/DeployableFileBuilder.java", "diffHunk": "@@ -221,10 +224,24 @@ private File getClassLoaderModelFile() {\n   private Artifact getArtifact(AbstractDependencyFileBuilder builder, boolean shared) {\n     ArtifactCoordinates artifactCoordinates =\n         new ArtifactCoordinates(builder.getGroupId(), builder.getArtifactId(), builder.getVersion(), builder.getType(),\n-                                builder.getClassifier());\n-    final Artifact artifact = new Artifact(artifactCoordinates, builder.getArtifactFile().toURI());\n+                                builder.getClassifier(), builder.getScope());\n+    URI uri;\n+    if (MULE_DOMAIN_CLASSIFIER.equals(builder.getClassifier())) {\n+      try {\n+        uri = new URI(\"\");\n+      } catch (URISyntaxException e) {\n+        throw new RuntimeException(e);\n+      }", "originalCommit": "fad9795db676e3358116b6ae870f1bb62a9785e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0NzY5Mw==", "url": "https://github.com/mulesoft/mule/pull/9663#discussion_r516147693", "bodyText": "why not ask for the classifier directly here?", "author": "elrodro83", "createdAt": "2020-11-02T17:42:00Z", "path": "modules/deployment-model-impl/src/test/java/org/mule/runtime/module/deployment/impl/internal/builder/DeployableFileBuilder.java", "diffHunk": "@@ -221,10 +224,24 @@ private File getClassLoaderModelFile() {\n   private Artifact getArtifact(AbstractDependencyFileBuilder builder, boolean shared) {\n     ArtifactCoordinates artifactCoordinates =\n         new ArtifactCoordinates(builder.getGroupId(), builder.getArtifactId(), builder.getVersion(), builder.getType(),\n-                                builder.getClassifier());\n-    final Artifact artifact = new Artifact(artifactCoordinates, builder.getArtifactFile().toURI());\n+                                builder.getClassifier(), builder.getScope());\n+    URI uri;\n+    if (MULE_DOMAIN_CLASSIFIER.equals(builder.getClassifier())) {\n+      try {\n+        uri = new URI(\"\");\n+      } catch (URISyntaxException e) {\n+        throw new RuntimeException(e);\n+      }\n+    } else {\n+      uri = builder.getArtifactFile().toURI();\n+    }\n+    final Artifact artifact = new Artifact(artifactCoordinates, uri);\n     // mule-maven-plugin (packager) will not include packages/resources for mule-plugin dependencies\n-    if (isSupportingPackagesResourcesInformation() && !MULE_PLUGIN_CLASSIFIER.equals(builder.getClassifier())) {\n+    boolean shouldAddPackagesAndResources = !MULE_PLUGIN_CLASSIFIER.equals(artifact.getArtifactCoordinates().getClassifier())\n+        && artifact.getUri() != null\n+        // mule-domain are set with a \"\" URI\n+        && isNotBlank(artifact.getUri().getPath());", "originalCommit": "fad9795db676e3358116b6ae870f1bb62a9785e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0ODE5NQ==", "url": "https://github.com/mulesoft/mule/pull/9663#discussion_r516148195", "bodyText": "Use java.util.Objects.requireNonNull(T, String) instead of guava", "author": "elrodro83", "createdAt": "2020-11-02T17:42:45Z", "path": "modules/deployment-model-impl/src/test/java/org/mule/runtime/module/deployment/impl/internal/builder/DomainFileBuilder.java", "diffHunk": "@@ -76,6 +85,26 @@ public String getClassifier() {\n     return MULE_DOMAIN_CLASSIFIER;\n   }\n \n+  @Override\n+  public String getScope() {\n+    return PROVIDED_SCOPE;\n+  }\n+\n+  /**\n+   * Adds a property into the plugin properties file.\n+   *\n+   * @param propertyName name fo the property to add. Non empty\n+   * @param propertyValue value of the property to add. Non null.\n+   * @return the same builder instance\n+   */\n+  public DomainFileBuilder configuredWith(String propertyName, String propertyValue) {\n+    checkImmutable();\n+    Preconditions.checkArgument(!isEmpty(propertyName), \"Property name cannot be empty\");\n+    Preconditions.checkArgument(propertyValue != null, \"Property value cannot be null\");", "originalCommit": "fad9795db676e3358116b6ae870f1bb62a9785e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0ODY5Mw==", "url": "https://github.com/mulesoft/mule/pull/9663#discussion_r516148693", "bodyText": "remove {} block (applies to code above as well)", "author": "elrodro83", "createdAt": "2020-11-02T17:43:31Z", "path": "modules/deployment-model-impl/src/test/java/org/mule/runtime/module/deployment/impl/internal/builder/DomainFileBuilder.java", "diffHunk": "@@ -142,6 +175,10 @@ private File createDomainJsonDescriptorFile(Optional<Boolean> redeploymentEnable\n     exportedResources.ifPresent(resources -> {\n       muleArtifactClassLoaderDescriptorBuilder.addProperty(EXPORTED_RESOURCES, resources.split(\",\"));\n     });\n+\n+    exportedClassPackages.ifPresent(packages -> {", "originalCommit": "fad9795db676e3358116b6ae870f1bb62a9785e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4712a35bb6bd647f920d890e3274a76a50df6fe8", "url": "https://github.com/mulesoft/mule/commit/4712a35bb6bd647f920d890e3274a76a50df6fe8", "message": "review", "committedDate": "2020-11-02T20:31:05Z", "type": "commit"}]}