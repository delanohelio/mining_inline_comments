{"pr_number": 9180, "pr_title": "MULE-18635: DslElementModel is not created consistently", "pr_createdAt": "2020-08-10T12:07:17Z", "pr_url": "https://github.com/mulesoft/mule/pull/9180", "timeline": [{"oid": "489b3092074daa9fcb90a45224ec4407618eabac", "url": "https://github.com/mulesoft/mule/commit/489b3092074daa9fcb90a45224ec4407618eabac", "message": "saving tests", "committedDate": "2020-08-07T23:12:44Z", "type": "commit"}, {"oid": "a38aa9f76703cbd04c3162f70167d59dfca43634", "url": "https://github.com/mulesoft/mule/commit/a38aa9f76703cbd04c3162f70167d59dfca43634", "message": "checkpoint!", "committedDate": "2020-08-07T23:12:45Z", "type": "commit"}, {"oid": "759031f273c02a751614031a5284c93cd5b8ad38", "url": "https://github.com/mulesoft/mule/commit/759031f273c02a751614031a5284c93cd5b8ad38", "message": "checkpoint2", "committedDate": "2020-08-07T23:12:47Z", "type": "commit"}, {"oid": "ad00c695ce9fdee78afedb3120b39767e0b0d04d", "url": "https://github.com/mulesoft/mule/commit/ad00c695ce9fdee78afedb3120b39767e0b0d04d", "message": "cleanup", "committedDate": "2020-08-07T23:12:48Z", "type": "commit"}, {"oid": "dc5999dda9333490dda448944e96eb352888d837", "url": "https://github.com/mulesoft/mule/commit/dc5999dda9333490dda448944e96eb352888d837", "message": "duplicates", "committedDate": "2020-08-07T23:12:49Z", "type": "commit"}, {"oid": "ba995fe332001b6a998d9007f14d3645e28c3966", "url": "https://github.com/mulesoft/mule/commit/ba995fe332001b6a998d9007f14d3645e28c3966", "message": "sdk tests", "committedDate": "2020-08-08T00:06:52Z", "type": "commit"}, {"oid": "23df46ed55c410ae98b5ef16e93cf41613d01b26", "url": "https://github.com/mulesoft/mule/commit/23df46ed55c410ae98b5ef16e93cf41613d01b26", "message": "fix metadata keys", "committedDate": "2020-08-08T14:45:06Z", "type": "commit"}, {"oid": "f30c66339dacb466415c6e03ea1a8d57720acd80", "url": "https://github.com/mulesoft/mule/commit/f30c66339dacb466415c6e03ea1a8d57720acd80", "message": "TODO", "committedDate": "2020-08-08T14:59:48Z", "type": "commit"}, {"oid": "f03504b19c0b68e63eec5ef44df9fa8ec27db72b", "url": "https://github.com/mulesoft/mule/commit/f03504b19c0b68e63eec5ef44df9fa8ec27db72b", "message": "javadocs", "committedDate": "2020-08-08T15:10:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNTY2NA==", "url": "https://github.com/mulesoft/mule/pull/9180#discussion_r467905664", "bodyText": "remove unused parameters elementDsl and parameterized", "author": "mlischetti", "createdAt": "2020-08-10T13:32:42Z", "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/dsl/model/ComponentAstBasedElementModelFactory.java", "diffHunk": "@@ -528,75 +410,56 @@ private void populateParameterizedElements(ParameterizedModel model, DslElementS\n         .forEach(p -> addElementParameter(innerComponents, parameters, elementDsl, builder, p));\n   }\n \n-  private void populateComposableElements(ComposableModel model, DslElementSyntax elementDsl,\n+  private void populateConnectionProviderElements(NamedObject model, DslElementSyntax elementDsl,\n+                                                  DslElementModel.Builder builder, ComponentAst configuration) {\n+    configuration.directChildrenStream()\n+        .filter(c -> c.getModel(ConnectionProviderModel.class).isPresent())\n+        .forEach(nestedComponentConfig -> create(nestedComponentConfig).ifPresent(builder::containing));\n+  }\n+\n+  private void populateComposableElements(NamedObject model, DslElementSyntax elementDsl,\n                                           DslElementModel.Builder builder, ComponentAst configuration) {\n+    final List<String> paramsAsChildrenNames = configuration.getModel(ParameterizedModel.class)\n+        .map(pmz -> pmz.getAllParameterModels()\n+            .stream()\n+            .map(pm -> hyphenize(pm.getName()))\n+            .collect(toList()))\n+        .orElse(emptyList());\n \n     configuration.directChildrenStream()\n-        .forEach(nestedComponentConfig -> {\n-          DslElementModel nestedElement = createIdentifiedElement(nestedComponentConfig);\n-          if (nestedElement != null) {\n-            builder.containing(nestedElement);\n-          } else {\n-            model.getNestedComponents()\n-                .stream()\n-                .filter(nestedModel -> nestedModel instanceof NestedRouteModel)\n-                .filter(nestedModel -> elementDsl.getContainedElement(nestedModel.getName())\n-                    .map(nestedDsl -> getIdentifier(nestedDsl).map(id -> nestedComponentConfig.getIdentifier().equals(id))\n-                        .orElse(false))\n-                    .orElse(false))\n-                .findFirst()\n-                .ifPresent(nestedModel -> {\n-                  DslElementSyntax routeDsl = elementDsl.getContainedElement(nestedModel.getName()).get();\n-                  DslElementModel.Builder<? extends NestableElementModel> routeBuilder =\n-                      DslElementModel.<NestableElementModel>builder()\n-                          .withModel(nestedModel)\n-                          .withDsl(routeDsl)\n-                          .withConfig(nestedComponentConfig)\n-                          .isExplicitInDsl(true);\n-\n-                  populateParameterizedElements((ParameterizedModel) nestedModel, routeDsl, routeBuilder, nestedComponentConfig);\n-                  nestedComponentConfig.directChildrenStream()\n-                      .forEach(routeElement -> {\n-                        DslElementModel nestableElementModel = createIdentifiedElement(routeElement);\n-                        if (nestableElementModel != null) {\n-                          routeBuilder.containing(nestableElementModel);\n-                        }\n-                      });\n-\n-                  builder.containing(routeBuilder.build());\n-                });\n-          }\n-        });\n+        // TODO MULE-17711 Remove this filter\n+        .filter(c -> !paramsAsChildrenNames.contains(c.getIdentifier().getName()))\n+        .filter(c -> !c.getModel(ConnectionProviderModel.class).isPresent())\n+        .forEach(nestedComponentConfig -> create(nestedComponentConfig).ifPresent(builder::containing));\n   }\n \n-  private void addInlineGroup(DslElementSyntax elementDsl,\n+  private void addInlineGroup(DslElementSyntax elementDsl, ComponentAst parameterized,", "originalCommit": "f03504b19c0b68e63eec5ef44df9fa8ec27db72b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNjE5NQ==", "url": "https://github.com/mulesoft/mule/pull/9180#discussion_r467906195", "bodyText": "remove unused parameters: model, elementDsl", "author": "mlischetti", "createdAt": "2020-08-10T13:33:29Z", "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/dsl/model/ComponentAstBasedElementModelFactory.java", "diffHunk": "@@ -528,75 +410,56 @@ private void populateParameterizedElements(ParameterizedModel model, DslElementS\n         .forEach(p -> addElementParameter(innerComponents, parameters, elementDsl, builder, p));\n   }\n \n-  private void populateComposableElements(ComposableModel model, DslElementSyntax elementDsl,\n+  private void populateConnectionProviderElements(NamedObject model, DslElementSyntax elementDsl,", "originalCommit": "f03504b19c0b68e63eec5ef44df9fa8ec27db72b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNzQyNQ==", "url": "https://github.com/mulesoft/mule/pull/9180#discussion_r467907425", "bodyText": "remove unused parameters: model, elementDsl", "author": "mlischetti", "createdAt": "2020-08-10T13:35:22Z", "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/dsl/model/ComponentAstBasedElementModelFactory.java", "diffHunk": "@@ -528,75 +410,56 @@ private void populateParameterizedElements(ParameterizedModel model, DslElementS\n         .forEach(p -> addElementParameter(innerComponents, parameters, elementDsl, builder, p));\n   }\n \n-  private void populateComposableElements(ComposableModel model, DslElementSyntax elementDsl,\n+  private void populateConnectionProviderElements(NamedObject model, DslElementSyntax elementDsl,\n+                                                  DslElementModel.Builder builder, ComponentAst configuration) {\n+    configuration.directChildrenStream()\n+        .filter(c -> c.getModel(ConnectionProviderModel.class).isPresent())\n+        .forEach(nestedComponentConfig -> create(nestedComponentConfig).ifPresent(builder::containing));\n+  }\n+\n+  private void populateComposableElements(NamedObject model, DslElementSyntax elementDsl,", "originalCommit": "f03504b19c0b68e63eec5ef44df9fa8ec27db72b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e33c2c4113815fdd49aea47f3f386040371ba126", "url": "https://github.com/mulesoft/mule/commit/e33c2c4113815fdd49aea47f3f386040371ba126", "message": "sonar + review", "committedDate": "2020-08-10T14:47:27Z", "type": "commit"}]}