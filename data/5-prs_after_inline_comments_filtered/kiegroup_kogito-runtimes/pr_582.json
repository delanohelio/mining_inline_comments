{"pr_number": 582, "pr_title": "KOGITO-2207 - Create process without adding to ProcessInstanceManager", "pr_createdAt": "2020-06-24T08:48:51Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/582", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444754306", "bodyText": "why is this needed? Since process instance was loaded from the storage it should not be connected at all. So how does it get into connected state here as the reconnect is few lines below?", "author": "mswiderski", "createdAt": "2020-06-24T09:09:16Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -125,6 +125,7 @@ public void internalSetProcessInstance(org.kie.api.runtime.process.ProcessInstan\n         if (this.legacyProcessInstance != null && this.status != ProcessInstance.STATE_PENDING) {\n             throw new IllegalStateException(\"Impossible to override process instance that already exists\");\n         }\n+        ((WorkflowProcessInstanceImpl) this.legacyProcessInstance).disconnect();", "originalCommit": "df02c53ed9e30d0c8cbe69c9358c11244c0d4834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2MzY2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444763662", "bodyText": "yep, I'm doing this only so that legacy process instance is removed from the DefaultProcessInstanceManager, otherwise it will keep appending more and more instances to it.", "author": "cristianonicolai", "createdAt": "2020-06-24T09:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc2NDM3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444764377", "bodyText": "why is it added there in the first place?", "author": "mswiderski", "createdAt": "2020-06-24T09:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc3MjEwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444772100", "bodyText": "This is done when unmarshalling the process: https://github.com/kiegroup/kogito-runtimes/blob/master/jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/marshalling/ProcessInstanceMarshaller.java#L102\nand https://github.com/kiegroup/kogito-runtimes/blob/master/jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java#L112", "author": "cristianonicolai", "createdAt": "2020-06-24T09:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc3NDEyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444774127", "bodyText": "in that case I'd change it there as it looks very confusing to disconnect and then reconnect.", "author": "mswiderski", "createdAt": "2020-06-24T09:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkyNTQwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444925400", "bodyText": "@mswiderski ok so trying a new approach here, so create process instance does not add it to ProcessInstanceManager. Some side effects are that now id is only generated when the process is started and not when created. Same goes for validating business key, it can only be done when starting the process now, not when creating. wdyt?", "author": "cristianonicolai", "createdAt": "2020-06-24T14:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1NDMwNg=="}], "type": "inlineReview"}, {"oid": "7a7da2bff63c04013dc1aea9a3a514c58f38e77f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/7a7da2bff63c04013dc1aea9a3a514c58f38e77f", "message": "KOGITO-2207 - Ensure previous legacy process instance is disconnect when loading process", "committedDate": "2020-06-24T14:11:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3ODAxNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r444978015", "bodyText": "why this change is needed? correlation key type is way to complex and kind of legacy too, so keeping string here and use correlation key on legacy process instance would make more sense to me, but not a huge issue I guess.", "author": "mswiderski", "createdAt": "2020-06-24T15:24:19Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -84,7 +75,7 @@\n \n     protected Integer status;\n     protected String id;\n-    protected String businessKey;\n+    protected CorrelationKey correlationKey;", "originalCommit": "7a7da2bff63c04013dc1aea9a3a514c58f38e77f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI4MTkwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r445281903", "bodyText": "@mswiderski I end up changing this because the CorrelationKey object is needed for when adding the process instance to the ProcessInstanceManager. I can revert that but then I would need to recreate this object every time the process is started. See: https://github.com/kiegroup/kogito-runtimes/pull/582/files#diff-c72f318d542b5bbf6d5de58b1b5c2f1fR163", "author": "cristianonicolai", "createdAt": "2020-06-25T03:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3ODAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY4NDk1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r447684956", "bodyText": "@cristianonicolai Just a clarification. Being this a process instance, if we want to start two process instances, then we need to first create 2 process instance objects anyway, right? That would mean that the recreation will only be needed for the second time when the process instance is started (so once it will be done in the constructor, second time in the star method). But to me it makes sense to compute this in the constructor and then reuse it in whatever method within the same object.", "author": "MarianMacik", "createdAt": "2020-06-30T13:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3ODAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc1ODU1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/582#discussion_r447758550", "bodyText": "@MarianMacik correct, we need to first create then start, so it makes sense to me to be done at the constructor level.", "author": "cristianonicolai", "createdAt": "2020-06-30T15:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3ODAxNQ=="}], "type": "inlineReview"}, {"oid": "fe853e480629a7f90ac9750f582da21a13a7298d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fe853e480629a7f90ac9750f582da21a13a7298d", "message": "KOGITO-2207 - Create process without adding to ProcessInstanceManager", "committedDate": "2020-06-25T03:55:41Z", "type": "commit"}, {"oid": "fe853e480629a7f90ac9750f582da21a13a7298d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fe853e480629a7f90ac9750f582da21a13a7298d", "message": "KOGITO-2207 - Create process without adding to ProcessInstanceManager", "committedDate": "2020-06-25T03:55:41Z", "type": "forcePushed"}]}