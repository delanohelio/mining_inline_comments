{"pr_number": 894, "pr_title": "KOGITO-3823 - Elastic monitoring addons ", "pr_createdAt": "2020-11-16T13:48:15Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/894", "timeline": [{"oid": "bc86cdcd856e0f81ca10be965d53bf774ab58b19", "url": "https://github.com/kiegroup/kogito-runtimes/commit/bc86cdcd856e0f81ca10be965d53bf774ab58b19", "message": "add elastic addons", "committedDate": "2020-12-11T09:17:11Z", "type": "commit"}, {"oid": "bc86cdcd856e0f81ca10be965d53bf774ab58b19", "url": "https://github.com/kiegroup/kogito-runtimes/commit/bc86cdcd856e0f81ca10be965d53bf774ab58b19", "message": "add elastic addons", "committedDate": "2020-12-11T09:17:11Z", "type": "forcePushed"}, {"oid": "5ef05646aa51dadad36065c23b568629a940ed3f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/5ef05646aa51dadad36065c23b568629a940ed3f", "message": "refactoring", "committedDate": "2020-12-11T09:21:04Z", "type": "commit"}, {"oid": "508e248a3d846a2f6fdbef5e4551295f7b15f0c6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/508e248a3d846a2f6fdbef5e4551295f7b15f0c6", "message": "refactoring", "committedDate": "2020-12-11T09:25:21Z", "type": "commit"}, {"oid": "755d37a0de63498581b455a18ca504b68a88efea", "url": "https://github.com/kiegroup/kogito-runtimes/commit/755d37a0de63498581b455a18ca504b68a88efea", "message": "refactoring", "committedDate": "2020-12-11T12:53:50Z", "type": "commit"}, {"oid": "a5fdb937195b12cfdfb2178229500433b7e957e4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a5fdb937195b12cfdfb2178229500433b7e957e4", "message": "fix pom", "committedDate": "2020-12-11T13:03:31Z", "type": "commit"}, {"oid": "88e55af7b7817a57e35e41a45cab1f262d7aef9e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/88e55af7b7817a57e35e41a45cab1f262d7aef9e", "message": "fix tests", "committedDate": "2020-12-14T07:43:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg4MzM2NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r541883365", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private KogitoElasticConfig kogitoElasticConfig;\n          \n          \n            \n                private final KogitoElasticConfig kogitoElasticConfig;", "author": "danielezonca", "createdAt": "2020-12-13T09:14:07Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticConfigFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.Map;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+\n+public class ElasticConfigFactory {\n+\n+    private KogitoElasticConfig kogitoElasticConfig;", "originalCommit": "a5fdb937195b12cfdfb2178229500433b7e957e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg4MzUxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r541883517", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.debug(\"Micrometer elastic publisher started.\");\n          \n          \n            \n                    logger.debug(\"Micrometer Elastic publisher started.\");", "author": "danielezonca", "createdAt": "2020-12-13T09:14:58Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticRegistry.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.concurrent.Executors;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+import io.micrometer.elastic.ElasticMeterRegistry;\n+import org.kie.kogito.monitoring.core.common.MonitoringRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ElasticRegistry {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ElasticRegistry.class);\n+    private ElasticMeterRegistry registry;\n+\n+    protected ElasticRegistry() {\n+    }\n+\n+    protected void start(ElasticConfig elasticConfig) {\n+        registry = ElasticMeterRegistry.builder(elasticConfig).build();\n+        MonitoringRegistry.addRegistry(registry);\n+        registry.start(Executors.defaultThreadFactory());\n+        logger.debug(\"Micrometer elastic publisher started.\");", "originalCommit": "a5fdb937195b12cfdfb2178229500433b7e957e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg4Mzc4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r541883780", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String prefix = ElasticConfig.DEFAULT.prefix();\n          \n          \n            \n                private Map<String, String> configMap;\n          \n          \n            \n                private final String prefix = ElasticConfig.DEFAULT.prefix();\n          \n          \n            \n                private final Map<String, String> configMap;", "author": "danielezonca", "createdAt": "2020-12-13T09:16:38Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/KogitoElasticConfig.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+\n+public class KogitoElasticConfig {\n+\n+    public static final String HOST_KEY = \"host\";\n+    public static final String INDEX_KEY = \"index\";\n+    public static final String STEP_KEY = \"step\";\n+    public static final String INDEX_DATE_FORMAT_KEY = \"indexDateFormat\";\n+    public static final String TIMESTAMP_FIELD_NAME_KEY = \"timestampFieldName\";\n+    public static final String AUTO_CREATE_INDEX_KEY = \"autoCreateIndex\";\n+    public static final String USERNAME_KEY = \"userName\";\n+    public static final String PASSWORD_KEY = \"password\";\n+    public static final String PIPELINE_KEY = \"pipeline\";\n+    public static final String INDEX_DATE_SEPARATOR_KEY = \"indexDateSeparator\";\n+    public static final String DOCUMENT_TYPE_KEY = \"documentType\";\n+\n+    private String prefix = ElasticConfig.DEFAULT.prefix();\n+    private Map<String, String> configMap;", "originalCommit": "a5fdb937195b12cfdfb2178229500433b7e957e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg4NDA0Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r541884046", "bodyText": "Usually set has no return value while with is for fluent interfaces. It is not mandatory but I think it improves the readability\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public KogitoElasticConfig setProperty(String key, String value) {\n          \n          \n            \n                public KogitoElasticConfig withProperty(String key, String value) {", "author": "danielezonca", "createdAt": "2020-12-13T09:18:17Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/KogitoElasticConfig.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+\n+public class KogitoElasticConfig {\n+\n+    public static final String HOST_KEY = \"host\";\n+    public static final String INDEX_KEY = \"index\";\n+    public static final String STEP_KEY = \"step\";\n+    public static final String INDEX_DATE_FORMAT_KEY = \"indexDateFormat\";\n+    public static final String TIMESTAMP_FIELD_NAME_KEY = \"timestampFieldName\";\n+    public static final String AUTO_CREATE_INDEX_KEY = \"autoCreateIndex\";\n+    public static final String USERNAME_KEY = \"userName\";\n+    public static final String PASSWORD_KEY = \"password\";\n+    public static final String PIPELINE_KEY = \"pipeline\";\n+    public static final String INDEX_DATE_SEPARATOR_KEY = \"indexDateSeparator\";\n+    public static final String DOCUMENT_TYPE_KEY = \"documentType\";\n+\n+    private String prefix = ElasticConfig.DEFAULT.prefix();\n+    private Map<String, String> configMap;\n+\n+    public KogitoElasticConfig() {\n+        this.configMap = new HashMap<>();\n+    }\n+\n+    public KogitoElasticConfig setProperty(String key, String value) {", "originalCommit": "a5fdb937195b12cfdfb2178229500433b7e957e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMTk3NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542301974", "bodyText": "I think this is not necessary because you are already observing StartupEvent in config method", "author": "danielezonca", "createdAt": "2020-12-14T11:10:43Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-quarkus-addon/src/main/java/org/kie/kogito/monitoring/elastic/quarkus/QuarkusElasticRegistryProvider.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.quarkus;\n+\n+import java.util.Optional;\n+\n+import javax.enterprise.event.Observes;\n+import javax.inject.Singleton;\n+\n+import io.quarkus.arc.config.ConfigProperties;\n+import io.quarkus.runtime.Startup;\n+import io.quarkus.runtime.StartupEvent;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+import org.kie.kogito.monitoring.elastic.common.ElasticConfigFactory;\n+import org.kie.kogito.monitoring.elastic.common.ElasticRegistry;\n+import org.kie.kogito.monitoring.elastic.common.KogitoElasticConfig;\n+\n+@Singleton\n+@Startup", "originalCommit": "88e55af7b7817a57e35e41a45cab1f262d7aef9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNTIwNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542305207", "bodyText": "I'm not sure Executors.defaultThreadFactory() is ideal with managed environment like Quarkus/Springboot. Can you please verify if there is a documented better option to obtain a ThreadFactory in similar environments?\nIn any case, please create an overloaded method to provide the instance\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void start(ElasticConfig elasticConfig) {\n          \n          \n            \n                    registry = ElasticMeterRegistry.builder(elasticConfig).build();\n          \n          \n            \n                    MonitoringRegistry.addRegistry(registry);\n          \n          \n            \n                    registry.start(Executors.defaultThreadFactory());\n          \n          \n            \n                    logger.debug(\"Micrometer elastic publisher started.\");\n          \n          \n            \n                }\n          \n          \n            \n                protected void start(ElasticConfig elasticConfig) {\n          \n          \n            \n                    start(elasticConfig, Executors.defaultThreadFactory());\n          \n          \n            \n                }    \n          \n          \n            \n                \n          \n          \n            \n                protected void start(ElasticConfig elasticConfig, ThreadFactory threadFactory) {\n          \n          \n            \n                    registry = ElasticMeterRegistry.builder(elasticConfig).build();\n          \n          \n            \n                    MonitoringRegistry.addRegistry(registry);\n          \n          \n            \n                    registry.start(threadFactory);\n          \n          \n            \n                    logger.debug(\"Micrometer elastic publisher started.\");\n          \n          \n            \n                }", "author": "danielezonca", "createdAt": "2020-12-14T11:16:09Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticRegistry.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.concurrent.Executors;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+import io.micrometer.elastic.ElasticMeterRegistry;\n+import org.kie.kogito.monitoring.core.common.MonitoringRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ElasticRegistry {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ElasticRegistry.class);\n+    private ElasticMeterRegistry registry;\n+\n+    protected ElasticRegistry() {\n+    }\n+\n+    protected void start(ElasticConfig elasticConfig) {\n+        registry = ElasticMeterRegistry.builder(elasticConfig).build();\n+        MonitoringRegistry.addRegistry(registry);\n+        registry.start(Executors.defaultThreadFactory());\n+        logger.debug(\"Micrometer elastic publisher started.\");\n+    }", "originalCommit": "88e55af7b7817a57e35e41a45cab1f262d7aef9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQyMDAzMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542420032", "bodyText": "Hi @danielezonca , I've refactored it: for Springboot I used https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.html, but for quarkus I did not find a (clean) way to inject a ThreadFactory. I use Executors.defaultThreadFactory() for it for the time being", "author": "r00ta", "createdAt": "2020-12-14T14:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNTIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3MDYyOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r547970628", "bodyText": "See quarkusio/quarkus#13874", "author": "r00ta", "createdAt": "2020-12-23T13:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNTIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODAzMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542308032", "bodyText": "Two comments:\n\nnull is already the default return value of get (javadoc) so don't need getOrDefault\nDo you expect this to happen?", "author": "danielezonca", "createdAt": "2020-12-14T11:20:46Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticConfigFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.Map;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+\n+public class ElasticConfigFactory {\n+\n+    private KogitoElasticConfig kogitoElasticConfig;\n+\n+    public ElasticConfigFactory() {\n+        this.kogitoElasticConfig = new KogitoElasticConfig();\n+    }\n+\n+    public ElasticConfigFactory setProperty(String key, String value) {\n+        this.kogitoElasticConfig.setProperty(key, value);\n+        return this;\n+    }\n+\n+    public ElasticConfig getElasticConfig() {\n+        Map<String, String> configMap = kogitoElasticConfig.getConfigMap();\n+        return s -> configMap.getOrDefault(s, null);", "originalCommit": "88e55af7b7817a57e35e41a45cab1f262d7aef9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQyNTA1Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542425057", "bodyText": "Yep, this is due to the micrometer contract: https://github.com/micrometer-metrics/micrometer/blob/37360582d35947fbc4c7479886ce6ebbe6a8086a/implementations/micrometer-registry-elastic/src/main/java/io/micrometer/elastic/ElasticConfig.java#L40 .\nThe default config map returns always null so that the default values are used. For example you can see in the Springboot impl that the default value is null\n    @Value(value = \"${kogito.addon.monitoring.elastic.indexDateFormat:#{null}}\")", "author": "r00ta", "createdAt": "2020-12-14T14:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQyNTM1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r542425352", "bodyText": "Changed to get by the way \ud83d\udc4d", "author": "r00ta", "createdAt": "2020-12-14T14:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODAzMg=="}], "type": "inlineReview"}, {"oid": "09a79856ebb4dbd692ce57a0f3a4e963208e18d2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/09a79856ebb4dbd692ce57a0f3a4e963208e18d2", "message": "Update addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticConfigFactory.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-12-14T12:11:09Z", "type": "commit"}, {"oid": "581ff939220593760ef9ee90218e45b683ba6d81", "url": "https://github.com/kiegroup/kogito-runtimes/commit/581ff939220593760ef9ee90218e45b683ba6d81", "message": "Update addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/ElasticRegistry.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-12-14T12:11:18Z", "type": "commit"}, {"oid": "2ee40a740abb4bfff7c10428362bcf9251121dc5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2ee40a740abb4bfff7c10428362bcf9251121dc5", "message": "Update addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/KogitoElasticConfig.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-12-14T12:11:29Z", "type": "commit"}, {"oid": "4fcaa2481983f677948fe4f134566856c43d8554", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4fcaa2481983f677948fe4f134566856c43d8554", "message": "Update addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/main/java/org/kie/kogito/monitoring/elastic/common/KogitoElasticConfig.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-12-14T12:11:40Z", "type": "commit"}, {"oid": "f92095707aeb5b1a563fbaf03a4e450bef0e8a4b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f92095707aeb5b1a563fbaf03a4e450bef0e8a4b", "message": "refactoring", "committedDate": "2020-12-14T13:39:52Z", "type": "commit"}, {"oid": "1b64ca3a9933d310621d7351635f395c0418cdd6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1b64ca3a9933d310621d7351635f395c0418cdd6", "message": "use springboot thread pool", "committedDate": "2020-12-14T14:19:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzMzI2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r546833268", "bodyText": "No need to call super here, but up to you.", "author": "MarianMacik", "createdAt": "2020-12-21T17:26:24Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-quarkus-addon/src/main/java/org/kie/kogito/monitoring/elastic/quarkus/QuarkusElasticRegistryProvider.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.quarkus;\n+\n+import java.util.Optional;\n+\n+import javax.enterprise.event.Observes;\n+import javax.inject.Singleton;\n+\n+import io.quarkus.runtime.StartupEvent;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+import org.kie.kogito.monitoring.elastic.common.ElasticConfigFactory;\n+import org.kie.kogito.monitoring.elastic.common.ElasticRegistry;\n+import org.kie.kogito.monitoring.elastic.common.KogitoElasticConfig;\n+\n+@Singleton\n+public class QuarkusElasticRegistryProvider extends ElasticRegistry {\n+\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.host\")\n+    public Optional<String> elasticHost;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.index\")\n+    public Optional<String> index;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.step\")\n+    public Optional<String> step;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.indexDateFormat\")\n+    public Optional<String> indexDateFormat;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.timestampFieldName\")\n+    public Optional<String> timestampFieldName;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.autoCreateIndex\")\n+    public Optional<String> autoCreateIndex;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.userName\")\n+    public Optional<String> userName;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.password\")\n+    public Optional<String> password;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.pipeline\")\n+    public Optional<String> pipeline;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.indexDateSeparator\")\n+    public Optional<String> indexDateSeparator;\n+    @ConfigProperty(name = \"kogito.addon.monitoring.elastic.documentType\")\n+    public Optional<String> documentType;\n+\n+    public void config(@Observes StartupEvent event) {\n+        ElasticConfigFactory elasticConfigFactory = new ElasticConfigFactory();\n+        elasticHost.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.HOST_KEY, x));\n+        index.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_KEY, x));\n+        step.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.STEP_KEY, x));\n+        indexDateFormat.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_DATE_FORMAT_KEY, x));\n+        timestampFieldName.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.TIMESTAMP_FIELD_NAME_KEY, x));\n+        autoCreateIndex.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.AUTO_CREATE_INDEX_KEY, x));\n+        userName.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.USERNAME_KEY, x));\n+        password.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.PASSWORD_KEY, x));\n+        pipeline.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.PIPELINE_KEY, x));\n+        indexDateSeparator.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_DATE_SEPARATOR_KEY, x));\n+        documentType.ifPresent(x -> elasticConfigFactory.withProperty(KogitoElasticConfig.DOCUMENT_TYPE_KEY, x));\n+        super.start(elasticConfigFactory.getElasticConfig());", "originalCommit": "1b64ca3a9933d310621d7351635f395c0418cdd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk2NTU4OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r547965588", "bodyText": "\ud83d\udc4d  I'd keep it if it's ok for you", "author": "r00ta", "createdAt": "2020-12-23T13:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzMzI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzMzYwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r546833601", "bodyText": "Same here.", "author": "MarianMacik", "createdAt": "2020-12-21T17:26:56Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-springboot-addon/src/main/java/org/kie/kogito/monitoring/elastic/springboot/SpringbootElasticRegistryProvider.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.springboot;\n+\n+import javax.annotation.PostConstruct;\n+\n+import org.kie.kogito.monitoring.elastic.common.ElasticConfigFactory;\n+import org.kie.kogito.monitoring.elastic.common.ElasticRegistry;\n+import org.kie.kogito.monitoring.elastic.common.KogitoElasticConfig;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class SpringbootElasticRegistryProvider extends ElasticRegistry {\n+\n+    @Value(value = \"${kogito.addon.monitoring.elastic.host:#{null}}\")\n+    public String elasticHost;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.index:#{null}}\")\n+    public String index;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.step:#{null}}\")\n+    public String step;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.indexDateFormat:#{null}}\")\n+    public String indexDateFormat;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.timestampFieldName:#{null}}\")\n+    public String timestampFieldName;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.autoCreateIndex:#{null}}\")\n+    public String autoCreateIndex;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.userName:#{null}}\")\n+    public String userName;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.password:#{null}}\")\n+    public String password;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.pipeline:#{null}}\")\n+    public String pipeline;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.indexDateSeparator:#{null}}\")\n+    public String indexDateSeparator;\n+    @Value(value = \"${kogito.addon.monitoring.elastic.documentType:#{null}}\")\n+    public String documentType;\n+\n+    @Autowired\n+    ThreadPoolTaskExecutor executor;\n+\n+    @PostConstruct\n+    protected void onStart() {\n+        ElasticConfigFactory elasticConfigFactory = new ElasticConfigFactory();\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.HOST_KEY, elasticHost);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_KEY, index);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.STEP_KEY, step);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_DATE_FORMAT_KEY, indexDateFormat);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.TIMESTAMP_FIELD_NAME_KEY, timestampFieldName);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.AUTO_CREATE_INDEX_KEY, autoCreateIndex);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.USERNAME_KEY, userName);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.PASSWORD_KEY, password);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.PIPELINE_KEY, pipeline);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.INDEX_DATE_SEPARATOR_KEY, indexDateSeparator);\n+        elasticConfigFactory.withProperty(KogitoElasticConfig.DOCUMENT_TYPE_KEY, documentType);\n+        super.start(elasticConfigFactory.getElasticConfig(), executor);", "originalCommit": "1b64ca3a9933d310621d7351635f395c0418cdd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk2NTYyMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r547965622", "bodyText": "\ud83d\udc4d  I'd keep it if it's ok for you", "author": "r00ta", "createdAt": "2020-12-23T13:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzMzYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzNzE1OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r546837159", "bodyText": "I think here you can just return countDownLatchMap.computeIfPresent(...) as it directly returns the value associated with the key after the remapping function is called or null if the value is not there or the remapping function returned null, so it was removed.", "author": "MarianMacik", "createdAt": "2020-12-21T17:34:20Z", "path": "addons/monitoring/monitoring-elastic/monitoring-elastic-common/src/test/java/org/kie/kogito/monitoring/elastic/common/ElasticRegistryTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.elastic.common;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import io.micrometer.elastic.ElasticConfig;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+public class ElasticRegistryTest {\n+\n+    @Test\n+    public void testElasticMicrometerIsUsingOurProperties() throws InterruptedException {\n+        ElasticRegistry elasticRegistry = new ElasticRegistry();\n+\n+        KogitoElasticConfig kogitoElasticConfig = new KogitoElasticConfig();\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.HOST_KEY, \"http://mylocalhost:8080\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.INDEX_KEY, \"myIndex\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.STEP_KEY, \"1s\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.TIMESTAMP_FIELD_NAME_KEY, \"myTimestampName\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.USERNAME_KEY, \"pippo\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.PASSWORD_KEY, \"pluto\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.PIPELINE_KEY, \"mypipe\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.INDEX_DATE_SEPARATOR_KEY, \"/\");\n+        kogitoElasticConfig.withProperty(KogitoElasticConfig.DOCUMENT_TYPE_KEY, \"doc\");\n+\n+        Map<String, String> configMap = kogitoElasticConfig.getConfigMap();\n+        Map<String, CountDownLatch> countDownLatchMap = new HashMap<>();\n+        configMap.keySet().forEach(x -> countDownLatchMap.put(x, new CountDownLatch(1)));\n+\n+        ElasticConfig elasticConfig = s -> {\n+            countDownLatchMap.computeIfPresent(s, (k, v) -> {\n+                v.countDown();\n+                return v;\n+            });\n+            return configMap.getOrDefault(s, null);\n+        };", "originalCommit": "1b64ca3a9933d310621d7351635f395c0418cdd6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk2OTgyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r547969829", "bodyText": "Hi @MarianMacik , configMap contains the key-value configuration pairs and countDownLatchMap maps the key to a CountDownLatch. countDownLatchMap.computeIfPresent(...) returns a CountDownLatch and atm the config values have to be fetched from the configMap after the latch is decremented.\nLet me know if we can move forward with the current implementation!", "author": "r00ta", "createdAt": "2020-12-23T13:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzNzE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQzNjgwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/894#discussion_r551436804", "bodyText": "Hi, I overlooked that these are 2 different maps, sorry for that. It is fine to move forward with this.", "author": "MarianMacik", "createdAt": "2021-01-04T16:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzNzE1OQ=="}], "type": "inlineReview"}, {"oid": "16dc3259be3cd2bea3afe3b9f516d95b11743143", "url": "https://github.com/kiegroup/kogito-runtimes/commit/16dc3259be3cd2bea3afe3b9f516d95b11743143", "message": "remove beans file from elastic spring addon, add kogito.addon to elastic modules", "committedDate": "2021-01-04T09:00:26Z", "type": "commit"}]}