{"pr_number": 859, "pr_title": "KOGITO-3732 - monitoring refactoring: decouple from Prometheus", "pr_createdAt": "2020-10-29T09:51:10Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/859", "timeline": [{"oid": "86a25e4de7a11f32e6994e6fb335ddd385bdf32e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/86a25e4de7a11f32e6994e6fb335ddd385bdf32e", "message": "use micrometer library", "committedDate": "2020-10-29T07:04:58Z", "type": "commit"}, {"oid": "095333e7718d9c056b4fe28f8f8514d030e29383", "url": "https://github.com/kiegroup/kogito-runtimes/commit/095333e7718d9c056b4fe28f8f8514d030e29383", "message": "move prometheus addon into monitoring addons module", "committedDate": "2020-10-29T07:06:29Z", "type": "commit"}, {"oid": "903bd53a52a8975361c8f40a799c7ce64c2263b0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/903bd53a52a8975361c8f40a799c7ce64c2263b0", "message": "refactoring: move to monitoring core decoupled monitoring resources", "committedDate": "2020-10-29T07:26:31Z", "type": "commit"}, {"oid": "9eaf9f073e4bce6fa574dc24e12adba536049537", "url": "https://github.com/kiegroup/kogito-runtimes/commit/9eaf9f073e4bce6fa574dc24e12adba536049537", "message": "move test files to core module", "committedDate": "2020-10-29T07:43:41Z", "type": "commit"}, {"oid": "d37ad37a024e598055693c9653064c3d896873c0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d37ad37a024e598055693c9653064c3d896873c0", "message": "refactoring tests", "committedDate": "2020-10-29T09:38:09Z", "type": "commit"}, {"oid": "61e5dcbcda9bdef91dafa92621bc2c357d56e7bc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/61e5dcbcda9bdef91dafa92621bc2c357d56e7bc", "message": "implement backcompability", "committedDate": "2020-10-29T09:45:56Z", "type": "commit"}, {"oid": "a3b5278ad3c3d14c121ea981400671558938eae5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a3b5278ad3c3d14c121ea981400671558938eae5", "message": "refactoring on kogito codegen so to use the new core module", "committedDate": "2020-10-29T09:50:12Z", "type": "commit"}, {"oid": "11fda1719dd166072276a166eff61ee0ce2c297f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/11fda1719dd166072276a166eff61ee0ce2c297f", "message": "remove file", "committedDate": "2020-10-29T09:52:03Z", "type": "commit"}, {"oid": "a1560a0b0c53e973ebd8c1cde587c805d0898532", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a1560a0b0c53e973ebd8c1cde587c805d0898532", "message": "refactoring dashboards generation", "committedDate": "2020-11-04T09:47:10Z", "type": "commit"}, {"oid": "75b8fc8104ae25c4f119d0113b68acdcb9c140ca", "url": "https://github.com/kiegroup/kogito-runtimes/commit/75b8fc8104ae25c4f119d0113b68acdcb9c140ca", "message": "refactoring dmnresult test", "committedDate": "2020-11-04T14:00:54Z", "type": "commit"}, {"oid": "84e05be90a3815afb780f661d72b267570736a09", "url": "https://github.com/kiegroup/kogito-runtimes/commit/84e05be90a3815afb780f661d72b267570736a09", "message": "add prometheus test", "committedDate": "2020-11-04T14:13:21Z", "type": "commit"}, {"oid": "ff1d6c16cc672d3351b3ccac62e8155e37e52db1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ff1d6c16cc672d3351b3ccac62e8155e37e52db1", "message": "refactoring kogito codegen to work with the two monitoring modules", "committedDate": "2020-11-05T09:26:26Z", "type": "commit"}, {"oid": "e3329ec1f4fb49012057766b24a6d827ae3b5d65", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e3329ec1f4fb49012057766b24a6d827ae3b5d65", "message": "remove file", "committedDate": "2020-11-10T07:57:15Z", "type": "commit"}, {"oid": "cde3bcf05d22a32fd1f5c18675cd12f450492334", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cde3bcf05d22a32fd1f5c18675cd12f450492334", "message": "Merge branch 'master' into KOGITO-3732-monitoring-refactoring", "committedDate": "2020-11-10T08:01:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM2MjgzMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520362831", "bodyText": "Micrometer supports dynamic labels (i.e. we see a new process_id every time and a new measurement is created every time ), but it's somehow hidden by the api: we have to create the object every time and if a Counter with the same name and tags already exists, then the existing one is returned (see micrometer-metrics/micrometer#535 (comment)) .", "author": "r00ta", "createdAt": "2020-11-10T08:08:03Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/process/ProcessEventListener.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.core.process;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.Tag;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.jbpm.workflow.instance.node.WorkItemNodeInstance;\n+import org.kie.api.event.process.DefaultProcessEventListener;\n+import org.kie.api.event.process.ProcessCompletedEvent;\n+import org.kie.api.event.process.ProcessNodeLeftEvent;\n+import org.kie.api.event.process.ProcessStartedEvent;\n+import org.kie.api.event.process.SLAViolatedEvent;\n+import org.kie.api.runtime.process.NodeInstance;\n+import org.kie.kogito.monitoring.core.MonitoringRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ProcessEventListener extends DefaultProcessEventListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ProcessEventListener.class);\n+    private static Map<String, AtomicInteger> gaugeMap = new HashMap<String, AtomicInteger>();\n+    private String identifier;\n+\n+    public ProcessEventListener(String identifier) {\n+        this.identifier = identifier;\n+    }\n+\n+    private static Counter getNumberOfProcessInstancesStartedCounter(String appId, String processId) {", "originalCommit": "cde3bcf05d22a32fd1f5c18675cd12f450492334", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "45e965e1bd9089bfc09ad456a82ef65d0685e1b4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/45e965e1bd9089bfc09ad456a82ef65d0685e1b4", "message": "add test on process gauge", "committedDate": "2020-11-10T08:48:06Z", "type": "commit"}, {"oid": "b0015594e1913a1558ae4536ae7444771c002d79", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b0015594e1913a1558ae4536ae7444771c002d79", "message": "fix pom", "committedDate": "2020-11-10T09:04:11Z", "type": "commit"}, {"oid": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/41c3ecbafce011c4dd3ceba67826dac0a48e199d", "message": "fix monitoring core pom", "committedDate": "2020-11-10T09:07:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMDgxOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520400818", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:10:08Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/process/ProcessEventListener.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTE1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520401150", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:10:38Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/rule/RuleMetrics.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTI3OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520401278", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:10:49Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/system/metrics/SystemMetricsCollector.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTQwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520401401", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:11:00Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/system/metrics/dmnhandlers/BooleanHandler.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTYwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520401603", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:11:18Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/system/metrics/dmnhandlers/StringHandler.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwMTcxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r520401713", "bodyText": "This file is not new..", "author": "r00ta", "createdAt": "2020-11-10T09:11:29Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/system/metrics/dmnhandlers/TypeHandlerWithSummary.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*", "originalCommit": "41c3ecbafce011c4dd3ceba67826dac0a48e199d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "426bf4091613e122a89cdd9b215688079f17a9c9", "url": "https://github.com/kiegroup/kogito-runtimes/commit/426bf4091613e122a89cdd9b215688079f17a9c9", "message": "fix pom", "committedDate": "2020-11-10T09:22:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAyOTU5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r521029598", "bodyText": "@r00ta could you avoid this inline add for the creation of the list? I would suggest maybe using Arrays.asList instead.", "author": "cristianonicolai", "createdAt": "2020-11-11T02:19:47Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/process/ProcessEventListener.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.core.process;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.Tag;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.jbpm.workflow.instance.node.WorkItemNodeInstance;\n+import org.kie.api.event.process.DefaultProcessEventListener;\n+import org.kie.api.event.process.ProcessCompletedEvent;\n+import org.kie.api.event.process.ProcessNodeLeftEvent;\n+import org.kie.api.event.process.ProcessStartedEvent;\n+import org.kie.api.event.process.SLAViolatedEvent;\n+import org.kie.api.runtime.process.NodeInstance;\n+import org.kie.kogito.monitoring.core.MonitoringRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ProcessEventListener extends DefaultProcessEventListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ProcessEventListener.class);\n+    private static Map<String, AtomicInteger> gaugeMap = new HashMap<String, AtomicInteger>();\n+    private String identifier;\n+\n+    public ProcessEventListener(String identifier) {\n+        this.identifier = identifier;\n+    }\n+\n+    private static Counter getNumberOfProcessInstancesStartedCounter(String appId, String processId) {\n+        List<Tag> tags = new ArrayList<Tag>() {", "originalCommit": "426bf4091613e122a89cdd9b215688079f17a9c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4bb0aa5d471462872b0d11d0200b9ce77f41315", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d4bb0aa5d471462872b0d11d0200b9ce77f41315", "message": "rebase master", "committedDate": "2020-11-11T07:54:10Z", "type": "commit"}, {"oid": "9d660804ae750cdb288744a03dae3806869f919c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/9d660804ae750cdb288744a03dae3806869f919c", "message": "refactoring tag array creation", "committedDate": "2020-11-11T08:05:26Z", "type": "commit"}, {"oid": "a31cc5f226da469b0cb14d3c44ef3a3ee1334c1c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a31cc5f226da469b0cb14d3c44ef3a3ee1334c1c", "message": "remove .gitignore nested file", "committedDate": "2020-11-11T08:06:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4MDIzNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r522180236", "bodyText": "Why this change?", "author": "danielezonca", "createdAt": "2020-11-12T15:11:43Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java", "diffHunk": "@@ -236,7 +236,8 @@ private ApplicationGenerator createApplicationGenerator() throws IOException, Mo\n         }\n \n         boolean usePersistence = persistence || hasClassOnClasspath(project, \"org.kie.kogito.persistence.KogitoProcessInstancesFactory\");\n-        boolean useMonitoring = hasClassOnClasspath(project, \"org.kie.kogito.monitoring.rest.MetricsResource\");\n+        boolean useMonitoring = hasClassOnClasspath(project, \"org.kie.kogito.monitoring.rest.MetricsResource\") ||\n+                hasClassOnClasspath(project, \"org.kie.kogito.monitoring.core.MonitoringRegistry\");", "originalCommit": "a31cc5f226da469b0cb14d3c44ef3a3ee1334c1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0Nzc4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r522447783", "bodyText": "Hi @danielezonca , now the user has two options:\n\nUse the monitoring-prometheus-addon\nUse the monitoring-core addon so to plug another micrometer meter registry\n\nWe'd like to enable the monitoring if any of these modules are used by the user, that's why we do this change.", "author": "r00ta", "createdAt": "2020-11-12T21:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4MDIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1MzYyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r522453626", "bodyText": "I've just realized that the other important topic is that currently the queries in the grafana dashboards we generate are prometheus specific, so I think we should generate them only of the prometheus addon is enabled.\nI'll implement this change tomorrow.\nExtending the generation to grafana dashboards specific for each type of data source needs a quite big refactoring, and it's something that we have to discuss in case we want to go into that direction.", "author": "r00ta", "createdAt": "2020-11-12T22:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4MDIzNg=="}], "type": "inlineReview"}, {"oid": "456ecd2c2db43475ada1c0168860f3e82fd0b1b6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/456ecd2c2db43475ada1c0168860f3e82fd0b1b6", "message": "generate grafana dashboards only if using prometheus addon", "committedDate": "2020-11-13T08:15:51Z", "type": "commit"}, {"oid": "0acb83c8aa56b12c43ee6494fc5e60cce09f3c85", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0acb83c8aa56b12c43ee6494fc5e60cce09f3c85", "message": "fix monitoring core package name", "committedDate": "2020-11-13T09:12:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMjY3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r522822677", "bodyText": "Let's name it withDashboardGeneration or similar, the fact that now we generate dashboards only if Prometheus is available is an impl detail", "author": "danielezonca", "createdAt": "2020-11-13T09:17:34Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/AddonsConfig.java", "diffHunk": "@@ -21,12 +21,14 @@\n             .withPersistence(false)\n             .withTracing(false)\n             .withMonitoring(false)\n+            .withPrometheusMonitoring(false)", "originalCommit": "0acb83c8aa56b12c43ee6494fc5e60cce09f3c85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg2MTY3OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r522861679", "bodyText": "I think it can be a bit misleading since we turn on this option if the prometheus module is included in the classpath. Unless we change how we activate this option (with a property.. or something else), I think we should keep it like this (and change it in the future if we will generate grafana dashboards for other data sources)", "author": "r00ta", "createdAt": "2020-11-13T10:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMjY3Nw=="}], "type": "inlineReview"}, {"oid": "cd3e3d723748f14a33fbb201ad1448570a9fa788", "url": "https://github.com/kiegroup/kogito-runtimes/commit/cd3e3d723748f14a33fbb201ad1448570a9fa788", "message": "fix native compatibility", "committedDate": "2020-11-13T14:48:50Z", "type": "commit"}, {"oid": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "url": "https://github.com/kiegroup/kogito-runtimes/commit/07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "message": "Merge branch 'master' into KOGITO-3732-monitoring-refactoring", "committedDate": "2020-11-20T10:46:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxNjY4OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r529416689", "bodyText": "Why not to name it just RuleMetricListener. Because right now we have both Rule and Drools in the name, seems unnecessary.", "author": "MarianMacik", "createdAt": "2020-11-24T10:26:20Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/rule/RuleMetricsDroolsListener.java", "diffHunk": "@@ -25,12 +23,12 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-public class PrometheusMetricsDroolsListener extends DefaultAgendaEventListener {\n+public class RuleMetricsDroolsListener extends DefaultAgendaEventListener {", "originalCommit": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2NzU5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r529467593", "bodyText": "Expected value no longer used.", "author": "MarianMacik", "createdAt": "2020-11-24T11:17:02Z", "path": "addons/monitoring-addon/monitoring-core/src/test/java/org/kie/kogito/monitoring/core/integration/DaysAndTimeDurationHandlerTest.java", "diffHunk": "@@ -44,14 +45,12 @@ public void givenDurationMetricsWhenMetricsAreStoredThenTheQuantilesAreCorrect()\n         // Arrange\n         Integer expectedValue = 10000;\n         Duration duration = Duration.ofMillis(expectedValue);", "originalCommit": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2ODIzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r529468234", "bodyText": "Same here, the old expected values are not used.", "author": "MarianMacik", "createdAt": "2020-11-24T11:18:09Z", "path": "addons/monitoring-addon/monitoring-core/src/test/java/org/kie/kogito/monitoring/core/integration/LocalDateHandlerTest.java", "diffHunk": "@@ -50,9 +50,9 @@ public void givenLocalDateMetricsWhenMetricsAreStoredThenTheQuantilesAreCorrect(\n         // Act\n         handler.record(\"decision\", ENDPOINT_NAME, now);\n \n+\n         // Assert\n-        for (Double key : quantiles) {\n-            assertEquals(expectedValue, getQuantile(\"decision\", ENDPOINT_NAME + DecisionConstants.DECISIONS_NAME_SUFFIX, ENDPOINT_NAME, key), 5);", "originalCommit": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ2ODMzNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r529468337", "bodyText": "Same here.", "author": "MarianMacik", "createdAt": "2020-11-24T11:18:19Z", "path": "addons/monitoring-addon/monitoring-core/src/test/java/org/kie/kogito/monitoring/core/integration/LocalDateTimeHandlerTest.java", "diffHunk": "@@ -51,8 +51,7 @@ public void givenLocalDateTimeMetricsWhenMetricsAreStoredThenTheQuantilesAreCorr\n         handler.record(\"decision\", ENDPOINT_NAME, now);\n \n         // Assert\n-        for (Double key : quantiles) {\n-            assertEquals(expectedValue, getQuantile(\"decision\", ENDPOINT_NAME + DecisionConstants.DECISIONS_NAME_SUFFIX, ENDPOINT_NAME, key), 5);", "originalCommit": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ3MDM5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/859#discussion_r529470397", "bodyText": "Maybe it would be good to name it MetricsProcessEventListener or similar so it is easier to identify?", "author": "MarianMacik", "createdAt": "2020-11-24T11:21:54Z", "path": "addons/monitoring-addon/monitoring-core/src/main/java/org/kie/kogito/monitoring/core/process/ProcessEventListener.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.monitoring.core.process;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.Tag;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.jbpm.workflow.instance.node.WorkItemNodeInstance;\n+import org.kie.api.event.process.DefaultProcessEventListener;\n+import org.kie.api.event.process.ProcessCompletedEvent;\n+import org.kie.api.event.process.ProcessNodeLeftEvent;\n+import org.kie.api.event.process.ProcessStartedEvent;\n+import org.kie.api.event.process.SLAViolatedEvent;\n+import org.kie.api.runtime.process.NodeInstance;\n+import org.kie.kogito.monitoring.core.MonitoringRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ProcessEventListener extends DefaultProcessEventListener {", "originalCommit": "07ccd96fb831ed5992c56d5ba145c08c9965b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "863e3134a7b68f2a133f32ab69837b2c991e59c5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/863e3134a7b68f2a133f32ab69837b2c991e59c5", "message": "remove unused variables", "committedDate": "2020-11-24T14:29:48Z", "type": "commit"}, {"oid": "a7ae1919a448a8f0d93d059d6b14d3145ffa5e42", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a7ae1919a448a8f0d93d059d6b14d3145ffa5e42", "message": "Merge branch 'KOGITO-3732-monitoring-refactoring' of github.com:r00ta/kogito-runtimes into KOGITO-3732-monitoring-refactoring", "committedDate": "2020-11-24T14:31:53Z", "type": "commit"}, {"oid": "487d7fe240ac016302a2f00594bf18e61f6b75eb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/487d7fe240ac016302a2f00594bf18e61f6b75eb", "message": "rename drools and process default listeners", "committedDate": "2020-11-24T15:11:45Z", "type": "commit"}, {"oid": "86ae85b58de3d94c9b5eac4f88befb7c4e709e70", "url": "https://github.com/kiegroup/kogito-runtimes/commit/86ae85b58de3d94c9b5eac4f88befb7c4e709e70", "message": "Merge remote-tracking branch 'upstream/master' into KOGITO-3732-monitoring-refactoring", "committedDate": "2020-11-24T15:52:07Z", "type": "commit"}, {"oid": "283fd723727f8a0a736b74e481fb76434ca69e58", "url": "https://github.com/kiegroup/kogito-runtimes/commit/283fd723727f8a0a736b74e481fb76434ca69e58", "message": "fix", "committedDate": "2020-11-24T15:56:32Z", "type": "commit"}]}