{"pr_number": 468, "pr_title": "[KOGITO-1958] Implement decision tracing addon for Quarkus", "pr_createdAt": "2020-04-22T10:28:15Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/468", "timeline": [{"oid": "f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "message": "[KOGITO-1958] Inject DmnExecutionIdSupplier in DmnDecisionModel if tracing-decision addon is enabled", "committedDate": "2020-04-22T10:31:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Nzg5NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r412877895", "bodyText": "not 100% what is the decision from Trusty side of things, but shouldn't this type of configuration be a compile-time decision?", "author": "tarilabs", "createdAt": "2020-04-22T10:51:37Z", "path": "kogito-codegen/src/main/resources/class-templates/DMNApplicationClassDeclTemplate.java", "diffHunk": "@@ -2,13 +2,21 @@\n public class DecisionModels implements org.kie.kogito.decision.DecisionModels {\n \n     private final static org.kie.dmn.api.core.DMNRuntime dmnRuntime = org.kie.kogito.dmn.DMNKogito.createGenericDMNRuntime();\n+    private org.kie.kogito.ExecutionIdSupplier execIdSupplier = null;\n \n     public void init(org.kie.kogito.Application app) {\n         app.config().decision().decisionEventListeners().listeners().forEach(dmnRuntime::addListener);\n+        if (requiresExecutionIdSupplier(app)) {\n+            execIdSupplier = new org.kie.kogito.dmn.DmnExecutionIdSupplier();\n+        }\n+    }\n+\n+    private boolean requiresExecutionIdSupplier(org.kie.kogito.Application app) {\n+        return app.config().addons().availableAddons().contains(\"tracing-decision\");\n     }\n \n     public org.kie.kogito.decision.DecisionModel getDecisionModel(java.lang.String namespace, java.lang.String name) {\n-        return new org.kie.kogito.dmn.DmnDecisionModel(dmnRuntime, namespace, name);\n+        return new org.kie.kogito.dmn.DmnDecisionModel(dmnRuntime, namespace, name, execIdSupplier);", "originalCommit": "f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkyNTYzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r412925639", "bodyText": "Definitely. It's implemented this way at the moment because it was the quickest to have the addon working to do local tests. I will change it for sure before the final review.", "author": "kostola", "createdAt": "2020-04-22T12:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Nzg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY3ODE2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416678169", "bodyText": "Now I'm checking if the addon is enabled at compile time and, if true, the instantiation of execIdSupplier is code-generated.", "author": "kostola", "createdAt": "2020-04-28T14:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Nzg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5ODYyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r413598623", "bodyText": "Why this? io.cloudevents already provide a builder for the cloud event import io.cloudevents.v1.CloudEventBuilder;", "author": "r00ta", "createdAt": "2020-04-23T08:01:13Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/main/java/org/kie/kogito/tracing/decision/DecisionTracingCollector.java", "diffHunk": "@@ -0,0 +1,186 @@\n+package org.kie.kogito.tracing.decision;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URI;\n+import java.net.URLEncoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import javax.inject.Singleton;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.datatype.jdk8.Jdk8Module;\n+import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\n+import com.fasterxml.jackson.module.paramnames.ParameterNamesModule;\n+import io.quarkus.vertx.ConsumeEvent;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.eclipse.microprofile.reactive.messaging.Outgoing;\n+import org.kie.kogito.tracing.decision.event.AfterEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.BeforeEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.EvaluateDecisionEvent;\n+import org.kie.kogito.tracing.decision.event.EvaluateEvent;\n+import org.reactivestreams.Publisher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Singleton\n+public class DecisionTracingCollector {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(DecisionTracingCollector.class);\n+\n+    private static final ObjectMapper MAPPER = new ObjectMapper()\n+            .registerModule(new ParameterNamesModule())\n+            .registerModule(new Jdk8Module())\n+            .registerModule(new JavaTimeModule());\n+\n+    private final Map<String, List<EvaluateEvent>> cacheMap = new HashMap<>();\n+    private final PublishSubject<String> eventSubject = PublishSubject.create();\n+\n+    @Outgoing(\"kogito-tracing-decision\")\n+    public Publisher<String> getEventPublisher() {\n+        return eventSubject.toFlowable(BackpressureStrategy.BUFFER);\n+    }\n+\n+    @ConsumeEvent(\"kogito-tracing-decision_BeforeEvaluateAllEvent\")\n+    public String handleEvent(BeforeEvaluateAllEvent event) {\n+        return handleEvaluateEvent(event);\n+    }\n+\n+    @ConsumeEvent(\"kogito-tracing-decision_AfterEvaluateAllEvent\")\n+    public String handleEvent(AfterEvaluateAllEvent event) {\n+        return handleEvaluateEvent(event);\n+    }\n+\n+    @ConsumeEvent(\"kogito-tracing-decision_BeforeEvaluateDecisionEvent\")\n+    public String handleEvent(org.kie.kogito.tracing.decision.event.BeforeEvaluateDecisionEvent event) {\n+        return handleEvaluateEvent(event);\n+    }\n+\n+    @ConsumeEvent(\"kogito-tracing-decision_AfterEvaluateDecisionEvent\")\n+    public String handleEvent(org.kie.kogito.tracing.decision.event.AfterEvaluateDecisionEvent event) {\n+        return handleEvaluateEvent(event);\n+    }\n+\n+    public String handleEvaluateEvent(EvaluateEvent event) {\n+        try {\n+            if (LOG.isInfoEnabled()) {\n+                if (event instanceof EvaluateDecisionEvent) {\n+                    LOG.trace(\n+                            \"Received {}(evaluationId: {}, modelName: {}, modelNamespace: {}, decisionId: {})\",\n+                            event.getClass().getSimpleName(),\n+                            event.getExecutionId(),\n+                            event.getModelName(),\n+                            event.getModelNamespace(),\n+                            ((EvaluateDecisionEvent) event).getDecisionId()\n+                    );\n+                } else {\n+                    LOG.trace(\n+                            \"Received {}(evaluationId: {}, modelName: {}, modelNamespace: {})\",\n+                            event.getClass().getSimpleName(),\n+                            event.getExecutionId(),\n+                            event.getModelName(),\n+                            event.getModelNamespace()\n+                    );\n+                }\n+            }\n+\n+            String evaluationId = event.getExecutionId();\n+            if (cacheMap.containsKey(evaluationId)) {\n+                cacheMap.get(evaluationId).add(event);\n+            } else {\n+                List<EvaluateEvent> list = new LinkedList<>();\n+                list.add(event);\n+                cacheMap.put(evaluationId, list);\n+                LOG.trace(\"Added evaluation {} to cache (current size: {})\", evaluationId, cacheMap.size());\n+            }\n+\n+            if (event instanceof AfterEvaluateAllEvent) {\n+                Pair<String, String> payload = aggregate(evaluationId, cacheMap.get(evaluationId));\n+                eventSubject.onNext(payload.getRight());\n+                LOG.debug(\"Generated aggregated event for evaluation {} (length {})\", payload.getKey(), payload.getValue().length());\n+                cacheMap.remove(evaluationId);\n+                LOG.trace(\"Removed evaluation {} from cache (current size: {})\", evaluationId, cacheMap.size());\n+            }\n+\n+            return \"\";\n+        } catch (Throwable e) {\n+            e.printStackTrace();\n+            return null;\n+        }\n+    }\n+\n+    public static Pair<String, String> aggregate(String evaluationId, List<EvaluateEvent> events) {\n+        AfterEvaluateAllEvent event = (AfterEvaluateAllEvent) events.get(events.size() - 1);\n+\n+        final CloudEvent<AfterEvaluateAllEvent> cloudEvent = new CloudEvent<>(\n+                evaluationId,\n+                AfterEvaluateAllEvent.class.getName(),\n+                sourceFrom(event),\n+                event\n+        );\n+\n+        try {\n+            return Pair.of(evaluationId, MAPPER.writer().writeValueAsString(cloudEvent));\n+        } catch (JsonProcessingException e) {\n+            LOG.error(\"JsonProcessingException\", e);\n+            e.printStackTrace();\n+            return Pair.of(evaluationId, \"ERROR\");\n+        }\n+    }\n+\n+    private static URI sourceFrom(EvaluateEvent event) {\n+        return URI.create(String.format(\"%s/%s\", event.getModelNamespace(), urlEncode(event.getModelName())));\n+    }\n+\n+    private static String urlEncode(String input) {\n+        try {\n+            return URLEncoder.encode(input, StandardCharsets.UTF_8.toString());\n+        } catch (UnsupportedEncodingException e) {\n+            e.printStackTrace();\n+            return null;\n+        }\n+    }\n+\n+    public static class CloudEvent<T> {\n+        private final String specversion;\n+        private final String id;\n+        private final String type;\n+        private final URI source;\n+        private final T data;", "originalCommit": "f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgwMDY5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415800693", "bodyText": "When you wrote this comment the official CloudEvents SDK (that contains the package you mentioned) was not imported and this class was used as POJO for the event.\nNow we decided to use it because of some useful extensions and this was removed.", "author": "kostola", "createdAt": "2020-04-27T13:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5ODYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5OTU2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r413599568", "bodyText": "Move to another file", "author": "r00ta", "createdAt": "2020-04-23T08:02:36Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/main/java/org/kie/kogito/tracing/decision/event/EvaluateEvent.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.kie.kogito.tracing.decision.event;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.DMNDecisionResult;\n+import org.kie.dmn.api.core.DMNMessage;\n+import org.kie.dmn.api.core.DMNMessageType;\n+import org.kie.dmn.api.core.DMNResult;\n+\n+public abstract class EvaluateEvent implements Serializable {\n+\n+    private final String executionId;\n+    private final String modelName;\n+    private final String modelNamespace;\n+    private final Map<String, Object> context;\n+    private final Map<String, Object> contextMetadata;\n+    private final Result result;\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNContext context) {\n+        DMNContext clone = context.clone();\n+        this.executionId = executionId;\n+        this.modelName = modelName;\n+        this.modelNamespace = modelNamespace;\n+        this.context = clone.getAll();\n+        this.contextMetadata = clone.getMetadata().asMap();\n+        this.result = null;\n+    }\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNResult result) {\n+        DMNContext clone = result.getContext().clone();\n+        this.executionId = executionId;\n+        this.modelName = modelName;\n+        this.modelNamespace = modelNamespace;\n+        this.context = clone.getAll();\n+        this.contextMetadata = clone.getMetadata().asMap();\n+        this.result = from(result);\n+    }\n+\n+    public String getExecutionId() {\n+        return executionId;\n+    }\n+\n+    public String getModelName() {\n+        return modelName;\n+    }\n+\n+    public String getModelNamespace() {\n+        return modelNamespace;\n+    }\n+\n+    public Map<String, Object> getContext() {\n+        return context;\n+    }\n+\n+    public Map<String, Object> getContextMetadata() {\n+        return contextMetadata;\n+    }\n+\n+    public Result getResult() {\n+        return result;\n+    }\n+\n+    public static class Result {\n+\n+        private final List<DecisionResult> decisionResults;\n+        private final List<Message> messages;\n+\n+        public Result(List<DecisionResult> decisionResults, List<Message> messages) {\n+            this.decisionResults = decisionResults;\n+            this.messages = messages;\n+        }\n+\n+        public List<DecisionResult> getDecisionResults() {\n+            return decisionResults;\n+        }\n+\n+        public List<Message> getMessages() {\n+            return messages;\n+        }\n+    }", "originalCommit": "f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgwMTIzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415801234", "bodyText": "I will definitely refactor this part once we have a clear agreement on the first version of the data we want to export.", "author": "kostola", "createdAt": "2020-04-27T13:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5OTU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYwMDUxMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r413600510", "bodyText": "Move to another file (also for all the other files/classes)", "author": "r00ta", "createdAt": "2020-04-23T08:03:58Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/main/java/org/kie/kogito/tracing/decision/event/EvaluateEvent.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.kie.kogito.tracing.decision.event;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.DMNDecisionResult;\n+import org.kie.dmn.api.core.DMNMessage;\n+import org.kie.dmn.api.core.DMNMessageType;\n+import org.kie.dmn.api.core.DMNResult;\n+\n+public abstract class EvaluateEvent implements Serializable {\n+\n+    private final String executionId;\n+    private final String modelName;\n+    private final String modelNamespace;\n+    private final Map<String, Object> context;\n+    private final Map<String, Object> contextMetadata;\n+    private final Result result;\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNContext context) {\n+        DMNContext clone = context.clone();\n+        this.executionId = executionId;\n+        this.modelName = modelName;\n+        this.modelNamespace = modelNamespace;\n+        this.context = clone.getAll();\n+        this.contextMetadata = clone.getMetadata().asMap();\n+        this.result = null;\n+    }\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNResult result) {\n+        DMNContext clone = result.getContext().clone();\n+        this.executionId = executionId;\n+        this.modelName = modelName;\n+        this.modelNamespace = modelNamespace;\n+        this.context = clone.getAll();\n+        this.contextMetadata = clone.getMetadata().asMap();\n+        this.result = from(result);\n+    }\n+\n+    public String getExecutionId() {\n+        return executionId;\n+    }\n+\n+    public String getModelName() {\n+        return modelName;\n+    }\n+\n+    public String getModelNamespace() {\n+        return modelNamespace;\n+    }\n+\n+    public Map<String, Object> getContext() {\n+        return context;\n+    }\n+\n+    public Map<String, Object> getContextMetadata() {\n+        return contextMetadata;\n+    }\n+\n+    public Result getResult() {\n+        return result;\n+    }\n+\n+    public static class Result {\n+\n+        private final List<DecisionResult> decisionResults;\n+        private final List<Message> messages;\n+\n+        public Result(List<DecisionResult> decisionResults, List<Message> messages) {\n+            this.decisionResults = decisionResults;\n+            this.messages = messages;\n+        }\n+\n+        public List<DecisionResult> getDecisionResults() {\n+            return decisionResults;\n+        }\n+\n+        public List<Message> getMessages() {\n+            return messages;\n+        }\n+    }\n+\n+    public static class DecisionResult {\n+\n+        private final String decisionId;\n+        private final String decisionName;\n+        private final DMNDecisionResult.DecisionEvaluationStatus evaluationStatus;\n+        private final Object result;\n+        private final List<Message> messages;\n+        private final boolean errors;\n+\n+        public DecisionResult(String decisionId, String decisionName, DMNDecisionResult.DecisionEvaluationStatus evaluationStatus, Object result, List<Message> messages, boolean errors) {\n+            this.decisionId = decisionId;\n+            this.decisionName = decisionName;\n+            this.evaluationStatus = evaluationStatus;\n+            this.result = result;\n+            this.messages = messages;\n+            this.errors = errors;", "originalCommit": "f7d6916c3629b9314bda96a2de6f9ef0c0c5a0dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgwMTMxOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415801318", "bodyText": "I will definitely refactor this part once we have a clear agreement on the first version of the data we want to export.", "author": "kostola", "createdAt": "2020-04-27T13:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYwMDUxMA=="}], "type": "inlineReview"}, {"oid": "b61667e9b1fb67c8532b3bfe5c124026e34af0a2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b61667e9b1fb67c8532b3bfe5c124026e34af0a2", "message": "[KOGITO-1958] Common logic moved to tracing-decision-common", "committedDate": "2020-04-24T13:50:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3ODI4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415578285", "bodyText": "Is it possible to use an interface instead of CloudEventImpl?\nWhy the package of this class contains v1? Is it version specific?", "author": "danielezonca", "createdAt": "2020-04-27T07:33:34Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/aggregator/Aggregator.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package org.kie.kogito.tracing.decision.aggregator;\n+\n+import java.util.List;\n+\n+import io.cloudevents.v1.CloudEventImpl;\n+import org.kie.kogito.tracing.decision.event.EvaluateEvent;\n+\n+@FunctionalInterface\n+public interface Aggregator<T> {\n+\n+    CloudEventImpl<T> aggregate(String evaluationId, List<EvaluateEvent> events);", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5ODYyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416498623", "bodyText": "The v1 contained in the package is the version of the CloudEvents specification v1.0, so it makes sense to me to have it there.\nI used CloudEventImpl because it's the standard implementation. The CloudEvent interface seems too generic for me: it requires two type parameters, one for the attributes of the CloudEvent itself and one for the payload.\nCloudEventImpl, instead, implements CloudEvent fixing the first type parameter to a standard implementation that matches the specification, and allows to specify only the payload type (the one we care about).\nIdk why it's implemented this way but I assume for compatibility between different specs. I don't like the idea of using CloudEvent and specifying the attribute type everywhere to be honest.", "author": "kostola", "createdAt": "2020-04-28T10:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3ODI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA3NDExMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r420074113", "bodyText": "ok let's keep it for now and see if this is solved in the new sdk version (if I remember correctly it is supposed to abstract over the different versions)", "author": "danielezonca", "createdAt": "2020-05-05T12:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU3ODI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MDA5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415580099", "bodyText": "Missing license (here and in all new files :D )", "author": "danielezonca", "createdAt": "2020-04-27T07:36:27Z", "path": "addons/tracing/tracing-decision-common/src/test/java/org/kie/kogito/tracing/decision/testimpl/TestAfterEvaluateAllEvent.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package org.kie.kogito.tracing.decision.testimpl;", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ5MDA5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416490091", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T10:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MDA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MTY3Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415581672", "bodyText": "I would prefer a different prefix for this class name because maven will consider this class as a test (see doc).\nWhat about Mock*?\nSame comment for all the other classes in this package", "author": "danielezonca", "createdAt": "2020-04-27T07:39:09Z", "path": "addons/tracing/tracing-decision-common/src/test/java/org/kie/kogito/tracing/decision/testimpl/TestAfterEvaluateAllEvent.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package org.kie.kogito.tracing.decision.testimpl;\n+\n+import org.kie.dmn.api.core.DMNResult;\n+import org.kie.dmn.api.core.event.AfterEvaluateAllEvent;\n+\n+public class TestAfterEvaluateAllEvent implements AfterEvaluateAllEvent {", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ4MDM1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416480355", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T09:48:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU5NjIzNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415596237", "bodyText": "I would prefer to use mockito and mock EventBus instead of implement a mock. What you are doing here can be easily obtained with an empty mock (just Mockito.mock(EventBus.class)) + verify + ArgumentCaptor", "author": "danielezonca", "createdAt": "2020-04-27T08:01:13Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/test/java/org/kie/kogito/tracing/decision/DecisionTracingTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.kie.kogito.tracing.decision;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import io.cloudevents.json.Json;\n+import io.cloudevents.v1.CloudEventImpl;\n+import io.reactivex.subscribers.TestSubscriber;\n+import org.junit.jupiter.api.Test;\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.DMNRuntime;\n+import org.kie.dmn.feel.util.Pair;\n+import org.kie.kogito.decision.DecisionModel;\n+import org.kie.kogito.dmn.DMNKogito;\n+import org.kie.kogito.dmn.DmnDecisionModel;\n+import org.kie.kogito.tracing.decision.event.AfterEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.BeforeEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.testimpl.TestEventBus;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class DecisionTracingTest {\n+\n+    private static final String TEST_EXECUTION_ID = \"7c50581e-6e5b-407b-91d6-2ffb1d47ebc0\";\n+\n+    @Test\n+    public void test_ListenerAndCollector_UseRealEvents_Working() {\n+        final String modelResource = \"/Traffic Violation.dmn\";\n+        final String modelNamespace = \"https://github.com/kiegroup/drools/kie-dmn/_A4BCA8B8-CF08-433F-93B2-A2598F19ECFF\";\n+        final String modelName = \"Traffic Violation\";\n+\n+        final DMNRuntime runtime = DMNKogito.createGenericDMNRuntime(new java.io.InputStreamReader(\n+                DecisionTracingTest.class.getResourceAsStream(modelResource)\n+        ));\n+\n+        TestEventBus eventBus = new TestEventBus();\n+        DecisionTracingListener listener = new DecisionTracingListener(eventBus);\n+        runtime.addListener(listener);\n+\n+        final Map<String, Object> driver = new HashMap<>();\n+        driver.put(\"Points\", 10);\n+        final Map<String, Object> violation = new HashMap<>();\n+        violation.put(\"Type\", \"speed\");\n+        violation.put(\"Actual Speed\", 105);\n+        violation.put(\"Speed Limit\", 100);\n+        final Map<String, Object> contextVariables = new HashMap<>();\n+        contextVariables.put(\"Driver\", driver);\n+        contextVariables.put(\"Violation\", violation);\n+\n+        final DecisionModel model = new DmnDecisionModel(runtime, modelNamespace, modelName, () -> TEST_EXECUTION_ID);\n+        final DMNContext context = model.newContext(contextVariables);\n+        model.evaluateAll(context);\n+\n+        List<Pair<String, Object>> eventBusCalls = eventBus.getCalls();\n+        assertEquals(2, eventBusCalls.size());\n+        assertEquals(\"kogito-tracing-decision_BeforeEvaluateAllEvent\", eventBusCalls.get(0).getLeft());\n+        assertTrue(eventBusCalls.get(0).getRight() instanceof BeforeEvaluateAllEvent);\n+        assertEquals(\"kogito-tracing-decision_AfterEvaluateAllEvent\", eventBusCalls.get(1).getLeft());\n+        assertTrue(eventBusCalls.get(1).getRight() instanceof AfterEvaluateAllEvent);\n+\n+        BeforeEvaluateAllEvent beforeEvent = (BeforeEvaluateAllEvent) eventBusCalls.get(0).getRight();\n+        AfterEvaluateAllEvent afterEvent = (AfterEvaluateAllEvent) eventBusCalls.get(1).getRight();", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ4MDU5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416480597", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T09:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU5NjIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzNDkyNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415634924", "bodyText": "I'm thinking at the possibility to hide publisher with an interface (we can start with a simple Consumer<String>) so that we can also implement handlePayload and the specific implementation will just provide the impl of that interface.\nWe can keep here an abstract protected getConsumer() method to implement.\nWdyt?", "author": "danielezonca", "createdAt": "2020-04-27T08:57:19Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/AbstractDecisionTracingCollector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.kie.kogito.tracing.decision;\n+\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.cloudevents.json.Json;\n+import org.kie.kogito.tracing.decision.aggregator.Aggregator;\n+import org.kie.kogito.tracing.decision.aggregator.DefaultAggregator;\n+import org.kie.kogito.tracing.decision.event.AfterEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.EvaluateEvent;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AbstractDecisionTracingCollector {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(AbstractDecisionTracingCollector.class);\n+\n+    private final Map<String, List<EvaluateEvent>> cacheMap;\n+    private final Aggregator<?> aggregator;\n+\n+    public AbstractDecisionTracingCollector() {\n+        this(new DefaultAggregator());\n+    }\n+\n+    public AbstractDecisionTracingCollector(Aggregator<?> aggregator) {\n+        this.cacheMap = new HashMap<>();\n+        this.aggregator = aggregator;\n+    }\n+\n+    protected void handleEvaluateEvent(EvaluateEvent event) {\n+        LOG.trace(\n+                \"Received {}(evaluationId: {}, modelName: {}, modelNamespace: {})\",\n+                event.getClass().getSimpleName(),\n+                event.getExecutionId(),\n+                event.getModelName(),\n+                event.getModelNamespace()\n+        );\n+\n+        String evaluationId = event.getExecutionId();\n+        if (cacheMap.containsKey(evaluationId)) {\n+            cacheMap.get(evaluationId).add(event);\n+        } else {\n+            List<EvaluateEvent> list = new LinkedList<>();\n+            list.add(event);\n+            cacheMap.put(evaluationId, list);\n+            LOG.trace(\"Added evaluation {} to cache (current size: {})\", evaluationId, cacheMap.size());\n+        }\n+\n+        if (event instanceof AfterEvaluateAllEvent) {\n+            String payload = aggregate(evaluationId, cacheMap.get(evaluationId));\n+            handlePayload(payload);\n+            LOG.debug(\"Generated aggregated event for evaluation {} (length {})\", evaluationId, payload.length());\n+            cacheMap.remove(evaluationId);\n+            LOG.trace(\"Removed evaluation {} from cache (current size: {})\", evaluationId, cacheMap.size());\n+        }\n+    }\n+\n+    protected abstract void handlePayload(String payload);", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYxNzE5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416617198", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T13:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzNDkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzNTgyNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415635824", "bodyText": "Same comment of AbstractDecisionTracingCollector: we can abstract over EventBus with  a simple Consumer and keep here all the rest of the logic.", "author": "danielezonca", "createdAt": "2020-04-27T08:58:32Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/AbstractDecisionTracingListener.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.kie.kogito.tracing.decision;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.event.DMNRuntimeEventListener;\n+import org.kie.kogito.decision.DecisionExecutionIdUtils;\n+import org.kie.kogito.tracing.decision.event.AfterEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.BeforeEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.EvaluateEvent;\n+\n+public abstract class AbstractDecisionTracingListener implements DMNRuntimeEventListener {\n+\n+    @Override\n+    public void beforeEvaluateAll(org.kie.dmn.api.core.event.BeforeEvaluateAllEvent event) {\n+        handleEvaluateEvent(new BeforeEvaluateAllEvent(\n+                extractExecutionId(event.getResult().getContext()),\n+                event.getModelName(),\n+                event.getModelNamespace(),\n+                event.getResult().getContext()\n+        ));\n+    }\n+\n+    @Override\n+    public void afterEvaluateAll(org.kie.dmn.api.core.event.AfterEvaluateAllEvent event) {\n+        handleEvaluateEvent(new AfterEvaluateAllEvent(\n+                extractExecutionId(event.getResult().getContext()),\n+                event.getModelName(),\n+                event.getModelNamespace(),\n+                event.getResult()\n+        ));\n+    }\n+\n+    protected abstract void handleEvaluateEvent(EvaluateEvent event);", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYxNzM0Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416617343", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T13:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzNTgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MDg4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r415640880", "bodyText": "This class will be probably changed a lot soon but in general I would prefer to have few/none inner classes, especially when it is not a sub-component of the outer class but a proper concept like DecisionResult, Result etc.\nMy proposal is to promote all of them as proper classes, wdyt?", "author": "danielezonca", "createdAt": "2020-04-27T09:05:40Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/event/EvaluateEvent.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.kie.kogito.tracing.decision.event;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.DMNDecisionResult;\n+import org.kie.dmn.api.core.DMNMessage;\n+import org.kie.dmn.api.core.DMNMessageType;\n+import org.kie.dmn.api.core.DMNResult;\n+\n+public abstract class EvaluateEvent implements Serializable {", "originalCommit": "6916c092e1e64f1f47c312737f50f40d9cc1c8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYxNzYwOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r416617609", "bodyText": "Promoted all inner classes to top level Java classes \ud83d\udc4d", "author": "kostola", "createdAt": "2020-04-28T13:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MDg4MA=="}], "type": "inlineReview"}, {"oid": "56b2bdf97fe8e1cc20bb7a78562e1363a674b23e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/56b2bdf97fe8e1cc20bb7a78562e1363a674b23e", "message": "[KOGITO-1958] Use Mock prefix instead of Test in test implementations", "committedDate": "2020-04-28T09:04:35Z", "type": "forcePushed"}, {"oid": "22dcd06ad97ff623a790e572bb0e7ece3bc82511", "url": "https://github.com/kiegroup/kogito-runtimes/commit/22dcd06ad97ff623a790e572bb0e7ece3bc82511", "message": "[KOGITO-1958] Check if tracing addon is enabled at compile time", "committedDate": "2020-04-28T14:48:44Z", "type": "forcePushed"}, {"oid": "6a5cb1addf63b62bfcfc39f18c98214566195635", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6a5cb1addf63b62bfcfc39f18c98214566195635", "message": "[KOGITO-1958] No need for EvaluateEvent to be serializable", "committedDate": "2020-04-29T09:50:49Z", "type": "forcePushed"}, {"oid": "fea655b43c1e26620ef401485d4f5cc002ccb85c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fea655b43c1e26620ef401485d4f5cc002ccb85c", "message": "[KOGITO-1958] No need for EvaluateEvent to be serializable", "committedDate": "2020-04-30T08:30:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0NTI4Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r418045287", "bodyText": "Sorry for asking again, but is there a specific reason why we are implementing this \"decision export\" using a listener in the runtime? What are the additional information that we might get from it (that we don't have in the DMNResult?)", "author": "r00ta", "createdAt": "2020-04-30T14:18:43Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/DecisionTracingListener.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.tracing.decision;\n+\n+import java.util.function.Consumer;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.event.DMNRuntimeEventListener;\n+import org.kie.kogito.decision.DecisionExecutionIdUtils;\n+import org.kie.kogito.tracing.decision.event.AfterEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.BeforeEvaluateAllEvent;\n+import org.kie.kogito.tracing.decision.event.EvaluateEvent;\n+\n+public class DecisionTracingListener implements DMNRuntimeEventListener {", "originalCommit": "fea655b43c1e26620ef401485d4f5cc002ccb85c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0OTExMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r419449111", "bodyText": "We're using a listener because we already planned to increase the amount of exported information with additional data that can be obtained only via a listener (e.g. inputs/outputs of BKM model invocations)\nThus, even if in this version we're basically just exporting the final DMNResult, the implementation via listener already enables the next improvements.", "author": "kostola", "createdAt": "2020-05-04T13:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0NTI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5NzgxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r420597813", "bodyText": "Please avoid Quarkus keyword here. This is the \"marker\" class we expect to have to recognize tracing is enable. Please rename it as KogitoDecisionTracingListener (of course rename the original class too, not only this variable :) )", "author": "danielezonca", "createdAt": "2020-05-06T07:36:38Z", "path": "kogito-quarkus-extension/deployment/src/main/java/org/kie/kogito/quarkus/deployment/KogitoAssetsProcessor.java", "diffHunk": "@@ -75,7 +74,7 @@\n     private final transient String appPackageName = \"org.kie.kogito.app\";\n     private final transient String persistenceFactoryClass = \"org.kie.kogito.persistence.KogitoProcessInstancesFactory\";\n     private final transient String metricsClass = \"org.kie.kogito.monitoring.rest.MetricsResource\";\n-\n+    private final transient String tracingClass = \"org.kie.kogito.tracing.decision.QuarkusDecisionTracingListener\";", "originalCommit": "fea655b43c1e26620ef401485d4f5cc002ccb85c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYxNDk5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r420614999", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-05-06T08:11:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5NzgxMw=="}], "type": "inlineReview"}, {"oid": "95ed65da7829c3a21acad3722965d569557df8d0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/95ed65da7829c3a21acad3722965d569557df8d0", "message": "[KOGITO-1958] Use Kogito prefix in tracing-decision-quarkus-addon", "committedDate": "2020-05-06T07:44:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY0NzMwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r420647303", "bodyText": "Can you please add a comment like this one", "author": "danielezonca", "createdAt": "2020-05-06T09:09:31Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/main/java/org/kie/kogito/tracing/decision/KogitoDecisionTracingListener.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.tracing.decision;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.vertx.core.eventbus.EventBus;\n+\n+@ApplicationScoped\n+public final class KogitoDecisionTracingListener extends DecisionTracingListener {", "originalCommit": "95ed65da7829c3a21acad3722965d569557df8d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY1MTkwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r420651908", "bodyText": "Done \ud83d\udc4d", "author": "kostola", "createdAt": "2020-05-06T09:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY0NzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5OTk0MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423599941", "bodyText": "Can you put a link to the Doc about why \"must always have\" the exact FQN, please?", "author": "tarilabs", "createdAt": "2020-05-12T09:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY0NzMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMjQ2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423602462", "bodyText": "Can you put a link to the Doc about why \"must always have\" the exact FQN, please?", "author": "tarilabs", "createdAt": "2020-05-12T09:41:48Z", "path": "addons/tracing/tracing-decision-quarkus-addon/src/main/java/org/kie/kogito/tracing/decision/KogitoDecisionTracingListener.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.tracing.decision;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.vertx.core.eventbus.EventBus;\n+\n+/**\n+ * This class must always have exact FQCN as <code>org.kie.kogito.tracing.decision.KogitoDecisionTracingListener</code>", "originalCommit": "3d144524b2db4a1ae8a4855b9c57b28213c54bb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NDk2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423794966", "bodyText": "+1", "author": "MarianMacik", "createdAt": "2020-05-12T14:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMjQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0MTI1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r424441255", "bodyText": "I agree that this should be documented but it is following the same \"convention\" of other classes like this one. It is possible to improve the javadoc but If we really want to make this design choice explicit, I think we should create a new task for document it.\nBtw it is not clear where we want to document this because we do not support \"custom addon\" in Kogito (yet?) so the way to load an addon class is an implementation detail and not an information that user should be aware of", "author": "danielezonca", "createdAt": "2020-05-13T13:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMjQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNzcyMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r424917721", "bodyText": "Let's keep this aligned with other classes in this PR so it can be merged.\nI will take care of opening a dedicated ticket for enhancing the documentation.", "author": "kostola", "createdAt": "2020-05-14T07:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMjQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NTM3MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423695370", "bodyText": "Just a consideration from my side: this EvaluateEvent is collecting exacly the DMNResult. As we have already discussed in the past, if we need to export just the DMNResult I think we should do that in another way.\nBut since we are using a listener 'cause potentially we might extract more information (that is not contained in the DMNResult), I'm a bit worried to expose here exactly the DMNResult structure. This is going to be deprecated/changed very soon by design, just saying that nobody should base his implementation on the DMNResult exposed here.. wdyt?", "author": "r00ta", "createdAt": "2020-05-12T12:32:42Z", "path": "addons/tracing/tracing-decision-common/src/main/java/org/kie/kogito/tracing/decision/event/EvaluateEvent.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.tracing.decision.event;\n+\n+import java.util.Map;\n+\n+import org.kie.dmn.api.core.DMNContext;\n+import org.kie.dmn.api.core.DMNResult;\n+\n+public abstract class EvaluateEvent {\n+\n+    private final String executionId;\n+    private final String modelName;\n+    private final String modelNamespace;\n+    private final Map<String, Object> context;\n+    private final Map<String, Object> contextMetadata;\n+    private final EvaluateEventResult result;\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNContext context) {\n+        DMNContext clone = context.clone();\n+        this.executionId = executionId;\n+        this.modelName = modelName;\n+        this.modelNamespace = modelNamespace;\n+        this.context = clone.getAll();\n+        this.contextMetadata = clone.getMetadata().asMap();\n+        this.result = null;\n+    }\n+\n+    public EvaluateEvent(String executionId, String modelName, String modelNamespace, DMNResult result) {", "originalCommit": "3d144524b2db4a1ae8a4855b9c57b28213c54bb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjkzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r424452939", "bodyText": "The implementation of the addon was split in several tasks, as we discussed, because of its size and to have intermediate working \"checkpoints\" to validate our design.\nThis is the first one that implements a initial version of the addon that exports a limited amount of data.\nI am already working on the second one that will refactor the exported data structure so that it won't expose any internal class of the DMN runtime anymore (which is your concern).\nI agree that nobody should base any implementation on this DMNResult, but I don't think it's a big issue here because I don't think anyone will use this version of the addon since it will soon be enhanced.", "author": "kostola", "createdAt": "2020-05-13T13:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcxMjE3NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423712175", "bodyText": "remove newline", "author": "r00ta", "createdAt": "2020-05-12T12:59:36Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/ApplicationGenerator.java", "diffHunk": "@@ -204,6 +204,7 @@ public ApplicationGenerator withMonitoring(boolean monitoring) {\n        return this;\n    }\n \n+", "originalCommit": "3d144524b2db4a1ae8a4855b9c57b28213c54bb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcxNTUzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r423715535", "bodyText": "Just a small consideration from my side: since we injecting some booleans as configurations, I think it's better to have a configuration object instead of many booleans, it would be much easier to maintain imo. If this is fine for the others we might do this refactoring in another PR", "author": "r00ta", "createdAt": "2020-05-12T13:04:30Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java", "diffHunk": "@@ -206,7 +207,7 @@ private ApplicationGenerator createApplicationGenerator(\n         }\n \n         if (generateDecisions) {\n-            appGen.withGenerator(DecisionCodegen.ofPath(kieSourcesDirectory.toPath()))\n+            appGen.withGenerator(DecisionCodegen.ofPath(kieSourcesDirectory.toPath()).withTracing(useTracing))", "originalCommit": "3d144524b2db4a1ae8a4855b9c57b28213c54bb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2ODE4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/468#discussion_r424468186", "bodyText": "Yes it's a good idea. We can open a dedicated ticket for this and extend the discussion to other Kogito devs.", "author": "kostola", "createdAt": "2020-05-13T14:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcxNTUzNQ=="}], "type": "inlineReview"}, {"oid": "452f2b075420fbad9c172fbffcb2ed234f5ef35e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/452f2b075420fbad9c172fbffcb2ed234f5ef35e", "message": "[KOGITO-1958] First working version of tracing-decision-quarkus-addon", "committedDate": "2020-05-13T15:38:13Z", "type": "commit"}, {"oid": "4f0f1a6a00290f66d15617ff97589829f13fb5b4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4f0f1a6a00290f66d15617ff97589829f13fb5b4", "message": "[KOGITO-1958] Extract execution ID in tracing-decision-quarkus-addon", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "d6e23f22e87aeee335b5c76a2cea603b3dcd6f1e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d6e23f22e87aeee335b5c76a2cea603b3dcd6f1e", "message": "[KOGITO-1958] Inject DmnExecutionIdSupplier in DmnDecisionModel if tracing-decision addon is enabled", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "45cad90d2112a17e8d554cf75b10b86b9b054944", "url": "https://github.com/kiegroup/kogito-runtimes/commit/45cad90d2112a17e8d554cf75b10b86b9b054944", "message": "[KOGITO-1958] Common logic moved to tracing-decision-common", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "fd17e21344d666e14a8c67a34f26fcc4bdb4f45f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fd17e21344d666e14a8c67a34f26fcc4bdb4f45f", "message": "[KOGITO-1958] Remove unused code", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "2fb4871f9c4bc358f5a471879555ea64235bd608", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2fb4871f9c4bc358f5a471879555ea64235bd608", "message": "[KOGITO-1958] Add tests to tracing-decision-quarkus-addon", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "4c9efc5e8cf9c6a8c426df1dd028679d9662e606", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4c9efc5e8cf9c6a8c426df1dd028679d9662e606", "message": "[KOGITO-1958] Add io.cloudevents:cloudevents-api:1.3.0 to global dependencyManagement", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "94e71e1e32ae2e432ca2df488c7e081853d0101f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/94e71e1e32ae2e432ca2df488c7e081853d0101f", "message": "[KOGITO-1958] Use Mock prefix instead of Test in test implementations", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "53e8edb669fadebec3a79f6ca84cb65f709716cc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/53e8edb669fadebec3a79f6ca84cb65f709716cc", "message": "[KOGITO-1958] Use Mockito in tracing-decision-quarkus-addons tests", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "560c48d720cc6dfb1bd2ac71d6ecede51c3af978", "url": "https://github.com/kiegroup/kogito-runtimes/commit/560c48d720cc6dfb1bd2ac71d6ecede51c3af978", "message": "[KOGITO-1958] Add missing license headers", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "2d5eaa52cdbaca949bff155d32c63e4c607eb607", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2d5eaa52cdbaca949bff155d32c63e4c607eb607", "message": "[KOGITO-1958] Add tracing decision modules to kogito-bom", "committedDate": "2020-05-13T15:38:14Z", "type": "commit"}, {"oid": "5b8dd71b8489a6d92b017f833e206c65a0dc3f6d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/5b8dd71b8489a6d92b017f833e206c65a0dc3f6d", "message": "[KOGITO-1958] Use composition in tracing decision addon", "committedDate": "2020-05-13T15:38:15Z", "type": "commit"}, {"oid": "fcfe276893256fa81d5ddb38869427294aeb9176", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fcfe276893256fa81d5ddb38869427294aeb9176", "message": "[KOGITO-1958] Check if tracing addon is enabled at compile time", "committedDate": "2020-05-13T15:38:15Z", "type": "commit"}, {"oid": "293ed81a93be1a486d28a67b969ede059c7c6eba", "url": "https://github.com/kiegroup/kogito-runtimes/commit/293ed81a93be1a486d28a67b969ede059c7c6eba", "message": "[KOGITO-1958] No need for EvaluateEvent to be serializable", "committedDate": "2020-05-13T15:38:15Z", "type": "commit"}, {"oid": "be12dc0da816c03bcd8756037ca974ada399dbb6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/be12dc0da816c03bcd8756037ca974ada399dbb6", "message": "[KOGITO-1958] Use Kogito prefix in tracing-decision-quarkus-addon", "committedDate": "2020-05-13T15:38:15Z", "type": "commit"}, {"oid": "d733eaf1b5f5b9d42fd201c69b259c46173513d6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d733eaf1b5f5b9d42fd201c69b259c46173513d6", "message": "[KOGITO-1958] Comment about exact FQCN in KogitoDecisionTracingListener", "committedDate": "2020-05-13T15:39:18Z", "type": "commit"}, {"oid": "d733eaf1b5f5b9d42fd201c69b259c46173513d6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d733eaf1b5f5b9d42fd201c69b259c46173513d6", "message": "[KOGITO-1958] Comment about exact FQCN in KogitoDecisionTracingListener", "committedDate": "2020-05-13T15:39:18Z", "type": "forcePushed"}]}