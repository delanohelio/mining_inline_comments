{"pr_number": 303, "pr_title": "KOGITO-19 - Tagging of process variables", "pr_createdAt": "2020-02-04T14:24:04Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/303", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwMjc3NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r375102775", "bodyText": "some minor code styling issues like this one.", "author": "cristianonicolai", "createdAt": "2020-02-05T07:54:12Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/ProcessCodegen.java", "diffHunk": "@@ -243,13 +253,13 @@ public ProcessCodegen withClassLoader(ClassLoader projectClassLoader) {\n             String classPrefix = StringUtils.capitalize(execModelGen.extractedProcessId());\n             WorkflowProcess workFlowProcess = execModelGen.process();\n             ModelClassGenerator modelClassGenerator =\n-                    processIdToModelGenerator.get(execModelGen.getProcessId());\n+                    processIdToModelGenerator.get(execModelGen.getProcessId());   \n \n             ProcessGenerator p = new ProcessGenerator(\n                     workFlowProcess,\n                     execModelGen,\n                     classPrefix,\n-                    modelClassGenerator.className(),\n+                    modelClassGenerator.className(),                    ", "originalCommit": "d4206811de5bfbae272741431e32ea33ab33f1df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwNDY1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r375104651", "bodyText": "Should it throw some exception here? like what you done for internal variable or simply check that the field actually exists?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    modelClazz.getDeclaredField(\"decision\");\n          \n          \n            \n                     assertThrows(NoSuchFieldException.class, () -> modelClazz.getDeclaredField(\"decision\");\n          \n          \n            \n                     or \n          \n          \n            \n                     ssertNotNull(modelClazz.getDeclaredField(\"decision\"));", "author": "cristianonicolai", "createdAt": "2020-02-05T07:59:55Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,127 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-readonly-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        \n+        Field approverField = resourceClazz.getDeclaredField(\"approver\");\n+        assertThat(approverField).isNotNull();\n+        assertThat(approverField.getType().getCanonicalName()).isEqualTo(String.class.getCanonicalName());\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"john\");\n+        m.fromMap(parameters);\n+        \n+        \n+        ProcessInstance processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+        \n+        final Model updates = p.createModel();\n+        parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"mary\");\n+        updates.fromMap(parameters);\n+        // updating readonly variable should fail\n+        assertThrows(VariableViolationException.class, () -> processInstance.updateVariables(updates));\n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+    \n+    @Test\n+    public void testApprovalWithInternalVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-internal-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        // internal variables are not exposed on the model\n+        assertThrows(NoSuchFieldException.class, () -> resourceClazz.getDeclaredField(\"approver\"));\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+\n+    @Test\n+    public void testApprovalWithRequiredVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-required-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        assertThrows(VariableViolationException.class, () -> {\n+            ProcessInstance<?> processInstance = p.createInstance(m);\n+            processInstance.start();\n+        });\n+ \n+    } \n+    \n+    @Test\n+    public void testApprovalWithIOVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-io-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> modelClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(modelClazz);\n+        // internal variables are not exposed on the model\n+        modelClazz.getDeclaredField(\"decision\");", "originalCommit": "d4206811de5bfbae272741431e32ea33ab33f1df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a921ea33b6edc350b722ca9e989e2f2daab3250", "url": "https://github.com/kiegroup/kogito-runtimes/commit/1a921ea33b6edc350b722ca9e989e2f2daab3250", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-05T10:16:03Z", "type": "forcePushed"}, {"oid": "d7643ccf5417c9e1996d58173534c80b528b729d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d7643ccf5417c9e1996d58173534c80b528b729d", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-05T11:20:28Z", "type": "forcePushed"}, {"oid": "4757140ed04032d84bbf1890a22df179a66f81d1", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4757140ed04032d84bbf1890a22df179a66f81d1", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-05T11:22:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3MjkzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376372935", "bodyText": "I think there is a shorthand assertj method for this\n// \"name\" needs to be either a property or a field of the TolkienCharacter class\nassertThat(fellowshipOfTheRing).extracting(\"name\")\n                               .contains(\"Boromir\", \"Gandalf\", \"Frodo\", \"Legolas\")\n                               .doesNotContain(\"Sauron\", \"Elrond\");", "author": "evacchi", "createdAt": "2020-02-07T12:47:57Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,129 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-readonly-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        \n+        Field approverField = resourceClazz.getDeclaredField(\"approver\");\n+        assertThat(approverField).isNotNull();\n+        assertThat(approverField.getType().getCanonicalName()).isEqualTo(String.class.getCanonicalName());", "originalCommit": "4757140ed04032d84bbf1890a22df179a66f81d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NDc0NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376374745", "bodyText": "I would move this Scope + Predicate method to VariableDeclarations static method; e.g. ofOutput", "author": "evacchi", "createdAt": "2020-02-07T12:52:57Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ProcessToExecModelGenerator.java", "diffHunk": "@@ -155,7 +156,26 @@ public ModelMetaData generateModel(WorkflowProcess process) {\n         String name = extractModelClassName(process.getId());\n \n         return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n-                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE)));\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG)),\n+                                 false);\n+    }\n+    \n+    public ModelMetaData generateInputModel(WorkflowProcess process) {\n+        String packageName = process.getPackageName();\n+        String name = extractModelClassName(process.getId()) + \"Input\";\n+\n+        return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.OUTPUT_TAG)),", "originalCommit": "4757140ed04032d84bbf1890a22df179a66f81d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5NTM5NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376395395", "bodyText": "moved", "author": "mswiderski", "createdAt": "2020-02-07T13:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NDc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NDc5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376374791", "bodyText": "I would move this Scope + Predicate method to VariableDeclarations static method; e.g. ofInput", "author": "evacchi", "createdAt": "2020-02-07T12:53:04Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ProcessToExecModelGenerator.java", "diffHunk": "@@ -155,7 +156,26 @@ public ModelMetaData generateModel(WorkflowProcess process) {\n         String name = extractModelClassName(process.getId());\n \n         return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n-                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE)));\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG)),\n+                                 false);\n+    }\n+    \n+    public ModelMetaData generateInputModel(WorkflowProcess process) {\n+        String packageName = process.getPackageName();\n+        String name = extractModelClassName(process.getId()) + \"Input\";\n+\n+        return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.OUTPUT_TAG)),\n+                                 true, \"/class-templates/ModelNoIDTemplate.java\");\n+    }\n+    \n+    public ModelMetaData generateOutputModel(WorkflowProcess process) {\n+        String packageName = process.getPackageName();\n+        String name = extractModelClassName(process.getId()) + \"Output\";\n+\n+        return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.INPUT_TAG)),\n+                                 true);", "originalCommit": "4757140ed04032d84bbf1890a22df179a66f81d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5NTQ4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376395480", "bodyText": "moved", "author": "mswiderski", "createdAt": "2020-02-07T13:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NDc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NTQ4OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376375489", "bodyText": "maybe we can move this method entirely to InputModelClassGenerator ?", "author": "evacchi", "createdAt": "2020-02-07T12:54:57Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ProcessToExecModelGenerator.java", "diffHunk": "@@ -155,7 +156,26 @@ public ModelMetaData generateModel(WorkflowProcess process) {\n         String name = extractModelClassName(process.getId());\n \n         return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n-                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE)));\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG)),\n+                                 false);\n+    }\n+    \n+    public ModelMetaData generateInputModel(WorkflowProcess process) {", "originalCommit": "4757140ed04032d84bbf1890a22df179a66f81d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5NTUzMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376395532", "bodyText": "done", "author": "mswiderski", "createdAt": "2020-02-07T13:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NTQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NTU5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376375591", "bodyText": "maybe we can move this method entirely to OutputModelClassGenerator ?", "author": "evacchi", "createdAt": "2020-02-07T12:55:12Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ProcessToExecModelGenerator.java", "diffHunk": "@@ -155,7 +156,26 @@ public ModelMetaData generateModel(WorkflowProcess process) {\n         String name = extractModelClassName(process.getId());\n \n         return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n-                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE)));\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG)),\n+                                 false);\n+    }\n+    \n+    public ModelMetaData generateInputModel(WorkflowProcess process) {\n+        String packageName = process.getPackageName();\n+        String name = extractModelClassName(process.getId()) + \"Input\";\n+\n+        return new ModelMetaData(process.getId(), packageName, name, process.getVisibility(),\n+                                 VariableDeclarations.of((VariableScope) ((org.jbpm.process.core.Process) process).getDefaultContext(VariableScope.VARIABLE_SCOPE), variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.OUTPUT_TAG)),\n+                                 true, \"/class-templates/ModelNoIDTemplate.java\");\n+    }\n+    \n+    public ModelMetaData generateOutputModel(WorkflowProcess process) {", "originalCommit": "4757140ed04032d84bbf1890a22df179a66f81d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5NTYwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376395601", "bodyText": "done", "author": "mswiderski", "createdAt": "2020-02-07T13:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM3NTU5MQ=="}], "type": "inlineReview"}, {"oid": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-07T13:41:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNzAwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376427008", "bodyText": "Just an idea, why not tu use lambda here as well since we introduced them in the other 2 methods...", "author": "MarianMacik", "createdAt": "2020-02-07T14:45:11Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/VariableDeclarations.java", "diffHunk": "@@ -26,6 +27,32 @@\n     public static VariableDeclarations of(VariableScope vscope) {\n         HashMap<String, String> vs = new HashMap<>();\n         for (Variable variable : vscope.getVariables()) {\n+            if (variable.hasTag(Variable.INTERNAL_TAG)) {\n+                continue;\n+            }\n+            \n+            vs.put(variable.getName(), variable.getType().getStringType());\n+        }\n+        return of(vs);", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MTI5MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376991290", "bodyText": "what would be the gain?", "author": "mswiderski", "createdAt": "2020-02-10T10:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNzAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNzI4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376427285", "bodyText": "Here we can use lambdas too, would be probably easier to read than continue.", "author": "MarianMacik", "createdAt": "2020-02-07T14:45:43Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/VariableDeclarations.java", "diffHunk": "@@ -26,6 +27,32 @@\n     public static VariableDeclarations of(VariableScope vscope) {\n         HashMap<String, String> vs = new HashMap<>();\n         for (Variable variable : vscope.getVariables()) {\n+            if (variable.hasTag(Variable.INTERNAL_TAG)) {\n+                continue;\n+            }\n+            \n+            vs.put(variable.getName(), variable.getType().getStringType());\n+        }\n+        return of(vs);\n+    }\n+    \n+    public static VariableDeclarations ofInput(VariableScope vscope) {\n+        \n+        return of(vscope, variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.OUTPUT_TAG));\n+    }\n+    \n+    public static VariableDeclarations ofOutput(VariableScope vscope) {\n+        \n+        return of(vscope, variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.INPUT_TAG));\n+    }\n+    \n+    public static VariableDeclarations of(VariableScope vscope, Predicate<Variable> filter) {\n+        HashMap<String, String> vs = new HashMap<>();\n+        for (Variable variable : vscope.getVariables()) {\n+            if (filter.test(variable)) {\n+                continue;\n+            }\n+            ", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MTE1Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376991153", "bodyText": "what would we gain by using another lambda?", "author": "mswiderski", "createdAt": "2020-02-10T10:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNzI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2MDIzNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377060236", "bodyText": "Consistency :) And avoidance of continue. But I am not saying it's wrong now.", "author": "MarianMacik", "createdAt": "2020-02-10T13:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNzI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyODE0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376428148", "bodyText": "This implies that we want variables which have internal or output tag. Can we at least change the name of the parameter in the of() method to filterOut? As the first time-reader it confused me for a while.", "author": "MarianMacik", "createdAt": "2020-02-07T14:47:14Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/VariableDeclarations.java", "diffHunk": "@@ -26,6 +27,32 @@\n     public static VariableDeclarations of(VariableScope vscope) {\n         HashMap<String, String> vs = new HashMap<>();\n         for (Variable variable : vscope.getVariables()) {\n+            if (variable.hasTag(Variable.INTERNAL_TAG)) {\n+                continue;\n+            }\n+            \n+            vs.put(variable.getName(), variable.getType().getStringType());\n+        }\n+        return of(vs);\n+    }\n+    \n+    public static VariableDeclarations ofInput(VariableScope vscope) {\n+        \n+        return of(vscope, variable -> variable.hasTag(Variable.INTERNAL_TAG) || variable.hasTag(Variable.OUTPUT_TAG));", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjA3OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992078", "bodyText": "parameter renamed", "author": "mswiderski", "createdAt": "2020-02-10T10:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyODE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyOTQxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376429414", "bodyText": "We can use the Variable.VARIABLE_TAGS constant here for customTags literal.", "author": "MarianMacik", "createdAt": "2020-02-07T14:49:36Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/AbstractCompositeNodeVisitor.java", "diffHunk": "@@ -68,9 +69,10 @@ protected void visitVariableScope(String contextNode, VariableScope variableScop\n                 if (!visitedVariables.add(variable.getName())) {\n                     continue;\n                 }\n+                String tags = (String) variable.getMetaData(\"customTags\");\n                 ClassOrInterfaceType variableType = new ClassOrInterfaceType(null, ObjectDataType.class.getSimpleName());\n                 ObjectCreationExpr variableValue = new ObjectCreationExpr(null, variableType, new NodeList<>(new StringLiteralExpr(variable.getType().getStringType())));\n-                addFactoryMethodWithArgs(contextNode, body, \"variable\", new StringLiteralExpr(variable.getName()), variableValue);\n+                addFactoryMethodWithArgs(contextNode, body, \"variable\", new StringLiteralExpr(variable.getName()), variableValue, new StringLiteralExpr(\"customTags\"), (tags != null ? new StringLiteralExpr(tags) : new NullLiteralExpr()));", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjEyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992129", "bodyText": "done", "author": "mswiderski", "createdAt": "2020-02-10T10:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyOTQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzMTM1OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376431358", "bodyText": "We can use the Variable.VARIABLE_TAGS constant here for customTags literal.", "author": "MarianMacik", "createdAt": "2020-02-07T14:53:00Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ProcessToExecModelGenerator.java", "diffHunk": "@@ -234,9 +254,10 @@ private void visitVariableScope(VariableScope variableScope, BlockStmt body, Set\n                 if (!visitedVariables.add(variable.getName())) {\n                     continue;\n                 }\n+                String tags = (String) variable.getMetaData(\"customTags\");\n                 ClassOrInterfaceType variableType = new ClassOrInterfaceType(null, ObjectDataType.class.getSimpleName());\n                 ObjectCreationExpr variableValue = new ObjectCreationExpr(null, variableType, new NodeList<>(new StringLiteralExpr(variable.getType().getStringType())));\n-                addFactoryMethodWithArgs(FACTORY_FIELD_NAME, body, \"variable\", new StringLiteralExpr(variable.getName()), variableValue);\n+                addFactoryMethodWithArgs(FACTORY_FIELD_NAME, body, \"variable\", new StringLiteralExpr(variable.getName()), variableValue, new StringLiteralExpr(\"customTags\"), tags != null ? new StringLiteralExpr(tags) : new NullLiteralExpr());", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjE1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992154", "bodyText": "done", "author": "mswiderski", "createdAt": "2020-02-10T10:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzMTM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTkwNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376439906", "bodyText": "Can tags be empty? The only way tags can be changed is either here or through setMetaData method. When setMetaData method is called with VARIABLE_TAGS name, tags are split and a map is populated. So when getTags method is called, tags cannot be empty, even if it was, doing splitting again would again produce an empty map. So I guess here we can just return tags and not do preprocessing again. Moreover, if I pass null to setMetaData, then getTags will produce NPE.", "author": "MarianMacik", "createdAt": "2020-02-07T15:08:41Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/Variable.java", "diffHunk": "@@ -93,4 +110,16 @@ public Object getMetaData(String name) {\n     public String toString() {\n         return this.name;\n     }\n+    \n+    public List<String> getTags() {\n+        if (tags.isEmpty() && this.metaData.containsKey(VARIABLE_TAGS)) {\n+            tags = Arrays.asList(metaData.get(VARIABLE_TAGS).toString().split(\",\"));\n+            \n+        }\n+        return tags;", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NDk0OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377064949", "bodyText": "Still holds, can you clarify?", "author": "MarianMacik", "createdAt": "2020-02-10T13:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NzI5MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377067290", "bodyText": "tags can be empty and in most of the cases will be empty. meta data can be given as one via setMetaData or it's done via the MetadataWrapper during bpmn2 parsing and it gets the metadata map and add data directly to that map. In such case it will need this extra processing.\n\nMoreover, if I pass null to setMetaData, then getTags will produce NPE.\n\nisn't this expected?", "author": "mswiderski", "createdAt": "2020-02-10T13:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA5NjAxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377096014", "bodyText": "Because I only saw one option how to set metadata, the double-processing was not clear to me. Thanks.\n\nisn't this expected?\n\nWell, you tell me if NPE is expected or not :) In general I think not, but if it's by design here, then OK. We could return empty list in case metaData.get(VARIABLE_TAGS) returns null.", "author": "MarianMacik", "createdAt": "2020-02-10T14:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzOTkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTI4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376971285", "bodyText": "I guess this should be of type $Type$Input as well? Also the if above it.", "author": "MarianMacik", "createdAt": "2020-02-10T10:14:49Z", "path": "kogito-codegen/src/main/resources/class-templates/ReactiveRestResourceTemplate.java", "diffHunk": "@@ -41,14 +41,14 @@\n     @POST()\n     @Produces(MediaType.APPLICATION_JSON)\n     @Consumes(MediaType.APPLICATION_JSON)    \n-    public CompletionStage<$Type$> createResource_$name$($Type$ resource) {\n+    public CompletionStage<$Type$Output> createResource_$name$($Type$Input resource) {\n         if (resource == null) {\n             resource = new $Type$();\n         }\n         final $Type$ value = resource;", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjE5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992198", "bodyText": "done", "author": "mswiderski", "createdAt": "2020-02-10T10:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NDY1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376974652", "bodyText": "Maybe rename to *WithReadOnlyVariableTags", "author": "MarianMacik", "createdAt": "2020-02-10T10:21:32Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,129 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MzA3MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376993071", "bodyText": "renamed", "author": "mswiderski", "createdAt": "2020-02-10T10:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTE4NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376975184", "bodyText": "But here they are exposed on the model. See assertNotNull.", "author": "MarianMacik", "createdAt": "2020-02-10T10:22:35Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,129 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-readonly-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        \n+        Field approverField = resourceClazz.getDeclaredField(\"approver\");\n+        assertThat(approverField).isNotNull();\n+        assertThat(approverField.getType().getCanonicalName()).isEqualTo(String.class.getCanonicalName());\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"john\");\n+        m.fromMap(parameters);\n+        \n+        \n+        ProcessInstance processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+        \n+        final Model updates = p.createModel();\n+        parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"mary\");\n+        updates.fromMap(parameters);\n+        // updating readonly variable should fail\n+        assertThrows(VariableViolationException.class, () -> processInstance.updateVariables(updates));\n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+    \n+    @Test\n+    public void testApprovalWithInternalVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-internal-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        // internal variables are not exposed on the model\n+        assertThrows(NoSuchFieldException.class, () -> resourceClazz.getDeclaredField(\"approver\"));\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+\n+    @Test\n+    public void testApprovalWithRequiredVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-required-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        assertThrows(VariableViolationException.class, () -> {\n+            ProcessInstance<?> processInstance = p.createInstance(m);\n+            processInstance.start();\n+        });\n+ \n+    } \n+    \n+    @Test\n+    public void testApprovalWithIOVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-io-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> modelClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(modelClazz);\n+        // internal variables are not exposed on the model", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjU4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992586", "bodyText": "what do you mean? internal should not be exposed on model at all", "author": "mswiderski", "createdAt": "2020-02-10T10:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2Mjg3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377062877", "bodyText": "I meant\nassertNotNull(modelClazz.getDeclaredField(\"decision\"));\nassertNotNull(modelClazz.getDeclaredField(\"approver\"));\n\nSo the comment was misleading.", "author": "MarianMacik", "createdAt": "2020-02-10T13:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NTIxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r377065217", "bodyText": "comment is removed now", "author": "mswiderski", "createdAt": "2020-02-10T13:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTY2MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376975660", "bodyText": "Probably bad comment here?", "author": "MarianMacik", "createdAt": "2020-02-10T10:23:31Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,129 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-readonly-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        \n+        Field approverField = resourceClazz.getDeclaredField(\"approver\");\n+        assertThat(approverField).isNotNull();\n+        assertThat(approverField.getType().getCanonicalName()).isEqualTo(String.class.getCanonicalName());\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"john\");\n+        m.fromMap(parameters);\n+        \n+        \n+        ProcessInstance processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+        \n+        final Model updates = p.createModel();\n+        parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"mary\");\n+        updates.fromMap(parameters);\n+        // updating readonly variable should fail\n+        assertThrows(VariableViolationException.class, () -> processInstance.updateVariables(updates));\n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+    \n+    @Test\n+    public void testApprovalWithInternalVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-internal-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        // internal variables are not exposed on the model\n+        assertThrows(NoSuchFieldException.class, () -> resourceClazz.getDeclaredField(\"approver\"));\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+\n+    @Test\n+    public void testApprovalWithRequiredVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-required-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        assertThrows(VariableViolationException.class, () -> {\n+            ProcessInstance<?> processInstance = p.createInstance(m);\n+            processInstance.start();\n+        });\n+ \n+    } \n+    \n+    @Test\n+    public void testApprovalWithIOVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-io-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> modelClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(modelClazz);\n+        // internal variables are not exposed on the model\n+        assertNotNull(modelClazz.getDeclaredField(\"decision\"));\n+        assertNotNull(modelClazz.getDeclaredField(\"approver\"));\n+        \n+        Class<?> inputModelClazz = Class.forName(\"org.acme.travels.ApprovalsModelInput\", true, testClassLoader());\n+        assertNotNull(inputModelClazz);\n+        // internal variables are not exposed on the model", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjYzMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992632", "bodyText": "removed", "author": "mswiderski", "createdAt": "2020-02-10T10:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTc0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376975744", "bodyText": "Same here.", "author": "MarianMacik", "createdAt": "2020-02-10T10:23:39Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/tests/UserTaskTest.java", "diffHunk": "@@ -675,4 +677,129 @@ public void testBasicUserTaskProcessClaimReleaseClaimAndCompletePhases() throws\n         processInstance.abort();\n         assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_ABORTED);\n     }\n+    \n+    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+    @Test\n+    public void testApprovalWithVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-readonly-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        \n+        Field approverField = resourceClazz.getDeclaredField(\"approver\");\n+        assertThat(approverField).isNotNull();\n+        assertThat(approverField.getType().getCanonicalName()).isEqualTo(String.class.getCanonicalName());\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"john\");\n+        m.fromMap(parameters);\n+        \n+        \n+        ProcessInstance processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+        \n+        final Model updates = p.createModel();\n+        parameters = new HashMap<>();\n+        parameters.put(\"approver\", \"mary\");\n+        updates.fromMap(parameters);\n+        // updating readonly variable should fail\n+        assertThrows(VariableViolationException.class, () -> processInstance.updateVariables(updates));\n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+    \n+    @Test\n+    public void testApprovalWithInternalVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-internal-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> resourceClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(resourceClazz);\n+        // internal variables are not exposed on the model\n+        assertThrows(NoSuchFieldException.class, () -> resourceClazz.getDeclaredField(\"approver\"));\n+        \n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        processInstance.start();\n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE, processInstance.status()); \n+\n+        processInstance.abort();\n+        \n+        assertEquals(org.kie.api.runtime.process.ProcessInstance.STATE_ABORTED, processInstance.status());\n+    } \n+\n+    @Test\n+    public void testApprovalWithRequiredVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-required-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"approvals\");\n+        \n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        \n+        assertThrows(VariableViolationException.class, () -> {\n+            ProcessInstance<?> processInstance = p.createInstance(m);\n+            processInstance.start();\n+        });\n+ \n+    } \n+    \n+    @Test\n+    public void testApprovalWithIOVariableTags() throws Exception {\n+        \n+        Application app = generateCodeProcessesOnly(\"usertask/approval-with-io-variable-tags.bpmn2\");        \n+        assertThat(app).isNotNull();\n+                \n+        Class<?> modelClazz = Class.forName(\"org.acme.travels.ApprovalsModel\", true, testClassLoader());\n+        assertNotNull(modelClazz);\n+        // internal variables are not exposed on the model\n+        assertNotNull(modelClazz.getDeclaredField(\"decision\"));\n+        assertNotNull(modelClazz.getDeclaredField(\"approver\"));\n+        \n+        Class<?> inputModelClazz = Class.forName(\"org.acme.travels.ApprovalsModelInput\", true, testClassLoader());\n+        assertNotNull(inputModelClazz);\n+        // internal variables are not exposed on the model\n+        assertNotNull(inputModelClazz.getDeclaredField(\"approver\"));\n+        assertThrows(NoSuchFieldException.class, () -> inputModelClazz.getDeclaredField(\"decision\"));\n+        assertThrows(NoSuchFieldException.class, () -> inputModelClazz.getDeclaredField(\"id\"));\n+        \n+        Class<?> outputModelClazz = Class.forName(\"org.acme.travels.ApprovalsModelOutput\", true, testClassLoader());\n+        assertNotNull(outputModelClazz);\n+        // internal variables are not exposed on the model", "originalCommit": "a46477b97e01c7e9cd7ad5b483c826746fc4f4d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk5MjY3MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/303#discussion_r376992670", "bodyText": "removed", "author": "mswiderski", "createdAt": "2020-02-10T10:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3NTc0NA=="}], "type": "inlineReview"}, {"oid": "ee00a1a1335f6cefd2d94d0fce3dd0e9c4cdaa3f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ee00a1a1335f6cefd2d94d0fce3dd0e9c4cdaa3f", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-10T10:54:52Z", "type": "forcePushed"}, {"oid": "c8a625002e355c93bb126fc69512ef6f319e8ff0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c8a625002e355c93bb126fc69512ef6f319e8ff0", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-10T10:57:10Z", "type": "forcePushed"}, {"oid": "921750be0d807e4ac3f69035e951e149c6b9d62d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/921750be0d807e4ac3f69035e951e149c6b9d62d", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-11T12:02:34Z", "type": "commit"}, {"oid": "921750be0d807e4ac3f69035e951e149c6b9d62d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/921750be0d807e4ac3f69035e951e149c6b9d62d", "message": "KOGITO-19 - Tagging of process variables", "committedDate": "2020-02-11T12:02:34Z", "type": "forcePushed"}]}