{"pr_number": 750, "pr_title": "[KOGITO-3297] Bump CloudEvents api to 2.x", "pr_createdAt": "2020-09-08T14:43:29Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/750", "timeline": [{"oid": "bc9b84403ac2ef1ac192d6986c8479c8de491dab", "url": "https://github.com/kiegroup/kogito-runtimes/commit/bc9b84403ac2ef1ac192d6986c8479c8de491dab", "message": "[KOGITO-3297] Bump CloudEvents api to 2.x\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-08T19:22:48Z", "type": "forcePushed"}, {"oid": "5383338bebcb72ef140e6b3fa85b401e76980a1d", "url": "https://github.com/kiegroup/kogito-runtimes/commit/5383338bebcb72ef140e6b3fa85b401e76980a1d", "message": "[KOGITO-3297] Replace knativeEventingClass\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-08T20:27:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4NzYwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485187603", "bodyText": "I believe there are one more place:\nkogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java:235:        boolean useKnativeEventing = hasClassOnClasspath(project, \"org.kie.kogito.events.knative.ce.http.HttpRequestConverter\");\nDammit we need to refactor this ASAP @evacchi", "author": "ricardozanini", "createdAt": "2020-09-08T20:48:33Z", "path": "kogito-quarkus-extension/deployment/src/main/java/org/kie/kogito/quarkus/deployment/KogitoAssetsProcessor.java", "diffHunk": "@@ -104,7 +104,7 @@\n     private static final DotName persistenceFactoryClass = DotName.createSimple(\"org.kie.kogito.persistence.KogitoProcessInstancesFactory\");\n     private static final DotName metricsClass = DotName.createSimple(\"org.kie.kogito.monitoring.rest.MetricsResource\");\n     private static final DotName tracingClass = DotName.createSimple(\"org.kie.kogito.tracing.decision.DecisionTracingListener\");\n-    private static final DotName knativeEventingClass = DotName.createSimple(\"org.kie.kogito.events.knative.ce.http.HttpRequestConverter\");\n+    private static final DotName knativeEventingClass = DotName.createSimple(\"org.kie.kogito.events.knative.ce.extensions.KogitoProcessExtension\");", "originalCommit": "5383338bebcb72ef140e6b3fa85b401e76980a1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3OTA3NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485379075", "bodyText": "done", "author": "ruromero", "createdAt": "2020-09-09T06:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4NzYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NTkxMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485365911", "bodyText": "this is only fixing capitalization, right?", "author": "evacchi", "createdAt": "2020-09-09T06:24:43Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/extensions/KogitoProcessExtension.java", "diffHunk": "@@ -53,35 +53,35 @@\n                     PROCESS_INSTANCE_STATE, REF_ID));\n \n     private final Map<String, Object> innerValues;\n-    private String kogitoProcessinstanceId;\n-    private String kogitoRootProcessinstanceId;\n+    private String kogitoProcessInstanceId;", "originalCommit": "5383338bebcb72ef140e6b3fa85b401e76980a1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3NzQ2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485377468", "bodyText": "yes", "author": "ruromero", "createdAt": "2020-09-09T06:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NTkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjI3OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485366278", "bodyText": "new String ?", "author": "evacchi", "createdAt": "2020-09-09T06:25:25Z", "path": "addons/events/knative-eventing-addon/src/test/java/org/kie/kogito/events/knative/ce/CloudEventConverterTest.java", "diffHunk": "@@ -47,14 +48,12 @@ void verifyBasicCloudEventConversion() {\n                         .withData(payload.getBytes())\n                         .build();\n \n-        final String ceJson = CloudEventConverter.toJson(cloudEvent);\n-        assertThat(ceJson).isNotEmpty().contains(\"Oi Mundo!\");\n+        final String ceJson = new String(cloudEvent.getData());", "originalCommit": "5383338bebcb72ef140e6b3fa85b401e76980a1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3ODU4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r485378585", "bodyText": "Yes, the getData() method is a byte[] representing the String", "author": "ruromero", "createdAt": "2020-09-09T06:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgxMzU1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r486813552", "bodyText": "oh ok. you may want to pass in a charset encoding then", "author": "evacchi", "createdAt": "2020-09-11T06:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyNDMxOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487024319", "bodyText": "Actually this doesn't test anything. I have replaced it by a simple Json object", "author": "ruromero", "createdAt": "2020-09-11T12:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM2NjI3OA=="}], "type": "inlineReview"}, {"oid": "6b506a42b907d5e9b48aff1c29bf09434f8d5b40", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6b506a42b907d5e9b48aff1c29bf09434f8d5b40", "message": "[KOGITO-3297] Bump CloudEvents api to 2.x\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-10T16:06:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487856905", "bodyText": "I don't think we should \"hide\" a serialization exception in an empty result. What about propagate the exception?", "author": "danielezonca", "createdAt": "2020-09-14T12:00:43Z", "path": "addons/tracing/tracing-decision-api/src/main/java/org/kie/kogito/tracing/decision/event/CloudEventUtils.java", "diffHunk": "@@ -21,31 +21,53 @@\n import java.net.URLEncoder;\n import java.nio.charset.StandardCharsets;\n \n-import com.fasterxml.jackson.core.type.TypeReference;\n-import io.cloudevents.json.Json;\n-import io.cloudevents.v1.CloudEventBuilder;\n-import io.cloudevents.v1.CloudEventImpl;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.cloudevents.CloudEvent;\n+import io.cloudevents.core.builder.CloudEventBuilder;\n+import io.cloudevents.jackson.JsonFormat;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class CloudEventUtils {\n \n-    public static <E> CloudEventImpl<E> build(String id,\n-                                              URI source,\n-                                              E data,\n-                                              Class<E> dataType) {\n-        return CloudEventBuilder.<E>builder()\n+    private static final Logger LOG = LoggerFactory.getLogger(CloudEventUtils.class);\n+    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper().registerModule(JsonFormat.getCloudEventJacksonModule());\n+\n+    public static <E> CloudEvent build(String id,\n+                                       URI source,\n+                                       E data,\n+                                       Class<E> dataType) {\n+        byte[] bytes = null;\n+        try {\n+            bytes = OBJECT_MAPPER.writeValueAsBytes(data);\n+        } catch (JsonProcessingException e) {\n+            LOG.error(\"Unable to serialize CloudEvent data\", e);\n+        }\n+        return CloudEventBuilder.v1()\n                 .withType(dataType.getName())\n                 .withId(id)\n                 .withSource(source)\n-                .withData(data)\n+                .withData(bytes)\n                 .build();", "originalCommit": "f1c512f41b7f0d76e582295dd02b512952b5fe90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3Mzk1NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487873955", "bodyText": "Propagate the exception up to where? I need advise here", "author": "ruromero", "createdAt": "2020-09-14T12:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkzMTczNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487931735", "bodyText": "@kostola\nCan you please support? What if an event is impossible to be serialized? (same question for comment below)", "author": "danielezonca", "createdAt": "2020-09-14T13:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NDE2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r489464166", "bodyText": "With the previous API the data field was typed, so there's no particular error handling for serialization errors.\nImho sending a CloudEvent with null data, as I see here, is not very useful. I would avoid that.\nI would rather log a more detailed error (possibly with the payload that triggered the error somehow) so that in a production environment it's possible to investigate by grabbing the logs of the services.\nWdyt @danielezonca @ruromero ?", "author": "kostola", "createdAt": "2020-09-16T14:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0MTg2Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r489741863", "bodyText": "Fine for me a more detailed log but what else? Error propagation until where?", "author": "danielezonca", "createdAt": "2020-09-16T20:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNjkwMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r490036902", "bodyText": "I would catch the exception, log the message without sending a CloudEvent with null data and then that's it in the code. It seems to me a very rare error but correct me if I'm wrong.\nThen the best way imho to catch those errors in a prod environment would be to setup a log management system (e.g. Graylog) that ingests all the logs and allows custom triggers on specific messages to be configured.\nDoes this seem reasonable to you?", "author": "kostola", "createdAt": "2020-09-17T07:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4OTIwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r490089208", "bodyText": "Probably the best solution for this method would be to return a Optional<CloudEvent> and let the caller decide how to handle the serialization failure with something like ifPresentOrElse (which in my case would be to simply log the error without sending anything as I wrote above).", "author": "kostola", "createdAt": "2020-09-17T09:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MDM5Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r490090397", "bodyText": "@ruromero\nCan you please verify if the proposed approach can be implemented? Return Optional and log error in caller if empty", "author": "danielezonca", "createdAt": "2020-09-17T09:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczOTQ4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r490739486", "bodyText": "@kostola logging the payload won't be of much help as it is an array of bytes representing anything (a Json object, a String, a serialized object in any language, etc.). In this case we expect an object of type E but if decoding failed you don't know how to represent the data content.\nI think the log is fine as it is. It's an error saying the CloudEvent data cannot be deserialized with the stacktrace.\nRegarding the Optional propagation. There are 2 chains of invocations:\n\nBaseModelEventEmitter#publishDecisionModels. In this case it's simple, we decide whether to emit the event or not.\nDefaultAggregator#aggregate: There are 2 invocations and for these cases the event is always created right before the invocation so it doesn't make sense to expect an error. If for some reason such error occurs I will throw an unchecked exception.", "author": "ruromero", "createdAt": "2020-09-18T06:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NjkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NzIzMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487857231", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-09-14T12:01:18Z", "path": "addons/tracing/tracing-decision-api/src/main/java/org/kie/kogito/tracing/decision/event/CloudEventUtils.java", "diffHunk": "@@ -21,31 +21,53 @@\n import java.net.URLEncoder;\n import java.nio.charset.StandardCharsets;\n \n-import com.fasterxml.jackson.core.type.TypeReference;\n-import io.cloudevents.json.Json;\n-import io.cloudevents.v1.CloudEventBuilder;\n-import io.cloudevents.v1.CloudEventImpl;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.cloudevents.CloudEvent;\n+import io.cloudevents.core.builder.CloudEventBuilder;\n+import io.cloudevents.jackson.JsonFormat;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n public class CloudEventUtils {\n \n-    public static <E> CloudEventImpl<E> build(String id,\n-                                              URI source,\n-                                              E data,\n-                                              Class<E> dataType) {\n-        return CloudEventBuilder.<E>builder()\n+    private static final Logger LOG = LoggerFactory.getLogger(CloudEventUtils.class);\n+    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper().registerModule(JsonFormat.getCloudEventJacksonModule());\n+\n+    public static <E> CloudEvent build(String id,\n+                                       URI source,\n+                                       E data,\n+                                       Class<E> dataType) {\n+        byte[] bytes = null;\n+        try {\n+            bytes = OBJECT_MAPPER.writeValueAsBytes(data);\n+        } catch (JsonProcessingException e) {\n+            LOG.error(\"Unable to serialize CloudEvent data\", e);\n+        }\n+        return CloudEventBuilder.v1()\n                 .withType(dataType.getName())\n                 .withId(id)\n                 .withSource(source)\n-                .withData(data)\n+                .withData(bytes)\n                 .build();\n     }\n \n-    public static <E> String encode(CloudEventImpl<E> event) {\n-        return Json.encode(event);\n+    public static String encode(CloudEvent event) {\n+        try {\n+            return OBJECT_MAPPER.writeValueAsString(event);\n+        } catch (JsonProcessingException e) {\n+            LOG.error(\"Unable to encode CloudEvent\", e);\n+            return null;\n+        }\n     }\n \n-    public static <E> CloudEventImpl<E> decode(String json, TypeReference<CloudEventImpl<E>> ref) {\n-        return Json.decodeValue(json, ref);\n+    public static CloudEvent decode(String json) {\n+        try {\n+            return OBJECT_MAPPER.readValue(json, CloudEvent.class);\n+        } catch (JsonProcessingException e) {\n+            LOG.error(\"Unable to decode CloudEvent\", e);\n+            return null;\n+        }", "originalCommit": "f1c512f41b7f0d76e582295dd02b512952b5fe90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3NTE2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/750#discussion_r487875164", "bodyText": "I tried to propagate it but I didn't know up to where or where to really deal with it. Any advise?", "author": "ruromero", "createdAt": "2020-09-14T12:33:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NzIzMQ=="}], "type": "inlineReview"}, {"oid": "e97b8c91f4670d50b4b5718ceb216dff33aa070f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e97b8c91f4670d50b4b5718ceb216dff33aa070f", "message": "Code review\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-14T13:21:39Z", "type": "forcePushed"}, {"oid": "0bcf321f425590ac2942ae23a2654175a9b03af0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0bcf321f425590ac2942ae23a2654175a9b03af0", "message": "[KOGITO-3297] Bump CloudEvents api to 2.x\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:49Z", "type": "commit"}, {"oid": "aeb29a765f40e30207dd5195b8acae7822316eef", "url": "https://github.com/kiegroup/kogito-runtimes/commit/aeb29a765f40e30207dd5195b8acae7822316eef", "message": "[KOGITO-3297] Remove TEXT_PLAIN\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "commit"}, {"oid": "ba1504c3e35bfaa46742cf571d4f2242d90b57a2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ba1504c3e35bfaa46742cf571d4f2242d90b57a2", "message": "[KOGITO-3297] Fix tests\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "commit"}, {"oid": "6ad271489fc40d99f06f6a57d4788a791411cd28", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6ad271489fc40d99f06f6a57d4788a791411cd28", "message": "Code review\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "commit"}, {"oid": "a33525383b7e322c7597ac5213735ce7f4fdc19a", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a33525383b7e322c7597ac5213735ce7f4fdc19a", "message": "[KOGITO-3297] Add missing setter\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "commit"}, {"oid": "321a01591c5c0b2d08099ff20565aaf34af9c369", "url": "https://github.com/kiegroup/kogito-runtimes/commit/321a01591c5c0b2d08099ff20565aaf34af9c369", "message": "[KOGITO-3297] Add index-dependency for tests\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "commit"}, {"oid": "3d2d52eb5373f13d57c00140c2525a86dd7482d7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3d2d52eb5373f13d57c00140c2525a86dd7482d7", "message": "[KOGITO-3297] Refactor cloudEvents serialization\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T07:26:51Z", "type": "forcePushed"}, {"oid": "24d6c18f10a5d1ff7373c4cfdc7fae8050605fa7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/24d6c18f10a5d1ff7373c4cfdc7fae8050605fa7", "message": "[KOGITO-3297] Refactor cloudEvents serialization\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T08:49:40Z", "type": "commit"}, {"oid": "24d6c18f10a5d1ff7373c4cfdc7fae8050605fa7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/24d6c18f10a5d1ff7373c4cfdc7fae8050605fa7", "message": "[KOGITO-3297] Refactor cloudEvents serialization\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-09-21T08:49:40Z", "type": "forcePushed"}]}