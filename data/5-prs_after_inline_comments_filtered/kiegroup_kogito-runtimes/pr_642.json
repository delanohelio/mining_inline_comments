{"pr_number": 642, "pr_title": "[KOGITO-2745] - Introducing CloudEvent processing through HTTP", "pr_createdAt": "2020-07-20T20:47:12Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/642", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkzNTQ5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r460935499", "bodyText": "we are keeping static \"constructor\" methods at the top", "author": "evacchi", "createdAt": "2020-07-27T14:33:35Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/ProcessCodegen.java", "diffHunk": "@@ -198,31 +219,6 @@ private static Process parseWorkflowFile(Resource r, String parser) {\n         }\n     }\n \n-    private String applicationCanonicalName;", "originalCommit": "e8420afd28b9332d484b16647928e15ac1e90676", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxMzk4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r461013986", "bodyText": "Dammit, my IDE changed this automatically. Are you using the Intellij profile for KIE or something like this?", "author": "ricardozanini", "createdAt": "2020-07-27T16:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkzNTQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMwMDc0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464300744", "bodyText": "actually no \ud83e\udd14 apparently I am, KIE Java Conventions", "author": "evacchi", "createdAt": "2020-08-03T09:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkzNTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0NzAwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r460947004", "bodyText": "minor nitpick (since this is a REST endpoint it's not a big deal) why does it need to be @PostConstruct ? can it be a plain constructor? (notice you can also use an anonymous constructor { ... })", "author": "evacchi", "createdAt": "2020-07-27T14:48:59Z", "path": "kogito-codegen/src/main/resources/class-templates/events/CloudEventListenerResource.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.kie.kogito.app;\n+\n+import io.cloudevents.CloudEvent;\n+import io.cloudevents.v1.AttributesImpl;\n+import io.cloudevents.v1.CloudEventImpl;\n+import org.eclipse.microprofile.reactive.messaging.Emitter;\n+import org.jboss.resteasy.spi.HttpRequest;\n+import org.kie.kogito.events.knative.ce.ExtMediaType;\n+import org.kie.kogito.events.knative.ce.RestEasyHttpRequestConverter;\n+\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+@Path(\"/\")\n+public class CloudEventListenerResource {\n+\n+    private RestEasyHttpRequestConverter httpRequestConverter = new RestEasyHttpRequestConverter();\n+\n+    private Map<String, Emitter<String>> emitters;\n+\n+    @javax.annotation.PostConstruct\n+    public void setup() {", "originalCommit": "e8420afd28b9332d484b16647928e15ac1e90676", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5OTM4OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r460999389", "bodyText": "I have to wait for CDI to inject the emitters, in the constructor I won't be able to do that, right?", "author": "ricardozanini", "createdAt": "2020-07-27T16:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0NzAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwMjg4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r461702882", "bodyText": "right. I am also wondering if it is possible to inject a map of emitters directly from smallrye, but I think it's not possible. anyway for REST endpoint it makes sense to use @PostCostruct", "author": "evacchi", "createdAt": "2020-07-28T16:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0NzAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4MDY4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r461780686", "bodyText": "I thought about having a list being injected, haven't tried, but I think we stick with PostConstruct in this scenarios being a REST endpoint. Thanks for the heads up \\o/", "author": "ricardozanini", "createdAt": "2020-07-28T18:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0NzAwNA=="}], "type": "inlineReview"}, {"oid": "8b04ab8ead80b5f92e4dbe0ec8830fcced11d202", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8b04ab8ead80b5f92e4dbe0ec8830fcced11d202", "message": "Reverting to smallrye types / utilities on knative-addon\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-07-27T21:11:24Z", "type": "forcePushed"}, {"oid": "fc327c03a6c386fc3b219c1950bf9c767b09730c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fc327c03a6c386fc3b219c1950bf9c767b09730c", "message": "Adjusting DataEvent for CE spec 1.0, playing around outcomming messages\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-07-29T21:29:37Z", "type": "forcePushed"}, {"oid": "178ceff006cd941b22072e9a5c69eb16856bbde5", "url": "https://github.com/kiegroup/kogito-runtimes/commit/178ceff006cd941b22072e9a5c69eb16856bbde5", "message": "Decorating CloudEvents outcoming messages\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-07-30T21:55:24Z", "type": "forcePushed"}, {"oid": "5412a149293edea28b65350bc9952f6cc0292de7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/5412a149293edea28b65350bc9952f6cc0292de7", "message": "Upgrade to CE SDK 2.x, fix source and type problem\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-07-31T23:22:30Z", "type": "forcePushed"}, {"oid": "21a23047cbd1289160f308e1ff8c736e29815951", "url": "https://github.com/kiegroup/kogito-runtimes/commit/21a23047cbd1289160f308e1ff8c736e29815951", "message": "Cleaning up smell code\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-03T15:48:14Z", "type": "forcePushed"}, {"oid": "fc147855588b54d94c791c230832ba72f2714954", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fc147855588b54d94c791c230832ba72f2714954", "message": "[KOGITO-2745] - Introducing CloudEvent processing over HTTP\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-03T21:40:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4Nzk2MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464787960", "bodyText": "@ricardozanini cant we reuse the ProcessInstanceDataEvent as it seems to be the exact same event?", "author": "cristianonicolai", "createdAt": "2020-08-04T04:12:20Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/extensions/KogitoProcessExtension.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package org.kie.kogito.events.knative.ce.extensions;\n+\n+import io.cloudevents.CloudEventExtensions;\n+import io.cloudevents.Extension;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+// The size of this extension could be reevaluated since we could make use of `type`, `source` and `subject` for processId, referenceId and instanceState\n+\n+/**\n+ * CloudEvent extension for Kogito Process.\n+ */\n+public class KogitoProcessExtension implements Extension {", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2OTg2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464969864", "bodyText": "This is an extension to process CE with the SDK, but yeah I think I got it. You say to extend ProcessInstanceDataEvent here? That makes sense :D", "author": "ricardozanini", "createdAt": "2020-08-04T11:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4Nzk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3MTE3Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465071176", "bodyText": "Actually is the ProcessInstanceEventBody and it's not the same thing. I think we can revisit this upon the cloudevent processing refactoring.", "author": "ricardozanini", "createdAt": "2020-08-04T13:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4Nzk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODEwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464788101", "bodyText": "missing headers :D", "author": "cristianonicolai", "createdAt": "2020-08-04T04:12:54Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/extensions/KogitoProcessExtension.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package org.kie.kogito.events.knative.ce.extensions;", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk2OTk5Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464969996", "bodyText": "\ud83e\udd26", "author": "ricardozanini", "createdAt": "2020-08-04T11:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODUzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464788534", "bodyText": "small comment to perhaps use import static for most use of Assertions", "author": "cristianonicolai", "createdAt": "2020-08-04T04:14:34Z", "path": "addons/events/knative-eventing-addon/src/test/java/org/kie/kogito/events/knative/ce/http/ResponsesTest.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.kie.kogito.events.knative.ce.http;\n+\n+import org.assertj.core.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import javax.ws.rs.core.Response;\n+\n+class ResponsesTest {\n+\n+    @Test\n+    void errorProcessingCloudEvent() {\n+        final Response response = Responses.errorProcessingCloudEvent(new IllegalArgumentException(\"Fail!\"));\n+        Assertions.assertThat(response).isNotNull();", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3MDE5Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464970192", "bodyText": "Now I learned how to import them automatically with my IDE, will do it.", "author": "ricardozanini", "createdAt": "2020-08-04T11:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODc4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464788780", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String datacontenttype;\n          \n          \n            \n                private String dataContentType;", "author": "cristianonicolai", "createdAt": "2020-08-04T04:15:27Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/event/AbstractDataEvent.java", "diffHunk": "@@ -29,14 +29,30 @@\n  */\n public abstract class AbstractDataEvent<T> implements DataEvent<T> {\n \n-    private static final String SPEC_VERSION = \"0.3\";\n-\n+    /**\n+     * String prefix for Kogito CloudEvents type fields.\n+     * Since this is a required field, the constructor will fill them with this default value.\n+     * Ideally, callers would use #TYPE_FORMAT to fill this field using the process name and the signal node name, e.g: process.travelagency.visaapproved\n+     */\n+    public static final String TYPE_PREFIX = \"process\";\n+    public static final String TYPE_FORMAT = TYPE_PREFIX + \".%s.%s\";\n+    /**\n+     * String format for Kogito CloudEvents source fields.\n+     * Since this is a required field, the constructor will fill them with default value, e.g.: /process/travelAgency/0982-1223-3121-1212\n+     */\n+    public static final String SOURCE_FORMAT = \"/process/%s/%s\";\n+    private static final String SPEC_VERSION = \"1.0\";\n     private String specversion;\n     private String id;\n     private String source;\n     private String type;\n     private String time;\n+    private String subject;\n+    private String datacontenttype;", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk3MDU4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464970585", "bodyText": "I'm using lower case to not clash with JSON unmarshalling. Since we can't use Jackson annotations. Or can we?", "author": "ricardozanini", "createdAt": "2020-08-04T11:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQzNzMxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465437317", "bodyText": "we are using Jackson as the default serialization anyway, I don't see a problem with that.", "author": "cristianonicolai", "createdAt": "2020-08-05T02:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxOTU3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465519577", "bodyText": "If you use Jackson, I would suggest to be a bit more verbose and use @JsonProperty. In some months somebody will see that the variable is all lower case and will change it, changing the implicit contract as well. Maybe it's just me, but I always have had very bad opinion on that dangerous Jackson behaviour :)", "author": "r00ta", "createdAt": "2020-08-05T07:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5MjAxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465692012", "bodyText": "Ok, I'll add the Jackson annotations to this class to make sure we don't mess it up.", "author": "ricardozanini", "createdAt": "2020-08-05T12:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODgyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r464788820", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String dataschema;\n          \n          \n            \n                private String dataSchema;", "author": "cristianonicolai", "createdAt": "2020-08-04T04:15:37Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/event/AbstractDataEvent.java", "diffHunk": "@@ -29,14 +29,30 @@\n  */\n public abstract class AbstractDataEvent<T> implements DataEvent<T> {\n \n-    private static final String SPEC_VERSION = \"0.3\";\n-\n+    /**\n+     * String prefix for Kogito CloudEvents type fields.\n+     * Since this is a required field, the constructor will fill them with this default value.\n+     * Ideally, callers would use #TYPE_FORMAT to fill this field using the process name and the signal node name, e.g: process.travelagency.visaapproved\n+     */\n+    public static final String TYPE_PREFIX = \"process\";\n+    public static final String TYPE_FORMAT = TYPE_PREFIX + \".%s.%s\";\n+    /**\n+     * String format for Kogito CloudEvents source fields.\n+     * Since this is a required field, the constructor will fill them with default value, e.g.: /process/travelAgency/0982-1223-3121-1212\n+     */\n+    public static final String SOURCE_FORMAT = \"/process/%s/%s\";\n+    private static final String SPEC_VERSION = \"1.0\";\n     private String specversion;\n     private String id;\n     private String source;\n     private String type;\n     private String time;\n+    private String subject;\n+    private String datacontenttype;\n+    private String dataschema;", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3NDE5Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465074196", "bodyText": "Same thing.", "author": "ricardozanini", "createdAt": "2020-08-04T14:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA5NDg1Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465094857", "bodyText": "See above.", "author": "ricardozanini", "createdAt": "2020-08-04T14:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4ODgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA1MTU4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465051585", "bodyText": "Is it really mutually exclusive? I mean, can't we have both at the same time, in the same project we may have one or N processes where we cloud have cloud events being received through kafka in some topic and other events using the HTTP endpoint?", "author": "tiagodolphine", "createdAt": "2020-08-04T13:31:09Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/ProcessCodegen.java", "diffHunk": "@@ -379,21 +381,33 @@ public ProcessCodegen withClassLoader(ClassLoader projectClassLoader) {\n                                 applicationCanonicalName,\n                                 msgDataEventGenerator.className(),\n                                 trigger)\n-                                .withDependencyInjection(annotator));\n+                                         .withDependencyInjection(annotator));\n                     } else if (trigger.getType().equals(TriggerMetaData.TriggerType.ProduceMessage)) {\n \n                         MessageDataEventGenerator msgDataEventGenerator = new MessageDataEventGenerator(workFlowProcess,\n-                                trigger)\n+                                                                                                        trigger)\n                                 .withDependencyInjection(annotator);\n                         mdegs.add(msgDataEventGenerator);\n \n-                        mpgs.add(new MessageProducerGenerator(\n-                                workFlowProcess,\n-                                modelClassGenerator.className(),\n-                                execModelGen.className(),\n-                                msgDataEventGenerator.className(),\n-                                trigger)\n-                                .withDependencyInjection(annotator));\n+                        // this is not cool, we should have a way to process addons\n+                        // generators without adding conditions to the main generators\n+                        if (addonsConfig.useKnativeEventing()) {\n+                            mpgs.add(new CloudEventsMessageProducerGenerator(\n+                                    workFlowProcess,\n+                                    modelClassGenerator.className(),\n+                                    execModelGen.className(),\n+                                    msgDataEventGenerator.className(),\n+                                    trigger)\n+                                             .withDependencyInjection(annotator));\n+                        } else {\n+                            mpgs.add(new MessageProducerGenerator(", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3NzcwMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465077701", "bodyText": "It was at first, I had to change because of this:\n\nFirst integration tests are OK. We can send CloudEvent messages to a given process through HTTP, having the correct headers. Outcoming is a problem right now since smallrye-http does not add Content-Type. Also the producer are ignoring type and source, unfortunately they are required by the spec. The target service are rejecting our produced events.\n\nThis should go away once Smallrye upgrades their CE SDK and add support to it. For now, we are producing string messages, which smallrye does not know how to process it. We need to decorate the message first, there are some changes in the producer template that would be easier and cleaner doing this away. I'm not happy with this condition either, but with the codegen refactoring + smallrye update we should be able to address this problem in the near future.", "author": "ricardozanini", "createdAt": "2020-08-04T14:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA1MTU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MTQ2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465061466", "bodyText": "can't we keep just one template for MessageProducer? I mean instead of CloudEventsMessageProducerTemplate.java and MessageProducerTemplate.java centralize just in one? they seem to be quite similar.", "author": "tiagodolphine", "createdAt": "2020-08-04T13:46:24Z", "path": "kogito-codegen/src/main/resources/class-templates/events/CloudEventsMessageProducerTemplate.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.myspace.demo;\n+\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.util.StdDateFormat;\n+import org.kie.api.runtime.process.ProcessInstance;\n+import org.kie.kogito.events.knative.ce.decorators.Decorator;\n+import org.kie.kogito.events.knative.ce.decorators.DecoratorFactory;\n+import org.kie.kogito.services.event.DataEventAttrBuilder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.TimeZone;\n+\n+public class MessageProducer {", "originalCommit": "fc147855588b54d94c791c230832ba72f2714954", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA3ODI4Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465078287", "bodyText": "See my reply above :p\nThey have the decorator instance to handle the messages to a CloudEvent subscriber and also the CloudEvent POJO is different, we are now filling type and source, which were not in the other template. I don't know what kind of side effects that could bring to older implementations/examples, so it would be better to leave the old template as is to avoid that.\nWe have plans to refactor the whole CloudEvent processing in the core in the short term, this way we will get rid of all this DataEvent thing to stay with CloudEvents SDK only. Then we will be committed with the spec.", "author": "ricardozanini", "createdAt": "2020-08-04T14:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MTQ2Ng=="}], "type": "inlineReview"}, {"oid": "8d8c649de4621f86052b328696017674f1f60ca2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8d8c649de4621f86052b328696017674f1f60ca2", "message": "Review comments\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-04T14:27:16Z", "type": "forcePushed"}, {"oid": "9b1c546440ea0cbc4b68873a0e7a9fb0cef2e853", "url": "https://github.com/kiegroup/kogito-runtimes/commit/9b1c546440ea0cbc4b68873a0e7a9fb0cef2e853", "message": "Review comments\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-04T19:44:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMzk3NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465513974", "bodyText": "licence everywhere?", "author": "r00ta", "createdAt": "2020-08-05T06:58:44Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/CloudEventConverter.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.kie.kogito.events.knative.ce;", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NTM1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465695352", "bodyText": "It's very weird to me having to add the license manually. I though we had a script to do that :/\nMaybe we could use the same one we use in the operator.", "author": "ricardozanini", "createdAt": "2020-08-05T12:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMzk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3MjczNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r466072736", "bodyText": "yeah that would be good, but you can set up the IDE to do that for you :)", "author": "cristianonicolai", "createdAt": "2020-08-06T00:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMzk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNDk0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465514944", "bodyText": "Very minor comment: what about a less generic name like MessageDecorator?", "author": "r00ta", "createdAt": "2020-08-05T07:00:46Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/decorators/Decorator.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package org.kie.kogito.events.knative.ce.decorators;\n+\n+import org.eclipse.microprofile.reactive.messaging.Message;\n+\n+/**\n+ * {@link Decorator}s decorates the {@link Message} envelope with metadata and additional information in a given context.\n+ */\n+public interface Decorator {", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NTU4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465695580", "bodyText": "I like it.", "author": "ricardozanini", "createdAt": "2020-08-05T12:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNDk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMTk4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465521982", "bodyText": "suggestion for future improvement. If I understand correctly this is only used in templates; so, could we avoid the run-time classpath inspection, and instead perform it at compile-time? i.e., replace a placeholder in the template with the \"right\" code branch?", "author": "evacchi", "createdAt": "2020-08-05T07:16:02Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/decorators/DecoratorFactory.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.kie.kogito.events.knative.ce.decorators;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Decorator Factory\n+ */\n+public final class DecoratorFactory {\n+\n+    private static final String SMALLRYE_HTTP_METADATA_CLASS = \"io.smallrye.reactive.messaging.http.HttpResponseMetadata\";\n+\n+    private DecoratorFactory() {\n+    }\n+\n+    /**\n+     * Builds a new {@link Decorator} depending on the implementation being presented in the classpath.\n+     *\n+     * @return an {@link Optional} instance of {@link Decorator}\n+     */\n+    public static Optional<Decorator> newInstance() {\n+        try {\n+            Class.forName(SMALLRYE_HTTP_METADATA_CLASS, false, DecoratorFactory.class.getClassLoader());", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODgxNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465698816", "bodyText": "The idea is to use the same Template for Spring and Quarkus, so the decorator would return the right decorator. Or event we can use for different scenarios where different decorators might be used. That's why I created a factory for it. wdyt?", "author": "ricardozanini", "createdAt": "2020-08-05T12:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMTk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjMxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465522312", "bodyText": "link to PR/JIRA ?", "author": "evacchi", "createdAt": "2020-08-05T07:16:41Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/http/ExtMediaType.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package org.kie.kogito.events.knative.ce.http;\n+\n+import javax.ws.rs.core.MediaType;\n+\n+/**\n+ * Extends {@link MediaType} to CloudEvents support\n+ */\n+// this shouldn't be provided by the CE SDK? Send a PR.", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5OTEwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465699108", "bodyText": "I need to send a PR to CE SDK.", "author": "ricardozanini", "createdAt": "2020-08-05T12:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNTAxMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465525011", "bodyText": "nothing in contrary with the change, but just wondering why is it necessary?", "author": "evacchi", "createdAt": "2020-08-05T07:22:08Z", "path": "addons/events/kogito-events-reactive-messaging-addon/src/main/java/org/kie/kogito/events/rm/ReactiveMessagingEventPublisher.java", "diffHunk": "@@ -32,8 +32,8 @@\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.StdDateFormat;\n \n-import io.smallrye.reactive.messaging.annotations.Channel;\n-import io.smallrye.reactive.messaging.annotations.Emitter;\n+import org.eclipse.microprofile.reactive.messaging.Channel;\n+import org.eclipse.microprofile.reactive.messaging.Emitter;", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5OTcxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465699712", "bodyText": "The SmallRye annotations have been deprecated, and we can't decorate the message with the old annotations since we don't have the right  send signature.", "author": "ricardozanini", "createdAt": "2020-08-05T12:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNTAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczMzYwOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465733609", "bodyText": "good, thanks for the explanation :)", "author": "evacchi", "createdAt": "2020-08-05T13:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNzY3Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465527673", "bodyText": "agreed :) add a link to a JIRA maybe? KOGITO-1767 Propose mechanism to extend codegen with addons has sat there for quite a while", "author": "evacchi", "createdAt": "2020-08-05T07:27:24Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/ProcessCodegen.java", "diffHunk": "@@ -379,21 +381,33 @@ public ProcessCodegen withClassLoader(ClassLoader projectClassLoader) {\n                                 applicationCanonicalName,\n                                 msgDataEventGenerator.className(),\n                                 trigger)\n-                                .withDependencyInjection(annotator));\n+                                         .withDependencyInjection(annotator));\n                     } else if (trigger.getType().equals(TriggerMetaData.TriggerType.ProduceMessage)) {\n \n                         MessageDataEventGenerator msgDataEventGenerator = new MessageDataEventGenerator(workFlowProcess,\n-                                trigger)\n+                                                                                                        trigger)\n                                 .withDependencyInjection(annotator);\n                         mdegs.add(msgDataEventGenerator);\n \n-                        mpgs.add(new MessageProducerGenerator(\n-                                workFlowProcess,\n-                                modelClassGenerator.className(),\n-                                execModelGen.className(),\n-                                msgDataEventGenerator.className(),\n-                                trigger)\n-                                .withDependencyInjection(annotator));\n+                        // this is not cool, we should have a way to process addons\n+                        // generators without adding conditions to the main generators", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5OTgxNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465699815", "bodyText": "Added!", "author": "ricardozanini", "createdAt": "2020-08-05T12:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNzY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODQzNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465528437", "bodyText": "see here re: DecoratorFactory -- the check is already there", "author": "evacchi", "createdAt": "2020-08-05T07:29:00Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateModelMojo.java", "diffHunk": "@@ -232,11 +232,13 @@ private ApplicationGenerator createApplicationGenerator() throws IOException, Mo\n         boolean usePersistence = persistence || hasClassOnClasspath(project, \"org.kie.kogito.persistence.KogitoProcessInstancesFactory\");\n         boolean useMonitoring = hasClassOnClasspath(project, \"org.kie.kogito.monitoring.rest.MetricsResource\");\n         boolean useTracing = hasClassOnClasspath(project, \"org.kie.kogito.tracing.decision.DecisionTracingListener\");\n+        boolean useKnativeEventing = hasClassOnClasspath(project, \"org.kie.kogito.events.knative.ce.http.HttpRequestConverter\");", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDkwMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465700900", "bodyText": "But I need this check, otherwise the codegen wouldn't know if it's to generate the CloudEvent endpoint or not. Would generate only if the target project has the addon added in the pom dependencies.", "author": "ricardozanini", "createdAt": "2020-08-05T12:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNzE0Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465737142", "bodyText": "I think I have mixed-up the classes, but what I mean, is that with you may not need this runtime check:\nhttps://github.com/kiegroup/kogito-runtimes/pull/642/files/d807d67c7b0a4bb615d7167ed7474aad6952861b#diff-cfee6e94f3636c1de7a11f0169051616\nsince that class is only used in generated code, in your template substitution logic you can do something like (pseudo-code)\nif (smallryeOnClassPath())\n   wrappedInitializer(template)\nelse\n   plainInitializer(template)\n\nand move that logic from runtime to codegen time. Anyway, we can improve this further in a next iteration", "author": "evacchi", "createdAt": "2020-08-05T13:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk3MjEzOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465972138", "bodyText": "Oh, I replied to you in another comment why I'm not doing that: #642 (comment)\n:)\nThe idea is to have a decorator for every runtime/use case out there based on the infra code in the classpath. So for instance, I have kafka I would not decorate this way, but in another. Same for Spring. Using the same template, same codegen logic.\nBut of course we can discuss this further in the refactoring :D", "author": "ricardozanini", "createdAt": "2020-08-05T20:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2MDI2Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465560267", "bodyText": "There is already a similar class.\nPerhaps they could be consolidated at some point?", "author": "manstis", "createdAt": "2020-08-05T08:26:50Z", "path": "addons/events/knative-eventing-addon/src/main/java/org/kie/kogito/events/knative/ce/CloudEventConverter.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.kie.kogito.events.knative.ce;\n+\n+import io.cloudevents.CloudEvent;\n+import io.cloudevents.core.format.EventFormat;\n+import io.cloudevents.core.provider.EventFormatProvider;\n+import io.cloudevents.jackson.JsonFormat;\n+\n+/**\n+ * Simple utility class to convert from CloudEvents objects to a Json String.\n+ * Wraps invocation to the CE SDK, so we can safely change the inner implementation without impacting callers.\n+ */\n+public final class CloudEventConverter {\n+\n+    private static final EventFormat format = EventFormatProvider.getInstance().resolveFormat(JsonFormat.CONTENT_TYPE);\n+\n+    private CloudEventConverter() {\n+    }\n+\n+    public static String toJson(final CloudEvent cloudEvent) {", "originalCommit": "d807d67c7b0a4bb615d7167ed7474aad6952861b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMTUzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/642#discussion_r465701535", "bodyText": "You guys are using an old version of the SDK, which has generics in the CloudEvent interface. That's why I create this one. This should be part of the CloudEvent refactoring we are planning.", "author": "ricardozanini", "createdAt": "2020-08-05T12:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2MDI2Nw=="}], "type": "inlineReview"}, {"oid": "a4cb82001c100acc61b4cecca56aac56ff68dea0", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a4cb82001c100acc61b4cecca56aac56ff68dea0", "message": "[KOGITO-2745] - Introducing CloudEvent processing over HTTP\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T13:34:12Z", "type": "commit"}, {"oid": "d25910da358302685f5268caf0aa19e0baa40c5b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d25910da358302685f5268caf0aa19e0baa40c5b", "message": "Review comments\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T13:34:12Z", "type": "commit"}, {"oid": "043af1ec0f8d3d3db4286f64a464d7092902030e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/043af1ec0f8d3d3db4286f64a464d7092902030e", "message": "Cleaning up pom.xml\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T13:34:12Z", "type": "commit"}, {"oid": "27f116214724a78a44c5623d00feb45526e2a36a", "url": "https://github.com/kiegroup/kogito-runtimes/commit/27f116214724a78a44c5623d00feb45526e2a36a", "message": "Minor review changes and pom version update\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T13:34:12Z", "type": "commit"}, {"oid": "63b77af700a671e1d0c17b7df750c0cd43342a35", "url": "https://github.com/kiegroup/kogito-runtimes/commit/63b77af700a671e1d0c17b7df750c0cd43342a35", "message": "Adding JsonProperties to AbstractDataEvent\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T13:34:12Z", "type": "commit"}, {"oid": "822f02de87f810e8ac33c6971632b96f4517c410", "url": "https://github.com/kiegroup/kogito-runtimes/commit/822f02de87f810e8ac33c6971632b96f4517c410", "message": "Removing unnecessary dependencies for smallrye\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T14:50:14Z", "type": "commit"}, {"oid": "822f02de87f810e8ac33c6971632b96f4517c410", "url": "https://github.com/kiegroup/kogito-runtimes/commit/822f02de87f810e8ac33c6971632b96f4517c410", "message": "Removing unnecessary dependencies for smallrye\n\nSigned-off-by: Ricardo Zanini <zanini@redhat.com>", "committedDate": "2020-08-06T14:50:14Z", "type": "forcePushed"}]}