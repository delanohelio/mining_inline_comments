{"pr_number": 551, "pr_title": "[KOGITO-1063] Generate task schema for form rendering", "pr_createdAt": "2020-06-10T09:53:33Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/551", "timeline": [{"oid": "215613ed0c9c6e337e6d727732cbb70e7ee271ae", "url": "https://github.com/kiegroup/kogito-runtimes/commit/215613ed0c9c6e337e6d727732cbb70e7ee271ae", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-10T10:26:12Z", "type": "forcePushed"}, {"oid": "97f528ad27d7d949d928653e76c7e87a44bcc466", "url": "https://github.com/kiegroup/kogito-runtimes/commit/97f528ad27d7d949d928653e76c7e87a44bcc466", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-10T11:24:51Z", "type": "forcePushed"}, {"oid": "593f799c11a82af2245fa59e59c7ed7b97c6b6e6", "url": "https://github.com/kiegroup/kogito-runtimes/commit/593f799c11a82af2245fa59e59c7ed7b97c6b6e6", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-10T17:41:32Z", "type": "forcePushed"}, {"oid": "f3a468e2d37e399cd2793302173f808e32d00198", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f3a468e2d37e399cd2793302173f808e32d00198", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-10T20:32:47Z", "type": "forcePushed"}, {"oid": "079f3538958a7599eeeb4fc5ee4ff06b6d4e548b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/079f3538958a7599eeeb4fc5ee4ff06b6d4e548b", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T09:54:06Z", "type": "forcePushed"}, {"oid": "60072041efe83c8f23a263f6e60f8fbceb1f2b85", "url": "https://github.com/kiegroup/kogito-runtimes/commit/60072041efe83c8f23a263f6e60f8fbceb1f2b85", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T11:47:23Z", "type": "forcePushed"}, {"oid": "f1d2e4c8a99da5474a31f1c1e226cd611cf6c48e", "url": "https://github.com/kiegroup/kogito-runtimes/commit/f1d2e4c8a99da5474a31f1c1e226cd611cf6c48e", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T12:37:53Z", "type": "forcePushed"}, {"oid": "01e033774c10bdc857fd58031b942218b592c2fa", "url": "https://github.com/kiegroup/kogito-runtimes/commit/01e033774c10bdc857fd58031b942218b592c2fa", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T12:42:12Z", "type": "forcePushed"}, {"oid": "9f1d23009ad8852bf5931d9677dd248ecab095ed", "url": "https://github.com/kiegroup/kogito-runtimes/commit/9f1d23009ad8852bf5931d9677dd248ecab095ed", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T14:47:55Z", "type": "forcePushed"}, {"oid": "4082b609348baf9b26d48a97834cc2330c05e3de", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4082b609348baf9b26d48a97834cc2330c05e3de", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T15:30:10Z", "type": "forcePushed"}, {"oid": "291b3cbcaf39ed10de16a7165396696665df7996", "url": "https://github.com/kiegroup/kogito-runtimes/commit/291b3cbcaf39ed10de16a7165396696665df7996", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-11T17:12:48Z", "type": "forcePushed"}, {"oid": "a16695e6fe134002d320eee097fc8c145aae8ad8", "url": "https://github.com/kiegroup/kogito-runtimes/commit/a16695e6fe134002d320eee097fc8c145aae8ad8", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T12:26:09Z", "type": "forcePushed"}, {"oid": "882a38c9eb6e721a59a2338a1417b3d229c55cad", "url": "https://github.com/kiegroup/kogito-runtimes/commit/882a38c9eb6e721a59a2338a1417b3d229c55cad", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T13:19:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2NTg3Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440165877", "bodyText": "I think this should be true: REST is customizable so json schema should change too.\n@evacchi WDYT?", "author": "danielezonca", "createdAt": "2020-06-15T13:14:05Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/GeneratedFile.java", "diffHunk": "@@ -35,7 +35,8 @@\n         CLASS( false ),\n         MESSAGE_CONSUMER( false ),\n         MESSAGE_PRODUCER( false ),\n-        RESOURCE( false );\n+        RESOURCE(false),\n+        JSON_SCHEMA(false);", "originalCommit": "a16695e6fe134002d320eee097fc8c145aae8ad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE5MDc0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440190740", "bodyText": "Yes, need to review the current usage of this flag. Currently JsonSchema is not customizable, but in future it will be, so it makes sense to change this to true", "author": "fjtirado", "createdAt": "2020-06-15T13:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2NTg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440169012", "bodyText": "Is this actually possible?\nI think we should throw an exception in this case instead of mute the error.\nWdyt?", "author": "danielezonca", "createdAt": "2020-06-15T13:19:01Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JSonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+\n+public class JSonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+\n+    public JSonSchemaGenerator(Stream<Class<?>> stream) {\n+        this.stream = stream;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(this::isUserTaskClass).collect(Collectors.groupingBy(this::getKey));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    merged.setAll(read);\n+            }\n+            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            writer.writeValue(outputStream, merged);\n+            files.add(new GeneratedFile(Type.JSON_SCHEMA, entry.getKey() + \".json\", outputStream.toByteArray()));\n+        }\n+        return files;\n+    }\n+\n+\n+    private String getKey(Class<?> c) {\n+        return c.getAnnotation(UserTask.class).taskName();\n+    }\n+\n+    private boolean isUserTaskClass(Class<?> c) {\n+        return c.isAnnotationPresent(UserTask.class);\n+    }\n+\n+    private boolean isNotUserTaskParam(FieldScope fieldScope) {\n+        return !fieldScope.getDeclaringType().getErasedType().isAnnotationPresent(UserTask.class) || fieldScope.getAnnotation(UserTaskParam.class) == null;\n+    }\n+\n+    public static final Stream<Class<?>> getClassStream(Path parentPath, ClassLoader cl) throws IOException {\n+        return Files.walk(parentPath).filter(p -> p.toString().endsWith(\".class\")).map(parentPath::relativize).map(p -> {\n+            try {\n+                return cl.loadClass(getClassNameFromPath(p));\n+            } catch (ClassNotFoundException e) {\n+                return (Class<?>) null;", "originalCommit": "a16695e6fe134002d320eee097fc8c145aae8ad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE5MDE1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440190150", "bodyText": "Yes, you are right, a class file should contain a class that can be uploaded by the passed classloader.\nIn inicial implementation I was using a custom class loader that potentially might not found some of the classe, but this can be safely removed now.", "author": "fjtirado", "createdAt": "2020-06-15T13:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIyNDk4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440224983", "bodyText": "Hmmm, after a second thought, even if there is a mistmatch between the classloader and the path provided, I think is safer to silently ignore this (consequence being not schema is generated) rather than breaking the whole generation procedure. More opinions on that are welcome.", "author": "fjtirado", "createdAt": "2020-06-15T14:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMjgyNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441012825", "bodyText": "Is this phase considered as optional?\nWhat about add a property to GenerateJsonSchemaMojo like failsafe with true as default for now and propagate this option to JSonSchemaGenerator?\nIt could be overkill so up to you :)\nIn any case please add some logging information (warning or error level)", "author": "danielezonca", "createdAt": "2020-06-16T17:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODY2Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441108666", "bodyText": "Yes, this is smarter, I will do that", "author": "fjtirado", "createdAt": "2020-06-16T20:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxODMwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441418304", "bodyText": "Exception is now thrown from the lambda.\nAll exceptions are catched by Mojo and rethrown as MavenFailure (not MavenExecution), so it can be ignored using proper flags when invoking maven", "author": "fjtirado", "createdAt": "2020-06-17T09:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2OTAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3NTA0Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440175043", "bodyText": "What about expose (with a different constructor?) the possibility to plug a different logic here?\nFrom what I can see it should be possible to reuse this class for other JSON schema generation usages just changing these functions:\n\ngetKey is just the identifier of the schema and could default to c.getCanonicalName()\nisUserTaskClass is a predicate to identify if the class should be used\nisNotUserTaskParam is a predicate to skip fields", "author": "danielezonca", "createdAt": "2020-06-15T13:28:47Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JSonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+\n+public class JSonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+\n+    public JSonSchemaGenerator(Stream<Class<?>> stream) {\n+        this.stream = stream;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(this::isUserTaskClass).collect(Collectors.groupingBy(this::getKey));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    merged.setAll(read);\n+            }\n+            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            writer.writeValue(outputStream, merged);\n+            files.add(new GeneratedFile(Type.JSON_SCHEMA, entry.getKey() + \".json\", outputStream.toByteArray()));\n+        }\n+        return files;\n+    }\n+\n+\n+    private String getKey(Class<?> c) {\n+        return c.getAnnotation(UserTask.class).taskName();\n+    }\n+\n+    private boolean isUserTaskClass(Class<?> c) {\n+        return c.isAnnotationPresent(UserTask.class);\n+    }\n+\n+    private boolean isNotUserTaskParam(FieldScope fieldScope) {\n+        return !fieldScope.getDeclaringType().getErasedType().isAnnotationPresent(UserTask.class) || fieldScope.getAnnotation(UserTaskParam.class) == null;\n+    }", "originalCommit": "882a38c9eb6e721a59a2338a1417b3d229c55cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwODk0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440208940", "bodyText": "hmmm, I just put that logic wrapped into private method to avoid the use of anonymous class (a performance trick for streams), but lets analyze them one by one to see if it make sense to expose them.\nThe name of the file, as discussed with Pere, should be process+task name. I actually made a trick here to avoid adding two attributes to the annotation and delegate that responsibility to compound the name to the UserTask class generator, so whatever is assigned to the UserTask annotatation is used as file name. Rethinking about it, thats probably wrong, so I would add \"Process name\" attribute to UserTask annotation and expose this function in constructor.\nisUserTaskClass is fine to expose as it is, since, as you indicate is a predicate to identify if the class should be used to generate a json or not.\nisNotUserTaskParam predicate paremeter depends on the 3pt tool we are using (parameter is a class that belong to JsonSchemaGenerator), so we cannot really expose it in the API. And it is very likely that a different generator will use a different approach to identify which fields should be included in the schema or not, so I think it is ok to not expose it.", "author": "fjtirado", "createdAt": "2020-06-15T14:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3NTA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNTc1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440215756", "bodyText": "PR updated, please check", "author": "fjtirado", "createdAt": "2020-06-15T14:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3NTA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3OTUyNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440179525", "bodyText": "Can you please add a test with a third annotated class with a different taskName to verify that it will be not merged?\nSame with a field without UserTaskParam annotation", "author": "danielezonca", "createdAt": "2020-06-15T13:35:27Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/JSonSchemaGeneratorTest.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.codegen;\n+\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class JSonSchemaGeneratorTest {", "originalCommit": "882a38c9eb6e721a59a2338a1417b3d229c55cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNTU5Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r440215593", "bodyText": "Done", "author": "fjtirado", "createdAt": "2020-06-15T14:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3OTUyNQ=="}], "type": "inlineReview"}, {"oid": "b51d788faa6761f895c8684ce6221737344eff53", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b51d788faa6761f895c8684ce6221737344eff53", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T14:24:24Z", "type": "forcePushed"}, {"oid": "98c8c85316016b634c67c991bafb7d243a9d5335", "url": "https://github.com/kiegroup/kogito-runtimes/commit/98c8c85316016b634c67c991bafb7d243a9d5335", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T14:28:30Z", "type": "forcePushed"}, {"oid": "494529885a83da935ecea019822b884bd6b30b84", "url": "https://github.com/kiegroup/kogito-runtimes/commit/494529885a83da935ecea019822b884bd6b30b84", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T15:48:05Z", "type": "forcePushed"}, {"oid": "347e043411f0456281c46cb434560a7f0c401829", "url": "https://github.com/kiegroup/kogito-runtimes/commit/347e043411f0456281c46cb434560a7f0c401829", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T18:20:31Z", "type": "forcePushed"}, {"oid": "de7456b94dbdca5c573bb3337f37c6b33d04cd36", "url": "https://github.com/kiegroup/kogito-runtimes/commit/de7456b94dbdca5c573bb3337f37c6b33d04cd36", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T18:21:35Z", "type": "forcePushed"}, {"oid": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "url": "https://github.com/kiegroup/kogito-runtimes/commit/bea883077a6f51dc7468f41fe3e3eb2ff9886115", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-15T19:52:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMTAxMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441021010", "bodyText": "Is this code really copied from SO?\nTo be honest I don't know if this is ok from a license perspective (see link 1, link 2)\nBtw if it is fine can you please move this comment as javadoc for the class instead of here before package declaration?", "author": "danielezonca", "createdAt": "2020-06-16T17:27:53Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+// code copied from https://stackoverflow.com/questions/9895041/merging-two-json-documents-using-jackson", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODM4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441108380", "bodyText": "Well, this was originally copied, but now it is quite different from the original, because I modified it to fix a couple of issues and change the style.", "author": "fjtirado", "createdAt": "2020-06-16T20:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4MTQ1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441381454", "bodyText": "Can I put \"inspired by\" rather than \"copy\"? (I guess is fair to mention that fact) will it be license compliant?", "author": "fjtirado", "createdAt": "2020-06-17T08:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMTAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ4Mjk1OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441482959", "bodyText": "From what I can see in link 2\nYou can rewrite \u201cideas\u201d that are expressed through a source code snippet, but you cannot copy snippets of code via Fair Use, regardless of the number of lines you are copying.\n\nso it should be fine just to mention inspired by", "author": "danielezonca", "createdAt": "2020-06-17T11:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyMTAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NjcyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441256720", "bodyText": "Maybe simply Type or ParamType ?", "author": "cristianonicolai", "createdAt": "2020-06-17T03:16:09Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/UserTaskParam.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.FIELD;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+\n+@Retention(RUNTIME)\n+@Target(FIELD)\n+public @interface UserTaskParam {\n+\n+    TaskType value();\n+\n+    public enum TaskType {", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3ODg0Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441378847", "bodyText": "good catch, this was copied from UserTask annotation and I forgot to change tha name to a proper one.", "author": "fjtirado", "createdAt": "2020-06-17T08:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NjcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NzY1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441257651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            else\n          \n          \n            \n                            else {", "author": "cristianonicolai", "createdAt": "2020-06-17T03:20:02Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5MDA5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441390094", "bodyText": "done", "author": "fjtirado", "createdAt": "2020-06-17T08:55:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NzY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NzY4Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441257683", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (merged == null)\n          \n          \n            \n                            if (merged == null) {", "author": "cristianonicolai", "createdAt": "2020-06-17T03:20:09Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4OTk4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441389982", "bodyText": "done", "author": "fjtirado", "createdAt": "2020-06-17T08:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1NzY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1ODk3Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441258973", "bodyText": "@fjtirado do we need to merge with a previously generated version? Why not simply overwrite it?", "author": "cristianonicolai", "createdAt": "2020-06-17T03:25:21Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    JsonUtils.merge(read, merged);", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NzY4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441367685", "bodyText": "We need a deep merge or we will be losing information.", "author": "fjtirado", "createdAt": "2020-06-17T08:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1ODk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2OTM2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441469364", "bodyText": "hm, maybe I'm missing something, but arent we generating the file with all the information every time the goal is executed?", "author": "cristianonicolai", "createdAt": "2020-06-17T11:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1ODk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NjcxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441476714", "bodyText": "The algorithm I believe we should use is:\nScan all UserTask annotated files, which basically are *InputTask and *OutputTask,\ngenerate json schema for each of them\ngroup these schemas by task form name (composition of process and task name), normally they will be two per form (_InputTask and OutputTask).\nmerge them into one single json schema file for the form\n(in maven plugin & quarkus extension) override the existing json schema file, if any.", "author": "fjtirado", "createdAt": "2020-06-17T11:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1ODk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1OTYyNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441259625", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n          \n          \n            \n                        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {", "author": "cristianonicolai", "createdAt": "2020-06-17T03:28:13Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    JsonUtils.merge(read, merged);\n+            }\n+            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI1OTkzNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441259934", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testJsonSchemaGenerator() throws IOException\n          \n          \n            \n                public void testJsonSchemaGenerator() throws IOException {", "author": "cristianonicolai", "createdAt": "2020-06-17T03:29:40Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/JsonSchemaGeneratorTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.codegen;\n+\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class JsonSchemaGeneratorTest {\n+\n+    @UserTask(taskName = \"test\", processName = \"test\")\n+    private static class PersonInputParams {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.INPUT)\n+        private String name;\n+\n+        @UserTaskParam(UserTaskParam.TaskType.INPUT)\n+        private Address address;\n+    }\n+\n+    @UserTask(taskName = \"test\", processName = \"test\")\n+    private static class PersonOutputParams {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private int age;\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private String name;\n+\n+        @SuppressWarnings(\"unused\")\n+        private String ignored;\n+    }\n+\n+    private static class Address {\n+        @SuppressWarnings(\"unused\")\n+        private String street;\n+    }\n+\n+    private static class IgnoredClass {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private int age;\n+    }\n+\n+    @Test\n+    public void testJsonSchemaGenerator() throws IOException", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2MDE4Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441260187", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testMerge()\n          \n          \n            \n                public void testMerge() {", "author": "cristianonicolai", "createdAt": "2020-06-17T03:30:43Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/json/JSonUtilsTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.codegen.json;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class JSonUtilsTest {\n+\n+    @Test\n+    public void testMerge()", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2MDgwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441260808", "bodyText": "can you add an example with both input and output?", "author": "cristianonicolai", "createdAt": "2020-06-17T03:33:06Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/JsonSchemaGeneratorTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.codegen;\n+\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class JsonSchemaGeneratorTest {\n+\n+    @UserTask(taskName = \"test\", processName = \"test\")\n+    private static class PersonInputParams {", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NTgxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441265814", "bodyText": "@fjtirado I would be surprised if we dont have a utils method in the codebase already to do similar thing, have you had a quick look?", "author": "cristianonicolai", "createdAt": "2020-06-17T03:54:56Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    JsonUtils.merge(read, merged);\n+            }\n+            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            writer.writeValue(outputStream, merged);\n+            files.add(new GeneratedFile(Type.JSON_SCHEMA, entry.getKey() + \".json\", outputStream.toByteArray()));\n+        }\n+        return files;\n+    }\n+\n+\n+    private static String getKey(Class<?> c) {\n+        UserTask userTask = c.getAnnotation(UserTask.class);\n+        return userTask.processName() + \"_\" + userTask.taskName();\n+    }\n+\n+    private static boolean isUserTaskClass(Class<?> c) {\n+        return c.isAnnotationPresent(UserTask.class);\n+    }\n+\n+    private boolean isNotUserTaskParam(FieldScope fieldScope) {\n+        return fieldScope.getDeclaringType().getErasedType().isAnnotationPresent(UserTask.class) && fieldScope.getAnnotation(UserTaskParam.class) == null;\n+    }\n+\n+    public static final Stream<Class<?>> getClassStream(Path parentPath, ClassLoader cl) throws IOException {\n+        return Files.walk(parentPath).filter(p -> p.toString().endsWith(\".class\")).map(parentPath::relativize).map(p -> {", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxOTM1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441419354", "bodyText": "I checked  CodeGenUtils and do not find anything similar, maybe it is worthy to move this method there?", "author": "fjtirado", "createdAt": "2020-06-17T09:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NTgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODc4Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441468782", "bodyText": "+1", "author": "cristianonicolai", "createdAt": "2020-06-17T11:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NTgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3MjI5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441472298", "bodyText": "Done", "author": "fjtirado", "createdAt": "2020-06-17T11:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NTgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NzQyNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441267424", "bodyText": "Perhaps you should check if the test task classes where found?", "author": "cristianonicolai", "createdAt": "2020-06-17T04:01:53Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/codegen/JsonSchemaGeneratorTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.codegen;\n+\n+\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class JsonSchemaGeneratorTest {\n+\n+    @UserTask(taskName = \"test\", processName = \"test\")\n+    private static class PersonInputParams {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.INPUT)\n+        private String name;\n+\n+        @UserTaskParam(UserTaskParam.TaskType.INPUT)\n+        private Address address;\n+    }\n+\n+    @UserTask(taskName = \"test\", processName = \"test\")\n+    private static class PersonOutputParams {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private int age;\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private String name;\n+\n+        @SuppressWarnings(\"unused\")\n+        private String ignored;\n+    }\n+\n+    private static class Address {\n+        @SuppressWarnings(\"unused\")\n+        private String street;\n+    }\n+\n+    private static class IgnoredClass {\n+\n+        @UserTaskParam(UserTaskParam.TaskType.OUTPUT)\n+        private int age;\n+    }\n+\n+    @Test\n+    public void testJsonSchemaGenerator() throws IOException\n+    {\n+        Collection<GeneratedFile> files = new JsonSchemaGenerator(Stream.of(PersonInputParams.class, PersonOutputParams.class, IgnoredClass.class)).generate();\n+        assertEquals(1, files.size());\n+        GeneratedFile file = files.iterator().next();\n+        assertEquals(\"test_test.json\", file.relativePath());\n+        ObjectReader reader = new ObjectMapper().reader();\n+        JsonNode node = reader.readTree(file.contents());\n+        assertEquals(\"https://json-schema.org/draft/2019-09/schema\", node.get(\"$schema\").asText());\n+        assertEquals(\"object\", node.get(\"type\").asText());\n+        JsonNode properties = node.get(\"properties\");\n+        assertEquals(3, properties.size());\n+        assertEquals(\"integer\", properties.get(\"age\").get(\"type\").asText());\n+        assertEquals(\"string\", properties.get(\"name\").get(\"type\").asText());\n+        JsonNode address = properties.get(\"address\");\n+        assertEquals(\"object\", address.get(\"type\").asText());\n+        assertEquals(\"string\", address.get(\"properties\").get(\"street\").get(\"type\").asText());\n+    }\n+\n+    @Test\n+    void testStreamPathToClass() throws IOException {\n+        assertEquals(JsonSchemaGenerator.class, JsonSchemaGenerator.getClassStream(Paths.get(\"target\", \"classes\"), JsonSchemaGenerator.class.getClassLoader()).filter(", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM5NTE2MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441395160", "bodyText": "That was my first idea, but then I though thatn since we are testing JSonSchemaGenerator, it will be nicer to search for that class..", "author": "fjtirado", "createdAt": "2020-06-17T09:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2NzQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2ODY0Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441268647", "bodyText": "could be interesting to log the name/path of the created files", "author": "cristianonicolai", "createdAt": "2020-06-17T04:07:18Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateJsonSchemaMojo.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.maven.plugin;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import org.apache.maven.plugin.MojoExecutionException;\n+import org.apache.maven.plugin.MojoFailureException;\n+import org.apache.maven.plugins.annotations.LifecyclePhase;\n+import org.apache.maven.plugins.annotations.Mojo;\n+import org.apache.maven.plugins.annotations.Parameter;\n+import org.apache.maven.plugins.annotations.ResolutionScope;\n+import org.apache.maven.project.MavenProject;\n+import org.kie.kogito.codegen.GeneratedFile;\n+import org.kie.kogito.codegen.JsonSchemaGenerator;\n+import org.kie.kogito.maven.plugin.util.MojoUtil;\n+\n+\n+@Mojo(name = \"generate-json-schema\",\n+      requiresDependencyResolution = ResolutionScope.COMPILE,\n+      requiresProject = true,\n+      defaultPhase = LifecyclePhase.PROCESS_CLASSES)\n+public class GenerateJsonSchemaMojo extends AbstractKieMojo {\n+\n+    @Parameter(required = true, defaultValue = \"${project}\")\n+    private MavenProject project;\n+\n+    @Override\n+    public void execute() throws MojoExecutionException, MojoFailureException {\n+        try {\n+            Path path = Paths.get(project.getBuild().getOutputDirectory());\n+            ClassLoader cl = MojoUtil\n+                                     .createProjectClassLoader(this\n+                                                                   .getClass()\n+                                                                   .getClassLoader(),\n+                                                               project,\n+                                                               path.toFile(),\n+                                                               null);\n+            Collection<GeneratedFile> files;\n+            try (Stream<Class<?>> stream = JsonSchemaGenerator.getClassStream(path, cl)) {\n+                files = new JsonSchemaGenerator(stream).generate();\n+            }\n+\n+            Path parentPath = path.resolve(\"META-INF\").resolve(\"jsonSchema\");\n+            Files.createDirectories(parentPath);\n+            for (GeneratedFile file : files) {\n+                Files.write(parentPath.resolve(file.relativePath()), file.contents());", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2OTExOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441369119", "bodyText": "yes, Ill do that", "author": "fjtirado", "createdAt": "2020-06-17T08:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2ODY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2OTA2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441269069", "bodyText": "we could have other failures here. So maybe keep it more generic like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new MojoExecutionException(\"Error retrieving children classes\", e);\n          \n          \n            \n                        throw new MojoExecutionException(\"Error generating JSON Schema for tasks\", e);", "author": "cristianonicolai", "createdAt": "2020-06-17T04:09:18Z", "path": "kogito-maven-plugin/src/main/java/org/kie/kogito/maven/plugin/GenerateJsonSchemaMojo.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.maven.plugin;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collection;\n+import java.util.stream.Stream;\n+\n+import org.apache.maven.plugin.MojoExecutionException;\n+import org.apache.maven.plugin.MojoFailureException;\n+import org.apache.maven.plugins.annotations.LifecyclePhase;\n+import org.apache.maven.plugins.annotations.Mojo;\n+import org.apache.maven.plugins.annotations.Parameter;\n+import org.apache.maven.plugins.annotations.ResolutionScope;\n+import org.apache.maven.project.MavenProject;\n+import org.kie.kogito.codegen.GeneratedFile;\n+import org.kie.kogito.codegen.JsonSchemaGenerator;\n+import org.kie.kogito.maven.plugin.util.MojoUtil;\n+\n+\n+@Mojo(name = \"generate-json-schema\",\n+      requiresDependencyResolution = ResolutionScope.COMPILE,\n+      requiresProject = true,\n+      defaultPhase = LifecyclePhase.PROCESS_CLASSES)\n+public class GenerateJsonSchemaMojo extends AbstractKieMojo {\n+\n+    @Parameter(required = true, defaultValue = \"${project}\")\n+    private MavenProject project;\n+\n+    @Override\n+    public void execute() throws MojoExecutionException, MojoFailureException {\n+        try {\n+            Path path = Paths.get(project.getBuild().getOutputDirectory());\n+            ClassLoader cl = MojoUtil\n+                                     .createProjectClassLoader(this\n+                                                                   .getClass()\n+                                                                   .getClassLoader(),\n+                                                               project,\n+                                                               path.toFile(),\n+                                                               null);\n+            Collection<GeneratedFile> files;\n+            try (Stream<Class<?>> stream = JsonSchemaGenerator.getClassStream(path, cl)) {\n+                files = new JsonSchemaGenerator(stream).generate();\n+            }\n+\n+            Path parentPath = path.resolve(\"META-INF\").resolve(\"jsonSchema\");\n+            Files.createDirectories(parentPath);\n+            for (GeneratedFile file : files) {\n+                Files.write(parentPath.resolve(file.relativePath()), file.contents());\n+            }\n+\n+        } catch (IOException e) {\n+            throw new MojoExecutionException(\"Error retrieving children classes\", e);", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2OTQxNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441369416", "bodyText": "yes, copy paste message ;), Ill fix that", "author": "fjtirado", "createdAt": "2020-06-17T08:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI2OTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MDc1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441280751", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            className.append(str.substring(0, str.length() - \".class\".length()));\n          \n          \n            \n                            className.append(str, 0, str.length() - \".class\".length());", "author": "cristianonicolai", "createdAt": "2020-06-17T04:58:54Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/JsonSchemaGenerator.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.codegen;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.github.victools.jsonschema.generator.FieldScope;\n+import com.github.victools.jsonschema.generator.OptionPreset;\n+import com.github.victools.jsonschema.generator.SchemaGenerator;\n+import com.github.victools.jsonschema.generator.SchemaGeneratorConfigBuilder;\n+import com.github.victools.jsonschema.generator.SchemaVersion;\n+import org.kie.kogito.UserTask;\n+import org.kie.kogito.UserTaskParam;\n+import org.kie.kogito.codegen.GeneratedFile.Type;\n+import org.kie.kogito.codegen.json.JsonUtils;\n+\n+public class JsonSchemaGenerator {\n+\n+    private Stream<Class<?>> stream;\n+    private Function<? super Class<?>, String> getSchemaName;\n+    private Predicate<? super Class<?>> shouldGenSchema;\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream) {\n+        this(stream, JsonSchemaGenerator::getKey, JsonSchemaGenerator::isUserTaskClass);\n+    }\n+\n+    public JsonSchemaGenerator(Stream<Class<?>> stream, Function<Class<?>, String> getSchemaName, Predicate<Class<?>> shouldGenSchema) {\n+        this.stream = stream;\n+        this.getSchemaName = getSchemaName;\n+        this.shouldGenSchema = shouldGenSchema;\n+    }\n+\n+    public Collection<GeneratedFile> generate() throws IOException {\n+        SchemaGeneratorConfigBuilder builder = new SchemaGeneratorConfigBuilder(SchemaVersion.DRAFT_2019_09, OptionPreset.PLAIN_JSON);\n+        builder.forFields().withIgnoreCheck(this::isNotUserTaskParam);\n+        SchemaGenerator generator = new SchemaGenerator(builder.build());\n+        ObjectWriter writer = new ObjectMapper().writer();\n+        Map<String, List<Class<?>>> map = stream.filter(shouldGenSchema).collect(Collectors.groupingBy(getSchemaName));\n+        Collection<GeneratedFile> files = new ArrayList<>();\n+        for (Map.Entry<String, List<Class<?>>> entry : map.entrySet()) {\n+            ObjectNode merged = null;\n+            for (Class<?> c : entry.getValue()) {\n+                ObjectNode read = generator.generateSchema(c);\n+                if (merged == null)\n+                    merged = read;\n+                else\n+                    JsonUtils.merge(read, merged);\n+            }\n+            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+            writer.writeValue(outputStream, merged);\n+            files.add(new GeneratedFile(Type.JSON_SCHEMA, entry.getKey() + \".json\", outputStream.toByteArray()));\n+        }\n+        return files;\n+    }\n+\n+\n+    private static String getKey(Class<?> c) {\n+        UserTask userTask = c.getAnnotation(UserTask.class);\n+        return userTask.processName() + \"_\" + userTask.taskName();\n+    }\n+\n+    private static boolean isUserTaskClass(Class<?> c) {\n+        return c.isAnnotationPresent(UserTask.class);\n+    }\n+\n+    private boolean isNotUserTaskParam(FieldScope fieldScope) {\n+        return fieldScope.getDeclaringType().getErasedType().isAnnotationPresent(UserTask.class) && fieldScope.getAnnotation(UserTaskParam.class) == null;\n+    }\n+\n+    public static final Stream<Class<?>> getClassStream(Path parentPath, ClassLoader cl) throws IOException {\n+        return Files.walk(parentPath).filter(p -> p.toString().endsWith(\".class\")).map(parentPath::relativize).map(p -> {\n+            try {\n+                return cl.loadClass(getClassNameFromPath(p));\n+            } catch (ClassNotFoundException e) {\n+                return (Class<?>) null;\n+            }\n+        }).filter(Objects::nonNull);\n+\n+    }\n+\n+    private static String getClassNameFromPath(Path path) {\n+        StringBuilder className = new StringBuilder();\n+        Iterator<Path> iter = path.iterator();\n+        while (iter.hasNext()) {\n+            String str = iter.next().toString();\n+            if (iter.hasNext()) {\n+                className.append(str).append('.');\n+            } else {\n+                className.append(str.substring(0, str.length() - \".class\".length()));", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2OTc3Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441369772", "bodyText": "good catch!!!", "author": "fjtirado", "createdAt": "2020-06-17T08:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MDc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMzMDYxMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441330610", "bodyText": "I think this is the first time I see these annotations (i.e. I haven't seen a rationale for using them), can we add some documentation somewhere?", "author": "evacchi", "createdAt": "2020-06-17T07:16:08Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/UserTask.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+\n+@Retention(RUNTIME)\n+@Target(TYPE)\n+public @interface UserTask {", "originalCommit": "bea883077a6f51dc7468f41fe3e3eb2ff9886115", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MjYyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/551#discussion_r441372626", "bodyText": "UserTask is to identify the files generated for user task and do not rely on the currently generated name (they finish with TaskImport and TaskOuput suffix)\nWithin these generated files, there are some fields that does not need to be included in the json schema, thats the rationale for the introduction of UserTaskParam", "author": "fjtirado", "createdAt": "2020-06-17T08:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMzMDYxMA=="}], "type": "inlineReview"}, {"oid": "89845d8e0de871c30c069a83c7f59bf887c39840", "url": "https://github.com/kiegroup/kogito-runtimes/commit/89845d8e0de871c30c069a83c7f59bf887c39840", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-17T09:39:25Z", "type": "forcePushed"}, {"oid": "363e5145c9a3264f77a0b67a88d2ceb06ee6f589", "url": "https://github.com/kiegroup/kogito-runtimes/commit/363e5145c9a3264f77a0b67a88d2ceb06ee6f589", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-17T11:15:38Z", "type": "forcePushed"}, {"oid": "d64cd17330c4e44e444654e4b3ac6f7728114556", "url": "https://github.com/kiegroup/kogito-runtimes/commit/d64cd17330c4e44e444654e4b3ac6f7728114556", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T14:32:29Z", "type": "forcePushed"}, {"oid": "0d03eae3f81d8187abf6fb298f549d9126f02937", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0d03eae3f81d8187abf6fb298f549d9126f02937", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T17:03:39Z", "type": "forcePushed"}, {"oid": "66e033bdd8b078586e92f8cc9ad9bec09963d421", "url": "https://github.com/kiegroup/kogito-runtimes/commit/66e033bdd8b078586e92f8cc9ad9bec09963d421", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T18:14:08Z", "type": "forcePushed"}, {"oid": "fc22fd86d274320fef6317ba18b657a26263212b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/fc22fd86d274320fef6317ba18b657a26263212b", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T18:16:24Z", "type": "forcePushed"}, {"oid": "3bb0c080fafc3272e4107bcb426d1a981b199b95", "url": "https://github.com/kiegroup/kogito-runtimes/commit/3bb0c080fafc3272e4107bcb426d1a981b199b95", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T18:22:24Z", "type": "forcePushed"}, {"oid": "c025eb5fe00ff140f05fb96b1915d6d7b1b87fc7", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c025eb5fe00ff140f05fb96b1915d6d7b1b87fc7", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-17T19:44:16Z", "type": "forcePushed"}, {"oid": "6fe96f1d86a742a26d35fe8bc74e9a6836f6e867", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6fe96f1d86a742a26d35fe8bc74e9a6836f6e867", "message": "[KOGITO-1063] Generate task schema endpoints for form rendering\n\nDefining new mojo for Spring boot", "committedDate": "2020-06-18T09:50:51Z", "type": "commit"}, {"oid": "2af357ee186fc34af6d4fdfc7c881f137325b348", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2af357ee186fc34af6d4fdfc7c881f137325b348", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-18T09:50:54Z", "type": "commit"}, {"oid": "2af357ee186fc34af6d4fdfc7c881f137325b348", "url": "https://github.com/kiegroup/kogito-runtimes/commit/2af357ee186fc34af6d4fdfc7c881f137325b348", "message": "KOGITO-1063\n\nAlternative approach that reuses existing MOJO", "committedDate": "2020-06-18T09:50:54Z", "type": "forcePushed"}]}