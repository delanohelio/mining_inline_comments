{"pr_number": 807, "pr_title": "KOGITO-3408  CloudEvent Kafka Publisher+Emitter (Quarkus)", "pr_createdAt": "2020-10-06T09:15:28Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/807", "timeline": [{"oid": "c6ca86a2a575966812aeef2e56023f2362860dc4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/c6ca86a2a575966812aeef2e56023f2362860dc4", "message": "fix", "committedDate": "2020-10-09T12:41:29Z", "type": "forcePushed"}, {"oid": "0eeb9b8eec9a06e20a71b12a2379cf5476f67f19", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0eeb9b8eec9a06e20a71b12a2379cf5476f67f19", "message": "re-disable pingpong in spring too", "committedDate": "2020-10-13T06:23:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk4MTMyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r503981320", "bodyText": "Can we assume the event.type is in fact the class name?", "author": "tiagodolphine", "createdAt": "2020-10-13T14:06:33Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/event/impl/CloudEventConsumer.java", "diffHunk": "@@ -47,6 +49,13 @@ public void consume(Application application, Process<M> process, String payload,\n         try {\n             T cloudEvent = mapper.readValue(payload, cloudEventClass);\n             M model = function.apply(cloudEvent.getData());\n+            // currently we filter out messages on the receiving end\n+            if (!cloudEventClass.getSimpleName().equals(cloudEvent.getType())) {", "originalCommit": "7aaca315ee2b1ea44e1afb359c7de717d8c1b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIxNDI1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504214250", "bodyText": "This should be changed, the engine is using the message node id as the type, not the domain class.", "author": "ricardozanini", "createdAt": "2020-10-13T19:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk4MTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMTg2Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504431863", "bodyText": "made this choice to do the filtering, let's file a jira to fix it", "author": "evacchi", "createdAt": "2020-10-14T06:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk4MTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjI0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504546248", "bodyText": "I have added an additional filter to allow the trigger name. https://issues.redhat.com/browse/KOGITO-3591", "author": "evacchi", "createdAt": "2020-10-14T09:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk4MTMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MDI4MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504140281", "bodyText": "I think Multi<String> events could be set as a parameter of the method.\nLike:\nMulti<String>  makeMulti(@Channel(\"kogito_incoming_stream\") Multi<String> events)...", "author": "tiagodolphine", "createdAt": "2020-10-13T17:40:43Z", "path": "kogito-shared/events-quarkus/src/main/java/org/kie/kogito/shared/events/quarkus/QuarkusCloudEventPublisher.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.shared.events.quarkus;import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Named;\n+\n+import io.quarkus.runtime.Startup;\n+import io.smallrye.mutiny.Multi;\n+import org.eclipse.microprofile.reactive.messaging.Channel;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Takes a @Channel event stream and re-exposes it as a Multi\n+ * (a subclass of {@link Publisher})\n+ */\n+@Startup\n+public class QuarkusCloudEventPublisher {\n+    @Channel(\"kogito_incoming_stream\")\n+    Multi<String> events;\n+\n+    @Produces\n+    @Named(\"kogito_event_publisher\")\n+    public Multi<String> makeMulti() {", "originalCommit": "7aaca315ee2b1ea44e1afb359c7de717d8c1b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMTk3Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504431976", "bodyText": "good point", "author": "evacchi", "createdAt": "2020-10-14T06:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MDI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY3Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504546676", "bodyText": "although I am not 100% sure @Channels can be given as param names. let's try...", "author": "evacchi", "createdAt": "2020-10-14T09:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MDI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5MTU1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r507691550", "bodyText": "I kept it as-is because it is working and I am not sure @Channel works in params, let's refine this iteratively :)", "author": "evacchi", "createdAt": "2020-10-19T12:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MDI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MjYxNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504142614", "bodyText": "One suggestion would be to make async the method return like CompletionStage<Response> then you could do emitter.send(...).thenApply(Response.ok().build())", "author": "tiagodolphine", "createdAt": "2020-10-13T17:45:08Z", "path": "kogito-codegen/src/main/resources/class-templates/events/CloudEventsListenerResource.java", "diffHunk": "@@ -28,33 +28,19 @@\n     @javax.inject.Inject\n     ObjectMapper objectMapper;\n \n-    @javax.annotation.PostConstruct\n-    public void setup() {\n-        emitters = new HashMap<>();\n-        objectMapper.registerModule(JsonFormat.getCloudEventJacksonModule());\n-        /*\n-         * $repeat$\n-         * emitters.put(\"$channel$\", $emitter$);\n-         * $end_repeat$\n-         */\n-    }\n+    @org.eclipse.microprofile.reactive.messaging.Channel(\"kogito_incoming_stream\")\n+    @javax.inject.Inject()\n+    Emitter<String> emitter;\n \n     @POST()\n     @Consumes({MediaType.APPLICATION_JSON, JsonFormat.CONTENT_TYPE})\n     @Produces(MediaType.APPLICATION_JSON)\n     public javax.ws.rs.core.Response cloudEventListener(CloudEvent event) {\n         try {\n             LOGGER.debug(\"CloudEvent received: {}\", Printer.beautify(event));\n-            if (emitters.get(event.getType()) != null) {\n-                // convert CloudEvent to JSON and send to internal channels\n-                emitters.get(event.getType()).send(objectMapper.writeValueAsString(event));\n-                return javax.ws.rs.core.Response.ok().build();\n-            } else if (emitters.get(event.getSource().toString()) != null) { // try the source instead\n-                emitters.get(event.getSource().toString()).send(objectMapper.writeValueAsString(event));\n-                return javax.ws.rs.core.Response.ok().build();\n-            } else {\n-                return Responses.channelNotBound(event.getType(), event);\n-            }\n+            // convert CloudEvent to JSON and send to internal channels\n+            emitter.send(objectMapper.writeValueAsString(event));", "originalCommit": "7aaca315ee2b1ea44e1afb359c7de717d8c1b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNjM1Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504716353", "bodyText": "tried but then e.g. knative example hangs. Keeping it simple for now. let's file a JIRA for improvements", "author": "evacchi", "createdAt": "2020-10-14T14:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MjYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MDczNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r507650736", "bodyText": "ok +1, we can improve it later, running some performance tests with some profilier to check how it behaves.", "author": "tiagodolphine", "createdAt": "2020-10-19T10:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0MjYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NDc1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504144750", "bodyText": "can't you just to r.completable() to be returned?", "author": "tiagodolphine", "createdAt": "2020-10-13T17:48:07Z", "path": "kogito-shared/events-spring/src/main/java/org/kie/kogito/shared/events/spring/SpringKafkaCloudEventEmitter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.shared.events.spring;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.kie.kogito.services.event.CloudEventEmitter;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.kafka.support.SendResult;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.concurrent.ListenableFuture;\n+import org.springframework.util.concurrent.ListenableFutureCallback;\n+\n+/**\n+ * Spring implementation delegating to kafka template\n+ * TODO proper error handling\n+ */\n+@Component\n+public class SpringKafkaCloudEventEmitter implements CloudEventEmitter {\n+    @Autowired\n+    org.springframework.kafka.core.KafkaTemplate<String, String> emitter;\n+\n+    public CompletionStage<Void> emit(String e) {\n+        ListenableFuture<SendResult<String, String>> r = emitter.send(\"kogito_outgoing_stream\", e);", "originalCommit": "7aaca315ee2b1ea44e1afb359c7de717d8c1b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMjEwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504432104", "bodyText": "\ud83e\udd2f", "author": "evacchi", "createdAt": "2020-10-14T06:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NDc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTkwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504149908", "bodyText": "maybe it would be better to subscribe into a shared executor, like .runSubscriptionOn(executor).subscribe().... because in this way the subscription to receive/handle the events would be using a different thread pool, instead of the same thread as the one bootstrapping CDI, but I'm not sure, maybe it is worth to print the thread name in the log info call and check it when receiving events... wdyt?", "author": "tiagodolphine", "createdAt": "2020-10-13T17:56:54Z", "path": "kogito-codegen/src/main/resources/class-templates/CdiMessageConsumerTemplate.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package $Package$;\n+\n+import org.kie.kogito.Application;\n+import org.kie.kogito.conf.ConfigBean;\n+import org.kie.kogito.event.impl.DefaultEventConsumerFactory;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.services.event.impl.AbstractMessageConsumer;\n+import org.reactivestreams.Publisher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import io.smallrye.mutiny.Multi;\n+\n+@io.quarkus.runtime.Startup\n+public class $Type$MessageConsumer extends AbstractMessageConsumer<$Type$, $DataType$, $DataEventType$> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(AbstractMessageConsumer.class);\n+\n+    @javax.inject.Inject\n+    Application application;\n+\n+    @javax.inject.Inject\n+    @javax.inject.Named(\"$ProcessName$\") Process<$Type$> process;\n+\n+    @javax.inject.Inject\n+    ConfigBean configBean;\n+\n+    @javax.inject.Inject\n+    @javax.inject.Named(\"kogito_event_publisher\") Publisher<String> eventPublisher;\n+\n+    @javax.annotation.PostConstruct\n+    void init() {\n+        setParams(application,\n+              process,\n+              $DataType$.class,\n+              $DataEventType$.class,\n+              \"$Trigger$\",\n+              new DefaultEventConsumerFactory(),\n+              configBean.useCloudEvents());\n+\n+        Multi.createFrom().publisher(eventPublisher)\n+                .invoke(x -> logger.info(\"Received: {}\", x))\n+                .subscribe()", "originalCommit": "7aaca315ee2b1ea44e1afb359c7de717d8c1b37b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMjE4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504432180", "bodyText": "\ud83d\udc4d great point", "author": "evacchi", "createdAt": "2020-10-14T06:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNTczMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504715731", "bodyText": "I tried but I got some errors, and I don't want to put too much at stake in this PR. reverted to this (which is mostly how it was done on master). Let's open a jira for improvements", "author": "evacchi", "createdAt": "2020-10-14T14:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MTM4Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r507651386", "bodyText": "ok +1, we can improve it later, running some performance tests with some profilier to check how it behaves.", "author": "tiagodolphine", "createdAt": "2020-10-19T10:49:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4ODgzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504188835", "bodyText": "Can you please create ticket/add ticket id?", "author": "danielezonca", "createdAt": "2020-10-13T19:01:40Z", "path": "integration-tests/integration-tests-quarkus-processes/src/test/java/org/kie/kogito/integrationtests/quarkus/PingPongMessageTest.java", "diffHunk": "@@ -31,6 +32,7 @@\n \n @QuarkusTest\n @QuarkusTestResource(KafkaQuarkusTestResource.class)\n+@Disabled(\"Must rewrite with cloud event support + must implement emitter!\")", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4OTYwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504189603", "bodyText": "Can you please add Jira id?", "author": "danielezonca", "createdAt": "2020-10-13T19:03:04Z", "path": "integration-tests/integration-tests-springboot/src/it/integration-tests-springboot-kafka-it/src/test/java/org/kie/kogito/integrationtests/springboot/PingPongMessageTest.java", "diffHunk": "@@ -32,6 +32,9 @@\n import static org.awaitility.Awaitility.await;\n import static org.hamcrest.CoreMatchers.equalTo;\n \n+import org.junit.jupiter.api.Disabled;\n+\n+@Disabled(\"Must implement cloud event producer/emitter for Spring\")", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4OTkyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504189929", "bodyText": "What about warn instead of debug?", "author": "danielezonca", "createdAt": "2020-10-13T19:03:39Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/event/impl/CloudEventConsumer.java", "diffHunk": "@@ -47,6 +49,14 @@ public void consume(Application application, Process<M> process, String payload,\n         try {\n             T cloudEvent = mapper.readValue(payload, cloudEventClass);\n             M model = function.apply(cloudEvent.getData());\n+            // currently we filter out messages on the receiving end\n+            if (!cloudEventClass.getSimpleName().equals(cloudEvent.getType()) && !cloudEventClass.getSimpleName().equals(cloudEvent.getSource())) {\n+                logger.debug(\"Consumer for CloudEvent type '{}': ignoring message with type '{}',  source '{}'\",", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMTEyOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504431129", "bodyText": "this may overflow your console if you have many consumers. I know debug it's not great though (bit me a few times already)", "author": "evacchi", "createdAt": "2020-10-14T06:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE4OTkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MTY0MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504191640", "bodyText": "Can you please create a ticket about removing this deprecated class and link it here?", "author": "danielezonca", "createdAt": "2020-10-13T19:06:46Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/events/CloudEventsMessageProducerGenerator.java", "diffHunk": "@@ -15,26 +15,84 @@\n \n package org.kie.kogito.codegen.process.events;\n \n+import com.github.javaparser.ast.CompilationUnit;\n+import com.github.javaparser.ast.body.ClassOrInterfaceDeclaration;\n+import com.github.javaparser.ast.body.FieldDeclaration;\n import com.github.javaparser.ast.body.MethodDeclaration;\n import com.github.javaparser.ast.expr.Expression;\n import com.github.javaparser.ast.expr.MethodCallExpr;\n+import com.github.javaparser.ast.expr.NameExpr;\n+import com.github.javaparser.ast.expr.StringLiteralExpr;\n+import com.github.javaparser.ast.expr.ThisExpr;\n import com.github.javaparser.ast.stmt.IfStmt;\n+import com.github.javaparser.ast.type.ClassOrInterfaceType;\n import org.jbpm.compiler.canonical.TriggerMetaData;\n import org.kie.api.definition.process.WorkflowProcess;\n+import org.kie.kogito.codegen.BodyDeclarationComparator;\n import org.kie.kogito.codegen.process.MessageProducerGenerator;\n \n+import static com.github.javaparser.StaticJavaParser.parse;\n+import static org.kie.kogito.codegen.CodegenUtils.interpolateTypes;\n+\n+/**\n+ * @deprecated now all messages are cloud events", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5NDA4NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504194084", "bodyText": "What about a javadoc?", "author": "danielezonca", "createdAt": "2020-10-13T19:11:13Z", "path": "api/kogito-services/src/main/java/org/kie/kogito/services/event/CloudEventEmitter.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.services.event;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+public interface CloudEventEmitter {", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5NDgyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504194827", "bodyText": "Do we have a quarkis issue link to paste here?", "author": "danielezonca", "createdAt": "2020-10-13T19:12:36Z", "path": "api/kogito-services/src/main/java/org/kie/kogito/services/event/impl/AbstractMessageConsumer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.services.event.impl;\n+\n+import java.util.Optional;\n+\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.services.event.AbstractProcessDataEvent;\n+import org.kie.kogito.services.event.EventConsumerFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class AbstractMessageConsumer<M extends Model, D, T extends AbstractProcessDataEvent<D>> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(AbstractMessageConsumer.class);\n+\n+    private Process<M> process;\n+    private Application application;\n+    private EventConsumerFactory eventConsumerFactory;\n+    private Optional<Boolean> useCloudEvents;\n+    private String trigger;\n+    private Class<D> dataEventClass;\n+    private Class<T> cloudEventClass;\n+\n+    // in general we should favor the non-empty constructor\n+    // but there is an issue with Quarkus", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5NTA2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504195068", "bodyText": "Same as above", "author": "danielezonca", "createdAt": "2020-10-13T19:13:07Z", "path": "api/kogito-services/src/main/java/org/kie/kogito/services/event/impl/AbstractMessageProducer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.services.event.impl;\n+\n+import java.util.Optional;\n+import java.util.function.Function;\n+\n+import org.kie.api.runtime.process.ProcessInstance;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.services.event.AbstractProcessDataEvent;\n+import org.kie.kogito.services.event.CloudEventEmitter;\n+import org.kie.kogito.services.event.EventConsumerFactory;\n+import org.kie.kogito.services.event.EventMarshaller;\n+\n+public abstract class AbstractMessageProducer<D, T extends AbstractProcessDataEvent<D>> {\n+\n+    private Optional<Boolean> useCloudEvents;\n+    private Class<D> dataEventClass;\n+    private Class<T> cloudEventClass;\n+    private EventMarshaller marshaller;\n+    private CloudEventEmitter emitter;\n+\n+    // in general we should favor the non-empty constructor\n+    // but there is an issue with Quarkus", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5ODMzOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504198339", "bodyText": "In MessageConsumerGenerator the same method returns\ngenerator.generatedFilePath();\nWhile here is different.\nCan you please verify?", "author": "danielezonca", "createdAt": "2020-10-13T19:19:09Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/MessageProducerGenerator.java", "diffHunk": "@@ -65,81 +70,52 @@ public MessageProducerGenerator(\n         this.resourceClazzName = classPrefix + \"MessageProducer_\" + trigger.getOwnerId();\n         this.relativePath = packageName.replace(\".\", \"/\") + \"/\" + resourceClazzName + \".java\";\n         this.messageDataEventClassName = messageDataEventClassName;\n+\n+        this.generator = new TemplatedGenerator(\n+                packageName,\n+                resourceClazzName,\n+                RESOURCE_CDI,\n+                RESOURCE_SPRING,\n+                RESOURCE);\n+\n     }\n \n     public MessageProducerGenerator withDependencyInjection(DependencyInjectionAnnotator annotator) {\n         this.annotator = annotator;\n+        generator.withDependencyInjection(annotator);\n         return this;\n     }\n \n-    public String className() {\n-        return resourceClazzName;\n-    }\n-\n-    public String generatedFilePath() {\n-        return relativePath;\n-    }\n-\n-    protected boolean useInjection() {\n-        return this.annotator != null;\n-    }\n-\n-    protected String getTemplate() {\n-        return CLASS_TEMPLATE;\n-    }\n-\n     public String generate() {\n-        CompilationUnit clazz = parse(\n-                this.getClass().getResourceAsStream(this.getTemplate()));\n+        CompilationUnit clazz = generator.compilationUnit()\n+                .orElseThrow(() -> new InvalidTemplateException(resourceClazzName, generator.templatePath(), \"Cannot generate message producer\"));\n         clazz.setPackageDeclaration(process.getPackageName());\n \n         ClassOrInterfaceDeclaration template = clazz.findFirst(ClassOrInterfaceDeclaration.class).get();\n         template.setName(resourceClazzName);\n+        template.findAll(ConstructorDeclaration.class).forEach(cd -> cd.setName(resourceClazzName));\n \n         template.findAll(ClassOrInterfaceType.class).forEach(cls -> interpolateTypes(cls, trigger.getDataType()));\n-        template.findAll(MethodDeclaration.class).stream().filter(md -> md.getNameAsString().equals(\"produce\")).forEach(md -> md.getParameters().stream().filter(p -> p.getNameAsString().equals(EVENT_DATA_VAR)).forEach(p -> p.setType(trigger.getDataType())));\n-        template.findAll(MethodDeclaration.class).stream().filter(md -> md.getNameAsString().equals(\"configure\")).forEach(md -> md.addAnnotation(\"javax.annotation.PostConstruct\"));\n-        template.findAll(MethodDeclaration.class).stream().filter(md -> md.getNameAsString().equals(\"marshall\")).forEach(md -> {\n-            md.getParameters().stream().filter(p -> p.getNameAsString().equals(EVENT_DATA_VAR)).forEach(p -> p.setType(trigger.getDataType()));\n-            md.findAll(StringLiteralExpr.class).forEach(s -> s.setString(s.getValue().replace(\"$channel$\", trigger.getName())));\n-            md.findAll(ClassOrInterfaceType.class).forEach(t -> t.setName(t.getNameAsString().replace(\"$DataEventType$\", messageDataEventClassName)));\n-        });\n-\n-        if (useInjection()) {\n-            annotator.withApplicationComponent(template);\n-\n-            FieldDeclaration emitterField = template.findFirst(FieldDeclaration.class)\n-                    .filter(fd -> fd.getVariables().stream().anyMatch(v -> v.getNameAsString().equals(\"emitter\")))\n-                    .orElseThrow(() -> new IllegalStateException(\"Cannot find emitter field in MessageProducerTemplate\"));\n-            annotator.withInjection(emitterField);\n-            annotator.withOutgoingMessage(emitterField, trigger.getName());\n-            emitterField.getVariable(0).setType(annotator.emitterType(\"String\"));\n-\n-            MethodDeclaration produceMethod = template.findAll(MethodDeclaration.class).stream()\n-                    .filter(md -> md.getNameAsString().equals(\"produce\"))\n-                    .findFirst().orElseThrow(() -> new IllegalStateException(\"Cannot find produce methods in MessageProducerTemplate\"));\n-\n-            MethodCallExpr sendMethodCall = new MethodCallExpr(new NameExpr(\"emitter\"), \"send\");\n-            annotator.withMessageProducer(\n-                    sendMethodCall,\n-                    trigger.getName(),\n-                    new MethodCallExpr(new ThisExpr(), \"marshall\")\n-                            .addArgument(new NameExpr(\"pi\"))\n-                            .addArgument(new NameExpr(EVENT_DATA_VAR)));\n-\n-            this.generateProduceMethodBody(produceMethod, sendMethodCall);\n-\n-            template.findAll(FieldDeclaration.class,\n-                             fd -> fd.getVariable(0).getNameAsString().equals(\"useCloudEvents\")).forEach(fd -> annotator.withConfigInjection(fd, \"kogito.messaging.as-cloudevents\"));\n-        }\n+        template.findAll(ClassOrInterfaceType.class).forEach(t -> t.setName(t.getNameAsString().replace(\"$DataEventType$\", messageDataEventClassName)));\n+        template.findAll(ClassOrInterfaceType.class).forEach(t -> t.setName(t.getNameAsString().replace(\"$DataType$\", trigger.getDataType())));\n+        template.findAll(StringLiteralExpr.class).forEach(s -> s.setString(s.getValue().replace(\"$channel$\", trigger.getName())));\n+        template.findAll(StringLiteralExpr.class).forEach(s -> s.setString(s.getValue().replace(\"$channel$\", trigger.getName())));\n+\n \n         template.getMembers().sort(new BodyDeclarationComparator());\n         return clazz.toString();\n     }\n \n-    protected void generateProduceMethodBody(final MethodDeclaration produceMethod, final MethodCallExpr sendMethodCall) {\n-        BlockStmt body = new BlockStmt();\n-        body.addStatement(sendMethodCall);\n-        produceMethod.setBody(body);\n+    public String className() {\n+        return resourceClazzName;\n+    }\n+\n+    public String generatedFilePath() {\n+        return relativePath;", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5ODcwOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504198708", "bodyText": "Do we have a ticket for that to refer here?", "author": "danielezonca", "createdAt": "2020-10-13T19:19:45Z", "path": "kogito-shared/events-spring/src/main/java/org/kie/kogito/shared/events/spring/SpringKafkaCloudEventEmitter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ *  Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.kie.kogito.shared.events.spring;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.kie.kogito.services.event.CloudEventEmitter;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.kafka.support.SendResult;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.concurrent.ListenableFuture;\n+import org.springframework.util.concurrent.ListenableFutureCallback;\n+\n+/**\n+ * Spring implementation delegating to kafka template\n+ * TODO proper error handling", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwNDI2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504204269", "bodyText": "Is this class quarkus specific? If yes please rename with CDI prefix, otherwise I'm not sure we can use microprofile reactive messaging with Spring", "author": "danielezonca", "createdAt": "2020-10-13T19:29:52Z", "path": "kogito-codegen/src/main/resources/class-templates/events/CloudEventsListenerResource.java", "diffHunk": "@@ -28,15 +28,13 @@\n     @javax.inject.Inject\n     ObjectMapper objectMapper;\n \n+    @org.eclipse.microprofile.reactive.messaging.Channel(\"kogito_incoming_stream\")", "originalCommit": "457ee600a57e4e56d65d32aab727853fa5af0f75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzMTQ5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504431494", "bodyText": "this is specific to knative addon, where only quarkus is currently supported so far", "author": "evacchi", "createdAt": "2020-10-14T06:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwNDI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5NDcwNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r504694707", "bodyText": "Maybe after this PR we can review this one and add SpringBoot support: https://issues.redhat.com/browse/KOGITO-2956", "author": "ricardozanini", "createdAt": "2020-10-14T13:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwNDI2OQ=="}], "type": "inlineReview"}, {"oid": "4c9cac0bfb5b8d64b71d18c37dba4fa6cf1294a2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/4c9cac0bfb5b8d64b71d18c37dba4fa6cf1294a2", "message": "KOGITO-3408 CloudEvent Kafka Publisher/Emitter (Quarkus)", "committedDate": "2020-10-15T15:15:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0NzczMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r507747733", "bodyText": "Unused dependency?", "author": "danielezonca", "createdAt": "2020-10-19T13:31:15Z", "path": "kogito-codegen/src/main/resources/class-templates/events/CloudEventsListenerResource.java", "diffHunk": "@@ -18,6 +18,7 @@\n import javax.ws.rs.core.MediaType;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.concurrent.CompletionStage;", "originalCommit": "7dd74a5c6b55d172cd0b611d9af4ab04c6d3ba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3MDcxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r510870717", "bodyText": "Is the Optional really needed ?", "author": "radtriste", "createdAt": "2020-10-23T13:07:34Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/conf/StaticConfigBean.java", "diffHunk": "@@ -14,21 +14,34 @@\n  */\n package org.kie.kogito.conf;\n \n+import java.util.Optional;\n+\n public class StaticConfigBean implements ConfigBean {\n \n     private String serviceUrl;\n+    private Optional<Boolean> useCloudEvents = Optional.empty();", "originalCommit": "920c27b7e7ecb8d1b884f0fa33280b55924ac88c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExOTM2NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r512119364", "bodyText": "tagged you at the use site", "author": "evacchi", "createdAt": "2020-10-26T16:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3MDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExOTE5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/807#discussion_r512119194", "bodyText": "the Optional is currently required at the use-sites @radtriste we can iterate and improve over this in further PRs though", "author": "evacchi", "createdAt": "2020-10-26T16:55:45Z", "path": "kogito-codegen/src/main/resources/class-templates/CdiMessageProducerTemplate.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package org.kie.kogito.test;\n+\n+import org.kie.api.runtime.process.ProcessInstance;\n+import org.kie.kogito.conf.ConfigBean;\n+import org.kie.kogito.event.impl.DefaultEventMarshaller;\n+import org.kie.kogito.services.event.CloudEventEmitter;\n+import org.kie.kogito.services.event.impl.AbstractMessageProducer;\n+\n+@javax.enterprise.context.ApplicationScoped()\n+public class MessageProducer extends AbstractMessageProducer<$DataType$, $DataEventType$> {\n+\n+    @javax.inject.Inject()\n+    CloudEventEmitter emitter;\n+    @javax.inject.Inject()\n+    ConfigBean configBean;\n+\n+    @javax.annotation.PostConstruct\n+    public void init() {\n+        setParams(emitter,\n+                  new DefaultEventMarshaller(),\n+                  configBean.useCloudEvents());", "originalCommit": "920c27b7e7ecb8d1b884f0fa33280b55924ac88c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57f44650c953414f6602f60d8890eb8f06d64e98", "url": "https://github.com/kiegroup/kogito-runtimes/commit/57f44650c953414f6602f60d8890eb8f06d64e98", "message": "KOGITO-3408 CloudEvent Kafka Publisher/Emitter (Quarkus)", "committedDate": "2020-10-27T07:32:58Z", "type": "commit"}, {"oid": "115a504315c41fb229b028e97227cf4432b27f95", "url": "https://github.com/kiegroup/kogito-runtimes/commit/115a504315c41fb229b028e97227cf4432b27f95", "message": "renaming modules to addons", "committedDate": "2020-10-27T07:32:58Z", "type": "commit"}, {"oid": "6a54645cbf44b22749dfc87d38018ec0349b0540", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6a54645cbf44b22749dfc87d38018ec0349b0540", "message": "rm unused dep", "committedDate": "2020-10-27T07:32:58Z", "type": "commit"}, {"oid": "6a54645cbf44b22749dfc87d38018ec0349b0540", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6a54645cbf44b22749dfc87d38018ec0349b0540", "message": "rm unused dep", "committedDate": "2020-10-27T07:32:58Z", "type": "forcePushed"}]}