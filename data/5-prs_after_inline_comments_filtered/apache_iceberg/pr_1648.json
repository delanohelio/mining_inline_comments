{"pr_number": 1648, "pr_title": "Move to Apache Avro 1.10.1", "pr_createdAt": "2020-10-22T19:26:26Z", "pr_url": "https://github.com/apache/iceberg/pull/1648", "timeline": [{"oid": "effe75ba793f259513711d2100929e9603969174", "url": "https://github.com/apache/iceberg/commit/effe75ba793f259513711d2100929e9603969174", "message": "Move to Apache Avro 1.10.0", "committedDate": "2020-10-22T19:34:16Z", "type": "forcePushed"}, {"oid": "43b8d9759aa5502eadba434821d31048765fd8a6", "url": "https://github.com/apache/iceberg/commit/43b8d9759aa5502eadba434821d31048765fd8a6", "message": "Move to Apache Avro 1.10.0", "committedDate": "2020-10-22T20:07:27Z", "type": "forcePushed"}, {"oid": "775b3dc5da43de46160ee3adb7193432866267f6", "url": "https://github.com/apache/iceberg/commit/775b3dc5da43de46160ee3adb7193432866267f6", "message": "Make the stylechecker happy", "committedDate": "2020-10-25T12:44:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQzMzA2NA==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r551433064", "bodyText": "This comment looks like the victim of an unintended search and replace.", "author": "massdosage", "createdAt": "2021-01-04T16:43:45Z", "path": "api/src/test/java/org/apache/iceberg/AssertHelpers.java", "diffHunk": "@@ -28,7 +30,8 @@ private AssertHelpers() {\n   }\n \n   /**\n-   * A convenience method to avoid a large number of @Test(expected=...) tests\n+   * A convenience method to avoid a large numb/test/java/org/apache/iceberg/TestHelpers.java", "originalCommit": "c3451c821812972b9a018efe8c358ef29602686f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzkwNzE4Mg==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r553907182", "bodyText": "Good catch, thanks!", "author": "Fokko", "createdAt": "2021-01-08T12:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQzMzA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAzMzY4Mw==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r556033683", "bodyText": "Remove this? Seems to be a remnant of the previous search/replace.", "author": "shardulm94", "createdAt": "2021-01-12T19:42:12Z", "path": "api/src/test/java/org/apache/iceberg/AssertHelpers.java", "diffHunk": "@@ -29,6 +31,7 @@ private AssertHelpers() {\n \n   /**\n    * A convenience method to avoid a large number of @Test(expected=...) tests\n+   * of @Test(expected=...) tests", "originalCommit": "f6207fc11cc752ac2e2d721442ae0b2b63012d08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1ce1fc8b8ee901d8a594e4566e853d235351ef5", "url": "https://github.com/apache/iceberg/commit/b1ce1fc8b8ee901d8a594e4566e853d235351ef5", "message": "Remove unnecessary changes", "committedDate": "2021-01-18T14:33:06Z", "type": "forcePushed"}, {"oid": "264abc739a8a442142feefce91e26566771433b7", "url": "https://github.com/apache/iceberg/commit/264abc739a8a442142feefce91e26566771433b7", "message": "Bump to 1.10.1", "committedDate": "2021-01-18T16:05:56Z", "type": "forcePushed"}, {"oid": "dacb650914cdd457b2a4b4a1f9e29e67051486d0", "url": "https://github.com/apache/iceberg/commit/dacb650914cdd457b2a4b4a1f9e29e67051486d0", "message": "Bump to 1.10.1", "committedDate": "2021-01-18T17:03:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQzNjIyMg==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r568436222", "bodyText": "Javadoc looks wrong, cut and paste error?", "author": "massdosage", "createdAt": "2021-02-02T09:11:16Z", "path": "api/src/test/java/org/apache/iceberg/AssertHelpers.java", "diffHunk": "@@ -137,4 +139,16 @@ private static void handleException(String message,\n       throw e;\n     }\n   }\n+\n+  /**\n+   * A convenience method to assert the cause of thrown exception.", "originalCommit": "24a6e5ca87eea919e86221c00db62902b742c154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTg3NDk1MA==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r571874950", "bodyText": "Good catch, thanks!", "author": "Fokko", "createdAt": "2021-02-08T08:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQzNjIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQzNzI0Nw==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r568437247", "bodyText": "Same here.", "author": "massdosage", "createdAt": "2021-02-02T09:12:45Z", "path": "parquet/src/test/java/org/apache/iceberg/TestHelpers.java", "diffHunk": "@@ -85,4 +87,17 @@ private static void handleException(String message,\n       throw e;\n     }\n   }\n+\n+  /**\n+   * A convenience method to assert the cause of thrown exception.", "originalCommit": "24a6e5ca87eea919e86221c00db62902b742c154", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTg3NDk5Nw==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r571874997", "bodyText": "Good catch, thanks!", "author": "Fokko", "createdAt": "2021-02-08T08:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQzNzI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg4NjAzNQ==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r579886035", "bodyText": "I think this should still use projectedLocation. Looks like it might just be a typo.", "author": "rdblue", "createdAt": "2021-02-21T23:40:47Z", "path": "core/src/test/java/org/apache/iceberg/avro/TestReadProjection.java", "diffHunk": "@@ -221,10 +221,10 @@ public void testNestedStructProjection() throws Exception {\n     );\n \n     projected = writeAndRead(\"latitude_only\", writeSchema, latOnly, record);\n-    projectedLocation = (Record) projected.get(\"location\");\n-    Assert.assertNull(\"Should not project id\", projected.get(\"id\"));\n+    Record projectedLocation = (Record) projected.get(\"location\");\n+    AssertHelpers.assertEmptyAvroField(projected, \"id\");\n     Assert.assertNotNull(\"Should project location\", projected.get(\"location\"));\n-    Assert.assertNull(\"Should not project longitude\", projectedLocation.get(\"long\"));\n+    AssertHelpers.assertEmptyAvroField(projected, \"long\");", "originalCommit": "04f5901b8f683bc9e06115ffd3319a9b93c3afb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjIyMjQ4OA==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r592222488", "bodyText": "Good catch, probably a copy-paste!", "author": "Fokko", "createdAt": "2021-03-11T10:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg4NjAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg4Njc0MQ==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r579886741", "bodyText": "This change results in creating a new Decimal for every value. While I don't think that we use this very much, I would rather not introduce object allocation for every conversion. Can you add a static cache for these? That was the purpose of decimalsByScale.", "author": "rdblue", "createdAt": "2021-02-21T23:46:28Z", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetAvro.java", "diffHunk": "@@ -169,12 +164,14 @@ public String getLogicalTypeName() {\n \n     @Override\n     public BigDecimal fromFixed(GenericFixed value, Schema schema, LogicalType type) {\n-      return super.fromFixed(value, schema, decimalsByScale[((ParquetDecimal) type).scale()]);\n+      final ParquetDecimal dec = (ParquetDecimal) type;\n+      return super.fromFixed(value, schema, LogicalTypes.decimal(dec.precision(), dec.scale()));", "originalCommit": "04f5901b8f683bc9e06115ffd3319a9b93c3afb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjIzNTI4NQ==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r592235285", "bodyText": "I know, but we didn't take the scale into account, so it could actually change the scale. I fixed this in the fromFixed by directly creating the BigDecimal, this is what's happening in the Avro library:\n    @Override\n    public BigDecimal fromFixed(GenericFixed value, Schema schema, LogicalType type) {\n      int scale = ((LogicalTypes.Decimal) type).getScale();\n      return new BigDecimal(new BigInteger(value.bytes()), scale);\n    }\n\nFor the toFixed this isn't that trivial, since this would mean copying a lot of code.", "author": "Fokko", "createdAt": "2021-03-11T10:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg4Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDU3OTgyNw==", "url": "https://github.com/apache/iceberg/pull/1648#discussion_r594579827", "bodyText": "I think it's fine to delegate to toFixed. I just don't want to call LogicalTypes.decimal every time to create a new decimal LogicalType with the same scale and precision. I think just adding a cache keyed by a Pair of scale and precision would fix it.", "author": "rdblue", "createdAt": "2021-03-15T18:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTg4Njc0MQ=="}], "type": "inlineReview"}, {"oid": "a0328ac77755bddb6b7b69ec045f6ecf2e5034d8", "url": "https://github.com/apache/iceberg/commit/a0328ac77755bddb6b7b69ec045f6ecf2e5034d8", "message": "Update docstring", "committedDate": "2021-03-11T08:36:26Z", "type": "forcePushed"}, {"oid": "9029e12aec0472c27efd517f51d373cc33b2825b", "url": "https://github.com/apache/iceberg/commit/9029e12aec0472c27efd517f51d373cc33b2825b", "message": "Move to Apache Avro 1.10.1", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "5838e708f5d913ce8e100a775b71d039e6e59447", "url": "https://github.com/apache/iceberg/commit/5838e708f5d913ce8e100a775b71d039e6e59447", "message": "Make the stylechecker happy", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "bc1f033b438aaa0876a926fe7a73f74424ecf0c5", "url": "https://github.com/apache/iceberg/commit/bc1f033b438aaa0876a926fe7a73f74424ecf0c5", "message": "Fix the conversions", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "bd9757f511abac6c2e2a758a518e968d1a8dec68", "url": "https://github.com/apache/iceberg/commit/bd9757f511abac6c2e2a758a518e968d1a8dec68", "message": "Remove accidental search/replace", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "bf8439bf40bbd2bd07665042409021d2f617d34e", "url": "https://github.com/apache/iceberg/commit/bf8439bf40bbd2bd07665042409021d2f617d34e", "message": "Bump to 1.10.1", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "919aa92cad3554139aabcaf474b1b09cc1215fe3", "url": "https://github.com/apache/iceberg/commit/919aa92cad3554139aabcaf474b1b09cc1215fe3", "message": "Update docstring", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "01411841256191b91e50ac8b7086d9d8d8314b8b", "url": "https://github.com/apache/iceberg/commit/01411841256191b91e50ac8b7086d9d8d8314b8b", "message": "Address comments", "committedDate": "2021-03-23T20:42:42Z", "type": "commit"}, {"oid": "f931bbfec7764c6da41c9b4f7867786e6367c6f6", "url": "https://github.com/apache/iceberg/commit/f931bbfec7764c6da41c9b4f7867786e6367c6f6", "message": "Bump to Avro 1.10.2", "committedDate": "2021-03-23T20:43:13Z", "type": "commit"}, {"oid": "f931bbfec7764c6da41c9b4f7867786e6367c6f6", "url": "https://github.com/apache/iceberg/commit/f931bbfec7764c6da41c9b4f7867786e6367c6f6", "message": "Bump to Avro 1.10.2", "committedDate": "2021-03-23T20:43:13Z", "type": "forcePushed"}, {"oid": "30db7ec39f10225e182a1878be8ae2e403d6bfe3", "url": "https://github.com/apache/iceberg/commit/30db7ec39f10225e182a1878be8ae2e403d6bfe3", "message": "Add cache", "committedDate": "2021-03-23T21:05:11Z", "type": "commit"}, {"oid": "30db7ec39f10225e182a1878be8ae2e403d6bfe3", "url": "https://github.com/apache/iceberg/commit/30db7ec39f10225e182a1878be8ae2e403d6bfe3", "message": "Add cache", "committedDate": "2021-03-23T21:05:11Z", "type": "forcePushed"}, {"oid": "737135b0defb21e8216f7b4febae00a7a523f847", "url": "https://github.com/apache/iceberg/commit/737135b0defb21e8216f7b4febae00a7a523f847", "message": "Merge branch 'master' of github.com:apache/iceberg into fd-move-to-avro-1-10", "committedDate": "2021-04-06T19:46:51Z", "type": "commit"}, {"oid": "e4700843eb73817f642d528359bd4cfb8593f614", "url": "https://github.com/apache/iceberg/commit/e4700843eb73817f642d528359bd4cfb8593f614", "message": "Merge branch 'master' into fd-move-to-avro-1-10", "committedDate": "2021-07-12T20:33:15Z", "type": "commit"}, {"oid": "982c85a9d26644dbe20293103b017f23f6bcd658", "url": "https://github.com/apache/iceberg/commit/982c85a9d26644dbe20293103b017f23f6bcd658", "message": "Cleanup", "committedDate": "2021-07-12T20:44:45Z", "type": "commit"}, {"oid": "1405a0c0c33ef482fc5e379256a2035238c45082", "url": "https://github.com/apache/iceberg/commit/1405a0c0c33ef482fc5e379256a2035238c45082", "message": "Back to 1.10.1", "committedDate": "2021-07-13T06:34:41Z", "type": "commit"}]}