{"pr_number": 818, "pr_title": "Refactor and improve BaseRewriteManifests", "pr_createdAt": "2020-02-22T07:14:59Z", "pr_url": "https://github.com/apache/iceberg/pull/818", "timeline": [{"oid": "5f7e5e49a3b3727f6394d76aaf19be0bbbb64903", "url": "https://github.com/apache/iceberg/commit/5f7e5e49a3b3727f6394d76aaf19be0bbbb64903", "message": "refactor and improve BaseRewriteManifests", "committedDate": "2020-02-22T07:09:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzQ1Ng==", "url": "https://github.com/apache/iceberg/pull/818#discussion_r382893456", "bodyText": "I removed synchronized here because it seems unnecessary. close is either called in synchronized void addEntry() method, which is already synchronized. Or it is called in the finally blockto close all of them using thread pool. In this case,closemethod of eachWriterWrapper` will be called by different threads and no need to be synchronized.", "author": "jun-he", "createdAt": "2020-02-22T07:18:46Z", "path": "core/src/main/java/org/apache/iceberg/BaseRewriteManifests.java", "diffHunk": "@@ -325,59 +327,38 @@ long getManifestTargetSizeBytes() {\n   }\n \n   class WriterWrapper {\n-    private final Map<Integer, ManifestWriter> manifestWritersBySpecId = Maps.newConcurrentMap();\n+    private final PartitionSpec spec;\n+    private ManifestWriter writer;\n \n-    synchronized void addEntry(ManifestEntry entry, int partitionSpecId) {\n-      getWriter(partitionSpecId).existing(entry);\n+    WriterWrapper(PartitionSpec spec) {\n+      this.spec = spec;\n     }\n \n-    synchronized ManifestWriter getWriter(int partitionSpecId) {\n-      ManifestWriter writer = manifestWritersBySpecId.get(partitionSpecId);\n-      if (writer != null) {\n-        if (writer.length() < getManifestTargetSizeBytes()) {\n-          return writer;\n-        } else {\n-          close(partitionSpecId);\n-        }\n+    synchronized void addEntry(ManifestEntry entry) {\n+      if (writer == null) {\n+        writer = newWriter();\n+      } else if (writer.length() >= getManifestTargetSizeBytes()) {\n+        close();\n+        writer = newWriter();\n       }\n+      writer.existing(entry);\n+    }\n \n-      // create ManifestWriter with the correct partitionSpec\n-      PartitionSpec partitionSpec = specsById.get(partitionSpecId);\n-      OutputFile outputFile = manifestPath(manifestSuffix.getAndIncrement());\n-      writer = new ManifestWriter(partitionSpec, outputFile, snapshotId());\n-      manifestWritersBySpecId.put(partitionSpecId, writer);\n-      return writer;\n+    private ManifestWriter newWriter() {\n+      return new ManifestWriter(spec, manifestPath(manifestSuffix.getAndIncrement()), snapshotId());\n     }\n \n-    synchronized void close(int partitionSpecId) {\n-      if (manifestWritersBySpecId != null) {\n+    void close() {", "originalCommit": "5f7e5e49a3b3727f6394d76aaf19be0bbbb64903", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3MzgzNQ==", "url": "https://github.com/apache/iceberg/pull/818#discussion_r386673835", "bodyText": "If a method is not safe to be called from multiple threads, then it should use synchronized. We don't want to rely on the current set of callers.", "author": "rdblue", "createdAt": "2020-03-02T21:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzQ1Ng=="}], "type": "inlineReview"}, {"oid": "49d07800836a0017aa2817cfe012175dc8a5e09a", "url": "https://github.com/apache/iceberg/commit/49d07800836a0017aa2817cfe012175dc8a5e09a", "message": "address the review comment", "committedDate": "2020-03-04T07:52:18Z", "type": "commit"}]}