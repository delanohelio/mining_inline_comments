{"pr_number": 1367, "pr_title": "Add partition summaries in SnapshotSummary builder", "pr_createdAt": "2020-08-22T21:37:16Z", "pr_url": "https://github.com/apache/iceberg/pull/1367", "timeline": [{"oid": "e04fa66ef5db635056d610307e0259fba03cef44", "url": "https://github.com/apache/iceberg/commit/e04fa66ef5db635056d610307e0259fba03cef44", "message": "Add partition summaries in SnapshotSummary builder.", "committedDate": "2020-10-02T20:32:13Z", "type": "commit"}, {"oid": "8bb3c482495708b335c9c36763c39d2397960cbd", "url": "https://github.com/apache/iceberg/commit/8bb3c482495708b335c9c36763c39d2397960cbd", "message": "Add threshold for partition-level summaries.", "committedDate": "2020-10-02T20:48:43Z", "type": "commit"}, {"oid": "8bb3c482495708b335c9c36763c39d2397960cbd", "url": "https://github.com/apache/iceberg/commit/8bb3c482495708b335c9c36763c39d2397960cbd", "message": "Add threshold for partition-level summaries.", "committedDate": "2020-10-02T20:48:43Z", "type": "forcePushed"}, {"oid": "e0b09dcc0251ecbbc144d77d69e26cedb2551534", "url": "https://github.com/apache/iceberg/commit/e0b09dcc0251ecbbc144d77d69e26cedb2551534", "message": "Add tests.", "committedDate": "2020-10-02T21:01:42Z", "type": "commit"}, {"oid": "36d59d6b85d7d958b75112aafff68e94cba1a937", "url": "https://github.com/apache/iceberg/commit/36d59d6b85d7d958b75112aafff68e94cba1a937", "message": "Fix checkstyle.", "committedDate": "2020-10-02T23:08:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MjAwMw==", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500482003", "bodyText": "Is this because we don't know how many records an equality delete removes?", "author": "aokolnychyi", "createdAt": "2020-10-06T17:43:40Z", "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -161,27 +176,154 @@ public void merge(SnapshotSummary.Builder builder) {\n       // copy custom summary properties\n       builder.putAll(properties);\n \n+      metrics.addTo(builder);\n+      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n+      Set<String> changedPartitions = partitionMetrics.keySet();\n+      setIf(trustPartitionMetrics, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n+\n+      if (trustPartitionMetrics && changedPartitions.size() <= maxChangedPartitionsForSummaries) {\n+        setIf(changedPartitions.size() > 0, builder, PARTITION_SUMMARY_PROP, \"true\");\n+        for (String key : changedPartitions) {\n+          setIf(key != null, builder, CHANGED_PARTITION_PREFIX + key, partitionSummary(partitionMetrics.get(key)));\n+        }\n+      }\n+\n+      return builder.build();\n+    }\n+\n+    private static String partitionSummary(UpdateMetrics metrics) {\n+      ImmutableMap.Builder<String, String> partBuilder = ImmutableMap.builder();\n+      metrics.addTo(partBuilder);\n+      return MAP_JOINER.join(partBuilder.build());\n+    }\n+  }\n+\n+  private static class UpdateMetrics {\n+    private long addedSize = 0L;\n+    private long removedSize = 0L;\n+    private int addedFiles = 0;\n+    private int removedFiles = 0;\n+    private int addedDeleteFiles = 0;\n+    private int removedDeleteFiles = 0;\n+    private long addedRecords = 0L;\n+    private long deletedRecords = 0L;\n+    private long addedPosDeletes = 0L;\n+    private long removedPosDeletes = 0L;\n+    private long addedEqDeletes = 0L;\n+    private long removedEqDeletes = 0L;\n+    private boolean trustSizeAndDeleteCounts = true;\n+\n+    void clear() {\n+      this.addedSize = 0L;\n+      this.removedSize = 0L;\n+      this.addedFiles = 0;\n+      this.removedFiles = 0;\n+      this.addedDeleteFiles = 0;\n+      this.removedDeleteFiles = 0;\n+      this.addedRecords = 0L;\n+      this.deletedRecords = 0L;\n+      this.addedPosDeletes = 0L;\n+      this.removedPosDeletes = 0L;\n+      this.addedEqDeletes = 0L;\n+      this.removedEqDeletes = 0L;\n+      this.trustSizeAndDeleteCounts = true;\n+    }\n+\n+    void addTo(ImmutableMap.Builder<String, String> builder) {\n       setIf(addedFiles > 0, builder, ADDED_FILES_PROP, addedFiles);\n-      setIf(deletedFiles > 0, builder, DELETED_FILES_PROP, deletedFiles);\n+      setIf(removedFiles > 0, builder, DELETED_FILES_PROP, removedFiles);\n       setIf(addedDeleteFiles > 0, builder, ADDED_DELETE_FILES_PROP, addedDeleteFiles);\n       setIf(removedDeleteFiles > 0, builder, REMOVED_DELETE_FILES_PROP, removedDeleteFiles);\n-      setIf(deletedDuplicateFiles > 0, builder, DELETED_DUPLICATE_FILES, deletedDuplicateFiles);\n       setIf(addedRecords > 0, builder, ADDED_RECORDS_PROP, addedRecords);\n       setIf(deletedRecords > 0, builder, DELETED_RECORDS_PROP, deletedRecords);\n-      setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n-      setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n-      setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n-      setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n-      setIf(true, builder, CHANGED_PARTITION_COUNT_PROP, changedPartitions.size());\n \n-      return builder.build();\n+      if (trustSizeAndDeleteCounts) {\n+        setIf(addedSize > 0, builder, ADDED_FILE_SIZE_PROP, addedSize);\n+        setIf(removedSize > 0, builder, REMOVED_FILE_SIZE_PROP, removedSize);\n+        setIf(addedPosDeletes > 0, builder, ADDED_POS_DELETES_PROP, addedPosDeletes);\n+        setIf(removedPosDeletes > 0, builder, REMOVED_POS_DELETES_PROP, removedPosDeletes);\n+        setIf(addedEqDeletes > 0, builder, ADDED_EQ_DELETES_PROP, addedEqDeletes);\n+        setIf(removedEqDeletes > 0, builder, REMOVED_EQ_DELETES_PROP, removedEqDeletes);\n+      }\n     }\n \n-    private static void setIf(boolean expression, ImmutableMap.Builder<String, String> builder,\n-                              String property, Object value) {\n-      if (expression) {\n-        builder.put(property, String.valueOf(value));\n+    void addedFile(ContentFile<?> file) {\n+      this.addedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.addedFiles += 1;\n+          this.addedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.addedDeleteFiles += 1;\n+          this.addedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n       }\n     }\n+\n+    void removedFile(ContentFile<?> file) {\n+      this.removedSize += file.fileSizeInBytes();\n+      switch (file.content()) {\n+        case DATA:\n+          this.removedFiles += 1;\n+          this.deletedRecords += file.recordCount();\n+          break;\n+        case POSITION_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedPosDeletes += file.recordCount();\n+          break;\n+        case EQUALITY_DELETES:\n+          this.removedDeleteFiles += 1;\n+          this.removedEqDeletes += file.recordCount();\n+          break;\n+        default:\n+          throw new UnsupportedOperationException(\"Unsupported file content type: \" + file.content());\n+      }\n+    }\n+\n+    void addedManifest(ManifestFile manifest) {\n+      switch (manifest.content()) {\n+        case DATA:\n+          this.addedFiles += manifest.addedFilesCount();\n+          this.addedRecords += manifest.addedRowsCount();\n+          this.removedFiles += manifest.deletedFilesCount();\n+          this.deletedRecords += manifest.deletedRowsCount();\n+          break;\n+        case DELETES:\n+          this.addedDeleteFiles += manifest.addedFilesCount();\n+          this.removedDeleteFiles += manifest.deletedFilesCount();\n+          this.trustSizeAndDeleteCounts = false;", "originalCommit": "36d59d6b85d7d958b75112aafff68e94cba1a937", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MjM4Mw==", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500492383", "bodyText": "Actually, no. It is because we don't have row counts for the number of equality and positional deletes in delete manifests.", "author": "aokolnychyi", "createdAt": "2020-10-06T18:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MjAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4ODc4NA==", "url": "https://github.com/apache/iceberg/pull/1367#discussion_r500488784", "bodyText": "We still interpret this as the number of records in data files that were removed?", "author": "aokolnychyi", "createdAt": "2020-10-06T17:54:47Z", "path": "core/src/main/java/org/apache/iceberg/SnapshotSummary.java", "diffHunk": "@@ -35,6 +36,8 @@\n   public static final String ADDED_RECORDS_PROP = \"added-records\";\n   public static final String DELETED_RECORDS_PROP = \"deleted-records\";", "originalCommit": "36d59d6b85d7d958b75112aafff68e94cba1a937", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}