{"pr_number": 1509, "pr_title": "Flink: Integrate Flink reader to SQL", "pr_createdAt": "2020-09-25T04:28:11Z", "pr_url": "https://github.com/apache/iceberg/pull/1509", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTM3Nw==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495185377", "bodyText": "Can you update the comment to state what Flink's default precision is?", "author": "rdblue", "createdAt": "2020-09-25T19:18:54Z", "path": "flink/src/main/java/org/apache/iceberg/flink/TypeToFlinkType.java", "diffHunk": "@@ -100,8 +100,8 @@ public LogicalType primitive(Type.PrimitiveType primitive) {\n       case DATE:\n         return new DateType();\n       case TIME:\n-        // MICROS\n-        return new TimeType(6);\n+        // Flink only support TimeType with default precision now.", "originalCommit": "9924db4dbd80d94ed97987e44671fa55d591f772", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTc1NQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495185755", "bodyText": "Are these related changes, or should the time changes go into a separate PR?", "author": "rdblue", "createdAt": "2020-09-25T19:19:56Z", "path": "flink/src/test/java/org/apache/iceberg/flink/TestFlinkSchemaUtil.java", "diffHunk": "@@ -252,7 +252,7 @@ public void testInconsistentTypes() {\n         Types.BinaryType.get(), new VarBinaryType(VarBinaryType.MAX_LENGTH),\n         new VarBinaryType(100), Types.BinaryType.get());\n     checkInconsistentType(\n-        Types.TimeType.get(), new TimeType(6),\n+        Types.TimeType.get(), new TimeType(),", "originalCommit": "9924db4dbd80d94ed97987e44671fa55d591f772", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY5NTYyOA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495695628", "bodyText": "I will create one.", "author": "JingsongLi", "createdAt": "2020-09-28T05:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY5NjkyMQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495696921", "bodyText": "Created #1521", "author": "JingsongLi", "createdAt": "2020-09-28T05:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MDA5OA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496260098", "bodyText": "Merged #1521.", "author": "rdblue", "createdAt": "2020-09-28T21:59:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NTc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjM1Mw==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495186353", "bodyText": "This should be called with timestampMillis because you want to wait until it is strictly after the current snapshot's timestamp.", "author": "rdblue", "createdAt": "2020-09-25T19:21:14Z", "path": "flink/src/test/java/org/apache/iceberg/flink/source/TestFlinkScan.java", "diffHunk": "@@ -230,7 +215,7 @@ public void testSnapshotReads() throws Exception {\n     long timestampMillis = table.currentSnapshot().timestampMillis();\n \n     // produce another timestamp\n-    Thread.sleep(10);\n+    waitUntilAfter(10);", "originalCommit": "9924db4dbd80d94ed97987e44671fa55d591f772", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY5NTU5MQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r495695591", "bodyText": "Yes, you are right.", "author": "JingsongLi", "createdAt": "2020-09-28T05:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE4NjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MjIzMA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496262230", "bodyText": "Why is this waiting until 10ms from now? That's basically equivalent to Thread.sleep. The purpose of using waitUntilAfter is to ensure the next call to System.currentTimeMillis() will be after some point in time. In most cases, that's the last snapshot's timestamp.\nI think this should be waitUntilAfter(table.currentSnapshot().timestampMillis());. Then the next append will be strictly after that snapshot's timestamp, and the query with as-of-timestamp will read the older snapshot. There should be no need to wait as long as 10ms.", "author": "rdblue", "createdAt": "2020-09-28T22:04:46Z", "path": "flink/src/test/java/org/apache/iceberg/flink/source/TestFlinkScan.java", "diffHunk": "@@ -230,13 +246,16 @@ public void testSnapshotReads() throws Exception {\n     long timestampMillis = table.currentSnapshot().timestampMillis();\n \n     // produce another timestamp\n-    Thread.sleep(10);\n+    waitUntilAfter(System.currentTimeMillis() + 10);", "originalCommit": "a41dd8f8300bf16334dd5b7d9aab05f2851587de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0NTU0Mg==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496345542", "bodyText": "I see. You are right.", "author": "JingsongLi", "createdAt": "2020-09-29T02:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MjIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496268020", "bodyText": "We try to avoid using Hadoop classes in Iceberg APIs because they are hard to remove. Injecting a Hadoop Configuration is currently done in one place: to instantiate a catalog that requires it.\nThe catalog creates tables and tables are associated with a FileIO, so the configuration is passed down through that chain. The table's configuration should be used for any table configuration.\nMR also has a Hadoop Configuration, but that's required by the API so we can't remove it from the API there. But we still prefer using the table's Configuration when it is needed for components like HadoopFileIO.", "author": "rdblue", "createdAt": "2020-09-28T22:20:19Z", "path": "flink/src/main/java/org/apache/iceberg/flink/source/FlinkSource.java", "diffHunk": "@@ -89,8 +88,18 @@ public Builder table(Table newTable) {\n       return this;\n     }\n \n-    public Builder filters(List<Expression> newFilters) {\n-      this.filterExpressions = newFilters;\n+    public Builder hadoopConf(Configuration newConf) {", "originalCommit": "a41dd8f8300bf16334dd5b7d9aab05f2851587de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1MzU2OQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496353569", "bodyText": "+1 for avoiding using Hadoop Configuration.", "author": "JingsongLi", "createdAt": "2020-09-29T03:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM1NjIzNg==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496356236", "bodyText": "The reason why Hadoop conf needs to be passed now is because:\n\nJobManager needs the splits of the scan, so it needs to call Table.newScan.\nSo JobManager needs Table object, where can a table be generated? TableLoader -> from Catalog or HadoopTables.\nThe creation of Catalog and HadoopTables needs a Hadoop Configuration.\n\nMaybe we can pass this chain with an Iceberg object (FileIO may looks not good to the creation of catalog)?", "author": "JingsongLi", "createdAt": "2020-09-29T03:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NDkzOQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496894939", "bodyText": "Maybe CatalogLoader should serialize its own Configuration? It would make sense to pass one when creating a CatalogLoader for HadoopCatalog or HiveCatalog because those need a Configuration to create the catalog.", "author": "rdblue", "createdAt": "2020-09-29T16:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NjA5OA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496896098", "bodyText": "Or maybe this could use the approach from the FlinkCatalogFactory:\n  public static Configuration clusterHadoopConf() {\n    return HadoopUtils.getHadoopConfiguration(GlobalConfiguration.loadConfiguration());\n  }\nUsing clusterHadoopConf internally here would avoid the need to expose this in the API and we could add Configuration to the loader later.", "author": "rdblue", "createdAt": "2020-09-29T16:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg3NTkyNg==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r497875926", "bodyText": "Using clusterHadoopConf may not so flexible.\nI am +1 for CatalogLoader should serialize its own Configuration. I will create a PR later for source and sink.", "author": "JingsongLi", "createdAt": "2020-10-01T00:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODEwNg==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496268106", "bodyText": "Why pass the conf here? I don't see it used.", "author": "rdblue", "createdAt": "2020-09-28T22:20:34Z", "path": "flink/src/main/java/org/apache/iceberg/flink/source/FlinkInputFormat.java", "diffHunk": "@@ -45,30 +43,25 @@\n   private static final long serialVersionUID = 1L;\n \n   private final TableLoader tableLoader;\n-  private final Schema projectedSchema;\n-  private final ScanOptions options;\n-  private final List<Expression> filterExpressions;\n+  private final SerializableConfiguration serializableConf;\n   private final FileIO io;\n   private final EncryptionManager encryption;\n-  private final SerializableConfiguration serializableConf;\n+  private final ScanContext context;\n \n   private transient RowDataIterator iterator;\n \n-  FlinkInputFormat(\n-      TableLoader tableLoader, Schema projectedSchema, FileIO io, EncryptionManager encryption,\n-      List<Expression> filterExpressions, ScanOptions options, SerializableConfiguration serializableConf) {\n+  FlinkInputFormat(TableLoader tableLoader, SerializableConfiguration serializableConf, FileIO io,\n+                   EncryptionManager encryption, ScanContext context) {\n     this.tableLoader = tableLoader;\n-    this.projectedSchema = projectedSchema;\n+    this.serializableConf = serializableConf;", "originalCommit": "a41dd8f8300bf16334dd5b7d9aab05f2851587de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjM0NzczOA==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496347738", "bodyText": "It is used to open TableLoader.", "author": "JingsongLi", "createdAt": "2020-09-29T02:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5MzE5OQ==", "url": "https://github.com/apache/iceberg/pull/1509#discussion_r496893199", "bodyText": "I see now. Thanks!", "author": "rdblue", "createdAt": "2020-09-29T16:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2ODEwNg=="}], "type": "inlineReview"}, {"oid": "12a155d892b5d1003896a2a2510b60edfc1f8021", "url": "https://github.com/apache/iceberg/commit/12a155d892b5d1003896a2a2510b60edfc1f8021", "message": "Flink: Integrate Flink reader to SQL", "committedDate": "2020-09-29T02:46:08Z", "type": "commit"}, {"oid": "76363be50f1277c4168f42d984174b7bb67406e1", "url": "https://github.com/apache/iceberg/commit/76363be50f1277c4168f42d984174b7bb67406e1", "message": "Fix isBounded", "committedDate": "2020-09-29T02:46:08Z", "type": "commit"}, {"oid": "eb153545aba6d62af3adbe834672f09978942e99", "url": "https://github.com/apache/iceberg/commit/eb153545aba6d62af3adbe834672f09978942e99", "message": "Address comments", "committedDate": "2020-09-29T02:46:09Z", "type": "commit"}, {"oid": "8e1b03f20113343331b0a722b40c57d3bfa50c8f", "url": "https://github.com/apache/iceberg/commit/8e1b03f20113343331b0a722b40c57d3bfa50c8f", "message": "Address comment", "committedDate": "2020-09-29T03:14:46Z", "type": "commit"}, {"oid": "8e1b03f20113343331b0a722b40c57d3bfa50c8f", "url": "https://github.com/apache/iceberg/commit/8e1b03f20113343331b0a722b40c57d3bfa50c8f", "message": "Address comment", "committedDate": "2020-09-29T03:14:46Z", "type": "forcePushed"}]}