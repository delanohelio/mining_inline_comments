{"pr_number": 1842, "pr_title": "Hive: Refactor Hive Iceberg schema conversions to a single file", "pr_createdAt": "2020-11-27T12:01:22Z", "pr_url": "https://github.com/apache/iceberg/pull/1842", "timeline": [{"oid": "77b1d08ee80300457ceb3a911b2644e538cab156", "url": "https://github.com/apache/iceberg/commit/77b1d08ee80300457ceb3a911b2644e538cab156", "message": "Refactor Hive Iceberg schema conversions to a single file", "committedDate": "2020-11-27T11:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MDAyMA==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r532090020", "bodyText": "Don't we need to copy the comments/doc from FieldSchema as well?", "author": "rdsr", "createdAt": "2020-11-28T18:12:23Z", "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTypeConverter.java", "diffHunk": "@@ -30,7 +37,52 @@ private HiveTypeConverter() {\n \n   }\n \n-  public static String convert(Type type) {\n+  /**\n+   * Converts the Iceberg schema to a Hive schema.\n+   * @param schema The original Iceberg schema to convert\n+   * @return The Hive column list generated from the Iceberg schema\n+   */\n+  public static List<FieldSchema> hiveSchema(Schema schema) {\n+    return schema.columns().stream()\n+        .map(col -> new FieldSchema(col.name(), HiveTypeConverter.convert(col.type()), \"\"))\n+        .collect(Collectors.toList());\n+  }\n+\n+  /**\n+   * Converts the list of Hive FieldSchemas to an Iceberg schema.\n+   * <p>\n+   * The list should contain the columns and the partition columns as well.\n+   * @param fieldSchemas The list of the columns\n+   * @return An equivalent Iceberg Schema\n+   */\n+  public static Schema icebergSchema(List<FieldSchema> fieldSchemas) {\n+    List<String> names = new ArrayList<>(fieldSchemas.size());\n+    List<TypeInfo> typeInfos = new ArrayList<>(fieldSchemas.size());\n+\n+    for (FieldSchema col : fieldSchemas) {\n+      names.add(col.getName());\n+      typeInfos.add(TypeInfoUtils.getTypeInfoFromTypeString(col.getType()));", "originalCommit": "77b1d08ee80300457ceb3a911b2644e538cab156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzI5MA==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r532633290", "bodyText": "Thanks @rdsr for the review!\nIn my previous PRs I have been asked to stick to minimal changes so it is easier to review, so I did not even started to think about adding any change here \ud83d\ude04 (I have been in the reviewing end of the changes and I definitely understand the pain of reviewing the big changes)\nThat said, your suggestion definitely worth checking. I have some concerns that Hive might disregard the comments set in the schema. I have seen columns with \"from deserializer\" and I am a little bit concerned about how Hive will handle this.\nWould you think this should be another PR, or should we handle this here?\nThanks,\nPeter", "author": "pvary", "createdAt": "2020-11-30T14:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwMDg4Ng==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r533600886", "bodyText": "Handling it separately is fine!", "author": "rdsr", "createdAt": "2020-12-01T17:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5MDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3NTk3OQ==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r536475979", "bodyText": "Most of the other modules use a different naming convention:\n\nAvroSchemaUtil.convert for Schema to Iceberg type and Iceberg type to Schema\nParquetSchemaUtil.convert\nSparkSchemaUtil.convert\nFlinkSchemaUtil.convert\n\nI think it would be nice to use the same convention here: use HiveSchemaUtil instead of HiveTypeConverter and then use overloads of convert. This would also make the API a bit less confusing because HiveTypeConverter and HiveSchemaConverter are very similar names and share a lot of the same tasks with different method args. Could these be combined into one?\nSome schema classes have a different type for the top-level schema (Iceberg and Parquet) and we usually convert between the two. Here, I think you could convert between Iceberg Schema and List<FieldSchema>, and between Iceberg Type and TypeInfo.", "author": "rdblue", "createdAt": "2020-12-05T01:38:03Z", "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTypeConverter.java", "diffHunk": "@@ -30,7 +37,52 @@ private HiveTypeConverter() {\n \n   }\n \n-  public static String convert(Type type) {\n+  /**\n+   * Converts the Iceberg schema to a Hive schema.\n+   * @param schema The original Iceberg schema to convert\n+   * @return The Hive column list generated from the Iceberg schema\n+   */\n+  public static List<FieldSchema> hiveSchema(Schema schema) {", "originalCommit": "77b1d08ee80300457ceb3a911b2644e538cab156", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA0MTY0MA==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r537041640", "bodyText": "Thanks @rdblue for the review!\nRenamed the class to HiveSchemaUtil and the methods to convert. Also added convert methods for Type conversion.\nKept the HiveSchemaConverter class for now for 2 reasons:\n\nWe have to extend the actual converter for Hive3 (Timestamp with local timezone is a separate type in Hive 3)\nYou suggested to implement a Hive type visitor on another review - we might want to use that for conversions when it is ready\n\nUntil we have a final solution I added a javadoc where specifically stated that this package private class should not be used anywhere for conversion and pointed to the correct class to use.\nWhat do you think? Would this be good enough for start?\nThanks,\nPeter", "author": "pvary", "createdAt": "2020-12-06T13:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MTkxMw==", "url": "https://github.com/apache/iceberg/pull/1842#discussion_r537861913", "bodyText": "Yes, sounds like you're heading in the direction I suggested. I'm flexible on how we get there and would defer to your judgement on it.", "author": "rdblue", "createdAt": "2020-12-07T21:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3NTk3OQ=="}], "type": "inlineReview"}, {"oid": "deaa613f27fa2468e7a30be0abe6fb78df826b9b", "url": "https://github.com/apache/iceberg/commit/deaa613f27fa2468e7a30be0abe6fb78df826b9b", "message": "Renamed HiveTypeConverter.java to HiveSchemaUtil.java and renamed all the conversion methods to convert.\nAlso added conversion methods for Types and added tests for Type conversions as well.", "committedDate": "2020-12-06T13:34:43Z", "type": "commit"}]}