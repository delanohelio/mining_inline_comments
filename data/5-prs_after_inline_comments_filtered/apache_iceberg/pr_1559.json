{"pr_number": 1559, "pr_title": "Core: Update version-hint.txt atomically", "pr_createdAt": "2020-10-07T07:52:27Z", "pr_url": "https://github.com/apache/iceberg/pull/1559", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwOTU5Mg==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500809592", "bodyText": "I would go for an uniq name here so 2 concurrent commits will not interfere", "author": "pvary", "createdAt": "2020-10-07T07:54:55Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );", "originalCommit": "5a09525b142ae249a2e4e75df0aae8eaf75a242f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMDU4NA==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500810584", "bodyText": "Formatting checks might fail here.\nI have learned that it is worth to run checkstyle checks before committing:\n./gradlew build -x test", "author": "pvary", "createdAt": "2020-10-07T07:56:28Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{", "originalCommit": "5a09525b142ae249a2e4e75df0aae8eaf75a242f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTIwNQ==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811205", "bodyText": "We might want to close the stream here (try with resources block can help)", "author": "pvary", "createdAt": "2020-10-07T07:57:30Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);\n+      }\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n+    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n+    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));", "originalCommit": "5a09525b142ae249a2e4e75df0aae8eaf75a242f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxMTUwOQ==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500811509", "bodyText": "Again concurrency can be problematic here", "author": "pvary", "createdAt": "2020-10-07T07:58:01Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,25 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      if (fs.exists(versionHintFile)) {\n+        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n+        writeFileToPath(fs, tempVersionHintFile);\n+        fs.delete(versionHintFile, false);\n+        fs.rename(tempVersionHintFile, versionHintFile);\n+      } else {\n+        writeFileToPath(fs, versionHintFile);", "originalCommit": "5a09525b142ae249a2e4e75df0aae8eaf75a242f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NTY3Mg==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500865672", "bodyText": "I wouldn't set overwrite to true to ensure this doesn't break anything. (In practice it won't, but it should be much clearer with overwrite = false.)", "author": "HeartSaVioR", "createdAt": "2020-10-07T09:23:03Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -295,22 +295,19 @@ private void writeVersionHint(int versionToWrite) {\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n     try {\n-      if (fs.exists(versionHintFile)) {\n-        Path tempVersionHintFile = metadataPath(\"version-hint.temp\" );\n-        writeFileToPath(fs, tempVersionHintFile);\n-        fs.delete(versionHintFile, false);\n-        fs.rename(tempVersionHintFile, versionHintFile);\n-      } else {\n-        writeFileToPath(fs, versionHintFile);\n-      }\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n-  private void writeFileToPath(FileSystem fs, Path path) throws IOException{\n-    FSDataOutputStream out = fs.create(path, true /* overwrite */);\n-    out.write(String.valueOf(path).getBytes(StandardCharsets.UTF_8));\n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, true /* overwrite */)) {", "originalCommit": "09fa44bf01463a36ae22ad384abe75c84809a3a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzNjE2Mg==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r500936162", "bodyText": "Thanks for the review. Done", "author": "lcspinter", "createdAt": "2020-10-07T11:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1ODUzNQ==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r511158535", "bodyText": "Boolean parameters need inline comments to explain what they are. What does false here do?", "author": "rdblue", "createdAt": "2020-10-23T21:14:56Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);\n+      fs.rename(tempVersionHintFile, versionHintFile);\n     } catch (IOException e) {\n       LOG.warn(\"Failed to update version hint\", e);\n     }\n   }\n \n+  private void writeVersionToPath(FileSystem fs, Path path, int versionToWrite) throws IOException {\n+    try (FSDataOutputStream out = fs.create(path, false)) {", "originalCommit": "f087434f602e8644353fc798369d11bd78387c29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ecad5e13a3867531aeb40ae50bd86f6f6fa5762", "url": "https://github.com/apache/iceberg/commit/2ecad5e13a3867531aeb40ae50bd86f6f6fa5762", "message": "Core: Update version-hint.txt atomically", "committedDate": "2020-10-29T10:02:08Z", "type": "commit"}, {"oid": "71cd1455fb70dda4f25133397998a53ee1c3f7f1", "url": "https://github.com/apache/iceberg/commit/71cd1455fb70dda4f25133397998a53ee1c3f7f1", "message": "Generate unique temp version-hint file name and some minor changes.", "committedDate": "2020-10-29T10:02:08Z", "type": "commit"}, {"oid": "3644929b1b1269d0bb08de6339868710ff1956e6", "url": "https://github.com/apache/iceberg/commit/3644929b1b1269d0bb08de6339868710ff1956e6", "message": "Set overwrite=false", "committedDate": "2020-10-29T10:02:09Z", "type": "commit"}, {"oid": "716e86b182abff566aeb7e032924627ec97c36d6", "url": "https://github.com/apache/iceberg/commit/716e86b182abff566aeb7e032924627ec97c36d6", "message": "Add inline parameter comment for Filesystem.create() call", "committedDate": "2020-10-29T10:06:17Z", "type": "commit"}, {"oid": "716e86b182abff566aeb7e032924627ec97c36d6", "url": "https://github.com/apache/iceberg/commit/716e86b182abff566aeb7e032924627ec97c36d6", "message": "Add inline parameter comment for Filesystem.create() call", "committedDate": "2020-10-29T10:06:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5Mjc5MQ==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r514392791", "bodyText": "This one needs a comment to clarify false as well.", "author": "rdblue", "createdAt": "2020-10-29T16:23:08Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTableOperations.java", "diffHunk": "@@ -294,13 +294,22 @@ private void writeVersionHint(int versionToWrite) {\n     Path versionHintFile = versionHintFile();\n     FileSystem fs = getFileSystem(versionHintFile, conf);\n \n-    try (FSDataOutputStream out = fs.create(versionHintFile, true /* overwrite */)) {\n-      out.write(String.valueOf(versionToWrite).getBytes(StandardCharsets.UTF_8));\n+    try {\n+      Path tempVersionHintFile = metadataPath(UUID.randomUUID().toString() + \"-version-hint.temp\");\n+      writeVersionToPath(fs, tempVersionHintFile, versionToWrite);\n+      fs.delete(versionHintFile, false);", "originalCommit": "716e86b182abff566aeb7e032924627ec97c36d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5NjA5NQ==", "url": "https://github.com/apache/iceberg/pull/1559#discussion_r514396095", "bodyText": "Thanks. Fixed it.", "author": "lcspinter", "createdAt": "2020-10-29T16:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM5Mjc5MQ=="}], "type": "inlineReview"}, {"oid": "595e31fdcd1b58994ee461076517be88243612c4", "url": "https://github.com/apache/iceberg/commit/595e31fdcd1b58994ee461076517be88243612c4", "message": "Add inline parameter comment for Filesystem.delete() call", "committedDate": "2020-10-29T16:26:20Z", "type": "commit"}]}