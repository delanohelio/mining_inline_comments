{"pr_number": 1979, "pr_title": "Support for role based access of HadoopCatalog table listing #1941", "pr_createdAt": "2020-12-23T15:32:58Z", "pr_url": "https://github.com/apache/iceberg/pull/1979", "timeline": [{"oid": "97f0e4636d028c5f3cf266d501c0f4e5c874dff4", "url": "https://github.com/apache/iceberg/commit/97f0e4636d028c5f3cf266d501c0f4e5c874dff4", "message": "Set up CI with Azure Pipelines\n\n[skip ci]", "committedDate": "2020-12-21T14:59:05Z", "type": "commit"}, {"oid": "0b3a92b504181d5de730bd83c66375a8f6a3ace5", "url": "https://github.com/apache/iceberg/commit/0b3a92b504181d5de730bd83c66375a8f6a3ace5", "message": "avoid using deprecated hadoop filesystem exist and isDirectory", "committedDate": "2020-12-22T20:06:02Z", "type": "commit"}, {"oid": "efa8c87018290ff41ed6a529f34b859d1804f67c", "url": "https://github.com/apache/iceberg/commit/efa8c87018290ff41ed6a529f34b859d1804f67c", "message": "removed unused filter", "committedDate": "2020-12-23T15:24:27Z", "type": "commit"}, {"oid": "4c672213740dca9b70a07e80249764aaf5654ec4", "url": "https://github.com/apache/iceberg/commit/4c672213740dca9b70a07e80249764aaf5654ec4", "message": "removed pipeline file", "committedDate": "2020-12-23T15:36:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2NzkwNw==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r549467907", "bodyText": "This should throw either RuntimeIOException or UncheckedIOException. If the status can't be loaded, returning false is not correct.", "author": "rdblue", "createdAt": "2020-12-28T19:50:29Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -139,6 +139,25 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean isTableDir(Path path) {\n+    Path metadataPath = new Path(path, \"metadata\");\n+    // Only the path which contains metadata is the path for table, otherwise it could be\n+    // still a namespace.\n+    try {\n+      return fs.listStatus(metadataPath, TABLE_FILTER).length >= 1;\n+    } catch (IOException e) {\n+      return false;\n+    }\n+  }\n+\n+  private boolean isDirectory(Path path) {\n+    try {\n+      return fs.getFileStatus(path).isDirectory();\n+    } catch (IOException e) {\n+      return false;", "originalCommit": "4c672213740dca9b70a07e80249764aaf5654ec4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r549468068", "bodyText": "Same here. Returning false is not correct.", "author": "rdblue", "createdAt": "2020-12-28T19:51:13Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -139,6 +139,25 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean isTableDir(Path path) {\n+    Path metadataPath = new Path(path, \"metadata\");\n+    // Only the path which contains metadata is the path for table, otherwise it could be\n+    // still a namespace.\n+    try {\n+      return fs.listStatus(metadataPath, TABLE_FILTER).length >= 1;\n+    } catch (IOException e) {\n+      return false;", "originalCommit": "4c672213740dca9b70a07e80249764aaf5654ec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTczNDE4Mg==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r549734182", "bodyText": "We use the iceberg HadoopCatalog over Azure ABFS, Users use spark to list the tables in the catalog. However not every user has access to all tables on disk (we use file system access control list). When a user cannot access a folder the listStatus function will throw a subclass of IOException.\nIn my ticket I suggested using a flag to configure the HadoopCatalog to throw errors when unable to list these directories or return false if it is expected that some users will not be able to list all folders/tables.\n#1941\nThe listStatus throws an FileNotFoundException when the path provided does not exists. I will handle that as a \"normal\" condition, any other IOException I will either catch or not based on a configuration flag.  This should handle scenarios where not all user's can access all tables/namespaces\nWhat do you think about that proposal?", "author": "cccs-jc", "createdAt": "2020-12-29T14:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc5ODU3NQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r549798575", "bodyText": "I think it makes sense to catch FileNotFoundException and return false. What is the exception class that you get when a user can't list path? I would rather use that instead of suppressing any IOException if there is a flag set.\nIt is also unclear how that suppression is set.", "author": "rdblue", "createdAt": "2020-12-29T18:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIwNDQ4MQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r550204481", "bodyText": "I've added support for a flag. However I have not yet retrieved the value from the configuration properties.\nThe exception thrown is this one:\nhttps://hadoop.apache.org/docs/r3.2.0/api/org/apache/hadoop/fs/azurebfs/contracts/exceptions/AbfsRestOperationException.html\nIOException\nAzureBlobFileSystemException\nAbfsRestOperationException\nUnfortunately the exception thrown is an ABFS specific class.", "author": "cccs-jc", "createdAt": "2020-12-30T14:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDY4NTI4NA==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r550685284", "bodyText": "Should the boolean be configurable? How are you setting it?", "author": "rdblue", "createdAt": "2020-12-31T20:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA2NTIxMQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r551065211", "bodyText": "Hey Ryan, sorry for the late reply. Ya I'm thinking it could support a flag passed in as a configuration via the org.apache.hadoop.conf.Configuration\nI'm just not sure how to pass values into that configuration object. For example there is already a FILE_IO_IMPL supported. How would I add an additional configuration like FILE_IO_IMPL?", "author": "cccs-jc", "createdAt": "2021-01-03T22:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MzU5MQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553053591", "bodyText": "Getting the config from catalog properties looks good, but I'd move the property constant as I noted above.", "author": "rdblue", "createdAt": "2021-01-07T01:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDkwOTQwNg==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r560909406", "bodyText": "this is really brittle design. It will only work for one specific store and contains the assumption that the store always returns the string \"AuthorizationPermissionMismatch\" on an error. If the abfs store ever changed that string everything will break.\n\nThat abfs exception also includes a status code, 403, which is what should really be used as the signal.\nOther stores return AccessDeniedException. Has anyone considered filing a hadoop bug asking for translation of rest exceptions with 403s into those? I am reasonably confident nobody is going reject PRs there.", "author": "steveloughran", "createdAt": "2021-01-20T12:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ2ODA2OA=="}], "type": "inlineReview"}, {"oid": "2219cd9edd845d7490ce294e7f53e10c6104f1ef", "url": "https://github.com/apache/iceberg/commit/2219cd9edd845d7490ce294e7f53e10c6104f1ef", "message": "added flag for suppressing ACL exceptions", "committedDate": "2020-12-29T16:11:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNTkxMQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r551425911", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean suppressACLExcpetion = false;\n          \n          \n            \n              private boolean suppressACLException = false;", "author": "massdosage", "createdAt": "2021-01-04T16:32:19Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -80,6 +82,7 @@\n   private final String warehouseLocation;\n   private final FileSystem fs;\n   private final FileIO fileIO;\n+  private boolean suppressACLExcpetion = false;", "originalCommit": "2219cd9edd845d7490ce294e7f53e10c6104f1ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNzUzOQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r551427539", "bodyText": "These exceptions could be thrown be errors that don't have anything to do with ACL so can we try come up with a more generic name for this flag? suppressIOException maybe? I guess it depends on where they will be configured and how.", "author": "massdosage", "createdAt": "2021-01-04T16:35:03Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -139,6 +142,37 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean isTableDir(Path path) {\n+    Path metadataPath = new Path(path, \"metadata\");\n+    // Only the path which contains metadata is the path for table, otherwise it could be\n+    // still a namespace.\n+    try {\n+      return fs.listStatus(metadataPath, TABLE_FILTER).length >= 1;\n+    } catch (FileNotFoundException e) {\n+      return false;\n+    } catch (IOException e) {\n+      if (suppressACLExcpetion) {", "originalCommit": "2219cd9edd845d7490ce294e7f53e10c6104f1ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ3Mjc4NQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r551472785", "bodyText": "fair enough.\nI'm going to add this configuration like it is done for the FILE_IO_IMPL for example.", "author": "cccs-jc", "createdAt": "2021-01-04T17:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQyNzUzOQ=="}], "type": "inlineReview"}, {"oid": "ac5e25e6118d35058b5fd31b9740a5e56388694d", "url": "https://github.com/apache/iceberg/commit/ac5e25e6118d35058b5fd31b9740a5e56388694d", "message": "made suppresion configurable", "committedDate": "2021-01-05T18:58:27Z", "type": "commit"}, {"oid": "c865b3597c78d48f1b49b46a84bd79ebe7dda3ca", "url": "https://github.com/apache/iceberg/commit/c865b3597c78d48f1b49b46a84bd79ebe7dda3ca", "message": "check if azure blob exception", "committedDate": "2021-01-06T19:18:03Z", "type": "commit"}, {"oid": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "url": "https://github.com/apache/iceberg/commit/a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "message": "Merge remote-tracking branch 'upstream/master'\n\nConflicts:\n\tcore/src/main/java/org/apache/iceberg/CatalogProperties.java\n\tcore/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "committedDate": "2021-01-06T19:30:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjEyMQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553052121", "bodyText": "Since this is specific to Hadoop, let's move it into HadoopCatalog. I don't think the other catalogs would need this because they do not list using FS operations. A private constant in HadoopCatalog should be fine and we can always expose it later if we need to.", "author": "rdblue", "createdAt": "2021-01-07T01:06:13Z", "path": "core/src/main/java/org/apache/iceberg/CatalogProperties.java", "diffHunk": "@@ -34,6 +34,8 @@ private CatalogProperties() {\n   public static final String HIVE_CLIENT_POOL_SIZE = \"clients\";\n   public static final int HIVE_CLIENT_POOL_SIZE_DEFAULT = 2;\n \n+  public static final String HADOOP_SUPPRESS_IOEXCEPTION = \"suppress-io-exception\";", "originalCommit": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjM1NQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553052355", "bodyText": "Can you move this to after fileIO is set? The line above and that line are related so we shouldn't separate them.", "author": "rdblue", "createdAt": "2021-01-07T01:06:57Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -129,6 +136,8 @@ public void initialize(String name, Map<String, String> properties) {\n     this.fs = Util.getFs(new Path(warehouseLocation), conf);\n \n     String fileIOImpl = properties.get(CatalogProperties.FILE_IO_IMPL);\n+    this.suppressIOException = Boolean.parseBoolean(properties.get(CatalogProperties.HADOOP_SUPPRESS_IOEXCEPTION));\n+", "originalCommit": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjU1OA==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553052558", "bodyText": "I would really prefer if this were more specific and looked at the exception message as well to ensure the error is a permissions or ACL problem.", "author": "rdblue", "createdAt": "2021-01-07T01:07:48Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -158,6 +167,44 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean shouldSuppressIOException(IOException ioException) {\n+    String name = ioException.getClass().getName();\n+    return suppressIOException && name.startsWith(\"org.apache.hadoop.fs.azurebfs\");", "originalCommit": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ2OTcxNA==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553469714", "bodyText": "I have fixed the code review suggestions.\nI'm detecting the azure blob permission exception using the message (that's all I have available). In that message there is an AzureServiceErrorCode of value \"AuthorizationPermissionMismatch\" which I use to detect a permission issue.\nI agree this is much better error handling since it will let other errors be reported.\nI'm thinking the flag should thus be \"suppress permission errors\". What do you think?", "author": "cccs-jc", "createdAt": "2021-01-07T17:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY5NjQxMQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553696411", "bodyText": "That sounds good to me!", "author": "rdblue", "createdAt": "2021-01-08T01:55:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjYzNA==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553052634", "bodyText": "Typo: Unalbe -> Unable", "author": "rdblue", "createdAt": "2021-01-07T01:08:05Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -158,6 +167,44 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean shouldSuppressIOException(IOException ioException) {\n+    String name = ioException.getClass().getName();\n+    return suppressIOException && name.startsWith(\"org.apache.hadoop.fs.azurebfs\");\n+  }\n+\n+  private boolean isTableDir(Path path) {\n+    Path metadataPath = new Path(path, \"metadata\");\n+    // Only the path which contains metadata is the path for table, otherwise it could be\n+    // still a namespace.\n+    try {\n+      return fs.listStatus(metadataPath, TABLE_FILTER).length >= 1;\n+    } catch (FileNotFoundException e) {\n+      return false;\n+    } catch (IOException e) {\n+      if (shouldSuppressIOException(e)) {\n+        LOG.warn(\"Unalbe to metadata directory {}: {}\", metadataPath, e);", "originalCommit": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA1MjY4OQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553052689", "bodyText": "Same typo.", "author": "rdblue", "createdAt": "2021-01-07T01:08:16Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopCatalog.java", "diffHunk": "@@ -158,6 +167,44 @@ public String name() {\n     return catalogName;\n   }\n \n+  private boolean shouldSuppressIOException(IOException ioException) {\n+    String name = ioException.getClass().getName();\n+    return suppressIOException && name.startsWith(\"org.apache.hadoop.fs.azurebfs\");\n+  }\n+\n+  private boolean isTableDir(Path path) {\n+    Path metadataPath = new Path(path, \"metadata\");\n+    // Only the path which contains metadata is the path for table, otherwise it could be\n+    // still a namespace.\n+    try {\n+      return fs.listStatus(metadataPath, TABLE_FILTER).length >= 1;\n+    } catch (FileNotFoundException e) {\n+      return false;\n+    } catch (IOException e) {\n+      if (shouldSuppressIOException(e)) {\n+        LOG.warn(\"Unalbe to metadata directory {}: {}\", metadataPath, e);\n+        return false;\n+      } else {\n+        throw new UncheckedIOException(e);\n+      }\n+    }\n+  }\n+\n+  private boolean isDirectory(Path path) {\n+    try {\n+      return fs.getFileStatus(path).isDirectory();\n+    } catch (FileNotFoundException e) {\n+      return false;\n+    } catch (IOException e) {\n+      if (shouldSuppressIOException(e)) {\n+        LOG.warn(\"Unalbe to list directory {}: {}\", path, e);", "originalCommit": "a6ee95a43ec2335d49264d12ea6e45f318ca2b55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "561a20239e31a6c04a2500288195c46edd78a4bf", "url": "https://github.com/apache/iceberg/commit/561a20239e31a6c04a2500288195c46edd78a4bf", "message": "code review fixes", "committedDate": "2021-01-07T15:21:46Z", "type": "commit"}, {"oid": "6b03929ac607a523f3efac72d15bce6fbf2d980f", "url": "https://github.com/apache/iceberg/commit/6b03929ac607a523f3efac72d15bce6fbf2d980f", "message": "fix indentation", "committedDate": "2021-01-07T17:18:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY5NjU5OQ==", "url": "https://github.com/apache/iceberg/pull/1979#discussion_r553696599", "bodyText": "Nit: this file doesn't need to be touched. Could you remove this whitespace change? It may cause git conflicts.", "author": "rdblue", "createdAt": "2021-01-08T01:55:42Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/ConfigProperties.java", "diffHunk": "@@ -25,4 +25,5 @@ private ConfigProperties() {\n   }\n \n   public static final String ENGINE_HIVE_ENABLED = \"iceberg.engine.hive.enabled\";\n+", "originalCommit": "6b03929ac607a523f3efac72d15bce6fbf2d980f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "66cca570ac8e1b90ff94da9c620f314fe7577b6c", "url": "https://github.com/apache/iceberg/commit/66cca570ac8e1b90ff94da9c620f314fe7577b6c", "message": "code review fixes", "committedDate": "2021-01-08T17:44:51Z", "type": "commit"}, {"oid": "e6dbe2ed116eef80493c3ebe03b5165949990f1e", "url": "https://github.com/apache/iceberg/commit/e6dbe2ed116eef80493c3ebe03b5165949990f1e", "message": "code review fixes", "committedDate": "2021-01-08T17:46:50Z", "type": "commit"}]}