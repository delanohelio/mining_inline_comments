{"pr_number": 1101, "pr_title": "Add sequence number assertions in merge append unit tests", "pr_createdAt": "2020-06-08T11:56:28Z", "pr_url": "https://github.com/apache/iceberg/pull/1101", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3Mjg4Nw==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438372887", "bodyText": "This doesn't make sense to me. The table metadata was just read into base above, so the V2Assert line doesn't need to read it again and can use base.lastSequenceNumber(). Next, if both v1 and v2 assertions are that base.lastSequenceNumber() is 0, then I think it makes more sense to use a normal Assert.assertEquals because it doesn't depend on the table version.\nI think these two lines should be replaced by this:\n    Assert.assertEquals(\"Last sequence number should be 0\", 0, base.lastSequenceNumber());", "author": "rdblue", "createdAt": "2020-06-10T19:55:41Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -183,31 +183,97 @@ public void testManifestMergeMinCount() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    V2Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());", "originalCommit": "a698497efe75f181c3f99f4aa143c585d2029e2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1MzU0MQ==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438453541", "bodyText": "OK.", "author": "chenjunjiedada", "createdAt": "2020-06-10T23:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3Mjg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NTkzNg==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438375936", "bodyText": "New validateManifest calls should also supply the status of each file as well.", "author": "rdblue", "createdAt": "2020-06-10T20:01:19Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -183,31 +183,97 @@ public void testManifestMergeMinCount() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    V2Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n \n     ManifestFile manifest = writeManifest(FILE_A);\n     ManifestFile manifest2 = writeManifestWithName(\"FILE_C\", FILE_C);\n     ManifestFile manifest3 = writeManifestWithName(\"FILE_D\", FILE_D);\n+    ManifestFile manifest4 = writeManifestWithName(\"FILE_B\", FILE_B);\n     table.newAppend()\n         .appendManifest(manifest)\n         .appendManifest(manifest2)\n         .appendManifest(manifest3)\n         .commit();\n \n+    Snapshot snap1 = table.currentSnapshot();\n+    long commitId1 = snap1.snapshotId();\n+    base = readMetadata();\n     Assert.assertEquals(\"Should contain 2 merged manifest for first write\",\n         2, readMetadata().currentSnapshot().allManifests().size());\n+    validateManifest(snap1.allManifests().get(0),", "originalCommit": "a698497efe75f181c3f99f4aa143c585d2029e2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1Mzk3OA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438453978", "bodyText": "OK, I see the new validate method, will replace them with the new one.", "author": "chenjunjiedada", "createdAt": "2020-06-10T23:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzAxMg==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438377012", "bodyText": "Why were new commits added to this test case?", "author": "rdblue", "createdAt": "2020-06-10T20:03:28Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -183,31 +183,97 @@ public void testManifestMergeMinCount() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    V2Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n \n     ManifestFile manifest = writeManifest(FILE_A);\n     ManifestFile manifest2 = writeManifestWithName(\"FILE_C\", FILE_C);\n     ManifestFile manifest3 = writeManifestWithName(\"FILE_D\", FILE_D);\n+    ManifestFile manifest4 = writeManifestWithName(\"FILE_B\", FILE_B);\n     table.newAppend()\n         .appendManifest(manifest)\n         .appendManifest(manifest2)\n         .appendManifest(manifest3)\n         .commit();\n \n+    Snapshot snap1 = table.currentSnapshot();\n+    long commitId1 = snap1.snapshotId();\n+    base = readMetadata();\n     Assert.assertEquals(\"Should contain 2 merged manifest for first write\",\n         2, readMetadata().currentSnapshot().allManifests().size());\n+    validateManifest(snap1.allManifests().get(0),\n+        seqs(1),\n+        ids(commitId1),\n+        files(FILE_A));\n+    validateManifest(snap1.allManifests().get(1),\n+        seqs(1, 1),\n+        ids(commitId1, commitId1),\n+        files(FILE_C, FILE_D));\n+\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 1\", 1, snap1.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n \n     table.newAppend()\n         .appendManifest(manifest)\n         .appendManifest(manifest2)\n         .appendManifest(manifest3)\n         .commit();\n-\n+    Snapshot snap2 = table.currentSnapshot();\n+    long commitId2 = snap2.snapshotId();\n+    base = readMetadata();\n     Assert.assertEquals(\"Should contain 3 merged manifest for second write\",\n         3, readMetadata().currentSnapshot().allManifests().size());\n+    validateManifest(snap2.allManifests().get(0),\n+        seqs(2),\n+        ids(commitId2),\n+        files(FILE_A));\n+\n+    validateManifest(snap2.allManifests().get(1),\n+        seqs(2, 2),\n+        ids(commitId2, commitId2),\n+        files(FILE_C, FILE_D));\n+\n+    validateManifestEntries(snap2.allManifests().get(2),\n+        ids(commitId1, commitId1, commitId1),\n+        files(FILE_A, FILE_C, FILE_D),\n+        statuses(Status.EXISTING, Status.EXISTING, Status.EXISTING));\n+\n+    validateManifest(snap2.allManifests().get(2),\n+        seqs(1, 1, 1),\n+        ids(commitId1, commitId1, commitId1),\n+        files(FILE_A, FILE_C, FILE_D));\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 2\", 2, snap2.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 2\", 2, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n \n     // validate that the metadata summary is correct when using appendManifest\n     Assert.assertEquals(\"Summary metadata should include 3 added files\",\n         \"3\", readMetadata().currentSnapshot().summary().get(\"added-data-files\"));\n+\n+    table.updateProperties()", "originalCommit": "a698497efe75f181c3f99f4aa143c585d2029e2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NDgzMQ==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438454831", "bodyText": "Both of them are related to merging manifests according to minMergeCount. Does that make sense?", "author": "chenjunjiedada", "createdAt": "2020-06-10T23:06:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyNDI4MA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466024280", "bodyText": "If there are more cases that were not originally tested, then let's create new test methods for them with names that describe what is happening.\nWhat are the additional cases?", "author": "rdblue", "createdAt": "2020-08-05T21:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMzE5Ng==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466413196", "bodyText": "It is the removed case in TestSequenceNumberForV2Table.java. Moved it to a new method.", "author": "chenjunjiedada", "createdAt": "2020-08-06T13:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0MDI5MQ==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r467140291", "bodyText": "What are the additional cases?", "author": "rdblue", "createdAt": "2020-08-07T16:20:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzkxMA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438377910", "bodyText": "Adding the sequence number asserts between the assertion about the number of manifests and validating a manifest makes it harder to read the test because lines that are related are now separated.\nCan you move the snapshot and table metadata sequence number assertions to just after each commit?", "author": "rdblue", "createdAt": "2020-06-10T20:05:23Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -251,7 +317,10 @@ public void testMergeWithExistingManifestAfterDelete() {\n     long baseId = base.currentSnapshot().snapshotId();\n     Assert.assertEquals(\"Should create 1 manifest for initial write\",\n         1, base.currentSnapshot().allManifests().size());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, readMetadata().lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, readMetadata().lastSequenceNumber());", "originalCommit": "a698497efe75f181c3f99f4aa143c585d2029e2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ1NDk5NA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r438454994", "bodyText": "OK.", "author": "chenjunjiedada", "createdAt": "2020-06-10T23:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM3NzkxMA=="}], "type": "inlineReview"}, {"oid": "4eca3765893ead8a74a4e70fc226ac9bae59d305", "url": "https://github.com/apache/iceberg/commit/4eca3765893ead8a74a4e70fc226ac9bae59d305", "message": "address comments", "committedDate": "2020-06-11T04:03:22Z", "type": "forcePushed"}, {"oid": "b7c6693b9168346f3f87a0ebb4bad2bd79dff9af", "url": "https://github.com/apache/iceberg/commit/b7c6693b9168346f3f87a0ebb4bad2bd79dff9af", "message": "Add sequence number assertions to merge append unit tests", "committedDate": "2020-06-11T06:32:15Z", "type": "commit"}, {"oid": "acc36005b2d2e424f84125aa864c2917bd96c9bf", "url": "https://github.com/apache/iceberg/commit/acc36005b2d2e424f84125aa864c2917bd96c9bf", "message": "minor updates", "committedDate": "2020-06-11T06:42:57Z", "type": "commit"}, {"oid": "acc36005b2d2e424f84125aa864c2917bd96c9bf", "url": "https://github.com/apache/iceberg/commit/acc36005b2d2e424f84125aa864c2917bd96c9bf", "message": "minor updates", "committedDate": "2020-06-11T06:42:57Z", "type": "forcePushed"}, {"oid": "42bf9042e971c9efde8b948f85c2e606c337c09d", "url": "https://github.com/apache/iceberg/commit/42bf9042e971c9efde8b948f85c2e606c337c09d", "message": "Address comments", "committedDate": "2020-07-27T22:00:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyMzE0MA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466023140", "bodyText": "Is this validation still needed if validateManifest is called below?", "author": "rdblue", "createdAt": "2020-08-05T21:47:24Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -75,17 +85,30 @@ public void testEmptyTableAppendManifest() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    Assert.assertEquals(\"Last sequence number should be 0\", 0, base.lastSequenceNumber());\n \n     ManifestFile manifest = writeManifest(FILE_A, FILE_B);\n-    Snapshot pending = table.newAppend()\n+    table.newAppend()\n         .appendManifest(manifest)\n-        .apply();\n+        .commit();\n+\n+    Snapshot committedSnapshot = table.currentSnapshot();\n+    Assert.assertNotNull(\"Should create a snapshot\", table.currentSnapshot());\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, table.ops().current().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n \n-    validateSnapshot(base.currentSnapshot(), pending, FILE_A, FILE_B);\n+    validateSnapshot(base.currentSnapshot(), committedSnapshot, FILE_A, FILE_B);", "originalCommit": "42bf9042e971c9efde8b948f85c2e606c337c09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMzk0MA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466413940", "bodyText": "Not needed. Removed.", "author": "chenjunjiedada", "createdAt": "2020-08-06T13:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyMzE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyMzcyNA==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466023724", "bodyText": "Before accessing a list item using get, you should always assert that the list has the number of items you expect. That helps avoid problems where you're validating the wrong item because there are more than you expected, and also provides a better error when there are no items at all.", "author": "rdblue", "createdAt": "2020-08-05T21:48:52Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -75,17 +85,30 @@ public void testEmptyTableAppendManifest() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    Assert.assertEquals(\"Last sequence number should be 0\", 0, base.lastSequenceNumber());\n \n     ManifestFile manifest = writeManifest(FILE_A, FILE_B);\n-    Snapshot pending = table.newAppend()\n+    table.newAppend()\n         .appendManifest(manifest)\n-        .apply();\n+        .commit();\n+\n+    Snapshot committedSnapshot = table.currentSnapshot();\n+    Assert.assertNotNull(\"Should create a snapshot\", table.currentSnapshot());\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, table.ops().current().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n \n-    validateSnapshot(base.currentSnapshot(), pending, FILE_A, FILE_B);\n+    validateSnapshot(base.currentSnapshot(), committedSnapshot, FILE_A, FILE_B);\n+\n+    long snapshotId = committedSnapshot.snapshotId();\n+    validateManifest(committedSnapshot.allManifests().get(0),", "originalCommit": "42bf9042e971c9efde8b948f85c2e606c337c09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxNDk1OQ==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r466414959", "bodyText": "I got it. I added the assertion in this one as well as missing assertions in other test methods.", "author": "chenjunjiedada", "createdAt": "2020-08-06T13:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyMzcyNA=="}], "type": "inlineReview"}, {"oid": "d38b7107131dc0654a93b076935abcde138aa560", "url": "https://github.com/apache/iceberg/commit/d38b7107131dc0654a93b076935abcde138aa560", "message": "address comments", "committedDate": "2020-08-06T13:26:53Z", "type": "commit"}, {"oid": "d38b7107131dc0654a93b076935abcde138aa560", "url": "https://github.com/apache/iceberg/commit/d38b7107131dc0654a93b076935abcde138aa560", "message": "address comments", "committedDate": "2020-08-06T13:26:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0MjI2Ng==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r467142266", "bodyText": "Nit: context is incorrect.", "author": "rdblue", "createdAt": "2020-08-07T16:24:23Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -121,56 +156,86 @@ public void testMergeWithAppendFilesAndManifest() throws IOException {\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    Assert.assertEquals(\"Last sequence number should be 0\", 0, base.lastSequenceNumber());\n \n     ManifestFile manifest = writeManifest(FILE_A, FILE_B);\n-    Snapshot pending = table.newAppend()\n+    table.newAppend()\n         .appendFile(FILE_C)\n         .appendFile(FILE_D)\n         .appendManifest(manifest)\n-        .apply();\n+        .commit();\n+\n+    Snapshot committedSnapshot = table.currentSnapshot();\n+    Assert.assertNotNull(\"Should create a snapshot\", table.currentSnapshot());\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, table.ops().current().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n \n-    long pendingId = pending.snapshotId();\n+    long snapshotId = committedSnapshot.snapshotId();\n \n-    Assert.assertEquals(\"Should create 1 merged manifest\", 1, pending.allManifests().size());\n-    validateManifest(pending.allManifests().get(0),\n-        ids(pendingId, pendingId, pendingId, pendingId),\n-        files(FILE_C, FILE_D, FILE_A, FILE_B));\n+    Assert.assertEquals(\"Should create 1 merged manifest\", 1, committedSnapshot.allManifests().size());\n+\n+    validateManifest(committedSnapshot.allManifests().get(0),\n+        seqs(1, 1, 1, 1),\n+        ids(snapshotId, snapshotId, snapshotId, snapshotId),\n+        files(FILE_C, FILE_D, FILE_A, FILE_B),\n+        statuses(Status.ADDED, Status.ADDED, Status.ADDED, Status.ADDED)\n+    );\n   }\n \n   @Test\n   public void testMergeWithExistingManifest() {\n     // merge all manifests for this test\n     table.updateProperties().set(\"commit.manifest.min-count-to-merge\", \"1\").commit();\n-\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n     Assert.assertEquals(\"Table should start empty\", 0, listManifestFiles().size());\n \n     table.newAppend()\n         .appendFile(FILE_A)\n         .appendFile(FILE_B)\n         .commit();\n \n+    Assert.assertNotNull(\"Should create a snapshot\", table.currentSnapshot());\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, table.ops().current().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n+\n     TableMetadata base = readMetadata();\n-    long baseId = base.currentSnapshot().snapshotId();\n+    Snapshot commitBefore = table.currentSnapshot();\n+    long baseId = commitBefore.snapshotId();\n+    validateSnapshot(null, commitBefore, 1, FILE_A, FILE_B);\n+\n     Assert.assertEquals(\"Should create 1 manifest for initial write\",\n-        1, base.currentSnapshot().allManifests().size());\n+        1, commitBefore.allManifests().size());\n     ManifestFile initialManifest = base.currentSnapshot().allManifests().get(0);\n+    validateManifest(initialManifest,\n+        seqs(1, 1),\n+        ids(baseId, baseId),\n+        files(FILE_A, FILE_B),\n+        statuses(Status.ADDED, Status.ADDED));\n \n-    Snapshot pending = table.newAppend()\n+    table.newAppend()\n         .appendFile(FILE_C)\n         .appendFile(FILE_D)\n-        .apply();\n+        .commit();\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, table.ops().current().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 2, table.ops().current().lastSequenceNumber());", "originalCommit": "d38b7107131dc0654a93b076935abcde138aa560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0NDYyNQ==", "url": "https://github.com/apache/iceberg/pull/1101#discussion_r467144625", "bodyText": "Minor: we don't need duplicate assertions when the condition should be true for both v1 and v2 tables.", "author": "rdblue", "createdAt": "2020-08-07T16:29:02Z", "path": "core/src/test/java/org/apache/iceberg/TestMergeAppend.java", "diffHunk": "@@ -193,46 +259,200 @@ public void testManifestMergeMinCount() throws IOException {\n         .appendManifest(manifest3)\n         .commit();\n \n+    Snapshot snap1 = table.currentSnapshot();\n+    long commitId1 = snap1.snapshotId();\n+    base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 1\", 1, snap1.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n+\n     Assert.assertEquals(\"Should contain 2 merged manifest for first write\",\n         2, readMetadata().currentSnapshot().allManifests().size());\n+    validateManifest(snap1.allManifests().get(0),\n+        seqs(1),\n+        ids(commitId1),\n+        files(FILE_A),\n+        statuses(Status.ADDED));\n+    validateManifest(snap1.allManifests().get(1),\n+        seqs(1, 1),\n+        ids(commitId1, commitId1),\n+        files(FILE_C, FILE_D),\n+        statuses(Status.ADDED, Status.ADDED));\n \n     table.newAppend()\n         .appendManifest(manifest)\n         .appendManifest(manifest2)\n         .appendManifest(manifest3)\n         .commit();\n+    Snapshot snap2 = table.currentSnapshot();\n+    long commitId2 = snap2.snapshotId();\n+    base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 2\", 2, snap2.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 2\", 2, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n \n     Assert.assertEquals(\"Should contain 3 merged manifest for second write\",\n         3, readMetadata().currentSnapshot().allManifests().size());\n+    validateManifest(snap2.allManifests().get(0),\n+        seqs(2),\n+        ids(commitId2),\n+        files(FILE_A),\n+        statuses(Status.ADDED));\n+    validateManifest(snap2.allManifests().get(1),\n+        seqs(2, 2),\n+        ids(commitId2, commitId2),\n+        files(FILE_C, FILE_D),\n+        statuses(Status.ADDED, Status.ADDED));\n+    validateManifest(snap2.allManifests().get(2),\n+        seqs(1, 1, 1),\n+        ids(commitId1, commitId1, commitId1),\n+        files(FILE_A, FILE_C, FILE_D),\n+        statuses(Status.EXISTING, Status.EXISTING, Status.EXISTING));\n \n     // validate that the metadata summary is correct when using appendManifest\n     Assert.assertEquals(\"Summary metadata should include 3 added files\",\n         \"3\", readMetadata().currentSnapshot().summary().get(\"added-data-files\"));\n   }\n \n+  @Test\n+  public void testManifestsMergeIntoOne() throws IOException {\n+    Assert.assertEquals(\"Table should start empty\", 0, listManifestFiles().size());\n+    table.newAppend().appendFile(FILE_A).commit();\n+    Snapshot snap1 = table.currentSnapshot();\n+    TableMetadata base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 1\", 1, snap1.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 1\", 1, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n+    long commitId1 = snap1.snapshotId();\n+\n+    Assert.assertEquals(\"Should contain 1 manifest\", 1, snap1.allManifests().size());\n+    validateManifest(snap1.allManifests().get(0), seqs(1), ids(commitId1), files(FILE_A), statuses(Status.ADDED));\n+\n+    table.newAppend().appendFile(FILE_B).commit();\n+    Snapshot snap2 = table.currentSnapshot();\n+    long commitId2 = snap2.snapshotId();\n+    base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 2\", 2, snap2.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 2\", 2, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n+\n+    Assert.assertEquals(\"Should contain 2 manifests\", 2, snap2.allManifests().size());\n+    validateManifest(snap2.allManifests().get(0),\n+        seqs(2),\n+        ids(commitId2),\n+        files(FILE_B),\n+        statuses(Status.ADDED));\n+    validateManifest(snap2.allManifests().get(1),\n+        seqs(1),\n+        ids(commitId1),\n+        files(FILE_A),\n+        statuses(Status.ADDED));\n+\n+    table.newAppend()\n+        .appendManifest(writeManifest(\"input-m0.avro\",\n+            manifestEntry(ManifestEntry.Status.ADDED, null, FILE_C)))\n+        .commit();\n+    Snapshot snap3 = table.currentSnapshot();\n+\n+    base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 3\", 3, snap3.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 3\", 3, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n+\n+    Assert.assertEquals(\"Should contain 3 manifests\", 3, snap3.allManifests().size());\n+    long commitId3 = snap3.snapshotId();\n+    validateManifest(snap3.allManifests().get(0),\n+        seqs(3),\n+        ids(commitId3),\n+        files(FILE_C),\n+        statuses(Status.ADDED));\n+    validateManifest(snap3.allManifests().get(1),\n+        seqs(2),\n+        ids(commitId2),\n+        files(FILE_B),\n+        statuses(Status.ADDED));\n+    validateManifest(snap3.allManifests().get(2),\n+        seqs(1),\n+        ids(commitId1),\n+        files(FILE_A),\n+        statuses(Status.ADDED));\n+\n+    table.updateProperties()\n+        .set(TableProperties.MANIFEST_MIN_MERGE_COUNT, \"1\")\n+        .commit();\n+\n+    table.newAppend()\n+        .appendManifest(writeManifest(\"input-m1.avro\",\n+            manifestEntry(ManifestEntry.Status.ADDED, null, FILE_D)))\n+        .commit();\n+    Snapshot snap4 = table.currentSnapshot();\n+\n+    base = readMetadata();\n+    V2Assert.assertEquals(\"Snapshot sequence number should be 4\", 4, snap4.sequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 4\", 4, base.lastSequenceNumber());\n+    V1Assert.assertEquals(\"Table should end with last-sequence-number 0\", 0, base.lastSequenceNumber());\n+\n+    long commitId4 = snap4.snapshotId();\n+    Assert.assertEquals(\"Should only contains 1 merged manifest\", 1, snap4.allManifests().size());\n+    validateManifest(snap4.allManifests().get(0),\n+        seqs(4, 3, 2, 1),\n+        ids(commitId4, commitId3, commitId2, commitId1),\n+        files(FILE_D, FILE_C, FILE_B, FILE_A),\n+        statuses(Status.ADDED, Status.EXISTING, Status.EXISTING, Status.EXISTING));\n+  }\n+\n   @Test\n   public void testManifestDoNotMergeMinCount() throws IOException {\n     Assert.assertEquals(\"Table should start empty\", 0, listManifestFiles().size());\n     table.updateProperties().set(\"commit.manifest.min-count-to-merge\", \"4\").commit();\n \n     TableMetadata base = readMetadata();\n     Assert.assertNull(\"Should not have a current snapshot\", base.currentSnapshot());\n+    V1Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());\n+    V2Assert.assertEquals(\"Last sequence number should be 0\", 0, readMetadata().lastSequenceNumber());", "originalCommit": "d38b7107131dc0654a93b076935abcde138aa560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7770ff69dfeeabc33e9793154684970df3332520", "url": "https://github.com/apache/iceberg/commit/7770ff69dfeeabc33e9793154684970df3332520", "message": "address comments", "committedDate": "2020-08-08T00:24:28Z", "type": "commit"}]}