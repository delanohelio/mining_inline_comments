{"pr_number": 545, "pr_title": "Update app to use latest Firestore data model", "pr_createdAt": "2020-07-16T03:59:12Z", "pr_url": "https://github.com/google/ground-android/pull/545", "timeline": [{"oid": "3d772c25425a5932b3872216813b9d256590f559", "url": "https://github.com/google/ground-android/commit/3d772c25425a5932b3872216813b9d256590f559", "message": "Auto-generated changes", "committedDate": "2020-07-16T02:42:56Z", "type": "commit"}, {"oid": "577ed78fa3f60667f20d1155db62e1fd4d09028f", "url": "https://github.com/google/ground-android/commit/577ed78fa3f60667f20d1155db62e1fd4d09028f", "message": "Merge branch 'master' of https://github.com/google/ground-android into update-remote-db", "committedDate": "2020-07-16T02:43:02Z", "type": "commit"}, {"oid": "7f7af1eb9c0561d2a608c900b84030726bb2f541", "url": "https://github.com/google/ground-android/commit/7f7af1eb9c0561d2a608c900b84030726bb2f541", "message": "`record` -> `observations` in remote db", "committedDate": "2020-07-16T02:46:49Z", "type": "commit"}, {"oid": "177677d0ca989dd566f8c1c83e0fe0b5e6725b02", "url": "https://github.com/google/ground-android/commit/177677d0ca989dd566f8c1c83e0fe0b5e6725b02", "message": "`featureType` -> `layer` in local and remote dbs", "committedDate": "2020-07-16T02:54:07Z", "type": "commit"}, {"oid": "f2469c1549be9437fe0e2bf5e602a581927416cd", "url": "https://github.com/google/ground-android/commit/f2469c1549be9437fe0e2bf5e602a581927416cd", "message": "Layer `listHeading` -> `name` in local and remote dbs", "committedDate": "2020-07-16T03:00:40Z", "type": "commit"}, {"oid": "1fc0309e153f8ac7eea4dba0e978bafcb3a94932", "url": "https://github.com/google/ground-android/commit/1fc0309e153f8ac7eea4dba0e978bafcb3a94932", "message": "Form `elements` list -> map", "committedDate": "2020-07-16T03:14:59Z", "type": "commit"}, {"oid": "d7fd7b322f04c9e7ce8f00f1d7c4df35c254fd16", "url": "https://github.com/google/ground-android/commit/d7fd7b322f04c9e7ce8f00f1d7c4df35c254fd16", "message": "Sort form fields by index", "committedDate": "2020-07-16T03:21:59Z", "type": "commit"}, {"oid": "6b5fb2cb7e2f4024a3ba8c68295140cb938cf979", "url": "https://github.com/google/ground-android/commit/6b5fb2cb7e2f4024a3ba8c68295140cb938cf979", "message": "Field `labels` -> `label` in remote db", "committedDate": "2020-07-16T03:29:48Z", "type": "commit"}, {"oid": "93438076e9de912cb11477ad02d75319b6685a3d", "url": "https://github.com/google/ground-android/commit/93438076e9de912cb11477ad02d75319b6685a3d", "message": "Option `labels` -> `label` in remote db", "committedDate": "2020-07-16T03:38:45Z", "type": "commit"}, {"oid": "995ff1632eab579ae57e158aba01639ee3e40b60", "url": "https://github.com/google/ground-android/commit/995ff1632eab579ae57e158aba01639ee3e40b60", "message": "Fix capitalization of accessor method name", "committedDate": "2020-07-16T03:40:07Z", "type": "commit"}, {"oid": "b578a833601764523c941314e60937e198bb84a6", "url": "https://github.com/google/ground-android/commit/b578a833601764523c941314e60937e198bb84a6", "message": "Feature `center` -> `location` in remote db", "committedDate": "2020-07-16T03:41:50Z", "type": "commit"}, {"oid": "e38f209d3963a32f737bb0691d74738a337a536d", "url": "https://github.com/google/ground-android/commit/e38f209d3963a32f737bb0691d74738a337a536d", "message": "Observation `modified` -> `last_modified` in remote db", "committedDate": "2020-07-16T03:44:21Z", "type": "commit"}, {"oid": "9981116f552616ec0a616838dcb71e9d46888253", "url": "https://github.com/google/ground-android/commit/9981116f552616ec0a616838dcb71e9d46888253", "message": "Feature `modified` -> `last_modified` in remote db", "committedDate": "2020-07-16T03:45:32Z", "type": "commit"}, {"oid": "e1bfa564df7a0511e526f7aaa7ac07b756b146cc", "url": "https://github.com/google/ground-android/commit/e1bfa564df7a0511e526f7aaa7ac07b756b146cc", "message": "Audit info `[client|server]TimeMillis` -> `Timestamp` in dbs and model", "committedDate": "2020-07-16T03:49:15Z", "type": "commit"}, {"oid": "d31296137c4fa3ff970aa4a5bb2b192e974e027e", "url": "https://github.com/google/ground-android/commit/d31296137c4fa3ff970aa4a5bb2b192e974e027e", "message": "Update project acls to new remote db structure", "committedDate": "2020-07-16T04:46:26Z", "type": "commit"}, {"oid": "9adac10586d2d047d9ebfc4fe3035594853650ac", "url": "https://github.com/google/ground-android/commit/9adac10586d2d047d9ebfc4fe3035594853650ac", "message": "Fix typo in manager role key", "committedDate": "2020-07-16T15:19:16Z", "type": "commit"}, {"oid": "3a87de185ba4818cc5e81f901948c9223470fe41", "url": "https://github.com/google/ground-android/commit/3a87de185ba4818cc5e81f901948c9223470fe41", "message": "Multiple choice Options list -> map", "committedDate": "2020-07-16T15:30:16Z", "type": "commit"}, {"oid": "7d93bb1382cbf8175e39ff900867917cf8729464", "url": "https://github.com/google/ground-android/commit/7d93bb1382cbf8175e39ff900867917cf8729464", "message": "Sort Options by index number in remote db", "committedDate": "2020-07-16T15:33:34Z", "type": "commit"}, {"oid": "ff583a442065d85098c05e701b7b8e9fcb4fb1d1", "url": "https://github.com/google/ground-android/commit/ff583a442065d85098c05e701b7b8e9fcb4fb1d1", "message": "Sort Options by index number in remote db", "committedDate": "2020-07-16T18:57:46Z", "type": "commit"}, {"oid": "760870d2ed12d93930fbeda8f33fdf054b6beccd", "url": "https://github.com/google/ground-android/commit/760870d2ed12d93930fbeda8f33fdf054b6beccd", "message": "Tolerate missing AuditInfo in remote db", "committedDate": "2020-07-16T18:57:57Z", "type": "commit"}, {"oid": "65e74e7ab2529a987d11cf4ba7e5ed0de3b15aa1", "url": "https://github.com/google/ground-android/commit/65e74e7ab2529a987d11cf4ba7e5ed0de3b15aa1", "message": "Tolerate color in Layer root on remote db", "committedDate": "2020-07-16T19:48:52Z", "type": "commit"}, {"oid": "a1703a5d036fcc502a7bf5754f248b6ce836653c", "url": "https://github.com/google/ground-android/commit/a1703a5d036fcc502a7bf5754f248b6ce836653c", "message": "Increase dex heap size to fix GC heap size errors on build", "committedDate": "2020-07-17T02:50:13Z", "type": "commit"}, {"oid": "77b1526cdd5aff72a6b482cad0ca5d5c443b305a", "url": "https://github.com/google/ground-android/commit/77b1526cdd5aff72a6b482cad0ca5d5c443b305a", "message": "Remove unused layerId from remote Observations", "committedDate": "2020-07-17T02:51:06Z", "type": "commit"}, {"oid": "203d655fbe23017c69858d30660b888718cb1524", "url": "https://github.com/google/ground-android/commit/203d655fbe23017c69858d30660b888718cb1524", "message": "Bug fix: Insert observations in local db also when there are no mutations", "committedDate": "2020-07-17T02:51:46Z", "type": "commit"}, {"oid": "73bb5463fdb7ffac5eae4dba8a888390c5d187a8", "url": "https://github.com/google/ground-android/commit/73bb5463fdb7ffac5eae4dba8a888390c5d187a8", "message": "Show label for options instead of uuid", "committedDate": "2020-07-17T03:03:42Z", "type": "commit"}, {"oid": "4936491d8476815b32130d44500b6068ffd14c55", "url": "https://github.com/google/ground-android/commit/4936491d8476815b32130d44500b6068ffd14c55", "message": "Fix typo", "committedDate": "2020-07-17T03:17:39Z", "type": "commit"}, {"oid": "16a80ec1bd66e65f87bdca6603e88fea373f71b7", "url": "https://github.com/google/ground-android/commit/16a80ec1bd66e65f87bdca6603e88fea373f71b7", "message": "Move default field index to converter", "committedDate": "2020-07-17T03:20:14Z", "type": "commit"}, {"oid": "9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "url": "https://github.com/google/ground-android/commit/9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "message": "Layer `itemLabel` -> `name` in local and remote db", "committedDate": "2020-07-17T03:47:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzMTcyNg==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456231726", "bodyText": "Does this mean code is deprecated now?", "author": "shobhitagarwal1612", "createdAt": "2020-07-17T05:49:28Z", "path": "gnd/src/main/java/com/google/android/gnd/model/form/Option.java", "diffHunk": "@@ -16,12 +16,16 @@\n \n package com.google.android.gnd.model.form;\n \n+import androidx.annotation.NonNull;\n import com.google.auto.value.AutoValue;\n import javax.annotation.Nullable;\n \n /** Describes a single valid option to a multiple choice question. */\n @AutoValue\n public abstract class Option {\n+  @NonNull\n+  public abstract String getId();\n+\n   @Nullable\n   public abstract String getCode();", "originalCommit": "9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ3OTE1MA==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456479150", "bodyText": "Nope.. code is an optional, language neutral value, used for analysis. So if the survey is in five languages, for example, values can be still be compared.", "author": "gino-m", "createdAt": "2020-07-17T14:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzMTcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzMjcwOA==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456232708", "bodyText": "Can we revert this back?", "author": "shobhitagarwal1612", "createdAt": "2020-07-17T05:52:46Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -340,24 +341,26 @@ public Completable mergeFeature(Feature feature) {\n         .subscribeOn(schedulers.io());\n   }\n \n+  @SuppressLint(\"TimberArgCount\")", "originalCommit": "9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3OTI4Nw==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456579287", "bodyText": "Done!", "author": "gino-m", "createdAt": "2020-07-17T17:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzMjcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzNTAyNA==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456235024", "bodyText": "If we traceback the call, this observation is fetched from local db in getObservations() and isn't mutated in the path. Maybe we should revert this back too. Unless I am missing some point, can you please check?", "author": "shobhitagarwal1612", "createdAt": "2020-07-17T06:00:26Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -340,24 +341,26 @@ public Completable mergeFeature(Feature feature) {\n         .subscribeOn(schedulers.io());\n   }\n \n+  @SuppressLint(\"TimberArgCount\")\n   @Transaction\n   @Override\n   public Completable mergeObservation(Observation observation) {\n     ObservationEntity observationEntity = ObservationEntity.fromObservation(observation);\n     return observationMutationDao\n         .findByObservationId(observation.getId())\n-        .flatMapCompletable(mutations -> mergeObservation(observationEntity, mutations));\n+        .flatMapCompletable(mutations -> mergeObservation(observationEntity, mutations))\n+        .subscribeOn(schedulers.io());\n   }\n \n   private Completable mergeObservation(\n       ObservationEntity observation, List<ObservationMutationEntity> mutations) {\n     if (mutations.isEmpty()) {\n-      return Completable.complete();\n+      return observationDao.insertOrUpdate(observation);", "originalCommit": "9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3NDA4Mg==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456574082", "bodyText": "Observations are being fetched from the remote db in ObservationRepository line 97, not the local one; previous they were not being written at all unless there were related mutations; not sure how this was ever working, unless something changed.", "author": "gino-m", "createdAt": "2020-07-17T17:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzNTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0ODY3Mg==", "url": "https://github.com/google/ground-android/pull/545#discussion_r457048672", "bodyText": "Thanks for pointing that out!", "author": "shobhitagarwal1612", "createdAt": "2020-07-20T04:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIzNTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MzI1OA==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456243258", "bodyText": "StyleNestedObject is converted back to Style in the next step. Better to create instance of Style instead of StyleNestefObject in \"orElse\" block.\n    Style style =\n        Optional.ofNullable(obj.getDefaultStyle())\n            .map(StyleConverter::toStyle)\n            .orElse(\n                Style.builder().setColor(Optional.ofNullable(obj.getColor()).orElse(FALLBACK_COLOR)).build());\n\n    layer\n        .setId(id)\n        .setListHeading(getLocalizedMessage(obj.getListHeading()))\n        .setItemLabel(getLocalizedMessage(obj.getItemLabel()))\n        .setDefaultStyle(style);", "author": "shobhitagarwal1612", "createdAt": "2020-07-17T06:25:58Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/LayerConverter.java", "diffHunk": "@@ -20,25 +20,28 @@\n \n import android.util.Log;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.model.layer.Style;\n+import java8.util.Optional;\n \n /** Converts between Firestore documents and {@link Layer} instances. */\n class LayerConverter {\n   private static final String TAG = LayerConverter.class.getSimpleName();\n \n   /** Black marker used when default remote data is corrupt or missing. */\n-  private static final Style DEFAULT_DEFAULT_STYLE = Style.builder().setColor(\"#000000\").build();\n+  private static final String FALLBACK_COLOR = \"#000000\";\n \n   static Layer toLayer(String id, LayerNestedObject obj) {\n     Layer.Builder layer = Layer.newBuilder();\n+    // Use \"color\" field until web UI is updated:\n+    // TODO(https://github.com/google/ground-platform/issues/402): Remove fallback once updated in\n+    // web client.\n+    StyleNestedObject style =\n+        Optional.ofNullable(obj.getDefaultStyle())\n+            .orElse(\n+                new StyleNestedObject(Optional.ofNullable(obj.getColor()).orElse(FALLBACK_COLOR)));\n     layer\n         .setId(id)\n-        .setListHeading(getLocalizedMessage(obj.getListHeading()))\n-        .setItemLabel(getLocalizedMessage(obj.getItemLabel()))\n-        .setDefaultStyle(\n-            obj.getDefaultStyle() == null\n-                ? DEFAULT_DEFAULT_STYLE\n-                : StyleConverter.toStyle(obj.getDefaultStyle()));\n+        .setName(getLocalizedMessage(obj.getName()))\n+        .setDefaultStyle(StyleConverter.toStyle(style));", "originalCommit": "9c8b9b38b9f5e8cbab5801623340acf5b57a4613", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU3Njc4Mw==", "url": "https://github.com/google/ground-android/pull/545#discussion_r456576783", "bodyText": "The two are functionally equivalent, and the cost of conversion is approx. 0, so I opted for creating a default input instead of output. Happy to change this, just wanted to mention it since in general we want to avoid over-optimizing code at the cost of readability.", "author": "gino-m", "createdAt": "2020-07-17T17:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0MzI1OA=="}], "type": "inlineReview"}, {"oid": "a908342a28efd70cb88cc4a8af4943d725c6b2df", "url": "https://github.com/google/ground-android/commit/a908342a28efd70cb88cc4a8af4943d725c6b2df", "message": "Refactor conversion of legacy layer color field", "committedDate": "2020-07-17T17:32:33Z", "type": "commit"}, {"oid": "2390fb8ff850da8e895a1484edab9a652121f5e0", "url": "https://github.com/google/ground-android/commit/2390fb8ff850da8e895a1484edab9a652121f5e0", "message": "Revert accidental change", "committedDate": "2020-07-17T17:33:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0OTY5OQ==", "url": "https://github.com/google/ground-android/pull/545#discussion_r457049699", "bodyText": "Please remove this unused import", "author": "shobhitagarwal1612", "createdAt": "2020-07-20T04:55:35Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -20,6 +20,7 @@\n import static com.google.android.gnd.util.ImmutableSetCollector.toImmutableSet;\n import static java8.util.stream.StreamSupport.stream;\n \n+import android.annotation.SuppressLint;", "originalCommit": "2390fb8ff850da8e895a1484edab9a652121f5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUxNDMyNA==", "url": "https://github.com/google/ground-android/pull/545#discussion_r457514324", "bodyText": "Done.", "author": "gino-m", "createdAt": "2020-07-20T15:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0OTY5OQ=="}], "type": "inlineReview"}, {"oid": "4d89be376dc366e2c21844067a726eddbc7014b2", "url": "https://github.com/google/ground-android/commit/4d89be376dc366e2c21844067a726eddbc7014b2", "message": "Remove unused import", "committedDate": "2020-07-20T15:51:30Z", "type": "commit"}]}