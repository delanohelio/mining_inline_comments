{"pr_number": 542, "pr_title": "List Human Readable Area Names in Offline Area List", "pr_createdAt": "2020-07-14T17:08:30Z", "pr_url": "https://github.com/google/ground-android/pull/542", "timeline": [{"oid": "dabad60617696d837fb6696f244936e1afc463df", "url": "https://github.com/google/ground-android/commit/dabad60617696d837fb6696f244936e1afc463df", "message": "Merge branch 'master' of https://github.com/google/ground-android into master", "committedDate": "2020-07-14T15:19:18Z", "type": "commit"}, {"oid": "cd0d4a7dcc59a52922b7b766e8e375e7548972cc", "url": "https://github.com/google/ground-android/commit/cd0d4a7dcc59a52922b7b766e8e375e7548972cc", "message": "Remove unused method in OfflineAreasViewModel", "committedDate": "2020-07-14T16:49:55Z", "type": "commit"}, {"oid": "45e91bb8751a90ea5d2198abb130045c36996946", "url": "https://github.com/google/ground-android/commit/45e91bb8751a90ea5d2198abb130045c36996946", "message": "Display locality/country names in area list\n\nPreviously, the area list listed the auto-generated ids for each area on the user's device--which isn't very helpful. Instead, we now use reverse Geocoding to get a human readable descriptor for an area based on the lat/lng of its center.\n\nWe use a bottom-up approach, as not all addresses have precise locale detail. If the area centers on a known Feature, we render the feature name, otherwise we fallback to the locality, otherwise, the subadministrative area, otherwise the administrative area, and finally, if all the other granularities are unknown, the country name. If we can't find any locality/address for the area, we list it as \"unknown area\". This hierarchy follows that of Extensible Address Language spec, in reverse order (a Country subsumes and admin area, an admin area a subadmin area, and so forth).", "committedDate": "2020-07-14T16:54:28Z", "type": "commit"}, {"oid": "97e50a7be5ebad9663806485736b38b5296303e1", "url": "https://github.com/google/ground-android/commit/97e50a7be5ebad9663806485736b38b5296303e1", "message": "Throw a custom Exception when Area Addresses aren't found\n\nRather than throw a raw exception, using a custom class makes the type of exception explicit (and makes PMD happy).", "committedDate": "2020-07-14T16:59:19Z", "type": "commit"}, {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba", "url": "https://github.com/google/ground-android/commit/7b6c4f309345107101af3eff4b30aac27e44ebba", "message": "Merge branch 'master' of https://github.com/google/ground-android into geocoding", "committedDate": "2020-07-14T17:12:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzk1OQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454557959", "bodyText": "Can you please move this string creation to catch block? Otherwise, it seems wasteful to do this init each time.", "author": "shobhitagarwal1612", "createdAt": "2020-07-14T18:27:06Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);", "originalCommit": "7b6c4f309345107101af3eff4b30aac27e44ebba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2ODI4Mg==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454668282", "bodyText": "@shobhitagarwal1612 Could you clarify what would be wasted and when?", "author": "gino-m", "createdAt": "2020-07-14T21:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTUxOQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454755519", "bodyText": "IIUC, this is the default area name \"unknown area\" which would be set if the try block throws an exception. So, this value would only be used if reverse geocoding fails for a particular point", "author": "shobhitagarwal1612", "createdAt": "2020-07-15T02:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1OTM1MQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459559351", "bodyText": "After the refactor in 81c0b3f, the setup is a bit different--we still need to do the allocation early as we can't just hold on to the context in the class (iirc this can lead to leaks)--but it should be a bit cleaner now.", "author": "scolsen", "createdAt": "2020-07-23T16:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTAwMQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454559001", "bodyText": "Can we please specify exactly which exception we are looking for? Is this catching errors other than AddressNotFoundException too?", "author": "shobhitagarwal1612", "createdAt": "2020-07-14T18:28:55Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);\n+\n+    OfflineArea area = offlineAreas.get(position);\n+    String id = area.getId();\n+    LatLng center = area.getBounds().getCenter();\n+\n+    try {\n+      List<Address> addresses =\n+          viewHolder.geocoder.getFromLocation(center.latitude, center.longitude, 1);\n+\n+      if (addresses.isEmpty()) {\n+        throw new AddressNotFoundException(\"No address found for area.\");\n+      }\n+\n+      Address address = addresses.get(0);\n+\n+      areaName =\n+          Optional.ofNullable(address.getFeatureName())\n+              .or(() -> Optional.ofNullable(address.getLocality()))\n+              .or(() -> Optional.ofNullable(address.getSubAdminArea()))\n+              .or(() -> Optional.ofNullable(address.getAdminArea()))\n+              .or(() -> Optional.ofNullable(address.getCountryName()))\n+              .orElse(areaName);\n+    } catch (Exception e) {", "originalCommit": "7b6c4f309345107101af3eff4b30aac27e44ebba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1OTQzNA==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459559434", "bodyText": "done! 81c0b3f", "author": "scolsen", "createdAt": "2020-07-23T16:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTQwNg==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454619406", "bodyText": "Following our current architecture, remote and system services are all hidden either behind a Repository or a Manager, respectively. Also,\nListAdapter is a purely UI component, so it would be best to abstract services like this one so they can be mocked or replaced without needing to mock the lower level API.\nHow about creating a GeocodingService that exposes only the functionality needed to implement this feature?", "author": "gino-m", "createdAt": "2020-07-14T20:19:29Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -37,6 +50,7 @@\n     public int position;\n     private ImmutableList<OfflineArea> areas;\n     private final Navigator navigator;\n+    private final Geocoder geocoder;", "originalCommit": "7b6c4f309345107101af3eff4b30aac27e44ebba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1OTYwMg==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459559602", "bodyText": "Done! 81c0b3f added a GeocodingManager", "author": "scolsen", "createdAt": "2020-07-23T16:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNDE5NQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r454624195", "bodyText": "In particular, this is business logic that would be best defined in a more tightly scoped class imo.", "author": "gino-m", "createdAt": "2020-07-14T20:27:57Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);\n+\n+    OfflineArea area = offlineAreas.get(position);\n+    String id = area.getId();", "originalCommit": "7b6c4f309345107101af3eff4b30aac27e44ebba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1OTY3Mg==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459559672", "bodyText": "81c0b3f", "author": "scolsen", "createdAt": "2020-07-23T16:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNDE5NQ=="}], "type": "inlineReview"}, {"oid": "12c8afbf7c7862b2f17e4875bac9cfb953009a11", "url": "https://github.com/google/ground-android/commit/12c8afbf7c7862b2f17e4875bac9cfb953009a11", "message": "Merge branch 'master' into geocoding", "committedDate": "2020-07-23T15:54:27Z", "type": "commit"}, {"oid": "81c0b3f03cfad12f8a23a0d002c5e59738df7ef8", "url": "https://github.com/google/ground-android/commit/81c0b3f03cfad12f8a23a0d002c5e59738df7ef8", "message": "Move geocoding functionality into its own class", "committedDate": "2020-07-23T15:58:03Z", "type": "commit"}, {"oid": "725046904d4b4ab0f5ff01d61738269c62855489", "url": "https://github.com/google/ground-android/commit/725046904d4b4ab0f5ff01d61738269c62855489", "message": "Merge branch 'master' of https://github.com/google/ground-android into geocoding", "committedDate": "2020-07-23T15:58:54Z", "type": "commit"}, {"oid": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "url": "https://github.com/google/ground-android/commit/cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "message": "Merge branch 'geocoding' of https://github.com/scolsen/ground-android into geocoding", "committedDate": "2020-07-23T15:59:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjMxMA==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459776310", "bodyText": "This seems like logic that would normally be called from the ViewModel. Also, it would be preferable to inject the GeocodingManager (in the VM) to make it easier to swap out in tests. Would this be possible?", "author": "gino-m", "createdAt": "2020-07-23T23:07:53Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -60,7 +47,7 @@ public AddressNotFoundException(String message) {\n       this.binding = binding;\n       this.areas = areas;\n       this.navigator = navigator;\n-      this.geocoder = new Geocoder(binding.getRoot().getContext());\n+      this.geocoder = new GeocodingManager(binding.getRoot().getContext());", "originalCommit": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3NTI3Nw==", "url": "https://github.com/google/ground-android/pull/542#discussion_r461875277", "bodyText": "77aaed7", "author": "scolsen", "createdAt": "2020-07-28T20:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjYwMA==", "url": "https://github.com/google/ground-android/pull/542#discussion_r459776600", "bodyText": "s/abstracts over/abstracts/", "author": "gino-m", "createdAt": "2020-07-23T23:08:57Z", "path": "gnd/src/main/java/com/google/android/gnd/system/GeocodingManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.content.Context;\n+import android.location.Address;\n+import android.location.Geocoder;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gnd.R;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import java.io.IOException;\n+import java.util.List;\n+import java8.util.Optional;\n+import timber.log.Timber;\n+\n+/**\n+ * GeocodingManger abstracts over native geocoding facilities, and provides convenience methods for", "originalCommit": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3NTM2NQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r461875365", "bodyText": "656adc8", "author": "scolsen", "createdAt": "2020-07-28T20:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjYwMA=="}], "type": "inlineReview"}, {"oid": "ce69f7c87b4e09e157c384fc21d675a4fe150ae4", "url": "https://github.com/google/ground-android/commit/ce69f7c87b4e09e157c384fc21d675a4fe150ae4", "message": "Merge branch 'master' into geocoding", "committedDate": "2020-07-28T14:28:28Z", "type": "commit"}, {"oid": "656adc801372efba3a3c01c39ff66efc660feec8", "url": "https://github.com/google/ground-android/commit/656adc801372efba3a3c01c39ff66efc660feec8", "message": "Comment editorial", "committedDate": "2020-07-28T19:21:19Z", "type": "commit"}, {"oid": "77aaed7c5c8cbd1918f4b2a6ed881765a9494438", "url": "https://github.com/google/ground-android/commit/77aaed7c5c8cbd1918f4b2a6ed881765a9494438", "message": "Move geocoding calls into the area selector viewmodel\n\nCalling the GeoCodingManager here, rather than in the list adapter, is better aligned with our architecture. We now pass an immutablemap of human readable names + areas to the list adapter from the view model.", "committedDate": "2020-07-28T20:58:14Z", "type": "commit"}, {"oid": "3379d8971a8436cd8bb2700c936dc192f2612a6d", "url": "https://github.com/google/ground-android/commit/3379d8971a8436cd8bb2700c936dc192f2612a6d", "message": "Merge branch 'geocoding' of https://github.com/scolsen/ground-android into geocoding", "committedDate": "2020-07-28T20:58:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MDkxNQ==", "url": "https://github.com/google/ground-android/pull/542#discussion_r461890915", "bodyText": "Instead of creating an instance here, how about converting GeocodingManager into an injectable dependency?", "author": "shobhitagarwal1612", "createdAt": "2020-07-28T21:29:21Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreasViewModel.java", "diffHunk": "@@ -16,39 +16,57 @@\n \n package com.google.android.gnd.ui.offlinearea;\n \n+import static java8.util.stream.StreamSupport.stream;\n+\n+import android.content.Context;\n import androidx.lifecycle.LiveData;\n import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gnd.model.basemap.OfflineArea;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n+import com.google.android.gnd.system.GeocodingManager;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n import com.google.android.gnd.ui.common.Navigator;\n-import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import dagger.hilt.android.qualifiers.ApplicationContext;\n+import java8.util.stream.Collectors;\n import javax.inject.Inject;\n \n /**\n  * View model for the offline area manager fragment. Handles the current list of downloaded areas.\n  */\n public class OfflineAreasViewModel extends AbstractViewModel {\n \n-  private LiveData<ImmutableList<OfflineArea>> offlineAreas;\n+  private LiveData<ImmutableMap<String, OfflineArea>> offlineAreas;\n   private final Navigator navigator;\n+  private final GeocodingManager geocoder;\n \n   @Inject\n-  OfflineAreasViewModel(Navigator navigator, OfflineAreaRepository offlineAreaRepository) {\n+  OfflineAreasViewModel(\n+      Navigator navigator,\n+      OfflineAreaRepository offlineAreaRepository,\n+      @ApplicationContext Context context) {\n     this.navigator = navigator;\n+    this.geocoder = new GeocodingManager(context);", "originalCommit": "3379d8971a8436cd8bb2700c936dc192f2612a6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5NTgxNg==", "url": "https://github.com/google/ground-android/pull/542#discussion_r461895816", "bodyText": "+1. I believe all you need is to add @Inject to the constructor.", "author": "gino-m", "createdAt": "2020-07-28T21:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MDkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMyNjU5Nw==", "url": "https://github.com/google/ground-android/pull/542#discussion_r462326597", "bodyText": "56b49e5", "author": "scolsen", "createdAt": "2020-07-29T14:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MDkxNQ=="}], "type": "inlineReview"}, {"oid": "56b49e5c83e6587ba053ac894754f6d0d036c607", "url": "https://github.com/google/ground-android/commit/56b49e5c83e6587ba053ac894754f6d0d036c607", "message": "Make GeocodingManager injectable", "committedDate": "2020-07-29T14:06:47Z", "type": "commit"}, {"oid": "6db2bc823f1422144abca19ce84d6aee7cb93984", "url": "https://github.com/google/ground-android/commit/6db2bc823f1422144abca19ce84d6aee7cb93984", "message": "Style compliance fixes", "committedDate": "2020-07-29T14:07:19Z", "type": "commit"}]}