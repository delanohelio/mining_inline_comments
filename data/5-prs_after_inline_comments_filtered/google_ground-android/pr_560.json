{"pr_number": 560, "pr_title": "Fetch Basemap sources from projects", "pr_createdAt": "2020-08-11T19:11:19Z", "pr_url": "https://github.com/google/ground-android/pull/560", "timeline": [{"oid": "9894bd47d1a347be03184a758cb7cacc21104b5d", "url": "https://github.com/google/ground-android/commit/9894bd47d1a347be03184a758cb7cacc21104b5d", "message": "Merge branch 'master' of https://github.com/google/ground-android into master", "committedDate": "2020-07-23T16:05:29Z", "type": "commit"}, {"oid": "59ac651dc9b078f50b53e0112b6b016ab587fa04", "url": "https://github.com/google/ground-android/commit/59ac651dc9b078f50b53e0112b6b016ab587fa04", "message": "Get tile json from project basemap sources\n\nProjects now contain a list of basemap sources, geojson files that specify tilesets for downloadable offline areas. This commit updates the OfflineAreaRepository to use the json sources specified in the active project instead of a json source on device.", "committedDate": "2020-08-11T18:46:11Z", "type": "commit"}, {"oid": "42b16d58919b0fa5623f7cce3400db2ce6cdd592", "url": "https://github.com/google/ground-android/commit/42b16d58919b0fa5623f7cce3400db2ce6cdd592", "message": "Update getIntersectingDownloadedTiles... to get json from the active project", "committedDate": "2020-08-11T19:07:20Z", "type": "commit"}, {"oid": "c2947032a4432f095a8e6b62a0dc36c2e8f20533", "url": "https://github.com/google/ground-android/commit/c2947032a4432f095a8e6b62a0dc36c2e8f20533", "message": "Remove config for on-device json source location\n\nNow that we pull json sources from projects, it's no longer needed.", "committedDate": "2020-08-11T19:07:51Z", "type": "commit"}, {"oid": "3be3daf6b2268a8d5f032d49ce185c727f9d2712", "url": "https://github.com/google/ground-android/commit/3be3daf6b2268a8d5f032d49ce185c727f9d2712", "message": "Merge branch 'master' of https://github.com/google/ground-android into project-basemap-source", "committedDate": "2020-08-11T19:09:02Z", "type": "commit"}, {"oid": "10480bfa9fe1751d1e03d0ca47d19e934bec01fd", "url": "https://github.com/google/ground-android/commit/10480bfa9fe1751d1e03d0ca47d19e934bec01fd", "message": "Merge branch 'master' into project-basemap-source", "committedDate": "2020-08-14T14:15:33Z", "type": "commit"}, {"oid": "716d61cd736675a3dcd919da206e7a406906c534", "url": "https://github.com/google/ground-android/commit/716d61cd736675a3dcd919da206e7a406906c534", "message": "Make id the primary key for Option entities", "committedDate": "2020-08-14T21:40:41Z", "type": "commit"}, {"oid": "c1b294801cc2d1d54a84b100af9012dbdfea6cb3", "url": "https://github.com/google/ground-android/commit/c1b294801cc2d1d54a84b100af9012dbdfea6cb3", "message": "Update GeoJsonTile URL_KEY", "committedDate": "2020-08-14T21:41:21Z", "type": "commit"}, {"oid": "a60c9df0dec7d032c8469de2a5a79079a5cbd90f", "url": "https://github.com/google/ground-android/commit/a60c9df0dec7d032c8469de2a5a79079a5cbd90f", "message": "Run OfflineAreaRepository streams on the io thread", "committedDate": "2020-08-14T21:42:02Z", "type": "commit"}, {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "url": "https://github.com/google/ground-android/commit/f0660a3fa22728ed035b4f2b7fde516062eace9b", "message": "Merge branch 'project-basemap-source' of https://github.com/scolsen/ground-android into project-basemap-source", "committedDate": "2020-08-14T21:43:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2Mzg4MA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470963880", "bodyText": "Could you also please remove the NOPMD from all these 3 places and 1 more in the same file?\nIt was added because of 4 occurrences of string literal \"field_id\". Now there are only 3\nhttps://pmd.github.io/latest/pmd_rules_java_errorprone.html#avoidduplicateliterals\nAlso, we should think about whether to disable this check as it is a bit annoying and less useful.", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:34:43Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/entity/OptionEntity.java", "diffHunk": "@@ -35,7 +35,7 @@\n             childColumns = \"field_id\", // NOPMD\n             onDelete = ForeignKey.CASCADE),\n     indices = {@Index(\"field_id\")}, // NOPMD\n-    primaryKeys = {\"code\", \"field_id\"}) // NOPMD\n+    primaryKeys = {\"id\"}) // NOPMD", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMjMzNA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471722334", "bodyText": "5b11ee0 thanks!", "author": "scolsen", "createdAt": "2020-08-17T19:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2Mzg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDQzMA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964430", "bodyText": "This block can be refactored into a new method and then reused in the rest of the code.", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:42:29Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -85,18 +109,33 @@ private Completable enqueueTileDownloads(OfflineArea area) {\n         .andThen(tileDownloadWorkManager.enqueueTileDownloadWorker());\n   }\n \n+  /**\n+   * Determine the set of tiles that need to be downloaded for a given area, then enqueue tile\n+   * downloads.\n+   */\n+  private Completable enqueueTileDownloads(OfflineArea area) {\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNzUxMA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471727510", "bodyText": "Good call, thanks! 80e58f8", "author": "scolsen", "createdAt": "2020-08-17T19:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDYyOQ==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964629", "bodyText": "How about passing only the first OfflineBaseMapSource to this method?\nSince the method is named downloadOfflineBaseMapSource, the error \"No basemap sources specified for this project.\" doesn't seem very intuitive. So that check should be done before the call reaches this function.\nWdyt?", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:45:08Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -38,42 +41,63 @@\n import io.reactivex.Single;\n import java.io.File;\n import java.io.IOException;\n+import java.net.URL;\n import javax.inject.Inject;\n+import org.apache.commons.io.FileUtils;\n import timber.log.Timber;\n \n public class OfflineAreaRepository {\n   private final TileDownloadWorkManager tileDownloadWorkManager;\n   private final LocalDataStore localDataStore;\n+  private final ProjectRepository projectRepository;\n   private final GeoJsonParser geoJsonParser;\n   private final FileUtil fileUtil;\n+  private final Schedulers schedulers;\n \n   private final OfflineUuidGenerator uuidGenerator;\n \n   @Inject\n   public OfflineAreaRepository(\n       TileDownloadWorkManager tileDownloadWorkManager,\n       LocalDataStore localDataStore,\n+      ProjectRepository projectRepository,\n       GeoJsonParser geoJsonParser,\n       OfflineUuidGenerator uuidGenerator,\n-      FileUtil fileUtil) {\n+      FileUtil fileUtil,\n+      Schedulers schedulers) {\n     this.tileDownloadWorkManager = tileDownloadWorkManager;\n     this.localDataStore = localDataStore;\n     this.geoJsonParser = geoJsonParser;\n     this.uuidGenerator = uuidGenerator;\n+    this.projectRepository = projectRepository;\n     this.fileUtil = fileUtil;\n+    this.schedulers = schedulers;\n   }\n \n-  private Completable enqueueTileDownloads(OfflineArea area) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Completable.error(e);\n+  /**\n+   * Download the offline basemap source for the active project.\n+   *\n+   * <p>Only the first basemap source is used. Sources are always re-downloaded and overwritten on\n+   * subsequent calls.\n+   */\n+  private File downloadOfflineBaseMapSource(\n+      ImmutableList<OfflineBaseMapSource> offlineBaseMapSources)\n+      throws IOException, NoBaseMapSourceException {\n+    if (offlineBaseMapSources.isEmpty()) {\n+      throw new NoBaseMapSourceException(\"No basemap sources specified for this project.\");\n     }\n \n-    ImmutableList<Tile> tiles = geoJsonParser.intersectingTiles(area.getBounds(), jsonSource);\n+    OfflineBaseMapSource source = offlineBaseMapSources.get(0);", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNzQzNQ==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471727435", "bodyText": "80e58f8 thanks!", "author": "scolsen", "createdAt": "2020-08-17T19:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDcyMg==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964722", "bodyText": "Please refactor as mentioned above.", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:46:18Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -109,19 +148,17 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n \n   public Flowable<ImmutableSet<Tile>> getIntersectingDownloadedTilesOnceAndStream(\n       OfflineArea offlineArea) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Flowable.error(e);\n-    }\n-\n-    ImmutableList<Tile> tiles =\n-        geoJsonParser.intersectingTiles(offlineArea.getBounds(), jsonSource);\n-\n-    return getDownloadedTilesOnceAndStream()\n-        .map(ts -> stream(tiles).filter(tiles::contains).collect(toImmutableSet()));\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNzM0MQ==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471727341", "bodyText": "80e58f8", "author": "scolsen", "createdAt": "2020-08-17T19:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDg0MA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964840", "bodyText": "Is the error non-fatal? If not, then please consider adding Timber.e() so that it eventually ends up in error/crash reporting.", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:48:14Z", "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -109,19 +148,17 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n \n   public Flowable<ImmutableSet<Tile>> getIntersectingDownloadedTilesOnceAndStream(\n       OfflineArea offlineArea) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Flowable.error(e);\n-    }\n-\n-    ImmutableList<Tile> tiles =\n-        geoJsonParser.intersectingTiles(offlineArea.getBounds(), jsonSource);\n-\n-    return getDownloadedTilesOnceAndStream()\n-        .map(ts -> stream(tiles).filter(tiles::contains).collect(toImmutableSet()));\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)\n+        .map(json -> geoJsonParser.intersectingTiles(offlineArea.getBounds(), json))\n+        .flatMap(\n+            tiles ->\n+                getDownloadedTilesOnceAndStream()\n+                    .map(ts -> stream(ts).filter(tiles::contains).collect(toImmutableSet())))\n+        .onErrorReturn(throwable -> ImmutableSet.of());", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyNzYzNw==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471727637", "bodyText": "It's not fatal in this case--added a brief explanation. 80e58f8", "author": "scolsen", "createdAt": "2020-08-17T19:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NTA4OA==", "url": "https://github.com/google/ground-android/pull/560#discussion_r470965088", "bodyText": "makeFile -> createFile?\nIn the comment, you've mentioned that it creates a new empty file. But it is not always going to be true if the file for the provided filename already exists. Please consider adding a check to validate that no file exists for the given name or update comment.", "author": "shobhitagarwal1612", "createdAt": "2020-08-15T10:51:28Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -70,6 +70,13 @@ public File getFile(String filename) throws FileNotFoundException {\n     return file;\n   }\n \n+  /**\n+   * Creates a new empty file in the app's file directory /data/data/com.google.android.gnd/files\n+   */\n+  public File makeFile(String filename) {", "originalCommit": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMzgyNg==", "url": "https://github.com/google/ground-android/pull/560#discussion_r471723826", "bodyText": "I've renamed it to getOrCreateFile and updated the comment accordingly, thanks! e17a280", "author": "scolsen", "createdAt": "2020-08-17T19:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NTA4OA=="}], "type": "inlineReview"}, {"oid": "80f43c4a1cd028b8ffe3c5c4e33fa9051fce66a2", "url": "https://github.com/google/ground-android/commit/80f43c4a1cd028b8ffe3c5c4e33fa9051fce66a2", "message": "Revert removal of google-services.json", "committedDate": "2020-08-17T19:12:16Z", "type": "commit"}, {"oid": "5b11ee0f7699ce2e369f905e695ab879dd0d22ff", "url": "https://github.com/google/ground-android/commit/5b11ee0f7699ce2e369f905e695ab879dd0d22ff", "message": "Remove NO_PMD annotations from OptionEntity\n\nThe ignored PMD violation stemmed from repetitions of the field_id literal. There are few enough repetitions now to prevent the violation from occurring, so we no longer need the annotations.", "committedDate": "2020-08-17T19:14:56Z", "type": "commit"}, {"oid": "e17a280a2b16e0ddf61887141892c7f1ccf4fbf8", "url": "https://github.com/google/ground-android/commit/e17a280a2b16e0ddf61887141892c7f1ccf4fbf8", "message": "Rename makeFile -> getOrCreateFile\n\nThis name more accurately describes what this method does--it is equivalent to getFile, sans an existence check. I've updated the corresponding comment as well.", "committedDate": "2020-08-17T19:19:18Z", "type": "commit"}, {"oid": "80e58f88e24788d3fe112481bea4b36f0e814b33", "url": "https://github.com/google/ground-android/commit/80e58f88e24788d3fe112481bea4b36f0e814b33", "message": "Refactor offline area repository methods\n\nThe basemap source stream wasn't completing, resulting in failed event\npropagations to the UI--that's fixed now.\n\nAdditionally, I've refactored some methods to make the code dryer.\n\nBig thanks to Shobhit for the feedback!", "committedDate": "2020-08-17T19:25:30Z", "type": "commit"}, {"oid": "a911334a2a0532f66cbe368e7f0b04bc8196c7a6", "url": "https://github.com/google/ground-android/commit/a911334a2a0532f66cbe368e7f0b04bc8196c7a6", "message": "Merge branch 'master' into project-basemap-source", "committedDate": "2020-08-18T17:40:57Z", "type": "commit"}]}