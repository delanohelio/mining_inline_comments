{"pr_number": 552, "pr_title": "[Feature] Add ability to delete features", "pr_createdAt": "2020-07-23T11:13:19Z", "pr_url": "https://github.com/google/ground-android/pull/552", "timeline": [{"oid": "aff6e8889f747367584fa1ada277b1dd1055c4f3", "url": "https://github.com/google/ground-android/commit/aff6e8889f747367584fa1ada277b1dd1055c4f3", "message": "Add unit test", "committedDate": "2020-07-23T11:53:51Z", "type": "forcePushed"}, {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899", "url": "https://github.com/google/ground-android/commit/1e58c77259e194e162f55dcfba6f2a4df8444899", "message": "Add unit test", "committedDate": "2020-07-23T12:02:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMDIwMQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459420201", "bodyText": "Naming nit: we may want to call this \"markFeatureForDeletion\" to distinguish it from our future state where we don't actually delete things, but rather mark them as \"deleted\". In that case there would be three states in the local DB, \"not deleted\", \"marked for deletion on remote\", and \"deleted\".", "author": "gino-m", "createdAt": "2020-07-23T12:44:40Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -387,17 +388,42 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureDeleted(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureDeleted(\n+      FeatureEntity featureEntity, FeatureMutation mutation) {", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MjU2Mg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459592562", "bodyText": "Done c210b45", "author": "shobhitagarwal1612", "createdAt": "2020-07-23T16:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMDIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMTAwNg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459421006", "bodyText": "Can this steam be simplified by starting it with the call to featureDao.update?", "author": "gino-m", "createdAt": "2020-07-23T12:45:58Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -387,17 +388,42 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureDeleted(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureDeleted(\n+      FeatureEntity featureEntity, FeatureMutation mutation) {\n+    return Single.just(featureEntity)\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .map(entity -> entity.toBuilder().setState(EntityState.DELETED).build())\n+        .flatMap(entity -> featureDao.update(entity))", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MjEyNg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459592126", "bodyText": "Yep. Done 9a65f16", "author": "shobhitagarwal1612", "createdAt": "2020-07-23T16:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMjA2Ng==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459422066", "bodyText": "Can you refer to the static constant here for state 1 instead? You should be able to concat it to the string with +.", "author": "gino-m", "createdAt": "2020-07-23T12:47:48Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/FeatureDao.java", "diffHunk": "@@ -26,7 +26,7 @@\n /** Provides low-level read/write operations of {@link FeatureEntity} to/from the local db. */\n @Dao\n public interface FeatureDao extends BaseDao<FeatureEntity> {\n-  @Query(\"SELECT * FROM feature WHERE project_id = :projectId\")\n+  @Query(\"SELECT * FROM feature WHERE project_id = :projectId AND state = 1\")", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MTg4NQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459591885", "bodyText": "String concatenation can't be used. So, instead I passed the state value as a parameter.\n1d04039", "author": "shobhitagarwal1612", "createdAt": "2020-07-23T16:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzODI2NQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459538265", "bodyText": "Please add GitHub issue no to TODO, e.g. TODO(#123).", "author": "gino-m", "createdAt": "2020-07-23T15:30:38Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/FeatureDocumentReference.java", "diffHunk": "@@ -35,7 +35,9 @@ public void addMutationToBatch(FeatureMutation mutation, User user, WriteBatch b\n         merge(FeatureMutationConverter.toMap(mutation, user), batch);\n         break;\n       case DELETE:\n-        // TODO: Implement me!\n+        // TODO: Also delete all remote observations linked to this feature.", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0MjAyNA==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459542024", "bodyText": "The naming of this method is a bit misleading; it actually filters out delete mutations and applies them to the local db. To make this clearer, I think we could do something like the following:\n  private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n    return remoteDataStore\n        .applyMutations(mutations, user)\n        .andThen(localDataStore.finalizeMutations(mutations));\n  }\n\nThen from LocalDataStore.finalizePendingMutations  we could finalizeDeletions and removePending, both in LocalDataStore. Wdyt?", "author": "gino-m", "createdAt": "2020-07-23T15:35:58Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -112,17 +113,26 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n-        .andThen(deleteObservationIfRemovedRemotely(mutations))\n+        .andThen(deleteObservationOrFeature(mutations))\n         .andThen(localDataStore.removePendingMutations(mutations));\n   }\n \n   // TODO: If the remote sync fails, reset the state to DEFAULT.\n-  private Completable deleteObservationIfRemovedRemotely(ImmutableList<Mutation> mutations) {\n+  private Completable deleteObservationOrFeature(ImmutableList<Mutation> mutations) {", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MTM0NA==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459591344", "bodyText": "Thanks! This makes so much sense now\n05b7f5b", "author": "shobhitagarwal1612", "createdAt": "2020-07-23T16:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0MjAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzM4Mg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459547382", "bodyText": "With autoDisposable() used here, I believe it will scope the subscription to the entire lifecycle of the HomeScreenFragment. These will accumulate as long as the home screen remains open.\nTo fix this, you can create a PublishProcessor deleteFeatureRequests in the VM which you could populate with feature id on each deletion request. That stream would then be flatMapped to the actual feature deletion observable, the resulting stream exposed as a stream of SingleEvent that is subscribed to in one of the create methods of this class. Wdyt?", "author": "gino-m", "createdAt": "2020-07-23T15:43:50Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java", "diffHunk": "@@ -232,10 +236,25 @@ private void closeDrawer() {\n   }\n \n   @Override\n-  public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {\n+  public void onCreateOptionsMenu(@NonNull Menu menu, MenuInflater inflater) {\n     inflater.inflate(R.menu.feature_sheet_menu, menu);\n   }\n \n+  @Override\n+  public boolean onOptionsItemSelected(@NonNull MenuItem item) {\n+    switch (item.getItemId()) {\n+      case R.id.move_feature_menu_item:\n+        // TODO\n+        return false;\n+      case R.id.delete_feature_menu_item:\n+        // TODO: Re-position map to default location after successful deletion.\n+        viewModel.deleteActiveFeature().as(autoDisposable(this)).subscribe(this::hideBottomSheet);", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwNjkwMg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r460106902", "bodyText": "Done. Thanks", "author": "shobhitagarwal1612", "createdAt": "2020-07-24T14:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzcwNg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459547706", "bodyText": "Why do we remove the current user here?", "author": "gino-m", "createdAt": "2020-07-23T15:44:18Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -80,7 +78,7 @@\n             .switchMapSingle(\n                 newFeature ->\n                     featureRepository\n-                        .saveFeature(newFeature, authManager.getCurrentUser())\n+                        .saveFeature(newFeature)", "originalCommit": "1e58c77259e194e162f55dcfba6f2a4df8444899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MzE5Mw==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459593193", "bodyText": "AuthenticationManager is now moved to FeatureRepository for simplicity.", "author": "shobhitagarwal1612", "createdAt": "2020-07-23T16:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzcwNg=="}], "type": "inlineReview"}, {"oid": "6c49e69b9aa24d77c240d1f49e40b510545ba3af", "url": "https://github.com/google/ground-android/commit/6c49e69b9aa24d77c240d1f49e40b510545ba3af", "message": "Fix theme for toolbar", "committedDate": "2020-07-23T15:47:35Z", "type": "commit"}, {"oid": "ff5a5b0f3c1749b02288ad8bfdd3aa361819f8e1", "url": "https://github.com/google/ground-android/commit/ff5a5b0f3c1749b02288ad8bfdd3aa361819f8e1", "message": "Add toBuilder() for converting entity to builder", "committedDate": "2020-07-23T15:47:35Z", "type": "commit"}, {"oid": "04fc89217e9060c32551b32842c72df2ac75a661", "url": "https://github.com/google/ground-android/commit/04fc89217e9060c32551b32842c72df2ac75a661", "message": "Add methods to repository for UI to interact with\n\n - Add deleteFeature() to FeatureRepository to enqueuing mutation\n - Move AuthenticationManager to FeatureRepository\n - Add method to HomeScreenViewModel to delete active feature", "committedDate": "2020-07-23T15:47:35Z", "type": "commit"}, {"oid": "87648003f4fbe26f58c36c24650b5d74e69b7d79", "url": "https://github.com/google/ground-android/commit/87648003f4fbe26f58c36c24650b5d74e69b7d79", "message": "Handle delete mutation when applying to local database", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "14eef0e9bbc7a91a5101c5afaa05ba9650bb7477", "url": "https://github.com/google/ground-android/commit/14eef0e9bbc7a91a5101c5afaa05ba9650bb7477", "message": "Handle delete mutation in LocalMutationSyncWorker", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "4e49697b27de4c2ba3db48ed60337ec28bf271c2", "url": "https://github.com/google/ground-android/commit/4e49697b27de4c2ba3db48ed60337ec28bf271c2", "message": "Handle delete type in FeatureDocumentReference", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "9e858ba67b77b65631d1ae96da5bcd16b116557f", "url": "https://github.com/google/ground-android/commit/9e858ba67b77b65631d1ae96da5bcd16b116557f", "message": "Hook UI to repository\n\n - On successful delete, hide the bottom sheet", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "e0af26e504c5bfddb15cfde1ec88a5da6b0bad5e", "url": "https://github.com/google/ground-android/commit/e0af26e504c5bfddb15cfde1ec88a5da6b0bad5e", "message": "Load only active features from local db", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "5ebf48c25c1013bdc9bc48b3ea0763786840f7fb", "url": "https://github.com/google/ground-android/commit/5ebf48c25c1013bdc9bc48b3ea0763786840f7fb", "message": "Unrelated changes to Project.xml by IDE", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "22e2122857a100077d9d7d7005b63d4064fd6e9e", "url": "https://github.com/google/ground-android/commit/22e2122857a100077d9d7d7005b63d4064fd6e9e", "message": "Add todo and update method names", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "11e4b6beaeacf71d408b132244754a3f3530ae8f", "url": "https://github.com/google/ground-android/commit/11e4b6beaeacf71d408b132244754a3f3530ae8f", "message": "Add unit test", "committedDate": "2020-07-23T15:47:36Z", "type": "commit"}, {"oid": "c210b452ac3acb7c96b734ea279495d77af68427", "url": "https://github.com/google/ground-android/commit/c210b452ac3acb7c96b734ea279495d77af68427", "message": "Rename method to mark*ForDeletion\n\nFrom Gino: This is to distinguish it from our future state where we don't actually delete things, but rather mark them as \"deleted\". In that case there would be three states in the local DB, \"not deleted\", \"marked for deletion on remote\", and \"deleted\".", "committedDate": "2020-07-23T15:51:30Z", "type": "commit"}, {"oid": "9a65f16d32b3e4d782a2321da425eb0b3e9da8ea", "url": "https://github.com/google/ground-android/commit/9a65f16d32b3e4d782a2321da425eb0b3e9da8ea", "message": "Simplify method by starting call with *Dao.update()", "committedDate": "2020-07-23T16:03:03Z", "type": "commit"}, {"oid": "1d0403954e77804fdb2cb712aaeed3cbf2cf0886", "url": "https://github.com/google/ground-android/commit/1d0403954e77804fdb2cb712aaeed3cbf2cf0886", "message": "Avoid using magic numbers for entity state.", "committedDate": "2020-07-23T16:12:45Z", "type": "commit"}, {"oid": "6022ed38affc9ab252f815e7dd43cb0bcacdaf84", "url": "https://github.com/google/ground-android/commit/6022ed38affc9ab252f815e7dd43cb0bcacdaf84", "message": "Add existing issue number next to TODO", "committedDate": "2020-07-23T16:14:10Z", "type": "commit"}, {"oid": "05b7f5b622f80528f88bf12ec1f02c1f14678302", "url": "https://github.com/google/ground-android/commit/05b7f5b622f80528f88bf12ec1f02c1f14678302", "message": "Refactor finalizing pending mutations", "committedDate": "2020-07-23T16:34:08Z", "type": "commit"}, {"oid": "05b7f5b622f80528f88bf12ec1f02c1f14678302", "url": "https://github.com/google/ground-android/commit/05b7f5b622f80528f88bf12ec1f02c1f14678302", "message": "Refactor finalizing pending mutations", "committedDate": "2020-07-23T16:34:08Z", "type": "forcePushed"}, {"oid": "ba945002a8895c2c45b14076219effe556ecbe09", "url": "https://github.com/google/ground-android/commit/ba945002a8895c2c45b14076219effe556ecbe09", "message": "Fix line length", "committedDate": "2020-07-23T17:07:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3Nzk1MQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459777951", "bodyText": "@Transaction doesn't apply to Firebase, which uses it's own API (db.runTransaction) to batch writings. Please remove here and throughout.", "author": "gino-m", "createdAt": "2020-07-23T23:13:07Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -333,9 +335,29 @@ public Completable updateMutations(ImmutableList<Mutation> mutations) {\n         .collect(toImmutableList());\n   }\n \n-  @Transaction\n   @Override\n-  public Completable removePendingMutations(ImmutableList<Mutation> mutations) {\n+  public Completable finalizePendingMutations(ImmutableList<Mutation> mutations) {\n+    return finalizeDeletions(mutations).andThen(removePending(mutations));\n+  }\n+\n+  @Transaction", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwNjk4NQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r460106985", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-07-24T14:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3Nzk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODA3MQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778071", "bodyText": "Perhaps Timber.t would be more appropriate here (or remove altogether).", "author": "gino-m", "createdAt": "2020-07-23T23:13:35Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMDUxNA==", "url": "https://github.com/google/ground-android/pull/552#discussion_r460100514", "bodyText": "Timber.t doesn't exist. Were you referring to info level?", "author": "shobhitagarwal1612", "createdAt": "2020-07-24T14:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwNDE1Nw==", "url": "https://github.com/google/ground-android/pull/552#discussion_r461204157", "bodyText": "Sorry, I didn't realize there wasn't a \"trace\" log level with Timber. Please disregard.", "author": "gino-m", "createdAt": "2020-07-27T22:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODIwMg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778202", "bodyText": "This can return Completable instead.", "author": "gino-m", "createdAt": "2020-07-23T23:14:02Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODIzMg==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778232", "bodyText": "Same here.", "author": "gino-m", "createdAt": "2020-07-23T23:14:09Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .ignoreElement()\n+        .subscribeOn(schedulers.io());\n+  }\n+\n   private Completable insertOrUpdateFeature(FeatureMutation mutation, User user) {\n     return featureDao\n         .insertOrUpdate(FeatureEntity.fromMutation(mutation, AuditInfo.now(user)))\n         .subscribeOn(schedulers.io());\n   }\n \n+  @Override\n+  public Completable deleteFeature(String featureId) {\n+    return featureDao\n+        .findById(featureId)\n+        .toSingle()\n+        .doOnSubscribe(__ -> Timber.d(\"Deleting local feature : %s\", featureId))", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODQ0MQ==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778441", "bodyText": "No need to change the subscribeOn thread inside private methods; it only needs to be done in the main entry point of each operation, the setting propagates to the rest of the stream.", "author": "gino-m", "createdAt": "2020-07-23T23:14:50Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .ignoreElement()\n+        .subscribeOn(schedulers.io());", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODgyNA==", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778824", "bodyText": "Using our convention in the Wiki, should should be called findOnceAndStream (or findByProjectIdAndEntityStateOnceAndStream, but that seems excessive).", "author": "gino-m", "createdAt": "2020-07-23T23:15:59Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/FeatureDao.java", "diffHunk": "@@ -19,15 +19,16 @@\n import androidx.room.Dao;\n import androidx.room.Query;\n import com.google.android.gnd.persistence.local.room.entity.FeatureEntity;\n+import com.google.android.gnd.persistence.local.room.models.EntityState;\n import io.reactivex.Flowable;\n import io.reactivex.Maybe;\n import java.util.List;\n \n /** Provides low-level read/write operations of {@link FeatureEntity} to/from the local db. */\n @Dao\n public interface FeatureDao extends BaseDao<FeatureEntity> {\n-  @Query(\"SELECT * FROM feature WHERE project_id = :projectId\")\n-  Flowable<List<FeatureEntity>> findByProjectIdStream(String projectId);\n+  @Query(\"SELECT * FROM feature WHERE project_id = :projectId AND state = :state\")\n+  Flowable<List<FeatureEntity>> findByProjectIdStream(String projectId, EntityState state);", "originalCommit": "ba945002a8895c2c45b14076219effe556ecbe09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2661073119bcada83b6f3c21971f47a02ef99c9", "url": "https://github.com/google/ground-android/commit/f2661073119bcada83b6f3c21971f47a02ef99c9", "message": "Avoid using autoDisposable() and replace with LiveData", "committedDate": "2020-07-24T14:45:10Z", "type": "commit"}, {"oid": "e3f1b66d218fa41f161fe6956becd31fa999ed79", "url": "https://github.com/google/ground-android/commit/e3f1b66d218fa41f161fe6956becd31fa999ed79", "message": "Remove annotation Transaction\n\nSince this doesn't apply to firebase, it's better not to include it", "committedDate": "2020-07-24T14:46:49Z", "type": "commit"}, {"oid": "8fbcff7a38e0ed4e117a22f024b49e63c2057d29", "url": "https://github.com/google/ground-android/commit/8fbcff7a38e0ed4e117a22f024b49e63c2057d29", "message": "Replace CompletableSource with Completable", "committedDate": "2020-07-24T14:49:56Z", "type": "commit"}, {"oid": "9858e8e9ea1294b2619b219440c752bbac190761", "url": "https://github.com/google/ground-android/commit/9858e8e9ea1294b2619b219440c752bbac190761", "message": "Remove unnecessary thread switching inside private methods", "committedDate": "2020-07-24T14:53:45Z", "type": "commit"}, {"oid": "f6591275c886c98ade2e3c5064b8594b1bc38356", "url": "https://github.com/google/ground-android/commit/f6591275c886c98ade2e3c5064b8594b1bc38356", "message": "Improve method name to follow naming conventions", "committedDate": "2020-07-24T14:57:25Z", "type": "commit"}]}