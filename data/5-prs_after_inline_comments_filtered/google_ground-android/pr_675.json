{"pr_number": 675, "pr_title": "Refactor handler for MultipleChoiceFields", "pr_createdAt": "2020-12-28T06:34:54Z", "pr_url": "https://github.com/google/ground-android/pull/675", "timeline": [{"oid": "18fc54e4acddaf197506bd81ea9859ad9e0f1594", "url": "https://github.com/google/ground-android/commit/18fc54e4acddaf197506bd81ea9859ad9e0f1594", "message": "Add abstract builder for select dialogs", "committedDate": "2020-12-27T02:57:15Z", "type": "commit"}, {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000", "url": "https://github.com/google/ground-android/commit/d537f15e632625a64dbfaebe584b443dac6bc000", "message": "Add helper method to VM", "committedDate": "2020-12-28T05:59:00Z", "type": "commit"}, {"oid": "0f8afc8e00c6fb731386e136f4ca31d77790d0c4", "url": "https://github.com/google/ground-android/commit/0f8afc8e00c6fb731386e136f4ca31d77790d0c4", "message": "Add base methods for generating alert dialog", "committedDate": "2020-12-28T06:22:32Z", "type": "commit"}, {"oid": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "url": "https://github.com/google/ground-android/commit/bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "message": "Refactor Single/MultiSelectDialogFactory", "committedDate": "2020-12-28T06:23:36Z", "type": "commit"}, {"oid": "ef1f7147a0ba1db5d188a33005c34a191e8310ae", "url": "https://github.com/google/ground-android/commit/ef1f7147a0ba1db5d188a33005c34a191e8310ae", "message": "Update usages", "committedDate": "2020-12-28T06:26:00Z", "type": "commit"}, {"oid": "ed3869a76a7f3d8f843bf5ec4b7b6fac9ad27d4c", "url": "https://github.com/google/ground-android/commit/ed3869a76a7f3d8f843bf5ec4b7b6fac9ad27d4c", "message": "Fix method name", "committedDate": "2020-12-28T06:29:08Z", "type": "commit"}, {"oid": "e6347d5de0c7d84c0732a98fa1b5b3c4d8cfc623", "url": "https://github.com/google/ground-android/commit/e6347d5de0c7d84c0732a98fa1b5b3c4d8cfc623", "message": "Merge branch 'master' into refactor", "committedDate": "2020-12-28T20:07:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549742947", "bodyText": "I think you could do:\n Optional.ofNullable(getResponse().getValue())\n                .flatMap(MultipleChoiceResponse.class::cast);", "author": "gino-m", "createdAt": "2020-12-29T15:20:20Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldViewModel.java", "diffHunk": "@@ -37,4 +39,10 @@ public void onShowDialog() {\n   MutableLiveData<Nil> getShowDialogClicks() {\n     return showDialogClicks;\n   }\n+\n+  Optional<MultipleChoiceResponse> getCurrentResponse() {\n+    return getResponse().getValue() == null", "originalCommit": "d537f15e632625a64dbfaebe584b443dac6bc000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MDg1NQ==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549780855", "bodyText": "That results in Optional<Optional< MultipleChoiceResponse>> as getResponse() already returns optional. Couldn't think of any other way to do the check. Do you have an idea?", "author": "shobhitagarwal1612", "createdAt": "2020-12-29T17:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDI2NQ==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549784265", "bodyText": "If getValue() returns an Optional, it shouldn't also be nullable. Would it be difficult to update it so that getValue() is @NonNull?", "author": "gino-m", "createdAt": "2020-12-29T17:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NzkxNw==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549787917", "bodyText": "getValue() is a method of LiveData class. We can't update it.", "author": "shobhitagarwal1612", "createdAt": "2020-12-29T17:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTgwMDA4Ng==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549800086", "bodyText": "Ah, sorry, you're right. In general, moving forward we should probably replace LiveData<Optional> with LiveData; we'd like to avoid cases where a variable can be both null or Optional. Related to #679.", "author": "gino-m", "createdAt": "2020-12-29T18:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDI4MA==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744280", "bodyText": "Can we make this empty by default instead of null?", "author": "gino-m", "createdAt": "2020-12-29T15:23:55Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultiSelectDialogFactory.java", "diffHunk": "@@ -16,84 +16,75 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n \n import android.content.Context;\n+import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n import java8.util.stream.IntStreams;\n \n-// TODO: Replace with modal bottom sheet.\n-class MultiSelectDialogFactory {\n+@AutoValue\n+abstract class MultiSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  @Nullable private boolean[] checkedItems;", "originalCommit": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4MjczNg==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549782736", "bodyText": "The size is determined after calling initSelectedState(). Also, setMultiChoiceItems also expects null if none of the items are selected. We can also use a collection instead of an array. But then we'll have to manually track all selected items. This way, the original array gets updated which we directly use.", "author": "shobhitagarwal1612", "createdAt": "2020-12-29T17:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDUxOA==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744518", "bodyText": "Do we need this wrapper function here? It doesn't seem to provide much abstraction or logic of its own.", "author": "gino-m", "createdAt": "2020-12-29T15:24:36Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultiSelectDialogFactory.java", "diffHunk": "@@ -16,84 +16,75 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n \n import android.content.Context;\n+import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n import java8.util.stream.IntStreams;\n \n-// TODO: Replace with modal bottom sheet.\n-class MultiSelectDialogFactory {\n+@AutoValue\n+abstract class MultiSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  @Nullable private boolean[] checkedItems;\n \n-  MultiSelectDialogFactory(Context context) {\n-    this.context = context;\n+  private static Builder builder() {\n+    return new AutoValue_MultiSelectDialogFactory.Builder();\n   }\n \n-  AlertDialog create(\n-      Field field,\n-      Optional<Response> initialResponse,\n-      Consumer<Optional<Response>> responseChangeCallback) {\n-    MultipleChoice multipleChoice = field.getMultipleChoice();\n-    checkNotNull(\n-        multipleChoice,\n-        \"When creating a MultiSelectDialogFactory the field must have a non-null MultipleChoice\");\n-\n-    AlertDialog.Builder dialogBuilder = new AlertDialog.Builder(context);\n-    List<Option> options = multipleChoice.getOptions();\n-    final DialogState state = new DialogState(multipleChoice, initialResponse);\n-    dialogBuilder.setMultiChoiceItems(\n-        getLabels(multipleChoice), state.checkedItems, (dialog, which, isChecked) -> {});\n-    dialogBuilder.setCancelable(false);\n-    dialogBuilder.setTitle(field.getLabel());\n-    dialogBuilder.setPositiveButton(\n-        R.string.apply_multiple_choice_changes,\n-        (dialog, which) -> responseChangeCallback.accept(state.getSelectedValues(options)));\n-    dialogBuilder.setNegativeButton(R.string.cancel, (dialog, which) -> {});\n-    return dialogBuilder.create();\n+  public static void showSelectDialog(", "originalCommit": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4Mjk1MQ==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549782951", "bodyText": "We can move it to the calling function.", "author": "shobhitagarwal1612", "createdAt": "2020-12-29T17:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDc0Ng==", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744746", "bodyText": "Same here.", "author": "gino-m", "createdAt": "2020-12-29T15:25:06Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/SingleSelectDialogFactory.java", "diffHunk": "@@ -16,91 +16,79 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n-\n import android.content.Context;\n import android.content.DialogInterface;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n \n-// TODO: Replace with modal bottom sheet.\n-class SingleSelectDialogFactory {\n+@AutoValue\n+abstract class SingleSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  private int checkedItem;\n \n-  SingleSelectDialogFactory(Context context) {\n-    this.context = context;\n+  private static Builder builder() {\n+    return new AutoValue_SingleSelectDialogFactory.Builder();\n   }\n \n-  AlertDialog create(\n-      Field field,\n-      Optional<Response> initialValue,\n-      Consumer<Optional<Response>> valueChangeCallback) {\n-    MultipleChoice multipleChoice = field.getMultipleChoice();\n-    checkNotNull(\n-        multipleChoice,\n-        \"When creating a SingleSelectDialogFactory the field must have a non-null MultipleChoice\"\n-    );\n-\n-    AlertDialog.Builder dialogBuilder = new AlertDialog.Builder(context);\n-    List<Option> options = multipleChoice.getOptions();\n-    DialogState state = new DialogState(multipleChoice, initialValue);\n-    dialogBuilder.setSingleChoiceItems(\n-        getLabels(multipleChoice), state.checkedItem, state::onSelect);\n-    dialogBuilder.setCancelable(false);\n-    dialogBuilder.setTitle(field.getLabel());\n-    dialogBuilder.setPositiveButton(\n-        R.string.apply_multiple_choice_changes,\n-        (dialog, which) -> valueChangeCallback.accept(state.getSelectedValue(options)));\n-    dialogBuilder.setNegativeButton(R.string.cancel, (dialog, which) -> {});\n-    return dialogBuilder.create();\n+  public static void showSelectDialog(", "originalCommit": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6eca88da25be3c363fc4b2fae85d91a591b0391", "url": "https://github.com/google/ground-android/commit/a6eca88da25be3c363fc4b2fae85d91a591b0391", "message": "Set default checked value for single select", "committedDate": "2020-12-29T17:10:44Z", "type": "commit"}, {"oid": "d0ef2009cca65aaf17edf36d151d41147174b204", "url": "https://github.com/google/ground-android/commit/d0ef2009cca65aaf17edf36d151d41147174b204", "message": "Create dialog in fragment", "committedDate": "2020-12-29T17:27:28Z", "type": "commit"}]}