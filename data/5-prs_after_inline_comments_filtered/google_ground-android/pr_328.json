{"pr_number": 328, "pr_title": "[Support Photos] Add photo field to observation", "pr_createdAt": "2020-01-19T17:45:49Z", "pr_url": "https://github.com/google/ground-android/pull/328", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1MDU2Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369650566", "bodyText": "Instead of using completeIf, why not have sendIntent return a completable?", "author": "scolsen", "createdAt": "2020-01-22T16:03:48Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.util.Log;\n+import com.google.android.gnd.rx.RxCompletable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class StorageManager {\n+\n+  public static final String TAG = StorageManager.class.getName();\n+\n+  private static final int PICKFILE_REQUEST_CODE = StorageManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public StorageManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public void imagePicker() {\n+    permissionsManager\n+        .obtainPermission(permission.READ_EXTERNAL_STORAGE)\n+        .andThen(RxCompletable.completeIf(this::sendIntent))", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1NjYxMQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369656611", "bodyText": "Wrap in a call to Completable.fromObservable and return the completable? (This way we'll catch any (highly unlikely) errors emitted by the publish subject)\nsee: http://reactivex.io/RxJava/javadoc/io/reactivex/Completable.html#fromObservable-io.reactivex.ObservableSource-", "author": "scolsen", "createdAt": "2020-01-22T16:14:00Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.util.Log;\n+import com.google.android.gnd.rx.RxCompletable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class StorageManager {\n+\n+  public static final String TAG = StorageManager.class.getName();\n+\n+  private static final int PICKFILE_REQUEST_CODE = StorageManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public StorageManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public void imagePicker() {\n+    permissionsManager\n+        .obtainPermission(permission.READ_EXTERNAL_STORAGE)\n+        .andThen(RxCompletable.completeIf(this::sendIntent))\n+        .andThen(\n+            activityStreams\n+                .getNextActivityResult(PICKFILE_REQUEST_CODE)\n+                .doOnNext(\n+                    activityResult -> {\n+                      if (activityResult.isOk()) {\n+                        Intent intent = activityResult.getData();\n+                        if (intent != null) {\n+                          Log.d(TAG, activityResult.getData().getData() + \" = uri\");\n+                        }\n+                      } else if (activityResult.isCanceled()) {\n+                        Log.d(TAG, \"file picker canceled\");\n+                      }\n+                    }))\n+        .subscribe();\n+  }\n+\n+  private boolean sendIntent() {\n+    Log.d(TAG, \"Sending file picker intent\");\n+    activityStreams.withActivity(", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1MzAxMA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369753010", "bodyText": "I had to use Completable.fromAction as activityStreams.withActivity doesn't return anything", "author": "shobhitagarwal1612", "createdAt": "2020-01-22T19:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1NjYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2MjAxMQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369662011", "bodyText": "Wrap in a call to Completable.fromObservable and return the completable? (This way we'll catch any (highly unlikely) errors emitted by the publish subject)\nsee: http://reactivex.io/RxJava/javadoc/io/reactivex/Completable.html#fromObservable-io.reactivex.ObservableSource-", "author": "scolsen", "createdAt": "2020-01-22T16:22:54Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.util.Log;\n+import com.google.android.gnd.rx.RxCompletable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class CameraManager {\n+\n+  public static final String TAG = CameraManager.class.getName();\n+\n+  private static final int CAPTURE_PHOTO_REQUEST_CODE = CameraManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public CameraManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public void clickPhoto() {\n+    permissionsManager\n+        .obtainPermission(permission.WRITE_EXTERNAL_STORAGE)\n+        .andThen(permissionsManager.obtainPermission(permission.CAMERA))\n+        .andThen(RxCompletable.completeIf(this::sendIntent))\n+        .andThen(\n+            activityStreams\n+                .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n+                .doOnNext(\n+                    activityResult -> {\n+                      if (activityResult.isOk()) {\n+                        Intent intent = activityResult.getData();\n+                        if (intent != null) {\n+                          Bitmap photo = (Bitmap) intent.getExtras().get(\"data\");\n+                          Log.d(TAG, photo.toString());\n+                        }\n+                      } else if (activityResult.isCanceled()) {\n+                        Log.d(TAG, \"capture photo canceled\");\n+                      }\n+                    }))\n+        .subscribe();\n+  }\n+\n+  private boolean sendIntent() {\n+    Log.d(TAG, \"Sending capture photo intent\");\n+    activityStreams.withActivity(", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2MjU4Nw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369662587", "bodyText": "Eventually, we probably don't want to subscribe in these classes themselves, but to expose their streams to callers and subscribe there.", "author": "scolsen", "createdAt": "2020-01-22T16:23:50Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.util.Log;\n+import com.google.android.gnd.rx.RxCompletable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class CameraManager {\n+\n+  public static final String TAG = CameraManager.class.getName();\n+\n+  private static final int CAPTURE_PHOTO_REQUEST_CODE = CameraManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public CameraManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public void clickPhoto() {\n+    permissionsManager\n+        .obtainPermission(permission.WRITE_EXTERNAL_STORAGE)\n+        .andThen(permissionsManager.obtainPermission(permission.CAMERA))\n+        .andThen(RxCompletable.completeIf(this::sendIntent))\n+        .andThen(\n+            activityStreams\n+                .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n+                .doOnNext(\n+                    activityResult -> {\n+                      if (activityResult.isOk()) {\n+                        Intent intent = activityResult.getData();\n+                        if (intent != null) {\n+                          Bitmap photo = (Bitmap) intent.getExtras().get(\"data\");\n+                          Log.d(TAG, photo.toString());\n+                        }\n+                      } else if (activityResult.isCanceled()) {\n+                        Log.d(TAG, \"capture photo canceled\");\n+                      }\n+                    }))\n+        .subscribe();", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ5OTI2MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r370499260", "bodyText": "Fixed", "author": "shobhitagarwal1612", "createdAt": "2020-01-24T07:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2MjU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2NDg5MQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369664891", "bodyText": "Can we somehow use butterknife binding  butterknife.BindView here instead instead of calls to show, etc.?", "author": "scolsen", "createdAt": "2020-01-22T16:27:38Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -197,6 +203,12 @@ public void onShowDialog(Field field) {\n     }\n   }\n \n+  public void onShowPhotoSelectorDialog(Field field) {", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNDYzNQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r370224635", "bodyText": "I'm okay with either of the two options. Just wanted to be consistent with other places. Should I replace this with Butterknife and remove DataBinding?\n@scolsen", "author": "shobhitagarwal1612", "createdAt": "2020-01-23T16:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2NDg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2MjUzMA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r370362530", "bodyText": "Ah, all good--I think my initial comment is irrelevant here since this is dialog frag.\nThis should be fine.", "author": "scolsen", "createdAt": "2020-01-23T21:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2NDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY2NTcwNQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r369665705", "bodyText": "Instead of making this generic, why not just call it PhotoDialogFragment for now and abstract later once and if we need to?", "author": "scolsen", "createdAt": "2020-01-22T16:28:59Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/ActionBottomDialogFragment.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.content.Context;\n+import android.os.Bundle;\n+import android.util.Log;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.BottomSheetBinding;\n+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;\n+\n+public class ActionBottomDialogFragment extends BottomSheetDialogFragment {", "originalCommit": "8b049cadb44c3dacfec8c26e600638b8bc4af900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fcfc32591517900df9c0124acf4407da5f7d954", "url": "https://github.com/google/ground-android/commit/7fcfc32591517900df9c0124acf4407da5f7d954", "message": "Merge remote-tracking branch 'origin/photos-support' into photos-support", "committedDate": "2020-01-24T07:19:31Z", "type": "forcePushed"}, {"oid": "1658541a6302c208033b31ba32010b6f5b202588", "url": "https://github.com/google/ground-android/commit/1658541a6302c208033b31ba32010b6f5b202588", "message": "Add method to select images from storage", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "493a5f179a305810d66c44af38083a5289e2af94", "url": "https://github.com/google/ground-android/commit/493a5f179a305810d66c44af38083a5289e2af94", "message": "Parse Uri if result is OK", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "830b6a849f813787750aa8e43d614160674fb041", "url": "https://github.com/google/ground-android/commit/830b6a849f813787750aa8e43d614160674fb041", "message": "Add camera/write permissions and CameraManager", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "8579c9350f09cb997e1b10961ae028a1aaf1c3fe", "url": "https://github.com/google/ground-android/commit/8579c9350f09cb997e1b10961ae028a1aaf1c3fe", "message": "Add layout for bottom modal sheet", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "80dd44a44f3c96424884718e0be9a3e7b71b8870", "url": "https://github.com/google/ground-android/commit/80dd44a44f3c96424884718e0be9a3e7b71b8870", "message": "Add ModalBottomDialog fragment", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "3eb5979bfd47c4b5b9846416add95e3dba78c80c", "url": "https://github.com/google/ground-android/commit/3eb5979bfd47c4b5b9846416add95e3dba78c80c", "message": "Attach UI for photo select/capture", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "3880ccaf1377756d6b0c0b06ff033b2d1559d1c6", "url": "https://github.com/google/ground-android/commit/3880ccaf1377756d6b0c0b06ff033b2d1559d1c6", "message": "Fix capture/select photo", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "a9af8c7b791b5bad35559c73caa3fd45fcdef628", "url": "https://github.com/google/ground-android/commit/a9af8c7b791b5bad35559c73caa3fd45fcdef628", "message": "Revert test changes", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "0ac3c154ca2665c544f1c8b6655a34e123d406fa", "url": "https://github.com/google/ground-android/commit/0ac3c154ca2665c544f1c8b6655a34e123d406fa", "message": "Improve file name: bottom_sheet -> edit_observation_bottom_sheet", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "1a8954e6f4cf807334f0359752e6f33e1f2399df", "url": "https://github.com/google/ground-android/commit/1a8954e6f4cf807334f0359752e6f33e1f2399df", "message": "Use Completable instead of completeIf", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "7d753db34adfa6486ce40e455acba4b8c5c489da", "url": "https://github.com/google/ground-android/commit/7d753db34adfa6486ce40e455acba4b8c5c489da", "message": "Use Completable instead of completeIf", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "481266c576cbfe402ab0e3a74ccfaa18ed4f8248", "url": "https://github.com/google/ground-android/commit/481266c576cbfe402ab0e3a74ccfaa18ed4f8248", "message": "Rename DialogFragment", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "c822d0ad7657123b363c923b929c9caf77300036", "url": "https://github.com/google/ground-android/commit/c822d0ad7657123b363c923b929c9caf77300036", "message": "Subscribe image results in ViewModel", "committedDate": "2020-01-24T07:39:44Z", "type": "commit"}, {"oid": "50e36d14a3cf46c6ae178507b9b597d0a58491e5", "url": "https://github.com/google/ground-android/commit/50e36d14a3cf46c6ae178507b9b597d0a58491e5", "message": "Code cleanup", "committedDate": "2020-01-24T07:43:24Z", "type": "commit"}, {"oid": "50e36d14a3cf46c6ae178507b9b597d0a58491e5", "url": "https://github.com/google/ground-android/commit/50e36d14a3cf46c6ae178507b9b597d0a58491e5", "message": "Code cleanup", "committedDate": "2020-01-24T07:43:24Z", "type": "forcePushed"}, {"oid": "7d9b3f8ab03a904a8f5b8855e366c43a9be429a1", "url": "https://github.com/google/ground-android/commit/7d9b3f8ab03a904a8f5b8855e366c43a9be429a1", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-24T16:44:23Z", "type": "commit"}, {"oid": "8220ab5a331c5218c4e28d09b8e35f52b615b588", "url": "https://github.com/google/ground-android/commit/8220ab5a331c5218c4e28d09b8e35f52b615b588", "message": "Remove unused code", "committedDate": "2020-01-24T17:05:55Z", "type": "commit"}, {"oid": "4ccaf4728d5f334bb4be63f4107f226544acf2cc", "url": "https://github.com/google/ground-android/commit/4ccaf4728d5f334bb4be63f4107f226544acf2cc", "message": "Bind fieldId along with the photo result\n\nThis would be useful if more than one photo field are present in the layer", "committedDate": "2020-01-25T18:43:07Z", "type": "commit"}, {"oid": "6985d80e1f8be1fa39bd20c253d84af03bd1a580", "url": "https://github.com/google/ground-android/commit/6985d80e1f8be1fa39bd20c253d84af03bd1a580", "message": "Add TODOs", "committedDate": "2020-01-25T18:55:28Z", "type": "commit"}, {"oid": "1a6dd5c208acef59a3c69548742d01102d223b53", "url": "https://github.com/google/ground-android/commit/1a6dd5c208acef59a3c69548742d01102d223b53", "message": "Improve build time", "committedDate": "2020-01-26T06:25:33Z", "type": "commit"}, {"oid": "4b044e3c7ccce420b15981bf8922b49b0362a8ac", "url": "https://github.com/google/ground-android/commit/4b044e3c7ccce420b15981bf8922b49b0362a8ac", "message": "Add callback for attached photo", "committedDate": "2020-01-26T06:28:04Z", "type": "commit"}, {"oid": "24a062ae87c77ccdab3bcd41c4482fcf74dcc58c", "url": "https://github.com/google/ground-android/commit/24a062ae87c77ccdab3bcd41c4482fcf74dcc58c", "message": "Load added pic to the imageview placeholder", "committedDate": "2020-01-26T11:12:46Z", "type": "commit"}, {"oid": "d7a42323b50f8873b8d2b623f39f9c57a9301704", "url": "https://github.com/google/ground-android/commit/d7a42323b50f8873b8d2b623f39f9c57a9301704", "message": "Revert test changes", "committedDate": "2020-01-26T12:48:54Z", "type": "commit"}, {"oid": "e2674036cb11975e917f149199271451c632cd93", "url": "https://github.com/google/ground-android/commit/e2674036cb11975e917f149199271451c632cd93", "message": "Filter activity result if ok", "committedDate": "2020-01-27T05:56:25Z", "type": "commit"}, {"oid": "17e754a46dd2c247e9e64c589f47ac9e1a188a27", "url": "https://github.com/google/ground-android/commit/17e754a46dd2c247e9e64c589f47ac9e1a188a27", "message": "Improve method name", "committedDate": "2020-01-27T06:00:35Z", "type": "commit"}, {"oid": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "url": "https://github.com/google/ground-android/commit/9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-27T18:05:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5NTk2NA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371495964", "bodyText": "Please add Javadoc explaining [non-obvious details] of what this class is used for.", "author": "gino-m", "createdAt": "2020-01-27T21:37:02Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.provider.MediaStore;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class CameraManager {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5NjcyMw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371496723", "bodyText": "Also here.", "author": "gino-m", "createdAt": "2020-01-27T21:38:45Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.provider.MediaStore.Images.Media;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class StorageManager {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5NzIwMg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371497202", "bodyText": "Nit: Use PICK_IMAGE_REQUEST_CODE for consistency.", "author": "gino-m", "createdAt": "2020-01-27T21:39:53Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.provider.MediaStore.Images.Media;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class StorageManager {\n+\n+  public static final String TAG = StorageManager.class.getName();\n+\n+  private static final int PICKFILE_REQUEST_CODE = StorageManager.class.hashCode() & 0xffff;", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5ODgwNQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371498805", "bodyText": "I generally prefer to bail out on edge cases (==null) and fall through to the expected default base case (!=null). That said, this could optionally also be written functionally as:\nactivityResult -> Optional.ofNullable(activityResult.getData())\n   .map(Intent::getExtras)\n   .map(extras -> (Bitmap) extras.get(\"data\"));", "author": "gino-m", "createdAt": "2020-01-27T21:43:15Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.provider.MediaStore;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class CameraManager {\n+\n+  public static final String TAG = CameraManager.class.getName();\n+\n+  private static final int CAPTURE_PHOTO_REQUEST_CODE = CameraManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public CameraManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public Completable launchImageCapture() {\n+    return permissionsManager\n+        .obtainPermission(permission.WRITE_EXTERNAL_STORAGE)\n+        .andThen(permissionsManager.obtainPermission(permission.CAMERA))\n+        .andThen(sendCaptureImageIntent());\n+  }\n+\n+  public Observable<Optional<Bitmap>> captureImageResult() {\n+    return activityStreams\n+        .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n+        .filter(ActivityResult::isOk)\n+        .map(\n+            activityResult -> {\n+              Intent intent = activityResult.getData();\n+              if (intent != null && intent.getExtras() != null) {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5OTcyOA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371499728", "bodyText": "Same here:\nactivityResult ->\n  Optional.ofNullable(activityResult.getData())\n    .map(Intent::getData)\n    .map(data -> Media.getBitmap(context.getContentResolver(), data)", "author": "gino-m", "createdAt": "2020-01-27T21:45:15Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.provider.MediaStore.Images.Media;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+@Singleton\n+public class StorageManager {\n+\n+  public static final String TAG = StorageManager.class.getName();\n+\n+  private static final int PICKFILE_REQUEST_CODE = StorageManager.class.hashCode() & 0xffff;\n+  private final Context context;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public StorageManager(\n+      Context context, PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.context = context;\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  public Completable launchImagePicker() {\n+    return permissionsManager\n+        .obtainPermission(permission.READ_EXTERNAL_STORAGE)\n+        .andThen(sendImagePickerIntent());\n+  }\n+\n+  public Observable<Optional<Bitmap>> imagePickerResult() {\n+    return activityStreams\n+        .getNextActivityResult(PICKFILE_REQUEST_CODE)\n+        .filter(ActivityResult::isOk)\n+        .map(\n+            activityResult -> {\n+              Intent intent = activityResult.getData();", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMTQ5MQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371501491", "bodyText": "Same here.", "author": "gino-m", "createdAt": "2020-01-27T21:48:57Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -169,12 +191,31 @@ public void addMultipleChoiceField(Field field) {\n   public void addPhotoField(Field field) {\n     PhotoInputFieldBinding binding =\n         PhotoInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n-    binding.setViewModel(viewModel);\n     binding.setLifecycleOwner(this);\n     binding.setField(field);\n+    binding.setFragment(this);\n     formLayout.addView(binding.getRoot());\n     assignGeneratedId(binding.getRoot().findViewById(R.id.image_thumbnail_preview));\n     assignGeneratedId(binding.getRoot().findViewById(R.id.btn_select_photo));\n+\n+    viewModel", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMTcyOQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371501729", "bodyText": "Can some of this logic be moved into the ViewModel?", "author": "gino-m", "createdAt": "2020-01-27T21:49:27Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -91,10 +101,22 @@ public void onViewCreated(\n     viewModel.getForm().observe(this, this::rebuildForm);\n     viewModel.getToolbarTitle().observe(this, toolbar::setTitle);\n     viewModel.getSaveResults().observe(this, e -> e.ifUnhandled(this::handleSaveResult));\n+    viewModel.getAddedPhoto().observe(this, this::onPhotoAdded);\n     // Initialize view model.\n     viewModel.initialize(EditObservationFragmentArgs.fromBundle(getArguments()));\n   }\n \n+  private void onPhotoAdded(Map<Field, File> fieldFileMap) {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMzQ4Mw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371623483", "bodyText": "Thanks for pointing this out! This makes the code much simpler", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMTcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjA4MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371502080", "bodyText": "Please add Javadoc re how this is used. Also, name implies this is a single added photo - should it be something newPhotos?", "author": "gino-m", "createdAt": "2020-01-27T21:50:13Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -63,13 +69,18 @@\n   private final ObservationRepository observationRepository;\n   private final AuthenticationManager authManager;\n   private final Resources resources;\n+  private final StorageManager storageManager;\n+  private final CameraManager cameraManager;\n+  private final FileUtil fileUtil;\n \n   // Input events.\n \n   /** Arguments passed in from view on initialize(). */\n   private final BehaviorProcessor<EditObservationFragmentArgs> viewArgs =\n       BehaviorProcessor.create();\n \n+  private final BehaviorProcessor<Map<Field, File>> addedPhoto = BehaviorProcessor.create();", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMzU1Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371623556", "bodyText": "Removed. Entire logic for updating responses moved directly into ViewModel", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjY1MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371502650", "bodyText": "What do you mean by \"Added\" here? Photos that were added during the lifecycle of this ViewModel?", "author": "gino-m", "createdAt": "2020-01-27T21:51:27Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -78,6 +89,9 @@\n   /** Form definition, loaded when view is initialized. */\n   private final LiveData<Form> form;\n \n+  /** Added image field. */\n+  private final LiveData<Map<Field, File>> photo;", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMzU4Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371623586", "bodyText": "Same as above.", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjg5MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371502890", "bodyText": "Do we need both addedPhoto and photo? What's the difference?", "author": "gino-m", "createdAt": "2020-01-27T21:52:00Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -120,12 +134,18 @@\n   EditObservationViewModel(\n       GndApplication application,\n       ObservationRepository observationRepository,\n-      AuthenticationManager authenticationManager) {\n+      AuthenticationManager authenticationManager,\n+      StorageManager storageManager,\n+      CameraManager cameraManager) {\n     this.resources = application.getResources();\n     this.observationRepository = observationRepository;\n     this.authManager = authenticationManager;\n+    this.storageManager = storageManager;\n+    this.cameraManager = cameraManager;\n+    this.fileUtil = new FileUtil(application);\n     this.form = fromPublisher(viewArgs.switchMapSingle(this::onInitialize));\n     this.saveResults = fromPublisher(saveClicks.switchMapSingle(__ -> onSave()));\n+    this.photo = fromPublisher(addedPhoto);", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMzYxNA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371623614", "bodyText": "Removed", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMjg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNDQ3Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371504476", "bodyText": "Please add essential Javadoc about why this is needed and what it's used for.", "author": "gino-m", "createdAt": "2020-01-27T21:55:24Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoDialogFragment.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.content.Context;\n+import android.os.Bundle;\n+import android.util.Log;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.EditObservationBottomSheetBinding;\n+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;\n+\n+public class PhotoDialogFragment extends BottomSheetDialogFragment {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNDY3Nw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371504677", "bodyText": "Nit: Use .class.getSimpleName() name to ensure refactors rename this properly.", "author": "gino-m", "createdAt": "2020-01-27T21:55:50Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoDialogFragment.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.content.Context;\n+import android.os.Bundle;\n+import android.util.Log;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.EditObservationBottomSheetBinding;\n+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;\n+\n+public class PhotoDialogFragment extends BottomSheetDialogFragment {\n+\n+  public static final String TAG = \"ActionBottomDialog\";", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTQ4Mg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371505482", "bodyText": "Nit: Final \".\" (can remove trailing slash)", "author": "gino-m", "createdAt": "2020-01-27T21:57:41Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.util;\n+\n+import android.content.Context;\n+import android.graphics.Bitmap;\n+import android.util.Log;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+\n+public class FileUtil {\n+\n+  private static final String TAG = FileUtil.class.getName();\n+  private final Context context;\n+\n+  public FileUtil(Context context) {\n+    this.context = context;\n+  }\n+\n+  /**\n+   * Creates a new file from bitmap and saves under internal app directory\n+   * /data/data/com.google.android.gnd/files/", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTc3Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371505776", "bodyText": "Since this is a low-level util shall we throw the exception up to the caller here instead of logging? (i.e. declare throws IOException)?", "author": "gino-m", "createdAt": "2020-01-27T21:58:21Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.util;\n+\n+import android.content.Context;\n+import android.graphics.Bitmap;\n+import android.util.Log;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+\n+public class FileUtil {\n+\n+  private static final String TAG = FileUtil.class.getName();\n+  private final Context context;\n+\n+  public FileUtil(Context context) {\n+    this.context = context;\n+  }\n+\n+  /**\n+   * Creates a new file from bitmap and saves under internal app directory\n+   * /data/data/com.google.android.gnd/files/\n+   */\n+  public File saveBitmap(Bitmap bitmap, String filename) {\n+    File file = new File(context.getFilesDir(), filename);\n+    try (FileOutputStream fos = context.openFileOutput(filename, Context.MODE_PRIVATE)) {\n+      bitmap.compress(Bitmap.CompressFormat.JPEG, 100, fos);\n+    } catch (IOException e) {\n+      Log.e(TAG, e.getMessage(), e);", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMDAwMA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371620000", "bodyText": "Agreed", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T05:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNTc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNjYzMw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371506633", "bodyText": "Javadoc here as well, maybe rename \"FIELD_ID_BUNDLE_ARG\" for clarity.", "author": "gino-m", "createdAt": "2020-01-27T22:00:08Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoDialogFragment.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.content.Context;\n+import android.os.Bundle;\n+import android.util.Log;\n+import android.view.LayoutInflater;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.EditObservationBottomSheetBinding;\n+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;\n+\n+public class PhotoDialogFragment extends BottomSheetDialogFragment {\n+\n+  public static final String TAG = \"ActionBottomDialog\";\n+  public static final String FIELD_ID = \"field_id\";", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzA1OA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371507058", "bodyText": "Can this and the other lambdas blocks below be refactored into methods with clear names to make it easier to follow?", "author": "gino-m", "createdAt": "2020-01-27T22:01:03Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -193,6 +212,52 @@ public void onFocusChange(Field field, boolean hasFocus) {\n     }\n   }\n \n+  void initPhotoSelector(String fieldId) {\n+    /*\n+     * Didn't subscribe this with Fragment's lifecycle because we need to retain the disposable\n+     * after the fragment is destroyed (for activity result)\n+     */\n+    disposeOnClear(\n+        storageManager\n+            .launchImagePicker()\n+            .andThen(\n+                storageManager\n+                    .imagePickerResult()", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzgxMw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371507813", "bodyText": "disposeOnClear will remove the subscription as soon as the ViewModel is removed, and we can't assume the ViewModel will stick around after the Fragment is destroyed. Do we need this because the photo picker Intent causes the fragment to go away? If so, can we launch image picker synchronously, and only subscribe to image picker results?", "author": "gino-m", "createdAt": "2020-01-27T22:02:46Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -193,6 +212,52 @@ public void onFocusChange(Field field, boolean hasFocus) {\n     }\n   }\n \n+  void initPhotoSelector(String fieldId) {\n+    /*\n+     * Didn't subscribe this with Fragment's lifecycle because we need to retain the disposable\n+     * after the fragment is destroyed (for activity result)\n+     */\n+    disposeOnClear(", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyNTI4OA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371625288", "bodyText": "Initially, I tried subscribing the RxChain in Fragment using it's lifecycle. But during launch of Intent, the fragment gets destroyed and so does the disposable.\n\ncan we launch image picker synchronously, and only subscribe to image picker results?\n\nIf we separate this logic, then how would we pass the requesting fieldId to update the response later?\nSince one observation can have multiple photo fields, we have to know the requesting fieldId in advance. Thoughts?", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg1MzkzOQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371853939", "bodyText": "Can you use the Bundle stored in the Intent's \"extras\" to pass the field id through to the photo picker and back again?", "author": "gino-m", "createdAt": "2020-01-28T14:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNTMyMg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373735322", "bodyText": "This method can be called multiple times, accumulating subscriptions until the view model is destroyed. If we can't decouple request from the activity response, please add a TODO here to trigger this from a switchMap or to find another way to split the stream in two to avoid accumulating subscriptions.", "author": "gino-m", "createdAt": "2020-02-01T00:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwNzkzNg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371507936", "bodyText": "Can we inject this?", "author": "gino-m", "createdAt": "2020-01-27T22:03:01Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -120,12 +134,18 @@\n   EditObservationViewModel(\n       GndApplication application,\n       ObservationRepository observationRepository,\n-      AuthenticationManager authenticationManager) {\n+      AuthenticationManager authenticationManager,\n+      StorageManager storageManager,\n+      CameraManager cameraManager) {\n     this.resources = application.getResources();\n     this.observationRepository = observationRepository;\n     this.authManager = authenticationManager;\n+    this.storageManager = storageManager;\n+    this.cameraManager = cameraManager;\n+    this.fileUtil = new FileUtil(application);", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwODUzNg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371508536", "bodyText": "Naming nit: fileFieldMap", "author": "gino-m", "createdAt": "2020-01-27T22:04:25Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -91,10 +101,22 @@ public void onViewCreated(\n     viewModel.getForm().observe(this, this::rebuildForm);\n     viewModel.getToolbarTitle().observe(this, toolbar::setTitle);\n     viewModel.getSaveResults().observe(this, e -> e.ifUnhandled(this::handleSaveResult));\n+    viewModel.getAddedPhoto().observe(this, this::onPhotoAdded);\n     // Initialize view model.\n     viewModel.initialize(EditObservationFragmentArgs.fromBundle(getArguments()));\n   }\n \n+  private void onPhotoAdded(Map<Field, File> fieldFileMap) {", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwODg1MQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371508851", "bodyText": "What does this do, and why does it do it for all image fields, not just the changed one?", "author": "gino-m", "createdAt": "2020-01-27T22:05:06Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -91,10 +101,22 @@ public void onViewCreated(\n     viewModel.getForm().observe(this, this::rebuildForm);\n     viewModel.getToolbarTitle().observe(this, toolbar::setTitle);\n     viewModel.getSaveResults().observe(this, e -> e.ifUnhandled(this::handleSaveResult));\n+    viewModel.getAddedPhoto().observe(this, this::onPhotoAdded);\n     // Initialize view model.\n     viewModel.initialize(EditObservationFragmentArgs.fromBundle(getArguments()));\n   }\n \n+  private void onPhotoAdded(Map<Field, File> fieldFileMap) {\n+    Log.d(TAG, fieldFileMap.toString());\n+\n+    // TODO: Upload photo to Firestore Storage\n+    // TODO: Fetch download url and update response in viewModel\n+    for (Field field : fieldFileMap.keySet()) {\n+      File file = fieldFileMap.get(field);\n+      viewModel.onResponseChanged(field, TextResponse.fromString(file.getPath()));", "originalCommit": "9c2f830f04b0025ddaf79e151fab858fcd4ada4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYyMzc3MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371623770", "bodyText": "Cleaned up", "author": "shobhitagarwal1612", "createdAt": "2020-01-28T06:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwODg1MQ=="}], "type": "inlineReview"}, {"oid": "5f91ea024b09898211bb6fb74039330312512b0f", "url": "https://github.com/google/ground-android/commit/5f91ea024b09898211bb6fb74039330312512b0f", "message": "Add Javadoc", "committedDate": "2020-01-28T03:34:04Z", "type": "commit"}, {"oid": "2f4efccf400aa69fb10b42a78dae77cec987072a", "url": "https://github.com/google/ground-android/commit/2f4efccf400aa69fb10b42a78dae77cec987072a", "message": "Rename request code variable name", "committedDate": "2020-01-28T03:36:14Z", "type": "commit"}, {"oid": "ee14a2a8d38fcaae6824aa927067214ee583b7c6", "url": "https://github.com/google/ground-android/commit/ee14a2a8d38fcaae6824aa927067214ee583b7c6", "message": "Cleanup RxChains", "committedDate": "2020-01-28T04:04:10Z", "type": "commit"}, {"oid": "cdcf260b534cd0a159a8ef3b3cff71e56e314de2", "url": "https://github.com/google/ground-android/commit/cdcf260b534cd0a159a8ef3b3cff71e56e314de2", "message": "Fix TAG name", "committedDate": "2020-01-28T04:05:24Z", "type": "commit"}, {"oid": "0fc240f0d0a95a19c9f57f2be2d8159d27e0879d", "url": "https://github.com/google/ground-android/commit/0fc240f0d0a95a19c9f57f2be2d8159d27e0879d", "message": "Refactor lambda blocks", "committedDate": "2020-01-28T05:36:23Z", "type": "commit"}, {"oid": "5af395ed92664da019dc14eeced4651da5872fc4", "url": "https://github.com/google/ground-android/commit/5af395ed92664da019dc14eeced4651da5872fc4", "message": "Convert FileUtil into injectable", "committedDate": "2020-01-28T05:38:10Z", "type": "commit"}, {"oid": "1e41bbd0f26888493f54325352eb6aa650d28e51", "url": "https://github.com/google/ground-android/commit/1e41bbd0f26888493f54325352eb6aa650d28e51", "message": "Rename param", "committedDate": "2020-01-28T05:39:27Z", "type": "commit"}, {"oid": "cd7dc3701039500c3d9096b1da49082d473a590d", "url": "https://github.com/google/ground-android/commit/cd7dc3701039500c3d9096b1da49082d473a590d", "message": "Update var name", "committedDate": "2020-01-28T05:43:18Z", "type": "commit"}, {"oid": "26a83e26eecbbe07da7bb878dc4858f39efe3bef", "url": "https://github.com/google/ground-android/commit/26a83e26eecbbe07da7bb878dc4858f39efe3bef", "message": "Add Javadoc", "committedDate": "2020-01-28T05:47:17Z", "type": "commit"}, {"oid": "d3fb8d131d0de875e3858b6dbe9d878436daafdd", "url": "https://github.com/google/ground-android/commit/d3fb8d131d0de875e3858b6dbe9d878436daafdd", "message": "Add \".\" and remove trailing \"/\"", "committedDate": "2020-01-28T05:48:37Z", "type": "commit"}, {"oid": "5595e6673653c202792018898dabf38ee52dbfbd", "url": "https://github.com/google/ground-android/commit/5595e6673653c202792018898dabf38ee52dbfbd", "message": "Don't catch IOException in FileUtil and let the implementation handle it", "committedDate": "2020-01-28T05:51:41Z", "type": "commit"}, {"oid": "5a79141a1bd570b6fd804776e8b8cb191ffb343a", "url": "https://github.com/google/ground-android/commit/5a79141a1bd570b6fd804776e8b8cb191ffb343a", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-28T05:52:34Z", "type": "commit"}, {"oid": "3b807e239b255bc6c996109a87cfea56bdcd4944", "url": "https://github.com/google/ground-android/commit/3b807e239b255bc6c996109a87cfea56bdcd4944", "message": "Move update response logic to ViewModel", "committedDate": "2020-01-28T06:08:46Z", "type": "commit"}, {"oid": "8db29aaea7619a5ddb529a78fd8213569f95eebc", "url": "https://github.com/google/ground-android/commit/8db29aaea7619a5ddb529a78fd8213569f95eebc", "message": "Update comment", "committedDate": "2020-01-28T06:20:12Z", "type": "commit"}, {"oid": "f25bbc8f6177d0f198952459c406941ffd892d45", "url": "https://github.com/google/ground-android/commit/f25bbc8f6177d0f198952459c406941ffd892d45", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-28T06:38:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNTM5Mg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371835392", "bodyText": "If we don't need to return Optional, then this can be further simplified to remove the need to wrap and unwrap in Optional, e.g.:\nSorry!", "author": "gino-m", "createdAt": "2020-01-28T14:30:14Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -50,19 +51,17 @@ public Completable launchImageCapture() {\n         .andThen(sendCaptureImageIntent());\n   }\n \n-  public Observable<Optional<Bitmap>> captureImageResult() {\n+  public Observable<Bitmap> captureImageResult() {\n     return activityStreams\n         .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n         .filter(ActivityResult::isOk)\n         .map(\n-            activityResult -> {\n-              Intent intent = activityResult.getData();\n-              if (intent != null && intent.getExtras() != null) {\n-                Bitmap photo = (Bitmap) intent.getExtras().get(\"data\");\n-                return Optional.ofNullable(photo);\n-              }\n-              return Optional.empty();\n-            });\n+            activityResult ->\n+                Optional.ofNullable(activityResult.getData())\n+                    .map(Intent::getExtras)\n+                    .map(extras -> (Bitmap) extras.get(\"data\")))\n+        .filter(Optional::isPresent)", "originalCommit": "f25bbc8f6177d0f198952459c406941ffd892d45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNzA3OA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371837078", "bodyText": ".getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n  .flatMap(this::onCaptureImageResult)\n\nThen:\nprivate static Observable<Bitmap> onCaptureImageResult(ActivityResult result) {\n  return Observable.create(em -> {\n    if (!result.isOk()) {\n      return;\n    }\n    Intent data = activityResult.getData();\n    if (data == null) {\n      return;\n    }\n    // and so on..\n    em.onNext((Bitmap) extras.get(\"data\"));\n  });\n}", "author": "gino-m", "createdAt": "2020-01-28T14:32:55Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -50,19 +51,17 @@ public Completable launchImageCapture() {\n         .andThen(sendCaptureImageIntent());\n   }\n \n-  public Observable<Optional<Bitmap>> captureImageResult() {\n+  public Observable<Bitmap> captureImageResult() {\n     return activityStreams\n         .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n         .filter(ActivityResult::isOk)\n         .map(\n-            activityResult -> {\n-              Intent intent = activityResult.getData();\n-              if (intent != null && intent.getExtras() != null) {\n-                Bitmap photo = (Bitmap) intent.getExtras().get(\"data\");\n-                return Optional.ofNullable(photo);\n-              }\n-              return Optional.empty();\n-            });\n+            activityResult ->\n+                Optional.ofNullable(activityResult.getData())\n+                    .map(Intent::getExtras)\n+                    .map(extras -> (Bitmap) extras.get(\"data\")))\n+        .filter(Optional::isPresent)\n+        .map(Optional::get);", "originalCommit": "f25bbc8f6177d0f198952459c406941ffd892d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3MjY2Nw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r372372667", "bodyText": "This would convert our RxChains into flat code. What's the benefit of that?", "author": "shobhitagarwal1612", "createdAt": "2020-01-29T13:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNzA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ3MDE1Mg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r372470152", "bodyText": "In this case, do you mean it would replace the functional reactive programming (FRP) paradigm with an imperative one?\nFunctional reactive constructs are very useful for representing flows of data while managing/limiting side effects in an expressive, consistent way. But since Java is primarily imperative, we'll always be jumping back and forth between functional and imperative paradigms anyway. Where we choose to do that is up to us, and imo, one clear place where it makes sense to switch to the imperative paradigm is synchronous code that would be much less readable if declared using the FRP model. At least this is what I've observed working with RxJava over the past two years or so.\n@scolsen, who has done more research on this than I have, what are your thoughts?", "author": "gino-m", "createdAt": "2020-01-29T15:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNzA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ4MjMzNw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373482337", "bodyText": "I agree with your points. Fixed", "author": "shobhitagarwal1612", "createdAt": "2020-01-31T13:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNzA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgzNzUyMw==", "url": "https://github.com/google/ground-android/pull/328#discussion_r371837523", "bodyText": "Please use IMAGE (vs PHOTO) throughout for consistency.", "author": "gino-m", "createdAt": "2020-01-28T14:33:33Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -50,19 +51,17 @@ public Completable launchImageCapture() {\n         .andThen(sendCaptureImageIntent());\n   }\n \n-  public Observable<Optional<Bitmap>> captureImageResult() {\n+  public Observable<Bitmap> captureImageResult() {\n     return activityStreams\n         .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)", "originalCommit": "f25bbc8f6177d0f198952459c406941ffd892d45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e5a772082e605021cd13b32adb584132102f961f", "url": "https://github.com/google/ground-android/commit/e5a772082e605021cd13b32adb584132102f961f", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-28T18:54:25Z", "type": "commit"}, {"oid": "7ab7b05787d6ec1a3e80215303b4e18fac862167", "url": "https://github.com/google/ground-android/commit/7ab7b05787d6ec1a3e80215303b4e18fac862167", "message": "Add license header", "committedDate": "2020-01-29T12:29:38Z", "type": "commit"}, {"oid": "c82c800edad07ed1fa4d6b053b030f816de10755", "url": "https://github.com/google/ground-android/commit/c82c800edad07ed1fa4d6b053b030f816de10755", "message": "Replace usages of image with photo", "committedDate": "2020-01-29T12:42:10Z", "type": "commit"}, {"oid": "548ca6ead1657c6ee364bc63f026e8b273fd125e", "url": "https://github.com/google/ground-android/commit/548ca6ead1657c6ee364bc63f026e8b273fd125e", "message": "Simplify RxChain", "committedDate": "2020-01-29T12:50:37Z", "type": "commit"}, {"oid": "631fee204e9dd90f55743036457943c8d3f65e42", "url": "https://github.com/google/ground-android/commit/631fee204e9dd90f55743036457943c8d3f65e42", "message": "Merge branch 'master' into photos-support", "committedDate": "2020-01-29T22:13:58Z", "type": "commit"}, {"oid": "34025919bcf8f285f43a3f705b663d9de0451fc6", "url": "https://github.com/google/ground-android/commit/34025919bcf8f285f43a3f705b663d9de0451fc6", "message": "Refactor CameraManager and StorageManager", "committedDate": "2020-01-31T13:34:34Z", "type": "commit"}, {"oid": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "url": "https://github.com/google/ground-android/commit/e101c77b4f656e358f168e3985657e0ccd22d9e8", "message": "Refactor#2", "committedDate": "2020-01-31T18:15:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMjYyNg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373732626", "bodyText": "It may make sense to return a Maybe here and in the helper given the semantics of these calls. Could you please add a TODO to investigate?", "author": "gino-m", "createdAt": "2020-01-31T23:46:42Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.os.Bundle;\n+import android.provider.MediaStore;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+/** Manages permissions needed for using camera and related flows to/from Activity. */\n+@Singleton\n+public class CameraManager {\n+\n+  public static final String TAG = CameraManager.class.getName();\n+\n+  private static final int CAPTURE_PHOTO_REQUEST_CODE = CameraManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public CameraManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  /**\n+   * Requests for capturing a photo from camera, if necessary permissions are granted. Otherwise,\n+   * requests for the permissions and then sends out the request.\n+   */\n+  public Completable launchPhotoCapture() {\n+    return permissionsManager\n+        .obtainPermission(permission.WRITE_EXTERNAL_STORAGE)\n+        .andThen(permissionsManager.obtainPermission(permission.CAMERA))\n+        .andThen(sendCapturePhotoIntent());\n+  }\n+\n+  /** Enqueue an intent for capturing a photo from camera. */\n+  private Completable sendCapturePhotoIntent() {\n+    return Completable.fromAction(\n+        () ->\n+            activityStreams.withActivity(\n+                activity -> {\n+                  Intent cameraIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);\n+                  activity.startActivityForResult(cameraIntent, CAPTURE_PHOTO_REQUEST_CODE);\n+                  Log.d(TAG, \"capture photo intent sent\");\n+                }));\n+  }\n+\n+  /** Observe for the result of request code {@link CameraManager#CAPTURE_PHOTO_REQUEST_CODE}. */\n+  public Observable<Bitmap> capturePhotoResult() {", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDQxNA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373790414", "bodyText": "Done", "author": "shobhitagarwal1612", "createdAt": "2020-02-01T17:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMjYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMjg2Ng==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373732866", "bodyText": "In that case this could be simplified to not be lazy, but rather to return a Maybe.empty() or Maybe.just().", "author": "gino-m", "createdAt": "2020-01-31T23:48:09Z", "path": "gnd/src/main/java/com/google/android/gnd/system/CameraManager.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.Manifest.permission;\n+import android.content.Intent;\n+import android.graphics.Bitmap;\n+import android.os.Bundle;\n+import android.provider.MediaStore;\n+import android.util.Log;\n+import com.google.android.gnd.system.ActivityStreams.ActivityResult;\n+import io.reactivex.Completable;\n+import io.reactivex.Observable;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+/** Manages permissions needed for using camera and related flows to/from Activity. */\n+@Singleton\n+public class CameraManager {\n+\n+  public static final String TAG = CameraManager.class.getName();\n+\n+  private static final int CAPTURE_PHOTO_REQUEST_CODE = CameraManager.class.hashCode() & 0xffff;\n+  private final PermissionsManager permissionsManager;\n+  private final ActivityStreams activityStreams;\n+\n+  @Inject\n+  public CameraManager(PermissionsManager permissionsManager, ActivityStreams activityStreams) {\n+    this.permissionsManager = permissionsManager;\n+    this.activityStreams = activityStreams;\n+  }\n+\n+  /**\n+   * Requests for capturing a photo from camera, if necessary permissions are granted. Otherwise,\n+   * requests for the permissions and then sends out the request.\n+   */\n+  public Completable launchPhotoCapture() {\n+    return permissionsManager\n+        .obtainPermission(permission.WRITE_EXTERNAL_STORAGE)\n+        .andThen(permissionsManager.obtainPermission(permission.CAMERA))\n+        .andThen(sendCapturePhotoIntent());\n+  }\n+\n+  /** Enqueue an intent for capturing a photo from camera. */\n+  private Completable sendCapturePhotoIntent() {\n+    return Completable.fromAction(\n+        () ->\n+            activityStreams.withActivity(\n+                activity -> {\n+                  Intent cameraIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);\n+                  activity.startActivityForResult(cameraIntent, CAPTURE_PHOTO_REQUEST_CODE);\n+                  Log.d(TAG, \"capture photo intent sent\");\n+                }));\n+  }\n+\n+  /** Observe for the result of request code {@link CameraManager#CAPTURE_PHOTO_REQUEST_CODE}. */\n+  public Observable<Bitmap> capturePhotoResult() {\n+    return activityStreams\n+        .getNextActivityResult(CAPTURE_PHOTO_REQUEST_CODE)\n+        .flatMap(this::onCapturePhotoResult);\n+  }\n+\n+  /** Fetch bitmap from the result, if present. */\n+  private Observable<Bitmap> onCapturePhotoResult(ActivityResult result) {\n+    return Observable.create(", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MDQyMQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373790421", "bodyText": "Added a TODO for the same", "author": "shobhitagarwal1612", "createdAt": "2020-02-01T17:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMjg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzUwNQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373733505", "bodyText": "Can this be represented by a lambda, with the function extracted into its own method?", "author": "gino-m", "createdAt": "2020-01-31T23:51:28Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -169,12 +177,31 @@ public void addMultipleChoiceField(Field field) {\n   public void addPhotoField(Field field) {\n     PhotoInputFieldBinding binding =\n         PhotoInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n-    binding.setViewModel(viewModel);\n     binding.setLifecycleOwner(this);\n     binding.setField(field);\n+    binding.setFragment(this);\n     formLayout.addView(binding.getRoot());\n     assignGeneratedId(binding.getRoot().findViewById(R.id.image_thumbnail_preview));\n     assignGeneratedId(binding.getRoot().findViewById(R.id.btn_select_photo));\n+\n+    viewModel\n+        .getResponses()\n+        .addOnMapChangedCallback(\n+            new OnMapChangedCallback<ObservableMap<String, Response>, String, Response>() {", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5MjgyMA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373792820", "bodyText": "Sadly no. I was looking into converting the Observable into a PublishProcessor for the Fragment to subscribe. But that needs some more refactoring which I'm planning to do later as it touches other codebase as well", "author": "shobhitagarwal1612", "createdAt": "2020-02-01T17:55:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzUwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk0OTgwNQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373949805", "bodyText": "Ok, thanks for checking.", "author": "gino-m", "createdAt": "2020-02-03T07:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzc0OQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373733749", "bodyText": "Also, please use \"return\" to bail out if conditions aren't met to avoid excessive nesting.", "author": "gino-m", "createdAt": "2020-01-31T23:52:36Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -169,12 +177,31 @@ public void addMultipleChoiceField(Field field) {\n   public void addPhotoField(Field field) {\n     PhotoInputFieldBinding binding =\n         PhotoInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n-    binding.setViewModel(viewModel);\n     binding.setLifecycleOwner(this);\n     binding.setField(field);\n+    binding.setFragment(this);\n     formLayout.addView(binding.getRoot());\n     assignGeneratedId(binding.getRoot().findViewById(R.id.image_thumbnail_preview));\n     assignGeneratedId(binding.getRoot().findViewById(R.id.btn_select_photo));\n+\n+    viewModel\n+        .getResponses()\n+        .addOnMapChangedCallback(\n+            new OnMapChangedCallback<ObservableMap<String, Response>, String, Response>() {\n+              @Override\n+              public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n+                if (key != null && key.equals(field.getId())) {", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzkzNg==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373733936", "bodyText": "Also, this seems to be IO logic and not UI logic - can we move it out of the Fragment into a util class so it can be tested independently?", "author": "gino-m", "createdAt": "2020-01-31T23:53:34Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -169,12 +177,31 @@ public void addMultipleChoiceField(Field field) {\n   public void addPhotoField(Field field) {\n     PhotoInputFieldBinding binding =\n         PhotoInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n-    binding.setViewModel(viewModel);\n     binding.setLifecycleOwner(this);\n     binding.setField(field);\n+    binding.setFragment(this);\n     formLayout.addView(binding.getRoot());\n     assignGeneratedId(binding.getRoot().findViewById(R.id.image_thumbnail_preview));\n     assignGeneratedId(binding.getRoot().findViewById(R.id.btn_select_photo));\n+\n+    viewModel\n+        .getResponses()\n+        .addOnMapChangedCallback(\n+            new OnMapChangedCallback<ObservableMap<String, Response>, String, Response>() {\n+              @Override\n+              public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n+                if (key != null && key.equals(field.getId())) {\n+                  String imageFilePath = sender.get(key).getDetailsText(field);\n+                  File imageFile = new File(imageFilePath);", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNTM5MA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373735390", "bodyText": "Same here re TODO.", "author": "gino-m", "createdAt": "2020-02-01T00:01:35Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -193,6 +204,44 @@ public void onFocusChange(Field field, boolean hasFocus) {\n     }\n   }\n \n+  void initPhotoSelector(String fieldId) {\n+    /*\n+     * Didn't subscribe this with Fragment's lifecycle because we need to retain the disposable\n+     * after the fragment is destroyed (for activity result)\n+     */\n+    disposeOnClear(\n+        storageManager.launchPhotoPicker().andThen(handlePhotoPickerResult(fieldId)).subscribe());\n+  }\n+\n+  private Completable handlePhotoPickerResult(String fieldId) {\n+    return storageManager\n+        .photoPickerResult()\n+        .compose(bitmap -> saveBitmapAndUpdateResponse(bitmap, fieldId))\n+        .ignoreElements();\n+  }\n+\n+  void initPhotoCapture(String fieldId) {\n+    /*\n+     * Didn't subscribe this with Fragment's lifecycle because we need to retain the disposable\n+     * after the fragment is destroyed (for activity result)\n+     */\n+    disposeOnClear(", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNTQwMQ==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373735401", "bodyText": "Same here re name.", "author": "gino-m", "createdAt": "2020-02-01T00:01:41Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -193,6 +204,44 @@ public void onFocusChange(Field field, boolean hasFocus) {\n     }\n   }\n \n+  void initPhotoSelector(String fieldId) {\n+    /*\n+     * Didn't subscribe this with Fragment's lifecycle because we need to retain the disposable\n+     * after the fragment is destroyed (for activity result)\n+     */\n+    disposeOnClear(\n+        storageManager.launchPhotoPicker().andThen(handlePhotoPickerResult(fieldId)).subscribe());\n+  }\n+\n+  private Completable handlePhotoPickerResult(String fieldId) {\n+    return storageManager\n+        .photoPickerResult()\n+        .compose(bitmap -> saveBitmapAndUpdateResponse(bitmap, fieldId))\n+        .ignoreElements();\n+  }\n+\n+  void initPhotoCapture(String fieldId) {", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNTY1NA==", "url": "https://github.com/google/ground-android/pull/328#discussion_r373735654", "bodyText": "\"init\" may imply it sets up the photo selector, but doesn't actually show it. One clearer name could be \"showPhotoSelector()\"", "author": "gino-m", "createdAt": "2020-02-01T00:02:43Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -193,6 +204,44 @@ public void onFocusChange(Field field, boolean hasFocus) {\n     }\n   }\n \n+  void initPhotoSelector(String fieldId) {", "originalCommit": "e101c77b4f656e358f168e3985657e0ccd22d9e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a58aa53deda1d2463c93a3b3661a3b63de96daf4", "url": "https://github.com/google/ground-android/commit/a58aa53deda1d2463c93a3b3661a3b63de96daf4", "message": "Added TODOs for future investigation", "committedDate": "2020-02-01T10:54:00Z", "type": "commit"}, {"oid": "96853de7d3baa9b84854ab196483cebaac8ee181", "url": "https://github.com/google/ground-android/commit/96853de7d3baa9b84854ab196483cebaac8ee181", "message": "Refactor#3: Move static methods to FileUtil", "committedDate": "2020-02-01T17:41:13Z", "type": "commit"}, {"oid": "539672603e548a16b22b902a807d1cbb03b40f9a", "url": "https://github.com/google/ground-android/commit/539672603e548a16b22b902a807d1cbb03b40f9a", "message": "Add more TODOs", "committedDate": "2020-02-01T17:49:07Z", "type": "commit"}, {"oid": "40feeaf37702b8a4756c5acf3f4f94b97ec604bc", "url": "https://github.com/google/ground-android/commit/40feeaf37702b8a4756c5acf3f4f94b97ec604bc", "message": "Update method name", "committedDate": "2020-02-01T17:50:13Z", "type": "commit"}]}