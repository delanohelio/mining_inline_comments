{"pr_number": 342, "pr_title": "Add a utility class for parsing GeoJson", "pr_createdAt": "2020-01-31T21:57:03Z", "pr_url": "https://github.com/google/ground-android/pull/342", "timeline": [{"oid": "2c9183df3946c09b0d862916761ab070e846d17f", "url": "https://github.com/google/ground-android/commit/2c9183df3946c09b0d862916761ab070e846d17f", "message": "Update Tile model\n\nI've added four fields to the tile model:\n\n- URL: A valid url that store the tile's corresponding imagery.\n- X: X coordinate of the tile.\n- Y: Y coordinate of the tile.\n- Z: Z coordinate of the tile.\n\nThis change also includes necessary changes to the TileEntity and File\ndownload worker that result from the model changes listed above. I've\nalso updated some doc comments to make them more consistent with other\ncomments throughout the codebase.", "committedDate": "2020-01-31T21:47:55Z", "type": "commit"}, {"oid": "39f6db240d8d0da01240e864d3a994df8bbba9a0", "url": "https://github.com/google/ground-android/commit/39f6db240d8d0da01240e864d3a994df8bbba9a0", "message": "Add a GeoJsonParser utility class\n\nThis class handles translating GeoJson to and from the model entities\nwe're interested in--at the moment, just tiles. It also implements a\nmethod to get all the tiles specified in a GeoJson that intersect with a\nparticular bounds (we'll use this to download tiles based on offline\nimagery selections).", "committedDate": "2020-01-31T21:51:06Z", "type": "commit"}, {"oid": "d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "url": "https://github.com/google/ground-android/commit/d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "message": "Merge branch 'master' of https://github.com/google/ground-android into json-parser", "committedDate": "2020-01-31T21:52:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwNDU2Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r373704566", "bodyText": "This is wrong -.- Have to fix this.", "author": "scolsen", "createdAt": "2020-01-31T22:00:08Z", "path": "gnd/src/main/java/com/google/android/gnd/util/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.util;\n+\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  static class Cartesian {\n+    private final int xcoordinate;\n+    private final int ycoordinate;\n+    private final int zcoordinate;\n+\n+    Cartesian(int x, int y, int z) {\n+      this.xcoordinate = x;\n+      this.ycoordinate = y;\n+      this.zcoordinate = z;\n+    }\n+\n+    private static Cartesian fromString(String catersianCoords) {\n+      String[] values = catersianCoords.replaceAll(\"[()]\", \"\").split(\",\");\n+      int[] coords = new int[3];\n+\n+      for (int i = 0; i < coords.length && i < values.length; i++) {\n+        coords[i] = Integer.parseInt(values[i]);\n+      }\n+\n+      return new Cartesian(coords[0], coords[1], coords[2]);\n+    }\n+  }\n+\n+  /**\n+   * A GeoJSONTile is any polygon that describes a single exterior ring comprised of four ordered\n+   * coordinates: South/West, South/East, North/West, North/East, has a cartesian representation,\n+   * and has an associated URL.\n+   */\n+  private static class GeoJsonTile {\n+\n+    private final LatLng[] coordinates;\n+    private final Cartesian cartesian;\n+    private final String url;\n+\n+    private GeoJsonTile(LatLng[] coordinates, Cartesian cartesian, String url) {\n+      this.coordinates = coordinates.clone();\n+      this.cartesian = cartesian;\n+      this.url = url;\n+    }\n+\n+    /**\n+     * Constructs a GeoJSONTile based on the contents of {@param jsonObject}.\n+     *\n+     * <p>A valid tile has the following information:\n+     *\n+     * <p>- a geometry describing a polygon. - an id specifying cartesian coordinates. - a URL\n+     * specifying a source for the tile imagery.\n+     *\n+     * <p>GeoJSON Polygons are described using coordinate arrays that form a linear ring. The first\n+     * and last value in a linear ring are equivalent. We assume coordinates are ordered, S/W, S/E,\n+     * N/E, N/W, (S/W again, closing the ring).\n+     *\n+     * <p>Interior rings, which describe holes in the polygon, are ignored.\n+     */\n+    private static Optional<GeoJsonTile> fromJsonObject(JSONObject jsonObject) {\n+      try {\n+        JSONObject geometry = jsonObject.getJSONObject(\"geometry\");\n+        JSONArray sw = geometry.getJSONArray(\"coordinates\").getJSONArray(0);\n+        JSONArray ne = geometry.getJSONArray(\"coordinates\").getJSONArray(2);\n+        String id = jsonObject.getString(\"id\");\n+        String url = jsonObject.getJSONObject(\"properties\").getString(\"title\");\n+\n+        double south = sw.getDouble(0);\n+        double west = sw.getDouble(1);\n+        double north = ne.getDouble(0);\n+        double east = ne.getDouble(1);\n+\n+        LatLng[] coords = {\n+          new LatLng(south, west),\n+          new LatLng(south, east),\n+          new LatLng(north, west),\n+          new LatLng(north, east)\n+        };\n+\n+        Cartesian cartesian = Cartesian.fromString(id);\n+\n+        return Optional.of(new GeoJsonTile(coords, cartesian, url));\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"failed to parse geoJSONPolygon\", e);\n+      }\n+      return Optional.empty();\n+    }\n+\n+    /**\n+     * Returns true iff any of {@link GeoJsonTile#coordinates} are contained within {@param bounds}.\n+     *\n+     * <p>This method assumes {@param bounds} is larger than the bounds described by {@link\n+     * GeoJsonTile#coordinates} and does not account for cases in which the inverse is true.\n+     */\n+    private boolean intersects(LatLngBounds bounds) {\n+      return stream(this.coordinates).anyMatch(bounds::contains);\n+    }\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<Tile> intersectingTiles(LatLngBounds bounds, File geojson) {\n+    try {\n+      InputStream is = new FileInputStream(geojson);\n+      BufferedReader buf = new BufferedReader(new InputStreamReader(is));\n+      String line = buf.readLine();\n+      StringBuilder sb = new StringBuilder();\n+      while (line != null) {\n+        sb.append(line).append('\\n');\n+        line = buf.readLine();\n+      }\n+\n+      JSONObject geoJson = new JSONObject(sb.toString());\n+      JSONArray features = geoJson.getJSONArray(\"features\");\n+\n+      stream(toArray(features))\n+          .filter(GeoJsonParser::hasGeometry)\n+          .filter(GeoJsonParser::isPolygon)", "originalCommit": "d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwNDk2OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r373704968", "bodyText": "isPolygon expects a geometry object, but here we return the entire feature object (and we need to maintain it down stream).\nI should move these checks into the GeoJsonTile.fromJson method anyway.", "author": "scolsen", "createdAt": "2020-01-31T22:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcwNDU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTQxNg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r373751416", "bodyText": "Would getFilenameFromCoords() be more appropriate?", "author": "gino-m", "createdAt": "2020-02-01T02:24:54Z", "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/Tile.java", "diffHunk": "@@ -37,14 +46,16 @@ public static Builder newBuilder() {\n     return new AutoValue_Tile.Builder();\n   }\n \n-  public static String pathFromId(String tileId) {\n+  public static String pathFromCoords(int x, int y, int z) {", "originalCommit": "d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MDQwOA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374360408", "bodyText": "I like filenameFromCoords --but I'm dropping get because this method is static (though maybe it shouldn't be static)!", "author": "scolsen", "createdAt": "2020-02-03T21:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY0NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r373751644", "bodyText": "Nit: maybe -> Maybe", "author": "gino-m", "createdAt": "2020-02-01T02:28:46Z", "path": "gnd/src/main/java/com/google/android/gnd/workers/FileDownloadWorker.java", "diffHunk": "@@ -183,24 +150,21 @@ private Result checkDownload(Tile tile) {\n   @NonNull\n   @Override\n   public Result doWork() {\n-    Log.d(TAG, \"Downloading tile: \" + Tile.pathFromId(tileId));\n     Tile tile = localDataStore.getTile(tileId).blockingGet();\n \n     // When there is no tile in the db, the maybe completes and returns null.", "originalCommit": "d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY2Nw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r373751667", "bodyText": "What if the tile has been deleted since this job was queued? Maybe we shouldn't fail but just exit?", "author": "gino-m", "createdAt": "2020-02-01T02:29:17Z", "path": "gnd/src/main/java/com/google/android/gnd/workers/FileDownloadWorker.java", "diffHunk": "@@ -183,24 +150,21 @@ private Result checkDownload(Tile tile) {\n   @NonNull\n   @Override\n   public Result doWork() {\n-    Log.d(TAG, \"Downloading tile: \" + Tile.pathFromId(tileId));\n     Tile tile = localDataStore.getTile(tileId).blockingGet();\n \n     // When there is no tile in the db, the maybe completes and returns null.\n+    // We expect tiles to be added to the DB prior to downloading.\n+    // If that isn't the case, we fail.\n     if (tile == null) {", "originalCommit": "d67638cb22a31fb02f0a1b01f572e8b6e3f8a14c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MzY5NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374363694", "bodyText": "Hmm, it seems like the right solution here is to use the workManager to cancel the jobs as soon as the tile is deleted: https://developer.android.com/topic/libraries/architecture/workmanager/how-to/cancel-stop-work. Probably some listener on the DB that fires off cancelAllWork when a user deletes an area and all its corresponding tiles are up for deletion. i.e. whatever method we implement that deletes tiles first checks in w/ the manager to see if any work is queued and stops all the relevant work first. -- we'll probably have to tag jobs by area id to ensure we stop work for just that area (and not e.g. other areas that were queued up immediately after)\nI think this would appropriately handle that case, while this check explicitly uncovers whether or not we queued this without adding something to the DB first.", "author": "scolsen", "createdAt": "2020-02-03T21:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ5MDI3OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374490278", "bodyText": "I don't feel smart enough to consider all the interactions between the workers and managers, so as a defensive maneuver would normally try to make everything idempotent that can be. Besides the user deleting the tile, it could also get remove if the user clears the app cache; I'm not sure if workers get cancelled as well when that happens. Even if they do, it would be nice not to need to know whether that's the case. Perhaps we can just bail out and log a debug log message instead?", "author": "gino-m", "createdAt": "2020-02-04T06:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc1NTY0Mw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374755643", "bodyText": "That sounds fair to me--so, I suppose we need to move this nullness check into the manager and avoid scheduling any work in the first place if we can't find the tile in the DB.", "author": "scolsen", "createdAt": "2020-02-04T15:51:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzMTc0NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374831744", "bodyText": "We will need the nullness check here regardless, since this logic is executed in a different scheduler than the thread that queues the tile. Currently the manager will only queue work after adding the tiles anyway iirc?", "author": "gino-m", "createdAt": "2020-02-04T18:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1MTY2Nw=="}], "type": "inlineReview"}, {"oid": "273235d1314cd8ecb63b6156b44fd31e95590264", "url": "https://github.com/google/ground-android/commit/273235d1314cd8ecb63b6156b44fd31e95590264", "message": "Merge branch 'master' into json-parser", "committedDate": "2020-02-03T07:26:04Z", "type": "commit"}, {"oid": "9760fa4d1077a5c1f61b515de084feb4ea9cf8c1", "url": "https://github.com/google/ground-android/commit/9760fa4d1077a5c1f61b515de084feb4ea9cf8c1", "message": "Refactor JSON geometry methods, return the immutable list of tiles\n\nThis change moves two checks for appropriate geojson features into the\nGeoJsonTile class, and refactors the tile constructor into several\nsupporting methods.\n\nAny fields that are requried to specify a tile throw exceptions on their\nabsence--this way we can debug and diagnose issues in the JSON itself,\nas well as potentially inform users of issues in their own JSON later.\n\nWe also now actually return the list of constructed tiles form the\nparser.", "committedDate": "2020-02-03T21:42:45Z", "type": "commit"}, {"oid": "e189b2de86dadd723b04a3823cea8fbcb1c20923", "url": "https://github.com/google/ground-android/commit/e189b2de86dadd723b04a3823cea8fbcb1c20923", "message": "Merge branch 'json-parser' of https://github.com/scolsen/ground-android into json-parser", "committedDate": "2020-02-03T21:45:37Z", "type": "commit"}, {"oid": "8edc54f2c4a2103c8df6f9916151cf66aee3c5e8", "url": "https://github.com/google/ground-android/commit/8edc54f2c4a2103c8df6f9916151cf66aee3c5e8", "message": "Fix typo, maybe -> Maybe", "committedDate": "2020-02-03T21:50:10Z", "type": "commit"}, {"oid": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "url": "https://github.com/google/ground-android/commit/2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "message": "Rename pathFromCoords -> filenameFromCoords in Tile", "committedDate": "2020-02-03T21:51:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NjQwMw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374486403", "bodyText": "Java auto converts int when using + with Strings, e.g:\nString filename = z + \"-\" + x + \"-\" y;", "author": "gino-m", "createdAt": "2020-02-04T05:56:18Z", "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/Tile.java", "diffHunk": "@@ -37,14 +46,16 @@ public static Builder newBuilder() {\n     return new AutoValue_Tile.Builder();\n   }\n \n-  public static String pathFromId(String tileId) {\n+  public static String filenameFromCoords(int x, int y, int z) {\n     // Tile ids are stored as x-y-z. Paths must be z-x-y.mbtiles.\n     // TODO: Convert tile ids to paths in a less restrictive and less hacky manner.\n     // TODO: Move this method to a more appropriate home? We need to perform (and possibly will no\n     // matter where the tiles are stored) translation between the tile ID and the file path of the\n     // corresponding tile source in remote storage/wherever we pull the source tile from.\n-    String[] fields = tileId.replaceAll(\"[()]\", \"\").split(\", \");\n-    String filename = fields[2] + \"-\" + fields[0] + \"-\" + fields[1];\n+    String xstr = String.valueOf(x);\n+    String ystr = String.valueOf(y);\n+    String zstr = String.valueOf(z);\n+    String filename = zstr + \"-\" + xstr + \"-\" + ystr;", "originalCommit": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc1MzQ5Mw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374753493", "bodyText": "Gotcha, thanks!", "author": "scolsen", "createdAt": "2020-02-04T15:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NjU5Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374486596", "bodyText": "=> getTileUrl(..)?", "author": "gino-m", "createdAt": "2020-02-04T05:57:16Z", "path": "gnd/src/main/java/com/google/android/gnd/util/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.util;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  static class Cartesian {\n+    private final int xcoordinate;\n+    private final int ycoordinate;\n+    private final int zcoordinate;\n+\n+    Cartesian(int x, int y, int z) {\n+      this.xcoordinate = x;\n+      this.ycoordinate = y;\n+      this.zcoordinate = z;\n+    }\n+\n+    private static Cartesian fromString(String catersianCoords) {\n+      String[] values = catersianCoords.replaceAll(\"[()]\", \"\").split(\",\");\n+      int[] coords = new int[3];\n+\n+      for (int i = 0; i < coords.length && i < values.length; i++) {\n+        coords[i] = Integer.parseInt(values[i]);\n+      }\n+\n+      return new Cartesian(coords[0], coords[1], coords[2]);\n+    }\n+  }\n+\n+  /**\n+   * A GeoJSONTile is any polygon that describes a single exterior ring comprised of four ordered\n+   * coordinates: South/West, South/East, North/West, North/East, has a cartesian representation,\n+   * and has an associated URL.\n+   */\n+  private static class GeoJsonTile {\n+\n+    private final LatLng[] coordinates;\n+    private final Cartesian cartesian;\n+    private final String url;\n+\n+    private GeoJsonTile(LatLng[] coordinates, Cartesian cartesian, String url) {\n+      this.coordinates = coordinates.clone();\n+      this.cartesian = cartesian;\n+      this.url = url;\n+    }\n+\n+    /**\n+     * Constructs a GeoJSONTile based on the contents of {@param jsonObject}.\n+     *\n+     * <p>A valid tile has the following information:\n+     *\n+     * <p>- a geometry describing a polygon. - an id specifying cartesian coordinates. - a URL\n+     * specifying a source for the tile imagery.\n+     *\n+     * <p>GeoJSON Polygons are described using coordinate arrays that form a linear ring. The first\n+     * and last value in a linear ring are equivalent. We assume coordinates are ordered, S/W, S/E,\n+     * N/E, N/W, (S/W again, closing the ring).\n+     *\n+     * <p>Interior rings, which describe holes in the polygon, are ignored.\n+     */\n+    private static Optional<GeoJsonTile> fromJsonObject(JSONObject jsonObject) {\n+      Optional<JSONObject> tileGeometry = jsonTileGeometry(jsonObject);\n+\n+      if (tileGeometry.isEmpty()) {\n+        return Optional.empty();\n+      }\n+\n+      try {\n+        LatLng[] coords = jsonTileCoordinates(tileGeometry.get());\n+        String id = jsonTileId(jsonObject);\n+        String url = jsonTileUrl(jsonObject);\n+\n+        Cartesian cartesian = Cartesian.fromString(id);\n+\n+        return Optional.of(new GeoJsonTile(coords, cartesian, url));\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"failed to parse tile JSON\", e);\n+      }\n+      return Optional.empty();\n+    }\n+\n+    /**\n+     * Attempts to retrieve a URL from {@param jsonObject}. Since this field is required for tiles,\n+     * we throw an exception if we fail to parse a URL.\n+     *\n+     * @throws JSONException\n+     */\n+    private static String jsonTileUrl(JSONObject jsonObject) throws JSONException {", "originalCommit": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4Njc3Nw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374486777", "bodyText": "Please move field names into String constants.", "author": "gino-m", "createdAt": "2020-02-04T05:58:02Z", "path": "gnd/src/main/java/com/google/android/gnd/util/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.util;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  static class Cartesian {\n+    private final int xcoordinate;\n+    private final int ycoordinate;\n+    private final int zcoordinate;\n+\n+    Cartesian(int x, int y, int z) {\n+      this.xcoordinate = x;\n+      this.ycoordinate = y;\n+      this.zcoordinate = z;\n+    }\n+\n+    private static Cartesian fromString(String catersianCoords) {\n+      String[] values = catersianCoords.replaceAll(\"[()]\", \"\").split(\",\");\n+      int[] coords = new int[3];\n+\n+      for (int i = 0; i < coords.length && i < values.length; i++) {\n+        coords[i] = Integer.parseInt(values[i]);\n+      }\n+\n+      return new Cartesian(coords[0], coords[1], coords[2]);\n+    }\n+  }\n+\n+  /**\n+   * A GeoJSONTile is any polygon that describes a single exterior ring comprised of four ordered\n+   * coordinates: South/West, South/East, North/West, North/East, has a cartesian representation,\n+   * and has an associated URL.\n+   */\n+  private static class GeoJsonTile {\n+\n+    private final LatLng[] coordinates;\n+    private final Cartesian cartesian;\n+    private final String url;\n+\n+    private GeoJsonTile(LatLng[] coordinates, Cartesian cartesian, String url) {\n+      this.coordinates = coordinates.clone();\n+      this.cartesian = cartesian;\n+      this.url = url;\n+    }\n+\n+    /**\n+     * Constructs a GeoJSONTile based on the contents of {@param jsonObject}.\n+     *\n+     * <p>A valid tile has the following information:\n+     *\n+     * <p>- a geometry describing a polygon. - an id specifying cartesian coordinates. - a URL\n+     * specifying a source for the tile imagery.\n+     *\n+     * <p>GeoJSON Polygons are described using coordinate arrays that form a linear ring. The first\n+     * and last value in a linear ring are equivalent. We assume coordinates are ordered, S/W, S/E,\n+     * N/E, N/W, (S/W again, closing the ring).\n+     *\n+     * <p>Interior rings, which describe holes in the polygon, are ignored.\n+     */\n+    private static Optional<GeoJsonTile> fromJsonObject(JSONObject jsonObject) {\n+      Optional<JSONObject> tileGeometry = jsonTileGeometry(jsonObject);\n+\n+      if (tileGeometry.isEmpty()) {\n+        return Optional.empty();\n+      }\n+\n+      try {\n+        LatLng[] coords = jsonTileCoordinates(tileGeometry.get());\n+        String id = jsonTileId(jsonObject);\n+        String url = jsonTileUrl(jsonObject);\n+\n+        Cartesian cartesian = Cartesian.fromString(id);\n+\n+        return Optional.of(new GeoJsonTile(coords, cartesian, url));\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"failed to parse tile JSON\", e);\n+      }\n+      return Optional.empty();\n+    }\n+\n+    /**\n+     * Attempts to retrieve a URL from {@param jsonObject}. Since this field is required for tiles,\n+     * we throw an exception if we fail to parse a URL.\n+     *\n+     * @throws JSONException\n+     */\n+    private static String jsonTileUrl(JSONObject jsonObject) throws JSONException {\n+      try {\n+        return jsonObject.getJSONObject(\"properties\").getString(\"title\");\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json tile url\", e);\n+        throw e;\n+      }\n+    }\n+\n+    /**\n+     * Attempts to retrieve coordinates from {@param jsonGeometry}. Since these fields are required\n+     * for tiles, we throw an exception if we fail to parse coordinates.\n+     *\n+     * @throws JSONException\n+     */\n+    private static LatLng[] jsonTileCoordinates(JSONObject jsonGeometry) throws JSONException {\n+      try {\n+        JSONArray sw = jsonGeometry.getJSONArray(\"coordinates\").getJSONArray(0);", "originalCommit": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NzA5OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374487098", "bodyText": "Since you're throwing a checked exception, the caller will need to handle it, in which case the catch() and Log statements aren't needed here.", "author": "gino-m", "createdAt": "2020-02-04T05:59:19Z", "path": "gnd/src/main/java/com/google/android/gnd/util/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.util;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  static class Cartesian {\n+    private final int xcoordinate;\n+    private final int ycoordinate;\n+    private final int zcoordinate;\n+\n+    Cartesian(int x, int y, int z) {\n+      this.xcoordinate = x;\n+      this.ycoordinate = y;\n+      this.zcoordinate = z;\n+    }\n+\n+    private static Cartesian fromString(String catersianCoords) {\n+      String[] values = catersianCoords.replaceAll(\"[()]\", \"\").split(\",\");\n+      int[] coords = new int[3];\n+\n+      for (int i = 0; i < coords.length && i < values.length; i++) {\n+        coords[i] = Integer.parseInt(values[i]);\n+      }\n+\n+      return new Cartesian(coords[0], coords[1], coords[2]);\n+    }\n+  }\n+\n+  /**\n+   * A GeoJSONTile is any polygon that describes a single exterior ring comprised of four ordered\n+   * coordinates: South/West, South/East, North/West, North/East, has a cartesian representation,\n+   * and has an associated URL.\n+   */\n+  private static class GeoJsonTile {\n+\n+    private final LatLng[] coordinates;\n+    private final Cartesian cartesian;\n+    private final String url;\n+\n+    private GeoJsonTile(LatLng[] coordinates, Cartesian cartesian, String url) {\n+      this.coordinates = coordinates.clone();\n+      this.cartesian = cartesian;\n+      this.url = url;\n+    }\n+\n+    /**\n+     * Constructs a GeoJSONTile based on the contents of {@param jsonObject}.\n+     *\n+     * <p>A valid tile has the following information:\n+     *\n+     * <p>- a geometry describing a polygon. - an id specifying cartesian coordinates. - a URL\n+     * specifying a source for the tile imagery.\n+     *\n+     * <p>GeoJSON Polygons are described using coordinate arrays that form a linear ring. The first\n+     * and last value in a linear ring are equivalent. We assume coordinates are ordered, S/W, S/E,\n+     * N/E, N/W, (S/W again, closing the ring).\n+     *\n+     * <p>Interior rings, which describe holes in the polygon, are ignored.\n+     */\n+    private static Optional<GeoJsonTile> fromJsonObject(JSONObject jsonObject) {\n+      Optional<JSONObject> tileGeometry = jsonTileGeometry(jsonObject);\n+\n+      if (tileGeometry.isEmpty()) {\n+        return Optional.empty();\n+      }\n+\n+      try {\n+        LatLng[] coords = jsonTileCoordinates(tileGeometry.get());\n+        String id = jsonTileId(jsonObject);\n+        String url = jsonTileUrl(jsonObject);\n+\n+        Cartesian cartesian = Cartesian.fromString(id);\n+\n+        return Optional.of(new GeoJsonTile(coords, cartesian, url));\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"failed to parse tile JSON\", e);\n+      }\n+      return Optional.empty();\n+    }\n+\n+    /**\n+     * Attempts to retrieve a URL from {@param jsonObject}. Since this field is required for tiles,\n+     * we throw an exception if we fail to parse a URL.\n+     *\n+     * @throws JSONException\n+     */\n+    private static String jsonTileUrl(JSONObject jsonObject) throws JSONException {\n+      try {\n+        return jsonObject.getJSONObject(\"properties\").getString(\"title\");\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json tile url\", e);\n+        throw e;\n+      }\n+    }\n+\n+    /**\n+     * Attempts to retrieve coordinates from {@param jsonGeometry}. Since these fields are required\n+     * for tiles, we throw an exception if we fail to parse coordinates.\n+     *\n+     * @throws JSONException\n+     */\n+    private static LatLng[] jsonTileCoordinates(JSONObject jsonGeometry) throws JSONException {\n+      try {\n+        JSONArray sw = jsonGeometry.getJSONArray(\"coordinates\").getJSONArray(0);\n+        JSONArray ne = jsonGeometry.getJSONArray(\"coordinates\").getJSONArray(2);\n+\n+        double south = sw.getDouble(0);\n+        double west = sw.getDouble(1);\n+        double north = ne.getDouble(0);\n+        double east = ne.getDouble(1);\n+\n+        return new LatLng[] {\n+          new LatLng(south, west),\n+          new LatLng(south, east),\n+          new LatLng(north, west),\n+          new LatLng(north, east)\n+        };\n+\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json tile coordinates\", e);", "originalCommit": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc1MTQ1OQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374751459", "bodyText": "My thinking was to particularize the point of failure by catching and logging in the helper methods + the caller.\nSo for instance, if we failed to get coordinates, we'd have a log + stack trace of roughly:\nGeoJsonParser: Failed to parse geojson\nGeoJsonParser: couldn't parse json tile coordinates\nIn which case we have more info to work with to debug -- wdyt? Is that overkill? Is it better to define a custom exception instead to differentiate and throw those? --that way we can still be specific about the cause of failure and only need to catch in the caller", "author": "scolsen", "createdAt": "2020-02-04T15:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NzA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4ODg0Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374488846", "bodyText": "A few suggestions on code structure:\n\n This deals with deserializing JSON files, so it probably in the persistence package. (e.g. ...persistence.geojson?)\n Rather than pass JSONObject around to static methods, can we wrap the different instances in typed accessor objects? (e.g., JsonGeometry, JsonTileExtent, etc)? (https://testing.googleblog.com/2017/11/obsessed-with-primitives.html)\n If this file is  moved to its own package, the inner classes and be promoted to outer classes in their own file to help readability.\n GeoJsonParser can then provide a custom GeoJson object with the data we're interested in.\n\nWdyt?", "author": "gino-m", "createdAt": "2020-02-04T06:07:11Z", "path": "gnd/src/main/java/com/google/android/gnd/util/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*", "originalCommit": "2c1e3d7945d4d1d598887a9a7d17c090c9082f8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc1MzIwNQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374753205", "bodyText": "SG! After the initial impl, this component seems complex enough to me to up-level it to its own package, which will make it easier to define accessor objects like you suggest--plus it'll make it easier to extend in the future.", "author": "scolsen", "createdAt": "2020-02-04T15:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4ODg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzMTk0MA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r374831940", "bodyText": "Thanks for taking a look!", "author": "gino-m", "createdAt": "2020-02-04T18:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4ODg0Ng=="}], "type": "inlineReview"}, {"oid": "d044cd4b5ada590a14cbad5b8de98961cb3c6159", "url": "https://github.com/google/ground-android/commit/d044cd4b5ada590a14cbad5b8de98961cb3c6159", "message": "Merge branch 'master' into json-parser", "committedDate": "2020-02-11T02:29:57Z", "type": "commit"}, {"oid": "747df3aa5ed842011d73de153e835bd479b232c9", "url": "https://github.com/google/ground-android/commit/747df3aa5ed842011d73de153e835bd479b232c9", "message": "Refactor geo json parsing utility\n\nThis commit refactors our approach to geo JSON parsing, including:\n\n- Moving the parser into its own package under persistance\n- Creating classes to represent each peice of JSON data we need\n- Using constants to refer to JSON key names\n- Healthy use of optionals to avoid non-catastrophic exceptions\n- Simplifying the parser class itself\n\nI've also replaced the cartesian coordinates based path conversion in\nTiles with the original id based-approach, since it's simpler for the\ntime being.", "committedDate": "2020-02-11T21:42:23Z", "type": "commit"}, {"oid": "a78d23ce3c813ca1584328c42ba0212f2bb10427", "url": "https://github.com/google/ground-android/commit/a78d23ce3c813ca1584328c42ba0212f2bb10427", "message": "Merge branch 'json-parser' of https://github.com/scolsen/ground-android into json-parser", "committedDate": "2020-02-11T21:46:50Z", "type": "commit"}, {"oid": "879d9f3b3e29208577c0566b642cf762244cc8c2", "url": "https://github.com/google/ground-android/commit/879d9f3b3e29208577c0566b642cf762244cc8c2", "message": "Merge branch 'master' of https://github.com/google/ground-android into json-parser", "committedDate": "2020-02-11T21:47:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzU5Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377997596", "bodyText": "Consider using List instead. Also, an empty list is synonymous with Optional.empty(), so Optional isn't needed here.", "author": "gino-m", "createdAt": "2020-02-12T01:36:47Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1NjYxMQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378956611", "bodyText": "Oh, nice! Thanks for the tip!", "author": "scolsen", "createdAt": "2020-02-13T16:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzY4NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377997685", "bodyText": "Consider renaming to vertices.", "author": "gino-m", "createdAt": "2020-02-12T01:37:07Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MjAzNA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378982034", "bodyText": "Done!", "author": "scolsen", "createdAt": "2020-02-13T16:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5NzY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5Nzk2NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377997965", "bodyText": "Extracting the coordinates from the geometry seems to be almost free, so we should prefer to remove this derived state and calculate when called.", "author": "gino-m", "createdAt": "2020-02-12T01:38:08Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;\n+\n+  @Nullable\n+  GeoJsonExtent(GeoJsonGeometry geometry) {\n+    this.geometry = geometry;\n+    this.coordinates = getPolygonCoordinates();", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MTk5NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378981995", "bodyText": "sg!", "author": "scolsen", "createdAt": "2020-02-13T16:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5Nzk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODIxNg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377998216", "bodyText": "this is only needed in the constructor to disambiguate the field name from the constructor arg, please remove throughout.", "author": "gino-m", "createdAt": "2020-02-12T01:38:56Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;\n+\n+  @Nullable\n+  GeoJsonExtent(GeoJsonGeometry geometry) {\n+    this.geometry = geometry;\n+    this.coordinates = getPolygonCoordinates();\n+  }\n+\n+  Optional<LatLngBounds> getBounds() {\n+    return this.coordinates.map(cs -> new LatLngBounds(cs[0], cs[2]));", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MjM1NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378982354", "bodyText": "Done!", "author": "scolsen", "createdAt": "2020-02-13T16:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODIxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODc2MA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377998760", "bodyText": "get() with throw an exception if the Optional is empty. We should either check .isPresent() first, use functional methods to propagate the empty state, or avoid the Optional altogether.", "author": "gino-m", "createdAt": "2020-02-12T01:41:07Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;\n+\n+  @Nullable\n+  GeoJsonExtent(GeoJsonGeometry geometry) {\n+    this.geometry = geometry;\n+    this.coordinates = getPolygonCoordinates();\n+  }\n+\n+  Optional<LatLngBounds> getBounds() {\n+    return this.coordinates.map(cs -> new LatLngBounds(cs[0], cs[2]));\n+  }\n+\n+  private Optional<LatLng[]> getPolygonCoordinates() {\n+    JSONArray sw = this.geometry.getCoordinates().map(j -> j.optJSONArray(0)).get();\n+    JSONArray ne = this.geometry.getCoordinates().map(j -> j.optJSONArray(2)).get();", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4NTM1OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378985358", "bodyText": "sg, for the first commit addressing these comments I'm going to stick with the optional and just add a check for empties--I think your suggestion to remove the optional entirely makes sense in this case though, so in subsequent commits I may do that.", "author": "scolsen", "createdAt": "2020-02-13T16:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODk3Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377998976", "bodyText": "This could then become Arrays.asList(new LatLng(..), new LatLng(..)..)", "author": "gino-m", "createdAt": "2020-02-12T01:41:59Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import javax.annotation.Nullable;\n+import org.json.JSONArray;\n+\n+public class GeoJsonExtent {\n+\n+  private final GeoJsonGeometry geometry;\n+  private final Optional<LatLng[]> coordinates;\n+\n+  @Nullable\n+  GeoJsonExtent(GeoJsonGeometry geometry) {\n+    this.geometry = geometry;\n+    this.coordinates = getPolygonCoordinates();\n+  }\n+\n+  Optional<LatLngBounds> getBounds() {\n+    return this.coordinates.map(cs -> new LatLngBounds(cs[0], cs[2]));\n+  }\n+\n+  private Optional<LatLng[]> getPolygonCoordinates() {\n+    JSONArray sw = this.geometry.getCoordinates().map(j -> j.optJSONArray(0)).get();\n+    JSONArray ne = this.geometry.getCoordinates().map(j -> j.optJSONArray(2)).get();\n+\n+    if (sw == null || ne == null) {\n+      return Optional.empty();\n+    }\n+\n+    double south = sw.optDouble(0, 0.0);\n+    double west = sw.optDouble(1, 0.0);\n+    double north = ne.optDouble(0, 0.0);\n+    double east = ne.optDouble(1, 0.0);\n+\n+    return Optional.of(", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4Njc2Mg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378986762", "bodyText": "Gotcha", "author": "scolsen", "createdAt": "2020-02-13T16:50:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5ODk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTMyOQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377999329", "bodyText": "Same comment here - let's get these states on the fly rather than caching them since it adds carrying cost without adding performance [possible overoptimization].", "author": "gino-m", "createdAt": "2020-02-12T01:43:34Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonGeometry.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import java8.util.Optional;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+public class GeoJsonGeometry {\n+\n+  private static final String GEOMETRY_KEY = \"geometry\";\n+  private static final String GEOMETRY_TYPE_KEY = \"type\";\n+  private static final String COORDINATES_JSON_KEY = \"coordinates\";\n+\n+  private final Optional<JSONObject> json;\n+  private final Optional<String> type;\n+  private final Optional<JSONArray> coordinates;\n+\n+  GeoJsonGeometry(JSONObject jsonObject) {\n+    this.json = Optional.ofNullable(jsonObject.optJSONObject(GEOMETRY_KEY));", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5MTE2Mg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378991162", "bodyText": "\ud83d\udc4d", "author": "scolsen", "createdAt": "2020-02-13T16:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTY5Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377999696", "bodyText": "Please make these classes package private (i.e. class GeoJsonGeometry) to avoid accidental usage outside this package and to signal they're tightly coupled to the parser.", "author": "gino-m", "createdAt": "2020-02-12T01:45:08Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonGeometry.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import java8.util.Optional;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+public class GeoJsonGeometry {", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5MTY4NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378991685", "bodyText": "\u2705", "author": "scolsen", "createdAt": "2020-02-13T16:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5OTkzMw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r377999933", "bodyText": "Please move down to after the public method that depends on it or after all public methods.", "author": "gino-m", "createdAt": "2020-02-12T01:46:04Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwMzA1Mg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378003052", "bodyText": "Not sure if this is better or not, but I think this method could also be written as something like:\nreturn IntStream.range(0, arr.length()).map(i -> arr. getJSONObject(i));\n\nThe returned stream could them be used directly without first iterating. May need to experiment on how to best handle JSONExceptions.", "author": "gino-m", "createdAt": "2020-02-12T01:58:40Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5NTExNg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378995116", "bodyText": "That is way better! We can use optJSONObject instead of getJSONObject to workaround exceptions.", "author": "scolsen", "createdAt": "2020-02-13T17:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwMzA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwNTE3Mg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379005172", "bodyText": "Turns out we can't conveniently use this approach due to lack of range functions (the libs we're using for stream support require spliterators)", "author": "scolsen", "createdAt": "2020-02-13T17:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwMzA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDQ2OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378004468", "bodyText": "Please use System.lineSeparator() instead of \\n.", "author": "gino-m", "createdAt": "2020-02-12T02:04:08Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<Tile> intersectingTiles(LatLngBounds bounds, File geojson) {\n+    try {\n+      InputStream is = new FileInputStream(geojson);\n+      BufferedReader buf = new BufferedReader(new InputStreamReader(is));\n+      String line = buf.readLine();\n+      StringBuilder sb = new StringBuilder();\n+      while (line != null) {\n+        sb.append(line).append('\\n');", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxNTcyOQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379015729", "bodyText": "done", "author": "scolsen", "createdAt": "2020-02-13T17:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxNzgyNw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379017827", "bodyText": "Changed to reading this char by char", "author": "scolsen", "createdAt": "2020-02-13T17:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDYwMQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378004601", "bodyText": "The arg name geojson collides with bar geoJson. Perhaps rename to file for clarity?", "author": "gino-m", "createdAt": "2020-02-12T02:04:49Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<Tile> intersectingTiles(LatLngBounds bounds, File geojson) {", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxNzkzMQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379017931", "bodyText": "done", "author": "scolsen", "createdAt": "2020-02-13T17:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNDYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTAwMA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378005000", "bodyText": "Either use orElse() to provide a default here and below, make required (not Optional), or check these fields are present before hand to prevent get() from crashing the app.", "author": "gino-m", "createdAt": "2020-02-12T02:06:26Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<Tile> intersectingTiles(LatLngBounds bounds, File geojson) {\n+    try {\n+      InputStream is = new FileInputStream(geojson);\n+      BufferedReader buf = new BufferedReader(new InputStreamReader(is));\n+      String line = buf.readLine();\n+      StringBuilder sb = new StringBuilder();\n+      while (line != null) {\n+        sb.append(line).append('\\n');\n+        line = buf.readLine();\n+      }\n+\n+      JSONObject geoJson = new JSONObject(sb.toString());\n+      JSONArray features = geoJson.getJSONArray(\"features\");\n+\n+      return stream(toArray(features))\n+          .map(GeoJsonTile::new)\n+          .filter(tile -> tile.boundsIntersect(bounds))\n+          .map(this::jsonToTile)\n+          .collect(toImmutableList());\n+\n+    } catch (IOException | JSONException e) {\n+      Log.e(TAG, \"Unable to load JSON layer\", e);\n+    }\n+    return ImmutableList.of();\n+  }\n+\n+  /** Returns the {@link Tile} specified by {@param json}. */\n+  private Tile jsonToTile(GeoJsonTile json) {\n+    return Tile.newBuilder()\n+        .setId(uuidGenerator.generateUuid())\n+        .setUrl(json.getUrl().get())", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAyMTEzMQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379021131", "bodyText": "Using orElse() for now and setting an empty string--but these should probably be required.", "author": "scolsen", "createdAt": "2020-02-13T17:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTE3NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378005174", "bodyText": "Same here re cached state.", "author": "gino-m", "createdAt": "2020-02-12T02:07:20Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonTile.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static java8.util.J8Arrays.stream;\n+\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import java8.util.Optional;\n+import org.json.JSONObject;\n+\n+/**\n+ * A GeoJSONTile is any polygon that describes a single exterior ring comprised of four ordered\n+ * coordinates: South/West, South/East, North/West, North/East, has a cartesian representation, and\n+ * has an associated URL.\n+ */\n+public class GeoJsonTile {\n+\n+  private static final String ID_KEY = \"id\";\n+  private static final String PROPERTIES_KEY = \"properties\";\n+  private static final String URL_KEY = \"title\";\n+\n+  private final GeoJsonExtent extent;\n+  private final Optional<String> id;\n+  private final Optional<String> url;\n+\n+  /**\n+   * Constructs a GeoJSONTile based on the contents of {@param jsonObject}.\n+   *\n+   * <p>A valid tile has the following information:\n+   *\n+   * <p>- a geometry describing a polygon. - an id specifying cartesian coordinates. - a URL\n+   * specifying a source for the tile imagery.\n+   *\n+   * <p>GeoJSON Polygons are described using coordinate arrays that form a linear ring. The first\n+   * and last value in a linear ring are equivalent. We assume coordinates are ordered, S/W, S/E,\n+   * N/E, N/W, (S/W again, closing the ring).\n+   *\n+   * <p>Interior rings, which describe holes in the polygon, are ignored.\n+   */\n+  GeoJsonTile(JSONObject jsonObject) {\n+    this.extent = new GeoJsonExtent(new GeoJsonGeometry(jsonObject));\n+    this.id = Optional.of(jsonObject.optString(ID_KEY));\n+    this.url =", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAyNDIzNA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379024234", "bodyText": "done", "author": "scolsen", "createdAt": "2020-02-13T17:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTQ4Nw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r378005487", "bodyText": "Can we split the loading of the file into a String into a separate method so that this method will focus on  parsing its contents?", "author": "gino-m", "createdAt": "2020-02-12T02:08:41Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.geojson;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.J8Arrays.stream;\n+\n+import android.util.Log;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n+import com.google.common.collect.ImmutableList;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.inject.Inject;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+public class GeoJsonParser {\n+\n+  private static final String TAG = GeoJsonParser.class.getSimpleName();\n+  private final OfflineUuidGenerator uuidGenerator;\n+\n+  @Inject\n+  GeoJsonParser(OfflineUuidGenerator uuidGenerator) {\n+    this.uuidGenerator = uuidGenerator;\n+  }\n+\n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<Tile> intersectingTiles(LatLngBounds bounds, File geojson) {\n+    try {\n+      InputStream is = new FileInputStream(geojson);\n+      BufferedReader buf = new BufferedReader(new InputStreamReader(is));\n+      String line = buf.readLine();\n+      StringBuilder sb = new StringBuilder();\n+      while (line != null) {\n+        sb.append(line).append('\\n');\n+        line = buf.readLine();\n+      }", "originalCommit": "879d9f3b3e29208577c0566b642cf762244cc8c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAyMTI2Mg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379021262", "bodyText": "Done!", "author": "scolsen", "createdAt": "2020-02-13T17:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNTQ4Nw=="}], "type": "inlineReview"}, {"oid": "9264197a062c901af2d40fbac88a96afecbd4333", "url": "https://github.com/google/ground-android/commit/9264197a062c901af2d40fbac88a96afecbd4333", "message": "Improve code quality of GeoJsonExtents\n\nIncluding:\n\n- Use an ImmutableList instead of an Array to represent vertices\n- Rename instances of coordinates to vertices\n- Calculate vertices on demand instead of allocating\n- Check that optionals aren't empty before calling `get()`\n- Reorder LatLngs in vertices list\n- Make various methods/classes package private", "committedDate": "2020-02-13T16:51:27Z", "type": "commit"}, {"oid": "c54eb95d70b282dbd8c56cfe61da0dc65492687f", "url": "https://github.com/google/ground-android/commit/c54eb95d70b282dbd8c56cfe61da0dc65492687f", "message": "Improve code quality in GeoJsonGeometry\n\nNotably:\n\n- Make the class package private\n- Calculate JSON field values on demand, instead of allocating", "committedDate": "2020-02-13T16:59:30Z", "type": "commit"}, {"oid": "a5e91f8b8cf2bb4a4860646e97d3312813221278", "url": "https://github.com/google/ground-android/commit/a5e91f8b8cf2bb4a4860646e97d3312813221278", "message": "Improve code quality in GeoJsonParser\n\n- Move static methods below public ones\n- Split JSON file reading into a separate function\n- Read files character by character instead of line by line\n- Return empty strings when URL and ID fields aren't present in JSON\n  tiles.", "committedDate": "2020-02-13T17:51:44Z", "type": "commit"}, {"oid": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "url": "https://github.com/google/ground-android/commit/bb10b27112ecbcd8d5d212a32287abd34b353a51", "message": "Compute GeoJsonTile values on demand instead of caching", "committedDate": "2020-02-13T17:55:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTI0NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379155245", "bodyText": "Can we get rid of this method and expose or rename getPolygonVertices()", "author": "gino-m", "createdAt": "2020-02-13T22:28:23Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonExtent.java", "diffHunk": "@@ -17,49 +17,44 @@\n package com.google.android.gnd.persistence.geojson;\n \n import com.google.android.gms.maps.model.LatLng;\n-import com.google.android.gms.maps.model.LatLngBounds;\n-import java8.util.Optional;\n+import com.google.common.collect.ImmutableList;\n import javax.annotation.Nullable;\n import org.json.JSONArray;\n \n-public class GeoJsonExtent {\n+class GeoJsonExtent {\n \n   private final GeoJsonGeometry geometry;\n-  private final Optional<LatLng[]> coordinates;\n \n   @Nullable\n   GeoJsonExtent(GeoJsonGeometry geometry) {\n     this.geometry = geometry;\n-    this.coordinates = getPolygonCoordinates();\n   }\n \n-  Optional<LatLngBounds> getBounds() {\n-    return this.coordinates.map(cs -> new LatLngBounds(cs[0], cs[2]));\n+  ImmutableList<LatLng> getVertices() {\n+    return getPolygonVertices();", "originalCommit": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0ODU2NQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380948565", "bodyText": "Sgtm, done!", "author": "scolsen", "createdAt": "2020-02-18T21:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjM5OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379156398", "bodyText": "Instead of eating the exception and returning \"\", we can throw it and catch it in intersectingTiles, eliminating the need for a \"fake\" value in the interim.", "author": "gino-m", "createdAt": "2020-02-13T22:31:10Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -46,41 +46,32 @@\n     this.uuidGenerator = uuidGenerator;\n   }\n \n-  /**\n-   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n-   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n-   */\n-  private static JSONObject[] toArray(JSONArray arr) {\n-    JSONObject[] result = new JSONObject[arr.length()];\n+  private String readJsonFile(File file) {\n+    try {\n+      InputStream is = new FileInputStream(file);\n+      BufferedReader buf = new BufferedReader(new InputStreamReader(is));\n+      StringBuilder sb = new StringBuilder();\n \n-    for (int i = 0; i < arr.length(); i++) {\n-      try {\n-        JSONObject o = arr.getJSONObject(i);\n-        result[i] = o;\n-      } catch (JSONException e) {\n-        Log.e(TAG, \"couldn't parse json\", e);\n+      int res = buf.read();\n+      while (res != -1) {\n+        sb.append(res);\n+        res = buf.read();\n       }\n+      return sb.toString();\n+    } catch (IOException e) {\n+      Log.e(TAG, \"Unable to load JSON\", e);\n     }\n-\n-    return result;\n+    return \"\";", "originalCommit": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0OTUwNw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380949507", "bodyText": "Ah, gotcha. \u2705", "author": "scolsen", "createdAt": "2020-02-18T21:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjU0OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379156548", "bodyText": "These two lines can be combined.", "author": "gino-m", "createdAt": "2020-02-13T22:31:32Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -89,19 +80,39 @@\n           .map(this::jsonToTile)\n           .collect(toImmutableList());\n \n-    } catch (IOException | JSONException e) {\n-      Log.e(TAG, \"Unable to load JSON layer\", e);\n+    } catch (JSONException e) {\n+      Log.e(TAG, \"Unable to parse JSON\", e);\n     }\n+\n     return ImmutableList.of();\n   }\n \n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);", "originalCommit": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MDU3NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380950574", "bodyText": "Done!", "author": "scolsen", "createdAt": "2020-02-18T21:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NzI0OA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379157248", "bodyText": "Ideally we wouldn't keep Tile in an invalidate state if the file is invalid. Could you add a TODO here to throw an Exception instead that gets handled downstream?", "author": "gino-m", "createdAt": "2020-02-13T22:33:16Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -89,19 +80,39 @@\n           .map(this::jsonToTile)\n           .collect(toImmutableList());\n \n-    } catch (IOException | JSONException e) {\n-      Log.e(TAG, \"Unable to load JSON layer\", e);\n+    } catch (JSONException e) {\n+      Log.e(TAG, \"Unable to parse JSON\", e);\n     }\n+\n     return ImmutableList.of();\n   }\n \n+  /**\n+   * Converts a JSONArray to an array of JSONObjects. Provided for compatibility with java8 streams.\n+   * JSONArray itself only inherits from Object, and is not convertible to a stream.\n+   */\n+  private static JSONObject[] toArray(JSONArray arr) {\n+    JSONObject[] result = new JSONObject[arr.length()];\n+\n+    for (int i = 0; i < arr.length(); i++) {\n+      try {\n+        JSONObject o = arr.getJSONObject(i);\n+        result[i] = o;\n+      } catch (JSONException e) {\n+        Log.e(TAG, \"couldn't parse json\", e);\n+      }\n+    }\n+\n+    return result;\n+  }\n+\n   /** Returns the {@link Tile} specified by {@param json}. */\n   private Tile jsonToTile(GeoJsonTile json) {\n     return Tile.newBuilder()\n         .setId(uuidGenerator.generateUuid())\n-        .setUrl(json.getUrl().get())\n+        .setUrl(json.getUrl().orElse(\"\"))\n         .setState(State.PENDING)\n-        .setPath(Tile.pathFromId(json.getId().get()))\n+        .setPath(Tile.pathFromId(json.getId().orElse(\"\")))", "originalCommit": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MDY1NA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380950654", "bodyText": "Added.", "author": "scolsen", "createdAt": "2020-02-18T21:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NzI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NzkyMg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r379157922", "bodyText": "This will return Optional.of(\"\") if it doesn't exists. We should either model missing as null, Optional.empty(), or \"\". Any of those alternatives are fine, but all these will make edge cases harder to catch.", "author": "gino-m", "createdAt": "2020-02-13T22:35:07Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonTile.java", "diffHunk": "@@ -53,34 +52,22 @@\n    * <p>Interior rings, which describe holes in the polygon, are ignored.\n    */\n   GeoJsonTile(JSONObject jsonObject) {\n-    this.extent = new GeoJsonExtent(new GeoJsonGeometry(jsonObject));\n-    this.id = Optional.of(jsonObject.optString(ID_KEY));\n-    this.url =\n-        Optional.ofNullable(jsonObject.optJSONObject(PROPERTIES_KEY))\n-            .map(j -> j.optString(URL_KEY));\n+    this.json = jsonObject;\n   }\n \n-  public Optional<LatLngBounds> getBounds() {\n-    return this.extent.getBounds();\n-  }\n-\n-  public Optional<LatLng[]> getCoordinates() {\n-    return this.extent.getCoordinates();\n+  private ImmutableList<LatLng> getVertices() {\n+    return new GeoJsonExtent(new GeoJsonGeometry(json)).getVertices();\n   }\n \n   public Optional<String> getId() {\n-    return this.id;\n+    return Optional.of(json.optString(ID_KEY));", "originalCommit": "bb10b27112ecbcd8d5d212a32287abd34b353a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1NjMxNw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380956317", "bodyText": "Gotcha, returning Optional.empty on...well, empty values.", "author": "scolsen", "createdAt": "2020-02-18T21:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NzkyMg=="}], "type": "inlineReview"}, {"oid": "5d958117059414f76c93a805670fc358a7ceb990", "url": "https://github.com/google/ground-android/commit/5d958117059414f76c93a805670fc358a7ceb990", "message": "Merge branch 'master' of https://github.com/google/ground-android into json-parser", "committedDate": "2020-02-18T21:32:51Z", "type": "commit"}, {"oid": "40fc09e46f5dac48110659aac5ae895e3d4a5060", "url": "https://github.com/google/ground-android/commit/40fc09e46f5dac48110659aac5ae895e3d4a5060", "message": "Remove redundant getter method in GeoJsonExtent\n\ngetPolygonVertices and getVertices were redundant--this change renames\nthe PolygonVertices method to getVertices and exposes it to callers\ndirectly (package-private).", "committedDate": "2020-02-18T21:40:49Z", "type": "commit"}, {"oid": "314e665068bef04129ccb53031bbbad77479ebd7", "url": "https://github.com/google/ground-android/commit/314e665068bef04129ccb53031bbbad77479ebd7", "message": "Improve code quality in GeoJsonParser\n\n- Be terse; merge equivalent lines.\n- Throw exceptions where it makes sense.\n- Add a TODO to throw further exceptions later.", "committedDate": "2020-02-18T21:42:12Z", "type": "commit"}, {"oid": "7136a3fadf3775da5ff5089cabd10ad374e0ab59", "url": "https://github.com/google/ground-android/commit/7136a3fadf3775da5ff5089cabd10ad374e0ab59", "message": "Remove cartesian coordinates from Tile model/db entity\n\nYAGNI/KISS--we don't have reason to store these yet, and accessing tiles\nby path/id alone was sufficient in the past. We can revisit storing\nthese values if we need to in the future.", "committedDate": "2020-02-18T21:47:55Z", "type": "commit"}, {"oid": "9015243dd1e7de3cb27390027d3c9daa2b7fa096", "url": "https://github.com/google/ground-android/commit/9015243dd1e7de3cb27390027d3c9daa2b7fa096", "message": "Return Optional.empty on empty ID values in JSONTile", "committedDate": "2020-02-18T21:52:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDE4Nw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380980187", "bodyText": "If you're throwing the exception callers will need to catch it, and they will try to log it as well; in that case no need for the try/catch and Log,", "author": "gino-m", "createdAt": "2020-02-18T22:44:16Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -60,17 +60,17 @@ private String readJsonFile(File file) {\n       return sb.toString();\n     } catch (IOException e) {", "originalCommit": "9015243dd1e7de3cb27390027d3c9daa2b7fa096", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDUwOA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380980508", "bodyText": "In fact I see it's logged in the calling function, so ok to remove the try/catch block.", "author": "gino-m", "createdAt": "2020-02-18T22:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4NTQ0Ng==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380985446", "bodyText": "Thanks!", "author": "scolsen", "createdAt": "2020-02-18T22:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MjM1Mw==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380982353", "bodyText": "This error message is slightly misleading \"Ignoring Error in JSON\" might be more accurate.", "author": "gino-m", "createdAt": "2020-02-18T22:49:19Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -96,8 +96,7 @@ private String readJsonFile(File file) {\n \n     for (int i = 0; i < arr.length(); i++) {\n       try {\n-        JSONObject o = arr.getJSONObject(i);\n-        result[i] = o;\n+        result[i] = arr.getJSONObject(i);\n       } catch (JSONException e) {\n         Log.e(TAG, \"couldn't parse json\", e);", "originalCommit": "9015243dd1e7de3cb27390027d3c9daa2b7fa096", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MDIwMA==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380990200", "bodyText": "Good call, updated to \"Ignoring error in JSON array\"", "author": "scolsen", "createdAt": "2020-02-18T23:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MzUxNg==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380983516", "bodyText": "When an exception is thrown here result[i] will remain uninitialized (null). In this case you'd need to filter them out in the caller intersectingTiles(). A cleaner/simpler approach would be to add them to an ArrayList instead of a primitive array.", "author": "gino-m", "createdAt": "2020-02-18T22:51:50Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -96,8 +96,7 @@ private String readJsonFile(File file) {\n \n     for (int i = 0; i < arr.length(); i++) {\n       try {\n-        JSONObject o = arr.getJSONObject(i);\n-        result[i] = o;\n+        result[i] = arr.getJSONObject(i);", "originalCommit": "9015243dd1e7de3cb27390027d3c9daa2b7fa096", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MDAzNQ==", "url": "https://github.com/google/ground-android/pull/342#discussion_r380990035", "bodyText": "Gotcha, switched to ArrayList", "author": "scolsen", "createdAt": "2020-02-18T23:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MzUxNg=="}], "type": "inlineReview"}, {"oid": "b088aa5c2b5300327d8b7d1006a5a979c5c44030", "url": "https://github.com/google/ground-android/commit/b088aa5c2b5300327d8b7d1006a5a979c5c44030", "message": "Use ArrayList instead of Array to avoid nulls\n\nPrior to this, malformed JSON objects encountered by the toArray method\nwould result in nasty nulls. We now use ArrayList to avoid breaking our\nstream over these values later.\n\nI also removed an extraneous try/catch.", "committedDate": "2020-02-18T23:08:49Z", "type": "commit"}, {"oid": "5c68c810c01be22a2e92b97746252011fcc71315", "url": "https://github.com/google/ground-android/commit/5c68c810c01be22a2e92b97746252011fcc71315", "message": "Merge branch 'master' into json-parser", "committedDate": "2020-02-19T14:51:18Z", "type": "commit"}, {"oid": "30b83f8afe5f28b0a96eb28aaaaef0828ce4eac1", "url": "https://github.com/google/ground-android/commit/30b83f8afe5f28b0a96eb28aaaaef0828ce4eac1", "message": "Address PMD issues\n\n- Use List interface instead of ArrayList directly.\n- Remove unused import.", "committedDate": "2020-02-19T15:52:58Z", "type": "commit"}]}