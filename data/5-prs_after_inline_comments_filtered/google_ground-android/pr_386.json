{"pr_number": 386, "pr_title": "[Photos Support] Improve upload photo UI", "pr_createdAt": "2020-03-12T09:33:35Z", "pr_url": "https://github.com/google/ground-android/pull/386", "timeline": [{"oid": "4274a8136075ba7db86ad23e80fba637b9acb79d", "url": "https://github.com/google/ground-android/commit/4274a8136075ba7db86ad23e80fba637b9acb79d", "message": "Replace log with timber", "committedDate": "2020-03-12T06:56:25Z", "type": "commit"}, {"oid": "0960e0c2cd886ab75e47a682aff9cc78824685af", "url": "https://github.com/google/ground-android/commit/0960e0c2cd886ab75e47a682aff9cc78824685af", "message": "Load selected image into thumbnail using BindingAdapter\n\nNotes: Wanted to make BindingAdapters injectable instead of having to pass dependencies into binding. Is there a better way?", "committedDate": "2020-03-12T08:22:56Z", "type": "commit"}, {"oid": "9da709d616ede7863456646d4060ba37e441bd63", "url": "https://github.com/google/ground-android/commit/9da709d616ede7863456646d4060ba37e441bd63", "message": "Improve photo field UI for EditObservation", "committedDate": "2020-03-12T09:29:27Z", "type": "commit"}, {"oid": "b06e2d163a89223d91d5913ed3f12478e4f6dd28", "url": "https://github.com/google/ground-android/commit/b06e2d163a89223d91d5913ed3f12478e4f6dd28", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-12T14:58:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY4MTg2Mg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r391681862", "bodyText": "With Timber can we now just do to following?\nTimber.v(\"onResponseChanged: %s = '%s'\", field.getId(), Response.toString(newResponse));", "author": "gino-m", "createdAt": "2020-03-12T15:00:38Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -196,14 +196,13 @@ public void initialize(EditObservationFragmentArgs args) {\n   }\n \n   public void onTextChanged(Field field, String text) {\n-    Log.v(TAG, \"onTextChanged: \" + field.getId());\n+    Timber.v(\"onTextChanged: %s\", field.getId());\n \n     onResponseChanged(field, TextResponse.fromString(text));\n   }\n \n   public void onResponseChanged(Field field, Optional<Response> newResponse) {\n-    Log.v(\n-        TAG, \"onResponseChanged: \" + field.getId() + \" = '\" + Response.toString(newResponse) + \"'\");\n+    Timber.v(\"onResponseChanged: \" + field.getId() + \" = '\" + Response.toString(newResponse) + \"'\");", "originalCommit": "b06e2d163a89223d91d5913ed3f12478e4f6dd28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY4MjA4Mw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r391682083", "bodyText": "Same here", "author": "gino-m", "createdAt": "2020-03-12T15:00:53Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -392,12 +391,12 @@ private void refreshResponseMap(Observation obs) {\n \n   private ImmutableList<ResponseDelta> getResponseDeltas() {\n     if (originalObservation == null) {\n-      Log.e(TAG, \"Response diff attempted before observation loaded\");\n+      Timber.e(\"Response diff attempted before observation loaded\");\n       return ImmutableList.of();\n     }\n     ImmutableList.Builder<ResponseDelta> deltas = ImmutableList.builder();\n     ResponseMap originalResponses = originalObservation.getResponses();\n-    Log.v(TAG, \"Responses:\\n Before: \" + originalResponses + \" \\nAfter:  \" + responses);\n+    Timber.v(\"Responses:\\n Before: \" + originalResponses + \" \\nAfter:  \" + responses);", "originalCommit": "b06e2d163a89223d91d5913ed3f12478e4f6dd28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9193b3ef1a074bcd16b06847b5a2c8910dc8826e", "url": "https://github.com/google/ground-android/commit/9193b3ef1a074bcd16b06847b5a2c8910dc8826e", "message": "String formatting", "committedDate": "2020-03-12T15:54:03Z", "type": "commit"}, {"oid": "71c91e11c5176fe1ac6bc10ecdfd0fcc70800e83", "url": "https://github.com/google/ground-android/commit/71c91e11c5176fe1ac6bc10ecdfd0fcc70800e83", "message": "Wrap imageview within material card", "committedDate": "2020-03-12T18:29:23Z", "type": "commit"}, {"oid": "73aad5e1620e52b649974ca9f1ff850f4ce48380", "url": "https://github.com/google/ground-android/commit/73aad5e1620e52b649974ca9f1ff850f4ce48380", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-12T18:29:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NzM1Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r391897357", "bodyText": "This is a lot of logic to be doing inside a binding adapter, especially the hiding/showing of the parent view. Can we instead define a separate view widget that can be tested and implemented independently? It could have its own ViewModel with LiveData containing the actual image to display. Wdyt?", "author": "gino-m", "createdAt": "2020-03-12T21:14:45Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/BindingAdapters.java", "diffHunk": "@@ -118,4 +125,29 @@ public static void setOnFocusChangeListener(\n   public static void setOnShowDialogListener(MultipleChoiceFieldLayout view, Runnable listener) {\n     view.setOnShowDialogListener(listener);\n   }\n+\n+  @BindingAdapter({\"bind:storageManager\", \"bind:response\"})\n+  public static void bindPhoto(ImageView view, StorageManager storageManager, Response response) {", "originalCommit": "73aad5e1620e52b649974ca9f1ff850f4ce48380", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA1ODQ0OA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392058448", "bodyText": "Makes sense. Then we can reuse it at other places as well.", "author": "shobhitagarwal1612", "createdAt": "2020-03-13T07:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIxNzI5MA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392217290", "bodyText": "I've added a custom view + a view model for it. But this is again having the original problem of image view not getting updated (nor the visibility of it's container). Can you please have a look? I tried debugging it but couldn't find anything useful. 81d1df1", "author": "shobhitagarwal1612", "createdAt": "2020-03-13T13:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5ODAzNA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393298034", "bodyText": "Great job finding this issue, I looked over the weekend but didn't find it!\nDo you think we can let the binding take a Uri instead of a StorageManager and response to prevent having so much logic in the binder?", "author": "gino-m", "createdAt": "2020-03-16T20:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg5NzM1Nw=="}], "type": "inlineReview"}, {"oid": "81d1df19c66bc22b11cc94b4c03bee810e3e59db", "url": "https://github.com/google/ground-android/commit/81d1df19c66bc22b11cc94b4c03bee810e3e59db", "message": "[WIP] Added Custom View + View Model\n\nProblems:\n - Visibility isn't getting toggled\n - ImageView doesn't get loaded", "committedDate": "2020-03-13T13:09:14Z", "type": "commit"}, {"oid": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "url": "https://github.com/google/ground-android/commit/eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "message": "BindingAdapters main Javadoc", "committedDate": "2020-03-13T15:37:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNTAzMg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392305032", "bodyText": "Do we want to set the placeholder here in case Uri is null?", "author": "gino-m", "createdAt": "2020-03-13T15:38:00Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/BindingAdapters.java", "diffHunk": "@@ -118,4 +129,13 @@ public static void setOnFocusChangeListener(\n   public static void setOnShowDialogListener(MultipleChoiceFieldLayout view, Runnable listener) {\n     view.setOnShowDialogListener(listener);\n   }\n+\n+  @BindingAdapter(\"bind:uri\")\n+  public static void bindUri(ImageView view, Uri uri) {\n+    if (uri == null) {\n+      return;", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1NTcxMA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392355710", "bodyText": "Ideally, when this happens the visibility of MaterialCard should be set to GONE", "author": "shobhitagarwal1612", "createdAt": "2020-03-13T17:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM4NTM0OQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392385349", "bodyText": "When could this actually be null? If it happens, the widget's previous state will remain. At some point, when it's made visible, the old state will show even though Uri is null, which is obviously incorrect. It would seem we'd want the state of the widget to match to current field binding, but I may be missing a piece!", "author": "gino-m", "createdAt": "2020-03-13T17:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMTYyOA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392311628", "bodyText": "This will get the (single) view model associated with this fragment. Instead, we want a different viewmodel for each field instance. For that you'll probably want to use viewModelFactory.create()", "author": "gino-m", "createdAt": "2020-03-13T15:48:52Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -176,26 +174,13 @@ public void addPhotoField(Field field) {\n     PhotoInputFieldBinding binding =\n         PhotoInputFieldBinding.inflate(getLayoutInflater(), formLayout, false);\n     binding.setLifecycleOwner(this);\n+    PhotoViewViewModel photoViewViewModel = getViewModel(PhotoViewViewModel.class);", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMzQ0Mg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392313442", "bodyText": "For once main functionality is working - please use Rx instead of Callbacks. Helper in RxTask can be used to createa Single<Uri> that this method returns, for example.", "author": "gino-m", "createdAt": "2020-03-13T15:52:06Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -120,35 +116,24 @@ private File getLocalFileFromDestinationPath(String destinationPath)\n     return fileUtil.getFile(splits[splits.length - 1]);\n   }\n \n+  private Uri getFileUriFromDestinationPath(String destinationPath) throws FileNotFoundException {\n+    File file = getLocalFileFromDestinationPath(destinationPath);\n+    return Uri.fromFile(file);\n+  }\n+\n   /**\n    * Load photo from the provided destination path.\n    *\n    * <p>If the image is not uploaded yet, then parse the filename from path and load the file from\n    * local storage.\n    *\n-   * @param imageView Placeholder for photo field\n    * @param destinationPath Destination path of the uploaded photo\n    */\n-  public void loadPhotoFromDestinationPath(ImageView imageView, String destinationPath) {\n+  public void loadPhotoFromDestinationPath(String destinationPath, Callback callback) {", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxMzY5MQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392313691", "bodyText": "Load = Download in this case? Please be specific here.", "author": "gino-m", "createdAt": "2020-03-13T15:52:33Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -120,35 +116,24 @@ private File getLocalFileFromDestinationPath(String destinationPath)\n     return fileUtil.getFile(splits[splits.length - 1]);\n   }\n \n+  private Uri getFileUriFromDestinationPath(String destinationPath) throws FileNotFoundException {\n+    File file = getLocalFileFromDestinationPath(destinationPath);\n+    return Uri.fromFile(file);\n+  }\n+\n   /**\n    * Load photo from the provided destination path.", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMDQ5MA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392320490", "bodyText": "Since Views are tightly bound to the Android OS and running VM, in general we're trying keep views as \"dumb\" as possible. This way we can test all/most business logic using ViewModels and upstream classes only. So ideally the views would delegate interaction with custom model classes or logic to the ViewModel. In most cases, that means the View can go away altogether, leaving us with just a layout and viewmodel. Would that be possible in this case?", "author": "gino-m", "createdAt": "2020-03-13T16:01:30Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoView.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.content.Context;\n+import android.net.Uri;\n+import android.util.AttributeSet;\n+import android.view.LayoutInflater;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.PhotoViewBinding;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.material.card.MaterialCardView;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+\n+public class PhotoView extends MaterialCardView {\n+\n+  private final PhotoViewBinding binding;\n+\n+  @Inject StorageManager storageManager;\n+\n+  @Nullable private Response response;\n+\n+  public PhotoView(Context context) {\n+    this(context, null);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs) {\n+    this(context, attrs, 0);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs, int defStyleAttr) {\n+    super(context, attrs, defStyleAttr);\n+\n+    LayoutInflater inflater =\n+        (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);\n+    binding = PhotoViewBinding.inflate(inflater);\n+  }\n+\n+  public void setResponse(@Nullable Response response) {", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMTEyNw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392321127", "bodyText": "In a non-Rx world we'd probably just use Consumer<Uri> instead, but in our case we can just use an Observable.", "author": "gino-m", "createdAt": "2020-03-13T16:02:36Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoView.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.content.Context;\n+import android.net.Uri;\n+import android.util.AttributeSet;\n+import android.view.LayoutInflater;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.PhotoViewBinding;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.material.card.MaterialCardView;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+\n+public class PhotoView extends MaterialCardView {\n+\n+  private final PhotoViewBinding binding;\n+\n+  @Inject StorageManager storageManager;\n+\n+  @Nullable private Response response;\n+\n+  public PhotoView(Context context) {\n+    this(context, null);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs) {\n+    this(context, attrs, 0);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs, int defStyleAttr) {\n+    super(context, attrs, defStyleAttr);\n+\n+    LayoutInflater inflater =\n+        (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);\n+    binding = PhotoViewBinding.inflate(inflater);\n+  }\n+\n+  public void setResponse(@Nullable Response response) {\n+    this.response = response;\n+  }\n+\n+  public void setFragment(Fragment fragment) {\n+    binding.setLifecycleOwner(fragment);\n+  }\n+\n+  public void setViewModel(PhotoViewViewModel viewModel) {\n+    if (viewModel == null) {\n+      return;\n+    }\n+    viewModel.setResponse(response);\n+    binding.setViewModel(viewModel);\n+  }\n+\n+  public interface Callback {", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMTkwOA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392321908", "bodyText": "Naming: PhotoFieldViewModel, to make it clear that this is specific to photo fields in forms, not just any photo widget?", "author": "gino-m", "createdAt": "2020-03-13T16:04:02Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoViewViewModel.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.net.Uri;\n+import android.view.View;\n+import androidx.databinding.ObservableInt;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import javax.inject.Inject;\n+\n+public class PhotoViewViewModel extends AbstractViewModel {", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMjQ0MA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392322440", "bodyText": "This should probably be calling this \"visibility\" instead given the value it returns and how it's used.", "author": "gino-m", "createdAt": "2020-03-13T16:04:56Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoViewViewModel.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.net.Uri;\n+import android.view.View;\n+import androidx.databinding.ObservableInt;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import javax.inject.Inject;\n+\n+public class PhotoViewViewModel extends AbstractViewModel {\n+\n+  private final StorageManager storageManager;\n+  private final MutableLiveData<Uri> destinationPath = new MutableLiveData<Uri>();\n+  private final ObservableInt isDestinationPathAvailable = new ObservableInt(View.GONE);", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMjgzMw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392322833", "bodyText": "Also, we should use LiveData since ObservableInt isn't Lifecycle aware.", "author": "gino-m", "createdAt": "2020-03-13T16:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyNDQzMg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r392324432", "bodyText": "LayoutInflater inflater = LayoutInflater.from(context); can be used here instead.", "author": "gino-m", "createdAt": "2020-03-13T16:08:26Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoView.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.content.Context;\n+import android.net.Uri;\n+import android.util.AttributeSet;\n+import android.view.LayoutInflater;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.PhotoViewBinding;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.material.card.MaterialCardView;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+\n+public class PhotoView extends MaterialCardView {\n+\n+  private final PhotoViewBinding binding;\n+\n+  @Inject StorageManager storageManager;\n+\n+  @Nullable private Response response;\n+\n+  public PhotoView(Context context) {\n+    this(context, null);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs) {\n+    this(context, attrs, 0);\n+  }\n+\n+  public PhotoView(Context context, AttributeSet attrs, int defStyleAttr) {\n+    super(context, attrs, defStyleAttr);\n+\n+    LayoutInflater inflater =\n+        (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMTcyNQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393301725", "bodyText": "This method is UI-specific so should probably be defined in the UI layer (e.g., the Fragment) or related helper.", "author": "gino-m", "createdAt": "2020-03-16T20:48:42Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -82,7 +78,7 @@ private Completable sendPhotoPickerIntent() {\n                   Intent intent = new Intent(Intent.ACTION_GET_CONTENT);\n                   intent.setType(\"image/*\");\n                   activity.startActivityForResult(intent, PICK_PHOTO_REQUEST_CODE);\n-                  Log.d(TAG, \"file picker intent sent\");\n+                  Timber.d(\"file picker intent sent\");", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDM5Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393350397", "bodyText": "Added a TODO for future refactoring", "author": "shobhitagarwal1612", "createdAt": "2020-03-16T22:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMTcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMjY0Ng==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393302646", "bodyText": "Sorry if I mentioned it before, but this probably won't work. Since you need to properly manage the returned disposable, we only subscribe to streams in lifecycle-aware contexts like Fragments. The right thing to do here I believe, would be to return a Single, which can be created using RxTask.", "author": "gino-m", "createdAt": "2020-03-16T20:50:35Z", "path": "gnd/src/main/java/com/google/android/gnd/system/StorageManager.java", "diffHunk": "@@ -120,35 +116,24 @@ private File getLocalFileFromDestinationPath(String destinationPath)\n     return fileUtil.getFile(splits[splits.length - 1]);\n   }\n \n+  private Uri getFileUriFromDestinationPath(String destinationPath) throws FileNotFoundException {\n+    File file = getLocalFileFromDestinationPath(destinationPath);\n+    return Uri.fromFile(file);\n+  }\n+\n   /**\n    * Load photo from the provided destination path.\n    *\n    * <p>If the image is not uploaded yet, then parse the filename from path and load the file from\n    * local storage.\n    *\n-   * @param imageView Placeholder for photo field\n    * @param destinationPath Destination path of the uploaded photo\n    */\n-  public void loadPhotoFromDestinationPath(ImageView imageView, String destinationPath) {\n+  public void loadPhotoFromDestinationPath(String destinationPath, Callback callback) {\n     firestoreStorageManager\n         .getDownloadUrl(destinationPath)\n-        .doOnSuccess(\n-            uri -> {\n-              // Load the file from Firestore Storage\n-              Picasso.get()\n-                  .load(uri)\n-                  .placeholder(R.drawable.ic_photo_grey_600_24dp)\n-                  .into(imageView);\n-            })\n-        .doOnError(\n-            throwable -> {\n-              // Load file locally\n-              File file = getLocalFileFromDestinationPath(destinationPath);\n-              Picasso.get()\n-                  .load(file)\n-                  .placeholder(R.drawable.ic_photo_grey_600_24dp)\n-                  .into(imageView);\n-            })\n+        .doOnSuccess(callback::run)\n+        .doOnError(throwable -> callback.run(getFileUriFromDestinationPath(destinationPath)))\n         .subscribe();", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDU3NA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393350574", "bodyText": "Thanks for catching this! This simplified the code greatly.", "author": "shobhitagarwal1612", "createdAt": "2020-03-16T22:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMjY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMzU1OA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393303558", "bodyText": "It's probably my fault for being vague in previous comments, but we're generally trying to avoid creating custom Views unless absolutely necessary, since they're hard to test and easy to get wrong (as you discovered)! Instead, could this view be reduced to a layout xml that can be included in the photo_input_field layout, which in turn gets added by the Fragment?", "author": "gino-m", "createdAt": "2020-03-16T20:52:18Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/photoview/PhotoView.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.google.android.gnd.ui.common.photoview;\n+\n+import android.content.Context;\n+import android.net.Uri;\n+import android.util.AttributeSet;\n+import android.view.LayoutInflater;\n+import androidx.fragment.app.Fragment;\n+import com.google.android.gnd.databinding.PhotoViewBinding;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.material.card.MaterialCardView;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+\n+public class PhotoView extends MaterialCardView {", "originalCommit": "eb9c85c81d3c1d25456bfcbb421411820aefb4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDcxNA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393350714", "bodyText": "Thanks for the idea. It all looks better than the first approach I took.", "author": "shobhitagarwal1612", "createdAt": "2020-03-16T22:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwMzU1OA=="}], "type": "inlineReview"}, {"oid": "a1b025dbc57527c958110c02f130d7433537aec7", "url": "https://github.com/google/ground-android/commit/a1b025dbc57527c958110c02f130d7433537aec7", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-16T20:52:36Z", "type": "commit"}, {"oid": "a28bd38a3d1183250835670dba54bcfdbe812faf", "url": "https://github.com/google/ground-android/commit/a28bd38a3d1183250835670dba54bcfdbe812faf", "message": "Attach layout to parent\n\nThis was the culprit for the view not getting updated :(", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "56b19d77860bfdf1ff945860b5aad2f1b4ad014f", "url": "https://github.com/google/ground-android/commit/56b19d77860bfdf1ff945860b5aad2f1b4ad014f", "message": "Load photo into ObservationDetailsFragment", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "9693cf2bf4eb659e3bc8589b35dc380d5825d0ab", "url": "https://github.com/google/ground-android/commit/9693cf2bf4eb659e3bc8589b35dc380d5825d0ab", "message": "Create a separate PhotoViewViewModel for each field", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "612ed5ed6822200800404c0445730d55aefc2e57", "url": "https://github.com/google/ground-android/commit/612ed5ed6822200800404c0445730d55aefc2e57", "message": "Remove redundant null check", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "38093ec706149ffe3c265c4dff6acc4ced5896af", "url": "https://github.com/google/ground-android/commit/38093ec706149ffe3c265c4dff6acc4ced5896af", "message": "Replace Callback with Rx", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "7397ff82d1459263a61fa4987bed144c03065f28", "url": "https://github.com/google/ground-android/commit/7397ff82d1459263a61fa4987bed144c03065f28", "message": "PhotoViewViewModel -> PhotoFieldViewModel", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "c276910c9676b265a1cef5ca5825d4b4927c2d8b", "url": "https://github.com/google/ground-android/commit/c276910c9676b265a1cef5ca5825d4b4927c2d8b", "message": "Use LiveData instead of ObservableInt and rename field name", "committedDate": "2020-03-16T22:38:27Z", "type": "commit"}, {"oid": "1a3ef1a9f611ee1a871ae5069d3de2dadb3abbc9", "url": "https://github.com/google/ground-android/commit/1a3ef1a9f611ee1a871ae5069d3de2dadb3abbc9", "message": "Add for future refactoring", "committedDate": "2020-03-16T22:38:28Z", "type": "commit"}, {"oid": "1a9f6bb73d75193d7ef7aa15f233f347af401502", "url": "https://github.com/google/ground-android/commit/1a9f6bb73d75193d7ef7aa15f233f347af401502", "message": "Add views from photo_view to photo_input_field", "committedDate": "2020-03-16T22:38:28Z", "type": "commit"}, {"oid": "5cc6198a930f48bdee8145efa6541531e3922f0b", "url": "https://github.com/google/ground-android/commit/5cc6198a930f48bdee8145efa6541531e3922f0b", "message": "Remove custom view", "committedDate": "2020-03-16T22:38:28Z", "type": "commit"}, {"oid": "08350598737ac98c35af9153ea826ec82dc78c66", "url": "https://github.com/google/ground-android/commit/08350598737ac98c35af9153ea826ec82dc78c66", "message": "Move PhotoFieldViewModel into editobservation package", "committedDate": "2020-03-16T22:38:28Z", "type": "commit"}, {"oid": "611cc98cffb339123c53124278a24b029990a5b3", "url": "https://github.com/google/ground-android/commit/611cc98cffb339123c53124278a24b029990a5b3", "message": "CheckCode fixes", "committedDate": "2020-03-16T22:38:28Z", "type": "commit"}, {"oid": "95ac556683efadcdc077cabe3fd7b356fc1b103e", "url": "https://github.com/google/ground-android/commit/95ac556683efadcdc077cabe3fd7b356fc1b103e", "message": "Fix comments", "committedDate": "2020-03-16T22:42:58Z", "type": "commit"}, {"oid": "1e71bdf5515f7e89b0e93815e9935c39071aab46", "url": "https://github.com/google/ground-android/commit/1e71bdf5515f7e89b0e93815e9935c39071aab46", "message": "Remove unused change", "committedDate": "2020-03-16T22:46:45Z", "type": "commit"}, {"oid": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "url": "https://github.com/google/ground-android/commit/df8cf46086a03c08f384ffc47bf651eff228ddf4", "message": "Improve method name", "committedDate": "2020-03-16T22:48:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3MjIzMA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393772230", "bodyText": "Do we need to handle error states here? Will failing to load the URI cause the application to crash?", "author": "gino-m", "createdAt": "2020-03-17T15:38:47Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/BindingAdapters.java", "diffHunk": "@@ -118,4 +126,9 @@ public static void setOnFocusChangeListener(\n   public static void setOnShowDialogListener(MultipleChoiceFieldLayout view, Runnable listener) {\n     view.setOnShowDialogListener(listener);\n   }\n+\n+  @BindingAdapter(\"imageUri\")\n+  public static void bindUri(ImageView view, Uri uri) {\n+    Picasso.get().load(uri).placeholder(R.drawable.ic_photo_grey_600_24dp).into(view);", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MTU0Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393791547", "bodyText": "No, that's why we have a placeholder. If anything unexpected happens, the app doesn't crash and the imageview just displays placeholder.\nI tested network not available and null cases", "author": "shobhitagarwal1612", "createdAt": "2020-03-17T16:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3MjIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MjQ2Mg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393792462", "bodyText": "Great, thanks for checking! Could you kindly add a comment for posterity since it's not obvious at first glance?", "author": "gino-m", "createdAt": "2020-03-17T16:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3MjIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3MzY2Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393773667", "bodyText": "Naming nit: Our classes follow the pattern FooView and FooViewModel, which would make this class here \"PhotoViewModel\". To make it clear this is specifically a photo in a form field, PhotoFieldView and PhotoFieldViewModel might be more appropriate.", "author": "gino-m", "createdAt": "2020-03-17T15:40:43Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/common/ViewModelModule.java", "diffHunk": "@@ -96,6 +97,11 @@\n   @ViewModelKey(EditObservationViewModel.class)\n   abstract ViewModel bindEditObservationViewModel(EditObservationViewModel viewModel);\n \n+  @Binds\n+  @IntoMap\n+  @ViewModelKey(PhotoFieldViewModel.class)\n+  abstract ViewModel bindPhotoViewViewModel(PhotoFieldViewModel viewModel);", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3NjAyMA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393776020", "bodyText": "Nit: Please use a more specific method name like updateField. In general avoid capital case in Java method names (updateUi instead of updateUI).", "author": "gino-m", "createdAt": "2020-03-17T15:43:29Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoFieldViewModel.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.net.Uri;\n+import android.view.View;\n+import androidx.databinding.ObservableMap;\n+import androidx.databinding.ObservableMap.OnMapChangedCallback;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import javax.inject.Inject;\n+\n+public class PhotoFieldViewModel extends AbstractViewModel {\n+\n+  private final StorageManager storageManager;\n+  private final MutableLiveData<Uri> destinationPath = new MutableLiveData<>();\n+  private final MutableLiveData<Integer> photoPreviewVisibility = new MutableLiveData<>(View.GONE);\n+\n+  @Inject\n+  PhotoFieldViewModel(StorageManager storageManager) {\n+    this.storageManager = storageManager;\n+  }\n+\n+  public LiveData<Uri> getDestinationPath() {\n+    return destinationPath;\n+  }\n+\n+  public MutableLiveData<Integer> photoPreviewVisibility() {\n+    return photoPreviewVisibility;\n+  }\n+\n+  public void init(Field field, ObservableMap<String, Response> responses) {\n+    // Load last saved value\n+    updateUI(responses.get(field.getId()), field);\n+\n+    // Observe response updates\n+    responses.addOnMapChangedCallback(\n+        new OnMapChangedCallback<ObservableMap<String, Response>, String, Response>() {\n+          @Override\n+          public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n+            if (key.equals(field.getId())) {\n+              updateUI(sender.get(key), field);\n+            }\n+          }\n+        });\n+  }\n+\n+  private void updateUI(Response response, Field field) {", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393779232", "bodyText": "This will accumulate subscriptions in the viewmodel ad infinitum every time a photo is changed during the viewmodel's lifecycle. That's probably ok in practice since the user will never likely do this so many times we'll run out of memory, but it is a form of memory leak that as a general rule we're designing to avoid.\nThe \"right\", safe way to do this would be to create a PublishSubject<Optional<String>> destinationPath class member that emits the path or empty when this method is called. Then in the constructor, you would define LiveData<Optional<Uri>> uri using something like:\n  this.uri = LiveDataReactiveStreams.fromPublisher(\n    destinationPath.switchMap(path -> path.map(storageManager::loadUriFromDestinationPath).orElse(Observable.of(Optional.empty()))));\nVisibility could be defined in a similar way:\n  this.uri = LiveDataReactiveStreams.fromPublisher(\n    destinationPath.map(path -> path.isPresent() ? View..VISIBLE : View.GONE));\nThis method would then simply call destinationPath.onNext with either Optional.empty() or the URI.\nWdyt?", "author": "gino-m", "createdAt": "2020-03-17T15:47:45Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoFieldViewModel.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.net.Uri;\n+import android.view.View;\n+import androidx.databinding.ObservableMap;\n+import androidx.databinding.ObservableMap.OnMapChangedCallback;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import javax.inject.Inject;\n+\n+public class PhotoFieldViewModel extends AbstractViewModel {\n+\n+  private final StorageManager storageManager;\n+  private final MutableLiveData<Uri> destinationPath = new MutableLiveData<>();\n+  private final MutableLiveData<Integer> photoPreviewVisibility = new MutableLiveData<>(View.GONE);\n+\n+  @Inject\n+  PhotoFieldViewModel(StorageManager storageManager) {\n+    this.storageManager = storageManager;\n+  }\n+\n+  public LiveData<Uri> getDestinationPath() {\n+    return destinationPath;\n+  }\n+\n+  public MutableLiveData<Integer> photoPreviewVisibility() {\n+    return photoPreviewVisibility;\n+  }\n+\n+  public void init(Field field, ObservableMap<String, Response> responses) {\n+    // Load last saved value\n+    updateUI(responses.get(field.getId()), field);\n+\n+    // Observe response updates\n+    responses.addOnMapChangedCallback(\n+        new OnMapChangedCallback<ObservableMap<String, Response>, String, Response>() {\n+          @Override\n+          public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n+            if (key.equals(field.getId())) {\n+              updateUI(sender.get(key), field);\n+            }\n+          }\n+        });\n+  }\n+\n+  private void updateUI(Response response, Field field) {\n+    if (response == null) {\n+      photoPreviewVisibility.setValue(View.GONE);\n+    } else {\n+      String value = response.getDetailsText(field);\n+      if (value.isEmpty()) {\n+        photoPreviewVisibility.setValue(View.GONE);\n+      } else {\n+        photoPreviewVisibility.setValue(View.VISIBLE);\n+        disposeOnClear(", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5ODM1MQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393798351", "bodyText": "Looks so clean. \u2728", "author": "shobhitagarwal1612", "createdAt": "2020-03-17T16:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5OTEzOQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393799139", "bodyText": "\ud83c\udf1f", "author": "gino-m", "createdAt": "2020-03-17T16:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1Njg3NA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393856874", "bodyText": "I am having a hard time creating the uri LiveData object.\nFor visibility, the below code works\n    photoPreviewVisibility =\n        LiveDataReactiveStreams.fromPublisher(\n            destinationPath\n                .map(path -> path.isPresent() ? View.VISIBLE : View.GONE)\n                .toFlowable(BackpressureStrategy.LATEST));\n\nBut for Uri, I can't get the correct RxChain\nloadUriFromDestinationPath(path) returns Single<Uri>", "author": "shobhitagarwal1612", "createdAt": "2020-03-17T17:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg2NzAzOQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393867039", "bodyText": "If you replace destinationPath with a PublishProcessor you can get rid of the .toFlowable. Looking into the right syntax for your case now.", "author": "gino-m", "createdAt": "2020-03-17T17:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg3NDQxNQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393874415", "bodyText": "Sorry, forgot to mention that after the refactor loadUriFromDestinationPath could now be misleading - it doesn't actually load any data, it just gets the download URL, so it should probably be renamed accordingly (getDownloadUrl could work!)", "author": "gino-m", "createdAt": "2020-03-17T18:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg4NDQ3Ng==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393884476", "bodyText": "I'd probably do this:\n  private final LiveData<Uri> uri;\n  private final BehaviorProcessor<String> destinationPath = BehaviorProcessor.create();\n\n  @Inject\n  PhotoFieldViewModel(StorageManager storageManager) {\n    this.storageManager = storageManager;\n    this.uri =\n        LiveDataReactiveStreams.fromPublisher(\n            destinationPath.switchMapSingle(this::getDownloadUrl));\n  }\n\n  private Single<Uri> getDownloadUrl(String path) {\n    return path.isEmpty() ? Single.just(Uri.EMPTY) : storageManager.getDownloadUrl(path);\n  }\nA few things to note:\n\nUri and String already have non-null representations of an \"empty\" state, so using those instead of introducing another edge state with Optional simplifies this logic. The binding may need to be updated to handle this case.\nUse switchMapSingle to introduce a single into the stream\nUse *Processor to get a Flowable straight away\nUsing BehaviorProcessor to cache the last value. Late subscribers will get the last value of the Uri.\n\nHTH!", "author": "gino-m", "createdAt": "2020-03-17T18:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk2NTg5Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393965897", "bodyText": "To be precise, I can't convert Single to Optional in the below chain. The only way I can think of doing it in the below code is by subscribing loadUriFromDestinationPath inside map but that would defeat the entire purpose of this refactor.\n    uri =\n        LiveDataReactiveStreams.fromPublisher(\n            Flowable.fromPublisher(destinationPath)\n                .map(Optional::get)\n                .map(storageManager::loadUriFromDestinationPath));", "author": "shobhitagarwal1612", "createdAt": "2020-03-17T20:57:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTgwNg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393779806", "bodyText": "I'm a bit confused by the naming here - it appears Uris are loaded from destination paths, therefore they're not equivalent. If that's the case, shouldn't this be called uri instead?", "author": "gino-m", "createdAt": "2020-03-17T15:48:29Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/PhotoFieldViewModel.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.ui.editobservation;\n+\n+import android.net.Uri;\n+import android.view.View;\n+import androidx.databinding.ObservableMap;\n+import androidx.databinding.ObservableMap.OnMapChangedCallback;\n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.MutableLiveData;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.observation.Response;\n+import com.google.android.gnd.system.StorageManager;\n+import com.google.android.gnd.ui.common.AbstractViewModel;\n+import javax.inject.Inject;\n+\n+public class PhotoFieldViewModel extends AbstractViewModel {\n+\n+  private final StorageManager storageManager;\n+  private final MutableLiveData<Uri> destinationPath = new MutableLiveData<>();", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5ODg1Nw==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393798857", "bodyText": "My bad, thanks for pointing it out", "author": "shobhitagarwal1612", "createdAt": "2020-03-17T16:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5OTU4MA==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393799580", "bodyText": "Np! Thanks for all the careful code hygiene overall!", "author": "gino-m", "createdAt": "2020-03-17T16:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc3OTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc4NjA2MQ==", "url": "https://github.com/google/ground-android/pull/386#discussion_r393786061", "bodyText": "Same here - subscriptions should only be made inside lifecycle methods so they can be properly disposed of in their equivalent end lifecycle methods. To do this safely, you can create a PublishSubject in the view model that gets exposed to the fragment as a LiveData. Let's discuss if it's not clear how to do this here.", "author": "gino-m", "createdAt": "2020-03-17T15:56:40Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/observationdetails/ObservationDetailsFragment.java", "diffHunk": "@@ -159,7 +163,18 @@ private void addField(Field field, Observation observation) {\n                 binding.fieldValue.setVisibility(View.GONE);\n                 binding.imagePreview.setVisibility(View.VISIBLE);\n \n-                storageManager.loadPhotoFromDestinationPath(binding.imagePreview, value);\n+                storageManager", "originalCommit": "df8cf46086a03c08f384ffc47bf651eff228ddf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzNTExMg==", "url": "https://github.com/google/ground-android/pull/386#discussion_r394535112", "bodyText": "Added a TODO", "author": "shobhitagarwal1612", "createdAt": "2020-03-18T17:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc4NjA2MQ=="}], "type": "inlineReview"}, {"oid": "7cfa40e6a5528bfe6c8354acb2d4a6f7dca9a4ae", "url": "https://github.com/google/ground-android/commit/7cfa40e6a5528bfe6c8354acb2d4a6f7dca9a4ae", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-17T16:04:33Z", "type": "commit"}, {"oid": "27ed1c6473891a4c5a8559d68bab2bf7b7c820c3", "url": "https://github.com/google/ground-android/commit/27ed1c6473891a4c5a8559d68bab2bf7b7c820c3", "message": "Naming nits", "committedDate": "2020-03-18T17:47:58Z", "type": "commit"}, {"oid": "1f9f643e2176f598b8ecaa8e7c297a36169ab99b", "url": "https://github.com/google/ground-android/commit/1f9f643e2176f598b8ecaa8e7c297a36169ab99b", "message": "Refactor VM using LiveData and BehaviorProcessor\n\nThanks Gino :)", "committedDate": "2020-03-18T17:47:58Z", "type": "commit"}, {"oid": "5aa4eeeb5ab6ddf409f53ff68453b8cff57b532b", "url": "https://github.com/google/ground-android/commit/5aa4eeeb5ab6ddf409f53ff68453b8cff57b532b", "message": "TODO added for future refactoring", "committedDate": "2020-03-18T17:52:13Z", "type": "commit"}, {"oid": "f68ca3bfab6caa93be8c5116741f5c31a4189599", "url": "https://github.com/google/ground-android/commit/f68ca3bfab6caa93be8c5116741f5c31a4189599", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-18T17:52:46Z", "type": "commit"}, {"oid": "282d85fe0ae576b7963a6f5261372ab8ecfa0542", "url": "https://github.com/google/ground-android/commit/282d85fe0ae576b7963a6f5261372ab8ecfa0542", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-18T18:28:36Z", "type": "commit"}, {"oid": "9aba62ea687cfe25e877f20e54e3264d01529c0c", "url": "https://github.com/google/ground-android/commit/9aba62ea687cfe25e877f20e54e3264d01529c0c", "message": "Merge branch 'master' into upload-photos-ui", "committedDate": "2020-03-18T18:59:07Z", "type": "commit"}, {"oid": "d71e42debee783ca47288fce33f5b9497d9c6eea", "url": "https://github.com/google/ground-android/commit/d71e42debee783ca47288fce33f5b9497d9c6eea", "message": "Invert if-else", "committedDate": "2020-03-18T19:06:35Z", "type": "commit"}]}