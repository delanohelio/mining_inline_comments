{"pr_number": 345, "pr_title": "[Photos Support] Upload photos to firebase storage", "pr_createdAt": "2020-02-05T14:52:08Z", "pr_url": "https://github.com/google/ground-android/pull/345", "timeline": [{"oid": "4fa324e5b01d24faa5e5d27e4169386493ca77f0", "url": "https://github.com/google/ground-android/commit/4fa324e5b01d24faa5e5d27e4169386493ca77f0", "message": "Upload added photo to firestore", "committedDate": "2020-02-03T17:15:02Z", "type": "commit"}, {"oid": "a14a23a5dff5dc3b7c46803346b471f65b19baf6", "url": "https://github.com/google/ground-android/commit/a14a23a5dff5dc3b7c46803346b471f65b19baf6", "message": "Remove timestamp suffix from filenames", "committedDate": "2020-02-03T17:53:10Z", "type": "commit"}, {"oid": "3d6492734e3448778a4e789144b72db90035ce24", "url": "https://github.com/google/ground-android/commit/3d6492734e3448778a4e789144b72db90035ce24", "message": "Return final destination url instead of local file path", "committedDate": "2020-02-04T12:43:00Z", "type": "commit"}, {"oid": "6f63655071121aefd410083838cf2eb615436cf1", "url": "https://github.com/google/ground-android/commit/6f63655071121aefd410083838cf2eb615436cf1", "message": "Load photo from firestore and fallback to local storage", "committedDate": "2020-02-05T13:41:52Z", "type": "commit"}, {"oid": "84d34fd40f94868c90e3e01ad6a4b8430b446b88", "url": "https://github.com/google/ground-android/commit/84d34fd40f94868c90e3e01ad6a4b8430b446b88", "message": "Upload media to project>form>feature dir", "committedDate": "2020-02-05T14:51:06Z", "type": "commit"}, {"oid": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "url": "https://github.com/google/ground-android/commit/7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "message": "Code cleanup", "committedDate": "2020-02-05T14:59:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzNjgzOQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375536839", "bodyText": "Can we instead inject FirebaseStorage or StorageReference to make it mockable in tests?", "author": "gino-m", "createdAt": "2020-02-05T22:10:43Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/FirestoreStorageManager.java", "diffHunk": "@@ -39,20 +35,18 @@\n \n   private static final String TAG = FirestoreStorageManager.class.getName();\n   private static final String MEDIA_ROOT_DIR = \"uploaded_media\";\n-  private final SimpleDateFormat dateFormat =\n-      new SimpleDateFormat(\"yyyyMMddHHmmss\", Locale.getDefault());\n \n   @Inject\n   FirestoreStorageManager() {}\n \n   /** Returns a reference to the default Storage bucket. */\n-  private FirebaseStorage getStorage() {\n-    return FirebaseStorage.getInstance();\n+  private StorageReference getBaseReference() {\n+    return FirebaseStorage.getInstance().getReference();", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzNzkyOQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375537929", "bodyText": "Please use the util class RxTask.toMaybe() instead.", "author": "gino-m", "createdAt": "2020-02-05T22:13:26Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/FirestoreStorageManager.java", "diffHunk": "@@ -61,34 +55,27 @@ private StorageReference getRootMediaDir() {\n    * @param fileName Name of the uploaded media\n    */\n   private StorageReference createReference(String fileName) {\n-    return getRootMediaDir().child(fileName + '-' + getFilenameSuffix());\n+    return getRootMediaDir().child(fileName);\n   }\n \n-  /** Converts current timestamp to a string to be used a suffix for uploading media. */\n-  private String getFilenameSuffix() {\n-    return dateFormat.format(new Date());\n+  public Maybe<Uri> getDownloadUrl(String path) {\n+    return Maybe.create(\n+        emitter ->", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4OTcyMQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r376689721", "bodyText": "This can't be used here as the Uri is fetched asynchronously.", "author": "shobhitagarwal1612", "createdAt": "2020-02-08T05:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzNzkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzODE5Mg==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375538192", "bodyText": "What's the difference between file and fileName? Please rename to something self explanatory and/or explain in JavaDoc.", "author": "gino-m", "createdAt": "2020-02-05T22:14:05Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/FirestoreStorageManager.java", "diffHunk": "@@ -61,34 +55,27 @@ private StorageReference getRootMediaDir() {\n    * @param fileName Name of the uploaded media\n    */\n   private StorageReference createReference(String fileName) {\n-    return getRootMediaDir().child(fileName + '-' + getFilenameSuffix());\n+    return getRootMediaDir().child(fileName);\n   }\n \n-  /** Converts current timestamp to a string to be used a suffix for uploading media. */\n-  private String getFilenameSuffix() {\n-    return dateFormat.format(new Date());\n+  public Maybe<Uri> getDownloadUrl(String path) {\n+    return Maybe.create(\n+        emitter ->\n+            getBaseReference()\n+                .child(path)\n+                .getDownloadUrl()\n+                .addOnSuccessListener(emitter::onSuccess)\n+                .addOnFailureListener(emitter::onError));\n   }\n \n   /** Upload file to Firebase Storage. */\n-  public void uploadMediaFromFile(File file, String fileName) {\n+  public String uploadMediaFromFile(File file, String fileName) {", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzODYyMQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375538621", "bodyText": "Please add JavaDoc describing this method's behavior.", "author": "gino-m", "createdAt": "2020-02-05T22:15:11Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -199,12 +201,25 @@ public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n   }\n \n   private void updateBitmap(ImageView imageView, String path) {", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzOTMyNQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375539325", "bodyText": "Do I understand correctly that we're currently relying on Firebase to manage offline support?\nIf so, can we add a TODO and a bug to implement our own offline photos functionality using Android Workers and the local db?", "author": "gino-m", "createdAt": "2020-02-05T22:16:56Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -238,10 +251,31 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n         .ignoreElements();\n   }\n \n-  private Observable<File> saveBitmapAndUpdateResponse(Observable<Bitmap> source, String fieldId) {\n+  private Observable<String> saveBitmapAndUpdateResponse(\n+      Observable<Bitmap> source, String fieldId) {\n     return source\n         .map(bitmap -> fileUtil.saveBitmap(bitmap, fieldId + \".jpg\"))\n-        .doOnNext(file -> onTextChanged(form.getValue().getField(fieldId).get(), file.getPath()));\n+        .map(\n+            file -> {\n+              // If offline, Firebase will automatically upload the image when the network\n+              // connectivity is  re-established.\n+              String remotePath = getRemoteImageDir() + file.getName();\n+              return firestoreStorageManager.uploadMediaFromFile(file, remotePath);", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0MTY0Ng==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375541646", "bodyText": "Alternatively, you can recast  this as getRemoteImagePath(filename) and use:\nreturn String.join(File.separator, args.getProjectId(), args.getFormId(), filename);", "author": "gino-m", "createdAt": "2020-02-05T22:22:32Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -238,10 +251,31 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n         .ignoreElements();\n   }\n \n-  private Observable<File> saveBitmapAndUpdateResponse(Observable<Bitmap> source, String fieldId) {\n+  private Observable<String> saveBitmapAndUpdateResponse(\n+      Observable<Bitmap> source, String fieldId) {\n     return source\n         .map(bitmap -> fileUtil.saveBitmap(bitmap, fieldId + \".jpg\"))\n-        .doOnNext(file -> onTextChanged(form.getValue().getField(fieldId).get(), file.getPath()));\n+        .map(\n+            file -> {\n+              // If offline, Firebase will automatically upload the image when the network\n+              // connectivity is  re-established.\n+              String remotePath = getRemoteImageDir() + file.getName();\n+              return firestoreStorageManager.uploadMediaFromFile(file, remotePath);\n+            })\n+        .doOnNext(\n+            url -> {\n+              // update observable response map\n+              onTextChanged(form.getValue().getField(fieldId).get(), url);\n+            });\n+  }\n+\n+  private String getRemoteImageDir() {\n+    return args.getProjectId()", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0MjM4MA==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375542380", "bodyText": "=> getFile?", "author": "gino-m", "createdAt": "2020-02-05T22:24:21Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -52,14 +51,11 @@ public File saveBitmap(Bitmap bitmap, String filename) throws IOException {\n     return file;\n   }\n \n-  /** Load bitmap from a file path. */\n-  @Nullable\n-  public static Bitmap createBitmapFromPath(String path) {\n-    File file = new File(path);\n+  public File getFileFromFilename(String filename) throws FileNotFoundException {", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0Mjc4MQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375542781", "bodyText": "Refactor splitting filename into its own method, also for consistency with logic for building filename.", "author": "gino-m", "createdAt": "2020-02-05T22:25:18Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -199,12 +201,25 @@ public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n   }\n \n   private void updateBitmap(ImageView imageView, String path) {\n-    Bitmap bitmap = FileUtil.createBitmapFromPath(path);\n-    if (bitmap != null) {\n-      // TODO: Bitmap doesn't get loaded\n-      imageView.setImageBitmap(bitmap);\n-      Toast.makeText(getContext(), \"Photo added\", Toast.LENGTH_SHORT).show();\n-    }\n+    // TODO: Image doesn't load into the imageview\n+    viewModel\n+        .getFirestoreDownloadUrl(path)\n+        .observeOn(AndroidSchedulers.mainThread())\n+        .doOnSuccess(\n+            uri -> {\n+              // Load the file from firestore storage\n+              Picasso.get().load(uri).into(imageView);\n+            })\n+        .doOnError(\n+            throwable -> {\n+              // Load file locally\n+              String[] splits = path.split(\"/\");\n+              Picasso.get()\n+                  .load(fileUtil.getFileFromFilename(splits[splits.length - 1]))", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0MjgzOQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r375542839", "bodyText": "Replace \"/\" with File.separator.", "author": "gino-m", "createdAt": "2020-02-05T22:25:26Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationFragment.java", "diffHunk": "@@ -199,12 +201,25 @@ public void onMapChanged(ObservableMap<String, Response> sender, String key) {\n   }\n \n   private void updateBitmap(ImageView imageView, String path) {\n-    Bitmap bitmap = FileUtil.createBitmapFromPath(path);\n-    if (bitmap != null) {\n-      // TODO: Bitmap doesn't get loaded\n-      imageView.setImageBitmap(bitmap);\n-      Toast.makeText(getContext(), \"Photo added\", Toast.LENGTH_SHORT).show();\n-    }\n+    // TODO: Image doesn't load into the imageview\n+    viewModel\n+        .getFirestoreDownloadUrl(path)\n+        .observeOn(AndroidSchedulers.mainThread())\n+        .doOnSuccess(\n+            uri -> {\n+              // Load the file from firestore storage\n+              Picasso.get().load(uri).into(imageView);\n+            })\n+        .doOnError(\n+            throwable -> {\n+              // Load file locally\n+              String[] splits = path.split(\"/\");", "originalCommit": "7560afd16655ed6d5daa8e9c5bc0c58a40d54080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86a47c210a412e8246b5bf852629a59d36474522", "url": "https://github.com/google/ground-android/commit/86a47c210a412e8246b5bf852629a59d36474522", "message": "Add description about picasso", "committedDate": "2020-02-06T18:43:15Z", "type": "commit"}, {"oid": "b9f0fe87150e8ef3fd7e4f05a46fceb9b9734f56", "url": "https://github.com/google/ground-android/commit/b9f0fe87150e8ef3fd7e4f05a46fceb9b9734f56", "message": "Make storage reference injectable", "committedDate": "2020-02-06T18:43:30Z", "type": "commit"}, {"oid": "7fbf438e95bfca04f56cd162354b251b09a6728d", "url": "https://github.com/google/ground-android/commit/7fbf438e95bfca04f56cd162354b251b09a6728d", "message": "Apply suggestion from code review", "committedDate": "2020-02-08T05:23:47Z", "type": "commit"}, {"oid": "de1ae6f6e3912cf544fada530fd3509704df63b9", "url": "https://github.com/google/ground-android/commit/de1ae6f6e3912cf544fada530fd3509704df63b9", "message": "Spotbugs: File.separator can't be used in regex\npmd: fix comment", "committedDate": "2020-02-08T05:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NDAzMg==", "url": "https://github.com/google/ground-android/pull/345#discussion_r377184032", "bodyText": "Firestore != Firebase Storage; please rename to something more appropriate, e.g. firebaseStorageReference.", "author": "gino-m", "createdAt": "2020-02-10T16:48:03Z", "path": "gnd/src/main/java/com/google/android/gnd/GndApplicationModule.java", "diffHunk": "@@ -120,6 +122,13 @@ static FirebaseFirestore firebaseFirestore(FirebaseFirestoreSettings settings) {\n     return firestore;\n   }\n \n+  /** Returns a reference to the default Storage bucket. */\n+  @Provides\n+  @Singleton\n+  static StorageReference baseFirestoreReference() {", "originalCommit": "de1ae6f6e3912cf544fada530fd3509704df63b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjUzNw==", "url": "https://github.com/google/ground-android/pull/345#discussion_r377186537", "bodyText": "Are we filtering by JPG?\nAlso, is it possible to upload more than one image for a particular field? If so fieldId alone won't unique.", "author": "gino-m", "createdAt": "2020-02-10T16:51:39Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -238,10 +253,46 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n         .ignoreElements();\n   }\n \n-  private Observable<File> saveBitmapAndUpdateResponse(Observable<Bitmap> source, String fieldId) {\n+  private Observable<String> saveBitmapAndUpdateResponse(\n+      Observable<Bitmap> source, String fieldId) {\n     return source\n         .map(bitmap -> fileUtil.saveBitmap(bitmap, fieldId + \".jpg\"))\n-        .doOnNext(file -> onTextChanged(form.getValue().getField(fieldId).get(), file.getPath()));\n+        .map(", "originalCommit": "de1ae6f6e3912cf544fada530fd3509704df63b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1NzUzMA==", "url": "https://github.com/google/ground-android/pull/345#discussion_r377457530", "bodyText": "No, we save the bitmap as a .jpg file and that gets uploaded.\nCurrently, one field can have only one photo. So, the old one gets overwritten if re-uploaded.", "author": "shobhitagarwal1612", "createdAt": "2020-02-11T06:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc3MTk2MQ==", "url": "https://github.com/google/ground-android/pull/345#discussion_r377771961", "bodyText": "I think that's ok as a starting point. We can see if more are needed. Thanks!", "author": "gino-m", "createdAt": "2020-02-11T17:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc3MjQ1NA==", "url": "https://github.com/google/ground-android/pull/345#discussion_r377772454", "bodyText": "I also wonder if we'll get into trouble if users uploading PNG and GIF from their device - let's remember test this.", "author": "gino-m", "createdAt": "2020-02-11T17:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjUzNw=="}], "type": "inlineReview"}, {"oid": "255e8945c65fb9c0f70d02e6fcce082bfae12e86", "url": "https://github.com/google/ground-android/commit/255e8945c65fb9c0f70d02e6fcce082bfae12e86", "message": "Merge branch 'master' into upload_photos_to_firebase_storage", "committedDate": "2020-02-11T02:28:48Z", "type": "commit"}, {"oid": "6eb959cd5be5f3c7ddffcebb20c49bf184316543", "url": "https://github.com/google/ground-android/commit/6eb959cd5be5f3c7ddffcebb20c49bf184316543", "message": "Merge branch 'master' into upload_photos_to_firebase_storage", "committedDate": "2020-02-11T06:02:07Z", "type": "commit"}, {"oid": "19a4c7421d4be713175b231bac456ea75922ddc6", "url": "https://github.com/google/ground-android/commit/19a4c7421d4be713175b231bac456ea75922ddc6", "message": "Fix method name", "committedDate": "2020-02-11T06:07:34Z", "type": "commit"}]}