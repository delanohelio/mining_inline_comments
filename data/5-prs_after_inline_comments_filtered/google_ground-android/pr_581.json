{"pr_number": 581, "pr_title": "[Feature] Relocate point features", "pr_createdAt": "2020-10-12T07:36:32Z", "pr_url": "https://github.com/google/ground-android/pull/581", "timeline": [{"oid": "c47ea6353fb3c19fd3fe2180992035a017a95ab2", "url": "https://github.com/google/ground-android/commit/c47ea6353fb3c19fd3fe2180992035a017a95ab2", "message": "Add buttons for cancel/confirm actions", "committedDate": "2020-10-08T13:25:21Z", "type": "commit"}, {"oid": "422fb2181c43f9d3eedc1be4352ad8226b504745", "url": "https://github.com/google/ground-android/commit/422fb2181c43f9d3eedc1be4352ad8226b504745", "message": "Add vector images", "committedDate": "2020-10-08T13:25:41Z", "type": "commit"}, {"oid": "287212847eaaae242b85349ef00ab60cc0efe9bd", "url": "https://github.com/google/ground-android/commit/287212847eaaae242b85349ef00ab60cc0efe9bd", "message": "Add enum Mode to MapContainerViewModel\n\nalso reformat code and add getter/setter methods", "committedDate": "2020-10-08T13:26:44Z", "type": "commit"}, {"oid": "5d6826613f52cfd450b4db99231b6a0db9148bd4", "url": "https://github.com/google/ground-android/commit/5d6826613f52cfd450b4db99231b6a0db9148bd4", "message": "Observer changes to mode and update UI", "committedDate": "2020-10-08T13:27:09Z", "type": "commit"}, {"oid": "c2d70a24ce39f0ac7db489e61477e5e62e8b2b31", "url": "https://github.com/google/ground-android/commit/c2d70a24ce39f0ac7db489e61477e5e62e8b2b31", "message": "Hook overflow menu item with reposition mode", "committedDate": "2020-10-08T13:29:12Z", "type": "commit"}, {"oid": "e8571c946483dd219c957b4d727f01fff1bb45ce", "url": "https://github.com/google/ground-android/commit/e8571c946483dd219c957b4d727f01fff1bb45ce", "message": "Display confirmation dialog", "committedDate": "2020-10-12T05:26:44Z", "type": "commit"}, {"oid": "ac800a510cb68eb2724e96ad1d90991df74ce0a7", "url": "https://github.com/google/ground-android/commit/ac800a510cb68eb2724e96ad1d90991df74ce0a7", "message": "Add support for reposition to repository", "committedDate": "2020-10-12T06:46:53Z", "type": "commit"}, {"oid": "9731a6e5f508d72e89f4c4eba2258791a38163ec", "url": "https://github.com/google/ground-android/commit/9731a6e5f508d72e89f4c4eba2258791a38163ec", "message": "Hide added buttons by default", "committedDate": "2020-10-12T06:48:16Z", "type": "commit"}, {"oid": "4434533d3a4c760d29cd8dbe201106e79e4aa496", "url": "https://github.com/google/ground-android/commit/4434533d3a4c760d29cd8dbe201106e79e4aa496", "message": "Hook confirmation dialog action with update request", "committedDate": "2020-10-12T06:48:56Z", "type": "commit"}, {"oid": "03c8f90711d5ddb32f64ab26ae475b1a8cdad172", "url": "https://github.com/google/ground-android/commit/03c8f90711d5ddb32f64ab26ae475b1a8cdad172", "message": "Update string resources", "committedDate": "2020-10-12T07:16:49Z", "type": "commit"}, {"oid": "235ffa3063f140bca4bda5d24a5482b374f84e88", "url": "https://github.com/google/ground-android/commit/235ffa3063f140bca4bda5d24a5482b374f84e88", "message": "Add license header", "committedDate": "2020-10-12T07:18:29Z", "type": "commit"}, {"oid": "332dbd3a06745d63f2e4e3c73d6fc6ebecc7d0ee", "url": "https://github.com/google/ground-android/commit/332dbd3a06745d63f2e4e3c73d6fc6ebecc7d0ee", "message": "Remove obvious javadoc comments", "committedDate": "2020-10-12T07:18:54Z", "type": "commit"}, {"oid": "3089b7ee82120fbed6cef5d3f09deb908adbc3d7", "url": "https://github.com/google/ground-android/commit/3089b7ee82120fbed6cef5d3f09deb908adbc3d7", "message": "Update last modified time and update remote db", "committedDate": "2020-10-12T07:36:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxMTgzMg==", "url": "https://github.com/google/ground-android/pull/581#discussion_r503311832", "bodyText": "Is this the currently selected feature? If so we should call it as such to be clear.\nAlso, since the selected feature is accessible via public methods, let's use Optional<> instead of nullable to expose that API.", "author": "gino-m", "createdAt": "2020-10-12T13:53:13Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerViewModel.java", "diffHunk": "@@ -63,14 +65,18 @@\n   private final FeatureRepository featureRepository;\n   private final Subject<Boolean> locationLockChangeRequests;\n   private final Subject<CameraUpdate> cameraUpdateSubject;\n+  private final MutableLiveData<Mode> viewMode = new MutableLiveData<>(Mode.DEFAULT);\n   private final MutableLiveData<Event<Nil>> showMapTypeSelectorRequests = new MutableLiveData<>();\n   private final LiveData<ImmutableSet<String>> mbtilesFilePaths;\n+\n   // TODO: Create our own wrapper/interface for MbTiles providers\n   // The impl we're using unfortunately requires calling a `close` method explicitly\n   // to clean up provider resources; `close` however, is not defined by the `TileProvider`\n   // interface, preventing us from treating providers generically.\n   private final List<MapBoxOfflineTileProvider> tileProviders = new ArrayList<>();\n \n+  @Nullable private Feature feature;", "originalCommit": "3089b7ee82120fbed6cef5d3f09deb908adbc3d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxMzYwOQ==", "url": "https://github.com/google/ground-android/pull/581#discussion_r503313609", "bodyText": "Rather than setting the visibility or other dynamic states of view explicitly, we've started moving towards using data bindings on ViewModel. Would it be possible to expose the visibility of these elements in the corresponding ViewModel and binding to them in the layout XML?", "author": "gino-m", "createdAt": "2020-10-12T13:55:52Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -131,6 +135,32 @@ public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceStat\n     mapContainerViewModel\n         .getShowMapTypeSelectorRequests()\n         .observe(getViewLifecycleOwner(), __ -> showMapTypeSelectorDialog());\n+    mapContainerViewModel.getViewMode().observe(getViewLifecycleOwner(), this::updateUI);\n+  }\n+\n+  private void updateUI(Mode mode) {\n+    switch (mode) {\n+      case DEFAULT:\n+        binding.mapTypeBtn.setVisibility(View.VISIBLE);", "originalCommit": "3089b7ee82120fbed6cef5d3f09deb908adbc3d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNDQzOA==", "url": "https://github.com/google/ground-android/pull/581#discussion_r503314438", "bodyText": "Why do we only take the first feature in the map here?", "author": "gino-m", "createdAt": "2020-10-12T13:57:04Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -95,6 +101,27 @@\n         LiveDataReactiveStreams.fromPublisher(\n             deleteFeatureRequests.switchMapSingle(\n                 __ -> deleteActiveFeature().toSingleDefault(true).onErrorReturnItem(false)));\n+\n+    updateFeature =\n+        LiveDataReactiveStreams.fromPublisher(\n+            updateFeatureRequests.switchMapSingle(\n+                map -> updateFeaturePosition(map).toSingleDefault(true).onErrorReturnItem(false)));\n+  }\n+\n+  public void updateFeature(Feature feature, Point point) {\n+    HashMap<Feature, Point> map = new HashMap<>();\n+    map.put(feature, point);\n+    updateFeatureRequests.onNext(map);\n+  }\n+\n+  public LiveData<Boolean> getUpdateFeature() {\n+    return updateFeature;\n+  }\n+\n+  private Completable updateFeaturePosition(Map<Feature, Point> map) {\n+    Feature feature = map.keySet().iterator().next();", "originalCommit": "3089b7ee82120fbed6cef5d3f09deb908adbc3d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "181e805c3556ade15928af0b6befd5e366bd5f1f", "url": "https://github.com/google/ground-android/commit/181e805c3556ade15928af0b6befd5e366bd5f1f", "message": "Fix string labels", "committedDate": "2020-10-13T08:46:56Z", "type": "commit"}, {"oid": "a368765dc75cebdd5b6f8350c423c87488b3940d", "url": "https://github.com/google/ground-android/commit/a368765dc75cebdd5b6f8350c423c87488b3940d", "message": "Replace null checks with Optional", "committedDate": "2020-10-13T09:00:19Z", "type": "commit"}, {"oid": "e7fbc20a3ecd91fa6757c729c897ecb5302a7897", "url": "https://github.com/google/ground-android/commit/e7fbc20a3ecd91fa6757c729c897ecb5302a7897", "message": "Split xmls for default and reposition mode", "committedDate": "2020-10-13T11:44:12Z", "type": "commit"}, {"oid": "e626942d744dfe15a52d1067d35668dc61f64302", "url": "https://github.com/google/ground-android/commit/e626942d744dfe15a52d1067d35668dc61f64302", "message": "Use data binding for controlling visibility", "committedDate": "2020-10-13T11:44:41Z", "type": "commit"}, {"oid": "87ca30a8e6eb8d1f8898dfe83d34a8046314b6e4", "url": "https://github.com/google/ground-android/commit/87ca30a8e6eb8d1f8898dfe83d34a8046314b6e4", "message": "Replace iterator with completable", "committedDate": "2020-10-13T11:53:39Z", "type": "commit"}, {"oid": "f5a176e69d35d88bfb598be1234c4835314f6ad9", "url": "https://github.com/google/ground-android/commit/f5a176e69d35d88bfb598be1234c4835314f6ad9", "message": "Simplify success message", "committedDate": "2020-10-13T12:07:59Z", "type": "commit"}, {"oid": "ff0de0b2536dba8b440e3257c81f829dcbf6be78", "url": "https://github.com/google/ground-android/commit/ff0de0b2536dba8b440e3257c81f829dcbf6be78", "message": "Merge branch 'master' into issue-109", "committedDate": "2020-10-13T17:26:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5NzY4NA==", "url": "https://github.com/google/ground-android/pull/581#discussion_r504297684", "bodyText": "Please use ImmutableMap to ensure it can't be modified while in the stream.", "author": "gino-m", "createdAt": "2020-10-13T22:36:28Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -95,6 +102,27 @@\n         LiveDataReactiveStreams.fromPublisher(\n             deleteFeatureRequests.switchMapSingle(\n                 __ -> deleteActiveFeature().toSingleDefault(true).onErrorReturnItem(false)));\n+\n+    updateFeature =\n+        LiveDataReactiveStreams.fromPublisher(\n+            updateFeatureRequests.switchMapSingle(\n+                map -> updateFeaturePosition(map).toSingleDefault(true).onErrorReturnItem(false)));\n+  }\n+\n+  public void updateFeature(Feature feature, Point point) {\n+    HashMap<Feature, Point> map = new HashMap<>();", "originalCommit": "ff0de0b2536dba8b440e3257c81f829dcbf6be78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5ODM4Ng==", "url": "https://github.com/google/ground-android/pull/581#discussion_r504298386", "bodyText": "Why is this a Map and not just two args? If it's because you wanted to avoid a custom class to bind Feature and Point, you can just use the Feature with the updated position.", "author": "gino-m", "createdAt": "2020-10-13T22:38:32Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -95,6 +102,27 @@\n         LiveDataReactiveStreams.fromPublisher(\n             deleteFeatureRequests.switchMapSingle(\n                 __ -> deleteActiveFeature().toSingleDefault(true).onErrorReturnItem(false)));\n+\n+    updateFeature =\n+        LiveDataReactiveStreams.fromPublisher(\n+            updateFeatureRequests.switchMapSingle(\n+                map -> updateFeaturePosition(map).toSingleDefault(true).onErrorReturnItem(false)));\n+  }\n+\n+  public void updateFeature(Feature feature, Point point) {\n+    HashMap<Feature, Point> map = new HashMap<>();\n+    map.put(feature, point);\n+    updateFeatureRequests.onNext(map);\n+  }\n+\n+  public LiveData<Boolean> getUpdateFeature() {\n+    return updateFeature;\n+  }\n+\n+  private Completable updateFeaturePosition(Map<Feature, Point> map) {", "originalCommit": "ff0de0b2536dba8b440e3257c81f829dcbf6be78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI5ODc1Mw==", "url": "https://github.com/google/ground-android/pull/581#discussion_r504298753", "bodyText": "A better error might be \"No feature selected\", since it described why we might be in this state.", "author": "gino-m", "createdAt": "2020-10-13T22:39:34Z", "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -147,12 +152,40 @@ private void onMapReady(MapAdapter map) {\n     homeScreenViewModel\n         .getBottomSheetState()\n         .observe(this, state -> onBottomSheetStateChange(state, map));\n-    binding.addFeatureBtn.setOnClickListener(\n+    binding.mapControls.addFeatureBtn.setOnClickListener(\n         __ -> homeScreenViewModel.onAddFeatureBtnClick(map.getCameraTarget()));\n+    binding.moveFeature.confirmButton.setOnClickListener(\n+        __ -> showConfirmationDialog(map.getCameraTarget()));\n+    binding.moveFeature.cancelButton.setOnClickListener(__ -> cancelRepositionMode());\n     enableLocationLockBtn();\n     mapContainerViewModel.getMbtilesFilePaths().observe(this, map::addTileOverlays);\n   }\n \n+  private void showConfirmationDialog(Point point) {\n+    new Builder(getContext())\n+        .setTitle(R.string.move_point_confirmation)\n+        .setPositiveButton(android.R.string.ok, (dialog, which) -> moveToNewPosition(point))\n+        .setNegativeButton(android.R.string.cancel, (dialog, which) -> cancelRepositionMode())\n+        .setCancelable(true)\n+        .create()\n+        .show();\n+  }\n+\n+  private void moveToNewPosition(Point point) {\n+    mapContainerViewModel\n+        .getSelectedFeature()\n+        .ifPresentOrElse(\n+            feature -> {\n+              homeScreenViewModel.updateFeature(feature, point);\n+              setDefaultMode();\n+            },\n+            () -> Timber.e(\"Feature is null, can't move to new position\"));", "originalCommit": "ff0de0b2536dba8b440e3257c81f829dcbf6be78", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c08c156622f20b75efa70ffbbd112602c1ea2ee", "url": "https://github.com/google/ground-android/commit/4c08c156622f20b75efa70ffbbd112602c1ea2ee", "message": "Code cleanup", "committedDate": "2020-10-15T09:39:51Z", "type": "commit"}, {"oid": "07516b7dba2bacf2ccd840d9278e10e8c871287e", "url": "https://github.com/google/ground-android/commit/07516b7dba2bacf2ccd840d9278e10e8c871287e", "message": "Use key \"location\" instead of \"created\" for point location", "committedDate": "2020-10-15T10:06:51Z", "type": "commit"}, {"oid": "e7dcccf846ee313346de043f7675d61aa7a3cea7", "url": "https://github.com/google/ground-android/commit/e7dcccf846ee313346de043f7675d61aa7a3cea7", "message": "Remove single-line method with inline", "committedDate": "2020-10-15T10:15:08Z", "type": "commit"}, {"oid": "3515e152100505605dc6aa9a8b953fa8ca36139c", "url": "https://github.com/google/ground-android/commit/3515e152100505605dc6aa9a8b953fa8ca36139c", "message": "Merge branch 'master' into issue-109", "committedDate": "2020-10-15T13:32:13Z", "type": "commit"}, {"oid": "3b4eaefc44dd9ccac2afca3b0aa5bc24176bc907", "url": "https://github.com/google/ground-android/commit/3b4eaefc44dd9ccac2afca3b0aa5bc24176bc907", "message": "Merge branch 'master' into issue-109", "committedDate": "2020-10-15T14:31:45Z", "type": "commit"}, {"oid": "226c329ad20be421cbc2ceec97ac25f9e052dc29", "url": "https://github.com/google/ground-android/commit/226c329ad20be421cbc2ceec97ac25f9e052dc29", "message": "Merge branch 'master' into issue-109", "committedDate": "2020-10-15T15:53:43Z", "type": "commit"}, {"oid": "c974a889533eee5c9edae39a7bb950fd31f2627d", "url": "https://github.com/google/ground-android/commit/c974a889533eee5c9edae39a7bb950fd31f2627d", "message": "Convert featureRepository to a local variable", "committedDate": "2020-10-15T19:13:50Z", "type": "commit"}]}