{"pr_number": 522, "pr_title": "[Manage observations] Add ability to remove observations", "pr_createdAt": "2020-07-04T11:03:49Z", "pr_url": "https://github.com/google/ground-android/pull/522", "timeline": [{"oid": "40eea3341ac36111fee65342b5a92cfe99c44efd", "url": "https://github.com/google/ground-android/commit/40eea3341ac36111fee65342b5a92cfe99c44efd", "message": "Change ActivityScoped to Singleton", "committedDate": "2020-07-09T16:24:48Z", "type": "commit"}, {"oid": "8f9966ea07e6914c7ed96ab359d302fb53b89f01", "url": "https://github.com/google/ground-android/commit/8f9966ea07e6914c7ed96ab359d302fb53b89f01", "message": "Implement DELETE mutation handling in firestore", "committedDate": "2020-07-09T16:24:48Z", "type": "commit"}, {"oid": "b9c778b878bbc5358744e1d72dfdd94b8886d2d7", "url": "https://github.com/google/ground-android/commit/b9c778b878bbc5358744e1d72dfdd94b8886d2d7", "message": "Add deleteObservation() method in ObservationRepository\n\n - Creates mutation in the local database\n - Enqueues worker\n - Replace Log -> Timber", "committedDate": "2020-07-09T16:25:51Z", "type": "commit"}, {"oid": "7db2c4a00ffc42ab89d61217a0b04b4ed32164b5", "url": "https://github.com/google/ground-android/commit/7db2c4a00ffc42ab89d61217a0b04b4ed32164b5", "message": "Add deleteObservation() in RoomLocalDataStore.\n\nAlso, exposes apply() and enqueue() methods publicly. This is so that we update the local database after deleting the observation from remote firestore", "committedDate": "2020-07-09T16:25:53Z", "type": "commit"}, {"oid": "25581766f0a5889dc7f079638f44ea2bcfad5e1a", "url": "https://github.com/google/ground-android/commit/25581766f0a5889dc7f079638f44ea2bcfad5e1a", "message": "Delete observation from local db after remote sync succeeds", "committedDate": "2020-07-09T16:26:21Z", "type": "commit"}, {"oid": "fca75b3883c02ecc3b95da69c18e8a96f0508623", "url": "https://github.com/google/ground-android/commit/fca75b3883c02ecc3b95da69c18e8a96f0508623", "message": "Integrate delete observation implementation to the UI", "committedDate": "2020-07-09T16:26:31Z", "type": "commit"}, {"oid": "e894269c2942912be01e3c5f1dd156eebd24af0c", "url": "https://github.com/google/ground-android/commit/e894269c2942912be01e3c5f1dd156eebd24af0c", "message": "Remove debug messages", "committedDate": "2020-07-09T16:26:33Z", "type": "commit"}, {"oid": "d081655e2450b8032ca0ad660db97f3b893b89ca", "url": "https://github.com/google/ground-android/commit/d081655e2450b8032ca0ad660db97f3b893b89ca", "message": "Add comment", "committedDate": "2020-07-09T16:26:33Z", "type": "commit"}, {"oid": "714fea2fc7a2d8f206a49528824afee9b097ac18", "url": "https://github.com/google/ground-android/commit/714fea2fc7a2d8f206a49528824afee9b097ac18", "message": "Add test for deleteObservation()", "committedDate": "2020-07-09T16:26:33Z", "type": "commit"}, {"oid": "4f68baa303b35e6d4026398a350bfc14741873d2", "url": "https://github.com/google/ground-android/commit/4f68baa303b35e6d4026398a350bfc14741873d2", "message": "Remove extra constructor", "committedDate": "2020-07-09T16:26:33Z", "type": "commit"}, {"oid": "6df2a6cc24dee1cb01eb5ab4445a4a9b776a7160", "url": "https://github.com/google/ground-android/commit/6df2a6cc24dee1cb01eb5ab4445a4a9b776a7160", "message": "Cleanup", "committedDate": "2020-07-09T16:26:38Z", "type": "commit"}, {"oid": "81b70dff782710896bca710bc7dddc062d673208", "url": "https://github.com/google/ground-android/commit/81b70dff782710896bca710bc7dddc062d673208", "message": "Rename variable to observation", "committedDate": "2020-07-09T16:26:40Z", "type": "commit"}, {"oid": "81b70dff782710896bca710bc7dddc062d673208", "url": "https://github.com/google/ground-android/commit/81b70dff782710896bca710bc7dddc062d673208", "message": "Rename variable to observation", "committedDate": "2020-07-09T16:26:40Z", "type": "forcePushed"}, {"oid": "86dcfbd0a06750382a15f66c33c580e49ae36535", "url": "https://github.com/google/ground-android/commit/86dcfbd0a06750382a15f66c33c580e49ae36535", "message": "Mark observation as deleted and delete only after sync finishes", "committedDate": "2020-07-09T17:11:07Z", "type": "commit"}, {"oid": "c5535db55bc8a564232efa57d3729263bff3a32b", "url": "https://github.com/google/ground-android/commit/c5535db55bc8a564232efa57d3729263bff3a32b", "message": "Update tests", "committedDate": "2020-07-09T17:30:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzM0Nw==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452403347", "bodyText": "Isn't this just another case of apply(ObservationMutation)? Adding a separate method would break this model, and it would mean there are many configurations of ObservationMutation that would be invalid and would need to be checked. Can we instead call the impl of this method via apply()?", "author": "gino-m", "createdAt": "2020-07-09T18:15:48Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -80,13 +81,25 @@\n    */\n   Completable applyAndEnqueue(ObservationMutation mutation);\n \n+  /** Applies the specified {@link ObservationMutation} to the local data store.. */\n+  Completable apply(ObservationMutation mutation) throws LocalDataStoreException;\n+\n+  /** Appends the specified {@link ObservationMutation} to the local queue for remote sync. */\n+  Completable enqueue(ObservationMutation mutation);\n+\n+  /** Deletes local observation entry. */\n+  Completable deleteObservation(ObservationMutation mutation);", "originalCommit": "c5535db55bc8a564232efa57d3729263bff3a32b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMzYwNA==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452613604", "bodyText": "Done 7f6dbff", "author": "shobhitagarwal1612", "createdAt": "2020-07-10T04:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzcwMw==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452403703", "bodyText": "Can we implement this in the DAO instead?", "author": "gino-m", "createdAt": "2020-07-09T18:16:28Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -260,6 +261,8 @@ public Completable applyAndEnqueue(FeatureMutation mutation) {\n         .map(\n             list ->\n                 stream(list)\n+                    .filter(\n+                        observationEntity -> observationEntity.getState() != EntityState.DELETED)", "originalCommit": "c5535db55bc8a564232efa57d3729263bff3a32b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMzUzOA==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452613538", "bodyText": "Thanks for pointing out! Dao already contains a where clause for DEFAULT state", "author": "shobhitagarwal1612", "createdAt": "2020-07-10T04:17:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzcwMw=="}], "type": "inlineReview"}, {"oid": "7f6dbff01b22a6021eb4b6f1a9eaec5696b10e15", "url": "https://github.com/google/ground-android/commit/7f6dbff01b22a6021eb4b6f1a9eaec5696b10e15", "message": "Merge implementation for mark delete / delete in apply", "committedDate": "2020-07-10T04:12:43Z", "type": "commit"}, {"oid": "32bcc02ee81377ece2e13b2a22576849b607a972", "url": "https://github.com/google/ground-android/commit/32bcc02ee81377ece2e13b2a22576849b607a972", "message": "Remove duplicate filter\n\nObservationDao already contains where clause: state = 1 (DEFAULT)", "committedDate": "2020-07-10T04:16:30Z", "type": "commit"}, {"oid": "c5532f0504c67b4c7168d71b3db35868291165c0", "url": "https://github.com/google/ground-android/commit/c5532f0504c67b4c7168d71b3db35868291165c0", "message": "Improve comments", "committedDate": "2020-07-10T04:29:04Z", "type": "commit"}, {"oid": "abac476b9055826472416faa4d4152407c25de81", "url": "https://github.com/google/ground-android/commit/abac476b9055826472416faa4d4152407c25de81", "message": "Update unit test", "committedDate": "2020-07-10T04:49:13Z", "type": "commit"}, {"oid": "f7e79c28cafef0f46d4c085afc3df08da8cf56c9", "url": "https://github.com/google/ground-android/commit/f7e79c28cafef0f46d4c085afc3df08da8cf56c9", "message": "Also assert local entity's state in unit test", "committedDate": "2020-07-10T05:10:02Z", "type": "commit"}, {"oid": "8260190bd6f291a516712202322b4685d3959c54", "url": "https://github.com/google/ground-android/commit/8260190bd6f291a516712202322b4685d3959c54", "message": "Fix indentation level", "committedDate": "2020-07-10T05:24:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMDI5Ng==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452900296", "bodyText": "This logic is not idempotent, which can lead to issues wrt order and timing of mutations; if you call it once, it will do something different than if you call it twice.\nIt's not clear to me when/how the second mutation to delete the entity would occur. Wouldn't it occur at a lower level, once the remote observation is actually removed (i.e. not via the mutation interface)?", "author": "gino-m", "createdAt": "2020-07-10T15:02:59Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -424,8 +427,25 @@ public Completable apply(ObservationMutation mutation) throws LocalDataStoreExce\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> updateObservation(mutation, user));\n       case DELETE:\n-        return getUser(mutation.getUserId())\n-            .flatMapCompletable(user -> markObservationDeleted(mutation));\n+        return observationDao\n+            .findById(mutation.getObservationId())\n+            .flatMapCompletable(\n+                entity -> {\n+                  // Mark the ObservationEntity as DELETED if the current state is DEFAULT.\n+                  // Otherwise, delete the observation entity from local db.\n+                  //\n+                  // TODO: If the remote sync fails, reset the state to DEFAULT.\n+                  //\n+                  // Note: Observations marked as DELETED are not shown in UI.\n+                  //       See {@link ObservationDao}\n+                  if (entity.getState() == EntityState.DEFAULT) {", "originalCommit": "8260190bd6f291a516712202322b4685d3959c54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzNjMyMg==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452936322", "bodyText": "I may have misinterpreted your previous comment. You mentioned that deleteObservation is another case of apply and should be called via it rather than directly. So I merged the two methods markObservationDeleted and deleteObservation under the same apply implementation.\nCurrent flow:\nmark observation as deleted -> create mutation -> remote sync (delete) -> delete local observation -> delete mutation\n@gino-m Did I make an error in understanding the comments? Please confirm.", "author": "shobhitagarwal1612", "createdAt": "2020-07-10T16:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMDI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzODU5Ng==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452938596", "bodyText": "Sorry, I may have misspoke - specifically \"mark deleted\" is a special case of apply. \"Delete permanently\" isn't represented as a mutation type, since it's not a user action that we need to sync to/from the remote server.\nThe flow as you described it seems correct. My comment was relating to how the \"delete local observation\" step is being invoked - it currently depends on how many times this method is called, and as mentioned, the cleanup step isn't a synced mutation type. Instead, it can be done directly in the db after the remote observation is deleted.", "author": "gino-m", "createdAt": "2020-07-10T16:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMDI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2MjIwMQ==", "url": "https://github.com/google/ground-android/pull/522#discussion_r452962201", "bodyText": "Done 3077b29", "author": "shobhitagarwal1612", "createdAt": "2020-07-10T16:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMDI5Ng=="}], "type": "inlineReview"}, {"oid": "3077b295cf5497f571d36e0bc3c15ede06fe396c", "url": "https://github.com/google/ground-android/commit/3077b295cf5497f571d36e0bc3c15ede06fe396c", "message": "Separate mark and delete methods for readability", "committedDate": "2020-07-10T16:57:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjU2OQ==", "url": "https://github.com/google/ground-android/pull/522#discussion_r453052569", "bodyText": "Why don't we just delete the observation as soon as the remote observation is deleted inside applyMutations? Sorry if I'm missing something!", "author": "gino-m", "createdAt": "2020-07-10T20:02:16Z", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -112,17 +112,17 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n-        .andThen(removeLocalObservationsIfMutationTypeIsDelete(mutations))\n+        .andThen(deleteObservationIfRemovedRemotely(mutations))", "originalCommit": "3077b295cf5497f571d36e0bc3c15ede06fe396c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2NjAyOQ==", "url": "https://github.com/google/ground-android/pull/522#discussion_r453766029", "bodyText": "ground-android/gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreDataStore.java\n    \n    \n         Line 112\n      in\n      1a1246f\n    \n    \n    \n    \n\n        \n          \n           return batch.commit(); \n        \n    \n  \n\n\nIIUC, deleting the observation just after adding batch request would not ensure that the remote observation was indeed removed. So, to ensure that we only do it after successful task completion, I chose to do it in after the success call.\nDoes that seem right to you?", "author": "shobhitagarwal1612", "createdAt": "2020-07-13T16:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3MTA0MA==", "url": "https://github.com/google/ground-android/pull/522#discussion_r453771040", "bodyText": "Ah, good point; sorry I forgot we were deleting them as part of the batch. I was concerned about possible race conditions, but we're using the same set of mutations in both steps, so I think we're ok here. LGTM!", "author": "gino-m", "createdAt": "2020-07-13T16:21:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjU2OQ=="}], "type": "inlineReview"}]}