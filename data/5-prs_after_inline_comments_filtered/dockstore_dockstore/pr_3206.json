{"pr_number": 3206, "pr_title": "create better error message for workflow or tool registration", "pr_createdAt": "2020-02-03T18:35:56Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3206", "timeline": [{"oid": "603368c3fcc64d4c6a1abef8558ced5993c41575", "url": "https://github.com/dockstore/dockstore/commit/603368c3fcc64d4c6a1abef8558ced5993c41575", "message": "created better error message if workflow is registered as tool or vice versa", "committedDate": "2020-02-03T17:55:37Z", "type": "commit"}, {"oid": "b862262651e29d2960d3bb2cdb9d394a011158bc", "url": "https://github.com/dockstore/dockstore/commit/b862262651e29d2960d3bb2cdb9d394a011158bc", "message": "added ExpressionTool check when registering CWL tool as workflow", "committedDate": "2020-02-03T18:24:40Z", "type": "commit"}, {"oid": "62eae48668c86059011b4d9ec5844274e9d74ad9", "url": "https://github.com/dockstore/dockstore/commit/62eae48668c86059011b4d9ec5844274e9d74ad9", "message": "removed checkstyle warning suppression", "committedDate": "2020-02-03T18:31:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI4MjcyMg==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r374282722", "bodyText": "Suggest mentioning the exact class(es) rather than the the possible choices.", "author": "coverbeck", "createdAt": "2020-02-03T19:03:53Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -736,7 +736,10 @@ public VersionTypeValidation validateWorkflowSet(Set<SourceFile> sourcefiles, St\n                 validationMessage = \"Primary descriptor is empty.\";\n             } else if (!content.contains(\"class: Workflow\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: Workflow.\";\n+                validationMessage = \"A CWL workflow requires class: Workflow.\";\n+                if (content.contains(\"class: CommandLineTool\") || content.contains(\"class: ExpressionTool\")) {\n+                    validationMessage += \" This file contains class: CommandLineTool or ExpressionTool. Did you mean to register a tool?\";", "originalCommit": "62eae48668c86059011b4d9ec5844274e9d74ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg0MDI3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r375840279", "bodyText": "Fixed so the message shows the exact class.\nCommandLineTool:\n\nExpressionTool:", "author": "kathy-t", "createdAt": "2020-02-06T13:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI4MjcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NjQ1Mw==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r374276453", "bodyText": "Should mention why it's invalid", "author": "garyluu", "createdAt": "2020-02-03T18:50:59Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/ValidationIT.java", "diffHunk": "@@ -168,12 +168,12 @@ public void testWdlWorkflow() {\n         workflow = workflowsApi.refresh(workflow.getId());\n         Assert.assertFalse(isWorkflowVersionValid(workflow, \"master\"));\n \n-        // change to valid tool - should be valid\n+        // change to valid tool - should be invalid\n         workflow.setWorkflowPath(\"/validTool.wdl\");\n         workflow = workflowsApi.updateWorkflow(workflow.getId(), workflow);\n         workflowsApi.updateWorkflowPath(workflow.getId(), workflow);\n         workflow = workflowsApi.refresh(workflow.getId());\n-        Assert.assertTrue(\"Should be valid\", isWorkflowVersionValid(workflow, \"master\"));\n+        Assert.assertFalse(\"Should be invalid\", isWorkflowVersionValid(workflow, \"master\"));", "originalCommit": "62eae48668c86059011b4d9ec5844274e9d74ad9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgzODk5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r375838996", "bodyText": "Reverted the test back to what it was originally because WDL tools with one task call can be registered as a WDL workflow (based on discussion with Denis).", "author": "kathy-t", "createdAt": "2020-02-06T13:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NjQ1Mw=="}], "type": "inlineReview"}, {"oid": "61bead7e2bd73dd4788c8b8140934b8b84d7345f", "url": "https://github.com/dockstore/dockstore/commit/61bead7e2bd73dd4788c8b8140934b8b84d7345f", "message": "reverted WDL workflow validation back to original. made CWL workflow error message more specific.", "committedDate": "2020-02-06T13:30:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MTQxNA==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376081414", "bodyText": "Might be just me, but I think it'd look cleaner with String.format", "author": "garyluu", "createdAt": "2020-02-06T21:05:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -736,7 +736,12 @@ public VersionTypeValidation validateWorkflowSet(Set<SourceFile> sourcefiles, St\n                 validationMessage = \"Primary descriptor is empty.\";\n             } else if (!content.contains(\"class: Workflow\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: Workflow.\";\n+                validationMessage = \"A CWL workflow requires class: Workflow.\";\n+                if (content.contains(\"class: CommandLineTool\") || content.contains(\"class: ExpressionTool\")) {\n+                    validationMessage += \" This file contains class: \";\n+                    validationMessage += (content.contains(\"class: CommandLineTool\")) ? \"CommandLineTool.\" : \"ExpressionTool.\";\n+                    validationMessage += \" Did you mean to register a tool?\";", "originalCommit": "61bead7e2bd73dd4788c8b8140934b8b84d7345f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4ODgzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376088839", "bodyText": "Another consideration is efficiency, this repeated concatenation is pretty inefficient.\nConsider a StringBuilder https://stackoverflow.com/questions/4645020/when-to-use-stringbuilder-in-java", "author": "denis-yuen", "createdAt": "2020-02-06T21:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MTQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4MzA1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376083055", "bodyText": "Perhaps single quotes around actual code", "author": "garyluu", "createdAt": "2020-02-06T21:09:11Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -768,7 +773,10 @@ public VersionTypeValidation validateToolSet(Set<SourceFile> sourcefiles, String\n                 validationMessage = \"Primary CWL descriptor is empty.\";\n             } else if (!content.contains(\"class: CommandLineTool\") && !content.contains(\"class: ExpressionTool\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: CommandLineTool or ExpressionTool.\";\n+                validationMessage = \"A CWL tool requires class: CommandLineTool or ExpressionTool.\";\n+                if (content.contains(\"class: Workflow\")) {\n+                    validationMessage += \" This file contains class: Workflow. Did you mean to register a workflow?\";", "originalCommit": "61bead7e2bd73dd4788c8b8140934b8b84d7345f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f75249ae3f185b2484eb7fbd7be8a80e2161a11", "url": "https://github.com/dockstore/dockstore/commit/9f75249ae3f185b2484eb7fbd7be8a80e2161a11", "message": "used StringBuilder for CWL workflow validation message. added single quotes for actual code in message", "committedDate": "2020-02-07T14:45:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNzg1MA==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376437850", "bodyText": "I prefer: validationMessage.append(String.format(\" This file contains 'class: %s'. Did you mean to register a tool?\", cwlClass));", "author": "garyluu", "createdAt": "2020-02-07T15:04:59Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -725,28 +725,32 @@ public VersionTypeValidation validateWorkflowSet(Set<SourceFile> sourcefiles, St\n         Optional<SourceFile> mainDescriptor = filteredSourcefiles.stream().filter((sourceFile -> Objects.equals(sourceFile.getPath(), primaryDescriptorFilePath))).findFirst();\n \n         boolean isValid = true;\n-        String validationMessage = null;\n+        StringBuilder validationMessage = new StringBuilder();\n         Map<String, String> validationMessageObject = new HashMap<>();\n \n         if (mainDescriptor.isPresent()) {\n             Yaml yaml = new Yaml();\n             String content = mainDescriptor.get().getContent();\n             if (content == null || content.isEmpty()) {\n                 isValid = false;\n-                validationMessage = \"Primary descriptor is empty.\";\n+                validationMessage.append(\"Primary descriptor is empty.\");\n             } else if (!content.contains(\"class: Workflow\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: Workflow.\";\n+                validationMessage.append(\"A CWL workflow requires 'class: Workflow'.\");\n+                if (content.contains(\"class: CommandLineTool\") || content.contains(\"class: ExpressionTool\")) {\n+                    String cwlClass = content.contains(\"class: CommandLineTool\") ? \"CommandLineTool\" : \"ExpressionTool\";\n+                    validationMessage.append(\" This file contains 'class: \").append(cwlClass).append(\"'. Did you mean to register a tool?\");", "originalCommit": "9f75249ae3f185b2484eb7fbd7be8a80e2161a11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2Mjc0OQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376462749", "bodyText": "String.format is less efficient than StringBuilder so I just stuck with using StringBuilder's append since using String.format would defeat the purpose of using StringBuilder for efficiency.", "author": "kathy-t", "createdAt": "2020-02-07T15:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ2NDE3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376464179", "bodyText": "It's for readability: https://stackoverflow.com/a/44127617", "author": "garyluu", "createdAt": "2020-02-07T15:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNzg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwNTgzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376505839", "bodyText": "This is nit-picky and you don't need to change the PR for it, but FYI string searches can be relatively expensive so you should generally try to avoid searching for the same substring more than once. Imagine if content was 100K or bigger -- worst case it will go through the whole string two times if there's not a match for CommandLineTool, plus twice more for however far into the string the match for ExpressionTool is. Unless the compiler/runtime does some fancy optimization, but I wouldn't rely on it.\nOTOH, descriptors aren't typically that big, it will still be fast, and this code is not frequently executed.", "author": "coverbeck", "createdAt": "2020-02-07T17:11:12Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -725,28 +725,32 @@ public VersionTypeValidation validateWorkflowSet(Set<SourceFile> sourcefiles, St\n         Optional<SourceFile> mainDescriptor = filteredSourcefiles.stream().filter((sourceFile -> Objects.equals(sourceFile.getPath(), primaryDescriptorFilePath))).findFirst();\n \n         boolean isValid = true;\n-        String validationMessage = null;\n+        StringBuilder validationMessage = new StringBuilder();\n         Map<String, String> validationMessageObject = new HashMap<>();\n \n         if (mainDescriptor.isPresent()) {\n             Yaml yaml = new Yaml();\n             String content = mainDescriptor.get().getContent();\n             if (content == null || content.isEmpty()) {\n                 isValid = false;\n-                validationMessage = \"Primary descriptor is empty.\";\n+                validationMessage.append(\"Primary descriptor is empty.\");\n             } else if (!content.contains(\"class: Workflow\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: Workflow.\";\n+                validationMessage.append(\"A CWL workflow requires 'class: Workflow'.\");\n+                if (content.contains(\"class: CommandLineTool\") || content.contains(\"class: ExpressionTool\")) {\n+                    String cwlClass = content.contains(\"class: CommandLineTool\") ? \"CommandLineTool\" : \"ExpressionTool\";", "originalCommit": "9f75249ae3f185b2484eb7fbd7be8a80e2161a11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwODkwMQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376508901", "bodyText": "I would personally use double quotes, but I can go either way: \"...\\\"class: Workflow\\\".\"", "author": "coverbeck", "createdAt": "2020-02-07T17:18:07Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -725,28 +725,32 @@ public VersionTypeValidation validateWorkflowSet(Set<SourceFile> sourcefiles, St\n         Optional<SourceFile> mainDescriptor = filteredSourcefiles.stream().filter((sourceFile -> Objects.equals(sourceFile.getPath(), primaryDescriptorFilePath))).findFirst();\n \n         boolean isValid = true;\n-        String validationMessage = null;\n+        StringBuilder validationMessage = new StringBuilder();\n         Map<String, String> validationMessageObject = new HashMap<>();\n \n         if (mainDescriptor.isPresent()) {\n             Yaml yaml = new Yaml();\n             String content = mainDescriptor.get().getContent();\n             if (content == null || content.isEmpty()) {\n                 isValid = false;\n-                validationMessage = \"Primary descriptor is empty.\";\n+                validationMessage.append(\"Primary descriptor is empty.\");\n             } else if (!content.contains(\"class: Workflow\")) {\n                 isValid = false;\n-                validationMessage = \"Requires class: Workflow.\";\n+                validationMessage.append(\"A CWL workflow requires 'class: Workflow'.\");", "originalCommit": "9f75249ae3f185b2484eb7fbd7be8a80e2161a11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUzODQxOQ==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376538419", "bodyText": "This is what it would look like with double quotes:\n\nIt also looks like single quotes are used for some error messages, such as the one for /Dockstore.wdl when the file has no content. Do you think it would be better to just keep it as single quotes for uniformity?\nWhat it looks like with single quotes:", "author": "kathy-t", "createdAt": "2020-02-07T18:26:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwODkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0MTk0Nw==", "url": "https://github.com/dockstore/dockstore/pull/3206#discussion_r376541947", "bodyText": "Ah, sorry, I did not look at other messages for comparison before I wrote my comment... If we're already using single quotes elsewhere, especially in the same message, we should be consistent and continue to use single quotes.\nI was commenting from more of a grammar perspective, although I don't actually know what the official rule is on that -- it just felt right to use double quotes. :)", "author": "coverbeck", "createdAt": "2020-02-07T18:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUwODkwMQ=="}], "type": "inlineReview"}]}