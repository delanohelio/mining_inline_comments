{"pr_number": 3794, "pr_title": "fixDagAndTools", "pr_createdAt": "2020-09-04T22:56:58Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3794", "timeline": [{"oid": "d8b3047a4d9c0350e3e14eff4cc44182da9a6ff8", "url": "https://github.com/dockstore/dockstore/commit/d8b3047a4d9c0350e3e14eff4cc44182da9a6ff8", "message": "$import $include", "committedDate": "2020-09-04T22:01:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r484971811", "bodyText": "Was the $ optional at some point?", "author": "denis-yuen", "createdAt": "2020-09-08T14:37:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -358,12 +358,12 @@ public String getContent(String mainDescriptorPath, String mainDescriptor, Set<S\n                         stepToType.put(workflowStepId, expressionToolType);\n                     } else if (run instanceof Map) {\n                         // must be import or include\n-                        Object importVal = ((Map)run).get(\"import\");\n+                        Object importVal = ((Map)run).get(\"$import\");", "originalCommit": "d8b3047a4d9c0350e3e14eff4cc44182da9a6ff8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA0MzQ2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r485043469", "bodyText": "I'm not sure. Looking at their documentation, I only see references with  the$ for include and import", "author": "NatalieEO", "createdAt": "2020-09-08T16:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwMzEzOA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488203138", "bodyText": "Were you going to fetch both, with and without the $, or did you decided that with the $ is the only way to go? If $ is the only way to go, does that mean $import and $include have never worked?", "author": "coverbeck", "createdAt": "2020-09-14T20:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyODIwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488228209", "bodyText": "Originally I was only going to do it with $ because I didn't see cwl documentation that didn't have it...but now I see this code https://github.com/dockstore/dockstore/pull/3794/files/9f19334385fe1fd251b7189ca3938b378cb411fd#diff-f9e0ac900016e3693ac10f2a3a7b8939L1505 that includes both. I think it is wrong to not have $, but maybe safer to just include both for now?", "author": "NatalieEO", "createdAt": "2020-09-14T21:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxNDI1MA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488814250", "bodyText": "I think you have the wrong link, it links back to this comment.\nI don't know enough about CWL to know the answer. Maybe you could query all of our CWL source files to see if they're present without the$?", "author": "coverbeck", "createdAt": "2020-09-15T16:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU2Mzk0Nw==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r489563947", "bodyText": "I think this is the link that was intended to illuminate the import format: https://www.commonwl.org/v1.0/SchemaSalad.html#Import_example", "author": "wshands", "createdAt": "2020-09-16T16:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1MDc4NA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r491050784", "bodyText": "I think Charles has it, if we know that all Dockstore workflows always have the $ then I would feel comfortable making it mandatory.  The other option is including both for now (essentially because a little more permissive than the current CWL specification).\nI don't have a strong option as to which, but it does feel like this was intentional at some point. So the git history might have a clue if a test or commit comment was included", "author": "denis-yuen", "createdAt": "2020-09-18T16:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk3MTgxMQ=="}], "type": "inlineReview"}, {"oid": "d969e88023d00f77052e297cc880e65fc83e7d39", "url": "https://github.com/dockstore/dockstore/commit/d969e88023d00f77052e297cc880e65fc83e7d39", "message": "check for docker if type tool", "committedDate": "2020-09-08T20:39:43Z", "type": "commit"}, {"oid": "fcec146abb115388a3c63d17ee08b80aa15041e9", "url": "https://github.com/dockstore/dockstore/commit/fcec146abb115388a3c63d17ee08b80aa15041e9", "message": "checkstyle", "committedDate": "2020-09-08T20:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2NDA0OA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r485964048", "bodyText": "Is there any reason for this? Just added two slashes at the end of the line? Just trying to make sure I understand.", "author": "coverbeck", "createdAt": "2020-09-09T22:50:02Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -561,7 +566,7 @@ private String getRequirementOrHint(List<Object> requirements, List<Object> hint\n      * @param yaml\n      * @return\n      */\n-    private String parseSecondaryFile(String stepDockerRequirement, String secondaryFileContents, Gson gson, Yaml yaml) {\n+    private String parseSecondaryFile(String stepDockerRequirement, String secondaryFileContents, Gson gson, Yaml yaml) { //", "originalCommit": "fcec146abb115388a3c63d17ee08b80aa15041e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MzM2OA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r485983368", "bodyText": "Ah no, this was a mistake. Left in when I was debugging", "author": "NatalieEO", "createdAt": "2020-09-09T23:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2NDA0OA=="}], "type": "inlineReview"}, {"oid": "9f19334385fe1fd251b7189ca3938b378cb411fd", "url": "https://github.com/dockstore/dockstore/commit/9f19334385fe1fd251b7189ca3938b378cb411fd", "message": "change return to Optional<String> to avoid NPEs", "committedDate": "2020-09-14T19:43:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODM0MQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488198341", "bodyText": "I can't believe I'm going to say this, since I think Optional is great, and I'm always pushing people to use it, but this change will force us to update the Galaxy plugin as well, since it implements this interface. Not sure we want to go down that route. Maybe... Best to get Denis' opinion.", "author": "coverbeck", "createdAt": "2020-09-14T20:23:36Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -141,7 +141,7 @@\n      * @param dao                  used to retrieve information on tools\n      * @return either a DAG or some form of a list of tools for a workflow\n      */\n-    String getContent(String mainDescriptorPath, String mainDescriptor, Set<SourceFile> secondarySourceFiles, Type type, ToolDAO dao);\n+    Optional<String> getContent(String mainDescriptorPath, String mainDescriptor, Set<SourceFile> secondarySourceFiles, Type type, ToolDAO dao);", "originalCommit": "9f19334385fe1fd251b7189ca3938b378cb411fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0Nzc5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r491047797", "bodyText": "Think you're thinking of CompleteLanguageInterface. generateToolsTable and CompleteLanguageInterface.loadCytoscapeElements because I suck at naming. I think this one is ok to rename/change to optional this is only used internally.", "author": "denis-yuen", "createdAt": "2020-09-18T16:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0OTMwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r491049309", "bodyText": "(comment above was not taking into account Gary's comment about whether this is a good idea, just saying that we won't necessarily break code in a different repo)", "author": "denis-yuen", "createdAt": "2020-09-18T16:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE5ODM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwMTE1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488201155", "bodyText": "Before, if there was an error, it would setToolTableJson(null). Now you don't set it at all. Do you want that?\nI don't know the answer, just raising the question. In theory, without understanding the whole flow, it seems like if there were already a value in that fiel, it would get cleared before your change, and now it doesn't.\nThis happens in at least 2 other places (ran across this one first). Checking that this is as intended everywhere. Could very well be the bug fix :) But I'm still concerned about old values not being cleared.", "author": "coverbeck", "createdAt": "2020-09-14T20:29:06Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1543,10 +1549,13 @@ public String getTableToolContent(@ApiParam(hidden = true) @Parameter(hidden = t\n         if (mainDescriptor != null) {\n             Set<SourceFile> secondaryDescContent = extractDescriptorAndSecondaryFiles(workflowVersion);\n             LanguageHandlerInterface lInterface = LanguageHandlerFactory.getInterface(workflow.getFileType());\n-            final String toolTableJson = lInterface.getContent(workflowVersion.getWorkflowPath(), mainDescriptor.getContent(), secondaryDescContent,\n+            final Optional<String> toolTableJson = lInterface.getContent(workflowVersion.getWorkflowPath(), mainDescriptor.getContent(), secondaryDescContent,\n                 LanguageHandlerInterface.Type.TOOLS, toolDAO);\n-            workflowVersion.setToolTableJson(toolTableJson);", "originalCommit": "9f19334385fe1fd251b7189ca3938b378cb411fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyNjI5OA==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488226298", "bodyText": "Oh good point, thinking about it more, it does make sense to clear it in this instance and here https://github.com/dockstore/dockstore/pull/3794/files/9f19334385fe1fd251b7189ca3938b378cb411fd#diff-f9e0ac900016e3693ac10f2a3a7b8939L1505 too.\nUnsure of the other location you were referring to.", "author": "NatalieEO", "createdAt": "2020-09-14T21:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwMTE1NQ=="}], "type": "inlineReview"}, {"oid": "3f27537b85c4aa0aaece89d412d7e800a65d77a1", "url": "https://github.com/dockstore/dockstore/commit/3f27537b85c4aa0aaece89d412d7e800a65d77a1", "message": "fix test, clear dag and tool table if there was an error retrieving the info.", "committedDate": "2020-09-14T21:43:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgwNTQxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488805411", "bodyText": "This is the other instance of it not being set to null where it would have been before", "author": "coverbeck", "createdAt": "2020-09-15T16:34:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1460,8 +1462,10 @@ public Workflow manualRegister(@ApiParam(hidden = true) @Parameter(hidden = true\n \n                     // store dag\n                     if (existingTag.getDagJson() == null) {\n-                        String dagJson = lInterface.getCleanDAG(w.getWorkflowPath(), getMainDescriptorFile(existingTag).getContent(), extractDescriptorAndSecondaryFiles(existingTag), LanguageHandlerInterface.Type.DAG, toolDAO);\n-                        existingTag.setDagJson(dagJson);\n+                        Optional<String> dagJson = lInterface.getCleanDAG(w.getWorkflowPath(), getMainDescriptorFile(existingTag).getContent(), extractDescriptorAndSecondaryFiles(existingTag), LanguageHandlerInterface.Type.DAG, toolDAO);\n+                        if (dagJson.isPresent()) {", "originalCommit": "3f27537b85c4aa0aaece89d412d7e800a65d77a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgxMTY5Mg==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r488811692", "bodyText": "This is fine, but you could also write it like:\nfinal String json = toolTableJson.getOrElse(null);\nworkflowVersion.setTooltableJson(json);\nreturn json;", "author": "coverbeck", "createdAt": "2020-09-15T16:44:38Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1543,10 +1552,16 @@ public String getTableToolContent(@ApiParam(hidden = true) @Parameter(hidden = t\n         if (mainDescriptor != null) {\n             Set<SourceFile> secondaryDescContent = extractDescriptorAndSecondaryFiles(workflowVersion);\n             LanguageHandlerInterface lInterface = LanguageHandlerFactory.getInterface(workflow.getFileType());\n-            final String toolTableJson = lInterface.getContent(workflowVersion.getWorkflowPath(), mainDescriptor.getContent(), secondaryDescContent,\n+            final Optional<String> toolTableJson = lInterface.getContent(workflowVersion.getWorkflowPath(), mainDescriptor.getContent(), secondaryDescContent,\n                 LanguageHandlerInterface.Type.TOOLS, toolDAO);\n-            workflowVersion.setToolTableJson(toolTableJson);\n-            return toolTableJson;\n+            if (toolTableJson.isPresent()) {", "originalCommit": "3f27537b85c4aa0aaece89d412d7e800a65d77a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed2f2679de586ab2bb83af2ba0ae7ba34fa6a3c6", "url": "https://github.com/dockstore/dockstore/commit/ed2f2679de586ab2bb83af2ba0ae7ba34fa6a3c6", "message": "handle with and without $, use less optional, clean up", "committedDate": "2020-09-19T00:33:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyODI1Nw==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r492328257", "bodyText": "I don't understand the whole flow, but this is saying that if run is a Map, then return an Optional.empty if the map doesn't reference an import. Are we saying we always want that? I guess so, and I'm saying in English what the code does, and this may be the whole point of the fix, but it also seems like a bit of a change, so just making sure.", "author": "coverbeck", "createdAt": "2020-09-21T20:30:55Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/CWLHandler.java", "diffHunk": "@@ -358,15 +358,20 @@ public String getContent(String mainDescriptorPath, String mainDescriptor, Set<S\n                         stepToType.put(workflowStepId, expressionToolType);\n                     } else if (run instanceof Map) {\n                         // must be import or include\n-                        Object importVal = ((Map)run).get(\"import\");\n+                        Object importVal = ((Map)run).containsKey(\"$import\") ? ((Map)run).get(\"$import\") : ((Map)run).get(\"import\");\n                         if (importVal != null) {\n                             secondaryFile = importVal.toString();\n                         }\n \n-                        Object includeVal = ((Map)run).get(\"include\");\n+                        Object includeVal = ((Map)run).containsKey(\"$include\") ? ((Map)run).get(\"$include\") : ((Map)run).get(\"include\");\n                         if (includeVal != null) {\n                             secondaryFile = includeVal.toString();\n                         }\n+\n+                        if (secondaryFile == null) {", "originalCommit": "ed2f2679de586ab2bb83af2ba0ae7ba34fa6a3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzNTgwMQ==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r492335801", "bodyText": "According to the comment there, if the run is a Map then it must be an import or include. If I don't return the optional.empty then the code will fail later at line 396 since the secondary file is never set which means stepToType won't get that  workflowStepId. That was causing the NPE before. It's possible there are other options other than import or include if it's a map though, but I don't really know CWL.", "author": "NatalieEO", "createdAt": "2020-09-21T20:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyODI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY0NjIzNw==", "url": "https://github.com/dockstore/dockstore/pull/3794#discussion_r493646237", "bodyText": "Weird comment formatting", "author": "denis-yuen", "createdAt": "2020-09-23T14:37:17Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/DAGHelper.java", "diffHunk": "@@ -38,11 +38,12 @@ private DAGHelper() {\n      * @param dag The unclean DAG with edges that may have undefined nodes\n      * @return The clean DAG without edges that have undefined nodes\n      */\n+    //", "originalCommit": "ed2f2679de586ab2bb83af2ba0ae7ba34fa6a3c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fdfc9b80276c68d2ccdc6c88210c239df722117d", "url": "https://github.com/dockstore/dockstore/commit/fdfc9b80276c68d2ccdc6c88210c239df722117d", "message": "remove comment", "committedDate": "2020-09-23T15:59:50Z", "type": "commit"}]}