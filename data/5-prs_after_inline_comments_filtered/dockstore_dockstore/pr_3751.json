{"pr_number": 3751, "pr_title": "Feature/3675/store license info", "pr_createdAt": "2020-08-17T21:17:52Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3751", "timeline": [{"oid": "431caaaed5d03cbbf038a4fe646dd68bb71eab90", "url": "https://github.com/dockstore/dockstore/commit/431caaaed5d03cbbf038a4fe646dd68bb71eab90", "message": "Update GitHub API dependency", "committedDate": "2020-08-17T17:43:48Z", "type": "commit"}, {"oid": "3c7a4b48d141418adb86d58ebc76c948d217ab2b", "url": "https://github.com/dockstore/dockstore/commit/3c7a4b48d141418adb86d58ebc76c948d217ab2b", "message": "Add LicenseInformation", "committedDate": "2020-08-17T20:40:16Z", "type": "commit"}, {"oid": "a445590694047efe301d89a063b05130fc6a19ba", "url": "https://github.com/dockstore/dockstore/commit/a445590694047efe301d89a063b05130fc6a19ba", "message": "Add a test", "committedDate": "2020-08-17T21:23:55Z", "type": "commit"}, {"oid": "64b70b7f8187a128e36c6b7db21f836448715cd3", "url": "https://github.com/dockstore/dockstore/commit/64b70b7f8187a128e36c6b7db21f836448715cd3", "message": "Add migration", "committedDate": "2020-08-17T21:23:55Z", "type": "commit"}, {"oid": "465e9c8db0a44b137c47ae6d7032931935ef2802", "url": "https://github.com/dockstore/dockstore/commit/465e9c8db0a44b137c47ae6d7032931935ef2802", "message": "Add TODOs", "committedDate": "2020-08-17T21:23:55Z", "type": "forcePushed"}, {"oid": "c5aa0215ae64cdd1482f6b7db663115638f97dee", "url": "https://github.com/dockstore/dockstore/commit/c5aa0215ae64cdd1482f6b7db663115638f97dee", "message": "Add TODOs", "committedDate": "2020-08-18T15:15:50Z", "type": "commit"}, {"oid": "8b2b911c2913e304bdb6b2e24d1d858db1e7f9ed", "url": "https://github.com/dockstore/dockstore/commit/8b2b911c2913e304bdb6b2e24d1d858db1e7f9ed", "message": "Move to repository level", "committedDate": "2020-08-18T15:15:50Z", "type": "commit"}, {"oid": "39a482d8590b253ab7c9fb461913b565d97c2bbf", "url": "https://github.com/dockstore/dockstore/commit/39a482d8590b253ab7c9fb461913b565d97c2bbf", "message": "Handle no license", "committedDate": "2020-08-18T15:15:50Z", "type": "commit"}, {"oid": "ac3a69175b505c7f30002c22bb84f2fb955ed42b", "url": "https://github.com/dockstore/dockstore/commit/ac3a69175b505c7f30002c22bb84f2fb955ed42b", "message": "Update test", "committedDate": "2020-08-18T15:15:50Z", "type": "commit"}, {"oid": "53882a4edee0e4dc674de76240012b1641ab7ce8", "url": "https://github.com/dockstore/dockstore/commit/53882a4edee0e4dc674de76240012b1641ab7ce8", "message": "Update swagger/openapi", "committedDate": "2020-08-18T15:15:50Z", "type": "commit"}, {"oid": "ea7436d4a15aa95079b121e5db435691605091db", "url": "https://github.com/dockstore/dockstore/commit/ea7436d4a15aa95079b121e5db435691605091db", "message": "Add workflow integration tests", "committedDate": "2020-08-18T15:46:20Z", "type": "commit"}, {"oid": "62f2abf2761a677447d1193cdd9871800e13fd79", "url": "https://github.com/dockstore/dockstore/commit/62f2abf2761a677447d1193cdd9871800e13fd79", "message": "Add tests", "committedDate": "2020-08-18T17:58:35Z", "type": "commit"}, {"oid": "89b764140e3bff787bc83484247eab9e89ec7b45", "url": "https://github.com/dockstore/dockstore/commit/89b764140e3bff787bc83484247eab9e89ec7b45", "message": "Generalize the setting of license information, support tools, non-null license information", "committedDate": "2020-08-18T17:59:50Z", "type": "commit"}, {"oid": "89b764140e3bff787bc83484247eab9e89ec7b45", "url": "https://github.com/dockstore/dockstore/commit/89b764140e3bff787bc83484247eab9e89ec7b45", "message": "Generalize the setting of license information, support tools, non-null license information", "committedDate": "2020-08-18T17:59:50Z", "type": "forcePushed"}, {"oid": "ad849abb5390d0237aa8331de0f9adb76a2b29d1", "url": "https://github.com/dockstore/dockstore/commit/ad849abb5390d0237aa8331de0f9adb76a2b29d1", "message": "Fix checkstyle", "committedDate": "2020-08-18T19:26:53Z", "type": "commit"}, {"oid": "7b20ea9195f3274e480abbbcf78d36c9f498b78b", "url": "https://github.com/dockstore/dockstore/commit/7b20ea9195f3274e480abbbcf78d36c9f498b78b", "message": "Don't set license name on register", "committedDate": "2020-08-19T23:25:05Z", "type": "commit"}, {"oid": "9b7e82678f0f22eb25784ad1681d2fe65c831d09", "url": "https://github.com/dockstore/dockstore/commit/9b7e82678f0f22eb25784ad1681d2fe65c831d09", "message": "Never return null license information", "committedDate": "2020-08-20T15:08:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIzNDE2OA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r474234168", "bodyText": "oops, will change these repo after others review", "author": "garyluu", "createdAt": "2020-08-20T19:49:05Z", "path": "dockstore-webservice/src/test/java/io/dockstore/webservice/helpers/GitHubHelperTest.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package io.dockstore.webservice.helpers;\n+\n+import java.io.IOException;\n+\n+import io.dockstore.webservice.core.LicenseInformation;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.kohsuke.github.AbuseLimitHandler;\n+import org.kohsuke.github.GitHub;\n+import org.kohsuke.github.GitHubBuilder;\n+import org.kohsuke.github.RateLimitHandler;\n+\n+public class GitHubHelperTest {\n+\n+    // TODO: Replace repos with something less likely to change\n+    @Test\n+    public void testGitHubLicense() throws IOException {\n+        GitHub gitHub = new GitHubBuilder().withRateLimitHandler(RateLimitHandler.WAIT).withAbuseLimitHandler(\n+                AbuseLimitHandler.WAIT).build();\n+        LicenseInformation licenseInformation = GitHubHelper.getLicenseInformation(gitHub, \"dockstore/lambda\");\n+        Assert.assertEquals(\"Apache License 2.0\", licenseInformation.getLicenseName());\n+\n+        licenseInformation = GitHubHelper.getLicenseInformation(gitHub, \"dockstore/dockstore\");", "originalCommit": "9b7e82678f0f22eb25784ad1681d2fe65c831d09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwMDQwMA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r474300400", "bodyText": "commented code likely to be uncommented?", "author": "denis-yuen", "createdAt": "2020-08-20T22:10:48Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/GeneralIT.java", "diffHunk": "@@ -1357,7 +1357,13 @@ public void testManualToAuto() {\n         ContainersApi toolsApi = setupWebService();\n         DockstoreTool tool = getQuayContainer(gitUrl);\n         DockstoreTool toolTest = toolsApi.registerManual(tool);\n-        toolsApi.refresh(toolTest.getId());\n+        // Assert.assertEquals(\"Should be able to get license after manual register\", \"Apache License 2.0\", toolTest.getLicenseInformation().getLicenseName());", "originalCommit": "9b7e82678f0f22eb25784ad1681d2fe65c831d09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwMDk0Nw==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r474300947", "bodyText": "interface methods should have javadoc", "author": "denis-yuen", "createdAt": "2020-08-20T22:12:12Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java", "diffHunk": "@@ -96,7 +96,7 @@ public static boolean matchesREADME(String filename) {\n     }\n \n     public abstract String getName();\n-\n+    public abstract void setLicenseInformation(Entry entry, String gitRepository);", "originalCommit": "9b7e82678f0f22eb25784ad1681d2fe65c831d09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwMTI4NA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r474301284", "bodyText": "add TODO for highlighting\nhttps://www.jetbrains.com/help/idea/using-todo.html\nalternatively can setToolLicenseInformation skip tools without a github token to avoid it being dead code?", "author": "denis-yuen", "createdAt": "2020-08-20T22:13:03Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoResource.java", "diffHunk": "@@ -596,9 +596,32 @@ public Tool registerManual(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             tool.setGitUrl(convertHttpsToSsh(tool.getGitUrl()));\n         }\n \n+        // Can't set tool license information here, far too many tests register a tool without a GitHub token", "originalCommit": "9b7e82678f0f22eb25784ad1681d2fe65c831d09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "385952498f6490d9e298978b3fcc94c13ca078e5", "url": "https://github.com/dockstore/dockstore/commit/385952498f6490d9e298978b3fcc94c13ca078e5", "message": "Add and update test", "committedDate": "2020-08-21T03:37:07Z", "type": "commit"}, {"oid": "e4488a8481c1577eeb8bd8f118fcbfdb58014ecd", "url": "https://github.com/dockstore/dockstore/commit/e4488a8481c1577eeb8bd8f118fcbfdb58014ecd", "message": "PR changes", "committedDate": "2020-08-21T03:45:07Z", "type": "commit"}, {"oid": "e0cbc321c8520fa5630265e2770b8d37de89baf3", "url": "https://github.com/dockstore/dockstore/commit/e0cbc321c8520fa5630265e2770b8d37de89baf3", "message": "Also update license information for GitHub Apps", "committedDate": "2020-08-21T16:10:12Z", "type": "commit"}, {"oid": "262e59ca60dd91e8fc610f38e08d0b55f21262ba", "url": "https://github.com/dockstore/dockstore/commit/262e59ca60dd91e8fc610f38e08d0b55f21262ba", "message": "Add single test, auto-fix some other tests", "committedDate": "2020-08-21T16:10:25Z", "type": "commit"}, {"oid": "8cc08a56b443db935259ee27c762929cedda56ed", "url": "https://github.com/dockstore/dockstore/commit/8cc08a56b443db935259ee27c762929cedda56ed", "message": "Add another test", "committedDate": "2020-08-21T19:44:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxMjU5OA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476012598", "bodyText": "You already have an empty LicenseInformation from line 99.", "author": "coverbeck", "createdAt": "2020-08-25T00:48:30Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubHelper.java", "diffHunk": "@@ -85,6 +89,27 @@ public static String getGitHubAccessToken(String code, String githubClientID, St\n         }\n     }\n \n+    /**\n+     * Get license for a specific GitHub repository\n+     * @param gitHub    The GitHub API\n+     * @param repositoryName    Name of the GitHub repository (e.g. dockstore/lambda)\n+     * @return  The LicenseInformation associated with the repository\n+     */\n+    public static LicenseInformation getLicenseInformation(GitHub gitHub, String repositoryName) {\n+        LicenseInformation licenseInformation = new LicenseInformation();\n+        try {\n+            GHRepository repository = gitHub.getRepository(repositoryName);\n+            GHLicense license = repository.getLicense();\n+            if (license == null) {\n+                return new LicenseInformation();", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxNDAwNA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476014004", "bodyText": "You could also use the same empty LicenseInformation here.", "author": "coverbeck", "createdAt": "2020-08-25T00:50:40Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubHelper.java", "diffHunk": "@@ -85,6 +89,27 @@ public static String getGitHubAccessToken(String code, String githubClientID, St\n         }\n     }\n \n+    /**\n+     * Get license for a specific GitHub repository\n+     * @param gitHub    The GitHub API\n+     * @param repositoryName    Name of the GitHub repository (e.g. dockstore/lambda)\n+     * @return  The LicenseInformation associated with the repository\n+     */\n+    public static LicenseInformation getLicenseInformation(GitHub gitHub, String repositoryName) {\n+        LicenseInformation licenseInformation = new LicenseInformation();\n+        try {\n+            GHRepository repository = gitHub.getRepository(repositoryName);\n+            GHLicense license = repository.getLicense();\n+            if (license == null) {\n+                return new LicenseInformation();\n+            }\n+            licenseInformation.setLicenseName(license.getName());\n+            return licenseInformation;\n+        } catch (IOException e) {\n+            return new LicenseInformation();", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxNDM2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476014362", "bodyText": "Any reason not to log this? Unless it's common, it's a new feature and might be helpful in figuring out what is going wrong.", "author": "coverbeck", "createdAt": "2020-08-25T00:51:12Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubHelper.java", "diffHunk": "@@ -85,6 +89,27 @@ public static String getGitHubAccessToken(String code, String githubClientID, St\n         }\n     }\n \n+    /**\n+     * Get license for a specific GitHub repository\n+     * @param gitHub    The GitHub API\n+     * @param repositoryName    Name of the GitHub repository (e.g. dockstore/lambda)\n+     * @return  The LicenseInformation associated with the repository\n+     */\n+    public static LicenseInformation getLicenseInformation(GitHub gitHub, String repositoryName) {\n+        LicenseInformation licenseInformation = new LicenseInformation();\n+        try {\n+            GHRepository repository = gitHub.getRepository(repositoryName);\n+            GHLicense license = repository.getLicense();\n+            if (license == null) {\n+                return new LicenseInformation();\n+            }\n+            licenseInformation.setLicenseName(license.getName());\n+            return licenseInformation;\n+        } catch (IOException e) {", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxNzYxNQ==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476017615", "bodyText": "Hadn't noticed this before, but it would be nice if the keys were at least constants. But this is already like this in several places, so don't bother", "author": "coverbeck", "createdAt": "2020-08-25T00:56:13Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/AbstractImageRegistry.java", "diffHunk": "@@ -329,12 +331,25 @@ public Tool refreshTool(final long toolId, final Long userId, final UserDAO user\n         logToolRefresh(dashboardPrefix, tool);\n \n         String repositoryId = sourceCodeRepoInterface.getRepositoryId(updatedTool);\n+        String gitUrl = tool.getGitUrl();\n+        String gitRepository = getGitRepositoryFromGitUrl(gitUrl);\n+        sourceCodeRepoInterface.setLicenseInformation(updatedTool, gitRepository);\n         sourceCodeRepoInterface.setDefaultBranchIfNotSet(updatedTool, repositoryId);\n         updatedTool.syncMetadataWithDefault();\n         // Return the updated tool\n         return updatedTool;\n     }\n \n+    public static String getGitRepositoryFromGitUrl(String gitUrl) {\n+        Map<String, String> repoUrlMap = parseGitUrl(gitUrl);\n+        if (repoUrlMap == null) {\n+            return null;\n+        }\n+        String username = repoUrlMap.get(\"Username\");", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAxODgwMA==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476018800", "bodyText": "You're not getting a quay token", "author": "coverbeck", "createdAt": "2020-08-25T00:57:56Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoResource.java", "diffHunk": "@@ -596,9 +596,33 @@ public Tool registerManual(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             tool.setGitUrl(convertHttpsToSsh(tool.getGitUrl()));\n         }\n \n+        // Can't set tool license information here, far too many tests register a tool without a GitHub token\n+        setToolLicenseInformation(user, tool);\n+\n         return toolDAO.findById(id);\n     }\n \n+    /**\n+     * Set the license information for a tool\n+     * @param user  The user the tool belongs to\n+     * @param tool  The tool to get license information for\n+     */\n+    private void setToolLicenseInformation(User user, Tool tool) {\n+        // Get user's quay and git tokens", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMzM5Mw==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476023393", "bodyText": "Interesting, hadn't noticed/clicked until now that you're doing this for the entry, not the version. This means it's getting the license for the repo. Is it going off the default branch? Probably fine for now, but I wonder if we eventually need to track at the version level. It's rare that licenses change, although I've seen it, and I don't know if they're retroactive or not -- I guess it depends on how the license content.", "author": "coverbeck", "createdAt": "2020-08-25T01:04:56Z", "path": "dockstore-webservice/src/test/java/io/dockstore/webservice/helpers/GitHubHelperTest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package io.dockstore.webservice.helpers;\n+\n+import java.io.IOException;\n+\n+import io.dockstore.webservice.core.LicenseInformation;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.kohsuke.github.AbuseLimitHandler;\n+import org.kohsuke.github.GitHub;\n+import org.kohsuke.github.GitHubBuilder;\n+import org.kohsuke.github.RateLimitHandler;\n+\n+public class GitHubHelperTest {\n+\n+    // TODO: Replace repos with something less likely to change\n+    @Test\n+    public void testGitHubLicense() throws IOException {\n+        GitHub gitHub = new GitHubBuilder().withRateLimitHandler(RateLimitHandler.WAIT).withAbuseLimitHandler(\n+                AbuseLimitHandler.WAIT).build();\n+        LicenseInformation licenseInformation = GitHubHelper.getLicenseInformation(gitHub, \"dockstore-testing/md5sum-checker\");", "originalCommit": "8cc08a56b443db935259ee27c762929cedda56ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAzNzg1Mw==", "url": "https://github.com/dockstore/dockstore/pull/3751#discussion_r476037853", "bodyText": "GitHub doesn't track it at version level. There was quite a bit of discussion when this was a draft PR. Check out my PR message (before all the edits)", "author": "garyluu", "createdAt": "2020-08-25T01:26:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMzM5Mw=="}], "type": "inlineReview"}, {"oid": "11a1f103d815d6b994948daa9900b076bbc36dc6", "url": "https://github.com/dockstore/dockstore/commit/11a1f103d815d6b994948daa9900b076bbc36dc6", "message": "PR changes", "committedDate": "2020-08-25T01:39:43Z", "type": "commit"}, {"oid": "3589763e88c79765703e698326d61618a1420d38", "url": "https://github.com/dockstore/dockstore/commit/3589763e88c79765703e698326d61618a1420d38", "message": "Merge branch 'develop' into feature/3675/storeLicenseInfo", "committedDate": "2020-08-25T01:40:20Z", "type": "commit"}, {"oid": "c2155a4c1c5141e44894156299f319dbfd81fd58", "url": "https://github.com/dockstore/dockstore/commit/c2155a4c1c5141e44894156299f319dbfd81fd58", "message": "Merge branch 'develop' into feature/3675/storeLicenseInfo", "committedDate": "2020-08-25T17:36:34Z", "type": "commit"}]}