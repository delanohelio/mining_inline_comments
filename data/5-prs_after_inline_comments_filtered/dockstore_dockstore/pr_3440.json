{"pr_number": 3440, "pr_title": "Enhance validation of dockstore.yml workflows", "pr_createdAt": "2020-04-30T13:36:46Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3440", "timeline": [{"oid": "21abfe9c89292f084bfb69870059c6ad6f61f3d4", "url": "https://github.com/dockstore/dockstore/commit/21abfe9c89292f084bfb69870059c6ad6f61f3d4", "message": "add version even if primary descriptor is not present", "committedDate": "2020-04-28T17:57:07Z", "type": "commit"}, {"oid": "4fc999b729aaa1f4a60db9ee56d1c870cfae7a31", "url": "https://github.com/dockstore/dockstore/commit/4fc999b729aaa1f4a60db9ee56d1c870cfae7a31", "message": "grab dockstore yml test parameter files even if primary descriptor is not found", "committedDate": "2020-04-28T18:07:46Z", "type": "commit"}, {"oid": "7f4301ffc5a56ea34115f8ae02aa74d2c5e37f55", "url": "https://github.com/dockstore/dockstore/commit/7f4301ffc5a56ea34115f8ae02aa74d2c5e37f55", "message": "record validation information for the .dockstore.yml", "committedDate": "2020-04-28T19:53:22Z", "type": "commit"}, {"oid": "b55eaa74788cb0b4882ed317affe30dcbfc1bcc9", "url": "https://github.com/dockstore/dockstore/commit/b55eaa74788cb0b4882ed317affe30dcbfc1bcc9", "message": "if cannot find primary descriptor, now stores validation message", "committedDate": "2020-04-28T19:58:37Z", "type": "commit"}, {"oid": "eb41cced998108293d3998da48a35054c8da7f59", "url": "https://github.com/dockstore/dockstore/commit/eb41cced998108293d3998da48a35054c8da7f59", "message": "fix index issue", "committedDate": "2020-04-29T18:09:04Z", "type": "commit"}, {"oid": "b56a55aafc740fd45b740d6889e07b3f9226cbdc", "url": "https://github.com/dockstore/dockstore/commit/b56a55aafc740fd45b740d6889e07b3f9226cbdc", "message": "add tests for invalid dockstore yml cases", "committedDate": "2020-04-29T19:23:13Z", "type": "commit"}, {"oid": "126836608d06fa052ef4a732c6380a77cce097ca", "url": "https://github.com/dockstore/dockstore/commit/126836608d06fa052ef4a732c6380a77cce097ca", "message": "clean up test", "committedDate": "2020-04-30T13:04:41Z", "type": "commit"}, {"oid": "f3f6342daff9ca45c40249f5241157f879e6bc34", "url": "https://github.com/dockstore/dockstore/commit/f3f6342daff9ca45c40249f5241157f879e6bc34", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services", "committedDate": "2020-04-30T13:37:16Z", "type": "commit"}, {"oid": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "url": "https://github.com/dockstore/dockstore/commit/ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "message": "prettier printing of validations", "committedDate": "2020-04-30T13:38:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE0NjcwOA==", "url": "https://github.com/dockstore/dockstore/pull/3440#discussion_r418146708", "bodyText": "Just my opinion:\nI know it's a hassle to code and I know it's nit-picky, but I think we shouldn't use the (s) in messages -- we know if it's singular or plural.", "author": "coverbeck", "createdAt": "2020-04-30T16:44:38Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -704,20 +708,30 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n                         testJson.setContent(testJsonContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch(\n-                            (SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n                         if (!hasDuplicate) {\n                             version.getSourceFiles().add(testJson);\n                         }\n+                    } else {\n+                        missingParamFiles.add(testParameterPath);\n                     }\n                 }\n+\n+                if (missingParamFiles.size() > 0) {\n+                    validationMessage.put(\"/.dockstore.yml\", String.format(\"The following file(s) are missing: %s.\",", "originalCommit": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE2MTY2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3440#discussion_r418161662", "bodyText": "Can you make \"/.dockstore.yml\" a constant somewhere?  There was a recent ticket saying how it sometimes was \"/dockstore.yml\" and it seems like now is as good a time as any to just start using a constant for that file path.", "author": "garyluu", "createdAt": "2020-04-30T17:10:14Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -704,20 +708,30 @@ private WorkflowVersion setupWorkflowFilesForGitHubVersion(Triple<String, Date,\n                         testJson.setContent(testJsonContent);\n \n                         // Only add test parameter file if it hasn't already been added\n-                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch(\n-                            (SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n+                        boolean hasDuplicate = version.getSourceFiles().stream().anyMatch((SourceFile sf) -> sf.getPath().equals(workflow.getDefaultTestParameterFilePath()) && sf.getType() == testJson.getType());\n                         if (!hasDuplicate) {\n                             version.getSourceFiles().add(testJson);\n                         }\n+                    } else {\n+                        missingParamFiles.add(testParameterPath);\n                     }\n                 }\n+\n+                if (missingParamFiles.size() > 0) {\n+                    validationMessage.put(\"/.dockstore.yml\", String.format(\"The following file(s) are missing: %s.\",\n+                            missingParamFiles.stream().map(paramFile -> String.format(\"'%s'\", paramFile)).collect(Collectors.joining(\", \"))));\n+                }\n             }\n         } else {\n             // File not found or null\n             LOG.info(\"Could not find file \" + primaryDescriptorPath + \" in repo \" + repository);\n-            return null;\n+            validationMessage.put(\"/.dockstore.yml\", \"Could not find the primary descriptor file '\" + primaryDescriptorPath + \"'.\");", "originalCommit": "ba829f2e399ac318243fb4b4ab0a21274c4b54c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c1e9a4026e292aa18cac43bea63fc09f05aa2f9", "url": "https://github.com/dockstore/dockstore/commit/4c1e9a4026e292aa18cac43bea63fc09f05aa2f9", "message": "recommended changes from PR", "committedDate": "2020-04-30T17:20:45Z", "type": "commit"}, {"oid": "bed3b9a92a3b66040deae174c66bc3cf81331dff", "url": "https://github.com/dockstore/dockstore/commit/bed3b9a92a3b66040deae174c66bc3cf81331dff", "message": "fix broken zip function", "committedDate": "2020-04-30T18:04:27Z", "type": "commit"}, {"oid": "b819f9c3aaab01b0aa45a60556daa6a76764202a", "url": "https://github.com/dockstore/dockstore/commit/b819f9c3aaab01b0aa45a60556daa6a76764202a", "message": "ignore dockstore.yml for version validaiton", "committedDate": "2020-04-30T18:12:18Z", "type": "commit"}, {"oid": "7e2e97ef5552aead21cbf61be7a0a9ef68fc4a45", "url": "https://github.com/dockstore/dockstore/commit/7e2e97ef5552aead21cbf61be7a0a9ef68fc4a45", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services", "committedDate": "2020-04-30T18:12:35Z", "type": "commit"}, {"oid": "946e9df396a29df5dbd6a5e2df6f051c6477cfb9", "url": "https://github.com/dockstore/dockstore/commit/946e9df396a29df5dbd6a5e2df6f051c6477cfb9", "message": "fix failing test for webhook", "committedDate": "2020-04-30T19:00:06Z", "type": "commit"}, {"oid": "945541dbe67f1043c584499a6a92c23d5ab7c740", "url": "https://github.com/dockstore/dockstore/commit/945541dbe67f1043c584499a6a92c23d5ab7c740", "message": "Merge branch 'develop' into feature/3416/disable-refresh-from-services", "committedDate": "2020-05-01T17:55:27Z", "type": "commit"}]}