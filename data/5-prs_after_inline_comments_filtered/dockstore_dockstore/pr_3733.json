{"pr_number": 3733, "pr_title": ".dockstore.yml in .github/ dir & Adding filters to .dockstore.yml", "pr_createdAt": "2020-08-12T14:08:24Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3733", "timeline": [{"oid": "14da001ab89111d819109f2ad2d805eb2a00b131", "url": "https://github.com/dockstore/dockstore/commit/14da001ab89111d819109f2ad2d805eb2a00b131", "message": "add filters to .dockstore.yml (WIP - needs tests)", "committedDate": "2020-08-11T15:37:41Z", "type": "commit"}, {"oid": "5e7a04d03fa89d54a79ba335bba7993914dfb124", "url": "https://github.com/dockstore/dockstore/commit/5e7a04d03fa89d54a79ba335bba7993914dfb124", "message": "add .github/.dockstore.yml as alternative .dockstore.yml path", "committedDate": "2020-08-12T13:44:56Z", "type": "commit"}, {"oid": "5418612a6478e31f1738f7520bef088fd3cf07b9", "url": "https://github.com/dockstore/dockstore/commit/5418612a6478e31f1738f7520bef088fd3cf07b9", "message": "tests for .dockstore.yml in .github/ & filters", "committedDate": "2020-08-12T13:45:57Z", "type": "commit"}, {"oid": "be93ff94bf2c6fe87318067c8dfc86d5874f1d34", "url": "https://github.com/dockstore/dockstore/commit/be93ff94bf2c6fe87318067c8dfc86d5874f1d34", "message": "fix misleading filters comment", "committedDate": "2020-08-12T14:11:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNTA5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469305097", "bodyText": "too similar to the other part, combine somehow.", "author": "garyluu", "createdAt": "2020-08-12T14:33:09Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -411,6 +430,21 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n             GitHubSourceCodeRepo gitHubSourceCodeRepo, User user, final SourceFile dockstoreYml) {\n         final List<Workflow> updatedServices = new ArrayList<>();\n         if (service != null) {\n+            final Path gitRefPath = Path.of(gitReference);\n+            final List<String> filters = service.getFilter();\n+            // Ignore filters if none specified\n+            Boolean isFiltered = !filters.isEmpty();\n+            for (String filter : filters) {\n+                final PathMatcher pathMatcher = FileSystems.getDefault().getPathMatcher(\"glob:**/\" + filter);\n+                // If filter matches, don't exclude service\n+                if (pathMatcher.matches(gitRefPath)) {\n+                    isFiltered = false;\n+                    break;\n+                }\n+            }", "originalCommit": "be93ff94bf2c6fe87318067c8dfc86d5874f1d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNjc2MA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469306760", "bodyText": "There's a way to stream() anymatch/nonematch this", "author": "garyluu", "createdAt": "2020-08-12T14:35:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -411,6 +430,21 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n             GitHubSourceCodeRepo gitHubSourceCodeRepo, User user, final SourceFile dockstoreYml) {\n         final List<Workflow> updatedServices = new ArrayList<>();\n         if (service != null) {\n+            final Path gitRefPath = Path.of(gitReference);\n+            final List<String> filters = service.getFilter();\n+            // Ignore filters if none specified\n+            Boolean isFiltered = !filters.isEmpty();\n+            for (String filter : filters) {\n+                final PathMatcher pathMatcher = FileSystems.getDefault().getPathMatcher(\"glob:**/\" + filter);\n+                // If filter matches, don't exclude service\n+                if (pathMatcher.matches(gitRefPath)) {\n+                    isFiltered = false;\n+                    break;\n+                }\n+            }", "originalCommit": "be93ff94bf2c6fe87318067c8dfc86d5874f1d34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "409f7ae2398a22be74a165874b872909981a90d5", "url": "https://github.com/dockstore/dockstore/commit/409f7ae2398a22be74a165874b872909981a90d5", "message": "filtering code for workflows/services abstracted into 1 function", "committedDate": "2020-08-12T15:17:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469340822", "bodyText": "Have not worked with this library yet (looks like a good choice though)\nDoes  this **/ mean that if someone specifies develop as a filter will it will match a branch called feature/develop?\nAlternatively, will it be hubflow compatible?\nFor example if someone specifies feature/foo as a filter, will this work or would it only match potato/feature/foo?", "author": "denis-yuen", "createdAt": "2020-08-12T15:21:57Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -383,7 +386,23 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n             final SourceFile dockstoreYml) {\n         try {\n             List<Workflow> updatedWorkflows = new ArrayList<>();\n+            final Path gitRefPath = Path.of(gitReference);\n             for (YamlWorkflow wf : yamlWorkflows) {\n+                final List<String> filters = wf.getFilter();\n+                // Ignore filters if none specified\n+                Boolean isFiltered = !filters.isEmpty();\n+                for (String filter : filters) {\n+                    final PathMatcher pathMatcher = FileSystems.getDefault().getPathMatcher(\"glob:**/\" + filter);", "originalCommit": "be93ff94bf2c6fe87318067c8dfc86d5874f1d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0NDg3Mw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469344873", "bodyText": "This library should behave exactly like Unix globbing.\nIf someone specified develop, then any reference path ending in develop would match.\nIf you wanted to only match the exact develop branch, then to be safe using heads/develop or even better the full refs/heads/develop path will work.\nThe only caveat is if for whatever reason you have branchs called something like feature/refs/heads/develop.", "author": "GFJHogue", "createdAt": "2020-08-12T15:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM1MzIyNQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469353225", "bodyText": "Ok, open to discussion with others on #dockstore.\nWhat I would expect is that develop would match only develop and that one would need to use *develop or foo/develop to match foo/develop\nSimilarly, I would expect feature/foo to match feature/foo but not potato/feature/foo\nI guess the simpler way to explain would be that I would expect to have to specify a * to use globbing in the filter and that otherwise it would be an exact match. In fact, looking around I think the convention is to use slashes to surround regular expressions otherwise exact match. Sorry for not catching that in the original ticket.\nPossible documentation examples\nhttps://www.appveyor.com/docs/branches/\nRegular expressions should be surrounded by /, otherwise Appveyor will do simple case insensitive string comparison.\n\nhttps://circleci.com/docs/2.0/configuration-reference/#filters-1\nBranches can have the keys only and ignore which either map to a single string naming a branch. You may also use regular expressions to match against branches by enclosing them with slashes, or map to a list of such strings. Regular expressions must match the entire string.\n\nhttps://docs.travis-ci.com/user/customizing-the-build#safelisting-or-blocklisting-branches\nAny name surrounded with / in the list of branches is treated as a regular expression and can contain any quantifiers, anchors or character classes supported by Ruby regular expressions.", "author": "denis-yuen", "createdAt": "2020-08-12T15:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM2ODQ2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469368469", "bodyText": "Perhaps a simple solution to this implementation-wise could be trying 2 separate matchers where instead of **/ leading the glob, we have:\n\nrefs/heads/\nrefs/tags/\nThis way it's enforced that the branch/tag is always an exact match to some tag or branch.\n\nOptionally there can also be refs/ to allow for specifying a tag or a branch.", "author": "GFJHogue", "createdAt": "2020-08-12T15:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM3NjQwMA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469376400", "bodyText": "It is worth a try.\nLooking through these pages, it seems some require the user to specify whether the filter is for a tag or for a branch. Some seem to assume that names of tags cannot overlap with branches which is probably true in 99% of cases", "author": "denis-yuen", "createdAt": "2020-08-12T16:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5MTM2NQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469391365", "bodyText": "Added this in latest commit", "author": "GFJHogue", "createdAt": "2020-08-12T16:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM0MDgyMg=="}], "type": "inlineReview"}, {"oid": "dd8319235203ceb7871a1d1593ed9fe0a9026a83", "url": "https://github.com/dockstore/dockstore/commit/dd8319235203ceb7871a1d1593ed9fe0a9026a83", "message": "remove leading slash from filters glob pathMatcher", "committedDate": "2020-08-12T15:44:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MjE4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469382189", "bodyText": "I think this should go somewhere else -- if we ever add dockstore.yml support to tools, this code wouldn't be accessible.\nI think this method is a good candidate for unit tests, where you could throw a bunch of patterns it at to make sure they work as expected.\nCircleCI filters have separate subsections for branches and tags. We're not going with that syntax, which is fine, but I think we need to have that functionality expressable. Maybe it's already here and I just don't know the pattern of a gitRefPath, but for example, is it possible to:\n\nFilter for all tags but no branches\nFilter for all releases, no branches, and no tags that aren't also releases (this one is a stretch and may not be possible)\nOther patterns that I can't think of?\n\n\n\nIf these are possible, could you give examples in comments and/or the unit tests? If not, I think we need to handle them, in particular the only filter tags case.", "author": "coverbeck", "createdAt": "2020-08-12T16:19:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -419,6 +430,19 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n         return updatedServices;\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    private boolean filterGitReference(final Path gitRefPath, final List<String> filters) {", "originalCommit": "dd8319235203ceb7871a1d1593ed9fe0a9026a83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQwMTg4NQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469401885", "bodyText": "I think this should go somewhere else -- if we ever add dockstore.yml support to tools, this code wouldn't be accessible.\n\n\nI'll look into that\n\n\nI think this method is a good candidate for unit tests, where you could throw a bunch of patterns it at to make sure they work as expected.\n\n\nTrue, that would have been a good alternative to the integration test I made...\n\n\nCircleCI filters have separate subsections for branches and tags. We're not going with that syntax, which is fine, but I think we need to have that functionality expressable. Maybe it's already here and I just don't know the pattern of a gitRefPath, but for example, is it possible to:\n\n\nAfter discussion with Denis above & my most recent commit:\n\n\nFilter for all tags but no branches\n\n\ntags/**\nOther way around: heads/**\n\n\nFilter for all releases, no branches, and no tags that aren't also releases (this one is a stretch and may not be possible)\n\n\nNot sure how to tell whether a git reference is a release, unless releases have consistent tag naming.\n- tags/1.0.*\n- tags/1.1.*\n...\n\n\n\nOther patterns that I can't think of?\n\n\nPathMatcher docs detail how to make more advanced globs.\nI'm currently automatically prefixing filter globs with refs/{,heads/,tags/}.\nHere is a handy site I found for experimenting with globbing patterns: https://globster.xyz/", "author": "GFJHogue", "createdAt": "2020-08-12T16:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MjE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODg2Mw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469418863", "bodyText": "True, that would have been a good alternative to the integration test I made...\n\nI would argue it's a good complement to integration tests, not either/or. If you want to test 20 different patterns, it's going to be time consuming and require a lot of set up with integration tests (create a branch named x, create a branch named y, create a tag named z, etc.).", "author": "coverbeck", "createdAt": "2020-08-12T17:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4MjE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4NzUyMw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469387523", "bodyText": "I always go back and forth in my head about the meaning of filter (filter in or filter out?), but in Java, streams (and JavaScript filter as well), a filter that returns true means it should be included, so I think you should either rename this function or keep the name and reverse what it returns.", "author": "coverbeck", "createdAt": "2020-08-12T16:28:06Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -419,6 +430,19 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n         return updatedServices;\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    private boolean filterGitReference(final Path gitRefPath, final List<String> filters) {", "originalCommit": "dd8319235203ceb7871a1d1593ed9fe0a9026a83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4ODkzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469388939", "bodyText": "I find double negatives harder to understand; if you reverse the return value of the function per my other suggestion, then you wouldn't need the negations here.", "author": "coverbeck", "createdAt": "2020-08-12T16:30:27Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -419,6 +430,19 @@ private LambdaEvent createBasicEvent(String repository, String gitReference, Str\n         return updatedServices;\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    private boolean filterGitReference(final Path gitRefPath, final List<String> filters) {\n+        return !filters.isEmpty() && !filters.stream().anyMatch(filter -> {", "originalCommit": "dd8319235203ceb7871a1d1593ed9fe0a9026a83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6daec496ad56e33ebce96f80bf8aa59fd4ea5368", "url": "https://github.com/dockstore/dockstore/commit/6daec496ad56e33ebce96f80bf8aa59fd4ea5368", "message": "remove leading ** from filters matching & use a git reference \"template\"", "committedDate": "2020-08-12T16:31:32Z", "type": "commit"}, {"oid": "82eaa14aade81d93ed883788ccd563ecc6d4b4e4", "url": "https://github.com/dockstore/dockstore/commit/82eaa14aade81d93ed883788ccd563ecc6d4b4e4", "message": "relocate filterGitReference() and negate boolean result", "committedDate": "2020-08-12T17:04:44Z", "type": "commit"}, {"oid": "bbff5e4792972f9ae11db30953986f6f82f86a9e", "url": "https://github.com/dockstore/dockstore/commit/bbff5e4792972f9ae11db30953986f6f82f86a9e", "message": "move function above inner class to fix checkstyle error", "committedDate": "2020-08-12T17:34:06Z", "type": "commit"}, {"oid": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "url": "https://github.com/dockstore/dockstore/commit/773cdc2ca21ef27973d5e2595c8756e232ea6070", "message": "regex filters (surround with /) & unit test", "committedDate": "2020-08-12T19:28:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5OTg3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469599879", "bodyText": "I think these should be assertFalse -- I was going to write a comment about how you should have some negative tests.", "author": "coverbeck", "createdAt": "2020-08-12T23:20:23Z", "path": "dockstore-common/src/test/java/io/dockstore/common/yaml/DockstoreYamlTest.java", "diffHunk": "@@ -198,4 +202,81 @@ public void testGalaxySubclass() throws DockstoreYamlHelper.DockstoreYamlExcepti\n         assertEquals(4, workflows.stream().filter(w -> w.getSubclass().equalsIgnoreCase(\"gxformat2\")).count());\n     }\n \n+    @Test\n+    public void testGitReferenceFilter() {\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"anything\"), List.of()));\n+\n+        // Generic name filter\n+        // Glob\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"develop\")));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), List.of(\"develop\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), List.of(\"develop\")));", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwMTM4Mw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469601383", "bodyText": "Contradicting what I said in Slack, I think this should pass. The string 'develop' is in the path.", "author": "coverbeck", "createdAt": "2020-08-12T23:25:02Z", "path": "dockstore-common/src/test/java/io/dockstore/common/yaml/DockstoreYamlTest.java", "diffHunk": "@@ -198,4 +202,81 @@ public void testGalaxySubclass() throws DockstoreYamlHelper.DockstoreYamlExcepti\n         assertEquals(4, workflows.stream().filter(w -> w.getSubclass().equalsIgnoreCase(\"gxformat2\")).count());\n     }\n \n+    @Test\n+    public void testGitReferenceFilter() {\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"anything\"), List.of()));\n+\n+        // Generic name filter\n+        // Glob\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"develop\")));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), List.of(\"develop\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), List.of(\"develop\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/foo/develop\"), List.of(\"develop\")));\n+        // Regex\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"/develop/\")));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), List.of(\"/develop/\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), List.of(\"/develop/\")));", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NDI1NA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469964254", "bodyText": "Continuing discussion on #dockstore so we can align on desired behaviour", "author": "GFJHogue", "createdAt": "2020-08-13T13:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwMTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNDg1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469604855", "bodyText": "I'm getting confused by this automatic start to the regex. It may be OK, and I just may not be understanding it, so speculating at this point:\nAs an example, how would I specify via RegEx all tags that start with Release?  As an end-user, I would be inclined to to write /^tags\\/Release.*/, but I don't think the double caret in here would work in conjunction the existing caret in ^refs.\nShould I instead write /^refs\\/tags\\/Release.*/? Although I'd still have the same problem.", "author": "coverbeck", "createdAt": "2020-08-12T23:35:46Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +198,26 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final List<String> filters) {\n+        return filters.isEmpty() || filters.stream().anyMatch(filter -> {\n+            String matcherString;\n+            // Use regex if filter string is surrounded by /\n+            if (filter.matches(\"^\\\\/.*\\\\/$\")) {\n+                matcherString = \"regex:^refs\\\\/(heads\\\\/|tags\\\\/|)\" + filter.substring(1, filter.length() - 1);", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MjU3OA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469962578", "bodyText": "I'm getting confused by this automatic start to the regex. It may be OK, and I just may not be understanding it, so speculating at this point:\n\nSo the automatic starts for both the regex & glob are equivalent to eachother and are required to achieve the behaviour we're looking for.\nFor instance, with regex we want /develop/ to match refs/heads/develop.\nBut we also want to specify something like /tags\\/.*/ (tags only) to match refs/tags/anything and not refs/heads/anything.\n\nAs an example, how would I specify via RegEx all tags that start with Release?\n\n/tags\\/Release.*/\n\nAs an end-user, I would be inclined to to write /^tags\\/Release.*/, but I don't think the double caret in here would work in conjunction the existing caret in ^refs.\n\nThe caret wouldn't work with the current prepended regex; /^tags\\/Release.*/ would become ^refs\\\\/(heads\\\\/|tags\\\\/|)^tags\\/Release.*.\nI think that as long as we clearly document the precise behaviour & have some usage examples in our documentation, users can easily find out what to expect & achieve desired behaviour.", "author": "GFJHogue", "createdAt": "2020-08-13T13:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNDg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNzA1MA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469607050", "bodyText": "What happens if the filter is not a valid regex, which will inevitably happen? Does the code on line 216 thrown an exception? Took a brief look at the code, and I think it does throw an exception:\nSome thoughts:\n\nLet it throw an exception, and we don't process the .dockstore.yml\nCatch the exception, and don't process the .dockstore.yml\nCatch the exception, and treat it as a filter that didn't pass, move on to next filter.\nValidate the filters when loading the .dockstore.yml and treat it as an invalid .dockstore.yml to start with.", "author": "coverbeck", "createdAt": "2020-08-12T23:43:04Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +198,26 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final List<String> filters) {\n+        return filters.isEmpty() || filters.stream().anyMatch(filter -> {\n+            String matcherString;\n+            // Use regex if filter string is surrounded by /\n+            if (filter.matches(\"^\\\\/.*\\\\/$\")) {\n+                matcherString = \"regex:^refs\\\\/(heads\\\\/|tags\\\\/|)\" + filter.substring(1, filter.length() - 1);", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAxNjQxOQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r470016419", "bodyText": "Great point, something like /[/ would throw an error.\nProbably best to handle the error here https://github.com/dockstore/dockstore/pull/3733/files#diff-d792d91142c26ee5507333d7d3db9acfR337", "author": "GFJHogue", "createdAt": "2020-08-13T14:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNzA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwODE5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469608197", "bodyText": "Edge case: What if the pattern is //? Will it match everything or nothing? Probably OK.", "author": "coverbeck", "createdAt": "2020-08-12T23:46:51Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +198,26 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final List<String> filters) {\n+        return filters.isEmpty() || filters.stream().anyMatch(filter -> {\n+            String matcherString;\n+            // Use regex if filter string is surrounded by /\n+            if (filter.matches(\"^\\\\/.*\\\\/$\")) {", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3NDU5MA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469974590", "bodyText": "It will match nothing.\nIf the pattern is // the effective regex will be just the prepended part ^refs\\\\/(heads\\\\/|tags\\\\/|).\nThat can only match strings refs/, refs/heads/, & refs/tags/ which are all impossible (Path objects don't even keep the trailing /).", "author": "GFJHogue", "createdAt": "2020-08-13T14:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwODE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMDU3Mw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469610573", "bodyText": "Escaping gets confusing; I wonder if anything might get lost when going from the YAML to here.\nLet's say I want to only filter tags that use semantic versioning. I would have a regex something like this in the YAML: \\d+\\.\\d+\\.\\d+. Will that work? At first I was thinking it wouldn't, but now I think it would. If I wrote that in Java, I think I would have to escape the backslashes themselves. But that might be only for the compiler, so maybe this does work. Worth adding a test for in any case.", "author": "coverbeck", "createdAt": "2020-08-12T23:54:37Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +198,26 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final List<String> filters) {\n+        return filters.isEmpty() || filters.stream().anyMatch(filter -> {\n+            String matcherString;\n+            // Use regex if filter string is surrounded by /\n+            if (filter.matches(\"^\\\\/.*\\\\/$\")) {\n+                matcherString = \"regex:^refs\\\\/(heads\\\\/|tags\\\\/|)\" + filter.substring(1, filter.length() - 1);", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3OTg2Mw==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r469979863", "bodyText": "Escaping is only really a thing for Java string literals here... need to use \\\\ to be interpreted as a \\.\nYAML reading shouldn't behave like this, but I can check with the library we use to read it.", "author": "GFJHogue", "createdAt": "2020-08-13T14:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgxMDk3MA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r475810970", "bodyText": "Integration test now uses an example with \\d+\\.\\d+", "author": "GFJHogue", "createdAt": "2020-08-24T18:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMDU3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMzU3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r470003579", "bodyText": "Can continue discussion in #dockstore but we probably need a new thread.\nI apologize for not catching this earlier, I'm not keen on the user needing to know the heads syntax, it doesn't seem to show up in the CI docs (I'm referring to circle, travis, appveyer)\nBut I think we can simplify things by doing regexes and exact match only, not globs as well (matching CI docs)\nAlternatively, we can discuss trade-offs of exact match and globs only?\nI realize this contradicts the original ticket. This is a lot hairier than I originally expected.", "author": "denis-yuen", "createdAt": "2020-08-13T14:41:06Z", "path": "dockstore-common/src/test/java/io/dockstore/common/yaml/DockstoreYamlTest.java", "diffHunk": "@@ -198,4 +202,81 @@ public void testGalaxySubclass() throws DockstoreYamlHelper.DockstoreYamlExcepti\n         assertEquals(4, workflows.stream().filter(w -> w.getSubclass().equalsIgnoreCase(\"gxformat2\")).count());\n     }\n \n+    @Test\n+    public void testGitReferenceFilter() {\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"anything\"), List.of()));\n+\n+        // Generic name filter\n+        // Glob\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"develop\")));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), List.of(\"develop\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), List.of(\"develop\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/foo/develop\"), List.of(\"develop\")));\n+        // Regex\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"/develop/\")));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), List.of(\"/develop/\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), List.of(\"/develop/\")));\n+        assertTrue(!DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/foo/develop\"), List.of(\"/develop/\")));\n+\n+        // Branch-only name filter\n+        // Glob\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), List.of(\"heads/develop\")));", "originalCommit": "773cdc2ca21ef27973d5e2595c8756e232ea6070", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16c90b9271280863282adcb8764da964c7d8adfc", "url": "https://github.com/dockstore/dockstore/commit/16c90b9271280863282adcb8764da964c7d8adfc", "message": "Merge remote-tracking branch 'origin/develop' into feature/3695/dockstoreyml-filters", "committedDate": "2020-08-14T18:14:45Z", "type": "commit"}, {"oid": "7f5b3ab0069a05dc9a51927fa753eb8487fd0ba9", "url": "https://github.com/dockstore/dockstore/commit/7f5b3ab0069a05dc9a51927fa753eb8487fd0ba9", "message": "separate tags and branches filters; broken WebHookIT test needs fixing", "committedDate": "2020-08-14T22:09:13Z", "type": "commit"}, {"oid": "f9d33bba66df41b8e3dbbe85a4719d5e1a33f0f3", "url": "https://github.com/dockstore/dockstore/commit/f9d33bba66df41b8e3dbbe85a4719d5e1a33f0f3", "message": "fixed integration tests: allow null filters, handle/log regex errors", "committedDate": "2020-08-24T16:27:58Z", "type": "commit"}, {"oid": "035f7cbd347d5640bba7ce646dd7d81970cdf7bb", "url": "https://github.com/dockstore/dockstore/commit/035f7cbd347d5640bba7ce646dd7d81970cdf7bb", "message": "Merge remote-tracking branch 'origin/develop' into feature/3695/dockstoreyml-filters", "committedDate": "2020-08-24T16:28:14Z", "type": "commit"}, {"oid": "44f4940283ca992a0934580bb43606063e379f74", "url": "https://github.com/dockstore/dockstore/commit/44f4940283ca992a0934580bb43606063e379f74", "message": "fix unit test - regex error no longer fails", "committedDate": "2020-08-24T18:28:09Z", "type": "commit"}, {"oid": "9b611886a6a132b8f895cf35c5c4b047d9f267d2", "url": "https://github.com/dockstore/dockstore/commit/9b611886a6a132b8f895cf35c5c4b047d9f267d2", "message": "remove unused imports from unit tests", "committedDate": "2020-08-24T18:30:33Z", "type": "commit"}, {"oid": "1d8aa3b54accef1a02977cbbed16eb121efa2906", "url": "https://github.com/dockstore/dockstore/commit/1d8aa3b54accef1a02977cbbed16eb121efa2906", "message": "Merge branch 'develop' into feature/3695/dockstoreyml-filters", "committedDate": "2020-08-25T13:43:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4MzQzNQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477383435", "bodyText": "Yes, it should at least do a LOG.warn probably error\nIn fact, this seems so unexpected it should probably throw an exception and die hard rather than (only) log", "author": "denis-yuen", "createdAt": "2020-08-26T15:19:03Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +199,52 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final Filters filters) {\n+        final List<String> branches = filters.getBranches();\n+        final List<String> tags = filters.getTags();\n+\n+        // If no filters specified, accept anything\n+        if (branches.isEmpty() && tags.isEmpty()) {\n+            return true;\n+        }\n+\n+        List<String> patterns;\n+        if (gitRefPath.startsWith(\"refs/heads/\")) {\n+            patterns = branches;\n+        } else if (gitRefPath.startsWith(\"refs/tags/\")) {\n+            patterns = tags;\n+        } else {\n+            // Reaching this is unexpected - should have a warning here.", "originalCommit": "1d8aa3b54accef1a02977cbbed16eb121efa2906", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NTkwMA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477385900", "bodyText": "\ud83d\udc40  (technically semantic, but would be harder regex, don't need to change)", "author": "denis-yuen", "createdAt": "2020-08-26T15:22:20Z", "path": "dockstore-common/src/test/java/io/dockstore/common/yaml/DockstoreYamlTest.java", "diffHunk": "@@ -198,4 +207,65 @@ public void testGalaxySubclass() throws DockstoreYamlHelper.DockstoreYamlExcepti\n         assertEquals(4, workflows.stream().filter(w -> w.getSubclass().equalsIgnoreCase(\"gxformat2\")).count());\n     }\n \n+    @Test\n+    public void testGitReferenceFilter() {\n+        // Empty filters allow anything\n+        Filters filters = new Filters();\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/anything\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/any/thing\"), filters));\n+\n+        // Only match develop branch\n+        // glob\n+        filters.setBranches(List.of(\"develop\"));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/developfoo\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), filters));\n+        // regex\n+        filters.setBranches(List.of());\n+        filters.setBranches(List.of(\"/develop/\"));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/develop\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/develop\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/developfoo\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/develop\"), filters));\n+\n+        // Only match 0.1 tag\n+        // glob\n+        filters.setBranches(List.of());\n+        filters.setTags(List.of(\"0.1\"));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/0.1\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/foo/0.1\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/0.1/foo\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/0.1\"), filters));\n+        // regex\n+        filters.setBranches(List.of());\n+        filters.setTags(List.of(\"/0\\\\.1/\"));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/0.1\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/foo/0.1\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/0.1/foo\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/0.1\"), filters));\n+\n+        // Match any feature/** branch and ALL tags\n+        // glob/regex combo\n+        filters.setBranches(List.of(\"feature/**\"));\n+        filters.setTags(List.of(\"/.*/\"));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/feature\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/feature/1234\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/feature/1234/filters\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/foo/feature/1234\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/heads/featurefoo\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/anything\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/any/thing\"), filters));\n+\n+        // X.X.X semantic version tags with regex\n+        filters.setBranches(List.of());\n+        filters.setTags(List.of(\"/\\\\d+\\\\.\\\\d+\\\\.\\\\d+/\"));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/0.0.0\"), filters));\n+        assertTrue(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/1.10.0\"), filters));\n+        assertFalse(DockstoreYamlHelper.filterGitReference(Path.of(\"refs/tags/1.10.0-beta\"), filters));", "originalCommit": "1d8aa3b54accef1a02977cbbed16eb121efa2906", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM4NzY2OA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477387668", "bodyText": "Code base is getting large enough, please add a link to https://github.com/DockstoreTestUser2/dockstoreyml-github-filters-test in the comment here for reviewers (we haven't done this before)", "author": "denis-yuen", "createdAt": "2020-08-26T15:24:45Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/WebhookIT.java", "diffHunk": "@@ -417,4 +419,94 @@ public void testInvalidDockstoreYmlFiles() throws Exception {\n             assertTrue(\"There should be 1 unsuccessful event\", failEvents.stream().filter(lambdaEvent -> !lambdaEvent.isSuccess()).count() == 1);\n         }\n     }\n+\n+    /**\n+     * This tests the GitHub release with .dockstore.yml located in /.github/.dockstore.yml\n+     */\n+    @Test\n+    public void testGithubDirDockstoreYml() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate2(SUPPORT, false);\n+        final ApiClient webClient = getWebClient(BasicIT.USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi client = new WorkflowsApi(webClient);\n+\n+        client.handleGitHubRelease(githubFiltersRepo, BasicIT.USER_2_USERNAME, \"refs/tags/1.0\", installationId);\n+        Workflow workflow = client.getWorkflowByPath(\"github.com/\" + githubFiltersRepo + \"/filternone\", \"\", false);\n+        assertNotNull(workflow);\n+    }\n+\n+    /**\n+     * This tests filters functionality in .dockstore.yml ; Workflow filters are configured as follows:", "originalCommit": "1d8aa3b54accef1a02977cbbed16eb121efa2906", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22b99d48c1bca5b738fedbf2b8e5a18d6fbd9bd2", "url": "https://github.com/dockstore/dockstore/commit/22b99d48c1bca5b738fedbf2b8e5a18d6fbd9bd2", "message": "Merge branch 'develop' into feature/3695/dockstoreyml-filters", "committedDate": "2020-08-26T17:04:11Z", "type": "commit"}, {"oid": "45ce82a517c348728930b79945a57d5f0d86ffcc", "url": "https://github.com/dockstore/dockstore/commit/45ce82a517c348728930b79945a57d5f0d86ffcc", "message": "throw exception on invalid git reference", "committedDate": "2020-08-26T18:56:37Z", "type": "commit"}, {"oid": "f9ef455574d5c5d5df4ca47de5b5917b252b04ba", "url": "https://github.com/dockstore/dockstore/commit/f9ef455574d5c5d5df4ca47de5b5917b252b04ba", "message": "use UnsupportedOperationException for invalid git reference error", "committedDate": "2020-08-26T19:16:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcwNzY3Ng==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477707676", "bodyText": "Is it possible to have a glob syntax error (I don't know)? if it is, does it throw a PatternSyntaxException or something else? If something else, then you'd need to catch it.", "author": "coverbeck", "createdAt": "2020-08-26T23:52:23Z", "path": "dockstore-common/src/main/java/io/dockstore/common/yaml/DockstoreYamlHelper.java", "diffHunk": "@@ -194,6 +199,51 @@ private static Validator createValidator() {\n         return validatorFactory.getValidator();\n     }\n \n+    /**\n+     * Decide whether a gitReference is excluded, given a workflow/service's filters\n+     * @param gitRefPath Path.of(gitReference) for glob matching with PathMatcher\n+     * @param filters Filters specified for a workflow/service in .dockstore.yml\n+     * @return\n+     */\n+    public static boolean filterGitReference(final Path gitRefPath, final Filters filters) {\n+        final List<String> branches = filters.getBranches();\n+        final List<String> tags = filters.getTags();\n+\n+        // If no filters specified, accept anything\n+        if (branches.isEmpty() && tags.isEmpty()) {\n+            return true;\n+        }\n+\n+        List<String> patterns;\n+        if (gitRefPath.startsWith(\"refs/heads/\")) {\n+            patterns = branches;\n+        } else if (gitRefPath.startsWith(\"refs/tags/\")) {\n+            patterns = tags;\n+        } else {\n+            throw new UnsupportedOperationException(\"Invalid git reference: \" + gitRefPath.toString());\n+        }\n+\n+        // Remove refs/heads/ or refs/tags/ from Path for matching\n+        final Path matchPath = gitRefPath.subpath(2, gitRefPath.getNameCount());\n+        return patterns.stream().anyMatch(pattern -> {\n+            String matcherString;\n+            // Use regex if pattern string is surrounded by /, otherwise use glob\n+            if (pattern.matches(\"^\\\\/.*\\\\/$\")) {\n+                matcherString = \"regex:\" + pattern.substring(1, pattern.length() - 1);\n+            } else {\n+                matcherString = \"glob:\" + pattern;\n+            }\n+            try {\n+                final PathMatcher pathMatcher = FileSystems.getDefault().getPathMatcher(matcherString);\n+                return pathMatcher.matches(matchPath);\n+            } catch (PatternSyntaxException e) {", "originalCommit": "f9ef455574d5c5d5df4ca47de5b5917b252b04ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ0MDA1Mg==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r478440052", "bodyText": "There shouldn't be anything else according to https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/FileSystem.html#getPathMatcher(java.lang.String) but I can catch UnsupportedOperationException just to be safe.", "author": "GFJHogue", "createdAt": "2020-08-27T13:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcwNzY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcxNjE2MA==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477716160", "bodyText": "You could make this List.of(DOCKSTORE_YML_PATH, \"/.github/.dockstore.yml\");", "author": "coverbeck", "createdAt": "2020-08-26T23:58:00Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/Constants.java", "diffHunk": "@@ -25,6 +27,7 @@\n     public static final String OPTIONAL_AUTH_MESSAGE = \"Does not require authentication for published workflows,\"\n             + \" authentication can be provided for restricted workflows\";\n     public static final String DOCKSTORE_YML_PATH = \"/.dockstore.yml\";\n+    public static final List<String> DOCKSTORE_YML_PATHS = List.of(\"/.dockstore.yml\", \"/.github/.dockstore.yml\");", "originalCommit": "f9ef455574d5c5d5df4ca47de5b5917b252b04ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzcyNzg2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3733#discussion_r477727869", "bodyText": "A test for invalid regex (and glob?, see my other comment) would be a bonus.", "author": "coverbeck", "createdAt": "2020-08-27T00:05:07Z", "path": "dockstore-common/src/test/java/io/dockstore/common/yaml/DockstoreYamlTest.java", "diffHunk": "@@ -198,4 +208,68 @@ public void testGalaxySubclass() throws DockstoreYamlHelper.DockstoreYamlExcepti\n         assertEquals(4, workflows.stream().filter(w -> w.getSubclass().equalsIgnoreCase(\"gxformat2\")).count());\n     }\n \n+    @Test\n+    public void testGitReferenceFilter() {", "originalCommit": "f9ef455574d5c5d5df4ca47de5b5917b252b04ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b560c1806f88fbd532a64d0478bc574557cb2476", "url": "https://github.com/dockstore/dockstore/commit/b560c1806f88fbd532a64d0478bc574557cb2476", "message": "invalid glob/regex unit test, matcher catch UnsupportedOperation", "committedDate": "2020-08-27T14:26:52Z", "type": "commit"}, {"oid": "cf082c35e3e5aab9ef569eff38ee6b6826bac9b7", "url": "https://github.com/dockstore/dockstore/commit/cf082c35e3e5aab9ef569eff38ee6b6826bac9b7", "message": "close comment bracket", "committedDate": "2020-08-27T14:44:15Z", "type": "commit"}, {"oid": "9f6a313c160e40288de8d7c716a99422d2819d24", "url": "https://github.com/dockstore/dockstore/commit/9f6a313c160e40288de8d7c716a99422d2819d24", "message": "Merge branch 'develop' into feature/3695/dockstoreyml-filters", "committedDate": "2020-08-27T17:26:45Z", "type": "commit"}]}