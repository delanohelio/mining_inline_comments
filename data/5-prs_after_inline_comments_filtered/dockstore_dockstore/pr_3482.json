{"pr_number": 3482, "pr_title": "Sourcefiles endpoint", "pr_createdAt": "2020-05-19T21:14:17Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3482", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMzYxNw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427613617", "bodyText": "From a user point of view, this seems unnecessary.  If they know the versionId, entryType should be irrelevant.", "author": "garyluu", "createdAt": "2020-05-19T21:34:11Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {\n+    private static final Logger LOG = LoggerFactory.getLogger(SourceFileResource.class);\n+\n+    private final SessionFactory sessionFactory;\n+    private final TagDAO tagDAO;\n+    private final WorkflowVersionDAO workflowVersionDAO;\n+\n+\n+    public SourceFileResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.tagDAO = new TagDAO(sessionFactory);\n+        this.workflowVersionDAO = new WorkflowVersionDAO(sessionFactory);\n+\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{versionId}/sourcefiles\")\n+    @ApiOperation(value = \"Retrieve sourcefiles for an entry version\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, responseContainer = \"Set\", response = SourceFile.class)\n+    public SortedSet<SourceFile> getSourceFiles(@ApiParam(hidden = true) @Auth User user,\n+        @ApiParam(value = \"Version to retrieve sourcefiles for\", required = true) @PathParam(\"versionId\") Long versionId,\n+        @ApiParam(value = \"Type of entry\", required = true) @QueryParam(\"entryType\") String entryType,", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3Mzg0Nw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427673847", "bodyText": "if you agree with @coverbeck, then I can determine it that way instead.", "author": "NatalieEO", "createdAt": "2020-05-20T00:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMzYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MDQwMw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428050403", "bodyText": "I'd rather the endpoint search through both tables than require the client to specify the entry type.  Otherwise when we add a different entry type things could be weird from the client side (for example \"service\" being passed in)", "author": "garyluu", "createdAt": "2020-05-20T14:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMzYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMzkzNA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427613934", "bodyText": "There's a constant for \"bearer\" somewhere", "author": "garyluu", "createdAt": "2020-05-19T21:34:53Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNDE4Ng==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427614186", "bodyText": "I think this should be the versions resource instead", "author": "garyluu", "createdAt": "2020-05-19T21:35:25Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNTU1MA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427615550", "bodyText": "This should probably just be a list of DescriptorLanguage.FileType enums", "author": "garyluu", "createdAt": "2020-05-19T21:38:14Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {\n+    private static final Logger LOG = LoggerFactory.getLogger(SourceFileResource.class);\n+\n+    private final SessionFactory sessionFactory;\n+    private final TagDAO tagDAO;\n+    private final WorkflowVersionDAO workflowVersionDAO;\n+\n+\n+    public SourceFileResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.tagDAO = new TagDAO(sessionFactory);\n+        this.workflowVersionDAO = new WorkflowVersionDAO(sessionFactory);\n+\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{versionId}/sourcefiles\")\n+    @ApiOperation(value = \"Retrieve sourcefiles for an entry version\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, responseContainer = \"Set\", response = SourceFile.class)\n+    public SortedSet<SourceFile> getSourceFiles(@ApiParam(hidden = true) @Auth User user,\n+        @ApiParam(value = \"Version to retrieve sourcefiles for\", required = true) @PathParam(\"versionId\") Long versionId,\n+        @ApiParam(value = \"Type of entry\", required = true) @QueryParam(\"entryType\") String entryType,\n+        @ApiParam(value = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<String> fileTypes) {", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MzQ3NQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427673475", "bodyText": "I originally had it that way, but when I was writing the tests it kept saying it expected a list of strings anyway.", "author": "NatalieEO", "createdAt": "2020-05-20T00:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNTU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNDQ2NA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428034464", "bodyText": "It probably converts the enum to a string, but for the swagger UI it is better if it is an enum since it will (I think) add a dropdown to the input with all the possible values.", "author": "agduncan94", "createdAt": "2020-05-20T13:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNTU1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMzU3MA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428333570", "bodyText": "using enum now", "author": "NatalieEO", "createdAt": "2020-05-20T22:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNTU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNzYwMw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427617603", "bodyText": "something something verison.getSourceFiles(); instead of a separate line for tag and workflowVersion", "author": "garyluu", "createdAt": "2020-05-19T21:42:51Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {\n+    private static final Logger LOG = LoggerFactory.getLogger(SourceFileResource.class);\n+\n+    private final SessionFactory sessionFactory;\n+    private final TagDAO tagDAO;\n+    private final WorkflowVersionDAO workflowVersionDAO;\n+\n+\n+    public SourceFileResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.tagDAO = new TagDAO(sessionFactory);\n+        this.workflowVersionDAO = new WorkflowVersionDAO(sessionFactory);\n+\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{versionId}/sourcefiles\")\n+    @ApiOperation(value = \"Retrieve sourcefiles for an entry version\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, responseContainer = \"Set\", response = SourceFile.class)\n+    public SortedSet<SourceFile> getSourceFiles(@ApiParam(hidden = true) @Auth User user,\n+        @ApiParam(value = \"Version to retrieve sourcefiles for\", required = true) @PathParam(\"versionId\") Long versionId,\n+        @ApiParam(value = \"Type of entry\", required = true) @QueryParam(\"entryType\") String entryType,\n+        @ApiParam(value = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<String> fileTypes) {\n+\n+        if (entryType != null) {\n+            SortedSet<SourceFile> sourceFiles = new TreeSet<>();\n+            if (\"tool\".equals(entryType)) {\n+                Tag tag = tagDAO.findById(versionId);\n+                sourceFiles = tag.getSourceFiles();\n+            } else if (\"workflow\".equals(entryType)) {\n+                WorkflowVersion workflowVersion = workflowVersionDAO.findById(versionId);\n+                sourceFiles = workflowVersion.getSourceFiles();", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxODkxNw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427618917", "bodyText": "The \"if\" statement can be collapsed", "author": "garyluu", "createdAt": "2020-05-19T21:45:49Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {\n+    private static final Logger LOG = LoggerFactory.getLogger(SourceFileResource.class);\n+\n+    private final SessionFactory sessionFactory;\n+    private final TagDAO tagDAO;\n+    private final WorkflowVersionDAO workflowVersionDAO;\n+\n+\n+    public SourceFileResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.tagDAO = new TagDAO(sessionFactory);\n+        this.workflowVersionDAO = new WorkflowVersionDAO(sessionFactory);\n+\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{versionId}/sourcefiles\")\n+    @ApiOperation(value = \"Retrieve sourcefiles for an entry version\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, responseContainer = \"Set\", response = SourceFile.class)\n+    public SortedSet<SourceFile> getSourceFiles(@ApiParam(hidden = true) @Auth User user,\n+        @ApiParam(value = \"Version to retrieve sourcefiles for\", required = true) @PathParam(\"versionId\") Long versionId,\n+        @ApiParam(value = \"Type of entry\", required = true) @QueryParam(\"entryType\") String entryType,\n+        @ApiParam(value = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<String> fileTypes) {\n+\n+        if (entryType != null) {\n+            SortedSet<SourceFile> sourceFiles = new TreeSet<>();\n+            if (\"tool\".equals(entryType)) {\n+                Tag tag = tagDAO.findById(versionId);\n+                sourceFiles = tag.getSourceFiles();\n+            } else if (\"workflow\".equals(entryType)) {\n+                WorkflowVersion workflowVersion = workflowVersionDAO.findById(versionId);\n+                sourceFiles = workflowVersion.getSourceFiles();\n+            } else {\n+                throw new CustomWebApplicationException(\"Entry type: \" + entryType + \" is unsupported.\", HttpStatus.SC_BAD_REQUEST);\n+            }\n+            if (fileTypes != null && !fileTypes.isEmpty()) {\n+                sourceFiles = sourceFiles.stream().filter(sourceFile -> {\n+                    if (fileTypes.contains(sourceFile.getType().toString())) {", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0NTMxMg==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427645312", "bodyText": "Collapsed in two ways... You don't need the curly braces, and you can just return contains(...", "author": "coverbeck", "createdAt": "2020-05-19T22:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxODkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxOTUxMA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427619510", "bodyText": "This should use OpenAPI annotations instead.  I believe there's testing utilities for openapi client so you don't have to worry about that part.", "author": "garyluu", "createdAt": "2020-05-19T21:47:05Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")\n+@Api(\"versions\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@SecuritySchemes({ @SecurityScheme (type = SecuritySchemeType.HTTP, name = \"bearer\", scheme = \"bearer\")})\n+@io.swagger.v3.oas.annotations.tags.Tag(name = \"sourceFile\", description = ResourceConstants.SOURCEFILE)\n+public class SourceFileResource {\n+    private static final Logger LOG = LoggerFactory.getLogger(SourceFileResource.class);\n+\n+    private final SessionFactory sessionFactory;\n+    private final TagDAO tagDAO;\n+    private final WorkflowVersionDAO workflowVersionDAO;\n+\n+\n+    public SourceFileResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.tagDAO = new TagDAO(sessionFactory);\n+        this.workflowVersionDAO = new WorkflowVersionDAO(sessionFactory);\n+\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{versionId}/sourcefiles\")\n+    @ApiOperation(value = \"Retrieve sourcefiles for an entry version\", authorizations = {", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0MzIyNg==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427643226", "bodyText": "I think this should be hierarchical.\n/workflows/<workflowid>/versions/<versionid>/sourcefiles\n\nAnd the corresponding one for tags.\n\nThe hierarchy is a common RESTful pattern\nYour way relies on ids of workflow versions and tags always being unique, which they are now, but who knows, some day that won't be.\n\nSee if anybody else agrees with me first though.\nIf you do it that way, then you should probably add the endpoints to WorkflowResource and DockerRepoTagResource.", "author": "coverbeck", "createdAt": "2020-05-19T22:47:56Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/SourceFileResource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.SourceFile;\n+import io.dockstore.webservice.core.Tag;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.WorkflowVersion;\n+import io.dockstore.webservice.jdbi.TagDAO;\n+import io.dockstore.webservice.jdbi.WorkflowVersionDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.annotations.Authorization;\n+import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;\n+import io.swagger.v3.oas.annotations.security.SecurityScheme;\n+import io.swagger.v3.oas.annotations.security.SecuritySchemes;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.Constants.JWT_SECURITY_DEFINITION_NAME;\n+\n+@Path(\"/versions\")", "originalCommit": "b541f6c48fa2b35574db700d0dbffebec27cbe98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NzAyMA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r427677020", "bodyText": "Ya, this was my first thought too.  The downside is you'd have two endpoints instead of one.  you'd also need the entry id", "author": "garyluu", "createdAt": "2020-05-20T00:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0MzIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMzMyMA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428333320", "bodyText": "changed to two endpoints", "author": "NatalieEO", "createdAt": "2020-05-20T22:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY0MzIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4Njg5OA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428086898", "bodyText": "Looks like a category, but why is there a category being created?", "author": "denis-yuen", "createdAt": "2020-05-20T15:04:33Z", "path": "dockstore-common/src/main/java/io/dockstore/common/SourceFileTest.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package io.dockstore.common;\n+\n+/**\n+ * Contains tests specific to sourcefiles\n+ * @author NatalieEO\n+ */\n+public class SourceFileTest {", "originalCommit": "38b714af462d22d26dd7f8db773143c2dfbec25a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMzIzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428333239", "bodyText": "deleted", "author": "NatalieEO", "createdAt": "2020-05-20T22:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4Njg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1OTM4NA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428359384", "bodyText": "You should ideally call TagDAO.findById() instead. That way you will fetch only one version from the DB and not the 600+ versions some repos have.\nThe problem is that you'll also need to validate that tagId belongs to containerId, otherwise you could end up fetching a tag for a different container. If you fetch all of the parent's versions to verify, then you're back to square one.\n\nYou make Version.entry field public, so you can do the check.\nYou write a new query that fetches a version given a containerId and tagId as params.\n\nThe second option would execute the fastest, but would be a little more work.", "author": "coverbeck", "createdAt": "2020-05-20T23:13:59Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoTagResource.java", "diffHunk": "@@ -246,4 +258,31 @@ private Tool findToolByIdAndCheckToolAndUser(Long toolId, User user) {\n         checkUser(user, tool);\n         return tool;\n     }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{containerId}/tags/{tagId}/sourcefiles\")\n+    @Operation(operationId = \"getTagsSourcefiles\", description = \"Retrieve sourcefiles for a container's version\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public SortedSet<SourceFile> getTagsSourceFiles(@ApiParam(hidden = true) @Auth Optional<User> user,\n+            @Parameter(name = \"containerId\", description = \"Container to retrieve the version from\", required = true, in = ParameterIn.PATH) @PathParam(\"containerId\") Long containerId,\n+            @Parameter(name = \"tagId\", description = \"Tag to retrieve the sourcefiles from\", required = true, in = ParameterIn.PATH) @PathParam(\"tagId\") Long tagId,\n+            @Parameter(name = \"fileTypes\", description = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<DescriptorLanguage.FileType> fileTypes) {\n+        Tool tool = toolDAO.findById(containerId);\n+        checkEntry(tool);\n+        checkOptionalAuthRead(user, tool);\n+\n+        Set<Tag> tags = tool.getWorkflowVersions();", "originalCommit": "246e4597f793114981495e36a3fce93f9c2ca156", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2MTMxOA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428361318", "bodyText": "Same comment as for tags", "author": "coverbeck", "createdAt": "2020-05-20T23:20:26Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1485,6 +1487,31 @@ public String getTableToolContent(@ApiParam(hidden = true) @Auth Optional<User>\n         return null;\n     }\n \n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{workflowId}/workflowVersions/{workflowVersionId}/sourcefiles\")\n+    @Operation(operationId = \"getWorkflowVersionsSourcefiles\", description = \"Retrieve sourcefiles for an entry's version\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public SortedSet<SourceFile> getWorkflowVersionsSourceFiles(@ApiParam(hidden = true) @Auth Optional<User> user,\n+            @Parameter(name = \"workflowId\", description = \"Workflow to retrieve the version from.\", required = true, in = ParameterIn.PATH) @PathParam(\"workflowId\") Long workflowId,\n+            @Parameter(name = \"workflowVersionId\", description = \"Workflow version to retrieve the version from.\", required = true, in = ParameterIn.PATH) @PathParam(\"workflowVersionId\") Long workflowVersionId,\n+            @Parameter(name = \"fileTypes\", description = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<DescriptorLanguage.FileType> fileTypes) {\n+        Workflow workflow = workflowDAO.findById(workflowId);\n+        checkEntry(workflow);\n+        checkOptionalAuthRead(user, workflow);\n+\n+        WorkflowVersion workflowVersion = getWorkflowVersion(workflow, workflowVersionId);", "originalCommit": "246e4597f793114981495e36a3fce93f9c2ca156", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Nzg0MQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428667841", "bodyText": "Not necessary to create a new named query and function.  Just make versionDAO constructor public and use versionDAO get by id.", "author": "garyluu", "createdAt": "2020-05-21T13:57:42Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoTagResource.java", "diffHunk": "@@ -246,4 +259,30 @@ private Tool findToolByIdAndCheckToolAndUser(Long toolId, User user) {\n         checkUser(user, tool);\n         return tool;\n     }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{containerId}/tags/{tagId}/sourcefiles\")\n+    @Operation(operationId = \"getTagsSourcefiles\", description = \"Retrieve sourcefiles for a container's version\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public SortedSet<SourceFile> getTagsSourceFiles(@ApiParam(hidden = true) @Auth Optional<User> user,\n+            @Parameter(name = \"containerId\", description = \"Container to retrieve the version from\", required = true, in = ParameterIn.PATH) @PathParam(\"containerId\") Long containerId,\n+            @Parameter(name = \"tagId\", description = \"Tag to retrieve the sourcefiles from\", required = true, in = ParameterIn.PATH) @PathParam(\"tagId\") Long tagId,\n+            @Parameter(name = \"fileTypes\", description = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<DescriptorLanguage.FileType> fileTypes) {\n+        Tool tool = toolDAO.findById(containerId);\n+        checkEntry(tool);\n+        checkOptionalAuthRead(user, tool);\n+\n+        Version version = tagDAO.findVersionInEntry(containerId, tagId);", "originalCommit": "2f9b442ce3ef1af29a4a37ccf9d781a5df3f258f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY5MDU5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428690591", "bodyText": "Probably don't even need to change visibility since TagDAO is a VersionDAO.", "author": "denis-yuen", "createdAt": "2020-05-21T14:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Nzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNTAxNQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428735015", "bodyText": "it's so that the other endpoint could share the same code, since it's unusual for workflowversion to call tagDAO", "author": "garyluu", "createdAt": "2020-05-21T15:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Nzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2NDE5OA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428764198", "bodyText": "I made a new query because it was asked to verify that the version belongs to the entry requested, and that it'd be the the quicker option, but I'll use versionDAO instead.", "author": "NatalieEO", "createdAt": "2020-05-21T16:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Nzg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2OTMxMg==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428669312", "bodyText": "Two endpoints is fine, but this line and every line below it should just be the same implementation as the other one, just use a function", "author": "garyluu", "createdAt": "2020-05-21T13:59:54Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1485,6 +1487,32 @@ public String getTableToolContent(@ApiParam(hidden = true) @Auth Optional<User>\n         return null;\n     }\n \n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{workflowId}/workflowVersions/{workflowVersionId}/sourcefiles\")\n+    @Operation(operationId = \"getWorkflowVersionsSourcefiles\", description = \"Retrieve sourcefiles for an entry's version\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public SortedSet<SourceFile> getWorkflowVersionsSourceFiles(@ApiParam(hidden = true) @Auth Optional<User> user,\n+            @Parameter(name = \"workflowId\", description = \"Workflow to retrieve the version from.\", required = true, in = ParameterIn.PATH) @PathParam(\"workflowId\") Long workflowId,\n+            @Parameter(name = \"workflowVersionId\", description = \"Workflow version to retrieve the version from.\", required = true, in = ParameterIn.PATH) @PathParam(\"workflowVersionId\") Long workflowVersionId,\n+            @Parameter(name = \"fileTypes\", description = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<DescriptorLanguage.FileType> fileTypes) {\n+        Workflow workflow = workflowDAO.findById(workflowId);\n+        checkEntry(workflow);", "originalCommit": "2f9b442ce3ef1af29a4a37ccf9d781a5df3f258f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428688818", "bodyText": "It probably doesn't hurt, but both tagids and entryids are unique, so it seems like the parentid check is redundant.", "author": "denis-yuen", "createdAt": "2020-05-21T14:31:43Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -67,6 +69,11 @@\n @Entity\n @ApiModel(value = \"Version\", description = \"Base class for versions of entries in the Dockstore\")\n @Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)\n+\n+@NamedQueries({\n+        @NamedQuery(name = \"Version.findVersionInEntry\", query = \"SELECT v FROM Version v WHERE :entryId = v.parent.id AND :versionId = v.id\")", "originalCommit": "2f9b442ce3ef1af29a4a37ccf9d781a5df3f258f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5MDg0Mg==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428790842", "bodyText": "The concern I had was making sure that doing GET /workflows//versions/ doesn't work. Especially if the user doesn't have permissions to another workflow.", "author": "coverbeck", "createdAt": "2020-05-21T17:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5NzA2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428797067", "bodyText": "I think the checkUser function already accomplishes that.", "author": "garyluu", "createdAt": "2020-05-21T17:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNDE4OA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428814188", "bodyText": "Yeah so checkOptionalAuthRead() checks if the entry is published or the user has access, so it takes care of the permission issue.", "author": "NatalieEO", "createdAt": "2020-05-21T17:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzMzNQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428817335", "bodyText": "It only takes care of the permissions issue if the version belongs to the entry that you checked. :) Which is why I think you do need the parent id here. Or maybe we're saying the same thing.", "author": "coverbeck", "createdAt": "2020-05-21T17:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDYzMg==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428854632", "bodyText": "Yeah, i think we're saying the same thing. I'm keeping the parentid", "author": "NatalieEO", "createdAt": "2020-05-21T19:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4ODgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5NDk4MA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428794980", "bodyText": "I only thought of this after you responded to my last comment, but you could just query the source files from the database directly. Any time we are filtering Hibernate objects, it's an indicator of a potential area where you could have the DB do the work for you.\nIs the common use case in the UI expected to be invoking going to be using the filetypes parameter, and if so, what type? Will it just be the .dockstore.yml? If that is a common case, it's a slightly stronger argument to fetch from the DB; if a workflow has n descriptor files and one .dockstore.yml, just fetch the .dockstore.yml from the DB.\nThis is probably way overkill, and we risk having too many one-offs, so I'm leaning towards not doing it, but throwing it out for consideration.", "author": "coverbeck", "createdAt": "2020-05-21T17:16:20Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoTagResource.java", "diffHunk": "@@ -246,4 +259,30 @@ private Tool findToolByIdAndCheckToolAndUser(Long toolId, User user) {\n         checkUser(user, tool);\n         return tool;\n     }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"{containerId}/tags/{tagId}/sourcefiles\")\n+    @Operation(operationId = \"getTagsSourcefiles\", description = \"Retrieve sourcefiles for a container's version\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    public SortedSet<SourceFile> getTagsSourceFiles(@ApiParam(hidden = true) @Auth Optional<User> user,\n+            @Parameter(name = \"containerId\", description = \"Container to retrieve the version from\", required = true, in = ParameterIn.PATH) @PathParam(\"containerId\") Long containerId,\n+            @Parameter(name = \"tagId\", description = \"Tag to retrieve the sourcefiles from\", required = true, in = ParameterIn.PATH) @PathParam(\"tagId\") Long tagId,\n+            @Parameter(name = \"fileTypes\", description = \"List of file types to filter sourcefiles by\") @QueryParam(\"fileType\") List<DescriptorLanguage.FileType> fileTypes) {\n+        Tool tool = toolDAO.findById(containerId);\n+        checkEntry(tool);\n+        checkOptionalAuthRead(user, tool);\n+\n+        Version version = tagDAO.findVersionInEntry(containerId, tagId);\n+        if (version == null) {\n+            throw new CustomWebApplicationException(\"Container tag \" + tagId + \" does not exist for this tool\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        SortedSet<SourceFile> sourceFiles = version.getSourceFiles();", "originalCommit": "2f9b442ce3ef1af29a4a37ccf9d781a5df3f258f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc5NjIyNQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r428796225", "bodyText": "The typical pattern for naming named queries is to use the package name, although we're not always consistent in it (io.dockstore.webservice.core.Version.findVersionInEntry).", "author": "coverbeck", "createdAt": "2020-05-21T17:18:38Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -67,6 +69,11 @@\n @Entity\n @ApiModel(value = \"Version\", description = \"Base class for versions of entries in the Dockstore\")\n @Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)\n+\n+@NamedQueries({\n+        @NamedQuery(name = \"Version.findVersionInEntry\", query = \"SELECT v FROM Version v WHERE :entryId = v.parent.id AND :versionId = v.id\")", "originalCommit": "2f9b442ce3ef1af29a4a37ccf9d781a5df3f258f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0NDQ4MQ==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r429244481", "bodyText": "These two tests should be using the OpenAPI client. Instead of io.swagger.client.ApiClient.", "author": "garyluu", "createdAt": "2020-05-22T13:26:45Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/BasicIT.java", "diffHunk": "@@ -1401,4 +1403,57 @@ public void testBrokenPath() {\n             Assert.assertEquals(\"Entry not found\", e.getMessage());\n         }\n     }\n+\n+    @Test\n+    public void testGettingSourceFilesForTag() {", "originalCommit": "fc2220cd7c42abc150e7152b577bde2cc929b5c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI0NTI0NA==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r429245244", "bodyText": "Remove mention of \"workflow\" from this (because of tools and services)", "author": "garyluu", "createdAt": "2020-05-22T13:28:12Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/EntryVersionHelper.java", "diffHunk": "@@ -388,6 +391,20 @@ default void checkNotFrozen(Version version) {\n         }\n     }\n \n+    default SortedSet<SourceFile> getVersionsSourcefiles(Long entryId, Long versionId, List<DescriptorLanguage.FileType> fileTypes, VersionDAO versionDAO) {\n+        Version version = versionDAO.findVersionInEntry(entryId, versionId);\n+        if (version == null) {\n+            throw new CustomWebApplicationException(\"Workflow version\" + versionId + \" does not exist for this workflow\", HttpStatus.SC_BAD_REQUEST);", "originalCommit": "fc2220cd7c42abc150e7152b577bde2cc929b5c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI1MDE5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3482#discussion_r429250196", "bodyText": "Should probably put a comment mentioning that this namedQuery is to double check that the user didn't put a workflowId they have access to with a workflowVersionId (from a different hidden workflow) they don't have access to.\nMy first thought when looking at this was that the versionId isn't unique and needs the parentId.", "author": "garyluu", "createdAt": "2020-05-22T13:37:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -67,6 +69,11 @@\n @Entity\n @ApiModel(value = \"Version\", description = \"Base class for versions of entries in the Dockstore\")\n @Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)\n+\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.Version.findVersionInEntry\", query = \"SELECT v FROM Version v WHERE :entryId = v.parent.id AND :versionId = v.id\")", "originalCommit": "fc2220cd7c42abc150e7152b577bde2cc929b5c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b9dbee83d29952d8a80db12e6d76df05c87d3a71", "url": "https://github.com/dockstore/dockstore/commit/b9dbee83d29952d8a80db12e6d76df05c87d3a71", "message": "Sourcefiles endpoint", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "7d7fc0833c2a6672f0eb13d008def376f534e234", "url": "https://github.com/dockstore/dockstore/commit/7d7fc0833c2a6672f0eb13d008def376f534e234", "message": "some PR changes", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "bc68b9b7b05ed7677d399f66f17603de13d9c609", "url": "https://github.com/dockstore/dockstore/commit/bc68b9b7b05ed7677d399f66f17603de13d9c609", "message": "split to two endpoints", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "c0fb4560e06e413171652edb8a255eecee2a7ce6", "url": "https://github.com/dockstore/dockstore/commit/c0fb4560e06e413171652edb8a255eecee2a7ce6", "message": "forgot to delete", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "548b03c795d2ea18b0738dc328ad1caad8a8a853", "url": "https://github.com/dockstore/dockstore/commit/548b03c795d2ea18b0738dc328ad1caad8a8a853", "message": "retrieve one version", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "52534b225b5a877035935ef8676424ca4cc4e356", "url": "https://github.com/dockstore/dockstore/commit/52534b225b5a877035935ef8676424ca4cc4e356", "message": "create function", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "f469bdf129421baad34fcd539316e53a51820025", "url": "https://github.com/dockstore/dockstore/commit/f469bdf129421baad34fcd539316e53a51820025", "message": "Change tests to use openapi", "committedDate": "2020-05-27T00:09:37Z", "type": "commit"}, {"oid": "f469bdf129421baad34fcd539316e53a51820025", "url": "https://github.com/dockstore/dockstore/commit/f469bdf129421baad34fcd539316e53a51820025", "message": "Change tests to use openapi", "committedDate": "2020-05-27T00:09:37Z", "type": "forcePushed"}, {"oid": "1a6d195534c9713389c7153ae635bbcae1b96515", "url": "https://github.com/dockstore/dockstore/commit/1a6d195534c9713389c7153ae635bbcae1b96515", "message": "remove from swagger", "committedDate": "2020-05-27T16:14:03Z", "type": "commit"}]}