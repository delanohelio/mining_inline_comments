{"pr_number": 3226, "pr_title": "get quay images for cwl workflows", "pr_createdAt": "2020-02-11T21:03:29Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3226", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMjY1MQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377902651", "bodyText": "Create variable for error_message so you don't repeat it.\nDo you mean to continue if there's an error? I guess the other code will just fall through harmlessly?", "author": "coverbeck", "createdAt": "2020-02-11T21:15:43Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();\n+        dockerTools = (ArrayList<Map<String, String>>)gson.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker = image.split(\"/\");\n+                String[] splitTag = splitDocker[2].split(\":\");\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {\n+                        Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n+                        Map<String, String> errorMap = new HashMap<>();\n+                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(\"error_message\") != null) {", "originalCommit": "2398600ecb9b1eba6abcf9fc50d027f5cdc71ff6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NjI5NQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377966295", "bodyText": "No didn't mean to. Changing", "author": "NatalieEO", "createdAt": "2020-02-11T23:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMjY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMDI5OA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377910298", "bodyText": "I thought we discussed not allowing snapshotting if the images were parameterizable. Is that covered in another ticket?\nAlso, if there are errors in getting the images, this will fail silently and there will be no indication to the user. If there is an error, should we even allow snapshotting? Not sure...", "author": "coverbeck", "createdAt": "2020-02-11T21:29:43Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1307,7 +1309,16 @@ public Workflow manualRegister(@ApiParam(hidden = true) @Auth User user,\n                     existingTag.setDirtyBit(true);\n                 }\n \n+                boolean wasFrozen = existingTag.isFrozen();\n                 existingTag.updateByUser(version);\n+                boolean nowFrozen = existingTag.isFrozen();\n+                // If version is snapshotted on this update, grab and store image information\n+                if (!wasFrozen && nowFrozen) {\n+                    LanguageHandlerInterface lInterface = LanguageHandlerFactory.getInterface(w.getFileType());\n+                    String toolsJSONTable = lInterface.getContent(w.getWorkflowPath(), getMainDescriptorFile(existingTag).getContent(), extractDescriptorAndSecondaryFiles(existingTag), LanguageHandlerInterface.Type.TOOLS, toolDAO);\n+                    Set<Image> images = lInterface.getImagesFromRegistry(toolsJSONTable);\n+                    existingTag.getImages().addAll(images);", "originalCommit": "2398600ecb9b1eba6abcf9fc50d027f5cdc71ff6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MjAxMw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377972013", "bodyText": "It can be in another ticket. My understanding is CWL only accepts strings in a dockerPull so WDL is the one with parameterizeable images.\nMy thoughts on if there was an error getting an image was that it was okay to let the process continue. There may be cases where we miss docker refs entirely or are unable to properly parse it (like how wdl docker refs allow variables, doesn't seem easy for use to handle?).\nBut maybe we should indicate to the user we weren't able to process certain images.", "author": "NatalieEO", "createdAt": "2020-02-12T00:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMDI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMTE5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377911196", "bodyText": "LOG.error instead of info\nLog the exception itself as well.", "author": "coverbeck", "createdAt": "2020-02-11T21:31:27Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();\n+        dockerTools = (ArrayList<Map<String, String>>)gson.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker = image.split(\"/\");\n+                String[] splitTag = splitDocker[2].split(\":\");\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {\n+                        Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n+                        Map<String, String> errorMap = new HashMap<>();\n+                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(\"error_message\") != null) {\n+                            LOG.error(\"Error response from Quay: \" + errorMap.get(\"error_message\"));\n+                        }\n+\n+                        try {\n+                            final List<Map<String, String>> array = map.get(\"tags\");\n+\n+                            for (Map<String, String> tag : array) {\n+                                final String digest = tag.get(\"manifest_digest\");\n+                                final String imageID = tag.get(\"image_id\");\n+                                List<Checksum> checksums = new ArrayList<>();\n+                                checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n+                                dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                            }\n+\n+                        } catch (IndexOutOfBoundsException | NullPointerException ex) {\n+                            LOG.error(\"Could not get checksum information for \" + splitDocker[1]);\n+                        }\n+                    }\n+                } else {\n+                    LOG.error(\"Could not find image version specified for \" + splitDocker[1]);\n+                }\n+\n+            } else if (image.startsWith(\"images.sbgenomics\")) {\n+                return dockerImages;\n+\n+            } else if (image.startsWith(\"registry.gitlab.com\")) {\n+                return dockerImages;\n+\n+            } else if (parts.length == 2) {\n+                //dockerhub\n+                return dockerImages;\n+            }\n+        }\n+        return dockerImages;\n+    }\n+\n+    default Optional<String> getImageResponseFromQuay(String dockerName) {\n+        String[] splitDocker = dockerName.split(\"/\");\n+        String[] splitTag = splitDocker[2].split(\":\");\n+        final String tagUrl = QUAY_URL + \"repository/\" + splitDocker[1] + \"/\" + splitTag[0] + \"/tag/\" + \"?specificTag=\" + splitTag[1];\n+        Optional<String> response;\n+\n+        try {\n+            URL url = new URL(tagUrl);\n+            response = Optional.of(IOUtils.toString(url, StandardCharsets.UTF_8));\n+            if (response.isPresent()) {\n+                return response;\n+            }\n+        } catch (IOException ex) {\n+            LOG.info(\"Unable to get response from Quay\");", "originalCommit": "2398600ecb9b1eba6abcf9fc50d027f5cdc71ff6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMTYxNw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377911617", "bodyText": "I don't think you need this if statement; if it's empty, you would just return the empty optional, which is what you want.", "author": "coverbeck", "createdAt": "2020-02-11T21:32:16Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();\n+        dockerTools = (ArrayList<Map<String, String>>)gson.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker = image.split(\"/\");\n+                String[] splitTag = splitDocker[2].split(\":\");\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {\n+                        Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n+                        Map<String, String> errorMap = new HashMap<>();\n+                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(\"error_message\") != null) {\n+                            LOG.error(\"Error response from Quay: \" + errorMap.get(\"error_message\"));\n+                        }\n+\n+                        try {\n+                            final List<Map<String, String>> array = map.get(\"tags\");\n+\n+                            for (Map<String, String> tag : array) {\n+                                final String digest = tag.get(\"manifest_digest\");\n+                                final String imageID = tag.get(\"image_id\");\n+                                List<Checksum> checksums = new ArrayList<>();\n+                                checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n+                                dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                            }\n+\n+                        } catch (IndexOutOfBoundsException | NullPointerException ex) {\n+                            LOG.error(\"Could not get checksum information for \" + splitDocker[1]);\n+                        }\n+                    }\n+                } else {\n+                    LOG.error(\"Could not find image version specified for \" + splitDocker[1]);\n+                }\n+\n+            } else if (image.startsWith(\"images.sbgenomics\")) {\n+                return dockerImages;\n+\n+            } else if (image.startsWith(\"registry.gitlab.com\")) {\n+                return dockerImages;\n+\n+            } else if (parts.length == 2) {\n+                //dockerhub\n+                return dockerImages;\n+            }\n+        }\n+        return dockerImages;\n+    }\n+\n+    default Optional<String> getImageResponseFromQuay(String dockerName) {\n+        String[] splitDocker = dockerName.split(\"/\");\n+        String[] splitTag = splitDocker[2].split(\":\");\n+        final String tagUrl = QUAY_URL + \"repository/\" + splitDocker[1] + \"/\" + splitTag[0] + \"/tag/\" + \"?specificTag=\" + splitTag[1];\n+        Optional<String> response;\n+\n+        try {\n+            URL url = new URL(tagUrl);\n+            response = Optional.of(IOUtils.toString(url, StandardCharsets.UTF_8));\n+            if (response.isPresent()) {", "originalCommit": "2398600ecb9b1eba6abcf9fc50d027f5cdc71ff6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyOTc1Mg==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377929752", "bodyText": "Question: Why this over TagApi.listRepoTagsWithHttpInfo()?", "author": "garyluu", "createdAt": "2020-02-11T22:09:55Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();\n+        dockerTools = (ArrayList<Map<String, String>>)gson.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker = image.split(\"/\");\n+                String[] splitTag = splitDocker[2].split(\":\");\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {\n+                        Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n+                        Map<String, String> errorMap = new HashMap<>();\n+                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(\"error_message\") != null) {\n+                            LOG.error(\"Error response from Quay: \" + errorMap.get(\"error_message\"));\n+                        }\n+\n+                        try {\n+                            final List<Map<String, String>> array = map.get(\"tags\");\n+\n+                            for (Map<String, String> tag : array) {\n+                                final String digest = tag.get(\"manifest_digest\");\n+                                final String imageID = tag.get(\"image_id\");\n+                                List<Checksum> checksums = new ArrayList<>();\n+                                checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n+                                dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                            }\n+\n+                        } catch (IndexOutOfBoundsException | NullPointerException ex) {\n+                            LOG.error(\"Could not get checksum information for \" + splitDocker[1]);\n+                        }\n+                    }\n+                } else {\n+                    LOG.error(\"Could not find image version specified for \" + splitDocker[1]);\n+                }\n+\n+            } else if (image.startsWith(\"images.sbgenomics\")) {\n+                return dockerImages;\n+\n+            } else if (image.startsWith(\"registry.gitlab.com\")) {\n+                return dockerImages;\n+\n+            } else if (parts.length == 2) {\n+                //dockerhub\n+                return dockerImages;\n+            }\n+        }\n+        return dockerImages;\n+    }\n+\n+    default Optional<String> getImageResponseFromQuay(String dockerName) {\n+        String[] splitDocker = dockerName.split(\"/\");\n+        String[] splitTag = splitDocker[2].split(\":\");\n+        final String tagUrl = QUAY_URL + \"repository/\" + splitDocker[1] + \"/\" + splitTag[0] + \"/tag/\" + \"?specificTag=\" + splitTag[1];\n+        Optional<String> response;\n+\n+        try {\n+            URL url = new URL(tagUrl);\n+            response = Optional.of(IOUtils.toString(url, StandardCharsets.UTF_8));", "originalCommit": "2398600ecb9b1eba6abcf9fc50d027f5cdc71ff6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNjU2OA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377936568", "bodyText": "ahh, it looks like the swagger-java-quay-client stuff is all wrong", "author": "garyluu", "createdAt": "2020-02-11T22:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyOTc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MjY5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r377972697", "bodyText": "Yeah I didn't understand how to use it...", "author": "NatalieEO", "createdAt": "2020-02-12T00:04:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyOTc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTY1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r378325655", "bodyText": "Would be worth a follow-up ticket to fix it (the quay.io swagger), this code is pretty hard to read/understand", "author": "denis-yuen", "createdAt": "2020-02-12T15:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyOTc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMjQ3Ng==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r378322476", "bodyText": "Can use List<Map<String, String>>\nhttps://stackoverflow.com/questions/9852831/polymorphism-why-use-list-list-new-arraylist-instead-of-arraylist-list-n kind of idea", "author": "denis-yuen", "createdAt": "2020-02-12T15:26:09Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();", "originalCommit": "cb82de835fb4a35f60e3fa8656236ca991a1b71e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMjgzMg==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r378322832", "bodyText": "Can create once for the class since it doesn't change from method call to method call", "author": "denis-yuen", "createdAt": "2020-02-12T15:26:41Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();", "originalCommit": "cb82de835fb4a35f60e3fa8656236ca991a1b71e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNDEzNQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r378324135", "bodyText": "Thought, this could be hooked up to a validation warning when we have it.\nFurther food for thought in #3216", "author": "denis-yuen", "createdAt": "2020-02-12T15:28:34Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +333,92 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        ArrayList<Map<String, String>> dockerTools = new ArrayList<>();\n+        Gson gson = new Gson();\n+        dockerTools = (ArrayList<Map<String, String>>)gson.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String errorKey = \"error_message\";\n+                String[] splitDocker = image.split(\"/\");\n+                String[] splitTag = splitDocker[2].split(\":\");\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {\n+                        Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n+                        Map<String, String> errorMap = new HashMap<>();\n+                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(errorKey) != null) {\n+                            LOG.error(\"Error response from Quay: \" + errorMap.get(errorKey));\n+                        } else {\n+                            try {\n+                                final List<Map<String, String>> array = map.get(\"tags\");\n+\n+                                for (Map<String, String> tag : array) {\n+                                    final String digest = tag.get(\"manifest_digest\");\n+                                    final String imageID = tag.get(\"image_id\");\n+                                    List<Checksum> checksums = new ArrayList<>();\n+                                    checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n+                                    dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                                }\n+\n+                            } catch (IndexOutOfBoundsException | NullPointerException ex) {\n+                                LOG.error(\"Could not get checksum information for \" + splitDocker[1]);", "originalCommit": "cb82de835fb4a35f60e3fa8656236ca991a1b71e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU2NjM2NQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379566365", "bodyText": "Log the exception itself as well as a second parameter", "author": "coverbeck", "createdAt": "2020-02-14T17:56:55Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -362,25 +363,25 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n                     if (response.isPresent()) {\n                         Map<String, ArrayList<Map<String, String>>> map = new HashMap<>();\n                         Map<String, String> errorMap = new HashMap<>();\n-                        map = (Map<String, ArrayList<Map<String, String>>>)gson.fromJson(response.get(), map.getClass());\n-                        errorMap = (Map<String, String>)gson.fromJson(response.get(), errorMap.getClass());\n-                        if (errorMap.get(\"error_message\") != null) {\n-                            LOG.error(\"Error response from Quay: \" + errorMap.get(\"error_message\"));\n-                        }\n-\n-                        try {\n-                            final List<Map<String, String>> array = map.get(\"tags\");\n-\n-                            for (Map<String, String> tag : array) {\n-                                final String digest = tag.get(\"manifest_digest\");\n-                                final String imageID = tag.get(\"image_id\");\n-                                List<Checksum> checksums = new ArrayList<>();\n-                                checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n-                                dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                        map = (Map<String, ArrayList<Map<String, String>>>)GSON.fromJson(response.get(), map.getClass());\n+                        errorMap = (Map<String, String>)GSON.fromJson(response.get(), errorMap.getClass());\n+                        if (errorMap.get(errorKey) != null) {\n+                            LOG.error(\"Error response from Quay: \" + errorMap.get(errorKey));\n+                        } else {\n+                            try {\n+                                final List<Map<String, String>> array = map.get(\"tags\");\n+\n+                                for (Map<String, String> tag : array) {\n+                                    final String digest = tag.get(\"manifest_digest\");\n+                                    final String imageID = tag.get(\"image_id\");\n+                                    List<Checksum> checksums = new ArrayList<>();\n+                                    checksums.add(new Checksum(digest.split(\":\")[0], digest.split(\":\")[1]));\n+                                    dockerImages.add(new Image(checksums, repo, tagName, imageID));\n+                                }\n+\n+                            } catch (IndexOutOfBoundsException | NullPointerException ex) {\n+                                LOG.error(\"Could not get checksum information for \" + splitDocker[1]);", "originalCommit": "24fc9ce669bbe491f1ab74d7e0fd91aae4249d9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MDA1Mw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379570053", "bodyText": "Also, what can cause the IndexOutOfBoundsException? If it's on splitDocker, which on a quick skim of the code, I don't think it is, then you'll get an exception logging the exception.\nAlso, rather than using indexes, it would be nice to have a variable name, but not crucial.", "author": "coverbeck", "createdAt": "2020-02-14T18:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU2NjM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxNzA2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379617069", "bodyText": "I don't think it'd ever really happen if the call to quay was successful, but it could happen when splitting the manifest_digest to get the checksum on line 378. But now that you mention it, someone could put an incomplete quay URL and it could fail on 357.", "author": "NatalieEO", "createdAt": "2020-02-14T19:55:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU2NjM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzM0OA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379623348", "bodyText": "Make an issue if it hasn't been done already", "author": "garyluu", "createdAt": "2020-02-14T20:10:36Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/EventResourceIT.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.client.cli;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import io.dockstore.common.CommonTestUtilities;\n+import io.dockstore.common.ConfidentialTest;\n+import io.dockstore.common.Registry;\n+import io.dockstore.common.ToolTest;\n+import io.dockstore.webservice.jdbi.EventDAO;\n+import io.dockstore.webservice.resources.EventSearchType;\n+import io.swagger.client.ApiClient;\n+import io.swagger.client.ApiException;\n+import io.swagger.client.api.ContainersApi;\n+import io.swagger.client.api.ContainertagsApi;\n+import io.swagger.client.api.EventsApi;\n+import io.swagger.client.model.DockstoreTool;\n+import io.swagger.client.model.Event;\n+import io.swagger.client.model.StarRequest;\n+import io.swagger.client.model.Tag;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.contrib.java.lang.system.ExpectedSystemExit;\n+import org.junit.contrib.java.lang.system.SystemErrRule;\n+import org.junit.contrib.java.lang.system.SystemOutRule;\n+import org.junit.experimental.categories.Category;\n+\n+import static io.swagger.client.model.DockstoreTool.ModeEnum.MANUAL_IMAGE_PATH;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * This test was originally in BasicIT, but it sometimes fails on travis and fails consistently locally if it is run with another test", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyNDA4MA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380824080", "bodyText": "#3248", "author": "NatalieEO", "createdAt": "2020-02-18T17:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMTY5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379631691", "bodyText": "something something stream map collector to set", "author": "garyluu", "createdAt": "2020-02-14T20:32:31Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +334,91 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        List<Map<String, String>> dockerTools = new ArrayList<>();\n+        dockerTools = (ArrayList<Map<String, String>>)GSON.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzMyNw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379633327", "bodyText": "this doesn't need to be in the loop", "author": "garyluu", "createdAt": "2020-02-14T20:36:52Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -324,6 +334,91 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        List<Map<String, String>> dockerTools = new ArrayList<>();\n+        dockerTools = (ArrayList<Map<String, String>>)GSON.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        Set<String> dockerStrings = new HashSet<>();\n+\n+        // Eliminate duplicate docker strings\n+        for (Map<String, String> tool : dockerTools) {\n+            dockerStrings.add(tool.get(\"docker\"));\n+        }\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String errorKey = \"error_message\";", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NjAxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380976011", "bodyText": "took out", "author": "NatalieEO", "createdAt": "2020-02-18T22:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjYwNA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379636604", "bodyText": "update comments in this function. probably rename function too", "author": "garyluu", "createdAt": "2020-02-14T20:45:34Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1638,6 +1649,9 @@ private void initializeValidations(String include, Workflow workflow) {\n         if (checkIncludes(include, ALIASES)) {\n             workflow.getWorkflowVersions().forEach(workflowVersion -> Hibernate.initialize(workflowVersion.getAliases()));\n         }\n+        if (checkIncludes(include, IMAGES)) {", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NTkzOQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380975939", "bodyText": "renamed", "author": "NatalieEO", "createdAt": "2020-02-18T22:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczMzk1MA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379733950", "bodyText": "Extra line, don't know f it does anything. Does this test run this way?\nThink it was like this before, but still.", "author": "denis-yuen", "createdAt": "2020-02-15T05:03:53Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/EventResourceIT.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.client.cli;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import io.dockstore.common.CommonTestUtilities;\n+import io.dockstore.common.ConfidentialTest;\n+import io.dockstore.common.Registry;\n+import io.dockstore.common.ToolTest;\n+import io.dockstore.webservice.jdbi.EventDAO;\n+import io.dockstore.webservice.resources.EventSearchType;\n+import io.swagger.client.ApiClient;\n+import io.swagger.client.ApiException;\n+import io.swagger.client.api.ContainersApi;\n+import io.swagger.client.api.ContainertagsApi;\n+import io.swagger.client.api.EventsApi;\n+import io.swagger.client.model.DockstoreTool;\n+import io.swagger.client.model.Event;\n+import io.swagger.client.model.StarRequest;\n+import io.swagger.client.model.Tag;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.contrib.java.lang.system.ExpectedSystemExit;\n+import org.junit.contrib.java.lang.system.SystemErrRule;\n+import org.junit.contrib.java.lang.system.SystemOutRule;\n+import org.junit.experimental.categories.Category;\n+\n+import static io.swagger.client.model.DockstoreTool.ModeEnum.MANUAL_IMAGE_PATH;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * This test was originally in BasicIT, but it sometimes fails on travis and fails consistently locally if it is run with another test\n+ * before it. If testRefreshAfterDeletingAVersion() was run before, eventResource fails. But if you comment out the lines that refresh the\n+ * tool then in testRefresh, the eventResource will pass. Separating out this test for now.\n+ */\n+@Category({ ConfidentialTest.class, ToolTest.class })\n+public class EventResourceIT extends BaseIT {\n+    @Rule\n+    public final ExpectedSystemExit systemExit = ExpectedSystemExit.none();\n+\n+    @Rule\n+    public final SystemOutRule systemOutRule = new SystemOutRule().enableLog().muteForSuccessfulTests();\n+\n+    @Rule\n+    public final SystemErrRule systemErrRule = new SystemErrRule().enableLog().muteForSuccessfulTests();\n+\n+    @Before\n+    @Override\n+    public void resetDBBetweenTests() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate1(SUPPORT);\n+    }\n+\n+    @SuppressWarnings(\"checkstyle:parameternumber\")\n+    private DockstoreTool manualRegisterAndPublish(ContainersApi containersApi, String namespace, String name, String toolName,\n+        String gitUrl, String cwlPath, String wdlPath, String dockerfilePath, DockstoreTool.RegistryEnum registry, String gitReference,\n+        String versionName, boolean toPublish, boolean isPrivate, String email, String customDockerPath) {\n+        DockstoreTool newTool = new DockstoreTool();\n+        newTool.setNamespace(namespace);\n+        newTool.setName(name);\n+        newTool.setToolname(toolName);\n+        newTool.setDefaultCwlPath(cwlPath);\n+        newTool.setDefaultWdlPath(wdlPath);\n+        newTool.setDefaultDockerfilePath(dockerfilePath);\n+        newTool.setGitUrl(gitUrl);\n+        newTool.setRegistry(registry);\n+        newTool.setRegistryString(registry.getValue());\n+        newTool.setMode(MANUAL_IMAGE_PATH);\n+        newTool.setPrivateAccess(isPrivate);\n+        newTool.setToolMaintainerEmail(email);\n+        if (customDockerPath != null) {\n+            newTool.setRegistryString(customDockerPath);\n+        }\n+\n+        if (!Registry.QUAY_IO.name().equals(registry.name())) {\n+            Tag tag = new Tag();\n+            tag.setReference(gitReference);\n+            tag.setName(versionName);\n+            tag.setDockerfilePath(dockerfilePath);\n+            tag.setCwlPath(cwlPath);\n+            tag.setWdlPath(wdlPath);\n+            List<Tag> tags = new ArrayList<>();\n+            tags.add(tag);\n+            newTool.setWorkflowVersions(tags);\n+        }\n+\n+        // Manually register\n+        DockstoreTool tool = containersApi.registerManual(newTool);\n+\n+        // Refresh\n+        tool = containersApi.refresh(tool.getId());\n+\n+        // Publish\n+        if (toPublish) {\n+            tool = containersApi.publish(tool.getId(), SwaggerUtility.createPublishRequest(true));\n+            assertTrue(tool.isIsPublished());\n+        }\n+        return tool;\n+    }\n+\n+    @SuppressWarnings(\"checkstyle:parameternumber\")\n+    private DockstoreTool manualRegisterAndPublish(ContainersApi containersApi, String namespace, String name, String toolName,\n+            String gitUrl, String cwlPath, String wdlPath, String dockerfilePath, DockstoreTool.RegistryEnum registry, String gitReference,\n+            String versionName, boolean toPublish) {\n+        return manualRegisterAndPublish(containersApi, namespace, name, toolName, gitUrl, cwlPath, wdlPath, dockerfilePath, registry,\n+                gitReference, versionName, toPublish, false, null, null);\n+    }\n+\n+\n+    @Test()\n+", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyMzczMQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380823731", "bodyText": "yeah, still runs with the extra line, but removed it", "author": "NatalieEO", "createdAt": "2020-02-18T17:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczMzk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNDIzNw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r379734237", "bodyText": "Do this before a merge.\nI would actually suggest https://github.com/dockstore-testing (in this case, I might be wrong but I don't think the test users need to own these workflows)", "author": "denis-yuen", "createdAt": "2020-02-15T05:04:35Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -846,6 +849,47 @@ public void testManualRegisterThenPublish() throws ApiException {\n         workflowApi.publish(bitbucketWorkflow.getId(), publishRequest);\n     }\n \n+    //TODO: Fork these workflows onto dockstoretestuser", "originalCommit": "a39b21335cbfd6409b0a3c93736a7522703d1ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NTg2Ng==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380975866", "bodyText": "forked", "author": "NatalieEO", "createdAt": "2020-02-18T22:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTczNDIzNw=="}], "type": "inlineReview"}, {"oid": "50e00931bd674fccacea0c75aeeed11bc8466d4e", "url": "https://github.com/dockstore/dockstore/commit/50e00931bd674fccacea0c75aeeed11bc8466d4e", "message": "get quay images for cwl workflows", "committedDate": "2020-02-18T22:18:25Z", "type": "commit"}, {"oid": "6b1227a50d9b3abc1791d4204682de4e54c8dd50", "url": "https://github.com/dockstore/dockstore/commit/6b1227a50d9b3abc1791d4204682de4e54c8dd50", "message": "error message, log error", "committedDate": "2020-02-18T22:18:25Z", "type": "commit"}, {"oid": "2b9d8ff0e9f56efbdc5b23833f35f53c71c8845f", "url": "https://github.com/dockstore/dockstore/commit/2b9d8ff0e9f56efbdc5b23833f35f53c71c8845f", "message": "no underscore :/", "committedDate": "2020-02-18T22:18:25Z", "type": "commit"}, {"oid": "550c1cc3ab2f102f66b574fdddb3bf8e2255c44a", "url": "https://github.com/dockstore/dockstore/commit/550c1cc3ab2f102f66b574fdddb3bf8e2255c44a", "message": "find the leak, other fixes", "committedDate": "2020-02-18T22:18:25Z", "type": "commit"}, {"oid": "6758eeaaa575caeda38723654e48c1aca77e0461", "url": "https://github.com/dockstore/dockstore/commit/6758eeaaa575caeda38723654e48c1aca77e0461", "message": "checkstyle", "committedDate": "2020-02-18T22:18:25Z", "type": "commit"}, {"oid": "001e91f389b373e7c17e2d1db2a84750e6067222", "url": "https://github.com/dockstore/dockstore/commit/001e91f389b373e7c17e2d1db2a84750e6067222", "message": "separate out test", "committedDate": "2020-02-18T22:24:07Z", "type": "commit"}, {"oid": "6a0dfd05ac67748a836cda36a3c012ab227ab5ec", "url": "https://github.com/dockstore/dockstore/commit/6a0dfd05ac67748a836cda36a3c012ab227ab5ec", "message": "Spacing", "committedDate": "2020-02-18T22:24:07Z", "type": "commit"}, {"oid": "3ecf3c67b5d2d87646e554a91e92b458dea7d708", "url": "https://github.com/dockstore/dockstore/commit/3ecf3c67b5d2d87646e554a91e92b458dea7d708", "message": "pr changes", "committedDate": "2020-02-18T22:24:07Z", "type": "commit"}, {"oid": "3ecf3c67b5d2d87646e554a91e92b458dea7d708", "url": "https://github.com/dockstore/dockstore/commit/3ecf3c67b5d2d87646e554a91e92b458dea7d708", "message": "pr changes", "committedDate": "2020-02-18T22:24:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4OTYwNw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380989607", "bodyText": "You are not explicitly handling the case if it is not present. If that is intentional, could you add a comment? If unintentional, you should handle.", "author": "coverbeck", "createdAt": "2020-02-18T23:07:10Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -325,6 +335,97 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        List<Map<String, String>> dockerTools = new ArrayList<>();\n+        dockerTools = (ArrayList<Map<String, String>>)GSON.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        // Eliminate duplicate docker strings\n+        Set<String> dockerStrings = dockerTools.stream().map(dockertool -> dockertool.get(\"docker\")).filter(Objects::nonNull).collect(Collectors.toSet());\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        String errorKey = \"error_message\";\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker;\n+                String[] splitTag;\n+\n+                try {\n+                    splitDocker = image.split(\"/\");\n+                    splitTag = splitDocker[2].split(\":\");\n+                } catch (ArrayIndexOutOfBoundsException ex) {\n+                    LOG.error(\"URL to image on Quay incomplete\", ex);\n+                    break;\n+                }\n+\n+\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);\n+\n+                    if (response.isPresent()) {", "originalCommit": "3ecf3c67b5d2d87646e554a91e92b458dea7d708", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MTkwMw==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r381091903", "bodyText": "handled", "author": "NatalieEO", "createdAt": "2020-02-19T06:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4OTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MjY2MA==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r380992660", "bodyText": "You recalculate splitDocker and splitTag inside getImageResponseFromQuay when you already calculated them above on lines 357-358.\nYou're not going to used repo and tagName unless you get inside the if (response.isPresent()... statement below; I would move lines 366-367 to inside the if block, where you actually need/use them.", "author": "coverbeck", "createdAt": "2020-02-18T23:16:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/LanguageHandlerInterface.java", "diffHunk": "@@ -325,6 +335,97 @@ default String getURLFromEntry(String dockerEntry, ToolDAO toolDAO) {\n         return url;\n     }\n \n+    // TODO: Implement for DockerHub, then gitlab and seven bridges;\n+    default Set<Image> getImagesFromRegistry(String toolsJSONTable) {\n+        List<Map<String, String>> dockerTools = new ArrayList<>();\n+        dockerTools = (ArrayList<Map<String, String>>)GSON.fromJson(toolsJSONTable, dockerTools.getClass());\n+\n+        // Eliminate duplicate docker strings\n+        Set<String> dockerStrings = dockerTools.stream().map(dockertool -> dockertool.get(\"docker\")).filter(Objects::nonNull).collect(Collectors.toSet());\n+\n+        Set<Image> dockerImages = new HashSet<>();\n+        String errorKey = \"error_message\";\n+        for (String image : dockerStrings) {\n+            String[] parts = image.split(\"/\");\n+\n+            Optional<String> response;\n+            if (image.startsWith(\"quay.io/\")) {\n+                String[] splitDocker;\n+                String[] splitTag;\n+\n+                try {\n+                    splitDocker = image.split(\"/\");\n+                    splitTag = splitDocker[2].split(\":\");\n+                } catch (ArrayIndexOutOfBoundsException ex) {\n+                    LOG.error(\"URL to image on Quay incomplete\", ex);\n+                    break;\n+                }\n+\n+\n+                if (splitTag.length > 1) {\n+                    String repo = splitDocker[1] + \"/\" + splitTag[0];\n+                    String tagName = splitTag[1];\n+                    response = getImageResponseFromQuay(image);", "originalCommit": "3ecf3c67b5d2d87646e554a91e92b458dea7d708", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MTg3MQ==", "url": "https://github.com/dockstore/dockstore/pull/3226#discussion_r381091871", "bodyText": "not exactly what you asked for but did change", "author": "NatalieEO", "createdAt": "2020-02-19T06:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk5MjY2MA=="}], "type": "inlineReview"}, {"oid": "754052259af40c9188c5fc7c0d46d9c274e7b6ee", "url": "https://github.com/dockstore/dockstore/commit/754052259af40c9188c5fc7c0d46d9c274e7b6ee", "message": "handle response not present, more readable", "committedDate": "2020-02-19T06:01:41Z", "type": "commit"}]}