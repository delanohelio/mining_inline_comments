{"pr_number": 3325, "pr_title": "Feature/3051/register tool wizard", "pr_createdAt": "2020-03-16T18:59:55Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3325", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxNzMwNA==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394017304", "bodyText": "You'll want to use getDockerPath() instead now. toString() will give QUAY_IO after my changes.", "author": "NatalieEO", "createdAt": "2020-03-17T22:55:30Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -203,6 +216,29 @@ private void insertQuayLastModifiedIntoLastBuilt(QuayTag quayTag, Tag tag) {\n         return toolList;\n     }\n \n+    public Tool getToolFromNamespaceAndRepo(String namespace, String repository) {\n+        try {\n+            String name = namespace + \"/\" + repository;\n+            QuayRepo repo = repositoryApi.getRepo(name, true);\n+\n+            Tool tool = new Tool();\n+            // interesting, this relies upon our container object having the same fields\n+            // as quay.io's repositories\n+\n+            // PLEASE NOTE : is_public is from quay.  It has NO connection to our is_published!\n+            tool.setName(repo.getName());\n+            tool.setNamespace(repo.getNamespace());\n+            // tag all of these with where they came from\n+            tool.setRegistry(Registry.QUAY_IO.toString());", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxNzQxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394017411", "bodyText": "Here too", "author": "NatalieEO", "createdAt": "2020-03-17T22:55:48Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/AbstractImageRegistry.java", "diffHunk": "@@ -158,37 +159,70 @@\n         // Get all the tools based on the found namespaces\n         List<Tool> apiTools = getToolsFromNamespace(namespaces);\n \n+        String registryString = getRegistry().getDockerPath();\n+\n         // Add manual tools to list of api tools\n         User user = userDAO.findById(userId);\n-        List<Tool> manualTools = toolDAO.findByMode(ToolMode.MANUAL_IMAGE_PATH);\n+        List<Tool> manualTools = toolDAO.findByModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        List<Tool> notManualTools = toolDAO.findByNotModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        apiTools.addAll(manualTools);\n+\n+        // Update api tools with build information\n+        updateAPIToolsWithBuildInformation(apiTools);\n+\n+        // Update db tools by copying over from api tools\n+        List<Tool> newDBTools = updateTools(apiTools, notManualTools, user, toolDAO);\n+\n+        // Get tags and update for each tool\n+        for (Tool tool : newDBTools) {\n+            logToolRefresh(dashboardPrefix, tool);\n \n-        // Get all tools in the db for the given registry\n-        List<Tool> dbTools = new ArrayList<>(getToolsFromUser(userId, userDAO, toolDAO));\n+            List<Tag> toolTags = getTags(tool);\n+            final SourceCodeRepoInterface sourceCodeRepo = SourceCodeRepoFactory\n+                .createSourceCodeRepo(tool.getGitUrl(), client, bitbucketToken == null ? null : bitbucketToken.getContent(),\n+                    gitlabToken == null ? null : gitlabToken.getContent(), githubToken.getContent());\n+            updateTags(toolTags, tool, sourceCodeRepo, tagDAO, fileDAO, toolDAO, fileFormatDAO, eventDAO, user);\n+        }\n \n-        // Filter DB tools and API tools to only include relevant tools\n-        manualTools.removeIf(test -> !test.getUsers().contains(user) || !test.getRegistry().equals(getRegistry().getDockerPath()));\n+        return newDBTools;\n+    }\n+\n+    @SuppressWarnings(\"checkstyle:ParameterNumber\")\n+    public List<Tool> refreshTool(final long userId, final UserDAO userDAO, final ToolDAO toolDAO, final TagDAO tagDAO,\n+            final FileDAO fileDAO, final FileFormatDAO fileFormatDAO, final HttpClient client, final Token githubToken, final Token bitbucketToken, final Token gitlabToken,\n+            String organization, final EventDAO eventDAO, final String dashboardPrefix, String repository) {\n+\n+        // Get all the tools based on the found namespaces\n+        List<Tool> apiTools;\n+        if (repository != null) {\n+            apiTools = new ArrayList<>(Collections.singletonList(getToolFromNamespaceAndRepo(organization, repository)));\n+        } else {\n+            throw new CustomWebApplicationException(\"Trying to refresh/register a tool without a repository name\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        // Add manual tools to list of api tools\n+        String registryString = getRegistry().toString();", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxODYxMQ==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394318611", "bodyText": "Will this die if test user 1(?) gains additional docker registries down the road?\nProbably unlikely, but maybe this should use a contains or similar rather than a equals.", "author": "denis-yuen", "createdAt": "2020-03-18T12:45:47Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/UserResourceDockerRegistriesIT.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package io.dockstore.client.cli;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import io.dockstore.common.CommonTestUtilities;\n+import io.dockstore.common.ConfidentialTest;\n+import io.dockstore.openapi.client.ApiClient;\n+import io.dockstore.openapi.client.ApiException;\n+import io.dockstore.openapi.client.api.UsersApi;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.contrib.java.lang.system.ExpectedSystemExit;\n+import org.junit.contrib.java.lang.system.SystemErrRule;\n+import org.junit.contrib.java.lang.system.SystemOutRule;\n+import org.junit.experimental.categories.Category;\n+\n+@Category(ConfidentialTest.class)\n+public class UserResourceDockerRegistriesIT extends BaseIT {\n+    @Rule\n+    public final ExpectedSystemExit systemExit = ExpectedSystemExit.none();\n+\n+    @Rule\n+    public final SystemOutRule systemOutRule = new SystemOutRule().enableLog().muteForSuccessfulTests();\n+\n+    @Rule\n+    public final SystemErrRule systemErrRule = new SystemErrRule().enableLog().muteForSuccessfulTests();\n+\n+    @Before\n+    @Override\n+    public void resetDBBetweenTests() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate1(SUPPORT);\n+    }\n+    @Test\n+    public void getUserDockerRegistriesTest() {\n+        ApiClient client = getOpenAPIWebClient(USER_1_USERNAME, testingPostgres);\n+        UsersApi usersApi = new UsersApi(client);\n+        List<String> actualRegistries = usersApi.getUserDockerRegistries();\n+        List<String> expectedRegistries = Arrays.asList(\"quay.io\", \"gitlab.com\");\n+        Assert.assertEquals(\"Should have the expected Docker registries\", expectedRegistries, actualRegistries);", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1NTQyNQ==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394355425", "bodyText": "I think having it match exactly is important for the validity of the test.  Originally it was returning \"Dockstore\" alongside \"quay.io\" and \"gitlab.com\".", "author": "garyluu", "createdAt": "2020-03-18T13:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxODYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1OTIxOA==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394359218", "bodyText": "Fair enough", "author": "denis-yuen", "createdAt": "2020-03-18T13:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxODYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNzIxNw==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394327217", "bodyText": "Ditto, will this break if we add repos at one point?", "author": "denis-yuen", "createdAt": "2020-03-18T13:00:24Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/UserResourceDockerRegistriesIT.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package io.dockstore.client.cli;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import io.dockstore.common.CommonTestUtilities;\n+import io.dockstore.common.ConfidentialTest;\n+import io.dockstore.openapi.client.ApiClient;\n+import io.dockstore.openapi.client.ApiException;\n+import io.dockstore.openapi.client.api.UsersApi;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.contrib.java.lang.system.ExpectedSystemExit;\n+import org.junit.contrib.java.lang.system.SystemErrRule;\n+import org.junit.contrib.java.lang.system.SystemOutRule;\n+import org.junit.experimental.categories.Category;\n+\n+@Category(ConfidentialTest.class)\n+public class UserResourceDockerRegistriesIT extends BaseIT {\n+    @Rule\n+    public final ExpectedSystemExit systemExit = ExpectedSystemExit.none();\n+\n+    @Rule\n+    public final SystemOutRule systemOutRule = new SystemOutRule().enableLog().muteForSuccessfulTests();\n+\n+    @Rule\n+    public final SystemErrRule systemErrRule = new SystemErrRule().enableLog().muteForSuccessfulTests();\n+\n+    @Before\n+    @Override\n+    public void resetDBBetweenTests() throws Exception {\n+        CommonTestUtilities.cleanStatePrivate1(SUPPORT);\n+    }\n+    @Test\n+    public void getUserDockerRegistriesTest() {\n+        ApiClient client = getOpenAPIWebClient(USER_1_USERNAME, testingPostgres);\n+        UsersApi usersApi = new UsersApi(client);\n+        List<String> actualRegistries = usersApi.getUserDockerRegistries();\n+        List<String> expectedRegistries = Arrays.asList(\"quay.io\", \"gitlab.com\");\n+        Assert.assertEquals(\"Should have the expected Docker registries\", expectedRegistries, actualRegistries);\n+    }\n+\n+    @Test\n+    public void getDockerRegistryOrganizationTest() {\n+        ApiClient client = getOpenAPIWebClient(USER_1_USERNAME, testingPostgres);\n+        UsersApi usersApi = new UsersApi(client);\n+        List<String> actualNamespaces = usersApi.getDockerRegistriesOrganization(\"quay.io\");\n+        List<String> expectedNamespaces = Arrays.asList(\"dockstore\", \"dockstoretestuser\");\n+        Assert.assertEquals(\"Should have the expected namespaces\", expectedNamespaces, actualNamespaces);\n+        try {\n+            usersApi.getDockerRegistriesOrganization(\"fakeDockerRegistry\");\n+            Assert.fail(\"Should not be able to get organizations of an unrecognized Docker registry\");\n+        } catch (ApiException e) {\n+            Assert.assertEquals(\"Should tell user that their Docker registry is unrecognized\", \"Unrecognized Docker registry\", e.getMessage());\n+        }\n+    }\n+\n+    @Test\n+    public void getDockerRegistryOrganizationRepositoriesTest() {\n+        ApiClient client = getOpenAPIWebClient(USER_1_USERNAME, testingPostgres);\n+        UsersApi usersApi = new UsersApi(client);\n+        List<String> actualRepositories = usersApi.getDockerRegistryOrganizationRepositories(\"quay.io\", \"dockstoretestuser\");\n+        List<String> expectedRepositories = Arrays.asList(\"noautobuild\", \"nobuildsatall\", \"quayandbitbucket\", \"quayandbitbucketalternate\", \"quayandgithub\", \"quayandgithubalternate\", \"quayandgithubwdl\", \"quayandgitlab\", \"quayandgitlabalternate\", \"test_input_json\");", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzNzM5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394337391", "bodyText": "Date", "author": "denis-yuen", "createdAt": "2020-03-18T13:16:58Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResourceDockerRegistries.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ *    Copyright 2017 OICR", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzNzUwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394337509", "bodyText": "Probably copied from somewhere", "author": "denis-yuen", "createdAt": "2020-03-18T13:17:09Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResourceDockerRegistries.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ *    Copyright 2017 OICR\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *    you may not use this file except in compliance with the License.\n+ *    You may obtain a copy of the License at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    Unless required by applicable law or agreed to in writing, software\n+ *    distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *    See the License for the specific language governing permissions and\n+ *    limitations under the License.\n+ */\n+\n+package io.dockstore.webservice.resources;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.Token;\n+import io.dockstore.webservice.core.TokenType;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.helpers.AbstractImageRegistry;\n+import io.dockstore.webservice.helpers.ImageRegistryFactory;\n+import io.dockstore.webservice.helpers.QuayImageRegistry;\n+import io.dockstore.webservice.jdbi.TokenDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.v3.oas.annotations.Operation;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import io.swagger.v3.oas.annotations.enums.ParameterIn;\n+import io.swagger.v3.oas.annotations.security.SecurityRequirement;\n+import io.swagger.v3.oas.annotations.tags.Tag;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static io.dockstore.webservice.resources.ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME;\n+\n+/**\n+ * @author xliu", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxNjk0NA==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394016944", "bodyText": "Why not LOG.error? Is this a normal situation?", "author": "coverbeck", "createdAt": "2020-03-17T22:54:32Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/QuayImageRegistry.java", "diffHunk": "@@ -203,6 +216,29 @@ private void insertQuayLastModifiedIntoLastBuilt(QuayTag quayTag, Tag tag) {\n         return toolList;\n     }\n \n+    public Tool getToolFromNamespaceAndRepo(String namespace, String repository) {\n+        try {\n+            String name = namespace + \"/\" + repository;\n+            QuayRepo repo = repositoryApi.getRepo(name, true);\n+\n+            Tool tool = new Tool();\n+            // interesting, this relies upon our container object having the same fields\n+            // as quay.io's repositories\n+\n+            // PLEASE NOTE : is_public is from quay.  It has NO connection to our is_published!\n+            tool.setName(repo.getName());\n+            tool.setNamespace(repo.getNamespace());\n+            // tag all of these with where they came from\n+            tool.setRegistry(Registry.QUAY_IO.toString());\n+            // not quite correct, they could be mixed but how can we tell from quay?\n+            tool.setMode(ToolMode.AUTO_DETECT_QUAY_TAGS_AUTOMATED_BUILDS);\n+            return tool;\n+        } catch (ApiException ex) {\n+            LOG.warn(quayToken.getUsername() + \" Exception: {}\", ex);", "originalCommit": "0c82b6da307307f6cadbf9aa993a4c5a2ea2da35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyNDM4Ng==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r395724386", "bodyText": "Keeping same as how we handle it for tools", "author": "garyluu", "createdAt": "2020-03-20T15:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxNjk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4MzU2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394483567", "bodyText": "I wonder if it's quicker to just do one query instead of two, then separate the results by ToolMode? Filtering and sorting are a lot faster in the DB, but here, you end up fetching all tool modes anyway, i.e., not filtering on ToolMode.\nThat said, probably not worth worrying about, and maybe it is faster the current way.", "author": "coverbeck", "createdAt": "2020-03-18T16:33:57Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/AbstractImageRegistry.java", "diffHunk": "@@ -158,37 +159,70 @@\n         // Get all the tools based on the found namespaces\n         List<Tool> apiTools = getToolsFromNamespace(namespaces);\n \n+        String registryString = getRegistry().getDockerPath();\n+\n         // Add manual tools to list of api tools\n         User user = userDAO.findById(userId);\n-        List<Tool> manualTools = toolDAO.findByMode(ToolMode.MANUAL_IMAGE_PATH);\n+        List<Tool> manualTools = toolDAO.findByModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        List<Tool> notManualTools = toolDAO.findByNotModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);", "originalCommit": "0a95b851f5264b998a607abde3e9123392d19e5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NDgwNg==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394484806", "bodyText": "Can't githubToken be null? If someone logs in with Google? Not that we have any users like that, but maybe someday...", "author": "coverbeck", "createdAt": "2020-03-18T16:35:47Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/AbstractImageRegistry.java", "diffHunk": "@@ -158,37 +159,70 @@\n         // Get all the tools based on the found namespaces\n         List<Tool> apiTools = getToolsFromNamespace(namespaces);\n \n+        String registryString = getRegistry().getDockerPath();\n+\n         // Add manual tools to list of api tools\n         User user = userDAO.findById(userId);\n-        List<Tool> manualTools = toolDAO.findByMode(ToolMode.MANUAL_IMAGE_PATH);\n+        List<Tool> manualTools = toolDAO.findByModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        List<Tool> notManualTools = toolDAO.findByNotModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        apiTools.addAll(manualTools);\n+\n+        // Update api tools with build information\n+        updateAPIToolsWithBuildInformation(apiTools);\n+\n+        // Update db tools by copying over from api tools\n+        List<Tool> newDBTools = updateTools(apiTools, notManualTools, user, toolDAO);\n+\n+        // Get tags and update for each tool\n+        for (Tool tool : newDBTools) {\n+            logToolRefresh(dashboardPrefix, tool);\n \n-        // Get all tools in the db for the given registry\n-        List<Tool> dbTools = new ArrayList<>(getToolsFromUser(userId, userDAO, toolDAO));\n+            List<Tag> toolTags = getTags(tool);\n+            final SourceCodeRepoInterface sourceCodeRepo = SourceCodeRepoFactory\n+                .createSourceCodeRepo(tool.getGitUrl(), client, bitbucketToken == null ? null : bitbucketToken.getContent(),\n+                    gitlabToken == null ? null : gitlabToken.getContent(), githubToken.getContent());", "originalCommit": "0a95b851f5264b998a607abde3e9123392d19e5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NTU0MA==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394485540", "bodyText": "Same comment on githubToken", "author": "coverbeck", "createdAt": "2020-03-18T16:36:56Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/AbstractImageRegistry.java", "diffHunk": "@@ -158,37 +159,70 @@\n         // Get all the tools based on the found namespaces\n         List<Tool> apiTools = getToolsFromNamespace(namespaces);\n \n+        String registryString = getRegistry().getDockerPath();\n+\n         // Add manual tools to list of api tools\n         User user = userDAO.findById(userId);\n-        List<Tool> manualTools = toolDAO.findByMode(ToolMode.MANUAL_IMAGE_PATH);\n+        List<Tool> manualTools = toolDAO.findByModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        List<Tool> notManualTools = toolDAO.findByNotModeRegistryNamespace(ToolMode.MANUAL_IMAGE_PATH, registryString, organization);\n+        apiTools.addAll(manualTools);\n+\n+        // Update api tools with build information\n+        updateAPIToolsWithBuildInformation(apiTools);\n+\n+        // Update db tools by copying over from api tools\n+        List<Tool> newDBTools = updateTools(apiTools, notManualTools, user, toolDAO);\n+\n+        // Get tags and update for each tool\n+        for (Tool tool : newDBTools) {\n+            logToolRefresh(dashboardPrefix, tool);\n \n-        // Get all tools in the db for the given registry\n-        List<Tool> dbTools = new ArrayList<>(getToolsFromUser(userId, userDAO, toolDAO));\n+            List<Tag> toolTags = getTags(tool);\n+            final SourceCodeRepoInterface sourceCodeRepo = SourceCodeRepoFactory\n+                .createSourceCodeRepo(tool.getGitUrl(), client, bitbucketToken == null ? null : bitbucketToken.getContent(),\n+                    gitlabToken == null ? null : gitlabToken.getContent(), githubToken.getContent());\n+            updateTags(toolTags, tool, sourceCodeRepo, tagDAO, fileDAO, toolDAO, fileFormatDAO, eventDAO, user);\n+        }\n \n-        // Filter DB tools and API tools to only include relevant tools\n-        manualTools.removeIf(test -> !test.getUsers().contains(user) || !test.getRegistry().equals(getRegistry().getDockerPath()));\n+        return newDBTools;\n+    }\n+\n+    @SuppressWarnings(\"checkstyle:ParameterNumber\")\n+    public List<Tool> refreshTool(final long userId, final UserDAO userDAO, final ToolDAO toolDAO, final TagDAO tagDAO,\n+            final FileDAO fileDAO, final FileFormatDAO fileFormatDAO, final HttpClient client, final Token githubToken, final Token bitbucketToken, final Token gitlabToken,\n+            String organization, final EventDAO eventDAO, final String dashboardPrefix, String repository) {\n+\n+        // Get all the tools based on the found namespaces\n+        List<Tool> apiTools;\n+        if (repository != null) {\n+            apiTools = new ArrayList<>(Collections.singletonList(getToolFromNamespaceAndRepo(organization, repository)));\n+        } else {\n+            throw new CustomWebApplicationException(\"Trying to refresh/register a tool without a repository name\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        // Add manual tools to list of api tools\n+        String registryString = getRegistry().getDockerPath();\n+        \n+        User user = userDAO.findById(userId);\n+        List<Tool> manualTools = toolDAO.findByModeRegistryNamespaceRepository(ToolMode.MANUAL_IMAGE_PATH, registryString, organization, repository);\n+        List<Tool> notManualTools = toolDAO.findByNotModeRegistryNamespaceRepository(ToolMode.MANUAL_IMAGE_PATH, registryString, organization, repository);\n \n-        dbTools.removeIf(test -> !test.getRegistry().equals(getRegistry().getDockerPath()));\n         apiTools.addAll(manualTools);\n \n-        // Remove tools that can't be updated (Manual tools)\n-        dbTools.removeIf(tool1 -> tool1.getMode() == ToolMode.MANUAL_IMAGE_PATH);\n-        apiTools.removeIf(tool -> !namespaces.contains(tool.getNamespace()));\n-        dbTools.removeIf(tool -> !namespaces.contains(tool.getNamespace()));\n         // Update api tools with build information\n         updateAPIToolsWithBuildInformation(apiTools);\n \n         // Update db tools by copying over from api tools\n-        List<Tool> newDBTools = updateTools(apiTools, dbTools, user, toolDAO);\n+        List<Tool> newDBTools = updateTools(apiTools, notManualTools, user, toolDAO);\n \n         // Get tags and update for each tool\n         for (Tool tool : newDBTools) {\n             logToolRefresh(dashboardPrefix, tool);\n \n             List<Tag> toolTags = getTags(tool);\n             final SourceCodeRepoInterface sourceCodeRepo = SourceCodeRepoFactory\n-                .createSourceCodeRepo(tool.getGitUrl(), client, bitbucketToken == null ? null : bitbucketToken.getContent(),\n-                    gitlabToken == null ? null : gitlabToken.getContent(), githubToken.getContent());\n+                    .createSourceCodeRepo(tool.getGitUrl(), client, bitbucketToken == null ? null : bitbucketToken.getContent(),\n+                            gitlabToken == null ? null : gitlabToken.getContent(), githubToken.getContent());", "originalCommit": "0a95b851f5264b998a607abde3e9123392d19e5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NzIzMw==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394487233", "bodyText": "It would be nice if this string were a constant. That way if we add support for DockerHub but not manual, we only have to update the string in one location", "author": "coverbeck", "createdAt": "2020-03-18T16:39:28Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/ManualRegistry.java", "diffHunk": "@@ -61,4 +63,9 @@ public Registry getRegistry() {\n     public boolean canConvertToAuto(Tool tool) {\n         return false;\n     }\n+\n+    @Override\n+    public Tool getToolFromNamespaceAndRepo(final String organization, final String repository) {\n+        throw new CustomWebApplicationException(\"Unsupported operation, only Quay.io is supported for now\", HttpStatus.SC_BAD_REQUEST);", "originalCommit": "0a95b851f5264b998a607abde3e9123392d19e5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4OTE4Ng==", "url": "https://github.com/dockstore/dockstore/pull/3325#discussion_r394489186", "bodyText": "Why do you wrap it with an ArrayList and not just return registry.refreshTool(... directly?", "author": "coverbeck", "createdAt": "2020-03-18T16:42:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/DockerRepoResource.java", "diffHunk": "@@ -184,12 +180,43 @@ public DockerRepoResource(final HttpClient client, final SessionFactory sessionF\n             LOG.info(\"Grabbing \" + registry.getFriendlyName() + \" repos\");\n \n             updatedTools.addAll(abstractImageRegistry\n-                .refreshTools(userId, userDAO, toolDAO, tagDAO, fileDAO, fileFormatDAO, client, githubToken, bitbucketToken, gitlabToken,\n-                    organization, eventDAO, dashboardPrefix));\n+                .refreshTools(userId, userDAO, toolDAO, tagDAO, fileDAO, fileFormatDAO, client, githubToken, bitbucketToken,\n+                    gitlabToken, organization, eventDAO, dashboardPrefix));\n         }\n         return updatedTools;\n     }\n \n+    List<Tool> refreshToolsForUser(Long userId, String organization, String repository) {\n+        refreshBitbucketToken(userId);\n+\n+        // Get user's quay and git tokens\n+        List<Token> tokens = tokenDAO.findByUserId(userId);\n+        Token quayToken = Token.extractToken(tokens, TokenType.QUAY_IO);\n+        Token githubToken = Token.extractToken(tokens, TokenType.GITHUB_COM);\n+        Token bitbucketToken = Token.extractToken(tokens, TokenType.BITBUCKET_ORG);\n+        Token gitlabToken = Token.extractToken(tokens, TokenType.GITLAB_COM);\n+\n+        // with Docker Hub support it is now possible that there is no quayToken\n+        checkTokens(quayToken, githubToken, bitbucketToken, gitlabToken);\n+\n+        // Get a list of all namespaces from Quay.io only\n+        if (quayToken == null) {\n+            throw new CustomWebApplicationException(\"Missing required Quay.io token\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+        QuayImageRegistry registry = new QuayImageRegistry(quayToken);\n+        return new ArrayList<>(", "originalCommit": "0a95b851f5264b998a607abde3e9123392d19e5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51a2ed3f47a641792c64b5b16d543e2466919df7", "url": "https://github.com/dockstore/dockstore/commit/51a2ed3f47a641792c64b5b16d543e2466919df7", "message": "Add new endpoints", "committedDate": "2020-03-24T18:14:04Z", "type": "commit"}, {"oid": "6520b50d6f113f8b14ff3993d101de7f323c5b26", "url": "https://github.com/dockstore/dockstore/commit/6520b50d6f113f8b14ff3993d101de7f323c5b26", "message": "Fix tests", "committedDate": "2020-03-24T18:14:04Z", "type": "commit"}, {"oid": "bbe9f3eb0bab178031d3eb588a15d6a58d715501", "url": "https://github.com/dockstore/dockstore/commit/bbe9f3eb0bab178031d3eb588a15d6a58d715501", "message": "Fix for getting Docker registries", "committedDate": "2020-03-24T18:14:04Z", "type": "commit"}, {"oid": "c0aa7c1be01304c6cf26075e4b6f5cce0402ae73", "url": "https://github.com/dockstore/dockstore/commit/c0aa7c1be01304c6cf26075e4b6f5cce0402ae73", "message": "Add some tests", "committedDate": "2020-03-24T18:14:04Z", "type": "commit"}, {"oid": "bab15eb75dad4da31e266326558776ecdaaefe5d", "url": "https://github.com/dockstore/dockstore/commit/bab15eb75dad4da31e266326558776ecdaaefe5d", "message": "Throw exception for other registries that somehow make it through", "committedDate": "2020-03-24T18:14:12Z", "type": "commit"}, {"oid": "8a4abadfe42b7c62f6c6bab2555a01fe419d196a", "url": "https://github.com/dockstore/dockstore/commit/8a4abadfe42b7c62f6c6bab2555a01fe419d196a", "message": "Change exception message", "committedDate": "2020-03-24T18:14:12Z", "type": "commit"}, {"oid": "08ba87a6216c5ddaeba7c0a73fbbdf946fdf58ab", "url": "https://github.com/dockstore/dockstore/commit/08ba87a6216c5ddaeba7c0a73fbbdf946fdf58ab", "message": "Change to getDockerPath()", "committedDate": "2020-03-24T18:14:12Z", "type": "commit"}, {"oid": "53aea73044c4348e79beaa37daadd5ed2b40031a", "url": "https://github.com/dockstore/dockstore/commit/53aea73044c4348e79beaa37daadd5ed2b40031a", "message": "Fix comments, add sorting", "committedDate": "2020-03-24T18:14:12Z", "type": "commit"}, {"oid": "6b3a66847371384f679af0895b1ccddf7f213288", "url": "https://github.com/dockstore/dockstore/commit/6b3a66847371384f679af0895b1ccddf7f213288", "message": "Less likely to break test", "committedDate": "2020-03-24T18:14:13Z", "type": "commit"}, {"oid": "61ad855a9f7430a51f45c3e396538064685eb0b5", "url": "https://github.com/dockstore/dockstore/commit/61ad855a9f7430a51f45c3e396538064685eb0b5", "message": "PR changes", "committedDate": "2020-03-24T18:14:13Z", "type": "commit"}, {"oid": "e2478c56487ee361302f621c310de59d1e3ac16e", "url": "https://github.com/dockstore/dockstore/commit/e2478c56487ee361302f621c310de59d1e3ac16e", "message": "Update openapi/swagger", "committedDate": "2020-03-24T18:19:51Z", "type": "commit"}, {"oid": "e2478c56487ee361302f621c310de59d1e3ac16e", "url": "https://github.com/dockstore/dockstore/commit/e2478c56487ee361302f621c310de59d1e3ac16e", "message": "Update openapi/swagger", "committedDate": "2020-03-24T18:19:51Z", "type": "forcePushed"}]}