{"pr_number": 3260, "pr_title": "Feature/2421/link orcid", "pr_createdAt": "2020-02-24T20:08:35Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3260", "timeline": [{"oid": "c80eae1cf8d93887131fb5cabaa86c653f58a7cc", "url": "https://github.com/dockstore/dockstore/commit/c80eae1cf8d93887131fb5cabaa86c653f58a7cc", "message": "added POST endpoint", "committedDate": "2020-02-21T21:52:06Z", "type": "commit"}, {"oid": "662f7b6c887cb1726700a4e3a7e0b5474acc0bf1", "url": "https://github.com/dockstore/dockstore/commit/662f7b6c887cb1726700a4e3a7e0b5474acc0bf1", "message": "orcid token endpoint working", "committedDate": "2020-02-24T20:07:36Z", "type": "commit"}, {"oid": "e7f9a005d098b6975328a3d9f8386365776832c3", "url": "https://github.com/dockstore/dockstore/commit/e7f9a005d098b6975328a3d9f8386365776832c3", "message": "set token username to username from ORCID response", "committedDate": "2020-02-24T20:29:17Z", "type": "commit"}, {"oid": "326efaf48a98c0695d6781dfd308b65105de0c9a", "url": "https://github.com/dockstore/dockstore/commit/326efaf48a98c0695d6781dfd308b65105de0c9a", "message": "cleanup", "committedDate": "2020-02-24T21:01:32Z", "type": "commit"}, {"oid": "a638d05aa1b9121f23995897591bf45eec7642ce", "url": "https://github.com/dockstore/dockstore/commit/a638d05aa1b9121f23995897591bf45eec7642ce", "message": "added orcid fields to dockstore yml template", "committedDate": "2020-02-24T21:13:17Z", "type": "commit"}, {"oid": "c00a576d57ccc6d4275bdab654995c3f1d35e29a", "url": "https://github.com/dockstore/dockstore/commit/c00a576d57ccc6d4275bdab654995c3f1d35e29a", "message": "updated config types", "committedDate": "2020-02-24T23:21:42Z", "type": "commit"}, {"oid": "5415772ab7a7f35aac86438021a2dfcafea75373", "url": "https://github.com/dockstore/dockstore/commit/5415772ab7a7f35aac86438021a2dfcafea75373", "message": "updated api yamls", "committedDate": "2020-02-25T00:04:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk2NDczOA==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r383964738", "bodyText": "Think build might be dying because these are set as required.\nEither add dummy values to the dropwizard config files used or allow these to be empty.", "author": "denis-yuen", "createdAt": "2020-02-25T15:47:46Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/DockstoreWebserviceConfiguration.java", "diffHunk": "@@ -108,6 +108,15 @@\n     @NotEmpty\n     private String zenodoClientSecret;\n \n+    @NotEmpty", "originalCommit": "5415772ab7a7f35aac86438021a2dfcafea75373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2583623dba6da34420afb8b0c31f2bc6d3ad7272", "url": "https://github.com/dockstore/dockstore/commit/2583623dba6da34420afb8b0c31f2bc6d3ad7272", "message": "update secret archive", "committedDate": "2020-02-26T18:20:54Z", "type": "commit"}, {"oid": "3ed94ecdefe7f0c1bece78bf268bc7ff630048c8", "url": "https://github.com/dockstore/dockstore/commit/3ed94ecdefe7f0c1bece78bf268bc7ff630048c8", "message": "Merge branch 'develop' into feature/2421/link-orcid", "committedDate": "2020-02-26T20:04:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2OTU2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r384769567", "bodyText": "Log the exception itself as well.", "author": "coverbeck", "createdAt": "2020-02-26T21:15:07Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -618,6 +623,65 @@ public Token addBitbucketToken(@ApiParam(hidden = true) @Auth User user, @QueryP\n         }\n     }\n \n+    @POST\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/orcid.org\")\n+    @ApiOperation(value = \"Add a new orcid.org token\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, notes = \"This is used as part of the OAuth 2 web flow. \"\n+            + \"Once a user has approved permissions for Collaboratory\"\n+            + \"Their browser will load the redirect URI which should resolve here\", response = Token.class)\n+    public Token addOrcidToken(@ApiParam(hidden = true) @Auth User user, @QueryParam(\"code\") String code) throws IOException {\n+        String accessToken;\n+        String refreshToken;\n+        String username;\n+\n+        if (code.isEmpty()) {\n+            throw new CustomWebApplicationException(\"Please provide an access code\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        final AuthorizationCodeFlow flow = new AuthorizationCodeFlow.Builder(BearerToken.authorizationHeaderAccessMethod(), HTTP_TRANSPORT,\n+                JSON_FACTORY, new GenericUrl(ORCID_URL + \"oauth/token\"),\n+                new ClientParametersAuthentication(orcidClientID, orcidClientSecret), orcidClientID,\n+                ORCID_URL + \"/authorize\").build();\n+\n+        try {\n+            TokenResponse tokenResponse = flow.newTokenRequest(code).setScopes(Collections.singletonList(\"/authenticate\"))\n+                    .setRequestInitializer(request -> request.getHeaders().setAccept(\"application/json\")).execute();\n+            accessToken = tokenResponse.getAccessToken();\n+            refreshToken = tokenResponse.getRefreshToken();\n+\n+            // ORCID API returns the user's ORCID username in the \"name\" property\n+            username = tokenResponse.get(\"name\").toString();\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Retrieving accessToken was unsuccessful\");", "originalCommit": "3ed94ecdefe7f0c1bece78bf268bc7ff630048c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d70a48cc336573423be240ba6cf04ead4eb0f8fd", "url": "https://github.com/dockstore/dockstore/commit/d70a48cc336573423be240ba6cf04ead4eb0f8fd", "message": "removed orcidRedirectURI field", "committedDate": "2020-02-26T21:30:24Z", "type": "commit"}, {"oid": "a5984780b8847a3ffc94ce901a05c688e9946ad7", "url": "https://github.com/dockstore/dockstore/commit/a5984780b8847a3ffc94ce901a05c688e9946ad7", "message": "Merge branch 'feature/2421/link-orcid' of https://github.com/dockstore/dockstore into feature/2421/link-orcid", "committedDate": "2020-02-26T21:31:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE1NDA4MA==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r385154080", "bodyText": "Missing openapi", "author": "garyluu", "createdAt": "2020-02-27T14:18:22Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -618,6 +623,65 @@ public Token addBitbucketToken(@ApiParam(hidden = true) @Auth User user, @QueryP\n         }\n     }\n \n+    @POST\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/orcid.org\")\n+    @ApiOperation(value = \"Add a new orcid.org token\", authorizations = {", "originalCommit": "3ed94ecdefe7f0c1bece78bf268bc7ff630048c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU1Mjg2NA==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r386552864", "bodyText": "added openapi annotation also", "author": "emlys", "createdAt": "2020-03-02T17:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE1NDA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE1NTM2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r385155362", "bodyText": "This is currently fine since there are no join tables in Token otherwise select count would've been better.", "author": "garyluu", "createdAt": "2020-02-27T14:20:16Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -618,6 +623,65 @@ public Token addBitbucketToken(@ApiParam(hidden = true) @Auth User user, @QueryP\n         }\n     }\n \n+    @POST\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/orcid.org\")\n+    @ApiOperation(value = \"Add a new orcid.org token\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, notes = \"This is used as part of the OAuth 2 web flow. \"\n+            + \"Once a user has approved permissions for Collaboratory\"\n+            + \"Their browser will load the redirect URI which should resolve here\", response = Token.class)\n+    public Token addOrcidToken(@ApiParam(hidden = true) @Auth User user, @QueryParam(\"code\") String code) throws IOException {\n+        String accessToken;\n+        String refreshToken;\n+        String username;\n+\n+        if (code.isEmpty()) {\n+            throw new CustomWebApplicationException(\"Please provide an access code\", HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        final AuthorizationCodeFlow flow = new AuthorizationCodeFlow.Builder(BearerToken.authorizationHeaderAccessMethod(), HTTP_TRANSPORT,\n+                JSON_FACTORY, new GenericUrl(ORCID_URL + \"oauth/token\"),\n+                new ClientParametersAuthentication(orcidClientID, orcidClientSecret), orcidClientID,\n+                ORCID_URL + \"/authorize\").build();\n+\n+        try {\n+            TokenResponse tokenResponse = flow.newTokenRequest(code).setScopes(Collections.singletonList(\"/authenticate\"))\n+                    .setRequestInitializer(request -> request.getHeaders().setAccept(\"application/json\")).execute();\n+            accessToken = tokenResponse.getAccessToken();\n+            refreshToken = tokenResponse.getRefreshToken();\n+\n+            // ORCID API returns the user's ORCID username in the \"name\" property\n+            username = tokenResponse.get(\"name\").toString();\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Retrieving accessToken was unsuccessful\");\n+            throw new CustomWebApplicationException(e.getMessage(), HttpStatus.SC_BAD_REQUEST);\n+        }\n+\n+        if (user != null) {\n+            List<Token> tokens = tokenDAO.findOrcidByUserId(user.getId());", "originalCommit": "3ed94ecdefe7f0c1bece78bf268bc7ff630048c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0daa7832d76a57455a1a8bd18e0a36cd8b6fad5f", "url": "https://github.com/dockstore/dockstore/commit/0daa7832d76a57455a1a8bd18e0a36cd8b6fad5f", "message": "pr review and codacy changes", "committedDate": "2020-03-02T18:27:17Z", "type": "commit"}, {"oid": "030257f6ced97def7000cb099dd3e467965017c7", "url": "https://github.com/dockstore/dockstore/commit/030257f6ced97def7000cb099dd3e467965017c7", "message": "Merge branch 'develop' into feature/2421/link-orcid", "committedDate": "2020-03-02T18:32:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r386609097", "bodyText": "Make sure that the openapi.yaml changes that are checked-in roughly matches the swagger.yaml changes", "author": "garyluu", "createdAt": "2020-03-02T19:42:15Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -618,6 +625,66 @@ public Token addBitbucketToken(@ApiParam(hidden = true) @Auth User user, @QueryP\n         }\n     }\n \n+    @POST\n+    @Timed\n+    @UnitOfWork\n+    @Path(\"/orcid.org\")\n+    @ApiOperation(value = \"Add a new orcid.org token\", authorizations = {\n+            @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, notes = \"This is used as part of the OAuth 2 web flow. \"\n+            + \"Once a user has approved permissions for ORCID, \"\n+            + \"their browser will load the redirect URI which should resolve here\", response = Token.class)\n+    @Operation(operationId = \"addOrcidToken\", summary = \"Request and store tokens from ORCID API\", security = @SecurityRequirement(name = \"bearer\"))", "originalCommit": "030257f6ced97def7000cb099dd3e467965017c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgxODA0Mw==", "url": "https://github.com/dockstore/dockstore/pull/3260#discussion_r387818043", "bodyText": "Looks about the same to me", "author": "emlys", "createdAt": "2020-03-04T17:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTA5Nw=="}], "type": "inlineReview"}, {"oid": "4a79fb2d40c2272b162be6bc3cb800217c0cecaf", "url": "https://github.com/dockstore/dockstore/commit/4a79fb2d40c2272b162be6bc3cb800217c0cecaf", "message": "check in openapi yaml; reset CUSTOM_DIR_NAME", "committedDate": "2020-03-04T17:22:07Z", "type": "commit"}, {"oid": "76fde0a834423d9de318d3df5505899606b73dcd", "url": "https://github.com/dockstore/dockstore/commit/76fde0a834423d9de318d3df5505899606b73dcd", "message": "using variables for endpoint summaries and descriptions", "committedDate": "2020-03-04T17:51:29Z", "type": "commit"}, {"oid": "562d691cbb3f2ffc06a888ae52c7e87e33628a85", "url": "https://github.com/dockstore/dockstore/commit/562d691cbb3f2ffc06a888ae52c7e87e33628a85", "message": "maven checkstyle", "committedDate": "2020-03-04T18:27:57Z", "type": "commit"}, {"oid": "1cea0acadffab9f4bbca7b25a352516f43c1398a", "url": "https://github.com/dockstore/dockstore/commit/1cea0acadffab9f4bbca7b25a352516f43c1398a", "message": "include yaml files", "committedDate": "2020-03-04T21:16:06Z", "type": "commit"}, {"oid": "a811784eee2eec77347646496304a7db5369384d", "url": "https://github.com/dockstore/dockstore/commit/a811784eee2eec77347646496304a7db5369384d", "message": "hiding user param from openapi", "committedDate": "2020-03-04T21:49:54Z", "type": "commit"}, {"oid": "a0578b49a313c1779fffa0db48f70dc23bde661f", "url": "https://github.com/dockstore/dockstore/commit/a0578b49a313c1779fffa0db48f70dc23bde661f", "message": "updated openapi yaml", "committedDate": "2020-03-04T22:02:12Z", "type": "commit"}, {"oid": "5c564b70e6500e35c427c904248ebd80a02ec6d8", "url": "https://github.com/dockstore/dockstore/commit/5c564b70e6500e35c427c904248ebd80a02ec6d8", "message": "Merge branch 'develop' into feature/2421/link-orcid", "committedDate": "2020-03-09T17:47:55Z", "type": "commit"}]}