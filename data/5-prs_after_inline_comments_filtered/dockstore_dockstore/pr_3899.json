{"pr_number": 3899, "pr_title": "Changes for elasticsearch6 update", "pr_createdAt": "2020-10-30T16:23:13Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3899", "timeline": [{"oid": "857b2db8d037835c27fa4da197ebc4a830b0245b", "url": "https://github.com/dockstore/dockstore/commit/857b2db8d037835c27fa4da197ebc4a830b0245b", "message": "Changed string to text, changed not_analyzed to false", "committedDate": "2020-10-26T18:29:59Z", "type": "commit"}, {"oid": "2990bfe8b4428e053293eb6bba5effbc835dc0db", "url": "https://github.com/dockstore/dockstore/commit/2990bfe8b4428e053293eb6bba5effbc835dc0db", "message": "Creates and updates two indices, search endpoint updated", "committedDate": "2020-10-29T19:18:45Z", "type": "commit"}, {"oid": "be3ce2689fdb0857d69d2525a8fb08065b2274d1", "url": "https://github.com/dockstore/dockstore/commit/be3ce2689fdb0857d69d2525a8fb08065b2274d1", "message": "change author mapping to keyword", "committedDate": "2020-10-29T20:04:28Z", "type": "commit"}, {"oid": "9843cf2dcb900cab803aaaca66735844dbe51c34", "url": "https://github.com/dockstore/dockstore/commit/9843cf2dcb900cab803aaaca66735844dbe51c34", "message": "map author as fielddata for filtering", "committedDate": "2020-10-30T16:14:33Z", "type": "commit"}, {"oid": "3714751cbe40b02e9abace6a6321d6540c16efb3", "url": "https://github.com/dockstore/dockstore/commit/3714751cbe40b02e9abace6a6321d6540c16efb3", "message": "Merge branch 'develop' into feature/1780/supportElasticsearch6", "committedDate": "2020-10-30T16:24:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNDk1OA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515234958", "bodyText": "It was like this, but this looks like the same path as line 111. Would be good to have a variable to avoid duplication.", "author": "coverbeck", "createdAt": "2020-10-30T16:48:09Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -101,17 +101,17 @@ public void handleIndexUpdate(Entry entry, StateManagerMode command) {\n         String json;\n         json = getDocumentValueFromEntry(entry);\n         try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {\n-            String entryType = entry instanceof Tool ? \"tool\" : \"workflow\";\n+            String entryType = entry instanceof Tool ? \"tools\" : \"workflows\";\n             HttpEntity entity = new NStringEntity(json, ContentType.APPLICATION_JSON);\n             Response post;\n             switch (command) {\n             case PUBLISH:\n             case UPDATE:\n                 post = restClient\n-                    .performRequest(\"POST\", \"/entry/\" + entryType + \"/\" + entry.getId() + \"/_update\", Collections.emptyMap(), entity);\n+                    .performRequest(\"POST\", \"/\" + entryType + \"/_doc/\" + entry.getId() + \"/_update\", Collections.emptyMap(), entity);\n                 break;\n             case DELETE:\n-                post = restClient.performRequest(\"DELETE\", \"/entry/\" + entryType + \"/\" + entry.getId(), Collections.emptyMap(), entity);\n+                post = restClient.performRequest(\"DELETE\", \"/\" + entryType + \"/_doc/\" + entry.getId(), Collections.emptyMap(), entity);", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwNzc0MA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515307740", "bodyText": "Do you mean to set \"/\" + entryType + \"/_doc/\" + entry.getId() as a variable?", "author": "nrzhao4", "createdAt": "2020-10-30T18:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNDk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxMDkyMA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515310920", "bodyText": "Yes, and use it here and on line 111.", "author": "coverbeck", "createdAt": "2020-10-30T18:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNDk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzU1Mw==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515237553", "bodyText": "General comment that also applies to line 162 -- If somebody tries to index a service (I don't think we do), then here it will get treated as a workflow, but on lines 162 and 163, you will ignore services. Maybe that's OK. Just making sure.", "author": "coverbeck", "createdAt": "2020-10-30T16:52:11Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -101,17 +101,17 @@ public void handleIndexUpdate(Entry entry, StateManagerMode command) {\n         String json;\n         json = getDocumentValueFromEntry(entry);\n         try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {\n-            String entryType = entry instanceof Tool ? \"tool\" : \"workflow\";\n+            String entryType = entry instanceof Tool ? \"tools\" : \"workflows\";", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxMDUwNA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515310504", "bodyText": "In line 88 if the entry is a service it would also get ignored after being set to null. i think its ok for now since we aren't indexing services yet", "author": "nrzhao4", "createdAt": "2020-10-30T18:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODk2MA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515238960", "bodyText": "This check could be done before you sort the entries.\nIn theory, you may need to test in each of the blocks below, e.g., if tools is empty but workflows is not, then I think you'll want to skip the first block.", "author": "coverbeck", "createdAt": "2020-10-30T16:54:28Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -158,19 +158,34 @@ public void bulkUpsert(List<Entry> entries) {\n         entries.forEach(this::eagerLoadEntry);\n         entries = filterCheckerWorkflows(entries);\n         // #2771 will need to disable this and properly create objects to get services into the index\n-        entries = entries.stream().filter(entry -> !(entry instanceof Service)).collect(Collectors.toList());\n+        // sort entries into workflows and tools\n+        List<Entry> workflows = entries.stream().filter(entry -> (entry instanceof BioWorkflow)).collect(Collectors.toList());\n+        List<Entry> tools = entries.stream().filter(entry -> (entry instanceof Tool)).collect(Collectors.toList());\n         if (entries.isEmpty()) {", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MDk5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515240991", "bodyText": "This block and the previous block are identical except for the path, entity and error message. Good candidate for a reusable method.", "author": "coverbeck", "createdAt": "2020-10-30T16:57:37Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -158,19 +158,34 @@ public void bulkUpsert(List<Entry> entries) {\n         entries.forEach(this::eagerLoadEntry);\n         entries = filterCheckerWorkflows(entries);\n         // #2771 will need to disable this and properly create objects to get services into the index\n-        entries = entries.stream().filter(entry -> !(entry instanceof Service)).collect(Collectors.toList());\n+        // sort entries into workflows and tools\n+        List<Entry> workflows = entries.stream().filter(entry -> (entry instanceof BioWorkflow)).collect(Collectors.toList());\n+        List<Entry> tools = entries.stream().filter(entry -> (entry instanceof Tool)).collect(Collectors.toList());\n         if (entries.isEmpty()) {\n             return;\n         }\n+        // upsert tools to tools index\n         try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {\n-            String newlineDJSON = getNDJSON(entries);\n-            HttpEntity bulkEntity = new NStringEntity(newlineDJSON, ContentType.APPLICATION_JSON);\n-            Response post = restClient.performRequest(\"POST\", \"/entry/_bulk\", Collections.emptyMap(), bulkEntity);\n+            String toolsNewlineDJSON = getNDJSON(tools);\n+            HttpEntity toolsBulkEntity = new NStringEntity(toolsNewlineDJSON, ContentType.APPLICATION_JSON);\n+            Response post = restClient.performRequest(\"POST\", \"/tools/_doc/_bulk\", Collections.emptyMap(), toolsBulkEntity);\n             if (post.getStatusLine().getStatusCode() != HttpStatus.SC_OK) {\n-                throw new CustomWebApplicationException(\"Could not submit index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);\n+                throw new CustomWebApplicationException(\"Could not submit tools index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);\n             }\n         } catch (IOException e) {\n-            LOGGER.error(\"Could not submit index to elastic search. \" + e.getMessage());\n+            LOGGER.error(\"Could not submit tools index to elastic search. \" + e.getMessage());\n+        }\n+\n+        // upsert workflows to workflows index\n+        try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MTY3NA==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515241674", "bodyText": "Is this intentional? If we don't need it and there are no plans to uncomment it, I would just delete it.", "author": "coverbeck", "createdAt": "2020-10-30T16:58:45Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -212,7 +227,7 @@ private String getNDJSON(List<Entry> publishedEntries) {\n             Map<String, Map<String, String>> index = new HashMap<>();\n             Map<String, String> internal = new HashMap<>();\n             internal.put(\"_id\", String.valueOf(entry.getId()));\n-            internal.put(\"_type\", entry instanceof Tool ? \"tool\" : \"workflow\");\n+            //internal.put(\"_type\", entry instanceof Tool ? \"tool\" : \"workflow\");", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0NDQ1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r515244455", "bodyText": "It was like this, but can you please also log the exception. The stack trace is often useful when looking through the logs.\nLOGGER.error(\"Could not submit tools index to elastic search. \" + e.getMessage(), e);", "author": "coverbeck", "createdAt": "2020-10-30T17:02:53Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -158,19 +158,34 @@ public void bulkUpsert(List<Entry> entries) {\n         entries.forEach(this::eagerLoadEntry);\n         entries = filterCheckerWorkflows(entries);\n         // #2771 will need to disable this and properly create objects to get services into the index\n-        entries = entries.stream().filter(entry -> !(entry instanceof Service)).collect(Collectors.toList());\n+        // sort entries into workflows and tools\n+        List<Entry> workflows = entries.stream().filter(entry -> (entry instanceof BioWorkflow)).collect(Collectors.toList());\n+        List<Entry> tools = entries.stream().filter(entry -> (entry instanceof Tool)).collect(Collectors.toList());\n         if (entries.isEmpty()) {\n             return;\n         }\n+        // upsert tools to tools index\n         try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {\n-            String newlineDJSON = getNDJSON(entries);\n-            HttpEntity bulkEntity = new NStringEntity(newlineDJSON, ContentType.APPLICATION_JSON);\n-            Response post = restClient.performRequest(\"POST\", \"/entry/_bulk\", Collections.emptyMap(), bulkEntity);\n+            String toolsNewlineDJSON = getNDJSON(tools);\n+            HttpEntity toolsBulkEntity = new NStringEntity(toolsNewlineDJSON, ContentType.APPLICATION_JSON);\n+            Response post = restClient.performRequest(\"POST\", \"/tools/_doc/_bulk\", Collections.emptyMap(), toolsBulkEntity);\n             if (post.getStatusLine().getStatusCode() != HttpStatus.SC_OK) {\n-                throw new CustomWebApplicationException(\"Could not submit index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);\n+                throw new CustomWebApplicationException(\"Could not submit tools index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);\n             }\n         } catch (IOException e) {\n-            LOGGER.error(\"Could not submit index to elastic search. \" + e.getMessage());\n+            LOGGER.error(\"Could not submit tools index to elastic search. \" + e.getMessage());", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3NjA4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r516076089", "bodyText": "Same with above, should make deleting tools and deleting workflows a re-usable method in case we want to add new indices some day (perhaps notebooks or services)", "author": "denis-yuen", "createdAt": "2020-11-02T16:02:24Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/proposedGA4GH/ToolsApiExtendedServiceImpl.java", "diffHunk": "@@ -166,20 +166,31 @@ public Response toolsIndexGet(SecurityContext securityContext) {\n                     .builder(new HttpHost(config.getEsConfiguration().getHostname(), config.getEsConfiguration().getPort(), \"http\"))\n                     .build()) {\n \n-                // Delete index\n+                // Delete indices\n                 try {\n-                    restClient.performRequest(\"DELETE\", \"/entry\");", "originalCommit": "3714751cbe40b02e9abace6a6321d6540c16efb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bcbe781648f000029a4a527e3814d9ac82ded953", "url": "https://github.com/dockstore/dockstore/commit/bcbe781648f000029a4a527e3814d9ac82ded953", "message": "refactoring methods, changed author mapping type to keyword", "committedDate": "2020-11-02T17:17:04Z", "type": "commit"}, {"oid": "3adcf5e71226953d92a0985c64bccb98812e1c47", "url": "https://github.com/dockstore/dockstore/commit/3adcf5e71226953d92a0985c64bccb98812e1c47", "message": "Merge branch 'feature/1780/supportElasticsearch6' of https://github.com/dockstore/dockstore into feature/1780/supportElasticsearch6", "committedDate": "2020-11-02T17:18:06Z", "type": "commit"}, {"oid": "415957e58a35c6e2307d978d4d909201da5f06ee", "url": "https://github.com/dockstore/dockstore/commit/415957e58a35c6e2307d978d4d909201da5f06ee", "message": "Merge branch 'develop' into feature/1780/supportElasticsearch6", "committedDate": "2020-11-03T18:49:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMjU2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3899#discussion_r517022567", "bodyText": "You should use the index variable for the message, like you do on line 186.", "author": "coverbeck", "createdAt": "2020-11-03T23:53:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/statelisteners/ElasticListener.java", "diffHunk": "@@ -158,19 +159,31 @@ public void bulkUpsert(List<Entry> entries) {\n         entries.forEach(this::eagerLoadEntry);\n         entries = filterCheckerWorkflows(entries);\n         // #2771 will need to disable this and properly create objects to get services into the index\n-        entries = entries.stream().filter(entry -> !(entry instanceof Service)).collect(Collectors.toList());\n         if (entries.isEmpty()) {\n             return;\n         }\n+        // sort entries into workflows and tools\n+        List<Entry> workflowsEntryList = entries.stream().filter(entry -> (entry instanceof BioWorkflow)).collect(Collectors.toList());\n+        List<Entry> toolsEntryList = entries.stream().filter(entry -> (entry instanceof Tool)).collect(Collectors.toList());\n+        if (!workflowsEntryList.isEmpty()) {\n+            postBulkUpdate(\"workflows\", workflowsEntryList);\n+        }\n+        if (!toolsEntryList.isEmpty()) {\n+            postBulkUpdate(\"tools\", toolsEntryList);\n+        }\n+    }\n+\n+    private void postBulkUpdate(String index, List<Entry> entries) {\n         try (RestClient restClient = RestClient.builder(new HttpHost(hostname, port, \"http\")).build()) {\n             String newlineDJSON = getNDJSON(entries);\n+            String endpoint = \"/\" + index + \"/_doc/_bulk\";\n             HttpEntity bulkEntity = new NStringEntity(newlineDJSON, ContentType.APPLICATION_JSON);\n-            Response post = restClient.performRequest(\"POST\", \"/entry/_bulk\", Collections.emptyMap(), bulkEntity);\n+            Response post = restClient.performRequest(\"POST\", endpoint, Collections.emptyMap(), bulkEntity);\n             if (post.getStatusLine().getStatusCode() != HttpStatus.SC_OK) {\n-                throw new CustomWebApplicationException(\"Could not submit index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);\n+                throw new CustomWebApplicationException(\"Could not submit tools index to elastic search\", HttpStatus.SC_INTERNAL_SERVER_ERROR);", "originalCommit": "415957e58a35c6e2307d978d4d909201da5f06ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "572006b38c15cb0e1c528575dee44ea08f09aa25", "url": "https://github.com/dockstore/dockstore/commit/572006b38c15cb0e1c528575dee44ea08f09aa25", "message": "put variable index in error message", "committedDate": "2020-11-04T17:47:42Z", "type": "commit"}, {"oid": "9c12909e97f9fefc31aab99fa392ccc63ef5e461", "url": "https://github.com/dockstore/dockstore/commit/9c12909e97f9fefc31aab99fa392ccc63ef5e461", "message": "Merge branch 'feature/1780/supportElasticsearch6' of https://github.com/dockstore/dockstore into feature/1780/supportElasticsearch6", "committedDate": "2020-11-04T17:48:03Z", "type": "commit"}, {"oid": "543729eb50ccd501cda09c3b7a4981098a49dc2a", "url": "https://github.com/dockstore/dockstore/commit/543729eb50ccd501cda09c3b7a4981098a49dc2a", "message": "Merge branch 'develop' into feature/1780/supportElasticsearch6", "committedDate": "2020-11-04T17:48:39Z", "type": "commit"}, {"oid": "ecb7b823ec5c51756987accf8bf6da3e52a4a0a3", "url": "https://github.com/dockstore/dockstore/commit/ecb7b823ec5c51756987accf8bf6da3e52a4a0a3", "message": "Merge branch 'develop' into feature/1780/supportElasticsearch6", "committedDate": "2020-11-04T20:29:26Z", "type": "commit"}]}