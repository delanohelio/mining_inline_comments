{"pr_number": 3311, "pr_title": "checksums for file descriptors", "pr_createdAt": "2020-03-09T17:23:53Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3311", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzkwMw==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389847903", "bodyText": "Should be FileFormatHelper.class", "author": "coverbeck", "createdAt": "2020-03-09T17:32:21Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -1,24 +1,33 @@\n package io.dockstore.webservice.helpers;\n \n+import java.io.UnsupportedEncodingException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n import java.util.List;\n import java.util.Set;\n import java.util.SortedSet;\n import java.util.TreeSet;\n import java.util.stream.Collectors;\n \n+import javax.xml.bind.DatatypeConverter;\n+\n import io.dockstore.common.DescriptorLanguage;\n import io.dockstore.webservice.core.FileFormat;\n import io.dockstore.webservice.core.SourceFile;\n import io.dockstore.webservice.core.Version;\n import io.dockstore.webservice.jdbi.FileFormatDAO;\n+import io.dockstore.webservice.jdbi.UserDAO;\n import io.dockstore.webservice.languages.CWLHandler;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n /**\n  * This class helps resolve file formats in versions\n  * @author gluu\n  * @since 1.5.0\n  */\n public final class FileFormatHelper {\n+    private static final Logger LOG = LoggerFactory.getLogger(UserDAO.class);", "originalCommit": "1777bc4efe2c82b936ad1512bd7b4259b41f6fe4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MjE1MQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389852151", "bodyText": "Suggest you return an  Optional<String> since you can return a null. Your code where you use this function doesn't check for a null, which makes an argument for why you should be returning an Optional. :)\nOn the other hand, if you think this is such an unlikely/impossible occurrence, which is possible (if UTF-8 encoding is not present, nothing's going to work, probably the same for SHA-1 algorithm not being present, not sure about UnsupportedOperationException), then maybe you should return a String and throw an exception.", "author": "coverbeck", "createdAt": "2020-03-09T17:39:29Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -66,4 +75,18 @@ public static void updateFileFormats(Set<? extends Version> versions, final File\n         });\n         return fileFormatsFromDB;\n     }\n+\n+    public static String calcSHA1(String content) {", "originalCommit": "1777bc4efe2c82b936ad1512bd7b4259b41f6fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3ODAyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389978029", "bodyText": "returning optional", "author": "NatalieEO", "createdAt": "2020-03-09T21:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MjE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MzE3NQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389853175", "bodyText": "This isn't doing anything -- toLowerCase returns a new string which you aren't using. It doesn't modify the existing one.\nWhy are you doing this? Not saying you shouldn't, but can you add a comment explaining why?", "author": "coverbeck", "createdAt": "2020-03-09T17:41:04Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -66,4 +75,18 @@ public static void updateFileFormats(Set<? extends Version> versions, final File\n         });\n         return fileFormatsFromDB;\n     }\n+\n+    public static String calcSHA1(String content) {\n+        //return org.apache.commons.codec.digest.DigestUtils.sha1Hex(content);\n+        String sha1 = null;\n+        try {\n+            MessageDigest messageDigest = MessageDigest.getInstance(\"SHA-1\");\n+            messageDigest.update(content.getBytes(\"UTF-8\"), 0, content.length());\n+            sha1 = DatatypeConverter.printHexBinary(messageDigest.digest());\n+            sha1.toLowerCase();", "originalCommit": "1777bc4efe2c82b936ad1512bd7b4259b41f6fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk1MTcxNg==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389951716", "bodyText": "had accidentally put it in the wrong place initially. But I did have it return with toLowerCase just because the checksums we receive via quay, dockerhub for images are lowerecased and I thought it'd be better to match that.", "author": "NatalieEO", "createdAt": "2020-03-09T20:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MzE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MzgyNA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389853824", "bodyText": "Can content ever be null? I suspect not, but you might want to make sure in the database and/or add a guard.", "author": "coverbeck", "createdAt": "2020-03-09T17:42:01Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -66,4 +75,18 @@ public static void updateFileFormats(Set<? extends Version> versions, final File\n         });\n         return fileFormatsFromDB;\n     }\n+\n+    public static String calcSHA1(String content) {\n+        //return org.apache.commons.codec.digest.DigestUtils.sha1Hex(content);\n+        String sha1 = null;\n+        try {\n+            MessageDigest messageDigest = MessageDigest.getInstance(\"SHA-1\");\n+            messageDigest.update(content.getBytes(\"UTF-8\"), 0, content.length());", "originalCommit": "1777bc4efe2c82b936ad1512bd7b4259b41f6fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3ODMwNg==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389978306", "bodyText": "added if checking if content is null", "author": "NatalieEO", "createdAt": "2020-03-09T21:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MzgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2MDQwMA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389860400", "bodyText": "This is probably OK, but just checking... Collections.singleton returns an immutable list. If at some point in the future we wanted to add a second checksum in the same session, this could cause problems. But I'm probably overthinking it. I guess if we added a second checksum, we would do it right here.", "author": "coverbeck", "createdAt": "2020-03-09T17:52:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1308,6 +1311,14 @@ public Workflow manualRegister(@ApiParam(hidden = true) @Auth User user,\n                     String toolsJSONTable = lInterface.getContent(w.getWorkflowPath(), getMainDescriptorFile(existingTag).getContent(), extractDescriptorAndSecondaryFiles(existingTag), LanguageHandlerInterface.Type.TOOLS, toolDAO);\n                     Set<Image> images = lInterface.getImagesFromRegistry(toolsJSONTable);\n                     existingTag.getImages().addAll(images);\n+\n+                    // Grab checksum for file descriptors if not already available.\n+                    for (SourceFile sourceFile : existingTag.getSourceFiles()) {\n+                        if (sourceFile.getChecksums() == null || sourceFile.getChecksums().isEmpty()) {\n+                            String sha = FileFormatHelper.calcSHA1(sourceFile.getContent());\n+                            sourceFile.setChecksums(Collections.singletonList(new Checksum(SHA_TYPE_FOR_SOURCEFILES, sha)));", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3ODYxMA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389978610", "bodyText": "set checksums with arraylist of checksums instead of using singleton", "author": "NatalieEO", "createdAt": "2020-03-09T21:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2MDQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2MDUwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389860509", "bodyText": "testedWDL check is a bit strange, it will always be true here but isn't checked if, for example the workflow has no versions at all", "author": "denis-yuen", "createdAt": "2020-03-09T17:52:44Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -922,6 +922,34 @@ private void verifyChecksumsAreSaved(WorkflowVersion version) {\n         }\n     }\n \n+    @Test\n+    public void testChecksumsForSourceFiles() {\n+        // Test grabbing checksum on refresh\n+        final ApiClient webClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi workflowsApi = new WorkflowsApi(webClient);\n+        Workflow workflow = workflowsApi.manualRegister(\"github\", \"DockstoreTestUser2/hello-dockstore-workflow\", \"/Dockstore.wdl\", \"\", \"wdl\", \"/test.json\");\n+\n+        workflow = workflowsApi.refresh(workflow.getId());\n+        List<WorkflowVersion> workflowVersions = workflow.getWorkflowVersions();\n+        assertFalse(workflowVersions.isEmpty());\n+        boolean testedWDL = false;\n+\n+        for (WorkflowVersion workflowVersion : workflowVersions) {\n+            if (workflowVersion.getName().equals(\"testBoth\") || workflowVersion.getName().equals(\"testWDL\")) {\n+                testedWDL = true;\n+                assertTrue(testedWDL);", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2MDg5OA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389860898", "bodyText": "Might be true if sourceFile.getChecksums() is empty but not null?\nDitto above", "author": "denis-yuen", "createdAt": "2020-03-09T17:53:28Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -922,6 +922,34 @@ private void verifyChecksumsAreSaved(WorkflowVersion version) {\n         }\n     }\n \n+    @Test\n+    public void testChecksumsForSourceFiles() {\n+        // Test grabbing checksum on refresh\n+        final ApiClient webClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi workflowsApi = new WorkflowsApi(webClient);\n+        Workflow workflow = workflowsApi.manualRegister(\"github\", \"DockstoreTestUser2/hello-dockstore-workflow\", \"/Dockstore.wdl\", \"\", \"wdl\", \"/test.json\");\n+\n+        workflow = workflowsApi.refresh(workflow.getId());\n+        List<WorkflowVersion> workflowVersions = workflow.getWorkflowVersions();\n+        assertFalse(workflowVersions.isEmpty());\n+        boolean testedWDL = false;\n+\n+        for (WorkflowVersion workflowVersion : workflowVersions) {\n+            if (workflowVersion.getName().equals(\"testBoth\") || workflowVersion.getName().equals(\"testWDL\")) {\n+                testedWDL = true;\n+                assertTrue(testedWDL);\n+                assertNotNull(workflowVersion.getSourceFiles());\n+                workflowVersion.getSourceFiles().stream().forEach(sourceFile -> assertNotNull(\"Should have checksums\", sourceFile.getChecksums()));\n+            }\n+            workflowVersion.getSourceFiles();\n+        }\n+\n+        // Test grabbing checksum on snapshot\n+        WorkflowVersion version = snapshotWorkflowVersion(workflowsApi, \"dockstore-testing/hello_world\", \"/hello_world.cwl\", \"1.0.1\");\n+        assertNotNull(version.getSourceFiles());\n+        version.getSourceFiles().stream().forEach(sourceFile -> assertNotNull(\"Should have checksums\", sourceFile.getChecksums()));", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3OTA2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389979067", "bodyText": "Asserting the checksum string isn't empty now", "author": "NatalieEO", "createdAt": "2020-03-09T21:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2MDg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NDkzNA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389864934", "bodyText": "Might be able to use something like StandardCharsets.UTF8, not sure about SHA-1.", "author": "denis-yuen", "createdAt": "2020-03-09T17:59:58Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -66,4 +75,16 @@ public static void updateFileFormats(Set<? extends Version> versions, final File\n         });\n         return fileFormatsFromDB;\n     }\n+\n+    public static String calcSHA1(String content) {\n+        String sha1 = null;\n+        try {\n+            MessageDigest messageDigest = MessageDigest.getInstance(\"SHA-1\");\n+            messageDigest.update(content.getBytes(\"UTF-8\"), 0, content.length());", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTg2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389865869", "bodyText": "Should maybe match string used in calcSHA1 and be SHA-1", "author": "denis-yuen", "createdAt": "2020-03-09T18:01:34Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -88,6 +89,7 @@\n public class GitHubSourceCodeRepo extends SourceCodeRepoInterface {\n \n     private static final Logger LOG = LoggerFactory.getLogger(GitHubSourceCodeRepo.class);\n+    private static final String SHA_TYPE_FOR_SOURCEFILES = \"sha1\";", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzODAzOA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389938038", "bodyText": "I put it as sha1 because that's how they listed it in the link that's in this comment https://github.com/ga4gh/tool-registry-service-schemas/blob/develop/openapi/openapi.yaml#L601 but can still change it", "author": "NatalieEO", "createdAt": "2020-03-09T20:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTg2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxNTI4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r390015289", "bodyText": "Good observation.\nI'd still like it to match Java convention in our database and code, just have it convert when converting to TRS", "author": "denis-yuen", "createdAt": "2020-03-09T23:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NjE4Nw==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389876187", "bodyText": "Ditto, there should probably only be the one constant as well", "author": "denis-yuen", "createdAt": "2020-03-09T18:20:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -154,6 +156,7 @@\n     private static final String ALIASES = \"aliases\";\n     private static final String VALIDATIONS = \"validations\";\n     private static final String IMAGES = \"images\";\n+    private static final String SHA_TYPE_FOR_SOURCEFILES = \"sha1\";", "originalCommit": "398785e8d581eb20b4e15489676030a35c01b22c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NjM0Ng==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389986346", "bodyText": "This is fine, but FYI, you could write it to be something like this (didn't try to compile it, so syntax could be off), which is my own personal preference:\nFileFormatHelper.calcSHA1(file.getContent()).ifPresent(sha -> file.getChecksums().add(new Checksum(SHA_TYPE_FOR_SOURCEFILES, sha));", "author": "coverbeck", "createdAt": "2020-03-09T22:01:27Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitHubSourceCodeRepo.java", "diffHunk": "@@ -617,6 +622,10 @@ private WorkflowVersion setupServiceFilesForGitHubVersion(Triple<String, Date, S\n                 file.setPath(filePath);\n                 file.setContent(fileContent);\n                 file.setType(DescriptorLanguage.FileType.DOCKSTORE_SERVICE_OTHER);\n+                Optional<String> sha = FileFormatHelper.calcSHA1(file.getContent());", "originalCommit": "6e6a441b29aa47864b93e61a1a81ac50aec4e1f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4Nzk5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389987997", "bodyText": "What is this for?", "author": "coverbeck", "createdAt": "2020-03-09T22:05:37Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -922,6 +922,34 @@ private void verifyChecksumsAreSaved(WorkflowVersion version) {\n         }\n     }\n \n+    @Test\n+    public void testChecksumsForSourceFiles() {\n+        // Test grabbing checksum on refresh\n+        final ApiClient webClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi workflowsApi = new WorkflowsApi(webClient);\n+        Workflow workflow = workflowsApi.manualRegister(\"github\", \"DockstoreTestUser2/hello-dockstore-workflow\", \"/Dockstore.wdl\", \"\", \"wdl\", \"/test.json\");\n+\n+        workflow = workflowsApi.refresh(workflow.getId());\n+        List<WorkflowVersion> workflowVersions = workflow.getWorkflowVersions();\n+        assertFalse(workflowVersions.isEmpty());\n+        boolean testedWDL = false;\n+\n+        for (WorkflowVersion workflowVersion : workflowVersions) {\n+            if (workflowVersion.getName().equals(\"testBoth\") || workflowVersion.getName().equals(\"testWDL\")) {\n+                testedWDL = true;\n+                assertNotNull(workflowVersion.getSourceFiles());\n+                workflowVersion.getSourceFiles().stream().forEach(sourceFile -> assertFalse(\"Source file should have a checksum\", sourceFile.getChecksums().get(0).toString().isEmpty()));\n+            }\n+            workflowVersion.getSourceFiles();", "originalCommit": "6e6a441b29aa47864b93e61a1a81ac50aec4e1f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4ODcxMg==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389988712", "bodyText": "It's probably overkill, but it would nice to verify the checksums didn't exist before doing the snapshot.", "author": "coverbeck", "createdAt": "2020-03-09T22:07:37Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -922,6 +922,34 @@ private void verifyChecksumsAreSaved(WorkflowVersion version) {\n         }\n     }\n \n+    @Test\n+    public void testChecksumsForSourceFiles() {\n+        // Test grabbing checksum on refresh\n+        final ApiClient webClient = getWebClient(USER_2_USERNAME, testingPostgres);\n+        WorkflowsApi workflowsApi = new WorkflowsApi(webClient);\n+        Workflow workflow = workflowsApi.manualRegister(\"github\", \"DockstoreTestUser2/hello-dockstore-workflow\", \"/Dockstore.wdl\", \"\", \"wdl\", \"/test.json\");\n+\n+        workflow = workflowsApi.refresh(workflow.getId());\n+        List<WorkflowVersion> workflowVersions = workflow.getWorkflowVersions();\n+        assertFalse(workflowVersions.isEmpty());\n+        boolean testedWDL = false;\n+\n+        for (WorkflowVersion workflowVersion : workflowVersions) {\n+            if (workflowVersion.getName().equals(\"testBoth\") || workflowVersion.getName().equals(\"testWDL\")) {\n+                testedWDL = true;\n+                assertNotNull(workflowVersion.getSourceFiles());\n+                workflowVersion.getSourceFiles().stream().forEach(sourceFile -> assertFalse(\"Source file should have a checksum\", sourceFile.getChecksums().get(0).toString().isEmpty()));\n+            }\n+            workflowVersion.getSourceFiles();\n+        }\n+        assertTrue(testedWDL);\n+\n+        // Test grabbing checksum on snapshot", "originalCommit": "6e6a441b29aa47864b93e61a1a81ac50aec4e1f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5Mjk3Ng==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r389992976", "bodyText": "Missed this the first time; content.length is wrong; you need the length of the byte array, something like:\nfinal byte [] bytes = content.getBytes(StandardCharsets.UTF_8);\nmessageDigest.update(bytes, 0, bytes.length);\n\nExplanation: content.length() returns the number of characters; a character can be made of more than one byte, so the bytes array length might be longer the number of characters. Typically not an issue for \"standard\" English characters, but throw in some accented characters or non-Latin characters, and it will become one.", "author": "coverbeck", "createdAt": "2020-03-09T22:19:06Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/FileFormatHelper.java", "diffHunk": "@@ -66,4 +75,20 @@ public static void updateFileFormats(Set<? extends Version> versions, final File\n         });\n         return fileFormatsFromDB;\n     }\n+\n+    public static Optional<String> calcSHA1(String content) {\n+        if (content != null) {\n+            try {\n+                MessageDigest messageDigest = MessageDigest.getInstance(\"SHA-1\");\n+                messageDigest.update(content.getBytes(StandardCharsets.UTF_8), 0, content.length());", "originalCommit": "6e6a441b29aa47864b93e61a1a81ac50aec4e1f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5be06b8343757cd43efd6660255dc7a027fcadfb", "url": "https://github.com/dockstore/dockstore/commit/5be06b8343757cd43efd6660255dc7a027fcadfb", "message": "checksums for files", "committedDate": "2020-03-17T15:43:25Z", "type": "commit"}, {"oid": "756b134b2e99fbf119f9963b33e3eeb6542e0140", "url": "https://github.com/dockstore/dockstore/commit/756b134b2e99fbf119f9963b33e3eeb6542e0140", "message": "remove comment and fix failing build", "committedDate": "2020-03-17T15:43:25Z", "type": "commit"}, {"oid": "5ac87417d444e1b005910230754a169e6b4a3e44", "url": "https://github.com/dockstore/dockstore/commit/5ac87417d444e1b005910230754a169e6b4a3e44", "message": "PR feedback", "committedDate": "2020-03-17T15:44:08Z", "type": "commit"}, {"oid": "d82f0c32f12509fe7b19d436d72da884f2a01464", "url": "https://github.com/dockstore/dockstore/commit/d82f0c32f12509fe7b19d436d72da884f2a01464", "message": "checksums for sourcefiles", "committedDate": "2020-03-17T15:44:08Z", "type": "commit"}, {"oid": "df25a03bceaef80c63a76276f872876031883ebf", "url": "https://github.com/dockstore/dockstore/commit/df25a03bceaef80c63a76276f872876031883ebf", "message": "rebase and change import", "committedDate": "2020-03-17T15:59:29Z", "type": "commit"}, {"oid": "df25a03bceaef80c63a76276f872876031883ebf", "url": "https://github.com/dockstore/dockstore/commit/df25a03bceaef80c63a76276f872876031883ebf", "message": "rebase and change import", "committedDate": "2020-03-17T15:59:29Z", "type": "forcePushed"}, {"oid": "343577e38a1ff42af717176ab64b7aaeac4d748c", "url": "https://github.com/dockstore/dockstore/commit/343577e38a1ff42af717176ab64b7aaeac4d748c", "message": "forgot to delete", "committedDate": "2020-03-17T16:22:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMDIzNQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r393920235", "bodyText": "Was a missing equals  the reason for the odd behaviour?", "author": "denis-yuen", "createdAt": "2020-03-17T19:31:39Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Checksum.java", "diffHunk": "@@ -55,4 +57,21 @@ public void setChecksum(String checksum) {\n     public String toString() {\n         return this.getType() + \":\" + this.getChecksum();\n     }\n+\n+    @Override\n+    public boolean equals(final Object o) {", "originalCommit": "343577e38a1ff42af717176ab64b7aaeac4d748c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMzUxOQ==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r393923519", "bodyText": "It was! \ud83d\ude2d", "author": "NatalieEO", "createdAt": "2020-03-17T19:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkyMDIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkzNDI0Ng==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r393934246", "bodyText": "I think you should make this position 6 and add an explicit position to the previous one, which is presumably an implicit 5. I don't know the implications but seems safest.", "author": "coverbeck", "createdAt": "2020-03-17T19:58:20Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/SourceFile.java", "diffHunk": "@@ -91,6 +94,11 @@\n     @ApiModelProperty(\"When true, this version cannot be affected by refreshes to the content or updates to its metadata\")\n     private boolean frozen = false;\n \n+    @Column(columnDefinition = \"varchar\")\n+    @Convert(converter = ChecksumConverter.class)\n+    @ApiModelProperty(position = 5)", "originalCommit": "343577e38a1ff42af717176ab64b7aaeac4d748c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkzODc5MA==", "url": "https://github.com/dockstore/dockstore/pull/3311#discussion_r393938790", "bodyText": "You don't have to change this, but you have existingFileMap.get(fileKey) four times and it's also done on line 207... I would create a variable on line 193.", "author": "coverbeck", "createdAt": "2020-03-17T20:07:01Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -187,11 +190,29 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n             workflowVersionFromDB.getSourceFiles().forEach(file -> existingFileMap.put(file.getType().toString() + file.getAbsolutePath(), file));\n \n             for (SourceFile file : version.getSourceFiles()) {\n-                if (existingFileMap.containsKey(file.getType().toString() + file.getAbsolutePath())) {\n+                String fileKey = file.getType().toString() + file.getAbsolutePath();\n+                if (existingFileMap.containsKey(fileKey)) {\n+                    List<Checksum> checksums = new ArrayList<>();\n+                    Optional<String> sha = FileFormatHelper.calcSHA1(file.getContent());\n+                    if (sha.isPresent()) {\n+                        checksums.add(new Checksum(SHA_TYPE_FOR_SOURCEFILES, sha.get()));\n+                        if (existingFileMap.get(fileKey).getChecksums() == null) {", "originalCommit": "343577e38a1ff42af717176ab64b7aaeac4d748c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cbb81fabe7176b99351694d6d7c705f9459f5465", "url": "https://github.com/dockstore/dockstore/commit/cbb81fabe7176b99351694d6d7c705f9459f5465", "message": "pr feedback", "committedDate": "2020-03-17T21:34:06Z", "type": "commit"}]}