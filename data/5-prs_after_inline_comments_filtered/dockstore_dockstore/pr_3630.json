{"pr_number": 3630, "pr_title": "delete user's services in UserResource.deleteSelfFromEntries() (#3291)", "pr_createdAt": "2020-06-30T18:12:15Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3630", "timeline": [{"oid": "08f231026662fc77376771ddbfe6976cad99de26", "url": "https://github.com/dockstore/dockstore/commit/08f231026662fc77376771ddbfe6976cad99de26", "message": "delete user's services in UserResource.deleteSelfFromEntries() (#3291)", "committedDate": "2020-06-30T17:54:21Z", "type": "commit"}, {"oid": "4dd8339b7be9e5da233a3e22330f584170184ef1", "url": "https://github.com/dockstore/dockstore/commit/4dd8339b7be9e5da233a3e22330f584170184ef1", "message": "test if user's services are deleted on selfDestruct(); revert previous", "committedDate": "2020-07-07T21:03:41Z", "type": "commit"}, {"oid": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "url": "https://github.com/dockstore/dockstore/commit/08990df20330b1a3ae8338d1aa680aa7ca05e34c", "message": "Merge branch 'develop' into feature/3291/delete-user-orphan-services", "committedDate": "2020-07-07T21:03:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5MjU4NA==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451592584", "bodyText": "Probably a bit more readable as SourceControl.GITHUB + '/' + serviceRepo", "author": "denis-yuen", "createdAt": "2020-07-08T14:33:11Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -249,6 +255,7 @@ public void testSelfDestruct() throws ApiException {\n         // Verify that admin can access unpublished workflow, because admin is going to verify later\n         // that the workflow is gone\n         adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n+        adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);", "originalCommit": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5Mjg5OQ==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451592899", "bodyText": "Ditto, can use constant", "author": "denis-yuen", "createdAt": "2020-07-08T14:33:36Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -278,6 +285,15 @@ public void testSelfDestruct() throws ApiException {\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);", "originalCommit": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU5Mzg2NA==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451593864", "bodyText": "Should assert that the exception is due to it being missing (would have expected a relevant error message or a wrapped 404 or something)\nOtherwise, this could \"pass\" if the api is just broken in some other way.", "author": "denis-yuen", "createdAt": "2020-07-08T14:34:55Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -278,6 +285,15 @@ public void testSelfDestruct() throws ApiException {\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(github + \"/\" + serviceRepo, null, true);\n+        } catch (ApiException e) {\n+            expectedAdminServiceAccessToFail = true;", "originalCommit": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMjAyNw==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451602027", "bodyText": "what's the difference between this filter and the DAO findByUser?", "author": "garyluu", "createdAt": "2020-07-08T14:45:56Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -313,6 +314,13 @@ private void deleteSelfFromEntries(User user) {\n                 });\n     }\n \n+    // We don't delete the LambdaEvent because it is useful for other users\n+    private void deleteSelfFromLambdaEvents(User user) {\n+        lambdaEventDAO.findByUser(user).stream()\n+                .filter(lambdaEvent -> lambdaEvent.getUser() == user)", "originalCommit": "08990df20330b1a3ae8338d1aa680aa7ca05e34c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMzg1Nw==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451603857", "bodyText": "D'oh, there isn't any. Will fix.", "author": "GFJHogue", "createdAt": "2020-07-08T14:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMjAyNw=="}], "type": "inlineReview"}, {"oid": "312c765fb8be6208d13fc5c47e3175e7ca2badfc", "url": "https://github.com/dockstore/dockstore/commit/312c765fb8be6208d13fc5c47e3175e7ca2badfc", "message": "review revisions - user self destruct & test", "committedDate": "2020-07-08T18:24:58Z", "type": "commit"}, {"oid": "bb817e48e91a67e2f731672d8866aea960cea86d", "url": "https://github.com/dockstore/dockstore/commit/bb817e48e91a67e2f731672d8866aea960cea86d", "message": "Merge remote-tracking branch 'origin/develop' into feature/3291/delete-user-orphan-services", "committedDate": "2020-07-08T18:25:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxODUwNA==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451818504", "bodyText": "Can use a constant to be more readable, something like the version 4 equivalent\nhttps://hc.apache.org/httpclient-3.x/apidocs/org/apache/commons/httpclient/HttpStatus.html#SC_BAD_REQUEST", "author": "denis-yuen", "createdAt": "2020-07-08T20:52:29Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -274,10 +280,21 @@ public void testSelfDestruct() throws ApiException {\n             adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n \n         } catch (ApiException e) {\n+            assertTrue(e.getCode() == 400);\n             expectedAdminAccessToFail = true;\n         }\n         assertTrue(expectedAdminAccessToFail);\n \n+        // Verify that self-destruct also deleted the service\n+        boolean expectedAdminServiceAccessToFail = false;\n+        try {\n+            adminWorkflowsApi.getWorkflowByPath(SourceControl.GITHUB + \"/\" + serviceRepo, null, true);\n+        } catch (ApiException e) {\n+            assertTrue(e.getCode() == 400);", "originalCommit": "bb817e48e91a67e2f731672d8866aea960cea86d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55", "url": "https://github.com/dockstore/dockstore/commit/6093b55ca776f1f50adaf7b6a75d58e53dc02b55", "message": "use HttpStatus constant", "committedDate": "2020-07-08T21:05:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDY5Mg==", "url": "https://github.com/dockstore/dockstore/pull/3630#discussion_r451840692", "bodyText": "assertEquals(expected, actual) or assertEquals(message, expected, actual) here and below", "author": "garyluu", "createdAt": "2020-07-08T21:39:55Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/webservice/UserResourceIT.java", "diffHunk": "@@ -274,10 +280,21 @@ public void testSelfDestruct() throws ApiException {\n             adminWorkflowsApi.getWorkflowByPath(WorkflowIT.DOCKSTORE_TEST_USER2_HELLO_DOCKSTORE_WORKFLOW, null, false);\n \n         } catch (ApiException e) {\n+            assertTrue(e.getCode() == HttpStatus.SC_BAD_REQUEST);", "originalCommit": "6093b55ca776f1f50adaf7b6a75d58e53dc02b55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b2520923834967aaba4073c56cc1532674c9e5e", "url": "https://github.com/dockstore/dockstore/commit/3b2520923834967aaba4073c56cc1532674c9e5e", "message": "Merge branch 'develop' into feature/3291/delete-user-orphan-services", "committedDate": "2020-07-09T14:00:17Z", "type": "commit"}, {"oid": "b364d84abcb6c9a1496d54169e1c2ee030397f72", "url": "https://github.com/dockstore/dockstore/commit/b364d84abcb6c9a1496d54169e1c2ee030397f72", "message": "use assertEquals()", "committedDate": "2020-07-09T14:03:26Z", "type": "commit"}]}