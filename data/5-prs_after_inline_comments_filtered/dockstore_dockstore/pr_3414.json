{"pr_number": 3414, "pr_title": "A little more sane path resolution for TRS", "pr_createdAt": "2020-04-17T21:52:21Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3414", "timeline": [{"oid": "022877b9013317dd781ada6d11400d94b3c42ed2", "url": "https://github.com/dockstore/dockstore/commit/022877b9013317dd781ada6d11400d94b3c42ed2", "message": "A little more sane path resolution, run through tests", "committedDate": "2020-04-17T21:27:38Z", "type": "commit"}, {"oid": "28d9761c9a32e48ac802f57d5a6177f16c4d6671", "url": "https://github.com/dockstore/dockstore/commit/28d9761c9a32e48ac802f57d5a6177f16c4d6671", "message": "Fix for tests", "committedDate": "2020-04-20T16:18:33Z", "type": "commit"}, {"oid": "dd719af88f4bce1284601fdd343554a0c3859c08", "url": "https://github.com/dockstore/dockstore/commit/dd719af88f4bce1284601fdd343554a0c3859c08", "message": "More fix, adding specific test", "committedDate": "2020-04-20T18:45:23Z", "type": "commit"}, {"oid": "4bc22a2978d5c0b333b8530c3a3b5154233c1ba0", "url": "https://github.com/dockstore/dockstore/commit/4bc22a2978d5c0b333b8530c3a3b5154233c1ba0", "message": "Terrible", "committedDate": "2020-04-20T22:00:46Z", "type": "commit"}, {"oid": "ed59ce5d19d60e07369eb2866cfb6d5a1d378c0a", "url": "https://github.com/dockstore/dockstore/commit/ed59ce5d19d60e07369eb2866cfb6d5a1d378c0a", "message": "Merge branch 'develop' into feature/better_trs_relative_paths", "committedDate": "2020-04-20T23:43:32Z", "type": "commit"}, {"oid": "da8c9b1108e1a3f47782d11acff301201e4d38cf", "url": "https://github.com/dockstore/dockstore/commit/da8c9b1108e1a3f47782d11acff301201e4d38cf", "message": "\"Proper fix\"", "committedDate": "2020-04-21T15:25:55Z", "type": "commit"}, {"oid": "63b4679f0415c43c6c8bb01f71fa3750d9c2e197", "url": "https://github.com/dockstore/dockstore/commit/63b4679f0415c43c6c8bb01f71fa3750d9c2e197", "message": "Merge branch 'feature/better_trs_relative_paths' of github.com:dockstore/dockstore into feature/better_trs_relative_paths", "committedDate": "2020-04-21T15:26:06Z", "type": "commit"}, {"oid": "6a85ebaf5f4eeb60565d6430a5f36f5f31fe7849", "url": "https://github.com/dockstore/dockstore/commit/6a85ebaf5f4eeb60565d6430a5f36f5f31fe7849", "message": "Merge branch 'develop' into feature/better_trs_relative_paths", "committedDate": "2020-04-21T22:06:10Z", "type": "commit"}, {"oid": "a9051a7dd0af038c86f12bdc8ab48e052fb85306", "url": "https://github.com/dockstore/dockstore/commit/a9051a7dd0af038c86f12bdc8ab48e052fb85306", "message": "Additional side-effect", "committedDate": "2020-04-22T16:37:08Z", "type": "commit"}, {"oid": "c9b9446806fdc255bed93fd604b17cd0f91a2d93", "url": "https://github.com/dockstore/dockstore/commit/c9b9446806fdc255bed93fd604b17cd0f91a2d93", "message": "Merge branch 'feature/better_trs_relative_paths' of github.com:dockstore/dockstore into feature/better_trs_relative_paths", "committedDate": "2020-04-22T16:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3NTIxNg==", "url": "https://github.com/dockstore/dockstore/pull/3414#discussion_r414175216", "bodyText": "Why toLowerCase here and the rest of the method? This may never occur in practice, but Git is case-sensitive, and in theory somebody could have some the same filename with different casing and this might yield unexpected results.", "author": "coverbeck", "createdAt": "2020-04-23T22:50:16Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -605,28 +606,28 @@ public String getReasonPhrase() {\n      * Return a matching source file\n      *\n      * @param sourceFiles      files to look through\n-     * @param searchPathParam       file to look for\n+     * @param searchPathParam       file to look for, could be relative or absolute\n      * @param workingDirectory working directory if relevant\n      * @return\n      */\n     public Optional<SourceFile> lookForFilePath(Set<SourceFile> sourceFiles, String searchPathParam, String workingDirectory) {\n-        // ignore leading slashes\n-        String searchPath = cleanRelativePath(searchPathParam);\n-\n-        for (SourceFile sourceFile : sourceFiles) {\n-            String calculatedPath = sourceFile.getAbsolutePath();\n-            // annoyingly, test json and Dockerfiles include a fullpath whereas descriptors are just relative to the main descriptor,\n-            // so we need to standardize relative to the main descriptor\n-            if (SourceFile.TEST_FILE_TYPES.contains(sourceFile.getType())) {\n-                calculatedPath = StringUtils.removeStart(cleanRelativePath(sourceFile.getPath()), cleanRelativePath(workingDirectory));\n-            }\n-            calculatedPath = cleanRelativePath(calculatedPath);\n-            if (searchPath.equalsIgnoreCase(calculatedPath) || searchPath\n-                .equalsIgnoreCase(StringUtils.removeStart(calculatedPath, workingDirectory + \"/\"))) {\n-                return Optional.of(sourceFile);\n-            }\n+        String targetPath;\n+        if (searchPathParam.startsWith(\"/\")) {\n+            // treat searchPath as an absolute path\n+            targetPath = cleanRelativePath(searchPathParam).toLowerCase();", "originalCommit": "c9b9446806fdc255bed93fd604b17cd0f91a2d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY3Mzg2NQ==", "url": "https://github.com/dockstore/dockstore/pull/3414#discussion_r414673865", "bodyText": "I had some tests fail when I turned that on. I'll take a closer look, but I was wary of adding an additional backwards incompatible change in case cromwell, cwl are not case sensitive.\nOr if they run on Windows for that matter", "author": "denis-yuen", "createdAt": "2020-04-24T15:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3NTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY5NTQ0Ng==", "url": "https://github.com/dockstore/dockstore/pull/3414#discussion_r414695446", "bodyText": "Yeah, probably not worth pursuing; it's a real edge case, and there are various factors at play; not just the OS, but how you configure git locally. Just mentioned it because I've been bitten by this a few times, but only over a very long period of time.", "author": "coverbeck", "createdAt": "2020-04-24T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3NTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMTAwNw==", "url": "https://github.com/dockstore/dockstore/pull/3414#discussion_r414821007", "bodyText": "Took a brief look at this, I think the tests that are breaking are because the casing of the descriptor path specified in the default workflow parameters did not match the casing here.\nIn other words, if we make things case-sensitive here then we need to treat things as case sensitive in the UI when entering paths and in .dockstore.yml. I'm thinking that this can be broken out into a separate ticket if we do make this change in behaviour", "author": "denis-yuen", "createdAt": "2020-04-24T19:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3NTIxNg=="}], "type": "inlineReview"}, {"oid": "d64c057f9c819ab9a73f7fe34f9a38f4d02c4d2c", "url": "https://github.com/dockstore/dockstore/commit/d64c057f9c819ab9a73f7fe34f9a38f4d02c4d2c", "message": "Merge branch 'develop' into feature/better_trs_relative_paths", "committedDate": "2020-04-24T19:39:01Z", "type": "commit"}]}