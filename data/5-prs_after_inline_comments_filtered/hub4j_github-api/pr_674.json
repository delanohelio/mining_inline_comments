{"pr_number": 674, "pr_title": "Retry when SocketException with some sleep", "pr_createdAt": "2020-01-23T16:57:18Z", "pr_url": "https://github.com/hub4j/github-api/pull/674", "timeline": [{"oid": "fca179abab6eb4f9c8305d3f2f0ad635a04542ba", "url": "https://github.com/hub4j/github-api/commit/fca179abab6eb4f9c8305d3f2f0ad635a04542ba", "message": "Retry if SocketException\n\nSee https://github.com/github-api/github-api/pull/373", "committedDate": "2020-01-23T13:33:12Z", "type": "commit"}, {"oid": "4f38ab36403166f2f4909c1d7d8970fd8519a412", "url": "https://github.com/hub4j/github-api/commit/4f38ab36403166f2f4909c1d7d8970fd8519a412", "message": "Cosmetic change", "committedDate": "2020-01-23T14:01:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI0OTc1NQ==", "url": "https://github.com/hub4j/github-api/pull/674#discussion_r370249755", "bodyText": "Make a configurable static for this and probably make it 500 millis to start?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Thread.sleep(5000);\n          \n          \n            \n                                Thread.sleep(Requester.retryTimeoutMillis);", "author": "bitwiseman", "createdAt": "2020-01-23T17:17:57Z", "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -902,8 +904,17 @@ private void setRequestMethod(HttpURLConnection connection) throws IOException {\n             // don't wrap exception in HttpException to preserve backward compatibility\n             throw e;\n         } catch (IOException e) {\n-            if (e instanceof SocketTimeoutException && timeouts > 0) {\n-                LOGGER.log(INFO, \"timed out accessing \" + uc.getURL() + \"; will try \" + timeouts + \" more time(s)\", e);\n+            if (((e instanceof SocketException && e.getCause() instanceof SocketTimeoutException)\n+                    || e instanceof SocketTimeoutException) && timeouts > 0) {\n+                LOGGER.log(INFO,\n+                        \"timed out accessing  \" + uc.getURL() + \". Sleeping 5 seconds before retrying... ; will try\"\n+                                + timeouts + \" more time(s)\",\n+                        e);\n+                try {\n+                    Thread.sleep(5000);", "originalCommit": "4f38ab36403166f2f4909c1d7d8970fd8519a412", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI1MjgzMQ==", "url": "https://github.com/hub4j/github-api/pull/674#discussion_r370252831", "bodyText": "This is also needed or the error just keeps happening.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            return parse(type, instance, timeouts - 1);\n          \n          \n            \n                            uc = setupConnection(uc.getURL());\n          \n          \n            \n                            return parse(type, instance, timeouts - 1);", "author": "bitwiseman", "createdAt": "2020-01-23T17:24:10Z", "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -902,8 +904,17 @@ private void setRequestMethod(HttpURLConnection connection) throws IOException {\n             // don't wrap exception in HttpException to preserve backward compatibility\n             throw e;\n         } catch (IOException e) {\n-            if (e instanceof SocketTimeoutException && timeouts > 0) {\n-                LOGGER.log(INFO, \"timed out accessing \" + uc.getURL() + \"; will try \" + timeouts + \" more time(s)\", e);\n+            if (((e instanceof SocketException && e.getCause() instanceof SocketTimeoutException)\n+                    || e instanceof SocketTimeoutException) && timeouts > 0) {\n+                LOGGER.log(INFO,\n+                        \"timed out accessing  \" + uc.getURL() + \". Sleeping 5 seconds before retrying... ; will try\"\n+                                + timeouts + \" more time(s)\",\n+                        e);\n+                try {\n+                    Thread.sleep(5000);\n+                } catch (InterruptedException _) {\n+                    throw (IOException) new InterruptedIOException().initCause(e);\n+                }\n                 return parse(type, instance, timeouts - 1);", "originalCommit": "4f38ab36403166f2f4909c1d7d8970fd8519a412", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cbe1022f20d3e9d1b02c3540f5f3cb0feca316c2", "url": "https://github.com/hub4j/github-api/commit/cbe1022f20d3e9d1b02c3540f5f3cb0feca316c2", "message": "Support more generic Socket Exceptions\n\nFor instance: connection reset by peer", "committedDate": "2020-01-23T20:28:57Z", "type": "commit"}, {"oid": "a5f04d44a4215e7e8811b6d08a3184794ac6f233", "url": "https://github.com/hub4j/github-api/commit/a5f04d44a4215e7e8811b6d08a3184794ac6f233", "message": "Fix javadoc warning", "committedDate": "2020-01-23T20:29:55Z", "type": "commit"}, {"oid": "20f04febf29c427d16f9202090352eae6ebcca2a", "url": "https://github.com/hub4j/github-api/commit/20f04febf29c427d16f9202090352eae6ebcca2a", "message": "As suggested in the code review, make a configurable sleep", "committedDate": "2020-01-23T20:36:00Z", "type": "commit"}, {"oid": "418ea9a19e936680ee371ac27586b2f05a833e73", "url": "https://github.com/hub4j/github-api/commit/418ea9a19e936680ee371ac27586b2f05a833e73", "message": "As suggested in the code review, handle exceptions and setup the connection", "committedDate": "2020-01-23T20:39:58Z", "type": "commit"}, {"oid": "d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "url": "https://github.com/hub4j/github-api/commit/d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "message": "UTs for the Timeout and Retry", "committedDate": "2020-01-23T21:09:14Z", "type": "commit"}, {"oid": "d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "url": "https://github.com/hub4j/github-api/commit/d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "message": "UTs for the Timeout and Retry", "committedDate": "2020-01-23T21:09:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0MjI4OQ==", "url": "https://github.com/hub4j/github-api/pull/674#discussion_r370442289", "bodyText": "I'd rather you do this in the test class. Override before and add this code there.", "author": "bitwiseman", "createdAt": "2020-01-24T01:44:33Z", "path": "src/test/java/org/kohsuke/github/junit/GitHubWireMockRule.java", "diffHunk": "@@ -87,6 +87,9 @@ protected void initializeServers() {\n     @Override\n     protected void before() {\n         super.before();\n+        this.apiServer()", "originalCommit": "d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ0MjkxNg==", "url": "https://github.com/hub4j/github-api/pull/674#discussion_r370442916", "bodyText": "Cool thanks.  Take a look at #678. When you get a chance. You don't have to change this, just meant as an FYI.", "author": "bitwiseman", "createdAt": "2020-01-24T01:47:25Z", "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -923,7 +939,11 @@ private void retryInvalidCached404Response() throws IOException {\n         // scenarios. If GitHub ever fixes their issue and/or begins providing accurate ETags to\n         // their 404 responses, this will result in at worst two requests being made for each 404\n         // responses. However, only the second request will count against rate limit.\n-        int responseCode = uc.getResponseCode();\n+        int responseCode = 0;", "originalCommit": "d9ebc9455ca2769f4c07fa697fcd0ee2bb8c7c45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "764599a7d9015a1b441f35c45195dbbe868e7d01", "url": "https://github.com/hub4j/github-api/commit/764599a7d9015a1b441f35c45195dbbe868e7d01", "message": "Move socket handling and add test", "committedDate": "2020-01-24T04:54:13Z", "type": "commit"}, {"oid": "74dd887c7922128cac78d82eb301f4eb5972c179", "url": "https://github.com/hub4j/github-api/commit/74dd887c7922128cac78d82eb301f4eb5972c179", "message": "Merge branch 'master' into master", "committedDate": "2020-01-24T06:22:42Z", "type": "commit"}, {"oid": "eb4000f26b60824be176d5fd6df687f6b817b388", "url": "https://github.com/hub4j/github-api/commit/eb4000f26b60824be176d5fd6df687f6b817b388", "message": "Streamline retry code path", "committedDate": "2020-01-24T20:32:04Z", "type": "commit"}]}