{"pr_number": 2011, "pr_title": "[feature] improved dragging behaviour", "pr_createdAt": "2020-01-16T11:45:44Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2011", "timeline": [{"oid": "04945c93d31b52eccb871a6143e51fe3076424e2", "url": "https://github.com/mercadopago/px-android/commit/04945c93d31b52eccb871a6143e51fe3076424e2", "message": "* Improved dragging behaviour.\n* Added animations.\n* Added security integration.", "committedDate": "2020-01-16T11:44:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNzQzMg==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367437432", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:11:14Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentFragment.java", "diffHunk": "@@ -19,6 +19,7 @@\n import android.support.v7.widget.LinearLayoutManager;\n import android.support.v7.widget.RecyclerView;\n import android.support.v7.widget.Toolbar;\n+import android.util.Log;", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNzkyMA==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367437920", "bodyText": "Agregar comment.", "author": "matiasromar", "createdAt": "2020-01-16T14:12:08Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentFragment.java", "diffHunk": "@@ -250,6 +258,65 @@ public void onDisabledDescriptorViewClick() {\n             new PaymentMethodHeaderAdapter(paymentMethodHeaderView),\n             new ConfirmButtonAdapter(confirmButton)\n         ));\n+\n+        configureBottomSheet();\n+    }\n+\n+    private void configureBottomSheet() {\n+        bottomSheet = getActivity().findViewById(R.id.off_methods_fragment);\n+        bottomSheetBehavior = BottomSheetBehavior.from(bottomSheet);\n+        bottomSheetBehavior.setHideable(true);\n+        bottomSheetBehavior.setBottomSheetCallback(new BottomSheetBehavior.BottomSheetCallback() {\n+            @Override\n+            public void onStateChanged(@NonNull final View view, final int state) {\n+                final OfflineMethodsFragment fragment = FragmentUtil\n+                    .getFragmentByTag(getFragmentManager(), TAG_OFFLINE_METHODS_FRAGMENT,\n+                        OfflineMethodsFragment.class);\n+                switch (state) {\n+                case BottomSheetBehavior.STATE_HIDDEN:\n+                    getFragmentManager().popBackStackImmediate();\n+                    break;\n+                case BottomSheetBehavior.STATE_DRAGGING:\n+                    fragment.onDragSheet();\n+                    break;\n+                case BottomSheetBehavior.STATE_EXPANDED:\n+                    fragment.onExpandedSheet();\n+                    break;\n+                default:\n+                }\n+\n+                if(fragment != null) {\n+                    fragment.onSheetStateChanged(state);\n+                }\n+            }\n+\n+            @Override\n+            public void onSlide(@NonNull final View view, final float v) {", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODE0OA==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367438148", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:12:31Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentFragment.java", "diffHunk": "@@ -283,6 +350,7 @@ public void onSaveInstanceState(@NonNull final Bundle outState) {\n     @Override\n     public void onResume() {\n         super.onResume();\n+        Log.v(\"CRIS\", \"ASDASD\");", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODU3Nw==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367438577", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:13:20Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentFragment.java", "diffHunk": "@@ -679,23 +747,34 @@ public int getRequestCode() {\n         return REQ_CODE_DISABLE_DIALOG;\n     }\n \n-    public void onBottomButtonClicked() {\n-        presenter.onOfflineMethodsClicked();\n+    @Override\n+    public void onOtherPaymentMethodClicked(@NonNull final OfflinePaymentTypesMetadata offlineMethods) {\n+        presenter.onOtherPaymentMethodClicked(offlineMethods);\n     }\n \n     @Override\n-    public void showOfflineMethods(@NonNull final OfflinePaymentTypesMetadata metadata) {\n-        final View offMethodsSheet = getActivity().findViewById(R.id.off_methods_fragment);\n-        offMethodsSheet.setVisibility(VISIBLE);\n-\n-        final BottomSheetBehavior<View> bottomSheetBehavior = BottomSheetBehavior.from(offMethodsSheet);\n+    public void showOfflineMethods(@NonNull final OfflinePaymentTypesMetadata offlineMethods) {\n+        bottomSheet.setVisibility(VISIBLE);\n         bottomSheetBehavior.setState(BottomSheetBehavior.STATE_EXPANDED);\n \n-        final OfflineMethodsFragment fragment = OfflineMethodsFragment.getInstance(metadata);\n-        getActivity().getSupportFragmentManager().beginTransaction()\n-            .setCustomAnimations(R.animator.px_slide_up, 0, 0, R.animator.px_slide_down)\n-            .add(R.id.off_methods_fragment, fragment, TAG_OFFLINE_METHODS_FRAGMENT)\n-            .addToBackStack(null)\n-            .commit();\n+        if (FragmentUtil.getFragmentByTag(getFragmentManager(), TAG_OFFLINE_METHODS_FRAGMENT) == null) {\n+            getFragmentManager().beginTransaction()\n+                .setCustomAnimations(R.animator.px_slide_up, 0, 0, R.animator.px_slide_down)\n+                .replace(R.id.off_methods_fragment, OfflineMethodsFragment.getInstance(offlineMethods),\n+                    TAG_OFFLINE_METHODS_FRAGMENT)\n+                .addToBackStack(null)\n+                .commit();\n+        } else {\n+            bottomSheetBehavior.setState(BottomSheetBehavior.STATE_EXPANDED);\n+        }\n+    }\n+\n+    @Override\n+    public void updateBottomSheetStatus(final boolean hasToExpand) {\n+        if (hasToExpand) {\n+            Log.v(\"CRIS\", \"EXPANDING BOTTOM SHEET\");", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODY4MQ==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367438681", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:13:33Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentPresenter.java", "diffHunk": "@@ -2,6 +2,7 @@\n \n import android.os.Bundle;\n import android.support.annotation.NonNull;\n+import android.util.Log;", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODkxMA==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367438910", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:14:02Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentPresenter.java", "diffHunk": "@@ -201,13 +206,16 @@ public void detachView() {\n     public void recoverFromBundle(@NonNull final Bundle bundle) {\n         splitSelectionState = bundle.getParcelable(BUNDLE_STATE_SPLIT_PREF);\n         paymentMethodIndex = bundle.getInt(BUNDLE_STATE_CURRENT_PM_INDEX);\n+        otherPaymentMethodClickable = bundle.getBoolean(BUNDLE_STATE_OTHER_PM_CLICKABLE);\n+        Log.v(\"CRIS\", \"RECOVERING CLICKABILITY \" + otherPaymentMethodClickable);", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MDE5Ng==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367440196", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:16:29Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/add_new_card/OfflineMethodsFragment.java", "diffHunk": "@@ -12,14 +15,19 @@\n import android.support.v7.widget.RecyclerView;\n import android.text.Editable;\n import android.text.SpannableStringBuilder;\n+import android.util.Log;", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTE3Mw==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367441173", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:18:18Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/add_new_card/OfflineMethodsFragment.java", "diffHunk": "@@ -94,6 +112,35 @@ public void onViewCreated(@NonNull final View view, @Nullable final Bundle saved\n     private void configureRecycler(@NonNull final RecyclerView recycler) {\n         final LinearLayoutManager linearLayoutManager = new LinearLayoutManager(getContext());\n         recycler.setLayoutManager(linearLayoutManager);\n+        recycler.addOnScrollListener(new RecyclerView.OnScrollListener() {\n+            @Override\n+            public void onScrollStateChanged(@NonNull final RecyclerView recyclerView, final int newState) {\n+                super.onScrollStateChanged(recyclerView, newState);\n+                final boolean atTop = !recyclerView.canScrollVertically(-1);\n+                Log.v(\"CRIS\", \"AT TOP \" + atTop);", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTMwNw==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367441307", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:18:31Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/add_new_card/OfflineMethodsFragment.java", "diffHunk": "@@ -94,6 +112,35 @@ public void onViewCreated(@NonNull final View view, @Nullable final Bundle saved\n     private void configureRecycler(@NonNull final RecyclerView recycler) {\n         final LinearLayoutManager linearLayoutManager = new LinearLayoutManager(getContext());\n         recycler.setLayoutManager(linearLayoutManager);\n+        recycler.addOnScrollListener(new RecyclerView.OnScrollListener() {\n+            @Override\n+            public void onScrollStateChanged(@NonNull final RecyclerView recyclerView, final int newState) {\n+                super.onScrollStateChanged(recyclerView, newState);\n+                final boolean atTop = !recyclerView.canScrollVertically(-1);\n+                Log.v(\"CRIS\", \"AT TOP \" + atTop);\n+                Log.v(\"CRIS\", \"State \" + newState);", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MjI1MQ==", "url": "https://github.com/mercadopago/px-android/pull/2011#discussion_r367442251", "bodyText": "Borrar.", "author": "matiasromar", "createdAt": "2020-01-16T14:20:16Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/add_new_card/OfflineMethodsFragment.java", "diffHunk": "@@ -224,9 +272,75 @@ public void showPaymentProcessor() {\n         void onItemSelected(@NonNull final OfflineMethodItem selectedMethod);\n     }\n \n+    @Override\n+    public Animation onCreateAnimation(final int transit, final boolean enter, final int nextAnim) {\n+        final int offset = getResources().getInteger(R.integer.px_long_animation_time);\n+        final int duration = getResources().getInteger(R.integer.px_shorter_animation_time);\n+        final Animation animation =\n+            AnimationUtils.loadAnimation(getContext(), enter ? R.anim.px_fade_in : R.anim.px_fade_out);\n+        animation.setDuration(duration);\n+        animation.setStartOffset(offset);\n+        header.startAnimation(animation);\n+        return super.onCreateAnimation(transit, enter, nextAnim);\n+    }\n+\n+    @Override\n+    public void onExpandedSheet() {\n+        if (fadeInAnimation != null && lastSheetState != BottomSheetBehavior.STATE_EXPANDED) {\n+            header.startAnimation(fadeInAnimation);\n+        }\n+    }\n+\n+    @Override\n+    public void onDragSheet() {\n+        if (fadeOutAnimation != null && lastSheetState == BottomSheetBehavior.STATE_EXPANDED) {\n+            header.startAnimation(fadeOutAnimation);\n+        }\n+    }\n+\n+    @Override\n+    public void onSheetStateChanged(final int newSheetState) {\n+        lastSheetState = newSheetState;\n+    }\n+\n+    @Override\n+    public void startSecurityValidation(final SecurityValidationData data) {\n+        confirmButton.setState(MeliButton.State.DISABLED);\n+        BehaviourProvider.getSecurityBehaviour().startValidation(this, data, REQ_CODE_BIOMETRICS);\n+    }\n+\n+    @Override\n+    public void onActivityResult(final int requestCode, final int resultCode, final Intent data) {\n+        if (requestCode == REQ_CODE_BIOMETRICS) {\n+            handleBiometricsResult(resultCode);\n+        }\n+    }\n+\n+    private void handleBiometricsResult(final int resultCode) {\n+        if (resultCode == RESULT_OK) {\n+            presenter.startPayment();\n+        } else {\n+            presenter.trackSecurityFriction();\n+        }\n+        confirmButton.setState(MeliButton.State.NORMAL);\n+    }\n+\n+    @Override\n+    public void onAttach(final Context context) {\n+        super.onAttach(context);\n+        final int duration = getResources().getInteger(R.integer.px_shorter_animation_time);\n+        fadeInAnimation = AnimationUtils.loadAnimation(context, R.anim.px_fade_in);\n+        fadeInAnimation.setDuration(duration);\n+        fadeOutAnimation = AnimationUtils.loadAnimation(context, R.anim.px_fade_out);\n+        fadeOutAnimation.setDuration(duration);\n+        Log.v(\"CRIS\", \"FRAGMENT ATTACHED\");\n+    }\n+\n     @Override\n     public void onDetach() {\n-        getActivity().findViewById(R.id.off_methods_fragment).setVisibility(View.GONE);\n+        Log.v(\"CRIS\", \"FRAGMENT DETACHED\");", "originalCommit": "04945c93d31b52eccb871a6143e51fe3076424e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3dda3316bbc95037095a86e6daf7f438bf7586a6", "url": "https://github.com/mercadopago/px-android/commit/3dda3316bbc95037095a86e6daf7f438bf7586a6", "message": "removed log", "committedDate": "2020-01-16T14:44:51Z", "type": "forcePushed"}, {"oid": "8746d8305b01c6fc113d172d7525b32368a57b2a", "url": "https://github.com/mercadopago/px-android/commit/8746d8305b01c6fc113d172d7525b32368a57b2a", "message": "removed log", "committedDate": "2020-01-16T14:46:01Z", "type": "forcePushed"}, {"oid": "568f885d6f06a1c6de37e0e1c7c1df7b0e2e48ab", "url": "https://github.com/mercadopago/px-android/commit/568f885d6f06a1c6de37e0e1c7c1df7b0e2e48ab", "message": "removed log", "committedDate": "2020-01-16T14:48:34Z", "type": "forcePushed"}, {"oid": "d6df0eaf0488fd7771295481f3e750f5450ad349", "url": "https://github.com/mercadopago/px-android/commit/d6df0eaf0488fd7771295481f3e750f5450ad349", "message": "removed log", "committedDate": "2020-01-16T18:10:37Z", "type": "forcePushed"}, {"oid": "1c1b601fee73e0502b22f9b1fdeb5d36569a2184", "url": "https://github.com/mercadopago/px-android/commit/1c1b601fee73e0502b22f9b1fdeb5d36569a2184", "message": "removed log", "committedDate": "2020-01-16T19:22:45Z", "type": "commit"}, {"oid": "1c1b601fee73e0502b22f9b1fdeb5d36569a2184", "url": "https://github.com/mercadopago/px-android/commit/1c1b601fee73e0502b22f9b1fdeb5d36569a2184", "message": "removed log", "committedDate": "2020-01-16T19:22:45Z", "type": "forcePushed"}]}