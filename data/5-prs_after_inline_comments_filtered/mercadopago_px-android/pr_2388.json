{"pr_number": 2388, "pr_title": "[Feature] Pay with debit card in chile", "pr_createdAt": "2020-11-18T16:17:50Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2388", "timeline": [{"oid": "73980aedd9e1f7a65babb88d7e9fb732e6efa4b9", "url": "https://github.com/mercadopago/px-android/commit/73980aedd9e1f7a65babb88d7e9fb732e6efa4b9", "message": "not show cvv screen", "committedDate": "2020-11-14T14:11:26Z", "type": "commit"}, {"oid": "6fbac1736be290ca4fb07fc67fb52554b8f79464", "url": "https://github.com/mercadopago/px-android/commit/6fbac1736be290ca4fb07fc67fb52554b8f79464", "message": "tokenize with debit card in MLC", "committedDate": "2020-11-17T15:13:40Z", "type": "commit"}, {"oid": "2fdc5b3db74fb918e3b6373674c4e7f1bd4ff299", "url": "https://github.com/mercadopago/px-android/commit/2fdc5b3db74fb918e3b6373674c4e7f1bd4ff299", "message": "refactor onetapsamples", "committedDate": "2020-11-18T12:52:16Z", "type": "commit"}, {"oid": "e4cfb08969de9101bb552b38318ddd306523dd3b", "url": "https://github.com/mercadopago/px-android/commit/e4cfb08969de9101bb552b38318ddd306523dd3b", "message": "token friction event added", "committedDate": "2020-11-18T13:34:17Z", "type": "commit"}, {"oid": "2b1c16014a337c12ca403e3a40d8b5468a3ffc14", "url": "https://github.com/mercadopago/px-android/commit/2b1c16014a337c12ca403e3a40d8b5468a3ffc14", "message": "refactor", "committedDate": "2020-11-18T16:05:57Z", "type": "commit"}, {"oid": "48860932437358f9f3166c28a0e0e3c6df33e984", "url": "https://github.com/mercadopago/px-android/commit/48860932437358f9f3166c28a0e0e3c6df33e984", "message": "test fixed", "committedDate": "2020-11-18T16:58:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2MDEwMQ==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526260101", "bodyText": "por que declaramos la public key como est\u00e1tica y no as\u00ed la pref id?", "author": "cgaggino", "createdAt": "2020-11-18T17:11:47Z", "path": "example/src/main/java/com/mercadopago/android/px/utils/OneTapSamples.java", "diffHunk": "@@ -579,4 +585,18 @@ private static CheckoutPreference getCheckoutPreferenceWithPayerEmail(\n                 new AdvancedConfiguration.Builder().setProductId(PRODUCT_ID).setExpressPaymentEnable(true)\n                     .build());\n     }\n+\n+    private static MercadoPagoCheckout.Builder startOneTapWithDebitCardInChile() {\n+        final SplitPaymentProcessor samplePaymentProcessor = new SamplePaymentProcessor(\n+            PaymentUtils.getGenericPaymentRejected(),\n+            PaymentUtils.getBusinessPaymentApproved());\n+\n+        return new MercadoPagoCheckout.Builder(ONE_TAP_MERCHANT_WEB_PAY_PUBLIC_KEY, \"589235406-850b749b-4dc3-4510-92ab-37e6e0b51a23\",", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2NjI1Nw==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526266257", "bodyText": "pifie", "author": "jorGonzalez291292", "createdAt": "2020-11-18T17:20:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2MDEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2MTg0NQ==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526261845", "bodyText": "le pondria shouldPayWithCvv o withSecurityCode, conceptualmente esta validaci\u00f3n no nos indica si se debe pagar con esc", "author": "cgaggino", "createdAt": "2020-11-18T17:14:12Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/PaymentService.java", "diffHunk": "@@ -222,12 +224,37 @@ public void startPayment() {\n         }\n     }\n \n+    private boolean shouldPayWithEsc(@NonNull final CardInformation card) {", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2NjY2OA==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526266668", "bodyText": "Dale!", "author": "jorGonzalez291292", "createdAt": "2020-11-18T17:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2MTg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2Mzc1MA==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526263750", "bodyText": "por que \"noRecoverable\"? creo que como lo usamos hoy en dia no importa si es recoverable o no porque queda en one tap no?", "author": "cgaggino", "createdAt": "2020-11-18T17:16:48Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/PaymentService.java", "diffHunk": "@@ -222,12 +224,37 @@ public void startPayment() {\n         }\n     }\n \n+    private boolean shouldPayWithEsc(@NonNull final CardInformation card) {\n+        final int securityCodeLength = card.getSecurityCodeLength() != null ? card.getSecurityCodeLength() : 0;\n+        return securityCodeLength > 0;\n+    }\n+\n+    private void payWithoutCvv(@NonNull final Card card) {\n+        tokenRepository.createTokenWithoutEsc(Objects.requireNonNull(card)).enqueue(new Callback<Token>() {\n+            @Override\n+            public void success(final Token token) {\n+                pay();\n+            }\n+\n+            @Override\n+            public void failure(final ApiException apiException) {\n+                // No start CVV screen if fail\n+                final String tokenError = new TokenErrorWrapper(apiException).getValue();\n+                handlerWrapper.onPaymentError(MercadoPagoError.createNotRecoverable(tokenError));", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2Nzc3MQ==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526267771", "bodyText": "Tiene pinta que pasar\u00eda a ser hasPayerCost, no?", "author": "cgaggino", "createdAt": "2020-11-18T17:22:23Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/PaymentService.java", "diffHunk": "@@ -268,8 +294,7 @@ public void failure(final ApiException apiException) {\n     }\n \n     private boolean hasValidSavedCardInfo() {\n-        return userSelectionRepository.hasCardSelected()\n-            && userSelectionRepository.getPayerCost() != null;\n+        return userSelectionRepository.getPayerCost() != null;", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2ODYyMg==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526268622", "bodyText": "jajaj sip!", "author": "jorGonzalez291292", "createdAt": "2020-11-18T17:23:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2Nzc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTQxNg==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526269416", "bodyText": "tambien queda raro ac\u00e1 el nombre, \"pagar sin cvv\" y lo primero que hace es \"crear token sin esc\", deberia ser crear token sin cvv", "author": "cgaggino", "createdAt": "2020-11-18T17:24:43Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/PaymentService.java", "diffHunk": "@@ -222,12 +224,37 @@ public void startPayment() {\n         }\n     }\n \n+    private boolean shouldPayWithEsc(@NonNull final CardInformation card) {\n+        final int securityCodeLength = card.getSecurityCodeLength() != null ? card.getSecurityCodeLength() : 0;\n+        return securityCodeLength > 0;\n+    }\n+\n+    private void payWithoutCvv(@NonNull final Card card) {\n+        tokenRepository.createTokenWithoutEsc(Objects.requireNonNull(card)).enqueue(new Callback<Token>() {", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3MTgzMw==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526271833", "bodyText": "Tenes raz\u00f3n", "author": "jorGonzalez291292", "createdAt": "2020-11-18T17:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2OTQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3MzE1OA==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526273158", "bodyText": "esto estar\u00eda mal, porque se est\u00e1 usando como condici\u00f3n para guardar el esc nuevo, si no ten\u00eda esc y tiene un esc nuevo hay que guardarlo", "author": "cgaggino", "createdAt": "2020-11-18T17:29:24Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/TokenizeService.java", "diffHunk": "@@ -34,24 +38,44 @@ public TokenizeService(@NonNull final GatewayService gatewayService,\n \n     @Override\n     public MPCall<Token> createToken(@NonNull final Card card) {\n-        return new MPCall<Token>() {\n-            private final String esc =\n-                escManagerBehaviour.getESC(card.getId(), card.getFirstSixDigits(), card.getLastFourDigits());\n+        return callback -> {\n+            final String cardId = Objects.requireNonNull(card.getId());\n+            final String esc = escManagerBehaviour.getESC(cardId, card.getFirstSixDigits(), card.getLastFourDigits());\n \n-            @Override\n-            public void enqueue(final Callback<Token> callback) {\n-                serviceCallWrapp(card.getId(), esc).enqueue(wrap(card, esc, callback));\n-            }\n+            gatewayService.createToken(\n+                paymentSettingRepository.getPublicKey(),\n+                paymentSettingRepository.getPrivateKey(),\n+                SavedESCCardToken.createWithEsc(cardId, esc, device)).enqueue(wrap(card, esc, callback));\n+        };\n+    }\n+\n+    @Override\n+    public MPCall<Token> createTokenWithoutEsc(@NonNull final Card card) {\n+        return callback -> {\n+            final SavedCardToken savedCardToken = new SavedCardToken(Objects.requireNonNull(card.getId()));\n+            savedCardToken.setDevice(device);\n+\n+            gatewayService.createToken(\n+                paymentSettingRepository.getPublicKey(),\n+                paymentSettingRepository.getPrivateKey(),\n+                savedCardToken).enqueue(wrap(card, null, callback));\n         };\n     }\n \n-    /* default */ Callback<Token> wrap(@NonNull final Card card, final String esc, final Callback<Token> callback) {\n+    /* default */ Callback<Token> wrap(@NonNull final Card card, @Nullable final String esc,\n+        final Callback<Token> callback) {\n+\n+        final boolean hasEsc = esc != null;", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3NDU1OQ==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526274559", "bodyText": "aaah entiendo... lo dejo separado en dos wrap distintos.", "author": "jorGonzalez291292", "createdAt": "2020-11-18T17:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3MzE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3NjM1OA==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526276358", "bodyText": "creo que lo m\u00e1s sano va a ser hacer distintas cosas para el flujo con esc y sin esc en vez de generalizar el wrapper del callback", "author": "cgaggino", "createdAt": "2020-11-18T17:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI3MzE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI4NjYzNg==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r526286636", "bodyText": "no vamos a usar un nuevo modelo al final sin securityCode?", "author": "cgaggino", "createdAt": "2020-11-18T17:37:25Z", "path": "px-services/src/main/java/com/mercadopago/android/px/model/SavedCardToken.java", "diffHunk": "@@ -12,11 +12,16 @@\n     private String securityCode;\n     private Device device;\n \n-    public SavedCardToken(String cardId, String securityCode) {\n+    public SavedCardToken(final String cardId, final String securityCode) {\n         this.cardId = cardId;\n         this.securityCode = securityCode;\n     }\n \n+    public SavedCardToken(final String cardId) {", "originalCommit": "48860932437358f9f3166c28a0e0e3c6df33e984", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "320d17f93cd043487687d383dd231bb0eb74c740", "url": "https://github.com/mercadopago/px-android/commit/320d17f93cd043487687d383dd231bb0eb74c740", "message": "review changes", "committedDate": "2020-11-18T18:20:57Z", "type": "commit"}, {"oid": "ff246d5448796fee8a1582a671781f007d3a5a6d", "url": "https://github.com/mercadopago/px-android/commit/ff246d5448796fee8a1582a671781f007d3a5a6d", "message": "revert changes", "committedDate": "2020-11-18T19:42:07Z", "type": "commit"}, {"oid": "c4d077b826fa15bb64e15795adc7667d4bb4e25c", "url": "https://github.com/mercadopago/px-android/commit/c4d077b826fa15bb64e15795adc7667d4bb4e25c", "message": "token friction event tracker fixed", "committedDate": "2020-11-18T19:52:20Z", "type": "commit"}, {"oid": "6f4a9692e681e11a2012e7fbcc06d26a3b746434", "url": "https://github.com/mercadopago/px-android/commit/6f4a9692e681e11a2012e7fbcc06d26a3b746434", "message": "refactor tracker", "committedDate": "2020-11-18T20:19:15Z", "type": "commit"}, {"oid": "c4d570e3fac145ac83a6e52e09a9a1b089102c27", "url": "https://github.com/mercadopago/px-android/commit/c4d570e3fac145ac83a6e52e09a9a1b089102c27", "message": "sample fixed", "committedDate": "2020-11-24T18:48:04Z", "type": "commit"}, {"oid": "ea616d7948a20ffd94fb7d221c90845073592faa", "url": "https://github.com/mercadopago/px-android/commit/ea616d7948a20ffd94fb7d221c90845073592faa", "message": "review changes", "committedDate": "2020-11-26T17:46:32Z", "type": "commit"}, {"oid": "450fb76304251fab43a120cf6af13ea0bfea4e56", "url": "https://github.com/mercadopago/px-android/commit/450fb76304251fab43a120cf6af13ea0bfea4e56", "message": "quit null check", "committedDate": "2020-11-26T17:51:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3NTg0Ng==", "url": "https://github.com/mercadopago/px-android/pull/2388#discussion_r531175846", "bodyText": "Creo que te qued\u00f3 al pedo al final este import", "author": "guchito9", "createdAt": "2020-11-26T18:07:31Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/PaymentService.java", "diffHunk": "@@ -51,6 +52,7 @@\n import java.util.Arrays;\n import java.util.Collections;\n import java.util.List;\n+import java.util.Objects;", "originalCommit": "450fb76304251fab43a120cf6af13ea0bfea4e56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05281c86df6b674884c9abffa3891d97556670fd", "url": "https://github.com/mercadopago/px-android/commit/05281c86df6b674884c9abffa3891d97556670fd", "message": "revert changes", "committedDate": "2020-11-26T18:29:18Z", "type": "commit"}]}