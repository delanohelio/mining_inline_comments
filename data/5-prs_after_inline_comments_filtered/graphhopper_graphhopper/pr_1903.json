{"pr_number": 1903, "pr_title": "Allow overlapping SpatialRules with priorities", "pr_createdAt": "2020-02-12T10:33:14Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/1903", "timeline": [{"oid": "fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "url": "https://github.com/graphhopper/graphhopper/commit/fde4c063600fbb3165b3b1d2ffd7aa2d59b1cf06", "message": "Remove `SpatialRule.EMPTY`", "committedDate": "2020-02-25T16:25:25Z", "type": "forcePushed"}, {"oid": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "url": "https://github.com/graphhopper/graphhopper/commit/affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "message": "Remove `SpatialRule.EMPTY`", "committedDate": "2020-03-04T08:27:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5NjU3MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r390296571", "bodyText": "Why is sorting necessary?\nSee https://github.com/graphhopper/graphhopper/pull/1911/files#diff-e313449003aba3db12b92952cd486e32L85-L87 where I had to remove it to avoid problems.", "author": "karussell", "createdAt": "2020-03-10T13:04:07Z", "path": "core/src/main/java/com/graphhopper/routing/util/spatialrules/SpatialRuleLookupJTS.java", "diffHunk": "@@ -17,110 +17,113 @@\n  */\n package com.graphhopper.routing.util.spatialrules;\n \n-import com.graphhopper.util.shapes.GHPoint;\n+import java.util.*;\n+\n import org.locationtech.jts.geom.*;\n import org.locationtech.jts.index.strtree.STRtree;\n \n-import java.util.*;\n-\n /**\n  * @author Thomas Butz\n  */\n public class SpatialRuleLookupJTS implements SpatialRuleLookup {\n-\n+    \n+    private static final Comparator<SpatialRule> RULE_COMP = new Comparator<SpatialRule>() {\n+\n+        @Override\n+        public int compare(SpatialRule o1, SpatialRule o2) {\n+            int comp = Integer.compare(o1.getPriority(), o2.getPriority());\n+            if (comp != 0) {\n+                return comp;\n+            }\n+            \n+            return o1.getId().compareTo(o2.getId());\n+        }\n+    };\n+    \n     private final GeometryFactory geometryFactory = new GeometryFactory();\n     private final List<SpatialRule> rules;\n     private final Envelope maxBounds;\n     private final STRtree index;\n-\n+    \n     public SpatialRuleLookupJTS(List<SpatialRule> spatialRules, Envelope maxBounds) {\n         this.index = new STRtree();\n-\n+        \n         Map<Polygon, SpatialRuleContainer> containerMap = new HashMap<>();\n+        List<SpatialRule> registeredRules = new ArrayList<>();\n         Set<String> ruleIDs = new HashSet<>();\n         for (SpatialRule rule : spatialRules) {\n             if (rule == null)\n                 throw new IllegalArgumentException(\"rule cannot be null\");\n-\n-            if (rule.equals(SpatialRule.EMPTY))\n-                throw new IllegalArgumentException(\"rule cannot be EMPTY\");\n-\n+            \n             if (!ruleIDs.add(rule.getId()))\n                 throw new IllegalArgumentException(\"Duplicate rule ID: \\\"\" + rule.getId() + \"\\\"\");\n-\n+            \n+            boolean registered = false;\n             for (Polygon border : rule.getBorders()) {\n                 Envelope borderEnvelope = border.getEnvelopeInternal();\n                 if (!maxBounds.intersects(borderEnvelope)) {\n                     continue;\n                 }\n-\n+                \n                 SpatialRuleContainer container = containerMap.get(border);\n                 if (container == null) {\n                     container = new SpatialRuleContainer(border);\n                     containerMap.put(border, container);\n                     index.insert(borderEnvelope, container);\n                 }\n                 container.addRule(rule);\n+                registered = true;\n+            }\n+            \n+            if (registered) {\n+                registeredRules.add(rule);\n             }\n         }\n \n         index.build();\n \n-        this.rules = new ArrayList<>();\n-        rules.add(SpatialRule.EMPTY);\n-        rules.addAll(spatialRules);\n+        Collections.sort(registeredRules, RULE_COMP); // keep the spatial id stable", "originalCommit": "affbc05bc34a3c49e763300bc57572f1e9e4aa7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2MTQ1Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r390861457", "bodyText": "I think we can drop it here as we're already passing in a sorted collection.", "author": "otbutz", "createdAt": "2020-03-11T10:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI5NjU3MQ=="}], "type": "inlineReview"}, {"oid": "e8d1b56632906335fec30b295033f7557b51eca0", "url": "https://github.com/graphhopper/graphhopper/commit/e8d1b56632906335fec30b295033f7557b51eca0", "message": "Don't reorder rules", "committedDate": "2020-03-11T10:29:59Z", "type": "forcePushed"}, {"oid": "ed9ae988ceae2986831f0e2832ea068c6489d034", "url": "https://github.com/graphhopper/graphhopper/commit/ed9ae988ceae2986831f0e2832ea068c6489d034", "message": "Allow rules to be sorted according to a priority score", "committedDate": "2020-03-16T07:50:54Z", "type": "commit"}, {"oid": "adf87d0294a1135894ba3526233113ab12335b80", "url": "https://github.com/graphhopper/graphhopper/commit/adf87d0294a1135894ba3526233113ab12335b80", "message": "Define a ruleset", "committedDate": "2020-03-16T07:50:54Z", "type": "commit"}, {"oid": "7fd873f8ac3941752447200c7fb22537c868c562", "url": "https://github.com/graphhopper/graphhopper/commit/7fd873f8ac3941752447200c7fb22537c868c562", "message": "Handle sorting inside the SpatialRuleLookup implementation", "committedDate": "2020-03-16T07:50:54Z", "type": "commit"}, {"oid": "d7ecb4eaf9070202c45bb959b9b2372446c0c439", "url": "https://github.com/graphhopper/graphhopper/commit/d7ecb4eaf9070202c45bb959b9b2372446c0c439", "message": "Return multiple rules per location", "committedDate": "2020-03-16T07:58:24Z", "type": "commit"}, {"oid": "2d5fffb881e9173704f34360d311866d6a40aa00", "url": "https://github.com/graphhopper/graphhopper/commit/2d5fffb881e9173704f34360d311866d6a40aa00", "message": "Only keep rules within the bounds", "committedDate": "2020-03-16T07:58:24Z", "type": "commit"}, {"oid": "dfcc758ffba05899fee754a8a6a000e4cd68203f", "url": "https://github.com/graphhopper/graphhopper/commit/dfcc758ffba05899fee754a8a6a000e4cd68203f", "message": "Remove `SpatialRule.EMPTY`", "committedDate": "2020-03-16T07:58:24Z", "type": "commit"}, {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "url": "https://github.com/graphhopper/graphhopper/commit/3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "message": "Don't reorder rules", "committedDate": "2020-03-16T07:58:24Z", "type": "commit"}, {"oid": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "url": "https://github.com/graphhopper/graphhopper/commit/3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "message": "Don't reorder rules", "committedDate": "2020-03-16T07:58:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r392943915", "bodyText": "Why do we need to add 1 when storing it into the edge? Also we should state it returns \"EMPTY.getSpatialId\" if it doesn't contain any rules.", "author": "karussell", "createdAt": "2020-03-16T11:12:01Z", "path": "core/src/main/java/com/graphhopper/routing/util/spatialrules/SpatialRuleSet.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ *  Licensed to GraphHopper GmbH under one or more contributor\n+ *  license agreements. See the NOTICE file distributed with this work for\n+ *  additional information regarding copyright ownership.\n+ *\n+ *  GraphHopper GmbH licenses this file to you under the Apache License,\n+ *  Version 2.0 (the \"License\"); you may not use this file except in\n+ *  compliance with the License. You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package com.graphhopper.routing.util.spatialrules;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import com.graphhopper.routing.profiles.RoadAccess;\n+import com.graphhopper.routing.profiles.RoadClass;\n+\n+/**\n+ * Contains all rules which are applicable for a certain position.\n+ * \n+ * @author Thomas Butz\n+ */\n+public class SpatialRuleSet {\n+    public static final SpatialRuleSet EMPTY = new SpatialRuleSet(Collections.<SpatialRule>emptyList(), -1);\n+    \n+    private final List<SpatialRule> rules;\n+    private final int spatialId;\n+\n+    /**\n+     * @param rules     a List of rules, ordered according to how they are to be applied\n+     * @param spatialId the index of the rule with the highest priority\n+     */\n+    public SpatialRuleSet(List<SpatialRule> rules, int spatialId) {\n+        this.rules = Collections.unmodifiableList(rules);\n+        this.spatialId = spatialId;\n+    }\n+    \n+    /**\n+     * Return the max speed for a certain road class.\n+     *\n+     * @param roadClass       The highway type, e.g. {@link RoadClass#MOTORWAY}\n+     * @param transport       The mode of transportation\n+     * @param currentMaxSpeed The current max speed value or -1 if no value has been set yet\n+     * @return the maximum speed value to be used\n+     */\n+    public double getMaxSpeed(RoadClass roadClass, TransportationMode transport, double currentMaxSpeed) {\n+        double value = currentMaxSpeed;\n+        for (SpatialRule rule : rules) {\n+            value = rule.getMaxSpeed(roadClass, transport, value);\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Returns the {@link RoadAccess} for a certain highway type and transportation mode.\n+     *\n+     * @param roadClass          The highway type, e.g. {@link RoadClass#MOTORWAY}\n+     * @param transport          The mode of transportation\n+     * @param currentRoadAccess  The current road access value (default: {@link RoadAccess#YES})\n+     * @return the type of access to be used\n+     */\n+    public RoadAccess getAccess(RoadClass roadClass, TransportationMode transport, RoadAccess currentRoadAccess) {\n+        RoadAccess value = currentRoadAccess;\n+        for (SpatialRule rule : rules) {\n+            value = rule.getAccess(roadClass, transport, value);\n+        }\n+        return value;\n+    }\n+    \n+    /**\n+     * @return the rules in this set\n+     */\n+    public List<SpatialRule> getRules() {\n+        return rules;\n+    }\n+\n+    /**\n+     * @return the index of the rule with the highest priority or\n+     *         <i>-1</i> if the set doesn't contain any rules\n+     */\n+    public int getSpatialId() {\n+        return spatialId;\n+    }", "originalCommit": "3a55d9eedb354a7fcd920c2ab9838dc8dc1a94b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxODM5NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r393518395", "bodyText": "The spatial ID is stored as an IntEncodedValue and therefor needs to be unsigned. As -1 is used to indicate \"no rules applied\" i'm adding 1 to avoid signed values. But i'm open for suggestions \ud83d\ude09\nIMHO the Javadoc of SpatialRuleSet.getSpatialId() is pretty clear about this:\n\nthe index of the rule with the highest priority or -1 if the set doesn't contain any rules", "author": "otbutz", "createdAt": "2020-03-17T08:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM3MDIyMA==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r396370220", "bodyText": "Could we also use 0 for this \"on rule\" indicator? Like we currently seem to do:\nspatialRuleEnc.setInt(false, edgeFlags, spatialRuleLookup.getSpatialId(rule));", "author": "karussell", "createdAt": "2020-03-23T11:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM4Mjk0OA==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r396382948", "bodyText": "I think it's a matter of personal preference. -1 is a widely acknowledged default to indicate a missing element (e.g Javas List.indexOf()). The limitation to use non-negative numbers is enforced by the graph storage and should therefore be handled there.", "author": "otbutz", "createdAt": "2020-03-23T11:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM5MTY5Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r396391697", "bodyText": "It is certainly a limitation of the storage and also the normal return value for a search is -1, but 0 is also the \"Java default\" for all numbers and \"no rule\" can be seen as the default value. Also I'm unsure why we should introduce this change when \"empty\" worked as 0 before.", "author": "karussell", "createdAt": "2020-03-23T11:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzkxNQ=="}], "type": "inlineReview"}, {"oid": "a87f0d103e7ca3510b787c282c07dc34f7b03079", "url": "https://github.com/graphhopper/graphhopper/commit/a87f0d103e7ca3510b787c282c07dc34f7b03079", "message": "Use spatial id 0 to represent no rule", "committedDate": "2020-03-23T12:00:30Z", "type": "commit"}, {"oid": "704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "url": "https://github.com/graphhopper/graphhopper/commit/704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "message": "Add a testcase for overlapping rules", "committedDate": "2020-04-14T13:57:42Z", "type": "commit"}, {"oid": "704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "url": "https://github.com/graphhopper/graphhopper/commit/704e016a3d2bc74b035b194ce7ceb0c8d27c7acb", "message": "Add a testcase for overlapping rules", "committedDate": "2020-04-14T13:57:42Z", "type": "forcePushed"}, {"oid": "159602212a4d0893d5ad3fadf4c5c3b4ae2350cd", "url": "https://github.com/graphhopper/graphhopper/commit/159602212a4d0893d5ad3fadf4c5c3b4ae2350cd", "message": "Merge branch 'master' into ruleset", "committedDate": "2020-04-14T16:15:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r414623839", "bodyText": "@otbutz if the first SpatialRule is always available should we provide a convenient method for this? Or will it be rather rare use case?", "author": "karussell", "createdAt": "2020-04-24T14:34:09Z", "path": "core/src/main/java/com/graphhopper/routing/lm/LandmarkStorage.java", "diffHunk": "@@ -464,10 +464,10 @@ protected IntHashSet findBorderEdgeIds(SpatialRuleLookup ruleLookup) {\n         IntHashSet inaccessible = new IntHashSet();\n         while (allEdgesIterator.next()) {\n             int adjNode = allEdgesIterator.getAdjNode();\n-            SpatialRule ruleAdj = ruleLookup.lookupRule(nodeAccess.getLatitude(adjNode), nodeAccess.getLongitude(adjNode));\n+            SpatialRule ruleAdj = ruleLookup.lookupRules(nodeAccess.getLatitude(adjNode), nodeAccess.getLongitude(adjNode)).getRules().get(0);\n \n             int baseNode = allEdgesIterator.getBaseNode();\n-            SpatialRule ruleBase = ruleLookup.lookupRule(nodeAccess.getLatitude(baseNode), nodeAccess.getLongitude(baseNode));", "originalCommit": "159602212a4d0893d5ad3fadf4c5c3b4ae2350cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYzMDgwNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r414630805", "bodyText": "No, it is not always available per se. The landmark use case is a bit special in that respect.", "author": "otbutz", "createdAt": "2020-04-24T14:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0NTc5Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r414645796", "bodyText": "Ok, so if no rule is available the list could be empty (unlike before where you got SpatialRule.EMPTY?)", "author": "karussell", "createdAt": "2020-04-24T15:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU0MzY5NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r415543695", "bodyText": "Correct. If no rules apply, an empty List is returned.", "author": "otbutz", "createdAt": "2020-04-27T06:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg1ODEyNg==", "url": "https://github.com/graphhopper/graphhopper/pull/1903#discussion_r415858126", "bodyText": "There seems to be a problem with this code: #2020", "author": "karussell", "createdAt": "2020-04-27T14:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYyMzgzOQ=="}], "type": "inlineReview"}]}