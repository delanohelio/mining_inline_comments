{"pr_number": 2087, "pr_title": "Clean-up edge iterator classes", "pr_createdAt": "2020-07-20T16:17:54Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/2087", "timeline": [{"oid": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "url": "https://github.com/graphhopper/graphhopper/commit/5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "message": "Clean-up edge iterator classes", "committedDate": "2020-07-20T16:16:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNDA2MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457534061", "bodyText": "This method was not really related to EdgeAccess.", "author": "easbar", "createdAt": "2020-07-20T16:19:48Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -112,23 +112,6 @@ public BaseGraph(Directory dir, final EncodingManager encodingManager, boolean w\n         this.edges = dir.find(\"edges\", DAType.getPreferredInt(dir.getDefaultType()));\n         this.listener = listener;\n         this.edgeAccess = new EdgeAccess(edges) {\n-            @Override\n-            EdgeIteratorState getEdgeProps(int edgeId, int adjNode, EdgeFilter edgeFilter) {", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNDQ2Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457534467", "bodyText": "This -1 appeared frequently, and was the only value used for this parameter", "author": "easbar", "createdAt": "2020-07-20T16:20:31Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1046,12 +1033,12 @@ private long nextGeoRef(int arrayLength) {\n         return tmp;\n     }\n \n-    protected static class EdgeIterable extends CommonEdgeIterator implements EdgeExplorer, EdgeIterator {\n+    protected static class EdgeIteratorImpl extends EdgeIteratorStateImpl implements EdgeExplorer, EdgeIterator {\n         final EdgeFilter filter;\n         int nextEdgeId;\n \n-        public EdgeIterable(BaseGraph baseGraph, EdgeAccess edgeAccess, EdgeFilter filter) {\n-            super(-1, edgeAccess, baseGraph);", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNDgzOQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457534839", "bodyText": "I renamed this for consistency with the other iterator class names.", "author": "easbar", "createdAt": "2020-07-20T16:21:10Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1046,12 +1033,12 @@ private long nextGeoRef(int arrayLength) {\n         return tmp;\n     }\n \n-    protected static class EdgeIterable extends CommonEdgeIterator implements EdgeExplorer, EdgeIterator {\n+    protected static class EdgeIteratorImpl extends EdgeIteratorStateImpl implements EdgeExplorer, EdgeIterator {", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNTMyNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457535324", "bodyText": "Moved this one level up, its hardly related to the iterator but its more like the initialization code of an edge state", "author": "easbar", "createdAt": "2020-07-20T16:21:55Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1062,33 +1049,6 @@ final void setEdgeId(int edgeId) {\n             this.nextEdgeId = this.edgeId = edgeId;\n         }\n \n-        /**\n-         * @return false if the edge has not a node equal to expectedAdjNode\n-         */\n-        final boolean init(int tmpEdgeId, int expectedAdjNode) {", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457536091", "bodyText": "Renamed this because its more like an 'edge' than an iterator. Its used as base class for the iterators yes, but there wasn't much that was 'iterator-like' about this class.", "author": "easbar", "createdAt": "2020-07-20T16:23:08Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1201,12 +1154,9 @@ public final EdgeIteratorState detach(boolean reverseArg) {\n         }\n     }\n \n-    /**\n-     * Common private super class for AllEdgesIteratorImpl and EdgeIterable\n-     */\n-    static abstract class CommonEdgeIterator implements EdgeIteratorState {\n+    static class EdgeIteratorStateImpl implements EdgeIteratorState {", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3NjE2NA==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458076164", "bodyText": "Thanks! I think it is probably time to try again if we can separate the EdgeIterator interface from EdgeIteratorState (the last time I tried this it was still to heavily coupled in CH but maybe now this is possible?)", "author": "karussell", "createdAt": "2020-07-21T13:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3OTUxNw==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458079517", "bodyText": "Ok, but why would this be better? An EdgeIterator is just an EdgeIteratorState with a next() method. I don't think this ever bothered me.", "author": "easbar", "createdAt": "2020-07-21T13:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4ODAyMQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458088021", "bodyText": "Hmmh, my argument would be that they should be separated like Object is separate from Iterator, but yes, here we change the properties of \"Object\" with every iterator.next() call and so EdgeIterator is not really an Iterator it is more an EdgeIteratorState with a setPointer/setCursor method (very similar to the ResultSet from jdbc API)", "author": "karussell", "createdAt": "2020-07-21T13:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5NDYyNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458094624", "bodyText": "Ok for me an EdgeIteratorState is a proxy to a row of data, or in some cases its an actual row of data (after calling detach()). An EdgeIterator is the same thing except that it can be moved to another edge. I think @michaz suggested calling it a 'cursor' because it changes state after calling next(), compared to the java.util.Iterator which returns the next element when calling next(). But honestly, I am so used to it I do not really care whether its called iterator or cursor. But I do not see real value in separating EdgeIteratorState from EdgeIterator, because like I said in this case the latter is really the same thing as the first except that it allows to be shifted (using the next() method).\nNow we are at it how would we call an EdgeIteratorState that can be set to an arbitrary edge (not just move to the next edge at the same base node). Would it be a SingleEdgeExplorer or a SingleEdgeIterator or a SingleEdgeCursor? \ud83d\ude03", "author": "easbar", "createdAt": "2020-07-21T13:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE3NzAzMg==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458177032", "bodyText": "Probably the EdgeIterator is not a \"cursor\" because it has no direct setEdgeId method, only an implicit \"next()\" and so \"iterator\" is more appropriate (?)\n\nNow we are at it how would we call an EdgeIteratorState that can be set to an arbitrary edge (not just move to the next edge at the same base node).\n\nI like SingleEdgeCursor (also it would have an explicit setEdgeId :) ? )", "author": "karussell", "createdAt": "2020-07-21T15:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NDExNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458184114", "bodyText": "Ok yes SingleEdgeCursor is good and avoids the confusion of calling it \"iterator\" or \"explorer\" :) Yes its main method would be setEdgeId (or setEdge or moveToEdge(Id) or `setToEdge(Id)?).", "author": "easbar", "createdAt": "2020-07-21T15:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NzEwNQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458187105", "bodyText": "Probably the EdgeIterator is not a \"cursor\" because it has no direct setEdgeId method, only an implicit \"next()\" and so \"iterator\" is more appropriate (?)\n\nHppc does this:\n      for (IntCursor cursor : IntArrayList.from(3, 6, 5)) {\n            System.out.println(cursor.value);\n      }\nand here we get the IntCursor when calling next on the Iterator<IntCursor>, so the IntCursor here is the equivalent to our EdgeIteratorState (the proxy object that gives access to the index and value of an int array for example).", "author": "easbar", "createdAt": "2020-07-21T15:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMzc2Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458833762", "bodyText": "Ohhhh, yes yes yes yes yes, standard iteration syntax, please. :-)", "author": "michaz", "createdAt": "2020-07-22T14:26:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjQ1Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r457536453", "bodyText": "The chFlags shouldn't belong to this (basegraph) iterator, I guess this was forgotten in some previous refactoring", "author": "easbar", "createdAt": "2020-07-20T16:23:43Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1215,15 +1165,39 @@ public final EdgeIteratorState detach(boolean reverseArg) {\n         boolean freshFlags;\n         int edgeId = -1;\n         private final IntsRef edgeFlags;\n-        int chFlags;", "originalCommit": "5b645b5816b52bfe4a766d6eac5b8c4527d1291f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3NjI5Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458076296", "bodyText": "Nice!", "author": "karussell", "createdAt": "2020-07-21T13:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzNjQ1Mw=="}], "type": "inlineReview"}, {"oid": "2f4bef4679148cadbb4f0978a97291a86d5d62a7", "url": "https://github.com/graphhopper/graphhopper/commit/2f4bef4679148cadbb4f0978a97291a86d5d62a7", "message": "Merge branch 'master' into iterator_cleanup", "committedDate": "2020-07-21T06:59:14Z", "type": "commit"}, {"oid": "9018712a92c338a9dfc9d108bf0ab71cd893d305", "url": "https://github.com/graphhopper/graphhopper/commit/9018712a92c338a9dfc9d108bf0ab71cd893d305", "message": "Merge branch 'master' into iterator_cleanup", "committedDate": "2020-07-21T13:00:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3OTk3OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458079979", "bodyText": "BTW: I'm not sure if it is a good thing to do these logic checks via if instead of `assert' as they could have a potential slow down, but I wasn't able to measure this difference and so I preferred long term safety (i.e. show these problems even in production)", "author": "karussell", "createdAt": "2020-07-21T13:05:48Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1130,29 +1090,22 @@ void goToNext() {\n \n         @Override\n         public EdgeIteratorState detach(boolean reverseArg) {\n-            if (edgeId == nextEdgeId || !EdgeIterator.Edge.isValid(edgeId))\n-                throw new IllegalStateException(\"call next before detaching or setEdgeId (edgeId:\" + edgeId + \" vs. next \" + nextEdgeId + \")\");\n-\n-            EdgeIteratorState iter = edgeAccess.getEdgeProps(edgeId, reverseArg ? baseNode : adjNode, filter);\n-            assert iter != null;\n-            if (reverseArg) {\n-                // for #162\n-                ((EdgeIterable) iter).reverse = !reverse;\n-            }\n-            return iter;\n+            if (edgeId == nextEdgeId)\n+                throw new IllegalStateException(\"call next before detaching (edgeId:\" + edgeId + \" vs. next \" + nextEdgeId + \")\");", "originalCommit": "9018712a92c338a9dfc9d108bf0ab71cd893d305", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5NzQ2Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458097463", "bodyText": "Hm yes good question. An integer comparison == should hardly ever matter? Except the method gets too long and is no longer inlined or something? Very hard or impossible to say without measuring.", "author": "easbar", "createdAt": "2020-07-21T13:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA3OTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MDc2Ng==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458080766", "bodyText": "I think we should always update the edgePointer to the new value before returning.", "author": "karussell", "createdAt": "2020-07-21T13:07:07Z", "path": "core/src/main/java/com/graphhopper/storage/BaseGraph.java", "diffHunk": "@@ -1164,10 +1117,10 @@ public int length() {\n         public boolean next() {\n             while (true) {\n                 edgeId++;\n-                edgePointer = (long) edgeId * edgeAccess.getEntryBytes();\n                 if (edgeId >= baseGraph.edgeCount)\n                     return false;\n \n+                edgePointer = edgeAccess.toPointer(edgeId);", "originalCommit": "9018712a92c338a9dfc9d108bf0ab71cd893d305", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4Mjk0Mg==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458082942", "bodyText": "Hm, if false is returned we are not using the iterator anymore? But maybe you are right and its more consistent the way you proposed. Should not matter performance-wise, because usually it has to be updated anyway (unless we are at the end of the iteration)", "author": "easbar", "createdAt": "2020-07-21T13:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4NDQyMw==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458084423", "bodyText": "But then we need to update adjNode and baseNode etc. as well? I think using the iterator after iter.next() == false is not well defined anyway? I always used it like this so far while (iter.next()) { // do sth }", "author": "easbar", "createdAt": "2020-07-21T13:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA5MTE3OQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2087#discussion_r458091179", "bodyText": "Ah, indeed, you are right.", "author": "karussell", "createdAt": "2020-07-21T13:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA4MDc2Ng=="}], "type": "inlineReview"}]}