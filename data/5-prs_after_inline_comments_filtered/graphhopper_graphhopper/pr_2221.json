{"pr_number": 2221, "pr_title": "OSMReader has problems with ways that reference missing nodes", "pr_createdAt": "2020-12-21T21:18:13Z", "pr_url": "https://github.com/graphhopper/graphhopper/pull/2221", "timeline": [{"oid": "b3baba8fb868bf1da23ed0d149ae100068072bb8", "url": "https://github.com/graphhopper/graphhopper/commit/b3baba8fb868bf1da23ed0d149ae100068072bb8", "message": "Add tests showing problems with non-existing node refs appearing in OSM ways", "committedDate": "2020-12-21T21:07:54Z", "type": "commit"}, {"oid": "650bea4a33465760b021ecf86654474399314b3a", "url": "https://github.com/graphhopper/graphhopper/commit/650bea4a33465760b021ecf86654474399314b3a", "message": "Simplify edge geometry before the distance is calculated", "committedDate": "2020-12-21T21:51:45Z", "type": "commit"}, {"oid": "ad65f7f61f30987e58369775520132617185eb0c", "url": "https://github.com/graphhopper/graphhopper/commit/ad65f7f61f30987e58369775520132617185eb0c", "message": "Fix gtfs test", "committedDate": "2020-12-22T06:55:52Z", "type": "commit"}, {"oid": "4e623cc5618eeaf8a60a82d433d0feceea79196c", "url": "https://github.com/graphhopper/graphhopper/commit/4e623cc5618eeaf8a60a82d433d0feceea79196c", "message": "Potential fix, but not sure yet, apparently #1984 persists", "committedDate": "2020-12-22T09:46:44Z", "type": "commit"}, {"oid": "4fdc5167286dbfd5377496cb35ac84daa6fd1a68", "url": "https://github.com/graphhopper/graphhopper/commit/4fdc5167286dbfd5377496cb35ac84daa6fd1a68", "message": "Add comment (remove later)", "committedDate": "2020-12-22T09:47:12Z", "type": "commit"}, {"oid": "d1b37f127131b49d47e32d73aecd59c739fb9471", "url": "https://github.com/graphhopper/graphhopper/commit/d1b37f127131b49d47e32d73aecd59c739fb9471", "message": "Remove unused wayOsmId parameter", "committedDate": "2020-12-22T12:09:26Z", "type": "commit"}, {"oid": "2c6554374095f4ccff2d95b6d5a25152c2f722df", "url": "https://github.com/graphhopper/graphhopper/commit/2c6554374095f4ccff2d95b6d5a25152c2f722df", "message": "Merge branch 'simplify_before_dist' into missing_osm_nodes", "committedDate": "2020-12-28T18:09:15Z", "type": "commit"}, {"oid": "0c102333faf4422991677d2767fcc480dab28ba1", "url": "https://github.com/graphhopper/graphhopper/commit/0c102333faf4422991677d2767fcc480dab28ba1", "message": "Check point coordinates and distance during OSM reading", "committedDate": "2020-12-28T18:41:25Z", "type": "commit"}, {"oid": "6625050a22a8915d4eba22e7458fe8ee768c6636", "url": "https://github.com/graphhopper/graphhopper/commit/6625050a22a8915d4eba22e7458fe8ee768c6636", "message": "Update test", "committedDate": "2020-12-28T18:41:42Z", "type": "commit"}, {"oid": "4ac8dafcdea29f004df487fa0d5968b2df21ab93", "url": "https://github.com/graphhopper/graphhopper/commit/4ac8dafcdea29f004df487fa0d5968b2df21ab93", "message": "add original test (remove later)", "committedDate": "2020-12-28T18:52:58Z", "type": "commit"}, {"oid": "b99da492db6b17bc63771426f4b11be53e2694e4", "url": "https://github.com/graphhopper/graphhopper/commit/b99da492db6b17bc63771426f4b11be53e2694e4", "message": "Merge branch 'master' into missing_osm_nodes", "committedDate": "2020-12-29T10:37:49Z", "type": "commit"}, {"oid": "14ebbe46b140bc776a8f9586ec5a34187c7f46a7", "url": "https://github.com/graphhopper/graphhopper/commit/14ebbe46b140bc776a8f9586ec5a34187c7f46a7", "message": "Remove temporary test and comment", "committedDate": "2020-12-29T10:45:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjI1Mw==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549662253", "bodyText": "Btw one of the major difficulties I had when trying to understand OSMReader is that the node map is used in two different ways during the import. In the first pass it simply separates between nodes that occur in two or more, only one or zero ways. For this we use the TOWER/PILLAR/EMPTY_NODE constants. But then in the second run we use the same map and assign pillar/tower node ids and this leads to very confusing code like this:\n  // skip osmIds with no associated pillar or tower id (e.g. !OSMReader.isBounds)\n                if (tmpNode == TOWER_NODE)\n                    continue;\n\n                if (tmpNode == PILLAR_NODE) {\nwhere tmpNode == TOWER/PILLAR_NODE does not mean that tmpNode is a tower/pillar node but it means something very different(!): Because no 'real' tower/pillar node id was assigned for this node it means that tmpNode does not exist.\nThis is probably the first thing I would clean up in OSMReader, because it really tripped me up. I understand that we probably want to re-use the map for performance reasons, but at least we should use a second reference to it (using a different name) or use some helper methods to make this more clear. Then again I wonder if we could exploit the fact that during the first pass we only need to distinguish three values (zero ways, one way, multiple ways) to achieve faster lookups somehow.", "author": "easbar", "createdAt": "2020-12-29T10:59:49Z", "path": "reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java", "diffHunk": "@@ -573,10 +573,30 @@ int addTowerNode(long osmId, double lat, double lon, double ele) {\n         final PointList pointList = new PointList(osmNodeIds.size(), nodeAccess.is3D());\n         final List<EdgeIteratorState> newEdges = new ArrayList<>(5);\n         int firstNode = -1;\n-        final int lastIndex = osmNodeIds.size() - 1;\n         int lastInBoundsPillarNode = -1;\n         try {\n-            for (int i = 0; i < osmNodeIds.size(); i++) {\n+            // #2221: ways might include nodes at the beginning or end that do not exist -> skip them\n+            int firstExisting = -1;\n+            int lastExisting = -1;\n+            for (int i = 0; i < osmNodeIds.size(); ++i) {\n+                final long tmpNode = getNodeMap().get(osmNodeIds.get(i));\n+                if (tmpNode > -TOWER_NODE || tmpNode < TOWER_NODE) {", "originalCommit": "14ebbe46b140bc776a8f9586ec5a34187c7f46a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3MTU2Nw==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549671567", "bodyText": "if we could exploit the fact that during the first pass we only need to distinguish three values\n\nFor example we could use a LongHashSet to store all OSM node Ids that occur in any way and a second (smaller) one to keep track which of these nodes are tower nodes. Not sure if this would be an improvement, because before pass2 we would still have to build the mapping between OSM node Ids and GH tower/pillar IDs.", "author": "easbar", "createdAt": "2020-12-29T11:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY5OTgwNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549699804", "bodyText": "but at least we should use a second reference to it (using a different name) or use some helper methods to make this more clear.\n\n\ud83d\udc4d\n\nFor example we could use a LongHashSet to store all OSM node Ids that occur in any way\n\nThe problem might be for big maps with millions of nodes as sets behave very ugly then: when increasing the size you double the size (additionally to the load factor of usually 0.75) and so you will need 3*1/0.75 = 4 and then you need to copy such big arrays.\nBut surely we can just try as the memory usage requirements changed significantly over the last years. Still at some point not too far in the past I tried with a database like mapdb but it was still much slower and used more resources (disk+memory).", "author": "karussell", "createdAt": "2020-12-29T13:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcwMTUyNA==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549701524", "bodyText": "Ok yes this was just an idea, its probably hard to say without trying it. Also I am not even sure if there is really much need to speed up the OSM parsing and improving readability seems more important.", "author": "easbar", "createdAt": "2020-12-29T13:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcwNTA0NQ==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549705045", "bodyText": "Yes, a speed up is not necessary. Still I would like it, if the new version is not much slower :) (maybe max 2x slower? probably depends on the gained readability)", "author": "karussell", "createdAt": "2020-12-29T13:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY2MjkwMw==", "url": "https://github.com/graphhopper/graphhopper/pull/2221#discussion_r549662903", "bodyText": "The actual fix is a bit lengthy, but rather trivial: We scan the osmNodeIds list from the beginning and end to find the first node that does exist (and skip those that do not exist).", "author": "easbar", "createdAt": "2020-12-29T11:02:16Z", "path": "reader-osm/src/main/java/com/graphhopper/reader/osm/OSMReader.java", "diffHunk": "@@ -573,10 +573,30 @@ int addTowerNode(long osmId, double lat, double lon, double ele) {\n         final PointList pointList = new PointList(osmNodeIds.size(), nodeAccess.is3D());\n         final List<EdgeIteratorState> newEdges = new ArrayList<>(5);\n         int firstNode = -1;\n-        final int lastIndex = osmNodeIds.size() - 1;\n         int lastInBoundsPillarNode = -1;\n         try {\n-            for (int i = 0; i < osmNodeIds.size(); i++) {\n+            // #2221: ways might include nodes at the beginning or end that do not exist -> skip them\n+            int firstExisting = -1;\n+            int lastExisting = -1;", "originalCommit": "14ebbe46b140bc776a8f9586ec5a34187c7f46a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fbaf5842133026077b86ae1af69c6591031bc41", "url": "https://github.com/graphhopper/graphhopper/commit/7fbaf5842133026077b86ae1af69c6591031bc41", "message": "Merge branch 'master' into missing_osm_nodes", "committedDate": "2020-12-29T13:23:24Z", "type": "commit"}]}