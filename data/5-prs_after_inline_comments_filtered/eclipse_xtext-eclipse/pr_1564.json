{"pr_number": 1564, "pr_title": "[#1563] Fixed Line Header Code Minings at Pos 0,0", "pr_createdAt": "2020-10-21T11:41:20Z", "pr_url": "https://github.com/eclipse/xtext-eclipse/pull/1564", "timeline": [{"oid": "31e6c4d9ff33f0df482aa40a8729742ce945feda", "url": "https://github.com/eclipse/xtext-eclipse/commit/31e6c4d9ff33f0df482aa40a8729742ce945feda", "message": "[#1563] Fixed Line Header Code Minings at Pos 0,0\n\nFixes: #1563\n\nSigned-off-by: Christian Dietrich <christian.dietrich@itemis.de>", "committedDate": "2020-10-21T12:30:26Z", "type": "forcePushed"}, {"oid": "62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "url": "https://github.com/eclipse/xtext-eclipse/commit/62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "message": "[#1563] Fixed Line Header Code Minings at Pos 0,0\n\nFixes: #1563\n\nSigned-off-by: Christian Dietrich <christian.dietrich@itemis.de>", "committedDate": "2020-10-21T12:44:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3NDA3OQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510674079", "bodyText": "Futures.getUnchecked(..) may simlify this try-catch and the one below.", "author": "szarnekow", "createdAt": "2020-10-23T06:58:44Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -74,7 +77,7 @@ protected String insertCodeMinings(XtextEditor editor) {\n \t\tISourceViewer viewer = editor.getInternalSourceViewer();\n \n \t\tString text = editor.getDocument().get();\n-\t\tStringBuilder sb = new StringBuilder();\n+\t\tStringBuilder sb = new StringBuilder(text);\n \n \t\tList<? extends ICodeMining> codeMinings;\n \t\ttry {", "originalCommit": "62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f810664685b2435e911f9f85d95c77debe7328a", "url": "https://github.com/eclipse/xtext-eclipse/commit/1f810664685b2435e911f9f85d95c77debe7328a", "message": "[#1563] Fixed Line Header Code Minings at Pos 0,0\n\nFixes: #1563\n\nSigned-off-by: Christian Dietrich <christian.dietrich@itemis.de>", "committedDate": "2020-10-23T07:04:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3NDUxNQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510674515", "bodyText": "Note to self: sort backwards such that traversal starts with the last one", "author": "szarnekow", "createdAt": "2020-10-23T06:59:47Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -92,45 +95,21 @@ protected String insertCodeMinings(XtextEditor editor) {\n \t\t\tassertTrue(\"CodeMining is not resolved!\", codeMining.isResolved());\n \t\t}\n \n-\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm1.getPosition().getOffset() - cm2.getPosition().getOffset());\n+\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm2.getPosition().getOffset() - cm1.getPosition().getOffset());", "originalCommit": "62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3NDc3Nw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510674777", "bodyText": "Note to self: Group the sorted minings -> LinkedHashMap maintains the order.", "author": "szarnekow", "createdAt": "2020-10-23T07:00:21Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -92,45 +95,21 @@ protected String insertCodeMinings(XtextEditor editor) {\n \t\t\tassertTrue(\"CodeMining is not resolved!\", codeMining.isResolved());\n \t\t}\n \n-\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm1.getPosition().getOffset() - cm2.getPosition().getOffset());\n+\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm2.getPosition().getOffset() - cm1.getPosition().getOffset());\n \n-\t\tint currentOffset = 0;\n-\t\tfor (int i = 0; i < codeMinings.size(); i++) {\n-\n-\t\t\tICodeMining codeMining = codeMinings.get(i);\n-\n-\t\t\tint codeMiningOffset = codeMining.getPosition().getOffset();\n-\n-\t\t\tList<ICodeMining> codeMiningsOnTheSameOffset = getCodeMiningsByOffset(codeMinings, codeMiningOffset);\n-\n-\t\t\tString codeMiningsText = getCodeMiningsText(codeMiningsOnTheSameOffset);\n-\n-\t\t\tsb.append(text.substring(currentOffset, codeMiningOffset) + codeMiningsText);\n-\n-\t\t\tcurrentOffset = codeMiningOffset;\n-\t\t\tif (containsLineHeaderCodeMining(codeMiningsOnTheSameOffset)) {\n-\t\t\t\tsb.append(System.lineSeparator());\n-\t\t\t\tcurrentOffset--;\n+\t\tMap<Integer, List<ICodeMining>> byPos = codeMinings.stream().collect(Collectors.groupingBy(e -> e.getPosition().getOffset(), LinkedHashMap::new, Collectors.toList()));", "originalCommit": "62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3NTk4Mw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510675983", "bodyText": "Maybe more straight forward to use Multimap.index(codeMinings, e->getPositions().getOffset()) but it's a matter of taste", "author": "szarnekow", "createdAt": "2020-10-23T07:03:15Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -92,45 +95,21 @@ protected String insertCodeMinings(XtextEditor editor) {\n \t\t\tassertTrue(\"CodeMining is not resolved!\", codeMining.isResolved());\n \t\t}\n \n-\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm1.getPosition().getOffset() - cm2.getPosition().getOffset());\n+\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm2.getPosition().getOffset() - cm1.getPosition().getOffset());\n \n-\t\tint currentOffset = 0;\n-\t\tfor (int i = 0; i < codeMinings.size(); i++) {\n-\n-\t\t\tICodeMining codeMining = codeMinings.get(i);\n-\n-\t\t\tint codeMiningOffset = codeMining.getPosition().getOffset();\n-\n-\t\t\tList<ICodeMining> codeMiningsOnTheSameOffset = getCodeMiningsByOffset(codeMinings, codeMiningOffset);\n-\n-\t\t\tString codeMiningsText = getCodeMiningsText(codeMiningsOnTheSameOffset);\n-\n-\t\t\tsb.append(text.substring(currentOffset, codeMiningOffset) + codeMiningsText);\n-\n-\t\t\tcurrentOffset = codeMiningOffset;\n-\t\t\tif (containsLineHeaderCodeMining(codeMiningsOnTheSameOffset)) {\n-\t\t\t\tsb.append(System.lineSeparator());\n-\t\t\t\tcurrentOffset--;\n+\t\tMap<Integer, List<ICodeMining>> byPos = codeMinings.stream().collect(Collectors.groupingBy(e -> e.getPosition().getOffset(), LinkedHashMap::new, Collectors.toList()));", "originalCommit": "62259d3a1accd09fa9bc962c1ef9fc1913d1f31b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3ODY5MQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510678691", "bodyText": "wanted to keep this similat to what eclipse does ;)", "author": "cdietrich", "createdAt": "2020-10-23T07:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3NTk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY3Njg4MA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1564#discussion_r510676880", "bodyText": "System.lineSeparator -> ((IDocumentExtension4)editor.getDocument()).getDefaultLineDelimiter()", "author": "szarnekow", "createdAt": "2020-10-23T07:05:15Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -74,63 +77,31 @@ protected String insertCodeMinings(XtextEditor editor) {\n \t\tISourceViewer viewer = editor.getInternalSourceViewer();\n \n \t\tString text = editor.getDocument().get();\n-\t\tStringBuilder sb = new StringBuilder();\n+\t\tStringBuilder sb = new StringBuilder(text);\n \n \t\tList<? extends ICodeMining> codeMinings;\n-\t\ttry {\n-\t\t\tcodeMinings = codeMiningProvider.provideCodeMinings(viewer, new NullProgressMonitor()).get();\n-\t\t} catch (InterruptedException | ExecutionException e) {\n-\t\t\tthrow new RuntimeException(e);\n-\t\t}\n+\t\tcodeMinings = Futures.getUnchecked(codeMiningProvider.provideCodeMinings(viewer, new NullProgressMonitor()));\n \n \t\tfor (ICodeMining codeMining : codeMinings) {\n-\t\t\ttry {\n-\t\t\t\tcodeMining.resolve(viewer, new NullProgressMonitor()).get();\n-\t\t\t} catch (InterruptedException | ExecutionException e) {\n-\t\t\t\tthrow new RuntimeException(e);\n-\t\t\t}\n+\t\t\tFutures.getUnchecked(codeMining.resolve(viewer, new NullProgressMonitor()));\n \t\t\tassertTrue(\"CodeMining is not resolved!\", codeMining.isResolved());\n \t\t}\n \n-\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm1.getPosition().getOffset() - cm2.getPosition().getOffset());\n-\n-\t\tint currentOffset = 0;\n-\t\tfor (int i = 0; i < codeMinings.size(); i++) {\n-\n-\t\t\tICodeMining codeMining = codeMinings.get(i);\n+\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm2.getPosition().getOffset() - cm1.getPosition().getOffset());\n \n-\t\t\tint codeMiningOffset = codeMining.getPosition().getOffset();\n-\n-\t\t\tList<ICodeMining> codeMiningsOnTheSameOffset = getCodeMiningsByOffset(codeMinings, codeMiningOffset);\n-\n-\t\t\tString codeMiningsText = getCodeMiningsText(codeMiningsOnTheSameOffset);\n-\n-\t\t\tsb.append(text.substring(currentOffset, codeMiningOffset) + codeMiningsText);\n-\n-\t\t\tcurrentOffset = codeMiningOffset;\n-\t\t\tif (containsLineHeaderCodeMining(codeMiningsOnTheSameOffset)) {\n-\t\t\t\tsb.append(System.lineSeparator());\n-\t\t\t\tcurrentOffset--;\n+\t\tMap<Integer, List<ICodeMining>> byPos = codeMinings.stream().collect(Collectors.groupingBy(e -> e.getPosition().getOffset(), LinkedHashMap::new, Collectors.toList()));\n+\t\tfor (Entry<Integer, List<ICodeMining>> e : byPos.entrySet()) {\n+\t\t\tint codeMiningOffset = e.getKey();\n+\t\t\tList<ICodeMining> miningsAtOffset = e.getValue();\n+\t\t\tString codeMiningsText = getCodeMiningsText(miningsAtOffset);\n+\t\t\tif (containsLineHeaderCodeMining(miningsAtOffset)) {\n+\t\t\t\tsb.insert(codeMiningOffset, System.lineSeparator());", "originalCommit": "1f810664685b2435e911f9f85d95c77debe7328a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09075f9b14cb9902a6e15900f52989963167eaca", "url": "https://github.com/eclipse/xtext-eclipse/commit/09075f9b14cb9902a6e15900f52989963167eaca", "message": "[#1563] Fixed Line Header Code Minings at Pos 0,0\n\nFixes: #1563\n\nSigned-off-by: Christian Dietrich <christian.dietrich@itemis.de>", "committedDate": "2020-10-23T07:09:38Z", "type": "commit"}, {"oid": "09075f9b14cb9902a6e15900f52989963167eaca", "url": "https://github.com/eclipse/xtext-eclipse/commit/09075f9b14cb9902a6e15900f52989963167eaca", "message": "[#1563] Fixed Line Header Code Minings at Pos 0,0\n\nFixes: #1563\n\nSigned-off-by: Christian Dietrich <christian.dietrich@itemis.de>", "committedDate": "2020-10-23T07:09:38Z", "type": "forcePushed"}]}