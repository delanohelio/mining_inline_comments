{"pr_number": 797, "pr_title": "Add DDlogJooqProvider and a corresponding test", "pr_createdAt": "2020-11-03T21:20:32Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/797", "timeline": [{"oid": "78944e47e1ecc857900a37f47a49117dd171c886", "url": "https://github.com/vmware/differential-datalog/commit/78944e47e1ecc857900a37f47a49117dd171c886", "message": "Add DDlogJooqProvider and a corresponding test\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T21:14:54Z", "type": "commit"}, {"oid": "8a30c8d994b7da6d994ce6ee51a5433c2214d503", "url": "https://github.com/vmware/differential-datalog/commit/8a30c8d994b7da6d994ce6ee51a5433c2214d503", "message": "Only support select statements for now\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T21:23:53Z", "type": "commit"}, {"oid": "44d7499b26645c18e242f8029ff1f61904ebf10f", "url": "https://github.com/vmware/differential-datalog/commit/44d7499b26645c18e242f8029ff1f61904ebf10f", "message": "Remove redundant DSLContext\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T21:31:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NDY3NQ==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516984675", "bodyText": "Your SQL parser is a bit rudimentary.\nMaybe you want to call this function executeSelectStar", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:09:49Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {\n+        this.dDlogAPI = dDlogAPI;\n+        dslContext = DSL.using(\"jdbc:h2:mem:\");\n+        for (final String sql : sqlStatements) {\n+            dslContext.execute(sql);\n+        }\n+        for (final Table<?> table: dslContext.meta().getTables()) {\n+            if (table.getSchema().getName().equals(\"PUBLIC\")) {\n+                tables.put(table.getName(), Arrays.asList(table.fields()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public MockResult[] execute(final MockExecuteContext ctx) throws SQLException {\n+        final MockResult[] mock = new MockResult[1];\n+        // The execute context contains SQL string(s), bind values, and other meta-data\n+        final String sql = ctx.sql();\n+\n+        if (sql.toUpperCase().startsWith(\"SELECT\")) {", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NDgyMg==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516984822", "bodyText": "You are not checking that the select expression is *.", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:10:12Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {\n+        this.dDlogAPI = dDlogAPI;\n+        dslContext = DSL.using(\"jdbc:h2:mem:\");\n+        for (final String sql : sqlStatements) {\n+            dslContext.execute(sql);\n+        }\n+        for (final Table<?> table: dslContext.meta().getTables()) {\n+            if (table.getSchema().getName().equals(\"PUBLIC\")) {\n+                tables.put(table.getName(), Arrays.asList(table.fields()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public MockResult[] execute(final MockExecuteContext ctx) throws SQLException {\n+        final MockResult[] mock = new MockResult[1];\n+        // The execute context contains SQL string(s), bind values, and other meta-data\n+        final String sql = ctx.sql();\n+\n+        if (sql.toUpperCase().startsWith(\"SELECT\")) {\n+            final String[] s = ctx.sql().toUpperCase().split(\" \");\n+            if (!s[s.length - 2].equals(\"FROM\")) {", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NDkxNA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516984914", "bodyText": "This could be null.", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:10:22Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {\n+        this.dDlogAPI = dDlogAPI;\n+        dslContext = DSL.using(\"jdbc:h2:mem:\");\n+        for (final String sql : sqlStatements) {\n+            dslContext.execute(sql);\n+        }\n+        for (final Table<?> table: dslContext.meta().getTables()) {\n+            if (table.getSchema().getName().equals(\"PUBLIC\")) {\n+                tables.put(table.getName(), Arrays.asList(table.fields()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public MockResult[] execute(final MockExecuteContext ctx) throws SQLException {\n+        final MockResult[] mock = new MockResult[1];\n+        // The execute context contains SQL string(s), bind values, and other meta-data\n+        final String sql = ctx.sql();\n+\n+        if (sql.toUpperCase().startsWith(\"SELECT\")) {\n+            final String[] s = ctx.sql().toUpperCase().split(\" \");\n+            if (!s[s.length - 2].equals(\"FROM\")) {\n+                throw new SQLException(\"Statement not supported: \" + sql);\n+            }\n+            final String tableName = s[s.length - 1];\n+            final List<Field<?>> fields = tables.get(tableName);", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NTU2MQ==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516985561", "bodyText": "Assert that the size is the same?", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:11:51Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {\n+        this.dDlogAPI = dDlogAPI;\n+        dslContext = DSL.using(\"jdbc:h2:mem:\");\n+        for (final String sql : sqlStatements) {\n+            dslContext.execute(sql);\n+        }\n+        for (final Table<?> table: dslContext.meta().getTables()) {\n+            if (table.getSchema().getName().equals(\"PUBLIC\")) {\n+                tables.put(table.getName(), Arrays.asList(table.fields()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public MockResult[] execute(final MockExecuteContext ctx) throws SQLException {\n+        final MockResult[] mock = new MockResult[1];\n+        // The execute context contains SQL string(s), bind values, and other meta-data\n+        final String sql = ctx.sql();\n+\n+        if (sql.toUpperCase().startsWith(\"SELECT\")) {\n+            final String[] s = ctx.sql().toUpperCase().split(\" \");\n+            if (!s[s.length - 2].equals(\"FROM\")) {\n+                throw new SQLException(\"Statement not supported: \" + sql);\n+            }\n+            final String tableName = s[s.length - 1];\n+            final List<Field<?>> fields = tables.get(tableName);\n+            final Result<Record> result = dslContext.newResult(fields);\n+            try {\n+                dDlogAPI.dumpTable(\"R\" + tableName.toLowerCase(), (record, l) -> {\n+                    final Record jooqRecord = dslContext.newRecord(fields);\n+                    final Object[] returnValue = new Object[fields.size()];\n+                    for (int i = 0; i < fields.size(); i++) {", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NTIwNw==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516995207", "bodyText": "What's the correct way to query the size of the ddlog record? I see record.getStructField(int i), but it does not say how many fields the struct has.", "author": "lalithsuresh", "createdAt": "2020-11-03T22:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NTU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NzUxMA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516997510", "bodyText": "In a sense, it'd be an internal error (ddlog or our sql-to-ddlog compiler) for record.<size()> to not be equal to fields.size(). And if it is not the case, we'll correctly get an out of bounds exception. Seems excessive to check every record in dumpTable() for their size. Am I missing something?", "author": "lalithsuresh", "createdAt": "2020-11-03T22:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NTU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NjAwNQ==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516986005", "bodyText": "this does not look like the following one at all. Is it ddlog_std?", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:12:50Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {\n+        this.dDlogAPI = dDlogAPI;\n+        dslContext = DSL.using(\"jdbc:h2:mem:\");\n+        for (final String sql : sqlStatements) {\n+            dslContext.execute(sql);\n+        }\n+        for (final Table<?> table: dslContext.meta().getTables()) {\n+            if (table.getSchema().getName().equals(\"PUBLIC\")) {\n+                tables.put(table.getName(), Arrays.asList(table.fields()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public MockResult[] execute(final MockExecuteContext ctx) throws SQLException {\n+        final MockResult[] mock = new MockResult[1];\n+        // The execute context contains SQL string(s), bind values, and other meta-data\n+        final String sql = ctx.sql();\n+\n+        if (sql.toUpperCase().startsWith(\"SELECT\")) {\n+            final String[] s = ctx.sql().toUpperCase().split(\" \");\n+            if (!s[s.length - 2].equals(\"FROM\")) {\n+                throw new SQLException(\"Statement not supported: \" + sql);\n+            }\n+            final String tableName = s[s.length - 1];\n+            final List<Field<?>> fields = tables.get(tableName);\n+            final Result<Record> result = dslContext.newResult(fields);\n+            try {\n+                dDlogAPI.dumpTable(\"R\" + tableName.toLowerCase(), (record, l) -> {\n+                    final Record jooqRecord = dslContext.newRecord(fields);\n+                    final Object[] returnValue = new Object[fields.size()];\n+                    for (int i = 0; i < fields.size(); i++) {\n+                        returnValue[i] = structToValue(fields.get(i), record.getStructField(i));\n+                    }\n+                    jooqRecord.fromArray(returnValue);\n+                    result.add(jooqRecord);\n+                });\n+            } catch (final DDlogException e) {\n+                e.printStackTrace();\n+            }\n+            mock[0] = new MockResult(1, result);\n+        } else {\n+            // Exceptions are propagated through the JDBC and jOOQ APIs\n+            throw new SQLException(\"Statement not supported: \" + sql);\n+        }\n+        return mock;\n+    }\n+\n+    @Nullable\n+    private Object structToValue(final Field<?> field, final DDlogRecord record) {\n+        final Class<?> cls = field.getType();\n+        if (record.isStruct() && record.getStructName().equals(\"std.None\")) {", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4ODI4MA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516988280", "bodyText": "It's now called ddlog_std::None. std.None is from an old version of DDlog.", "author": "ryzhyk", "createdAt": "2020-11-03T22:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NjAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NjU2MA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516986560", "bodyText": "I don't know this Jooq stuff, but I would expect there's a way to mock just input tables, not statements, and then statements can run on these tables.", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:14:04Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package com.vmware.ddlog;\n+\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Field;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.Table;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.jooq.tools.jdbc.MockExecuteContext;\n+import org.jooq.tools.jdbc.MockResult;\n+\n+import javax.annotation.Nullable;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DDlogJooqProvider implements MockDataProvider {\n+    private static final String INTEGER_TYPE = \"java.lang.Integer\";\n+    private static final String STRING_TYPE = \"java.lang.String\";\n+    private static final String BOOLEAN_TYPE = \"java.lang.Boolean\";\n+    private static final String LONG_TYPE = \"java.lang.Long\";\n+\n+    private final DDlogAPI dDlogAPI;\n+    private final DSLContext dslContext;\n+    private final Map<String, List<Field<?>>> tables = new HashMap<>();\n+\n+    public DDlogJooqProvider(final DDlogAPI dDlogAPI, final List<String> sqlStatements) {", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NTk1NQ==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516995955", "bodyText": "This affects the API a bit. Here, the user supplies the SQL statements to make a schema out of (and we extract the information we need it from it, like the mapping of table names to JOOQ Fields). The alternative is that the user supplies a JOOQ connection with the schema already initialized.", "author": "lalithsuresh", "createdAt": "2020-11-03T22:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NjU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NzA0NA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516987044", "bodyText": "Don't you want to insert everything in one transaction? Should be significantly more efficient.", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:15:09Z", "path": "sql/src/test/java/ddlog/JooqProviderTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package ddlog;\n+\n+import com.vmware.ddlog.DDlogJooqProvider;\n+import com.vmware.ddlog.ir.DDlogProgram;\n+import com.vmware.ddlog.translator.Translator;\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogCommand;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecCommand;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockConnection;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.junit.Test;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+\n+public class JooqProviderTest {\n+\n+    @Test\n+    public void testddlog() throws IOException, DDlogException {\n+        final Translator t = new Translator(null);\n+        final String s1 = \"create table hosts (id integer, capacity integer)\";\n+        final String v2 = \"create view hostsv as select distinct * from hosts\";\n+        final String v1 = \"create view good_hosts as select distinct * from hosts where capacity < 50\";\n+        t.translateSqlStatement(s1);\n+        t.translateSqlStatement(v2);\n+        t.translateSqlStatement(v1);\n+        final DDlogProgram dDlogProgram = t.getDDlogProgram();\n+        writeProgramToFile(dDlogProgram.toString());\n+        DDlogAPI.compileDDlogProgram(\"/tmp/program.dl\", true, \"../lib\", \"./lib\");\n+        DDlogAPI.loadDDlog();\n+\n+        final DDlogAPI dDlogAPI = new DDlogAPI(1, null, true);\n+        final int numInserts = 5;\n+        for (int i = 0; i < numInserts; i++) {\n+            final DDlogRecord rec = new DDlogRecord(i);\n+            final DDlogRecord cap = new DDlogRecord(20);\n+            final DDlogRecord struct = DDlogRecord.makeStruct(\"Thosts\", rec, cap);\n+            final int id = dDlogAPI.getTableId(\"Rhosts\");\n+            final DDlogRecCommand command = new DDlogRecCommand(DDlogCommand.Kind.Insert, id, struct);", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NjAxOQ==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516996019", "bodyText": "This was just for tests. I'll fix it.", "author": "lalithsuresh", "createdAt": "2020-11-03T22:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NzA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NzQ5MA==", "url": "https://github.com/vmware/differential-datalog/pull/797#discussion_r516987490", "bodyText": "why don't you make this one a static final?", "author": "mbudiu-vmw", "createdAt": "2020-11-03T22:16:11Z", "path": "sql/src/test/java/ddlog/JooqProviderTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2018-2020 VMware, Inc. All Rights Reserved.\n+ * SPDX-License-Identifier: BSD-2\n+ */\n+package ddlog;\n+\n+import com.vmware.ddlog.DDlogJooqProvider;\n+import com.vmware.ddlog.ir.DDlogProgram;\n+import com.vmware.ddlog.translator.Translator;\n+import ddlogapi.DDlogAPI;\n+import ddlogapi.DDlogCommand;\n+import ddlogapi.DDlogException;\n+import ddlogapi.DDlogRecCommand;\n+import ddlogapi.DDlogRecord;\n+import org.jooq.DSLContext;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+import org.jooq.impl.DSL;\n+import org.jooq.tools.jdbc.MockConnection;\n+import org.jooq.tools.jdbc.MockDataProvider;\n+import org.junit.Test;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertArrayEquals;\n+import static org.junit.Assert.assertEquals;\n+\n+public class JooqProviderTest {\n+\n+    @Test\n+    public void testddlog() throws IOException, DDlogException {\n+        final Translator t = new Translator(null);\n+        final String s1 = \"create table hosts (id integer, capacity integer)\";\n+        final String v2 = \"create view hostsv as select distinct * from hosts\";\n+        final String v1 = \"create view good_hosts as select distinct * from hosts where capacity < 50\";\n+        t.translateSqlStatement(s1);\n+        t.translateSqlStatement(v2);\n+        t.translateSqlStatement(v1);\n+        final DDlogProgram dDlogProgram = t.getDDlogProgram();\n+        writeProgramToFile(dDlogProgram.toString());\n+        DDlogAPI.compileDDlogProgram(\"/tmp/program.dl\", true, \"../lib\", \"./lib\");\n+        DDlogAPI.loadDDlog();\n+\n+        final DDlogAPI dDlogAPI = new DDlogAPI(1, null, true);\n+        final int numInserts = 5;\n+        for (int i = 0; i < numInserts; i++) {\n+            final DDlogRecord rec = new DDlogRecord(i);\n+            final DDlogRecord cap = new DDlogRecord(20);\n+            final DDlogRecord struct = DDlogRecord.makeStruct(\"Thosts\", rec, cap);\n+            final int id = dDlogAPI.getTableId(\"Rhosts\");\n+            final DDlogRecCommand command = new DDlogRecCommand(DDlogCommand.Kind.Insert, id, struct);\n+            dDlogAPI.transactionStart();\n+            dDlogAPI.applyUpdates(new DDlogRecCommand[]{command});\n+            dDlogAPI.transactionCommit();\n+        }\n+\n+        final List<String> ddl = new ArrayList<>();\n+        ddl.add(s1);\n+        ddl.add(v2);\n+        ddl.add(v1);\n+\n+        // Initialise the data provider\n+        MockDataProvider provider = new DDlogJooqProvider(dDlogAPI, ddl);\n+        MockConnection connection = new MockConnection(provider);\n+\n+        // Pass the mock connection to a jOOQ DSLContext:\n+        DSLContext create = DSL.using(connection);\n+        final Result<Record> fetch = create.fetch(\"select * from hostsv\");\n+        assertEquals(numInserts, fetch.size());\n+        assertArrayEquals(new int[]{0, 1, 2, 3, 4},\n+                          fetch.stream().mapToInt(r -> r.get(0, Integer.class)).toArray());\n+    }\n+\n+    public File writeProgramToFile(String programBody) throws IOException {\n+        File tmp = new File(\"/tmp/program.dl\");", "originalCommit": "44d7499b26645c18e242f8029ff1f61904ebf10f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c52aa278f035fee7f0f46438db8a4f5d757c8faa", "url": "https://github.com/vmware/differential-datalog/commit/c52aa278f035fee7f0f46438db8a4f5d757c8faa", "message": "Address first round of code reviews\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T22:33:53Z", "type": "commit"}, {"oid": "93b7587f0fe79939ac40e0873a82838fb2cd06ce", "url": "https://github.com/vmware/differential-datalog/commit/93b7587f0fe79939ac40e0873a82838fb2cd06ce", "message": "Batch all writes into one transaction\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T22:37:02Z", "type": "commit"}, {"oid": "68b4178416e846a6682dd8fa91c39d83a9eeffca", "url": "https://github.com/vmware/differential-datalog/commit/68b4178416e846a6682dd8fa91c39d83a9eeffca", "message": "Make writeProgramToFile static\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T22:37:43Z", "type": "commit"}, {"oid": "864b3eedb99ca3f4ffe35185d93339a9c83f6fa5", "url": "https://github.com/vmware/differential-datalog/commit/864b3eedb99ca3f4ffe35185d93339a9c83f6fa5", "message": "A bit more defensive check\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-03T23:58:48Z", "type": "commit"}]}