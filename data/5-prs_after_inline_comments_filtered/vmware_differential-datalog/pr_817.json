{"pr_number": 817, "pr_title": "jooq-ddlog: migrate away from dumpTables and use incremental API", "pr_createdAt": "2020-11-17T19:09:19Z", "pr_url": "https://github.com/vmware/differential-datalog/pull/817", "timeline": [{"oid": "74b0ee3ec1d5d907e96da2444c138093f189c2a5", "url": "https://github.com/vmware/differential-datalog/commit/74b0ee3ec1d5d907e96da2444c138093f189c2a5", "message": "jooq-ddlog: migrate away from dumpTables and use incremental API\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-17T19:01:47Z", "type": "commit"}, {"oid": "f12ecf9c4134b0110fe97a72782bb924b4e995d3", "url": "https://github.com/vmware/differential-datalog/commit/f12ecf9c4134b0110fe97a72782bb924b4e995d3", "message": "jooq-ddlog: handle nulls in structToValue\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-17T19:10:54Z", "type": "commit"}, {"oid": "e0e62987378b8eb045c0e3b55557843d1b74796d", "url": "https://github.com/vmware/differential-datalog/commit/e0e62987378b8eb045c0e3b55557843d1b74796d", "message": "jooq-ddlog: use a relationNameToTableName() helper method\n\nSigned-off-by: Lalith Suresh <lsuresh@vmware.com>", "committedDate": "2020-11-17T19:27:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMjY0OA==", "url": "https://github.com/vmware/differential-datalog/pull/817#discussion_r525432648", "bodyText": "I think these should become methods in the compiler.", "author": "mbudiu-vmw", "createdAt": "2020-11-17T19:32:58Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -343,6 +358,13 @@ private static String ddlogRelationName(final String tableName) {\n         return \"R\" + tableName.toLowerCase();\n     }\n \n+    /*\n+     * This corresponds to the naming convention followed by the SQL -> DDlog compiler\n+     */\n+    private static String relationNameToTableName(final String relationName) {", "originalCommit": "e0e62987378b8eb045c0e3b55557843d1b74796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ2MTkxOQ==", "url": "https://github.com/vmware/differential-datalog/pull/817#discussion_r525461919", "bodyText": "In the sql-ddlog compiler right? I'll send a separate PR for that.", "author": "lalithsuresh", "createdAt": "2020-11-17T19:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMjY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzNDQ0MQ==", "url": "https://github.com/vmware/differential-datalog/pull/817#discussion_r525434441", "bodyText": "Reflection is bound to be very slow. This will probably dominate the other conversion costs.\nYou should consider caching the field types map.", "author": "mbudiu-vmw", "createdAt": "2020-11-17T19:34:49Z", "path": "sql/src/main/java/com/vmware/ddlog/DDlogJooqProvider.java", "diffHunk": "@@ -362,23 +384,37 @@ private static DDlogRecord maybeOption(final Boolean isNullable, final DDlogReco\n     }\n \n     @Nullable\n-    private static Object structToValue(final Field<?> field, final DDlogRecord record) {\n-        final Class<?> cls = field.getType();\n-        if (record.isStruct() && record.getStructName().equals(DDLOG_NONE)) {\n-            return null;\n-        }\n-        if (record.isStruct() && record.getStructName().equals(DDLOG_SOME)) {\n-            return structToValue(field, record.getStructField(0));\n+    private static void structToValue(final Field<?> field, final DDlogRecord record, final Record jooqRecord) {\n+        final boolean isStruct = record.isStruct();\n+        if (isStruct) {\n+            final String structName = record.getStructName();\n+            if (structName.equals(DDLOG_NONE)) {\n+                jooqRecord.setValue(field,null);\n+                return;\n+            }\n+            if (structName.equals(DDLOG_SOME)) {\n+                toValue(field, record.getStructField(0), jooqRecord);\n+                return;\n+            }\n         }\n+        toValue(field, record, jooqRecord);\n+    }\n+\n+    private static void toValue(final Field<?> field, final DDlogRecord record, final Record jooqRecord) {\n+        final Class<?> cls = field.getType();", "originalCommit": "e0e62987378b8eb045c0e3b55557843d1b74796d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzNzQ3Mw==", "url": "https://github.com/vmware/differential-datalog/pull/817#discussion_r525437473", "bodyText": "This is not using reflection. This returns a member of type Class<?> from JOOQ's Field<> type.", "author": "lalithsuresh", "createdAt": "2020-11-17T19:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzNDQ0MQ=="}], "type": "inlineReview"}]}