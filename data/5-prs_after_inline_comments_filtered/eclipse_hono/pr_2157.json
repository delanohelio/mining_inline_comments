{"pr_number": 2157, "pr_title": "Refactor base classes to allow other implementations (JDBC)", "pr_createdAt": "2020-09-07T07:16:47Z", "pr_url": "https://github.com/eclipse/hono/pull/2157", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNTM4Mw==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484735383", "bodyText": "how about simply adding these static methods to the existing CommonCredential class?", "author": "sophokles73", "createdAt": "2020-09-08T08:16:54Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredentials.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import java.util.Collection;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+/**\n+ * Helper methods for {@link CommonCredential}.\n+ */\n+public final class CommonCredentials {", "originalCommit": "9a36ae16e34c4f3602c5a549fb49ad7545dc19d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwMTU5Ng==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484801596", "bodyText": "I was following the pattern of splitting actual objects and helper classes apart, like java.util.Collections, java.lang.Objects, com.google.collect.Streams, \u2026", "author": "ctron", "createdAt": "2020-09-08T10:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNTM4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMjM0NQ==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484832345", "bodyText": "I see", "author": "sophokles73", "createdAt": "2020-09-08T11:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNzczNQ==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484737735", "bodyText": "maybe we should add non-null checks for the services as well?", "author": "sophokles73", "createdAt": "2020-09-08T08:20:27Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/device/AutoProvisioning.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.device;\n+\n+import java.net.HttpURLConnection;\n+import java.security.cert.X509Certificate;\n+import java.time.Instant;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.security.auth.x500.X500Principal;\n+\n+import org.eclipse.hono.service.management.OperationResult;\n+import org.eclipse.hono.service.management.credentials.CredentialsManagementService;\n+import org.eclipse.hono.service.management.credentials.X509CertificateCredential;\n+import org.eclipse.hono.service.management.credentials.X509CertificateSecret;\n+\n+import io.opentracing.Span;\n+import io.vertx.core.Future;\n+\n+/**\n+ * Helper to auto-provision devices.\n+ */\n+public final class AutoProvisioning {\n+\n+    private AutoProvisioning() {\n+    }\n+\n+    /**\n+     * Registers a device together with a set of credentials for the given client certificate.\n+     *\n+     * @param deviceManagementService The device management service to use.\n+     * @param credentialsManagementService The credentials service to use.\n+     * @param tenantId The tenant to which the device belongs.\n+     * @param clientCertificate The X.509 certificate of the device to be provisioned.\n+     * @param span The active OpenTracing span for this operation. It is not to be closed in this method! An\n+     *            implementation should log (error) events on this span and it may set tags and use this span as the\n+     *            parent for any spans created in this method.\n+     * @return A (succeeded) future containing the result of the operation. The <em>status</em> will be\n+     *         <ul>\n+     *         <li><em>201 CREATED</em> if the device has successfully been provisioned.</li>\n+     *         <li><em>4XX</em> if the provisioning failed. The payload may contain an error description.</li>\n+     *         </ul>\n+     * @throws NullPointerException if any of the parameters is {@code null}.\n+     */\n+    public static Future<OperationResult<String>> provisionDevice(\n+            final DeviceManagementService deviceManagementService,\n+            final CredentialsManagementService credentialsManagementService,\n+            final String tenantId,\n+            final X509Certificate clientCertificate,\n+            final Span span) {\n+\n+        Objects.requireNonNull(tenantId);", "originalCommit": "9a36ae16e34c4f3602c5a549fb49ad7545dc19d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc0MDU1NA==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484740554", "bodyText": "how about adding null checks?", "author": "sophokles73", "createdAt": "2020-09-08T08:24:58Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/device/AbstractRegistrationService.java", "diffHunk": "@@ -103,11 +104,39 @@ public final void setTenantInformationService(final TenantInformationService ten\n      * @param span The active OpenTracing span for this operation. It is not to be closed in this method! An\n      *            implementation should log (error) events on this span and it may set tags and use this span as the\n      *            parent for any spans created in this method.\n-     * @return A future indicating the outcome of the operation. A failed future with \n+     * @return A future indicating the outcome of the operation. A failed future with\n      *           a {@link ServiceInvocationException} is returned, if there was an error resolving the groups.\n      * @throws NullPointerException if any of the parameters is {@code null}.\n      */\n-    protected abstract Future<JsonArray> resolveGroupMembers(String tenantId, JsonArray viaGroups, Span span);\n+    Future<JsonArray> resolveGroupMembers(final String tenantId, final JsonArray viaGroups, final Span span) {\n+\n+        final var viaGroupsAsString = viaGroups.stream()", "originalCommit": "9a36ae16e34c4f3602c5a549fb49ad7545dc19d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a911de948a7d00fb9f2620d185ebb38a93226698", "url": "https://github.com/eclipse/hono/commit/a911de948a7d00fb9f2620d185ebb38a93226698", "message": "Refactor base classes to allow other implementations (JDBC)", "committedDate": "2020-09-08T10:04:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5MjE0NA==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484792144", "bodyText": "How about including @throws NullPointerException ... to the JavaDoc?", "author": "kaniyan", "createdAt": "2020-09-08T09:47:36Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/service/management/credentials/CommonCredentials.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.service.management.credentials;\n+\n+import java.util.Collection;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+/**\n+ * Helper methods for {@link CommonCredential}.\n+ */\n+public final class CommonCredentials {\n+\n+    private CommonCredentials() {\n+    }\n+\n+    /**\n+     * Find a credentials object in a set of credentials.\n+     *\n+     * @param credentials The credentials to search.\n+     * @param type The type to search for.\n+     * @param authId The auth id to search for.\n+     * @return The search result.\n+     */", "originalCommit": "9a36ae16e34c4f3602c5a549fb49ad7545dc19d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwMzg4Mg==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484803882", "bodyText": "Null check is missing for hashAlgorithmsWhitelist. hashAlgorithmsWhitelist is passed as an argumet to\nDeviceRegistryUtils.checkCredential(...) and it does not allow null value for this argument.", "author": "kaniyan", "createdAt": "2020-09-08T10:07:48Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/credentials/AbstractCredentialsManagementService.java", "diffHunk": "@@ -41,23 +43,34 @@\n  */\n public abstract class AbstractCredentialsManagementService implements CredentialsManagementService {\n \n-    protected TenantInformationService tenantInformationService = new NoopTenantInformationService();\n \n-    private HonoPasswordEncoder passwordEncoder;\n+    protected TenantInformationService tenantInformationService = new NoopTenantInformationService();\n \n     private final Vertx vertx;\n+    private final HonoPasswordEncoder passwordEncoder;\n+    private final int maxBcryptIteration;\n+    private final Set<String> hashAlgorithmsWhitelist;\n \n     /**\n      * Creates a service for the given Vertx and password encoder instances.\n      *\n      * @param vertx The Vertx instance to use.\n      * @param passwordEncoder The password encoder.\n-     * @throws NullPointerException if any of the parameters is {@code null};\n+     * @param maxBcryptIteration The maximum number of allowed bcrypt iterations.\n+     * @param hashAlgorithmsWhitelist An optional collection of allowed password hashes.\n+     * @throws NullPointerException if any of the required parameters is {@code null};\n      */\n-    @Autowired\n-    public AbstractCredentialsManagementService(final Vertx vertx, final HonoPasswordEncoder passwordEncoder) {\n+    public AbstractCredentialsManagementService(\n+            final Vertx vertx,\n+            final HonoPasswordEncoder passwordEncoder,\n+            final int maxBcryptIteration,\n+            final Set<String> hashAlgorithmsWhitelist) {\n+\n         this.vertx = Objects.requireNonNull(vertx);\n         this.passwordEncoder = Objects.requireNonNull(passwordEncoder);\n+        this.maxBcryptIteration = maxBcryptIteration;\n+        this.hashAlgorithmsWhitelist = hashAlgorithmsWhitelist;", "originalCommit": "a911de948a7d00fb9f2620d185ebb38a93226698", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwNDM2NA==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484804364", "bodyText": "How about naming this static variable in upper case?", "author": "kaniyan", "createdAt": "2020-09-08T10:08:41Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/credentials/AbstractCredentialsService.java", "diffHunk": "@@ -32,8 +44,13 @@\n  */\n public abstract class AbstractCredentialsService implements CredentialsService {\n \n+    private static final Logger log = LoggerFactory.getLogger(AbstractCredentialsService.class);", "originalCommit": "a911de948a7d00fb9f2620d185ebb38a93226698", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMjM5Nw==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484822397", "bodyText": "First of all, it is not a constant, in the sense of a scalar value constant. Second, we use lowercase log in all other areas of Hono, so I would leave it as is.", "author": "ctron", "createdAt": "2020-09-08T10:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgwNDM2NA=="}], "type": "inlineReview"}, {"oid": "7463b85c22986107a6a4107a7bfc58fceb91a172", "url": "https://github.com/eclipse/hono/commit/7463b85c22986107a6a4107a7bfc58fceb91a172", "message": "Refactor base classes to allow other implementations (JDBC)", "committedDate": "2020-09-08T10:41:58Z", "type": "commit"}, {"oid": "7463b85c22986107a6a4107a7bfc58fceb91a172", "url": "https://github.com/eclipse/hono/commit/7463b85c22986107a6a4107a7bfc58fceb91a172", "message": "Refactor base classes to allow other implementations (JDBC)", "committedDate": "2020-09-08T10:41:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMTQ4NQ==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484831485", "bodyText": "FMPOV we should also make sure that the iterations are within the supported value range, in our case [4, 31].\nHaving read throught the bcrypt documentation again, it seems like the parameter should better be called maxBcryptLogRounds as the number of actual iterations is computed as 2^logRounds ...", "author": "sophokles73", "createdAt": "2020-09-08T11:00:26Z", "path": "services/device-registry-base/src/main/java/org/eclipse/hono/deviceregistry/service/credentials/AbstractCredentialsManagementService.java", "diffHunk": "@@ -43,21 +46,31 @@\n \n     protected TenantInformationService tenantInformationService = new NoopTenantInformationService();\n \n-    private HonoPasswordEncoder passwordEncoder;\n-\n     private final Vertx vertx;\n+    private final HonoPasswordEncoder passwordEncoder;\n+    private final int maxBcryptIteration;\n+    private final Set<String> hashAlgorithmsWhitelist;\n \n     /**\n      * Creates a service for the given Vertx and password encoder instances.\n      *\n      * @param vertx The Vertx instance to use.\n      * @param passwordEncoder The password encoder.\n-     * @throws NullPointerException if any of the parameters is {@code null};\n+     * @param maxBcryptIteration The maximum number of allowed bcrypt iterations.\n+     * @param hashAlgorithmsWhitelist An optional collection of allowed password hashes.\n+     * @throws NullPointerException if any of the required parameters is {@code null};\n      */\n-    @Autowired\n-    public AbstractCredentialsManagementService(final Vertx vertx, final HonoPasswordEncoder passwordEncoder) {\n+    public AbstractCredentialsManagementService(\n+            final Vertx vertx,\n+            final HonoPasswordEncoder passwordEncoder,\n+            final int maxBcryptIteration,\n+            final Set<String> hashAlgorithmsWhitelist) {\n+\n         this.vertx = Objects.requireNonNull(vertx);\n         this.passwordEncoder = Objects.requireNonNull(passwordEncoder);\n+        this.maxBcryptIteration = maxBcryptIteration;", "originalCommit": "7463b85c22986107a6a4107a7bfc58fceb91a172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2NjA0Ng==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484866046", "bodyText": "I would say this is already covered by the configuration, which explicitly checks for that. Also would renaming mean, that we should do that consistently throughout the project. Not only here.\nSo I would say, we keep this PR focused on the current items. And create a new one later for renaming that parameter, which has an impact on documentation and configuration as well.", "author": "ctron", "createdAt": "2020-09-08T12:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMTQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MjcxNw==", "url": "https://github.com/eclipse/hono/pull/2157#discussion_r484992717", "bodyText": "fine with me", "author": "sophokles73", "createdAt": "2020-09-08T15:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMTQ4NQ=="}], "type": "inlineReview"}]}