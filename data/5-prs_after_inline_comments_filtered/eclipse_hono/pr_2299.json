{"pr_number": 2299, "pr_title": "[#2288] Fixing device level QoS forwarding of events for HTTP adapter.", "pr_createdAt": "2020-11-16T08:26:38Z", "pr_url": "https://github.com/eclipse/hono/pull/2299", "timeline": [{"oid": "29740b0acc26bc58b6fa54e640baf76555a58f6b", "url": "https://github.com/eclipse/hono/commit/29740b0acc26bc58b6fa54e640baf76555a58f6b", "message": "[#2288] Fixing device level QoS forwarding of events for HTTP adapter.\n\nThe HTTP adapter suffered from a bug when a client sent an event and set a device level QoS to something different than 1 or set no device level QoS at all. In any case the event was sent with QoS 1 but the message property indicating the device level QoS to the northbound application (which should always be 1 as this is the only supported QoS for events) was wrong.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-16T08:40:38Z", "type": "forcePushed"}, {"oid": "fa28f017f58edac8b12c5b5a9765a438b18a95ee", "url": "https://github.com/eclipse/hono/commit/fa28f017f58edac8b12c5b5a9765a438b18a95ee", "message": "[#2288] Fixing device level QoS forwarding of events for HTTP adapter.\n\nThe HTTP adapter suffered from a bug when a client sent an event and set a device level QoS to something different than 1 or set no device level QoS at all. In any case the event was sent with QoS 1 but the message property indicating the device level QoS to the northbound application (which should always be 1 as this is the only supported QoS for events) was wrong.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-16T09:15:22Z", "type": "commit"}, {"oid": "fa28f017f58edac8b12c5b5a9765a438b18a95ee", "url": "https://github.com/eclipse/hono/commit/fa28f017f58edac8b12c5b5a9765a438b18a95ee", "message": "[#2288] Fixing device level QoS forwarding of events for HTTP adapter.\n\nThe HTTP adapter suffered from a bug when a client sent an event and set a device level QoS to something different than 1 or set no device level QoS at all. In any case the event was sent with QoS 1 but the message property indicating the device level QoS to the northbound application (which should always be 1 as this is the only supported QoS for events) was wrong.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-16T09:15:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTEyNA==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r524025124", "bodyText": "I had imagined to add some assertions to the existing integration tests that we have for uploading telemetry/event messages to adapters. On the consumer side we would simply need to assert that the consumed messages contain the correct value for the qos application property, right?", "author": "sophokles73", "createdAt": "2020-11-16T09:31:51Z", "path": "tests/src/test/java/org/eclipse/hono/tests/http/EventHttpIT.java", "diffHunk": "@@ -52,4 +63,46 @@ protected void assertAdditionalMessageProperties(final Message msg) {\n \n         assertThat(msg.isDurable()).isTrue();\n     }\n+\n+    /**\n+     * Checks that device QoS level is ignored for events.\n+     *\n+     * @param ctx The test context.\n+     *\n+     * @throws InterruptedException if the test fails.\n+     */\n+    @Test\n+    public void testDeviceQosLevelIsIgnored(final VertxTestContext ctx) throws InterruptedException {", "originalCommit": "fa28f017f58edac8b12c5b5a9765a438b18a95ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NzI0Ng==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r524997246", "bodyText": "I took a look on how this could possibly be implemented.\nIn Hono's integration tests base classes there is a method called assertAdditionalMessageProperties. As far as I can see this could be the right place for verifying the qos application property.\nFor this an additional abstract method, say getExpectedQoS, could be defined in the base classes and overridden in the test classes.\nFor this approach to work each test subclass needs to focus on testing with a defined qos (as the abstract method can only be implemented once per subclass), like done in the MQTT Adapter tests: there is a subclass TelemetryMqttQoS1IT and TelemetryMqttQoS0IT.\nConsequently I would need to refactor test classes of all adapters so that they follow the pattern in the MQTT Adapter to put this to work.\nWDYT?", "author": "fkaltner", "createdAt": "2020-11-17T09:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxMjgyMQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r525012821", "bodyText": "I can also imagine adding an assertQosLevel(Message, int) method to the base test classes which is then invoked in addition to the assertAdditionalMessageProperties method. We would then pass the expected QoS level into the generic testUploadMessages method(s) where the downstream consumer is created. We would then not need to refactor all test classes ...", "author": "sophokles73", "createdAt": "2020-11-17T09:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEwMTEwNQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526101105", "bodyText": "Turned out I couldn't implement this strictly following either my or your proposal, since the test cases the different adapters are implement following different approaches.\nI managed to find something I regard as a as-minimal-as-possible-change by fitting the approach to the test case at hand.", "author": "fkaltner", "createdAt": "2020-11-18T13:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTEyNA=="}], "type": "inlineReview"}, {"oid": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "url": "https://github.com/eclipse/hono/commit/71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "message": "Review suggestions:\n- Adapting integration tests of all adapters so that they verify the QoS application property\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-18T13:47:44Z", "type": "commit"}, {"oid": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "url": "https://github.com/eclipse/hono/commit/71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "message": "Review suggestions:\n- Adapting integration tests of all adapters so that they verify the QoS application property\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-18T13:47:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0MDUwMQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526740501", "bodyText": "can we rename qos to expectedQos?", "author": "sophokles73", "createdAt": "2020-11-19T10:10:03Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "diffHunk": "@@ -81,6 +81,10 @@ private void assertMessageProperties(final VertxTestContext ctx, final Message m\n         assertAdditionalMessageProperties(ctx, msg);\n     }\n \n+    private void assertQosLevel(final VertxTestContext ctx, final Message msg, final ProtonQoS qos) {", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NDY2Mw==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526744663", "bodyText": "???", "author": "sophokles73", "createdAt": "2020-11-19T10:16:19Z", "path": "tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttPublishTestBase.java", "diffHunk": "@@ -77,6 +85,7 @@\n      *         message. The future will succeed if the message has been\n      *         published successfully.\n      */\n+    // here", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAzNjg3MQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r527036871", "bodyText": "Thanks for spotting that was a \"note\" I overlooked before committing...", "author": "fkaltner", "createdAt": "2020-11-19T16:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NDY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1NDM5NQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526754395", "bodyText": "qos -> expectedQos", "author": "sophokles73", "createdAt": "2020-11-19T10:31:31Z", "path": "tests/src/test/java/org/eclipse/hono/tests/coap/CoapTestBase.java", "diffHunk": "@@ -922,6 +926,25 @@ private void assertMessageProperties(final VertxTestContext ctx, final Message m\n         assertAdditionalMessageProperties(ctx, msg);\n     }\n \n+    private QoS getExpectedQoS(final QoS qos) {\n+        if (qos != null) {\n+            return qos;\n+        }\n+\n+        switch (getMessageType()) {\n+            case CON:\n+                return QoS.AT_LEAST_ONCE;\n+            case NON:\n+                return QoS.AT_MOST_ONCE;\n+            default:\n+                throw new IllegalArgumentException(\"Either QoS must be non-null or message type must be CON or NON!\");\n+        }\n+    }\n+\n+    private void  assertQosLevel(final VertxTestContext ctx, final Message msg, final QoS qos) {", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1NDY0OQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526754649", "bodyText": "indentation?", "author": "sophokles73", "createdAt": "2020-11-19T10:31:53Z", "path": "tests/src/test/java/org/eclipse/hono/tests/coap/TelemetryCoapIT.java", "diffHunk": "@@ -80,7 +81,7 @@ protected Type getMessageType() {\n      * @throws InterruptedException if the test fails.\n      */\n     @Test\n-    public void testUploadUsingQoS1(final VertxTestContext ctx) throws InterruptedException {\n+        public void testUploadUsingQoS1(final VertxTestContext ctx) throws InterruptedException {", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1NTk5Ng==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526755996", "bodyText": "qos -> expectedQos", "author": "sophokles73", "createdAt": "2020-11-19T10:34:07Z", "path": "tests/src/test/java/org/eclipse/hono/tests/http/HttpTestBase.java", "diffHunk": "@@ -1241,6 +1265,10 @@ private void assertMessageProperties(final VertxTestContext ctx, final Message m\n         });\n     }\n \n+    private void  assertQosLevel(final VertxTestContext ctx, final Message msg, final QoS qos) {", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1NjI0Nw==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526756247", "bodyText": "this is not needed anymore, right?", "author": "sophokles73", "createdAt": "2020-11-19T10:34:31Z", "path": "tests/src/test/java/org/eclipse/hono/tests/http/EventHttpIT.java", "diffHunk": "@@ -52,4 +63,47 @@ protected void assertAdditionalMessageProperties(final Message msg) {\n \n         assertThat(msg.isDurable()).isTrue();\n     }\n+\n+    /**\n+     * Checks that device QoS level is ignored for events.\n+     *\n+     * @param ctx The test context.\n+     *\n+     * @throws InterruptedException if the test fails.\n+     */\n+    @Test\n+    public void testDeviceQosLevelIsIgnored(final VertxTestContext ctx) throws InterruptedException {\n+        final VertxTestContext setup = new VertxTestContext();\n+        final Tenant tenant = new Tenant();\n+        final MultiMap requestHeaders = MultiMap.caseInsensitiveMultiMap()\n+                .add(HttpHeaders.CONTENT_TYPE, \"text/plain\")\n+                .add(HttpHeaders.AUTHORIZATION, authorization)\n+                .add(HttpHeaders.ORIGIN, ORIGIN_URI)\n+                .add(Constants.HEADER_QOS_LEVEL, String.valueOf(QoS.AT_MOST_ONCE.ordinal()));\n+\n+        helper.registry.addDeviceForTenant(tenantId, tenant, deviceId, PWD).onComplete(setup.completing());\n+\n+        assertThat(setup.awaitCompletion(5, TimeUnit.SECONDS)).isTrue();\n+        if (setup.failed()) {\n+            ctx.failNow(setup.causeOfFailure());\n+            return;\n+        }\n+\n+        testUploadMessages(ctx, tenantId,\n+                msg -> {\n+                    ctx.verify(() -> {\n+                        assertThat(msg.getApplicationProperties().getValue().get(MessageHelper.APP_PROPERTY_QOS))", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1OTI0OQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r526759249", "bodyText": "then it is probably not the expected QoS but simply the QoS, right?", "author": "sophokles73", "createdAt": "2020-11-19T10:39:15Z", "path": "tests/src/test/java/org/eclipse/hono/tests/mqtt/MqttPublishTestBase.java", "diffHunk": "@@ -66,6 +67,13 @@\n     // <MQTT message ID, PUBACK handler>\n     private final Map<Integer, Handler<Integer>> pendingMessages = new HashMap<>();\n \n+    /**\n+     * Gets the QoS level with which the MQTT message shall be sent.\n+     *\n+     * @return The QoS level.\n+     */\n+    protected abstract MqttQoS getExpectedQos();", "originalCommit": "71e90f11c2ecd0c75dc5af73f6860eb13bcf774f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAzNzU2Nw==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r527037567", "bodyText": "Actually it is both as the QoS to be expected should be the one with the message was sent. I am fine with renaming though.", "author": "fkaltner", "createdAt": "2020-11-19T16:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1OTI0OQ=="}], "type": "inlineReview"}, {"oid": "f4040dbd77318a3d7103455fdcc4d6200f0a336b", "url": "https://github.com/eclipse/hono/commit/f4040dbd77318a3d7103455fdcc4d6200f0a336b", "message": "Review suggestions:\n- Renaming qos parameter to expectedQos\n- Removing obsolete comment\n- Fixing ident\n- Removing obsolete assert on message\n- Renaming method getExpectedQos -> getQos\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-19T17:05:38Z", "type": "commit"}, {"oid": "f4040dbd77318a3d7103455fdcc4d6200f0a336b", "url": "https://github.com/eclipse/hono/commit/f4040dbd77318a3d7103455fdcc4d6200f0a336b", "message": "Review suggestions:\n- Renaming qos parameter to expectedQos\n- Removing obsolete comment\n- Fixing ident\n- Removing obsolete assert on message\n- Renaming method getExpectedQos -> getQos\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-19T17:05:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MTE3OQ==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r527651179", "bodyText": "the QoS of the sender is being set when opening the sender link. Setting this property after the link has been established has no impact.", "author": "sophokles73", "createdAt": "2020-11-20T12:12:01Z", "path": "tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpUploadTestBase.java", "diffHunk": "@@ -355,6 +360,7 @@ private void testUploadMessages(\n             msg.setAddress(getEndpointName());\n             final Promise<?> sendingComplete = Promise.promise();\n             final Handler<ProtonSender> sendMsgHandler = replenishedSender -> {\n+                replenishedSender.setQoS(senderQoS);", "originalCommit": "f4040dbd77318a3d7103455fdcc4d6200f0a336b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4OTA3Nw==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r527689077", "bodyText": "While it might be true what you are saying, setting this property does have an impact:\nIf you comment this line the test will actually fail, because the forwarded application QoS property does not match the expected value.\nIn order to double check I inserted two debug log statements in VertxBasedAmqpProtocolAdapter on line 1112 and 1116 printing out whether the message is sent as AT_LEAST_ONCE or as AT_MOST_ONCE.\nWhen also removing the AT_LEAST_ONCE QoS in TelemetryAmqpIT's senderQoSTypes() method I observe that all messages are sent with AT_LEAST_ONCE QoS in the AMQP protocol adapter's log and also the test fails.\nI ran the test with: mvn verify -Prun-tests,jaeger,useRunningContainers -Ddocker.keepRunning -Dit.test=TelemetryAmqpIT#testUploadMessagesUsingSaslPlain\nMaybe this is a side-effect? Or is it a problem with my machine?", "author": "fkaltner", "createdAt": "2020-11-20T13:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MTE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMDA0Ng==", "url": "https://github.com/eclipse/hono/pull/2299#discussion_r527800046", "bodyText": "Oh, you are working on the 1.3.x branch. In 1.3.x the AMQP adapter only supports opening link with sender-settle-mode unsettled (see \n  \n    \n      hono/tests/src/test/java/org/eclipse/hono/tests/amqp/AmqpAdapterTestBase.java\n    \n    \n         Line 123\n      in\n      c63b042\n    \n    \n    \n    \n\n        \n          \n           protected Future<ProtonSender> createProducer(final String target, final ProtonQoS senderQos) { \n        \n    \n  \n\n). We are therefore not able to send settled messages from the test case. I guess it only makes sense to check for the correct QoS level in downstream messages for message being sent with AT_LEAST_ONCE semantics ...\nFor 1.5.0, we have changed the AMQP adapter to now also accept links with snd-settle-mode settled, your test should therefore work on master. However, I am afraid that it will also not work on 1.4.x", "author": "sophokles73", "createdAt": "2020-11-20T16:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MTE3OQ=="}], "type": "inlineReview"}, {"oid": "dc1ce1f81c8ba53cf5d0b637b3f26a3e3c8c2e58", "url": "https://github.com/eclipse/hono/commit/dc1ce1f81c8ba53cf5d0b637b3f26a3e3c8c2e58", "message": "Review suggestions:\n- Verifying that QoS is always AT_LEAST_ONCE for AMQP adapter as it only supports opening links with sender-settle-mode unsettled.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-23T07:51:35Z", "type": "commit"}, {"oid": "00d4b942e0a528eb34c374101825bf9f9f999590", "url": "https://github.com/eclipse/hono/commit/00d4b942e0a528eb34c374101825bf9f9f999590", "message": "Review suggestions:\n- Adding release notes\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-23T08:51:37Z", "type": "commit"}]}