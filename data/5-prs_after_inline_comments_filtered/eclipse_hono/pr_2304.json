{"pr_number": 2304, "pr_title": "#2301 auto provisioning status properties integration tests", "pr_createdAt": "2020-11-17T16:06:25Z", "pr_url": "https://github.com/eclipse/hono/pull/2304", "timeline": [{"oid": "dea8af01d4b23fda39bf0142af8907aa409c592d", "url": "https://github.com/eclipse/hono/commit/dea8af01d4b23fda39bf0142af8907aa409c592d", "message": "#2301 Replacing \"dummy\" implementation of auto-provisioning properties in FileBasedRegistrationService\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-17T15:58:37Z", "type": "commit"}, {"oid": "642b40f1b360c5d4141cb74edb10d96f5996f5ab", "url": "https://github.com/eclipse/hono/commit/642b40f1b360c5d4141cb74edb10d96f5996f5ab", "message": "#2301 Adding assertions for auto-provisioning status properties to integration tests\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-17T16:04:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5Mjc2MA==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526692760", "bodyText": "is there a reason why this method returns a DeviceDto while forUpdate returns a FileBasedDeviceDto?", "author": "sophokles73", "createdAt": "2020-11-19T08:57:10Z", "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -707,47 +705,57 @@ public String toString() {\n      */\n     private String generateDeviceId(final String tenantId) {\n \n-        final ConcurrentMap<String, FileBasedDeviceDto> devices = getDevicesForTenant(tenantId);\n+        final ConcurrentMap<String, DeviceDto> devices = getDevicesForTenant(tenantId);\n         String tempDeviceId;\n         do {\n             tempDeviceId = UUID.randomUUID().toString();\n         } while (devices.containsKey(tempDeviceId));\n         return tempDeviceId;\n     }\n \n-    private static final class FileBasedDeviceDto extends BaseDto<Versioned<Device>> {\n+    private static final class FileBasedDeviceDto extends DeviceDto {\n \n         FileBasedDeviceDto() {\n         }\n \n+        public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject entry) {", "originalCommit": "642b40f1b360c5d4141cb74edb10d96f5996f5ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2NjM1OA==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527066358", "bodyText": "Yes, I was reluctant to change the signature of DeviceDto's forUpdate method taking a Supplier as this leads to changes in JDBC and MongoDb registry and I didn't want to do this because of a the file based registry which is just for \"playing around\" \ud83d\ude10.\nBut as you said below, it seems like this is too confusing. I adapted the implementation to use FileBasedDeviceDto everywhere.", "author": "fkaltner", "createdAt": "2020-11-19T17:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5Mjc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NDExOQ==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526694119", "bodyText": "to me it is very confusing that in some places we use DeviceDto while in others we use FileBasedDeviceDto. Can't we only use FileBasedDeviceDto?", "author": "sophokles73", "createdAt": "2020-11-19T08:59:09Z", "path": "services/device-registry-file/src/main/java/org/eclipse/hono/deviceregistry/file/FileBasedRegistrationService.java", "diffHunk": "@@ -75,7 +73,7 @@\n     private static final Logger LOG = LoggerFactory.getLogger(FileBasedRegistrationService.class);\n \n     // <tenantId, <deviceId, registrationData>>\n-    private final ConcurrentMap<String, ConcurrentMap<String, FileBasedDeviceDto>> identities = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<String, ConcurrentMap<String, DeviceDto>> identities = new ConcurrentHashMap<>();", "originalCommit": "642b40f1b360c5d4141cb74edb10d96f5996f5ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2NjQ0NQ==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527066445", "bodyText": "see above.", "author": "fkaltner", "createdAt": "2020-11-19T17:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NjQxMQ==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r526696411", "bodyText": "currently, the Device Registry Management API does not require the status property to be present in the response body. It also doesn't mention the autoprovisioned and autoprovisioningnotificationsent property at all.\nSo, IMHO we need to add these properties to the API spec, if they indeed can be returned by a registry implementation.", "author": "sophokles73", "createdAt": "2020-11-19T09:02:41Z", "path": "tests/src/test/java/org/eclipse/hono/tests/registry/DeviceManagementIT.java", "diffHunk": "@@ -734,11 +735,19 @@ private static String assertLocationHeader(final MultiMap responseHeaders, final\n         return generatedId;\n     }\n \n-    private static void assertRegistrationInformation(final Device response, final Device expectedData) {\n+    private static void assertRegistrationInformation(final HttpResponse<Buffer> response, final Device expectedData) {\n \n+        final JsonObject actualDeviceJson = response.bodyAsJsonObject();\n+\n+        // internal status is not decoded from JSON as users should not be allowed to change internal status\n+        final JsonObject actualDeviceStatus = actualDeviceJson.getJsonObject(RegistryManagementConstants.FIELD_STATUS);\n+        assertThat(actualDeviceStatus.getBoolean(RegistryManagementConstants.FIELD_AUTO_PROVISIONED)).isFalse();", "originalCommit": "642b40f1b360c5d4141cb74edb10d96f5996f5ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5MDU4Mg==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527090582", "bodyText": "Sure, makes sense.\nI just became confused again: should the properties be camelCased or kebab-cased? I am asking since I noticed that last-user is kebab-cased the rest is camelCased.\nBy majority decision counting the properties by case I think it is camelCased? \ud83d\ude04", "author": "fkaltner", "createdAt": "2020-11-19T18:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NjQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0NTg2Mg==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527545862", "bodyText": "camel case, yes. last-user should be changed to lastUser FMPOV. But we will handle that in another issue: #2309", "author": "sophokles73", "createdAt": "2020-11-20T09:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY5NjQxMQ=="}], "type": "inlineReview"}, {"oid": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "url": "https://github.com/eclipse/hono/commit/bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "message": "Review suggestions:\n- Using FileBasedDeviceDto everywhere\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-19T17:32:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNzI0NQ==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527537245", "bodyText": "shouldn't this method return a JdbcBasedDeviceDto?", "author": "sophokles73", "createdAt": "2020-11-20T08:58:37Z", "path": "services/base-jdbc/src/main/java/org/eclipse/hono/service/base/jdbc/store/model/JdbcBasedDeviceDto.java", "diffHunk": "@@ -57,7 +57,7 @@ public static JdbcBasedDeviceDto forCreation(final DeviceKey deviceKey, final Bo\n      */\n     public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject recordJson) {\n \n-        return DeviceDto.forRead(tenantId,\n+        return DeviceDto.forRead(DeviceDto::new, tenantId,", "originalCommit": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0NzIwOQ==", "url": "https://github.com/eclipse/hono/pull/2304#discussion_r527547209", "bodyText": "shouldn't this method return a MongoDbBasedDeviceDto?", "author": "sophokles73", "createdAt": "2020-11-20T09:07:32Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/model/MongoDbBasedDeviceDto.java", "diffHunk": "@@ -44,7 +44,7 @@ public MongoDbBasedDeviceDto() {\n      */\n     public static DeviceDto forRead(final String tenantId, final String deviceId, final JsonObject recordJson) {\n \n-        return DeviceDto.forRead(tenantId,\n+        return DeviceDto.forRead(DeviceDto::new, tenantId,", "originalCommit": "bcfd2c62a65e0b825c29098f35dca8dcaec142a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f1038cc9b97d2b27de46bbacb732b87564d82ef", "url": "https://github.com/eclipse/hono/commit/3f1038cc9b97d2b27de46bbacb732b87564d82ef", "message": "Review suggestions:\n- Adding auto-provisioning properties to API spec\n- Returning JdbcBasedDeviceDto / MongoDbBasedDeviceDto in their forRead methods\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-20T09:34:38Z", "type": "commit"}, {"oid": "2991ad051b871ebedd54eed9fa7a5764609fd612", "url": "https://github.com/eclipse/hono/commit/2991ad051b871ebedd54eed9fa7a5764609fd612", "message": "Review suggestions:\n- Bumping API Spec version to 1.5.0\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-11-20T10:04:08Z", "type": "commit"}]}