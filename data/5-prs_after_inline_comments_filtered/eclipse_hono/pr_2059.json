{"pr_number": 2059, "pr_title": "[#2049] Adding AMQP application property \"qos\" for northbound consumers", "pr_createdAt": "2020-06-29T17:14:04Z", "pr_url": "https://github.com/eclipse/hono/pull/2059", "timeline": [{"oid": "e399da66a1352f4a2eadf9e93647b7adc3173f0c", "url": "https://github.com/eclipse/hono/commit/e399da66a1352f4a2eadf9e93647b7adc3173f0c", "message": "[#2049] Adding AMQP application property \"qos\" for northbound consumers\n\nAdding a new application property \"qos\" which enables northbound consumers to obtain the QoS level set by the device when it sent a message to a protocol adapter.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-06-29T17:32:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MTIxOQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448181219", "bodyText": "IMHO we should add this method to ExecutionContext because it is a general requirement for all adapters/protocols.", "author": "sophokles73", "createdAt": "2020-07-01T07:50:41Z", "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/CoapContext.java", "diffHunk": "@@ -307,4 +308,13 @@ private Integer getIntegerQueryParameter(final String parameterName) {\n                 .orElse(null);\n     }\n \n+    /**\n+     * Get the QoS level as set in the request by the device.\n+     *\n+     * @return The QoS level requested by the device.\n+     */\n+    public QoS getRequestedQos() {", "originalCommit": "e399da66a1352f4a2eadf9e93647b7adc3173f0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg0NTM5NA==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448845394", "bodyText": "Are you working on this? I can't find a corresponding change in your latest push?", "author": "sophokles73", "createdAt": "2020-07-02T08:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MTIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3MzQ4Mg==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448873482", "bodyText": "Yes, I do! I will push a separate commit containing the QoS changes soon.", "author": "fkaltner", "createdAt": "2020-07-02T09:30:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MTIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5ODgxMQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448898811", "bodyText": "There you go, see: 9bb5266\nLet me know what you think about the two QoS classes and the NOT_APPLICABLE and the UNKNOWN levels", "author": "fkaltner", "createdAt": "2020-07-02T10:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MTIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5MDk2MA==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449990960", "bodyText": "Since this is the only conversation left unresolved: is there something I missed or are you still reviewing?", "author": "fkaltner", "createdAt": "2020-07-06T05:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MTIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MjM1Mg==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448182352", "bodyText": "Can you please always use present tense active form? In this case\n\nGets the quality of service level corresponding to the delivery semantics specified by the device in its request to upload data.\n\nThis applies to most (all) of your JavaDoc comments ...", "author": "sophokles73", "createdAt": "2020-07-01T07:52:44Z", "path": "adapters/coap-vertx-base/src/main/java/org/eclipse/hono/adapter/coap/CoapContext.java", "diffHunk": "@@ -307,4 +308,13 @@ private Integer getIntegerQueryParameter(final String parameterName) {\n                 .orElse(null);\n     }\n \n+    /**\n+     * Get the QoS level as set in the request by the device.", "originalCommit": "e399da66a1352f4a2eadf9e93647b7adc3173f0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0NDQ0NA==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448244444", "bodyText": "Will do.", "author": "fkaltner", "createdAt": "2020-07-01T09:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4MjM1Mg=="}], "type": "inlineReview"}, {"oid": "d2d7e5976deeaa29aa41a5aeef13596190de0643", "url": "https://github.com/eclipse/hono/commit/d2d7e5976deeaa29aa41a5aeef13596190de0643", "message": "[#2049] Using HttpContext in HTTP adapter\n\nThis is done to make the implementation consistent to the other protocol adapters.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-01T09:21:59Z", "type": "forcePushed"}, {"oid": "32c09f2a2331ebcd8270bb20f599b140bdf40de0", "url": "https://github.com/eclipse/hono/commit/32c09f2a2331ebcd8270bb20f599b140bdf40de0", "message": "[#2049] Using HttpContext in HTTP adapter\n\nThis is done to make the implementation consistent to the other protocol adapters.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-01T09:28:17Z", "type": "forcePushed"}, {"oid": "ba7f8af538cc4e337b00e1b445bdccb52facc05a", "url": "https://github.com/eclipse/hono/commit/ba7f8af538cc4e337b00e1b445bdccb52facc05a", "message": "[#2049] Using HttpContext in HTTP adapter\n\nThis is done to make the implementation consistent to the other protocol adapters.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-01T09:40:11Z", "type": "forcePushed"}, {"oid": "47ac3e6e627840fb6c5abe80f5e91a0e256ab5e2", "url": "https://github.com/eclipse/hono/commit/47ac3e6e627840fb6c5abe80f5e91a0e256ab5e2", "message": "[#2049] Using HttpContext in HTTP adapter\n\nThis is done to make the implementation consistent to the other protocol adapters in order to facilitate the implementation of #2049.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-02T06:37:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzNzQ1Nw==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448937457", "bodyText": "This is a new class, thus the date range only contains the date of inception, i.e.\n\nCopyright (c) 2020 Contributors ...", "author": "sophokles73", "createdAt": "2020-07-02T11:35:08Z", "path": "core/src/main/java/org/eclipse/hono/util/QoS.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2016, 2020 Contributors to the Eclipse Foundation", "originalCommit": "9bb52667bc40596ac6a5a8770ee2fc65fc0066dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTMxNg==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448939316", "bodyText": "there is no official mapping of numbers to QoS levels. I would therefore suggest to rename this method to fromMqttQosLevel as that is what the number is expected to be, isn't it? And also update the JavaDocs accordingly ...", "author": "sophokles73", "createdAt": "2020-07-02T11:39:01Z", "path": "core/src/main/java/org/eclipse/hono/util/QoS.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2016, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.util;\n+\n+/**\n+ * Denotes the QoS level with which a message was sent by the device.\n+ */\n+public enum QoS {\n+\n+    AT_MOST_ONCE,\n+    AT_LEAST_ONCE,\n+    /**\n+     * Indicates the QoS is not settable by the device.\n+     */\n+    NOT_APPLICABLE,\n+    /**\n+     * Indicates that the device set a QoS level which is not known or supported.\n+     */\n+    UNKNOWN;\n+\n+    /**\n+     * Derive the QoS level from the given number.", "originalCommit": "9bb52667bc40596ac6a5a8770ee2fc65fc0066dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1NDA5NQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449154095", "bodyText": "Makes sense, yes this is used for MQTT only.", "author": "fkaltner", "createdAt": "2020-07-02T17:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2NTYwMA==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449565600", "bodyText": "After a closer look it turned out that this method was in fact used in the HTTP adapter. The HTTP adapter accidentally (I guess) shares its QoS level definition with MQTT.\nI think it makes more sense to have this in the corresponding Context implementations, since it is protocol specific.", "author": "fkaltner", "createdAt": "2020-07-03T12:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTc4NQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448939785", "bodyText": "this is `EXACTLY_ONCE* delivery semantics. Whether or not it is applicable or supported should be determined by the component using this enum, shouldn't it?", "author": "sophokles73", "createdAt": "2020-07-02T11:40:02Z", "path": "core/src/main/java/org/eclipse/hono/util/QoS.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2016, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.util;\n+\n+/**\n+ * Denotes the QoS level with which a message was sent by the device.\n+ */\n+public enum QoS {\n+\n+    AT_MOST_ONCE,\n+    AT_LEAST_ONCE,\n+    /**\n+     * Indicates the QoS is not settable by the device.\n+     */\n+    NOT_APPLICABLE,\n+    /**\n+     * Indicates that the device set a QoS level which is not known or supported.\n+     */\n+    UNKNOWN;\n+\n+    /**\n+     * Derive the QoS level from the given number.\n+     *\n+     * @param number The number denoting the QoS level.\n+     *\n+     * @return The QoS level derived from the given number.\n+     */\n+    public static QoS from(final int number) {\n+        switch (number) {\n+            case 0:\n+                return AT_MOST_ONCE;\n+            case 1:\n+                return AT_LEAST_ONCE;\n+            case 2:\n+                return NOT_APPLICABLE;", "originalCommit": "9bb52667bc40596ac6a5a8770ee2fc65fc0066dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE1ODQ2Mg==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449158462", "bodyText": "Yes, from the ordinal of the enum that's right.\nLet's ignore the ordinal for now: the reason why I introduced this was that I stumbled upon sendTtdEvent() in AbstractProtocolAdapterBase and sendNotificationEvent in AbstractMessageSenderConnectionEventProducer.\nAre TTD and connection events something which will arrive at the northbound application? Should the qos application property be set for those events as well?", "author": "fkaltner", "createdAt": "2020-07-02T17:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NTY0NQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449445645", "bodyText": "Yes, both are supposed to be consumed by downstream applications. AFAIC they should thus also contain the qos property.", "author": "sophokles73", "createdAt": "2020-07-03T08:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2NjA1Ng==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449566056", "bodyText": "Alright, set their QoS to AT_LEAST_ONCE, since they use EventSenderImpl which send AMQP messages with ProtonQoS.AT_LEAST_ONCE.", "author": "fkaltner", "createdAt": "2020-07-03T12:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkzOTc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MTQ3Nw==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448941477", "bodyText": "we should support AT_MOST_ONCE and EXACTLY_ONCE explicitly here FMPOV", "author": "sophokles73", "createdAt": "2020-07-02T11:43:40Z", "path": "adapters/mqtt-vertx-base/src/main/java/org/eclipse/hono/adapter/mqtt/MqttContext.java", "diffHunk": "@@ -45,6 +46,19 @@\n     private MqttContext() {\n     }\n \n+    @Override\n+    public QoS getRequestedQos() {\n+\n+        switch (message.qosLevel()) {\n+            case AT_LEAST_ONCE:\n+                return QoS.AT_LEAST_ONCE;\n+            default:", "originalCommit": "9bb52667bc40596ac6a5a8770ee2fc65fc0066dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MzE5Mw==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r448943193", "bodyText": "are the public methods supposed to be overridden by subclasses? If not, then either the whole class or the public methods should be final ...", "author": "sophokles73", "createdAt": "2020-07-02T11:47:14Z", "path": "service-base/src/main/java/org/eclipse/hono/service/http/HttpContext.java", "diffHunk": "@@ -73,4 +89,137 @@ public void setTracingContext(final SpanContext spanContext) {\n     public SpanContext getTracingContext() {\n         return spanContext;\n     }\n+\n+    @Override\n+    public QoS getRequestedQos() {", "originalCommit": "9bb52667bc40596ac6a5a8770ee2fc65fc0066dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE2MDA5Mw==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449160093", "bodyText": "Based on today's Community call: @ctron mentioned that this will cause problems with Quarkus (native). I see your point (I guess: \"Design for inheritance, or prohibit it\") but wasn't sure anymore after the discussion.", "author": "fkaltner", "createdAt": "2020-07-02T17:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MzE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NDcwNw==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449444707", "bodyText": "Let's wait and see what happens with the Quarkus story ... in the meantime I suggest to follow good design practice here :-)", "author": "sophokles73", "createdAt": "2020-07-03T08:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk0MzE5Mw=="}], "type": "inlineReview"}, {"oid": "4b3ac2e22f062995f9dad76ff4eedbe94ba3a3e3", "url": "https://github.com/eclipse/hono/commit/4b3ac2e22f062995f9dad76ff4eedbe94ba3a3e3", "message": "[#2049] Adding AMQP application property \"qos\" for northbound consumers\n\nAdding a new application property \"qos\" which enables northbound consumers to obtain the QoS level set by the device when it sent a message to a protocol adapter.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-03T12:43:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3MTAzMQ==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449571031", "bodyText": "is qos allowed to be null? If yes, then we should mention it here explicitly\n\n... or {@code null} if unknown.\n\nIf not, then we should document this by means of declaring an NPE and also checking for null before starting to process the parameters.", "author": "sophokles73", "createdAt": "2020-07-03T12:59:08Z", "path": "core/src/main/java/org/eclipse/hono/util/MessageHelper.java", "diffHunk": "@@ -922,9 +927,10 @@ public static Object getCorrelationId(final Message message) {\n      * Creates an AMQP 1.0 message.\n      * <p>\n      * This method simply calls\n-     * {@link #newMessage(ResourceIdentifier, String, String, Buffer, TenantObject, JsonObject, Integer, Duration, String, boolean, boolean)}\n+     * {@link #newMessage(QoS, ResourceIdentifier, String, String, Buffer, TenantObject, JsonObject, Integer, Duration, String, boolean, boolean)}\n      * to create the AMQP 1.0 message.\n      *\n+     * @param qos The QoS level with which the device sent the message to the protocol adapter.", "originalCommit": "4b3ac2e22f062995f9dad76ff4eedbe94ba3a3e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3MjAwMA==", "url": "https://github.com/eclipse/hono/pull/2059#discussion_r449572000", "bodyText": "same here, document null value behavior", "author": "sophokles73", "createdAt": "2020-07-03T13:01:23Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -1171,9 +1172,10 @@ private boolean isGatewaySupportedForDevice(final JsonObject registrationAsserti\n      * Subclasses are encouraged to use this method for creating {@code Message} instances to be sent downstream in\n      * order to have required Hono specific properties being set on the message automatically.\n      * <p>\n-     * This method simply delegates to {@link #newMessage(ResourceIdentifier, String, String, Buffer, TenantObject,\n+     * This method simply delegates to {@link #newMessage(QoS, ResourceIdentifier, String, String, Buffer, TenantObject,\n      * JsonObject, Integer, Duration)}.\n      *\n+     * @param qos The QoS level with which the device sent the message to the protocol adapter.", "originalCommit": "4b3ac2e22f062995f9dad76ff4eedbe94ba3a3e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc3f283d1abc78691d1bef47b4c48b43059ff6c6", "url": "https://github.com/eclipse/hono/commit/cc3f283d1abc78691d1bef47b4c48b43059ff6c6", "message": "[#2049] Using HttpContext in HTTP adapter\n\nThis is done to make the implementation consistent to the other protocol adapters in order to facilitate the implementation of #2049.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-07T07:33:26Z", "type": "commit"}, {"oid": "2a1ce0a156be11de3183e9a5263e659fc3e32cc6", "url": "https://github.com/eclipse/hono/commit/2a1ce0a156be11de3183e9a5263e659fc3e32cc6", "message": "[#2049] Adding AMQP application property \"qos\" for northbound consumers\n\nAdding a new application property \"qos\" which enables northbound consumers to obtain the QoS level set by the device when it sent a message to a protocol adapter.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-07T07:33:26Z", "type": "commit"}, {"oid": "2a1ce0a156be11de3183e9a5263e659fc3e32cc6", "url": "https://github.com/eclipse/hono/commit/2a1ce0a156be11de3183e9a5263e659fc3e32cc6", "message": "[#2049] Adding AMQP application property \"qos\" for northbound consumers\n\nAdding a new application property \"qos\" which enables northbound consumers to obtain the QoS level set by the device when it sent a message to a protocol adapter.\n\nThis fixes #2049\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-07-07T07:33:26Z", "type": "forcePushed"}]}