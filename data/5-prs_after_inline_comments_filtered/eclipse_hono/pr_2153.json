{"pr_number": 2153, "pr_title": "Improve Command & Control related tracing.", "pr_createdAt": "2020-09-04T04:54:00Z", "pr_url": "https://github.com/eclipse/hono/pull/2153", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ0OTU2NQ==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483449565", "bodyText": "FMPOV the cause (Throwable) should be logged here as intended by the OpenTracing spec, i.e. using Fields.ERROR_KIND and Fields.ERROR_OBJECT to be consistent with other cases where we use TracingHelper.log(Throwable). We might want to consider adding Fields.STACK to that method as well ...", "author": "sophokles73", "createdAt": "2020-09-04T07:51:21Z", "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -975,24 +974,34 @@ protected void setNonEmptyResponsePayload(final HttpServerResponse response, fin\n             }\n             return Future.succeededFuture();\n         }\n+        uploadMessageSpan.setTag(MessageHelper.APP_PROPERTY_DEVICE_TTD, ttdSecs);\n+\n+        final Span waitForCommandSpan = TracingHelper\n+                .buildChildSpan(tracer, uploadMessageSpan.context(),\n+                        \"wait for command\", getTypeName())\n+                .withTag(Tags.SPAN_KIND.getKey(), Tags.SPAN_KIND_CLIENT)\n+                .withTag(TracingHelper.TAG_TENANT_ID, tenantObject.getTenantId())\n+                .withTag(TracingHelper.TAG_DEVICE_ID, deviceId)\n+                .start();\n \n-        currentSpan.setTag(MessageHelper.APP_PROPERTY_DEVICE_TTD, ttdSecs);\n         final Handler<CommandContext> commandHandler = commandContext -> {\n \n             Tags.COMPONENT.set(commandContext.getTracingSpan(), getTypeName());\n             final Command command = commandContext.getCommand();\n             final Sample commandSample = getMetrics().startTimer();\n-            if (isCommandValid(command, currentSpan)) {\n+            if (isCommandValid(command, waitForCommandSpan)) {\n \n                 if (requestProcessed.compareAndSet(false, true)) {\n-                    checkMessageLimit(tenantObject, command.getPayloadSize(), currentSpan.context())\n+                    CommandConsumer.logReceivedCommandToSpan(command, waitForCommandSpan);\n+                    checkMessageLimit(tenantObject, command.getPayloadSize(), waitForCommandSpan.context())\n                     .onComplete(result -> {\n                         if (result.succeeded()) {\n                             addMicrometerSample(commandContext, commandSample);\n                             // put command context to routing context and notify\n                             ctx.put(CommandContext.KEY_COMMAND_CONTEXT, commandContext);\n                         } else {\n                             commandContext.reject(getErrorCondition(result.cause()));\n+                            waitForCommandSpan.log(\"rejected command for device: \" + result.cause());", "originalCommit": "5c68a75cadf4ec47757e9940afb374d6d77dbfff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2OTExMw==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483469113", "bodyText": "I think the stack is not important here. The log message is supposed to contain result.cause().toString().\nConcerning the \"ERROR_KIND\" and \"ERROR_OBJECT\" fields: These would of course be set if  Tracing.logError was used here. I didn't want to use this because I didn't want the HTTP PUT span to be marked as an error span in this case (that wasn't done so before).\nBut thinking again, I think this case should indeed be marked as an error span, reflecting the \"check message limit failed\" error. I have adapted the commit accordingly, also setting an error for the \"received invalid command message\" case.", "author": "calohmn", "createdAt": "2020-09-04T08:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ0OTU2NQ=="}], "type": "inlineReview"}, {"oid": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "url": "https://github.com/eclipse/hono/commit/f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-04T08:28:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNDMzNw==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483504337", "bodyText": "The command is invalid in this case, isn't it? Shouldn't this result in an error being logged to the span?", "author": "sophokles73", "createdAt": "2020-09-04T09:33:07Z", "path": "adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java", "diffHunk": "@@ -1020,6 +1029,9 @@ protected void setNonEmptyResponsePayload(final HttpServerResponse response, fin\n                 }\n \n             } else {\n+                if (!requestProcessed.get()) {\n+                    CommandConsumer.logReceivedCommandToSpan(command, waitForCommandSpan);", "originalCommit": "f187a5b07ba4e9987b0129d2a51c96ff268b8b02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNTMxNA==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483505314", "bodyText": "Yes, logReceivedCommandToSpan does  that.", "author": "calohmn", "createdAt": "2020-09-04T09:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNDMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwODIwMg==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483508202", "bodyText": "I see. Then FMPOV we should pull up the CommandConsumer.logReceivedCommandToSpan(command, waitForCommandSpan) invocation before the if (isCommandValid(command, waitForCommandSpan)) statement and explicitly log the fact that the request has already been processed and the command is being released. WDYT?", "author": "sophokles73", "createdAt": "2020-09-04T09:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNDMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3OTgyOQ==", "url": "https://github.com/eclipse/hono/pull/2153#discussion_r483579829", "bodyText": "I've amended the commit accordingly.", "author": "calohmn", "createdAt": "2020-09-04T12:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwNDMzNw=="}], "type": "inlineReview"}, {"oid": "ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "url": "https://github.com/eclipse/hono/commit/ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-04T12:17:47Z", "type": "commit"}, {"oid": "ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "url": "https://github.com/eclipse/hono/commit/ffb5389a0668d5f8ae66163d3d27ed343f0b4f2f", "message": "Improve Command & Control related tracing.\n\nThe HTTP adapter now tracks the reception of a\ncommand in a separate span.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-04T12:17:47Z", "type": "forcePushed"}]}