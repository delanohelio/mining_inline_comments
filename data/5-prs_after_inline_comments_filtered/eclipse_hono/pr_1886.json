{"pr_number": 1886, "pr_title": "[#1679] Add implementation to resolve group members in MongoDB based device registry", "pr_createdAt": "2020-04-08T08:46:19Z", "pr_url": "https://github.com/eclipse/hono/pull/1886", "timeline": [{"oid": "85d214641e36a97cb359a9f048149dcaf586f373", "url": "https://github.com/eclipse/hono/commit/85d214641e36a97cb359a9f048149dcaf586f373", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-08T08:47:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTAwOQ==", "url": "https://github.com/eclipse/hono/pull/1886#discussion_r405505009", "bodyText": "The span should already be tagged with the tenant ID.", "author": "sophokles73", "createdAt": "2020-04-08T13:00:11Z", "path": "services/device-registry-mongodb/src/main/java/org/eclipse/hono/deviceregistry/mongodb/service/MongoDbBasedRegistrationService.java", "diffHunk": "@@ -314,6 +319,35 @@ private boolean isDuplicateKeyError(final Throwable throwable) {\n                                 Optional.ofNullable(deviceDto.getVersion()))));\n     }\n \n+    private Future<JsonArray> processResolveGroupMembers(final String tenantId, final JsonArray viaGroups,\n+            final Span span) {\n+        final JsonObject resolveGroupMembersQuery = new MongoDbDocumentBuilder()\n+                .withTenantId(tenantId).document()\n+                .put(String.format(\"%s.%s\", MongoDbDeviceRegistryUtils.FIELD_DEVICE,\n+                        RegistryManagementConstants.FIELD_MEMBER_OF),\n+                        new JsonObject()\n+                                .put(\"$exists\", true)\n+                                .put(\"$in\", viaGroups));\n+        //Retrieve only the deviceId instead of the whole document.\n+        final FindOptions findOptionsForDeviceId = new FindOptions()\n+                .setFields(new JsonObject().put(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID, true).put(\"_id\", false));\n+        final Promise<List<JsonObject>> resolveGroupMembersPromise = Promise.promise();\n+\n+        mongoClient.findWithOptions(config.getCollectionName(), resolveGroupMembersQuery, findOptionsForDeviceId,\n+                resolveGroupMembersPromise);\n+\n+        return resolveGroupMembersPromise.future()\n+                .map(deviceIdsList -> {\n+                    final JsonArray deviceIds = Optional.ofNullable(deviceIdsList)\n+                            .map(ok -> deviceIdsList.stream()\n+                                    .map(json -> json.getString(RegistrationConstants.FIELD_PAYLOAD_DEVICE_ID))\n+                                    .collect(Collectors.collectingAndThen(Collectors.toList(), JsonArray::new)))\n+                            .orElse(new JsonArray());\n+                    span.log(String.format(\"successfully resolved group members for the tenant [%s]\", tenantId));", "originalCommit": "85d214641e36a97cb359a9f048149dcaf586f373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzODM2Ng==", "url": "https://github.com/eclipse/hono/pull/1886#discussion_r405538366", "bodyText": "Since the tenant ID is already being tagged, now I have removed logging the tenant ID and pushed the changes.", "author": "kaniyan", "createdAt": "2020-04-08T13:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTAwOQ=="}], "type": "inlineReview"}, {"oid": "95f61ffe216ac0c5336c51022a7eaeff7fba5334", "url": "https://github.com/eclipse/hono/commit/95f61ffe216ac0c5336c51022a7eaeff7fba5334", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-08T13:46:13Z", "type": "commit"}, {"oid": "95f61ffe216ac0c5336c51022a7eaeff7fba5334", "url": "https://github.com/eclipse/hono/commit/95f61ffe216ac0c5336c51022a7eaeff7fba5334", "message": "[#1679] Add implementation to resolve group members in device registration service.\n\nSigned-off-by: Kartheeswaran Kalidass <kartheeswaran.kalidass@bosch.io>", "committedDate": "2020-04-08T13:46:13Z", "type": "forcePushed"}]}