{"pr_number": 1727, "pr_title": "[#1642] Add Hotrod based DeviceConnectionClient", "pr_createdAt": "2020-01-29T09:13:18Z", "pr_url": "https://github.com/eclipse/hono/pull/1727", "timeline": [{"oid": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "url": "https://github.com/eclipse/hono/commit/bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-02-10T12:07:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMjQ0MA==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r378902440", "bodyText": "I find having another cache abstraction on top of the existing one a bit of over-complication. We have an abstraction in enmasse of CacheProvider, which adds necessary cache handling but then services use infinispan interfaces directly.\nhttps://github.com/EnMasseProject/enmasse/blob/master/iot/iot-infinispan-base/src/main/java/io/enmasse/iot/infinispan/cache/AbstractCacheProvider.java\nMaybe at some point we can align two implementations more.", "author": "dejanb", "createdAt": "2020-02-13T14:42:19Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.hono.client.ConnectionLifecycle;\n+import org.eclipse.hono.client.DisconnectListener;\n+import org.eclipse.hono.client.ReconnectListener;\n+import org.eclipse.hono.client.ServerErrorException;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.commons.api.BasicCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.vertx.core.AsyncResult;\n+import io.vertx.core.Future;\n+import io.vertx.core.Handler;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A HotrodCache.\n+ *\n+ * @param <K> The type of keys used by the cache.\n+ * @param <V> The type of values stored in the cache.\n+ */\n+public final class HotrodCache<K, V> implements ConnectionLifecycle<HotrodCache<K, V>> {", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwMzU2OA==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379003568", "bodyText": "The HotrodCache is adding the connection checking capability that we need for the readiness and liveness checks. Apart from that, it doesn't have much value. But we do need these checks in multiple places so I thought it would be a good idea to have them implemented in a single place.", "author": "sophokles73", "createdAt": "2020-02-13T17:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3NTUwNA==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379375504", "bodyText": "Yeah, we created some separate components for infinispan registry that does the same. The only thing here is that this abstraction now \"narrows\" the original cache api, which the introduce one more thing to maintain going forward.\nMaybe another topic for F2F at BCX to see if we can get two implementations more inlined. And maintained at one place.", "author": "dejanb", "createdAt": "2020-02-14T11:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMzIwMg==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r378903202", "bodyText": "Why not use RemoteCache or AdvanceCache interfaces and then use \"async\" variant of the calls instead of handling this manually?", "author": "dejanb", "createdAt": "2020-02-13T14:43:24Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import java.net.HttpURLConnection;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.eclipse.hono.client.ConnectionLifecycle;\n+import org.eclipse.hono.client.DisconnectListener;\n+import org.eclipse.hono.client.ReconnectListener;\n+import org.eclipse.hono.client.ServerErrorException;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.commons.api.BasicCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.vertx.core.AsyncResult;\n+import io.vertx.core.Future;\n+import io.vertx.core.Handler;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A HotrodCache.\n+ *\n+ * @param <K> The type of keys used by the cache.\n+ * @param <V> The type of values stored in the cache.\n+ */\n+public final class HotrodCache<K, V> implements ConnectionLifecycle<HotrodCache<K, V>> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(HotrodCache.class);\n+\n+    private final AtomicBoolean connecting = new AtomicBoolean(false);\n+    private final Vertx vertx;\n+    private final RemoteCacheManager cacheManager;\n+    private final String cacheName;\n+    private final K connectionCheckKey;\n+    private final V connectionCheckValue;\n+\n+    private RemoteCache<K, V> cache;\n+\n+    /**\n+     * @param vertx The vert.x instance to run on.\n+     * @param cacheManager The connection to the remote cache.\n+     * @param name The name of the (remote) cache.\n+     * @param connectionCheckKey The key to use for checking the connection\n+     *                           to the data grid.\n+     * @param connectionCheckValue The value to use for checking the connection\n+     *                           to the data grid.\n+     */\n+    public HotrodCache(\n+            final Vertx vertx,\n+            final RemoteCacheManager cacheManager,\n+            final String name,\n+            final K connectionCheckKey,\n+            final V connectionCheckValue) {\n+        this.vertx = Objects.requireNonNull(vertx);\n+        this.cacheManager = Objects.requireNonNull(cacheManager);\n+        this.cacheName = Objects.requireNonNull(name);\n+        this.connectionCheckKey = Objects.requireNonNull(connectionCheckKey);\n+        this.connectionCheckValue = Objects.requireNonNull(connectionCheckValue);\n+    }\n+\n+    public BasicCache<K, V> getCache() {\n+        return cache;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Future<HotrodCache<K, V>> connect() {\n+        return connectToGrid().map(ok -> this);\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Future<Void> isConnected() {\n+        return checkForCacheAvailability().mapEmpty();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void disconnect() {\n+        disconnect(r -> {});\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void disconnect(final Handler<AsyncResult<Void>> completionHandler) {\n+\n+        vertx.executeBlocking(r -> {", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwNDYxOA==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379004618", "bodyText": "I originally had that but the code is not much different because you still need to adapt the standard Java CompletableFuture to vert.x Promise ...", "author": "sophokles73", "createdAt": "2020-02-13T17:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMzIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3NjMyNQ==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379376325", "bodyText": "OK, makes sense.", "author": "dejanb", "createdAt": "2020-02-14T11:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkwMzIwMg=="}], "type": "inlineReview"}, {"oid": "7db2442c6a54e8a05d8817b45b232495bef118ed", "url": "https://github.com/eclipse/hono/commit/7db2442c6a54e8a05d8817b45b232495bef118ed", "message": "[#1642] Add Hotrod based DeviceConnectionClient\n\nThe client implementation connects directly to an Infinispan data grid\nto access device connection information. This client is an optimized\nversion of the existing client, skipping the Device Connection service\naltogether. Note that this also means that the client can access all\ndata for all tenants and should therefore not be used with custom\nprotocol adapters.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-02-14T13:25:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ1MzA4Mw==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379453083", "bodyText": "This name very much implies there being only one cache for the device connection data. However, for #1272 there will be other data added (mapping between device id and id of the protocol adapter instance that has a command consumer for that device). I would rather put this data in a separate Infinispan cache. So then there would be 2 Infinispan caches used for device connection data.\nSo, for now the name is Ok, for #1272 I think it will better be renamed to something like LastKnownGatewayInfoCache.", "author": "calohmn", "createdAt": "2020-02-14T14:18:21Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/DeviceConnectionInfoCache.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import io.opentracing.SpanContext;\n+import io.vertx.core.Future;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A repository for keeping connection information about devices.\n+ *\n+ */\n+public interface DeviceConnectionInfoCache {", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4MjQ5NQ==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379482495", "bodyText": "I think the type parameter T should better be renamed so that it doesn't hide the T parameter of the enclosing class.", "author": "calohmn", "createdAt": "2020-02-14T15:11:45Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -719,8 +744,9 @@ protected void doStop(final Promise<Void> stopPromise) {\n      *         connection cannot be established.\n      * @throws NullPointerException if serviceName is {@code null}.\n      * @throws IllegalArgumentException if factory is {@code null}.\n+     * @param <T> The type of connection that the factory uses.\n      */\n-    protected final Future<HonoConnection> connectToService(final ConnectionLifecycle<HonoConnection> factory, final String serviceName) {\n+    protected final <T> Future<T> connectToService(final ConnectionLifecycle<T> factory, final String serviceName) {", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4MjcxNA==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379482714", "bodyText": "I think the type parameter T should better be renamed so that it doesn't hide the T parameter of the enclosing class.", "author": "calohmn", "createdAt": "2020-02-14T15:12:08Z", "path": "service-base/src/main/java/org/eclipse/hono/service/AbstractProtocolAdapterBase.java", "diffHunk": "@@ -738,12 +764,13 @@ protected void doStop(final Promise<Void> stopPromise) {\n      *         connection cannot be established.\n      * @throws NullPointerException if serviceName is {@code null}.\n      * @throws IllegalArgumentException if factory is {@code null}.\n+     * @param <T> The type of connection that the factory uses.\n      */\n-    protected final Future<HonoConnection> connectToService(\n-            final ConnectionLifecycle<HonoConnection> factory,\n+    protected final <T> Future<T> connectToService(", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4Mzc0OQ==", "url": "https://github.com/eclipse/hono/pull/1727#discussion_r379483749", "bodyText": "final?", "author": "calohmn", "createdAt": "2020-02-14T15:13:59Z", "path": "services/device-connection/src/main/java/org/eclipse/hono/deviceconnection/infinispan/RemoteCacheBasedDeviceConnectionService.java", "diffHunk": "@@ -46,100 +37,16 @@\n  */\n public class RemoteCacheBasedDeviceConnectionService extends EventBusDeviceConnectionAdapter implements DeviceConnectionService, HealthCheckProvider {\n \n-    private static final String CACHE_NAME = \"device-connection\";\n-\n-    private RemoteCacheContainer cacheManager;\n-    private BasicCache<String, String> cache;\n-    private AtomicBoolean connecting = new AtomicBoolean(false);\n+    private DeviceConnectionInfoCache cache;", "originalCommit": "bd15f72ebe5ca45debcd2b54169b5d286c8903fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6e811d30dbcef68504c1cffd330ec784bf4ff1d4", "url": "https://github.com/eclipse/hono/commit/6e811d30dbcef68504c1cffd330ec784bf4ff1d4", "message": "Suggested changes\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-02-20T13:04:26Z", "type": "commit"}, {"oid": "a1635991bc127497b03eb0ae92856ef7e6ff39d1", "url": "https://github.com/eclipse/hono/commit/a1635991bc127497b03eb0ae92856ef7e6ff39d1", "message": "Rename DeviceConnectionInfo\n\nadded tests\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-02-20T15:11:59Z", "type": "commit"}, {"oid": "a1635991bc127497b03eb0ae92856ef7e6ff39d1", "url": "https://github.com/eclipse/hono/commit/a1635991bc127497b03eb0ae92856ef7e6ff39d1", "message": "Rename DeviceConnectionInfo\n\nadded tests\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-02-20T15:11:59Z", "type": "forcePushed"}]}