{"pr_number": 2328, "pr_title": "[#2068] Use cached connected check result in HotrodCache", "pr_createdAt": "2020-11-26T16:11:26Z", "pr_url": "https://github.com/eclipse/hono/pull/2328", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ1MjI4OQ==", "url": "https://github.com/eclipse/hono/pull/2328#discussion_r531452289", "bodyText": "maybe this method should also be renamed to connectToCache?", "author": "sophokles73", "createdAt": "2020-11-27T08:36:40Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/EmbeddedCache.java", "diffHunk": "@@ -104,10 +99,22 @@ protected boolean isStarted() {\n                 connecting.set(false);\n             });\n         } else {\n-            LOG.info(\"already trying to establish connection to data grid\");\n-            result.fail(\"already trying to establish connection to data grid\");\n+            LOG.info(\"already trying to establish connection to cache\");\n+            result.fail(\"already trying to establish connection to cache\");\n         }\n         return result.future();\n     }\n \n+    @Override\n+    public Future<JsonObject> checkForCacheAvailability() {\n+\n+        if (isStarted()) {\n+            return Future.succeededFuture(new JsonObject());\n+        } else {\n+            // try to (re-)establish connection\n+            connectToGrid();", "originalCommit": "1c339e841fe7741185684baa94e806f567f0a742", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ1NDE1Nw==", "url": "https://github.com/eclipse/hono/pull/2328#discussion_r531454157", "bodyText": "IMHO invoking the super class implementation is an anti pattern as you have no control over what is happening there.\nFMPOV withCache should be declared final and should be changed to invoke e.g. a postCacheAccess(Handler<AsyncResult<?>>) method with the outcome of the cache access. Subclasses can then override this method or not. But its purpose is well defined in any case ...", "author": "sophokles73", "createdAt": "2020-11-27T08:40:31Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/HotrodCache.java", "diffHunk": "@@ -127,4 +145,80 @@ protected boolean isStarted() {\n         });\n     }\n \n+    @Override\n+    protected <T> Future<T> withCache(\n+            final Function<org.infinispan.commons.api.BasicCache<K, V>, CompletionStage<T>> futureSupplier) {\n+        return super.withCache(futureSupplier)", "originalCommit": "1c339e841fe7741185684baa94e806f567f0a742", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUyNzc2Mg==", "url": "https://github.com/eclipse/hono/pull/2328#discussion_r531527762", "bodyText": "Yes, that's better. I've changed it accordingly.", "author": "calohmn", "createdAt": "2020-11-27T10:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ1NDE1Nw=="}], "type": "inlineReview"}, {"oid": "2533b9b1ac62f8a2b5888dc30b3607d275bee083", "url": "https://github.com/eclipse/hono/commit/2533b9b1ac62f8a2b5888dc30b3607d275bee083", "message": "[#2068] Used cached connected check result in HotrodCache.\n\nThe HotrodCache#checkForCacheAvailability() method will now determine\nits outcome based on whether the last cache operation was successful\nor not. It will only \"put\" the connectionCheckKey/Value if the last\ncache operation took place more than 30s ago.\nThe EmbeddedCache#checkForCacheAvailability() method now only checks\nwhether the cache instance was successfully obtained, not doing the\n\"put\" operation with connectionCheckKey/Value anymore.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-27T10:35:32Z", "type": "commit"}, {"oid": "2533b9b1ac62f8a2b5888dc30b3607d275bee083", "url": "https://github.com/eclipse/hono/commit/2533b9b1ac62f8a2b5888dc30b3607d275bee083", "message": "[#2068] Used cached connected check result in HotrodCache.\n\nThe HotrodCache#checkForCacheAvailability() method will now determine\nits outcome based on whether the last cache operation was successful\nor not. It will only \"put\" the connectionCheckKey/Value if the last\ncache operation took place more than 30s ago.\nThe EmbeddedCache#checkForCacheAvailability() method now only checks\nwhether the cache instance was successfully obtained, not doing the\n\"put\" operation with connectionCheckKey/Value anymore.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-11-27T10:35:32Z", "type": "forcePushed"}]}