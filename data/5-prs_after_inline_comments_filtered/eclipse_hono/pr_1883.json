{"pr_number": 1883, "pr_title": "Provide an embedded cache version for the device connection service", "pr_createdAt": "2020-04-07T12:51:04Z", "pr_url": "https://github.com/eclipse/hono/pull/1883", "timeline": [{"oid": "3254f6a059d27870a3368874885436bb8fc1e357", "url": "https://github.com/eclipse/hono/commit/3254f6a059d27870a3368874885436bb8fc1e357", "message": "Provide an embedded cache version for the device connection service", "committedDate": "2020-04-07T12:54:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM4MTM1MA==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405381350", "bodyText": "Typo", "author": "calohmn", "createdAt": "2020-04-08T09:20:26Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/EmbeddedCache.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.eclipse.hono.deviceconnection.infinispan.client;\n+\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.infinispan.lifecycle.ComponentStatus;\n+import org.infinispan.manager.EmbeddedCacheManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.vertx.core.Future;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+\n+/**\n+ * An embedded cache.\n+ *\n+ * @param <K> The type of keys used by the cache.\n+ * @param <V> The type of values stored in the cache.\n+ */\n+public class EmbeddedCache<K, V> extends BasicCache<K, V> {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(EmbeddedCache.class);\n+\n+    private final AtomicBoolean connecting = new AtomicBoolean(false);\n+\n+    private final EmbeddedCacheManager cacheManager;\n+    private final String cacheName;\n+\n+    /**\n+     * Create a new embedded cache instance.\n+     *\n+     * @param vertx The vert.x instance to run on.\n+     * @param cacheManager The connection to the remote cache.\n+     * @param cacheName The name of the (remote) cache.\n+     * @param connectionCheckKey The key to use for checking the connection\n+     *        to the data grid.\n+     * @param connectionCheckValue The value to use for checking the connection\n+     *        to the data grid.\n+     */\n+    public EmbeddedCache(\n+            final Vertx vertx,\n+            final EmbeddedCacheManager cacheManager,\n+            final String cacheName,\n+            final K connectionCheckKey,\n+            final V connectionCheckValue) {\n+        super(vertx, cacheManager, connectionCheckKey, connectionCheckValue);\n+        this.cacheManager = Objects.requireNonNull(cacheManager);\n+        this.cacheName = Objects.requireNonNull(cacheName);\n+    }\n+\n+    @Override\n+    protected boolean isStarted() {\n+        return cacheManager.getStatus() == ComponentStatus.RUNNING && getCache() != null;\n+    }\n+\n+    @Override\n+    protected Future<Void> connectToGrid() {\n+\n+        final Promise<Void> result = Promise.promise();\n+\n+        if (connecting.compareAndSet(false, true)) {\n+\n+            vertx.executeBlocking(r -> {\n+                try {\n+                    final var status = cacheManager.getStatus();\n+                    if (status != ComponentStatus.RUNNING) {\n+                        LOG.debug(\"trying to start cache manager, current state: {}\", status);\n+                        cacheManager.start();\n+                        LOG.info(\"started cache manager, now connecting to remote cache\");\n+                    }\n+                    LOG.debug(\"trying to get cache\");\n+                    setCache(cacheManager.getCache(cacheName));\n+                    if (getCache() == null) {\n+                        r.fail(new IllegalStateException(\"cache [\" + cacheName + \"] is not configured exist\"));", "originalCommit": "3254f6a059d27870a3368874885436bb8fc1e357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzNjM0Mg==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405536342", "bodyText": "Fixed.", "author": "ctron", "createdAt": "2020-04-08T13:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM4MTM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ4MzI1OQ==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405483259", "bodyText": "The content of the log message doesn't fit here any more.", "author": "calohmn", "createdAt": "2020-04-08T12:23:54Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/CacheBasedDeviceConnectionInfo.java", "diffHunk": "@@ -167,39 +164,26 @@ public HotrodBasedDeviceConnectionInfo(final RemoteCache<String, String> cache,\n         Objects.requireNonNull(adapterInstanceId);\n \n         final String key = getAdapterInstanceEntryKey(tenantId, deviceId);\n-        return cache.getWithVersion(key)\n-               .recover(t -> {\n+\n+        return cache\n+                .remove(key, adapterInstanceId)\n+                .recover(t -> {\n                     LOG.debug(\"failed to get cache entry when trying to remove command handling adapter instance [tenant: {}, device-id: {}, adapter-instance: {}]\",", "originalCommit": "3254f6a059d27870a3368874885436bb8fc1e357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzNjQyNg==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405536426", "bodyText": "Fixed.", "author": "ctron", "createdAt": "2020-04-08T13:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ4MzI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ4NTM4MA==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405485380", "bodyText": "I would prefix the @return sentence with \"A succeeded future containing\".\nI think it would be good to also mention the possibility that a failed future is returned here.", "author": "calohmn", "createdAt": "2020-04-08T12:27:38Z", "path": "client-device-connection-infinispan/src/main/java/org/eclipse/hono/deviceconnection/infinispan/client/Cache.java", "diffHunk": "@@ -67,14 +57,14 @@\n     Future<V> get(K key);\n \n     /**\n-     * Gets a value from the cache.\n+     * Remove a key/value mapping from the cache.\n      *\n      * @param key The key.\n-     * @return A succeeded future containing the value or {@code null} if the\n-     *         cache didn't contain the key yet.\n-     *         A failed future if the value could not be read from the cache.\n+     * @param value The value.\n+     * @return {@code true} if the key was mapped to the value, {@code false}\n+     *         otherwise.", "originalCommit": "3254f6a059d27870a3368874885436bb8fc1e357", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUzNjUxOQ==", "url": "https://github.com/eclipse/hono/pull/1883#discussion_r405536519", "bodyText": "Changed.", "author": "ctron", "createdAt": "2020-04-08T13:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ4NTM4MA=="}], "type": "inlineReview"}, {"oid": "dcc279b314ad968b25240a73384fe0d188bd2d0c", "url": "https://github.com/eclipse/hono/commit/dcc279b314ad968b25240a73384fe0d188bd2d0c", "message": "Provide an embedded cache version for the device connection service", "committedDate": "2020-04-08T13:44:37Z", "type": "forcePushed"}, {"oid": "404f2bfb8f18715ab023944ce8024cca6cef7edf", "url": "https://github.com/eclipse/hono/commit/404f2bfb8f18715ab023944ce8024cca6cef7edf", "message": "Provide an embedded cache version for the device connection service", "committedDate": "2020-04-08T13:46:22Z", "type": "commit"}, {"oid": "404f2bfb8f18715ab023944ce8024cca6cef7edf", "url": "https://github.com/eclipse/hono/commit/404f2bfb8f18715ab023944ce8024cca6cef7edf", "message": "Provide an embedded cache version for the device connection service", "committedDate": "2020-04-08T13:46:22Z", "type": "forcePushed"}]}