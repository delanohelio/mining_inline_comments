{"pr_number": 2051, "pr_title": "#1856 negative authenticated connection count", "pr_createdAt": "2020-06-24T12:50:21Z", "pr_url": "https://github.com/eclipse/hono/pull/2051", "timeline": [{"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "url": "https://github.com/eclipse/hono/commit/c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-06-24T12:55:02Z", "type": "commit"}, {"oid": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "url": "https://github.com/eclipse/hono/commit/c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-06-24T12:55:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkyNTk1OA==", "url": "https://github.com/eclipse/hono/pull/2051#discussion_r444925958", "bodyText": "FMPOV this check should be done immediately after the openHandler has been invoked", "author": "sophokles73", "createdAt": "2020-06-24T14:15:38Z", "path": "adapters/amqp-vertx/src/test/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapterTest.java", "diffHunk": "@@ -1189,10 +1191,17 @@ public void testConnectionFailsIfAdapterLevelConnectionLimitIsExceeded() {\n                 .forClass(Handler.class);\n         verify(deviceConnection).openHandler(openHandler.capture());\n         openHandler.getValue().handle(Future.succeededFuture(deviceConnection));\n-        // THEN the adapter does not accept the incoming connection request. \n+        // THEN the adapter closes the connection right after it opened it\n+        final ArgumentCaptor<Handler<AsyncResult<ProtonConnection>>> closeHandler = ArgumentCaptor.forClass(Handler.class);\n+        verify(deviceConnection).closeHandler(closeHandler.capture());\n+        closeHandler.getValue().handle(Future.succeededFuture());\n         final ArgumentCaptor<ErrorCondition> errorConditionCaptor = ArgumentCaptor.forClass(ErrorCondition.class);\n         verify(deviceConnection).setCondition(errorConditionCaptor.capture());\n         assertEquals(AmqpError.UNAUTHORIZED_ACCESS, errorConditionCaptor.getValue().getCondition());\n+        // AND increments and decrements the connection count accordingly\n+        final InOrder metricsInOrderVerifier = inOrder(metrics);\n+        metricsInOrderVerifier.verify(metrics).incrementConnections(TEST_TENANT_ID);", "originalCommit": "c97cb8c7a8a63d108655f3eeda61598bd3dc4bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1MzgyMQ==", "url": "https://github.com/eclipse/hono/pull/2051#discussion_r444953821", "bodyText": "Okay for me. By this we'll make sure that the increment is actually made in the open handler and not accidentally called in the closed handler together with the decrement (would be very weird - but you never know... )", "author": "fkaltner", "createdAt": "2020-06-24T14:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkyNTk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1NTc4NA==", "url": "https://github.com/eclipse/hono/pull/2051#discussion_r444955784", "bodyText": "exactly", "author": "sophokles73", "createdAt": "2020-06-24T14:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkyNTk1OA=="}], "type": "inlineReview"}, {"oid": "a180d94580c1fab08fd360f4dc57c0f2dca251a4", "url": "https://github.com/eclipse/hono/commit/a180d94580c1fab08fd360f4dc57c0f2dca251a4", "message": "[#1856] Fixing negative AMQP authenticated connection count metric\n\nConnection count was erroneously not incremented when a connection was rejected due to the connection limit of an adapter, but was decremented in that case as well which lead to negative connection counts.\n\nSigned-off-by: Florian Kaltner <florian.kaltner@bosch.io>", "committedDate": "2020-06-24T15:03:40Z", "type": "commit"}]}