{"pr_number": 2235, "pr_title": "[#2234] Reject command message with unsupported body section", "pr_createdAt": "2020-10-08T06:57:56Z", "pr_url": "https://github.com/eclipse/hono/pull/2235", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0NjY2NQ==", "url": "https://github.com/eclipse/hono/pull/2235#discussion_r501546665", "bodyText": "This looks a little odd to me. How about renaming this to something like assertSupportedPayloadType and throw an exception holding a description in case of an invalid payload?", "author": "sophokles73", "createdAt": "2020-10-08T08:40:51Z", "path": "core/src/main/java/org/eclipse/hono/util/MessageHelper.java", "diffHunk": "@@ -459,39 +440,88 @@ public static Buffer getPayload(final Message msg) {\n      * <li>In all other cases, {@code null} is returned.</li>\n      * </ul>\n      *\n-     * @param message The AMQP 1.0 message to parse the body of.\n+     * @param msg The AMQP 1.0 message to parse the body of.\n      * @return The String representation of the payload data or {@code null} if the message\n      *         body does not contain data that can be decoded into a String.\n      * @throws NullPointerException if the message is {@code null}.\n      */\n-    public static String getPayloadAsString(final Message message) {\n+    public static String getPayloadAsString(final Message msg) {\n+        Objects.requireNonNull(msg);\n+        // In case of an AmqpValue containing a String,\n+        // we prevent encoding/decoding of the String to/from its UTF-8 bytes.\n+        if (msg.getBody() instanceof AmqpValue\n+                && ((AmqpValue) msg.getBody()).getValue() instanceof String) {\n+            return (String) ((AmqpValue) msg.getBody()).getValue();\n+        }\n+        return Optional.ofNullable(getPayload(msg)).map(Buffer::toString).orElse(null);\n+    }\n \n-        Objects.requireNonNull(message);\n+    /**\n+     * Gets the size of the payload data contained in a message's body.\n+     * <p>\n+     * If there is no body section or if its type is unsupported, {@code 0} is returned.\n+     *\n+     * @param msg The AMQP 1.0 message to parse the body of.\n+     * @return The payload size in bytes, 0 if message body is {@code null} or unsupported.\n+     * @throws NullPointerException if the message is {@code null}.\n+     */\n+    public static int getPayloadSize(final Message msg) {\n+        Objects.requireNonNull(msg);\n+        return Optional.ofNullable(getPayloadByteArray(msg)).map(bytes -> bytes.length).orElse(0);\n+    }\n \n-        if (message.getBody() == null) {\n-            LOG.trace(\"message has no body\");\n-            return null;\n-        }\n+    /**\n+     * Checks whether the payload data contained in a message's body is returned as {@code null} by\n+     * {@link #getPayload(Message)} or {@link #getPayloadAsString(Message)} and, if that is the case,\n+     * returns the reason for that.\n+     *\n+     * @param msg The AMQP 1.0 message to parse.\n+     * @return A reason string or {@code null} if the payload is not {@code null}.\n+     * @throws NullPointerException if the message is {@code null}.\n+     */\n+    public static String getReasonIfPayloadNull(final Message msg) {", "originalCommit": "76f83aa4b3bf30eef27325068f99f9350acde1fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEzMDA5OA==", "url": "https://github.com/eclipse/hono/pull/2235#discussion_r503130098", "bodyText": "Throwing an exception in that message doesn't fit the use case of the Command class and just adds clutter there.\nI've renamed the method to getUnsupportedPayloadReason now (returning an Optional).\nWhen the need for a assertSupportedPayloadTyp method arises, we can add that, simply invoking getUnsupportedPayloadReason internally.", "author": "calohmn", "createdAt": "2020-10-12T08:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0NjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE2MDYzNQ==", "url": "https://github.com/eclipse/hono/pull/2235#discussion_r503160635", "bodyText": "Is this method being used anywhere else? If this is a very Command specific requirement, then we could also simply embed this method into the Command class. WDYT?", "author": "sophokles73", "createdAt": "2020-10-12T09:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0NjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI0NjgzOQ==", "url": "https://github.com/eclipse/hono/pull/2235#discussion_r503246839", "bodyText": "Ok, I've moved the method to the Command class.\nI've also updated the new org.eclipse.hono.adapter.client.command.Command class.", "author": "calohmn", "createdAt": "2020-10-12T12:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0NjY2NQ=="}], "type": "inlineReview"}, {"oid": "be6b7d65d90aeb33ce875479b9cf2160a52969df", "url": "https://github.com/eclipse/hono/commit/be6b7d65d90aeb33ce875479b9cf2160a52969df", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-12T08:35:24Z", "type": "forcePushed"}, {"oid": "18e69129a4f4aee36352b7e7fd9c76175abb342e", "url": "https://github.com/eclipse/hono/commit/18e69129a4f4aee36352b7e7fd9c76175abb342e", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-12T11:26:40Z", "type": "forcePushed"}, {"oid": "a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "url": "https://github.com/eclipse/hono/commit/a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-12T11:57:54Z", "type": "commit"}, {"oid": "a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "url": "https://github.com/eclipse/hono/commit/a25db6cbe2c1ba8465a311d236fc941b9d8db18e", "message": "[#2234] Reject command message with unsupported body section.\n\nAlso introduce getPayloadSize() method, preventing copy of\nbody section bytes.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-10-12T11:57:54Z", "type": "forcePushed"}]}