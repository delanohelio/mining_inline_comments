{"pr_number": 2123, "pr_title": "[#2120] Fix calculation of duration of current accounting period", "pr_createdAt": "2020-08-20T09:49:14Z", "pr_url": "https://github.com/eclipse/hono/pull/2123", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0OTc3NQ==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473949775", "bodyText": "FMPOV we should also allow to set a future date as an effectiveSince date. For example, I would like to start a plan from the next month. In this case, I should be able to set it now and not wait until 12 AM UTC on the first day of the next month. IMHO if the effective date is in the future, we can simply ignore and no need to calculate any limits.\nIf we don't want to allow any future date as an effectiveSince, then I think a corresponding validation should be  there while adding/updating tenant information. WDYT?", "author": "kaniyan", "createdAt": "2020-08-20T12:59:17Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -627,76 +647,146 @@ private Long extractLongValue(final JsonObject response, final Span span) {\n     }\n \n     /**\n-     * Calculates the effective resource limit for a tenant for the given period from the configured values.\n+     * Calculates the effective resource limit for a tenant for the current accounting period.\n      * <p>\n-     * In the <em>monthly</em> mode, if the effectiveSince date doesn't fall on the \n-     * first day of the month then the effective resource limit for the tenant is \n-     * calculated as below.\n+     * For the initial accounting period of a monthly plan the effective resource limit is\n+     * calculated as follows:\n      * <pre>\n      *             configured limit \n-     *   ---------------------------------- x No. of days from effectiveSince till lastDay of the targetDateMonth.\n-     *    No. of days in the current month\n+     *   ----------------------------------- x No. of minutes until start of next accounting period.\n+     *   No. of minutes in the current month\n      * </pre>\n      * <p>\n-     * For rest of the months and the <em>days</em> mode, the configured limit is used directly.\n+     * In all other cases the configured limit is used directly.\n      *\n-     * @param effectiveSince The point of time on which the given resource limit came into effect.\n-     * @param targetDateTime The target date and time.\n-     * @param mode The mode of the period. \n-     * @param configuredLimit The configured limit. \n-     * @return The effective resource limit that has been calculated.\n+     * @param effectiveSince The point of time (UTC) at which the resource limit became effective.\n+     * @param targetDateTime The point in time (UTC) to calculate the limit for.\n+     * @param periodType The type of accounting periods that the resource limit is based on.\n+     * @param configuredLimit The maximum amount of resources to be used per accounting period.\n+     * @return The resource limit for the current accounting period.\n+     * @throws NullPointerException if any of the parameters are {@code null}.\n+     * @throws IllegalArgumentException if target date-time is before effective since date-time.\n      */\n     long calculateEffectiveLimit(\n-            final OffsetDateTime effectiveSince,\n-            final OffsetDateTime targetDateTime,\n-            final PeriodMode mode,\n+            final Instant effectiveSince,\n+            final Instant targetDateTime,\n+            final PeriodMode periodType,\n             final long configuredLimit) {\n-        if (PeriodMode.MONTHLY.equals(mode)\n-                && configuredLimit > 0\n-                && !targetDateTime.isBefore(effectiveSince)\n-                && YearMonth.from(targetDateTime).equals(YearMonth.from(effectiveSince))\n-                && effectiveSince.getDayOfMonth() != 1) {\n-            final OffsetDateTime lastDayOfMonth = effectiveSince.with(TemporalAdjusters.lastDayOfMonth());\n-            final long daysBetween = ChronoUnit.DAYS\n-                    .between(effectiveSince, lastDayOfMonth) + 1;\n-            return Double.valueOf(Math.ceil(daysBetween * configuredLimit / lastDayOfMonth.getDayOfMonth()))\n-                    .longValue();\n+\n+        Objects.requireNonNull(effectiveSince, \"effective since\");\n+        Objects.requireNonNull(targetDateTime, \"target date-time\");\n+        Objects.requireNonNull(periodType, \"period mode\");\n+\n+        if (targetDateTime.isBefore(effectiveSince)) {\n+            throw new IllegalArgumentException(\"target date-time must not be before effective since\");", "originalCommit": "130bd9904c06dac41245f8667c98980c2d66333f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk2MzUxMA==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473963510", "bodyText": "very good point \ud83d\udc4d  I will change it accordingly", "author": "sophokles73", "createdAt": "2020-08-20T13:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0OTc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzNjY4Mg==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473936682", "bodyText": "typo: Septemer", "author": "calohmn", "createdAt": "2020-08-20T12:36:47Z", "path": "service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java", "diffHunk": "@@ -402,80 +427,110 @@ public void testMessageLimitNotExceededForMissingMetrics(final VertxTestContext\n      */\n     @Test\n     public void verifyEffectiveResourceLimitCalculation() {\n+\n         final long maxBytes = 9300;\n \n         // Monthly mode\n-        // The case where the effectiveSince lies on the past months of the target date.\n-        assertEquals(maxBytes,\n+        // target date lies within the initial accounting period.\n+        final long numberOfMinutesInSeptemer = 24 * 60 * 30;", "originalCommit": "130bd9904c06dac41245f8667c98980c2d66333f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MDA5NA==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473940094", "bodyText": "Using Math.floor() looks superfluous here since the division result is truncated anyway.", "author": "calohmn", "createdAt": "2020-08-20T12:43:06Z", "path": "service-base/src/test/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecksTest.java", "diffHunk": "@@ -402,80 +427,110 @@ public void testMessageLimitNotExceededForMissingMetrics(final VertxTestContext\n      */\n     @Test\n     public void verifyEffectiveResourceLimitCalculation() {\n+\n         final long maxBytes = 9300;\n \n         // Monthly mode\n-        // The case where the effectiveSince lies on the past months of the target date.\n-        assertEquals(maxBytes,\n+        // target date lies within the initial accounting period.\n+        final long numberOfMinutesInSeptemer = 24 * 60 * 30;\n+        // next accounting period starts Oct 1st 12 AM UTC\n+        final long remainingMinutesTillStartOfNextAccountingPeriod = 24 * 60 * 28 + 9 * 60 + 30;\n+        final long expectedEffectiveLimit = (long) Math.floor(remainingMinutesTillStartOfNextAccountingPeriod * maxBytes / numberOfMinutesInSeptemer );", "originalCommit": "130bd9904c06dac41245f8667c98980c2d66333f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk2NTg4MQ==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473965881", "bodyText": "floor() is the wrong one anyway ;-)", "author": "sophokles73", "createdAt": "2020-08-20T13:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MDA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MjMyOQ==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473952329", "bodyText": "The result won't be the rounded up division result here because the division is done in an integer context and so the division result is truncated before it gets used in Math.ceil().", "author": "calohmn", "createdAt": "2020-08-20T13:03:27Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -627,76 +647,146 @@ private Long extractLongValue(final JsonObject response, final Span span) {\n     }\n \n     /**\n-     * Calculates the effective resource limit for a tenant for the given period from the configured values.\n+     * Calculates the effective resource limit for a tenant for the current accounting period.\n      * <p>\n-     * In the <em>monthly</em> mode, if the effectiveSince date doesn't fall on the \n-     * first day of the month then the effective resource limit for the tenant is \n-     * calculated as below.\n+     * For the initial accounting period of a monthly plan the effective resource limit is\n+     * calculated as follows:\n      * <pre>\n      *             configured limit \n-     *   ---------------------------------- x No. of days from effectiveSince till lastDay of the targetDateMonth.\n-     *    No. of days in the current month\n+     *   ----------------------------------- x No. of minutes until start of next accounting period.\n+     *   No. of minutes in the current month\n      * </pre>\n      * <p>\n-     * For rest of the months and the <em>days</em> mode, the configured limit is used directly.\n+     * In all other cases the configured limit is used directly.\n      *\n-     * @param effectiveSince The point of time on which the given resource limit came into effect.\n-     * @param targetDateTime The target date and time.\n-     * @param mode The mode of the period. \n-     * @param configuredLimit The configured limit. \n-     * @return The effective resource limit that has been calculated.\n+     * @param effectiveSince The point of time (UTC) at which the resource limit became effective.\n+     * @param targetDateTime The point in time (UTC) to calculate the limit for.\n+     * @param periodType The type of accounting periods that the resource limit is based on.\n+     * @param configuredLimit The maximum amount of resources to be used per accounting period.\n+     * @return The resource limit for the current accounting period.\n+     * @throws NullPointerException if any of the parameters are {@code null}.\n+     * @throws IllegalArgumentException if target date-time is before effective since date-time.\n      */\n     long calculateEffectiveLimit(\n-            final OffsetDateTime effectiveSince,\n-            final OffsetDateTime targetDateTime,\n-            final PeriodMode mode,\n+            final Instant effectiveSince,\n+            final Instant targetDateTime,\n+            final PeriodMode periodType,\n             final long configuredLimit) {\n-        if (PeriodMode.MONTHLY.equals(mode)\n-                && configuredLimit > 0\n-                && !targetDateTime.isBefore(effectiveSince)\n-                && YearMonth.from(targetDateTime).equals(YearMonth.from(effectiveSince))\n-                && effectiveSince.getDayOfMonth() != 1) {\n-            final OffsetDateTime lastDayOfMonth = effectiveSince.with(TemporalAdjusters.lastDayOfMonth());\n-            final long daysBetween = ChronoUnit.DAYS\n-                    .between(effectiveSince, lastDayOfMonth) + 1;\n-            return Double.valueOf(Math.ceil(daysBetween * configuredLimit / lastDayOfMonth.getDayOfMonth()))\n-                    .longValue();\n+\n+        Objects.requireNonNull(effectiveSince, \"effective since\");\n+        Objects.requireNonNull(targetDateTime, \"target date-time\");\n+        Objects.requireNonNull(periodType, \"period mode\");\n+\n+        if (targetDateTime.isBefore(effectiveSince)) {\n+            throw new IllegalArgumentException(\"target date-time must not be before effective since\");\n+        }\n+\n+        // we only need to calculate the effective limit if we are in the initial accounting period\n+        // of a monthly plan\n+        if (PeriodMode.MONTHLY.equals(periodType) && configuredLimit > 0) {\n+\n+            final ZonedDateTime effectiveSinceZonedDateTime = ZonedDateTime.ofInstant(effectiveSince, ZoneOffset.UTC);\n+            final ZonedDateTime targetZonedDateTime = ZonedDateTime.ofInstant(targetDateTime, ZoneOffset.UTC);\n+\n+            if (YearMonth.from(targetZonedDateTime).equals(YearMonth.from(effectiveSinceZonedDateTime))) {\n+\n+                final ZonedDateTime startOfNextAccountingPeriod = effectiveSinceZonedDateTime\n+                        .with(TemporalAdjusters.firstDayOfNextMonth())\n+                        .withHour(0)\n+                        .withMinute(0)\n+                        .withSecond(0)\n+                        .withNano(0);\n+                final long minutesTillStartOfNextAccountingPeriod = Math.max(1, Duration\n+                        .between(effectiveSinceZonedDateTime, startOfNextAccountingPeriod)\n+                        .toMinutes());\n+                final long lengthOfCurrentMonthInMinutes = 60 * 24 * effectiveSinceZonedDateTime\n+                        .range(ChronoField.DAY_OF_MONTH).getMaximum();\n+                return Double.valueOf(Math.ceil(minutesTillStartOfNextAccountingPeriod * configuredLimit / lengthOfCurrentMonthInMinutes))", "originalCommit": "5b5511fe54615764955e5aab014436fa7c850c88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA1MTE4Nw==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r474051187", "bodyText": "true, I have changed that", "author": "sophokles73", "createdAt": "2020-08-20T15:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MjMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MzYyMA==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r473953620", "bodyText": "double whitespace used here", "author": "calohmn", "createdAt": "2020-08-20T13:05:35Z", "path": "core/src/main/java/org/eclipse/hono/util/ResourceLimitsPeriod.java", "diffHunk": "@@ -64,11 +64,11 @@ public final int getNoOfDays() {\n      *\n      * @param noOfDays The number of days for which resource usage is calculated.\n      * @return  a reference to this for fluent use.\n-     * @throws IllegalArgumentException if the number of days is negative.\n+     * @throws IllegalArgumentException if the number of days is &lt;= 0.\n      */\n     public final ResourceLimitsPeriod setNoOfDays(final int noOfDays) {\n-        if (noOfDays < 0) {\n-            throw new IllegalArgumentException(\"Number of days property must be  set to value >= 0\");\n+        if (noOfDays <= 0) {\n+            throw new IllegalArgumentException(\"Number of days property must be  set to value > 0\");", "originalCommit": "5b5511fe54615764955e5aab014436fa7c850c88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA5OTIzOQ==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r474099239", "bodyText": "As per the master branch, the configured maxBytes value is returned when the effectiveSince date lies in the future. Now by returning zero, it means that no messages are accepted for this tenant (as the allowedMaxBytes is zero bytes) until the plan actually starts as per the effectiveSince date. I think it makes more sense not to allow any messages until the plan actually starts.", "author": "kaniyan", "createdAt": "2020-08-20T16:05:52Z", "path": "service-base/src/main/java/org/eclipse/hono/service/resourcelimits/PrometheusBasedResourceLimitChecks.java", "diffHunk": "@@ -678,7 +678,7 @@ long calculateEffectiveLimit(\n         Objects.requireNonNull(periodType, \"period mode\");\n \n         if (targetDateTime.isBefore(effectiveSince)) {\n-            throw new IllegalArgumentException(\"target date-time must not be before effective since\");\n+            return 0;", "originalCommit": "6287c65d75ea67e5e9d9d908a9b36b40a8f36117", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwMDM4OQ==", "url": "https://github.com/eclipse/hono/pull/2123#discussion_r474100389", "bodyText": "I agree. That's why I made that change ;-)", "author": "sophokles73", "createdAt": "2020-08-20T16:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA5OTIzOQ=="}], "type": "inlineReview"}, {"oid": "7dd770a26a77704969888dc74fee9c8a58001acc", "url": "https://github.com/eclipse/hono/commit/7dd770a26a77704969888dc74fee9c8a58001acc", "message": "Fix wording in Management API\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-08-21T06:14:09Z", "type": "forcePushed"}, {"oid": "d089308168f1a9295d6c83d0b20541f311a30873", "url": "https://github.com/eclipse/hono/commit/d089308168f1a9295d6c83d0b20541f311a30873", "message": "[#2120] Fix calculation of duration of current accounting period\n\nThe calculation had been using days granularity when determining how\nmuch of the current accounting period's contingent has been used up\nalready.\nIf a lot of resources had been used towards the end of the previous\nperiod, this could lead to situations where resources used during\ntte previous period would be accounted for the current accounting period\nas well.\n\nFixes #2120\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-08-21T06:55:32Z", "type": "commit"}, {"oid": "9979a2524c0af8ef81d041f95a32985fd9804aac", "url": "https://github.com/eclipse/hono/commit/9979a2524c0af8ef81d041f95a32985fd9804aac", "message": "Improve documentation of resource limits in Management API\n\nAdded specifics of accounting period modes.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-08-21T06:55:33Z", "type": "commit"}, {"oid": "9979a2524c0af8ef81d041f95a32985fd9804aac", "url": "https://github.com/eclipse/hono/commit/9979a2524c0af8ef81d041f95a32985fd9804aac", "message": "Improve documentation of resource limits in Management API\n\nAdded specifics of accounting period modes.\n\nSigned-off-by: Kai Hudalla <kai.hudalla@bosch.io>", "committedDate": "2020-08-21T06:55:33Z", "type": "forcePushed"}]}