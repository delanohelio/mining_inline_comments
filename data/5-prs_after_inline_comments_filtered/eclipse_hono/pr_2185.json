{"pr_number": 2185, "pr_title": "[#2166] Improve 503 error messages in HTTP adapter", "pr_createdAt": "2020-09-17T07:28:36Z", "pr_url": "https://github.com/eclipse/hono/pull/2185", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDA2Nw==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490034067", "bodyText": "this looks like it would be helpful in both ClientErrorException and ServerErrorException. Thus, IMHO we should add this to ServiceInvocationException.", "author": "sophokles73", "createdAt": "2020-09-17T07:37:33Z", "path": "client/src/main/java/org/eclipse/hono/client/ServerErrorException.java", "diffHunk": "@@ -21,6 +21,8 @@\n \n     private static final long serialVersionUID = 1L;\n \n+    private String clientFacingMessage;", "originalCommit": "6d907b5a0687dc3fcb4b4608d69c0a11e56ca3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc0ODk0OQ==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490748949", "bodyText": "The motivation to put it only in the ServerErrorException class was that the standard error message of a ClientErrorException is already a client-facing one, i.e. it is used in the HTTP response for example:\n\n  \n    \n      hono/adapters/http-vertx-base/src/main/java/org/eclipse/hono/adapter/http/AbstractVertxBasedHttpProtocolAdapter.java\n    \n    \n        Lines 787 to 789\n      in\n      0e440ef\n    \n    \n    \n    \n\n        \n          \n           if (ClientErrorException.class.isInstance(t)) { \n        \n\n        \n          \n               outcome = ProcessingOutcome.UNPROCESSABLE; \n        \n\n        \n          \n               ctx.fail(t); \n        \n    \n  \n\n\nI see a ServerErrorException as more of an internal exception, where it makes sense to add a separate error message that abstracts from the internals.", "author": "calohmn", "createdAt": "2020-09-18T07:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzMzUwMA==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r491833500", "bodyText": "I see", "author": "sophokles73", "createdAt": "2020-09-21T07:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDIzNQ==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490034235", "bodyText": "final?", "author": "sophokles73", "createdAt": "2020-09-17T07:37:53Z", "path": "client/src/main/java/org/eclipse/hono/client/ServerErrorException.java", "diffHunk": "@@ -115,4 +117,22 @@ public ServerErrorException(final String tenant, final int errorCode, final Stri\n             throw new IllegalArgumentException(\"client error code must be >= 500 and < 600\");\n         }\n     }\n+\n+    /**\n+     * Gets the error message suitable to be propagated to an external client.\n+     *\n+     * @return The message or {@code null}.\n+     */\n+    public String getClientFacingMessage() {", "originalCommit": "6d907b5a0687dc3fcb4b4608d69c0a11e56ca3e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNDI5MQ==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490034291", "bodyText": "final ?", "author": "sophokles73", "createdAt": "2020-09-17T07:38:00Z", "path": "client/src/main/java/org/eclipse/hono/client/ServerErrorException.java", "diffHunk": "@@ -115,4 +117,22 @@ public ServerErrorException(final String tenant, final int errorCode, final Stri\n             throw new IllegalArgumentException(\"client error code must be >= 500 and < 600\");\n         }\n     }\n+\n+    /**\n+     * Gets the error message suitable to be propagated to an external client.\n+     *\n+     * @return The message or {@code null}.\n+     */\n+    public String getClientFacingMessage() {\n+        return clientFacingMessage;\n+    }\n+\n+    /**\n+     * Sets the error message suitable to be propagated to an external client.\n+     *\n+     * @param clientFacingMessage The message.\n+     */\n+    public void setClientFacingMessage(final String clientFacingMessage) {", "originalCommit": "6d907b5a0687dc3fcb4b4608d69c0a11e56ca3e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNTg4MQ==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490035881", "bodyText": "FMPOV you have now opened Pandora's Box of (localized) messages ;-)\nI do not think that we should populate our constants classes with full fledged error messages ...\nInstead, we should probably use resource bundles which have been designed for this purpose.", "author": "sophokles73", "createdAt": "2020-09-17T07:40:48Z", "path": "client/src/main/java/org/eclipse/hono/client/impl/AbstractSender.java", "diffHunk": "@@ -56,6 +56,24 @@\n  */\n public abstract class AbstractSender extends AbstractHonoClient implements MessageSender {\n \n+    /**\n+     * Client facing error message for the case of a message sender not receiving a delivery update in time.\n+     * May be used as {@link ServerErrorException#clientFacingMessage}.\n+     */\n+    public static final String ERROR_SEND_MESSAGE_TIMEOUT = \"consumer failed to indicate in time whether it has processed the message\";", "originalCommit": "6d907b5a0687dc3fcb4b4608d69c0a11e56ca3e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1MzQ5MQ==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r490753491", "bodyText": "Using a resource bundle just for these error messages seems a bit overkill to me. We also don't use a resource bundle for the ClientErrorException messages already being included in HTTP responses.\nI mainly introduced these constants to match the error message in the unit tests. As we rarely use such error message checks in unit tests, I could just remove them and then also remove the constants.", "author": "calohmn", "createdAt": "2020-09-18T07:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgzNDEwMg==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r491834102", "bodyText": "FMPOV it would actually be the right choice for the problem at hand. I also do not think that it is much effort to implement.", "author": "sophokles73", "createdAt": "2020-09-21T07:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0Mzk3Mg==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r491843972", "bodyText": "So you mean introducing a resource bundle, used then also for the ClientErrorException messages?", "author": "calohmn", "createdAt": "2020-09-21T07:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNTg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0NzQzMA==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r491847430", "bodyText": "You mean for the already existing messages? IMHO that should be the goal then, yes. We could maybe use a step-by-step approach here but in the end we should use the same mechanism. FMPOV this is even more desirable if we want to provide more elaborate messages than bad JSON ...", "author": "sophokles73", "createdAt": "2020-09-21T07:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDAzNTg4MQ=="}], "type": "inlineReview"}, {"oid": "35184383e626aa3b817db80aca0c95def4460594", "url": "https://github.com/eclipse/hono/commit/35184383e626aa3b817db80aca0c95def4460594", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-18T07:01:24Z", "type": "forcePushed"}, {"oid": "3d02ff00b51af7d1e9e08e4d8e3516ca5bd9019b", "url": "https://github.com/eclipse/hono/commit/3d02ff00b51af7d1e9e08e4d8e3516ca5bd9019b", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-29T06:34:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1OTk0MA==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r496459940", "bodyText": "the consumer did not process the message in this case as well", "author": "sophokles73", "createdAt": "2020-09-29T06:58:32Z", "path": "client/src/main/java/org/eclipse/hono/client/impl/AbstractSender.java", "diffHunk": "@@ -304,10 +307,15 @@ protected final Span startSpan(final Message message) {\n                                 : new ClientErrorException(HttpURLConnection.HTTP_BAD_REQUEST, rejected.getError().getDescription());\n                     } else if (Released.class.isInstance(remoteState)) {\n                         e = new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE);\n+                        ((ServerErrorException) e).setClientFacingMessage(ServerErrorMessage.MESSAGE_NOT_PROCESSED);\n                     } else if (Modified.class.isInstance(remoteState)) {\n                         final Modified modified = (Modified) deliveryUpdated.getRemoteState();\n-                        e = modified.getUndeliverableHere() ? new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND)\n-                                : new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE);\n+                        if (modified.getUndeliverableHere()) {\n+                            e = new ClientErrorException(HttpURLConnection.HTTP_NOT_FOUND);", "originalCommit": "3d02ff00b51af7d1e9e08e4d8e3516ca5bd9019b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUyMzA2Nw==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r496523067", "bodyText": "yes, but I think the \"not found/don't try again\" semantics of the exception would then need to be put into the message as well. How about using\nSERVER_ERROR_MESSAGE_UNDELIVERABLE=consumer declared message as undeliverable, it should not be redelivered\nhere?", "author": "calohmn", "createdAt": "2020-09-29T08:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1OTk0MA=="}], "type": "inlineReview"}, {"oid": "a9a6ebfe1ce61c1445638fdbc7feb2a8f0118234", "url": "https://github.com/eclipse/hono/commit/a9a6ebfe1ce61c1445638fdbc7feb2a8f0118234", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-29T12:51:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcyNDcyMA==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r496724720", "bodyText": "wow, this looks terrible, doesn't it ;-)\nMaybe we can add a static String ServiceInvocationException.getLocalizedMessage(String) method which accepts a key instead?", "author": "sophokles73", "createdAt": "2020-09-29T13:39:33Z", "path": "tests/src/test/java/org/eclipse/hono/tests/http/TelemetryHttpIT.java", "diffHunk": "@@ -214,6 +221,10 @@ public void testUploadQos1MessageFailsIfDeliveryStateNotUpdated(final VertxTestC\n \n         httpResponseFuture\n                 .onComplete(ctx.succeeding(response -> {\n+                    ctx.verify(() -> {\n+                        assertThat(response.bodyAsString())\n+                                .isEqualTo(new SendMessageTimeoutException(\"\").getClientFacingMessage());\n+                    });", "originalCommit": "a9a6ebfe1ce61c1445638fdbc7feb2a8f0118234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2MjgyNw==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r496762827", "bodyText": "Well, I agree that it doesn't look pretty and I was actually a bit hesitant, using that. However, it's in a test and as an advantage, the resource handling and keys can be kept internal to the exception classes that way.\nBut ok, I've changed it to use ServiceInvocationException.getLocalizedMessage() now.", "author": "calohmn", "createdAt": "2020-09-29T14:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcyNDcyMA=="}], "type": "inlineReview"}, {"oid": "5b11db74260a05f84f8cdacafb8bece5ac116630", "url": "https://github.com/eclipse/hono/commit/5b11db74260a05f84f8cdacafb8bece5ac116630", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-29T14:22:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI2Njg4OA==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r497266888", "bodyText": "IMHO it would be helpful to explain that apart from the given message, the clientFacingMessage will be set to a certain key. This is also true for the other exception classes. WDYT?", "author": "sophokles73", "createdAt": "2020-09-30T06:20:08Z", "path": "client/src/main/java/org/eclipse/hono/client/NoConsumerException.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.client;\n+\n+import java.net.HttpURLConnection;\n+\n+/**\n+ * A {@link ServerErrorException} indicating that there is no consumer for the request message.\n+ */\n+public class NoConsumerException extends ServerErrorException {\n+\n+    /**\n+     * Resource key for the client facing error message.\n+     */\n+    public static final String CLIENT_FACING_MESSAGE_KEY = \"SERVER_ERROR_NO_CONSUMER\";\n+\n+    /**\n+     * Creates a new NoConsumerException.", "originalCommit": "5b11db74260a05f84f8cdacafb8bece5ac116630", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5NDU5Mg==", "url": "https://github.com/eclipse/hono/pull/2185#discussion_r497394592", "bodyText": "I've amended the commit accordingly.", "author": "calohmn", "createdAt": "2020-09-30T10:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI2Njg4OA=="}], "type": "inlineReview"}, {"oid": "6d7b8c9d8bb722d10a23f18854efec5311cebbed", "url": "https://github.com/eclipse/hono/commit/6d7b8c9d8bb722d10a23f18854efec5311cebbed", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-30T10:07:42Z", "type": "commit"}, {"oid": "6d7b8c9d8bb722d10a23f18854efec5311cebbed", "url": "https://github.com/eclipse/hono/commit/6d7b8c9d8bb722d10a23f18854efec5311cebbed", "message": "[#2166] Improve 503 error messages in HTTP adapter.\n\nAlso improve the corresponding documentation for the\nHTTP adapter and CoAP adapter.\n\nSigned-off-by: Carsten Lohmann <carsten.lohmann@bosch.io>", "committedDate": "2020-09-30T10:07:42Z", "type": "forcePushed"}]}