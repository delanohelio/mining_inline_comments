{"pr_number": 8534, "pr_title": "Avoid roads export import", "pr_createdAt": "2020-02-21T16:12:57Z", "pr_url": "https://github.com/osmandapp/OsmAnd/pull/8534", "timeline": [{"oid": "a0ce3b60fec1d2c56afdd5fd908e02c85401241b", "url": "https://github.com/osmandapp/OsmAnd/commit/a0ce3b60fec1d2c56afdd5fd908e02c85401241b", "message": "avoid roads export import", "committedDate": "2020-02-20T16:34:27Z", "type": "commit"}, {"oid": "a685cf4637410c57ccc0da8a92ce52746a9c0d4b", "url": "https://github.com/osmandapp/OsmAnd/commit/a685cf4637410c57ccc0da8a92ce52746a9c0d4b", "message": "Merge remote-tracking branch 'origin/import_screen' into avoid_roads_export_import", "committedDate": "2020-02-20T16:59:05Z", "type": "commit"}, {"oid": "321aa96846e48d3c051c09e04b823735cac4992a", "url": "https://github.com/osmandapp/OsmAnd/commit/321aa96846e48d3c051c09e04b823735cac4992a", "message": "avoid roads, refactor, corrections", "committedDate": "2020-02-21T16:03:28Z", "type": "commit"}, {"oid": "a28d9f84c44e0e620464167a9c83d22250d368e3", "url": "https://github.com/osmandapp/OsmAnd/commit/a28d9f84c44e0e620464167a9c83d22250d368e3", "message": "expand check_box clickable area", "committedDate": "2020-02-21T16:51:12Z", "type": "commit"}, {"oid": "ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "url": "https://github.com/osmandapp/OsmAnd/commit/ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "message": "collapsing toolbar", "committedDate": "2020-02-24T14:34:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1MDM0Ng==", "url": "https://github.com/osmandapp/OsmAnd/pull/8534#discussion_r383350346", "bodyText": "Simplify", "author": "max-klaus", "createdAt": "2020-02-24T15:55:39Z", "path": "OsmAnd/src/net/osmand/plus/SettingsHelper.java", "diffHunk": "@@ -801,7 +805,7 @@ SettingsItemReader getReader() {\n \t\t\t\t@Override\n \t\t\t\tpublic void readFromStream(@NonNull InputStream inputStream) throws IOException, IllegalArgumentException {\n \t\t\t\t\tOutputStream output;\n-\t\t\t\t\tif (shouldReplace || !file.exists()) {\n+\t\t\t\t\tif (!file.exists() || file.exists() && shouldReplace) {", "originalCommit": "ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1MDU0OA==", "url": "https://github.com/osmandapp/OsmAnd/pull/8534#discussion_r383350548", "bodyText": "Implement in superclass", "author": "max-klaus", "createdAt": "2020-02-24T15:55:56Z", "path": "OsmAnd/src/net/osmand/plus/SettingsHelper.java", "diffHunk": "@@ -1440,6 +1447,204 @@ public boolean writeToStream(@NonNull OutputStream outputStream) throws IOExcept\n \t\t}\n \t}\n \n+\tpublic static class AvoidRoadsSettingsItem extends CollectionSettingsItem<AvoidRoadInfo> {\n+\n+\t\tprivate OsmandApplication app;\n+\t\tprivate OsmandSettings settings;\n+\t\tprivate AvoidSpecificRoads specificRoads;\n+\n+\t\tpublic AvoidRoadsSettingsItem(@NonNull OsmandApplication app, @NonNull List<AvoidRoadInfo> items) {\n+\t\t\tsuper(SettingsItemType.AVOID_ROADS, items);\n+\t\t\tthis.app = app;\n+\t\t\tsettings = app.getSettings();\n+\t\t\tspecificRoads = app.getAvoidSpecificRoads();\n+\t\t\texistingItems = new ArrayList<>(specificRoads.getImpassableRoads().values());\n+\t\t\tduplicateItems = new ArrayList<>();\n+\t\t}\n+\n+\t\tAvoidRoadsSettingsItem(@NonNull OsmandApplication app, @NonNull JSONObject json) throws JSONException {\n+\t\t\tsuper(SettingsItemType.AVOID_ROADS, json);\n+\t\t\tthis.app = app;\n+\t\t\tsettings = app.getSettings();\n+\t\t\tspecificRoads = app.getAvoidSpecificRoads();\n+\t\t\texistingItems = new ArrayList<>(specificRoads.getImpassableRoads().values());\n+\t\t\tduplicateItems = new ArrayList<>();\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getName() {\n+\t\t\treturn \"avoid_roads\";\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getPublicName(@NonNull Context ctx) {\n+\t\t\treturn \"avoid_roads\";\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getFileName() {\n+\t\t\treturn getName() + \".json\";\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic void apply() {\n+\t\t\tif (!items.isEmpty() || !duplicateItems.isEmpty()) {\n+\t\t\t\tfor (AvoidRoadInfo duplicate : duplicateItems) {\n+\t\t\t\t\tif (shouldReplace) {\n+\t\t\t\t\t\tLatLon latLon = new LatLon(duplicate.latitude, duplicate.longitude);\n+\t\t\t\t\t\tif (settings.removeImpassableRoad(latLon)) {\n+\t\t\t\t\t\t\tsettings.addImpassableRoad(duplicate);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tsettings.addImpassableRoad(renameItem(duplicate));\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tfor (AvoidRoadInfo avoidRoad : items) {\n+\t\t\t\t\tsettings.addImpassableRoad(avoidRoad);\n+\t\t\t\t}\n+\t\t\t\tspecificRoads.loadImpassableRoads();\n+\t\t\t\tspecificRoads.initRouteObjects(true);\n+\t\t\t}\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic List<AvoidRoadInfo> excludeDuplicateItems() {", "originalCommit": "ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1MDczOQ==", "url": "https://github.com/osmandapp/OsmAnd/pull/8534#discussion_r383350739", "bodyText": "Implement equals in AvoidRoadInfo", "author": "max-klaus", "createdAt": "2020-02-24T15:56:14Z", "path": "OsmAnd/src/net/osmand/plus/SettingsHelper.java", "diffHunk": "@@ -1440,6 +1447,204 @@ public boolean writeToStream(@NonNull OutputStream outputStream) throws IOExcept\n \t\t}\n \t}\n \n+\tpublic static class AvoidRoadsSettingsItem extends CollectionSettingsItem<AvoidRoadInfo> {\n+\n+\t\tprivate OsmandApplication app;\n+\t\tprivate OsmandSettings settings;\n+\t\tprivate AvoidSpecificRoads specificRoads;\n+\n+\t\tpublic AvoidRoadsSettingsItem(@NonNull OsmandApplication app, @NonNull List<AvoidRoadInfo> items) {\n+\t\t\tsuper(SettingsItemType.AVOID_ROADS, items);\n+\t\t\tthis.app = app;\n+\t\t\tsettings = app.getSettings();\n+\t\t\tspecificRoads = app.getAvoidSpecificRoads();\n+\t\t\texistingItems = new ArrayList<>(specificRoads.getImpassableRoads().values());\n+\t\t\tduplicateItems = new ArrayList<>();\n+\t\t}\n+\n+\t\tAvoidRoadsSettingsItem(@NonNull OsmandApplication app, @NonNull JSONObject json) throws JSONException {\n+\t\t\tsuper(SettingsItemType.AVOID_ROADS, json);\n+\t\t\tthis.app = app;\n+\t\t\tsettings = app.getSettings();\n+\t\t\tspecificRoads = app.getAvoidSpecificRoads();\n+\t\t\texistingItems = new ArrayList<>(specificRoads.getImpassableRoads().values());\n+\t\t\tduplicateItems = new ArrayList<>();\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getName() {\n+\t\t\treturn \"avoid_roads\";\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getPublicName(@NonNull Context ctx) {\n+\t\t\treturn \"avoid_roads\";\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic String getFileName() {\n+\t\t\treturn getName() + \".json\";\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic void apply() {\n+\t\t\tif (!items.isEmpty() || !duplicateItems.isEmpty()) {\n+\t\t\t\tfor (AvoidRoadInfo duplicate : duplicateItems) {\n+\t\t\t\t\tif (shouldReplace) {\n+\t\t\t\t\t\tLatLon latLon = new LatLon(duplicate.latitude, duplicate.longitude);\n+\t\t\t\t\t\tif (settings.removeImpassableRoad(latLon)) {\n+\t\t\t\t\t\t\tsettings.addImpassableRoad(duplicate);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tsettings.addImpassableRoad(renameItem(duplicate));\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tfor (AvoidRoadInfo avoidRoad : items) {\n+\t\t\t\t\tsettings.addImpassableRoad(avoidRoad);\n+\t\t\t\t}\n+\t\t\t\tspecificRoads.loadImpassableRoads();\n+\t\t\t\tspecificRoads.initRouteObjects(true);\n+\t\t\t}\n+\t\t}\n+\n+\t\t@NonNull\n+\t\t@Override\n+\t\tpublic List<AvoidRoadInfo> excludeDuplicateItems() {\n+\t\t\tfor (AvoidRoadInfo item : items) {\n+\t\t\t\tif (isDuplicate(item)) {\n+\t\t\t\t\tduplicateItems.add(item);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\titems.removeAll(duplicateItems);\n+\t\t\treturn duplicateItems;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic boolean isDuplicate(@NonNull AvoidRoadInfo item) {\n+\t\t\tfor (AvoidRoadInfo existingItem : existingItems) {\n+\t\t\t\tif (item.latitude == existingItem.latitude", "originalCommit": "ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NDgyOA==", "url": "https://github.com/osmandapp/OsmAnd/pull/8534#discussion_r383364828", "bodyText": "Replace with if (items.contains(item))", "author": "max-klaus", "createdAt": "2020-02-24T16:18:21Z", "path": "OsmAnd/src/net/osmand/plus/SettingsHelper.java", "diffHunk": "@@ -1622,7 +1830,12 @@ void importItems(@NonNull File file, @NonNull List<SettingsItem> items) throws I\n \t\t\t\t\t\tif (item != null && collecting && item.shouldReadOnCollecting()\n \t\t\t\t\t\t\t\t|| item != null && !collecting && !item.shouldReadOnCollecting()) {\n \t\t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\t\titem.getReader().readFromStream(ois);\n+\t\t\t\t\t\t\t\tfor (SettingsItem settingsItem : items) {", "originalCommit": "ff570d4b8103f73c172785a6cfe0b4eb6eaa33a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "edbba11ed7ea0f300f65fc265a899fce252da65d", "url": "https://github.com/osmandapp/OsmAnd/commit/edbba11ed7ea0f300f65fc265a899fce252da65d", "message": "refactor, fix map screen between fragments", "committedDate": "2020-02-24T17:12:14Z", "type": "commit"}, {"oid": "170fb4be54015e1f8b2ae1869d79981bfe234161", "url": "https://github.com/osmandapp/OsmAnd/commit/170fb4be54015e1f8b2ae1869d79981bfe234161", "message": "refactor", "committedDate": "2020-02-24T17:18:46Z", "type": "commit"}, {"oid": "4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "url": "https://github.com/osmandapp/OsmAnd/commit/4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "message": "delete translations of renamed string", "committedDate": "2020-02-24T17:23:05Z", "type": "commit"}, {"oid": "4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "url": "https://github.com/osmandapp/OsmAnd/commit/4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "message": "delete translations of renamed string", "committedDate": "2020-02-24T17:23:05Z", "type": "forcePushed"}, {"oid": "4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "url": "https://github.com/osmandapp/OsmAnd/commit/4fc18f0783d755e42b1e66a1573f3e61c189f4ea", "message": "delete translations of renamed string", "committedDate": "2020-02-24T17:23:05Z", "type": "forcePushed"}, {"oid": "fb428c931b89a35b596023bb1af826324ef9c223", "url": "https://github.com/osmandapp/OsmAnd/commit/fb428c931b89a35b596023bb1af826324ef9c223", "message": "refactor duplicateItems", "committedDate": "2020-02-25T09:05:27Z", "type": "commit"}, {"oid": "123274a614f242eb578617bc739e10f02d301a0d", "url": "https://github.com/osmandapp/OsmAnd/commit/123274a614f242eb578617bc739e10f02d301a0d", "message": "strings sc conflict", "committedDate": "2020-02-25T09:15:48Z", "type": "commit"}, {"oid": "03fd1234190e20e32397c078e6cbc01e89b8986a", "url": "https://github.com/osmandapp/OsmAnd/commit/03fd1234190e20e32397c078e6cbc01e89b8986a", "message": "Merge branch 'r3.6' into avoid_roads_export_import", "committedDate": "2020-02-25T09:20:07Z", "type": "commit"}, {"oid": "38919196f08c8f44f6deca1ab1df911cccf787c5", "url": "https://github.com/osmandapp/OsmAnd/commit/38919196f08c8f44f6deca1ab1df911cccf787c5", "message": "settingsImporter refactor", "committedDate": "2020-02-25T10:00:51Z", "type": "commit"}, {"oid": "dd35175ae4f8fb2604bb1cc9a5ce42ab01e64f6a", "url": "https://github.com/osmandapp/OsmAnd/commit/dd35175ae4f8fb2604bb1cc9a5ce42ab01e64f6a", "message": "refactor import layout", "committedDate": "2020-02-25T10:48:20Z", "type": "commit"}, {"oid": "ae7fd7710a9c72dc5e94d332721a4271191cb531", "url": "https://github.com/osmandapp/OsmAnd/commit/ae7fd7710a9c72dc5e94d332721a4271191cb531", "message": "refactor & app bar shadow", "committedDate": "2020-02-25T11:23:42Z", "type": "commit"}]}