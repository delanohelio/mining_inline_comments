{"pr_number": 1114, "pr_title": "Configure `TransportObserver` via `ConnectionFactory` on the client-side", "pr_createdAt": "2020-08-01T03:11:51Z", "pr_url": "https://github.com/apple/servicetalk/pull/1114", "timeline": [{"oid": "1c9f13626ed6cb6f747989dcf1f87166a470529c", "url": "https://github.com/apple/servicetalk/commit/1c9f13626ed6cb6f747989dcf1f87166a470529c", "message": "Configure `TransportObserver` via `ConnectionFactory` on the client-side\n\nMotivation:\n\nHaving `TransportObserver` on `ConnectionFactory#newConnection` method gives\nusers more flexibility when they need to correlate prior events and a state\nwith observability events of new connections. It also allows them to choose\nfor which `ResolvedAddress`es they need an observer.\n\nModification:\n\n- Add `TransportObserver` as a second argument for\n`ConnectionFactory#newConnection`;\n- Remove `#transportObserver(...)` configuration method from all client builders;\n- Update code to use new `ConnectionFactory` API;\n\nResults:\n\nMore flexible approach for users to configure `TransportObserver` on the\nclient-side.", "committedDate": "2020-08-01T00:05:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYyMDk5NA==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r464620994", "bodyText": "IIUC, expected usage is to add a ConnectionFactory for a client that introduces a TransportObserver for the call.\nWhat is the guidance for such factories if there is already an observer passed to them?", "author": "NiteshKant", "createdAt": "2020-08-03T19:36:03Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ConnectionFactory.java", "diffHunk": "@@ -31,7 +34,9 @@\n      * Creates and asynchronously returns a connection.\n      *\n      * @param address to connect.\n+     * @param observer {@link TransportObserver} that provides visibility into transport events associated with a new\n+     * connection.\n      * @return {@link Single} that emits the created connection.\n      */\n-    Single<C> newConnection(ResolvedAddress address);\n+    Single<C> newConnection(ResolvedAddress address, @Nullable TransportObserver observer);", "originalCommit": "1c9f13626ed6cb6f747989dcf1f87166a470529c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1MjQ3Ng==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r464652476", "bodyText": "Good question!\nI plan to add a BiTransportObserver implementation later that will merge two observers into one, when necessary. Something similar to BiDnsQueryLifecycleObserverFactory in netty.\nThat will be useful for the server-side as well, when users need to report metrics data to 2+ systems simultaneously.", "author": "idelpivnitskiy", "createdAt": "2020-08-03T20:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYyMDk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NDUxNA==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r464744514", "bodyText": "Added TransportObserverConnectionFactoryFilter that uses BiTransportObserver internally, ptal: 0e98ded", "author": "idelpivnitskiy", "createdAt": "2020-08-04T01:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYyMDk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYyMTk0Nw==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r464621947", "bodyText": "Instead of repeating the TransportObserver definition, just say {@link TransportObserver} for the newly created connections?", "author": "NiteshKant", "createdAt": "2020-08-03T19:38:20Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/ConnectionFactory.java", "diffHunk": "@@ -31,7 +34,9 @@\n      * Creates and asynchronously returns a connection.\n      *\n      * @param address to connect.\n+     * @param observer {@link TransportObserver} that provides visibility into transport events associated with a new", "originalCommit": "1c9f13626ed6cb6f747989dcf1f87166a470529c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYyMzM1NA==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r464623354", "bodyText": "Add a comment why we are passing null here?", "author": "NiteshKant", "createdAt": "2020-08-03T19:41:20Z", "path": "servicetalk-loadbalancer/src/main/java/io/servicetalk/loadbalancer/RoundRobinLoadBalancer.java", "diffHunk": "@@ -273,7 +273,7 @@ public void onComplete() {\n         }\n \n         // No connection was selected: create a new one\n-        return connectionFactory.newConnection(host.address)\n+        return connectionFactory.newConnection(host.address, null)", "originalCommit": "1c9f13626ed6cb6f747989dcf1f87166a470529c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2b9d244ac716dd72b0cf1b84161bea97cc33f36", "url": "https://github.com/apple/servicetalk/commit/f2b9d244ac716dd72b0cf1b84161bea97cc33f36", "message": "Address comments", "committedDate": "2020-08-03T20:41:18Z", "type": "commit"}, {"oid": "8a3864ad4a1031ca8a3dc4b1aa01c21553c87993", "url": "https://github.com/apple/servicetalk/commit/8a3864ad4a1031ca8a3dc4b1aa01c21553c87993", "message": "Fix javadoc warnings", "committedDate": "2020-08-03T20:41:28Z", "type": "commit"}, {"oid": "a8d32daefb0760c21895bb67879f9c14b9197e54", "url": "https://github.com/apple/servicetalk/commit/a8d32daefb0760c21895bb67879f9c14b9197e54", "message": "Update copyright years", "committedDate": "2020-08-03T20:44:39Z", "type": "commit"}, {"oid": "0e98ded1b654c0db6ea471ff72f3dd042f87701f", "url": "https://github.com/apple/servicetalk/commit/0e98ded1b654c0db6ea471ff72f3dd042f87701f", "message": "Add TransportObserverConnectionFactoryFilter", "committedDate": "2020-08-04T01:19:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjQ4MQ==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465202481", "bodyText": "requireNotNull?", "author": "NiteshKant", "createdAt": "2020-08-04T17:10:38Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/BiTransportObserver.java", "diffHunk": "@@ -0,0 +1,351 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.client.api;\n+\n+import io.servicetalk.transport.api.ConnectionInfo;\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.DataObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.MultiplexedObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.ReadObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.SecurityHandshakeObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.StreamObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.WriteObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import javax.net.ssl.SSLSession;\n+\n+/**\n+ * Combines two {@link TransportObserver}s into a single {@link TransportObserver}.\n+ */\n+final class BiTransportObserver implements TransportObserver {\n+\n+    private final TransportObserver first;\n+    private final TransportObserver second;\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param first the {@link TransportObserver} that will receive events first\n+     * @param second the {@link TransportObserver} that will receive events second\n+     */\n+    BiTransportObserver(final TransportObserver first, final TransportObserver second) {\n+        this.first = first;", "originalCommit": "0e98ded1b654c0db6ea471ff72f3dd042f87701f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NTU2Mw==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465355563", "bodyText": "This is an internal class and we do null-check upfront. At this time caller code does not expect any exception.", "author": "idelpivnitskiy", "createdAt": "2020-08-04T22:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NzE1Ng==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465357156", "bodyText": "I think you wanted to make it public at some point? It is your call but standalone pig-private classes are good to be coded as if one day they will be public. If they are inner-class then the assumptions are valid.", "author": "NiteshKant", "createdAt": "2020-08-04T22:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMjQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMzY1MA==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465203650", "bodyText": "If first and second both throw then because second is called from a finally block, the first exception is lost. An alternative is to add separate try-catch blocks for each observer which also extends generically to n observers.", "author": "NiteshKant", "createdAt": "2020-08-04T17:12:41Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/BiTransportObserver.java", "diffHunk": "@@ -0,0 +1,351 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.client.api;\n+\n+import io.servicetalk.transport.api.ConnectionInfo;\n+import io.servicetalk.transport.api.ConnectionObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.DataObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.MultiplexedObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.ReadObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.SecurityHandshakeObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.StreamObserver;\n+import io.servicetalk.transport.api.ConnectionObserver.WriteObserver;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import javax.net.ssl.SSLSession;\n+\n+/**\n+ * Combines two {@link TransportObserver}s into a single {@link TransportObserver}.\n+ */\n+final class BiTransportObserver implements TransportObserver {\n+\n+    private final TransportObserver first;\n+    private final TransportObserver second;\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param first the {@link TransportObserver} that will receive events first\n+     * @param second the {@link TransportObserver} that will receive events second\n+     */\n+    BiTransportObserver(final TransportObserver first, final TransportObserver second) {\n+        this.first = first;\n+        this.second = second;\n+    }\n+\n+    @Override\n+    public ConnectionObserver onNewConnection() {\n+        return new BiConnectionObserver(first.onNewConnection(), second.onNewConnection());\n+    }\n+\n+    private static final class BiConnectionObserver implements ConnectionObserver {\n+\n+        private final ConnectionObserver first;\n+        private final ConnectionObserver second;\n+\n+        private BiConnectionObserver(final ConnectionObserver first, final ConnectionObserver second) {\n+            this.first = first;\n+            this.second = second;\n+        }\n+\n+        @Override\n+        public void onDataRead(final int size) {\n+            try {\n+                first.onDataRead(size);\n+            } finally {\n+                second.onDataRead(size);", "originalCommit": "0e98ded1b654c0db6ea471ff72f3dd042f87701f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NTY0OQ==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465345649", "bodyText": "I wanted to avoid safety guarantees for this implementation. Do you mind if I remove all try-catch blocks and will assume that first/second observers are never throw?\nThey can be wrapped by CatchAllTransportObserver impl as we discussed before.", "author": "idelpivnitskiy", "createdAt": "2020-08-04T21:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMzY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NzI3OQ==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465357279", "bodyText": "ok that sounds fair", "author": "NiteshKant", "createdAt": "2020-08-04T22:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwMzY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNjI3NA==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465206274", "bodyText": "Is creating a TransportObserver per subscribe what we want semantically? It seems to be conflicting with the fact that the argument to newConnection() is a TransportObserver and not a factory.", "author": "NiteshKant", "createdAt": "2020-08-04T17:17:11Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/TransportObserverConnectionFactoryFilter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright \u00a9 2020 Apple Inc. and the ServiceTalk project authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.servicetalk.client.api;\n+\n+import io.servicetalk.concurrent.api.ListenableAsyncCloseable;\n+import io.servicetalk.concurrent.api.Single;\n+import io.servicetalk.transport.api.TransportObserver;\n+\n+import java.util.function.Function;\n+import javax.annotation.Nullable;\n+\n+import static io.servicetalk.concurrent.api.Single.defer;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * A {@link ConnectionFactoryFilter} that configures a {@link TransportObserver} for new connections.\n+ *\n+ * @param <ResolvedAddress> The type of a resolved address that can be used for connecting.\n+ * @param <C> The type of connections created by the {@link ConnectionFactory} decorated by this filter.\n+ */\n+public final class TransportObserverConnectionFactoryFilter<ResolvedAddress, C extends ListenableAsyncCloseable>\n+        implements ConnectionFactoryFilter<ResolvedAddress, C> {\n+\n+    private final Function<ResolvedAddress, TransportObserver> observerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param observer {@link TransportObserver} to use for new connections\n+     */\n+    public TransportObserverConnectionFactoryFilter(final TransportObserver observer) {\n+        requireNonNull(observer);\n+        observerFactory = __ -> observer;\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     *\n+     * @param observerFactory a factory to create a {@link TransportObserver} for new connections\n+     */\n+    public TransportObserverConnectionFactoryFilter(\n+            final Function<ResolvedAddress, TransportObserver> observerFactory) {\n+        this.observerFactory = requireNonNull(observerFactory);\n+    }\n+\n+    @Override\n+    public ConnectionFactory<ResolvedAddress, C> create(final ConnectionFactory<ResolvedAddress, C> original) {\n+        return new DelegatingConnectionFactory<ResolvedAddress, C>(original) {\n+            @Override\n+            public Single<C> newConnection(final ResolvedAddress resolvedAddress,\n+                                           @Nullable final TransportObserver originalObserver) {\n+                return defer(() -> {\n+                    final TransportObserver newObserver = requireNonNull(observerFactory.apply(resolvedAddress));", "originalCommit": "0e98ded1b654c0db6ea471ff72f3dd042f87701f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NTY3Ng==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465345676", "bodyText": "TransportObserver technically is a factory for ConnectionObservers. Therefore, I don't see a strong need to provide another level of abstraction for that internally in the transport.\nHere we also have access to ResolvedAddress and it's an opportunity for us to let users decide if they need a TransportObserver for this address or not and what instance of TransportObserver they need.\nBtw, let me remote the requireNonNull from here and allow null values.", "author": "idelpivnitskiy", "createdAt": "2020-08-04T21:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNjI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0ODc5Nw==", "url": "https://github.com/apple/servicetalk/pull/1114#discussion_r465348797", "bodyText": "Actually, we don't need to create a new TransportObserver per subscribe. We can remove defer operator.", "author": "idelpivnitskiy", "createdAt": "2020-08-04T21:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIwNjI3NA=="}], "type": "inlineReview"}, {"oid": "6b98e36bc4ab34ad58510b10b72c418047d3b4b8", "url": "https://github.com/apple/servicetalk/commit/6b98e36bc4ab34ad58510b10b72c418047d3b4b8", "message": "Address comments", "committedDate": "2020-08-04T22:00:55Z", "type": "commit"}, {"oid": "d12f4da7fc4efbf567a1c3308d04a8c7824231d7", "url": "https://github.com/apple/servicetalk/commit/d12f4da7fc4efbf567a1c3308d04a8c7824231d7", "message": "BiTransportObserver requireNonNull", "committedDate": "2020-08-04T22:17:41Z", "type": "commit"}]}