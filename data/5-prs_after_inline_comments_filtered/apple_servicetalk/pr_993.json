{"pr_number": 993, "pr_title": "Replace ConcurrentSubscription with DelayedCancellable when synchronous request(Long.MAX_VALUE)", "pr_createdAt": "2020-04-02T00:06:15Z", "pr_url": "https://github.com/apple/servicetalk/pull/993", "timeline": [{"oid": "cd614798b4dcc02cecfc298b0f08003f123551c2", "url": "https://github.com/apple/servicetalk/commit/cd614798b4dcc02cecfc298b0f08003f123551c2", "message": "Replace ConcurrentSubscription with DelayedCancellable when synchronous request(Long.MAX_VALUE)\n\nMotivation:\nThere are some operators which convert from Publisher to Completable or\nSingle. Since the demand for Completable and Single is implicit on\nsubscribe(..) these operators need to simulate the demand in\nonSubscribe. In order to prevent concurrent access on the Subscription\nwith the downstream Subscriber and the synchornous requestN call it is\nwrapped in a ConcurrentSubscription. However ConcurrentSubscription has\nto coordinate between two methods and is inheritly more complicated than\nDelayedCancellable. We can use DelayedCancellable which is a simpler\noperation at the cost of requesting demand before propagating\nsynchronous cancel operation. This isn't perceived as a deal breaker\nbecause demand is implicit anyways, and cancel is best effort.\n\nModifications:\n- When converting from Publisher to Completable or Single use\nDelayedCancellable instead of ConcurrentSubscription\n\nResult:\nLess complicated and less expensive conversion from Subscription to\nCancellable when converting from Publisher to Single or Completable.", "committedDate": "2020-04-02T00:05:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ0MjQwNA==", "url": "https://github.com/apple/servicetalk/pull/993#discussion_r402442404", "bodyText": "Looks like we can just extend DelayedCancellable now.\nfinal class ForEachSubscriber<T> extends DelayedCancellable implements Subscriber<T> {\n\n    @Override\n    public void onSubscribe(Subscription s) {\n        s.request(Long.MAX_VALUE);\n        delayedCancellable(s);\n    }\n}\nAlso for all other classes in this PR", "author": "NiteshKant", "createdAt": "2020-04-02T16:21:51Z", "path": "servicetalk-concurrent-api/src/main/java/io/servicetalk/concurrent/api/ForEachSubscriber.java", "diffHunk": "@@ -40,11 +39,12 @@\n \n     @Override\n     public void onSubscribe(Subscription s) {\n-        // We wrap the subscription into ConcurrentSubscription as cancel on SequentialCancellable (this) can be\n+        // We wrap the subscription into DelayedCancellable as cancel on SequentialCancellable (this) can be\n         // concurrent with the request-n below.\n-        ConcurrentSubscription cs = wrap(s);\n-        nextCancellable(cs::cancel);\n-        cs.request(Long.MAX_VALUE);\n+        DelayedCancellable delayedCancellable = new DelayedCancellable();", "originalCommit": "cd614798b4dcc02cecfc298b0f08003f123551c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2MTM0MA==", "url": "https://github.com/apple/servicetalk/pull/993#discussion_r402461340", "bodyText": "hum good point ... I will change this class to extend DelayedCancellable. however in the other cases where the Cancellable isn't exposed externally I think it makes more sense to keep to the local allocation in onSubscribe as the memory can be reclaimed asap, and may even be stack allocated because it is local scope and doesn't escape.", "author": "Scottmitch", "createdAt": "2020-04-02T16:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ0MjQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3NjkxOA==", "url": "https://github.com/apple/servicetalk/pull/993#discussion_r402476918", "bodyText": "actually forget what I said ... the DelayedCancellable does escape to the Subscriber ... change made!", "author": "Scottmitch", "createdAt": "2020-04-02T17:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ0MjQwNA=="}], "type": "inlineReview"}, {"oid": "0b1773df57bee4ee1d12b09aee0efbfa8e0c7c07", "url": "https://github.com/apple/servicetalk/commit/0b1773df57bee4ee1d12b09aee0efbfa8e0c7c07", "message": "ForEachSubscriber to extend DelayedCancellable", "committedDate": "2020-04-02T16:50:43Z", "type": "commit"}, {"oid": "ebd942c2b4f580b13556b237f17134e678406fe8", "url": "https://github.com/apple/servicetalk/commit/ebd942c2b4f580b13556b237f17134e678406fe8", "message": "PayloadPump to extend DelayedCancellable", "committedDate": "2020-04-02T16:53:06Z", "type": "commit"}, {"oid": "427f55303f86e11b82a79bc635a916be01123e38", "url": "https://github.com/apple/servicetalk/commit/427f55303f86e11b82a79bc635a916be01123e38", "message": "remaining cases to extend DelayedCancellable", "committedDate": "2020-04-02T17:14:42Z", "type": "commit"}]}