{"pr_number": 936, "pr_title": "`HttpObjectEncoder` should always allocate direct outbound buffers", "pr_createdAt": "2020-02-12T20:19:33Z", "pr_url": "https://github.com/apple/servicetalk/pull/936", "timeline": [{"oid": "f66f66104a2173d468c3dabd36ece04758643090", "url": "https://github.com/apple/servicetalk/commit/f66f66104a2173d468c3dabd36ece04758643090", "message": "`HttpObjectEncoder` should always allocate direct outbound buffers\n\nMotivation:\n\n`HttpObjectEncoder` internally allocates buffers that will be\npassed to the transport or `OPENSSL` handler, both require direct\nmemory for processing. We should explicitly allocate direct memory\nin outbound handler to prevent from slowing down (by introducing\nadditional copying from heap to direct memory) when users specify\n`io.netty.noPreferDirectFlag=true` system property.\n\nModifications:\n\n- Explicitly allocate direct pooled buffers in `HttpObjectEncoder`;\n\nResult:\n\nBuffers allocated in `HttpObjectEncoder` will always use direct\npooled memory and won't be copied by transport or `OPENSSL` handler.", "committedDate": "2020-02-12T20:18:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r378493094", "bodyText": "Transport needs direct memory for the outgoing data and after this handler users do not touch buffers anymore. So, this helps to prevent additional copy in transport when users configure buffer allocator to prefer heap memory.\n@normanmaurer as there any specific reason to use buffer method here instead of directBuffer or ioBuffer in similar handler in netty?\nhttps://github.com/netty/netty/blob/fcf55fcf718af1e4cae85eb86cdb679094186aed/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectEncoder.java#L93", "author": "idelpivnitskiy", "createdAt": "2020-02-12T20:24:54Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/HttpObjectEncoder.java", "diffHunk": "@@ -125,7 +125,7 @@ public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)\n             // We prefer a direct allocation here because it is expected the resulted encoded Buffer will be written\n             // to a socket. In order to do the write to the socket the memory typically needs to be allocated in direct\n             // memory and will be copied to direct memory if not. Using a direct buffer will avoid the copy.\n-            ByteBuf byteBuf = POOLED_ALLOCATOR.buffer((int) headersEncodedSizeAccumulator);\n+            ByteBuf byteBuf = POOLED_ALLOCATOR.directBuffer((int) headersEncodedSizeAccumulator);", "originalCommit": "f66f66104a2173d468c3dabd36ece04758643090", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcxNTM4OQ==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r378715389", "bodyText": "usually we use buffer so the user has pretty much control over what type of buffer is allocated. And by default buffer(...) will return a direct buffer in netty anyway", "author": "normanmaurer", "createdAt": "2020-02-13T08:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwMDk3NQ==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r379000975", "bodyText": "Agreed, this is by default in netty. But this \"control\" leads to overhead, because transport needs to copy to direct memory anyway. Not sure about netty, because users may have other handlers between transport and HttpObjectEncoder with their logic, but for ST I think it makes sense to always use direct buffers here.", "author": "idelpivnitskiy", "createdAt": "2020-02-13T17:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MzExOA==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r379073118", "bodyText": "@idelpivnitskiy looks like @normanmaurer is saying that buffer() will anways return direct buffers. Is this change just to be explicit or you found an issue?", "author": "NiteshKant", "createdAt": "2020-02-13T19:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA4Njk0NA==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r379086944", "bodyText": "@NiteshKant he is saying that this is by default in netty, but the actual type depends on the configuration of the provided buffer allocator or io.netty.noPreferDirectFlag=true system property. This is outgoing path and transport anyway requires direct memory. So, to reduce overhead of copying from heap to direct memory at transport level, we should ignore what users prefer and always use direct buffers here. Their preference of heap memory makes sense only when they allocate buffers in code they control, but not in transport or this encoder.", "author": "idelpivnitskiy", "createdAt": "2020-02-13T19:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2MDg0NQ==", "url": "https://github.com/apple/servicetalk/pull/936#discussion_r379660845", "bodyText": "got it, thanks!", "author": "NiteshKant", "createdAt": "2020-02-14T21:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5MzA5NA=="}], "type": "inlineReview"}]}