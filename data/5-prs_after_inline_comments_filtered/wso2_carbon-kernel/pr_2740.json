{"pr_number": 2740, "pr_title": "Cache username in the get user flow", "pr_createdAt": "2020-08-10T08:02:04Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2740", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0OTc0NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467749744", "bodyText": "I guess we should be able to use the UserCoreUtil.removeDomainFromName here to get the domainFreeUserName?", "author": "ashensw", "createdAt": "2020-08-10T08:15:48Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserUniqueIDManger.java", "diffHunk": "@@ -67,20 +68,36 @@ public User addUser(String username, String profileName, AbstractUserStoreManage\n     public User getUser(String uniqueId, AbstractUserStoreManager userStoreManager)\n             throws UserStoreException {\n \n-        String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+        String userName = userStoreManager.getFromUserNameCache(uniqueId);\n+        if (StringUtils.isEmpty(userName)) {\n \n-        if (usernames.length > 1) {\n-            throw new UserStoreException(\"More than one user presents with the same user unique id.\");\n-        }\n+            String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+\n+            if (usernames.length > 1) {\n+                throw new UserStoreException(\"More than one user presents with the same user unique id.\");\n+            }\n \n-        if (usernames.length == 0) {\n-            return null;\n+            if (usernames.length == 0) {\n+                return null;\n+            }\n+            userName = usernames[0];\n+            UserStore userStore = userStoreManager.getUserStoreWithID(uniqueId);\n+            String[] userNames = userName.split(CarbonConstants.DOMAIN_SEPARATOR);\n+            String domainFreeUserName;\n+\n+            if (userNames.length > 1) {\n+                domainFreeUserName = userNames[1];\n+            } else {\n+                domainFreeUserName = userName;\n+            }", "originalCommit": "130650e1998579f81d6e02b952e30d18165104e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MDQ1MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467790450", "bodyText": "Resolved", "author": "Buddhimah", "createdAt": "2020-08-10T09:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0OTc0NA=="}], "type": "inlineReview"}, {"oid": "7ca55a73965f69738229c1506731613c33f06212", "url": "https://github.com/wso2/carbon-kernel/commit/7ca55a73965f69738229c1506731613c33f06212", "message": "Cache the get user flow", "committedDate": "2020-08-10T09:36:36Z", "type": "commit"}, {"oid": "7ca55a73965f69738229c1506731613c33f06212", "url": "https://github.com/wso2/carbon-kernel/commit/7ca55a73965f69738229c1506731613c33f06212", "message": "Cache the get user flow", "committedDate": "2020-08-10T09:36:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwMDE0Mw==", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467800143", "bodyText": "Ideally this cache needs to be managed outside the user-store-manager level, as it needs to keep a reference from UUID to {tenant, user-store, user-store-local-id}", "author": "ruwanta", "createdAt": "2020-08-10T09:56:54Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserUniqueIDManger.java", "diffHunk": "@@ -67,20 +68,29 @@ public User addUser(String username, String profileName, AbstractUserStoreManage\n     public User getUser(String uniqueId, AbstractUserStoreManager userStoreManager)\n             throws UserStoreException {\n \n-        String[] usernames = userStoreManager.getUserList(UserCoreClaimConstants.USER_ID_CLAIM_URI, uniqueId, null);\n+        String userName = userStoreManager.getFromUserNameCache(uniqueId);", "originalCommit": "7ca55a73965f69738229c1506731613c33f06212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgxNjc0NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2740#discussion_r467816744", "bodyText": "+1. Currently, the cache is managed outside of user-store-manager.  It keeps UUID/tenantId--> to {full qualified username}\nhttps://github.com/wso2/carbon-kernel/blob/4.6.x/core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/UserIdResolverCache.java#L71", "author": "IsuraD", "createdAt": "2020-08-10T10:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwMDE0Mw=="}], "type": "inlineReview"}, {"oid": "39845ba3a95d94b7f411c713df685b7f5516d651", "url": "https://github.com/wso2/carbon-kernel/commit/39845ba3a95d94b7f411c713df685b7f5516d651", "message": "Refactor user store manager level cache", "committedDate": "2020-08-10T14:30:33Z", "type": "forcePushed"}, {"oid": "46f379383d38b68db6288ec63ec93d755303b773", "url": "https://github.com/wso2/carbon-kernel/commit/46f379383d38b68db6288ec63ec93d755303b773", "message": "Refactor user store manager level cache", "committedDate": "2020-08-10T14:33:26Z", "type": "forcePushed"}, {"oid": "213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "url": "https://github.com/wso2/carbon-kernel/commit/213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "message": "Refactor user store manager level cache", "committedDate": "2020-08-10T14:37:30Z", "type": "commit"}, {"oid": "213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "url": "https://github.com/wso2/carbon-kernel/commit/213475c4ec2e9f501fab5ba60e3c8e9983302ca4", "message": "Refactor user store manager level cache", "committedDate": "2020-08-10T14:37:30Z", "type": "forcePushed"}, {"oid": "7c0557c7fc2a0910013da0178ccc4a52c11b9465", "url": "https://github.com/wso2/carbon-kernel/commit/7c0557c7fc2a0910013da0178ccc4a52c11b9465", "message": "Use already exsisting cache manager", "committedDate": "2020-08-10T15:00:01Z", "type": "forcePushed"}, {"oid": "ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "url": "https://github.com/wso2/carbon-kernel/commit/ad82c2be7df427b9d65c033a8a1a363d05d87eb8", "message": "Use already exsisting cache manager", "committedDate": "2020-08-11T04:45:21Z", "type": "forcePushed"}, {"oid": "34180e00dd45f6a1825be6336081ac8a6be6ab6b", "url": "https://github.com/wso2/carbon-kernel/commit/34180e00dd45f6a1825be6336081ac8a6be6ab6b", "message": "Use already exsisting cache manager", "committedDate": "2020-08-11T04:47:07Z", "type": "forcePushed"}, {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8", "url": "https://github.com/wso2/carbon-kernel/commit/d64cb527b474f97b2b853b67891e33e8bae1b5c8", "message": "Use already exsisting cache manager", "committedDate": "2020-08-11T05:07:08Z", "type": "commit"}, {"oid": "d64cb527b474f97b2b853b67891e33e8bae1b5c8", "url": "https://github.com/wso2/carbon-kernel/commit/d64cb527b474f97b2b853b67891e33e8bae1b5c8", "message": "Use already exsisting cache manager", "committedDate": "2020-08-11T05:07:08Z", "type": "forcePushed"}]}