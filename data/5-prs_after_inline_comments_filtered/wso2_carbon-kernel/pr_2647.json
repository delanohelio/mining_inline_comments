{"pr_number": 2647, "pr_title": "Add changes to introduce rest endpoint for tenant management", "pr_createdAt": "2020-03-30T05:02:46Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2647", "timeline": [{"oid": "da8a868d8cdced497b78777cab4a2c8ae326e07c", "url": "https://github.com/wso2/carbon-kernel/commit/da8a868d8cdced497b78777cab4a2c8ae326e07c", "message": "Add chages to introduce rest endpoint", "committedDate": "2020-03-31T09:07:41Z", "type": "commit"}, {"oid": "da8a868d8cdced497b78777cab4a2c8ae326e07c", "url": "https://github.com/wso2/carbon-kernel/commit/da8a868d8cdced497b78777cab4a2c8ae326e07c", "message": "Add chages to introduce rest endpoint", "committedDate": "2020-03-31T09:07:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyNTk5Mw==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r400825993", "bodyText": "Change the name to uuid", "author": "nilasini", "createdAt": "2020-03-31T11:05:06Z", "path": "core/org.wso2.carbon.user.api/src/main/java/org/wso2/carbon/user/api/Tenant.java", "diffHunk": "@@ -82,6 +83,26 @@\n      */\n     private String adminPassword;\n \n+    /**\n+     * Unique id of the tenant.\n+     */\n+    private String resourceId;", "originalCommit": "da8a868d8cdced497b78777cab4a2c8ae326e07c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgzNDMxMQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r400834311", "bodyText": "Remove it", "author": "nilasini", "createdAt": "2020-03-31T11:21:03Z", "path": "core/org.wso2.carbon.user.api/src/main/java/org/wso2/carbon/user/api/Tenant.java", "diffHunk": "@@ -82,6 +83,26 @@\n      */\n     private String adminPassword;\n \n+    /**\n+     * Unique id of the tenant.\n+     */\n+    private String resourceId;\n+\n+    /**\n+     * The admin user name of the tenant\n+     */\n+    private String adminUserId;\n+\n+    /**\n+     * region of the tenant admin.\n+     */\n+    private String region;", "originalCommit": "da8a868d8cdced497b78777cab4a2c8ae326e07c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a8cecbad35cfd4a9b5e086f086c35dbfa32b43d", "url": "https://github.com/wso2/carbon-kernel/commit/8a8cecbad35cfd4a9b5e086f086c35dbfa32b43d", "message": "Fix PR comments", "committedDate": "2020-03-31T13:11:53Z", "type": "commit"}, {"oid": "aff40c9609bf46538689aae7555f6fbbf64dedb2", "url": "https://github.com/wso2/carbon-kernel/commit/aff40c9609bf46538689aae7555f6fbbf64dedb2", "message": "Add pagination support for list tenants", "committedDate": "2020-04-02T12:44:36Z", "type": "commit"}, {"oid": "7e5d4f62f62f1246c4dfab629b1d041462db44dc", "url": "https://github.com/wso2/carbon-kernel/commit/7e5d4f62f62f1246c4dfab629b1d041462db44dc", "message": "Add pagination for list tenant and caching support for tenant uuid", "committedDate": "2020-04-08T06:38:59Z", "type": "commit"}, {"oid": "c0d166fd0a2550a06fe1a49996846ef2549f7537", "url": "https://github.com/wso2/carbon-kernel/commit/c0d166fd0a2550a06fe1a49996846ef2549f7537", "message": "Change the pagination param order", "committedDate": "2020-04-08T09:58:01Z", "type": "commit"}, {"oid": "050794ba51797ffe56ef8fdf265558dca3e180c1", "url": "https://github.com/wso2/carbon-kernel/commit/050794ba51797ffe56ef8fdf265558dca3e180c1", "message": "Merge branch '4.6.x' of github.com:wso2/carbon-kernel into tenantRestEndpoint", "committedDate": "2020-04-09T05:18:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3MTIwOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r405971209", "bodyText": "modify the comment. why </p?", "author": "IsuraD", "createdAt": "2020-04-09T05:53:57Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -56,12 +56,22 @@\n     protected BundleContext bundleContext;\n     protected TenantCache tenantCacheManager = TenantCache.getInstance();\n     DataSource dataSource;\n+    private static final String DB2 = \"db2\";\n+    private static final String ORACLE = \"oracle\";\n     /**\n      * Map which maps tenant domains to tenant IDs\n      * <p/>\n      * Key - tenant domain, value - tenantId\n      */\n     private TenantIdCache tenantIdCache = TenantIdCache.getInstance();\n+\n+    /**", "originalCommit": "c0d166fd0a2550a06fe1a49996846ef2549f7537", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3MzAwOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r405973009", "bodyText": "clearTenantCaches", "author": "IsuraD", "createdAt": "2020-04-09T06:00:12Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -722,6 +883,16 @@ private void clearTenantCache(int tenantId) throws UserStoreException {\n         tenantCacheManager.clearCacheEntry(new TenantIdKey(tenantId));\n     }\n \n+    private void clearTenantUniqueIDCache(String tenantUniqueID) throws UserStoreException {", "originalCommit": "c0d166fd0a2550a06fe1a49996846ef2549f7537", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3NjM0NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r405976345", "bodyText": "e is missing", "author": "IsuraD", "createdAt": "2020-04-09T06:11:11Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -825,4 +996,116 @@ private StringBuilder printCurrentStackTrace() {\n         }\n         return currentStackTraceBuilder;\n     }\n+\n+    /**\n+     * Get total number of tenant existing in the system.\n+     *\n+     * @return number of tenant count.\n+     * @throws UserStoreException Error when getting count of tenants.\n+     */\n+    private int getCountOfTenants() throws UserStoreException {\n+\n+        String sqlStmt = TenantConstants.LIST_TENANTS_COUNT_SQL;\n+        int tenantCount = 0;\n+        try (Connection dbConnection = getDBConnection();\n+             PreparedStatement prepStmt = dbConnection.prepareStatement(sqlStmt)) {\n+            try (ResultSet rs = prepStmt.executeQuery()) {\n+                if (rs.next()) {\n+                    tenantCount = Integer.parseInt(rs.getString(1));\n+                }\n+            }\n+        } catch (SQLException e) {\n+            throw new UserStoreException(\"Error occurred while retrieving tenant count\");", "originalCommit": "c0d166fd0a2550a06fe1a49996846ef2549f7537", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a26155b8b1bc1b7d13e12d6b640b443f1d5d0022", "url": "https://github.com/wso2/carbon-kernel/commit/a26155b8b1bc1b7d13e12d6b640b443f1d5d0022", "message": "Fix PR comments", "committedDate": "2020-04-09T08:44:51Z", "type": "forcePushed"}, {"oid": "8f5f394bf9a7d3f2eeef913c06e5000d55eeeb59", "url": "https://github.com/wso2/carbon-kernel/commit/8f5f394bf9a7d3f2eeef913c06e5000d55eeeb59", "message": "Fix PR comments", "committedDate": "2020-04-09T11:44:21Z", "type": "forcePushed"}, {"oid": "f714409c53e7f67ddf0831833ce112aa26dd8cfc", "url": "https://github.com/wso2/carbon-kernel/commit/f714409c53e7f67ddf0831833ce112aa26dd8cfc", "message": "Fix PR comments", "committedDate": "2020-04-09T14:16:58Z", "type": "commit"}, {"oid": "f714409c53e7f67ddf0831833ce112aa26dd8cfc", "url": "https://github.com/wso2/carbon-kernel/commit/f714409c53e7f67ddf0831833ce112aa26dd8cfc", "message": "Fix PR comments", "committedDate": "2020-04-09T14:16:58Z", "type": "forcePushed"}, {"oid": "4c8a0d6cfa5a24dabcf57e797b683300306d626f", "url": "https://github.com/wso2/carbon-kernel/commit/4c8a0d6cfa5a24dabcf57e797b683300306d626f", "message": "Add new column tenant uuid and config for maxlimit", "committedDate": "2020-04-09T14:47:24Z", "type": "forcePushed"}, {"oid": "ccde77fa944eea1b9fa092281a16de200dfd4751", "url": "https://github.com/wso2/carbon-kernel/commit/ccde77fa944eea1b9fa092281a16de200dfd4751", "message": "Add new column tenant uuid and config for maxlimit", "committedDate": "2020-04-09T14:58:46Z", "type": "commit"}, {"oid": "ccde77fa944eea1b9fa092281a16de200dfd4751", "url": "https://github.com/wso2/carbon-kernel/commit/ccde77fa944eea1b9fa092281a16de200dfd4751", "message": "Add new column tenant uuid and config for maxlimit", "committedDate": "2020-04-09T14:58:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU4MTk5NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r406581994", "bodyText": "unncessary new line", "author": "IsuraD", "createdAt": "2020-04-10T03:05:23Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/TenantUniqueIdCache.java", "diffHunk": "@@ -0,0 +1,193 @@\n+package org.wso2.carbon.user.core.tenant;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n+\n+import javax.cache.Cache;\n+import javax.cache.CacheManager;\n+import javax.cache.Caching;\n+\n+/**\n+ * Tenant unique id cache which holds tenant unique id as the key and tenant as the entry.\n+ */\n+public class TenantUniqueIdCache {\n+\n+    private static final String TENANT_UNIQUE_ID_CACHE_MANAGER = \"TENANT_UNIQUE_ID_CACHE_MANAGER\";\n+    private static final String TENANT_UNIQUE_ID_CACHE = \"TENANT_UNIQUE_ID_CACHE\";\n+    private static Log log = LogFactory.getLog(TenantUniqueIdCache.class);\n+    private static TenantUniqueIdCache tenantUniqueIdCache = new TenantUniqueIdCache();\n+\n+    private TenantUniqueIdCache() {\n+\n+    }\n+\n+    /**\n+     * Gets a new instance of TenantUniqueIdCache.\n+     *\n+     * @return A new instance of TenantUniqueIdCache.\n+     */\n+    public synchronized static TenantUniqueIdCache getInstance() {\n+\n+        return tenantUniqueIdCache;\n+    }\n+\n+    /**\n+     * Getting existing cache if the cache available, else returns a newly created cache.\n+     * This logic handles by javax.cache implementation\n+     */\n+    private <T> Cache<TenantUniqueIDKey, T> getTenantUUIDCache() {\n+\n+        Cache<TenantUniqueIDKey, T> cache;\n+        CacheManager cacheManager = Caching.getCacheManagerFactory().getCacheManager(TENANT_UNIQUE_ID_CACHE_MANAGER);\n+        cache = cacheManager.getCache(TENANT_UNIQUE_ID_CACHE);\n+        return cache;\n+    }\n+\n+    /**\n+     * Add a cache entry.\n+     * Tenant\n+     *\n+     * @param key   Key which cache entry is indexed.\n+     * @param entry Actual object where cache entry is placed.\n+     */\n+    public <T> void addToCache(TenantUniqueIDKey key, T entry) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+            // Element already in the cache. Remove it first.\n+            clearCacheEntry(key);\n+            Cache<TenantUniqueIDKey, T> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                cache.put(key, entry);\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"added the entry : \" + entry + \" for the key : \" + key + \" successfully\");\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Retrieves a cache entry.\n+     *\n+     * @param key CacheKey\n+     * @return Cached entry if the key presents, else returns null.\n+     */\n+    public <T> T getValueFromCache(TenantUniqueIDKey key) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+\n+            Cache<TenantUniqueIDKey, T> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                if (cache.containsKey(key)) {\n+                    T entry = cache.get(key);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER +\n+                                \", found the entry : \" + entry + \" for the key : \" + key + \" successfully\");\n+                    }\n+                    return entry;\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"doesn't contain the key : \" + key);\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+            return null;\n+\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Clears a cache entry.\n+     *\n+     * @param key Key to clear cache.\n+     */\n+    public void clearCacheEntry(TenantUniqueIDKey key) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+\n+            Cache<TenantUniqueIDKey, Object> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                if (cache.containsKey(key)) {\n+                    cache.remove(key);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", is \"\n+                                + \"removed entry for the key : \" + key + \" successfully\");\n+                    }\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"doesn't contain the key : \" + key);\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    private void startSuperTenantFlow() {\n+\n+        PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n+        carbonContext.setTenantId(MultitenantConstants.SUPER_TENANT_ID);\n+        carbonContext.setTenantDomain(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+    }\n+\n+    /**\n+     * Remove everything in the cache.\n+     */\n+    public void clear() {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+            Cache<TenantUniqueIDKey, Object> tenantUniqueIDCache = getTenantUUIDCache();\n+            if (tenantUniqueIDCache != null) {\n+                tenantUniqueIDCache.removeAll();\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"is cleared successfully\");\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+", "originalCommit": "ccde77fa944eea1b9fa092281a16de200dfd4751", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU4MjA0MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r406582040", "bodyText": "unncessary new line", "author": "IsuraD", "createdAt": "2020-04-10T03:05:36Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/TenantUniqueIdCache.java", "diffHunk": "@@ -0,0 +1,193 @@\n+package org.wso2.carbon.user.core.tenant;\n+\n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n+import org.wso2.carbon.context.PrivilegedCarbonContext;\n+import org.wso2.carbon.utils.multitenancy.MultitenantConstants;\n+\n+import javax.cache.Cache;\n+import javax.cache.CacheManager;\n+import javax.cache.Caching;\n+\n+/**\n+ * Tenant unique id cache which holds tenant unique id as the key and tenant as the entry.\n+ */\n+public class TenantUniqueIdCache {\n+\n+    private static final String TENANT_UNIQUE_ID_CACHE_MANAGER = \"TENANT_UNIQUE_ID_CACHE_MANAGER\";\n+    private static final String TENANT_UNIQUE_ID_CACHE = \"TENANT_UNIQUE_ID_CACHE\";\n+    private static Log log = LogFactory.getLog(TenantUniqueIdCache.class);\n+    private static TenantUniqueIdCache tenantUniqueIdCache = new TenantUniqueIdCache();\n+\n+    private TenantUniqueIdCache() {\n+\n+    }\n+\n+    /**\n+     * Gets a new instance of TenantUniqueIdCache.\n+     *\n+     * @return A new instance of TenantUniqueIdCache.\n+     */\n+    public synchronized static TenantUniqueIdCache getInstance() {\n+\n+        return tenantUniqueIdCache;\n+    }\n+\n+    /**\n+     * Getting existing cache if the cache available, else returns a newly created cache.\n+     * This logic handles by javax.cache implementation\n+     */\n+    private <T> Cache<TenantUniqueIDKey, T> getTenantUUIDCache() {\n+\n+        Cache<TenantUniqueIDKey, T> cache;\n+        CacheManager cacheManager = Caching.getCacheManagerFactory().getCacheManager(TENANT_UNIQUE_ID_CACHE_MANAGER);\n+        cache = cacheManager.getCache(TENANT_UNIQUE_ID_CACHE);\n+        return cache;\n+    }\n+\n+    /**\n+     * Add a cache entry.\n+     * Tenant\n+     *\n+     * @param key   Key which cache entry is indexed.\n+     * @param entry Actual object where cache entry is placed.\n+     */\n+    public <T> void addToCache(TenantUniqueIDKey key, T entry) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+            // Element already in the cache. Remove it first.\n+            clearCacheEntry(key);\n+            Cache<TenantUniqueIDKey, T> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                cache.put(key, entry);\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"added the entry : \" + entry + \" for the key : \" + key + \" successfully\");\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Retrieves a cache entry.\n+     *\n+     * @param key CacheKey\n+     * @return Cached entry if the key presents, else returns null.\n+     */\n+    public <T> T getValueFromCache(TenantUniqueIDKey key) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+\n+            Cache<TenantUniqueIDKey, T> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                if (cache.containsKey(key)) {\n+                    T entry = cache.get(key);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER +\n+                                \", found the entry : \" + entry + \" for the key : \" + key + \" successfully\");\n+                    }\n+                    return entry;\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"doesn't contain the key : \" + key);\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+            return null;\n+\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    /**\n+     * Clears a cache entry.\n+     *\n+     * @param key Key to clear cache.\n+     */\n+    public void clearCacheEntry(TenantUniqueIDKey key) {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+\n+            Cache<TenantUniqueIDKey, Object> cache = getTenantUUIDCache();\n+            if (cache != null) {\n+                if (cache.containsKey(key)) {\n+                    cache.remove(key);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", is \"\n+                                + \"removed entry for the key : \" + key + \" successfully\");\n+                    }\n+                }\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"doesn't contain the key : \" + key);\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+\n+        } finally {\n+            PrivilegedCarbonContext.endTenantFlow();\n+        }\n+    }\n+\n+    private void startSuperTenantFlow() {\n+\n+        PrivilegedCarbonContext carbonContext = PrivilegedCarbonContext.getThreadLocalCarbonContext();\n+        carbonContext.setTenantId(MultitenantConstants.SUPER_TENANT_ID);\n+        carbonContext.setTenantDomain(MultitenantConstants.SUPER_TENANT_DOMAIN_NAME);\n+    }\n+\n+    /**\n+     * Remove everything in the cache.\n+     */\n+    public void clear() {\n+\n+        PrivilegedCarbonContext.startTenantFlow();\n+\n+        try {\n+            startSuperTenantFlow();\n+            Cache<TenantUniqueIDKey, Object> tenantUniqueIDCache = getTenantUUIDCache();\n+            if (tenantUniqueIDCache != null) {\n+                tenantUniqueIDCache.removeAll();\n+                if (log.isDebugEnabled()) {\n+                    log.debug(TENANT_UNIQUE_ID_CACHE + \" which is under \" + TENANT_UNIQUE_ID_CACHE_MANAGER + \", \" +\n+                            \"is cleared successfully\");\n+                }\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Error while getting the cache : \" + TENANT_UNIQUE_ID_CACHE + \" which is under \" +\n+                            TENANT_UNIQUE_ID_CACHE_MANAGER);\n+                }\n+            }\n+", "originalCommit": "ccde77fa944eea1b9fa092281a16de200dfd4751", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU4MjQwNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r406582406", "bodyText": "We need to add tenantUUID cache as well", "author": "IsuraD", "createdAt": "2020-04-10T03:07:47Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -114,6 +132,9 @@ public int addTenant(org.wso2.carbon.user.api.Tenant tenant) throws UserStoreExc\n             InputStream is = new ByteArrayInputStream(realmConfigString.getBytes());\n             prepStmt.setBinaryStream(4, is, is.available());\n \n+            if (tenant.getTenantUniqueID() != null) {\n+                prepStmt.setString(5, tenant.getTenantUniqueID());\n+            }", "originalCommit": "ccde77fa944eea1b9fa092281a16de200dfd4751", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "894d81dbd3d97f340d577e4e8299ef1a931a96b7", "url": "https://github.com/wso2/carbon-kernel/commit/894d81dbd3d97f340d577e4e8299ef1a931a96b7", "message": "Fix PR comments", "committedDate": "2020-04-10T04:05:31Z", "type": "forcePushed"}, {"oid": "382f6f79445ea7b653b60d3385918b9e4d676e2d", "url": "https://github.com/wso2/carbon-kernel/commit/382f6f79445ea7b653b60d3385918b9e4d676e2d", "message": "Fix PR comments", "committedDate": "2020-04-10T04:46:57Z", "type": "forcePushed"}, {"oid": "024366877d534667c50f9b8eea9139dd6907dde9", "url": "https://github.com/wso2/carbon-kernel/commit/024366877d534667c50f9b8eea9139dd6907dde9", "message": "Fix PR comments", "committedDate": "2020-04-10T04:50:07Z", "type": "commit"}, {"oid": "024366877d534667c50f9b8eea9139dd6907dde9", "url": "https://github.com/wso2/carbon-kernel/commit/024366877d534667c50f9b8eea9139dd6907dde9", "message": "Fix PR comments", "committedDate": "2020-04-10T04:50:07Z", "type": "forcePushed"}, {"oid": "3110b0c0c793ab923d3bf040bd14a6255e2b7148", "url": "https://github.com/wso2/carbon-kernel/commit/3110b0c0c793ab923d3bf040bd14a6255e2b7148", "message": "Add column existing logic", "committedDate": "2020-04-10T09:30:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwMDAyMg==", "url": "https://github.com/wso2/carbon-kernel/pull/2647#discussion_r406700022", "bodyText": "This should execute only in server startup?", "author": "IsuraD", "createdAt": "2020-04-10T10:26:03Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -825,4 +1030,177 @@ private StringBuilder printCurrentStackTrace() {\n         }\n         return currentStackTraceBuilder;\n     }\n+\n+    /**\n+     * Get total number of tenant existing in the system.\n+     *\n+     * @return number of tenant count.\n+     * @throws UserStoreException Error when getting count of tenants.\n+     */\n+    private int getCountOfTenants() throws UserStoreException {\n+\n+        String sqlStmt = TenantConstants.LIST_TENANTS_COUNT_SQL;\n+        int tenantCount = 0;\n+        try (Connection dbConnection = getDBConnection();\n+             PreparedStatement prepStmt = dbConnection.prepareStatement(sqlStmt)) {\n+            try (ResultSet rs = prepStmt.executeQuery()) {\n+                if (rs.next()) {\n+                    tenantCount = Integer.parseInt(rs.getString(1));\n+                }\n+            }\n+        } catch (SQLException e) {\n+            throw new UserStoreException(\"Error occurred while retrieving tenant count.\", e);\n+        }\n+        return tenantCount;\n+    }\n+\n+    private ResultSet getTenantQueryResultSet(Connection dbConnection, String sortedOrder, Integer offset,\n+                                              Integer limit) throws SQLException, UserStoreException {\n+\n+        String dbType = dbConnection.getMetaData().getDatabaseProductName();\n+        PreparedStatement prepStmt;\n+        String sqlQuery;\n+        String sqlTail;\n+        sqlQuery = TenantConstants.LIST_TENANTS_PAGINATED_SQL;\n+\n+        if (dbType.contains(\"MySQL\") || dbType.contains(\"H2\")) {\n+            sqlTail = String.format(TenantConstants.LIST_TENANTS_MYSQL_TAIL, sortedOrder);\n+            sqlQuery = sqlQuery + sqlTail;\n+            prepStmt = dbConnection.prepareStatement(sqlQuery);\n+            prepStmt.setInt(1, offset);\n+            prepStmt.setInt(2, limit);\n+        } else if (dbType.contains(\"oracle\")) {\n+            sqlQuery = TenantConstants.LIST_TENANTS_PAGINATED_ORACLE;\n+            sqlTail = String.format(TenantConstants.LIST_TENANTS_ORACLE_TAIL, sortedOrder);\n+            sqlQuery = sqlQuery + sqlTail;\n+            prepStmt = dbConnection.prepareStatement(sqlQuery);\n+            prepStmt.setInt(1, offset + limit);\n+            prepStmt.setInt(2, offset);\n+        } else if (dbType.contains(\"Microsoft\")) {\n+            sqlTail = String.format(TenantConstants.LIST_TENANTS_MSSQL_TAIL, sortedOrder);\n+            sqlQuery = sqlQuery + sqlTail;\n+            prepStmt = dbConnection.prepareStatement(sqlQuery);\n+            prepStmt.setInt(1, offset);\n+            prepStmt.setInt(2, limit);\n+        } else if (dbType.contains(\"db2\") || dbType.contains(\"DB2\")) {\n+            sqlQuery = TenantConstants.LIST_TENANTS_PAGINATED_DB2;\n+            sqlTail = String.format(TenantConstants.LIST_TENANTS_DB2_TAIL, sortedOrder);\n+            sqlQuery = sqlQuery + sqlTail;\n+            prepStmt = dbConnection.prepareStatement(sqlQuery);\n+            prepStmt.setInt(1, offset + 1);\n+            prepStmt.setInt(2, offset + limit);\n+        } else if (dbType.contains(\"PostgreSQL\")) {\n+            sqlTail = String.format(TenantConstants.LIST_TENANTS_POSTGRESQL_TAIL, sortedOrder);\n+            sqlQuery = sqlQuery + sqlTail;\n+            prepStmt = dbConnection.prepareStatement(sqlQuery);\n+            prepStmt.setInt(1, limit);\n+            prepStmt.setInt(2, offset);\n+        } else {\n+            String message = \"Error while loading tenant from DB: Database driver could not be identified\" +\n+                    \" or not supported.\";\n+            log.error(message);\n+            throw new UserStoreException(message);\n+        }\n+        return prepStmt.executeQuery();\n+    }\n+\n+    private List<Tenant> populateTenantList(ResultSet resultSet)\n+            throws SQLException, UserStoreException {\n+\n+        List<Tenant> tenantList = new ArrayList<Tenant>();\n+        while (resultSet.next()) {\n+            int id = resultSet.getInt(COLUMN_NAME_UM_ID);\n+            String domain = resultSet.getString(COLUMN_NAME_UM_DOMAIN_NAME);\n+            String email = resultSet.getString(COLUMN_NAME_UM_EMAIL);\n+            boolean active = resultSet.getBoolean(COLUMN_NAME_UM_ACTIVE);\n+            Date createdDate = new Date(resultSet.getTimestamp(\n+                    COLUMN_NAME_UM_CREATED_DATE).getTime());\n+            String tenantUniqueId = resultSet.getString(COLUMN_NAME_UM_TENANT_UUID);\n+\n+            InputStream is = resultSet.getBinaryStream(COLUMN_NAME_UM_USER_CONFIG);\n+\n+            RealmConfigXMLProcessor processor = new RealmConfigXMLProcessor();\n+            RealmConfiguration realmConfig = processor.buildTenantRealmConfiguration(is);\n+\n+            Tenant tenant = new Tenant();\n+            tenant.setId(id);\n+            tenant.setDomain(domain);\n+            tenant.setEmail(email);\n+            tenant.setActive(active);\n+            tenant.setTenantUniqueID(tenantUniqueId);\n+            tenant.setCreatedDate(createdDate);\n+            String adminUserName = realmConfig.getAdminUserName();\n+            tenant.setAdminName(adminUserName);\n+            tenant.setAdminUserId(getUserId(adminUserName, id));\n+            tenantList.add(tenant);\n+        }\n+        return tenantList;\n+    }\n+\n+    private String getUserId(String userName, int tenantId) throws UserStoreException {\n+\n+        String claimValue = null;\n+        RealmService realmService = UserStoreMgtDSComponent.getRealmService();\n+        try {\n+            UserRealm tenantUserRealm = realmService.getTenantUserRealm(tenantId);\n+            if (tenantUserRealm != null) {\n+                UserStoreManager userStoreManager = (UserStoreManager) tenantUserRealm.getUserStoreManager();\n+                if (userStoreManager != null) {\n+                    claimValue = userStoreManager.getUserClaimValue(userName, UserCoreClaimConstants.USER_ID_CLAIM_URI,\n+                            UserCoreConstants.DEFAULT_PROFILE);\n+                }\n+            }\n+        } catch (org.wso2.carbon.user.api.UserStoreException e) {\n+            throw new UserStoreException(\"Error while getting claim value for the claim: \" +\n+                    UserCoreClaimConstants.USER_ID_CLAIM_URI, e);\n+        }\n+        return claimValue;\n+    }\n+\n+    private boolean isTenantUniqueIdColumnAvailable() throws UserStoreException {\n+\n+        if (tenantUniqueIdColumnAvailable == null) {\n+            tenantUniqueIdColumnAvailable =  checkUniqueIdColumnInTable();\n+        }\n+        return tenantUniqueIdColumnAvailable;\n+    }\n+\n+    private boolean checkUniqueIdColumnInTable() throws UserStoreException {", "originalCommit": "3110b0c0c793ab923d3bf040bd14a6255e2b7148", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}