{"pr_number": 2705, "pr_title": "Update multi-valued user claims independently from non-multi-valued claims", "pr_createdAt": "2020-06-15T11:58:23Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2705", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODQ4Mw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r442708483", "bodyText": "Can you create an issue to track this requirement?", "author": "madurangasiriwardena", "createdAt": "2020-06-19T08:31:25Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/JDBCUserStoreManager.java", "diffHunk": "@@ -2229,6 +2230,15 @@ public void doSetUserClaimValues(String userName, Map<String, String> claims, St\n         super.doSetUserClaimValues(userName, claims, profileName);\n     }\n \n+    @Override\n+    public void doSetUserClaimValues(String userName, Map<String, List<String>> multiValuedClaimsToAdd,\n+                                           Map<String, List<String>> multiValuedClaimsToDelete,\n+                                           Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                           String profileName) throws UserStoreException, NotImplementedException {\n+\n+        throw new NotImplementedException(\"This functionality is not yet implemented for JDBC userstores.\");", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwOTU1OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r452109559", "bodyText": "created the git issue : wso2/product-is#8659", "author": "AnuradhaSK", "createdAt": "2020-07-09T10:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjQyMA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463906420", "bodyText": "Shall we add this as a default method?", "author": "somindatommy", "createdAt": "2020-08-01T01:58:38Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/UniqueIDUserStoreManager.java", "diffHunk": "@@ -236,6 +236,23 @@ void setUserClaimValueWithID(String userID, String claimURI, String claimValue,\n     void setUserClaimValuesWithID(String userID, Map<String, String> claims, String profileName)\n             throws UserStoreException;\n \n+    /**\n+     * Set user claim values.\n+     *\n+     * @param userID                           UserID of the user.\n+     * @param oldClaimMap                      A map of existing claim URIs of the user against values.\n+     * @param multiValuedClaimsToAdd           A map of multi-valued claim URIs against values to add.\n+     * @param multiValuedClaimsToDelete        A map of multi-valued claim URIs against values to delete.\n+     * @param claimsExcludingMultiValuedClaims A map of non-multi-valued claim URIs against values to replace.\n+     * @param profileName                      The profile name, can be null. If null the default profile is considered.\n+     * @throws UserStoreException Thrown if an error occurred in userstore operation.\n+     */\n+    void setUserClaimValuesWithID(String userID, Map<String, List<String>> oldClaimMap,", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjcyMQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499736721", "bodyText": "addressed in fb430db", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjY4Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463906686", "bodyText": "In my opinion, we do not need this log. WDYT?", "author": "somindatommy", "createdAt": "2020-08-01T02:01:07Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -595,6 +595,29 @@ protected void doSetUserAttributes(String userName, Map<String, String> processe\n         throw new NotImplementedException(\"doSetUserAttributes operation is not implemented in: \" + this.getClass());\n     }\n \n+    /**\n+     * Set the user attributes of a user.\n+     *\n+     * @param userName                 UserName of the user.\n+     * @param claimAttributesToAdd     A processed map of userstore attribute values to add.\n+     * @param claimAttributesToDelete  A processed map of userstore attribute values to delte.\n+     * @param claimAttributesToReplace A processed map of userstore attribute values to replace.\n+     * @param profileName              The profile name, can be null. If null the default profile is considered.\n+     * @throws UserStoreException      Thrown if the userstore operation fails.\n+     * @throws NotImplementedException Thrown if the operation is not implemented in the underlying userstore.\n+     */\n+    protected void doSetUserAttributes(String userName, Map<String, List<String>> claimAttributesToAdd,\n+                                             Map<String, List<String>> claimAttributesToDelete,\n+                                             Map<String, List<String>> claimAttributesToReplace, String profileName)\n+            throws UserStoreException, NotImplementedException {\n+\n+        if (log.isDebugEnabled()) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTcwNQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500459705", "bodyText": "fixed in 0b9e061", "author": "AnuradhaSK", "createdAt": "2020-10-06T17:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjc1MQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463906751", "bodyText": "In my opinion, we do not need this log. WDYT?", "author": "somindatommy", "createdAt": "2020-08-01T02:01:48Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -615,6 +638,29 @@ protected void doSetUserAttributesWithID(String userID,\n                 + this.getClass());\n     }\n \n+    /**\n+     * Set the user attributes of a user.\n+     *\n+     * @param userID                   UserID of the user.\n+     * @param claimAttributesToAdd     A processed map of userstore attribute values to add.\n+     * @param claimAttributesToDelete  A processed map of userstore attribute values to delete.\n+     * @param claimAttributesToReplace A processed map of userstore attribute values to replace.\n+     * @param profileName              The profile name, can be null. If null the default profile is considered.\n+     * @throws UserStoreException      Thrown if the userstore operation fails.\n+     * @throws NotImplementedException Thrown if the operation is not implemented in the underlying userstore.\n+     */\n+    protected void doSetUserAttributesWithID(String userID, Map<String, List<String>> claimAttributesToAdd,\n+                                             Map<String, List<String>> claimAttributesToDelete,\n+                                             Map<String, List<String>> claimAttributesToReplace, String profileName)\n+            throws UserStoreException, NotImplementedException {\n+\n+        if (log.isDebugEnabled()) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTY0NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500459644", "bodyText": "fixed in 0b9e061", "author": "AnuradhaSK", "createdAt": "2020-10-06T17:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjgxMg==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463906812", "bodyText": "Can we check for StringUtils.isBlank?", "author": "somindatommy", "createdAt": "2020-08-01T02:02:35Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -667,6 +713,45 @@ public void doSetUserClaimValues(String userName, Map<String, String> claims,\n         doSetUserAttributes(userName, claimAttributeValueMapForPersist, profileName);\n     }\n \n+    /**\n+     * Set many user claim values by treating multi-valued claims independently from simple claims.\n+     *\n+     * @param userName                         User's username.\n+     * @param multiValuedClaimsToAdd           Map of multi-valued claim URIs against values to be added.\n+     * @param multiValuedClaimsToDelete        Map of multi-valued claim URIs against values to be deleted.\n+     * @param claimsExcludingMultiValuedClaims Map of claim URIs excluding multi-valued claims against values\n+     *                                         to be modified.\n+     * @param profileName                      The profile name, can be null. If null the default profile is considered.\n+     * @throws UserStoreException      An unexpected exception has occurred.\n+     * @throws NotImplementedException Functionality is not implemented exception.\n+     */\n+    protected void doSetUserClaimValues(String userName, Map<String, List<String>> multiValuedClaimsToAdd,\n+                                        Map<String, List<String>> multiValuedClaimsToDelete,\n+                                        Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                        String profileName)\n+            throws UserStoreException, NotImplementedException {\n+\n+        if (profileName == null) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjY0Nw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499736647", "bodyText": "addressed in fb430db", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNjgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzA3Mg==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463907072", "bodyText": "Shall we remove these extra new lines?", "author": "somindatommy", "createdAt": "2020-08-01T02:05:19Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -698,6 +783,30 @@ public void doSetUserClaimValues(String userName, Map<String, String> claims,\n         return userStoreAttributeValueMap;\n     }\n \n+    private Map<String, List<String>> resolveUserStoreAttributeValueMaps(String userIdentifier,\n+                                                                         Map<String, List<String>> claims)\n+            throws UserStoreException {\n+\n+        Map<String, List<String>> userStoreAttributeValueMap = new HashMap<>();\n+\n+        try {\n+            for (Map.Entry<String, List<String>> claimEntry : claims.entrySet()) {\n+                String claimURI = claimEntry.getKey();\n+                String attributeName = getClaimAtrribute(claimURI, userIdentifier, null);\n+                userStoreAttributeValueMap.put(attributeName, claimEntry.getValue());\n+            }\n+        } catch (org.wso2.carbon.user.api.UserStoreException e) {\n+            String errorMessage = \"Error occurred while getting claim attribute for user : \" + userIdentifier;\n+", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjU4NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499736584", "bodyText": "addressed in fb430db", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzM5OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463907399", "bodyText": "Shall we remove this new line since its related to the of condition?", "author": "somindatommy", "createdAt": "2020-08-01T02:09:28Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -12417,6 +12561,101 @@ public final void setUserClaimValuesWithID(String userID, Map<String, String> cl\n \n     }\n \n+    @Override\n+    public final void setUserClaimValuesWithID(String userID, Map<String, List<String>> oldClaimMap,\n+                                               Map<String, List<String>> multiValuedClaimsToAdd,\n+                                               Map<String, List<String>> multiValuedClaimsToDelete,\n+                                               Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                               String profileName) throws UserStoreException {\n+\n+        UserStore userStore = getUserStoreWithID(userID);\n+        if (userStore.isRecurssive()) {\n+            ((AbstractUserStoreManager) userStore.getUserStoreManager())\n+                    .setUserClaimValuesWithID(userStore.getDomainFreeUserId(), oldClaimMap, multiValuedClaimsToAdd,\n+                            multiValuedClaimsToDelete, claimsExcludingMultiValuedClaims, profileName);\n+            return;\n+        }\n+        Map<String, String> claims =\n+                getModifiedClaims(oldClaimMap, multiValuedClaimsToAdd, multiValuedClaimsToDelete,\n+                        claimsExcludingMultiValuedClaims);\n+\n+        // #################### Domain Name Free Zone Starts Here ################################\n+\n+        boolean isUniqueIdEnabled = isUniqueUserIdEnabledInUserStore(userStore);\n+        boolean isUserExists;\n+        if (isUniqueIdEnabled) {\n+            isUserExists = doCheckExistingUserWithID(userID);\n+        } else {\n+            String userNameFromUserID = doGetUserNameFromUserID(userID);\n+            isUserExists = userNameFromUserID != null;\n+        }\n+\n+        if (!isUserExists) {\n+            String errorMessage = String.format(ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getMessage(), userID,\n+                    realmConfig.getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME));\n+            String errorCode = ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getCode();\n+            handleSetUserClaimValuesFailureWithID(errorCode, errorMessage, userID, claims, profileName);\n+            throw new UserStoreException(errorCode + \" - \" + errorMessage);\n+        }\n+\n+        // #################### <Pre Listeners> #####################################################\n+        invokeDoPreSetUserClaimsWithIDListeners(userID, claims, profileName);\n+        // #################### </Pre Listeners> #####################################################\n+\n+        // If user store is readonly this method should not get invoked with non empty claim set.\n+", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjUzOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499736539", "bodyText": "addressed in fb430db", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzY2NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463907665", "bodyText": "Is this our existing logic? dont we have to check the userstore before we invoke the pre listeners?", "author": "somindatommy", "createdAt": "2020-08-01T02:11:46Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -12417,6 +12561,101 @@ public final void setUserClaimValuesWithID(String userID, Map<String, String> cl\n \n     }\n \n+    @Override\n+    public final void setUserClaimValuesWithID(String userID, Map<String, List<String>> oldClaimMap,\n+                                               Map<String, List<String>> multiValuedClaimsToAdd,\n+                                               Map<String, List<String>> multiValuedClaimsToDelete,\n+                                               Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                               String profileName) throws UserStoreException {\n+\n+        UserStore userStore = getUserStoreWithID(userID);\n+        if (userStore.isRecurssive()) {\n+            ((AbstractUserStoreManager) userStore.getUserStoreManager())\n+                    .setUserClaimValuesWithID(userStore.getDomainFreeUserId(), oldClaimMap, multiValuedClaimsToAdd,\n+                            multiValuedClaimsToDelete, claimsExcludingMultiValuedClaims, profileName);\n+            return;\n+        }\n+        Map<String, String> claims =\n+                getModifiedClaims(oldClaimMap, multiValuedClaimsToAdd, multiValuedClaimsToDelete,\n+                        claimsExcludingMultiValuedClaims);\n+\n+        // #################### Domain Name Free Zone Starts Here ################################\n+\n+        boolean isUniqueIdEnabled = isUniqueUserIdEnabledInUserStore(userStore);\n+        boolean isUserExists;\n+        if (isUniqueIdEnabled) {\n+            isUserExists = doCheckExistingUserWithID(userID);\n+        } else {\n+            String userNameFromUserID = doGetUserNameFromUserID(userID);\n+            isUserExists = userNameFromUserID != null;\n+        }\n+\n+        if (!isUserExists) {\n+            String errorMessage = String.format(ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getMessage(), userID,\n+                    realmConfig.getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME));\n+            String errorCode = ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getCode();\n+            handleSetUserClaimValuesFailureWithID(errorCode, errorMessage, userID, claims, profileName);\n+            throw new UserStoreException(errorCode + \" - \" + errorMessage);\n+        }\n+\n+        // #################### <Pre Listeners> #####################################################\n+        invokeDoPreSetUserClaimsWithIDListeners(userID, claims, profileName);\n+        // #################### </Pre Listeners> #####################################################\n+\n+        // If user store is readonly this method should not get invoked with non empty claim set.\n+\n+        if (isReadOnly() && !claims.isEmpty()) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyNjI1MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499726250", "bodyText": "yes, this is an existing logic.", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzc2Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463907766", "bodyText": "Can we use MapUtils here?", "author": "somindatommy", "createdAt": "2020-08-01T02:13:18Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -12417,6 +12561,101 @@ public final void setUserClaimValuesWithID(String userID, Map<String, String> cl\n \n     }\n \n+    @Override\n+    public final void setUserClaimValuesWithID(String userID, Map<String, List<String>> oldClaimMap,\n+                                               Map<String, List<String>> multiValuedClaimsToAdd,\n+                                               Map<String, List<String>> multiValuedClaimsToDelete,\n+                                               Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                               String profileName) throws UserStoreException {\n+\n+        UserStore userStore = getUserStoreWithID(userID);\n+        if (userStore.isRecurssive()) {\n+            ((AbstractUserStoreManager) userStore.getUserStoreManager())\n+                    .setUserClaimValuesWithID(userStore.getDomainFreeUserId(), oldClaimMap, multiValuedClaimsToAdd,\n+                            multiValuedClaimsToDelete, claimsExcludingMultiValuedClaims, profileName);\n+            return;\n+        }\n+        Map<String, String> claims =\n+                getModifiedClaims(oldClaimMap, multiValuedClaimsToAdd, multiValuedClaimsToDelete,\n+                        claimsExcludingMultiValuedClaims);\n+\n+        // #################### Domain Name Free Zone Starts Here ################################\n+\n+        boolean isUniqueIdEnabled = isUniqueUserIdEnabledInUserStore(userStore);\n+        boolean isUserExists;\n+        if (isUniqueIdEnabled) {\n+            isUserExists = doCheckExistingUserWithID(userID);\n+        } else {\n+            String userNameFromUserID = doGetUserNameFromUserID(userID);\n+            isUserExists = userNameFromUserID != null;\n+        }\n+\n+        if (!isUserExists) {\n+            String errorMessage = String.format(ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getMessage(), userID,\n+                    realmConfig.getUserStoreProperty(UserCoreConstants.RealmConfig.PROPERTY_DOMAIN_NAME));\n+            String errorCode = ErrorMessages.ERROR_CODE_NON_EXISTING_USER.getCode();\n+            handleSetUserClaimValuesFailureWithID(errorCode, errorMessage, userID, claims, profileName);\n+            throw new UserStoreException(errorCode + \" - \" + errorMessage);\n+        }\n+\n+        // #################### <Pre Listeners> #####################################################\n+        invokeDoPreSetUserClaimsWithIDListeners(userID, claims, profileName);\n+        // #################### </Pre Listeners> #####################################################\n+\n+        // If user store is readonly this method should not get invoked with non empty claim set.\n+\n+        if (isReadOnly() && !claims.isEmpty()) {\n+            handleSetUserClaimValuesFailureWithID(ErrorMessages.ERROR_CODE_READONLY_USER_STORE.getCode(),\n+                    ErrorMessages.ERROR_CODE_READONLY_USER_STORE.getMessage(), userID, claims, profileName);\n+            throw new UserStoreException(ErrorMessages.ERROR_CODE_READONLY_USER_STORE.toString());\n+        }\n+\n+        // Any additional simple claim modified due to pre listeners are taken into claimsExcludingMultiValuedClaims map.\n+        String separator = \",\";\n+        if (StringUtils.isNotEmpty(realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR))) {\n+            separator = realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR);\n+        }\n+        if (claimsExcludingMultiValuedClaims != null) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyOTE5MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499729190", "bodyText": "A null check is sufficient here due to the following for loop.\nwso2-support/carbon-kernel#984 (comment)", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwNzc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTQ1Mw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463951453", "bodyText": "Can we use mapUtils?", "author": "somindatommy", "createdAt": "2020-08-01T11:07:33Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -14817,4 +15056,114 @@ private String getUserStoreDomainName(UserStoreManager userStoreManager) {\n         }\n         return domainNameProperty;\n     }\n+\n+    /**\n+     * Process and return the modifed claim values against claim URI. Add or remove specific claim values\n+     * against old claim values of multi-valued claims. Replace old claim values from modified values for\n+     * non multi-valued claims.\n+     *\n+     * @param oldClaimMap                      Map of claim URIs against old claim values of user.\n+     * @param multiValuedClaimsToAdd           Map of multi-valued claim URIs against values need to be added to\n+     *                                         old claim value.\n+     * @param multiValuedClaimsToDelete        Map of multi-valued claim URIs against values need to be removed from\n+     *                                         old claim value.\n+     * @param claimsExcludingMultiValuedClaims Map of non multi-valued claim URIs against modified values to be stred.\n+     * @return Map of claim URIs against the modified claim values.\n+     */\n+    private Map<String, String> getModifiedClaims(Map<String, List<String>> oldClaimMap,\n+                                                  Map<String, List<String>> multiValuedClaimsToAdd,\n+                                                  Map<String, List<String>> multiValuedClaimsToDelete,\n+                                                  Map<String, List<String>> claimsExcludingMultiValuedClaims) {\n+\n+        Map<String, String> claims = new HashMap<>();\n+        String separator = \",\";\n+        if (StringUtils.isNotEmpty(realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR))) {\n+            separator = realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR);\n+        }\n+        if (claimsExcludingMultiValuedClaims != null) {\n+            for (String claimURI : claimsExcludingMultiValuedClaims.keySet()) {\n+                claims.put(claimURI,\n+                        StringUtils.join(claimsExcludingMultiValuedClaims.get(claimURI).iterator(), separator));\n+            }\n+        }\n+\n+        // Get modified claim values for multi-valued claims.\n+        if (multiValuedClaimsToAdd != null) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDA3Nw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499730077", "bodyText": "A null check is sufficient here due to the following for loop.\nwso2-support/carbon-kernel#984 (comment)", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTQ4Mw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463951483", "bodyText": "Can we use MapUtils?", "author": "somindatommy", "createdAt": "2020-08-01T11:07:59Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -14817,4 +15056,114 @@ private String getUserStoreDomainName(UserStoreManager userStoreManager) {\n         }\n         return domainNameProperty;\n     }\n+\n+    /**\n+     * Process and return the modifed claim values against claim URI. Add or remove specific claim values\n+     * against old claim values of multi-valued claims. Replace old claim values from modified values for\n+     * non multi-valued claims.\n+     *\n+     * @param oldClaimMap                      Map of claim URIs against old claim values of user.\n+     * @param multiValuedClaimsToAdd           Map of multi-valued claim URIs against values need to be added to\n+     *                                         old claim value.\n+     * @param multiValuedClaimsToDelete        Map of multi-valued claim URIs against values need to be removed from\n+     *                                         old claim value.\n+     * @param claimsExcludingMultiValuedClaims Map of non multi-valued claim URIs against modified values to be stred.\n+     * @return Map of claim URIs against the modified claim values.\n+     */\n+    private Map<String, String> getModifiedClaims(Map<String, List<String>> oldClaimMap,\n+                                                  Map<String, List<String>> multiValuedClaimsToAdd,\n+                                                  Map<String, List<String>> multiValuedClaimsToDelete,\n+                                                  Map<String, List<String>> claimsExcludingMultiValuedClaims) {\n+\n+        Map<String, String> claims = new HashMap<>();\n+        String separator = \",\";\n+        if (StringUtils.isNotEmpty(realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR))) {\n+            separator = realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR);\n+        }\n+        if (claimsExcludingMultiValuedClaims != null) {\n+            for (String claimURI : claimsExcludingMultiValuedClaims.keySet()) {\n+                claims.put(claimURI,\n+                        StringUtils.join(claimsExcludingMultiValuedClaims.get(claimURI).iterator(), separator));\n+            }\n+        }\n+\n+        // Get modified claim values for multi-valued claims.\n+        if (multiValuedClaimsToAdd != null) {\n+            for (String claimURI : multiValuedClaimsToAdd.keySet()) {\n+                List<String> modifiedValue = new ArrayList<>();\n+                if (oldClaimMap.containsKey(claimURI)) {\n+                    modifiedValue.addAll(oldClaimMap.get(claimURI));\n+                    modifiedValue.addAll(multiValuedClaimsToAdd.get(claimURI));\n+                } else {\n+                    modifiedValue.addAll(multiValuedClaimsToAdd.get(claimURI));\n+                }\n+                claims.put(claimURI, StringUtils.join(modifiedValue.iterator(), separator));\n+            }\n+        }\n+        if (multiValuedClaimsToDelete != null) {", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDAxOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499730019", "bodyText": "A null check is sufficient here due to the following for loop.\nwso2-support/carbon-kernel#984 (comment)", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTczNQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r463951735", "bodyText": "Shall we remove extra newlines?", "author": "somindatommy", "createdAt": "2020-08-01T11:11:25Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/ldap/ReadWriteLDAPUserStoreManager.java", "diffHunk": "@@ -917,6 +918,80 @@ protected void doSetUserAttributes(String userName, Map<String, String> processe\n         }\n     }\n \n+    protected void doSetUserAttributes(String userName, Map<String, List<String>> claimAttributesToAdd,\n+                                       Map<String, List<String>> claimAttributesToDelete,\n+                                       Map<String, List<String>> claimAttributesToReplace, String profileName)\n+            throws UserStoreException, NotImplementedException {\n+\n+        // Get the LDAP Directory context.\n+        DirContext dirContext = this.connectionSource.getContext();\n+        DirContext subDirContext = null;\n+        // Search the relevant user entry by user name.\n+        String userSearchBase = realmConfig.getUserStoreProperty(LDAPConstants.USER_SEARCH_BASE);\n+        String userSearchFilter = realmConfig\n+                .getUserStoreProperty(LDAPConstants.USER_NAME_SEARCH_FILTER);\n+        // If user name contains domain name, remove domain name.\n+        userName = UserCoreUtil.removeDomainFromName(userName);\n+        userSearchFilter = userSearchFilter.replace(\"?\", escapeSpecialCharactersForFilter(userName));\n+\n+        SearchControls searchControls = new SearchControls();\n+        searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);\n+        searchControls.setReturningAttributes(null);\n+\n+        NamingEnumeration<SearchResult> returnedResultList = null;\n+        String returnedUserEntry = StringUtils.EMPTY;\n+\n+        try {\n+            subDirContext = (DirContext) dirContext.lookup(escapeDNForSearch(userSearchBase));\n+            returnedResultList = dirContext.search(escapeDNForSearch(userSearchBase), userSearchFilter, searchControls);\n+\n+            // Assume only one user is returned from the search.\n+            if (returnedResultList.hasMore()) {\n+                returnedUserEntry = returnedResultList.next().getName();\n+                handleLdapUserNameAttributeChanges(claimAttributesToReplace, subDirContext, returnedUserEntry);\n+            }\n+\n+        } catch (NamingException e) {\n+            String errorMessage = \"Results could not be retrieved from the directory context for user : \" + userName;\n+", "originalCommit": "852a23c9f3930e0b32df4c52255506f00e428c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNjM4NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r499736384", "bodyText": "addressed in fb430db", "author": "AnuradhaSK", "createdAt": "2020-10-05T16:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1MTczNQ=="}], "type": "inlineReview"}, {"oid": "3f2294363dedc5b782da00e295e7e75f500b9646", "url": "https://github.com/wso2/carbon-kernel/commit/3f2294363dedc5b782da00e295e7e75f500b9646", "message": "address comments", "committedDate": "2020-10-05T16:58:10Z", "type": "forcePushed"}, {"oid": "fcde39da236f7f4061e3b5644117c3d04f8adba7", "url": "https://github.com/wso2/carbon-kernel/commit/fcde39da236f7f4061e3b5644117c3d04f8adba7", "message": "Update multi-valued user claims independently from non-multi-valued claims", "committedDate": "2020-10-06T12:52:48Z", "type": "commit"}, {"oid": "e08b9e45db7e61ed00333444cf76f9044095e50c", "url": "https://github.com/wso2/carbon-kernel/commit/e08b9e45db7e61ed00333444cf76f9044095e50c", "message": "Add setUserClaimValuesWithID method into UniqueIDUserStoreManager interface", "committedDate": "2020-10-06T12:52:48Z", "type": "commit"}, {"oid": "fc932b05f8215d6d5fc6bfe0ca30902a75f64eb1", "url": "https://github.com/wso2/carbon-kernel/commit/fc932b05f8215d6d5fc6bfe0ca30902a75f64eb1", "message": "address comments", "committedDate": "2020-10-06T12:52:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5MzMyMg==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500393322", "bodyText": "Shall we remove the additional newline here?", "author": "somindatommy", "createdAt": "2020-10-06T15:31:26Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/common/AbstractUserStoreManager.java", "diffHunk": "@@ -15123,4 +15358,114 @@ private String getUserStoreDomainName(UserStoreManager userStoreManager) {\n         }\n         return domainNameProperty;\n     }\n+\n+    /**\n+     * Process and return the modifed claim values against claim URI. Add or remove specific claim values\n+     * against old claim values of multi-valued claims. Replace old claim values from modified values for\n+     * non multi-valued claims.\n+     *\n+     * @param oldClaimMap                      Map of claim URIs against old claim values of user.\n+     * @param multiValuedClaimsToAdd           Map of multi-valued claim URIs against values need to be added to\n+     *                                         old claim value.\n+     * @param multiValuedClaimsToDelete        Map of multi-valued claim URIs against values need to be removed from\n+     *                                         old claim value.\n+     * @param claimsExcludingMultiValuedClaims Map of non multi-valued claim URIs against modified values to be stred.\n+     * @return Map of claim URIs against the modified claim values.\n+     */\n+    private Map<String, String> getModifiedClaims(Map<String, List<String>> oldClaimMap,\n+                                                  Map<String, List<String>> multiValuedClaimsToAdd,\n+                                                  Map<String, List<String>> multiValuedClaimsToDelete,\n+                                                  Map<String, List<String>> claimsExcludingMultiValuedClaims) {\n+\n+        Map<String, String> claims = new HashMap<>();\n+        String separator = \",\";\n+        if (StringUtils.isNotEmpty(realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR))) {\n+            separator = realmConfig.getUserStoreProperty(MULTI_ATTRIBUTE_SEPARATOR);\n+        }\n+        if (claimsExcludingMultiValuedClaims != null) {\n+            for (String claimURI : claimsExcludingMultiValuedClaims.keySet()) {\n+                claims.put(claimURI,\n+                        StringUtils.join(claimsExcludingMultiValuedClaims.get(claimURI).iterator(), separator));\n+            }\n+        }\n+\n+        // Get modified claim values for multi-valued claims.\n+        if (multiValuedClaimsToAdd != null) {\n+            for (String claimURI : multiValuedClaimsToAdd.keySet()) {\n+                List<String> modifiedValue = new ArrayList<>();\n+                if (oldClaimMap.containsKey(claimURI)) {\n+                    modifiedValue.addAll(oldClaimMap.get(claimURI));\n+                    modifiedValue.addAll(multiValuedClaimsToAdd.get(claimURI));\n+                } else {\n+                    modifiedValue.addAll(multiValuedClaimsToAdd.get(claimURI));\n+                }\n+                claims.put(claimURI, StringUtils.join(modifiedValue.iterator(), separator));\n+            }\n+        }\n+        if (multiValuedClaimsToDelete != null) {\n+            for (String claimURI : multiValuedClaimsToDelete.keySet()) {\n+                List<String> values = null;\n+                if (claims.containsKey(claimURI)) {\n+                    values = Arrays.asList(claims.get(claimURI).split(separator));\n+                } else if (oldClaimMap.containsKey(claimURI)) {\n+                    values = oldClaimMap.get(claimURI);\n+                }\n+                if (!CollectionUtils.isEmpty(values)) {\n+                    List<String> modifiedValue =\n+                            (List<String>) CollectionUtils.subtract(values, multiValuedClaimsToDelete.get(claimURI));\n+                    claims.put(claimURI, StringUtils.join(modifiedValue.iterator(), separator));\n+                }\n+            }\n+        }\n+        return claims;\n+    }\n+\n+    private void invokeDoPreSetUserClaimsWithIDListeners(String userID, Map<String, String> claims, String profileName)\n+            throws UserStoreException {\n+\n+        try {\n+            for (UserOperationEventListener listener : UMListenerServiceComponent.getUserOperationEventListeners()) {\n+                if (!((AbstractUserOperationEventListener) listener)\n+                        .doPreSetUserClaimValuesWithID(userID, claims, profileName, this)) {\n+                    handleSetUserClaimValuesFailureWithID(\n+                            ErrorMessages.ERROR_CODE_ERROR_DURING_PRE_SET_USER_CLAIM_VALUES.getCode(),\n+                            String.format(ErrorMessages.ERROR_CODE_ERROR_DURING_PRE_SET_USER_CLAIM_VALUES.getMessage(),\n+                                    UserCoreErrorConstants.PRE_LISTENER_TASKS_FAILED_MESSAGE), userID, claims,\n+                            profileName);\n+                    return;\n+                }\n+            }\n+        } catch (UserStoreException e) {\n+            handleSetUserClaimValuesFailureWithID(\n+                    ErrorMessages.ERROR_CODE_ERROR_DURING_PRE_SET_USER_CLAIM_VALUES.getCode(),\n+                    String.format(ErrorMessages.ERROR_CODE_ERROR_DURING_PRE_SET_USER_CLAIM_VALUES.getMessage(),\n+                            e.getMessage()), userID, claims, profileName);\n+            throw e;\n+        }\n+", "originalCommit": "3f2294363dedc5b782da00e295e7e75f500b9646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTUzNw==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500459537", "bodyText": "fixed in 0b9e061", "author": "AnuradhaSK", "createdAt": "2020-10-06T17:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5MzMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5NDQzNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500394436", "bodyText": "Don't we have to say that this is uniqueId JDBC?", "author": "somindatommy", "createdAt": "2020-10-06T15:32:37Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/jdbc/UniqueIDJDBCUserStoreManager.java", "diffHunk": "@@ -1816,6 +1826,15 @@ public void doSetUserClaimValuesWithID(String userID, Map<String, String> claims\n         super.doSetUserClaimValuesWithID(userID, claims, profileName);\n     }\n \n+    @Override\n+    public void doSetUserClaimValuesWithID(String userID, Map<String, List<String>> multiValuedClaimsToAdd,\n+                                           Map<String, List<String>> multiValuedClaimsToDelete,\n+                                           Map<String, List<String>> claimsExcludingMultiValuedClaims,\n+                                           String profileName) throws NotImplementedException {\n+\n+        throw new NotImplementedException(\"This functionality is not yet implemented for JDBC userstores.\");", "originalCommit": "3f2294363dedc5b782da00e295e7e75f500b9646", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTQwMA==", "url": "https://github.com/wso2/carbon-kernel/pull/2705#discussion_r500459400", "bodyText": "fixed in 0b9e061", "author": "AnuradhaSK", "createdAt": "2020-10-06T17:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM5NDQzNg=="}], "type": "inlineReview"}, {"oid": "0b9e0615f73df04ff560b0323874d376248c8758", "url": "https://github.com/wso2/carbon-kernel/commit/0b9e0615f73df04ff560b0323874d376248c8758", "message": "improve logs and fix formatting issues", "committedDate": "2020-10-06T17:05:31Z", "type": "commit"}, {"oid": "0b9e0615f73df04ff560b0323874d376248c8758", "url": "https://github.com/wso2/carbon-kernel/commit/0b9e0615f73df04ff560b0323874d376248c8758", "message": "improve logs and fix formatting issues", "committedDate": "2020-10-06T17:05:31Z", "type": "forcePushed"}]}