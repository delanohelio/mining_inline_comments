{"pr_number": 2692, "pr_title": "Implement UMData deletion", "pr_createdAt": "2020-05-25T11:21:20Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2692", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMDQ1OA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429900458", "bodyText": "Shall we format the newly added SQL lines to follow the maximum characters per line rule (<=120)? WDYT? Please format the other places as well.", "author": "ShanChathusanda93", "createdAt": "2020-05-25T12:07:49Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/authorization/DBConstants.java", "diffHunk": "@@ -73,6 +75,7 @@\n     public static final String DELETE_USER_PERMISSION_SQL = \"DELETE FROM UM_USER_PERMISSION WHERE UM_USER_NAME=? \" +\n             \"AND UM_PERMISSION_ID = (SELECT UM_ID FROM UM_PERMISSION WHERE UM_RESOURCE_ID = ? AND \" +\n             \"UM_ACTION = ? AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL = \"DELETE FROM UM_USER_PERMISSION WHERE UM_TENANT_ID = ?\";", "originalCommit": "7c5e0844453b1976ac5f452925f6c393553c8c33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTM5MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429901390", "bodyText": "Shall we add only the UserStoreException rather than the relative path? WDYT?", "author": "ShanChathusanda93", "createdAt": "2020-05-25T12:10:15Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws org.wso2.carbon.user.api.UserStoreException", "originalCommit": "7c5e0844453b1976ac5f452925f6c393553c8c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NzQyMw==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430077423", "bodyText": "The full path is included here as there is another UserStoreException which is inherited by this. But I think we can use that Exception here.\n+1", "author": "sumedhe", "createdAt": "2020-05-25T21:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTczNA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429901734", "bodyText": "Is it possible to catch a specific exception here rather than catching the Exception class?", "author": "ShanChathusanda93", "createdAt": "2020-05-25T12:11:04Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {", "originalCommit": "7c5e0844453b1976ac5f452925f6c393553c8c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NTczMA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430075730", "bodyText": "Here the SQLException is handled inside executeDeleteQuery method and it returns new Exception with the error message. So I thought to catch that Exception here. And both are private methods.\nAny suggestions to handle them in a better way?", "author": "sumedhe", "createdAt": "2020-05-25T21:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMTczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMjE5Nw==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r429902197", "bodyText": "Shall we throw a specific exception from here? WDYT?", "author": "ShanChathusanda93", "createdAt": "2020-05-25T12:12:18Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,74 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws Exception {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (Exception e) {\n+            conn.rollback();\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            throw new Exception(errorMsg, e);\n+        } finally {\n+            conn.close();\n+        }\n+    }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private static void executeDeleteQuery(Connection conn, String query, int tenantId)", "originalCommit": "7c5e0844453b1976ac5f452925f6c393553c8c33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3Njg1OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r430076859", "bodyText": "Yes. It's better. I threw a new Exception here as I already handled the SQLException inside this function. Or we can throw the same SQLException from here too.", "author": "sumedhe", "createdAt": "2020-05-25T21:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkwMjE5Nw=="}], "type": "inlineReview"}, {"oid": "3bbb6d67b542ec334acd35e0b6e40d0705626c0e", "url": "https://github.com/wso2/carbon-kernel/commit/3bbb6d67b542ec334acd35e0b6e40d0705626c0e", "message": "Fix minor issues", "committedDate": "2020-06-01T20:29:15Z", "type": "forcePushed"}, {"oid": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "url": "https://github.com/wso2/carbon-kernel/commit/6756f163dee5a07d2deb7e74fea59ce102b2f14f", "message": "Fix minor issues", "committedDate": "2020-06-11T19:44:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442054152", "bodyText": "These should not be used from Identity Server. Improved claim manager functionality is moved to the carbon-identity-framework repo. Check if you have some necessary changes there as well.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:24:06Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/claim/dao/ClaimDBConstants.java", "diffHunk": "@@ -27,6 +27,7 @@\n     public static final String DELETE_CLAIM_SQL = \"DELETE FROM UM_CLAIM WHERE UM_CLAIM_URI=? AND \" +\n             \"UM_DIALECT_ID=(SELECT UM_ID FROM UM_DIALECT WHERE UM_DIALECT_URI=? \" +\n             \"AND UM_TENANT_ID=?) AND UM_TENANT_ID=?\";\n+    public static final String DELETE_CLAIM_BY_TENANT_ID_SQL = \"DELETE FROM UM_CLAIM WHERE UM_TENANT_ID=?\";", "originalCommit": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1NzA5OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442757099", "bodyText": "Yes. Identity server uses claim metadata service for claim management. Anyway, check whether we are adding any records to these UM tables while adding a tenant. If not, we can skip this.", "author": "IsuraD", "createdAt": "2020-06-19T10:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI1NTc3Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r443255776", "bodyText": "No records with UM_CLAIMS, UM_DIALECT, UM_CLAIM_BEHAVIOR, UM_PROFILE_CONFIG tables which are related to claims in tenant addition. I'm removing them.", "author": "sumedhe", "createdAt": "2020-06-21T20:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NDE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NTQ0NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442055444", "bodyText": "I don't see any advantage of extracting this method.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:26:06Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {\n+\n+        try {\n+            Connection conn = getDBConnection();\n+            deleteTenantUMData(tenantId, conn);", "originalCommit": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NTY3NA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442055674", "bodyText": "use try with resource to close the connection.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:26:31Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,73 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws SQLException {\n+\n+        try {", "originalCommit": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1Njc2NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442056765", "bodyText": "use try with resource to close the prepared statement.", "author": "madurangasiriwardena", "createdAt": "2020-06-18T08:28:09Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1223,73 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Delete tenant UM Data.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @param conn DB connection\n+     * @throws Exception\n+     */\n+    private static void deleteTenantUMData(int tenantId, Connection conn) throws SQLException {\n+\n+        try {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_CLAIM_BEHAVIOR_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, ProfileDBConstant.DELETE_PROFILE_CONFIG_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_CLAIM_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, ClaimDBConstants.DELETE_DIALECT_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, TenantConstants.DELETE_TENANT_SQL, tenantId);\n+\n+            conn.commit();\n+        } catch (SQLException e) {\n+            conn.rollback();\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            throw new SQLException(errorMsg, e);\n+        } finally {\n+            conn.close();\n+        }\n+    }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private static void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {\n+\n+        PreparedStatement prepStmt = null;\n+        try {\n+            prepStmt = conn.prepareStatement(query);", "originalCommit": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r442758756", "bodyText": "What is the default behavior of executing this? Are we deleting users and roles with the tenant deletion by default or do we have to enable the config?", "author": "IsuraD", "createdAt": "2020-06-19T10:21:35Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +910,23 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {", "originalCommit": "6756f163dee5a07d2deb7e74fea59ce102b2f14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1NjE2Mg==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r443156162", "bodyText": "We have to enable this in config. It supposed to call from carbon-multitenancy.", "author": "sumedhe", "createdAt": "2020-06-20T20:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0MzUzNA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r448743534", "bodyText": "That configuration should honor only for Users and Roles.  Other information such as PERMISSIONS, Internal roles, Internal role mappings should be deleted irrespective of that config on tenant deletion.", "author": "IsuraD", "createdAt": "2020-07-02T04:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc1ODc1Ng=="}], "type": "inlineReview"}, {"oid": "ad93e58bb86d06edf48f8b55b19a0aa622cdd986", "url": "https://github.com/wso2/carbon-kernel/commit/ad93e58bb86d06edf48f8b55b19a0aa622cdd986", "message": "Implement UMData deletion", "committedDate": "2020-06-21T20:55:01Z", "type": "forcePushed"}, {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "url": "https://github.com/wso2/carbon-kernel/commit/69f3c9724053f6a161d626b22f5853498f2fd9c2", "message": "Implement UMData deletion", "committedDate": "2020-07-27T04:45:31Z", "type": "commit"}, {"oid": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "url": "https://github.com/wso2/carbon-kernel/commit/69f3c9724053f6a161d626b22f5853498f2fd9c2", "message": "Implement UMData deletion", "committedDate": "2020-07-27T04:45:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwNjc4MQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r551506781", "bodyText": "Fix formatting issues.", "author": "ashensw", "createdAt": "2021-01-04T19:02:30Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {", "originalCommit": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2MzUxNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r552963516", "bodyText": "Fixed in #2894", "author": "sumedhe", "createdAt": "2021-01-06T21:12:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwNjc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwODAxNg==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r551508016", "bodyText": "Add the specific Exception type. Also, the param descriptions should start with a capital and end with a full stop. Fix all the other comments accrodingly.", "author": "ashensw", "createdAt": "2021-01-04T19:05:04Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception", "originalCommit": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2MzQ2OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r552963469", "bodyText": "Fixed in #2894", "author": "sumedhe", "createdAt": "2021-01-06T21:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUwODAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQyMDMzNA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r562420334", "bodyText": "Current practice is either handle exception and log it with appropriate information. OR throw it.  Log and throw is discouraged as it fills up the logs unnecessarily", "author": "ruwanta", "createdAt": "2021-01-22T06:47:24Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -905,6 +909,50 @@ public void deleteTenant(int tenantId, boolean removeFromPersistentStorage)\n         }\n     }\n \n+    /**\n+     * Delete all tenant information related to tenant stored in UM tables.\n+     *\n+     * @param tenantId Id of the tenant\n+     * @throws UserStoreException\n+     */\n+    @Override\n+    public void deleteTenantUMData(int tenantId) throws UserStoreException {\n+\n+        ServerConfigurationService serverConfigurationService = UserStoreMgtDSComponent.getServerConfigurationService();\n+\n+        try (Connection conn = getDBConnection()) {\n+            conn.setAutoCommit(false);\n+\n+            executeDeleteQuery(conn, DBConstants.DELETE_USER_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_ROLE_PERMISSIONS_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, DBConstants.DELETE_PERMISSION_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USER_PROPERTY_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.DELETE_DOMAIN_FROM_USER_ROLE_BY_TENANT_ID, tenantId);\n+            executeDeleteQuery(conn, JDBCRealmConstants.REMOVE_USER_ROLES_BY_TENANT_ID_SQL, tenantId);\n+\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+            executeDeleteQuery(conn, HybridJDBCConstants.DELETE_REMEMBERME_VALUES_BY_TENANT_ID_SQL, tenantId);\n+\n+            if (Boolean.parseBoolean(serverConfigurationService\n+                    .getFirstProperty(\"Tenant.DeletePrimaryUsersOnTenantDeletion\"))) {\n+                executeDeleteQuery(conn, JDBCRealmConstants.DELETE_ROLES_BY_TENANT_ID_SQL, tenantId);\n+                executeDeleteQuery(conn, JDBCRealmConstants.DELETE_USERS_BY_TENANT_ID_SQL, tenantId);\n+            } else {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Tenant.DeletePrimaryUsersOnTenantDeletion flag is not enabled in carbon.xml. \" +\n+                            \"Users and Roles will not be deleted.\");\n+                }\n+            }\n+\n+            conn.commit();\n+        } catch (SQLException e) {\n+            String errorMsg = \"An error occurred while deleting um data for tenant: \" + tenantId;\n+            log.error(e);", "originalCommit": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQyMDU1OA==", "url": "https://github.com/wso2/carbon-kernel/pull/2692#discussion_r562420558", "bodyText": "Log and throw the same exception is no longer considered best practice", "author": "ruwanta", "createdAt": "2021-01-22T06:47:59Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/tenant/JDBCTenantManager.java", "diffHunk": "@@ -1201,4 +1249,24 @@ private boolean checkUniqueIdColumnInTable() throws UserStoreException {\n         }\n         return false;\n     }\n+\n+    /**\n+     * Execute deletion queries.\n+     *\n+     * @param conn DB connection\n+     * @param query SQL query\n+     * @param tenantId Id of the tenant\n+     * @throws Exception\n+     */\n+    private void executeDeleteQuery(Connection conn, String query, int tenantId)  throws SQLException {\n+\n+        try (PreparedStatement prepStmt = conn.prepareStatement(query)) {\n+            prepStmt.setInt(1, tenantId);\n+            prepStmt.executeUpdate();\n+        } catch (SQLException e) {\n+            String errMsg = \"Error executing query \" + query + \" for tenant: \" + tenantId;\n+            log.error(errMsg, e);", "originalCommit": "69f3c9724053f6a161d626b22f5853498f2fd9c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}