{"pr_number": 598, "pr_title": "SQL translator", "pr_createdAt": "2020-04-09T15:10:32Z", "pr_url": "https://github.com/ibissource/iaf/pull/598", "timeline": [{"oid": "a90e2ec02f65cae9b00a12dcfbda40b88e215735", "url": "https://github.com/ibissource/iaf/commit/a90e2ec02f65cae9b00a12dcfbda40b88e215735", "message": "Add abstract translator.", "committedDate": "2020-04-09T08:25:24Z", "type": "commit"}, {"oid": "c0dd76ed19545eff50bee9aeb9ba3583ef9b7bea", "url": "https://github.com/ibissource/iaf/commit/c0dd76ed19545eff50bee9aeb9ba3583ef9b7bea", "message": "Improve abstract translator.", "committedDate": "2020-04-09T14:05:27Z", "type": "commit"}, {"oid": "6ab75072192ed59cc067909bd0559a3801d3bad0", "url": "https://github.com/ibissource/iaf/commit/6ab75072192ed59cc067909bd0559a3801d3bad0", "message": "Add basic translators.", "committedDate": "2020-04-09T14:06:57Z", "type": "commit"}, {"oid": "572fd56886aecd2f8707827114dd112243fa7b4a", "url": "https://github.com/ibissource/iaf/commit/572fd56886aecd2f8707827114dd112243fa7b4a", "message": "Add parameterless constructor and small regex improvements,", "committedDate": "2020-04-09T14:58:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDk0OQ==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r406460949", "bodyText": "This will work only when the query searched has exactly this form", "author": "gvanbrakel", "createdAt": "2020-04-09T20:33:41Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/translator/MssqlTranslator.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package nl.nn.adapterframework.jdbc.dbms.translator;\n+\n+public class MssqlTranslator extends ITranslator {\n+\tpublic MssqlTranslator(ITranslator target) {\n+\t\tsuper(target);\n+\t}\n+\n+\tpublic MssqlTranslator() {\n+\t\tsuper();\n+\t}\n+\n+\t@Override\n+\tprotected void populateMaps() {\n+\t\tregexes.put(\"NEXTVAL\", toPattern(\"NEXT VALUE FOR (\\\\w+)\"));\n+\t\treplacements.put(\"NEXTVAL\", \"(NEXT VALUE FOR $1)\");\n+\n+\t\tregexes.put(\"CURRVAL\", toPattern(\"SELECT CURRENT_VALUE FROM SYS.SEQUENCES WHERE NAME\\\\s+=\\\\s+'(\\\\w+)'\"));\n+\t\treplacements.put(\"CURRVAL\", \"(SELECT current_value FROM sys.sequences WHERE name = '$1')\");", "originalCommit": "572fd56886aecd2f8707827114dd112243fa7b4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyOTcwMA==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r407929700", "bodyText": "I know, currently these regex strings are more of a placeholder. I'm testing and improving them as i go along, one by one.", "author": "mkmeral", "createdAt": "2020-04-14T07:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDk0OQ=="}], "type": "inlineReview"}, {"oid": "03847af543691ea5a5244f379c7d1946ac77e590", "url": "https://github.com/ibissource/iaf/commit/03847af543691ea5a5244f379c7d1946ac77e590", "message": "Adapt translator to use csv to store regex strings.", "committedDate": "2020-04-14T10:16:24Z", "type": "commit"}, {"oid": "24ef75ca40450f6164110d4422708d4230c4c8b4", "url": "https://github.com/ibissource/iaf/commit/24ef75ca40450f6164110d4422708d4230c4c8b4", "message": "Modify ITranslator to SqlTranslator and remove all extended classes.", "committedDate": "2020-04-14T13:32:18Z", "type": "commit"}, {"oid": "c20ea979bd89adc43c21952b9fda6fe66fa20da7", "url": "https://github.com/ibissource/iaf/commit/c20ea979bd89adc43c21952b9fda6fe66fa20da7", "message": "Adapt SqlTranslator to use csv values.", "committedDate": "2020-04-14T13:32:48Z", "type": "commit"}, {"oid": "97037fe00c1b3b5020fd73899dc40742fa428966", "url": "https://github.com/ibissource/iaf/commit/97037fe00c1b3b5020fd73899dc40742fa428966", "message": "Add csv files for SqlTranslator.", "committedDate": "2020-04-14T13:33:19Z", "type": "commit"}, {"oid": "8cedc839a53c8159f123157bc227c2a06e99f6db", "url": "https://github.com/ibissource/iaf/commit/8cedc839a53c8159f123157bc227c2a06e99f6db", "message": "Create a test suite for sql translator.", "committedDate": "2020-04-15T13:52:55Z", "type": "commit"}, {"oid": "f70b44596e094fd4094c3f2a9f2520354900eea3", "url": "https://github.com/ibissource/iaf/commit/f70b44596e094fd4094c3f2a9f2520354900eea3", "message": "Use more specific exceptions.", "committedDate": "2020-04-15T14:08:27Z", "type": "commit"}, {"oid": "6d102a482ca6fdd88e338da9b9bd7d2836018819", "url": "https://github.com/ibissource/iaf/commit/6d102a482ca6fdd88e338da9b9bd7d2836018819", "message": "Add logging to sql translator.", "committedDate": "2020-04-15T15:25:42Z", "type": "commit"}, {"oid": "77558cc05ba79c490b469f58d89a3e9a7082f743", "url": "https://github.com/ibissource/iaf/commit/77558cc05ba79c490b469f58d89a3e9a7082f743", "message": "Add more tests and small improvements for sql translator.", "committedDate": "2020-04-15T15:41:42Z", "type": "commit"}, {"oid": "f9452e8316cf314661e04b9b3eb395d100583d94", "url": "https://github.com/ibissource/iaf/commit/f9452e8316cf314661e04b9b3eb395d100583d94", "message": "Add more tests, debug, and add property for disabling translations.", "committedDate": "2020-04-22T09:25:47Z", "type": "commit"}, {"oid": "41050ee1099f84e0994d2b295fab89a17619e1ec", "url": "https://github.com/ibissource/iaf/commit/41050ee1099f84e0994d2b295fab89a17619e1ec", "message": "Add Sql translator as the default converter for generic dbms support.", "committedDate": "2020-04-23T08:14:21Z", "type": "commit"}, {"oid": "cacc540d33089b35fc508bfd7a219d1f999cda9a", "url": "https://github.com/ibissource/iaf/commit/cacc540d33089b35fc508bfd7a219d1f999cda9a", "message": "Debug larva tests for ms sql.", "committedDate": "2020-04-23T08:18:58Z", "type": "commit"}, {"oid": "1a56b88ec5feef945c1636ed9932c045b1064eba", "url": "https://github.com/ibissource/iaf/commit/1a56b88ec5feef945c1636ed9932c045b1064eba", "message": "Add extra tests for sql translator.", "committedDate": "2020-04-23T08:19:36Z", "type": "commit"}, {"oid": "624e8d2010619e724e27062f7f6194b2ecbb03fc", "url": "https://github.com/ibissource/iaf/commit/624e8d2010619e724e27062f7f6194b2ecbb03fc", "message": "Add space cleaning to sql translator.", "committedDate": "2020-04-23T10:03:22Z", "type": "commit"}, {"oid": "2744403b6f947026f5b6eaccb86e897d60fc42ac", "url": "https://github.com/ibissource/iaf/commit/2744403b6f947026f5b6eaccb86e897d60fc42ac", "message": "Improve regex strings for sql translator.", "committedDate": "2020-04-23T15:27:44Z", "type": "commit"}, {"oid": "763729300be37214b9bda4b82d574130f6a2b274", "url": "https://github.com/ibissource/iaf/commit/763729300be37214b9bda4b82d574130f6a2b274", "message": "Merge branch 'master' into sql-translator", "committedDate": "2020-06-24T06:54:53Z", "type": "commit"}, {"oid": "3398995ce2b05b56b8bcc1e5995ad355afce3e0c", "url": "https://github.com/ibissource/iaf/commit/3398995ce2b05b56b8bcc1e5995ad355afce3e0c", "message": "Fix compile errors", "committedDate": "2020-06-24T07:25:32Z", "type": "commit"}, {"oid": "a7e43dec57de1cf6f4271c4dfc3d98756cba233d", "url": "https://github.com/ibissource/iaf/commit/a7e43dec57de1cf6f4271c4dfc3d98756cba233d", "message": "Merge branch 'master' into sql-translator", "committedDate": "2020-06-26T11:15:33Z", "type": "commit"}, {"oid": "07b101288fb91bb06c19c17ae1de0880755fe3e4", "url": "https://github.com/ibissource/iaf/commit/07b101288fb91bb06c19c17ae1de0880755fe3e4", "message": "Working version of regex based SqlTranslator", "committedDate": "2020-06-29T16:51:07Z", "type": "commit"}, {"oid": "2a3f5594e57043a8f11c294513ae11fed6240d50", "url": "https://github.com/ibissource/iaf/commit/2a3f5594e57043a8f11c294513ae11fed6240d50", "message": "Fix Codacy issues", "committedDate": "2020-06-29T17:08:02Z", "type": "commit"}, {"oid": "21446d4978705cb0d3b4e1df00a23e438c114514", "url": "https://github.com/ibissource/iaf/commit/21446d4978705cb0d3b4e1df00a23e438c114514", "message": "remove unused dependency", "committedDate": "2020-06-29T17:10:00Z", "type": "commit"}, {"oid": "0ccc2258e23404ff1d648e367be6a340fd95e0e8", "url": "https://github.com/ibissource/iaf/commit/0ccc2258e23404ff1d648e367be6a340fd95e0e8", "message": "fix test ignore", "committedDate": "2020-06-30T07:31:08Z", "type": "commit"}, {"oid": "96006e337cead114646d30998e976d3bef1454da", "url": "https://github.com/ibissource/iaf/commit/96006e337cead114646d30998e976d3bef1454da", "message": "Add overrides", "committedDate": "2020-06-30T07:32:43Z", "type": "commit"}, {"oid": "be24b7b23dd7cc5adc56046a989c6da5f139193b", "url": "https://github.com/ibissource/iaf/commit/be24b7b23dd7cc5adc56046a989c6da5f139193b", "message": "Create interface ISqlTranslator, remove unused code and config", "committedDate": "2020-06-30T15:43:17Z", "type": "commit"}, {"oid": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "url": "https://github.com/ibissource/iaf/commit/9ba2b42bac6cee2400f90b23889233e3da9b267a", "message": "remove .csv files", "committedDate": "2020-07-01T07:51:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4NjQzNw==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448186437", "bodyText": "SqlTranslationPatterns.properties ?", "author": "nielsm5", "createdAt": "2020-07-01T08:00:09Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.logging.log4j.Logger;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.util.ClassUtils;\n+import nl.nn.adapterframework.util.LogUtil;\n+\n+/**\n+ * Sql syntax translator to translate queries\n+ * for different database management systems (e.g. Oracle to MsSql or PostgreSql to MySql)\n+ */\n+public class SqlTranslator implements ISqlTranslator {\n+\tprivate final Logger log = LogUtil.getLogger(this);\n+\n+\tprivate static final String PATTERN_FILE = \"sql-translate.properties\";", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4ODc1Mg==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448188752", "bodyText": "Moet dit niet configured heten? Of anders een check doen om te kijken of er een Match is in de properties file voor de betreffende translatie?", "author": "nielsm5", "createdAt": "2020-07-01T08:04:37Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.logging.log4j.Logger;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.util.ClassUtils;\n+import nl.nn.adapterframework.util.LogUtil;\n+\n+/**\n+ * Sql syntax translator to translate queries\n+ * for different database management systems (e.g. Oracle to MsSql or PostgreSql to MySql)\n+ */\n+public class SqlTranslator implements ISqlTranslator {\n+\tprivate final Logger log = LogUtil.getLogger(this);\n+\n+\tprivate static final String PATTERN_FILE = \"sql-translate.properties\";\n+\n+\tprivate Map<String,Pattern> sources;\n+\tprivate Map<String,String>  targets;\n+\t\n+\tprivate boolean configured=false;\n+\n+\tpublic SqlTranslator(String source, String target) throws JdbcException {\n+\t\tif (StringUtils.isEmpty(source) || StringUtils.isEmpty(target))\n+\t\t\tthrow new IllegalArgumentException(\"Can not translate from [\" + source + \"] to [\" + target + \"]\");\n+\t\tif (source.equalsIgnoreCase(target)) {\n+\t\t\tlog.warn(\"Same source and target for SqlTranslator. Skipping pattern generation.\");\n+\t\t\treturn;\n+\t\t}\n+\t\ttry {\n+\t\t\tif (!readPatterns(source,target)) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new JdbcException(\"cannot create SqlTranslator\",e);\n+\t\t}\n+\t\tconfigured = true;\n+\t}\n+\n+\t@Override\n+\tpublic boolean canConvert(String from, String to) {", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE4OTE5NA==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448189194", "bodyText": "is nu een properties file?", "author": "nielsm5", "createdAt": "2020-07-01T08:05:21Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.logging.log4j.Logger;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.util.ClassUtils;\n+import nl.nn.adapterframework.util.LogUtil;\n+\n+/**\n+ * Sql syntax translator to translate queries\n+ * for different database management systems (e.g. Oracle to MsSql or PostgreSql to MySql)\n+ */\n+public class SqlTranslator implements ISqlTranslator {\n+\tprivate final Logger log = LogUtil.getLogger(this);\n+\n+\tprivate static final String PATTERN_FILE = \"sql-translate.properties\";\n+\n+\tprivate Map<String,Pattern> sources;\n+\tprivate Map<String,String>  targets;\n+\t\n+\tprivate boolean configured=false;\n+\n+\tpublic SqlTranslator(String source, String target) throws JdbcException {\n+\t\tif (StringUtils.isEmpty(source) || StringUtils.isEmpty(target))\n+\t\t\tthrow new IllegalArgumentException(\"Can not translate from [\" + source + \"] to [\" + target + \"]\");\n+\t\tif (source.equalsIgnoreCase(target)) {\n+\t\t\tlog.warn(\"Same source and target for SqlTranslator. Skipping pattern generation.\");\n+\t\t\treturn;\n+\t\t}\n+\t\ttry {\n+\t\t\tif (!readPatterns(source,target)) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new JdbcException(\"cannot create SqlTranslator\",e);\n+\t\t}\n+\t\tconfigured = true;\n+\t}\n+\n+\t@Override\n+\tpublic boolean canConvert(String from, String to) {\n+\t\treturn configured;\n+\t}\n+\t\n+\t/**\n+\t * Translates the given query to the target language.\n+\t * Uses the translation rules set by this and the target translators.\n+\t *\n+\t * @param original Original query to be translated.\n+\t * @return Translated query.\n+\t */\n+\t@Override\n+\tpublic String translate(String original) {\n+\t\tString query = original;\n+\t\tif (sources!=null) {\n+\t\t\tfor (String label:sources.keySet()) {\n+\t\t\t\tMatcher matcher = sources.get(label).matcher(query);\n+\t\t\t\tif (matcher.find()) {\n+\t\t\t\t\tif (log.isTraceEnabled()) log.trace(String.format(\"Found a match for label [%s] pattern [%s]\",label, sources.get(label)));\n+\t\t\t\t\tString replacement = targets.get(label);\n+\t\t\t\t\tif (StringUtils.isNotEmpty(replacement)) {\n+\t\t\t\t\t\tquery = matcher.replaceAll(replacement);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tquery = matcher.replaceAll(\"\");\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tif (StringUtils.isEmpty(query)) {\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn query;\n+\t}\n+\n+\t/**\n+\t * Compiles a pattern with necessary flags.\n+\t * @param str String to be compiled.\n+\t * @return Output pattern.\n+\t */\n+\tprotected Pattern toPattern(String str) {\n+\t\t// Make sure there are no greedy matchers.\n+\t\tString pattern = str.replaceAll(\"\\\\.\\\\*\", \".*?\");\n+\t\tlog.trace(\"Compiling pattern [\" + pattern + \"]\");\n+\t\treturn Pattern.compile(pattern, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE);\n+\t}\n+\n+\t/**\n+\t * Reads data from SOURCE_CSV file.", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5MzkwOQ==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448193909", "bodyText": "Ik vind het raar om een timeout mee te geven voor het lokaal ophalen van een bestand.  Zie ook dat de betreffende methode nog nergens anders gebruikt wordt. De methode an zich is wel handig maar dan wel de connectietimeout argumenten verwijderen.\nIn de methode zit een catch om UnsupportedEncodingException heen en vervolgens wordt een IOException gegooid, is ook een beetje raar toch? Die inheriten elkaar...", "author": "nielsm5", "createdAt": "2020-07-01T08:13:55Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.logging.log4j.Logger;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.util.ClassUtils;\n+import nl.nn.adapterframework.util.LogUtil;\n+\n+/**\n+ * Sql syntax translator to translate queries\n+ * for different database management systems (e.g. Oracle to MsSql or PostgreSql to MySql)\n+ */\n+public class SqlTranslator implements ISqlTranslator {\n+\tprivate final Logger log = LogUtil.getLogger(this);\n+\n+\tprivate static final String PATTERN_FILE = \"sql-translate.properties\";\n+\n+\tprivate Map<String,Pattern> sources;\n+\tprivate Map<String,String>  targets;\n+\t\n+\tprivate boolean configured=false;\n+\n+\tpublic SqlTranslator(String source, String target) throws JdbcException {\n+\t\tif (StringUtils.isEmpty(source) || StringUtils.isEmpty(target))\n+\t\t\tthrow new IllegalArgumentException(\"Can not translate from [\" + source + \"] to [\" + target + \"]\");\n+\t\tif (source.equalsIgnoreCase(target)) {\n+\t\t\tlog.warn(\"Same source and target for SqlTranslator. Skipping pattern generation.\");\n+\t\t\treturn;\n+\t\t}\n+\t\ttry {\n+\t\t\tif (!readPatterns(source,target)) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new JdbcException(\"cannot create SqlTranslator\",e);\n+\t\t}\n+\t\tconfigured = true;\n+\t}\n+\n+\t@Override\n+\tpublic boolean canConvert(String from, String to) {\n+\t\treturn configured;\n+\t}\n+\t\n+\t/**\n+\t * Translates the given query to the target language.\n+\t * Uses the translation rules set by this and the target translators.\n+\t *\n+\t * @param original Original query to be translated.\n+\t * @return Translated query.\n+\t */\n+\t@Override\n+\tpublic String translate(String original) {\n+\t\tString query = original;\n+\t\tif (sources!=null) {\n+\t\t\tfor (String label:sources.keySet()) {\n+\t\t\t\tMatcher matcher = sources.get(label).matcher(query);\n+\t\t\t\tif (matcher.find()) {\n+\t\t\t\t\tif (log.isTraceEnabled()) log.trace(String.format(\"Found a match for label [%s] pattern [%s]\",label, sources.get(label)));\n+\t\t\t\t\tString replacement = targets.get(label);\n+\t\t\t\t\tif (StringUtils.isNotEmpty(replacement)) {\n+\t\t\t\t\t\tquery = matcher.replaceAll(replacement);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tquery = matcher.replaceAll(\"\");\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tif (StringUtils.isEmpty(query)) {\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn query;\n+\t}\n+\n+\t/**\n+\t * Compiles a pattern with necessary flags.\n+\t * @param str String to be compiled.\n+\t * @return Output pattern.\n+\t */\n+\tprotected Pattern toPattern(String str) {\n+\t\t// Make sure there are no greedy matchers.\n+\t\tString pattern = str.replaceAll(\"\\\\.\\\\*\", \".*?\");\n+\t\tlog.trace(\"Compiling pattern [\" + pattern + \"]\");\n+\t\treturn Pattern.compile(pattern, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE);\n+\t}\n+\n+\t/**\n+\t * Reads data from SOURCE_CSV file.\n+\t * Puts the data in memory to be used later.\n+\t * @throws IOException If database name can not be found or file can not be read.\n+\t */\n+\tprivate boolean readPatterns(String sourceDialect, String targetDialect) throws IOException {\n+\t\tsources = new LinkedHashMap<>();\n+\t\ttargets = new LinkedHashMap<>();\n+\n+\t\tString sourceMatch=\".source.\"+sourceDialect.replaceAll(\" \", \"_\");\n+\t\tString targetMatch=\".target.\"+targetDialect.replaceAll(\" \", \"_\");\n+\n+\t\tURL resourceUrl = ClassUtils.getResourceURL(Thread.currentThread().getContextClassLoader(), PATTERN_FILE);\n+\n+\t\ttry (BufferedReader reader = new BufferedReader(ClassUtils.urlToReader(resourceUrl, 10000))) {\n+\t\t\tString line= reader.readLine();", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5NTA3Mw==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448195073", "bodyText": "install of configured?", "author": "nielsm5", "createdAt": "2020-07-01T08:15:59Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslator.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+   Copyright 2020 WeAreFrank!\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.logging.log4j.Logger;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.util.ClassUtils;\n+import nl.nn.adapterframework.util.LogUtil;\n+\n+/**\n+ * Sql syntax translator to translate queries\n+ * for different database management systems (e.g. Oracle to MsSql or PostgreSql to MySql)\n+ */\n+public class SqlTranslator implements ISqlTranslator {\n+\tprivate final Logger log = LogUtil.getLogger(this);\n+\n+\tprivate static final String PATTERN_FILE = \"sql-translate.properties\";\n+\n+\tprivate Map<String,Pattern> sources;\n+\tprivate Map<String,String>  targets;\n+\t\n+\tprivate boolean configured=false;\n+\n+\tpublic SqlTranslator(String source, String target) throws JdbcException {\n+\t\tif (StringUtils.isEmpty(source) || StringUtils.isEmpty(target))\n+\t\t\tthrow new IllegalArgumentException(\"Can not translate from [\" + source + \"] to [\" + target + \"]\");\n+\t\tif (source.equalsIgnoreCase(target)) {\n+\t\t\tlog.warn(\"Same source and target for SqlTranslator. Skipping pattern generation.\");\n+\t\t\treturn;\n+\t\t}\n+\t\ttry {\n+\t\t\tif (!readPatterns(source,target)) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new JdbcException(\"cannot create SqlTranslator\",e);\n+\t\t}\n+\t\tconfigured = true;\n+\t}\n+\n+\t@Override\n+\tpublic boolean canConvert(String from, String to) {\n+\t\treturn configured;\n+\t}\n+\t\n+\t/**\n+\t * Translates the given query to the target language.\n+\t * Uses the translation rules set by this and the target translators.\n+\t *\n+\t * @param original Original query to be translated.\n+\t * @return Translated query.\n+\t */\n+\t@Override\n+\tpublic String translate(String original) {\n+\t\tString query = original;\n+\t\tif (sources!=null) {\n+\t\t\tfor (String label:sources.keySet()) {\n+\t\t\t\tMatcher matcher = sources.get(label).matcher(query);\n+\t\t\t\tif (matcher.find()) {\n+\t\t\t\t\tif (log.isTraceEnabled()) log.trace(String.format(\"Found a match for label [%s] pattern [%s]\",label, sources.get(label)));\n+\t\t\t\t\tString replacement = targets.get(label);\n+\t\t\t\t\tif (StringUtils.isNotEmpty(replacement)) {\n+\t\t\t\t\t\tquery = matcher.replaceAll(replacement);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tquery = matcher.replaceAll(\"\");\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tif (StringUtils.isEmpty(query)) {\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn query;\n+\t}\n+\n+\t/**\n+\t * Compiles a pattern with necessary flags.\n+\t * @param str String to be compiled.\n+\t * @return Output pattern.\n+\t */\n+\tprotected Pattern toPattern(String str) {\n+\t\t// Make sure there are no greedy matchers.\n+\t\tString pattern = str.replaceAll(\"\\\\.\\\\*\", \".*?\");\n+\t\tlog.trace(\"Compiling pattern [\" + pattern + \"]\");\n+\t\treturn Pattern.compile(pattern, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE);\n+\t}\n+\n+\t/**\n+\t * Reads data from SOURCE_CSV file.\n+\t * Puts the data in memory to be used later.\n+\t * @throws IOException If database name can not be found or file can not be read.\n+\t */\n+\tprivate boolean readPatterns(String sourceDialect, String targetDialect) throws IOException {\n+\t\tsources = new LinkedHashMap<>();\n+\t\ttargets = new LinkedHashMap<>();\n+\n+\t\tString sourceMatch=\".source.\"+sourceDialect.replaceAll(\" \", \"_\");\n+\t\tString targetMatch=\".target.\"+targetDialect.replaceAll(\" \", \"_\");\n+\n+\t\tURL resourceUrl = ClassUtils.getResourceURL(Thread.currentThread().getContextClassLoader(), PATTERN_FILE);\n+\n+\t\ttry (BufferedReader reader = new BufferedReader(ClassUtils.urlToReader(resourceUrl, 10000))) {\n+\t\t\tString line= reader.readLine();\n+\t\t\twhile (line!=null) {\n+\t\t\t\tint equalsPos = line.indexOf(\"=\");\n+\t\t\t\tif (!line.startsWith(\"#\") && equalsPos>=0) {\n+\t\t\t\t\tString key = line.substring(0,equalsPos).trim();\n+\t\t\t\t\tString value = line.substring(equalsPos+1).trim();\n+\t\t\t\t\tif (log.isTraceEnabled()) log.trace(\"read key [\"+key+\"] value [\"+value+\"]\");\n+\t\t\t\t\tint sourceMatchPos = key.indexOf(sourceMatch);\n+\t\t\t\t\tif (sourceMatchPos>0) {\n+\t\t\t\t\t\tString label = key.substring(0,sourceMatchPos);\n+\t\t\t\t\t\tsources.put(label, toPattern(value));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tint targetMatchPos = key.indexOf(targetMatch);\n+\t\t\t\t\t\tif (targetMatchPos>0) {\n+\t\t\t\t\t\t\tString label = key.substring(0,targetMatchPos);\n+\t\t\t\t\t\t\ttargets.put(label, value);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tline= reader.readLine();\n+\t\t\t}\n+\t\t}\n+\t\tfor (Iterator<String> it=sources.keySet().iterator();it.hasNext();) {\n+\t\t\tString label = it.next();\n+\t\t\tString source = sources.get(label).toString();\n+\t\t\tString target = targets.get(label);\n+\t\t\tif (target==null || target.equals(source) || target.equals(\"$0\")) {\n+\t\t\t\tit.remove();\n+\t\t\t} else {\n+\t\t\t\tlog.debug(String.format(\"install translation pattern label [%s] source [%s] target [%s]\", label,  source,  target));", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE5OTQ3OA==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448199478", "bodyText": "Ik snap de Dedicated niet in de naam....", "author": "nielsm5", "createdAt": "2020-07-01T08:23:14Z", "path": "core/src/test/java/nl/nn/adapterframework/jdbc/dbms/OracleToH2TranslatorDedicatedTest.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.sql.SQLException;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.jdbc.QueryExecutionContext;\n+\n+public class OracleToH2TranslatorDedicatedTest extends OracleToH2TranslatorTest {\n+\n+\t@Override\n+\tprotected String convertQuery(QueryExecutionContext queryExecutionContext, boolean canModifyQueryExecutionContext) throws JdbcException, SQLException {\n+\t\treturn OracleToH2Translator.convertQuery(queryExecutionContext, canModifyQueryExecutionContext);\n+\t}\n+\n+}", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwMTMxMg==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448201312", "bodyText": "De IbisStore is wel de belangrijkste tabel. Omdat dit nu uit staat wil dat zeggen dat geen identity translaties gedaan kunnen worden?", "author": "nielsm5", "createdAt": "2020-07-01T08:26:06Z", "path": "core/src/test/java/nl/nn/adapterframework/jdbc/dbms/SqlTranslatorTestOracleToH2.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package nl.nn.adapterframework.jdbc.dbms;\n+\n+import java.sql.SQLException;\n+\n+import org.junit.Ignore;\n+\n+import nl.nn.adapterframework.jdbc.JdbcException;\n+import nl.nn.adapterframework.jdbc.QueryExecutionContext;\n+\n+public class SqlTranslatorTestOracleToH2 extends OracleToH2TranslatorTest {\n+\n+\t@Override\n+\tprotected String convertQuery(QueryExecutionContext queryExecutionContext, boolean canModifyQueryExecutionContext) throws JdbcException, SQLException {\n+\t\tSqlTranslator translator = new SqlTranslator(\"Oracle\", \"H2\");\n+\t\treturn translator.translate(queryExecutionContext.getQuery());\n+\t}\n+\n+\t@Ignore(\"too hard for SqlTranslator to create identity column\")\n+\t@Override\n+\tpublic void testIgnoreAlterTableIbisStore() throws JdbcException, SQLException {\n+\t\t//super.testIgnoreAlterTableIbisStore();\n+\t}\n+\t@Ignore(\"too hard for SqlTranslator to create identity column\")\n+\t@Override\n+\tpublic void testConvertQueryCreateTableIbisStore() throws JdbcException, SQLException {\n+\t\t//super.testConvertQueryCreateTableIbisStore();\n+\t}", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwMTc4Nw==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448201787", "bodyText": "Graag bij de warnConvertQuery een comment waarom dit zo in elkaar zit", "author": "nielsm5", "createdAt": "2020-07-01T08:26:51Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/GenericDbmsSupport.java", "diffHunk": "@@ -413,10 +417,49 @@ public String getBooleanValue(boolean value) {\n \t\treturn (\"\"+value).toUpperCase();\n \t}\n \n+\tprotected ISqlTranslator createTranslator(String source, String target) throws JdbcException {\n+\t\treturn new SqlTranslator(source, target);\n+\t}\n+\n \t@Override\n \tpublic void convertQuery(QueryExecutionContext queryExecutionContext, String sqlDialectFrom) throws SQLException, JdbcException {\n \t\tif (isQueryConversionRequired(sqlDialectFrom)) {\n-\t\t\twarnConvertQuery(sqlDialectFrom);\n+\t\t\tISqlTranslator translator = sqlTranslators.get(sqlDialectFrom);\n+\t\t\tif (translator==null) {\n+\t\t\t\tif (sqlTranslators.containsKey(sqlDialectFrom)) {\n+\t\t\t\t\twarnConvertQuery(sqlDialectFrom);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t\ttry {\n+\t\t\t\t\ttranslator = createTranslator(sqlDialectFrom, getDbmsName());\n+\t\t\t\t} catch (IllegalArgumentException e) {\n+\t\t\t\t\twarnConvertQuery(sqlDialectFrom);\n+\t\t\t\t\tsqlTranslators.put(sqlDialectFrom, null);\n+\t\t\t\t\treturn;\n+\t\t\t\t} catch (Exception e) {\n+\t\t\t\t\tthrow new JdbcException(\"Could not translate sql query from \" + sqlDialectFrom + \" to \" + getDbmsName(), e);\n+\t\t\t\t}\n+\t\t\t\tif (!translator.canConvert(sqlDialectFrom, getDbmsName())) {\n+\t\t\t\t\twarnConvertQuery(sqlDialectFrom);\n+\t\t\t\t\tsqlTranslators.put(sqlDialectFrom, null);", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwMjQ0NQ==", "url": "https://github.com/ibissource/iaf/pull/598#discussion_r448202445", "bodyText": "Als ik echt mag zeuren vind ik dat we ergens onze dialecten hard moeten defineren. Nu gebeurd dat half in een spring bestand en kan iedereen elk dialect opgeven dat hij of zij wilt.", "author": "nielsm5", "createdAt": "2020-07-01T08:27:53Z", "path": "core/src/main/java/nl/nn/adapterframework/jdbc/dbms/GenericDbmsSupport.java", "diffHunk": "@@ -413,10 +417,49 @@ public String getBooleanValue(boolean value) {\n \t\treturn (\"\"+value).toUpperCase();\n \t}\n \n+\tprotected ISqlTranslator createTranslator(String source, String target) throws JdbcException {\n+\t\treturn new SqlTranslator(source, target);\n+\t}\n+\n \t@Override\n \tpublic void convertQuery(QueryExecutionContext queryExecutionContext, String sqlDialectFrom) throws SQLException, JdbcException {", "originalCommit": "9ba2b42bac6cee2400f90b23889233e3da9b267a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c484ba867ab94ba2b7383ba2f86c44703b825d5d", "url": "https://github.com/ibissource/iaf/commit/c484ba867ab94ba2b7383ba2f86c44703b825d5d", "message": "Fix issues", "committedDate": "2020-07-01T11:37:40Z", "type": "commit"}]}