{"pr_number": 1156, "pr_title": "Fix #1151 Use original messageid when resending message", "pr_createdAt": "2020-10-16T14:36:50Z", "pr_url": "https://github.com/ibissource/iaf/pull/1156", "timeline": [{"oid": "03c58d3e341b88e3be6f0a322e3bdf961669fa9a", "url": "https://github.com/ibissource/iaf/commit/03c58d3e341b88e3be6f0a322e3bdf961669fa9a", "message": "Use original messageid when resending message", "committedDate": "2020-10-16T14:36:09Z", "type": "commit"}, {"oid": "1f54406ae0fa0feb353ab9ae0bc6db8a668b6ae8", "url": "https://github.com/ibissource/iaf/commit/1f54406ae0fa0feb353ab9ae0bc6db8a668b6ae8", "message": "improve legibility", "committedDate": "2020-10-16T14:57:36Z", "type": "commit"}, {"oid": "6f38bdc25439ce12a3fbb4a7ed0f15055ca1e1f6", "url": "https://github.com/ibissource/iaf/commit/6f38bdc25439ce12a3fbb4a7ed0f15055ca1e1f6", "message": "Mark retries with session variable retry=true", "committedDate": "2020-10-16T15:12:11Z", "type": "commit"}, {"oid": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61", "url": "https://github.com/ibissource/iaf/commit/37a3227c755fd40b1e8f0e4e10f245e19bbe3b61", "message": "Rename storageMessageId into storageKey", "committedDate": "2020-10-19T06:40:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0MjMwMg==", "url": "https://github.com/ibissource/iaf/pull/1156#discussion_r507542302", "bodyText": "Eigenlijk zou ik verwachten dat de txManager slimmer zou zijn, dwz dat hij in zijn commit methode eerst controlleert of hij marked as rollback is.", "author": "nielsm5", "createdAt": "2020-10-19T07:53:08Z", "path": "core/src/main/java/nl/nn/adapterframework/receivers/ReceiverBase.java", "diffHunk": "@@ -1033,28 +1035,34 @@ public void retryMessage(String messageId) throws ListenerException {\n \t\tTransactionStatus txStatus = itx.getStatus();\n \t\tSerializable msg=null;\n \t\tITransactionalStorage<Serializable> errorStorage = getErrorStorage();\n+\t\tthreadContext.put(\"retry\", \"true\");\n \t\ttry {\n \t\t\ttry {\n-\t\t\t\tmsg = errorStorage.getMessage(messageId);\n+\t\t\t\tmsg = errorStorage.getMessage(storageKey);\n \t\t\t\tprocessRawMessage(msg, threadContext, -1, true);\n \t\t\t} catch (Throwable t) {\n \t\t\t\ttxStatus.setRollbackOnly();\n \t\t\t\tthrow new ListenerException(t);\n \t\t\t} finally {\n-\t\t\t\ttxManager.commit(txStatus);\n+\t\t\t\tif (txStatus.isRollbackOnly()) {\n+\t\t\t\t\ttxManager.rollback(txStatus);\n+\t\t\t\t} else {\n+\t\t\t\t\ttxManager.commit(txStatus);", "originalCommit": "37a3227c755fd40b1e8f0e4e10f245e19bbe3b61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0NjcyMg==", "url": "https://github.com/ibissource/iaf/pull/1156#discussion_r507546722", "bodyText": "Dat doet hij ook wel, maar als dat dan zo is, dan rolt hij terug en zegt dat de rollback unexpected was", "author": "gvanbrakel", "createdAt": "2020-10-19T08:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU0MjMwMg=="}], "type": "inlineReview"}]}