{"pr_number": 857, "pr_title": "Avoid classloader contents appearing in logs", "pr_createdAt": "2020-06-22T06:44:40Z", "pr_url": "https://github.com/ibissource/iaf/pull/857", "timeline": [{"oid": "13289e7e8b56d2593470a778b071626df438c84b", "url": "https://github.com/ibissource/iaf/commit/13289e7e8b56d2593470a778b071626df438c84b", "message": "Avoid classloader contents appearing in logs", "committedDate": "2020-06-22T06:42:50Z", "type": "commit"}, {"oid": "c8ba220a8bfa0bb9b4a168a70901c280cad17f8a", "url": "https://github.com/ibissource/iaf/commit/c8ba220a8bfa0bb9b4a168a70901c280cad17f8a", "message": "Prep ClassLoader refactor", "committedDate": "2020-06-22T17:12:07Z", "type": "commit"}, {"oid": "3ab1a332ad1e8f29830fc8156248dc3295393caf", "url": "https://github.com/ibissource/iaf/commit/3ab1a332ad1e8f29830fc8156248dc3295393caf", "message": "Use ClassUtils.getClassLoaderName", "committedDate": "2020-06-22T17:12:43Z", "type": "commit"}, {"oid": "874d94a1d76c4044f5ee46fb42f6e020b5eb71c2", "url": "https://github.com/ibissource/iaf/commit/874d94a1d76c4044f5ee46fb42f6e020b5eb71c2", "message": "Oops its ClassLoaderBase", "committedDate": "2020-06-22T17:59:38Z", "type": "commit"}, {"oid": "afe6fccb3a008ac8c76084cb14e5be7d0e86991a", "url": "https://github.com/ibissource/iaf/commit/afe6fccb3a008ac8c76084cb14e5be7d0e86991a", "message": "Toch maar even anders gedaan", "committedDate": "2020-06-23T07:55:05Z", "type": "commit"}, {"oid": "4e0473209441cfd0bf6097e7065355c402d32d08", "url": "https://github.com/ibissource/iaf/commit/4e0473209441cfd0bf6097e7065355c402d32d08", "message": "fix log name", "committedDate": "2020-06-23T08:00:41Z", "type": "commit"}, {"oid": "120f39a586c2f48435a7866a31cd9081bf2e2b18", "url": "https://github.com/ibissource/iaf/commit/120f39a586c2f48435a7866a31cd9081bf2e2b18", "message": "Implement destroy method", "committedDate": "2020-06-23T14:06:09Z", "type": "commit"}, {"oid": "9b0049ee723179750b68ddb3d5cfe6ea9cc2c5bb", "url": "https://github.com/ibissource/iaf/commit/9b0049ee723179750b68ddb3d5cfe6ea9cc2c5bb", "message": "fix memleak", "committedDate": "2020-06-23T14:06:33Z", "type": "commit"}, {"oid": "0d29cd8bd373694d401c5dc92ea4fc74ccf525cd", "url": "https://github.com/ibissource/iaf/commit/0d29cd8bd373694d401c5dc92ea4fc74ccf525cd", "message": "Fix mem leak in UtilityTransformerPools", "committedDate": "2020-06-23T14:17:00Z", "type": "commit"}, {"oid": "8f5e8926187579aafd53059a1e569409ba24dfc6", "url": "https://github.com/ibissource/iaf/commit/8f5e8926187579aafd53059a1e569409ba24dfc6", "message": "Actually call shutdown on all classLoaders", "committedDate": "2020-06-23T14:17:13Z", "type": "commit"}, {"oid": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "url": "https://github.com/ibissource/iaf/commit/7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "message": "Fix junit test", "committedDate": "2020-06-23T18:05:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5Nzg4Mw==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r445997883", "bodyText": "derivable?\nbeter misschien: 'is not a', 'does not derive from' of 'does not implement'", "author": "gvanbrakel", "createdAt": "2020-06-26T06:46:01Z", "path": "core/src/main/java/nl/nn/adapterframework/configuration/ClassLoaderManager.java", "diffHunk": "@@ -241,14 +241,36 @@ public void reload(ClassLoader classLoader) throws ConfigurationException {\n \t\tif (classLoader == null)\n \t\t\tthrow new ConfigurationException(\"classloader cannot be null\");\n \n-\t\tif (classLoader instanceof ReloadAware) {\n-\t\t\t((ReloadAware)classLoader).reload();\n+\t\tif (classLoader instanceof IConfigurationClassLoader) {\n+\t\t\t((IConfigurationClassLoader) classLoader).reload();\n \t\t} else {\n-\t\t\tLOG.warn(\"classloader [\"+classLoader.toString()+\"] is not ReloadAware, ignoring reload\");\n+\t\t\tLOG.warn(\"classloader [\"+classLoader.toString()+\"] is not derivable from IConfigurationClassLoader, ignoring reload\");", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5ODM1MA==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r445998350", "bodyText": "Hier ook 'derivable',  maar ook: moet dit wel een warning zijn?", "author": "gvanbrakel", "createdAt": "2020-06-26T06:47:13Z", "path": "core/src/main/java/nl/nn/adapterframework/configuration/ClassLoaderManager.java", "diffHunk": "@@ -241,14 +241,36 @@ public void reload(ClassLoader classLoader) throws ConfigurationException {\n \t\tif (classLoader == null)\n \t\t\tthrow new ConfigurationException(\"classloader cannot be null\");\n \n-\t\tif (classLoader instanceof ReloadAware) {\n-\t\t\t((ReloadAware)classLoader).reload();\n+\t\tif (classLoader instanceof IConfigurationClassLoader) {\n+\t\t\t((IConfigurationClassLoader) classLoader).reload();\n \t\t} else {\n-\t\t\tLOG.warn(\"classloader [\"+classLoader.toString()+\"] is not ReloadAware, ignoring reload\");\n+\t\t\tLOG.warn(\"classloader [\"+classLoader.toString()+\"] is not derivable from IConfigurationClassLoader, ignoring reload\");\n \t\t}\n \t}\n \n \tpublic boolean contains(String currentConfigurationName) {\n \t\treturn (classLoaders.containsKey(currentConfigurationName));\n \t}\n+\n+\t/**\n+\t * Removes all created ClassLoaders\n+\t */\n+\tpublic void shutdown() {\n+\t\tfor (Iterator<String> iterator = classLoaders.keySet().iterator(); iterator.hasNext();) {\n+\t\t\tString configurationClassLoader = iterator.next();\n+\t\t\tClassLoader classLoader = classLoaders.get(configurationClassLoader);\n+\t\t\tif(classLoader instanceof IConfigurationClassLoader) {\n+\t\t\t\t((IConfigurationClassLoader) classLoader).destroy();\n+\t\t\t} else {\n+\t\t\t\tLOG.warn(\"classloader [\"+ClassUtils.getClassLoaderName(classLoader)+\"] is not derivable from IConfigurationClassLoader, ignoring destroy\");", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5OTM0OQ==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r445999349", "bodyText": "Is reload() hetzelfde als destroy()? Is dat altijd zo", "author": "gvanbrakel", "createdAt": "2020-06-26T06:49:53Z", "path": "core/src/main/java/nl/nn/adapterframework/configuration/classloaders/ClassLoaderBase.java", "diffHunk": "@@ -253,26 +257,21 @@ public URL getResource(String name, boolean useParent) {\n \t}\n \n \t@Override\n-\tpublic String toString() {\n-\t\tif(StringUtils.isEmpty(getConfigurationName())) {\n-\t\t\treturn super.toString();\n-\t\t}\n+\tpublic void reload() throws ConfigurationException {\n+\t\tlog.debug(\"reloading classloader [\"+getConfigurationName()+\"]\");\n \n-\t\tif(logPrefix==null) {\n-\t\t\tString superString = super.toString();\n-\t\t\tlogPrefix = superString.substring(superString.lastIndexOf(\".\")+1)+\"[\"+getConfigurationName()+\"]\";\n-\t\t}\n-\t\treturn logPrefix;\n+\t\tAppConstants.removeInstance(this);\n \t}\n \n \t@Override\n-\tpublic void reload() throws ConfigurationException {\n-\t\tlog.debug(\"reloading configuration [\"+getConfigurationName()+\"]\");\n-\n-\t\tif (getParent() instanceof ReloadAware) {\n-\t\t\t((ReloadAware)getParent()).reload();\n-\t\t}\n+\tpublic void destroy() {\n+\t\tlog.debug(\"removing classloader [\"+this.toString()+\"]\");\n \n \t\tAppConstants.removeInstance(this);\n \t}\n+", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwMTAwNg==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r446001006", "bodyText": "Zou van mij ook getName() mogen heten.", "author": "gvanbrakel", "createdAt": "2020-06-26T06:54:26Z", "path": "core/src/main/java/nl/nn/adapterframework/util/ClassUtils.java", "diffHunk": "@@ -148,21 +149,36 @@ static public URL getResourceURL(ClassLoader classLoader, String resource, Strin\n \t\t\t\t\t\ttry {\n \t\t\t\t\t\t\turl = new URL(Misc.replace(resource, \" \", \"%20\"));\n \t\t\t\t\t\t} catch(MalformedURLException e) {\n-\t\t\t\t\t\t\tlog.debug(\"Could not find resource [\"+resource+\"] in classloader [\"+classLoader+\"] and not as URL [\" + resource + \"]: \"+e.getMessage());\n+\t\t\t\t\t\t\tlog.debug(\"Could not find resource [\"+resource+\"] in classloader [\"+getClassLoaderName(classLoader)+\"] and not as URL [\" + resource + \"]: \"+e.getMessage());\n \t\t\t\t\t\t}\n-\t\t\t\t\t} else if(log.isDebugEnabled()) log.debug(\"Cannot lookup resource [\"+resource+\"] in classloader [\"+classLoader+\"], not allowed with protocol [\"+protocol+\"] allowedProtocols \"+protocols.toString());\n+\t\t\t\t\t} else if(log.isDebugEnabled()) log.debug(\"Cannot lookup resource [\"+resource+\"] in classloader [\"+getClassLoaderName(classLoader)+\"], not allowed with protocol [\"+protocol+\"] allowedProtocols \"+protocols.toString());\n \t\t\t\t} else {\n-\t\t\t\t\tif(log.isDebugEnabled()) log.debug(\"Could not find resource as URL [\" + resource + \"] in classloader [\"+classLoader+\"], with protocol [\"+protocol+\"], no allowedProtocols\");\n+\t\t\t\t\tif(log.isDebugEnabled()) log.debug(\"Could not find resource as URL [\" + resource + \"] in classloader [\"+getClassLoaderName(classLoader)+\"], with protocol [\"+protocol+\"], no allowedProtocols\");\n \t\t\t\t}\n \t\t\t} else {\n-\t\t\t\tif(log.isDebugEnabled()) log.debug(\"Cannot lookup resource [\"+resource+\"] in classloader [\"+classLoader+\"] and no protocol to try as URL\");\n+\t\t\t\tif(log.isDebugEnabled()) log.debug(\"Cannot lookup resource [\"+resource+\"] in classloader [\"+getClassLoaderName(classLoader)+\"] and no protocol to try as URL\");\n \t\t\t}\n \t\t}\n \n \t\treturn url;\n \t}\n \n- \tpublic static InputStream urlToStream(URL url, int timeoutMs) throws IOException {\n+\t/**\n+\t * If the classLoader is derivable of IConfigurationClassLoader return the className + configurationName, \n+\t * else return the className of the object. Don't return the package name to avoid cluttering the logs.\n+\t */\n+\tpublic static String getClassLoaderName(ClassLoader classLoader) {", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg2MTgzNw==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r446861837", "bodyText": "andere methode heet nameOf(...). Misschien is het mooi deze het zelfde te laten heten? Aan de andere kant doet de getName(...) methode wel net iets anders dan nameOf(...)", "author": "nielsm5", "createdAt": "2020-06-29T08:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwMTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwMjEyMw==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r446002123", "bodyText": "Eens. Moet 'null' zijn, d.w.z. als de Xslt niet via een Resource wordt aangeboden mag er geen External Entity Expansion zijn, en dus ook geen classpath nodig.", "author": "gvanbrakel", "createdAt": "2020-06-26T06:57:23Z", "path": "core/src/main/java/nl/nn/adapterframework/util/TransformerPool.java", "diffHunk": "@@ -168,27 +164,33 @@ private TransformerPool(Source source, String sysId, int xsltVersion, Source con\n \t\t}\n \t\tthis.xsltVersion=xsltVersion;\n \t\ttFactory = XmlUtils.getTransformerFactory(xsltVersion);\n-\t\tclassLoaderURIResolver = new ClassLoaderURIResolver(classLoader);\n-\t\tif (log.isDebugEnabled()) log.debug(\"created Transformerpool for sysId [\"+sysId+\"] classLoader [\"+classLoader+\"]\");\n-\t\ttFactory.setURIResolver(classLoaderURIResolver);\n+\t\tif(classLoader != null) {\n+\t\t\tclassLoaderURIResolver = new ClassLoaderURIResolver(classLoader);\n+\t\t\tif (log.isDebugEnabled()) log.debug(\"created Transformerpool for sysId [\"+sysId+\"] classloader [\"+ClassUtils.getClassLoaderName(classLoader)+\"]\");\n+\t\t\ttFactory.setURIResolver(classLoaderURIResolver);\n+\t\t}\n \t\tinitTransformerPool(source, sysId);\n \n \t\t// check if a transformer can be initiated\n \t\tTransformer t = getTransformer();\n \t\t\n \t\treleaseTransformer(t);\n-\t}\t\n+\t}\n \n \n \tprivate TransformerPool(Resource resource, int xsltVersion) throws TransformerConfigurationException, IOException, SAXException {\n \t\tthis(resource.asSource(),resource.getSystemId(),xsltVersion,resource.asSource(), resource.getClassLoader());\n \t}\n-\t\n+\n+\t//TODO Fix this, Thread.currentThread().getContextClassLoader() should not be used and causes memory leaks upon reloading configurations!!!", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwMzM4MA==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r446003380", "bodyText": "Dat je deze sluit betekent niet dat je ze allemaal sluit!", "author": "gvanbrakel", "createdAt": "2020-06-26T07:00:41Z", "path": "core/src/main/java/nl/nn/adapterframework/util/TransformerPool.java", "diffHunk": "@@ -352,18 +362,23 @@ public static TransformerPool configureStyleSheetTransformer(String logPrefix, C\n \t\treturn result;\n \t}\n \n-\t\n \tpublic void open() throws Exception {\n \t}\n-\t\n+\n+\t/**\n+\t * Closing the Pool doesn't automatically mean all references remaining in the pool will be terminated.\n+\t * After closing, manually releases any associated resources in the pool\n+\t */\n \tpublic void close() {\n \t\ttry {\n-\t\t\tpool.clear();\t\t\t\n+\t\t\tpool.clear();\n+\t\t\tclearTransformerPools();", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAwNDg1OA==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r446004858", "bodyText": "Werkt dit altijd? Of alleen voor IConfigurationClassLoaders? Dan class hernoemen.", "author": "gvanbrakel", "createdAt": "2020-06-26T07:04:20Z", "path": "core/src/test/java/nl/nn/adapterframework/configuration/classloaders/ClassLoaderTestBase.java", "diffHunk": "@@ -254,4 +254,12 @@ public void configurationFileCustomLocationAndBasePath() throws Exception {\n \t\tassertNotNull(\"config file [\"+configFile+\"] cannot be found\", configURL);\n \t\tassertTrue(configURL.getPath().endsWith(file));\n \t}\n+\n+\t@Test\n+\tpublic void toStringTest() throws Exception {\n+\t\tString logPrefix = classLoader.getClass().getSimpleName() + \"@\" + Integer.toHexString(classLoader.hashCode());\n+\n+\t\t//Should match DatabaseClassLoader@1234abcd[<CONFIG-NAME>]\n+\t\tassertEquals(logPrefix+\"[\"+getConfigurationName()+\"]\", classLoader.toString());", "originalCommit": "7a6953c2996f2c872270e0baff3c9f77b8ec6b24", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "023aa980827ad6fb08643577403a83459bb04f7b", "url": "https://github.com/ibissource/iaf/commit/023aa980827ad6fb08643577403a83459bb04f7b", "message": "Rename getClassLoaderName to getName", "committedDate": "2020-06-29T07:51:25Z", "type": "commit"}, {"oid": "8212c17c50afad00fe25df94bcad5db3afe811f6", "url": "https://github.com/ibissource/iaf/commit/8212c17c50afad00fe25df94bcad5db3afe811f6", "message": "Remove clearTransformerPools", "committedDate": "2020-06-29T08:11:35Z", "type": "commit"}, {"oid": "cb21acf4c737a352afb44cfeee7227e83d18d1bd", "url": "https://github.com/ibissource/iaf/commit/cb21acf4c737a352afb44cfeee7227e83d18d1bd", "message": "Rename classloadertest base class", "committedDate": "2020-06-29T08:13:42Z", "type": "commit"}, {"oid": "3e4c8374219a04bfef3a53c3f96334c807263157", "url": "https://github.com/ibissource/iaf/commit/3e4c8374219a04bfef3a53c3f96334c807263157", "message": "Remove unused field", "committedDate": "2020-06-29T08:15:48Z", "type": "commit"}, {"oid": "885919276bc0f6c81ec5835a9102527179deff23", "url": "https://github.com/ibissource/iaf/commit/885919276bc0f6c81ec5835a9102527179deff23", "message": "Rename to nameOf", "committedDate": "2020-06-29T09:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5ODg4MQ==", "url": "https://github.com/ibissource/iaf/pull/857#discussion_r447598881", "bodyText": "Hier moet je dan in de else tak een NonResolvingUriResolver zetten.", "author": "gvanbrakel", "createdAt": "2020-06-30T11:03:37Z", "path": "core/src/main/java/nl/nn/adapterframework/util/TransformerPool.java", "diffHunk": "@@ -168,27 +164,33 @@ private TransformerPool(Source source, String sysId, int xsltVersion, Source con\n \t\t}\n \t\tthis.xsltVersion=xsltVersion;\n \t\ttFactory = XmlUtils.getTransformerFactory(xsltVersion);\n-\t\tclassLoaderURIResolver = new ClassLoaderURIResolver(classLoader);\n-\t\tif (log.isDebugEnabled()) log.debug(\"created Transformerpool for sysId [\"+sysId+\"] classLoader [\"+classLoader+\"]\");\n-\t\ttFactory.setURIResolver(classLoaderURIResolver);\n+\t\tif(classLoader != null) {\n+\t\t\tclassLoaderURIResolver = new ClassLoaderURIResolver(classLoader);\n+\t\t\tif (log.isDebugEnabled()) log.debug(\"created Transformerpool for sysId [\"+sysId+\"] classloader [\"+ClassUtils.getName(classLoader)+\"]\");\n+\t\t\ttFactory.setURIResolver(classLoaderURIResolver);\n+\t\t}", "originalCommit": "3e4c8374219a04bfef3a53c3f96334c807263157", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a9f9de23d40c96c065b0364d1df3f0bcb2cce85", "url": "https://github.com/ibissource/iaf/commit/8a9f9de23d40c96c065b0364d1df3f0bcb2cce85", "message": "Make sure resources don't resolve when no ClassLoader is present", "committedDate": "2020-07-01T11:49:39Z", "type": "commit"}]}