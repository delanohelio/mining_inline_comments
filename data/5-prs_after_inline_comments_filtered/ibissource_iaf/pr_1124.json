{"pr_number": 1124, "pr_title": "Add option to use an adapter to determine cmis event routing", "pr_createdAt": "2020-10-06T07:37:13Z", "pr_url": "https://github.com/ibissource/iaf/pull/1124", "timeline": [{"oid": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "url": "https://github.com/ibissource/iaf/commit/a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "message": "Add option to use an adapter to determine cmis event routing", "committedDate": "2020-10-05T13:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMjgwOA==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r500302808", "bodyText": "Hier mogen toch wel meer snorhaken", "author": "gvanbrakel", "createdAt": "2020-10-06T13:57:20Z", "path": "cmis/src/main/java/nl/nn/adapterframework/extensions/cmis/CmisUtils.java", "diffHunk": "@@ -679,14 +679,21 @@ private static XmlBuilder repositoryCapabilities2xml(RepositoryCapabilities capa\n \t\t\tif(capabilities.isVersionSpecificFilingSupported() != null)\n \t\t\t\trepositoryXml.addAttribute(\"supportsVersionSpecificFiling\", capabilities.isVersionSpecificFilingSupported());\n \n-\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n+\t\t\tif(capabilities.getAclCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n+\t\t\tif(capabilities.getChangesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n+\t\t\tif(capabilities.getContentStreamUpdatesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n \t\t\trepositoryXml.addSubElement(CmisUtils.creatablePropertyTypes2xml(capabilities.getCreatablePropertyTypes()));\n+\t\t\tif(capabilities.getJoinCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"joinCapability\", capabilities.getJoinCapability().name());\n \t\t\trepositoryXml.addSubElement(CmisUtils.newTypeSettableAttributes2xml(capabilities.getNewTypeSettableAttributes()));\n-\t\t\trepositoryXml.addAttribute(\"orderByCapability\", capabilities.getOrderByCapability().name());\n+\t\t\tif(capabilities.getOrderByCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"orderByCapability\", capabilities.getOrderByCapability().name());\n+\t\t\tif(capabilities.getQueryCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"queryCapability\", capabilities.getQueryCapability().name());\n+\t\t\tif(capabilities.getRenditionsCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"renditionsCapability\", capabilities.getRenditionsCapability().name());", "originalCommit": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwNTcyNQ==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r500305725", "bodyText": "Zou je dit niet proxying moeten noemen?", "author": "gvanbrakel", "createdAt": "2020-10-06T14:00:20Z", "path": "cmis/src/main/java/nl/nn/adapterframework/extensions/cmis/server/CmisEventDispatcher.java", "diffHunk": "@@ -67,14 +77,16 @@ public Element trigger(CmisEvent event, String message, CallContext callContext)\n \t}\n \n \tpublic Element trigger(CmisEvent event, String message, IPipeLineSession messageContext) {\n-\t\tCmisUtils.populateCmisAttributes(messageContext);\n-\n \t\tif(!eventListeners.containsKey(event))\n-\t\t\tthrow new CmisRuntimeException(\"event [\"+event.toString()+\"] not found\");\n+\t\t\tthrow new CmisRuntimeException(\"event [\"+event.name()+\"] not registered\");\n+\n+\t\tif(log.isDebugEnabled()) log.debug(\"bridging CmisEvent [\"+event.name()+\"]\");", "originalCommit": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMDkwNw==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r502310907", "bodyText": "Wij hebben de Apache OpenCmis bridge dus vandaar de naam. Het extra wat wij er bij doen is dingen door een Frank! heen halen.", "author": "nielsm5", "createdAt": "2020-10-09T09:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwNTcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMDg5OQ==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r500400899", "bodyText": "Waarom geef je niet zoiets als true of false terug, en zodat je excepties voor excepties kan bewaren?", "author": "gvanbrakel", "createdAt": "2020-10-06T15:39:40Z", "path": "cmis/src/main/java/nl/nn/adapterframework/extensions/cmis/server/CmisEventDispatcher.java", "diffHunk": "@@ -99,6 +111,29 @@ else if (XmlUtils.isWellFormed(result, \"cmis\")) {\n \t}\n \n \tpublic boolean contains(CmisEvent event) {\n-\t\treturn eventListeners.containsKey(event);\n+\t\tif(StringUtils.isNotEmpty(dispatcherName)) {\n+\t\t\tJavaListener listener = JavaListener.getListener(dispatcherName);\n+\t\t\tif(listener == null) {\n+\t\t\t\tthrow new CmisRuntimeException(\"unable to bridge cmis request, dispatcher offline\"); //Adapter registered but not started\n+\t\t\t}\n+\n+\t\t\tHashMap<String, Object> messageContext = new HashMap<>();\n+\t\t\tmessageContext.put(\"CmisEvent\", event.name());\n+\n+\t\t\ttry {\n+\t\t\t\tlistener.processRequest(null, event.name(), messageContext);\n+\t\t\t\t// Nothing is done with the result, it's purely to check if the event should be bridged or not. If not, an execption should be thrown.\n+", "originalCommit": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMTM1Nw==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r502311357", "bodyText": "Omdat je bij een exceptie echt wilt dat hij niets doet, en je mooi een foutmelding mee kan geven.", "author": "nielsm5", "createdAt": "2020-10-09T09:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyODIxNQ==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r502328215", "bodyText": "always false unless explicitly true", "author": "nielsm5", "createdAt": "2020-10-09T10:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMDg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDUzMA==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r502330530", "bodyText": "indent!", "author": "nielsm5", "createdAt": "2020-10-09T10:17:34Z", "path": "cmis/src/main/java/nl/nn/adapterframework/extensions/cmis/CmisUtils.java", "diffHunk": "@@ -679,14 +679,21 @@ private static XmlBuilder repositoryCapabilities2xml(RepositoryCapabilities capa\n \t\t\tif(capabilities.isVersionSpecificFilingSupported() != null)\n \t\t\t\trepositoryXml.addAttribute(\"supportsVersionSpecificFiling\", capabilities.isVersionSpecificFilingSupported());\n \n-\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n+\t\t\tif(capabilities.getAclCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n+\t\t\tif(capabilities.getChangesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n+\t\t\tif(capabilities.getContentStreamUpdatesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n \t\t\trepositoryXml.addSubElement(CmisUtils.creatablePropertyTypes2xml(capabilities.getCreatablePropertyTypes()));\n+\t\t\tif(capabilities.getJoinCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"joinCapability\", capabilities.getJoinCapability().name());", "originalCommit": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMDY0Nw==", "url": "https://github.com/ibissource/iaf/pull/1124#discussion_r502330647", "bodyText": "indent!", "author": "nielsm5", "createdAt": "2020-10-09T10:17:46Z", "path": "cmis/src/main/java/nl/nn/adapterframework/extensions/cmis/CmisUtils.java", "diffHunk": "@@ -679,14 +679,21 @@ private static XmlBuilder repositoryCapabilities2xml(RepositoryCapabilities capa\n \t\t\tif(capabilities.isVersionSpecificFilingSupported() != null)\n \t\t\t\trepositoryXml.addAttribute(\"supportsVersionSpecificFiling\", capabilities.isVersionSpecificFilingSupported());\n \n-\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n-\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n+\t\t\tif(capabilities.getAclCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"aclCapability\", capabilities.getAclCapability().name());\n+\t\t\tif(capabilities.getChangesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"changesCapability\", capabilities.getChangesCapability().name());\n+\t\t\tif(capabilities.getContentStreamUpdatesCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"contentStreamUpdatesCapability\", capabilities.getContentStreamUpdatesCapability().name());\n \t\t\trepositoryXml.addSubElement(CmisUtils.creatablePropertyTypes2xml(capabilities.getCreatablePropertyTypes()));\n+\t\t\tif(capabilities.getJoinCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"joinCapability\", capabilities.getJoinCapability().name());\n \t\t\trepositoryXml.addSubElement(CmisUtils.newTypeSettableAttributes2xml(capabilities.getNewTypeSettableAttributes()));\n-\t\t\trepositoryXml.addAttribute(\"orderByCapability\", capabilities.getOrderByCapability().name());\n+\t\t\tif(capabilities.getOrderByCapability() != null)\n+\t\t\t\trepositoryXml.addAttribute(\"orderByCapability\", capabilities.getOrderByCapability().name());\n+\t\t\tif(capabilities.getQueryCapability() != null)\n \t\t\trepositoryXml.addAttribute(\"queryCapability\", capabilities.getQueryCapability().name());", "originalCommit": "a4699916bb0b1ea385a3ca3b548f8cb6e4dcc545", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ed6fb589c16d225f020ca50277829855e04e8a4", "url": "https://github.com/ibissource/iaf/commit/2ed6fb589c16d225f020ca50277829855e04e8a4", "message": "Use the dispatcherAdapter result; either true, false or an exception", "committedDate": "2020-10-12T14:38:24Z", "type": "commit"}]}