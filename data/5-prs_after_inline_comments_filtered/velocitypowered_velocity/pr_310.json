{"pr_number": 310, "pr_title": "[Future] 1.16 Update", "pr_createdAt": "2020-05-22T22:23:34Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/310", "timeline": [{"oid": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "url": "https://github.com/VelocityPowered/Velocity/commit/d37b6a361cb05f69db2608c29c4608dc6881edc7", "message": "Snapshot 20w21a", "committedDate": "2020-05-22T22:18:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTMyMg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479322", "bodyText": "Add @Nullable", "author": "mikroskeem", "createdAt": "2020-05-22T22:31:17Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Chat.java", "diffHunk": "@@ -10,20 +10,25 @@\n import net.kyori.text.serializer.gson.GsonComponentSerializer;\n import org.checkerframework.checker.nullness.qual.Nullable;\n \n+import java.util.UUID;\n+\n public class Chat implements MinecraftPacket {\n \n   public static final byte CHAT_TYPE = (byte) 0;\n   public static final int MAX_SERVERBOUND_MESSAGE_LENGTH = 256;\n+  public static final UUID EMPTY_SENDER = new UUID(0, 0);\n \n   private @Nullable String message;\n   private byte type;\n+  private UUID sender;", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTM4MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479381", "bodyText": "Use EMPTY_SENDER constant here", "author": "mikroskeem", "createdAt": "2020-05-22T22:31:39Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Chat.java", "diffHunk": "@@ -69,6 +86,9 @@ public void encode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersi\n     ProtocolUtils.writeString(buf, message);\n     if (direction == ProtocolUtils.Direction.CLIENTBOUND) {\n       buf.writeByte(type);\n+      if(version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+        ProtocolUtils.writeUuid(buf, sender == null ? new UUID(0,0) : sender);", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMjE1OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429532159", "bodyText": "Silly me, I made it for that purpose", "author": "Xernium", "createdAt": "2020-05-23T09:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTQwNA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479404", "bodyText": "if (", "author": "mikroskeem", "createdAt": "2020-05-22T22:31:45Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Chat.java", "diffHunk": "@@ -69,6 +86,9 @@ public void encode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersi\n     ProtocolUtils.writeString(buf, message);\n     if (direction == ProtocolUtils.Direction.CLIENTBOUND) {\n       buf.writeByte(type);\n+      if(version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMjMyOQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429532329", "bodyText": "I swear to god IntelliJ", "author": "Xernium", "createdAt": "2020-05-23T09:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTQ5MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479491", "bodyText": "// 1.16+", "author": "mikroskeem", "createdAt": "2020-05-22T22:32:15Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/JoinGame.java", "diffHunk": "@@ -19,6 +20,11 @@\n   private int viewDistance; //1.14+\n   private boolean reducedDebugInfo;\n   private boolean showRespawnScreen;\n+  private boolean shouldKeepPlayerData;\n+  private boolean isDebug;\n+  private boolean isFlat;\n+  private String dimensionRegistryName;\n+  private CompoundTag dimensionRegistry;", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTY5Ng==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479696", "bodyText": "Move this to else if instead of nesting into else block", "author": "mikroskeem", "createdAt": "2020-05-22T22:33:16Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/JoinGame.java", "diffHunk": "@@ -110,10 +156,15 @@ public String toString() {\n   public void decode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersion version) {\n     this.entityId = buf.readInt();\n     this.gamemode = buf.readUnsignedByte();\n-    if (version.compareTo(ProtocolVersion.MINECRAFT_1_9_1) >= 0) {\n-      this.dimension = buf.readInt();\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+      this.dimensionRegistry = ProtocolUtils.readCompoundTag(buf);\n+      this.dimensionRegistryName = ProtocolUtils.readString(buf);\n     } else {\n-      this.dimension = buf.readByte();\n+      if (version.compareTo(ProtocolVersion.MINECRAFT_1_9_1) >= 0) {", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTc2Mg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479762", "bodyText": "Move this to else if instead of nesting into else block", "author": "mikroskeem", "createdAt": "2020-05-22T22:33:35Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/JoinGame.java", "diffHunk": "@@ -122,24 +173,37 @@ public void decode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersi\n       this.partialHashedSeed = buf.readLong();\n     }\n     this.maxPlayers = buf.readUnsignedByte();\n-    this.levelType = ProtocolUtils.readString(buf, 16);\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) < 0) {\n+      this.levelType = ProtocolUtils.readString(buf, 16);\n+    } else {\n+      this.levelType = \"default\"; // I didn't have the courage to rework this yet.\n+    }\n     if (version.compareTo(ProtocolVersion.MINECRAFT_1_14) >= 0) {\n       this.viewDistance = ProtocolUtils.readVarInt(buf);\n     }\n     this.reducedDebugInfo = buf.readBoolean();\n     if (version.compareTo(ProtocolVersion.MINECRAFT_1_15) >= 0) {\n       this.showRespawnScreen = buf.readBoolean();\n     }\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+      isDebug = buf.readBoolean();\n+      isFlat = buf.readBoolean();\n+    }\n   }\n \n   @Override\n   public void encode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersion version) {\n     buf.writeInt(entityId);\n     buf.writeByte(gamemode);\n-    if (version.compareTo(ProtocolVersion.MINECRAFT_1_9_1) >= 0) {\n-      buf.writeInt(dimension);\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+      ProtocolUtils.writeCompoundTag(buf, dimensionRegistry);\n+      ProtocolUtils.writeString(buf, dimensionRegistryName);\n     } else {\n-      buf.writeByte(dimension);\n+      if (version.compareTo(ProtocolVersion.MINECRAFT_1_9_1) >= 0) {", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3OTg2NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429479864", "bodyText": "// added in 1.16", "author": "mikroskeem", "createdAt": "2020-05-22T22:34:06Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/brigadier/ArgumentPropertyRegistry.java", "diffHunk": "@@ -134,5 +134,6 @@ public static void serialize(ByteBuf buf, ArgumentType<?> type) {\n     dummy(\"minecraft:int_range\", DUMMY);\n     dummy(\"minecraft:float_range\", DUMMY);\n     dummy(\"minecraft:time\", DUMMY); // added in 1.14\n+    dummy(\"minecraft:uuid\", DUMMY);", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4MDAwMA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429480000", "bodyText": "Drop this else block, move contents out from it", "author": "mikroskeem", "createdAt": "2020-05-22T22:34:57Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +160,81 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      return null;\n+    } else {", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4MDA1NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429480054", "bodyText": "Could use try-resources here", "author": "mikroskeem", "createdAt": "2020-05-22T22:35:16Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +160,81 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      return null;\n+    } else {\n+      buf.readerIndex(indexBefore);\n+      try {\n+        DataInput input = new ByteBufInputStream(buf);", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMjEyNQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429532125", "bodyText": "No, DataInput is not Closeable", "author": "Xernium", "createdAt": "2020-05-23T09:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4MDA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4MDEwNw==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429480107", "bodyText": "See comments for readCompoundTag", "author": "mikroskeem", "createdAt": "2020-05-22T22:35:30Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +160,81 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      return null;\n+    } else {\n+      buf.readerIndex(indexBefore);\n+      try {\n+        DataInput input = new ByteBufInputStream(buf);\n+        byte type = input.readByte();\n+        if (type != 10) {\n+          return null;\n+        }\n+        input.readUTF();\n+        CompoundTag ret = new CompoundTag();\n+        ret.read(input, 0);\n+        return ret;\n+      } catch (IOException e) {\n+        return null;\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Writes a CompoundTag to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param compoundTag the CompoundTag to write\n+   */\n+  public static void writeCompoundTag(ByteBuf buf, CompoundTag compoundTag) {\n+    if (compoundTag == null) {\n+      buf.writeByte(0);\n+    } else {", "originalCommit": "d37b6a361cb05f69db2608c29c4608dc6881edc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fca73bae675d396cb584fc48e2c0548cc6595e58", "url": "https://github.com/VelocityPowered/Velocity/commit/fca73bae675d396cb584fc48e2c0548cc6595e58", "message": "Some minor touch-ups", "committedDate": "2020-05-23T09:46:27Z", "type": "commit"}, {"oid": "197bc4f288f4b01f3348e98d84e5facb0f224518", "url": "https://github.com/VelocityPowered/Velocity/commit/197bc4f288f4b01f3348e98d84e5facb0f224518", "message": "Make checkstyle happy again", "committedDate": "2020-05-23T09:49:27Z", "type": "commit"}, {"oid": "38487c5bba0d2376312f663c47bbea906c32779e", "url": "https://github.com/VelocityPowered/Velocity/commit/38487c5bba0d2376312f663c47bbea906c32779e", "message": "Server-change mechanics update", "committedDate": "2020-05-23T11:03:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzNjM1Nw==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429536357", "bodyText": "Note to self: Update the comments here", "author": "Xernium", "createdAt": "2020-05-23T11:04:47Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ClientPlaySessionHandler.java", "diffHunk": "@@ -334,12 +334,15 @@ public void handleBackendJoinGame(JoinGame joinGame, VelocityServerConnection de\n       // to perform entity ID rewrites, eliminating potential issues from rewriting packets and\n       // improving compatibility with mods.\n       player.getMinecraftConnection().delayedWrite(joinGame);", "originalCommit": "38487c5bba0d2376312f663c47bbea906c32779e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0Mjg0Mg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429542842", "bodyText": "Imo a mark + reset is cleaner than storing the offset. https://netty.io/4.0/api/io/netty/buffer/ByteBuf.html#markReaderIndex--", "author": "hugmanrique", "createdAt": "2020-05-23T12:41:49Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +162,80 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      throw new DecoderException(\"Invalid NBT start-type (end/empty)\");\n+    }\n+    buf.readerIndex(indexBefore);", "originalCommit": "38487c5bba0d2376312f663c47bbea906c32779e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0NDk4MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429544980", "bodyText": "mark/reset is gone in the next major release of Netty: netty/netty#8535", "author": "astei", "createdAt": "2020-05-23T13:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0Mjg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MzA1Ng==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429543056", "bodyText": "Replace constant by TagType.COMPOUND.id() (https://github.com/KyoriPowered/nbt/blob/0ec540ee377d902d5d96fa8d2aca3d3f2b35abe4/src/main/java/net/kyori/nbt/TagType.java#L78 )", "author": "hugmanrique", "createdAt": "2020-05-23T12:44:37Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +162,80 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      throw new DecoderException(\"Invalid NBT start-type (end/empty)\");\n+    }\n+    buf.readerIndex(indexBefore);\n+    try {\n+      DataInput input = new ByteBufInputStream(buf);\n+      byte type = input.readByte();\n+      if (type != 10) {", "originalCommit": "38487c5bba0d2376312f663c47bbea906c32779e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MzI0MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429543241", "bodyText": "See above", "author": "hugmanrique", "createdAt": "2020-05-23T12:47:09Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +162,80 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      throw new DecoderException(\"Invalid NBT start-type (end/empty)\");\n+    }\n+    buf.readerIndex(indexBefore);\n+    try {\n+      DataInput input = new ByteBufInputStream(buf);\n+      byte type = input.readByte();\n+      if (type != 10) {\n+        throw new DecoderException(\"NBTTag is not a CompoundTag\");\n+      }\n+      input.readUTF(); // Head-padding\n+      CompoundTag compoundTag = new CompoundTag();\n+      compoundTag.read(input, 0);\n+      return compoundTag;\n+    } catch (IOException e) {\n+      throw new DecoderException(\"Unable to decode NBT CompoundTag at \" + indexBefore);\n+    }\n+  }\n+\n+  /**\n+   * Writes a CompoundTag to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param compoundTag the CompoundTag to write\n+   */\n+  public static void writeCompoundTag(ByteBuf buf, CompoundTag compoundTag) {\n+    if (compoundTag == null) {\n+      buf.writeByte(0);\n+      return;\n+    }\n+    try {\n+      DataOutput output = new ByteBufOutputStream(buf);\n+      output.writeByte(10); // Type 10 - CompoundTag", "originalCommit": "38487c5bba0d2376312f663c47bbea906c32779e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU0MzU0OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r429543549", "bodyText": "Minor nit: inconsistent use of this. Either use it for setting all fields, or use it for none.", "author": "hugmanrique", "createdAt": "2020-05-23T12:51:35Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Respawn.java", "diffHunk": "@@ -74,33 +114,57 @@ public String toString() {\n         + \", difficulty=\" + difficulty\n         + \", gamemode=\" + gamemode\n         + \", levelType='\" + levelType + '\\''\n+        + \", shouldKeepPlayerData=\" + shouldKeepPlayerData\n+        + \", isDebug=\" + isDebug\n+        + \", isFlat='\" + isFlat\n+        + \", dimensionRegistryName='\" + dimensionRegistryName + '\\''\n         + '}';\n   }\n \n   @Override\n   public void decode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersion version) {\n-    this.dimension = buf.readInt();\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+      this.dimensionRegistryName = ProtocolUtils.readString(buf); // Not sure what the cap on that is\n+    } else {\n+      this.dimension = buf.readInt();\n+    }\n     if (version.compareTo(ProtocolVersion.MINECRAFT_1_13_2) <= 0) {\n       this.difficulty = buf.readUnsignedByte();\n     }\n     if (version.compareTo(ProtocolVersion.MINECRAFT_1_15) >= 0) {\n       this.partialHashedSeed = buf.readLong();\n     }\n     this.gamemode = buf.readUnsignedByte();\n-    this.levelType = ProtocolUtils.readString(buf, 16);\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) >= 0) {\n+      isDebug = buf.readBoolean();\n+      isFlat = buf.readBoolean();\n+      shouldKeepPlayerData = buf.readBoolean();", "originalCommit": "38487c5bba0d2376312f663c47bbea906c32779e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18e595397660ea6651bb4c86e1bb3a6addf1dd24", "url": "https://github.com/VelocityPowered/Velocity/commit/18e595397660ea6651bb4c86e1bb3a6addf1dd24", "message": "Save progress", "committedDate": "2020-06-04T13:36:58Z", "type": "commit"}, {"oid": "6734ef3a087ed3f068ee9ce809d93ce31ce844bc", "url": "https://github.com/VelocityPowered/Velocity/commit/6734ef3a087ed3f068ee9ce809d93ce31ce844bc", "message": "Checkstyle-auto", "committedDate": "2020-06-04T17:13:10Z", "type": "commit"}, {"oid": "009f207883738e3ee1b1fb51adf614fec89b8a4c", "url": "https://github.com/VelocityPowered/Velocity/commit/009f207883738e3ee1b1fb51adf614fec89b8a4c", "message": "More progress", "committedDate": "2020-06-04T19:21:54Z", "type": "commit"}, {"oid": "368d50b4555a87f0fb5ca734947f098e86ccac96", "url": "https://github.com/VelocityPowered/Velocity/commit/368d50b4555a87f0fb5ca734947f098e86ccac96", "message": "Rework Dimension Registry", "committedDate": "2020-06-05T13:22:55Z", "type": "commit"}, {"oid": "aa4a8de2fd474325927be5e221534a4f98a7a046", "url": "https://github.com/VelocityPowered/Velocity/commit/aa4a8de2fd474325927be5e221534a4f98a7a046", "message": "Stylize", "committedDate": "2020-06-05T13:45:11Z", "type": "commit"}, {"oid": "6368b47e78a499b7c1cfada8f1d0913a1ca59c8c", "url": "https://github.com/VelocityPowered/Velocity/commit/6368b47e78a499b7c1cfada8f1d0913a1ca59c8c", "message": "Old sins", "committedDate": "2020-06-05T13:58:34Z", "type": "commit"}, {"oid": "0377a6829f7b280aa35bb78219cfb86b0321ab64", "url": "https://github.com/VelocityPowered/Velocity/commit/0377a6829f7b280aa35bb78219cfb86b0321ab64", "message": "Move to Registry", "committedDate": "2020-06-05T14:00:51Z", "type": "commit"}, {"oid": "a2134297350b943c70daeb3572e5ff56043ea80c", "url": "https://github.com/VelocityPowered/Velocity/commit/a2134297350b943c70daeb3572e5ff56043ea80c", "message": "Merge from indev: 1.16-pre2\n\nFrom indev: 1.16-pre2", "committedDate": "2020-06-05T14:02:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTQzOQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436201439", "bodyText": "@MonotonicNonNull may be a better choice here.", "author": "astei", "createdAt": "2020-06-05T23:08:51Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java", "diffHunk": "@@ -53,6 +53,7 @@\n   private BackendConnectionPhase connectionPhase = BackendConnectionPhases.UNKNOWN;\n   private long lastPingId;\n   private long lastPingSent;\n+  private @Nullable DimensionRegistry activeDimensionRegistry;", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTYzOA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436201638", "bodyText": "Do not use javax.annotation.*. Since we follow Checker Framework, just drop the annotation (all fields are presumed to be non-null).", "author": "astei", "createdAt": "2020-06-05T23:09:52Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import java.util.HashSet;\n+import java.util.NoSuchElementException;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+\n+public class DimensionRegistry {\n+\n+  private final @Nonnull Set<DimensionData> dimensionRegistry;", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzOTI0OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436239248", "bodyText": "As discussed on the discord, will do", "author": "Xernium", "createdAt": "2020-06-06T05:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTkwNw==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436201907", "bodyText": "This class is called DimensionRegistry and yet we have a field called dimensionRegistry. This is confusing. Can we give this a better name?", "author": "astei", "createdAt": "2020-06-05T23:11:12Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import java.util.HashSet;\n+import java.util.NoSuchElementException;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+\n+public class DimensionRegistry {\n+\n+  private final @Nonnull Set<DimensionData> dimensionRegistry;\n+  private final @Nonnull String[] levelNames;\n+\n+  /**\n+   * Initializes a new {@link DimensionRegistry} instance.\n+   * This registry is required for 1.16+ clients/servers to communicate,\n+   * it constrains the dimension types and names the client can be sent\n+   * in a Respawn action (dimension change).\n+   * @param dimensionRegistry a populated set containing dimension data types\n+   * @param levelNames a populated {@link Set} of the dimension level names the server offers\n+   */\n+  public DimensionRegistry(Set<DimensionData> dimensionRegistry,\n+                           String[] levelNames) {\n+    if (dimensionRegistry == null || dimensionRegistry.isEmpty()\n+            || levelNames == null || levelNames.length == 0) {\n+      throw new IllegalArgumentException(\n+              \"Dimension registry requires valid arguments, not null and not empty\");\n+    }\n+    this.dimensionRegistry = dimensionRegistry;\n+    this.levelNames = levelNames;\n+  }\n+\n+  public @Nonnull Set<DimensionData> getDimensionRegistry() {", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzOTIyOQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436239229", "bodyText": "Agreed, will clear this up.", "author": "Xernium", "createdAt": "2020-06-06T05:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMjExNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436202116", "bodyText": "This won't hold up merging this in, but perhaps we can consider using a map of dimension IDs to dimension data (try Guava Maps.uniqueIndex).", "author": "astei", "createdAt": "2020-06-05T23:12:22Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import java.util.HashSet;\n+import java.util.NoSuchElementException;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+\n+public class DimensionRegistry {\n+\n+  private final @Nonnull Set<DimensionData> dimensionRegistry;\n+  private final @Nonnull String[] levelNames;\n+\n+  /**\n+   * Initializes a new {@link DimensionRegistry} instance.\n+   * This registry is required for 1.16+ clients/servers to communicate,\n+   * it constrains the dimension types and names the client can be sent\n+   * in a Respawn action (dimension change).\n+   * @param dimensionRegistry a populated set containing dimension data types\n+   * @param levelNames a populated {@link Set} of the dimension level names the server offers\n+   */\n+  public DimensionRegistry(Set<DimensionData> dimensionRegistry,\n+                           String[] levelNames) {\n+    if (dimensionRegistry == null || dimensionRegistry.isEmpty()\n+            || levelNames == null || levelNames.length == 0) {\n+      throw new IllegalArgumentException(\n+              \"Dimension registry requires valid arguments, not null and not empty\");\n+    }\n+    this.dimensionRegistry = dimensionRegistry;\n+    this.levelNames = levelNames;\n+  }\n+\n+  public @Nonnull Set<DimensionData> getDimensionRegistry() {\n+    return dimensionRegistry;\n+  }\n+\n+  public @Nonnull String[] getLevelNames() {\n+    return levelNames;\n+  }\n+\n+  /**\n+   * Returns the internal dimension data type as used by the game.\n+   * @param dimensionIdentifier how the dimension is identified by the connection\n+   * @return game dimension data\n+   */\n+  public @Nonnull DimensionData getDimensionData(@Nonnull String dimensionIdentifier) {\n+    if (dimensionIdentifier == null) {\n+      throw new IllegalArgumentException(\"Dimension identifier cannot be null!\");\n+    }\n+    for (DimensionData iter : dimensionRegistry) {", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzOTEzNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436239136", "bodyText": "I had that but I dropped it because I felt like it\u2019s a waste of space seeing as the DimensionData object already needs to store that", "author": "Xernium", "createdAt": "2020-06-06T05:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMjExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMjg5OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436202898", "bodyText": "Do not use exceptions as a control-flow mechanism", "author": "astei", "createdAt": "2020-06-05T23:15:58Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import java.util.HashSet;\n+import java.util.NoSuchElementException;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+\n+public class DimensionRegistry {\n+\n+  private final @Nonnull Set<DimensionData> dimensionRegistry;\n+  private final @Nonnull String[] levelNames;\n+\n+  /**\n+   * Initializes a new {@link DimensionRegistry} instance.\n+   * This registry is required for 1.16+ clients/servers to communicate,\n+   * it constrains the dimension types and names the client can be sent\n+   * in a Respawn action (dimension change).\n+   * @param dimensionRegistry a populated set containing dimension data types\n+   * @param levelNames a populated {@link Set} of the dimension level names the server offers\n+   */\n+  public DimensionRegistry(Set<DimensionData> dimensionRegistry,\n+                           String[] levelNames) {\n+    if (dimensionRegistry == null || dimensionRegistry.isEmpty()\n+            || levelNames == null || levelNames.length == 0) {\n+      throw new IllegalArgumentException(\n+              \"Dimension registry requires valid arguments, not null and not empty\");\n+    }\n+    this.dimensionRegistry = dimensionRegistry;\n+    this.levelNames = levelNames;\n+  }\n+\n+  public @Nonnull Set<DimensionData> getDimensionRegistry() {\n+    return dimensionRegistry;\n+  }\n+\n+  public @Nonnull String[] getLevelNames() {\n+    return levelNames;\n+  }\n+\n+  /**\n+   * Returns the internal dimension data type as used by the game.\n+   * @param dimensionIdentifier how the dimension is identified by the connection\n+   * @return game dimension data\n+   */\n+  public @Nonnull DimensionData getDimensionData(@Nonnull String dimensionIdentifier) {\n+    if (dimensionIdentifier == null) {\n+      throw new IllegalArgumentException(\"Dimension identifier cannot be null!\");\n+    }\n+    for (DimensionData iter : dimensionRegistry) {\n+      if (iter.getRegistryIdentifier().equals(dimensionIdentifier)) {\n+        return iter;\n+      }\n+    }\n+    throw new NoSuchElementException(\"Dimension with identifier \" + dimensionIdentifier\n+            + \" doesn't exist in this Registry!\");\n+  }\n+\n+  /**\n+   * Checks a {@link DimensionInfo} against this registry.\n+   * @param toValidate the {@link DimensionInfo} to validate\n+   * @return true: the dimension information is valid for this registry\n+   */\n+  public boolean isValidFor(@Nonnull DimensionInfo toValidate) {\n+    if (toValidate == null) {\n+      throw new IllegalArgumentException(\"Dimension info cannot be null\");\n+    }\n+    try {\n+      getDimensionData(toValidate.getRegistryIdentifier());\n+      for (int i = 0; i < levelNames.length; i++) {\n+        if (levelNames[i].equals(toValidate.getRegistryIdentifier())) {\n+          return true;\n+        }\n+      }\n+      return false;\n+    } catch (NoSuchElementException thrown) {", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMzAxMg==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436203012", "bodyText": "Can we make this class immutable if possible?", "author": "astei", "createdAt": "2020-06-05T23:16:27Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import java.util.HashSet;\n+import java.util.NoSuchElementException;\n+import java.util.Set;\n+import javax.annotation.Nonnull;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+\n+public class DimensionRegistry {", "originalCommit": "a2134297350b943c70daeb3572e5ff56043ea80c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIzOTAwNQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436239005", "bodyText": "Fair, all of the three classes should be. Will do.", "author": "Xernium", "createdAt": "2020-06-06T05:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMzAxMg=="}], "type": "inlineReview"}, {"oid": "f868cea5830fac6fec03fa360fd6650d65de0e20", "url": "https://github.com/VelocityPowered/Velocity/commit/f868cea5830fac6fec03fa360fd6650d65de0e20", "message": "Move to proper API", "committedDate": "2020-06-06T22:14:23Z", "type": "commit"}, {"oid": "ef5b9cf183da0eda038374f01dc342bbea5d2d40", "url": "https://github.com/VelocityPowered/Velocity/commit/ef5b9cf183da0eda038374f01dc342bbea5d2d40", "message": "Sync to IDE", "committedDate": "2020-06-06T22:22:11Z", "type": "commit"}, {"oid": "3ed5e7718c918bbdded6c9654dc656110966244b", "url": "https://github.com/VelocityPowered/Velocity/commit/3ed5e7718c918bbdded6c9654dc656110966244b", "message": "Fix logic error", "committedDate": "2020-06-06T22:33:06Z", "type": "commit"}, {"oid": "c004e5769d50092a9d4c549bc9a1857f37f9bc86", "url": "https://github.com/VelocityPowered/Velocity/commit/c004e5769d50092a9d4c549bc9a1857f37f9bc86", "message": "Merge Cleanup from indev\n\nCleanup", "committedDate": "2020-06-06T22:36:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjE0NQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436306145", "bodyText": "Can be replaced with registeredDimensions.get(dimensionIdentifier)", "author": "astei", "createdAt": "2020-06-06T22:38:56Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionRegistry.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import com.google.common.base.Preconditions;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Maps;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+import net.kyori.nbt.CompoundTag;\n+import net.kyori.nbt.ListTag;\n+import net.kyori.nbt.Tag;\n+import net.kyori.nbt.TagType;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+\n+public final class DimensionRegistry {\n+\n+  private final Map<String, DimensionData> registeredDimensions;\n+  private final ImmutableSet<String> levelNames;\n+\n+  /**\n+   * Initializes a new {@link DimensionRegistry} instance.\n+   * This registry is required for 1.16+ clients/servers to communicate,\n+   * it constrains the dimension types and names the client can be sent\n+   * in a Respawn action (dimension change).\n+   * This WILL raise an IllegalArgumentException if the following is not met:\n+   * - At least one valid DimensionData instance is provided\n+   * - At least one valid world name is provided\n+   * @param registeredDimensions a populated {@link ImmutableSet} containing dimension data types\n+   * @param levelNames a populated {@link ImmutableSet} of the level (world) names the server offers\n+   */\n+  public DimensionRegistry(ImmutableSet<DimensionData> registeredDimensions,\n+                            ImmutableSet<String> levelNames) {\n+    Preconditions.checkNotNull(registeredDimensions,\n+            \"registeredDimensions cannot be null\");\n+    Preconditions.checkNotNull(levelNames,\n+            \"levelNames cannot be null\");\n+    Preconditions.checkArgument(registeredDimensions.size() > 0,\n+            \"registeredDimensions needs to be populated\");\n+    Preconditions.checkArgument(levelNames.size() > 0,\n+            \"levelNames needs to populated\");\n+    this.registeredDimensions = Maps.uniqueIndex(\n+            registeredDimensions, DimensionData::getRegistryIdentifier);\n+    this.levelNames = levelNames;\n+  }\n+\n+  public Map<String, DimensionData> getRegisteredDimensions() {\n+    return registeredDimensions;\n+  }\n+\n+  public Set<String> getLevelNames() {\n+    return levelNames;\n+  }\n+\n+  /**\n+   * Returns the internal dimension data type as used by the game.\n+   * @param dimensionIdentifier how the dimension is identified by the connection\n+   * @return game dimension data or null if not registered\n+   */\n+  public @Nullable DimensionData getDimensionData(String dimensionIdentifier) {\n+    return registeredDimensions.getOrDefault(dimensionIdentifier, null);", "originalCommit": "c004e5769d50092a9d4c549bc9a1857f37f9bc86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjUwNQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436306505", "bodyText": "Ah I just read up that it returns null in java for a map key that does not have a value and does NOT throw an exception instead, my bad, will fix.", "author": "Xernium", "createdAt": "2020-06-06T22:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjE3OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436306178", "bodyText": "It's not a good practice to pass Optional as a parameter. Mark these as @Nullable and handle the null situation gracefully.", "author": "astei", "createdAt": "2020-06-06T22:39:41Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/registry/DimensionData.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package com.velocitypowered.proxy.connection.registry;\n+\n+import com.google.common.base.Optional;\n+import com.google.common.base.Preconditions;\n+import net.kyori.nbt.CompoundTag;\n+\n+public final class DimensionData {\n+  private final String registryIdentifier;\n+  private final boolean isNatural;\n+  private final float ambientLight;\n+  private final boolean isShrunk;\n+  private final boolean isUltrawarm;\n+  private final boolean hasCeiling;\n+  private final boolean hasSkylight;\n+  private final Optional<Long> fixedTime;\n+  private final Optional<Boolean> hasEnderdragonFight;\n+\n+  /**\n+   * Initializes a new {@link DimensionData} instance.\n+   * @param registryIdentifier the identifier for the dimension from the registry.\n+   * @param isNatural indicates if the dimension use natural world generation (e.g. overworld)\n+   * @param ambientLight the light level the client sees without external lighting\n+   * @param isShrunk indicates if the world is shrunk, aka not the full 256 blocks (e.g. nether)\n+   * @param isUltrawarm internal dimension warmth flag\n+   * @param hasCeiling indicates if the dimension has a ceiling layer\n+   * @param hasSkylight indicates if the dimension should display the sun\n+   * @param fixedTime optional. If set to any game daytime value will deactivate time cycle\n+   * @param hasEnderdragonFight optional. Internal flag used in the end dimension\n+   */\n+  public DimensionData(String registryIdentifier, boolean isNatural,\n+                       float ambientLight, boolean isShrunk, boolean isUltrawarm,\n+                       boolean hasCeiling, boolean hasSkylight,\n+                       Optional<Long> fixedTime, Optional<Boolean> hasEnderdragonFight) {", "originalCommit": "c004e5769d50092a9d4c549bc9a1857f37f9bc86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjQxMw==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436306413", "bodyText": "Will revert that- Was an idea anyway", "author": "Xernium", "createdAt": "2020-06-06T22:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjE3OA=="}], "type": "inlineReview"}, {"oid": "4e5f708bede9c73a74c6eee8bbbaa6bdfc38490e", "url": "https://github.com/VelocityPowered/Velocity/commit/4e5f708bede9c73a74c6eee8bbbaa6bdfc38490e", "message": "Resolve review", "committedDate": "2020-06-06T22:51:21Z", "type": "commit"}, {"oid": "4e6144a87cfad1fe46c1360f321000e51a6a2fa7", "url": "https://github.com/VelocityPowered/Velocity/commit/4e6144a87cfad1fe46c1360f321000e51a6a2fa7", "message": "Merge from indev/future/1.16\n\nResolve review", "committedDate": "2020-06-06T22:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwODQxOA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436308418", "bodyText": "Try using https://github.com/KyoriPowered/nbt/blob/master/src/main/java/net/kyori/nbt/TagIO.java#L62 instead", "author": "astei", "createdAt": "2020-06-06T23:26:19Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +163,110 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      throw new DecoderException(\"Invalid NBT start-type (end/empty)\");\n+    }\n+    buf.readerIndex(indexBefore);\n+    try {\n+      DataInput input = new ByteBufInputStream(buf);", "originalCommit": "4e6144a87cfad1fe46c1360f321000e51a6a2fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwODQyNw==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r436308427", "bodyText": "Could https://github.com/KyoriPowered/nbt/blob/master/src/main/java/net/kyori/nbt/TagIO.java#L165 work here instead?", "author": "astei", "createdAt": "2020-06-06T23:26:50Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/ProtocolUtils.java", "diffHunk": "@@ -153,6 +163,110 @@ public static void writeUuid(ByteBuf buf, UUID uuid) {\n     buf.writeLong(uuid.getLeastSignificantBits());\n   }\n \n+  /**\n+   * Reads an UUID stored as an Integer Array from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return the UUID from the buffer\n+   */\n+  public static UUID readUuidIntArray(ByteBuf buf) {\n+    long msbHigh = (long) buf.readInt() << 32;\n+    long msbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long msb = msbHigh | msbLow;\n+    long lsbHigh = (long) buf.readInt() << 32;\n+    long lsbLow = (long) buf.readInt() & 0xFFFFFFFFL;\n+    long lsb = lsbHigh | lsbLow;\n+    return new UUID(msb, lsb);\n+  }\n+\n+  /**\n+   * Writes an UUID as an Integer Array to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param uuid the UUID to write\n+   */\n+  public static void writeUuidIntArray(ByteBuf buf, UUID uuid) {\n+    buf.writeInt((int) (uuid.getMostSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getMostSignificantBits());\n+    buf.writeInt((int) (uuid.getLeastSignificantBits() >> 32));\n+    buf.writeInt((int) uuid.getLeastSignificantBits());\n+  }\n+\n+  /**\n+   * Reads a {@link net.kyori.nbt.CompoundTag} from the {@code buf}.\n+   * @param buf the buffer to read from\n+   * @return {@link net.kyori.nbt.CompoundTag} the CompoundTag from the buffer\n+   */\n+  public static CompoundTag readCompoundTag(ByteBuf buf) {\n+    int indexBefore = buf.readerIndex();\n+    byte startType = buf.readByte();\n+    if (startType == 0) {\n+      throw new DecoderException(\"Invalid NBT start-type (end/empty)\");\n+    }\n+    buf.readerIndex(indexBefore);\n+    try {\n+      DataInput input = new ByteBufInputStream(buf);\n+      byte type = input.readByte();\n+      if (type != TagType.COMPOUND.id()) {\n+        throw new DecoderException(\"NBTTag is not a CompoundTag\");\n+      }\n+      input.readUTF(); // Head-padding\n+      CompoundTag compoundTag = new CompoundTag();\n+      compoundTag.read(input, 0);\n+      return compoundTag;\n+    } catch (IOException e) {\n+      throw new DecoderException(\"Unable to decode NBT CompoundTag at \" + indexBefore);\n+    }\n+  }\n+\n+  /**\n+   * Writes a CompoundTag to the {@code buf}.\n+   * @param buf the buffer to write to\n+   * @param compoundTag the CompoundTag to write\n+   */\n+  public static void writeCompoundTag(ByteBuf buf, CompoundTag compoundTag) {\n+    if (compoundTag == null) {\n+      buf.writeByte(0);\n+      return;\n+    }\n+    try {\n+      DataOutput output = new ByteBufOutputStream(buf);", "originalCommit": "4e6144a87cfad1fe46c1360f321000e51a6a2fa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "101a6a58dd7a1c2af13edd897eade28ac92599ba", "url": "https://github.com/VelocityPowered/Velocity/commit/101a6a58dd7a1c2af13edd897eade28ac92599ba", "message": "Changes 1.16-pre3", "committedDate": "2020-06-10T19:00:18Z", "type": "commit"}, {"oid": "8d159408ba5af80892fedb0b717e0cc37fa88f3a", "url": "https://github.com/VelocityPowered/Velocity/commit/8d159408ba5af80892fedb0b717e0cc37fa88f3a", "message": "Merge Changes 1.16-pre3\n\nChanges 1.16-pre3", "committedDate": "2020-06-10T19:01:16Z", "type": "commit"}, {"oid": "78b442a852a14633ea16fa09f3f27b28fd44ea3f", "url": "https://github.com/VelocityPowered/Velocity/commit/78b442a852a14633ea16fa09f3f27b28fd44ea3f", "message": "Changes 1.16-pre4 and Logic fixes", "committedDate": "2020-06-11T21:39:16Z", "type": "commit"}, {"oid": "78b442a852a14633ea16fa09f3f27b28fd44ea3f", "url": "https://github.com/VelocityPowered/Velocity/commit/78b442a852a14633ea16fa09f3f27b28fd44ea3f", "message": "Changes 1.16-pre4 and Logic fixes", "committedDate": "2020-06-11T21:39:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExOTcxMA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r439119710", "bodyText": "I should probably add a dummy constructor here that has message and type", "author": "Xernium", "createdAt": "2020-06-11T23:12:22Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Chat.java", "diffHunk": "@@ -10,20 +10,25 @@\n import net.kyori.text.serializer.gson.GsonComponentSerializer;\n import org.checkerframework.checker.nullness.qual.Nullable;\n \n+import java.util.UUID;\n+\n public class Chat implements MinecraftPacket {\n \n   public static final byte CHAT_TYPE = (byte) 0;\n   public static final int MAX_SERVERBOUND_MESSAGE_LENGTH = 256;\n+  public static final UUID EMPTY_SENDER = new UUID(0, 0);\n \n   private @Nullable String message;\n   private byte type;\n+  private @Nullable UUID sender;\n \n   public Chat() {\n   }\n \n-  public Chat(String message, byte type) {\n+  public Chat(String message, byte type, UUID sender) {", "originalCommit": "78b442a852a14633ea16fa09f3f27b28fd44ea3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMDc1MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r439120751", "bodyText": "The packet API is internal details. You can create a constructor for compatibility if you want, but it won't prevent me from merging this in.", "author": "astei", "createdAt": "2020-06-11T23:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExOTcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMDA4Ng==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r439120086", "bodyText": "I need to revamp this too.", "author": "Xernium", "createdAt": "2020-06-11T23:13:33Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/JoinGame.java", "diffHunk": "@@ -122,21 +153,36 @@ public void decode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersi\n       this.partialHashedSeed = buf.readLong();\n     }\n     this.maxPlayers = buf.readUnsignedByte();\n-    this.levelType = ProtocolUtils.readString(buf, 16);\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_16) < 0) {\n+      this.levelType = ProtocolUtils.readString(buf, 16);", "originalCommit": "78b442a852a14633ea16fa09f3f27b28fd44ea3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMDM2Ng==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r439120366", "bodyText": "Should I also make a dummy constructor here @astei ?", "author": "Xernium", "createdAt": "2020-06-11T23:14:38Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/Respawn.java", "diffHunk": "@@ -13,17 +14,21 @@\n   private short difficulty;\n   private short gamemode;\n   private String levelType = \"\";\n+  private boolean shouldKeepPlayerData; // 1.16+\n+  private DimensionInfo dimensionInfo;\n \n   public Respawn() {\n   }\n \n   public Respawn(int dimension, long partialHashedSeed, short difficulty, short gamemode,\n-      String levelType) {", "originalCommit": "78b442a852a14633ea16fa09f3f27b28fd44ea3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMDc4MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/310#discussion_r439120780", "bodyText": "The packet API is internal details. You can create a constructor for compatibility if you want, but it won't prevent me from merging this in.", "author": "astei", "createdAt": "2020-06-11T23:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMDM2Ng=="}], "type": "inlineReview"}, {"oid": "6577b08bdd6c6286681b3c784bf8664681b4697a", "url": "https://github.com/VelocityPowered/Velocity/commit/6577b08bdd6c6286681b3c784bf8664681b4697a", "message": "Changes 1.16-pre5", "committedDate": "2020-06-13T09:26:51Z", "type": "commit"}, {"oid": "a1ab29186b26145c88f07552f6a1ad81bdd2cc22", "url": "https://github.com/VelocityPowered/Velocity/commit/a1ab29186b26145c88f07552f6a1ad81bdd2cc22", "message": "Changes 1.16-pre6", "committedDate": "2020-06-16T15:56:56Z", "type": "commit"}, {"oid": "ee64b97b8ee1b217686687f3c4c6326cf0ff9c14", "url": "https://github.com/VelocityPowered/Velocity/commit/ee64b97b8ee1b217686687f3c4c6326cf0ff9c14", "message": "Changes 1.16-pre7", "committedDate": "2020-06-16T16:39:51Z", "type": "commit"}, {"oid": "83ba7d6051ad8efcbc3ce56ebc0fc2caec2efdff", "url": "https://github.com/VelocityPowered/Velocity/commit/83ba7d6051ad8efcbc3ce56ebc0fc2caec2efdff", "message": "Changes 1.16-rc1", "committedDate": "2020-06-18T16:24:39Z", "type": "commit"}]}