{"pr_number": 4215, "pr_title": "[GEOS-9196] decode special characters with relative paths", "pr_createdAt": "2020-04-28T12:29:36Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4215", "timeline": [{"oid": "bf5a72ecac75f906bb6b8dc703eb98da3df81695", "url": "https://github.com/geoserver/geoserver/commit/bf5a72ecac75f906bb6b8dc703eb98da3df81695", "message": "GEOS-9196 decode special characters with relative paths", "committedDate": "2020-04-28T21:31:13Z", "type": "forcePushed"}, {"oid": "cc8ae457e474580ca22cfeff25c421413fb91776", "url": "https://github.com/geoserver/geoserver/commit/cc8ae457e474580ca22cfeff25c421413fb91776", "message": "GEOS-9196 decode special characters with relative paths", "committedDate": "2020-04-28T22:10:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODEyMw==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r417588123", "bodyText": "I always get frustrated with special characters.\n@NielsCharlier can you add a test for the unicode precomposed characters which are known to cause problems on macOS.\n\nFor example, the character \"\u00fc\" can be encoded as the single code point U+00FC \"\u00fc\" or as the base character U+0075 \"u\" followed by the non-spacing character U+0308 \"\u00a8\"", "author": "jodygarnett", "createdAt": "2020-04-29T20:22:49Z", "path": "src/platform/src/test/java/org/geoserver/platform/GeoServerResourceLoaderTest.java", "diffHunk": "@@ -162,4 +166,22 @@ public void testSetBaseDirectory() throws IOException {\n         assertEquals(tempDir, loader.getBaseDirectory());\n         assertEquals(mockStore, loader.getResourceStore());\n     }\n+\n+    @Test\n+    public void fromRelativeURLTest() throws IOException {\n+        GeoServerResourceLoader loader = new GeoServerResourceLoader();\n+        tempFolder.create();\n+        File tempDir = tempFolder.getRoot();\n+        loader.setBaseDirectory(tempDir);\n+\n+        Resource res = loader.fromURL(\"file:relative/with/special+characters%23\");\n+        assertEquals(\"relative/with/special characters#\", res.path());", "originalCommit": "cc8ae457e474580ca22cfeff25c421413fb91776", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2NjY2Nw==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r418466667", "bodyText": "DOne.", "author": "NielsCharlier", "createdAt": "2020-05-01T08:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxODY2NQ==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r426918665", "bodyText": "Thanks, now to check if the macOS build passes :)", "author": "jodygarnett", "createdAt": "2020-05-18T22:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODU5MQ==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r417588591", "bodyText": "Why is this exception being eaten? nom nom nom ...", "author": "jodygarnett", "createdAt": "2020-04-29T20:23:44Z", "path": "src/platform/src/main/java/org/geoserver/platform/resource/Resources.java", "diffHunk": "@@ -593,6 +595,12 @@ public static Resource fromURL(Resource baseDirectory, String url) {\n         if (url.startsWith(\"file:\")) {\n             url = url.substring(5); // remove 'file:' prefix\n \n+            // revert encoded special characters and spaces\n+            try {\n+                url = URLDecoder.decode(url, \"UTF-8\");\n+            } catch (UnsupportedEncodingException e) {", "originalCommit": "cc8ae457e474580ca22cfeff25c421413fb91776", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4OTM1MA==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r417589350", "bodyText": "Q: This is detecting for relative paths, but misses the absolute path thing above?\nQ: Does URLs.urlToFile need similar logic?", "author": "jodygarnett", "createdAt": "2020-04-29T20:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI5MTYyOA==", "url": "https://github.com/geoserver/geoserver/pull/4215#discussion_r418291628", "bodyText": "The exception is eaten, because it cannot occur.\nSee https://docs.oracle.com/javase/8/docs/api/java/nio/charset/Charset.html\n\"Every implementation of the Java platform is required to support the following standard charsets. \"\nAs explained on the jira ticket, absolute paths already support special characters, and only relative ones fail. This is exactly because URLS.urlTOFile already has the logic, and it is being called for absolute paths.", "author": "NielsCharlier", "createdAt": "2020-04-30T21:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4ODU5MQ=="}], "type": "inlineReview"}, {"oid": "956d749acb12734e25f61d8e9017a88268e90bf9", "url": "https://github.com/geoserver/geoserver/commit/956d749acb12734e25f61d8e9017a88268e90bf9", "message": "[GEOS-9196] decode special characters with relative paths", "committedDate": "2020-04-30T22:44:34Z", "type": "commit"}, {"oid": "956d749acb12734e25f61d8e9017a88268e90bf9", "url": "https://github.com/geoserver/geoserver/commit/956d749acb12734e25f61d8e9017a88268e90bf9", "message": "[GEOS-9196] decode special characters with relative paths", "committedDate": "2020-04-30T22:44:34Z", "type": "forcePushed"}]}