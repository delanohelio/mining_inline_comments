{"pr_number": 4055, "pr_title": "[GEOS-9501] WFS GeoJSON complex features output returns duplicated key names instead a JSON array", "pr_createdAt": "2020-02-13T20:24:28Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4055", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MDI2Nw==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379150267", "bodyText": "Multi-values is only support with JDBC right?", "author": "nmco", "createdAt": "2020-02-13T22:16:21Z", "path": "src/extension/app-schema/app-schema-test/src/test/java/org/geoserver/test/NormalizedMultiValuesTest.java", "diffHunk": "@@ -258,14 +270,44 @@ public void testGetAllNormalizedMultiValuesWfsJson20() throws Exception {\n                         + \"&outputFormat=application/json\";\n         JSONObject json = (JSONObject) getAsJSON(request);\n         JSONArray features = json.getJSONArray(\"features\");\n-        assertEquals(2, features.size());\n+        assertEquals(3, features.size());\n         // check stations json content\n         JSONObject station = getStationById(features, \"st.1\");\n         assertNotNull(station);\n         checkStationJson1(station);\n         station = getStationById(features, \"st.2\");\n         assertNotNull(station);\n         checkStationJson2(station);\n+        station = getStationById(features, \"st.3\");\n+        assertNotNull(station);\n+        checkStationJson3(station);\n+    }\n+\n+    @Test\n+    public void testGetAllNormalizedMultiValuesWfsJsonFormat20() throws Exception {\n+        // check if this is an online test with a JDBC based data store\n+        if (notJdbcBased()) {\n+            // not a JDBC online test\n+            return;\n+        }", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODI0MQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379168241", "bodyText": "Right.", "author": "fernandor777", "createdAt": "2020-02-13T23:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MDI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MTI5Ng==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379151296", "bodyText": "I see so you parse the JSON, since no repeated keys are allowed if the parsing passes it means that the repeat keys were encoded as arrays. But still I will add an explicit check validating that we an array with the expected entities inside it.", "author": "nmco", "createdAt": "2020-02-13T22:18:54Z", "path": "src/extension/app-schema/app-schema-test/src/test/java/org/geoserver/test/NormalizedMultiValuesTest.java", "diffHunk": "@@ -258,14 +270,44 @@ public void testGetAllNormalizedMultiValuesWfsJson20() throws Exception {\n                         + \"&outputFormat=application/json\";\n         JSONObject json = (JSONObject) getAsJSON(request);\n         JSONArray features = json.getJSONArray(\"features\");\n-        assertEquals(2, features.size());\n+        assertEquals(3, features.size());\n         // check stations json content\n         JSONObject station = getStationById(features, \"st.1\");\n         assertNotNull(station);\n         checkStationJson1(station);\n         station = getStationById(features, \"st.2\");\n         assertNotNull(station);\n         checkStationJson2(station);\n+        station = getStationById(features, \"st.3\");\n+        assertNotNull(station);\n+        checkStationJson3(station);\n+    }\n+\n+    @Test\n+    public void testGetAllNormalizedMultiValuesWfsJsonFormat20() throws Exception {\n+        // check if this is an online test with a JDBC based data store\n+        if (notJdbcBased()) {\n+            // not a JDBC online test\n+            return;\n+        }\n+        // execute the WFS 2.0 request\n+        String request =\n+                \"wfs?request=GetFeature&version=2.0&typename=st_gml32:Station_gml32\"\n+                        + \"&outputFormat=application/json\";\n+        MockHttpServletResponse response = getAsServletResponse(request);\n+\n+        String content = response.getContentAsString();\n+        validateJsonOutput(content);\n+    }\n+\n+    private void validateJsonOutput(String jsonString) {\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        objectMapper.enable(JsonParser.Feature.STRICT_DUPLICATE_DETECTION);\n+        try {\n+            objectMapper.readTree(jsonString);", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2MDAxOQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379160019", "bodyText": "I only checked repeated keys because complete data and structure check is already made on other json tests added on recent PR.", "author": "fernandor777", "createdAt": "2020-02-13T22:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MTI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MzUxMQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379153511", "bodyText": "@fernandor777 look at he rest of the code and try to apply the same patterns :black_flag, more precisely in this case it means:\n\nisolate this behavior in an helper method, this else shoudl be a single line\ndocument properly, the comment above doesn't seem to match what you are doing\nif possible avoid this psychedelic Java 8 streams usage, it has performance personalities and it's not clear at all", "author": "nmco", "createdAt": "2020-02-13T22:24:27Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -244,7 +246,24 @@ private void encodePropertiesByType(\n                 encodeLinkedFeatures(descriptor, linkedFeatures);\n             } else {\n                 // no chained or linked features just encode each property\n-                properties.forEach(this::encodeProperty);\n+                String attributeName = descriptor.getName().getLocalPart();", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MTg3Nw==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379171877", "bodyText": "refactored", "author": "fernandor777", "createdAt": "2020-02-13T23:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MzUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1MzY4Nw==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379153687", "bodyText": "Is this second else needed waht's going on here?", "author": "nmco", "createdAt": "2020-02-13T22:24:50Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -244,7 +246,24 @@ private void encodePropertiesByType(\n                 encodeLinkedFeatures(descriptor, linkedFeatures);\n             } else {\n                 // no chained or linked features just encode each property\n-                properties.forEach(this::encodeProperty);\n+                String attributeName = descriptor.getName().getLocalPart();\n+                if (properties.size() > 1\n+                        && properties\n+                                .stream()\n+                                .allMatch(\n+                                        prop ->\n+                                                Objects.equals(\n+                                                        attributeName,\n+                                                        prop.getName().getLocalPart()))) {\n+                    jsonWriter.key(attributeName).array();\n+                    properties.forEach(\n+                            prop ->\n+                                    encodeProperty(\n+                                            INSIDE_ARRAY_ATTRIBUTE, prop, getAttributes(prop)));\n+                    jsonWriter.endArray();\n+                } else {\n+                    properties.forEach(this::encodeProperty);\n+                }\n             }\n         } else {", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDAxMQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379154011", "bodyText": "What's this?", "author": "nmco", "createdAt": "2020-02-13T22:25:39Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -45,6 +46,7 @@\n \n     private static Class NON_FEATURE_TYPE_PROXY;\n     private static final String DATATYPE = \"@dataType\";\n+    private static final String INSIDE_ARRAY_ATTRIBUTE = \"${inside-array}\";", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODgxNg==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379168816", "bodyText": "Adding this as comment:\nA string constant for representing a not needed key name because object is\nbeing added inside an already named json array", "author": "fernandor777", "createdAt": "2020-02-13T23:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDQyMA==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379154420", "bodyText": "I would have used an if with brackets and put a proper explaining what it means the branch being passed.", "author": "nmco", "createdAt": "2020-02-13T22:26:29Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -274,8 +293,8 @@ private void encodeLinkedFeatures(\n     /** Encodes a list of features (chained features) as a JSON array. */\n     private void encodeChainedFeatures(String attributeName, List<Feature> chainedFeatures) {\n         // start the JSON object\n-        jsonWriter.key(attributeName);\n-        jsonWriter.array();\n+        key(attributeName);\n+        if (!isInsideArrayAttributeName(attributeName)) jsonWriter.array();", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NjY2Ng==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379176666", "bodyText": "Agreed, fixed", "author": "fernandor777", "createdAt": "2020-02-13T23:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDU3NQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379154575", "bodyText": "No idea what this is, could you add documentation?", "author": "nmco", "createdAt": "2020-02-13T22:26:48Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -288,7 +307,11 @@ private void encodeChainedFeatures(String attributeName, List<Feature> chainedFe\n             }\n         }\n         // end the JSON chained features array\n-        jsonWriter.endArray();\n+        if (!isInsideArrayAttributeName(attributeName)) jsonWriter.endArray();\n+    }\n+\n+    private boolean isInsideArrayAttributeName(String attributeName) {", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NjcxMQ==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379176711", "bodyText": "Added", "author": "fernandor777", "createdAt": "2020-02-13T23:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDc1MA==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379154750", "bodyText": "Thx!", "author": "nmco", "createdAt": "2020-02-13T22:27:14Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -374,17 +397,22 @@ static boolean checkIfFeatureIsLinked(Property property, Map<NameImpl, String> a\n \n     /**\n      * Encode a feature property, we only support complex attributes and simple attributes, if\n-     * another tye of attribute is used an exception will be throw.\n+     * another type of attribute is used an exception will be throw.", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDk1Mg==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379154952", "bodyText": "Please add Javadoc.", "author": "nmco", "createdAt": "2020-02-13T22:27:42Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -374,17 +397,22 @@ static boolean checkIfFeatureIsLinked(Property property, Map<NameImpl, String> a\n \n     /**\n      * Encode a feature property, we only support complex attributes and simple attributes, if\n-     * another tye of attribute is used an exception will be throw.\n+     * another type of attribute is used an exception will be throw.\n      */\n-    @SuppressWarnings(\"unchecked\")\n     private void encodeProperty(Property property) {\n         // these extra attributes should be seen as XML attributes\n-        Map<NameImpl, Object> attributes =\n-                (Map<NameImpl, Object>) property.getUserData().get(Attributes.class);\n+        Map<NameImpl, Object> attributes = getAttributes(property);\n         String attributeName = property.getName().getLocalPart();\n         encodeProperty(attributeName, property, attributes);\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    private Map<NameImpl, Object> getAttributes(Property property) {", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NzU1Nw==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379177557", "bodyText": "added", "author": "fernandor777", "createdAt": "2020-02-13T23:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NDk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTQzNA==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379155434", "bodyText": "Please add documentation, this pattern is already strange enough \ud83d\ude0b.", "author": "nmco", "createdAt": "2020-02-13T22:28:49Z", "path": "src/wfs/src/main/java/org/geoserver/wfs/json/ComplexGeoJsonWriter.java", "diffHunk": "@@ -618,6 +648,12 @@ private void encodeSimpleAttribute(\n         jsonWriter.endObject();\n     }\n \n+    private void key(String name) {", "originalCommit": "bdf2b089ee22f338633f9fe1d926622f20465f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODU5OA==", "url": "https://github.com/geoserver/geoserver/pull/4055#discussion_r379178598", "bodyText": "added", "author": "fernandor777", "createdAt": "2020-02-13T23:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NTQzNA=="}], "type": "inlineReview"}, {"oid": "e899f8a896374e955bb479eae5564cce59452864", "url": "https://github.com/geoserver/geoserver/commit/e899f8a896374e955bb479eae5564cce59452864", "message": "[GEOS-9501] WFS GeoJSON complex features output returns duplicated key names instead a JSON array", "committedDate": "2020-02-13T23:46:00Z", "type": "forcePushed"}, {"oid": "a880da98a8dfcb5a61f796217a7c0926435b676b", "url": "https://github.com/geoserver/geoserver/commit/a880da98a8dfcb5a61f796217a7c0926435b676b", "message": "[GEOS-9501] WFS GeoJSON complex features output returns duplicated key names instead a JSON array", "committedDate": "2020-02-13T23:47:12Z", "type": "commit"}, {"oid": "a880da98a8dfcb5a61f796217a7c0926435b676b", "url": "https://github.com/geoserver/geoserver/commit/a880da98a8dfcb5a61f796217a7c0926435b676b", "message": "[GEOS-9501] WFS GeoJSON complex features output returns duplicated key names instead a JSON array", "committedDate": "2020-02-13T23:47:12Z", "type": "forcePushed"}]}