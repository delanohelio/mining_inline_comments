{"pr_number": 4374, "pr_title": "[GEOS-9403] MongoDB Plugin breaks GeoServer Admin UI", "pr_createdAt": "2020-07-02T22:39:11Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4374", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODE1OQ==", "url": "https://github.com/geoserver/geoserver/pull/4374#discussion_r449308159", "bodyText": "MonfoDB -> MongoDB", "author": "nmco", "createdAt": "2020-07-02T23:27:52Z", "path": "src/extension/mongodb/src/main/java/org/geoserver/rest/service/AppSchemaUtils.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.rest.service;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import org.geoserver.rest.RestException;\n+import org.geotools.data.DataAccess;\n+import org.geotools.data.complex.AppSchemaDataAccess;\n+import org.geotools.data.complex.FeatureTypeMapping;\n+import org.geotools.data.mongodb.MongoDataStore;\n+import org.opengis.feature.type.Name;\n+import org.springframework.http.HttpStatus;\n+\n+/** Util methods for AppSchema centric logic. */\n+class AppSchemaUtils {\n+\n+    /**\n+     * Returns the internal MonfoDB store from the AppSchema data store with the provided store ID.", "originalCommit": "3ad1afdf0a68975305ff4654972141e1075b8834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODIzMw==", "url": "https://github.com/geoserver/geoserver/pull/4374#discussion_r449308233", "bodyText": "AppSchema -> App-Schema", "author": "nmco", "createdAt": "2020-07-02T23:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYyMjAzOA==", "url": "https://github.com/geoserver/geoserver/pull/4374#discussion_r449622038", "bodyText": "Fixed, thanks", "author": "fernandor777", "createdAt": "2020-07-03T14:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODM4OQ==", "url": "https://github.com/geoserver/geoserver/pull/4374#discussion_r449308389", "bodyText": "JavaDoc?", "author": "nmco", "createdAt": "2020-07-02T23:29:01Z", "path": "src/extension/mongodb/src/main/java/org/geoserver/rest/service/AppSchemaUtils.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/* (c) 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.rest.service;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import org.geoserver.rest.RestException;\n+import org.geotools.data.DataAccess;\n+import org.geotools.data.complex.AppSchemaDataAccess;\n+import org.geotools.data.complex.FeatureTypeMapping;\n+import org.geotools.data.mongodb.MongoDataStore;\n+import org.opengis.feature.type.Name;\n+import org.springframework.http.HttpStatus;\n+\n+/** Util methods for AppSchema centric logic. */\n+class AppSchemaUtils {\n+\n+    /**\n+     * Returns the internal MonfoDB store from the AppSchema data store with the provided store ID.\n+     */\n+    static MongoDataStore getMongoStoreById(\n+            String storeId, final AppSchemaDataAccess appSchemaStore) throws IOException {\n+        MongoDataStore mongoStore = null;\n+        List<Name> names = appSchemaStore.getNames();\n+        for (Name ename : names) {\n+            FeatureTypeMapping mapping = appSchemaStore.getMappingByName(ename);\n+            if (mapping.getSourceDatastoreId().filter(id -> storeId.equals(id)).isPresent()) {\n+                DataAccess internalStore = mapping.getSource().getDataStore();\n+                if (!(internalStore instanceof MongoDataStore)) {\n+                    throw new RestException(\n+                            \"Internal Datastore is not a MongoDB one.\", HttpStatus.BAD_REQUEST);\n+                }\n+                mongoStore = (MongoDataStore) internalStore;\n+                break;\n+            }\n+        }\n+        if (mongoStore == null) {\n+            throw new RestException(\"Internal Datastore not found.\", HttpStatus.BAD_REQUEST);\n+        }\n+        return mongoStore;\n+    }\n+\n+    /** Returns the Mongo schemas in use based on the store id. */\n+    static Set<String> extractUsedSchemas(AppSchemaDataAccess appSchemaStore, String storeId)\n+            throws IOException {\n+        final List<Name> names = appSchemaStore.getNames();\n+        final Set<String> schemas = new HashSet<>();\n+        for (Name en : names) {\n+            FeatureTypeMapping mapping = appSchemaStore.getMappingByName(en);\n+            String eid = mapping.getSourceDatastoreId().orElse(null);\n+            if (Objects.equals(storeId, eid)) {\n+                Name schemaName = mapping.getSource().getSchema().getName();\n+                schemas.add(schemaName.getLocalPart());\n+            }\n+        }\n+        return Collections.unmodifiableSet(schemas);\n+    }\n+\n+    /** Returns the store ID for the MongoDataStore provided instance. */\n+    static String getStoreId(AppSchemaDataAccess appSchemaStore, MongoDataStore mongoStore)\n+            throws IOException {\n+        for (Name etn : appSchemaStore.getNames()) {\n+            FeatureTypeMapping featureTypeMapping = appSchemaStore.getMappingByName(etn);\n+            if (Objects.equals(mongoStore, featureTypeMapping.getSource().getDataStore()))\n+                return featureTypeMapping.getSourceDatastoreId().orElse(null);\n+        }\n+        return null;\n+    }\n+\n+    static void fillMongoStoresSet(", "originalCommit": "3ad1afdf0a68975305ff4654972141e1075b8834", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYyMjA4Ng==", "url": "https://github.com/geoserver/geoserver/pull/4374#discussion_r449622086", "bodyText": "Added", "author": "fernandor777", "createdAt": "2020-07-03T14:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwODM4OQ=="}], "type": "inlineReview"}, {"oid": "f7640c4bbf176346a8c867c02e32d605095c3b57", "url": "https://github.com/geoserver/geoserver/commit/f7640c4bbf176346a8c867c02e32d605095c3b57", "message": "[GEOS-9403] MongoDB Plugin breaks GeoServer Admin UI", "committedDate": "2020-07-03T15:09:10Z", "type": "commit"}, {"oid": "f7640c4bbf176346a8c867c02e32d605095c3b57", "url": "https://github.com/geoserver/geoserver/commit/f7640c4bbf176346a8c867c02e32d605095c3b57", "message": "[GEOS-9403] MongoDB Plugin breaks GeoServer Admin UI", "committedDate": "2020-07-03T15:09:10Z", "type": "forcePushed"}]}