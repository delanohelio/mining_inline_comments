{"pr_number": 3921, "pr_title": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "pr_createdAt": "2020-08-19T09:38:53Z", "pr_url": "https://github.com/micronaut-projects/micronaut-core/pull/3921", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzMDY0Mg==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r472930642", "bodyText": "Think it would be more efficient to use getParameterValues() and check the array since this will not build the MutableArgumentValue objects and there is no requirement here to use the MutableArgumentValue interface", "author": "graemerocher", "createdAt": "2020-08-19T10:35:20Z", "path": "aop/src/main/java/io/micronaut/aop/util/KotlinInvocationContextUtils.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.aop.util;\n+\n+import io.micronaut.aop.Interceptor;\n+import io.micronaut.aop.MethodInvocationContext;\n+import io.micronaut.core.annotation.Experimental;\n+import io.micronaut.core.annotation.Internal;\n+import io.micronaut.core.type.MutableArgumentValue;\n+import io.micronaut.core.util.CollectionUtils;\n+import io.micronaut.core.util.KotlinUtils;\n+import kotlin.coroutines.Continuation;\n+\n+import java.util.Collection;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.function.Consumer;\n+\n+/**\n+ * <p>Internal Utility methods for working with Kotlin <code>suspend</code> functions with {@link io.micronaut.aop.MethodInterceptor}</p>.\n+ *\n+ * @author Denis stepanov\n+ * @since 2.1.0\n+ */\n+@Internal\n+@Experimental\n+public class KotlinInvocationContextUtils {\n+\n+    /**\n+     * Checks if the method invocation is a Kotlin coroutine.\n+     *\n+     * @param context {@link MethodInvocationContext}\n+     * @return true if Kotlin coroutine\n+     */\n+    public static boolean isKotlinCoroutine(MethodInvocationContext<Object, Object> context) {\n+        if (!KotlinUtils.KOTLIN_COROUTINES_SUPPORTED || !context.getExecutableMethod().isSuspend()) {\n+            return false;\n+        }\n+        Collection<MutableArgumentValue<?>> arguments = context.getParameters().values();", "originalCommit": "5e93ef0f8dae7458d6eed8d78381c4fc2d6aecd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzMDkxMA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r472930910", "bodyText": "Same thing here I thin you can use getParameterValues() as well", "author": "graemerocher", "createdAt": "2020-08-19T10:35:46Z", "path": "aop/src/main/java/io/micronaut/aop/util/KotlinInvocationContextUtils.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.aop.util;\n+\n+import io.micronaut.aop.Interceptor;\n+import io.micronaut.aop.MethodInvocationContext;\n+import io.micronaut.core.annotation.Experimental;\n+import io.micronaut.core.annotation.Internal;\n+import io.micronaut.core.type.MutableArgumentValue;\n+import io.micronaut.core.util.CollectionUtils;\n+import io.micronaut.core.util.KotlinUtils;\n+import kotlin.coroutines.Continuation;\n+\n+import java.util.Collection;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.function.Consumer;\n+\n+/**\n+ * <p>Internal Utility methods for working with Kotlin <code>suspend</code> functions with {@link io.micronaut.aop.MethodInterceptor}</p>.\n+ *\n+ * @author Denis stepanov\n+ * @since 2.1.0\n+ */\n+@Internal\n+@Experimental\n+public class KotlinInvocationContextUtils {\n+\n+    /**\n+     * Checks if the method invocation is a Kotlin coroutine.\n+     *\n+     * @param context {@link MethodInvocationContext}\n+     * @return true if Kotlin coroutine\n+     */\n+    public static boolean isKotlinCoroutine(MethodInvocationContext<Object, Object> context) {\n+        if (!KotlinUtils.KOTLIN_COROUTINES_SUPPORTED || !context.getExecutableMethod().isSuspend()) {\n+            return false;\n+        }\n+        Collection<MutableArgumentValue<?>> arguments = context.getParameters().values();\n+        if (arguments.isEmpty()) {\n+            return false;\n+        }\n+        MutableArgumentValue lastArgument = CollectionUtils.last(arguments);\n+        Object lastArgumentValue = lastArgument.getValue();\n+        if (lastArgumentValue instanceof Continuation) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Handle Kotlin coroutine invocation represented as {@link CompletableFuture}s.\n+     *\n+     * @param context  {@link MethodInvocationContext}\n+     * @param consumer helper\n+     * @return invocation return value\n+     */\n+    public static Object handleKotlinCoroutine(MethodInvocationContext<Object, Object> context, Consumer<KotlinCoroutineInvocation> consumer) {\n+        Collection<MutableArgumentValue<?>> arguments = context.getParameters().values();", "originalCommit": "5e93ef0f8dae7458d6eed8d78381c4fc2d6aecd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzODE0OQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r472938149", "bodyText": "I need MutableArgumentValue to change the value lastArgument.setValue(completableFutureContinuation);", "author": "dstepanov", "createdAt": "2020-08-19T10:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzMDkxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk3NDQ5MQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r472974491", "bodyText": "even then will be more efficient to the array element directly since you are not using anything the Argument interface provides (like the annotation metadata or the argument name)", "author": "graemerocher", "createdAt": "2020-08-19T11:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkzMDkxMA=="}], "type": "inlineReview"}, {"oid": "f4e25a0df0504adc28b291ca27fe2b5335e2beb2", "url": "https://github.com/micronaut-projects/micronaut-core/commit/f4e25a0df0504adc28b291ca27fe2b5335e2beb2", "message": "Support Kotlin suspend functions in MethodInterceptors", "committedDate": "2020-08-19T12:15:57Z", "type": "forcePushed"}, {"oid": "1114e82cc1dc55dd89ec517ac160ba6a43001871", "url": "https://github.com/micronaut-projects/micronaut-core/commit/1114e82cc1dc55dd89ec517ac160ba6a43001871", "message": "Extract helper for method interception", "committedDate": "2020-08-20T14:08:06Z", "type": "forcePushed"}, {"oid": "a251a9a2453b80eb5f79b297a46b1c3a38913aa8", "url": "https://github.com/micronaut-projects/micronaut-core/commit/a251a9a2453b80eb5f79b297a46b1c3a38913aa8", "message": "Extract helper for method interception", "committedDate": "2020-08-21T03:37:45Z", "type": "forcePushed"}, {"oid": "4454fb30c7a7dc99cb717df8d6648f1339708be4", "url": "https://github.com/micronaut-projects/micronaut-core/commit/4454fb30c7a7dc99cb717df8d6648f1339708be4", "message": "Extract helper for method interception", "committedDate": "2020-08-21T04:50:21Z", "type": "forcePushed"}, {"oid": "8057a1ddc062da438f99cc8ad1cdce03232d20c9", "url": "https://github.com/micronaut-projects/micronaut-core/commit/8057a1ddc062da438f99cc8ad1cdce03232d20c9", "message": "Extract helper for method interception", "committedDate": "2020-08-21T05:01:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4ODc5MA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r478288790", "bodyText": "Does this need to public? Probably needs renaming too", "author": "graemerocher", "createdAt": "2020-08-27T09:38:57Z", "path": "aop/src/main/java/io/micronaut/aop/util/ReactiveMethodInterceptorHelper.java", "diffHunk": "@@ -0,0 +1,237 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.aop.util;\n+\n+import io.micronaut.aop.Interceptor;\n+import io.micronaut.aop.MethodInvocationContext;\n+import io.micronaut.aop.InterceptBuilder;\n+import io.micronaut.core.annotation.Experimental;\n+import io.micronaut.core.annotation.Internal;\n+import io.micronaut.core.async.publisher.Publishers;\n+import io.micronaut.core.convert.ConversionService;\n+import io.micronaut.core.type.Argument;\n+import io.micronaut.core.type.ReturnType;\n+import org.reactivestreams.Publisher;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+import java.util.function.BiFunction;\n+\n+/**\n+ * Reactive method invocation helper.\n+ *\n+ * @author Denis stepanov\n+ * @since 2.1.0\n+ *\n+ * @param <T> The declaring type\n+ * @param <R> The result of the method call\n+ */\n+@Internal\n+@Experimental\n+public class ReactiveMethodInterceptorHelper<T, R> implements InterceptBuilder<T, R> {", "originalCommit": "053cd89fc92fd4a725985534fe46d065cc991d14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMwNzMzOQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r478307339", "bodyText": "Renamed it also, do you want to rebase?", "author": "dstepanov", "createdAt": "2020-08-27T10:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4ODc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMwODM1NA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3921#discussion_r478308354", "bodyText": "Makes sense to rebase yes", "author": "graemerocher", "createdAt": "2020-08-27T10:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4ODc5MA=="}], "type": "inlineReview"}, {"oid": "8875dc936efdd6398a80d1272a012eb1fa6fbcad", "url": "https://github.com/micronaut-projects/micronaut-core/commit/8875dc936efdd6398a80d1272a012eb1fa6fbcad", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-08-27T10:22:27Z", "type": "forcePushed"}, {"oid": "d4c2700d866e41b5783452a50c81cad79b816728", "url": "https://github.com/micronaut-projects/micronaut-core/commit/d4c2700d866e41b5783452a50c81cad79b816728", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-08-27T16:29:54Z", "type": "forcePushed"}, {"oid": "8d976ff01310b023f8fea31813c464a217763d75", "url": "https://github.com/micronaut-projects/micronaut-core/commit/8d976ff01310b023f8fea31813c464a217763d75", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-08-27T16:36:07Z", "type": "forcePushed"}, {"oid": "6dd71af87980f4e7e27e9a51a02d4c16f1f59d92", "url": "https://github.com/micronaut-projects/micronaut-core/commit/6dd71af87980f4e7e27e9a51a02d4c16f1f59d92", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-08-27T17:04:32Z", "type": "forcePushed"}, {"oid": "009b982dc4d74f1b16a151167d58491605c8d331", "url": "https://github.com/micronaut-projects/micronaut-core/commit/009b982dc4d74f1b16a151167d58491605c8d331", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-08-31T03:17:29Z", "type": "forcePushed"}, {"oid": "5500a5b4b00abfecec475a99f757de0ccd7eaa3e", "url": "https://github.com/micronaut-projects/micronaut-core/commit/5500a5b4b00abfecec475a99f757de0ccd7eaa3e", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-03T04:08:40Z", "type": "forcePushed"}, {"oid": "3d4d76957cf198bb0572dec028d9e2f742a1807c", "url": "https://github.com/micronaut-projects/micronaut-core/commit/3d4d76957cf198bb0572dec028d9e2f742a1807c", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-04T11:16:50Z", "type": "forcePushed"}, {"oid": "880b2f4a5ecd54b8762715b11b46c195a28d7bdf", "url": "https://github.com/micronaut-projects/micronaut-core/commit/880b2f4a5ecd54b8762715b11b46c195a28d7bdf", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-10T06:23:38Z", "type": "forcePushed"}, {"oid": "86e54d9b71021dc38f77747cc285b14c1862ae5b", "url": "https://github.com/micronaut-projects/micronaut-core/commit/86e54d9b71021dc38f77747cc285b14c1862ae5b", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-18T07:23:03Z", "type": "forcePushed"}, {"oid": "1b5b69233f328d010d664cf60f54ba2bab58cb52", "url": "https://github.com/micronaut-projects/micronaut-core/commit/1b5b69233f328d010d664cf60f54ba2bab58cb52", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-18T07:51:20Z", "type": "forcePushed"}, {"oid": "48d984340ed0ddbf374a408271edaaf9d9e760a4", "url": "https://github.com/micronaut-projects/micronaut-core/commit/48d984340ed0ddbf374a408271edaaf9d9e760a4", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-18T08:10:58Z", "type": "commit"}, {"oid": "48d984340ed0ddbf374a408271edaaf9d9e760a4", "url": "https://github.com/micronaut-projects/micronaut-core/commit/48d984340ed0ddbf374a408271edaaf9d9e760a4", "message": "Add API to make it easier to write method interceptors and support Kotlin suspend functions", "committedDate": "2020-09-18T08:10:58Z", "type": "forcePushed"}]}