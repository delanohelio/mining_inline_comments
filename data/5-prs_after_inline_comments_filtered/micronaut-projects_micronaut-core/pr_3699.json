{"pr_number": 3699, "pr_title": "Fix how suspend function results are mapped", "pr_createdAt": "2020-07-09T16:11:27Z", "pr_url": "https://github.com/micronaut-projects/micronaut-core/pull/3699", "timeline": [{"oid": "c93654a3811afc7bc776b57221cebce726f0f4be", "url": "https://github.com/micronaut-projects/micronaut-core/commit/c93654a3811afc7bc776b57221cebce726f0f4be", "message": "Fix how suspend function results are passed through. Now filters will get an appropriate response based on the result of the body stream. Fixes #3667", "committedDate": "2020-07-09T16:10:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3MzY2NQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3699#discussion_r452673665", "bodyText": "Isn't it just more efficient to use Flowable.create instead of Single.create if we are just converting it to a flowable afterwards? Only different in the code would be you would have to call onNext(..) then onComplete()", "author": "graemerocher", "createdAt": "2020-07-10T07:33:54Z", "path": "http-server-netty/src/main/java/io/micronaut/http/server/netty/RoutingInBoundHandler.java", "diffHunk": "@@ -1407,49 +1408,47 @@ protected void doOnError(Throwable t) {\n                                 routeMatch instanceof MethodBasedRouteMatch &&\n                                         isKotlinFunctionReturnTypeUnit(((MethodBasedRouteMatch) routeMatch).getExecutableMethod());\n                         final Supplier<CompletableFuture<?>> supplier = ContinuationArgumentBinder.extractContinuationCompletableFutureSupplier(incomingRequest);\n-                        Object suspendedBody;\n                         if (isKotlinCoroutineSuspended(body)) {\n-                            if (isKotlinFunctionReturnTypeUnit) {\n-                                suspendedBody = Completable.create(emitter -> {\n-                                    CompletableFuture<?> f = supplier.get();\n-                                    f.whenComplete((BiConsumer<Object, Throwable>) (o, throwable) -> {\n-                                        if (throwable != null) {\n-                                            emitter.onError(throwable);\n-                                        } else {\n-                                            emitter.onComplete();\n-                                        }\n-                                    });\n-                                });\n-                            } else {\n-                                suspendedBody = Single.create(emitter -> {\n-                                    CompletableFuture<?> f = supplier.get();\n-                                    f.whenComplete((BiConsumer<Object, Throwable>) (o, throwable) -> {\n-                                        if (throwable != null) {\n-                                            emitter.onError(throwable);\n+                            return Single.<MutableHttpResponse<?>>create(emitter -> {\n+                                CompletableFuture<?> f = supplier.get();\n+                                f.whenComplete((o, throwable) -> {\n+                                    if (throwable != null) {\n+                                        emitter.onError(throwable);\n+                                    } else {\n+                                        MutableHttpResponse<?> response;\n+                                        if (o instanceof MutableHttpResponse) {\n+                                            response = (MutableHttpResponse<?>) o;\n                                         } else {\n-                                            emitter.onSuccess(o);\n+                                            response = forStatus(routeMatch.getAnnotationMetadata(), defaultHttpStatus);\n+                                            if (!isKotlinFunctionReturnTypeUnit) {\n+                                                response = response.body(o);\n+                                            }\n                                         }\n-                                    });\n+                                        response.setAttribute(HttpAttributes.ROUTE_MATCH, finalRoute);\n+                                        emitter.onSuccess(response);\n+                                    }\n                                 });\n-                            }\n+                            }).toFlowable();", "originalCommit": "c93654a3811afc7bc776b57221cebce726f0f4be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzOTQxNw==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3699#discussion_r452839417", "bodyText": "Probably - I'll update it", "author": "jameskleeh", "createdAt": "2020-07-10T13:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3MzY2NQ=="}], "type": "inlineReview"}, {"oid": "379b27abe0e55aad39d2fdb96a4c9a4156e0e141", "url": "https://github.com/micronaut-projects/micronaut-core/commit/379b27abe0e55aad39d2fdb96a4c9a4156e0e141", "message": "Use Flowable.create instead of Single", "committedDate": "2020-07-10T13:25:14Z", "type": "commit"}, {"oid": "46177bf8c18b964cd4339fed6a6ffa007c8d69aa", "url": "https://github.com/micronaut-projects/micronaut-core/commit/46177bf8c18b964cd4339fed6a6ffa007c8d69aa", "message": "Merge branch 'master' into issue-3667", "committedDate": "2020-07-10T16:28:34Z", "type": "commit"}]}