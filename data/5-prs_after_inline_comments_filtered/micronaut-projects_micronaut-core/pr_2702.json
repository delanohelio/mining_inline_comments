{"pr_number": 2702, "pr_title": "Enabling Visitors to declare annotation processors options.", "pr_createdAt": "2020-01-28T15:25:20Z", "pr_url": "https://github.com/micronaut-projects/micronaut-core/pull/2702", "timeline": [{"oid": "cfeb3da0d309e97e380b5a05246002505393fb3e", "url": "https://github.com/micronaut-projects/micronaut-core/commit/cfeb3da0d309e97e380b5a05246002505393fb3e", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5", "committedDate": "2020-01-28T15:40:23Z", "type": "forcePushed"}, {"oid": "3f4bf3f579ac50fdc3f9d04b14d87268818d8d05", "url": "https://github.com/micronaut-projects/micronaut-core/commit/3f4bf3f579ac50fdc3f9d04b14d87268818d8d05", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5", "committedDate": "2020-01-28T16:22:28Z", "type": "forcePushed"}, {"oid": "b6f0bc273d19a024a47fa41fbf6a3a066e127e0f", "url": "https://github.com/micronaut-projects/micronaut-core/commit/b6f0bc273d19a024a47fa41fbf6a3a066e127e0f", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5", "committedDate": "2020-01-28T17:27:08Z", "type": "forcePushed"}, {"oid": "84caa2b1b2eac93363b6ba67b33f779db9323e6b", "url": "https://github.com/micronaut-projects/micronaut-core/commit/84caa2b1b2eac93363b6ba67b33f779db9323e6b", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly", "committedDate": "2020-01-29T18:17:32Z", "type": "forcePushed"}, {"oid": "961aaf84d94daa0e5391f0eac234c316e5f5d07c", "url": "https://github.com/micronaut-projects/micronaut-core/commit/961aaf84d94daa0e5391f0eac234c316e5f5d07c", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly", "committedDate": "2020-01-29T19:24:12Z", "type": "forcePushed"}, {"oid": "89e52cb12870978e6bc8ee45ed02bd7dad2a0c41", "url": "https://github.com/micronaut-projects/micronaut-core/commit/89e52cb12870978e6bc8ee45ed02bd7dad2a0c41", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-01-29T21:44:14Z", "type": "forcePushed"}, {"oid": "83f0fbb6ce1fac88f3424ab1226c8b0390d5b23f", "url": "https://github.com/micronaut-projects/micronaut-core/commit/83f0fbb6ce1fac88f3424ab1226c8b0390d5b23f", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-01-29T22:03:27Z", "type": "forcePushed"}, {"oid": "d7b520a7953467b32bbaf8c368345aa0ad112b80", "url": "https://github.com/micronaut-projects/micronaut-core/commit/d7b520a7953467b32bbaf8c368345aa0ad112b80", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-01-30T15:44:25Z", "type": "forcePushed"}, {"oid": "c4cc6f8337f2735265bbccf8cf68eb79e38dd47d", "url": "https://github.com/micronaut-projects/micronaut-core/commit/c4cc6f8337f2735265bbccf8cf68eb79e38dd47d", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-02-04T14:50:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyMzIyMQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2702#discussion_r374723221", "bodyText": "You collect to a Set, so I don't think distinct is needed.", "author": "croudet", "createdAt": "2020-02-04T15:02:50Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/TypeElementVisitorProcessor.java", "diffHunk": "@@ -55,10 +58,30 @@\n public class TypeElementVisitorProcessor extends AbstractInjectAnnotationProcessor {\n \n     private boolean executed = false;\n+    private Collection<TypeElementVisitor> typeElementVisitors;\n+\n+    @Override\n+    public synchronized void init(ProcessingEnvironment processingEnv) {\n+        super.init(processingEnv);\n+        this.typeElementVisitors = findTypeElementVisitors();\n+    }\n \n     @Override\n     public Set<String> getSupportedOptions() {\n-        return Collections.singleton(\"org.gradle.annotation.processing.aggregating\");\n+        Stream<String> baseOption = Stream.of(\"org.gradle.annotation.processing.aggregating\");\n+        Stream<String> visitorsOptions = typeElementVisitors\n+                .stream()\n+                .map(TypeElementVisitor::getSupportedOptions)\n+                .flatMap(Collection::stream);\n+        Stream<String> visitorsAnnotationsOptions = typeElementVisitors\n+                .stream()\n+                .filter(tev -> tev.getClass().isAnnotationPresent(SupportedOptions.class))\n+                .map(TypeElementVisitor::getClass)\n+                .map(cls -> cls.getAnnotation(SupportedOptions.class))\n+                .flatMap((SupportedOptions supportedOptions) -> Arrays.stream(supportedOptions.value()));\n+        return Stream.of(baseOption, visitorsAnnotationsOptions, visitorsOptions)\n+                .flatMap(Stream::distinct)", "originalCommit": "c4cc6f8337f2735265bbccf8cf68eb79e38dd47d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc0MDczMw==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2702#discussion_r374740733", "bodyText": "Done!", "author": "miguelbaldi", "createdAt": "2020-02-04T15:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyMzIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyMzg2MA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2702#discussion_r374723860", "bodyText": "You may want to call super.getSupportedOptions as well.", "author": "croudet", "createdAt": "2020-02-04T15:03:44Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/TypeElementVisitorProcessor.java", "diffHunk": "@@ -55,10 +58,30 @@\n public class TypeElementVisitorProcessor extends AbstractInjectAnnotationProcessor {\n \n     private boolean executed = false;\n+    private Collection<TypeElementVisitor> typeElementVisitors;\n+\n+    @Override\n+    public synchronized void init(ProcessingEnvironment processingEnv) {\n+        super.init(processingEnv);\n+        this.typeElementVisitors = findTypeElementVisitors();\n+    }\n \n     @Override\n     public Set<String> getSupportedOptions() {\n-        return Collections.singleton(\"org.gradle.annotation.processing.aggregating\");\n+        Stream<String> baseOption = Stream.of(\"org.gradle.annotation.processing.aggregating\");\n+        Stream<String> visitorsOptions = typeElementVisitors\n+                .stream()\n+                .map(TypeElementVisitor::getSupportedOptions)\n+                .flatMap(Collection::stream);\n+        Stream<String> visitorsAnnotationsOptions = typeElementVisitors\n+                .stream()\n+                .filter(tev -> tev.getClass().isAnnotationPresent(SupportedOptions.class))\n+                .map(TypeElementVisitor::getClass)\n+                .map(cls -> cls.getAnnotation(SupportedOptions.class))\n+                .flatMap((SupportedOptions supportedOptions) -> Arrays.stream(supportedOptions.value()));\n+        return Stream.of(baseOption, visitorsAnnotationsOptions, visitorsOptions)", "originalCommit": "c4cc6f8337f2735265bbccf8cf68eb79e38dd47d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc0MDUyNA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2702#discussion_r374740524", "bodyText": "Done! Thanks", "author": "miguelbaldi", "createdAt": "2020-02-04T15:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyMzg2MA=="}], "type": "inlineReview"}, {"oid": "0883617f21598f312d844dec8b3aa712550d9fe1", "url": "https://github.com/micronaut-projects/micronaut-core/commit/0883617f21598f312d844dec8b3aa712550d9fe1", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-02-04T15:05:37Z", "type": "forcePushed"}, {"oid": "9fd9e70bf69b681a1d7c7931827e588f8da87dba", "url": "https://github.com/micronaut-projects/micronaut-core/commit/9fd9e70bf69b681a1d7c7931827e588f8da87dba", "message": "[WIP] Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affect, given that they access the properties directly\n  TODO:\n    - Tests!", "committedDate": "2020-02-04T15:27:46Z", "type": "forcePushed"}, {"oid": "bbd23b6e412353c7c41be6a3203fd255b6a1dab9", "url": "https://github.com/micronaut-projects/micronaut-core/commit/bbd23b6e412353c7c41be6a3203fd255b6a1dab9", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affected, given that they access the properties directly\n  - Internal visitors updated to use `@SupportedOptions` annotation.", "committedDate": "2020-02-04T19:49:57Z", "type": "forcePushed"}, {"oid": "fabcf52aa0d88d6964ed71d689e0e3dba1cedd08", "url": "https://github.com/micronaut-projects/micronaut-core/commit/fabcf52aa0d88d6964ed71d689e0e3dba1cedd08", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affected, given that they access the properties directly\n  - Internal visitors updated to use `@SupportedOptions` annotation.", "committedDate": "2020-02-04T20:10:57Z", "type": "forcePushed"}, {"oid": "a4e875a3803e5fa85f41db54d9dcd177d123df0b", "url": "https://github.com/micronaut-projects/micronaut-core/commit/a4e875a3803e5fa85f41db54d9dcd177d123df0b", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affected, given that they access the properties directly\n  - Internal visitors updated to use `@SupportedOptions` annotation.", "committedDate": "2020-02-04T22:47:35Z", "type": "forcePushed"}, {"oid": "310864173198c43f132db5af71027036726b1db5", "url": "https://github.com/micronaut-projects/micronaut-core/commit/310864173198c43f132db5af71027036726b1db5", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affected, given that they access the properties directly\n  - Internal visitors updated to use `@SupportedOptions` annotation.", "committedDate": "2020-02-04T22:50:22Z", "type": "commit"}, {"oid": "310864173198c43f132db5af71027036726b1db5", "url": "https://github.com/micronaut-projects/micronaut-core/commit/310864173198c43f132db5af71027036726b1db5", "message": "Enabling Visitors to declare annotation processors options.\n\n  - Needed to fix issue micronaut-projects/micronaut-openapi#108\n    By enabling annotation processors arguments, one can remove the need\n    for ugly System properties on thirdy party visitors. E.g.:\n      micronaut-openapi\n  - Fixing http-server-netty integration test, according to HTTP spec regarding to\n    Content-Type negotiation:\n    See https://tools.ietf.org/html/rfc7231#section-3.1.1.5\n  - Groovy compatibility using System properties\n  - Java processors implementations that rely on System properties are\n    not affected, given that they access the properties directly\n  - Internal visitors updated to use `@SupportedOptions` annotation.", "committedDate": "2020-02-04T22:50:22Z", "type": "forcePushed"}]}