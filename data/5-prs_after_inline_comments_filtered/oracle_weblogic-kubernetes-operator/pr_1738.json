{"pr_number": 1738, "pr_title": "Crossdomxaction", "pr_createdAt": "2020-06-16T17:24:37Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738", "timeline": [{"oid": "1ef8b91c81660c6251c7116c89908b179923ff1a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1ef8b91c81660c6251c7116c89908b179923ff1a", "message": "cross domain transaction test", "committedDate": "2020-06-05T19:11:36Z", "type": "commit"}, {"oid": "ee3b5dbcbb96c5211b1dc083669ec7ab6da59e8f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee3b5dbcbb96c5211b1dc083669ec7ab6da59e8f", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into crossdomxaction", "committedDate": "2020-06-05T19:11:47Z", "type": "commit"}, {"oid": "1ea131cc2c9d63c6c242732780eb69b7bd072e26", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1ea131cc2c9d63c6c242732780eb69b7bd072e26", "message": "updating cross domain transaction test", "committedDate": "2020-06-11T16:34:52Z", "type": "commit"}, {"oid": "2f21fe47546259a708e3c7ab0030b95df821448c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2f21fe47546259a708e3c7ab0030b95df821448c", "message": "sync develop changes", "committedDate": "2020-06-12T21:05:04Z", "type": "commit"}, {"oid": "23fbfa92163ecf974a9cd81b068255d70074ed74", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/23fbfa92163ecf974a9cd81b068255d70074ed74", "message": "updates to cross domain transaction test", "committedDate": "2020-06-12T21:07:47Z", "type": "commit"}, {"oid": "127c0a1529ad95b4c2d07858cbf4e2b503da75ac", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/127c0a1529ad95b4c2d07858cbf4e2b503da75ac", "message": "add curl command to the test", "committedDate": "2020-06-15T15:12:12Z", "type": "commit"}, {"oid": "16c28ef7bce3eab2beac5d512b965f1eab55abe9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/16c28ef7bce3eab2beac5d512b965f1eab55abe9", "message": "update crossd domaintransaction to use new app", "committedDate": "2020-06-15T18:08:12Z", "type": "commit"}, {"oid": "33f7e08d65e9189a47c34063591da1b31276e6ae", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/33f7e08d65e9189a47c34063591da1b31276e6ae", "message": "adding some debug statements", "committedDate": "2020-06-16T14:29:06Z", "type": "commit"}, {"oid": "29ecb7a13e1a5fb2f15e5b98d7416f13cc5cf381", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/29ecb7a13e1a5fb2f15e5b98d7416f13cc5cf381", "message": "sync develop", "committedDate": "2020-06-16T15:42:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNTM2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r441115363", "bodyText": "add domain2-managed-server2 to end of URL list", "author": "ajsomogyi", "createdAt": "2020-06-16T20:15:33Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -0,0 +1,400 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.annotations.tags.MustNotRunInParallel;\n+import oracle.weblogic.kubernetes.annotations.tags.Slow;\n+import oracle.weblogic.kubernetes.assertions.TestAssertions;\n+import oracle.weblogic.kubernetes.extensions.LoggedTest;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.PV_ROOT;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.RESULTS_ROOT;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.MODEL_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.createDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.assertions.TestAssertions.domainExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.ExecCommand.exec;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+@DisplayName(\"Verify cross domain transaction is successful\")\n+@IntegrationTest\n+public class ItCrossDomainTransaction implements LoggedTest {\n+\n+  private static final String WDT_MODEL_FILE_DOMAIN1 = \"model-crossdomaintransaction-domain1.yaml\";\n+  private static final String WDT_MODEL_FILE_DOMAIN2 = \"model-crossdomaintransaction-domain2.yaml\";\n+\n+  private static final String WDT_MODEL_DOMAIN1_PROPS = \"model-crossdomaintransaction-domain1.properties\";\n+  private static final String WDT_MODEL_DOMAIN2_PROPS = \"model-crossdomaintransaction-domain2.properties\";\n+  private static final String WDT_IMAGE_NAME1 = \"domain1-wdt-image\";\n+  private static final String WDT_IMAGE_NAME2 = \"domain2-wdt-image\";\n+  private static final String WDT_APP_NAME = \"txforward\";\n+  private static final String PROPS_TEMP_DIR = RESULTS_ROOT + \"/crossdomaintransactiontemp\";\n+\n+  private static HelmParams opHelmParams = null;\n+  private static String opNamespace = null;\n+  private static String operatorImage = null;\n+  private static String domain1Namespace = null;\n+  private static String domain2Namespace = null;\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  private static String dockerConfigJson = \"\";\n+  private String domainUid1 = \"domain1\";\n+  private String domainUid2 = \"domain2\";\n+  private static Map<String, Object> secretNameMap;\n+  private final String domain1AdminServerPodName = domainUid1 + \"-admin-server\";\n+  private final String domain1ManagedServerPrefix = domainUid1 + \"-managed-server\";\n+  private final String domain2ManagedServerPrefix = domainUid2 + \"-managed-server\";\n+\n+  /**\n+   * Install Operator.\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *     JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    // get a new unique opNamespace\n+    logger.info(\"Creating unique namespace for Operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    // Now that we got the namespaces for both the domains,w e need to update the model properties\n+    // file with the namespaces. for cross domain transaction to work, we need to have the externalDNSName\n+    // set in the config file. Cannot set this after the domain is up since a server restart is\n+    // required for this to take effect. So, copying the property file to RESULT_ROOT and updating the\n+    // property file\n+    updatePropertyFile();\n+\n+    // install and verify operator\n+    installAndVerifyOperator(opNamespace, domain1Namespace, domain2Namespace);\n+\n+  }\n+\n+  private static void updatePropertyFile() {\n+    //create a temporary directory to copy and update the properties file\n+    Path target = Paths.get(PROPS_TEMP_DIR);\n+    Path source1 = Paths.get(MODEL_DIR, WDT_MODEL_DOMAIN1_PROPS);\n+    Path source2 = Paths.get(MODEL_DIR, WDT_MODEL_DOMAIN2_PROPS);\n+    logger.info(\"Copy the properties file to the above area so that we can add namespace property\");\n+    assertDoesNotThrow(() -> {\n+      Files.createDirectories(target);\n+      Files.copy(source1, target.resolve(source1.getFileName()), StandardCopyOption.REPLACE_EXISTING);\n+      Files.copy(source2, target.resolve(source2.getFileName()), StandardCopyOption.REPLACE_EXISTING);\n+    });\n+\n+    assertDoesNotThrow(() -> {\n+      addNamespaceToPropertyFile(WDT_MODEL_DOMAIN1_PROPS, domain1Namespace);\n+      String.format(\"Failed to update %s with namespace %s\",\n+            WDT_MODEL_DOMAIN1_PROPS, domain1Namespace);\n+    });\n+    assertDoesNotThrow(() -> {\n+      addNamespaceToPropertyFile(WDT_MODEL_DOMAIN2_PROPS, domain2Namespace);\n+      String.format(\"Failed to update %s with namespace %s\",\n+            WDT_MODEL_DOMAIN2_PROPS, domain2Namespace);\n+    });\n+\n+  }\n+\n+  private static void addNamespaceToPropertyFile(String propFileName, String domainNamespace) throws IOException {\n+    FileInputStream in = new FileInputStream(PROPS_TEMP_DIR + \"/\" + propFileName);\n+    Properties props = new Properties();\n+    props.load(in);\n+    in.close();\n+\n+    FileOutputStream out = new FileOutputStream(PROPS_TEMP_DIR + \"/\" + propFileName);\n+    props.setProperty(\"NAMESPACE\", domainNamespace);\n+    props.store(out, null);\n+    out.close();\n+  }\n+\n+  /*\n+   * This test verifies cross domain transaction is successful. domain in image using wdt is used\n+   * to create 2 domains in different namespaces. An app is deployed to both the domains and the servlet\n+   * is invoked which starts a transaction that spans both domains.\n+   */\n+  @Test\n+  @DisplayName(\"Check cross domain transaction works\")\n+  @Slow\n+  @MustNotRunInParallel\n+  public void testCrossDomainTransaction() {\n+\n+    //build application archive\n+    //Path application = Paths.get(RESOURCE_DIR, \"apps\", \"txpropagate\");\n+    Path application = Paths.get(RESOURCE_DIR, \"apps\", \"txforward\");\n+    BuildApplication.buildApplication(application, null, \"build\", domain1Namespace);\n+\n+    // create admin credential secret for domain1\n+    logger.info(\"Create admin credential secret for domain1\");\n+    String domain1AdminSecretName = domainUid1 + \"-weblogic-credentials\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        domain1AdminSecretName, domain1Namespace, ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT),\n+        String.format(\"createSecret %s failed for %s\", domain1AdminSecretName, domainUid1));\n+\n+    // create admin credential secret for domain2\n+    logger.info(\"Create admin credential secret for domain2\");\n+    String domain2AdminSecretName = domainUid2 + \"-weblogic-credentials\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        domain2AdminSecretName, domain2Namespace, ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT),\n+        String.format(\"createSecret %s failed for %s\", domain2AdminSecretName, domainUid2));\n+\n+    //createImageVerify expects the location of the ear file\n+    String appSource = PV_ROOT + \"/applications/\" + WDT_APP_NAME + \"/\" + WDT_APP_NAME + \".ear\";\n+\n+    logger.info(\"Creating image with model file and verify\");\n+    String domain1Image = createImageAndVerify(\n+        WDT_IMAGE_NAME1, WDT_MODEL_FILE_DOMAIN1, appSource, WDT_MODEL_DOMAIN1_PROPS, PROPS_TEMP_DIR, domainUid1);\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(domain1Image);\n+\n+    logger.info(\"Creating image with model file and verify\");\n+    //String domain2Image = createImageAndVerify(\n+    //    WDT_IMAGE_NAME2, WDT_MODEL_FILE_DOMAIN2, WDT_APP_NAME, WDT_MODEL_DOMAIN2_PROPS, PROPS_TEMP_DIR, domainUid2);\n+    String domain2Image = createImageAndVerify(\n+        WDT_IMAGE_NAME2, WDT_MODEL_FILE_DOMAIN2, appSource, WDT_MODEL_DOMAIN2_PROPS, PROPS_TEMP_DIR, domainUid2);\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(domain2Image);\n+\n+    //create domain1\n+    createDomain(domainUid1, domain1Namespace, domain1AdminSecretName, domain1Image);\n+    //create domain2\n+    createDomain(domainUid2, domain2Namespace, domain2AdminSecretName, domain2Image);\n+\n+    logger.info(\"Getting admin server external service node port\");\n+    int adminServiceNodePort = assertDoesNotThrow(\n+        () -> getServiceNodePort(domain1Namespace, domain1AdminServerPodName + \"-external\", \"default\"),\n+        \"Getting admin server node port failed\");\n+\n+    String curlRequest = String.format(\"curl -v --show-error --noproxy '*' \"\n+            + \"http://%s:%s/TxForward/TxForward?urls=t3://%s.%s:7001,t3://%s1.%s:8001,t3://%s1.%s:8001\",\n+             K8S_NODEPORT_HOST, adminServiceNodePort, domain1AdminServerPodName, domain1Namespace,", "originalCommit": "29ecb7a13e1a5fb2f15e5b98d7416f13cc5cf381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwMjk1Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r441202956", "bodyText": "added domain2-managed-server2 to the url list", "author": "bhavaniravichandran", "createdAt": "2020-06-16T23:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNTM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjkyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r441116925", "bodyText": "change JNDIName to txforward.RemoteSync", "author": "ajsomogyi", "createdAt": "2020-06-16T20:18:36Z", "path": "new-integration-tests/src/test/resources/apps/txforward/remotesync/src/example/RemoteSync.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package example;\r\n+\r\n+import java.rmi.Remote;\r\n+import java.rmi.RemoteException;\r\n+\r\n+public interface RemoteSync extends Remote {\r\n+  public static final String JNDINAME = \"propagate.RemoteSync\";\r", "originalCommit": "29ecb7a13e1a5fb2f15e5b98d7416f13cc5cf381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIwMzQ5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r441203493", "bodyText": "fixed", "author": "bhavaniravichandran", "createdAt": "2020-06-16T23:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExNjkyNQ=="}], "type": "inlineReview"}, {"oid": "54f9b3c16420dba70f28f816f8786de633556dc8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/54f9b3c16420dba70f28f816f8786de633556dc8", "message": "sync develop", "committedDate": "2020-06-16T23:01:44Z", "type": "commit"}, {"oid": "b59f22ee5183d4ddc438fda853882ded8ee5618f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b59f22ee5183d4ddc438fda853882ded8ee5618f", "message": "Merge branch 'crossdomxaction' of https://github.com/oracle/weblogic-kubernetes-operator into crossdomxaction", "committedDate": "2020-06-16T23:38:03Z", "type": "commit"}, {"oid": "fe5a88a7bf831901cb4f199d796440696bb011d8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fe5a88a7bf831901cb4f199d796440696bb011d8", "message": "fix following Alex's review comments", "committedDate": "2020-06-16T23:45:26Z", "type": "commit"}, {"oid": "d1b2c763387fb3d801cf43bd2c054fe728d40336", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d1b2c763387fb3d801cf43bd2c054fe728d40336", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into crossdomxaction", "committedDate": "2020-06-17T00:26:49Z", "type": "commit"}, {"oid": "66801ccf7c33a955985a244e0d4344e93316ccc6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/66801ccf7c33a955985a244e0d4344e93316ccc6", "message": "fix merge", "committedDate": "2020-06-17T01:23:27Z", "type": "commit"}, {"oid": "7503d721cf5f44bfac77781d143166fe0548c64c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7503d721cf5f44bfac77781d143166fe0548c64c", "message": "add debugs", "committedDate": "2020-06-19T21:43:51Z", "type": "commit"}, {"oid": "13e31f697baae6b2a55100a656825e5cbe6cf073", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/13e31f697baae6b2a55100a656825e5cbe6cf073", "message": "add repo name to the image", "committedDate": "2020-06-21T01:22:11Z", "type": "commit"}, {"oid": "f6bcbe8531cf5fd841610186ebbcf0730f5481bb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f6bcbe8531cf5fd841610186ebbcf0730f5481bb", "message": "reverting previous commit", "committedDate": "2020-06-21T03:04:13Z", "type": "commit"}, {"oid": "e930ba304a55cefb3dc2304f3acf2d8686044c47", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e930ba304a55cefb3dc2304f3acf2d8686044c47", "message": "fix checkstyle", "committedDate": "2020-06-21T18:22:09Z", "type": "commit"}, {"oid": "719778266308e622a54a4de72b658317be13816a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/719778266308e622a54a4de72b658317be13816a", "message": "pull develop and resolve merge conflicts", "committedDate": "2020-06-23T16:04:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjY1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444336652", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Now that we got the namespaces for both the domains,w e need to update the model properties\n          \n          \n            \n                // Now that we got the namespaces for both the domains, we need to update the model properties", "author": "sankarpn", "createdAt": "2020-06-23T16:02:14Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -0,0 +1,402 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.annotations.tags.MustNotRunInParallel;\n+import oracle.weblogic.kubernetes.annotations.tags.Slow;\n+import oracle.weblogic.kubernetes.assertions.TestAssertions;\n+import oracle.weblogic.kubernetes.extensions.LoggedTest;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.PV_ROOT;\n+//import static oracle.weblogic.kubernetes.TestConstants.REPO_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.RESULTS_ROOT;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.MODEL_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.createDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.assertions.TestAssertions.domainExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.ExecCommand.exec;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+@DisplayName(\"Verify cross domain transaction is successful\")\n+@IntegrationTest\n+public class ItCrossDomainTransaction implements LoggedTest {\n+\n+  private static final String WDT_MODEL_FILE_DOMAIN1 = \"model-crossdomaintransaction-domain1.yaml\";\n+  private static final String WDT_MODEL_FILE_DOMAIN2 = \"model-crossdomaintransaction-domain2.yaml\";\n+\n+  private static final String WDT_MODEL_DOMAIN1_PROPS = \"model-crossdomaintransaction-domain1.properties\";\n+  private static final String WDT_MODEL_DOMAIN2_PROPS = \"model-crossdomaintransaction-domain2.properties\";\n+  private static final String WDT_IMAGE_NAME1 = \"domain1-cdxaction-wdt-image\";\n+  private static final String WDT_IMAGE_NAME2 = \"domain2-cdxaction-wdt-image\";\n+  private static final String WDT_APP_NAME = \"txforward\";\n+  private static final String PROPS_TEMP_DIR = RESULTS_ROOT + \"/crossdomaintransactiontemp\";\n+\n+  private static HelmParams opHelmParams = null;\n+  private static String opNamespace = null;\n+  private static String operatorImage = null;\n+  private static String domain1Namespace = null;\n+  private static String domain2Namespace = null;\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  private static String dockerConfigJson = \"\";\n+  private String domainUid1 = \"domain1\";\n+  private String domainUid2 = \"domain2\";\n+  private static Map<String, Object> secretNameMap;\n+  private final String domain1AdminServerPodName = domainUid1 + \"-admin-server\";\n+  private final String domain1ManagedServerPrefix = domainUid1 + \"-managed-server\";\n+  private final String domain2ManagedServerPrefix = domainUid2 + \"-managed-server\";\n+\n+  /**\n+   * Install Operator.\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *     JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    // get a new unique opNamespace\n+    logger.info(\"Creating unique namespace for Operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    // Now that we got the namespaces for both the domains,w e need to update the model properties", "originalCommit": "e930ba304a55cefb3dc2304f3acf2d8686044c47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NjE0MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444366140", "bodyText": "fixed", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjk0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444336948", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // file with the namespaces. for cross domain transaction to work, we need to have the externalDNSName\n          \n          \n            \n                // file with the namespaces. For cross domain transaction to work, we need to have the externalDNSName", "author": "sankarpn", "createdAt": "2020-06-23T16:02:39Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -0,0 +1,402 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.annotations.tags.MustNotRunInParallel;\n+import oracle.weblogic.kubernetes.annotations.tags.Slow;\n+import oracle.weblogic.kubernetes.assertions.TestAssertions;\n+import oracle.weblogic.kubernetes.extensions.LoggedTest;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.PV_ROOT;\n+//import static oracle.weblogic.kubernetes.TestConstants.REPO_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.RESULTS_ROOT;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.MODEL_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.createDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.assertions.TestAssertions.domainExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.ExecCommand.exec;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+@DisplayName(\"Verify cross domain transaction is successful\")\n+@IntegrationTest\n+public class ItCrossDomainTransaction implements LoggedTest {\n+\n+  private static final String WDT_MODEL_FILE_DOMAIN1 = \"model-crossdomaintransaction-domain1.yaml\";\n+  private static final String WDT_MODEL_FILE_DOMAIN2 = \"model-crossdomaintransaction-domain2.yaml\";\n+\n+  private static final String WDT_MODEL_DOMAIN1_PROPS = \"model-crossdomaintransaction-domain1.properties\";\n+  private static final String WDT_MODEL_DOMAIN2_PROPS = \"model-crossdomaintransaction-domain2.properties\";\n+  private static final String WDT_IMAGE_NAME1 = \"domain1-cdxaction-wdt-image\";\n+  private static final String WDT_IMAGE_NAME2 = \"domain2-cdxaction-wdt-image\";\n+  private static final String WDT_APP_NAME = \"txforward\";\n+  private static final String PROPS_TEMP_DIR = RESULTS_ROOT + \"/crossdomaintransactiontemp\";\n+\n+  private static HelmParams opHelmParams = null;\n+  private static String opNamespace = null;\n+  private static String operatorImage = null;\n+  private static String domain1Namespace = null;\n+  private static String domain2Namespace = null;\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  private static String dockerConfigJson = \"\";\n+  private String domainUid1 = \"domain1\";\n+  private String domainUid2 = \"domain2\";\n+  private static Map<String, Object> secretNameMap;\n+  private final String domain1AdminServerPodName = domainUid1 + \"-admin-server\";\n+  private final String domain1ManagedServerPrefix = domainUid1 + \"-managed-server\";\n+  private final String domain2ManagedServerPrefix = domainUid2 + \"-managed-server\";\n+\n+  /**\n+   * Install Operator.\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *     JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    // get a new unique opNamespace\n+    logger.info(\"Creating unique namespace for Operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    // Now that we got the namespaces for both the domains,w e need to update the model properties\n+    // file with the namespaces. for cross domain transaction to work, we need to have the externalDNSName", "originalCommit": "e930ba304a55cefb3dc2304f3acf2d8686044c47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NjAxOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444366019", "bodyText": "fixed", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0MTI1MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444341250", "bodyText": "remove commented code", "author": "sankarpn", "createdAt": "2020-06-23T16:08:49Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItCrossDomainTransaction.java", "diffHunk": "@@ -0,0 +1,386 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.nio.file.StandardCopyOption;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.annotations.tags.MustNotRunInParallel;\n+import oracle.weblogic.kubernetes.annotations.tags.Slow;\n+import oracle.weblogic.kubernetes.assertions.TestAssertions;\n+import oracle.weblogic.kubernetes.extensions.LoggedTest;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.RESULTS_ROOT;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.MODEL_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.createDomainCustomResource;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.assertions.TestAssertions.domainExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.ExecCommand.exec;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+@DisplayName(\"Verify cross domain transaction is successful\")\n+@IntegrationTest\n+public class ItCrossDomainTransaction implements LoggedTest {\n+\n+  private static final String WDT_MODEL_FILE_DOMAIN1 = \"model-crossdomaintransaction-domain1.yaml\";\n+  private static final String WDT_MODEL_FILE_DOMAIN2 = \"model-crossdomaintransaction-domain2.yaml\";\n+\n+  private static final String WDT_MODEL_DOMAIN1_PROPS = \"model-crossdomaintransaction-domain1.properties\";\n+  private static final String WDT_MODEL_DOMAIN2_PROPS = \"model-crossdomaintransaction-domain2.properties\";\n+  private static final String WDT_IMAGE_NAME1 = \"domain1-cdxaction-wdt-image\";\n+  private static final String WDT_IMAGE_NAME2 = \"domain2-cdxaction-wdt-image\";\n+  private static final String WDT_APP_NAME = \"txforward\";\n+  private static final String PROPS_TEMP_DIR = RESULTS_ROOT + \"/crossdomaintransactiontemp\";\n+\n+  private static HelmParams opHelmParams = null;\n+  private static String opNamespace = null;\n+  private static String operatorImage = null;\n+  private static String domain1Namespace = null;\n+  private static String domain2Namespace = null;\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  private static String dockerConfigJson = \"\";\n+  private String domainUid1 = \"domain1\";\n+  private String domainUid2 = \"domain2\";\n+  private static Map<String, Object> secretNameMap;\n+  private final String domain1AdminServerPodName = domainUid1 + \"-admin-server\";\n+  private final String domain1ManagedServerPrefix = domainUid1 + \"-managed-server\";\n+  private final String domain2ManagedServerPrefix = domainUid2 + \"-managed-server\";\n+\n+  /**\n+   * Install Operator.\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *     JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    // get a new unique opNamespace\n+    logger.info(\"Creating unique namespace for Operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Creating unique namespace for Domain\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    // Now that we got the namespaces for both the domains,w e need to update the model properties\n+    // file with the namespaces. for cross domain transaction to work, we need to have the externalDNSName\n+    // set in the config file. Cannot set this after the domain is up since a server restart is\n+    // required for this to take effect. So, copying the property file to RESULT_ROOT and updating the\n+    // property file\n+    updatePropertyFile();\n+\n+    // install and verify operator\n+    installAndVerifyOperator(opNamespace, domain1Namespace, domain2Namespace);\n+\n+  }\n+\n+  private static void updatePropertyFile() {\n+    //create a temporary directory to copy and update the properties file\n+    Path target = Paths.get(PROPS_TEMP_DIR);\n+    Path source1 = Paths.get(MODEL_DIR, WDT_MODEL_DOMAIN1_PROPS);\n+    Path source2 = Paths.get(MODEL_DIR, WDT_MODEL_DOMAIN2_PROPS);\n+    logger.info(\"Copy the properties file to the above area so that we can add namespace property\");\n+    assertDoesNotThrow(() -> {\n+      Files.createDirectories(target);\n+      Files.copy(source1, target.resolve(source1.getFileName()), StandardCopyOption.REPLACE_EXISTING);\n+      Files.copy(source2, target.resolve(source2.getFileName()), StandardCopyOption.REPLACE_EXISTING);\n+    });\n+\n+    assertDoesNotThrow(() -> {\n+      addNamespaceToPropertyFile(WDT_MODEL_DOMAIN1_PROPS, domain1Namespace);\n+      String.format(\"Failed to update %s with namespace %s\",\n+            WDT_MODEL_DOMAIN1_PROPS, domain1Namespace);\n+    });\n+    assertDoesNotThrow(() -> {\n+      addNamespaceToPropertyFile(WDT_MODEL_DOMAIN2_PROPS, domain2Namespace);\n+      String.format(\"Failed to update %s with namespace %s\",\n+            WDT_MODEL_DOMAIN2_PROPS, domain2Namespace);\n+    });\n+\n+  }\n+\n+  private static void addNamespaceToPropertyFile(String propFileName, String domainNamespace) throws IOException {\n+    FileInputStream in = new FileInputStream(PROPS_TEMP_DIR + \"/\" + propFileName);\n+    Properties props = new Properties();\n+    props.load(in);\n+    in.close();\n+\n+    FileOutputStream out = new FileOutputStream(PROPS_TEMP_DIR + \"/\" + propFileName);\n+    props.setProperty(\"NAMESPACE\", domainNamespace);\n+    props.store(out, null);\n+    out.close();\n+  }\n+\n+  /*\n+   * This test verifies cross domain transaction is successful. domain in image using wdt is used\n+   * to create 2 domains in different namespaces. An app is deployed to both the domains and the servlet\n+   * is invoked which starts a transaction that spans both domains.\n+   */\n+  @Test\n+  @DisplayName(\"Check cross domain transaction works\")\n+  @Slow\n+  @MustNotRunInParallel\n+  public void testCrossDomainTransaction() {\n+\n+    //build application archive\n+\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"txforward\"), null, null,\n+        \"build\", domain1Namespace);\n+    logger.info(\"distDir is {0}\", distDir.toString());\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"txforward.ear\").toFile().exists(),\n+        \"Application archive is not available\");\n+    String appSource = distDir.toString() + \"/txforward.ear\";\n+    logger.info(\"Application is in {0}\", appSource);\n+\n+    // create admin credential secret for domain1\n+    logger.info(\"Create admin credential secret for domain1\");\n+    String domain1AdminSecretName = domainUid1 + \"-weblogic-credentials\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        domain1AdminSecretName, domain1Namespace, ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT),\n+        String.format(\"createSecret %s failed for %s\", domain1AdminSecretName, domainUid1));\n+\n+    // create admin credential secret for domain2\n+    logger.info(\"Create admin credential secret for domain2\");\n+    String domain2AdminSecretName = domainUid2 + \"-weblogic-credentials\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        domain2AdminSecretName, domain2Namespace, ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT),\n+        String.format(\"createSecret %s failed for %s\", domain2AdminSecretName, domainUid2));\n+\n+    //createImageVerify expects the location of the ear file\n+    //String appSource = PV_ROOT + \"/applications/\" + WDT_APP_NAME + \"/\" + WDT_APP_NAME + \".ear\";", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTkyNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365927", "bodyText": "removed the 2 lines", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0MTI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0MzYwMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444343600", "bodyText": "missing copyright", "author": "sankarpn", "createdAt": "2020-06-23T16:12:24Z", "path": "new-integration-tests/src/test/resources/apps/txforward/TxForward/src/example/TxForward.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package example;", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTUzMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365532", "bodyText": "added copyright", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0MzYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjM5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444346398", "bodyText": "missing copyright", "author": "sankarpn", "createdAt": "2020-06-23T16:16:44Z", "path": "new-integration-tests/src/test/resources/apps/txforward/remotesync/src/example/LifecycleListenerImpl.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package example;", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTQyMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365422", "bodyText": "added copyright", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjYxNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444346615", "bodyText": "missing copyright", "author": "sankarpn", "createdAt": "2020-06-23T16:17:06Z", "path": "new-integration-tests/src/test/resources/apps/txforward/remotesync/src/example/RemoteSync.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package example;\r", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTMxNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365317", "bodyText": "added copyright", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjY3NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444346675", "bodyText": "missing copyright", "author": "sankarpn", "createdAt": "2020-06-23T16:17:13Z", "path": "new-integration-tests/src/test/resources/apps/txforward/remotesync/src/example/RemoteSyncImpl.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package example;\r", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTIzOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365239", "bodyText": "done", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjkzMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444346933", "bodyText": "missing copyright", "author": "sankarpn", "createdAt": "2020-06-23T16:17:37Z", "path": "new-integration-tests/src/test/resources/apps/txforward/remotesync/src/example/Utils.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package example;", "originalCommit": "719778266308e622a54a4de72b658317be13816a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM2NTE1Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1738#discussion_r444365156", "bodyText": "done", "author": "bhavaniravichandran", "createdAt": "2020-06-23T16:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjkzMw=="}], "type": "inlineReview"}, {"oid": "99e1e57707c8a8ccbb6d16ce0ad754976236ea9d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/99e1e57707c8a8ccbb6d16ce0ad754976236ea9d", "message": "fixes based on review comments", "committedDate": "2020-06-23T16:46:09Z", "type": "commit"}, {"oid": "f616d5b4131509a10bb4a305068d7c7aa358c45c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f616d5b4131509a10bb4a305068d7c7aa358c45c", "message": "fix teh app distribution dir in the test", "committedDate": "2020-06-23T17:32:27Z", "type": "commit"}]}