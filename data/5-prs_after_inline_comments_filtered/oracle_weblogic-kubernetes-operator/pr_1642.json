{"pr_number": 1642, "pr_title": "Added more checks for LB pods status", "pr_createdAt": "2020-05-12T16:14:30Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642", "timeline": [{"oid": "c6988055a105fb1f7e6c641c45e5b6cb79dc3577", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c6988055a105fb1f7e6c641c45e5b6cb79dc3577", "message": "added debug logs", "committedDate": "2020-05-09T17:23:56Z", "type": "commit"}, {"oid": "ff48ba2377bd02c5e0f5a606526f75f938f4619a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ff48ba2377bd02c5e0f5a606526f75f938f4619a", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into lbtest", "committedDate": "2020-05-09T17:25:13Z", "type": "commit"}, {"oid": "c699a2d2ac20a2806e1c7578cb078dc748e9d1cb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c699a2d2ac20a2806e1c7578cb078dc748e9d1cb", "message": "style", "committedDate": "2020-05-10T02:37:26Z", "type": "commit"}, {"oid": "f0f716a54261e3e22c97e187d476dd39d1560fb9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f0f716a54261e3e22c97e187d476dd39d1560fb9", "message": "style1", "committedDate": "2020-05-11T16:55:49Z", "type": "commit"}, {"oid": "6b9bc07801e7fd0d09fecf1f10eaf58449a1fb8e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6b9bc07801e7fd0d09fecf1f10eaf58449a1fb8e", "message": "added sync to update method", "committedDate": "2020-05-11T19:45:55Z", "type": "commit"}, {"oid": "58ee82f540e3d2c61b9953d6dbc4cb4f32479397", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/58ee82f540e3d2c61b9953d6dbc4cb4f32479397", "message": " added check for terminated state", "committedDate": "2020-05-11T22:55:13Z", "type": "commit"}, {"oid": "d935149bd3e5769387afa204f59141a105c2d807", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d935149bd3e5769387afa204f59141a105c2d807", "message": " added check for terminated state1", "committedDate": "2020-05-11T23:22:26Z", "type": "commit"}, {"oid": "87a3a520cdcf41e78d423778929b4d0931613d01", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/87a3a520cdcf41e78d423778929b4d0931613d01", "message": "corrected ingress check", "committedDate": "2020-05-12T02:47:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NzU1Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r423877556", "bodyText": "reliable way to check a pod is restarted is by comparing the pod creation timestamp that is captured before upgrade and pod creation timestamp after upgrade ...please change this logic", "author": "vanajamukkara", "createdAt": "2020-05-12T16:39:24Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java", "diffHunk": "@@ -150,10 +150,26 @@ private void upgradeTraefikNamespace() throws Exception {\n     LoggerHelper.getLocal().log(Level.INFO, \" upgradeTraefikNamespace() Running \" + cmd.toString());\n     ExecResult result = ExecCommand.exec(cmd.toString());\n     if (result.exitValue() != 0) {\n+      TestUtils.checkHelmChart(\"traefik-operator\",\"traefik\");\n       reportHelmInstallFailure(cmd.toString(), result);\n     }\n     String outputStr = result.stdout().trim();\n     LoggerHelper.getLocal().log(Level.INFO, \"Command returned \" + outputStr);\n+    int i = 0;\n+    //wait until pod is restarted after upgrade and check the status\n+    String traefikPod = TestUtils.getPodName(\" -l app=traefik \", \"traefik\");\n+    cmd = new StringBuffer();\n+    cmd.append(\"kubectl get pod -n traefik\");\n+    while (i < maxIterationsPod) {\n+      if (TestUtils.checkPodContains(cmd.toString(), \"Terminating\", traefikPod)) {", "originalCommit": "87a3a520cdcf41e78d423778929b4d0931613d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg5MDI1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r423890257", "bodyText": "Also check the status of the release after upgrade", "author": "vanajamukkara", "createdAt": "2020-05-12T16:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NzU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MTc2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r424551763", "bodyText": "traefik (voyager) pod at same cases terminates and restarted in others it does not, after adding check for creation timestamp some tests failed because timestamp check ( so I removed it back). Added status of release check", "author": "marinakog", "createdAt": "2020-05-13T15:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NzU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3OTk1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425179959", "bodyText": "I checked with Ryan, he said traefik pod should not be getting restarted after upgrade. You can remove the check you have here for pod restart.", "author": "vanajamukkara", "createdAt": "2020-05-14T14:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NzU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4OTI5Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425489296", "bodyText": "the traffic pod in some cases get restarted, keeping the check", "author": "marinakog", "createdAt": "2020-05-14T23:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NzU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg4MjUzNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r423882537", "bodyText": "have you verified that this method is not getting called by multiple tests at the same time in parallel runs after adding this?", "author": "vanajamukkara", "createdAt": "2020-05-12T16:47:07Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java", "diffHunk": "@@ -131,7 +131,7 @@ private void createTraefikIngressPerDomain() throws Exception {\n     createTraefikIngress();\n   }\n \n-  private void upgradeTraefikNamespace() throws Exception {\n+  private synchronized void upgradeTraefikNamespace() throws Exception {", "originalCommit": "87a3a520cdcf41e78d423778929b4d0931613d01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU1MjA5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r424552099", "bodyText": "yes", "author": "marinakog", "createdAt": "2020-05-13T15:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg4MjUzNw=="}], "type": "inlineReview"}, {"oid": "dc923f78b094159f989270f8493378771906133e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/dc923f78b094159f989270f8493378771906133e", "message": "added timestamp check", "committedDate": "2020-05-12T21:37:04Z", "type": "commit"}, {"oid": "107580b3f7eeb9710652b016ef3bd42cf8c6b1cb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/107580b3f7eeb9710652b016ef3bd42cf8c6b1cb", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into lbtest", "committedDate": "2020-05-12T21:37:21Z", "type": "commit"}, {"oid": "026ab57f999085eb840f1d1480d82c83a6d7607e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/026ab57f999085eb840f1d1480d82c83a6d7607e", "message": "style", "committedDate": "2020-05-13T01:25:35Z", "type": "commit"}, {"oid": "94f464b4c5cf113e0c6d7c819c62ea2c51bdda20", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/94f464b4c5cf113e0c6d7c819c62ea2c51bdda20", "message": "added check LB to domain", "committedDate": "2020-05-13T01:46:10Z", "type": "commit"}, {"oid": "6a2dccd29deb8ff9375807415b8aaeaea18df987", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6a2dccd29deb8ff9375807415b8aaeaea18df987", "message": "added extra info", "committedDate": "2020-05-13T01:49:55Z", "type": "commit"}, {"oid": "fdcf24d00a26a550b4ad31fcc8c95a4a907432ca", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fdcf24d00a26a550b4ad31fcc8c95a4a907432ca", "message": "fixed style", "committedDate": "2020-05-13T04:01:50Z", "type": "commit"}, {"oid": "9552d2c9c1afbfa51a09dc1ce2c794af6fcc7d66", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9552d2c9c1afbfa51a09dc1ce2c794af6fcc7d66", "message": "removed chek creationtime", "committedDate": "2020-05-13T04:24:19Z", "type": "commit"}, {"oid": "466a57cc627ad418af9f2c63b65a7a8e4430a822", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/466a57cc627ad418af9f2c63b65a7a8e4430a822", "message": "removed chek creationtime1", "committedDate": "2020-05-13T04:31:57Z", "type": "commit"}, {"oid": "6fe23d9a74492caff097c22a68f7b5fa8947520c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6fe23d9a74492caff097c22a68f7b5fa8947520c", "message": "cleaned commented out code", "committedDate": "2020-05-13T15:57:20Z", "type": "commit"}, {"oid": "a9ae3cf8c7b07ac629acbd1756a8bdce0cf33d56", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a9ae3cf8c7b07ac629acbd1756a8bdce0cf33d56", "message": "added get values", "committedDate": "2020-05-13T16:30:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5NDk5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425194993", "bodyText": "I think this is only for debugging..you can also check the ingress as well and do TestUtils.checkPodReadyAndRunning(traefikPod, \"traefik\") before helmcheck", "author": "vanajamukkara", "createdAt": "2020-05-14T14:46:52Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/Domain.java", "diffHunk": "@@ -806,7 +806,9 @@ public void callWebAppAndVerifyLoadBalancing(String webappName, boolean verifyLo\n \n       LoggerHelper.getLocal().log(Level.INFO, \"Curl cmd with response code \" + curlCmdResCode);\n       LoggerHelper.getLocal().log(Level.INFO, \"Curl cmd \" + curlCmd);\n-\n+      //check helm status\n+      String lbName = getLoadBalancerName().toLowerCase();\n+      TestUtils.checkHelmChart(lbName + \"-operator\", lbName);", "originalCommit": "a9ae3cf8c7b07ac629acbd1756a8bdce0cf33d56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4OTA1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425489052", "bodyText": "added", "author": "marinakog", "createdAt": "2020-05-14T23:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5NDk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5NTkxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425195912", "bodyText": "you can remove this too", "author": "vanajamukkara", "createdAt": "2020-05-14T14:48:08Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/LoadBalancer.java", "diffHunk": "@@ -291,8 +319,25 @@ private void upgradeVoyagerNamespace() throws Exception {\n     }\n \n     if (null == returnStr) {\n-      executeHelmCommand(cmd.toString());\n+      executeHelmCommand(cmd.toString(), \"voyager-operator\",\"voyager\");\n     }\n+    //check release status\n+    String helmCmd = \"helm status voyager-operator --namespace voyager\";\n+    TestUtils.checkAnyCmdInLoop(helmCmd, \"deployed\");\n+    i = 0;\n+    //wait until pod is restarted after upgrade and check the status", "originalCommit": "a9ae3cf8c7b07ac629acbd1756a8bdce0cf33d56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ4OTEzNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r425489134", "bodyText": "corrected msg", "author": "marinakog", "createdAt": "2020-05-14T23:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5NTkxMg=="}], "type": "inlineReview"}, {"oid": "4cb4810c8749561106628ac611548e63136b5440", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4cb4810c8749561106628ac611548e63136b5440", "message": "merge", "committedDate": "2020-05-14T16:53:08Z", "type": "commit"}, {"oid": "84c3388609388aea19a64308efa1ea3c2be94898", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/84c3388609388aea19a64308efa1ea3c2be94898", "message": "added log collection", "committedDate": "2020-05-14T18:10:33Z", "type": "commit"}, {"oid": "d0aedbafb0e12a108a7844d2e1946b5c63679d41", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d0aedbafb0e12a108a7844d2e1946b5c63679d41", "message": "style", "committedDate": "2020-05-14T18:22:20Z", "type": "commit"}, {"oid": "6c9381018b628f7283b1a85af0848fc80c16451d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6c9381018b628f7283b1a85af0848fc80c16451d", "message": "fixed typo", "committedDate": "2020-05-14T20:12:38Z", "type": "commit"}, {"oid": "2ac84c7b2ab33a2509d93bb5fc4fced790a619e2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2ac84c7b2ab33a2509d93bb5fc4fced790a619e2", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into lbtest", "committedDate": "2020-05-14T23:04:29Z", "type": "commit"}, {"oid": "fec238e8e61e11977a6c2d6502ca0acfc15f91d0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fec238e8e61e11977a6c2d6502ca0acfc15f91d0", "message": "added more status collection", "committedDate": "2020-05-15T19:53:23Z", "type": "commit"}, {"oid": "1d6320ae795cb8f071bd2940b219d2ed28732fc8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1d6320ae795cb8f071bd2940b219d2ed28732fc8", "message": "typo", "committedDate": "2020-05-15T20:20:31Z", "type": "commit"}, {"oid": "ac00c40ebe370fd86e8587c398a3e8d4ed9c3646", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ac00c40ebe370fd86e8587c398a3e8d4ed9c3646", "message": "typo1", "committedDate": "2020-05-15T20:31:23Z", "type": "commit"}, {"oid": "add01fcc79af9ded5062ba84aad35b2a23609253", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/add01fcc79af9ded5062ba84aad35b2a23609253", "message": "fixed logic for lb", "committedDate": "2020-05-16T00:20:45Z", "type": "commit"}, {"oid": "67d46fd93eb5880e47cd90f0ba48fdd987f562f6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/67d46fd93eb5880e47cd90f0ba48fdd987f562f6", "message": "fixed style", "committedDate": "2020-05-16T00:59:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwOTMwMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r426209302", "bodyText": "it's an ingress controller, not a load balancer. just a note - no need to change it", "author": "markxnelson", "createdAt": "2020-05-17T02:19:59Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/Domain.java", "diffHunk": "@@ -814,7 +814,8 @@ public void callWebAppAndVerifyLoadBalancing(String webappName, boolean verifyLo\n \n       LoggerHelper.getLocal().log(Level.INFO, \"Curl cmd with response code \" + curlCmdResCode);\n       LoggerHelper.getLocal().log(Level.INFO, \"Curl cmd \" + curlCmd);\n-\n+      //check helm status\n+      checkLoadBalancer();", "originalCommit": "67d46fd93eb5880e47cd90f0ba48fdd987f562f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwOTM5MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r426209390", "bodyText": "expr is a poor choice of name", "author": "markxnelson", "createdAt": "2020-05-17T02:21:06Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/TestUtils.java", "diffHunk": "@@ -2181,4 +2210,107 @@ public static String getDeletionTimestamp(String namespace, String pod) throws E\n     ExecResult result = ExecCommand.exec(kcmd);\n     return result.stdout().trim();\n   }\n+\n+  /**\n+   * Check the expected status for provided helm chart.\n+   *\n+   * @param chartName  helm chart name\n+   * @param chartNS helm chart namespace\n+   * @param expr expected status", "originalCommit": "67d46fd93eb5880e47cd90f0ba48fdd987f562f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwOTQyOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1642#discussion_r426209429", "bodyText": "you are not returning anything from this method, so \"retrieve info\" seems incorrect", "author": "markxnelson", "createdAt": "2020-05-17T02:21:49Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/TestUtils.java", "diffHunk": "@@ -2181,4 +2210,107 @@ public static String getDeletionTimestamp(String namespace, String pod) throws E\n     ExecResult result = ExecCommand.exec(kcmd);\n     return result.stdout().trim();\n   }\n+\n+  /**\n+   * Check the expected status for provided helm chart.\n+   *\n+   * @param chartName  helm chart name\n+   * @param chartNS helm chart namespace\n+   * @param expr expected status\n+   * @throws Exception if expected status not found.\n+   */\n+  public static void checkHelmChartStatus(String chartName, String chartNS, String expr) throws Exception {\n+    String cmd = \"helm status \" + chartName + \" --namespace \" + chartNS;\n+    ExecResult result = ExecCommand.exec(cmd);\n+    checkCmdInLoop(cmd, expr, chartName);\n+  }\n+\n+  /**\n+   * Retrieve info for provided helm chart.", "originalCommit": "67d46fd93eb5880e47cd90f0ba48fdd987f562f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f28263d0516ce1da2adbf35c436cb2706dae49a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6f28263d0516ce1da2adbf35c436cb2706dae49a", "message": "corrected var and method naming", "committedDate": "2020-05-17T17:17:24Z", "type": "commit"}, {"oid": "44843e27e124f30d37bfe5fc550e112c60d9a32c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/44843e27e124f30d37bfe5fc550e112c60d9a32c", "message": "modified getpodname to return last created pod based on searchexp", "committedDate": "2020-05-17T18:32:57Z", "type": "commit"}]}