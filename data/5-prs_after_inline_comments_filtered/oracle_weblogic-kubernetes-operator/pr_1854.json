{"pr_number": 1854, "pr_title": "Retry failure fix", "pr_createdAt": "2020-08-06T18:17:02Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854", "timeline": [{"oid": "b6f680eda269c527aa33422f8128966308981b6d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b6f680eda269c527aa33422f8128966308981b6d", "message": "update from develop", "committedDate": "2020-07-01T19:55:24Z", "type": "commit"}, {"oid": "83afa23a615028e986f2c43ce00e16487e981acb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/83afa23a615028e986f2c43ce00e16487e981acb", "message": "update from develop", "committedDate": "2020-07-01T19:55:35Z", "type": "commit"}, {"oid": "14866ebad7cf05c33209951d4afea07d1763080a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/14866ebad7cf05c33209951d4afea07d1763080a", "message": "change log message", "committedDate": "2020-07-02T14:15:45Z", "type": "commit"}, {"oid": "208324d6b5ead54d0d5eb3642f15527f943edec5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/208324d6b5ead54d0d5eb3642f15527f943edec5", "message": "Initial check in for JRF Fatal error fix", "committedDate": "2020-07-05T00:58:46Z", "type": "commit"}, {"oid": "a66911f809ac452fc83bc0b7fe77bba55f246f0d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a66911f809ac452fc83bc0b7fe77bba55f246f0d", "message": "remove test for now", "committedDate": "2020-07-05T14:15:35Z", "type": "commit"}, {"oid": "dd006942ebae1c3be56b6c51a83354ca38c2f5e5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/dd006942ebae1c3be56b6c51a83354ca38c2f5e5", "message": "Fix logic", "committedDate": "2020-07-05T19:40:21Z", "type": "commit"}, {"oid": "8522acca008949f4173033e3f0eeca80c971db7d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8522acca008949f4173033e3f0eeca80c971db7d", "message": "merge from develop", "committedDate": "2020-07-13T17:42:40Z", "type": "commit"}, {"oid": "1201c586b7fc25bc8b6d9919a8b78c5b9dac4b61", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1201c586b7fc25bc8b6d9919a8b78c5b9dac4b61", "message": "add info for create jrf domain and remove obsolete constants", "committedDate": "2020-07-13T19:23:02Z", "type": "commit"}, {"oid": "80dd3c8e075c69a20251f14ed91f22e93502e1a4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/80dd3c8e075c69a20251f14ed91f22e93502e1a4", "message": "add comment", "committedDate": "2020-07-14T18:41:43Z", "type": "commit"}, {"oid": "1f8dbead2e3dd2dcad9d6bd4cb12ee19dc6e070a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1f8dbead2e3dd2dcad9d6bd4cb12ee19dc6e070a", "message": "relax retry and update comments", "committedDate": "2020-07-14T19:15:55Z", "type": "commit"}, {"oid": "9f40583add3ded2713769815c2b00af32ff8ca17", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9f40583add3ded2713769815c2b00af32ff8ca17", "message": "change comments", "committedDate": "2020-07-15T14:01:42Z", "type": "commit"}, {"oid": "086a4d8fb8cdbe2fc5437f23d951cc22fca361ff", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/086a4d8fb8cdbe2fc5437f23d951cc22fca361ff", "message": "change info text", "committedDate": "2020-07-17T17:11:47Z", "type": "commit"}, {"oid": "d710ac0aa43889eb170c04e9eebac8d38b7efe80", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d710ac0aa43889eb170c04e9eebac8d38b7efe80", "message": "minor text change", "committedDate": "2020-07-17T17:51:14Z", "type": "commit"}, {"oid": "d9f4e682d737c34040926fbad2cb931624e38e81", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d9f4e682d737c34040926fbad2cb931624e38e81", "message": "Add retry count to domain status and support retryCountMax", "committedDate": "2020-07-30T21:35:26Z", "type": "commit"}, {"oid": "690dac56804555b5dd763b6384132ca906efb993", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/690dac56804555b5dd763b6384132ca906efb993", "message": "Merge branch 'develop' into retry-failure-fix", "committedDate": "2020-08-04T13:09:53Z", "type": "commit"}, {"oid": "ee1e3181077e0c4b262ea48e029990c34f2ad211", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee1e3181077e0c4b262ea48e029990c34f2ad211", "message": "Merge branch 'develop' into OWLS-83019-JRF-Introspect", "committedDate": "2020-08-04T19:05:13Z", "type": "commit"}, {"oid": "1628ae1d1f993a718a66b81f697622a93eff81ce", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1628ae1d1f993a718a66b81f697622a93eff81ce", "message": "Merge branch 'OWLS-83019-JRF-Introspect' into retry-failure-fix", "committedDate": "2020-08-04T19:50:46Z", "type": "commit"}, {"oid": "affb71754efc1c891eaf168160fb0cf9ee3a571d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/affb71754efc1c891eaf168160fb0cf9ee3a571d", "message": "increment retry count only if there is an error message", "committedDate": "2020-08-04T20:35:46Z", "type": "commit"}, {"oid": "27e4e00d4e67eb3834ed2ef524370d829bce5102", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/27e4e00d4e67eb3834ed2ef524370d829bce5102", "message": "doc update", "committedDate": "2020-08-04T20:36:26Z", "type": "commit"}, {"oid": "20c0c157b0f8f7063d639138a54494ee638b4c59", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/20c0c157b0f8f7063d639138a54494ee638b4c59", "message": "Merge branch 'develop' into retry-failure-fix", "committedDate": "2020-08-06T13:16:53Z", "type": "commit"}, {"oid": "04612f4ff77cbb2984b8dd176d009d3178d48386", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/04612f4ff77cbb2984b8dd176d009d3178d48386", "message": "use existing error for increment", "committedDate": "2020-08-06T15:39:42Z", "type": "commit"}, {"oid": "5fcfc9bf03159407fb8f8f82e541850dde03ba2a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5fcfc9bf03159407fb8f8f82e541850dde03ba2a", "message": "Log message change", "committedDate": "2020-08-06T18:00:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTM3Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r469251376", "bodyText": "Is there a way we can return a fatal error more clearly? It seems brittle to rely on a specific string like this.", "author": "rjeberhard", "createdAt": "2020-08-12T13:17:19Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -630,10 +631,31 @@ public boolean wasInspectionRun() {\n \n     private boolean isShouldContinue() {\n       DomainPresenceInfo cachedInfo = getExistingDomainPresenceInfo(getNamespace(), getDomainUid());\n+      int currentRetryCount = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getRetryCount)\n+          .orElse(0);\n+\n+      String existingError = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getMessage)\n+          .orElse(null);\n+\n       if (cachedInfo == null || cachedInfo.getDomain() == null) {\n         return true;\n+      } else if (currentRetryCount > DomainPresence.getDomainPresenceFailureRetryMaxCount()) {\n+        LOGGER.fine(\"Stop introspection retry - exceeded configured domainPresenceFailureRetryMaxCount: \"\n+            + DomainPresence.getDomainPresenceFailureRetryMaxCount());\n+        return false;\n       } else if (isCachedInfoNewer(liveInfo, cachedInfo)) {\n         return false;  // we have already cached this\n+      } else if (existingError != null && existingError.startsWith(\"MII Fatal Error\")", "originalCommit": "5fcfc9bf03159407fb8f8f82e541850dde03ba2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyMzUzMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r469323530", "bodyText": "I don't see how to eliminate dependence on string parsing, but to make it less specific to MII and maybe a bit less brittle, perhaps use 'contains' instead of 'starts' and look for a string like 'FatalIntrospectorError'?  What do you think @rjeberhard ?", "author": "tbarnes-us", "createdAt": "2020-08-12T14:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMzMTA4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r469331084", "bodyText": "That would be okay, but my expectation is that the introspector is returning structured data, of which the error message is one value. The least brittle would be if there was a value for \"isFatalError\" or \"isPermanentFailure\". However, I'm okay with something like what you propose.", "author": "rjeberhard", "createdAt": "2020-08-12T15:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ1ODEzMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r472458133", "bodyText": "I changed it to contains \"FatalIntrospectorError\". Eventually If we can change the introspect job and operator java code has a more flexible way to communicate other than just a return code, then we can experiment the idea of always return 0 but have some text that gives more structured data.", "author": "jshum2479", "createdAt": "2020-08-18T20:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MzgxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r469253813", "bodyText": "This PR is missing behavior that resets the retry count on introspectVersion or other changes.", "author": "rjeberhard", "createdAt": "2020-08-12T13:20:57Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -630,10 +631,31 @@ public boolean wasInspectionRun() {\n \n     private boolean isShouldContinue() {\n       DomainPresenceInfo cachedInfo = getExistingDomainPresenceInfo(getNamespace(), getDomainUid());\n+      int currentRetryCount = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getRetryCount)\n+          .orElse(0);\n+\n+      String existingError = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getMessage)\n+          .orElse(null);\n+\n       if (cachedInfo == null || cachedInfo.getDomain() == null) {\n         return true;\n+      } else if (currentRetryCount > DomainPresence.getDomainPresenceFailureRetryMaxCount()) {", "originalCommit": "5fcfc9bf03159407fb8f8f82e541850dde03ba2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NzQ4MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r472397480", "bodyText": "There is a reset now", "author": "jshum2479", "createdAt": "2020-08-18T18:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MzgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMzMzg3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r469333878", "bodyText": "Is it only introspection failures that cause a limited number of retries, or there other types of validation failures?  If so, then the wording is misleading.\nShould the text say 'domain.spec.retryCount' instead of 'domainPresenceFailureRetryMaxCount'?", "author": "tbarnes-us", "createdAt": "2020-08-12T15:12:04Z", "path": "operator/src/main/java/oracle/kubernetes/operator/DomainProcessorImpl.java", "diffHunk": "@@ -630,10 +631,31 @@ public boolean wasInspectionRun() {\n \n     private boolean isShouldContinue() {\n       DomainPresenceInfo cachedInfo = getExistingDomainPresenceInfo(getNamespace(), getDomainUid());\n+      int currentRetryCount = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getRetryCount)\n+          .orElse(0);\n+\n+      String existingError = Optional.ofNullable(liveInfo)\n+          .map(DomainPresenceInfo::getDomain)\n+          .map(Domain::getStatus)\n+          .map(DomainStatus::getMessage)\n+          .orElse(null);\n+\n       if (cachedInfo == null || cachedInfo.getDomain() == null) {\n         return true;\n+      } else if (currentRetryCount > DomainPresence.getDomainPresenceFailureRetryMaxCount()) {\n+        LOGGER.fine(\"Stop introspection retry - exceeded configured domainPresenceFailureRetryMaxCount: \"\n+            + DomainPresence.getDomainPresenceFailureRetryMaxCount());", "originalCommit": "5fcfc9bf03159407fb8f8f82e541850dde03ba2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxMDU5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r472410595", "bodyText": "The max count actually is an operator tuning parameter not in domain spec", "author": "jshum2479", "createdAt": "2020-08-18T18:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMzMzg3OA=="}], "type": "inlineReview"}, {"oid": "1e556114d6f8b3564ed1d67eb133dc3d671beaae", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1e556114d6f8b3564ed1d67eb133dc3d671beaae", "message": "rename retryCount to introspectJobFailureRetryCount", "committedDate": "2020-08-13T18:05:49Z", "type": "commit"}, {"oid": "d9a16a28a9d448d66876b5fd05734b807d0dc402", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d9a16a28a9d448d66876b5fd05734b807d0dc402", "message": "Add logging for retry counter", "committedDate": "2020-08-17T21:39:16Z", "type": "commit"}, {"oid": "57de2eac27b69daccaa96dae84bfb39fd2ddc4f0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/57de2eac27b69daccaa96dae84bfb39fd2ddc4f0", "message": "Fix NPE in unit test", "committedDate": "2020-08-17T23:27:37Z", "type": "commit"}, {"oid": "71baf527f1c9cdcbaedea64e7c521d18eabb56cc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/71baf527f1c9cdcbaedea64e7c521d18eabb56cc", "message": "merge from develop", "committedDate": "2020-08-18T02:49:42Z", "type": "commit"}, {"oid": "70202a2f2e3a10adc17971a1bac85227a9229bd3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/70202a2f2e3a10adc17971a1bac85227a9229bd3", "message": "Minor refactoring", "committedDate": "2020-08-18T03:46:11Z", "type": "commit"}, {"oid": "599e20e2783abe1d3f3cd5884be6488e6a6ec616", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/599e20e2783abe1d3f3cd5884be6488e6a6ec616", "message": "refactor code", "committedDate": "2020-08-18T14:56:50Z", "type": "commit"}, {"oid": "baaf912f7709c3ff0fbc8bc7c9b17703ced9a0ff", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/baaf912f7709c3ff0fbc8bc7c9b17703ced9a0ff", "message": "update description of field", "committedDate": "2020-08-18T18:21:53Z", "type": "commit"}, {"oid": "b4eb89ebedc17dc99453620e8d1d2c798b49883b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b4eb89ebedc17dc99453620e8d1d2c798b49883b", "message": "changing description texts", "committedDate": "2020-08-18T18:51:48Z", "type": "commit"}, {"oid": "3bcb0ffba7fb693bb4bc401eed5a14f1ff364e12", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3bcb0ffba7fb693bb4bc401eed5a14f1ff364e12", "message": "missed files", "committedDate": "2020-08-18T18:52:10Z", "type": "commit"}, {"oid": "ee62903f2407ba1c6a124780140f37014f9093c4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee62903f2407ba1c6a124780140f37014f9093c4", "message": "change \"MII Fatal Error\" to \"FatalIntrospectorError\"", "committedDate": "2020-08-18T20:12:11Z", "type": "commit"}, {"oid": "73a7dd01d7945f23f8729709bc82912ab7de35b7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/73a7dd01d7945f23f8729709bc82912ab7de35b7", "message": "default failure retry count should be 0", "committedDate": "2020-08-19T11:39:53Z", "type": "commit"}, {"oid": "cd31afa4f4c0c8b995f2a80e10cf96471d03915c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cd31afa4f4c0c8b995f2a80e10cf96471d03915c", "message": "change comparing failure retry count gte", "committedDate": "2020-08-19T18:22:02Z", "type": "commit"}, {"oid": "24987da2dc2a8728e6d8dd610a621cc610c8d24e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/24987da2dc2a8728e6d8dd610a621cc610c8d24e", "message": "Merge branch 'develop' into retry-failure-fix", "committedDate": "2020-09-04T14:10:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5NzUzNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r483097535", "bodyText": "(1) Rename to: IntrospectorJobFailureCount\n(2) Change text to:  \"The IntrospectorJobFailureCount is non-zero if introspector has failed.  Configure the maximum retry count using operator tuning parameter XXX.\"  (Look in our documentation to get the official name for 'operator tuning parameter'.)\n(3) Modify the documentation for operator tuning parameters if needed.  For example, remove documentation for the (ignored) interval setting.", "author": "tbarnes-us", "createdAt": "2020-09-03T16:13:28Z", "path": "operator/src/main/java/oracle/kubernetes/weblogic/domain/model/DomainStatus.java", "diffHunk": "@@ -276,6 +284,45 @@ public DomainStatus withReplicas(Integer replicas) {\n     return this;\n   }\n \n+  /**\n+   * The number of retries for an introspect job that fails.\n+   *\n+   * @return introspectJobFailureRetryCount\n+   */\n+  public Integer getIntrospectJobFailureRetryCount() {", "originalCommit": "cd31afa4f4c0c8b995f2a80e10cf96471d03915c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExMDY2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1854#discussion_r487110666", "bodyText": "done", "author": "jshum2479", "createdAt": "2020-09-11T15:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA5NzUzNQ=="}], "type": "inlineReview"}, {"oid": "92714964cc03b8c161536d0a28fc049d6974deba", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/92714964cc03b8c161536d0a28fc049d6974deba", "message": "rename introspectJobFailureRetryCount field, reset counter if succcessful, and log before retry.", "committedDate": "2020-09-08T15:36:01Z", "type": "commit"}, {"oid": "4420081246696db3de99a4eaea16f87bda3324ef", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4420081246696db3de99a4eaea16f87bda3324ef", "message": "Internationalize message and move logging to start of retry", "committedDate": "2020-09-08T23:56:31Z", "type": "commit"}, {"oid": "9394b89633d08666d701708eb41a1dcb5b860c70", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9394b89633d08666d701708eb41a1dcb5b860c70", "message": "update message", "committedDate": "2020-09-09T08:48:49Z", "type": "commit"}, {"oid": "2903e077c08b8fbb78d3c908d864bef85da69a1e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2903e077c08b8fbb78d3c908d864bef85da69a1e", "message": "update message text", "committedDate": "2020-09-09T17:17:14Z", "type": "commit"}, {"oid": "70c132fe558602e22fb4d348c63c4453e6bb0c18", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/70c132fe558602e22fb4d348c63c4453e6bb0c18", "message": "Merge remote-tracking branch 'origin/develop' into retry-failure-fix", "committedDate": "2020-09-17T15:04:45Z", "type": "commit"}]}