{"pr_number": 1904, "pr_title": "fix build application not to assert exec false exit value", "pr_createdAt": "2020-09-04T15:40:47Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904", "timeline": [{"oid": "ed9424bb270e6fb58eecd199237f7305f59cdb0c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ed9424bb270e6fb58eecd199237f7305f59cdb0c", "message": "fix build application not to assert exec false exit valuae", "committedDate": "2020-09-03T21:52:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483715418", "bodyText": "why can't the check be done in this method instead of changing all the calling It test classes?", "author": "vanajamukkara", "createdAt": "2020-09-04T16:04:21Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/BuildApplication.java", "diffHunk": "@@ -174,8 +175,14 @@ public static Path buildApplication(Path appSrcPath, Map<String, String> antPara\n       if (exec.stderr() != null) {\n         logger.info(\"Exec stderr {0}\", exec.stderr());\n       }\n-      assertEquals(0, exec.exitValue(), \"Exec into \" + webLogicPod.getMetadata().getName()\n-          + \" to build an application failed with exit value \" + exec.exitValue());\n+\n+      // Exec returns a non-zero return code intermittently even when the application builds\n+      // successfully. This seems to be an issue with io.kubernetes.client.Exec.java. So, Commenting\n+      // this assertion for now. it is now the responsibility of the It test class\n+      // to assert the application exists before continuing with the test.", "originalCommit": "ed9424bb270e6fb58eecd199237f7305f59cdb0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0MjkxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483742913", "bodyText": "The source application might build more than 1 archive and we don't know what file name it will be, so it is better to leave it to the It class to do that.", "author": "sankarpn", "createdAt": "2020-09-04T16:48:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MDQ1NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483750455", "bodyText": "what is the stderr when it returns non-zero on success?", "author": "vanajamukkara", "createdAt": "2020-09-04T17:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MzU0OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483753548", "bodyText": "I see the stderr is empty when it returns non-zero code on success, how about checking for 0 exit value or (non-zero and stderr is empty) for success? on failure, stderr is not empty, is that correct?\nhttps://build.weblogick8s.org:8443/job/wko-kind-nightly/95/artifact/logdir/jenkins-wko-kind-nightly-95/wl_k8s_test_results/diagnosticlogs/ItCrossDomainTransaction/ItCrossDomainTransaction.out/*view*/", "author": "vanajamukkara", "createdAt": "2020-09-04T17:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1OTI4Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483759287", "bodyText": "I don't know if we can rely on that logic. IMO a simple assertion in the It class would be sufficient. Like this\nassertTrue(clusterViewAppPath.toFile().exists(), \"Application archive is not available\");", "author": "sankarpn", "createdAt": "2020-09-04T17:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2MzA2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483763060", "bodyText": "Is that check done in all the existing it classes which calls this method? If not, that needs to be done in the It classes as part of this PR as this assertion is removed here, otherwise tests will proceed even if the application build fails.", "author": "vanajamukkara", "createdAt": "2020-09-04T17:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MTc1NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483771754", "bodyText": "Only 1 class was missing the assert. Added the assertion in ItManagedCoherence.java", "author": "sankarpn", "createdAt": "2020-09-04T17:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTkxMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483715911", "bodyText": "doesn't the copy files/dir from pod fail if the build is not successful?", "author": "vanajamukkara", "createdAt": "2020-09-04T16:05:19Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/BuildApplication.java", "diffHunk": "@@ -174,8 +175,14 @@ public static Path buildApplication(Path appSrcPath, Map<String, String> antPara\n       if (exec.stderr() != null) {\n         logger.info(\"Exec stderr {0}\", exec.stderr());\n       }\n-      assertEquals(0, exec.exitValue(), \"Exec into \" + webLogicPod.getMetadata().getName()\n-          + \" to build an application failed with exit value \" + exec.exitValue());\n+\n+      // Exec returns a non-zero return code intermittently even when the application builds\n+      // successfully. This seems to be an issue with io.kubernetes.client.Exec.java. So, Commenting\n+      // this assertion for now. it is now the responsibility of the It test class\n+      // to assert the application exists before continuing with the test.\n+\n+      //assertEquals(0, exec.exitValue(), \"Exec into \" + webLogicPod.getMetadata().getName()\n+      //    + \" to build an application failed with exit value \" + exec.exitValue());\n \n       Kubernetes.copyDirectoryFromPod(webLogicPod,", "originalCommit": "ed9424bb270e6fb58eecd199237f7305f59cdb0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0NDE1Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483744153", "bodyText": "Yes, but that is what we expect right?. Most of  the time what we  see is exit code issue even though build is successful.", "author": "sankarpn", "createdAt": "2020-09-04T16:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTcxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483749710", "bodyText": "Yes, we expect it to fail. So, if the build is not successful, will it fail at this point?", "author": "vanajamukkara", "createdAt": "2020-09-04T17:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTk3NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483749974", "bodyText": "if it fails here, we don't need to add any additional checks in It class", "author": "vanajamukkara", "createdAt": "2020-09-04T17:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2MDUxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1904#discussion_r483760512", "bodyText": "Depends on the source app. If the build failed but created a empty distDir this copy command may not fail. It will simply copy the empty directory to local file system.", "author": "sankarpn", "createdAt": "2020-09-04T17:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNTkxMQ=="}], "type": "inlineReview"}, {"oid": "0f48c92539bd0f9047584203c3382f8c7dedb185", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0f48c92539bd0f9047584203c3382f8c7dedb185", "message": "Asserting that file is available  after build", "committedDate": "2020-09-04T17:53:38Z", "type": "commit"}]}