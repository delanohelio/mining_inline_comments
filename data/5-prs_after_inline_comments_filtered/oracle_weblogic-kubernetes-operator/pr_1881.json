{"pr_number": 1881, "pr_title": " List continuation and watch bookmark support", "pr_createdAt": "2020-08-19T19:40:50Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881", "timeline": [{"oid": "ee2b134611f7e1caa2d739ca8aa0c35c65d10300", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee2b134611f7e1caa2d739ca8aa0c35c65d10300", "message": "Allow watch bookmarks", "committedDate": "2020-08-13T14:53:32Z", "type": "commit"}, {"oid": "a98a366a0fb572cebdc4e774fdbcdd909a3660ab", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a98a366a0fb572cebdc4e774fdbcdd909a3660ab", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-08-13T21:25:12Z", "type": "commit"}, {"oid": "8056b4561673aeadbebe839f677abcb01d92e0cb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8056b4561673aeadbebe839f677abcb01d92e0cb", "message": "Work in progress", "committedDate": "2020-08-17T13:12:10Z", "type": "commit"}, {"oid": "6ea68747ff84f7d1b051d99ea3a9caf00e726774", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6ea68747ff84f7d1b051d99ea3a9caf00e726774", "message": "Work in progress", "committedDate": "2020-08-17T14:26:06Z", "type": "commit"}, {"oid": "5fa913ea7b79a47b01cb41f3fddda37740da1ac2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5fa913ea7b79a47b01cb41f3fddda37740da1ac2", "message": "Work in progress", "committedDate": "2020-08-17T21:51:28Z", "type": "commit"}, {"oid": "a642f8a9eb79ff0519b36a73977857664adae508", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a642f8a9eb79ff0519b36a73977857664adae508", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-08-17T22:11:38Z", "type": "commit"}, {"oid": "a94ab5e04cf4ab540dcc8551140d9b9dc71b96a7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a94ab5e04cf4ab540dcc8551140d9b9dc71b96a7", "message": "Work in progress", "committedDate": "2020-08-18T15:17:18Z", "type": "commit"}, {"oid": "604f41a1f8cf84d2a226c0ec6b88afd947f8efb5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/604f41a1f8cf84d2a226c0ec6b88afd947f8efb5", "message": "AsyncRequestStep tests", "committedDate": "2020-08-18T20:51:04Z", "type": "commit"}, {"oid": "1e3b392b05e22b75df7667ffdf1412b7d9ac5280", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1e3b392b05e22b75df7667ffdf1412b7d9ac5280", "message": "Fix tests", "committedDate": "2020-08-19T15:29:02Z", "type": "commit"}, {"oid": "8a43b855672456797ef8258069625715aacbacf0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8a43b855672456797ef8258069625715aacbacf0", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-08-19T15:45:32Z", "type": "commit"}, {"oid": "af2f2b39372b24899ddd9367b95e429cb9f49ed4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/af2f2b39372b24899ddd9367b95e429cb9f49ed4", "message": "Bookmark tests", "committedDate": "2020-08-19T17:48:30Z", "type": "commit"}, {"oid": "80ddf895486f309b62200ad6b3ebdd5736ba738f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/80ddf895486f309b62200ad6b3ebdd5736ba738f", "message": "Clarify names", "committedDate": "2020-08-19T19:04:18Z", "type": "commit"}, {"oid": "94aafd6aeebe13a99861f4b22077fddc75cd1641", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/94aafd6aeebe13a99861f4b22077fddc75cd1641", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-08-31T12:46:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE1OTk4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r480159985", "bodyText": "I don't understand the name of this test. It seems to be testing that if a watcher receives  a bookmark callback, it updates its resource version for future queries. Is that correct? If so, I'd suggest that the test be named something like, whenWatcherReceivesBookmarkEvent_updateResourceVersion. The current name seems to be talking about what Kubernetes does, not what the operator does.", "author": "russgold", "createdAt": "2020-08-31T14:15:07Z", "path": "operator/src/test/java/oracle/kubernetes/operator/DomainWatcherTest.java", "diffHunk": "@@ -43,6 +45,13 @@ public void initialRequest_specifiesStartingResourceVersion() {\n         hasEntry(\"resourceVersion\", INITIAL_RESOURCE_VERSION.toString()));\n   }\n \n+  @Test", "originalCommit": "94aafd6aeebe13a99861f4b22077fddc75cd1641", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY5NDY5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r485694693", "bodyText": "Changed", "author": "rjeberhard", "createdAt": "2020-09-09T15:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE1OTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2MTkwNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r480161906", "bodyText": "Generally, we've kept the type of watcher generic in the test base. This could simply return Watcher<?> and the unit test could either cast the result or just accept the generic.", "author": "russgold", "createdAt": "2020-08-31T14:18:12Z", "path": "operator/src/test/java/oracle/kubernetes/operator/WatcherTestBase.java", "diffHunk": "@@ -101,10 +105,20 @@ void sendInitialRequest(BigInteger initialResourceVersion) {\n     createAndRunWatcher(NAMESPACE, stopping, initialResourceVersion);\n   }\n \n+  DomainWatcher sendBookmarkRequest(BigInteger initialResourceVersion, String bookmarkResourceVersion) {", "originalCommit": "94aafd6aeebe13a99861f4b22077fddc75cd1641", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2ODMwNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r480168305", "bodyText": "Here you have the retry logic and list continue logic mixed together. It seems to me that they really need to be separate, as a retry and and a continue are orthogonal. You seem to be conditioning the processing of a retry on the presence of a continue token. At the very least, the code is unclear.", "author": "russgold", "createdAt": "2020-08-31T14:28:12Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/ResponseStep.java", "diffHunk": "@@ -92,17 +94,34 @@ private NextAction getPotentialRetryAction(Packet packet) {\n \n   /**\n    * Returns next action that can be used to get the next batch of results from a list search that\n-   * specified a \"continue\" value.\n+   * specified a \"continue\" value, if any; otherwise, returns next.\n    *\n+   * @param callResponse Call response\n    * @param packet Packet\n    * @return Next action for list continue\n    */\n-  protected final NextAction doContinueList(Packet packet) {\n-    RetryStrategy retryStrategy = packet.getSpi(RetryStrategy.class);\n-    if (retryStrategy != null) {\n-      retryStrategy.reset();\n+  protected final NextAction doContinueListOrNext(CallResponse<T> callResponse, Packet packet) {\n+    return doContinueListOrNext(callResponse, packet, getNext());\n+  }\n+", "originalCommit": "94aafd6aeebe13a99861f4b22077fddc75cd1641", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY5NDMzNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r485694336", "bodyText": "I've changed this to try and clarify... I believe that the disconnect is that I see that you implemented a solution in your PR that would iterate until there was no continue token and then present the final list to the response step, but I wanted to present each partial list to the response step. Therefore, the response step needs a mechanism to request the next request. When a new request happens, I do want to reset any failure count that may have been accumulated from the previous request.", "author": "rjeberhard", "createdAt": "2020-09-09T15:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2ODMwNQ=="}], "type": "inlineReview"}, {"oid": "6873ba6627ee082298e7766446d1215d3bbecd08", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6873ba6627ee082298e7766446d1215d3bbecd08", "message": "Work in progress", "committedDate": "2020-08-31T20:25:53Z", "type": "commit"}, {"oid": "b95eccc0283e546e652cd0b52d5ab74ae7c28e05", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b95eccc0283e546e652cd0b52d5ab74ae7c28e05", "message": "Better support for namespace lists spanning REST calls", "committedDate": "2020-08-31T21:50:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTExNTE5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r481115193", "bodyText": "This code is becoming increasingly complex. The coupling between the listNamespace calls and the CRD processing should not be done at this level. One of the great things about the Step/Fiber architecture is that you have those separate steps, and let the code that sets them up define the chain. Putting the dependency directly in the response to the namespace list makes future maintenance ever more difficult.", "author": "russgold", "createdAt": "2020-09-01T12:54:45Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Main.java", "diffHunk": "@@ -369,14 +370,33 @@ private static Step readExistingPods(String ns) {\n   }\n \n   static Step readExistingNamespaces(DomainNamespaceSelectionStrategy selectionStrategy,\n-                                             Collection<String> domainNamespaces,\n-                                             boolean isFullRecheck) {\n+                                     Collection<String> domainNamespaces,\n+                                     boolean isFullRecheck) {\n     CallBuilder builder = new CallBuilder();\n     String selector = selectionStrategy.getLabelSelector();\n     if (selector != null) {\n       builder.withLabelSelectors(selector);\n     }\n-    return builder.listNamespaceAsync(new NamespaceListStep(selectionStrategy, domainNamespaces, isFullRecheck));\n+    return builder.listNamespaceAsync(", "originalCommit": "b95eccc0283e546e652cd0b52d5ab74ae7c28e05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4OTI4OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r485189288", "bodyText": "That's fair, but the complexity here really isn't new -- I just moved this code here. I'll see if I can separate them.", "author": "rjeberhard", "createdAt": "2020-09-08T20:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTExNTE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY4NzE4Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r485687186", "bodyText": "Okay, I pulled the CRD steps out separately and earlier in the overall flow.", "author": "rjeberhard", "createdAt": "2020-09-09T15:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTExNTE5Mw=="}], "type": "inlineReview"}, {"oid": "a933fb484a6e46682a01adabb3aec67549300d7b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a933fb484a6e46682a01adabb3aec67549300d7b", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-02T13:01:24Z", "type": "commit"}, {"oid": "61b5ba91fb71cf9d8273c2afb9e47787ad9740bd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/61b5ba91fb71cf9d8273c2afb9e47787ad9740bd", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-02T19:48:11Z", "type": "commit"}, {"oid": "39ae62967421f78e9fa2f0cb288ce59affad9ab6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/39ae62967421f78e9fa2f0cb288ce59affad9ab6", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-03T22:18:32Z", "type": "commit"}, {"oid": "5cf233511cce345965d9f21577f1887ab066e2ae", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5cf233511cce345965d9f21577f1887ab066e2ae", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-04T17:43:09Z", "type": "commit"}, {"oid": "c5c93f4c60614309cac6d1b59468950cc5374861", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c5c93f4c60614309cac6d1b59468950cc5374861", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-04T23:22:14Z", "type": "commit"}, {"oid": "608af60efb940732eb7d6d5320e7787b2c3eba53", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/608af60efb940732eb7d6d5320e7787b2c3eba53", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-08T14:19:59Z", "type": "commit"}, {"oid": "cf467956fa115155d03daa6e545c28d66d537baf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cf467956fa115155d03daa6e545c28d66d537baf", "message": "Revert changes to charts", "committedDate": "2020-09-08T15:12:22Z", "type": "commit"}, {"oid": "f3ef12a94d13f9087d4e01b2b28ac9958da5f023", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f3ef12a94d13f9087d4e01b2b28ac9958da5f023", "message": "Bug fixes", "committedDate": "2020-09-08T18:59:06Z", "type": "commit"}, {"oid": "093e373e268325a8f0475702e8f3362ac6ee4b61", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/093e373e268325a8f0475702e8f3362ac6ee4b61", "message": "Disassociate CRD creation from namespace startup", "committedDate": "2020-09-08T21:29:34Z", "type": "commit"}, {"oid": "fb4b6a88ae2a0e97a4ff797d0cf0fe1c44c59bf5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fb4b6a88ae2a0e97a4ff797d0cf0fe1c44c59bf5", "message": "Make unit-test more generic", "committedDate": "2020-09-09T13:48:44Z", "type": "commit"}, {"oid": "ee5823896093daa4d15acbbcc9f80dfbaf05fc20", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee5823896093daa4d15acbbcc9f80dfbaf05fc20", "message": "Clarify continue pattern", "committedDate": "2020-09-09T14:36:34Z", "type": "commit"}, {"oid": "704c4d334678d5fa85f1e9a1bbabaf0e3b558c53", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/704c4d334678d5fa85f1e9a1bbabaf0e3b558c53", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-09T16:02:05Z", "type": "commit"}, {"oid": "9314171a7887e2c711773ab0c9c90eef5a90a89b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9314171a7887e2c711773ab0c9c90eef5a90a89b", "message": "Save continue for reinvoke of async request", "committedDate": "2020-09-10T16:22:22Z", "type": "commit"}, {"oid": "7619b35e664a45d69321744bb654d2cc1809bd4e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7619b35e664a45d69321744bb654d2cc1809bd4e", "message": "Merge remote-tracking branch 'origin/develop' into owls-83432", "committedDate": "2020-09-10T16:41:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0OTM3NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486649375", "bodyText": "The method name is bit unclear. Should it be something like resetRetryStrategyAndReinvokeRequest?", "author": "ankedia", "createdAt": "2020-09-10T21:40:47Z", "path": "operator/src/main/java/oracle/kubernetes/operator/helpers/ResponseStep.java", "diffHunk": "@@ -126,6 +147,20 @@ private NextAction doPotentialRetry(Step conflictStep, Packet packet, CallRespon\n     return null;\n   }\n \n+  /**\n+   * Resets any retry strategy, such as a failed retry count and invokes the request again. This\n+   * will be useful for patterns such as list requests that include a \"continue\" value.\n+   * @param packet Packet\n+   * @return Next action for the original request\n+   */\n+  private NextAction resetResetAndReinvokeRequest(Packet packet) {", "originalCommit": "7619b35e664a45d69321744bb654d2cc1809bd4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1NTY5NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486655694", "bodyText": "Yup... it's a typo. Thanks.", "author": "rjeberhard", "createdAt": "2020-09-10T21:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0OTM3NQ=="}], "type": "inlineReview"}, {"oid": "ecdb291a7081ee9348f0a11d000409366a21c71b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ecdb291a7081ee9348f0a11d000409366a21c71b", "message": "Correct method name", "committedDate": "2020-09-10T21:55:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2NjY2OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486666669", "bodyText": "The ALLOW_BOOKMARKS is set to true in WatchBuilder but I don't see BOOKMARK watch event handled in Watcher.java. My understanding of Watch bookmark feature is that it will send an event of type BOOKMARK to mark that all changes up to a given resourceVersion the client is requesting have already been sent. I was imagining that we'll update the resource version in Watcher.java with resource version set in BOOKMARK event . https://kubernetes.io/docs/reference/using-api/api-concepts/#watch-bookmarks", "author": "ankedia", "createdAt": "2020-09-10T22:23:22Z", "path": "operator/src/main/java/oracle/kubernetes/operator/builders/WatchBuilder.java", "diffHunk": "@@ -29,7 +29,7 @@\n   /** Ignored for watches. */\n   private static final String START_LIST = null;\n \n-  private static final Boolean ALLOW_BOOKMARKS = false;\n+  private static final Boolean ALLOW_BOOKMARKS = true;", "originalCommit": "7619b35e664a45d69321744bb654d2cc1809bd4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MzUxMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486673513", "bodyText": "I found that the behavior of the default branch of the switch was identical to what we would do for a specific BOOKMARK event, so there was no need to make further code change.", "author": "rjeberhard", "createdAt": "2020-09-10T22:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2NjY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2ODU0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486668547", "bodyText": "I was thinking that getNewResourceVersion() method of Watcher.java will check if event type is BOOKMARK and then update the resource version sent as part of bookmark event. Please let me know if my understanding is incorrect or if I missed something.", "author": "ankedia", "createdAt": "2020-09-10T22:28:30Z", "path": "operator/src/main/java/oracle/kubernetes/operator/Watcher.java", "diffHunk": "@@ -93,6 +93,11 @@ void waitForExit() {\n     }\n   }\n \n+  // for test", "originalCommit": "ecdb291a7081ee9348f0a11d000409366a21c71b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3Mzg2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486673860", "bodyText": "If you follow the logic through, you will see that this is what happens. I'm working on another branch, but tomorrow I'll find the existing code.", "author": "rjeberhard", "createdAt": "2020-09-10T22:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2ODU0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMjc3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1881#discussion_r486702779", "bodyText": "ok, got it. I wonder if we need to test it functionally (in integration test or stress test) to verify if bookmark events helps in mitigating the impact of short event history window. In any case, this looks fine to me.", "author": "ankedia", "createdAt": "2020-09-11T00:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2ODU0Nw=="}], "type": "inlineReview"}]}