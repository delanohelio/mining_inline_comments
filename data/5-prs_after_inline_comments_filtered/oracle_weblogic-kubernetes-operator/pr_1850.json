{"pr_number": 1850, "pr_title": "ItPodTemplates test conversion to Junit5", "pr_createdAt": "2020-08-05T18:30:03Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850", "timeline": [{"oid": "c8090a765f83c10b7609a36028691aaa1da3191c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c8090a765f83c10b7609a36028691aaa1da3191c", "message": "added tests for pod templates", "committedDate": "2020-08-05T17:49:34Z", "type": "commit"}, {"oid": "cd3c3269350044227bca29f8027d89333c48a04d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cd3c3269350044227bca29f8027d89333c48a04d", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-05T17:50:05Z", "type": "commit"}, {"oid": "d378ea6183d144777575e49ce5549515cdc37747", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d378ea6183d144777575e49ce5549515cdc37747", "message": "fixed typo", "committedDate": "2020-08-05T18:10:02Z", "type": "commit"}, {"oid": "c098f81243e14c71b424a6c4ca2d3f7de5238bc4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c098f81243e14c71b424a6c4ca2d3f7de5238bc4", "message": "fixed styling", "committedDate": "2020-08-05T18:16:33Z", "type": "commit"}, {"oid": "402bf599dc03a1cdc7013bbca0af207f11155576", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/402bf599dc03a1cdc7013bbca0af207f11155576", "message": "fixed styling1", "committedDate": "2020-08-05T18:35:17Z", "type": "commit"}, {"oid": "7294511c36d071d7116adffe21a8a29a7312f059", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7294511c36d071d7116adffe21a8a29a7312f059", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-05T21:53:01Z", "type": "commit"}, {"oid": "00d744fdadc86f0db0a0865d591d6e1dfd42fb7b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/00d744fdadc86f0db0a0865d591d6e1dfd42fb7b", "message": "removed junit4 test", "committedDate": "2020-08-05T21:53:50Z", "type": "commit"}, {"oid": "8752bef815a6517a459b2cf548d4b79009c480a2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8752bef815a6517a459b2cf548d4b79009c480a2", "message": "removed t3port", "committedDate": "2020-08-06T16:06:26Z", "type": "commit"}, {"oid": "9cd6e0cca2c03105e19f3c44844fa910fd9a9f9d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9cd6e0cca2c03105e19f3c44844fa910fd9a9f9d", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-06T16:06:50Z", "type": "commit"}, {"oid": "7f3c52cb0a65899ec9b46c3259735487c2fd0b8c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7f3c52cb0a65899ec9b46c3259735487c2fd0b8c", "message": "fixed domainhome dir", "committedDate": "2020-08-06T19:33:24Z", "type": "commit"}, {"oid": "5ca7d8a704fdfc0b5395b80e327a520b97b33a6e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5ca7d8a704fdfc0b5395b80e327a520b97b33a6e", "message": "fixed domainhome dir1", "committedDate": "2020-08-06T19:35:09Z", "type": "commit"}, {"oid": "5a7f9d9d5401627c4fc334627ae551d894778bf9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5a7f9d9d5401627c4fc334627ae551d894778bf9", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-07T16:15:20Z", "type": "commit"}, {"oid": "317b43e8d16105c22a0b3e08e553d960db53cd58", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/317b43e8d16105c22a0b3e08e553d960db53cd58", "message": " revert to 5ca7d8a704fdfc0b5395b80e327a520b97b33a6e", "committedDate": "2020-08-07T17:32:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2MTUyOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468161529", "bodyText": "this method is called for creating domain home in image too, but the variable name used is miiImage", "author": "vanajamukkara", "createdAt": "2020-08-10T20:17:44Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain1Uid),\n+          \"Can't find expected value for label domainhome, the retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain1\");\n+      shutdownDomain(domain1Uid, domain1Namespace);\n+    }\n+  }\n+\n+  @AfterAll\n+  public void tearDownAll() {\n+\n+    // shutdown domain1\n+    logger.info(\"Shutting down domain1\");\n+    assertTrue(shutdownDomain(domain1Uid, domain1Namespace),\n+        String.format(\"shutdown domain %s in namespace %s failed\", domain1Uid, domain1Namespace));\n+    if (wdtImage != null) {\n+      deleteImage(miiImage);\n+    }\n+\n+    // Delete domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain1Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain1Uid, domain1Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain1Uid + \" from \" + domain1Namespace);\n+\n+    // Delete wdt domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain2Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain2Uid, domain2Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain2Uid + \" from \" + domain2Namespace);\n+  }\n+\n+  /**\n+   * Create and verify domain in image.\n+   * @return image name\n+   */\n+  private static String createAndVerifyDomainInImage() {\n+    // create image with model files\n+    logger.info(\"Create image with model file and verify\");\n+    String appPath = String.format(\"%s/../src/integration-tests/apps/testwebapp.war\", ITTESTS_DIR);\n+\n+    List<String> appList = new ArrayList();\n+    appList.add(appPath);\n+\n+    int t3ChannelPort = getNextFreePort(31600, 32767);  // the port range has to be between 31,000 to 32,767\n+\n+    Properties p = new Properties();\n+    p.setProperty(\"ADMIN_USER\", ADMIN_USERNAME_DEFAULT);\n+    p.setProperty(\"ADMIN_PWD\", ADMIN_PASSWORD_DEFAULT);\n+    p.setProperty(\"DOMAIN_NAME\", domain2Uid);\n+    p.setProperty(\"DOMAIN_UID\", domain2Uid);\n+    p.setProperty(\"ADMIN_NAME\", \"admin-server\");\n+    p.setProperty(\"PRODUCTION_MODE_ENABLED\", \"true\");\n+    p.setProperty(\"CLUSTER_NAME\", clusterName);\n+    p.setProperty(\"CLUSTER_TYPE\", \"DYNAMIC\");\n+    p.setProperty(\"CONFIGURED_MANAGED_SERVER_COUNT\", \"2\");\n+    p.setProperty(\"MANAGED_SERVER_NAME_BASE\", \"managed-server\");\n+    p.setProperty(\"T3_CHANNEL_PORT\", Integer.toString(t3ChannelPort));\n+    p.setProperty(\"T3_PUBLIC_ADDRESS\", K8S_NODEPORT_HOST);\n+    p.setProperty(\"MANAGED_SERVER_PORT\", \"8001\");\n+    p.setProperty(\"SERVER_START_MODE\", \"prod\");\n+    p.setProperty(\"ADMIN_PORT\", \"7001\");\n+    p.setProperty(\"MYSQL_USER\", \"wluser1\");\n+    p.setProperty(\"MYSQL_PWD\", \"wlpwd123\");\n+    // create a temporary WebLogic domain property file as a input for WDT model file\n+    File domainPropertiesFile = assertDoesNotThrow(() ->\n+            File.createTempFile(\"domain\", \"properties\"),\n+        \"Failed to create domain properties file\");\n+    assertDoesNotThrow(() ->\n+            p.store(new FileOutputStream(domainPropertiesFile), \"WDT properties file\"),\n+        \"Failed to write domain properties file\");\n+\n+    final List<String> propertyList = Collections.singletonList(domainPropertiesFile.getPath());\n+\n+    // build the model file list\n+    final List<String> modelList = Collections.singletonList(RESOURCE_DIR\n+        + \"/wdt-models/wdt-model.yaml\");\n+\n+    wdtImage =\n+        createImageAndVerify(PODTEMPLATES_IMAGE_NAME,\n+            modelList,\n+            appList,\n+            propertyList,\n+            WLS_BASE_IMAGE_NAME,\n+            WLS_BASE_IMAGE_TAG,\n+            WLS,\n+            false,\n+            domain2Uid, true);\n+\n+\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(wdtImage);\n+\n+    return wdtImage;\n+  }\n+\n+  //create domain from provided image and verify it's start\n+  private static void createAndVerifyDomain(String miiImage,", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1Njc5Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468256797", "bodyText": "corrected var name", "author": "marinakog", "createdAt": "2020-08-11T00:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2MTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2MjczOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468162738", "bodyText": "fix the messages for domain home in image and model in image domains ...", "author": "vanajamukkara", "createdAt": "2020-08-10T20:19:36Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain1Uid),\n+          \"Can't find expected value for label domainhome, the retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain1\");\n+      shutdownDomain(domain1Uid, domain1Namespace);\n+    }\n+  }\n+\n+  @AfterAll\n+  public void tearDownAll() {\n+\n+    // shutdown domain1\n+    logger.info(\"Shutting down domain1\");\n+    assertTrue(shutdownDomain(domain1Uid, domain1Namespace),\n+        String.format(\"shutdown domain %s in namespace %s failed\", domain1Uid, domain1Namespace));\n+    if (wdtImage != null) {\n+      deleteImage(miiImage);\n+    }\n+\n+    // Delete domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain1Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain1Uid, domain1Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain1Uid + \" from \" + domain1Namespace);\n+\n+    // Delete wdt domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain2Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain2Uid, domain2Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain2Uid + \" from \" + domain2Namespace);\n+  }\n+\n+  /**\n+   * Create and verify domain in image.\n+   * @return image name\n+   */\n+  private static String createAndVerifyDomainInImage() {\n+    // create image with model files\n+    logger.info(\"Create image with model file and verify\");\n+    String appPath = String.format(\"%s/../src/integration-tests/apps/testwebapp.war\", ITTESTS_DIR);\n+\n+    List<String> appList = new ArrayList();\n+    appList.add(appPath);\n+\n+    int t3ChannelPort = getNextFreePort(31600, 32767);  // the port range has to be between 31,000 to 32,767\n+\n+    Properties p = new Properties();\n+    p.setProperty(\"ADMIN_USER\", ADMIN_USERNAME_DEFAULT);\n+    p.setProperty(\"ADMIN_PWD\", ADMIN_PASSWORD_DEFAULT);\n+    p.setProperty(\"DOMAIN_NAME\", domain2Uid);\n+    p.setProperty(\"DOMAIN_UID\", domain2Uid);\n+    p.setProperty(\"ADMIN_NAME\", \"admin-server\");\n+    p.setProperty(\"PRODUCTION_MODE_ENABLED\", \"true\");\n+    p.setProperty(\"CLUSTER_NAME\", clusterName);\n+    p.setProperty(\"CLUSTER_TYPE\", \"DYNAMIC\");\n+    p.setProperty(\"CONFIGURED_MANAGED_SERVER_COUNT\", \"2\");\n+    p.setProperty(\"MANAGED_SERVER_NAME_BASE\", \"managed-server\");\n+    p.setProperty(\"T3_CHANNEL_PORT\", Integer.toString(t3ChannelPort));\n+    p.setProperty(\"T3_PUBLIC_ADDRESS\", K8S_NODEPORT_HOST);\n+    p.setProperty(\"MANAGED_SERVER_PORT\", \"8001\");\n+    p.setProperty(\"SERVER_START_MODE\", \"prod\");\n+    p.setProperty(\"ADMIN_PORT\", \"7001\");\n+    p.setProperty(\"MYSQL_USER\", \"wluser1\");\n+    p.setProperty(\"MYSQL_PWD\", \"wlpwd123\");\n+    // create a temporary WebLogic domain property file as a input for WDT model file\n+    File domainPropertiesFile = assertDoesNotThrow(() ->\n+            File.createTempFile(\"domain\", \"properties\"),\n+        \"Failed to create domain properties file\");\n+    assertDoesNotThrow(() ->\n+            p.store(new FileOutputStream(domainPropertiesFile), \"WDT properties file\"),\n+        \"Failed to write domain properties file\");\n+\n+    final List<String> propertyList = Collections.singletonList(domainPropertiesFile.getPath());\n+\n+    // build the model file list\n+    final List<String> modelList = Collections.singletonList(RESOURCE_DIR\n+        + \"/wdt-models/wdt-model.yaml\");\n+\n+    wdtImage =\n+        createImageAndVerify(PODTEMPLATES_IMAGE_NAME,\n+            modelList,\n+            appList,\n+            propertyList,\n+            WLS_BASE_IMAGE_NAME,\n+            WLS_BASE_IMAGE_TAG,\n+            WLS,\n+            false,\n+            domain2Uid, true);\n+\n+\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(wdtImage);\n+\n+    return wdtImage;\n+  }\n+\n+  //create domain from provided image and verify it's start\n+  private static void createAndVerifyDomain(String miiImage,\n+                                            String domainUid,\n+                                            String namespace,\n+                                            String domainHomeSource,\n+                                            int replicaCount) {\n+    // create docker registry secret to pull the image from registry\n+    logger.info(\"Create docker registry secret in namespace {0}\", namespace);\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(namespace),\n+        String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n+    // create secret for admin credentials\n+    logger.info(\"Create secret for admin credentials\");\n+    String adminSecretName = \"weblogic-credentials\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(adminSecretName, namespace,\n+        \"weblogic\", \"welcome1\"),\n+        String.format(\"create secret for admin credentials failed for %s\", adminSecretName));\n+\n+    // create encryption secret\n+    logger.info(\"Create encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(encryptionSecretName, namespace,\n+        \"weblogicenc\", \"weblogicenc\"),\n+        String.format(\"create encryption secret failed for %s\", encryptionSecretName));\n+\n+    // create domain and verify\n+    logger.info(\"Create model in image domain {0} in namespace {1} using docker image {2}\",", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1Njg2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468256860", "bodyText": "fixed", "author": "marinakog", "createdAt": "2020-08-11T00:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2MjczOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MzE3Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468173176", "bodyText": "add some comments and log messages as to what you are verifying here", "author": "vanajamukkara", "createdAt": "2020-08-10T20:40:37Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1NjkzMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468256932", "bodyText": "done", "author": "marinakog", "createdAt": "2020-08-11T00:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MzE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Mzg3Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468173872", "bodyText": "same as above by leaving a blank line between the checks", "author": "vanajamukkara", "createdAt": "2020-08-10T20:41:59Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NTEzNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468175135", "bodyText": "is this needed here?", "author": "vanajamukkara", "createdAt": "2020-08-10T20:44:40Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjExMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468176113", "bodyText": "leave blank line for better readability", "author": "vanajamukkara", "createdAt": "2020-08-10T20:46:35Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjI1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468176252", "bodyText": "leave blank line for better readability", "author": "vanajamukkara", "createdAt": "2020-08-10T20:46:51Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjM3OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468176378", "bodyText": "leave blank line for better readability", "author": "vanajamukkara", "createdAt": "2020-08-10T20:47:03Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjkyMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468176922", "bodyText": "what is this?", "author": "vanajamukkara", "createdAt": "2020-08-10T20:48:16Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1Nzg3MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468257871", "bodyText": "by default crd has logHomeEnable = false, so even pod template has LOG_HOME used for annotation it does not get initialized. I left like that to check that it does not prevent pod from running.", "author": "marinakog", "createdAt": "2020-08-11T00:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Nzg3MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468177870", "bodyText": "checking wdtImage and deleting miiImage? images are deleted in ImageBuilders extension class at the end of the test suite. Is this needed here?", "author": "vanajamukkara", "createdAt": "2020-08-10T20:50:05Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain1Uid),\n+          \"Can't find expected value for label domainhome, the retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain1\");\n+      shutdownDomain(domain1Uid, domain1Namespace);\n+    }\n+  }\n+\n+  @AfterAll\n+  public void tearDownAll() {\n+\n+    // shutdown domain1\n+    logger.info(\"Shutting down domain1\");\n+    assertTrue(shutdownDomain(domain1Uid, domain1Namespace),\n+        String.format(\"shutdown domain %s in namespace %s failed\", domain1Uid, domain1Namespace));\n+    if (wdtImage != null) {", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1ODQ0Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468258443", "bodyText": "removed image delete (this is custom image created I thought we must delete them in the test)", "author": "marinakog", "createdAt": "2020-08-11T00:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Nzg3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwMTgwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r469001809", "bodyText": "also switched to generic wit image", "author": "marinakog", "createdAt": "2020-08-12T04:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Nzg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3ODY2Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468178667", "bodyText": "test infra takes care of cleanup, no need to have this code here", "author": "vanajamukkara", "createdAt": "2020-08-10T20:51:43Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain1Uid),\n+          \"Can't find expected value for label domainhome, the retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain1\");\n+      shutdownDomain(domain1Uid, domain1Namespace);\n+    }\n+  }\n+\n+  @AfterAll\n+  public void tearDownAll() {\n+\n+    // shutdown domain1", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3OTIzMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468179231", "bodyText": "is this related to template variables ?", "author": "vanajamukkara", "createdAt": "2020-08-10T20:52:50Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create domain and verify that it's running\");\n+      createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", replicaCount);\n+      String managedServerPodName = domain1Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      //checking that values from template variables are assigned.\n+      V1Pod managedServerPod = Kubernetes.getPod(domain1Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod, \"The managed-server1 pod does not exist in namespace \" + domain1Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(\"wls-domain1\"),\n+          \"Can't find expected value for  label domainname\");\n+\n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+\n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain1Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain1Uid),\n+          \"Can't find expected value for label domainhome, the retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain1\");\n+      shutdownDomain(domain1Uid, domain1Namespace);\n+    }\n+  }\n+\n+  @AfterAll\n+  public void tearDownAll() {\n+\n+    // shutdown domain1\n+    logger.info(\"Shutting down domain1\");\n+    assertTrue(shutdownDomain(domain1Uid, domain1Namespace),\n+        String.format(\"shutdown domain %s in namespace %s failed\", domain1Uid, domain1Namespace));\n+    if (wdtImage != null) {\n+      deleteImage(miiImage);\n+    }\n+\n+    // Delete domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain1Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain1Uid, domain1Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain1Uid + \" from \" + domain1Namespace);\n+\n+    // Delete wdt domain custom resource\n+    logger.info(\"Delete domain custom resource in namespace {0}\", domain2Namespace);\n+    assertDoesNotThrow(() -> deleteDomainCustomResource(domain2Uid, domain2Namespace),\n+        \"deleteDomainCustomResource failed with ApiException\");\n+    logger.info(\"Deleted Domain Custom Resource \" + domain2Uid + \" from \" + domain2Namespace);\n+  }\n+\n+  /**\n+   * Create and verify domain in image.\n+   * @return image name\n+   */\n+  private static String createAndVerifyDomainInImage() {\n+    // create image with model files\n+    logger.info(\"Create image with model file and verify\");\n+    String appPath = String.format(\"%s/../src/integration-tests/apps/testwebapp.war\", ITTESTS_DIR);\n+\n+    List<String> appList = new ArrayList();\n+    appList.add(appPath);\n+\n+    int t3ChannelPort = getNextFreePort(31600, 32767);  // the port range has to be between 31,000 to 32,767\n+\n+    Properties p = new Properties();", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1ODc4Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468258786", "bodyText": "it is used for passing the property to model file, I removed it, we don't need t3 access in this test", "author": "marinakog", "createdAt": "2020-08-11T00:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3OTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTM3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468181379", "bodyText": "is there any difference in the way the variables are used for domain home in image and model in image domain?", "author": "vanajamukkara", "createdAt": "2020-08-10T20:57:01Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainname\");\n+      assertNotNull(domainName, \"Can't find label domainname\");\n+      assertTrue(domainName.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for  label domainname\");\n+      \n+      String myclusterName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"clustername\");\n+      assertNotNull(myclusterName, \"Can't find label clustername\");\n+      assertTrue(myclusterName.equalsIgnoreCase(clusterName),\n+          \"Can't find expected value for label clustername\");\n+      \n+      String domainuid = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"domainuid\");\n+      assertNotNull(domainuid, \"Can't find label domainuid\");\n+      assertTrue(domainuid.equalsIgnoreCase(domain2Uid),\n+          \"Can't find expected value for label domainuid\");\n+\n+      String loghome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"loghome\");\n+      assertNotNull(loghome, \"Can't find label loghome\");\n+      //value is not initialized since logHomeEnable = false\n+      assertTrue(loghome.equalsIgnoreCase(\"$(LOG_HOME)\"),\n+          \"Can't find expected value for label loghome, real value is \" + loghome);\n+\n+      String domainhome = managedServerPod\n+          .getMetadata().getAnnotations()\n+          .get(\"domainhome\");\n+      assertNotNull(domainhome, \"Can't find label domainhome\");\n+      assertTrue(domainhome.equalsIgnoreCase(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domain2Uid),\n+          \"Can't find expected value for label domainhome, retrieved value is :\" + domainhome);\n+\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      shutdownDomain(domain2Uid, domain2Namespace);\n+    }\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME)\n+   * in serverPod for Model In Image domain. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for model in image domain.\")\n+  public void testPodTemplateUsingVariablesModelInImage() throws Exception {", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1ODk5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468258998", "bodyText": "should be same, sent this question to Ryan, if not needed will remove one of them", "author": "marinakog", "createdAt": "2020-08-11T00:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxNDUzMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r469314532", "bodyText": "I don't think its needed as there is no difference in the way the template variables are used. Can you remove this test.", "author": "vanajamukkara", "createdAt": "2020-08-12T14:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMTQ0MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468201441", "bodyText": "throughout the test add some logs and comments as to what you are verifying.", "author": "sankarpn", "createdAt": "2020-08-10T21:39:56Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItPodTemplates.java", "diffHunk": "@@ -0,0 +1,495 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import org.awaitility.core.ConditionFactory;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static java.util.concurrent.TimeUnit.MINUTES;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MANAGED_SERVER_NAME_BASE;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.WDT_IMAGE_DOMAINHOME_BASE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.ITTESTS_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.RESOURCE_DIR;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.WLS_BASE_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.actions.TestActions.deleteImage;\n+import static oracle.weblogic.kubernetes.actions.TestActions.shutdownDomain;\n+import static oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes.deleteDomainCustomResource;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createImageAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.dockerLoginAndPushImageToRegistry;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.awaitility.Awaitility.with;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+\n+/**\n+ * This test is used for creating Operator(s) and domain which uses pod templates.\n+ */\n+@DisplayName(\"Test to verify domain pod templates.\")\n+@IntegrationTest\n+class ItPodTemplates {\n+\n+\n+  // domain constants\n+  private static final int replicaCount = 1;\n+  private static String domain1Namespace = null;\n+  private static String domain1Uid = \"itpodtemplates-domain-1\";\n+  private static String domain2Namespace = null;\n+  private static String domain2Uid = \"itpodtemplates-domain-2\";\n+  private static ConditionFactory withStandardRetryPolicy = null;\n+  // constants for creating domain image using model in image\n+  private static final String PODTEMPLATES_IMAGE_NAME = \"podtemplates-image\";\n+\n+  private static String clusterName = \"cluster-1\";\n+  private static String miiImage = null;\n+  private static String wdtImage = null;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Install operator.\n+   *\n+   * @param namespaces list of namespaces created by the IntegrationTestWatcher by the\n+   *                   JUnit engine parameter resolution mechanism\n+   */\n+  @BeforeAll\n+\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+\n+    logger = getLogger();\n+    // create standard, reusable retry/backoff policy\n+    withStandardRetryPolicy = with().pollDelay(2, SECONDS)\n+        .and().with().pollInterval(10, SECONDS)\n+        .atMost(5, MINUTES).await();\n+\n+    logger.info(\"Get a unique namespace for operator\");\n+    assertNotNull(namespaces.get(0), \"Namespace list is null\");\n+    final String opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain1\");\n+    assertNotNull(namespaces.get(1), \"Namespace list is null\");\n+    domain1Namespace = namespaces.get(1);\n+\n+    logger.info(\"Get a unique namespace for WebLogic domain2\");\n+    assertNotNull(namespaces.get(2), \"Namespace list is null\");\n+    domain2Namespace = namespaces.get(2);\n+\n+    logger.info(\"install and verify operator\");\n+    installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n+\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+  }\n+\n+  /**\n+   * Test pod templates using all the variables $(SERVER_NAME), $(DOMAIN_NAME), $(DOMAIN_UID),\n+   * $(DOMAIN_HOME), $(LOG_HOME) and $(CLUSTER_NAME) in serverPod for Domain In Image. Make sure the domain comes up\n+   * successfully.\n+   *\n+   * @throws Exception when the domain crd creation fails or when updating the serverPod with\n+   *                   variables\n+   */\n+  @Test\n+  @DisplayName(\"Test pod templates using all the variables for domain in image.\")\n+  public void testPodTemplateUsingVariablesDomainInImage() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      String managedServerPodName = domain2Uid + \"-\" + MANAGED_SERVER_NAME_BASE + \"1\";\n+      V1Pod managedServerPod = Kubernetes.getPod(domain2Namespace, null, managedServerPodName);\n+      assertNotNull(managedServerPod,\"The admin pod does not exist in namespace \" + domain2Namespace);\n+      String serverName = managedServerPod\n+          .getMetadata().getLabels()\n+          .get(\"servername\");\n+      assertNotNull(serverName, \"Can't find label servername\");\n+      assertTrue(serverName.equalsIgnoreCase(\"managed-server1\"),\n+          \"Can't find or match label servername\");\n+      String domainName = managedServerPod", "originalCommit": "317b43e8d16105c22a0b3e08e553d960db53cd58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1OTAxOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1850#discussion_r468259019", "bodyText": "added", "author": "marinakog", "createdAt": "2020-08-11T00:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIwMTQ0MQ=="}], "type": "inlineReview"}, {"oid": "e0861af4e738cf28f37db3f58dc749288e5b7a6b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e0861af4e738cf28f37db3f58dc749288e5b7a6b", "message": " addressed the review comments", "committedDate": "2020-08-10T23:51:23Z", "type": "commit"}, {"oid": "f2879ab292ff09d34687a7cd5973f5da67328265", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f2879ab292ff09d34687a7cd5973f5da67328265", "message": "put back Lenny's commit", "committedDate": "2020-08-11T00:03:04Z", "type": "commit"}, {"oid": "a3f9256ba3788fecf9b1ea16505c9f0ea0a81800", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a3f9256ba3788fecf9b1ea16505c9f0ea0a81800", "message": "added more comments", "committedDate": "2020-08-11T16:26:38Z", "type": "commit"}, {"oid": "3edb1c1051ef811c6d140f7ff818f4ca0bea7dd2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3edb1c1051ef811c6d140f7ff818f4ca0bea7dd2", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-11T16:26:46Z", "type": "commit"}, {"oid": "cc6892e364291849bd627f6affbc1fa57c7c7164", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cc6892e364291849bd627f6affbc1fa57c7c7164", "message": "addressed comments, move to use default wdt image", "committedDate": "2020-08-11T22:55:57Z", "type": "commit"}, {"oid": "0598c1908d46c642c6783c921474457faa93ad55", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0598c1908d46c642c6783c921474457faa93ad55", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-11T22:56:01Z", "type": "commit"}, {"oid": "340b0d866d72fed4c125d26bbaeed70d707b7807", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/340b0d866d72fed4c125d26bbaeed70d707b7807", "message": "removed mii test", "committedDate": "2020-08-12T15:39:15Z", "type": "commit"}, {"oid": "5d09abb1e9e45a5051b1b6fde00eac7b64901d70", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5d09abb1e9e45a5051b1b6fde00eac7b64901d70", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into podtempl", "committedDate": "2020-08-12T21:41:50Z", "type": "commit"}]}