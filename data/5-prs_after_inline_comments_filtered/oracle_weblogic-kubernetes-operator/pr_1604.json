{"pr_number": 1604, "pr_title": "Support for Kubernetes exec command", "pr_createdAt": "2020-04-28T03:34:57Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604", "timeline": [{"oid": "17cbd490f9f19b981d0e03e84fbac506b1fa8510", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/17cbd490f9f19b981d0e03e84fbac506b1fa8510", "message": "Add support for Kubernetes exec API", "committedDate": "2020-04-25T00:58:53Z", "type": "commit"}, {"oid": "7ec6710fa3f4ed9ac70a18ff8dc8d61d4a41798e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7ec6710fa3f4ed9ac70a18ff8dc8d61d4a41798e", "message": "merge from develop branch", "committedDate": "2020-04-25T01:14:02Z", "type": "commit"}, {"oid": "3f1172f7878b175a231a9dbe894cf8a81ff92acc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3f1172f7878b175a231a9dbe894cf8a81ff92acc", "message": "Update processing input stream and adding ExecResult return type", "committedDate": "2020-04-27T21:22:46Z", "type": "commit"}, {"oid": "8c0c96d487975fd52836134ff67ab27520bb09d2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8c0c96d487975fd52836134ff67ab27520bb09d2", "message": "Merge remote-tracking branch 'origin/develop' into test-exec-cmd\n\nMerge latest from develop branch.", "committedDate": "2020-04-27T21:25:42Z", "type": "commit"}, {"oid": "13d1f50918ba4c9f71074ef949d7074215a66e66", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/13d1f50918ba4c9f71074ef949d7074215a66e66", "message": "clean up reading output thread join", "committedDate": "2020-04-27T22:13:17Z", "type": "commit"}, {"oid": "f70b000f5a5726b8250f5bc953ef3c334c4499ad", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f70b000f5a5726b8250f5bc953ef3c334c4499ad", "message": "add test to call exec", "committedDate": "2020-04-28T01:08:48Z", "type": "commit"}, {"oid": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "message": "update copyright", "committedDate": "2020-04-28T03:24:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyODc0Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416628747", "bodyText": "In general we would not want the test code directly works with low-level Kubernetes objects. But I am not worried about this here because this method is a sample to demonstrate and test the new functionality, which eventually may not needed.", "author": "doxiao", "createdAt": "2020-04-28T13:49:49Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMiiDomain.java", "diffHunk": "@@ -757,4 +767,23 @@ private void checkServiceCreated(String serviceName, String domNamespace) {\n \n   }\n \n+  private void checkServerReadyStatusByExec(String podName, String namespace) {\n+    final V1Pod pod = assertDoesNotThrow(() -> oracle.weblogic.kubernetes.assertions.impl.Kubernetes", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc4MDAyNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416780027", "bodyText": "Yes, I used the low-level Kubernetes call because I know that Pani has a PR that has an action to get the Pod.  I'll change it to use the action in Pani's PR when it eventually gets merged or we can remove this example altogether. IMO we should consider consolidating the Kubernetes API's into one Kubernetes class from which both actions and assertions would then share.", "author": "lennyphan", "createdAt": "2020-04-28T17:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyODc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgxMDI4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416810285", "bodyText": "sounds good.", "author": "doxiao", "createdAt": "2020-04-28T17:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyODc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMTk0Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416631942", "bodyText": "I don't know how long it takes for the phase to be updated to \"terminating\", and how long it will stay in that phase. Wondering if this check may hit a window, and as a result, reports a false failure.", "author": "doxiao", "createdAt": "2020-04-28T13:53:53Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -491,9 +507,15 @@ public static boolean deleteNamespace(String name) {\n     }\n \n     if (response.getObject() != null) {\n-      logger.info(\n-          \"Received after-deletion status of the requested object, will be deleting namespace\"\n-              + \" in background!\");\n+      V1Namespace namespace = (V1Namespace) response.getObject();\n+      String phase = namespace.getStatus().getPhase();\n+      logger.fine(\n+          \"Deletion of namespace \" + namespace.getMetadata().getName() + \" is in phase: \" + phase);\n+      if (!phase.equals(\"Terminating\")) {", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0MjQ5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r417342495", "bodyText": "modified code looks good.", "author": "doxiao", "createdAt": "2020-04-29T14:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMTk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzQ5NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416633495", "bodyText": "It seems that if the redirectToStdout is false, the following code will still make a copy of the original  input stream while the original input stream can be directly used.", "author": "doxiao", "createdAt": "2020-04-28T13:55:51Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1352,149 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy Process output to stdout\n+   * @param command The command to run\n+   * @return result of command execution\n+   * @throws IOException if an I/O error occurs.\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static ExecResult exec(V1Pod pod, String containerName, boolean redirectToStdout,\n+      String... command)\n+      throws IOException, ApiException, InterruptedException {\n+\n+    // Execute command using Kubernetes API\n+    KubernetesExec kubernetesExec = createKubernetesExec(pod, containerName);\n+    final Process proc = kubernetesExec.exec(command);\n+\n+    final CopyingOutputStream copyOut =\n+        redirectToStdout ? new CopyingOutputStream(System.out) : new CopyingOutputStream(null);", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MjEwOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416792109", "bodyText": "Instead of waiting for Process.waitFor() to read from the stream directly, I wanted to creating a separate thread (used for redirect) in order to consume the process's output stream to prevent the output stream buffer from becoming full and blocking.", "author": "lennyphan", "createdAt": "2020-04-28T17:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMjk1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416632952", "bodyText": "equals? or contains? just checking", "author": "markxnelson", "createdAt": "2020-04-28T13:55:12Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMiiDomain.java", "diffHunk": "@@ -757,4 +767,23 @@ private void checkServiceCreated(String serviceName, String domNamespace) {\n \n   }\n \n+  private void checkServerReadyStatusByExec(String podName, String namespace) {\n+    final V1Pod pod = assertDoesNotThrow(() -> oracle.weblogic.kubernetes.assertions.impl.Kubernetes\n+        .getPod(namespace, null, podName));\n+\n+    if (pod != null) {\n+      ExecResult execResult = assertDoesNotThrow(\n+          () -> execCommand(pod, null, true, READ_STATE_COMMAND));\n+      if (execResult.exitValue() == 0) {\n+        logger.info(\"execResult: \" + execResult);\n+        assertEquals(\"RUNNING\", execResult.stdout(),", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY2MzU2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416663562", "bodyText": "The readState.sh script already trims the rest of the contents of the node manager's server status file, so this is equals.  Of course, the server could be in other statuses, such as \"ADMIN\". :)", "author": "rjeberhard", "createdAt": "2020-04-28T14:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMjk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzE2MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416633160", "bodyText": "fix this javadoc please", "author": "markxnelson", "createdAt": "2020-04-28T13:55:27Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/TestActions.java", "diffHunk": "@@ -495,7 +499,7 @@ public static boolean buildAppArchive(AppParams params) {\n    * @param registryName registry name", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzY5Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416633697", "bodyText": "is run -> is to be run", "author": "markxnelson", "createdAt": "2020-04-28T13:56:06Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/TestActions.java", "diffHunk": "@@ -531,6 +535,27 @@ public static JsonObject createDockerConfigJson(String username, String password\n     return Docker.createDockerConfigJson(username, password, email, registry);\n   }\n \n+  // ----------------------- Execute a Command   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0OTgyMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418249820", "bodyText": "Fixed this syntax changes in all the files.", "author": "lennyphan", "createdAt": "2020-04-30T19:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzg4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416633882", "bodyText": "is run -> is to be run", "author": "markxnelson", "createdAt": "2020-04-28T13:56:18Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/TestActions.java", "diffHunk": "@@ -531,6 +535,27 @@ public static JsonObject createDockerConfigJson(String username, String password\n     return Docker.createDockerConfigJson(username, password, email, registry);\n   }\n \n+  // ----------------------- Execute a Command   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNDI2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416634263", "bodyText": "process - no capital", "author": "markxnelson", "createdAt": "2020-04-28T13:56:44Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/TestActions.java", "diffHunk": "@@ -531,6 +535,27 @@ public static JsonObject createDockerConfigJson(String username, String password\n     return Docker.createDockerConfigJson(username, password, email, registry);\n   }\n \n+  // ----------------------- Execute a Command   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy Process output to stdout", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0OTk0NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418249945", "bodyText": "Removed capital from all files", "author": "lennyphan", "createdAt": "2020-04-30T19:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNDI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNDg2MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416634861", "bodyText": "same comments as in other file", "author": "markxnelson", "createdAt": "2020-04-28T13:57:26Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/Exec.java", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.openapi.ApiException;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.Kubernetes;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+\n+public class Exec {\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNTgzMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416635830", "bodyText": "this is unreliable - you need to wait until it is gone, but just terminating.\nit could get stuck in terminating forever if there is a bad finalizer", "author": "markxnelson", "createdAt": "2020-04-28T13:58:35Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -491,9 +507,15 @@ public static boolean deleteNamespace(String name) {\n     }\n \n     if (response.getObject() != null) {\n-      logger.info(\n-          \"Received after-deletion status of the requested object, will be deleting namespace\"\n-              + \" in background!\");\n+      V1Namespace namespace = (V1Namespace) response.getObject();\n+      String phase = namespace.getStatus().getPhase();\n+      logger.fine(\n+          \"Deletion of namespace \" + namespace.getMetadata().getName() + \" is in phase: \" + phase);\n+      if (!phase.equals(\"Terminating\")) {", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNjg3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416636877", "bodyText": "same", "author": "markxnelson", "createdAt": "2020-04-28T13:59:59Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1352,149 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzNzY4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416637685", "bodyText": "process does not need capital all through here", "author": "markxnelson", "createdAt": "2020-04-28T14:00:58Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1352,149 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy Process output to stdout\n+   * @param command The command to run\n+   * @return result of command execution\n+   * @throws IOException if an I/O error occurs.\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static ExecResult exec(V1Pod pod, String containerName, boolean redirectToStdout,\n+      String... command)\n+      throws IOException, ApiException, InterruptedException {\n+\n+    // Execute command using Kubernetes API\n+    KubernetesExec kubernetesExec = createKubernetesExec(pod, containerName);\n+    final Process proc = kubernetesExec.exec(command);\n+\n+    final CopyingOutputStream copyOut =\n+        redirectToStdout ? new CopyingOutputStream(System.out) : new CopyingOutputStream(null);\n+\n+    // Start a thread to begin reading the output stream of the command\n+    Thread out = null;\n+    try {\n+      out =\n+          new Thread(\n+              () -> {\n+                try {\n+                  ByteStreams.copy(proc.getInputStream(), copyOut);\n+                } catch (IOException ex) {\n+                  logger.warning(\"Exception reading from input stream.\", ex);\n+                }\n+              });\n+      out.start();\n+\n+      // wait for the Process, which represents the executing command, to terminate", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzODA5Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416638097", "bodyText": "same", "author": "markxnelson", "createdAt": "2020-04-28T14:01:30Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1352,149 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy Process output to stdout\n+   * @param command The command to run\n+   * @return result of command execution\n+   * @throws IOException if an I/O error occurs.\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static ExecResult exec(V1Pod pod, String containerName, boolean redirectToStdout,\n+      String... command)\n+      throws IOException, ApiException, InterruptedException {\n+\n+    // Execute command using Kubernetes API\n+    KubernetesExec kubernetesExec = createKubernetesExec(pod, containerName);\n+    final Process proc = kubernetesExec.exec(command);\n+\n+    final CopyingOutputStream copyOut =\n+        redirectToStdout ? new CopyingOutputStream(System.out) : new CopyingOutputStream(null);\n+\n+    // Start a thread to begin reading the output stream of the command\n+    Thread out = null;\n+    try {\n+      out =\n+          new Thread(\n+              () -> {\n+                try {\n+                  ByteStreams.copy(proc.getInputStream(), copyOut);\n+                } catch (IOException ex) {\n+                  logger.warning(\"Exception reading from input stream.\", ex);\n+                }\n+              });\n+      out.start();\n+\n+      // wait for the Process, which represents the executing command, to terminate\n+      proc.waitFor();\n+\n+      // wait for reading thread to finish any last remaining output\n+      if (out != null) {\n+        out.join();\n+      }\n+\n+      // Read data from Process's stdout\n+      String stdout = read(copyOut.getInputStream());\n+\n+      // Read from Process's stderr, if data available\n+      String stderr = (proc.getErrorStream().available() != 0) ? read(proc.getErrorStream()) : null;\n+\n+      return new ExecResult(proc.exitValue(), stdout, stderr);\n+    } finally {\n+      if (proc != null) {\n+        proc.destroy();\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Create an object which can execute commands in Kubertenes container.\n+   *\n+   * @param pod The pod where the command is run", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM5OTc0NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418399745", "bodyText": "is run -> is to be run\nsame on next line", "author": "markxnelson", "createdAt": "2020-05-01T03:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzODA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzOTkyOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416639928", "bodyText": "an inline class that implements an abstract class defined in a different file seems really cumbersome", "author": "markxnelson", "createdAt": "2020-04-28T14:03:56Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1352,149 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy Process output to stdout\n+   * @param command The command to run\n+   * @return result of command execution\n+   * @throws IOException if an I/O error occurs.\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static ExecResult exec(V1Pod pod, String containerName, boolean redirectToStdout,\n+      String... command)\n+      throws IOException, ApiException, InterruptedException {\n+\n+    // Execute command using Kubernetes API\n+    KubernetesExec kubernetesExec = createKubernetesExec(pod, containerName);\n+    final Process proc = kubernetesExec.exec(command);\n+\n+    final CopyingOutputStream copyOut =\n+        redirectToStdout ? new CopyingOutputStream(System.out) : new CopyingOutputStream(null);\n+\n+    // Start a thread to begin reading the output stream of the command\n+    Thread out = null;\n+    try {\n+      out =\n+          new Thread(\n+              () -> {\n+                try {\n+                  ByteStreams.copy(proc.getInputStream(), copyOut);\n+                } catch (IOException ex) {\n+                  logger.warning(\"Exception reading from input stream.\", ex);\n+                }\n+              });\n+      out.start();\n+\n+      // wait for the Process, which represents the executing command, to terminate\n+      proc.waitFor();\n+\n+      // wait for reading thread to finish any last remaining output\n+      if (out != null) {\n+        out.join();\n+      }\n+\n+      // Read data from Process's stdout\n+      String stdout = read(copyOut.getInputStream());\n+\n+      // Read from Process's stderr, if data available\n+      String stderr = (proc.getErrorStream().available() != 0) ? read(proc.getErrorStream()) : null;\n+\n+      return new ExecResult(proc.exitValue(), stdout, stderr);\n+    } finally {\n+      if (proc != null) {\n+        proc.destroy();\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Create an object which can execute commands in Kubertenes container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @return object for executing a command in a container of the pod\n+   */\n+  public static KubernetesExec createKubernetesExec(V1Pod pod, String containerName) {\n+    KubernetesExec kubernetesExec = EXEC_FACTORY.create(pod, containerName);\n+    kubernetesExec.setStdin(stdin);\n+    kubernetesExec.setTty(tty);\n+    return kubernetesExec;\n+  }\n+\n   //------------------------\n+\n+  /**\n+   * KubernetesExec object for executing a command in the container of a pod.\n+   */\n+  public static class KubernetesExecImpl extends KubernetesExec {", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1MDM3OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418250379", "bodyText": "Simplified the implementation as your suggestion below.", "author": "lennyphan", "createdAt": "2020-04-30T19:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzOTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MDkwNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416640905", "bodyText": "fluent pattern does not use \"set\" prefix\nalso this field name is bad - i read \"stdin\" and i assume you mean the stdin - but you really mean something like \"do you want to have a stdin\" or something?? choose a better name", "author": "markxnelson", "createdAt": "2020-04-28T14:05:13Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExec.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.openapi.ApiException;\n+\n+/** A base class for an object which can execute a command in an Kubertenes containers. */\n+public abstract class KubernetesExec {\n+  private boolean stdin = true;\n+  private boolean tty = true;\n+\n+  boolean isStdin() {\n+    return stdin;\n+  }\n+\n+  public void setStdin(boolean stdin) {", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MTA4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416641084", "bodyText": "is -> has ??", "author": "markxnelson", "createdAt": "2020-04-28T14:05:28Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExec.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.openapi.ApiException;\n+\n+/** A base class for an object which can execute a command in an Kubertenes containers. */\n+public abstract class KubernetesExec {\n+  private boolean stdin = true;\n+  private boolean tty = true;\n+\n+  boolean isStdin() {", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MTYzMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416641633", "bodyText": "javadoc does not seem to describe what this abstract method is actually for", "author": "markxnelson", "createdAt": "2020-04-28T14:06:10Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExec.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.openapi.ApiException;\n+\n+/** A base class for an object which can execute a command in an Kubertenes containers. */\n+public abstract class KubernetesExec {\n+  private boolean stdin = true;\n+  private boolean tty = true;\n+\n+  boolean isStdin() {\n+    return stdin;\n+  }\n+\n+  public void setStdin(boolean stdin) {\n+    this.stdin = stdin;\n+  }\n+\n+  boolean isTty() {\n+    return tty;\n+  }\n+\n+  public void setTty(boolean tty) {\n+    this.tty = tty;\n+  }\n+\n+  /**\n+   * Execute a command in a container.", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MjIzMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r416642230", "bodyText": "way to much OOP going on here -- use the simple functional pattern with static methods and fluent api instead of all this", "author": "markxnelson", "createdAt": "2020-04-28T14:06:50Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExecFactory.java", "diffHunk": "@@ -0,0 +1,18 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import io.kubernetes.client.openapi.models.V1Pod;", "originalCommit": "8644f41c1ff804e07dd24397fc1f6abe72a8dc32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1MDc2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418250766", "bodyText": "Simplified the implementation to be more functional.", "author": "lennyphan", "createdAt": "2020-04-30T19:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MjIzMA=="}], "type": "inlineReview"}, {"oid": "631fb8d521fa11a10efd7978e5cb7c44020c612b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/631fb8d521fa11a10efd7978e5cb7c44020c612b", "message": "First code review changes", "committedDate": "2020-04-29T02:45:59Z", "type": "commit"}, {"oid": "6ae34c0403e0168df27c3da36a3ed3a8ef502731", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6ae34c0403e0168df27c3da36a3ed3a8ef502731", "message": "Merge remote-tracking branch 'origin/develop' into test-exec-cmd\n\nMerge more changes from develop before push.", "committedDate": "2020-04-29T02:46:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczMjQzNw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r417732437", "bodyText": "Why do we need multiple setters for \"pod\"?  And, are we doing fluent API or not?  This class seems to mix both.  For example line 50 and 64.", "author": "ddsharpe", "createdAt": "2020-04-30T03:24:30Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExec.java", "diffHunk": "@@ -0,0 +1,134 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.Exec;\n+import io.kubernetes.client.openapi.ApiClient;\n+import io.kubernetes.client.openapi.ApiException;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+\n+/**\n+ * KubernetesExec object for executing a command in the container of a pod.\n+ */\n+public class KubernetesExec {\n+  // the Kubernetes api client to dispatch the \"exec\" command\n+  private ApiClient apiClient;\n+\n+  // The Kubernetes pod where the command is to be run\n+  private V1Pod pod;\n+\n+  // the container in which the command is to be run\n+  private String containerName;\n+\n+  // If true, pass a stdin stream into the container\n+  private boolean passStdinAsStream;\n+\n+  // If true, stdin is a TTY (only applies if stdin is true)\n+  private boolean stdinIsTty;\n+\n+  public KubernetesExec apiClient(ApiClient apiClient) {\n+    this.apiClient = apiClient;\n+    return this;\n+  }\n+\n+  /**\n+   * Get the API client for these exec operations.\n+   *\n+   * @return The API client that will be used.\n+   */\n+  public ApiClient getApiClient() {\n+    return apiClient;\n+  }\n+\n+  public void setApiClient(ApiClient apiClient) {\n+    this.apiClient = apiClient;\n+  }\n+\n+  public KubernetesExec pod(V1Pod pod) {\n+    this.pod = pod;\n+    return this;\n+  }\n+\n+  /**\n+   * Get the Kubernetes pod where the command is to be run.\n+   *\n+   * @return Kubernetes pod object\n+   */\n+  public V1Pod getPod() {\n+    return pod;\n+  }\n+\n+  public void setPod(V1Pod pod) {", "originalCommit": "6ae34c0403e0168df27c3da36a3ed3a8ef502731", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczNjQ1Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r417736452", "bodyText": "yes, it is a mix.  I was looking at the K8s api resource objects and our model objects and fashioned it after them but realized that they have set/get methods in order  to be serialized/de-serialized using the JSON/YAML libraries.  I can clean it up to have the more fluent api look.  Thanks", "author": "lennyphan", "createdAt": "2020-04-30T03:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczMjQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1MDk4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418250982", "bodyText": "Removed set/get methods since not necessary.", "author": "lennyphan", "createdAt": "2020-04-30T19:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczMjQzNw=="}], "type": "inlineReview"}, {"oid": "0d25691e8df77ab190322d15f23f36d55ff528fe", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0d25691e8df77ab190322d15f23f36d55ff528fe", "message": "Remove set/get methods in KubernetesExec", "committedDate": "2020-04-30T04:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM5OTg2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418399863", "bodyText": "this method names seems too generic - what does read mean?", "author": "markxnelson", "createdAt": "2020-05-01T03:23:09Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1327,5 +1368,127 @@ public static boolean deleteClusterRoleBinding(String name) {\n     return true;\n   }\n \n+  // --------------------------- Exec   ---------------------------\n+\n+  /**\n+   * Execute a command in a container.\n+   *\n+   * @param pod The pod where the command is to be run\n+   * @param containerName The container in the Pod where the command is to be run. If no\n+   *     container name is provided than the first container in the Pod is used.\n+   * @param redirectToStdout copy process output to stdout\n+   * @param command The command to run\n+   * @return result of command execution\n+   * @throws IOException if an I/O error occurs.\n+   * @throws ApiException if Kubernetes client API call fails\n+   * @throws InterruptedException if any thread has interrupted the current thread\n+   */\n+  public static ExecResult exec(V1Pod pod, String containerName, boolean redirectToStdout,\n+      String... command)\n+      throws IOException, ApiException, InterruptedException {\n+\n+    // Execute command using Kubernetes API\n+    KubernetesExec kubernetesExec = createKubernetesExec(pod, containerName);\n+    final Process proc = kubernetesExec.exec(command);\n+\n+    final CopyingOutputStream copyOut =\n+        redirectToStdout ? new CopyingOutputStream(System.out) : new CopyingOutputStream(null);\n+\n+    // Start a thread to begin reading the output stream of the command\n+    Thread out = null;\n+    try {\n+      out =\n+          new Thread(\n+              () -> {\n+                try {\n+                  ByteStreams.copy(proc.getInputStream(), copyOut);\n+                } catch (IOException ex) {\n+                  // \"Pipe broken\" is expected when process is finished so don't log\n+                  if (ex.getMessage() != null && !ex.getMessage().contains(\"Pipe broken\")) {\n+                    logger.warning(\"Exception reading from input stream.\", ex);\n+                  }\n+                }\n+              });\n+      out.start();\n+\n+      // wait for the process, which represents the executing command, to terminate\n+      proc.waitFor();\n+\n+      // wait for reading thread to finish any last remaining output\n+      if (out != null) {\n+        out.join();\n+      }\n+\n+      // Read data from process's stdout\n+      String stdout = read(copyOut.getInputStream());\n+\n+      // Read from process's stderr, if data available\n+      String stderr = (proc.getErrorStream().available() != 0) ? read(proc.getErrorStream()) : null;\n+\n+      return new ExecResult(proc.exitValue(), stdout, stderr);\n+    } finally {\n+      if (proc != null) {\n+        proc.destroy();\n+      }\n+    }\n+  }\n+\n+  /**\n+   * Create an object which can execute commands in a Kubernetes container.\n+   *\n+   * @param pod The pod where the command is run\n+   * @param containerName The container in the Pod where the command is run. If no container\n+   *     name is provided than the first container in the Pod is used.\n+   * @return object for executing a command in a container of the pod\n+   */\n+  public static KubernetesExec createKubernetesExec(V1Pod pod, String containerName) {\n+    return new KubernetesExec()\n+        .apiClient(apiClient) // the Kubernetes api client to dispatch the \"exec\" command\n+        .pod(pod) // The pod where the command is to be run\n+        .containerName(containerName) // the container in which the command is to be run\n+        .passStdinAsStream() // pass a stdin stream into the container\n+        .stdinIsTty(); // stdin is a TTY (only applies if stdin is true)\n+  }\n+\n   //------------------------\n+\n+  private static String read(InputStream is) throws IOException {", "originalCommit": "0d25691e8df77ab190322d15f23f36d55ff528fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b92b73b69d80c49b03e8b79989ea3194ddf3964", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2b92b73b69d80c49b03e8b79989ea3194ddf3964", "message": "minor changes from latest review", "committedDate": "2020-05-01T04:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODU5Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418558596", "bodyText": "Javadoc in this class is VERY sparse.  Please increase the coverage", "author": "ddsharpe", "createdAt": "2020-05-01T14:13:11Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/KubernetesExec.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes.actions.impl.primitive;\n+\n+import java.io.IOException;\n+\n+import io.kubernetes.client.Exec;\n+import io.kubernetes.client.openapi.ApiClient;\n+import io.kubernetes.client.openapi.ApiException;\n+import io.kubernetes.client.openapi.models.V1Pod;\n+\n+/**\n+ * KubernetesExec object for executing a command in the container of a pod.\n+ */\n+public class KubernetesExec {\n+  // the Kubernetes api client to dispatch the \"exec\" command\n+  private ApiClient apiClient;\n+\n+  // The Kubernetes pod where the command is to be run\n+  private V1Pod pod;\n+\n+  // the container in which the command is to be run\n+  private String containerName;\n+\n+  // If true, pass a stdin stream into the container\n+  private boolean passStdinAsStream;\n+\n+  // If true, stdin is a TTY (only applies if stdin is true)\n+  private boolean stdinIsTty;\n+\n+  public KubernetesExec apiClient(ApiClient apiClient) {\n+    this.apiClient = apiClient;\n+    return this;\n+  }\n+\n+  public KubernetesExec pod(V1Pod pod) {\n+    this.pod = pod;\n+    return this;\n+  }\n+\n+\n+  public KubernetesExec containerName(String containerName) {\n+    this.containerName = containerName;\n+    return this;\n+  }\n+\n+  public KubernetesExec passStdinAsStream() {\n+    this.passStdinAsStream = true;\n+    return this;\n+  }\n+\n+  public KubernetesExec stdinIsTty() {", "originalCommit": "2b92b73b69d80c49b03e8b79989ea3194ddf3964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU3NDM0Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1604#discussion_r418574346", "bodyText": "Updated with javadoc.", "author": "lennyphan", "createdAt": "2020-05-01T14:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODU5Ng=="}], "type": "inlineReview"}, {"oid": "5d6311cf2f5d141157a51d0762b6f59b1a6b6a1c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5d6311cf2f5d141157a51d0762b6f59b1a6b6a1c", "message": "Boost java description of methods", "committedDate": "2020-05-01T14:46:21Z", "type": "commit"}]}