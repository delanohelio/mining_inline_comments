{"pr_number": 1757, "pr_title": "converted ItMonitorintExporter tests to junit5", "pr_createdAt": "2020-06-22T18:42:35Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757", "timeline": [{"oid": "4c0f0e35830cc64e1a4972185b0c09eba2133622", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4c0f0e35830cc64e1a4972185b0c09eba2133622", "message": "added prom support", "committedDate": "2020-05-27T17:07:38Z", "type": "commit"}, {"oid": "3a6d44b33048c9e8093ddfd5be6dc3e04d7fbdc3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3a6d44b33048c9e8093ddfd5be6dc3e04d7fbdc3", "message": "merge", "committedDate": "2020-05-27T17:13:03Z", "type": "commit"}, {"oid": "9733f9718e65f6587ff570e5dcab17022aefd94f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9733f9718e65f6587ff570e5dcab17022aefd94f", "message": "added support for coord, webhook", "committedDate": "2020-06-01T02:02:05Z", "type": "commit"}, {"oid": "83bce0092691778587c4c8f720b919d9b93f405b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/83bce0092691778587c4c8f720b919d9b93f405b", "message": "merge with develop", "committedDate": "2020-06-01T02:28:06Z", "type": "commit"}, {"oid": "8d21ca470d7aca52f0c1d8216f0e80c107c7b79f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8d21ca470d7aca52f0c1d8216f0e80c107c7b79f", "message": "fixed typos", "committedDate": "2020-06-01T02:36:11Z", "type": "commit"}, {"oid": "3619c1d635d83424b5ce0900baf62bd7411b7b57", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3619c1d635d83424b5ce0900baf62bd7411b7b57", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-01T15:39:18Z", "type": "commit"}, {"oid": "8b663d70caf24fedd788eba4c475f1f5089dfe80", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8b663d70caf24fedd788eba4c475f1f5089dfe80", "message": "added support to deploy archived file", "committedDate": "2020-06-02T17:38:28Z", "type": "commit"}, {"oid": "ec54129757cfa6aadb61140cc278f7621eebab8e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ec54129757cfa6aadb61140cc278f7621eebab8e", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-02T17:38:40Z", "type": "commit"}, {"oid": "953e86eefe00968e4cee5d52561f12e679324d71", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/953e86eefe00968e4cee5d52561f12e679324d71", "message": "fixed monexp app check", "committedDate": "2020-06-02T18:11:34Z", "type": "commit"}, {"oid": "f54e67f3dd40ef1940572b6e81ca203e7ef275a2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f54e67f3dd40ef1940572b6e81ca203e7ef275a2", "message": "fixed style", "committedDate": "2020-06-02T22:43:03Z", "type": "commit"}, {"oid": "274e36bb2af2eec639a0f90523faa9a5ad00c99b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/274e36bb2af2eec639a0f90523faa9a5ad00c99b", "message": "fixed style1", "committedDate": "2020-06-02T22:45:26Z", "type": "commit"}, {"oid": "fd2a7e3b627d8221cb39635fac9cfde87f45ef1c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fd2a7e3b627d8221cb39635fac9cfde87f45ef1c", "message": "fixed push image", "committedDate": "2020-06-03T02:11:01Z", "type": "commit"}, {"oid": "15f2f56078fe2583236ac6d90b23b9915e9e1060", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/15f2f56078fe2583236ac6d90b23b9915e9e1060", "message": "fixed style", "committedDate": "2020-06-03T15:10:37Z", "type": "commit"}, {"oid": "336fcf99713b9352a9cae4a7fcbccfcdf2087d17", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/336fcf99713b9352a9cae4a7fcbccfcdf2087d17", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-03T15:10:46Z", "type": "commit"}, {"oid": "a3d918be49df6f22c650ab52cc21f79be9b2fbe0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a3d918be49df6f22c650ab52cc21f79be9b2fbe0", "message": "fixed deployment delete", "committedDate": "2020-06-03T16:10:04Z", "type": "commit"}, {"oid": "8308ec0ed935b1bf89f3477a6b30ca29c7b2332a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8308ec0ed935b1bf89f3477a6b30ca29c7b2332a", "message": "cleanup", "committedDate": "2020-06-03T17:10:08Z", "type": "commit"}, {"oid": "f8828d6bc3e02d9e4e8b2c382a17db5fe842e7cb", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f8828d6bc3e02d9e4e8b2c382a17db5fe842e7cb", "message": "cleanup", "committedDate": "2020-06-03T17:13:25Z", "type": "commit"}, {"oid": "6c0069fcdd5dd1b5c17bc523c57b421ab4210cd6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6c0069fcdd5dd1b5c17bc523c57b421ab4210cd6", "message": "cleanup", "committedDate": "2020-06-03T17:22:22Z", "type": "commit"}, {"oid": "af1b8a8538a46bca0eae23e250fc85439b71e0d6", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/af1b8a8538a46bca0eae23e250fc85439b71e0d6", "message": "addressed comments from review", "committedDate": "2020-06-04T23:18:31Z", "type": "commit"}, {"oid": "9a2a8c241214d86f1ff46ba85e3b4a146272a595", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9a2a8c241214d86f1ff46ba85e3b4a146272a595", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-04T23:18:39Z", "type": "commit"}, {"oid": "5633729bddf3c70f1ed36f67cd176dbbf3a2f82e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5633729bddf3c70f1ed36f67cd176dbbf3a2f82e", "message": "checkstyle", "committedDate": "2020-06-05T00:01:54Z", "type": "commit"}, {"oid": "c154d759b9e59d3c5589e99da7d3673ddb6b7aa4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c154d759b9e59d3c5589e99da7d3673ddb6b7aa4", "message": "fixed logic", "committedDate": "2020-06-05T06:29:39Z", "type": "commit"}, {"oid": "05b7044280e0dca89df35a1e7ebd4d7b4da1f3e2", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/05b7044280e0dca89df35a1e7ebd4d7b4da1f3e2", "message": "modified isPodReady", "committedDate": "2020-06-05T19:48:41Z", "type": "commit"}, {"oid": "eb12375980da4a7c2fd2639ebcb4bd78d2e8ac58", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/eb12375980da4a7c2fd2639ebcb4bd78d2e8ac58", "message": "merge", "committedDate": "2020-06-05T19:50:51Z", "type": "commit"}, {"oid": "cf6004aba59b0987486d4f5cb8bc0edea3e4820d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cf6004aba59b0987486d4f5cb8bc0edea3e4820d", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-08T15:31:13Z", "type": "commit"}, {"oid": "f53a37a1d6397f70bfaca98042e1b37b0e8d2c64", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f53a37a1d6397f70bfaca98042e1b37b0e8d2c64", "message": "moved replaceString to testutils", "committedDate": "2020-06-08T15:34:59Z", "type": "commit"}, {"oid": "3b4c1de8795dd86e2deae8bfcc8ecd8715f26efa", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3b4c1de8795dd86e2deae8bfcc8ecd8715f26efa", "message": "fixed comments, changed map processing", "committedDate": "2020-06-08T17:38:39Z", "type": "commit"}, {"oid": "42801409d9da53d46169e82743d2dc9a6acf0abc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/42801409d9da53d46169e82743d2dc9a6acf0abc", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-09T15:16:02Z", "type": "commit"}, {"oid": "128ce9fd695305f280a85dc93002ad908c5e0b30", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/128ce9fd695305f280a85dc93002ad908c5e0b30", "message": "deleted unused vars, split methods", "committedDate": "2020-06-09T15:48:11Z", "type": "commit"}, {"oid": "1871c2db1014d65e8f410d3087a41cb1bb650c89", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1871c2db1014d65e8f410d3087a41cb1bb650c89", "message": "replaced with descriptive var name, fixed processing of multiple webapps files", "committedDate": "2020-06-09T17:22:44Z", "type": "commit"}, {"oid": "6c43e2ac0d51de5091fc767e606b3ea388a4f254", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6c43e2ac0d51de5091fc767e606b3ea388a4f254", "message": "style", "committedDate": "2020-06-09T17:42:56Z", "type": "commit"}, {"oid": "a15a27cbbd0a157aeb79fd9efe20015ef86d22b9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a15a27cbbd0a157aeb79fd9efe20015ef86d22b9", "message": "typo", "committedDate": "2020-06-09T21:14:18Z", "type": "commit"}, {"oid": "a7e47e3c85a81341963e7c6f4b024609f5e1b1f0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a7e47e3c85a81341963e7c6f4b024609f5e1b1f0", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest", "committedDate": "2020-06-09T21:37:17Z", "type": "commit"}, {"oid": "07f8221366e971e96609e15d72ef5164b93831ed", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/07f8221366e971e96609e15d72ef5164b93831ed", "message": "added endtoend", "committedDate": "2020-06-14T16:03:23Z", "type": "commit"}, {"oid": "99d1d5bd8bdc9dd4b20e4c5963a5da99254941e1", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/99d1d5bd8bdc9dd4b20e4c5963a5da99254941e1", "message": "merge", "committedDate": "2020-06-14T16:14:40Z", "type": "commit"}, {"oid": "5df72cd0ed90e5e0324121f1d1bb0fab90786211", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5df72cd0ed90e5e0324121f1d1bb0fab90786211", "message": "merged bhavani impl", "committedDate": "2020-06-14T17:35:27Z", "type": "commit"}, {"oid": "a5ce0f13e152962abc1196686d0872e94c7db9cd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a5ce0f13e152962abc1196686d0872e94c7db9cd", "message": "fixed scaling", "committedDate": "2020-06-15T16:26:48Z", "type": "commit"}, {"oid": "e5d2117b91264f08366d6d3c7f82ae734ce6f640", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e5d2117b91264f08366d6d3c7f82ae734ce6f640", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest1", "committedDate": "2020-06-15T23:47:28Z", "type": "commit"}, {"oid": "b5da933c6c7ae6f091977a1e95f9c70caba445d7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b5da933c6c7ae6f091977a1e95f9c70caba445d7", "message": "added func tests", "committedDate": "2020-06-18T18:53:01Z", "type": "commit"}, {"oid": "f11b85c268cf876bc290cfc47e20c1056f849346", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f11b85c268cf876bc290cfc47e20c1056f849346", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest2", "committedDate": "2020-06-18T18:54:40Z", "type": "commit"}, {"oid": "806066f4dd6fffa23c696bb67fe869c759e65594", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/806066f4dd6fffa23c696bb67fe869c759e65594", "message": "fixed logic", "committedDate": "2020-06-19T17:58:52Z", "type": "commit"}, {"oid": "6f30b5a426bcc615d98bd4e9acbda80ac306649f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6f30b5a426bcc615d98bd4e9acbda80ac306649f", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest2", "committedDate": "2020-06-19T18:00:40Z", "type": "commit"}, {"oid": "243eda14dc357b3a235e30ff57ef5666635a193c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/243eda14dc357b3a235e30ff57ef5666635a193c", "message": "fix", "committedDate": "2020-06-20T20:32:43Z", "type": "commit"}, {"oid": "e4b39a34f9ac56e2508a634ab6e8194c3d3dc669", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e4b39a34f9ac56e2508a634ab6e8194c3d3dc669", "message": "merge", "committedDate": "2020-06-20T21:06:08Z", "type": "commit"}, {"oid": "2bd5bfb3ee70385480b851038e7766f6665fe340", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2bd5bfb3ee70385480b851038e7766f6665fe340", "message": " added fix", "committedDate": "2020-06-21T21:52:33Z", "type": "commit"}, {"oid": "757f40a90e3108c4e5cb2b80dcfc4a04b58d2f87", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/757f40a90e3108c4e5cb2b80dcfc4a04b58d2f87", "message": "fix logic", "committedDate": "2020-06-22T03:35:31Z", "type": "commit"}, {"oid": "3bbe9ed75398391152bbec2152819b83b03bad59", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3bbe9ed75398391152bbec2152819b83b03bad59", "message": "fixed test", "committedDate": "2020-06-22T18:25:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5Nzc4OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444297789", "bodyText": "Dongbo has refactored a method to use common code, please see if that is useful here.\nhttps://github.com/oracle/weblogic-kubernetes-operator/pull/1759/files#diff-563c7e0923febf5308b79abec0486d46", "author": "sankarpn", "createdAt": "2020-06-23T15:07:06Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -226,112 +256,380 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     installMonitoringExporter();\n \n     // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MDUxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444390510", "bodyText": "I add request to add domain creation based on custom image name, right now it uses prebuilt image. in my test I have prop files based image creation", "author": "marinakog", "createdAt": "2020-06-23T17:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5Nzc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwMjczMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444302732", "bodyText": "Please fix punctuation. It looks like this when javadoc is viewed.\nTest covers end to end sample, provided in the Monitoring Exporter github project . Create Prometheus, Grafana, Webhook, Coordinator create domain in Image with monitoring exporter verify access to monitoring exporter WebLogic metrics via nginx check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana fire Alert using Webhook change prometheus to add different domain to monitor", "author": "sankarpn", "createdAt": "2020-06-23T15:14:10Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -226,112 +256,380 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     installMonitoringExporter();\n \n     // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n     // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     // create ingress for the domain\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    //create pv and pvc for monitoring\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n    * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * create domain in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * fire Alert using Webhook", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NjcyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445096724", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-24T18:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwMjczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwNjc2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444306763", "bodyText": "The above comments can be logged as messages, easier to debug when test fails.", "author": "sankarpn", "createdAt": "2020-06-23T15:19:43Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -226,112 +256,380 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     installMonitoringExporter();\n \n     // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n     // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     // create ingress for the domain\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    //create pv and pvc for monitoring\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n    * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * create domain in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * fire Alert using Webhook\n+   * change prometheus to add different domain to monitor\n    */\n   @Test\n-  @DisplayName(\"Install Prometheus, Grafana , Webhook, Coordinator and verify WebLogic metrics\")\n-  public void testCheckMetrics() throws Exception {\n+  @DisplayName(\"Test End to End example from MonitoringExporter github project.\")\n+  public void testEndToEndViaChart() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      // create and verify one cluster wdt domain\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      ingressHost2List =\n+              createIngressForDomainAndVerify(domain2Uid, domain2Namespace, clusterNameMsPortMap);\n+\n+      installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+              domain2Namespace,\n+              domain2Uid);\n+\n+      installWebhook();\n+      installCoordinator(domain2Namespace);\n+\n+      //verify access to Monitoring Exporter\n+      verifyMonExpAppAccessThroughNginx(ingressHost2List.get(0), managedServersCount);\n+      //verify metrics via prometheus\n+      String testappPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22test-webapp%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(testappPrometheusSearchKey, \"test-webapp\");\n+      //fire alert by scaling down\n+      fireAlert();\n+      //switch to monitor another domain", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NjgyMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445096821", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-24T18:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwNjc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwNzE4NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444307185", "bodyText": "Fix javadoc", "author": "sankarpn", "createdAt": "2020-06-23T15:20:20Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -226,112 +256,380 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     installMonitoringExporter();\n \n     // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n     // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     // create ingress for the domain\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    //create pv and pvc for monitoring\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n    * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * create domain in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * fire Alert using Webhook\n+   * change prometheus to add different domain to monitor\n    */\n   @Test\n-  @DisplayName(\"Install Prometheus, Grafana , Webhook, Coordinator and verify WebLogic metrics\")\n-  public void testCheckMetrics() throws Exception {\n+  @DisplayName(\"Test End to End example from MonitoringExporter github project.\")\n+  public void testEndToEndViaChart() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      // create and verify one cluster wdt domain\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      ingressHost2List =\n+              createIngressForDomainAndVerify(domain2Uid, domain2Namespace, clusterNameMsPortMap);\n+\n+      installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+              domain2Namespace,\n+              domain2Uid);\n+\n+      installWebhook();\n+      installCoordinator(domain2Namespace);\n+\n+      //verify access to Monitoring Exporter\n+      verifyMonExpAppAccessThroughNginx(ingressHost2List.get(0), managedServersCount);\n+      //verify metrics via prometheus\n+      String testappPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22test-webapp%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(testappPrometheusSearchKey, \"test-webapp\");\n+      //fire alert by scaling down\n+      fireAlert();\n+      //switch to monitor another domain\n+      String oldRegex = String.format(\"regex: %s;%s;%s\", domain2Namespace, domain2Uid, clusterName);\n+      String newRegex = String.format(\"regex: %s;%s;%s\", domain1Namespace, domain1Uid, clusterName);\n+      editPrometheusCM(oldRegex, newRegex);\n+      String sessionAppPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22myear%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(sessionAppPrometheusSearchKey, \"sessmigr\");\n+      checkPromGrafanaLatestVersion();\n+    } finally {\n+      // shutdown domain2\n+      logger.info(\"Shutting down domain2\");\n+      assertTrue(shutdownDomain(domain2Uid, domain2Namespace),\n+              String.format(\"shutdown domain %s in namespace %s failed\", domain2Uid, domain2Namespace));\n+    }\n+  }\n \n-    installPrometheusGrafana();\n-    installWebhookCoordinator();\n+  /**\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n+   * Create Prometheus, Grafana\n+   * create Model in Image with monitoring exporter\n+   * verify access to monitoring exporter WebLogic metrics via nginx\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * check basic functionality of monitoring exporter\n+   */", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5Njg4MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445096880", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-24T18:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwNzE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNTQxOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444315419", "bodyText": "You might want to wait until the job is done and report any error if it fails. Please see createDomainJob in ItIntrospectVersion", "author": "sankarpn", "createdAt": "2020-06-23T15:31:21Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -602,65 +921,70 @@ private static void createCoordinator(String image,\n                                         String imagePullPolicy,\n                                         String namespace,\n                                         String secretName) throws ApiException {\n-    Map labels = new HashMap<String, String>();\n-    labels.put(\"app\", \"coordinator\");\n-    coordinatorDepl = new V1Deployment()\n-        .apiVersion(\"apps/v1\")\n-        .kind(\"Deployment\")\n-        .metadata(new V1ObjectMeta()\n-            .name(\"coordinator\")\n-            .namespace(namespace)\n-            .labels(labels))\n-        .spec(new V1DeploymentSpec()\n-            .replicas(1)\n-            .selector(new V1LabelSelector()\n-                .matchLabels(labels))\n-            .strategy(new V1DeploymentStrategy()\n-            .type(\"Recreate\"))\n-            .template(new V1PodTemplateSpec()\n-                .metadata(new V1ObjectMeta()\n-                    .labels(labels))\n-                .spec(new V1PodSpec()\n-                    .containers(Arrays.asList(\n-                        new V1Container()\n-                            .image(image)\n-                            .imagePullPolicy(imagePullPolicy)\n-                            .name(\"coordinator\")\n-                    .ports(Arrays.asList(\n-                        new V1ContainerPort()\n-                        .containerPort(8999)))))\n-                    .imagePullSecrets(Arrays.asList(\n-                        new V1LocalObjectReference()\n-                            .name(secretName))))));\n-\n-    logger.info(\"Create deployment for coordinator in namespace {0}\",\n-        namespace);\n-    boolean deploymentCreated = assertDoesNotThrow(() -> Kubernetes.createDeployment(coordinatorDepl),\n-        String.format(\"Create deployment failed with ApiException for coordinator in namespace %s\",\n-            namespace));\n-    assertTrue(deploymentCreated, String.format(\n-        \"Create deployment failed with ApiException for coordinator in namespace %s \",\n-        namespace));\n-\n-    coordinatorService = new V1Service()\n-        .metadata(new V1ObjectMeta()\n-            .name(\"coordinator\")\n-            .namespace(namespace)\n-            .labels(labels))\n-        .spec(new V1ServiceSpec()\n-            .ports(Arrays.asList(\n-                new V1ServicePort()\n-                    .port(8999)\n-                    .targetPort(new IntOrString(8999))))\n-            .type(\"NodePort\")\n-            .selector(labels));\n-\n-    logger.info(\"Create service for coordinator in namespace {0}\",\n-        namespace);\n-    boolean success = assertDoesNotThrow(() -> Kubernetes.createService(coordinatorService),\n-        String.format(\"Create service failed with ApiException for coordinator in namespace %s\",\n-            namespace));\n-    assertTrue(success, \"Coordinator service creation failed\");\n+    if (coordinatorDepl == null) {\n+      Map labels = new HashMap<String, String>();\n+      labels.put(\"app\", \"coordinator\");\n+      coordinatorDepl = new V1Deployment()\n+              .apiVersion(\"apps/v1\")\n+              .kind(\"Deployment\")\n+              .metadata(new V1ObjectMeta()\n+                      .name(\"coordinator\")\n+                      .namespace(namespace)\n+                      .labels(labels))\n+              .spec(new V1DeploymentSpec()\n+                      .replicas(1)\n+                      .selector(new V1LabelSelector()\n+                              .matchLabels(labels))\n+                      .strategy(new V1DeploymentStrategy()\n+                              .type(\"Recreate\"))\n+                      .template(new V1PodTemplateSpec()\n+                              .metadata(new V1ObjectMeta()\n+                                      .labels(labels))\n+                              .spec(new V1PodSpec()\n+                                      .containers(Arrays.asList(\n+                                              new V1Container()\n+                                                      .image(image)\n+                                                      .imagePullPolicy(imagePullPolicy)\n+                                                      .name(\"coordinator\")\n+                                                      .ports(Arrays.asList(\n+                                                              new V1ContainerPort()\n+                                                                      .containerPort(8999)))))\n+                                      .imagePullSecrets(Arrays.asList(\n+                                              new V1LocalObjectReference()\n+                                                      .name(secretName))))));\n+\n+      logger.info(\"Create deployment for coordinator in namespace {0}\",\n+              namespace);\n+      boolean deploymentCreated = assertDoesNotThrow(() -> Kubernetes.createDeployment(coordinatorDepl),\n+              String.format(\"Create deployment failed with ApiException for coordinator in namespace %s\",\n+                      namespace));\n+      assertTrue(deploymentCreated, String.format(\n+              \"Create deployment failed with ApiException for coordinator in namespace %s \",\n+              namespace));", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5Njk2NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445096964", "bodyText": "added check for depl", "author": "marinakog", "createdAt": "2020-06-24T18:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNTQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNzQ2MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444317461", "bodyText": "you don't need this check, podReady does both", "author": "sankarpn", "createdAt": "2020-06-23T15:34:28Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -816,96 +1147,177 @@ private static String createAndVerifyDomainImage() {\n     // build the model file list\n     final List<String> modelList = Collections.singletonList(MODEL_DIR + \"/\" + MONEXP_MODEL_FILE);\n     miiImage =\n-        createMiiImageAndVerify(MONEXP_IMAGE_NAME, modelList, appList);\n+            createMiiImageAndVerify(MONEXP_IMAGE_NAME, modelList, appList);\n \n     // docker login and push image to docker registry if necessary\n     dockerLoginAndPushImageToRegistry(miiImage);\n \n     // create docker registry secret to pull the image from registry\n     logger.info(\"Create docker registry secret in namespace {0}\", domain1Namespace);\n     assertDoesNotThrow(() -> createDockerRegistrySecret(domain1Namespace),\n-        String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n+            String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n \n     return miiImage;\n   }\n \n-  private static void createAndVerifyDomain(String miiImage, String domainUid) {\n+  /**\n+   * Create and verify domain in image from endtoend sample topology with monitoring exporter.\n+   * @return image name\n+   */\n+  private static String createAndVerifyDomainInImage() {\n+    // create image with model files\n+    logger.info(\"Create image with model file with monitoring exporter app and verify\");\n+    String app1Path = String.format(\"%s/wls-exporter.war\", monitoringExporterAppDir);\n+    String app2Path = String.format(\"%s/../src/integration-tests/apps/testwebapp.war\", ITTESTS_DIR);\n+\n+    List<String> appList = new ArrayList();\n+    appList.add(app1Path);\n+    appList.add(app2Path);\n+\n+    final int t3ChannelPort = getNextFreePort(31000, 32767);  // the port range has to be between 30,000 to 32,767\n+\n+    Properties p = new Properties();\n+    p.setProperty(\"ADMIN_USER\", ADMIN_USERNAME_DEFAULT);\n+    p.setProperty(\"ADMIN_PWD\", ADMIN_PASSWORD_DEFAULT);\n+    p.setProperty(\"DOMAIN_NAME\", domain2Uid);\n+    p.setProperty(\"ADMIN_NAME\", \"admin-server\");\n+    p.setProperty(\"PRODUCTION_MODE_ENABLED\", \"true\");\n+    p.setProperty(\"CLUSTER_NAME\", clusterName);\n+    p.setProperty(\"CLUSTER_TYPE\", \"DYNAMIC\");\n+    p.setProperty(\"CONFIGURED_MANAGED_SERVER_COUNT\", \"2\");\n+    p.setProperty(\"MANAGED_SERVER_NAME_BASE\", \"managed-server\");\n+    p.setProperty(\"T3_CHANNEL_PORT\", Integer.toString(t3ChannelPort));\n+    p.setProperty(\"T3_PUBLIC_ADDRESS\", K8S_NODEPORT_HOST);\n+    p.setProperty(\"MANAGED_SERVER_PORT\", \"8001\");\n+    p.setProperty(\"SERVER_START_MODE\", \"prod\");\n+    p.setProperty(\"ADMIN_PORT\", \"7001\");\n+    p.setProperty(\"MYSQL_USER\", \"wluser1\");\n+    p.setProperty(\"MYSQL_PWD\", \"wlpwd123\");\n+    // create a temporary WebLogic domain property file as a input for WDT model file\n+    File domainPropertiesFile = assertDoesNotThrow(() ->\n+                    File.createTempFile(\"domain\", \"properties\"),\n+            \"Failed to create domain properties file\");\n+    assertDoesNotThrow(() ->\n+                    p.store(new FileOutputStream(domainPropertiesFile), \"WDT properties file\"),\n+            \"Failed to write domain properties file\");\n+\n+    final List<String> propertyList = Collections.singletonList(domainPropertiesFile.getPath());\n+\n+    // build the model file list\n+    final List<String> modelList = Collections.singletonList(monitoringExporterEndToEndDir\n+            + MONEXP_WDT_FILE);\n+\n+    wdtImage =\n+        createImageAndVerify(MONEXP_IMAGE_NAME,\n+                modelList,\n+                appList,\n+                propertyList,\n+                WLS_BASE_IMAGE_NAME,\n+                WLS_BASE_IMAGE_TAG,\n+                WLS,\n+                false,\n+                domain2Uid, true);\n+\n+\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(wdtImage);\n+\n+    // create docker registry secret to pull the image from registry\n+    logger.info(\"Create docker registry secret in namespace {0}\", domain2Namespace);\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domain2Namespace),\n+        String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n+\n+    return wdtImage;\n+  }\n+\n+  //create domain from provided image and verify it's start\n+  private static void createAndVerifyDomain(String miiImage,\n+                                            String domainUid,\n+                                            String namespace,\n+                                            String domainHomeSource,\n+                                            int replicaCount) {\n     // create secret for admin credentials\n     logger.info(\"Create secret for admin credentials\");\n     String adminSecretName = \"weblogic-credentials\";\n-    assertDoesNotThrow(() -> createSecretWithUsernamePassword(adminSecretName, domain1Namespace,\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(adminSecretName, namespace,\n         \"weblogic\", \"welcome1\"),\n         String.format(\"create secret for admin credentials failed for %s\", adminSecretName));\n \n     // create encryption secret\n     logger.info(\"Create encryption secret\");\n     String encryptionSecretName = \"encryptionsecret\";\n-    assertDoesNotThrow(() -> createSecretWithUsernamePassword(encryptionSecretName, domain1Namespace,\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(encryptionSecretName, namespace,\n         \"weblogicenc\", \"weblogicenc\"),\n         String.format(\"create encryption secret failed for %s\", encryptionSecretName));\n \n     // create domain and verify\n     logger.info(\"Create model in image domain {0} in namespace {1} using docker image {2}\",\n-        domainUid, domain1Namespace, miiImage);\n-    createDomainCrAndVerify(adminSecretName, REPO_SECRET_NAME, encryptionSecretName, miiImage,domainUid);\n-\n+        domainUid, namespace, miiImage);\n+    createDomainCrAndVerify(adminSecretName, REPO_SECRET_NAME, encryptionSecretName, miiImage,domainUid,\n+            namespace, domainHomeSource, replicaCount);\n+    String adminServerPodName = domainUid + \"-admin-server\";\n     // check that admin server pod exists in the domain namespace\n     logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n-        adminServerPodName, domain1Namespace);\n-    checkPodExists(adminServerPodName, domainUid, domain1Namespace);\n+        adminServerPodName, namespace);", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NzAzOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445097039", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-24T18:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNzQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNzcyMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444317720", "bodyText": "this has to be done before podReady, pod will never become ready when service creation fails.", "author": "sankarpn", "createdAt": "2020-06-23T15:34:53Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -816,96 +1147,177 @@ private static String createAndVerifyDomainImage() {\n     // build the model file list\n     final List<String> modelList = Collections.singletonList(MODEL_DIR + \"/\" + MONEXP_MODEL_FILE);\n     miiImage =\n-        createMiiImageAndVerify(MONEXP_IMAGE_NAME, modelList, appList);\n+            createMiiImageAndVerify(MONEXP_IMAGE_NAME, modelList, appList);\n \n     // docker login and push image to docker registry if necessary\n     dockerLoginAndPushImageToRegistry(miiImage);\n \n     // create docker registry secret to pull the image from registry\n     logger.info(\"Create docker registry secret in namespace {0}\", domain1Namespace);\n     assertDoesNotThrow(() -> createDockerRegistrySecret(domain1Namespace),\n-        String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n+            String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n \n     return miiImage;\n   }\n \n-  private static void createAndVerifyDomain(String miiImage, String domainUid) {\n+  /**\n+   * Create and verify domain in image from endtoend sample topology with monitoring exporter.\n+   * @return image name\n+   */\n+  private static String createAndVerifyDomainInImage() {\n+    // create image with model files\n+    logger.info(\"Create image with model file with monitoring exporter app and verify\");\n+    String app1Path = String.format(\"%s/wls-exporter.war\", monitoringExporterAppDir);\n+    String app2Path = String.format(\"%s/../src/integration-tests/apps/testwebapp.war\", ITTESTS_DIR);\n+\n+    List<String> appList = new ArrayList();\n+    appList.add(app1Path);\n+    appList.add(app2Path);\n+\n+    final int t3ChannelPort = getNextFreePort(31000, 32767);  // the port range has to be between 30,000 to 32,767\n+\n+    Properties p = new Properties();\n+    p.setProperty(\"ADMIN_USER\", ADMIN_USERNAME_DEFAULT);\n+    p.setProperty(\"ADMIN_PWD\", ADMIN_PASSWORD_DEFAULT);\n+    p.setProperty(\"DOMAIN_NAME\", domain2Uid);\n+    p.setProperty(\"ADMIN_NAME\", \"admin-server\");\n+    p.setProperty(\"PRODUCTION_MODE_ENABLED\", \"true\");\n+    p.setProperty(\"CLUSTER_NAME\", clusterName);\n+    p.setProperty(\"CLUSTER_TYPE\", \"DYNAMIC\");\n+    p.setProperty(\"CONFIGURED_MANAGED_SERVER_COUNT\", \"2\");\n+    p.setProperty(\"MANAGED_SERVER_NAME_BASE\", \"managed-server\");\n+    p.setProperty(\"T3_CHANNEL_PORT\", Integer.toString(t3ChannelPort));\n+    p.setProperty(\"T3_PUBLIC_ADDRESS\", K8S_NODEPORT_HOST);\n+    p.setProperty(\"MANAGED_SERVER_PORT\", \"8001\");\n+    p.setProperty(\"SERVER_START_MODE\", \"prod\");\n+    p.setProperty(\"ADMIN_PORT\", \"7001\");\n+    p.setProperty(\"MYSQL_USER\", \"wluser1\");\n+    p.setProperty(\"MYSQL_PWD\", \"wlpwd123\");\n+    // create a temporary WebLogic domain property file as a input for WDT model file\n+    File domainPropertiesFile = assertDoesNotThrow(() ->\n+                    File.createTempFile(\"domain\", \"properties\"),\n+            \"Failed to create domain properties file\");\n+    assertDoesNotThrow(() ->\n+                    p.store(new FileOutputStream(domainPropertiesFile), \"WDT properties file\"),\n+            \"Failed to write domain properties file\");\n+\n+    final List<String> propertyList = Collections.singletonList(domainPropertiesFile.getPath());\n+\n+    // build the model file list\n+    final List<String> modelList = Collections.singletonList(monitoringExporterEndToEndDir\n+            + MONEXP_WDT_FILE);\n+\n+    wdtImage =\n+        createImageAndVerify(MONEXP_IMAGE_NAME,\n+                modelList,\n+                appList,\n+                propertyList,\n+                WLS_BASE_IMAGE_NAME,\n+                WLS_BASE_IMAGE_TAG,\n+                WLS,\n+                false,\n+                domain2Uid, true);\n+\n+\n+\n+    // docker login and push image to docker registry if necessary\n+    dockerLoginAndPushImageToRegistry(wdtImage);\n+\n+    // create docker registry secret to pull the image from registry\n+    logger.info(\"Create docker registry secret in namespace {0}\", domain2Namespace);\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domain2Namespace),\n+        String.format(\"create Docker Registry Secret failed for %s\", REPO_SECRET_NAME));\n+\n+    return wdtImage;\n+  }\n+\n+  //create domain from provided image and verify it's start\n+  private static void createAndVerifyDomain(String miiImage,\n+                                            String domainUid,\n+                                            String namespace,\n+                                            String domainHomeSource,\n+                                            int replicaCount) {\n     // create secret for admin credentials\n     logger.info(\"Create secret for admin credentials\");\n     String adminSecretName = \"weblogic-credentials\";\n-    assertDoesNotThrow(() -> createSecretWithUsernamePassword(adminSecretName, domain1Namespace,\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(adminSecretName, namespace,\n         \"weblogic\", \"welcome1\"),\n         String.format(\"create secret for admin credentials failed for %s\", adminSecretName));\n \n     // create encryption secret\n     logger.info(\"Create encryption secret\");\n     String encryptionSecretName = \"encryptionsecret\";\n-    assertDoesNotThrow(() -> createSecretWithUsernamePassword(encryptionSecretName, domain1Namespace,\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(encryptionSecretName, namespace,\n         \"weblogicenc\", \"weblogicenc\"),\n         String.format(\"create encryption secret failed for %s\", encryptionSecretName));\n \n     // create domain and verify\n     logger.info(\"Create model in image domain {0} in namespace {1} using docker image {2}\",\n-        domainUid, domain1Namespace, miiImage);\n-    createDomainCrAndVerify(adminSecretName, REPO_SECRET_NAME, encryptionSecretName, miiImage,domainUid);\n-\n+        domainUid, namespace, miiImage);\n+    createDomainCrAndVerify(adminSecretName, REPO_SECRET_NAME, encryptionSecretName, miiImage,domainUid,\n+            namespace, domainHomeSource, replicaCount);\n+    String adminServerPodName = domainUid + \"-admin-server\";\n     // check that admin server pod exists in the domain namespace\n     logger.info(\"Checking that admin server pod {0} exists in namespace {1}\",\n-        adminServerPodName, domain1Namespace);\n-    checkPodExists(adminServerPodName, domainUid, domain1Namespace);\n+        adminServerPodName, namespace);\n+    checkPodExists(adminServerPodName, domainUid, namespace);\n \n     // check that admin server pod is ready\n     logger.info(\"Checking that admin server pod {0} is ready in namespace {1}\",\n-        adminServerPodName, domain1Namespace);\n-    checkPodReady(adminServerPodName, domainUid, domain1Namespace);\n+        adminServerPodName, namespace);\n+    checkPodReady(adminServerPodName, domainUid, namespace);\n \n     // check that admin service exists in the domain namespace\n     logger.info(\"Checking that admin service {0} exists in namespace {1}\",\n-        adminServerPodName, domain1Namespace);\n-    checkServiceExists(adminServerPodName, domain1Namespace);\n+        adminServerPodName, namespace);\n+    checkServiceExists(adminServerPodName, namespace);", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzQ0NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r444323444", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Create a Kubernetes Config Map.\n          \n          \n            \n               * Updates a Kubernetes Config Map.", "author": "sankarpn", "createdAt": "2020-06-23T15:43:22Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1117,6 +1118,50 @@ public static boolean createConfigMap(V1ConfigMap configMap) throws ApiException\n     return true;\n   }\n \n+  /**\n+   * Create a Kubernetes Config Map.", "originalCommit": "3bbe9ed75398391152bbec2152819b83b03bad59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5ODMxOQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445098319", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-24T18:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzQ0NA=="}], "type": "inlineReview"}, {"oid": "91f7db2e9866a4047fbe8c539bb5afc62171a097", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/91f7db2e9866a4047fbe8c539bb5afc62171a097", "message": "merged", "committedDate": "2020-06-24T01:26:34Z", "type": "commit"}, {"oid": "320ee7705cbfff69bfb7441ca29905e0de0e52e5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/320ee7705cbfff69bfb7441ca29905e0de0e52e5", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest2", "committedDate": "2020-06-24T01:26:48Z", "type": "commit"}, {"oid": "37f2af68874410cbebc111842ac784a11412aa92", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/37f2af68874410cbebc111842ac784a11412aa92", "message": "addressed comments from review", "committedDate": "2020-06-24T15:54:39Z", "type": "commit"}, {"oid": "bde4b29ef5417800dc5022dcedc781eceaaffb39", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bde4b29ef5417800dc5022dcedc781eceaaffb39", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest2", "committedDate": "2020-06-24T15:54:45Z", "type": "commit"}, {"oid": "20f6281f572d6d9c965f4c1144e02237046a07ad", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/20f6281f572d6d9c965f4c1144e02237046a07ad", "message": "fixed logic for checkpod and service", "committedDate": "2020-06-24T19:04:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MjI4NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445292284", "bodyText": "Can you please explain bit more detail. What is the purpose of replacing a Config Map", "author": "anpanigr", "createdAt": "2020-06-25T03:54:21Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/impl/primitive/Kubernetes.java", "diffHunk": "@@ -1117,6 +1118,50 @@ public static boolean createConfigMap(V1ConfigMap configMap) throws ApiException\n     return true;\n   }\n \n+  /**\n+   * Replace a Kubernetes Config Map.", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MjE1NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445852155", "bodyText": "this is to support updates for CM ( kubectl edit cm ) I have added more description", "author": "marinakog", "createdAt": "2020-06-25T21:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MjI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MzAwMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445293002", "bodyText": "extra blank space between the word  \"deployment\"  and \"is\"", "author": "anpanigr", "createdAt": "2020-06-25T03:57:33Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Kubernetes.java", "diffHunk": "@@ -429,6 +433,74 @@ public static V1Service getService(\n     return null;\n   }\n \n+  /**\n+   * Get V1Deployment object for the given  name, label and namespace.\n+   * @param deploymentName name of the deployment to look for\n+   * @param label the key value pair with which the deployment is decorated with\n+   * @param namespace the namespace in which to check for the deployment\n+   * @return V1Deployment object if found otherwise null\n+   * @throws ApiException when there is error in querying the cluster\n+   */\n+  public static V1Deployment getDeployment(\n+          String deploymentName, Map<String, String> label, String namespace)\n+          throws ApiException {\n+    String labelSelector = null;\n+    if (label != null) {\n+      String key = label.keySet().iterator().next().toString();\n+      String value = label.get(key).toString();\n+      labelSelector = String.format(\"%s in (%s)\", key, value);\n+      logger.info(labelSelector);\n+    }\n+    V1DeploymentList v1DeploymentList = listDeployments(namespace);\n+\n+    for (V1Deployment deployment : v1DeploymentList.getItems()) {\n+      if (deployment.getMetadata().getName().equals(deploymentName.trim())\n+              && deployment.getMetadata().getNamespace().equals(namespace.trim())) {\n+        logger.info(\"Deployment Name : \" + deployment.getMetadata().getName());\n+        logger.info(\"Deployment Namespace : \" + deployment.getMetadata().getNamespace());\n+        logger.info(\"Deployment status : \" + deployment.getStatus().toString());\n+        Map<String, String> labels = deployment.getMetadata().getLabels();\n+        if (labels != null) {\n+          for (Map.Entry<String, String> entry : labels.entrySet()) {\n+            logger.log(Level.INFO, \"Label Key: {0} Label Value: {1}\",\n+                    new Object[]{entry.getKey(), entry.getValue()});\n+          }\n+        }\n+        return deployment;\n+      }\n+    }\n+    return null;\n+  }\n+\n+  /**\n+   * Checks if an deployment  is running in a given namespace.", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTYzNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851635", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MzAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0MzAyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445643023", "bodyText": "Remove \"by\" from the comment above", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:24:53Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -204,134 +231,398 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     assertNotNull(namespaces.get(2), \"Namespace list is null\");\n     domain2Namespace = namespaces.get(2);\n \n-    // get a unique monitoring namespace\n     logger.info(\"Get a unique namespace for monitoring\");\n     assertNotNull(namespaces.get(3), \"Namespace list is null\");\n     monitoringNS = namespaces.get(3);\n \n-    // get a unique webhook namespace\n     logger.info(\"Get a unique namespace for webhook\");\n     assertNotNull(namespaces.get(4), \"Namespace list is null\");\n     webhookNS = namespaces.get(4);\n \n-    // get a unique NGINX namespace\n     logger.info(\"Get a unique namespace for NGINX\");\n     assertNotNull(namespaces.get(5), \"Namespace list is null\");\n-    final String nginxNamespace = namespaces.get(5);\n+    final String nginxNamespace1 = namespaces.get(5);\n+    assertNotNull(namespaces.get(6), \"Namespace list is null\");\n+    final String nginxNamespace2 = namespaces.get(6);\n \n-    // install and verify operator\n+    logger.info(\"install and verify operator\");\n     installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n \n-    //install monitoring exporter\n+    logger.info(\"nstall monitoring exporter\");\n     installMonitoringExporter();\n \n-    // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n-    // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n-    // create ingress for the domain\n+    logger.info(\"install and verify NGINX\");\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    logger.info(\"create pv and pvc for monitoring\");\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n-   * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project.\n+   * Create Prometheus, Grafana, Webhook, Coordinator.\n+   * Create domain in Image with monitoring exporter.\n+   * Verify access to monitoring exporter WebLogic metrics via nginx.\n+   * Check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana.\n+   * Fire Alert using Webhook.\n+   * Change prometheus to add different domain to monitor.\n+   */\n+  @Test\n+  @DisplayName(\"Test End to End example from MonitoringExporter github project.\")\n+  public void testEndToEndViaChart() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      ingressHost2List =\n+              createIngressForDomainAndVerify(domain2Uid, domain2Namespace, clusterNameMsPortMap);\n+\n+      installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+              domain2Namespace,\n+              domain2Uid);\n+\n+      installWebhook();\n+      installCoordinator(domain2Namespace);\n+\n+      logger.info(\"verify access to Monitoring Exporter\");\n+      verifyMonExpAppAccessThroughNginx(ingressHost2List.get(0), managedServersCount);\n+      logger.info(\"verify metrics via prometheus\");\n+      String testappPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22test-webapp%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(testappPrometheusSearchKey, \"test-webapp\");\n+      logger.info(\"fire alert by scaling down\");\n+      fireAlert();\n+      logger.info(\"switch to monitor another domain\");\n+      String oldRegex = String.format(\"regex: %s;%s;%s\", domain2Namespace, domain2Uid, clusterName);\n+      String newRegex = String.format(\"regex: %s;%s;%s\", domain1Namespace, domain1Uid, clusterName);\n+      editPrometheusCM(oldRegex, newRegex);\n+      String sessionAppPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22myear%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(sessionAppPrometheusSearchKey, \"sessmigr\");\n+      checkPromGrafanaLatestVersion();\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      assertTrue(shutdownDomain(domain2Uid, domain2Namespace),\n+              String.format(\"shutdown domain %s in namespace %s failed\", domain2Uid, domain2Namespace));\n+    }\n+  }\n+\n+  /**\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n+   * Create Prometheus, Grafana\n+   * create Model in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTQxMg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851412", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0MzAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0NDMxMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445644311", "bodyText": "Fix the javadoc. Similar to Sankar's comment earlier.", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:26:36Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -204,134 +231,398 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     assertNotNull(namespaces.get(2), \"Namespace list is null\");\n     domain2Namespace = namespaces.get(2);\n \n-    // get a unique monitoring namespace\n     logger.info(\"Get a unique namespace for monitoring\");\n     assertNotNull(namespaces.get(3), \"Namespace list is null\");\n     monitoringNS = namespaces.get(3);\n \n-    // get a unique webhook namespace\n     logger.info(\"Get a unique namespace for webhook\");\n     assertNotNull(namespaces.get(4), \"Namespace list is null\");\n     webhookNS = namespaces.get(4);\n \n-    // get a unique NGINX namespace\n     logger.info(\"Get a unique namespace for NGINX\");\n     assertNotNull(namespaces.get(5), \"Namespace list is null\");\n-    final String nginxNamespace = namespaces.get(5);\n+    final String nginxNamespace1 = namespaces.get(5);\n+    assertNotNull(namespaces.get(6), \"Namespace list is null\");\n+    final String nginxNamespace2 = namespaces.get(6);\n \n-    // install and verify operator\n+    logger.info(\"install and verify operator\");\n     installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n \n-    //install monitoring exporter\n+    logger.info(\"nstall monitoring exporter\");\n     installMonitoringExporter();\n \n-    // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n-    // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n-    // create ingress for the domain\n+    logger.info(\"install and verify NGINX\");\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    logger.info(\"create pv and pvc for monitoring\");\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n-   * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project.\n+   * Create Prometheus, Grafana, Webhook, Coordinator.\n+   * Create domain in Image with monitoring exporter.\n+   * Verify access to monitoring exporter WebLogic metrics via nginx.\n+   * Check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana.\n+   * Fire Alert using Webhook.\n+   * Change prometheus to add different domain to monitor.\n+   */\n+  @Test\n+  @DisplayName(\"Test End to End example from MonitoringExporter github project.\")\n+  public void testEndToEndViaChart() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      ingressHost2List =\n+              createIngressForDomainAndVerify(domain2Uid, domain2Namespace, clusterNameMsPortMap);\n+\n+      installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+              domain2Namespace,\n+              domain2Uid);\n+\n+      installWebhook();\n+      installCoordinator(domain2Namespace);\n+\n+      logger.info(\"verify access to Monitoring Exporter\");\n+      verifyMonExpAppAccessThroughNginx(ingressHost2List.get(0), managedServersCount);\n+      logger.info(\"verify metrics via prometheus\");\n+      String testappPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22test-webapp%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(testappPrometheusSearchKey, \"test-webapp\");\n+      logger.info(\"fire alert by scaling down\");\n+      fireAlert();\n+      logger.info(\"switch to monitor another domain\");\n+      String oldRegex = String.format(\"regex: %s;%s;%s\", domain2Namespace, domain2Uid, clusterName);\n+      String newRegex = String.format(\"regex: %s;%s;%s\", domain1Namespace, domain1Uid, clusterName);\n+      editPrometheusCM(oldRegex, newRegex);\n+      String sessionAppPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22myear%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(sessionAppPrometheusSearchKey, \"sessmigr\");\n+      checkPromGrafanaLatestVersion();\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      assertTrue(shutdownDomain(domain2Uid, domain2Namespace),\n+              String.format(\"shutdown domain %s in namespace %s failed\", domain2Uid, domain2Namespace));\n+    }\n+  }\n+\n+  /**\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n+   * Create Prometheus, Grafana\n+   * create Model in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * check basic functionality of monitoring exporter\n    */\n   @Test\n-  @DisplayName(\"Install Prometheus, Grafana , Webhook, Coordinator and verify WebLogic metrics\")\n-  public void testCheckMetrics() throws Exception {\n+  @DisplayName(\"Test Basic Functionality of Monitoring Exporter.\")\n+  public void testBasicFunctionality() throws Exception {\n \n-    installPrometheusGrafana();\n-    installWebhookCoordinator();\n+    installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+            domain1Namespace,\n+            domain1Uid);\n \n     //verify access to Monitoring Exporter\n-    verifyMonExpAppAccessThroughNginx();\n-    //verify metrics via prometheus\n-    String testappPrometheusSearchKey =\n-        \"weblogic_servlet_invocation_total_count%7Bapp%3D%22wlsexporter%22%7D%5B15s%5D\";\n-    checkMetricsViaPrometheus(testappPrometheusSearchKey, \"wlsexporter\");\n+    verifyMonExpAppAccessThroughNginx(ingressHost1List.get(0),1);\n+\n+    try {\n+      logger.info(\"Testing replace configuration\");\n+      replaceConfiguration();\n+      logger.info(\"Testing append configuration\");\n+      appendConfiguration();\n+      logger.info(\"Testing replace One Attribute Value AsArray configuration\");\n+      replaceOneAttributeValueAsArrayConfiguration();\n+      logger.info(\"Testing append One Attribute Value AsArray configuration\");\n+      appendArrayWithOneExistedAndOneDifferentAttributeValueAsArrayConfiguration();\n+      logger.info(\"Testing replace with empty configuration\");\n+      replaceWithEmptyConfiguration();\n+      logger.info(\"Testing append with empty configuration\");\n+      appendWithEmptyConfiguration();\n+      logger.info(\"Testing append with invalid yaml configuration\");\n+      appendWithNotYmlConfiguration();\n+      logger.info(\"Testing replace with invalid yaml configuration\");\n+      replaceWithNotYmlConfiguration();\n+      logger.info(\"Testing append with corrupted yaml configuration\");\n+      appendWithCorruptedYmlConfiguration();\n+      logger.info(\"Testing replace with corrupted yaml configuration\");\n+      replaceWithCorruptedYmlConfiguration();\n+      logger.info(\"Testing replace with dublicated values yaml configuration\");\n+      replaceWithDublicatedValuesConfiguration();\n+      logger.info(\"Testing append with corrupted yaml configuration\");\n+      appendWithDuplicatedValuesConfiguration();\n+      logger.info(\"Testing replace with name snake false yaml configuration\");\n+      replaceMetricsNameSnakeCaseFalseConfiguration();\n+      logger.info(\"Testing change with no credentials configuration\");\n+      changeConfigNoCredentials();\n+      logger.info(\"Testing change with no invalid user configuration\");\n+      changeConfigInvalidUser();\n+      logger.info(\"Testing change with no invalid pass configuration\");\n+      changeConfigInvalidPass();\n+      logger.info(\"Testing change with empty user configuration\");\n+      changeConfigEmptyUser();\n+      logger.info(\"Testing change with no empty pass configuration\");\n+      changeConfigEmptyPass();\n+      logger.info(\"Testing replace with domain qualifier configuration\");\n+      replaceMetricsDomainQualifierTrueConfiguration();\n+    } finally {\n+      //restore configuration\n+      submitConfigureForm(exporterUrl, \"replace\", RESOURCE_DIR + \"/exporter/exporter-config.yml\");\n+    }\n   }\n \n   /**\n-   * Install Prometheus, Grafana using helm chart, and verify that pods are running.\n-   * @throws ApiException when creating helm charts or pods fails\n+   * Test covers the following use cases.\n+   * Create Prometheus, Grafana from latest version of helm chart\n+   * verify access to monitoring exporter WebLogic metrics via nginx\n+   * check WebLogic metrics via Prometheus", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTM1MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851351", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0NDMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0NDgyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445644825", "bodyText": "fix the comment above - not uninstalling helm here are you?", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:27:24Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -204,134 +231,398 @@ public static void initAll(@Namespaces(6) List<String> namespaces) {\n     assertNotNull(namespaces.get(2), \"Namespace list is null\");\n     domain2Namespace = namespaces.get(2);\n \n-    // get a unique monitoring namespace\n     logger.info(\"Get a unique namespace for monitoring\");\n     assertNotNull(namespaces.get(3), \"Namespace list is null\");\n     monitoringNS = namespaces.get(3);\n \n-    // get a unique webhook namespace\n     logger.info(\"Get a unique namespace for webhook\");\n     assertNotNull(namespaces.get(4), \"Namespace list is null\");\n     webhookNS = namespaces.get(4);\n \n-    // get a unique NGINX namespace\n     logger.info(\"Get a unique namespace for NGINX\");\n     assertNotNull(namespaces.get(5), \"Namespace list is null\");\n-    final String nginxNamespace = namespaces.get(5);\n+    final String nginxNamespace1 = namespaces.get(5);\n+    assertNotNull(namespaces.get(6), \"Namespace list is null\");\n+    final String nginxNamespace2 = namespaces.get(6);\n \n-    // install and verify operator\n+    logger.info(\"install and verify operator\");\n     installAndVerifyOperator(opNamespace, domain1Namespace,domain2Namespace);\n \n-    //install monitoring exporter\n+    logger.info(\"nstall monitoring exporter\");\n     installMonitoringExporter();\n \n-    // create and verify WebLogic domain image using model in image with model files\n-    String imageName = createAndVerifyDomainImage();\n+    logger.info(\"create and verify WebLogic domain image using model in image with model files\");\n+    miiImage = createAndVerifyMiiImage();\n \n-    // create and verify one cluster domain\n+    // create and verify one cluster mii domain\n     logger.info(\"Create domain and verify that it's running\");\n-    createAndVerifyDomain(imageName, domain1Uid);\n+    createAndVerifyDomain(miiImage, domain1Uid, domain1Namespace, \"FromModel\", 1);\n \n     // get a free node port for NGINX\n-    nodeportshttp = getNextFreePort(30305, 30405);\n-    int nodeportshttps = getNextFreePort(30443, 30543);\n+    nodeportshttp1 = getNextFreePort(30305, 30405);\n+    nodeportshttp2 = getNextFreePort(30305, 30405);\n+    int nodeportshttps1 = getNextFreePort(30443, 30543);\n \n-    // install and verify NGINX\n-    nginxHelmParams = installAndVerifyNginx(nginxNamespace, nodeportshttp, nodeportshttps);\n-    // create ingress for the domain\n+    logger.info(\"install and verify NGINX\");\n+    nginxHelmParams1 = installAndVerifyNginx(nginxNamespace1, nodeportshttp1, nodeportshttps1);\n     logger.info(\"Creating ingress for domain {0} in namespace {1}\", domain1Uid, domain1Namespace);\n-    Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+    clusterNameMsPortMap = new HashMap<>();\n     clusterNameMsPortMap.put(clusterName, managedServerPort);\n-    ingressHostList =\n-        createIngressForDomainAndVerify(domain1Uid, domain1Namespace, clusterNameMsPortMap);\n+    ingressHost1List =\n+        createIngressForDomainAndVerify(domain1Uid, domain1Namespace,clusterNameMsPortMap, false);\n+\n+    exporterUrl = String.format(\"http://%s:%s/wls-exporter/\",K8S_NODEPORT_HOST,nodeportshttp1);\n+\n+    logger.info(\"create pv and pvc for monitoring\");\n+    HashMap<String, String> labels = new HashMap<>();\n+    labels.put(\"app\", \"monitoring\");\n+    labels.put(\"weblogic.domainUid\", domain1Uid);\n+    assertDoesNotThrow(() -> createPvAndPvc(\"prometheus\", monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"alertmanager\",monitoringNS, labels));\n+    assertDoesNotThrow(() -> createPvAndPvc(\"grafana\", monitoringNS, labels));\n \n   }\n \n   /**\n-   * Test covers the following use cases.\n-   * Create Prometheus, Grafana, Webhook, Coordinator\n-   * create domain Model in Image with monitoring exporter\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project.\n+   * Create Prometheus, Grafana, Webhook, Coordinator.\n+   * Create domain in Image with monitoring exporter.\n+   * Verify access to monitoring exporter WebLogic metrics via nginx.\n+   * Check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana.\n+   * Fire Alert using Webhook.\n+   * Change prometheus to add different domain to monitor.\n+   */\n+  @Test\n+  @DisplayName(\"Test End to End example from MonitoringExporter github project.\")\n+  public void testEndToEndViaChart() throws Exception {\n+    wdtImage = createAndVerifyDomainInImage();\n+    try {\n+      logger.info(\"Create wdt domain and verify that it's running\");\n+      createAndVerifyDomain(wdtImage, domain2Uid, domain2Namespace, \"Image\", replicaCount);\n+      ingressHost2List =\n+              createIngressForDomainAndVerify(domain2Uid, domain2Namespace, clusterNameMsPortMap);\n+\n+      installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+              domain2Namespace,\n+              domain2Uid);\n+\n+      installWebhook();\n+      installCoordinator(domain2Namespace);\n+\n+      logger.info(\"verify access to Monitoring Exporter\");\n+      verifyMonExpAppAccessThroughNginx(ingressHost2List.get(0), managedServersCount);\n+      logger.info(\"verify metrics via prometheus\");\n+      String testappPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22test-webapp%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(testappPrometheusSearchKey, \"test-webapp\");\n+      logger.info(\"fire alert by scaling down\");\n+      fireAlert();\n+      logger.info(\"switch to monitor another domain\");\n+      String oldRegex = String.format(\"regex: %s;%s;%s\", domain2Namespace, domain2Uid, clusterName);\n+      String newRegex = String.format(\"regex: %s;%s;%s\", domain1Namespace, domain1Uid, clusterName);\n+      editPrometheusCM(oldRegex, newRegex);\n+      String sessionAppPrometheusSearchKey =\n+              \"wls_servlet_invocation_total_count%7Bapp%3D%22myear%22%7D%5B15s%5D\";\n+      checkMetricsViaPrometheus(sessionAppPrometheusSearchKey, \"sessmigr\");\n+      checkPromGrafanaLatestVersion();\n+    } finally {\n+      logger.info(\"Shutting down domain2\");\n+      assertTrue(shutdownDomain(domain2Uid, domain2Namespace),\n+              String.format(\"shutdown domain %s in namespace %s failed\", domain2Uid, domain2Namespace));\n+    }\n+  }\n+\n+  /**\n+   * Test covers end to end sample, provided in the Monitoring Exporter github project .\n+   * Create Prometheus, Grafana\n+   * create Model in Image with monitoring exporter\n    * verify access to monitoring exporter WebLogic metrics via nginx\n-   * check generated by monitoring exporter WebLogic metrics via Prometheus\n+   * check generated by monitoring exporter WebLogic metrics via Prometheus, Grafana\n+   * check basic functionality of monitoring exporter\n    */\n   @Test\n-  @DisplayName(\"Install Prometheus, Grafana , Webhook, Coordinator and verify WebLogic metrics\")\n-  public void testCheckMetrics() throws Exception {\n+  @DisplayName(\"Test Basic Functionality of Monitoring Exporter.\")\n+  public void testBasicFunctionality() throws Exception {\n \n-    installPrometheusGrafana();\n-    installWebhookCoordinator();\n+    installPrometheusGrafana(PROMETHEUS_CHART_VERSION, GRAFANA_CHART_VERSION,\n+            domain1Namespace,\n+            domain1Uid);\n \n     //verify access to Monitoring Exporter\n-    verifyMonExpAppAccessThroughNginx();\n-    //verify metrics via prometheus\n-    String testappPrometheusSearchKey =\n-        \"weblogic_servlet_invocation_total_count%7Bapp%3D%22wlsexporter%22%7D%5B15s%5D\";\n-    checkMetricsViaPrometheus(testappPrometheusSearchKey, \"wlsexporter\");\n+    verifyMonExpAppAccessThroughNginx(ingressHost1List.get(0),1);\n+\n+    try {\n+      logger.info(\"Testing replace configuration\");\n+      replaceConfiguration();\n+      logger.info(\"Testing append configuration\");\n+      appendConfiguration();\n+      logger.info(\"Testing replace One Attribute Value AsArray configuration\");\n+      replaceOneAttributeValueAsArrayConfiguration();\n+      logger.info(\"Testing append One Attribute Value AsArray configuration\");\n+      appendArrayWithOneExistedAndOneDifferentAttributeValueAsArrayConfiguration();\n+      logger.info(\"Testing replace with empty configuration\");\n+      replaceWithEmptyConfiguration();\n+      logger.info(\"Testing append with empty configuration\");\n+      appendWithEmptyConfiguration();\n+      logger.info(\"Testing append with invalid yaml configuration\");\n+      appendWithNotYmlConfiguration();\n+      logger.info(\"Testing replace with invalid yaml configuration\");\n+      replaceWithNotYmlConfiguration();\n+      logger.info(\"Testing append with corrupted yaml configuration\");\n+      appendWithCorruptedYmlConfiguration();\n+      logger.info(\"Testing replace with corrupted yaml configuration\");\n+      replaceWithCorruptedYmlConfiguration();\n+      logger.info(\"Testing replace with dublicated values yaml configuration\");\n+      replaceWithDublicatedValuesConfiguration();\n+      logger.info(\"Testing append with corrupted yaml configuration\");\n+      appendWithDuplicatedValuesConfiguration();\n+      logger.info(\"Testing replace with name snake false yaml configuration\");\n+      replaceMetricsNameSnakeCaseFalseConfiguration();\n+      logger.info(\"Testing change with no credentials configuration\");\n+      changeConfigNoCredentials();\n+      logger.info(\"Testing change with no invalid user configuration\");\n+      changeConfigInvalidUser();\n+      logger.info(\"Testing change with no invalid pass configuration\");\n+      changeConfigInvalidPass();\n+      logger.info(\"Testing change with empty user configuration\");\n+      changeConfigEmptyUser();\n+      logger.info(\"Testing change with no empty pass configuration\");\n+      changeConfigEmptyPass();\n+      logger.info(\"Testing replace with domain qualifier configuration\");\n+      replaceMetricsDomainQualifierTrueConfiguration();\n+    } finally {\n+      //restore configuration\n+      submitConfigureForm(exporterUrl, \"replace\", RESOURCE_DIR + \"/exporter/exporter-config.yml\");\n+    }\n   }\n \n   /**\n-   * Install Prometheus, Grafana using helm chart, and verify that pods are running.\n-   * @throws ApiException when creating helm charts or pods fails\n+   * Test covers the following use cases.\n+   * Create Prometheus, Grafana from latest version of helm chart\n+   * verify access to monitoring exporter WebLogic metrics via nginx\n+   * check WebLogic metrics via Prometheus\n    */\n-  private void installPrometheusGrafana() throws IOException, ApiException {\n-    createPvAndPvc(\"prometheus\");\n-    createPvAndPvc(\"alertmanager\");\n-    createPvAndPvc(\"grafana\");\n+  private void checkPromGrafanaLatestVersion() throws Exception {\n+    //check if helm was already created and uninstall", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTMwOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851308", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0NDgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1NDA4Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445654087", "bodyText": "remove commented code above", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:41:12Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItMonitoringExporter.java", "diffHunk": "@@ -1018,8 +1438,404 @@ public static boolean execCommandCheckResponse(String cmd, String searchKey) {\n    * @return true if the output matches searchKey otherwise false\n    */\n   private static Callable<Boolean> searchForKey(String cmd, String searchKey) {\n-    return () -> {\n-      return execCommandCheckResponse(cmd, searchKey);\n-    };\n+    return () -> execCommandCheckResponse(cmd, searchKey);\n+  }\n+\n+  /**\n+   * Check if executed command contains expected output.\n+   *\n+   * @param pod   V1Pod object\n+   * @param searchKey expected string in the log\n+   * @return true if the output matches searchKey otherwise false\n+   */\n+  private static Callable<Boolean> searchPodLogForKey(V1Pod pod, String searchKey) {\n+    return () -> Kubernetes.getPodLog(pod.getMetadata().getName(),\n+            pod.getMetadata().getNamespace()).contains(searchKey);\n+  }\n+\n+  /*\n+   ** uninstall Prometheus and Grafana helm charts\n+   */\n+  private void uninstallPrometheusGrafana() {\n+    if (promHelmParams != null) {\n+      Prometheus.uninstall(promHelmParams);\n+      promHelmParams = null;\n+      prometheusDomainRegexValue = null;\n+      logger.info(\"Prometheus is uninstalled\");\n+    }\n+    if (grafanaHelmParams != null) {\n+      Grafana.uninstall(grafanaHelmParams);\n+      deleteSecret(\"grafana-secret\",monitoringNS);\n+      grafanaHelmParams = null;\n+      logger.info(\"Grafana is uninstalled\");\n+    }\n+  }\n+\n+  private void changeConfigNegative(String effect, String configFile, String expectedErrorMsg)\n+          throws Exception {\n+    final WebClient webClient = new WebClient();\n+    //webClient.addRequestHeader(\"Host\", ingressHost1List.get(0));\n+    HtmlPage originalPage = webClient.getPage(exporterUrl);\n+    assertNotNull(originalPage);\n+    HtmlPage page = submitConfigureForm(exporterUrl, effect, configFile);\n+    assertTrue((page.asText()).contains(expectedErrorMsg));\n+    assertTrue(!(page.asText()).contains(\"Error 500--Internal Server Error\"));\n+  }\n+\n+  private void changeConfigNegativeAuth(\n+          String effect, String configFile, String expectedErrorMsg, String username, String password)\n+          throws Exception {\n+    try {\n+      final WebClient webClient = new WebClient();\n+      //webClient.addRequestHeader(\"Host\", ingressHost1List.get(0));\n+      //webClient.addRequestHeader(\"Location\",exporterUrl);\n+      //webClient.addRequestHeader(\"Referer\", exporterUrl);\n+", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTI2NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851265", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1NDA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1ODMxMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445658310", "bodyText": "Are there tabs? I see it in a lot of files actually.", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:47:24Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -803,19 +838,19 @@ public static String createMiiImageAndVerify(String miiImageNameBase,\n    * @return image name with tag\n    */\n   public static String createImageAndVerify(String imageNameBase,\n-                                             String wdtModelFile,\n-                                             String appName,\n-                                             String modelPropFile,\n-                                             String altModelDir,\n-                                             String domainHome) {\n+                                            String wdtModelFile,\n+                                            String appName,\n+                                            String modelPropFile,\n+                                            String altModelDir,\n+                                            String domainHome) {\n \n     final List<String> wdtModelList = Collections.singletonList(MODEL_DIR + \"/\" + wdtModelFile);\n     final List<String> appSrcDirList = Collections.singletonList(appName);\n     final List<String> modelPropList = Collections.singletonList(altModelDir + \"/\" + modelPropFile);\n \n     return createImageAndVerify(\n-        imageNameBase, wdtModelList, appSrcDirList, modelPropList, WLS_BASE_IMAGE_NAME,\n-        WLS_BASE_IMAGE_TAG, WLS, false, domainHome, false);\n+            imageNameBase, wdtModelList, appSrcDirList, modelPropList, WLS_BASE_IMAGE_NAME,\n+            WLS_BASE_IMAGE_TAG, WLS, false, domainHome, false);", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTE5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851199", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1ODMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1ODg1NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445658854", "bodyText": "Looks like tabs here again.", "author": "bhavaniravichandran", "createdAt": "2020-06-25T15:48:14Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -942,43 +977,43 @@ public static String createImageAndVerify(String imageNameBase,\n     boolean result = false;\n     if (!modelType) {  //create a domain home in image image\n       result = createImage(\n-          new WitParams()\n-              .baseImageName(baseImageName)\n-              .baseImageTag(baseImageTag)\n-              .domainType(domainType)\n-              .modelImageName(imageName)\n-              .modelImageTag(imageTag)\n-              .modelFiles(wdtModelList)\n-              .modelVariableFiles(modelPropList)\n-              .modelArchiveFiles(archiveList)\n-              .domainHome(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domainHome)\n-              .wdtModelOnly(modelType)\n-              .wdtOperation(\"CREATE\")\n-              .wdtVersion(WDT_VERSION)\n-              .env(env)\n-              .redirect(true));\n+              new WitParams()\n+                      .baseImageName(baseImageName)\n+                      .baseImageTag(baseImageTag)\n+                      .domainType(domainType)\n+                      .modelImageName(imageName)\n+                      .modelImageTag(imageTag)\n+                      .modelFiles(wdtModelList)\n+                      .modelVariableFiles(modelPropList)\n+                      .modelArchiveFiles(archiveList)\n+                      .domainHome(WDT_IMAGE_DOMAINHOME_BASE_DIR + \"/\" + domainHome)\n+                      .wdtModelOnly(modelType)\n+                      .wdtOperation(\"CREATE\")\n+                      .wdtVersion(WDT_VERSION)\n+                      .env(env)\n+                      .redirect(true));", "originalCommit": "20f6281f572d6d9c965f4c1144e02237046a07ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1MTE2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1757#discussion_r445851162", "bodyText": "done", "author": "marinakog", "createdAt": "2020-06-25T21:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1ODg1NA=="}], "type": "inlineReview"}, {"oid": "578fa449215a9c8b7890c5137e2ecaa8379fe104", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/578fa449215a9c8b7890c5137e2ecaa8379fe104", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into promtest2", "committedDate": "2020-06-25T18:00:06Z", "type": "commit"}, {"oid": "b29642ed775469e8fe23a574cbff0e2bcc8fcf40", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b29642ed775469e8fe23a574cbff0e2bcc8fcf40", "message": "addressed review comments", "committedDate": "2020-06-25T18:39:43Z", "type": "commit"}, {"oid": "122d29c67b9a8a36e5503dfcf2e145fb2a81a506", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/122d29c67b9a8a36e5503dfcf2e145fb2a81a506", "message": "fixed typo", "committedDate": "2020-06-25T20:19:49Z", "type": "commit"}, {"oid": "0324c065ed9c7d5ab397c2fb89905c6f00227a58", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0324c065ed9c7d5ab397c2fb89905c6f00227a58", "message": "merge", "committedDate": "2020-06-25T21:12:34Z", "type": "commit"}, {"oid": "187cc3dc826ac68b4979e86cd6264d1287557ef5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/187cc3dc826ac68b4979e86cd6264d1287557ef5", "message": "merge", "committedDate": "2020-06-25T21:54:27Z", "type": "commit"}, {"oid": "7726d9f6731fc9440eb0a7b469413a889018af69", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7726d9f6731fc9440eb0a7b469413a889018af69", "message": "style", "committedDate": "2020-06-25T22:20:20Z", "type": "commit"}]}