{"pr_number": 1538, "pr_title": "OWLS-80826, OWLS-80942", "pr_createdAt": "2020-04-04T23:04:27Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1538", "timeline": [{"oid": "ab735bfdaea76e0be32fdbe40c95beb3b9008bb9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ab735bfdaea76e0be32fdbe40c95beb3b9008bb9", "message": " added support for helm 3.0", "committedDate": "2020-03-04T21:22:37Z", "type": "commit"}, {"oid": "3c85e17a39970f086ca04ca365c2d6b0e5056ded", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3c85e17a39970f086ca04ca365c2d6b0e5056ded", "message": "added check for repo", "committedDate": "2020-03-05T20:53:00Z", "type": "commit"}, {"oid": "a94fe3e3c3b8df7924bbd23304f408119542f6f9", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a94fe3e3c3b8df7924bbd23304f408119542f6f9", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-03-22T16:21:13Z", "type": "commit"}, {"oid": "9dc1150055e75e1581b405b4f57ca2d12760235d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9dc1150055e75e1581b405b4f57ca2d12760235d", "message": "moved from monitoring ns", "committedDate": "2020-03-22T17:18:46Z", "type": "commit"}, {"oid": "f566228f3c5e0eab338169737a8d5c41c3dad62c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f566228f3c5e0eab338169737a8d5c41c3dad62c", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-03-26T19:27:28Z", "type": "commit"}, {"oid": "3ac27191e582c2f9c0e81fa034bf0600739284dd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3ac27191e582c2f9c0e81fa034bf0600739284dd", "message": "added the test", "committedDate": "2020-03-27T19:49:14Z", "type": "commit"}, {"oid": "ba9393448837898d3d5219830e50d42a9fa5c604", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ba9393448837898d3d5219830e50d42a9fa5c604", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-03-27T19:49:19Z", "type": "commit"}, {"oid": "9b61c0b6bab20407db4a7310c09d84ec5317a95b", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9b61c0b6bab20407db4a7310c09d84ec5317a95b", "message": "fixed style", "committedDate": "2020-03-27T20:11:49Z", "type": "commit"}, {"oid": "cdd8ed743633c5f371971938ba9da4103d73410e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cdd8ed743633c5f371971938ba9da4103d73410e", "message": "added missed file", "committedDate": "2020-03-27T20:34:12Z", "type": "commit"}, {"oid": "40d651f781fe2d80cc12e9b4ca4e2a8000ff48af", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/40d651f781fe2d80cc12e9b4ca4e2a8000ff48af", "message": "added condition for ver", "committedDate": "2020-03-27T23:27:10Z", "type": "commit"}, {"oid": "1f95241ee191c7d1fda27864d42c2bf33b5354ea", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1f95241ee191c7d1fda27864d42c2bf33b5354ea", "message": "rework to avoid interm failures", "committedDate": "2020-03-28T00:41:20Z", "type": "commit"}, {"oid": "983ade7ddda2c34ba367fb4c798c7ad4ff69ae0c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/983ade7ddda2c34ba367fb4c798c7ad4ff69ae0c", "message": "fixed docs", "committedDate": "2020-03-28T21:25:09Z", "type": "commit"}, {"oid": "f787dc520c031677f4662e246ca8f9d28258eaf7", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/f787dc520c031677f4662e246ca8f9d28258eaf7", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-03-28T21:25:34Z", "type": "commit"}, {"oid": "7964917f34ec34f4d67f18bb9e689cb971716942", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/7964917f34ec34f4d67f18bb9e689cb971716942", "message": "updated version of MonExp", "committedDate": "2020-03-30T17:35:18Z", "type": "commit"}, {"oid": "0b7f1a9aec052cfc6b7ba012743764dde581b9ca", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0b7f1a9aec052cfc6b7ba012743764dde581b9ca", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-04-01T00:37:04Z", "type": "commit"}, {"oid": "81f62e0e79955c8baa9b3fc1ee82c7d89a78425a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/81f62e0e79955c8baa9b3fc1ee82c7d89a78425a", "message": "added some timing", "committedDate": "2020-04-01T04:18:43Z", "type": "commit"}, {"oid": "fc0f9fe3f71fea7503568285cab78744d6928767", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fc0f9fe3f71fea7503568285cab78744d6928767", "message": "style", "committedDate": "2020-04-01T16:05:44Z", "type": "commit"}, {"oid": "bd740b96964b6a986f6cdb8765e33b1f95054a20", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/bd740b96964b6a986f6cdb8765e33b1f95054a20", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-04-01T21:16:20Z", "type": "commit"}, {"oid": "706dec9c1eab4820b1444e2146cb4cfcc68028cd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/706dec9c1eab4820b1444e2146cb4cfcc68028cd", "message": "redesigned shutdowntest, fix some issues in MonEx", "committedDate": "2020-04-04T01:13:27Z", "type": "commit"}, {"oid": "ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-04-04T01:13:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU3MzY1Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1538#discussion_r403573657", "bodyText": "this doc is unclear - what does this mean? please try to make it clearer", "author": "markxnelson", "createdAt": "2020-04-04T23:33:59Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItPodsShutdown.java", "diffHunk": "@@ -74,128 +68,99 @@ public static void staticPrepare() throws Exception {\n    * This method gets called before every test. It creates the result/pv root directories\n    * for the test. Creates the operator and domain if its not running.\n    *\n-   * @throws Exception exception if result/pv/operator/domain creation fails\n+   * @throws Exception if result/pv/operator/domain creation fails\n    */\n   @BeforeEach\n   public void prepare() throws Exception {\n     // initialize test properties and create the directories\n     if (FULLTEST) {\n       LoggerHelper.getLocal().log(Level.INFO, \"Checking if operator1 and domain are running, if not creating\");\n+      createResultAndPvDirs(testClassName);\n       // create operator1\n       if (operator1 == null) {\n-        createResultAndPvDirs(testClassName);\n+        ArrayList<String> targetDomainsNS = new ArrayList<String>();\n+        targetDomainsNS.add(domainNSShutOpCluster);\n+        targetDomainsNS.add(domainNSShutOpDomain);\n+        targetDomainsNS.add(domainNSShutOpEnv);\n+        targetDomainsNS.add(domainNSShutOpMS);\n+        targetDomainsNS.add(domainNSShutOpMSForced);\n+        targetDomainsNS.add(domainNSShutOpMSIgnoreSessions);\n+        targetDomainsNS.add(domainNSShutOpMSTimeout);\n+        targetDomainsNS.add(domainNSShutOpOverrideViaCluster);\n+        targetDomainsNS.add(domainNSShutOpOverrideViaEnv);\n         Map<String, Object> operatorMap = createOperatorMap(getNewSuffixCount(), true, testClassName);\n+        operatorMap.put(\"domainNamespaces\",targetDomainsNS);\n         operator1 = TestUtils.createOperator(operatorMap, Operator.RestCertType.SELF_SIGNED);\n         Assertions.assertNotNull(operator1);\n-        domainNS1 = ((ArrayList<String>) operatorMap.get(\"domainNamespaces\")).get(0);\n         namespaceList.append((String)operatorMap.get(\"namespace\"));\n-        namespaceList.append(\" \").append(domainNS1);\n-        shutdownTmpDir = getResultDir() + \"/shutdowntemp\";\n-        Files.createDirectories(Paths.get(shutdownTmpDir));\n+        namespaceList.append(\" \")\n+            .append(domainNSShutOpOverrideViaCluster)\n+            .append(\" \")\n+            .append(domainNSShutOpMS)\n+            .append(\" \")\n+            .append(domainNSShutOpMSForced)\n+            .append(\" \")\n+            .append(domainNSShutOpMSIgnoreSessions)\n+            .append(\" \")\n+            .append(domainNSShutOpMSTimeout)\n+            .append(\" \")\n+            .append(domainNSShutOpEnv)\n+            .append(\" \")\n+            .append(domainNSShutOpDomain)\n+            .append(\" \")\n+            .append(domainNSShutOpOverrideViaEnv)\n+            .append(\" \")\n+            .append(domainNSShutOpCluster);\n       }\n-\n-      if (domain == null) {\n-        domain = createDomain();\n-        originalYaml =\n-            getUserProjectsDir()\n-                + \"/weblogic-domains/\"\n-                + domain.getDomainUid()\n-                + \"/domain.yaml\";\n-        Assertions.assertNotNull(domain);\n-      }\n-      domainUid = domain.getDomainUid();\n-      domainNS = domain.getDomainNs();\n     }\n   }\n \n   /**\n    * Releases k8s cluster lease, archives result, pv directories.\n    *\n-   * @throws Exception exception\n+   * @throws Exception tear objects fails", "originalCommit": "ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU3NDQ4Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1538#discussion_r403574482", "bodyText": "Please use capital to start the sentence - as per the Javadoc standard https://www.oracle.com/technetwork/java/javase/documentation/index-137868.html - in particular the section \"First sentence\"", "author": "markxnelson", "createdAt": "2020-04-04T23:35:57Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItPodsShutdown.java", "diffHunk": "@@ -206,23 +171,22 @@ public static void callWebApp(String testAppPath, Domain domain, boolean deployA\n \n     // Send a HTTP request to keep open session\n     String curlCmd = webServiceUrl.toString();\n-    // LoggerHelper.getLocal().log(Level.INFO, \"Send a HTTP request: \" + curlCmd);\n     TestUtils.checkAnyCmdInLoop(curlCmd, \"Ending to sleep\");\n   }\n \n   /**\n-   * shutdown managed server.\n+   * shutdown managed server and returns spent shutdown time.", "originalCommit": "ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU3NTc5Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1538#discussion_r403575793", "bodyText": "please add messages to your assertions, so that we get a descriptive message in the log if the assertion fails.\nplease consider static importing Assertions so that you can just write assertNotNull(domain, \"descriptive failure message\")", "author": "markxnelson", "createdAt": "2020-04-04T23:39:00Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/ItPodsShutdown.java", "diffHunk": "@@ -261,166 +225,168 @@ private static boolean checkShutdownUpdatedProp(String podName, String... props)\n   }\n \n   /**\n-   * Add shutdown options at managed server level and verify the managed server pod are Terminated\n-   * and recreated with specified shutdown options.\n+   * Start domain with added shutdown options at the domain level\n+   * and verify values are propagated to server level.\n    *\n-   * @throws Exception when domain.yaml cannot be read or modified\n+   * @throws Exception when domain cannot be started or failed to verify shutdown options\n    */\n   @Test\n-  public void testAddShutdownOptionsToMS() throws Exception {\n+  public void testAddShutdownOptionsToDomain() throws Exception {\n+\n     Assumptions.assumeTrue(FULLTEST);\n     String testMethodName = new Object() {\n     }.getClass().getEnclosingMethod().getName();\n     logTestBegin(testMethodName);\n-    String podName = domainUid + \"-managed-server1\";\n-    Files.createDirectories(Paths.get(shutdownTmpDir));\n-    // Modify the original domain yaml to include shutdown options in managed server-1 node\n-    final DomainCrd crd = new DomainCrd(originalYaml);\n-\n-    Map<String, Object> shutdownProps = new HashMap();\n+    Map<String, Object> shutdownProps = new HashMap<>();\n+    Map<String, Object> shutdownDomainProps = new HashMap();\n     shutdownProps.put(\"timeoutSeconds\", 160);\n-    shutdownProps.put(\"shutdownType\", \"Forced\");\n-    shutdownProps.put(\"ignoreSessions\", true);\n-    crd.addShutDownOptionToMS(\"managed-server1\", shutdownProps);\n+    shutdownDomainProps.put(\"domain\",shutdownProps);\n+    Domain domain = null;\n     try {\n-      updateCrdYamlVerifyShutdown(crd, 0);\n-      Assertions.assertTrue(checkShutdownUpdatedProp(domainUid + \"-admin-server\", \"Graceful\"));\n-      Assertions.assertTrue(\n-          checkShutdownUpdatedProp(domainUid + \"-managed-server1\", \"Forced\", \"160\", \"true\"));\n+      domain = createDomain(domainNSShutOpDomain, shutdownDomainProps);\n+      Assertions.assertNotNull(domain);\n+      Assertions.assertTrue(checkShutdownUpdatedProp(domain.getDomainUid()\n+          + \"-admin-server\", domain.getDomainNs(),\"160\"));\n+      Assertions.assertTrue(checkShutdownUpdatedProp(domain.getDomainUid()\n+          + \"-managed-server1\",domain.getDomainNs(), \"160\"));\n     } finally {\n-      LoggerHelper.getLocal().log(\n-          Level.INFO, \"Reverting back the domain to old crd\\n kubectl apply -f {0}\", originalYaml);\n-      resetDomainCrd();\n+      if (domain != null) {\n+        TestUtils.deleteWeblogicDomainResources(domain.getDomainUid());\n+      }\n     }\n+    LoggerHelper.getLocal().log(Level.INFO, \"SUCCESS - {0}\", testMethodName);\n   }\n \n   /**\n-   * Add shutdown options to Cluster level and verify the managed server pods in the cluster are\n-   * Terminated and recreated with specified shutdown options.\n+   * Start domain with added shutdown options at the managed server level\n+   * and verify values are propagated to specified server level but effecting admin setting.\n    *\n-   * @throws Exception when domain.yaml cannot be read or modified\n+   * @throws Exception when domain cannot be started or failed to verify shutdown options\n    */\n   @Test\n-  public void testAddShutdownOptionToCluster() throws Exception {\n+  public void testAddShutdownOptionsToMS() throws Exception {\n     Assumptions.assumeTrue(FULLTEST);\n     String testMethodName = new Object() {\n     }.getClass().getEnclosingMethod().getName();\n     logTestBegin(testMethodName);\n \n-    Files.createDirectories(Paths.get(shutdownTmpDir));\n-\n-    // Modify the original domain yaml to include shutdown options in cluster-1 node\n-    final DomainCrd crd = new DomainCrd(originalYaml);\n-\n     Map<String, Object> shutdownProps = new HashMap();\n-    shutdownProps.put(\"timeoutSeconds\", 60);\n+    shutdownProps.put(\"timeoutSeconds\", 160);\n     shutdownProps.put(\"shutdownType\", \"Forced\");\n     shutdownProps.put(\"ignoreSessions\", true);\n-\n-    crd.addShutdownOptionsToCluster(domain.getClusterName(), shutdownProps);\n+    List<Map<String,Object>> shutdownPropsMSs = new ArrayList<>();\n+    Map<String, Object> shutdownPropsMyMS = new HashMap();\n+    shutdownPropsMyMS.put(\"managed-server1\", shutdownProps);\n+    shutdownPropsMSs.add(shutdownPropsMyMS);\n+    Map<String, Object> shutdownPropOpt = new HashMap();\n+    shutdownPropOpt.put(\"server\",shutdownPropsMSs);\n+    Domain domain = null;\n     try {\n-      updateCrdYamlVerifyShutdown(crd, 0);\n-      Assertions.assertTrue(checkShutdownUpdatedProp(domainUid + \"-admin-server\", \"Graceful\"));\n-      Assertions.assertTrue(checkShutdownUpdatedProp(domainUid + \"-managed-server1\", \"Forced\"));\n+      domain = createDomain(domainNSShutOpMS, shutdownPropOpt);\n+      Assertions.assertNotNull(domain);\n+      Assertions.assertTrue(checkShutdownUpdatedProp(domain.getDomainUid()\n+          + \"-admin-server\", \"Graceful\"));\n+      Assertions.assertTrue(\n+          checkShutdownUpdatedProp(domain.getDomainUid()\n+              + \"-managed-server1\", domain.getDomainNs(),\"Forced\", \"160\", \"true\"));\n     } finally {\n       LoggerHelper.getLocal().log(\n-          Level.INFO, \"Reverting back the domain to old crd\\n kubectl apply -f {0}\", originalYaml);\n-      resetDomainCrd();\n+          Level.INFO, \" Deleting domain \" + domain.getDomainUid());\n+      if (domain != null) {\n+        TestUtils.deleteWeblogicDomainResources(domain.getDomainUid());\n+      }\n     }\n     LoggerHelper.getLocal().log(Level.INFO, \"SUCCESS - {0}\", testMethodName);\n   }\n \n   /**\n-   * Add shutdown options at domain level and verify all pods are Terminated and recreated.\n+   * Start domain with added shutdown options at the cluster level\n+   * and verify values are propagated to all managed servers in the cluster.\n    *\n-   * @throws Exception when domain.yaml cannot be read or modified\n+   * @throws Exception when domain cannot be started or failed to verify shutdown options\n    */\n   @Test\n-  public void testAddShutdownOptionsToDomain() throws Exception {\n-\n+  public void testAddShutdownOptionToCluster() throws Exception {\n     Assumptions.assumeTrue(FULLTEST);\n     String testMethodName = new Object() {\n     }.getClass().getEnclosingMethod().getName();\n     logTestBegin(testMethodName);\n \n-    Files.createDirectories(Paths.get(shutdownTmpDir));\n-    // Modify the original domain yaml to include shutdown options in domain spec node\n-    DomainCrd crd = new DomainCrd(originalYaml);\n-\n     Map<String, Object> shutdownProps = new HashMap();\n-    shutdownProps.put(\"timeoutSeconds\", 160);\n-    crd.addShutdownOptionToDomain(shutdownProps);\n+    shutdownProps.put(\"timeoutSeconds\", 60);\n+    shutdownProps.put(\"shutdownType\", \"Forced\");\n+    shutdownProps.put(\"ignoreSessions\", true);\n+    List<Map<String,Object>> shutdownPropsClusters = new ArrayList<>();\n+    Map<String, Object> shutdownPropsMyCluster = new HashMap();\n+    shutdownPropsMyCluster.put(\"cluster-1\", shutdownProps);\n+    shutdownPropsClusters.add(shutdownPropsMyCluster);\n+    Map<String, Object> shutdownPropOpt = new HashMap();\n+    shutdownPropOpt.put(\"cluster\",shutdownPropsClusters);\n+    Domain domain = null;\n     try {\n-      updateCrdYamlVerifyShutdown(crd, 0);\n-      Assertions.assertTrue(checkShutdownUpdatedProp(domainUid + \"-admin-server\", \"160\"));\n-      Assertions.assertTrue(checkShutdownUpdatedProp(domainUid + \"-managed-server1\", \"160\"));\n+      domain = createDomain(domainNSShutOpCluster,shutdownPropOpt);\n+      Assertions.assertNotNull(domain);", "originalCommit": "ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU3NzI0Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1538#discussion_r403577246", "bodyText": "start sentence with a capital", "author": "markxnelson", "createdAt": "2020-04-04T23:42:24Z", "path": "integration-tests/src/test/java/oracle/kubernetes/operator/utils/Domain.java", "diffHunk": "@@ -2414,7 +2458,7 @@ public boolean accept(File dir, String name) {\n \n \n   /**\n-   * write server pod logs\n+   * write server pod logs.", "originalCommit": "ee2cef4a5e4b3d877868eb0dc337d5cf7e4ea5d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67e705145f157a0343f5b96b1756e7638a3c0f2d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/67e705145f157a0343f5b96b1756e7638a3c0f2d", "message": "fixed java docs", "committedDate": "2020-04-06T02:24:48Z", "type": "commit"}, {"oid": "a3cda3019aad9c937182a6de50920a74aa96ca5d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a3cda3019aad9c937182a6de50920a74aa96ca5d", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into monhm", "committedDate": "2020-04-06T02:25:07Z", "type": "commit"}]}