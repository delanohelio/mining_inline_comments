{"pr_number": 1831, "pr_title": "Add tests to verify loadbalancing with treafik lb for multiple domains", "pr_createdAt": "2020-07-23T16:05:35Z", "pr_url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831", "timeline": [{"oid": "45abc55d9ba2bcba9337e2ac7f0248c9306342bd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/45abc55d9ba2bcba9337e2ac7f0248c9306342bd", "message": "Adding utilities for creating Traefik load balancer", "committedDate": "2020-07-20T23:59:30Z", "type": "commit"}, {"oid": "d0a7762cd25b4f9e919c9ec7759f39508e13a5e4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d0a7762cd25b4f9e919c9ec7759f39508e13a5e4", "message": "Log the assertion errors in IT*.out files", "committedDate": "2020-07-21T00:24:33Z", "type": "commit"}, {"oid": "5e9382c32f234f86528e965aa4b2ce040aa1fd87", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5e9382c32f234f86528e965aa4b2ce040aa1fd87", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into traefik-lb-tests", "committedDate": "2020-07-21T17:47:00Z", "type": "commit"}, {"oid": "23b847afe3762492a6c9a671364b5b482c932876", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/23b847afe3762492a6c9a671364b5b482c932876", "message": "Create ingress resource for traefik", "committedDate": "2020-07-21T18:59:06Z", "type": "commit"}, {"oid": "33e8eb5fa71b64c8ea97d67b05eac9c53c6d106a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/33e8eb5fa71b64c8ea97d67b05eac9c53c6d106a", "message": "Fix the traefik pod name", "committedDate": "2020-07-21T19:34:36Z", "type": "commit"}, {"oid": "3a04162cb2bfebafdcb0f7ee7570158f43a48b96", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3a04162cb2bfebafdcb0f7ee7570158f43a48b96", "message": "do kind repo check", "committedDate": "2020-07-21T20:16:17Z", "type": "commit"}, {"oid": "4a18027ee7da9d2dac6ad4ab8b6d809e50e2f20f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4a18027ee7da9d2dac6ad4ab8b6d809e50e2f20f", "message": "uninstall traefik", "committedDate": "2020-07-21T21:04:57Z", "type": "commit"}, {"oid": "2f0c1b2f3d0a29c95f2df0c722f9bde64cf6edbf", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2f0c1b2f3d0a29c95f2df0c722f9bde64cf6edbf", "message": "Add application building", "committedDate": "2020-07-21T21:09:11Z", "type": "commit"}, {"oid": "df9b88326967955b3861ea75e3928e46172d6098", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/df9b88326967955b3861ea75e3928e46172d6098", "message": "Deploy application using REST and access it through traefik LB", "committedDate": "2020-07-22T17:26:59Z", "type": "commit"}, {"oid": "06e2d92e01566323c8093c3878c33bad3e7fed77", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/06e2d92e01566323c8093c3878c33bad3e7fed77", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into traefik-lb-tests", "committedDate": "2020-07-22T17:30:39Z", "type": "commit"}, {"oid": "0479643be7888ca35419452ecba7214dcf7eada5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0479643be7888ca35419452ecba7214dcf7eada5", "message": "create secret for WebLogic domain", "committedDate": "2020-07-22T18:04:52Z", "type": "commit"}, {"oid": "b6def0edf0d1fe74dc012d474e1a8e845fd3fc1f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b6def0edf0d1fe74dc012d474e1a8e845fd3fc1f", "message": "remove the testwebapp", "committedDate": "2020-07-22T18:25:19Z", "type": "commit"}, {"oid": "15f6ebda5694bc00304315f623ccdd082c9a82cc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/15f6ebda5694bc00304315f623ccdd082c9a82cc", "message": "Print JVMID from clusterview app", "committedDate": "2020-07-22T18:51:34Z", "type": "commit"}, {"oid": "1bec514608da46300c41b5c769bf04e9316b284f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1bec514608da46300c41b5c769bf04e9316b284f", "message": "Remove the domain creation in PV", "committedDate": "2020-07-22T19:45:09Z", "type": "commit"}, {"oid": "1f33cefb1d92905924c4d8f2910f96a835ceade5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/1f33cefb1d92905924c4d8f2910f96a835ceade5", "message": "cleanup code", "committedDate": "2020-07-22T19:50:50Z", "type": "commit"}, {"oid": "8ecb73f1bec4c489e43b2d5a87923494eaaeb502", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/8ecb73f1bec4c489e43b2d5a87923494eaaeb502", "message": "cleanup code", "committedDate": "2020-07-22T21:51:00Z", "type": "commit"}, {"oid": "11b171e7b4ef4446ed7c8453cc0be54f4a776042", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/11b171e7b4ef4446ed7c8453cc0be54f4a776042", "message": "remove the domainUid from url", "committedDate": "2020-07-22T23:04:01Z", "type": "commit"}, {"oid": "cafc778bde54f40e70d5fc0b04b3689a2321d1c0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/cafc778bde54f40e70d5fc0b04b3689a2321d1c0", "message": "verify loadbalancing after creating 2 domains", "committedDate": "2020-07-23T16:00:23Z", "type": "commit"}, {"oid": "a3df3356fe3d2cd9ad50c4a699be4a75905d12ca", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a3df3356fe3d2cd9ad50c4a699be4a75905d12ca", "message": "cleanup javadocs", "committedDate": "2020-07-23T16:20:16Z", "type": "commit"}, {"oid": "b59aed35eb7e84abecd5a098ed966f997663d36c", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b59aed35eb7e84abecd5a098ed966f997663d36c", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into traefik-lb-tests", "committedDate": "2020-07-23T16:20:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMTM2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459631366", "bodyText": "Add more information about the usecase\n(a) we are verifying host routing usecase\n(b) A single Traefik Ingress controller routing web requests to multiple domains by providing host information in Http Header.\n(c) quick info about the expected return string from the webapp.", "author": "anpanigr", "createdAt": "2020-07-23T18:02:14Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,304 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.", "originalCommit": "b59aed35eb7e84abecd5a098ed966f997663d36c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NTQ3NQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461095475", "bodyText": "Added more details to test descriptions.", "author": "sankarpn", "createdAt": "2020-07-27T18:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMTM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMjY1OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459632658", "bodyText": "Modify test name to be specific testTraefikHostRoutingAcrossDomains()", "author": "anpanigr", "createdAt": "2020-07-23T18:04:38Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,304 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {", "originalCommit": "b59aed35eb7e84abecd5a098ed966f997663d36c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NTYyMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461095621", "bodyText": "test method names are changed.", "author": "sankarpn", "createdAt": "2020-07-27T18:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMjY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNzQ5Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459637496", "bodyText": "Does the clusterView Servlet assures that the response is coming form domain1/domain2. Does it display the unique managed server name from each domain ?", "author": "anpanigr", "createdAt": "2020-07-23T18:13:09Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,304 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {\n+\n+    // Create the repo secret to pull the image\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domainNamespace),\n+        String.format(\"createSecret failed for %s\", REPO_SECRET_NAME));\n+\n+    // create WebLogic domain credentials secret\n+    logger.info(\"Creating WebLogic credentials secrets for domain\");\n+    createSecretWithUsernamePassword(wlSecretName, domainNamespace,\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT);\n+\n+    // create model encryption secret\n+    logger.info(\"Creating encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        encryptionSecretName,\n+        domainNamespace,\n+        \"weblogicenc\",\n+        \"weblogicenc\"),\n+        String.format(\"createSecret failed for %s\", encryptionSecretName));\n+\n+    int replicaCount = 2;\n+    String managedServerNameBase = \"managed-server\";\n+    String[] domains = {\"domain1\", \"domain2\"};\n+\n+    for (String domainUid : domains) {\n+\n+      // admin/managed server name here should match with model yaml in MII_BASIC_WDT_MODEL_FILE\n+      String adminServerPodName = domainUid + \"-admin-server\";\n+      String managedServerPrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+      // create the domain custom resource object\n+      Domain domain = createDomainResource(domainUid,\n+          domainNamespace,\n+          REPO_SECRET_NAME,\n+          encryptionSecretName,\n+          replicaCount,\n+          IMAGE);\n+\n+      // create model in image domain\n+      logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n+          domainUid, domainNamespace, MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG);\n+      createDomainAndVerify(domain, domainNamespace);\n+\n+      logger.info(\"Check admin service {0} is created in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkServiceExists(adminServerPodName, domainNamespace);\n+\n+      // check admin server pod is ready\n+      logger.info(\"Waiting for admin server pod {0} to be ready in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+\n+      // check managed server services created\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Check managed server service {0} is created in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkServiceExists(managedServerPrefix + i, domainNamespace);\n+      }\n+\n+      // check managed server pods are ready\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Wait for managed server pod {0} to be ready in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkPodReady(managedServerPrefix + i, domainUid, domainNamespace);\n+      }\n+\n+      //create ingress resource - rules for loadbalancing\n+      Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+      clusterNameMsPortMap.put(\"cluster-1\", 8001);\n+      logger.info(\"Creating ingress resource for domain {0} in namespace {1}\", domainUid, domainNamespace);\n+      createTraefikIngressForDomainAndVerify(domainUid, domainNamespace, 0, clusterNameMsPortMap, true);\n+\n+      logger.info(\"Getting node port for admin server default channel\");\n+      int serviceNodePort = assertDoesNotThrow(()\n+          -> getServiceNodePort(domainNamespace, adminServerPodName + \"-external\", \"default\"),\n+          \"Getting admin server node port failed\");\n+\n+      logger.info(\"Deploying application {0} in domain {1} cluster target cluster-1\",\n+          clusterViewAppPath, domainUid);\n+      ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+          String.valueOf(serviceNodePort),\n+          ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+          \"cluster-1\", clusterViewAppPath, null, domainUid + \"clusterview\");\n+      assertNotNull(result, \"Application deployment failed\");\n+      logger.info(\"Application deployment returned {0}\", result.toString());\n+      assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }\n+\n+    // verify load balancing works when 2 domains are running in the same namespace\n+    for (String domainUid : domains) {\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);", "originalCommit": "b59aed35eb7e84abecd5a098ed966f997663d36c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjExMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096110", "bodyText": "Yes, the domain names are bound in JNDI trees of the managed servers and later verified while accessing a particular managed server response.", "author": "sankarpn", "createdAt": "2020-07-27T18:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNzQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0MTA1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459641059", "bodyText": "We need to add test\n(a) to access console thru LoadBalancer\n(b) access the app thru TLS enabled EndPoints.", "author": "anpanigr", "createdAt": "2020-07-23T18:19:26Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,304 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {\n+\n+    // Create the repo secret to pull the image\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domainNamespace),\n+        String.format(\"createSecret failed for %s\", REPO_SECRET_NAME));\n+\n+    // create WebLogic domain credentials secret\n+    logger.info(\"Creating WebLogic credentials secrets for domain\");\n+    createSecretWithUsernamePassword(wlSecretName, domainNamespace,\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT);\n+\n+    // create model encryption secret\n+    logger.info(\"Creating encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        encryptionSecretName,\n+        domainNamespace,\n+        \"weblogicenc\",\n+        \"weblogicenc\"),\n+        String.format(\"createSecret failed for %s\", encryptionSecretName));\n+\n+    int replicaCount = 2;\n+    String managedServerNameBase = \"managed-server\";\n+    String[] domains = {\"domain1\", \"domain2\"};\n+\n+    for (String domainUid : domains) {\n+\n+      // admin/managed server name here should match with model yaml in MII_BASIC_WDT_MODEL_FILE\n+      String adminServerPodName = domainUid + \"-admin-server\";\n+      String managedServerPrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+      // create the domain custom resource object\n+      Domain domain = createDomainResource(domainUid,\n+          domainNamespace,\n+          REPO_SECRET_NAME,\n+          encryptionSecretName,\n+          replicaCount,\n+          IMAGE);\n+\n+      // create model in image domain\n+      logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n+          domainUid, domainNamespace, MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG);\n+      createDomainAndVerify(domain, domainNamespace);\n+\n+      logger.info(\"Check admin service {0} is created in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkServiceExists(adminServerPodName, domainNamespace);\n+\n+      // check admin server pod is ready\n+      logger.info(\"Waiting for admin server pod {0} to be ready in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+\n+      // check managed server services created\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Check managed server service {0} is created in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkServiceExists(managedServerPrefix + i, domainNamespace);\n+      }\n+\n+      // check managed server pods are ready\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Wait for managed server pod {0} to be ready in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkPodReady(managedServerPrefix + i, domainUid, domainNamespace);\n+      }\n+\n+      //create ingress resource - rules for loadbalancing\n+      Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+      clusterNameMsPortMap.put(\"cluster-1\", 8001);\n+      logger.info(\"Creating ingress resource for domain {0} in namespace {1}\", domainUid, domainNamespace);\n+      createTraefikIngressForDomainAndVerify(domainUid, domainNamespace, 0, clusterNameMsPortMap, true);\n+\n+      logger.info(\"Getting node port for admin server default channel\");\n+      int serviceNodePort = assertDoesNotThrow(()\n+          -> getServiceNodePort(domainNamespace, adminServerPodName + \"-external\", \"default\"),\n+          \"Getting admin server node port failed\");\n+\n+      logger.info(\"Deploying application {0} in domain {1} cluster target cluster-1\",\n+          clusterViewAppPath, domainUid);\n+      ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+          String.valueOf(serviceNodePort),\n+          ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+          \"cluster-1\", clusterViewAppPath, null, domainUid + \"clusterview\");\n+      assertNotNull(result, \"Application deployment failed\");\n+      logger.info(\"Application deployment returned {0}\", result.toString());\n+      assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }\n+\n+    // verify load balancing works when 2 domains are running in the same namespace\n+    for (String domainUid : domains) {\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }", "originalCommit": "b59aed35eb7e84abecd5a098ed966f997663d36c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NjU2NA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459666564", "bodyText": "Why do you want to access the console through loadbalancer?\nWhat is the usecase?", "author": "sankarpn", "createdAt": "2020-07-23T19:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0MTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjMyNA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096324", "bodyText": "added testcases for accessing the admin server console.", "author": "sankarpn", "createdAt": "2020-07-27T18:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0MTA1OQ=="}], "type": "inlineReview"}, {"oid": "2c4ff724aee90c511fa4c23d4b645a4a8a8aef5e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/2c4ff724aee90c511fa4c23d4b645a4a8a8aef5e", "message": "Add verification checks to determine host routing is done correctly", "committedDate": "2020-07-23T19:51:22Z", "type": "commit"}, {"oid": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "message": "fix comments", "committedDate": "2020-07-23T19:54:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5NTk1OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459695959", "bodyText": "Assigns unique namespaces for operator, Traefik and domains", "author": "xiancao", "createdAt": "2020-07-23T20:02:50Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,353 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjM4MQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096381", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5NTk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5ODIxNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459698215", "bodyText": "Can you let Kubernetes pick up the nodeport for Traefik then get the assigned nodeport through getServiceNodePort() method? In parallel run, the predefined nodeport may got port conflicts.", "author": "xiancao", "createdAt": "2020-07-23T20:07:09Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,353 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjQ3Nw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096477", "bodyText": "fixed.", "author": "sankarpn", "createdAt": "2020-07-27T18:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5ODIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjU2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096566", "bodyText": "Good point, Thanks", "author": "sankarpn", "createdAt": "2020-07-27T18:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5ODIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTY2Mg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459701662", "bodyText": "change this to: domainUid + \".\" + domainNamespace + \".cluster-1.test\", K8S_NODEPORT_HOST, nodeportshttp);", "author": "xiancao", "createdAt": "2020-07-23T20:14:17Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,353 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {\n+\n+    // Create the repo secret to pull the image\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domainNamespace),\n+        String.format(\"createSecret failed for %s\", REPO_SECRET_NAME));\n+\n+    // create WebLogic domain credentials secret\n+    logger.info(\"Creating WebLogic credentials secrets for domain\");\n+    createSecretWithUsernamePassword(wlSecretName, domainNamespace,\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT);\n+\n+    // create model encryption secret\n+    logger.info(\"Creating encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        encryptionSecretName,\n+        domainNamespace,\n+        \"weblogicenc\",\n+        \"weblogicenc\"),\n+        String.format(\"createSecret failed for %s\", encryptionSecretName));\n+\n+    int replicaCount = 2;\n+    String managedServerNameBase = \"managed-server\";\n+    String[] domains = {\"domain1\", \"domain2\"};\n+\n+    for (String domainUid : domains) {\n+\n+      // admin/managed server name here should match with model yaml in MII_BASIC_WDT_MODEL_FILE\n+      String adminServerPodName = domainUid + \"-admin-server\";\n+      String managedServerPrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+      // create the domain custom resource object\n+      Domain domain = createDomainResource(domainUid,\n+          domainNamespace,\n+          REPO_SECRET_NAME,\n+          encryptionSecretName,\n+          replicaCount,\n+          IMAGE);\n+\n+      // create model in image domain\n+      logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n+          domainUid, domainNamespace, MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG);\n+      createDomainAndVerify(domain, domainNamespace);\n+\n+      logger.info(\"Check admin service {0} is created in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkServiceExists(adminServerPodName, domainNamespace);\n+\n+      // check admin server pod is ready\n+      logger.info(\"Waiting for admin server pod {0} to be ready in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+\n+      // check managed server services created\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Check managed server service {0} is created in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkServiceExists(managedServerPrefix + i, domainNamespace);\n+      }\n+\n+      // check managed server pods are ready\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Wait for managed server pod {0} to be ready in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkPodReady(managedServerPrefix + i, domainUid, domainNamespace);\n+      }\n+\n+      //create ingress resource - rules for loadbalancing\n+      Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+      clusterNameMsPortMap.put(\"cluster-1\", 8001);\n+      logger.info(\"Creating ingress resource for domain {0} in namespace {1}\", domainUid, domainNamespace);\n+      createTraefikIngressForDomainAndVerify(domainUid, domainNamespace, 0, clusterNameMsPortMap, true);\n+\n+      logger.info(\"Getting node port for admin server default channel\");\n+      int serviceNodePort = assertDoesNotThrow(()\n+          -> getServiceNodePort(domainNamespace, adminServerPodName + \"-external\", \"default\"),\n+          \"Getting admin server node port failed\");\n+\n+      logger.info(\"Deploying application {0} in domain {1} cluster target cluster-1\",\n+          clusterViewAppPath, domainUid);\n+      ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+          String.valueOf(serviceNodePort),\n+          ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+          \"cluster-1\", clusterViewAppPath, null, domainUid + \"clusterview\");\n+      assertNotNull(result, \"Application deployment failed\");\n+      logger.info(\"Application deployment returned {0}\", result.toString());\n+      assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+      bindDomainName(domainUid);\n+    }\n+\n+    // verify load balancing works when 2 domains are running in the same namespace\n+    for (String domainUid : domains) {\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }\n+  }\n+\n+  private void verifyLoadbalancing(String domainUid, int replicaCount, String managedServerNameBase) {\n+    //access application in managed servers through traefik load balancer\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlRequest = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet\",\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjYxOA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096618", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMTY2Mg=="}], "type": "inlineReview"}, {"oid": "4e91d56575098e4cb824f53ec9631c64db60667e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/4e91d56575098e4cb824f53ec9631c64db60667e", "message": "Add a delay before accessing the app", "committedDate": "2020-07-23T20:36:23Z", "type": "commit"}, {"oid": "d6c95bfc2a127e9d9ad14d83270969f9e4f578e0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d6c95bfc2a127e9d9ad14d83270969f9e4f578e0", "message": "Fix the curl command", "committedDate": "2020-07-23T20:38:20Z", "type": "commit"}, {"oid": "9047b9343487da8830c66426144867df4be91932", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9047b9343487da8830c66426144867df4be91932", "message": "iAddressed the review comments", "committedDate": "2020-07-23T21:43:14Z", "type": "commit"}, {"oid": "09cf9577ba69affa0d9976479b81bcebea70be0e", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/09cf9577ba69affa0d9976479b81bcebea70be0e", "message": "Fix service name", "committedDate": "2020-07-23T21:57:41Z", "type": "commit"}, {"oid": "3f15538d7b76cf04b98111c44c728c11d45d82d0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3f15538d7b76cf04b98111c44c728c11d45d82d0", "message": "fix namespace", "committedDate": "2020-07-23T22:07:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2MDc4MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459760780", "bodyText": "You can change this to: domainUid + \".\" + domainNamespace + \".cluster-1.test\", K8S_NODEPORT_HOST, nodeportshttp);", "author": "xiancao", "createdAt": "2020-07-23T22:22:21Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,353 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {\n+\n+    // Create the repo secret to pull the image\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domainNamespace),\n+        String.format(\"createSecret failed for %s\", REPO_SECRET_NAME));\n+\n+    // create WebLogic domain credentials secret\n+    logger.info(\"Creating WebLogic credentials secrets for domain\");\n+    createSecretWithUsernamePassword(wlSecretName, domainNamespace,\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT);\n+\n+    // create model encryption secret\n+    logger.info(\"Creating encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        encryptionSecretName,\n+        domainNamespace,\n+        \"weblogicenc\",\n+        \"weblogicenc\"),\n+        String.format(\"createSecret failed for %s\", encryptionSecretName));\n+\n+    int replicaCount = 2;\n+    String managedServerNameBase = \"managed-server\";\n+    String[] domains = {\"domain1\", \"domain2\"};\n+\n+    for (String domainUid : domains) {\n+\n+      // admin/managed server name here should match with model yaml in MII_BASIC_WDT_MODEL_FILE\n+      String adminServerPodName = domainUid + \"-admin-server\";\n+      String managedServerPrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+      // create the domain custom resource object\n+      Domain domain = createDomainResource(domainUid,\n+          domainNamespace,\n+          REPO_SECRET_NAME,\n+          encryptionSecretName,\n+          replicaCount,\n+          IMAGE);\n+\n+      // create model in image domain\n+      logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n+          domainUid, domainNamespace, MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG);\n+      createDomainAndVerify(domain, domainNamespace);\n+\n+      logger.info(\"Check admin service {0} is created in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkServiceExists(adminServerPodName, domainNamespace);\n+\n+      // check admin server pod is ready\n+      logger.info(\"Waiting for admin server pod {0} to be ready in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+\n+      // check managed server services created\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Check managed server service {0} is created in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkServiceExists(managedServerPrefix + i, domainNamespace);\n+      }\n+\n+      // check managed server pods are ready\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Wait for managed server pod {0} to be ready in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkPodReady(managedServerPrefix + i, domainUid, domainNamespace);\n+      }\n+\n+      //create ingress resource - rules for loadbalancing\n+      Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+      clusterNameMsPortMap.put(\"cluster-1\", 8001);\n+      logger.info(\"Creating ingress resource for domain {0} in namespace {1}\", domainUid, domainNamespace);\n+      createTraefikIngressForDomainAndVerify(domainUid, domainNamespace, 0, clusterNameMsPortMap, true);\n+\n+      logger.info(\"Getting node port for admin server default channel\");\n+      int serviceNodePort = assertDoesNotThrow(()\n+          -> getServiceNodePort(domainNamespace, adminServerPodName + \"-external\", \"default\"),\n+          \"Getting admin server node port failed\");\n+\n+      logger.info(\"Deploying application {0} in domain {1} cluster target cluster-1\",\n+          clusterViewAppPath, domainUid);\n+      ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+          String.valueOf(serviceNodePort),\n+          ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+          \"cluster-1\", clusterViewAppPath, null, domainUid + \"clusterview\");\n+      assertNotNull(result, \"Application deployment failed\");\n+      logger.info(\"Application deployment returned {0}\", result.toString());\n+      assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+      bindDomainName(domainUid);\n+    }\n+\n+    // verify load balancing works when 2 domains are running in the same namespace\n+    for (String domainUid : domains) {\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }\n+  }\n+\n+  private void verifyLoadbalancing(String domainUid, int replicaCount, String managedServerNameBase) {\n+    //access application in managed servers through traefik load balancer\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlRequest = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet\",\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);\n+    List<String> managedServers = new ArrayList<>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServers.add(managedServerNameBase + i);\n+    }\n+    assertThat(verifyClusterMemberCommunication(curlRequest, managedServers, 20))\n+        .as(\"Verify applications from cluster can be acessed through the traefik loadbalancer.\")\n+        .withFailMessage(\"application not accessible through traefik loadbalancer.\")\n+        .isTrue();\n+\n+    boolean hostRouting = false;\n+    //access application in managed servers through traefik load balancer and bind domain in the JNDI tree\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlCmd = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet?domainTest=\" + domainUid,\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjcwMQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096701", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2MDc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2MTA5OQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459761099", "bodyText": "You can change this to: domainUid + \".\" + domainNamespace + \".cluster-1.test\", K8S_NODEPORT_HOST, nodeportshttp);", "author": "xiancao", "createdAt": "2020-07-23T22:23:15Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,353 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createTraefikIngressForDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.getNextFreePort;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by traefik loadbalancer.\n+ */\n+@DisplayName(\"Test traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static int nodeportshttp;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private final String wlSecretName = \"weblogic-credentials\";\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  /**\n+   * Assigns unique namespaces for operator and domains. Installs operator.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // get a free web and websecure ports for traefik\n+    nodeportshttp = getNextFreePort(30380, 30405);\n+    int nodeportshttps = getNextFreePort(31443, 31743);\n+\n+    // install and verify traefik\n+    logger.info(\"Installing traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, nodeportshttp, nodeportshttps);\n+\n+    // build the clusterview application\n+    logger.info(\"Building clusterview application\");\n+    Path distDir = BuildApplication.buildApplication(Paths.get(APP_DIR, \"clusterview\"), null, null,\n+        \"dist\", domainNamespace);\n+    assertTrue(Paths.get(distDir.toString(),\n+        \"clusterview.war\").toFile().exists(),\n+        \"Application archive is not available\");\n+    clusterViewAppPath = Paths.get(distDir.toString(), \"clusterview.war\");\n+\n+  }\n+\n+  @Test\n+  @DisplayName(\"Create model in image domains domain1 and domain2 and Ingress resources\")\n+  public void testTraefikLoadbalancer() {\n+\n+    // Create the repo secret to pull the image\n+    assertDoesNotThrow(() -> createDockerRegistrySecret(domainNamespace),\n+        String.format(\"createSecret failed for %s\", REPO_SECRET_NAME));\n+\n+    // create WebLogic domain credentials secret\n+    logger.info(\"Creating WebLogic credentials secrets for domain\");\n+    createSecretWithUsernamePassword(wlSecretName, domainNamespace,\n+        ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT);\n+\n+    // create model encryption secret\n+    logger.info(\"Creating encryption secret\");\n+    String encryptionSecretName = \"encryptionsecret\";\n+    assertDoesNotThrow(() -> createSecretWithUsernamePassword(\n+        encryptionSecretName,\n+        domainNamespace,\n+        \"weblogicenc\",\n+        \"weblogicenc\"),\n+        String.format(\"createSecret failed for %s\", encryptionSecretName));\n+\n+    int replicaCount = 2;\n+    String managedServerNameBase = \"managed-server\";\n+    String[] domains = {\"domain1\", \"domain2\"};\n+\n+    for (String domainUid : domains) {\n+\n+      // admin/managed server name here should match with model yaml in MII_BASIC_WDT_MODEL_FILE\n+      String adminServerPodName = domainUid + \"-admin-server\";\n+      String managedServerPrefix = domainUid + \"-\" + managedServerNameBase;\n+\n+      // create the domain custom resource object\n+      Domain domain = createDomainResource(domainUid,\n+          domainNamespace,\n+          REPO_SECRET_NAME,\n+          encryptionSecretName,\n+          replicaCount,\n+          IMAGE);\n+\n+      // create model in image domain\n+      logger.info(\"Creating model in image domain {0} in namespace {1} using docker image {2}\",\n+          domainUid, domainNamespace, MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG);\n+      createDomainAndVerify(domain, domainNamespace);\n+\n+      logger.info(\"Check admin service {0} is created in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkServiceExists(adminServerPodName, domainNamespace);\n+\n+      // check admin server pod is ready\n+      logger.info(\"Waiting for admin server pod {0} to be ready in namespace {1}\",\n+          adminServerPodName, domainNamespace);\n+      checkPodReady(adminServerPodName, domainUid, domainNamespace);\n+\n+      // check managed server services created\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Check managed server service {0} is created in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkServiceExists(managedServerPrefix + i, domainNamespace);\n+      }\n+\n+      // check managed server pods are ready\n+      for (int i = 1; i <= replicaCount; i++) {\n+        logger.info(\"Wait for managed server pod {0} to be ready in namespace {1}\",\n+            managedServerPrefix + i, domainNamespace);\n+        checkPodReady(managedServerPrefix + i, domainUid, domainNamespace);\n+      }\n+\n+      //create ingress resource - rules for loadbalancing\n+      Map<String, Integer> clusterNameMsPortMap = new HashMap<>();\n+      clusterNameMsPortMap.put(\"cluster-1\", 8001);\n+      logger.info(\"Creating ingress resource for domain {0} in namespace {1}\", domainUid, domainNamespace);\n+      createTraefikIngressForDomainAndVerify(domainUid, domainNamespace, 0, clusterNameMsPortMap, true);\n+\n+      logger.info(\"Getting node port for admin server default channel\");\n+      int serviceNodePort = assertDoesNotThrow(()\n+          -> getServiceNodePort(domainNamespace, adminServerPodName + \"-external\", \"default\"),\n+          \"Getting admin server node port failed\");\n+\n+      logger.info(\"Deploying application {0} in domain {1} cluster target cluster-1\",\n+          clusterViewAppPath, domainUid);\n+      ExecResult result = DeployUtil.deployUsingRest(K8S_NODEPORT_HOST,\n+          String.valueOf(serviceNodePort),\n+          ADMIN_USERNAME_DEFAULT, ADMIN_PASSWORD_DEFAULT,\n+          \"cluster-1\", clusterViewAppPath, null, domainUid + \"clusterview\");\n+      assertNotNull(result, \"Application deployment failed\");\n+      logger.info(\"Application deployment returned {0}\", result.toString());\n+      assertEquals(\"202\", result.stdout(), \"Deployment didn't return HTTP status code 202\");\n+\n+      bindDomainName(domainUid);\n+    }\n+\n+    // verify load balancing works when 2 domains are running in the same namespace\n+    for (String domainUid : domains) {\n+      verifyLoadbalancing(domainUid, replicaCount, managedServerNameBase);\n+    }\n+  }\n+\n+  private void verifyLoadbalancing(String domainUid, int replicaCount, String managedServerNameBase) {\n+    //access application in managed servers through traefik load balancer\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlRequest = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet\",\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);\n+    List<String> managedServers = new ArrayList<>();\n+    for (int i = 1; i <= replicaCount; i++) {\n+      managedServers.add(managedServerNameBase + i);\n+    }\n+    assertThat(verifyClusterMemberCommunication(curlRequest, managedServers, 20))\n+        .as(\"Verify applications from cluster can be acessed through the traefik loadbalancer.\")\n+        .withFailMessage(\"application not accessible through traefik loadbalancer.\")\n+        .isTrue();\n+\n+    boolean hostRouting = false;\n+    //access application in managed servers through traefik load balancer and bind domain in the JNDI tree\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlCmd = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet?domainTest=\" + domainUid,\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);\n+\n+    // call the webapp and verify the bound domain name to determine\n+    // the requests are sent to the correct cluster members.\n+    for (int i = 0; i < 10; i++) {\n+      ExecResult result;\n+      try {\n+        result = ExecCommand.exec(curlCmd, true);\n+        String response = result.stdout().trim();\n+        if (response.contains(domainUid)) {\n+          hostRouting = true;\n+        }\n+        logger.info(\"Response for iteration {0}: exitValue {1}, stdout {2}, stderr {3}\",\n+            i, result.exitValue(), response, result.stderr());\n+      } catch (IOException | InterruptedException ex) {\n+        //\n+      }\n+    }\n+    assertTrue(hostRouting, \"Host routing is not working\");\n+\n+  }\n+\n+  private void bindDomainName(String domainUid) {\n+    //access application in managed servers through traefik load balancer and bind domain in the JNDI tree\n+    logger.info(\"Accessing the clusterview app through traefik load balancer\");\n+    String curlCmd = String.format(\"curl --silent --show-error --noproxy '*' \"\n+        + \"-H 'host: %s' http://%s:%s/clusterview/ClusterViewServlet?bindDomain=\" + domainUid,\n+        domainUid + \".\" + domainNamespace + \".\" + \"cluster-1\" + \".test\", K8S_NODEPORT_HOST, nodeportshttp);", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5Njc2Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096766", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2MTA5OQ=="}], "type": "inlineReview"}, {"oid": "0e9ebb47c739eded1414c29b6aa682fe85ec9e40", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0e9ebb47c739eded1414c29b6aa682fe85ec9e40", "message": "add more wait time", "committedDate": "2020-07-23T22:30:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NDE0Ng==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459764146", "bodyText": "use 'Traefik' since it is a product name", "author": "xiancao", "createdAt": "2020-07-23T22:31:26Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/actions/TestActions.java", "diffHunk": "@@ -338,6 +340,18 @@ public static boolean installVoyager(VoyagerParams params) {\n     return Voyager.install(params);\n   }\n \n+  /**\n+   * Install traefik ingress controller.", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjgyMw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096823", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:47:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NDE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTczMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459765730", "bodyText": "use 'Traefik' here", "author": "xiancao", "createdAt": "2020-07-23T22:35:42Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Kubernetes.java", "diffHunk": "@@ -338,6 +339,29 @@ public static boolean isNginxPodReady(String namespace) throws ApiException {\n     return isPodReady(namespace, labelSelector, \"nginx-ingress-controller\");\n   }\n \n+  /**\n+   * Checks if traefik pod is running in the specified namespace.", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5Njk1MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461096950", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTkzMA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459765930", "bodyText": "change all 'traefik' in the comments to 'Traefik'", "author": "xiancao", "createdAt": "2020-07-23T22:36:17Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/assertions/impl/Kubernetes.java", "diffHunk": "@@ -338,6 +339,29 @@ public static boolean isNginxPodReady(String namespace) throws ApiException {\n     return isPodReady(namespace, labelSelector, \"nginx-ingress-controller\");\n   }\n \n+  /**\n+   * Checks if traefik pod is running in the specified namespace.\n+   *\n+   * @param namespace in which to check for the running traefik pod\n+   * @return true if the pod is running, otherwise false\n+   * @throws ApiException if Kubernetes client API call fails\n+   */\n+  public static boolean isTraefikPodRunning(String namespace) throws ApiException {\n+    return isPodRunning(namespace, null, TRAEFIK_RELEASE_NAME + \"-\" + namespace.substring(3));\n+  }\n+\n+  /**\n+   * Check whether the traefik pod is ready in the specified namespace.", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NzAzNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461097036", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NjkyNQ==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459766925", "bodyText": "Traefik chart values to override", "author": "xiancao", "createdAt": "2020-07-23T22:39:20Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -448,6 +455,63 @@ public static HelmParams installAndVerifyVoyager(String voyagerNamespace,\n     return voyagerHelmParams;\n   }\n \n+  /**\n+   * Install traefik and wait for up to five minutes for the traefik pod to be ready.\n+   *\n+   * @param traefikNamespace the namespace in which the traefik ingress controller is installed\n+   * @param nodeportshttp the web nodeport of traefik\n+   * @param nodeportshttps the websecure nodeport of traefik\n+   * @return the traefik Helm installation parameters\n+   */\n+  public static HelmParams installAndVerifyTraefik(String traefikNamespace,\n+      int nodeportshttp,\n+      int nodeportshttps) {\n+    LoggingFacade logger = getLogger();\n+    // Helm install parameters\n+    HelmParams traefikHelmParams = new HelmParams()\n+        .releaseName(TRAEFIK_RELEASE_NAME + \"-\" + traefikNamespace.substring(3))\n+        .namespace(traefikNamespace)\n+        .repoUrl(TRAEFIK_REPO_URL)\n+        .repoName(TRAEFIK_REPO_NAME)\n+        .chartName(TRAEFIK_CHART_NAME);\n+\n+    // NGINX chart values to override", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NzA5OA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461097098", "bodyText": "fixed", "author": "sankarpn", "createdAt": "2020-07-27T18:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NjkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NzY0MA==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r459767640", "bodyText": "what if only nodeportshttp or nodeportshttps is not 0?", "author": "xiancao", "createdAt": "2020-07-23T22:41:19Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/utils/CommonTestUtils.java", "diffHunk": "@@ -448,6 +455,63 @@ public static HelmParams installAndVerifyVoyager(String voyagerNamespace,\n     return voyagerHelmParams;\n   }\n \n+  /**\n+   * Install traefik and wait for up to five minutes for the traefik pod to be ready.\n+   *\n+   * @param traefikNamespace the namespace in which the traefik ingress controller is installed\n+   * @param nodeportshttp the web nodeport of traefik\n+   * @param nodeportshttps the websecure nodeport of traefik\n+   * @return the traefik Helm installation parameters\n+   */\n+  public static HelmParams installAndVerifyTraefik(String traefikNamespace,\n+      int nodeportshttp,\n+      int nodeportshttps) {\n+    LoggingFacade logger = getLogger();\n+    // Helm install parameters\n+    HelmParams traefikHelmParams = new HelmParams()\n+        .releaseName(TRAEFIK_RELEASE_NAME + \"-\" + traefikNamespace.substring(3))\n+        .namespace(traefikNamespace)\n+        .repoUrl(TRAEFIK_REPO_URL)\n+        .repoName(TRAEFIK_REPO_NAME)\n+        .chartName(TRAEFIK_CHART_NAME);\n+\n+    // NGINX chart values to override\n+    TraefikParams traefikParams = new TraefikParams()\n+        .helmParams(traefikHelmParams);\n+\n+    if (nodeportshttp != 0 && nodeportshttps != 0) {\n+      traefikParams\n+          .nodePortsHttp(nodeportshttp)\n+          .nodePortsHttps(nodeportshttps);\n+    }", "originalCommit": "a0d4245dc4111aede7b871b0a2e9c9534f8e930f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NzY2Mw==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461097663", "bodyText": "I copied this code from the one I guess you created. Your question makes sense, removed the check and assign value only from supplied method params.", "author": "sankarpn", "createdAt": "2020-07-27T18:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NzY0MA=="}], "type": "inlineReview"}, {"oid": "097465f569f721633cecae63b848b453d6a963ba", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/097465f569f721633cecae63b848b453d6a963ba", "message": "Adding TLS test", "committedDate": "2020-07-24T01:26:48Z", "type": "commit"}, {"oid": "0dda55420afd49660282b8c24ff505c2e89f1931", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/0dda55420afd49660282b8c24ff505c2e89f1931", "message": "Fix CN", "committedDate": "2020-07-24T04:06:14Z", "type": "commit"}, {"oid": "9eb5c6d0a97bc06bfdf8e79708103a8c745b5ed4", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9eb5c6d0a97bc06bfdf8e79708103a8c745b5ed4", "message": "Add https usecase", "committedDate": "2020-07-24T16:35:45Z", "type": "commit"}, {"oid": "a1fa721f1321c4b0656632497e19f987333d674a", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a1fa721f1321c4b0656632497e19f987333d674a", "message": "Encode it as normal String", "committedDate": "2020-07-24T17:12:02Z", "type": "commit"}, {"oid": "5a71b6f301f5bd7a3f5fe67011a4e7bd1ef69cbc", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5a71b6f301f5bd7a3f5fe67011a4e7bd1ef69cbc", "message": "Fix file names", "committedDate": "2020-07-24T17:23:10Z", "type": "commit"}, {"oid": "760edcad6ee0afee1ff520cc5276e790183412b8", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/760edcad6ee0afee1ff520cc5276e790183412b8", "message": "include -k option to ignore host name verification", "committedDate": "2020-07-24T17:25:37Z", "type": "commit"}, {"oid": "82300487fcb8e22c5d3f6459c912bba09bcfbf30", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/82300487fcb8e22c5d3f6459c912bba09bcfbf30", "message": "Add cert and key as String", "committedDate": "2020-07-24T17:58:04Z", "type": "commit"}, {"oid": "3fbe3e814bf51e1f026116cc746bcbe16011e327", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/3fbe3e814bf51e1f026116cc746bcbe16011e327", "message": "wip", "committedDate": "2020-07-24T18:51:42Z", "type": "commit"}, {"oid": "c8723f0489edf68f842e5f782ca31fa517947413", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/c8723f0489edf68f842e5f782ca31fa517947413", "message": "use same namespace for traefik", "committedDate": "2020-07-24T20:02:13Z", "type": "commit"}, {"oid": "086720c99aa364c4d465ec538bb7babe9b3a2ff5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/086720c99aa364c4d465ec538bb7babe9b3a2ff5", "message": "Added more tests", "committedDate": "2020-07-25T03:46:53Z", "type": "commit"}, {"oid": "b6a03cc26767605567f6e968001278dbb353c8cd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/b6a03cc26767605567f6e968001278dbb353c8cd", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into traefik-lb-tests", "committedDate": "2020-07-25T03:47:14Z", "type": "commit"}, {"oid": "6fa00fb9298e58d2c20b07e2243f26f8f668b9a3", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/6fa00fb9298e58d2c20b07e2243f26f8f668b9a3", "message": "Fix the ingress rules creation  command", "committedDate": "2020-07-25T05:32:59Z", "type": "commit"}, {"oid": "fe7f4c5832216fb5bf00347543951ef5c82acd19", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/fe7f4c5832216fb5bf00347543951ef5c82acd19", "message": "Fix getNodePort", "committedDate": "2020-07-25T23:14:57Z", "type": "commit"}, {"oid": "d3e95fadc162d2d4d9cc68725b40ce276336422d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d3e95fadc162d2d4d9cc68725b40ce276336422d", "message": "Access console in a loop", "committedDate": "2020-07-26T00:09:30Z", "type": "commit"}, {"oid": "5e3c8259e7ce105c8a8608c1d056743c7be7a857", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/5e3c8259e7ce105c8a8608c1d056743c7be7a857", "message": "Merge branch 'develop' of https://github.com/oracle/weblogic-kubernetes-operator into traefik-lb-tests", "committedDate": "2020-07-27T17:15:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4NDYyNg==", "url": "https://github.com/oracle/weblogic-kubernetes-operator/pull/1831#discussion_r461984626", "bodyText": "remove commented out line", "author": "marinakog", "createdAt": "2020-07-29T01:28:13Z", "path": "new-integration-tests/src/test/java/oracle/weblogic/kubernetes/ItTraefikLoadBalancer.java", "diffHunk": "@@ -0,0 +1,509 @@\n+// Copyright (c) 2020, Oracle Corporation and/or its affiliates.\n+// Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.\n+\n+package oracle.weblogic.kubernetes;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import io.kubernetes.client.openapi.models.V1EnvVar;\n+import io.kubernetes.client.openapi.models.V1LocalObjectReference;\n+import io.kubernetes.client.openapi.models.V1ObjectMeta;\n+import io.kubernetes.client.openapi.models.V1SecretReference;\n+import oracle.weblogic.domain.AdminServer;\n+import oracle.weblogic.domain.AdminService;\n+import oracle.weblogic.domain.Channel;\n+import oracle.weblogic.domain.Cluster;\n+import oracle.weblogic.domain.Configuration;\n+import oracle.weblogic.domain.Domain;\n+import oracle.weblogic.domain.DomainSpec;\n+import oracle.weblogic.domain.Model;\n+import oracle.weblogic.domain.ServerPod;\n+import oracle.weblogic.kubernetes.actions.ActionConstants;\n+import oracle.weblogic.kubernetes.actions.impl.primitive.HelmParams;\n+import oracle.weblogic.kubernetes.annotations.IntegrationTest;\n+import oracle.weblogic.kubernetes.annotations.Namespaces;\n+import oracle.weblogic.kubernetes.logging.LoggingFacade;\n+import oracle.weblogic.kubernetes.utils.BuildApplication;\n+import oracle.weblogic.kubernetes.utils.DeployUtil;\n+import oracle.weblogic.kubernetes.utils.ExecCommand;\n+import oracle.weblogic.kubernetes.utils.ExecResult;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_PASSWORD_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.ADMIN_USERNAME_DEFAULT;\n+import static oracle.weblogic.kubernetes.TestConstants.DOMAIN_API_VERSION;\n+import static oracle.weblogic.kubernetes.TestConstants.K8S_NODEPORT_HOST;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_NAME;\n+import static oracle.weblogic.kubernetes.TestConstants.MII_BASIC_IMAGE_TAG;\n+import static oracle.weblogic.kubernetes.TestConstants.REPO_SECRET_NAME;\n+import static oracle.weblogic.kubernetes.actions.ActionConstants.APP_DIR;\n+import static oracle.weblogic.kubernetes.actions.TestActions.getServiceNodePort;\n+import static oracle.weblogic.kubernetes.actions.TestActions.uninstallTraefik;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkPodReady;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.checkServiceExists;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDockerRegistrySecret;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createDomainAndVerify;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithTLSCertKey;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.createSecretWithUsernamePassword;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyOperator;\n+import static oracle.weblogic.kubernetes.utils.CommonTestUtils.installAndVerifyTraefik;\n+import static oracle.weblogic.kubernetes.utils.TestUtils.verifyClusterMemberCommunication;\n+import static oracle.weblogic.kubernetes.utils.ThreadSafeLogger.getLogger;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to WebLogic domain traffic routed by Traefik loadbalancer.\n+ */\n+@DisplayName(\"Test Traefik loadbalancing with multiple WebLogic domains\")\n+@IntegrationTest\n+public class ItTraefikLoadBalancer {\n+\n+  private static String opNamespace = null;\n+  private static String domainNamespace = null;\n+  private static String traefikNamespace = null;\n+\n+  private static HelmParams traefikHelmParams = null;\n+\n+  private static final String IMAGE = MII_BASIC_IMAGE_NAME + \":\" + MII_BASIC_IMAGE_TAG;\n+\n+  private static final String WL_SECRET_NAME = \"weblogic-credentials\";\n+  private static Path tlsCertFile;\n+  private static Path tlsKeyFile;\n+\n+  private static Path clusterViewAppPath;\n+  private static LoggingFacade logger = null;\n+\n+  private static final String[] domains = {\"domain1\", \"domain2\"};\n+  private static final int replicaCount = 2;\n+  private static final String managedServerNameBase = \"managed-server\";\n+\n+  /**\n+   * 1. Assigns unique namespaces for operator, Traefik loadbalancer and domains.\n+   * 2. Installs operator.\n+   * 3. Creates 2 MII domains.\n+   * 4. Creates Ingress resource for each domain with Host based routing rules.\n+   * 5. Deploys clusterview sample application in cluster target in each domain.\n+   * 6. Creates a TLS Kubernetes for secure access to the clusters.\n+   * 7. Create Ingress rules for host based routing to various targets.\n+   *\n+   * @param namespaces injected by JUnit\n+   */\n+  @BeforeAll\n+  public static void initAll(@Namespaces(3) List<String> namespaces) {\n+    logger = getLogger();\n+\n+    logger.info(\"Assign a unique namespace for operator\");\n+    opNamespace = namespaces.get(0);\n+\n+    logger.info(\"Assign a unique namespace for WebLogic domains\");\n+    domainNamespace = namespaces.get(1);\n+\n+    logger.info(\"Assign a unique namespace for Traefik\");\n+    traefikNamespace = namespaces.get(2);\n+\n+    // install operator and verify its running in ready state\n+    logger.info(\"Installing operator\");\n+    installAndVerifyOperator(opNamespace, domainNamespace);\n+\n+    // install and verify Traefik\n+    logger.info(\"Installing Traefik controller using helm\");\n+    traefikHelmParams = installAndVerifyTraefik(traefikNamespace, 0, 0);\n+    //traefikHelmParams = installAndVerifyTraefik(domainNamespace, 0, 0);", "originalCommit": "d3e95fadc162d2d4d9cc68725b40ce276336422d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d25985e0814993836f32c274e05eb2987935ae8d", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/d25985e0814993836f32c274e05eb2987935ae8d", "message": "Adding voyager tests", "committedDate": "2020-07-29T20:03:40Z", "type": "commit"}, {"oid": "14e2fd1f55c4884e2fef103c488cff2796e933f0", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/14e2fd1f55c4884e2fef103c488cff2796e933f0", "message": "Renamed testclass to be generic for all loadbalancers", "committedDate": "2020-07-29T20:05:13Z", "type": "commit"}, {"oid": "e290856fb59d4251fc00ce8c57492efedfc22afd", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/e290856fb59d4251fc00ce8c57492efedfc22afd", "message": "order the tests", "committedDate": "2020-07-29T21:44:39Z", "type": "commit"}, {"oid": "a61c91319d2c7a219aa72b201a755dd655e30e68", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/a61c91319d2c7a219aa72b201a755dd655e30e68", "message": "Add break statement once reponse is found", "committedDate": "2020-07-29T22:19:40Z", "type": "commit"}, {"oid": "9fd3b7dbb2d6558c734584856376558fa49a32b5", "url": "https://github.com/oracle/weblogic-kubernetes-operator/commit/9fd3b7dbb2d6558c734584856376558fa49a32b5", "message": "bind domain names", "committedDate": "2020-07-29T23:05:13Z", "type": "commit"}]}