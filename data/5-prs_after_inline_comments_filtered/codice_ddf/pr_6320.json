{"pr_number": 6320, "pr_title": "DDF-6319 - Enable case-insensitive sorting of solr text fields", "pr_createdAt": "2020-09-11T20:05:18Z", "pr_url": "https://github.com/codice/ddf/pull/6320", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwOTAyNQ==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r488309025", "bodyText": "\u2757 I realized the other day that similar code I had added to the Solr client could cause threading issue since System properties are backed by a hashtable which is synchronized.  In the other case the method would generally short circuit before reaching the system property check.  In this case, it will happen for every sorted geo and text field.\nhttps://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/classes/java/lang/System.java#L533\nI would recommend loading this property into a field.  We can restart the bundle if we need to refresh the value.", "author": "pklinef", "createdAt": "2020-09-15T00:22:00Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -899,12 +899,17 @@ private String findAnyMatchingNumericalField(String propertyName, String fieldSu\n   }\n \n   String getSortKey(String field) {\n-    if (field.endsWith(SchemaFields.GEO_SUFFIX)) {\n+    if (field.endsWith(SchemaFields.GEO_SUFFIX)\n+        || (field.endsWith(SchemaFields.TEXT_SUFFIX) && caseInsensitiveSort())) {\n       field = field + SchemaFields.SORT_SUFFIX;\n     }\n     return field;\n   }\n \n+  private boolean caseInsensitiveSort() {\n+    return \"true\".equals(System.getProperty(\"solr.sort.case-insensitive\"));", "originalCommit": "d1abc7f1866dc24ba9f43471627b00ea300ff399", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODQ4NA==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r490318484", "bodyText": "\u270f\ufe0f There is one solr.query. system property and I am working on a PR to add another one.  Might consider making this solr.query.sort.caseInsensitive.\n\n  \n    \n      ddf/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n    \n    \n         Line 155\n      in\n      b50f3c2\n    \n    \n    \n    \n\n        \n          \n           private static final String SOLR_QUERY_TIMEALLOWEDMS = \"solr.query.timeAllowed\";", "author": "pklinef", "createdAt": "2020-09-17T14:55:02Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -163,6 +165,7 @@ public DynamicSchemaResolver(List<String> additionalFields) {\n     ConfigurationStore.getInstance().addConfigurationListener(this);\n     this.schemaFields = new SchemaFields();\n     metadataMaximumBytes = getMetadataSizeLimit();\n+    caseInsensitiveSort = \"true\".equals(System.getProperty(\"solr.sort.case-insensitive\"));", "originalCommit": "c1e1cbddd63dd4db770fc324751af6f2e9d1ccc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98356ce8b470ba503c121cd1083f9b9040a560eb", "url": "https://github.com/codice/ddf/commit/98356ce8b470ba503c121cd1083f9b9040a560eb", "message": "Fix schema to use SortableTextField", "committedDate": "2020-09-17T21:36:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NDIyNA==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492364224", "bodyText": "\u2757 Truncate the fields like we used to do to save on index space.  Before we were using 127 characters but that was limited by TruncateTokenFilterFactory.\nhttps://github.com/codice/ddf/blob/2.12.x/platform/solr/platform-solr-server-standalone/src/main/resources/solr/conf/schema.xml#L569-L570\nSortableTextField uses a value of 1024.", "author": "pklinef", "createdAt": "2020-09-21T21:46:06Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +333,18 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)", "originalCommit": "f52043a5fdfcac5ff9b5d6f9b134b2797c6078ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwOTUzNQ==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492409535", "bodyText": "\u270f\ufe0f Some kind of log message would be useful here to know why there was a NumberFormatException.", "author": "pklinef", "createdAt": "2020-09-21T23:55:48Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -163,6 +167,13 @@ public DynamicSchemaResolver(List<String> additionalFields) {\n     ConfigurationStore.getInstance().addConfigurationListener(this);\n     this.schemaFields = new SchemaFields();\n     metadataMaximumBytes = getMetadataSizeLimit();\n+    caseInsensitiveSort = \"true\".equals(System.getProperty(\"solr.query.sort.caseInsensitive\"));\n+    try {\n+      textSortCharacterLimit =\n+          Integer.parseInt(System.getProperty(\"solr.index.sort.characterLimit\", \"127\").trim());\n+    } catch (NumberFormatException nfe) {\n+      textSortCharacterLimit = 127;", "originalCommit": "5680507a6b0ca92e724b50b29c143edfe1eb9546", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwOTkxNg==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492409916", "bodyText": "\u270f\ufe0f If you truncate before toLowerCase, then there will be less to make lowercase.", "author": "pklinef", "createdAt": "2020-09-21T23:57:11Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +341,19 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)\n+                    .map(String::toLowerCase)\n+                    .map(value -> truncate(value, textSortCharacterLimit))", "originalCommit": "5680507a6b0ca92e724b50b29c143edfe1eb9546", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxMDQxOA==", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492410418", "bodyText": "\u2757 Filter null values to avoid NPE in following maps.", "author": "pklinef", "createdAt": "2020-09-21T23:59:12Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +341,19 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)", "originalCommit": "5680507a6b0ca92e724b50b29c143edfe1eb9546", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00fa29d1289661f3c23ca26aadf74bdfc50f6812", "url": "https://github.com/codice/ddf/commit/00fa29d1289661f3c23ca26aadf74bdfc50f6812", "message": "Enable case-insensitive sorting of solr text fields", "committedDate": "2020-09-22T02:49:41Z", "type": "commit"}, {"oid": "5cd23228180a4515fbbbf49bef8761eb252b4b9d", "url": "https://github.com/codice/ddf/commit/5cd23228180a4515fbbbf49bef8761eb252b4b9d", "message": "Move caseInsensitiveSort to field instead of method", "committedDate": "2020-09-22T02:52:27Z", "type": "commit"}, {"oid": "956479ca630eb30b43e8e070a3e698babf184f98", "url": "https://github.com/codice/ddf/commit/956479ca630eb30b43e8e070a3e698babf184f98", "message": "Fix schema to use SortableTextField", "committedDate": "2020-09-22T02:52:27Z", "type": "commit"}, {"oid": "9e6bcc31cf2cf5fe116ffc7d853b59c2fea43e9b", "url": "https://github.com/codice/ddf/commit/9e6bcc31cf2cf5fe116ffc7d853b59c2fea43e9b", "message": "Update property name", "committedDate": "2020-09-22T02:53:31Z", "type": "commit"}, {"oid": "11e4162a389ad67f59de2614362651fe62c260e5", "url": "https://github.com/codice/ddf/commit/11e4162a389ad67f59de2614362651fe62c260e5", "message": "Add unit test, add sort field at ingest time", "committedDate": "2020-09-22T02:53:31Z", "type": "commit"}, {"oid": "6d86ebbb318ed31823378fb2bd96b529e6730567", "url": "https://github.com/codice/ddf/commit/6d86ebbb318ed31823378fb2bd96b529e6730567", "message": "Add truncation to sort fields", "committedDate": "2020-09-22T02:54:47Z", "type": "commit"}, {"oid": "7984aad56fd0c07b07fbbf3bb377c6f3e5ebd6e3", "url": "https://github.com/codice/ddf/commit/7984aad56fd0c07b07fbbf3bb377c6f3e5ebd6e3", "message": "Change to string field, address comments", "committedDate": "2020-09-22T02:54:47Z", "type": "commit"}, {"oid": "7984aad56fd0c07b07fbbf3bb377c6f3e5ebd6e3", "url": "https://github.com/codice/ddf/commit/7984aad56fd0c07b07fbbf3bb377c6f3e5ebd6e3", "message": "Change to string field, address comments", "committedDate": "2020-09-22T02:54:47Z", "type": "forcePushed"}]}