{"pr_number": 6427, "pr_title": "[2.26.x] Fix email client not finding IMAPProvider", "pr_createdAt": "2020-11-20T14:30:52Z", "pr_url": "https://github.com/codice/ddf/pull/6427", "timeline": [{"oid": "157aefe0069d0444e96f218b921459ae7d5bdb7b", "url": "https://github.com/codice/ddf/commit/157aefe0069d0444e96f218b921459ae7d5bdb7b", "message": "Fix email client not finding IMAPProvider", "committedDate": "2020-11-20T14:23:21Z", "type": "commit"}, {"oid": "d6f27c3f121b14ceb60603e06308bb794fcb6478", "url": "https://github.com/codice/ddf/commit/d6f27c3f121b14ceb60603e06308bb794fcb6478", "message": "Use correct version", "committedDate": "2020-11-20T14:49:20Z", "type": "commit"}, {"oid": "e3aed6db979c8307ca0c783e9927a2bc48dbc61d", "url": "https://github.com/codice/ddf/commit/e3aed6db979c8307ca0c783e9927a2bc48dbc61d", "message": "Fix critical comment formatting issue", "committedDate": "2020-11-20T16:04:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwNjM5Ng==", "url": "https://github.com/codice/ddf/pull/6427#discussion_r527806396", "bodyText": "\u270f\ufe0f Would it be worthwhile to reset the class loader in a finally block?", "author": "emmberk", "createdAt": "2020-11-20T16:25:59Z", "path": "platform/email/platform-email-impl/src/main/java/org/codice/ddf/platform/email/impl/SmtpClientImpl.java", "diffHunk": "@@ -126,15 +127,34 @@ public Session createSession() {\n     properties.setProperty(SMTP_HOST_PROPERTY, hostName);\n     properties.setProperty(SMTP_PORT_PROPERTY, portNumber.toString());\n \n+    // Jakarta Mail uses java.util.ServiceLoader.load() to look for service implementations, in\n+    // this case of the javax.mail.Provider interface. ServiceLoader relies on the Thread Context\n+    // Classloader which is not necessarily the correct behavior in an OSGi context and may result\n+    // in services not being found.\n+    //\n+    // To fix this, we set the current thread classloader to the classloader of the bundle\n+    // containing those services (making sure to restore the original classloader before returning)\n+    // so that ServiceLoader will always find them.\n+    //\n+    // TODO: Look into SPI Fly. Might be a better solution\n+    // http://aries.apache.org/modules/spi-fly.html\n+    ClassLoader originalContextClassLoader = Thread.currentThread().getContextClassLoader();\n+    Thread.currentThread().setContextClassLoader(Provider.class.getClassLoader());\n+\n+    Session session;\n     if (StringUtils.isNotBlank(userName)) {\n       properties.put(SMTP_AUTH_PROPERTY, TRUE);\n       properties.put(SMTP_START_TLS_ENABLE_PROPERTY, TRUE);\n \n-      return Session.getInstance(properties, createAuthenticator());\n+      session = Session.getInstance(properties, createAuthenticator());\n     } else {\n       properties.setProperty(SMTP_AUTH_PROPERTY, FALSE);\n-      return Session.getInstance(properties);\n+\n+      session = Session.getInstance(properties);\n     }\n+\n+    Thread.currentThread().setContextClassLoader(originalContextClassLoader);", "originalCommit": "e3aed6db979c8307ca0c783e9927a2bc48dbc61d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxMjk0NQ==", "url": "https://github.com/codice/ddf/pull/6427#discussion_r527812945", "bodyText": "Good idea", "author": "SmithJosh", "createdAt": "2020-11-20T16:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwNjM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxNTIyMA==", "url": "https://github.com/codice/ddf/pull/6427#discussion_r527815220", "bodyText": "\u270f\ufe0f Should the Thread.currentThread().setContextClassLoader(Provider.class.getClassLoader()); line go inside the try block in case something goes wrong between that line and when the try block starts?", "author": "emmberk", "createdAt": "2020-11-20T16:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwNjM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxOTM5NA==", "url": "https://github.com/codice/ddf/pull/6427#discussion_r527819394", "bodyText": "Ah, yeah. I changed it", "author": "SmithJosh", "createdAt": "2020-11-20T16:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwNjM5Ng=="}], "type": "inlineReview"}, {"oid": "4a0a22bbb0fb52d9b44d020464a70dfe2baea5f1", "url": "https://github.com/codice/ddf/commit/4a0a22bbb0fb52d9b44d020464a70dfe2baea5f1", "message": "Restore classloader in a finally block", "committedDate": "2020-11-20T16:36:34Z", "type": "commit"}, {"oid": "4a0a22bbb0fb52d9b44d020464a70dfe2baea5f1", "url": "https://github.com/codice/ddf/commit/4a0a22bbb0fb52d9b44d020464a70dfe2baea5f1", "message": "Restore classloader in a finally block", "committedDate": "2020-11-20T16:36:34Z", "type": "forcePushed"}, {"oid": "3ee2b20359db6ee7c99705466dcfa6867e5e4af0", "url": "https://github.com/codice/ddf/commit/3ee2b20359db6ee7c99705466dcfa6867e5e4af0", "message": "Set classloader inside the try block", "committedDate": "2020-11-20T16:44:57Z", "type": "commit"}]}