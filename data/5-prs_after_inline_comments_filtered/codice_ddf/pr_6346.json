{"pr_number": 6346, "pr_title": "[2.19.x] DDF-6156 G-8624 SHA 256 Checksum Provider", "pr_createdAt": "2020-09-24T23:29:23Z", "pr_url": "https://github.com/codice/ddf/pull/6346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2OTY0NQ==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r494669645", "bodyText": "The Adler32 provider allocates more space for reading the stream.\nbyte[] buf = new byte[4096];\n\nIs 1028 going to be enough?", "author": "Lambeaux", "createdAt": "2020-09-24T23:45:28Z", "path": "libs/checksum/src/main/java/org/codice/ddf/checksum/impl/Sha256ChecksumProvider.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.checksum.impl;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import org.apache.commons.codec.binary.Hex;\n+import org.codice.ddf.checksum.AbstractChecksumProvider;\n+\n+public class Sha256ChecksumProvider extends AbstractChecksumProvider {\n+\n+  private static final String DIGEST_ALGORITHM = \"SHA-256\";\n+\n+  @Override\n+  public String calculateChecksum(InputStream inputStream)\n+      throws IOException, NoSuchAlgorithmException {\n+    if (inputStream == null) {\n+      throw new IllegalArgumentException(\"InputStream cannot be null\");\n+    }\n+\n+    try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {\n+      byte[] buffer = new byte[1028];", "originalCommit": "68aa4b21ec9c81b3119adb8418e758c79631cd64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4MjMwMg==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r494682302", "bodyText": "See below comment. As long as len never exceeds 1028 I think this is fine.", "author": "Lambeaux", "createdAt": "2020-09-25T00:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2OTY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY3NjE3Ng==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r494676176", "bodyText": "Okay. I think I see the difference here. The Adler flavor is using a special pass-through stream that handles checksum computation. That's not a built-in option for SHA-256 so we need to do a manual handoff between streams.\nThe local byte array buffer is only being used to cache the handoff. The outputStream has an internal byte array that will resize itself as necessary.\nI think this will work fine.\n(\u2753 ) Do we need to handle the case where len is zero?", "author": "Lambeaux", "createdAt": "2020-09-25T00:08:38Z", "path": "libs/checksum/src/main/java/org/codice/ddf/checksum/impl/Sha256ChecksumProvider.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.checksum.impl;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import org.apache.commons.codec.binary.Hex;\n+import org.codice.ddf.checksum.AbstractChecksumProvider;\n+\n+public class Sha256ChecksumProvider extends AbstractChecksumProvider {\n+\n+  private static final String DIGEST_ALGORITHM = \"SHA-256\";\n+\n+  @Override\n+  public String calculateChecksum(InputStream inputStream)\n+      throws IOException, NoSuchAlgorithmException {\n+    if (inputStream == null) {\n+      throw new IllegalArgumentException(\"InputStream cannot be null\");\n+    }\n+\n+    try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {\n+      byte[] buffer = new byte[1028];\n+\n+      int len;\n+      while ((len = inputStream.read(buffer)) != -1) {\n+        outputStream.write(buffer, 0, len);", "originalCommit": "68aa4b21ec9c81b3119adb8418e758c79631cd64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAyNTcxMQ==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r495025711", "bodyText": "Found a different utility that simplifies this", "author": "bdeining", "createdAt": "2020-09-25T14:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY3NjE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4MTk3MA==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r494681970", "bodyText": "( \u2753 ) Can we validate these using a separate tool just to be sure? For example, I'm not getting consistent results leveraging Python when I expect I should.\n$ python -c \"import hashlib; m = hashlib.sha256(); m.update('Hello World'); print(m.hexdigest());\"\na591a6d40bf420404a011733cfb7b190d62c65bf0bcda32b57b277d9ad9f146e\n\nSee https://docs.python.org/3/library/hashlib.html for details.", "author": "Lambeaux", "createdAt": "2020-09-25T00:30:28Z", "path": "libs/checksum/src/test/java/org/codice/ddf/checksum/Sha256ChecksumProviderTest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.checksum;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.Is.is;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.ObjectOutputStream;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Arrays;\n+import org.codice.ddf.checksum.impl.Sha256ChecksumProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class Sha256ChecksumProviderTest {\n+\n+  private ChecksumProvider checksumProvider;\n+\n+  @Before\n+  public void intialize() {\n+    checksumProvider = new Sha256ChecksumProvider();\n+  }\n+\n+  @Test\n+  public void testCalculateChecksumString() throws IOException, NoSuchAlgorithmException {\n+    String testString = \"Hello World\";\n+    String checksumCompareHash = \"cade3dbf41da60f7154ef628446ff163700b6a9860cd951de8e4321b2189de6d\";", "originalCommit": "68aa4b21ec9c81b3119adb8418e758c79631cd64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NDAxMA==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r495044010", "bodyText": "the tests are using an object stream for simplicity, so it's not a 1:1 encoding of the string 'Hello World'", "author": "bdeining", "createdAt": "2020-09-25T14:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4MTk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NDc1MQ==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r495044751", "bodyText": "and the consumer uses it similarly https://github.com/codice/ddf/blob/master/catalog/plugin/catalog-plugin-checksum/src/main/java/org/codice/ddf/catalog/content/plugin/checksum/Checksum.java#L72", "author": "bdeining", "createdAt": "2020-09-25T14:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4MTk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI3NDk3OQ==", "url": "https://github.com/codice/ddf/pull/6346#discussion_r495274979", "bodyText": "I agree that we should have tests with object streams since that's how it's used in prod. But having the testString right next to the checksumCompareHash is misleading since we're not doing a 1:1 mapping there but instead are using an object stream.\n( \u2753 ) For all the tests, can we in-line the hash within the assertThat statement?\nI think that would help without redundant tests or comments.", "author": "Lambeaux", "createdAt": "2020-09-25T22:14:38Z", "path": "libs/checksum/src/test/java/org/codice/ddf/checksum/Sha256ChecksumProviderTest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.checksum;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.Is.is;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.ObjectOutputStream;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Arrays;\n+import org.codice.ddf.checksum.impl.Sha256ChecksumProvider;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class Sha256ChecksumProviderTest {\n+\n+  private ChecksumProvider checksumProvider;\n+\n+  @Before\n+  public void intialize() {\n+    checksumProvider = new Sha256ChecksumProvider();\n+  }\n+\n+  @Test\n+  public void testCalculateChecksumString() throws IOException, NoSuchAlgorithmException {\n+    String testString = \"Hello World\";\n+    String checksumCompareHash = \"cade3dbf41da60f7154ef628446ff163700b6a9860cd951de8e4321b2189de6d\";", "originalCommit": "cbd4b20835a18478d78eca5c60113ba3a2f35365", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5aae9f96aaf5079408d79f6e5848b280da4c88dc", "url": "https://github.com/codice/ddf/commit/5aae9f96aaf5079408d79f6e5848b280da4c88dc", "message": "DDF-6156 G-8624 SHA 256 Checksum", "committedDate": "2020-09-30T19:58:49Z", "type": "commit"}, {"oid": "5aae9f96aaf5079408d79f6e5848b280da4c88dc", "url": "https://github.com/codice/ddf/commit/5aae9f96aaf5079408d79f6e5848b280da4c88dc", "message": "DDF-6156 G-8624 SHA 256 Checksum", "committedDate": "2020-09-30T19:58:49Z", "type": "forcePushed"}, {"oid": "4d0063587bfb9a7730a81472360e02f2b8dfcf8a", "url": "https://github.com/codice/ddf/commit/4d0063587bfb9a7730a81472360e02f2b8dfcf8a", "message": "DDF-6156 Formatting and test cleanup", "committedDate": "2020-10-05T19:53:12Z", "type": "commit"}, {"oid": "4f5664a8d58573774817acea47cb060533b68195", "url": "https://github.com/codice/ddf/commit/4f5664a8d58573774817acea47cb060533b68195", "message": "Formatting", "committedDate": "2020-10-05T20:38:23Z", "type": "commit"}]}