{"pr_number": 5745, "pr_title": "DDF-5741 adding export and import command for PersistentStore", "pr_createdAt": "2020-01-07T23:02:48Z", "pr_url": "https://github.com/codice/ddf/pull/5745", "timeline": [{"oid": "0ec5d314182c160bae4d55ca05164a34bdbc7b14", "url": "https://github.com/codice/ddf/commit/0ec5d314182c160bae4d55ca05164a34bdbc7b14", "message": "DDF-5741 adding export and import command", "committedDate": "2020-01-07T23:21:42Z", "type": "forcePushed"}, {"oid": "6c972578ae8f5217e62fcb34f5e98b86f1bf242b", "url": "https://github.com/codice/ddf/commit/6c972578ae8f5217e62fcb34f5e98b86f1bf242b", "message": "DDF-5741 fix test error", "committedDate": "2020-01-21T18:06:09Z", "type": "forcePushed"}, {"oid": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "url": "https://github.com/codice/ddf/commit/cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "message": "DDF-5741 fix test error", "committedDate": "2020-04-20T19:24:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5MjY3Ng==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r413992676", "bodyText": "\u2753 Shouldn't the CQL be returned here if there is no user?", "author": "pklinef", "createdAt": "2020-04-23T17:37:06Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {\n+    if (StringUtils.isBlank(user)) return \"\";", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5NzY0Nw==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r413997647", "bodyText": "\u2757 This seems dangerous to try and load all persistence items into memory.  I think this could cause OOM if there are millions of persistence items being exported.  The dump command iterates through all records but writes them out and does not accumulate the results into memory.\n\n  \n    \n      ddf/catalog/core/catalog-core-commands/src/main/java/org/codice/ddf/commands/catalog/DumpCommand.java\n    \n    \n         Line 99\n      in\n      fc2fa5f\n    \n    \n    \n    \n\n        \n          \n           public class DumpCommand extends CqlCommands {", "author": "pklinef", "createdAt": "2020-04-23T17:44:36Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {\n+    if (StringUtils.isBlank(user)) return \"\";\n+    if (StringUtils.isNotBlank(cql)) {\n+      cql = \"( \" + cql + \") AND user='\" + user + \"'\";\n+    } else {\n+      cql = \"user='\" + user + \"'\";\n+    }\n+    return cql;\n+  }\n+\n+  protected List<Map<String, Object>> getResults() throws PersistenceException {\n+\n+    List<Map<String, Object>> results = new ArrayList<>();\n+    List<Map<String, Object>> pagedResults;\n+    int startIndex = 0;\n+    int pageSize = 1000;\n+\n+    do {\n+      pagedResults = persistentStore.get(type, cql, startIndex, pageSize);\n+      results.addAll(pagedResults);", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNDE4NA==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414004184", "bodyText": "\u270f\ufe0f It would be nice to print out the progress bar.\n\n  \n    \n      ddf/catalog/core/catalog-core-commands/src/main/java/org/codice/ddf/commands/catalog/CommandSupport.java\n    \n    \n         Line 68\n      in\n      fc2fa5f\n    \n    \n    \n    \n\n        \n          \n           protected void printProgressAndFlush(long start, long totalCount, long currentCount) {", "author": "pklinef", "createdAt": "2020-04-23T17:54:05Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/StoreExportCommand.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.persistence.commands;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.commons.codec.digest.DigestUtils;\n+import org.apache.commons.io.FilenameUtils;\n+import org.apache.karaf.shell.api.action.Argument;\n+import org.apache.karaf.shell.api.action.Command;\n+import org.apache.karaf.shell.api.action.Option;\n+import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.codice.ddf.persistence.PersistenceException;\n+import org.codice.ddf.persistence.PersistentItem;\n+\n+@Service\n+@Command(\n+  scope = \"store\",\n+  name = \"export\",\n+  description = \"Export entries that are available in the persistent store.\"\n+)\n+public class StoreExportCommand extends AbstractStoreCommand {\n+\n+  @Option(\n+    name = \"User ID\",\n+    aliases = {\"-u\", \"--user\"},\n+    required = false,\n+    description =\n+        \"User ID to search for notifications. If an id is not provided, then all of the notifications for all users are displayed.\",\n+    multiValued = false\n+  )\n+  private String user;\n+\n+  @Argument(\n+    name = \"Dump directory path\",\n+    description =\n+        \"Directory to export into. Paths are absolute and must be in quotes.  Files in directory will be overwritten if they already exist.\",\n+    index = 0,\n+    multiValued = false,\n+    required = true\n+  )\n+  private String dirPath = null;\n+\n+  private final Gson gson =\n+      new GsonBuilder().setDateFormat(\"EEE, dd MMM yyyy HH:mm:ss zzz\").create();\n+\n+  @Override\n+  public void storeCommand() throws PersistenceException {\n+\n+    if (FilenameUtils.getExtension(dirPath).equals(\"\") && !dirPath.endsWith(File.separator)) {\n+      dirPath += File.separator;\n+    }\n+    final File dumpDir = new File(dirPath);\n+\n+    if (!dumpDir.exists()) {\n+      console.println(\n+          \"Directory does not exist. If the directory does indeed exist, try putting the path in quotes.\");\n+      return;\n+    }\n+\n+    if (!dumpDir.isDirectory()) {\n+      console.println(\"Specified path is not a directory.\");\n+      return;\n+    }\n+\n+    cql = createCql(user, cql);\n+    List<Map<String, Object>> storeResults = getResults();\n+    console.println(\"Results found: \" + storeResults.size() + \"\\n\");\n+\n+    int count =\n+        storeResults\n+            .stream()\n+            .map(PersistentItem.class::cast)\n+            .map(\n+                persistentItem -> {\n+                  persistentItem.encodeBinaryProperties();\n+                  return persistentItem;\n+                })\n+            .map(gson::toJson)\n+            .map(json -> writeRecordToFile(json, dumpDir))", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEzNzAxOQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r428137019", "bodyText": "since Export now does paging, it won't know the totalcount to keep progress.", "author": "lamhuy", "createdAt": "2020-05-20T16:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNDE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3OTk2OA==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r428379968", "bodyText": "I see.  I forgot PersistentStore does not have a way to get the total count. I am surprised that has not been an issues all this time.", "author": "pklinef", "createdAt": "2020-05-21T00:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNDE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxNzAyNw==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414017027", "bodyText": "\u2757 I have two concerns with this method.\nThe first is that it is unsafe since it could be called multiple times and I think would fail after the first call.  It would also be confusing because the key would still have the binary suffix but would now have a string value.\nMy second concern is that this is not really a concern of this class.  There are many different ways to encode binary data.  I think this should be moved to to the store commands which have a concern on how to serialize the data.  Base64 decoding is already done in the store import command.  The store export command should do Base64 encoding to keep the command format symmetry in one package.  Another option is to create a GSON converter like this gist example to use in the commands.\nhttps://gist.github.com/orip/3635246\nIf you do that, it might be useful to add to our GSON type adapters.\nhttps://github.com/codice/ddf/blob/master/libs/gson-support/src/main/java/org/codice/gsonsupport/GsonTypeAdapters.java#L38", "author": "pklinef", "createdAt": "2020-04-23T18:13:22Z", "path": "platform/persistence/platform-persistence-core-api/src/main/java/org/codice/ddf/persistence/PersistentItem.java", "diffHunk": "@@ -142,6 +145,18 @@ public Date getDateProperty(String name) {\n     return (Date) getProperty(name + DATE_SUFFIX);\n   }\n \n+  public void encodeBinaryProperties() {", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMzM2MQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414023361", "bodyText": "\u2757 We might have a problem with this call on SolrCloud since it looks like we do not sort to guarantee consistent ordering between shards.\nhttps://github.com/codice/ddf/blob/master/platform/persistence/platform-persistence-core-impl/src/main/java/org/codice/ddf/persistence/internal/PersistentStoreImpl.java#L191-L194\nWe have to sort by ID to avoid this issue with the catalog dump command\n\n  \n    \n      ddf/catalog/core/catalog-core-commands/src/main/java/org/codice/ddf/commands/catalog/DumpCommand.java\n    \n    \n         Line 253\n      in\n      fc2fa5f\n    \n    \n    \n    \n\n        \n          \n           SortBy sort = new SortByImpl(Core.ID, SortOrder.ASCENDING);", "author": "pklinef", "createdAt": "2020-04-23T18:23:06Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {\n+    if (StringUtils.isBlank(user)) return \"\";\n+    if (StringUtils.isNotBlank(cql)) {\n+      cql = \"( \" + cql + \") AND user='\" + user + \"'\";\n+    } else {\n+      cql = \"user='\" + user + \"'\";\n+    }\n+    return cql;\n+  }\n+\n+  protected List<Map<String, Object>> getResults() throws PersistenceException {\n+\n+    List<Map<String, Object>> results = new ArrayList<>();\n+    List<Map<String, Object>> pagedResults;\n+    int startIndex = 0;\n+    int pageSize = 1000;\n+\n+    do {\n+      pagedResults = persistentStore.get(type, cql, startIndex, pageSize);", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MDgyNQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r431190825", "bodyText": "add default ID sorting on PersistentStore https://github.com/codice/ddf/pull/5745/files#diff-0927a922dc7dab1b936e3721db97721aR193", "author": "lamhuy", "createdAt": "2020-05-27T14:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMzM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzk5OTkxNw==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r413999917", "bodyText": "If you go the stream route we can remove this variable", "author": "mojogitoverhere", "createdAt": "2020-04-23T17:47:52Z", "path": "catalog/core/catalog-core-commands/src/main/java/org/codice/ddf/commands/catalog/IngestCommand.java", "diffHunk": "@@ -441,12 +442,11 @@ private int totalFileCount(File inputFile) throws IOException {\n     if (inputFile.isDirectory()) {\n       int currentFileCount = 0;", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNDA0NQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414004045", "bodyText": "\u2753 Does this pass the format check? I thought we had a rule preventing this inline style", "author": "mojogitoverhere", "createdAt": "2020-04-23T17:53:53Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {\n+    if (StringUtils.isBlank(user)) return \"\";", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzUyMg==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414007522", "bodyText": "\u270f\ufe0f I know this was moved from a different class, but I think the descriptiveness of the name can be improved. What do you think about something like addUserConstraintToCql?", "author": "mojogitoverhere", "createdAt": "2020-04-23T17:59:01Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTQyNg==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414009426", "bodyText": "\u2757 How many items do we expect to be in the persistent store? Is there a risk of running out of memory?", "author": "mojogitoverhere", "createdAt": "2020-04-23T18:01:40Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/AbstractStoreCommand.java", "diffHunk": "@@ -81,4 +85,30 @@ public Object execute() {\n \n   /** Calls a command that operates on the Persistent Store service. */\n   abstract void storeCommand() throws PersistenceException;\n+\n+  protected String createCql(String user, String cql) {\n+    if (StringUtils.isBlank(user)) return \"\";\n+    if (StringUtils.isNotBlank(cql)) {\n+      cql = \"( \" + cql + \") AND user='\" + user + \"'\";\n+    } else {\n+      cql = \"user='\" + user + \"'\";\n+    }\n+    return cql;\n+  }\n+\n+  protected List<Map<String, Object>> getResults() throws PersistenceException {\n+\n+    List<Map<String, Object>> results = new ArrayList<>();\n+    List<Map<String, Object>> pagedResults;\n+    int startIndex = 0;\n+    int pageSize = 1000;\n+\n+    do {\n+      pagedResults = persistentStore.get(type, cql, startIndex, pageSize);\n+      results.addAll(pagedResults);\n+      startIndex += pageSize;\n+    } while (pagedResults.size() > 0);", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MjY4OA==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r431192688", "bodyText": "updated to export per batch", "author": "lamhuy", "createdAt": "2020-05-27T14:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwOTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAxMzU0NQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414013545", "bodyText": "\u2757 The persistent store is used for other things besides notifications, like user preferences", "author": "mojogitoverhere", "createdAt": "2020-04-23T18:07:56Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/StoreExportCommand.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.persistence.commands;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.commons.codec.digest.DigestUtils;\n+import org.apache.commons.io.FilenameUtils;\n+import org.apache.karaf.shell.api.action.Argument;\n+import org.apache.karaf.shell.api.action.Command;\n+import org.apache.karaf.shell.api.action.Option;\n+import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.codice.ddf.persistence.PersistenceException;\n+import org.codice.ddf.persistence.PersistentItem;\n+\n+@Service\n+@Command(\n+  scope = \"store\",\n+  name = \"export\",\n+  description = \"Export entries that are available in the persistent store.\"\n+)\n+public class StoreExportCommand extends AbstractStoreCommand {\n+\n+  @Option(\n+    name = \"User ID\",\n+    aliases = {\"-u\", \"--user\"},\n+    required = false,\n+    description =\n+        \"User ID to search for notifications. If an id is not provided, then all of the notifications for all users are displayed.\",", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAyMzIyMg==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r414023222", "bodyText": "\u270f\ufe0f Might be nice to expose this date format (package private) in StoreExportCommand and import it here so they don't get out of sync", "author": "mojogitoverhere", "createdAt": "2020-04-23T18:22:54Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/StoreImportCommand.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.persistence.commands;\n+\n+import static org.codice.ddf.persistence.PersistentItem.BINARY_SUFFIX;\n+import static org.codice.ddf.persistence.PersistentItem.DATE_SUFFIX;\n+import static org.codice.ddf.persistence.PersistentItem.INT_SUFFIX;\n+import static org.codice.ddf.persistence.PersistentItem.LONG_SUFFIX;\n+import static org.codice.ddf.persistence.PersistentItem.SUFFIXES;\n+import static org.codice.ddf.persistence.PersistentItem.TEXT_SUFFIX;\n+import static org.codice.ddf.persistence.PersistentItem.XML_SUFFIX;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonIOException;\n+import com.google.gson.JsonSyntaxException;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.FileVisitOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import org.apache.commons.lang.StringUtils;\n+import org.apache.karaf.shell.api.action.Argument;\n+import org.apache.karaf.shell.api.action.Command;\n+import org.apache.karaf.shell.api.action.Completion;\n+import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.apache.karaf.shell.support.completers.FileCompleter;\n+import org.codice.ddf.persistence.PersistenceException;\n+\n+@Service\n+@Command(\n+  scope = \"store\",\n+  name = \"import\",\n+  description = \"Import entries into the persistent store.\"\n+)\n+public class StoreImportCommand extends AbstractStoreCommand {\n+\n+  @Argument(\n+    name = \"File path or Directory path\",\n+    description =\n+        \"Path to a file or a directory of file(s) to be ingested. Paths can be absolute or relative to installation directory.\",\n+    index = 0,\n+    multiValued = false,\n+    required = true\n+  )\n+  @Completion(FileCompleter.class)\n+  String filePath;\n+\n+  private final Gson gson = new Gson();\n+  private final SimpleDateFormat formatter = new SimpleDateFormat(\"EEE, dd MMM yyyy HH:mm:ss zzz\");", "originalCommit": "cf035b97a31c8e6b6e1a01ba09ee17553cad059f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f62e430daea87c8ae4117ae44533f3135da486c", "url": "https://github.com/codice/ddf/commit/3f62e430daea87c8ae4117ae44533f3135da486c", "message": "DDF-5924 remove persistence type enforcement (#5938)\n\nDDF-5741 update logic add test", "committedDate": "2020-05-20T16:15:43Z", "type": "forcePushed"}, {"oid": "c97cbad54fb3e186f4f202033b14ea9f8131ce91", "url": "https://github.com/codice/ddf/commit/c97cbad54fb3e186f4f202033b14ea9f8131ce91", "message": "DDF-5741 clean up", "committedDate": "2020-05-29T14:32:35Z", "type": "forcePushed"}, {"oid": "b9e67f770e05d5c9e6fabd180a72b0825cf693d2", "url": "https://github.com/codice/ddf/commit/b9e67f770e05d5c9e6fabd180a72b0825cf693d2", "message": "DDF-5741 adding export and import command", "committedDate": "2020-06-01T22:08:41Z", "type": "commit"}, {"oid": "8283bb7410f166df688d5caed32ab491d502c30a", "url": "https://github.com/codice/ddf/commit/8283bb7410f166df688d5caed32ab491d502c30a", "message": "DDF-5924 remove persistence type enforcement (#5938)\n\nDDF-5741 update logic add test", "committedDate": "2020-06-01T22:08:41Z", "type": "commit"}, {"oid": "9b3a98c8300d6b64cb5bae61f2b02693c64431bd", "url": "https://github.com/codice/ddf/commit/9b3a98c8300d6b64cb5bae61f2b02693c64431bd", "message": "DDF-5741 using custom gson type adapter", "committedDate": "2020-06-02T00:18:37Z", "type": "commit"}, {"oid": "9b3a98c8300d6b64cb5bae61f2b02693c64431bd", "url": "https://github.com/codice/ddf/commit/9b3a98c8300d6b64cb5bae61f2b02693c64431bd", "message": "DDF-5741 using custom gson type adapter", "committedDate": "2020-06-02T00:18:37Z", "type": "forcePushed"}, {"oid": "93ee3eb8b28d928c88a83cc75fb394303485cbc4", "url": "https://github.com/codice/ddf/commit/93ee3eb8b28d928c88a83cc75fb394303485cbc4", "message": "DDF-5741 fix unit test", "committedDate": "2020-06-02T15:00:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MDMxNA==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r434880314", "bodyText": "\u270f\ufe0f I think this could cause OOM is too many files are stored at once.  We could do the files in batches to avoid one map getting too large.", "author": "pklinef", "createdAt": "2020-06-03T21:56:23Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/StoreImportCommand.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.persistence.commands;\n+\n+import static org.codice.gsonsupport.GsonTypeAdapters.MAP_STRING_TO_OBJECT_TYPE;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonIOException;\n+import com.google.gson.JsonSyntaxException;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.io.UncheckedIOException;\n+import java.nio.file.FileVisitOption;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import org.apache.karaf.shell.api.action.Argument;\n+import org.apache.karaf.shell.api.action.Command;\n+import org.apache.karaf.shell.api.action.Completion;\n+import org.apache.karaf.shell.api.action.lifecycle.Service;\n+import org.apache.karaf.shell.support.completers.FileCompleter;\n+import org.codice.ddf.persistence.PersistenceException;\n+import org.codice.gsonsupport.GsonTypeAdapters.PersistenceMapTypeAdapter;\n+\n+@Service\n+@Command(\n+  scope = \"store\",\n+  name = \"import\",\n+  description = \"Import entries into the persistent store.\"\n+)\n+public class StoreImportCommand extends AbstractStoreCommand {\n+\n+  @Argument(\n+    name = \"File path or Directory path\",\n+    description =\n+        \"Path to a file or a directory of file(s) to be ingested. Paths can be absolute or relative to installation directory.\",\n+    index = 0,\n+    multiValued = false,\n+    required = true\n+  )\n+  @Completion(FileCompleter.class)\n+  String filePath;\n+\n+  private final Gson gson =\n+      new GsonBuilder().registerTypeAdapterFactory(PersistenceMapTypeAdapter.FACTORY).create();\n+\n+  @Override\n+  public void storeCommand() throws PersistenceException {\n+\n+    final File inputFile = getInputFile();\n+    if (inputFile == null) {\n+      return;\n+    }\n+    int totalFiles = 0;\n+\n+    try {\n+      totalFiles = totalFileCount(inputFile);\n+    } catch (IOException e) {\n+      console.println(\"Unable to read directory\");\n+    }\n+\n+    List<Map<String, Object>> importResults = new ArrayList<>();\n+\n+    console.println(\"Found \" + totalFiles + \" files to import\\n\");\n+\n+    try (Stream<Path> ingestStream = Files.walk(inputFile.toPath(), FileVisitOption.FOLLOW_LINKS)) {\n+      ingestStream\n+          .filter(Files::isRegularFile)\n+          .map(Path::toFile)\n+          .map(this::processFile)\n+          .filter(Objects::nonNull)\n+          .forEach(importResults::add);", "originalCommit": "93ee3eb8b28d928c88a83cc75fb394303485cbc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDE0NQ==", "url": "https://github.com/codice/ddf/pull/5745#discussion_r434884145", "bodyText": "\u2753 Couldn't this command print +100k lines if there were a lot of items or large items in the persistent store?\nShould we have a default limit of lines to print like 10 but a command option could increase it?", "author": "pklinef", "createdAt": "2020-06-03T22:05:53Z", "path": "platform/persistence/platform-persistence-commands/src/main/java/org/codice/ddf/persistence/commands/StoreListCommand.java", "diffHunk": "@@ -40,49 +40,40 @@\n         \"User ID to search for notifications. If an id is not provided, then all of the notifications for all users are displayed.\",\n     multiValued = false\n   )\n-  private String user;\n+  String user;\n \n-  private Set<String> headerSet = new TreeSet<String>();\n+  private Set<String> headerSet = new TreeSet<>();\n \n   @Override\n   public void storeCommand() throws PersistenceException {\n \n-    List<Map<String, Object>> storeResults;\n+    cql = addUserConstraintToCql(user, cql);\n \n-    cql = createCql(user, cql);\n+    // output the entries\n+    // populates the header with the keys from the first entry\n+    Function<List<Map<String, Object>>, Integer> listFunction =\n+        results -> {\n+          int count = 0;\n+          for (int i = 0; i < results.size(); i++) {\n+            Map<String, Object> curStore = PersistentItem.stripSuffixes(results.get(i));\n+            console.println(\"Result {\" + i + \"}:\");\n+            if (headerSet.isEmpty()) {\n+              // populates the header with the keys from the first entry\n+              headerSet.addAll(curStore.keySet());\n+            }\n \n-    if (StringUtils.isNotBlank(cql)) {\n-      storeResults = persistentStore.get(type, cql);\n-    } else {\n-      storeResults = persistentStore.get(type);\n-    }\n-    console.println(\"Results found: \" + storeResults.size() + \"\\n\");\n+            for (String curKey : headerSet) {\n+              console.println(curKey + \":\");\n+              console.println(\"\\t\" + curStore.get(curKey).toString());\n+              count++;\n+            }\n+          }\n+          return count;\n+        };\n \n-    // output the entries\n-    for (int i = 0; i < storeResults.size(); i++) {\n-      Map<String, Object> curStore = PersistentItem.stripSuffixes(storeResults.get(i));\n-      console.println(\"Result {\" + i + \"}:\");\n-      if (headerSet.isEmpty()) {\n-        // populates the header with the keys from the first entry\n-        headerSet.addAll(curStore.keySet());\n-      }\n+    long totalCount = getResults(listFunction);", "originalCommit": "93ee3eb8b28d928c88a83cc75fb394303485cbc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "50e5b3561a48bdbb7836201dc14e9acba2db8584", "url": "https://github.com/codice/ddf/commit/50e5b3561a48bdbb7836201dc14e9acba2db8584", "message": "DDF-5741 address comment", "committedDate": "2020-06-05T20:39:46Z", "type": "commit"}]}