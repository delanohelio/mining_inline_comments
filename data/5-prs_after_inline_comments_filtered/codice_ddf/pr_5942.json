{"pr_number": 5942, "pr_title": "[2.21.x] DDF-5360 Adds the ability to go through OAuth to download a resource", "pr_createdAt": "2020-03-25T21:36:54Z", "pr_url": "https://github.com/codice/ddf/pull/5942", "timeline": [{"oid": "d52fe4aaa89979af8a8e61c42ae0797d71630bd5", "url": "https://github.com/codice/ddf/commit/d52fe4aaa89979af8a8e61c42ae0797d71630bd5", "message": "DDF-5360 Changed user ID based OAuth token storage to session ID to better handle the guest user.", "committedDate": "2020-03-26T21:31:20Z", "type": "forcePushed"}, {"oid": "de2abd3fd3a3cc6835976c98e785726e5b8ec3ae", "url": "https://github.com/codice/ddf/commit/de2abd3fd3a3cc6835976c98e785726e5b8ec3ae", "message": "DDF-5360 Changed user ID based OAuth token storage to session ID to better handle the guest user.", "committedDate": "2020-03-27T18:10:20Z", "type": "forcePushed"}, {"oid": "d6e18a004891f8e7eeb4031098e4b2d1a71cd1dc", "url": "https://github.com/codice/ddf/commit/d6e18a004891f8e7eeb4031098e4b2d1a71cd1dc", "message": "DDF-5360 Adds the ability to go through OAuth to download a resource", "committedDate": "2020-03-28T00:10:52Z", "type": "forcePushed"}, {"oid": "ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "url": "https://github.com/codice/ddf/commit/ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "message": "Adding session ID to subject", "committedDate": "2020-03-30T19:49:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyNjc3NQ==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r400526775", "bodyText": "\u270f\ufe0f I feel like I've mentioned this before, sorry if I did, but would \"The user Subject is not available.\"  make more sense here?", "author": "bakejeyner", "createdAt": "2020-03-30T22:14:46Z", "path": "catalog/plugin/catalog-plugin-oauth/src/main/java/org/codice/ddf/catalog/plugin/oauth/OAuthPlugin.java", "diffHunk": "@@ -140,17 +141,22 @@ public QueryRequest process(Source source, QueryRequest input) throws StopProces\n \n     Object securityAssertion = input.getProperties().get(SECURITY_SUBJECT);\n     if (!(securityAssertion instanceof Subject)) {\n-      LOGGER.warn(\"A user Subject is not available.\");\n-      throw new StopProcessingException(\"A user Subject is not available.\");\n+      LOGGER.warn(\"The user's subject is not available.\");", "originalCommit": "ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0MTk1MA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r400541950", "bodyText": "\u270f\ufe0f getSystemWebClient() may read better", "author": "bakejeyner", "createdAt": "2020-03-30T22:51:47Z", "path": "platform/security/rest/security-rest-clientapi/src/main/java/org/codice/ddf/cxf/client/SecureCxfClientFactory.java", "diffHunk": "@@ -42,6 +42,13 @@\n    */\n   WebClient getWebClient();\n \n+  /**\n+   * Returns the WebClient\n+   *\n+   * @return\n+   */\n+  WebClient getWebSystemClient();", "originalCommit": "ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de3139923ac9786fb9bb15bcd301fd405f7fe78d", "url": "https://github.com/codice/ddf/commit/de3139923ac9786fb9bb15bcd301fd405f7fe78d", "message": "Adding session ID to subject", "committedDate": "2020-03-30T23:55:40Z", "type": "forcePushed"}, {"oid": "7b50bdbc20a6cc4f7a5fbcdfb82f3e0e2992c4f1", "url": "https://github.com/codice/ddf/commit/7b50bdbc20a6cc4f7a5fbcdfb82f3e0e2992c4f1", "message": "Adding session ID to subject", "committedDate": "2020-03-31T01:08:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MDE5NA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r400560194", "bodyText": "\u270f\ufe0f This seems redundant, given we're already passing the baseUrl and parameters", "author": "SmithJosh", "createdAt": "2020-03-30T23:45:30Z", "path": "catalog/plugin/catalog-plugin-oauth/src/main/java/org/codice/ddf/catalog/plugin/oauth/OAuthPlugin.java", "diffHunk": "@@ -300,26 +314,22 @@ private void findExistingTokens(\n         return;\n       }\n \n-      refreshTokens(tokenEntry.getRefreshToken(), oauthSource, userId, metadata);\n+      refreshTokens(tokenEntry.getRefreshToken(), oauthSource, sessionId, metadata);\n     }\n \n     LOGGER.debug(\n         \"Unable to process query. The user needs to authorize to query the {} source.\",\n         oauthSource.getId());\n \n-    try {\n-      URIBuilder uriBuilder = new URIBuilder(AUTHORIZE_SOURCE_ENDPOINT);\n-      uriBuilder.addParameter(USER_ID, userId);\n-      uriBuilder.addParameter(SOURCE_ID, oauthSource.getId());\n-      uriBuilder.addParameter(DISCOVERY_URL, oauthSource.getOauthDiscoveryUrl());\n-\n-      String url = uriBuilder.build().toURL().toString();\n-      throw new OAuthPluginException(oauthSource.getId(), url, AUTH_SOURCE);\n-\n-    } catch (URISyntaxException | MalformedURLException e) {\n-      LOGGER.warn(\"Unable to construct authorization URL.\");\n-      throw new StopProcessingException(\"Unable to construct authorization URL. \" + e.getMessage());\n-    }\n+    Map<String, String> parameters = new HashMap<>();\n+    parameters.put(SOURCE_ID, oauthSource.getId());\n+    parameters.put(DISCOVERY_URL, oauthSource.getOauthDiscoveryUrl());\n+    throw new OAuthPluginException(\n+        oauthSource.getId(),\n+        buildUrl(AUTHORIZE_SOURCE_ENDPOINT, parameters),", "originalCommit": "ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MzMyMg==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r400563322", "bodyText": "\u270f\ufe0f Same comment as before - this is redundant. Imo makes more sense to move the constructUrl inside OAuthException", "author": "SmithJosh", "createdAt": "2020-03-30T23:55:50Z", "path": "catalog/rest/catalog-rest-service/src/main/java/org/codice/ddf/rest/service/AbstractCatalogService.java", "diffHunk": "@@ -366,6 +374,15 @@ public BinaryContent getDocument(\n         String errorMessage = \"Unable to process request. Data usage limit exceeded: \";\n         LOGGER.debug(errorMessage, e);\n         throw new DataUsageLimitExceededException(errorMessage);\n+      } catch (OAuthPluginException e) {\n+        Map<String, String> parameters = e.getParameters();\n+        String url = constructUrl(httpRequest, e.getBaseUrl(), parameters);", "originalCommit": "ebe5ff8b95af2b83fbcaa2f17ea29e1032f5c679", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3MDk3OA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r400570978", "bodyText": "\u270f\ufe0f It's gone now, but your previous code change with overriding the getters gave me an idea. You could do something like:\n  public SessionToken(PrincipalCollection principals, String id, String ip) {\n    super(principals, id, ip);\n  }\n\n  public PrincipalCollection getPrincipalCollection() {\n    return (PrincipalCollection) this.principal;\n  }\n\n  public String getId() {\n    return (String) this.credentials;\n  }\n\nSo that it's clearer what SessionToken actually requires.", "author": "SmithJosh", "createdAt": "2020-03-31T00:20:59Z", "path": "platform/security/handler/security-handler-api/src/main/java/org/codice/ddf/security/handler/api/SessionToken.java", "diffHunk": "@@ -15,10 +15,6 @@\n \n public class SessionToken extends BaseAuthenticationToken {\n \n-  public SessionToken(Object credentials) {", "originalCommit": "de3139923ac9786fb9bb15bcd301fd405f7fe78d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MzM2Mw==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401873363", "bodyText": "This is a good idea. I'll make the change", "author": "blen-desta", "createdAt": "2020-04-01T19:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3MDk3OA=="}], "type": "inlineReview"}, {"oid": "71000aa13971fdad02abacf8aa2a22beac94fdb8", "url": "https://github.com/codice/ddf/commit/71000aa13971fdad02abacf8aa2a22beac94fdb8", "message": "Adding session ID to subject", "committedDate": "2020-03-31T15:54:29Z", "type": "forcePushed"}, {"oid": "076b00487a8afde633b919badf976af08ec161c8", "url": "https://github.com/codice/ddf/commit/076b00487a8afde633b919badf976af08ec161c8", "message": "DDF-5360 Added support for the OAuth Resource Owner Password Credentials Grant", "committedDate": "2020-04-01T18:06:47Z", "type": "commit"}, {"oid": "34902ce978352258dde0685b73e10aae3feca223", "url": "https://github.com/codice/ddf/commit/34902ce978352258dde0685b73e10aae3feca223", "message": "DDF-5360 Adds the ability to go through OAuth to download a resource", "committedDate": "2020-04-01T18:25:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NDQzOQ==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401864439", "bodyText": "\u2753 Aren't these args backwards?", "author": "stustison", "createdAt": "2020-04-01T19:42:32Z", "path": "platform/security/idp/security-idp-client/src/main/java/org/codice/ddf/security/idp/client/LogoutRequestService.java", "diffHunk": "@@ -271,7 +271,7 @@ private String extractSubject(Map<String, Object> sessionAttributes) {\n         .map(SecurityTokenHolder::getPrincipals)\n         .filter(Objects::nonNull)\n         .map(PrincipalCollection.class::cast)\n-        .map(SessionToken::new)\n+        .map(principalCollection -> new SessionToken(principalCollection, null, \"127.0.0.1\"))", "originalCommit": "7c217528c77e4a823fa65e6cd5f3d6bcc1509da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MDMyMA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401870320", "bodyText": "Yes I just fixed them", "author": "blen-desta", "createdAt": "2020-04-01T19:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NDQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NTQzOA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401865438", "bodyText": "We probably need to make a builder for this thing.", "author": "stustison", "createdAt": "2020-04-01T19:44:10Z", "path": "platform/security/rest/security-rest-cxfwrapper/src/main/java/org/codice/ddf/cxf/client/impl/SecureCxfClientFactoryImpl.java", "diffHunk": "@@ -399,6 +403,69 @@ public SecureCxfClientFactoryImpl(\n     this.oauthSecurity = oauthSecurity;\n   }\n \n+  /**\n+   * Constructs a factory that will return security-aware cxf clients. Once constructed, use the\n+   * getClient* methods to retrieve a fresh client with the same configuration. Providing {@link\n+   * WebClient} to interfaceClass will create a generic web client.\n+   *\n+   * <p>This factory can and should be cached. The clients it constructs should not be.\n+   *\n+   * @param endpointUrl the remote url to connect to\n+   * @param interfaceClass an interface representing the resource at the remote url\n+   * @param providers optional list of providers to further configure the client\n+   * @param interceptor optional message interceptor for the client\n+   * @param disableCnCheck disable ssl check for common name / host name match\n+   * @param allowRedirects allow this client to follow redirects\n+   * @param connectionTimeout timeout for the connection\n+   * @param receiveTimeout timeout for receiving responses\n+   * @param sourceId the id of the source\n+   * @param discoveryUrl the oauth provider's discovery url\n+   * @param clientId the client id registered with the oauth provider\n+   * @param clientSecret the client secret registered with the oauth provider\n+   * @param username the oauth flow to use\n+   * @param password the oauth flow to use\n+   * @param additionalOauthParameters the oauth flow to use\n+   * @param oauthSecurity class used to set oauth tokens on clients\n+   */\n+  @SuppressWarnings(\"squid:S00107\")", "originalCommit": "7c217528c77e4a823fa65e6cd5f3d6bcc1509da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MDc3MA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401870770", "bodyText": "Agreed it's getting too big. I believe there was another PR on master to add one more constructor.", "author": "blen-desta", "createdAt": "2020-04-01T19:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NTQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NzkwNw==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401867907", "bodyText": "\u2753 Isn't this backwards from what is in WebSSOFilter?", "author": "stustison", "createdAt": "2020-04-01T19:48:36Z", "path": "platform/security/servlet/security-servlet-logout/src/main/java/org/codice/ddf/security/servlet/logout/LogoutServiceImpl.java", "diffHunk": "@@ -57,7 +57,7 @@ public String getActionProviders(HttpServletRequest request, HttpServletResponse\n     Object token =\n         ((SecurityTokenHolder) session.getAttribute(SecurityConstants.SECURITY_TOKEN_KEY))\n             .getPrincipals();\n-    SessionToken sessionToken = new SessionToken(token);\n+    SessionToken sessionToken = new SessionToken(token, session.getId(), \"127.0.0.1\");", "originalCommit": "7c217528c77e4a823fa65e6cd5f3d6bcc1509da4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MTQ3NQ==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401871475", "bodyText": "Yes I missed this one \ud83e\udd26\u200d\u2640", "author": "blen-desta", "createdAt": "2020-04-01T19:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NzkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MzIxOA==", "url": "https://github.com/codice/ddf/pull/5942#discussion_r401873218", "bodyText": "This would prevent these mistakes in the future: #5942 (comment)", "author": "SmithJosh", "createdAt": "2020-04-01T19:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2NzkwNw=="}], "type": "inlineReview"}, {"oid": "24d7b184de1e6e566133190eb59c720fc3cdeeb8", "url": "https://github.com/codice/ddf/commit/24d7b184de1e6e566133190eb59c720fc3cdeeb8", "message": "DDF-5360 Changed user ID based OAuth token storage to session ID to better handle the guest user.", "committedDate": "2020-04-01T19:51:31Z", "type": "forcePushed"}, {"oid": "bb0eb9d33d1a584cf90af204952d0b0355c956bb", "url": "https://github.com/codice/ddf/commit/bb0eb9d33d1a584cf90af204952d0b0355c956bb", "message": "DDF-5360 Changed user ID based OAuth token storage to session ID to better handle the guest user.", "committedDate": "2020-04-01T22:08:46Z", "type": "commit"}, {"oid": "bb0eb9d33d1a584cf90af204952d0b0355c956bb", "url": "https://github.com/codice/ddf/commit/bb0eb9d33d1a584cf90af204952d0b0355c956bb", "message": "DDF-5360 Changed user ID based OAuth token storage to session ID to better handle the guest user.", "committedDate": "2020-04-01T22:08:46Z", "type": "forcePushed"}]}