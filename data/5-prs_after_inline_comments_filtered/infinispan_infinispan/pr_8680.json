{"pr_number": 8680, "pr_title": "ISPN-12177 Persist IRAC version during shutdown", "pr_createdAt": "2020-09-10T10:51:18Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8680", "timeline": [{"oid": "e63a257513603d59855252b7ca693d96eda70145", "url": "https://github.com/infinispan/infinispan/commit/e63a257513603d59855252b7ca693d96eda70145", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-09-25T10:45:34Z", "type": "forcePushed"}, {"oid": "e204caf8f62d43d23852efb32aa02a34d325707a", "url": "https://github.com/infinispan/infinispan/commit/e204caf8f62d43d23852efb32aa02a34d325707a", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-09-28T12:56:17Z", "type": "forcePushed"}, {"oid": "4539874c28934d83ab4afadf531524c8925468e2", "url": "https://github.com/infinispan/infinispan/commit/4539874c28934d83ab4afadf531524c8925468e2", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-10-09T09:46:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510248374", "bodyText": "Looks like topologyId can be removed as well?", "author": "wburns", "createdAt": "2020-10-22T15:19:56Z", "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "diffHunk": "@@ -90,6 +92,7 @@ public String toString() {\n             \"cacheName=\" + cacheName +\n             \", segment=\" + segment +\n             \", topologyId=\" + topologyId +", "originalCommit": "4539874c28934d83ab4afadf531524c8925468e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NjU1OA==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510346558", "bodyText": "not really. It makes sure the node has at least that topology installed before handling the executing the command.", "author": "pruivo", "createdAt": "2020-10-22T17:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NzQzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510347435", "bodyText": "Shouldn't it be part of the readFrom and writeTo though?", "author": "wburns", "createdAt": "2020-10-22T17:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDIxMQ==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510404211", "bodyText": "no, the previous code was incorrect.\nThe CacheRpcCommandExternalizer [1] invokes the ReplicableCommandExternalizer [2] and the latter sends the topology id.\n[1] https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/marshall/exts/CacheRpcCommandExternalizer.java#L142\n[2] https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/marshall/exts/ReplicableCommandExternalizer.java#L82", "author": "pruivo", "createdAt": "2020-10-22T19:27:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MDY4Mw==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510270683", "bodyText": "This seems awfully expensive to compile a new Pattern on every invocation. I would suggest to store the compiled pattern statically.", "author": "wburns", "createdAt": "2020-10-22T15:49:20Z", "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -36,6 +49,16 @@ public static TopologyIracVersion max(TopologyIracVersion v1, TopologyIracVersio\n       return v1.compareTo(v2) < 0 ? v2 : v1;\n    }\n \n+   public static TopologyIracVersion fromString(String s) {\n+      Matcher m = Pattern.compile(REGEX).matcher(s);", "originalCommit": "4539874c28934d83ab4afadf531524c8925468e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0Nzk0Mg==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510347942", "bodyText": "right!", "author": "pruivo", "createdAt": "2020-10-22T17:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MDY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MjQwMw==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510272403", "bodyText": "Is there a reason this was changed? The prior appending is much faster and a bit easier to read imo.", "author": "wburns", "createdAt": "2020-10-22T15:51:37Z", "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -63,7 +86,7 @@ public int compareTo(TopologyIracVersion other) {\n \n    @Override\n    public String toString() {\n-      return '(' + Integer.toString(topologyId) + ':' + version + ')';\n+      return String.format(FMT, topologyId, version);", "originalCommit": "4539874c28934d83ab4afadf531524c8925468e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0ODIxOQ==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510348219", "bodyText": "I've spent too much time in python xD", "author": "pruivo", "createdAt": "2020-10-22T17:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MjQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3NTEwMA==", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510275100", "bodyText": "Good catch \ud83d\udc4d", "author": "wburns", "createdAt": "2020-10-22T15:55:12Z", "path": "core/src/main/java/org/infinispan/interceptors/impl/NonTxIracLocalSiteInterceptor.java", "diffHunk": "@@ -226,20 +225,21 @@ private void handleDataWriteCommand(InvocationContext ctx, DataWriteCommand comm\n    /**\n     * Visits th {@link WriteCommand} after executed and stores the {@link IracMetadata} if it was successful.\n     */\n+   @SuppressWarnings(\"unused\")\n    private void handleWriteCommand(InvocationContext ctx, WriteCommand command, Object rv, Throwable t) {\n       if (!command.isSuccessful()) {\n          return;\n       }\n       for (Object key : command.getAffectedKeys()) {\n-         if (skipEntryCommit(ctx, key)) {\n+         if (skipEntryCommit(ctx, command, key)) {\n             continue;\n          }\n          setMetadataToCacheEntry(ctx.lookupEntry(key), command.getInternalMetadata(key).iracMetadata());\n       }\n    }\n \n-   private boolean skipEntryCommit(InvocationContext ctx, Object key) {\n-      switch (getOwnership(key)) {\n+   private boolean skipEntryCommit(InvocationContext ctx, WriteCommand command, Object key) {\n+      switch (getOwnership(getSegment(command, key))) {", "originalCommit": "4539874c28934d83ab4afadf531524c8925468e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3c583b597c5c9736679b0034570cd6ff8e606e9", "url": "https://github.com/infinispan/infinispan/commit/d3c583b597c5c9736679b0034570cd6ff8e606e9", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-10-22T18:02:48Z", "type": "forcePushed"}, {"oid": "50a3e1c88abc2a1a32a119380228bbb6e8b6201b", "url": "https://github.com/infinispan/infinispan/commit/50a3e1c88abc2a1a32a119380228bbb6e8b6201b", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-10-23T10:40:12Z", "type": "commit"}, {"oid": "50a3e1c88abc2a1a32a119380228bbb6e8b6201b", "url": "https://github.com/infinispan/infinispan/commit/50a3e1c88abc2a1a32a119380228bbb6e8b6201b", "message": "ISPN-12177 Persist IRAC version during shutdown", "committedDate": "2020-10-23T10:40:12Z", "type": "forcePushed"}]}