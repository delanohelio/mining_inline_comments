{"pr_number": 7876, "pr_title": "[9.4.x] ISPN-11209 Max Idle changes caused a REPL read performance regression", "pr_createdAt": "2020-02-11T19:20:45Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7876", "timeline": [{"oid": "6e0f686104518fea26446518214488db312d7882", "url": "https://github.com/infinispan/infinispan/commit/6e0f686104518fea26446518214488db312d7882", "message": "ISPN-11209 Max Idle changes caused a REPL read performance regression\n\n* Updated missing reference", "committedDate": "2020-02-11T19:33:05Z", "type": "forcePushed"}, {"oid": "6d716460226f2748dfe134a0db64dd2fd1fb160c", "url": "https://github.com/infinispan/infinispan/commit/6d716460226f2748dfe134a0db64dd2fd1fb160c", "message": "ISPN-11209 Max Idle changes caused a REPL read performance regression\n\n* Updated missing reference", "committedDate": "2020-02-11T20:39:48Z", "type": "commit"}, {"oid": "6d716460226f2748dfe134a0db64dd2fd1fb160c", "url": "https://github.com/infinispan/infinispan/commit/6d716460226f2748dfe134a0db64dd2fd1fb160c", "message": "ISPN-11209 Max Idle changes caused a REPL read performance regression\n\n* Updated missing reference", "committedDate": "2020-02-11T20:39:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r377903518", "bodyText": "AFAICT the PeekableTouchableMap impls implement Lifecycle, not AutoCloseable, so maybe this code isn't needed at all?", "author": "danberindei", "createdAt": "2020-02-11T21:17:34Z", "path": "core/src/main/java/org/infinispan/container/impl/DefaultSegmentedDataContainer.java", "diffHunk": "@@ -234,11 +234,11 @@ public void removeSegments(IntSet segments) {\n \n    private void startNewMap(int segment) {\n       if (maps.get(segment) == null) {\n-         PeekableTouchableContainerMap<K, V> newMap = new PeekableTouchableContainerMap<>(mapSupplier.get());\n+         PeekableTouchableMap<K, InternalCacheEntry<K, V>> newMap = mapSupplier.get();\n          // Just in case of concurrent starts - this shouldn't be possible\n-         if (!maps.compareAndSet(segment, null, newMap) && newMap.delegate() instanceof AutoCloseable) {\n+         if (!maps.compareAndSet(segment, null, newMap) && newMap instanceof AutoCloseable) {", "originalCommit": "6d716460226f2748dfe134a0db64dd2fd1fb160c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzODg4NQ==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378238885", "bodyText": "https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/container/offheap/OffHeapConcurrentMap.java#L84 is the one that doesn't.", "author": "wburns", "createdAt": "2020-02-12T13:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI4Mjc2MA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378282760", "bodyText": "PeekableTouchableContainerMap doesn't implement AutoCloseable either", "author": "danberindei", "createdAt": "2020-02-12T14:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI4NzM1OA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378287358", "bodyText": "Yeah it doesn't need it though, it is all on heap with nothing started :)", "author": "wburns", "createdAt": "2020-02-12T14:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI4NzY2Ng==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378287666", "bodyText": "Unless I am missing a reference somewhere, in which case it would need fixing.", "author": "wburns", "createdAt": "2020-02-12T14:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMzI2Ng==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378323266", "bodyText": "I'm not saying it needs AutoCloseable, I'm just saying this code is never executed because none of the classes implement AutoCloseable.", "author": "danberindei", "createdAt": "2020-02-12T15:27:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTIxMQ==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378325211", "bodyText": "OffHeapConcurrentMap does as I linked, I just accidentally put master instead of 9.4.x\nhttps://github.com/infinispan/infinispan/blob/9.4.x/core/src/main/java/org/infinispan/container/offheap/OffHeapConcurrentMap.java#L33", "author": "wburns", "createdAt": "2020-02-12T15:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTQyNA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378325424", "bodyText": "ah it used to, refactoring at its best.", "author": "wburns", "createdAt": "2020-02-12T15:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTg3Nw==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378325877", "bodyText": "It does on master and 10.1.x, but not on 9.4.x is the problem.", "author": "wburns", "createdAt": "2020-02-12T15:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzNjY0OA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378336648", "bodyText": "LOL, I thought I was looking at the master code in my working dir... it took me a second to realize that I had created my task branch from 9.4.x instead of master!", "author": "danberindei", "createdAt": "2020-02-12T15:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMzUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwNDk1Nw==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r377904957", "bodyText": "Comment still says \"it wasn't touched\"", "author": "danberindei", "createdAt": "2020-02-11T21:19:06Z", "path": "core/src/main/java/org/infinispan/container/offheap/OffHeapConcurrentMap.java", "diffHunk": "@@ -58,7 +58,7 @@\n    @Override\n    public boolean touchKey(Object key, long currentTimeMillis) {\n       // OFF HEAP does not support max idle in this version - just say it wasn't touched\n-      return false;\n+      return true;", "originalCommit": "6d716460226f2748dfe134a0db64dd2fd1fb160c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r377925965", "bodyText": "\ud83d\udc4d\nFor master, the declaration would be simpler if you made PeekableTouchableMap<K, V> implement ConcurrentMap<K, InternalCacheEntry<K, V>>, and the PeekableMap and TouchableMap interfaces also don't seem to be used by themselves:\n1f21b70\nI'd go even further and change the interface name, e.g. DataContainerSegment, so there's no confusion because the V means something else compared to Map.", "author": "danberindei", "createdAt": "2020-02-11T22:01:09Z", "path": "core/src/main/java/org/infinispan/factories/DataContainerFactory.java", "diffHunk": "@@ -65,7 +68,8 @@ public Object construct(String componentName) {\n                int addressCount = memoryConfiguration.addressCount();\n                if (shouldSegment) {\n                   int segments = clusteringConfiguration.hash().numSegments();\n-                  Supplier mapSupplier = () -> createAndStartOffHeapConcurrentMap(addressCount, segments);\n+                  Supplier<PeekableTouchableMap<WrappedBytes, InternalCacheEntry<WrappedBytes, WrappedBytes>>>\n+                        mapSupplier = () -> createAndStartOffHeapConcurrentMap(addressCount, segments);", "originalCommit": "6d716460226f2748dfe134a0db64dd2fd1fb160c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTY3NA==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r377935674", "bodyText": "Yeah part of the problem is the disparity between 9.4.x and master. I can try to consolidate them on master better.", "author": "wburns", "createdAt": "2020-02-11T22:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMjI5Nw==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378322297", "bodyText": "Yeah one of my issues was that PeekableMap is in commons, I wasn't quite sure about removing it.", "author": "wburns", "createdAt": "2020-02-12T15:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzNzg4OQ==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378337889", "bodyText": "We don't need to remove it immediately, but don't have to keep implementing it either, because the per-segment maps were never exposed.", "author": "danberindei", "createdAt": "2020-02-12T15:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzODQ4NQ==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378338485", "bodyText": "Sure, I can just deprecate it. More than likely no one is using it anyways.", "author": "wburns", "createdAt": "2020-02-12T15:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzODkwMw==", "url": "https://github.com/infinispan/infinispan/pull/7876#discussion_r378338903", "bodyText": "I will do that in master only though.", "author": "wburns", "createdAt": "2020-02-12T15:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyNTk2NQ=="}], "type": "inlineReview"}]}