{"pr_number": 8196, "pr_title": "ISPN-11620 Remove EncoderRegistry from DataConversion", "pr_createdAt": "2020-04-14T14:19:03Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8196", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r409309748", "bodyText": "Can't remove these methods directly IMO, even if we don't expect applications to actually use them they're still part of the public API. Let's deprecate them, but simplify the implementation to simply delegate to EncoderRegistry.", "author": "danberindei", "createdAt": "2020-04-16T06:24:44Z", "path": "core/src/main/java/org/infinispan/encoding/DataConversion.java", "diffHunk": "@@ -143,30 +142,11 @@ private MediaType getStorageMediaType(Configuration configuration, boolean embed\n       return MediaType.APPLICATION_UNKNOWN;\n    }\n \n-   public boolean isConversionSupported(MediaType mediaType) {", "originalCommit": "e5fe5d1b9f143defa7ac19feb386bcf9f2bf848e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjA2Mg==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r409312062", "bodyText": "The problem is, to keep them the encoder registry is needed inside the data conversion, which defeats the whole purpose of the the PR :)", "author": "gustavonalle", "createdAt": "2020-04-16T06:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMxMjkyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r409312925", "bodyText": "We can either:\n\ndeprecate them in the upcoming 10.1.7 and remove here\njust remove it here and write in the upgrade guide", "author": "gustavonalle", "createdAt": "2020-04-16T06:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NDYwNw==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r409464607", "bodyText": "IMO if we deprecate those methods and we never call them internally then it's safe to not inject the EncoderRegistry in those static instances (i.e. move the encoderRegistry assignment after the if line in injectDependencies()). E.g. 0ffe095\nThen everything works as it should, only stuff like DataConversion.IDENTITY_KEY.convert(o, randomMediaType1, randomMediaType2), which shouldn't be a surprise for anyone.\nI'm now working on ISPN-11629 and I'm thinking of deprecating those constants too, and using them only internally (if at all).\nOTOH I just noticed that org.infinispan.encoding and org.infinispan.commons.encoding are not @public packages. They are referenced in public APIs like AdvancedCache, so they should be in the javadoc. I don't think this gives a free pass to remove methods, but @tristantarrant might disagree :)", "author": "danberindei", "createdAt": "2020-04-16T10:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU0MDMwOQ==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r409540309", "bodyText": "I'd personally deprecate in 10.1.7 and then remove altogether on 11", "author": "gustavonalle", "createdAt": "2020-04-16T13:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA4NTMwNg==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r410085306", "bodyText": "WDYT @danberindei?", "author": "gustavonalle", "createdAt": "2020-04-17T08:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1MjU2OA==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r413652568", "bodyText": "@gustavonalle we can't deprecate in 10.1.x any more, so let's just deprecate it in 11.", "author": "danberindei", "createdAt": "2020-04-23T09:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMzUxMw==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415623513", "bodyText": "@danberindei updated to simply deprecated it and removed the internal usages", "author": "gustavonalle", "createdAt": "2020-04-27T08:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMwOTc0OA=="}], "type": "inlineReview"}, {"oid": "eb6b292bdac905dd0b21e2c29b0cf05dc233c62f", "url": "https://github.com/infinispan/infinispan/commit/eb6b292bdac905dd0b21e2c29b0cf05dc233c62f", "message": "ISPN-11620 Deprecate methods using EncoderRegistry from DataConversion", "committedDate": "2020-04-27T08:38:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415704432", "bodyText": "Should this really be public API?\nEncoderRegistry is not in a @public package, so it's not going to be included in the Javadoc.", "author": "danberindei", "createdAt": "2020-04-27T10:42:03Z", "path": "core/src/main/java/org/infinispan/manager/EmbeddedCacheManager.java", "diffHunk": "@@ -373,4 +374,10 @@ default EmbeddedCacheManagerAdmin administration() {\n    }\n \n    ClassWhiteList getClassWhiteList();\n+\n+   /**\n+    * @since 11.0\n+    * @return the {@link EncoderRegistry} associated with the cache manager.\n+    */\n+   EncoderRegistry getEncoderRegistry();", "originalCommit": "eb6b292bdac905dd0b21e2c29b0cf05dc233c62f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNzk0MQ==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415707941", "bodyText": "What API do you suggest to expose that a conversion is supported and to convert data? ATM, at least internally, it grabs this EncoderRegistry from the registry every time", "author": "gustavonalle", "createdAt": "2020-04-27T10:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxMDcwMw==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415710703", "bodyText": "Why would an application need to ask at runtime whether a conversion is supported? Internal components can keep injecting the EncoderRegistry from the global component registry.", "author": "danberindei", "createdAt": "2020-04-27T10:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxMzAyNg==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415713026", "bodyText": "Why would an application need to ask at runtime whether a conversion is supported?\n\nThose methods were in the DataConversion, and this PR deprecated them. Are you proposing to just deprecate them and provide no alternative?", "author": "gustavonalle", "createdAt": "2020-04-27T10:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcxNTAyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415715025", "bodyText": "Yes! If someone actually needs an alternative we will provide it, but the deprecated methods will still work until the affected users realize they are affected and ask for an alternative.", "author": "danberindei", "createdAt": "2020-04-27T10:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc4NjgzMA==", "url": "https://github.com/infinispan/infinispan/pull/8196#discussion_r415786830", "bodyText": "Ok, PR updated", "author": "gustavonalle", "createdAt": "2020-04-27T12:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwNDQzMg=="}], "type": "inlineReview"}, {"oid": "be68fe238779548302e42b1a35a0a3358e5de585", "url": "https://github.com/infinispan/infinispan/commit/be68fe238779548302e42b1a35a0a3358e5de585", "message": "ISPN-11620 Deprecate methods using EncoderRegistry from DataConversion", "committedDate": "2020-04-27T12:52:52Z", "type": "forcePushed"}, {"oid": "d74191fe527f25bc7f0ffa1fbcc168561de67c49", "url": "https://github.com/infinispan/infinispan/commit/d74191fe527f25bc7f0ffa1fbcc168561de67c49", "message": "ISPN-11620 Deprecate methods using EncoderRegistry from DataConversion", "committedDate": "2020-04-27T13:22:05Z", "type": "commit"}, {"oid": "d74191fe527f25bc7f0ffa1fbcc168561de67c49", "url": "https://github.com/infinispan/infinispan/commit/d74191fe527f25bc7f0ffa1fbcc168561de67c49", "message": "ISPN-11620 Deprecate methods using EncoderRegistry from DataConversion", "committedDate": "2020-04-27T13:22:05Z", "type": "forcePushed"}]}