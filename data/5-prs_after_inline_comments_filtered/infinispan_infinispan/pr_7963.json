{"pr_number": 7963, "pr_title": "ISPN-11390 Non-components cannot export metrics", "pr_createdAt": "2020-02-28T05:56:03Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7963", "timeline": [{"oid": "83a3759fc8fe5d90b7ee3ef8dd9c92dd95b7e276", "url": "https://github.com/infinispan/infinispan/commit/83a3759fc8fe5d90b7ee3ef8dd9c92dd95b7e276", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-02T08:20:39Z", "type": "forcePushed"}, {"oid": "bb69c3b10bc4700fb66a8a9adf28577f128f7d53", "url": "https://github.com/infinispan/infinispan/commit/bb69c3b10bc4700fb66a8a9adf28577f128f7d53", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-02T08:49:59Z", "type": "forcePushed"}, {"oid": "a0e83ac6726be7f91defb89a403d4a805d1136cc", "url": "https://github.com/infinispan/infinispan/commit/a0e83ac6726be7f91defb89a403d4a805d1136cc", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-02T11:59:19Z", "type": "forcePushed"}, {"oid": "7e2262914a3b4d0c9b5e988edc74d526d760cdf9", "url": "https://github.com/infinispan/infinispan/commit/7e2262914a3b4d0c9b5e988edc74d526d760cdf9", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-02T12:11:11Z", "type": "forcePushed"}, {"oid": "7c9a93d107875fabed5a1d748d3a372bef0e5bdb", "url": "https://github.com/infinispan/infinispan/commit/7c9a93d107875fabed5a1d748d3a372bef0e5bdb", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-02T12:47:01Z", "type": "forcePushed"}, {"oid": "2b1fb02f9d75ac7fe0f6f6e99a13ec75f23d831d", "url": "https://github.com/infinispan/infinispan/commit/2b1fb02f9d75ac7fe0f6f6e99a13ec75f23d831d", "message": "wip", "committedDate": "2020-03-02T19:38:15Z", "type": "forcePushed"}, {"oid": "3afaa6465dedb504a2f5b663177c44af55ae609b", "url": "https://github.com/infinispan/infinispan/commit/3afaa6465dedb504a2f5b663177c44af55ae609b", "message": "wip", "committedDate": "2020-03-03T04:25:31Z", "type": "forcePushed"}, {"oid": "cc4a824653a8aa1e50e1effdff726fa2cbc4b0b8", "url": "https://github.com/infinispan/infinispan/commit/cc4a824653a8aa1e50e1effdff726fa2cbc4b0b8", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-03T09:10:15Z", "type": "forcePushed"}, {"oid": "3dc5c39fba2edf3cd85fc89a18fd7b318700acd6", "url": "https://github.com/infinispan/infinispan/commit/3dc5c39fba2edf3cd85fc89a18fd7b318700acd6", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-04T08:32:38Z", "type": "forcePushed"}, {"oid": "f9d62f52c6d31f508c383e7fc14c64069b8bdf71", "url": "https://github.com/infinispan/infinispan/commit/f9d62f52c6d31f508c383e7fc14c64069b8bdf71", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-04T13:17:09Z", "type": "forcePushed"}, {"oid": "4789dc4f64cca33bd5bec78c4bb35a8fcacd0940", "url": "https://github.com/infinispan/infinispan/commit/4789dc4f64cca33bd5bec78c4bb35a8fcacd0940", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-04T16:12:28Z", "type": "forcePushed"}, {"oid": "ae59b0ae85d6dfc9097da54bd6012e88ae313b71", "url": "https://github.com/infinispan/infinispan/commit/ae59b0ae85d6dfc9097da54bd6012e88ae313b71", "message": "wip", "committedDate": "2020-03-05T08:31:41Z", "type": "forcePushed"}, {"oid": "21a3520f2d435a434abee24b808b607366b6e34f", "url": "https://github.com/infinispan/infinispan/commit/21a3520f2d435a434abee24b808b607366b6e34f", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-05T09:45:37Z", "type": "forcePushed"}, {"oid": "7b07a1447c5c53e433a0566cb73f453216f0636c", "url": "https://github.com/infinispan/infinispan/commit/7b07a1447c5c53e433a0566cb73f453216f0636c", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-05T11:20:04Z", "type": "forcePushed"}, {"oid": "541767326ad09c77f45f6558e740291d17de953a", "url": "https://github.com/infinispan/infinispan/commit/541767326ad09c77f45f6558e740291d17de953a", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-05T13:48:09Z", "type": "forcePushed"}, {"oid": "22f08071e34b9dd30f32f9fdb27dc9cea3fad1d7", "url": "https://github.com/infinispan/infinispan/commit/22f08071e34b9dd30f32f9fdb27dc9cea3fad1d7", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-06T07:47:25Z", "type": "forcePushed"}, {"oid": "fc61dc7864250360a49b9723db469085157068a4", "url": "https://github.com/infinispan/infinispan/commit/fc61dc7864250360a49b9723db469085157068a4", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-06T09:06:00Z", "type": "forcePushed"}, {"oid": "a7895b4e43cfcd87485e624c3ab03f436bfbca05", "url": "https://github.com/infinispan/infinispan/commit/a7895b4e43cfcd87485e624c3ab03f436bfbca05", "message": "wip", "committedDate": "2020-03-06T13:50:01Z", "type": "forcePushed"}, {"oid": "fb5659127f4183ae5b50ee4a7968bd9f59fd1738", "url": "https://github.com/infinispan/infinispan/commit/fb5659127f4183ae5b50ee4a7968bd9f59fd1738", "message": "ISPN-11430 Align microprofile metrics and config artifact versions with Wildfly latest", "committedDate": "2020-03-06T14:30:52Z", "type": "forcePushed"}, {"oid": "002a915dd74a3d1ff9047563ca578331a14b7702", "url": "https://github.com/infinispan/infinispan/commit/002a915dd74a3d1ff9047563ca578331a14b7702", "message": "Rename InfinispanMetricRegistry to MetricsCollector", "committedDate": "2020-03-06T10:08:37Z", "type": "forcePushed"}, {"oid": "5abc9f8c1ee7d34ef95262224821ec1398554689", "url": "https://github.com/infinispan/infinispan/commit/5abc9f8c1ee7d34ef95262224821ec1398554689", "message": "Rename InfinispanMetricRegistry to MetricsCollector", "committedDate": "2020-03-07T14:42:32Z", "type": "forcePushed"}, {"oid": "4fabaaa4716f995ae527c52b3695a656011c8ff9", "url": "https://github.com/infinispan/infinispan/commit/4fabaaa4716f995ae527c52b3695a656011c8ff9", "message": "Get node name for metrics tag directly from Transport", "committedDate": "2020-03-08T20:13:40Z", "type": "forcePushed"}, {"oid": "39485467464762820265abc22d59aabe622d3ea9", "url": "https://github.com/infinispan/infinispan/commit/39485467464762820265abc22d59aabe622d3ea9", "message": "New metric registration config options: namesAsTags\n\n* boolean, if enabled it results in the cache manager name and cache name\n\u00a0 being added as tags rather than being included in the metric name\n* disabled by default", "committedDate": "2020-03-09T11:11:37Z", "type": "forcePushed"}, {"oid": "0969e8d83a4ec5d58cc6508bef72a742b0f68094", "url": "https://github.com/infinispan/infinispan/commit/0969e8d83a4ec5d58cc6508bef72a742b0f68094", "message": "ISPN-11438 Additional metric registration config option: namesAsTags\n\n* boolean, if enabled it results in the cache manager name and cache name\n\u00a0 being added as tags rather than being included in the metric name\n* disabled by default", "committedDate": "2020-03-09T12:33:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNjM1NQ==", "url": "https://github.com/infinispan/infinispan/pull/7963#discussion_r389936355", "bodyText": "I'd really love this to be rewritten not to use JMX at some point", "author": "tristantarrant", "createdAt": "2020-03-09T20:15:58Z", "path": "server/core/src/main/java/org/infinispan/server/core/transport/NettyTransportConnectionStats.java", "diffHunk": "@@ -95,22 +95,26 @@ private int calculateGlobalConnections() {\n       public Integer apply(EmbeddedCacheManager embeddedCacheManager) {\n          CacheManagerJmxRegistration jmxRegistration = SecurityActions.getGlobalComponentRegistry(embeddedCacheManager)\n                .getComponent(CacheManagerJmxRegistration.class);\n-         try {\n-            ObjectName transportNamePattern = new ObjectName(jmxRegistration.getDomain() + \":type=Server,component=Transport,name=*\");\n-            Set<ObjectName> objectNames = jmxRegistration.getMBeanServer().queryNames(transportNamePattern, null);\n-\n-            // sum the NumberOfLocalConnections from all transport MBeans that match the pattern\n-            int total = 0;\n-            for (ObjectName name : objectNames) {\n-               if (name.getKeyProperty(\"name\").startsWith(serverName)) {\n-                  Integer connections = (Integer) jmxRegistration.getMBeanServer().getAttribute(name, \"NumberOfLocalConnections\");\n-                  total += connections;\n+         if (jmxRegistration.enabled()) {", "originalCommit": "e3310ac56733fa80bfba40c9ed5a4d92360fc552", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc0MTM0Mg==", "url": "https://github.com/infinispan/infinispan/pull/7963#discussion_r391741342", "bodyText": "I've create https://issues.redhat.com/browse/ISPN-11466 to track this.", "author": "anistor", "createdAt": "2020-03-12T16:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzNjM1NQ=="}], "type": "inlineReview"}, {"oid": "8a9665ab0825c8803377e8685d497db6867c7024", "url": "https://github.com/infinispan/infinispan/commit/8a9665ab0825c8803377e8685d497db6867c7024", "message": "ISPN-11389 Deprecate EmbeddedCacheManager.getStats() method because CacheContainerStats is already deprecated", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "4c9308f5f974d45c677feb241dafb6f0768e1032", "url": "https://github.com/infinispan/infinispan/commit/4c9308f5f974d45c677feb241dafb6f0768e1032", "message": "Remove unneeded SuppressWarnings", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "3b068dfe115c37e1e58cd6821270246e7f3b735f", "url": "https://github.com/infinispan/infinispan/commit/3b068dfe115c37e1e58cd6821270246e7f3b735f", "message": "ISPN-11388 Refactor CacheIgnoreManager - AbstractProtocolServer collaboration\n\n* remove CacheIgnoreManager from ProtocolServer.start and make it a global component because it is shared by all protocols\n* remove the parameters of AbstractProtocolServer.startInternal( ) and process them in start() instead", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "da8e43614ad62c0f6c058840071d6a1f28c7e826", "url": "https://github.com/infinispan/infinispan/commit/da8e43614ad62c0f6c058840071d6a1f28c7e826", "message": "ISPN-11403 RestMetricsResource fails due to NettyTransportConnectionStats.getNumberOfGlobalConnections metrics not working with jmx disabled\n\n* this just works around the issue and returns a 0 for that metric when not computable rather than failing with a RuntimeException", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "2a042de1b2476c691796b68e76b1af60da581eab", "url": "https://github.com/infinispan/infinispan/commit/2a042de1b2476c691796b68e76b1af60da581eab", "message": "ISPN-11390 Non-components cannot export metrics\n\n* introduce AbstractMetricsRegistration.registerExternalMetrics", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "984eb9d7102616f2d180e482ba8c0899d64b546f", "url": "https://github.com/infinispan/infinispan/commit/984eb9d7102616f2d180e482ba8c0899d64b546f", "message": "Rename InfinispanMetricRegistry to MetricsCollector", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "40e8bb12577bace171f60f3763ddec6ed84b9fda", "url": "https://github.com/infinispan/infinispan/commit/40e8bb12577bace171f60f3763ddec6ed84b9fda", "message": "Get node name for metrics tag directly from Transport", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "f31d59e644a41d520cdabaf356db046076fe491f", "url": "https://github.com/infinispan/infinispan/commit/f31d59e644a41d520cdabaf356db046076fe491f", "message": "ISPN-11438 Additional metric registration config option: namesAsTags\n\n* boolean, if enabled it results in the cache manager name and cache name\n\u00a0 being added as tags rather than being included in the metric name\n* disabled by default", "committedDate": "2020-03-10T03:08:36Z", "type": "commit"}, {"oid": "f31d59e644a41d520cdabaf356db046076fe491f", "url": "https://github.com/infinispan/infinispan/commit/f31d59e644a41d520cdabaf356db046076fe491f", "message": "ISPN-11438 Additional metric registration config option: namesAsTags\n\n* boolean, if enabled it results in the cache manager name and cache name\n\u00a0 being added as tags rather than being included in the metric name\n* disabled by default", "committedDate": "2020-03-10T03:08:36Z", "type": "forcePushed"}]}