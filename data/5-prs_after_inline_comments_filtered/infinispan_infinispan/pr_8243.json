{"pr_number": 8243, "pr_title": "ISPN-11626 Server report", "pr_createdAt": "2020-04-24T16:26:18Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8243", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzODQwOQ==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r415638409", "bodyText": "Better to define a constant MediaType.APPLICATION_GZIP", "author": "gustavonalle", "createdAt": "2020-04-27T09:02:03Z", "path": "server/rest/src/main/java/org/infinispan/rest/resources/ServerResource.java", "diffHunk": "@@ -122,6 +125,26 @@ public Invocations getInvocations() {\n             .build());\n    }\n \n+   private CompletionStage<RestResponse> report(RestRequest restRequest) {\n+      ServerManagement server = invocationHelper.getServer();\n+      NettyRestResponse.Builder responseBuilder = new NettyRestResponse.Builder();\n+      return server.getServerReport().handle((path, t) -> {\n+         if (t != null) {\n+            return responseBuilder.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).build();\n+         } else {\n+            return responseBuilder\n+                  .contentType(MediaType.fromString(\"application/gzip\"))", "originalCommit": "0987dd20f5aad618484fb1adbd5334314742a6c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzOTQ3NA==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r415639474", "bodyText": "What is this header for?", "author": "gustavonalle", "createdAt": "2020-04-27T09:03:36Z", "path": "server/rest/src/main/java/org/infinispan/rest/resources/ServerResource.java", "diffHunk": "@@ -122,6 +125,26 @@ public Invocations getInvocations() {\n             .build());\n    }\n \n+   private CompletionStage<RestResponse> report(RestRequest restRequest) {\n+      ServerManagement server = invocationHelper.getServer();\n+      NettyRestResponse.Builder responseBuilder = new NettyRestResponse.Builder();\n+      return server.getServerReport().handle((path, t) -> {\n+         if (t != null) {\n+            return responseBuilder.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).build();\n+         } else {\n+            return responseBuilder\n+                  .contentType(MediaType.fromString(\"application/gzip\"))\n+                  .header(\"Content-Disposition\",", "originalCommit": "0987dd20f5aad618484fb1adbd5334314742a6c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MjIzMg==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r415642232", "bodyText": "It forces the browser to download and sets the name of the file.", "author": "tristantarrant", "createdAt": "2020-04-27T09:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzOTQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MTAxOQ==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r415641019", "bodyText": "Is Windows going to be handled? It probably needs to return 501 from the REST endpoint", "author": "gustavonalle", "createdAt": "2020-04-27T09:05:53Z", "path": "server/runtime/src/main/java/org/infinispan/server/Server.java", "diffHunk": "@@ -536,4 +545,24 @@ public ComponentStatus getStatus() {\n    public TaskManager getTaskManager() {\n       return taskManager;\n    }\n+\n+   @Override\n+   public CompletionStage<Path> getServerReport() {\n+      return CompletableFuture.supplyAsync(() -> {\n+         Path home = serverHome.toPath();\n+         ProcessBuilder builder = new ProcessBuilder(\"sh\", \"-c\", home.resolve(\"bin/report.sh\").toString(), home.toString());", "originalCommit": "0987dd20f5aad618484fb1adbd5334314742a6c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MjM3NQ==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r415642375", "bodyText": "I'll do that for non-Linux.", "author": "tristantarrant", "createdAt": "2020-04-27T09:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY0MTAxOQ=="}], "type": "inlineReview"}, {"oid": "a84bf1555f38e25aad96b8ace931770ad369da8e", "url": "https://github.com/infinispan/infinispan/commit/a84bf1555f38e25aad96b8ace931770ad369da8e", "message": "ISPN-11626 Server report", "committedDate": "2020-05-07T13:47:15Z", "type": "forcePushed"}, {"oid": "8c4372243fc866b0e44bcad8bc2a47a02b6bfa94", "url": "https://github.com/infinispan/infinispan/commit/8c4372243fc866b0e44bcad8bc2a47a02b6bfa94", "message": "ISPN-11626 Server report", "committedDate": "2020-05-07T13:57:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5OTM0NA==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422199344", "bodyText": "print help all the time?\nthe command > server alone isn't valid.", "author": "pruivo", "createdAt": "2020-05-08T15:10:00Z", "path": "cli/cli-client/src/main/java/org/infinispan/cli/commands/Server.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.infinispan.cli.commands;\n+\n+import org.aesh.command.Command;\n+import org.aesh.command.CommandDefinition;\n+import org.aesh.command.CommandResult;\n+import org.aesh.command.GroupCommandDefinition;\n+import org.infinispan.cli.activators.ConnectionActivator;\n+import org.infinispan.cli.impl.ContextAwareCommandInvocation;\n+import org.kohsuke.MetaInfServices;\n+\n+/**\n+ * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n+ * @since 11.0\n+ **/\n+@MetaInfServices(Command.class)\n+@GroupCommandDefinition(name = Server.CMD, description = \"Obtains information about the server\", activator = ConnectionActivator.class, groupCommands = {Server.Report.class})\n+public class Server extends CliCommand {\n+\n+   public static final String CMD = \"server\";\n+   public static final String TYPE = \"type\";\n+   public static final String NAME = \"name\";\n+\n+   @Override\n+   public CommandResult exec(ContextAwareCommandInvocation commandInvocation) {\n+      if (help) {", "originalCommit": "36930b9657389fc092009afa3f28b38f0910e475", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwOTYwOA==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422209608", "bodyText": "nitpick: you don't need the ForkJoinPool.commonPool(). It is used by default.", "author": "pruivo", "createdAt": "2020-05-08T15:29:20Z", "path": "server/runtime/src/main/java/org/infinispan/server/Server.java", "diffHunk": "@@ -536,4 +548,35 @@ public ComponentStatus getStatus() {\n    public TaskManager getTaskManager() {\n       return taskManager;\n    }\n+\n+   @Override\n+   public CompletionStage<Path> getServerReport() {\n+      long pid = ProcessInfo.getInstance().getPid();\n+      Path home = serverHome.toPath();\n+      Path root = serverRoot.toPath();\n+      ProcessBuilder builder = new ProcessBuilder();\n+      OS os = OS.getCurrentOs();\n+      switch (os) {\n+         case LINUX:\n+            builder.command(\"sh\", \"-c\", home.resolve(\"bin/report.sh\").toString(), Long.toString(pid), root.toString());\n+            break;\n+         default:\n+            return CompletableFutures.completedExceptionFuture(log.serverReportUnavailable(os));\n+      }\n+\n+      return CompletableFuture.supplyAsync(() -> {\n+         try {\n+            Process process = builder.start();\n+            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n+            Path path = Paths.get(reader.readLine());\n+            process.waitFor(1, TimeUnit.MINUTES);\n+            return path;\n+         } catch (IOException e) {\n+            throw new RuntimeException(e);\n+         } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new RuntimeException(e);\n+         }\n+      }, ForkJoinPool.commonPool());", "originalCommit": "36930b9657389fc092009afa3f28b38f0910e475", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIyNDg2Nw==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422224867", "bodyText": "Checkstyle wants it :) Blame @wburns", "author": "tristantarrant", "createdAt": "2020-05-08T15:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwOTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIyOTQzMA==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422229430", "bodyText": "Are you not able to pass the blocking executor in some way? We are trying not to use common pool at all. Tbh I should add a checkstyle to prevent calling ForkJoinPool.commonPool as well :)", "author": "wburns", "createdAt": "2020-05-08T16:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwOTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzMDI2Mg==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422230262", "bodyText": "Should be able to just extract it from the first cacheManager.", "author": "wburns", "createdAt": "2020-05-08T16:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwOTYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzMDgyNA==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422230824", "bodyText": "To be honest I am not a fan of the multiple cacheManagers in this class still. Having multiple GLOBAL components could be quite problematic.", "author": "wburns", "createdAt": "2020-05-08T16:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIwOTYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIxMDMxNQ==", "url": "https://github.com/infinispan/infinispan/pull/8243#discussion_r422210315", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long pid = ProcessInfo.getInstance().getPid();\n          \n          \n            \n                  Path home = serverHome.toPath();\n          \n          \n            \n                  Path root = serverRoot.toPath();\n          \n          \n            \n                  ProcessBuilder builder = new ProcessBuilder();\n          \n          \n            \n                  OS os = OS.getCurrentOs();\n          \n          \n            \n                  switch (os) {\n          \n          \n            \n                     case LINUX:\n          \n          \n            \n                        builder.command(\"sh\", \"-c\", home.resolve(\"bin/report.sh\").toString(), Long.toString(pid), root.toString());\n          \n          \n            \n                        break;\n          \n          \n            \n                     default:\n          \n          \n            \n                        return CompletableFutures.completedExceptionFuture(log.serverReportUnavailable(os));\n          \n          \n            \n                  }\n          \n          \n            \n                  OS os = OS.getCurrentOs();\n          \n          \n            \n                  if (os != OS.LINUX) {\n          \n          \n            \n                     return CompletableFutures.completedExceptionFuture(log.serverReportUnavailable(os));\n          \n          \n            \n                  }\n          \n          \n            \n                  \n          \n          \n            \n                  long pid = ProcessInfo.getInstance().getPid();\n          \n          \n            \n                  Path home = serverHome.toPath();\n          \n          \n            \n                  Path root = serverRoot.toPath();\n          \n          \n            \n                  ProcessBuilder builder = new ProcessBuilder();\n          \n          \n            \n                  builder.command(\"sh\", \"-c\", home.resolve(\"bin/report.sh\").toString(), Long.toString(pid), root.toString());", "author": "pruivo", "createdAt": "2020-05-08T15:30:43Z", "path": "server/runtime/src/main/java/org/infinispan/server/Server.java", "diffHunk": "@@ -536,4 +548,35 @@ public ComponentStatus getStatus() {\n    public TaskManager getTaskManager() {\n       return taskManager;\n    }\n+\n+   @Override\n+   public CompletionStage<Path> getServerReport() {\n+      long pid = ProcessInfo.getInstance().getPid();\n+      Path home = serverHome.toPath();\n+      Path root = serverRoot.toPath();\n+      ProcessBuilder builder = new ProcessBuilder();\n+      OS os = OS.getCurrentOs();\n+      switch (os) {\n+         case LINUX:\n+            builder.command(\"sh\", \"-c\", home.resolve(\"bin/report.sh\").toString(), Long.toString(pid), root.toString());\n+            break;\n+         default:\n+            return CompletableFutures.completedExceptionFuture(log.serverReportUnavailable(os));\n+      }", "originalCommit": "36930b9657389fc092009afa3f28b38f0910e475", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bab8f8a8ff3a6f97184cf67f7158fa1c722f6cd3", "url": "https://github.com/infinispan/infinispan/commit/bab8f8a8ff3a6f97184cf67f7158fa1c722f6cd3", "message": "ISPN-11626 Server report", "committedDate": "2020-05-08T15:59:23Z", "type": "forcePushed"}, {"oid": "39a3185b5239644b4bc5e5319ed846b2f6c53f83", "url": "https://github.com/infinispan/infinispan/commit/39a3185b5239644b4bc5e5319ed846b2f6c53f83", "message": "ISPN-11626 Server report", "committedDate": "2020-05-08T16:53:21Z", "type": "forcePushed"}, {"oid": "ce1135c4a3204fcc2b7e458f49311d838c43d2d3", "url": "https://github.com/infinispan/infinispan/commit/ce1135c4a3204fcc2b7e458f49311d838c43d2d3", "message": "ISPN-11626 Server report", "committedDate": "2020-05-09T13:47:57Z", "type": "forcePushed"}, {"oid": "c37adbf009b7fdacdc06e3faf54d485d5534bdc5", "url": "https://github.com/infinispan/infinispan/commit/c37adbf009b7fdacdc06e3faf54d485d5534bdc5", "message": "ISPN-11626 Server report", "committedDate": "2020-05-19T08:07:41Z", "type": "commit"}, {"oid": "c37adbf009b7fdacdc06e3faf54d485d5534bdc5", "url": "https://github.com/infinispan/infinispan/commit/c37adbf009b7fdacdc06e3faf54d485d5534bdc5", "message": "ISPN-11626 Server report", "committedDate": "2020-05-19T08:07:41Z", "type": "forcePushed"}]}