{"pr_number": 8173, "pr_title": "ISPN-11599 Out of the box testing with Infinispan Server and JUnit 5 ", "pr_createdAt": "2020-04-04T08:50:40Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8173", "timeline": [{"oid": "df038a426e55c50298124c8325922d4e4e1d443c", "url": "https://github.com/infinispan/infinispan/commit/df038a426e55c50298124c8325922d4e4e1d443c", "message": "ISPN-11505 add config for standalone embedded server", "committedDate": "2020-04-06T16:27:44Z", "type": "forcePushed"}, {"oid": "4b28e4018d01b485e9a562018d17eee8cea5bd73", "url": "https://github.com/infinispan/infinispan/commit/4b28e4018d01b485e9a562018d17eee8cea5bd73", "message": "ISPN-11505 add config for standalone embedded server", "committedDate": "2020-04-06T20:24:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MzY4Mw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404063683", "bodyText": "java.* and javax.* first, please", "author": "danberindei", "createdAt": "2020-04-06T12:48:55Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractInfinispanServerDriver.java", "diffHunk": "@@ -1,10 +1,25 @@\n package org.infinispan.server.test.core;\n \n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;", "originalCommit": "46ecb7881279b0dbcd12da1630aee158993181b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NTU5NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404065594", "bodyText": "The sentence feels unfinished", "author": "danberindei", "createdAt": "2020-04-06T12:52:10Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/EmbeddedInfinispanServerDriver.java", "diffHunk": "@@ -61,9 +61,11 @@ protected void start(String name, File rootDir, String configurationFile) {\n          serverFutures.add(server.run());\n          servers.add(server);\n       }\n-      // Ensure that the cluster has formed\n+      // Ensure that the cluster has formed if more than one", "originalCommit": "46ecb7881279b0dbcd12da1630aee158993181b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NDIxMA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404664210", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               private static final List<String> DEFAULT_INFINISPAN_CONFIG_FILES = Arrays.asList(\n          \n          \n            \n               private static final List<String> DEFAULT_INFINISPAN_CONFIG_FILES = \n          \n          \n            \n                     Arrays.asList(DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME);", "author": "danberindei", "createdAt": "2020-04-07T09:22:47Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractInfinispanServerDriver.java", "diffHunk": "@@ -16,29 +31,21 @@\n import java.security.cert.CertificateException;\n import java.security.cert.X509Certificate;\n import java.util.Arrays;\n+import java.util.List;\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.function.BiConsumer;\n import java.util.function.Consumer;\n \n-import javax.security.auth.x500.X500Principal;\n-\n-import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n-import org.infinispan.commons.test.CommonsTestingUtil;\n-import org.infinispan.commons.test.Exceptions;\n-import org.infinispan.commons.util.Util;\n-import org.infinispan.lifecycle.ComponentStatus;\n-import org.infinispan.security.AuthorizationPermission;\n-import org.infinispan.server.Server;\n-import org.infinispan.server.security.UserTool;\n-import org.wildfly.security.x500.cert.BasicConstraintsExtension;\n-import org.wildfly.security.x500.cert.SelfSignedX509CertificateAndSigningKey;\n-import org.wildfly.security.x500.cert.X509CertificateBuilder;\n-\n /**\n  * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n  * @since 10.0\n  **/\n public abstract class AbstractInfinispanServerDriver implements InfinispanServerDriver {\n+   public static final String DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME = \"infinispan.xml\";\n+\n+   private static final List<String> DEFAULT_INFINISPAN_CONFIG_FILES = Arrays.asList(", "originalCommit": "4b28e4018d01b485e9a562018d17eee8cea5bd73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1MzUwNw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404853507", "bodyText": "I would not have a default configuration name specified. In CONTAINER mode we can simply start the server with no configuration and it will use the default infinispan.xml", "author": "tristantarrant", "createdAt": "2020-04-07T14:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAyMDkwNQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r406020905", "bodyText": "oki", "author": "karesti", "createdAt": "2020-04-09T07:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404665596", "bodyText": "Is this change really necessary?\n\"infinispan.xml\" is not an absolute path, so it would use the else branch, which looks exactly the same.", "author": "danberindei", "createdAt": "2020-04-07T09:24:56Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractInfinispanServerDriver.java", "diffHunk": "@@ -84,22 +91,32 @@ public void prepare(String name) {\n          throw new RuntimeException(\"Failed to create server configuration directory \" + confDir);\n       }\n       URL configurationFileURL;\n-      if (new File(configuration.configurationFile()).isAbsolute()) {\n+      if (DEFAULT_INFINISPAN_CONFIG_FILES.contains(configuration.configurationFile())) {", "originalCommit": "4b28e4018d01b485e9a562018d17eee8cea5bd73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY4MDMwNw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404680307", "bodyText": "it raises an exception", "author": "karesti", "createdAt": "2020-04-07T09:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0OTM3NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404849374", "bodyText": "Are you sure? The code looks exactly the same to me.", "author": "danberindei", "createdAt": "2020-04-07T14:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1Nzg4Ng==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404857886", "bodyText": "new File(configuration.configurationFile()) -> raises exception for the file when it is in the jar", "author": "karesti", "createdAt": "2020-04-07T14:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1ODA4OA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404858088", "bodyText": "but the code can be refactored for sure to avoid duplication", "author": "karesti", "createdAt": "2020-04-07T14:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg5MDUyNA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404890524", "bodyText": "It shouldn't get to new File(configuration.configurationFile()), because new File(configuration.configurationFile()).isAbsolute() should be false.\nBTW how are you testing this?", "author": "danberindei", "createdAt": "2020-04-07T15:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0NDY1OQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r405144659", "bodyText": "in the playground project for now of tristan", "author": "karesti", "createdAt": "2020-04-07T22:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NTU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NzM1MA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404667350", "bodyText": "Here you're only copying the configuration file. What happens with the other files the server needs, like log4j2.xml?", "author": "danberindei", "createdAt": "2020-04-07T09:27:41Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractInfinispanServerDriver.java", "diffHunk": "@@ -84,22 +91,32 @@ public void prepare(String name) {\n          throw new RuntimeException(\"Failed to create server configuration directory \" + confDir);\n       }\n       URL configurationFileURL;\n-      if (new File(configuration.configurationFile()).isAbsolute()) {\n+      if (DEFAULT_INFINISPAN_CONFIG_FILES.contains(configuration.configurationFile())) {\n+         configurationFileURL = getClass().getClassLoader().getResource(configuration.configurationFile());\n+      } else if (new File(configuration.configurationFile()).isAbsolute()) {\n          configurationFileURL = Exceptions.unchecked(() -> new File(configuration.configurationFile()).toURI().toURL());\n       } else {\n          configurationFileURL = getClass().getClassLoader().getResource(configuration.configurationFile());\n       }\n       if (configurationFileURL == null) {\n          throw new RuntimeException(\"Cannot find test configuration file: \" + configuration.configurationFile());\n       }\n-      Path configurationFilePath;\n+\n       try {\n-         configurationFilePath = Paths.get(configurationFileURL.toURI());\n-         // Recursively copy the contents of the directory containing the configuration file to the test target\n-         Util.recursiveDirectoryCopy(configurationFilePath.getParent(), confDir.toPath());\n+         if (DEFAULT_INFINISPAN_CONFIG_FILES.contains(configuration.configurationFile())) {", "originalCommit": "4b28e4018d01b485e9a562018d17eee8cea5bd73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3Mjk4NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404672984", "bodyText": "IMO we should add a constructor without any parameters that uses the default server configuration.\nOtherwise users that write their own custom server configuration and name it infinispan.xml could accidentally run some code that is meant to run without a custom server configuration.", "author": "danberindei", "createdAt": "2020-04-07T09:36:36Z", "path": "server/testdriver/junit4/src/main/java/org/infinispan/server/test/junit4/InfinispanServerRuleBuilder.java", "diffHunk": "@@ -24,6 +25,18 @@\n    private boolean jmx;\n    private boolean parallelStartup = true;\n \n+   /**\n+    * Use this method to instantiate a single clustered embedded server\n+    *\n+    * @return InfinispanServerRule\n+    */\n+   public static InfinispanServerRule standalone() {\n+      return new InfinispanServerRuleBuilder(DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME)", "originalCommit": "4b28e4018d01b485e9a562018d17eee8cea5bd73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NzExNg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r404857116", "bodyText": "s/standalone()/server()/", "author": "tristantarrant", "createdAt": "2020-04-07T14:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3Mjk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAyMTY2NQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r406021665", "bodyText": "oki", "author": "karesti", "createdAt": "2020-04-09T07:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3Mjk4NA=="}], "type": "inlineReview"}, {"oid": "5d10f5af6c2457e49e82c98e70e5ff26534b1bd4", "url": "https://github.com/infinispan/infinispan/commit/5d10f5af6c2457e49e82c98e70e5ff26534b1bd4", "message": "ISPN-11505 add config for standalone embedded server", "committedDate": "2020-04-10T09:29:40Z", "type": "forcePushed"}, {"oid": "bfdb5ceba1771990dfbba1bc855b200211c9a2e0", "url": "https://github.com/infinispan/infinispan/commit/bfdb5ceba1771990dfbba1bc855b200211c9a2e0", "message": "ISPN-11505 add config for standalone embedded server", "committedDate": "2020-04-10T09:57:02Z", "type": "forcePushed"}, {"oid": "c8f01358e3bc7cb625d25e5a231307ea2fa060cc", "url": "https://github.com/infinispan/infinispan/commit/c8f01358e3bc7cb625d25e5a231307ea2fa060cc", "message": "ISPN-11600 JUnit5 Extension", "committedDate": "2020-04-17T12:29:59Z", "type": "forcePushed"}, {"oid": "03b9ae9e2ea2c03261997d92f06f0e364cac201a", "url": "https://github.com/infinispan/infinispan/commit/03b9ae9e2ea2c03261997d92f06f0e364cac201a", "message": "ISPN-11600 JUnit5 Extension", "committedDate": "2020-04-17T12:33:04Z", "type": "forcePushed"}, {"oid": "761da10f485e6217e4ece68aa2a34e20b01dece8", "url": "https://github.com/infinispan/infinispan/commit/761da10f485e6217e4ece68aa2a34e20b01dece8", "message": "ISPN-11600 Run JUnit 5 server driver tests with JUnit 5\n\n* Copy the maven-surefire-plugin from one of the JUnit modules\n* Replace provider surefire-junit47 with surefire-junit-platform\n* Add junit-jupiter-engine dependency\n* Set scope of JUnit dependencies in parent POM to test\n* Remove TestNG dependency\n* Remove Infinispan core compile dependency in server parent", "committedDate": "2020-04-24T14:11:44Z", "type": "forcePushed"}, {"oid": "426498d5113bd72f31d8d6aa14eb6d5f8ad829d9", "url": "https://github.com/infinispan/infinispan/commit/426498d5113bd72f31d8d6aa14eb6d5f8ad829d9", "message": "ISPN-11600 Fixes compilation issues in the extension and rule", "committedDate": "2020-04-24T16:54:28Z", "type": "forcePushed"}, {"oid": "02fc9c5f8e41154cf94458b501deeda3c53be005", "url": "https://github.com/infinispan/infinispan/commit/02fc9c5f8e41154cf94458b501deeda3c53be005", "message": "ISPN-11600 Run JUnit 5 server driver tests with JUnit 5\n\n* Copy the maven-surefire-plugin from one of the JUnit modules\n* Replace provider surefire-junit47 with surefire-junit-platform\n* Add junit-jupiter-engine dependency\n* Set scope of JUnit dependencies in parent POM to test\n* Remove TestNG dependency\n* Remove Infinispan core compile dependency in server parent", "committedDate": "2020-04-29T13:55:22Z", "type": "forcePushed"}, {"oid": "b8a26923718d3aae7846c38ffd44a952aec3afff", "url": "https://github.com/infinispan/infinispan/commit/b8a26923718d3aae7846c38ffd44a952aec3afff", "message": "ISPN-11505 Add Junit 4 test\n* Containe mode\n* Standalone server", "committedDate": "2020-04-29T23:55:11Z", "type": "forcePushed"}, {"oid": "b329187d37693768ccbf3ecf95915cff78837d7c", "url": "https://github.com/infinispan/infinispan/commit/b329187d37693768ccbf3ecf95915cff78837d7c", "message": "ISPN-11505 Add Junit 4 test\n* Containe mode\n* Standalone server\n* Rm de copy resource for embedded default", "committedDate": "2020-05-01T12:41:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3ODA1Mw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r416578053", "bodyText": "Missing description, author, wrong version", "author": "danberindei", "createdAt": "2020-04-28T12:38:34Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/Base.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.infinispan.server.test.core;\n+\n+import org.infinispan.commons.api.CacheContainerAdmin;\n+import org.infinispan.commons.configuration.BasicConfiguration;\n+import org.infinispan.commons.configuration.Self;\n+import org.infinispan.commons.configuration.XMLStringConfiguration;\n+import org.infinispan.configuration.cache.CacheMode;\n+\n+import java.util.EnumSet;\n+\n+/**\n+ * @since 10", "originalCommit": "8c14541ac1dd7eaf0c12ffb30e3b4748e5100a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NTY1Mg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418945652", "bodyText": "the version is ok\nthe author is tristan and description was missing. this already existed Dan. but I'm going to improve it in the next commit", "author": "karesti", "createdAt": "2020-05-02T11:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3ODA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNjk3NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418526974", "bodyText": "Name seems too short to me, what is it a base for?\nSame with the subclasses, HotRod and Rest.", "author": "danberindei", "createdAt": "2020-05-01T12:47:46Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/Base.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.infinispan.server.test.core;\n+\n+import org.infinispan.commons.api.CacheContainerAdmin;\n+import org.infinispan.commons.configuration.BasicConfiguration;\n+import org.infinispan.commons.configuration.Self;\n+import org.infinispan.commons.configuration.XMLStringConfiguration;\n+import org.infinispan.configuration.cache.CacheMode;\n+\n+import java.util.EnumSet;\n+\n+/**\n+ * @since 10\n+ * @param <S>\n+ */\n+public abstract class Base<S extends Base<S>> implements Self<S> {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjM4Nw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418936387", "bodyText": "These classes, Base, HotRod and Rest classes already existed, as inner classes inside the Junit 4 method Rule. I just moved them out to make them reusable across junit 4 and junit 5.\nBut I'm going to refactor the names in an additional commit now", "author": "karesti", "createdAt": "2020-05-02T09:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNjk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNzQxMg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418527412", "bodyText": "IMO getContainer(int i) matches createContainer(int i) better.", "author": "danberindei", "createdAt": "2020-05-01T12:49:23Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -218,6 +218,13 @@ protected void start(String name, File rootDir, String configurationFile) {\n       }\n    }\n \n+   public InfinispanGenericContainer getSingleContainer(int i) {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NTczMw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418945733", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T11:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNzQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NTk5OQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418545999", "bodyText": "Is this still necessary?", "author": "danberindei", "createdAt": "2020-05-01T13:42:55Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractInfinispanServerDriver.java", "diffHunk": "@@ -39,6 +39,8 @@\n  * @since 10.0\n  **/\n public abstract class AbstractInfinispanServerDriver implements InfinispanServerDriver {\n+   public static final String DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME = \"infinispan.xml\";", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0Njk1MA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946950", "bodyText": "yes", "author": "karesti", "createdAt": "2020-05-02T11:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NTk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NjMxMw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418546313", "bodyText": "Will defaultFile ever be true?", "author": "danberindei", "createdAt": "2020-05-01T13:43:37Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/InfinispanServerTestConfiguration.java", "diffHunk": "@@ -18,10 +18,11 @@\n    private final JavaArchive[] archives;\n    private final boolean jmx;\n    private final boolean parallelStartup;\n+   private boolean defaultFile;\n \n    public InfinispanServerTestConfiguration(String configurationFile, int numServers, ServerRunMode runMode,\n                                             Properties properties, String[] mavenArtifacts, JavaArchive[] archives,\n-                                            boolean jmx, boolean parallelStartup) {\n+                                            boolean jmx, boolean parallelStartup, boolean defaultFile) {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjM0Mw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946343", "bodyText": "yes. in container mode. we don't copy anything to the container run that way", "author": "karesti", "createdAt": "2020-05-02T11:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NjMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NzAwNg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418547006", "bodyText": "Missing javadoc", "author": "danberindei", "createdAt": "2020-05-01T13:45:21Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/TestClient.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.infinispan.server.test.core;\n+\n+import net.spy.memcached.MemcachedClient;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.RemoteCounterManagerFactory;\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.configuration.RestClientConfigurationBuilder;\n+import org.infinispan.commons.test.CommonsTestingUtil;\n+import org.infinispan.commons.util.Util;\n+import org.infinispan.counter.api.CounterManager;\n+import org.infinispan.scripting.ScriptingManager;\n+\n+import java.io.Closeable;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class TestClient {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjI3Mg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946272", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T11:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NzAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NzM0OQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418547349", "bodyText": "Shouldn't this be a method in HotRod?", "author": "danberindei", "createdAt": "2020-05-01T13:46:11Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/TestClient.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.infinispan.server.test.core;\n+\n+import net.spy.memcached.MemcachedClient;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.RemoteCounterManagerFactory;\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.configuration.RestClientConfigurationBuilder;\n+import org.infinispan.commons.test.CommonsTestingUtil;\n+import org.infinispan.commons.util.Util;\n+import org.infinispan.counter.api.CounterManager;\n+import org.infinispan.scripting.ScriptingManager;\n+\n+import java.io.Closeable;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class TestClient {\n+   protected InfinispanServerTestConfiguration configuration;\n+   protected TestServer testServer;\n+   protected List<Closeable> resources;\n+   private String methodName;\n+\n+   public TestClient(TestServer testServer) {\n+      this.testServer = testServer;\n+   }\n+\n+   public <T extends Closeable> T registerResource(T resource) {\n+      resources.add(resource);\n+      return resource;\n+   }\n+\n+   public InfinispanServerDriver getServerDriver() {\n+      if (!testServer.isDriverInitialized()) {\n+         throw new IllegalStateException(\"Operation not supported before test starts\");\n+      }\n+      return testServer.getDriver();\n+   }\n+\n+   public HotRod hotrod() {\n+      return new HotRod(testServer, this);\n+   }\n+\n+   public Rest rest() {\n+      return new Rest(testServer, this);\n+   }\n+\n+   public CounterManager getCounterManager() {\n+      RemoteCacheManager remoteCacheManager = registerResource(testServer.newHotRodClient());\n+      return RemoteCounterManagerFactory.asCounterManager(remoteCacheManager);\n+   }\n+\n+\n+   public void setMethodName(String methodName) {\n+      this.methodName = methodName;\n+   }\n+\n+   public void clearResources() {\n+      if (resources != null) {\n+         resources.forEach(Util::close);\n+         resources.clear();\n+      }\n+   }\n+\n+   public void initResources() {\n+      resources = new ArrayList<>();\n+   }\n+\n+   public String addScript(RemoteCacheManager remoteCacheManager, String script) {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NTkxNw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418945917", "bodyText": "possibly, yes. I kept things as untouched as possible in the test suite.\nAgain, this classes and methods already existed\nI will try to refactor in another commit", "author": "karesti", "createdAt": "2020-05-02T11:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0NzM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODE3MA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418548170", "bodyText": "Not sure we should expose this one.", "author": "danberindei", "createdAt": "2020-05-01T13:48:13Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/TestClient.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.infinispan.server.test.core;\n+\n+import net.spy.memcached.MemcachedClient;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.RemoteCounterManagerFactory;\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.configuration.RestClientConfigurationBuilder;\n+import org.infinispan.commons.test.CommonsTestingUtil;\n+import org.infinispan.commons.util.Util;\n+import org.infinispan.counter.api.CounterManager;\n+import org.infinispan.scripting.ScriptingManager;\n+\n+import java.io.Closeable;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class TestClient {\n+   protected InfinispanServerTestConfiguration configuration;\n+   protected TestServer testServer;\n+   protected List<Closeable> resources;\n+   private String methodName;\n+\n+   public TestClient(TestServer testServer) {\n+      this.testServer = testServer;\n+   }\n+\n+   public <T extends Closeable> T registerResource(T resource) {\n+      resources.add(resource);\n+      return resource;\n+   }\n+\n+   public InfinispanServerDriver getServerDriver() {\n+      if (!testServer.isDriverInitialized()) {\n+         throw new IllegalStateException(\"Operation not supported before test starts\");\n+      }\n+      return testServer.getDriver();\n+   }\n+\n+   public HotRod hotrod() {\n+      return new HotRod(testServer, this);\n+   }\n+\n+   public Rest rest() {\n+      return new Rest(testServer, this);\n+   }\n+\n+   public CounterManager getCounterManager() {\n+      RemoteCacheManager remoteCacheManager = registerResource(testServer.newHotRodClient());\n+      return RemoteCounterManagerFactory.asCounterManager(remoteCacheManager);\n+   }\n+\n+\n+   public void setMethodName(String methodName) {\n+      this.methodName = methodName;\n+   }\n+\n+   public void clearResources() {\n+      if (resources != null) {\n+         resources.forEach(Util::close);\n+         resources.clear();\n+      }\n+   }\n+\n+   public void initResources() {\n+      resources = new ArrayList<>();\n+   }\n+\n+   public String addScript(RemoteCacheManager remoteCacheManager, String script) {\n+      RemoteCache<String, String> scriptCache = remoteCacheManager.getCache(ScriptingManager.SCRIPT_CACHE);\n+      try (InputStream in = this.getClass().getClassLoader().getResourceAsStream(script)) {\n+         scriptCache.put(getMethodName(), CommonsTestingUtil.loadFileAsString(in));\n+      } catch (Exception e) {\n+         throw new RuntimeException(e);\n+      }\n+      return getMethodName();\n+   }\n+\n+   public String getMethodName() {\n+      return getMethodName(null);\n+   }\n+\n+   public RestClient newRestClient(RestClientConfigurationBuilder restClientConfigurationBuilder) {\n+      RestClient restClient = testServer.newRestClient(restClientConfigurationBuilder);\n+      registerResource(restClient);\n+      return restClient;\n+   }\n+\n+   public String getMethodName(String qualifier) {\n+      String cacheName = \"C\" + methodName + (qualifier != null ? qualifier : \"\");\n+      try {\n+         MessageDigest sha1 = MessageDigest.getInstance(\"SHA-1\");\n+         byte[] digest = sha1.digest(cacheName.getBytes(StandardCharsets.UTF_8));\n+         return Util.toHexString(digest);\n+      } catch (NoSuchAlgorithmException e) {\n+         // Won't happen\n+         return null;\n+      }\n+   }\n+\n+   public MemcachedClient getMemcachedClient() {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjAwNQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946005", "bodyText": "again, this is the testsuite impact. I will refactor then", "author": "karesti", "createdAt": "2020-05-02T11:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODI2MA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418548260", "bodyText": "Missing javadoc", "author": "danberindei", "createdAt": "2020-05-01T13:48:24Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/TestServer.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package org.infinispan.server.test.core;\n+\n+import net.spy.memcached.MemcachedClient;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.configuration.RestClientConfigurationBuilder;\n+import org.infinispan.commons.test.Exceptions;\n+import org.testcontainers.DockerClientFactory;\n+\n+import java.io.Closeable;\n+import java.io.File;\n+import java.net.InetSocketAddress;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+public class TestServer {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjAzMw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946033", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T11:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MDY0Mw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418550643", "bodyText": "Seems odd that newRestClient is in TestClient, but newHotRodClient() is only in TestServer.", "author": "danberindei", "createdAt": "2020-05-01T13:54:11Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/TestClient.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package org.infinispan.server.test.core;\n+\n+import net.spy.memcached.MemcachedClient;\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.RemoteCounterManagerFactory;\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.configuration.RestClientConfigurationBuilder;\n+import org.infinispan.commons.test.CommonsTestingUtil;\n+import org.infinispan.commons.util.Util;\n+import org.infinispan.counter.api.CounterManager;\n+import org.infinispan.scripting.ScriptingManager;\n+\n+import java.io.Closeable;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class TestClient {\n+   protected InfinispanServerTestConfiguration configuration;\n+   protected TestServer testServer;\n+   protected List<Closeable> resources;\n+   private String methodName;\n+\n+   public TestClient(TestServer testServer) {\n+      this.testServer = testServer;\n+   }\n+\n+   public <T extends Closeable> T registerResource(T resource) {\n+      resources.add(resource);\n+      return resource;\n+   }\n+\n+   public InfinispanServerDriver getServerDriver() {\n+      if (!testServer.isDriverInitialized()) {\n+         throw new IllegalStateException(\"Operation not supported before test starts\");\n+      }\n+      return testServer.getDriver();\n+   }\n+\n+   public HotRod hotrod() {\n+      return new HotRod(testServer, this);\n+   }\n+\n+   public Rest rest() {\n+      return new Rest(testServer, this);\n+   }\n+\n+   public CounterManager getCounterManager() {\n+      RemoteCacheManager remoteCacheManager = registerResource(testServer.newHotRodClient());\n+      return RemoteCounterManagerFactory.asCounterManager(remoteCacheManager);\n+   }\n+\n+\n+   public void setMethodName(String methodName) {\n+      this.methodName = methodName;\n+   }\n+\n+   public void clearResources() {\n+      if (resources != null) {\n+         resources.forEach(Util::close);\n+         resources.clear();\n+      }\n+   }\n+\n+   public void initResources() {\n+      resources = new ArrayList<>();\n+   }\n+\n+   public String addScript(RemoteCacheManager remoteCacheManager, String script) {\n+      RemoteCache<String, String> scriptCache = remoteCacheManager.getCache(ScriptingManager.SCRIPT_CACHE);\n+      try (InputStream in = this.getClass().getClassLoader().getResourceAsStream(script)) {\n+         scriptCache.put(getMethodName(), CommonsTestingUtil.loadFileAsString(in));\n+      } catch (Exception e) {\n+         throw new RuntimeException(e);\n+      }\n+      return getMethodName();\n+   }\n+\n+   public String getMethodName() {\n+      return getMethodName(null);\n+   }\n+\n+   public RestClient newRestClient(RestClientConfigurationBuilder restClientConfigurationBuilder) {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NTkzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418945935", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T11:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MDY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MjM3NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418552374", "bodyText": "To me the name get() suggests that the method returns the same RemoteCache instance, so it's surprising that it creates a new RemoteCacheManager instance every time.", "author": "danberindei", "createdAt": "2020-05-01T13:58:11Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/HotRod.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.infinispan.server.test.core;\n+\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.configuration.cache.CacheMode;\n+\n+/**\n+ * @since 10\n+ */\n+public class HotRod extends Base<HotRod> {\n+   private final TestServer testServer;\n+   private final TestClient testClient;\n+   ConfigurationBuilder clientConfiguration = new ConfigurationBuilder();\n+\n+   public HotRod(TestServer testServer, TestClient testClient) {\n+      this.testServer = testServer;\n+      this.testClient = testClient;\n+   }\n+\n+   public HotRod withClientConfiguration(ConfigurationBuilder clientConfiguration) {\n+      this.clientConfiguration = clientConfiguration;\n+      return this;\n+   }\n+\n+   public <K, V> RemoteCache<K, V> get() {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjQ0OQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946449", "bodyText": "I will review this, but this impacts all our test suite. I just moved code around. not sure I should change this in this PR though.", "author": "karesti", "createdAt": "2020-05-02T11:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MjM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MzIyOA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418553228", "bodyText": "create also seems ambiguous to me, it doesn't say it's creating the cache on the server, so it could be interpreted as \"create the RemoteCache instance so that get() can use it\".", "author": "danberindei", "createdAt": "2020-05-01T14:00:13Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/HotRod.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.infinispan.server.test.core;\n+\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.configuration.cache.CacheMode;\n+\n+/**\n+ * @since 10\n+ */\n+public class HotRod extends Base<HotRod> {\n+   private final TestServer testServer;\n+   private final TestClient testClient;\n+   ConfigurationBuilder clientConfiguration = new ConfigurationBuilder();\n+\n+   public HotRod(TestServer testServer, TestClient testClient) {\n+      this.testServer = testServer;\n+      this.testClient = testClient;\n+   }\n+\n+   public HotRod withClientConfiguration(ConfigurationBuilder clientConfiguration) {\n+      this.clientConfiguration = clientConfiguration;\n+      return this;\n+   }\n+\n+   public <K, V> RemoteCache<K, V> get() {\n+      RemoteCacheManager remoteCacheManager = testClient.registerResource(testServer.newHotRodClient(clientConfiguration));\n+      String name = testClient.getMethodName(qualifier);\n+      return remoteCacheManager.getCache(name);\n+   }\n+\n+   public <K, V> RemoteCache<K, V> create() {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NTg0NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418945844", "bodyText": "again, all this already existed", "author": "karesti", "createdAt": "2020-05-02T11:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1MzIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NjIzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418556235", "bodyText": "I suggest AbstractTestServerBuilder, because it creates a TestServer instance. Although TestServer isn't just one server either, it's a cluster, so maybe AbstractTestClusterBuilder?", "author": "danberindei", "createdAt": "2020-05-01T14:07:38Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/AbstractServerConfigBuilder.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package org.infinispan.server.test.core;\n+\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+\n+import java.util.Properties;\n+\n+/**\n+ * Common code for JUnit 4 and Junit 5 Extension\n+ *\n+ * @param <T> type of builder\n+ * @author Katia Aresti\n+ * @since 11\n+ */\n+public abstract class AbstractServerConfigBuilder<T> {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjY5OQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946699", "bodyText": "I don't agree. The Rule is called \"InfinispanServerRuleBuilder\" not \"InfinispanClusterRuleBuilder\". This builder emerged up to reuse the same type of build for the InfinispanServerExtension and InfinispanServerRule.\nThe InfinispanServer is either a cluster or a standalone server.", "author": "karesti", "createdAt": "2020-05-02T11:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NjIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NzM4NQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418557385", "bodyText": "Wrong indent, and the previous line should be wrapped", "author": "danberindei", "createdAt": "2020-05-01T14:10:22Z", "path": "server/testdriver/junit4/src/test/java/InfinispanRuleBasicTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.configuration.ClientIntelligence;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.configuration.cache.CacheMode;\n+import org.infinispan.server.test.junit4.InfinispanServerRule;\n+import org.infinispan.server.test.junit4.InfinispanServerRuleBuilder;\n+import org.infinispan.server.test.junit4.InfinispanServerTestMethodRule;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class InfinispanRuleBasicTest {\n+   @ClassRule\n+   public static final InfinispanServerRule SERVER = InfinispanServerRuleBuilder.server();\n+\n+   @Rule\n+   public InfinispanServerTestMethodRule SERVER_TEST = new InfinispanServerTestMethodRule(SERVER);\n+\n+   @Test\n+   public void testSingleServer() {\n+      ConfigurationBuilder builder = new ConfigurationBuilder();\n+      builder.clientIntelligence(ClientIntelligence.BASIC);\n+      RemoteCache<String, String> cache = SERVER_TEST.hotrod().withClientConfiguration(builder).withCacheMode(CacheMode.DIST_SYNC).create();\n+            cache.put(\"k1\", \"v1\");", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjUzMw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418936533", "bodyText": "oki", "author": "karesti", "createdAt": "2020-05-02T09:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NzM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODEzOQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418558139", "bodyText": "Missing javadoc", "author": "danberindei", "createdAt": "2020-05-01T14:12:07Z", "path": "server/testdriver/junit5/src/main/java/org/infinispan/server/test/junit5/InfinispanServerExtension.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.infinispan.server.test.junit5;\n+\n+import org.infinispan.server.test.core.InfinispanServerTestConfiguration;\n+import org.infinispan.server.test.core.TestClient;\n+import org.infinispan.server.test.core.TestServer;\n+import org.junit.jupiter.api.extension.AfterAllCallback;\n+import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+public class InfinispanServerExtension implements", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjQzNg==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418936436", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T09:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjA3NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946074", "bodyText": "ok", "author": "karesti", "createdAt": "2020-05-02T11:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1ODEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MTk5MA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418561990", "bodyText": "Is the container parameter still needed?\nWe also need a test to make sure it works, there is no usage ATM.", "author": "danberindei", "createdAt": "2020-05-01T14:21:02Z", "path": "server/testdriver/junit5/src/main/java/org/infinispan/server/test/junit5/InfispanServerExtensionBuilder.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.infinispan.server.test.junit5;\n+\n+import org.infinispan.server.test.core.AbstractServerConfigBuilder;\n+import org.infinispan.server.test.core.ServerRunMode;\n+\n+import static org.infinispan.server.test.core.AbstractInfinispanServerDriver.DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME;\n+\n+/**\n+ * Infinispan Server Extension Builder\n+ *\n+ * @author Katia Aresti\n+ * @since 11\n+ */\n+public class InfispanServerExtensionBuilder extends AbstractServerConfigBuilder<InfispanServerExtensionBuilder> {\n+   /**\n+    * Use this method to instantiate a single clustered embedded server\n+    *\n+    * @return InfinispanServerExtension\n+    */\n+   public static InfinispanServerExtension server() {\n+      return server(true);\n+   }\n+\n+   public static InfinispanServerExtension server(boolean container) {", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0NjEwMA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418946100", "bodyText": "adding a test", "author": "karesti", "createdAt": "2020-05-02T11:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MjcwMw==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418562703", "bodyText": "Shouldn't we have more info about how to use the extension, or at least a @see InfinispanServerExtension?", "author": "danberindei", "createdAt": "2020-05-01T14:22:41Z", "path": "server/testdriver/junit5/src/main/java/org/infinispan/server/test/junit5/InfispanServerExtensionBuilder.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.infinispan.server.test.junit5;\n+\n+import org.infinispan.server.test.core.AbstractServerConfigBuilder;\n+import org.infinispan.server.test.core.ServerRunMode;\n+\n+import static org.infinispan.server.test.core.AbstractInfinispanServerDriver.DEFAULT_CLUSTERED_INFINISPAN_CONFIG_FILE_NAME;\n+\n+/**\n+ * Infinispan Server Extension Builder", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY0Mzg2OA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418643868", "bodyText": "Dan,  possibly, but not in this PR please. I can create a JIRA to document and improve after this gets in.", "author": "karesti", "createdAt": "2020-05-01T17:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MjcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjQ5NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418936494", "bodyText": "ok for the javadoc in the other file", "author": "karesti", "createdAt": "2020-05-02T09:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MjcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MjgwMQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418562801", "bodyText": "Wrong indent", "author": "danberindei", "createdAt": "2020-05-01T14:22:58Z", "path": "server/testdriver/junit5/src/test/java/org/infinispan/server/test/junit5/InfinispanServerExtensionTest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package org.infinispan.server.test.junit5;\n+\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.configuration.ClientIntelligence;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.configuration.cache.CacheMode;\n+import org.infinispan.server.test.core.ServerRunMode;\n+import org.infinispan.server.test.core.TestClient;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class InfinispanServerExtensionTest {\n+\n+   @RegisterExtension\n+   static InfinispanServerExtension SERVER = InfispanServerExtensionBuilder.config(\"infinispan.xml\")\n+         .numServers(1)\n+         .runMode(ServerRunMode.EMBEDDED)\n+         .build();\n+\n+   @Test\n+   public void testSingleServer() {\n+      ConfigurationBuilder builder = new ConfigurationBuilder();\n+      builder.clientIntelligence(ClientIntelligence.BASIC);\n+      TestClient client = SERVER.client();\n+      RemoteCache<String, String> cache = client.hotrod().withClientConfiguration(builder).withCacheMode(CacheMode.DIST_SYNC).create();\n+            cache.put(\"k1\", \"v1\");", "originalCommit": "b329187d37693768ccbf3ecf95915cff78837d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjUxMA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r418936510", "bodyText": "oki", "author": "karesti", "createdAt": "2020-05-02T09:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU2MjgwMQ=="}], "type": "inlineReview"}, {"oid": "2ba278de5f04af2865d7828f6af06dfc6e659f2c", "url": "https://github.com/infinispan/infinispan/commit/2ba278de5f04af2865d7828f6af06dfc6e659f2c", "message": "ISPN-11505 Docs and API encapsulation\n* TestClientDriver interface\n* Javadocs\n* Memcache client only exposed in JUnit 4 rule\n* junit and junit5 maven properties renamed\n* Clean some unused methods\n* Add a standalone container test in junit5 module", "committedDate": "2020-05-02T13:09:30Z", "type": "forcePushed"}, {"oid": "6af8060f53d96c059fafe312da8e83f5e257b8f5", "url": "https://github.com/infinispan/infinispan/commit/6af8060f53d96c059fafe312da8e83f5e257b8f5", "message": "ISPN-11505 Docs and API encapsulation\n* TestClientDriver interface\n* Javadocs\n* Memcache client only exposed in JUnit 4 rule\n* junit and junit5 maven properties renamed\n* Clean some unused methods\n* Add a standalone container test in junit5 module", "committedDate": "2020-05-02T22:30:16Z", "type": "forcePushed"}, {"oid": "c3c6c38385e47df65d8ed99648c393dd7553ce4a", "url": "https://github.com/infinispan/infinispan/commit/c3c6c38385e47df65d8ed99648c393dd7553ce4a", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-06T13:54:19Z", "type": "forcePushed"}, {"oid": "970304e214eabca5dfc3890fd7999d7bde44f9f4", "url": "https://github.com/infinispan/infinispan/commit/970304e214eabca5dfc3890fd7999d7bde44f9f4", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-06T14:08:20Z", "type": "forcePushed"}, {"oid": "eb10384a9a78dcc6e671f99ce550da901dac081b", "url": "https://github.com/infinispan/infinispan/commit/eb10384a9a78dcc6e671f99ce550da901dac081b", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-07T09:30:19Z", "type": "forcePushed"}, {"oid": "147ce8843a23d612db9d1594ec3dab819e84f14f", "url": "https://github.com/infinispan/infinispan/commit/147ce8843a23d612db9d1594ec3dab819e84f14f", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-07T12:56:18Z", "type": "forcePushed"}, {"oid": "8ae23f88540d921e88a91b3b4af3226fbf7ebd8d", "url": "https://github.com/infinispan/infinispan/commit/8ae23f88540d921e88a91b3b4af3226fbf7ebd8d", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-08T14:18:33Z", "type": "commit"}, {"oid": "8ae23f88540d921e88a91b3b4af3226fbf7ebd8d", "url": "https://github.com/infinispan/infinispan/commit/8ae23f88540d921e88a91b3b4af3226fbf7ebd8d", "message": "ISPN-11599 JUnit 5 Server Extension\n\n* ISPN-11505 Standalone server() method in Rule and Extension\n* ISPN-11600 JUnit 5 extension\n* ISPN-11444 JUnit 5 Upgrade. JUnit 5 server driver tests with JUnit 5\n    * Copy the maven-surefire-plugin from one of the JUnit modules\n    * Replace provider surefire-junit47 with surefire-junit-platform\n    * Add junit-jupiter-engine dependency\n    * Set scope of JUnit dependencies in parent POM to test\n    * Remove TestNG dependency\n    * Remove Infinispan core compile dependency in server parent", "committedDate": "2020-05-08T14:18:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzODgzOA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r422238838", "bodyText": "AFAICT AbstractInfinispanServerDriver.createUserFile runs with a non-default configuration just as well as with the default configuration, so this check isn't necessary.\nIn general I would prefer a method like isContainerRunWithDefaultServerConfig() to return true only if running with the default configuration that ships in the server image, not a configuration file that ships in the testdriver jar.", "author": "danberindei", "createdAt": "2020-05-08T16:25:19Z", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/api/HotRodTestClientDriver.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package org.infinispan.server.test.api;\n+\n+import org.infinispan.client.hotrod.RemoteCache;\n+import org.infinispan.client.hotrod.RemoteCacheManager;\n+import org.infinispan.client.hotrod.configuration.ClientIntelligence;\n+import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\n+import org.infinispan.configuration.cache.CacheMode;\n+import org.infinispan.server.test.core.TestClient;\n+import org.infinispan.server.test.core.TestServer;\n+\n+/**\n+ *  REST operations for the testing framework\n+ *\n+ * @author Tristan Tarrant\n+ * @since 10\n+ */\n+public class HotRodTestClientDriver extends BaseTestClientDriver<HotRodTestClientDriver> {\n+   private final TestServer testServer;\n+   private final TestClient testClient;\n+   ConfigurationBuilder clientConfiguration;\n+\n+   public HotRodTestClientDriver(TestServer testServer, TestClient testClient) {\n+      this.testServer = testServer;\n+      this.testClient = testClient;\n+\n+      ConfigurationBuilder builder = new ConfigurationBuilder();\n+      if(testServer.isContainerRunWithDefaultServerConfig()) {", "originalCommit": "8ae23f88540d921e88a91b3b4af3226fbf7ebd8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1MTU5NA==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r422251594", "bodyText": "it is necessary since I only want to add this configuration for container mode and when the default file is requested (which is secured). Otherwise, users need to concern too early about security. But I don't want to make this in embedded since default config files stuff are not supported yet, and there are XML files that are not secured in our tests. So if I add a user admin, I get hard error because the server is not secured in the test but I try to connect with a user. (check the other runs errors)\nI don't know how to make this better for now.", "author": "karesti", "createdAt": "2020-05-08T16:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzODgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwNDE2NQ==", "url": "https://github.com/infinispan/infinispan/pull/8173#discussion_r422904165", "bodyText": "Thanks for the explanation Katia, I thought that the users were added for every configuration.", "author": "danberindei", "createdAt": "2020-05-11T09:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzODgzOA=="}], "type": "inlineReview"}]}