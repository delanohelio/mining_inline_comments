{"pr_number": 7878, "pr_title": "ISPN-11316 Split XSiteStateTransferControlCommand into individual com\u2026", "pr_createdAt": "2020-02-12T15:40:55Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7878", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MDY5MQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378780691", "bodyText": "this method should be abstract. Not all commands go through handleStateTransferControl() method.", "author": "pruivo", "createdAt": "2020-02-13T10:41:33Z", "path": "core/src/main/java/org/infinispan/xsite/XSiteReplicateCommand.java", "diffHunk": "@@ -11,15 +12,36 @@\n  * @author Pedro Ruivo\n  * @since 7.0\n  */\n-public abstract class XSiteReplicateCommand extends BaseRpcCommand {\n+public abstract class XSiteReplicateCommand implements CacheRpcCommand {\n \n-   private String originSite;\n+   private final byte commandId;\n+   protected ByteString cacheName;\n+   private Address origin;\n+   protected String originSite;\n \n-   protected XSiteReplicateCommand(ByteString cacheName) {\n-      super(cacheName);\n+   protected XSiteReplicateCommand(byte commandId, ByteString cacheName) {\n+      this.commandId = commandId;\n+      this.cacheName = cacheName;\n    }\n \n-   public abstract CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder);\n+   @Override\n+   public boolean isReturnValueExpected() {\n+      return false;\n+   }\n+\n+   @Override\n+   public byte getCommandId() {\n+      return commandId;\n+   }\n+\n+   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n+      assert !preserveOrder;\n+      return receiver.handleStateTransferControl(this);", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTEzNg==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781136", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "author": "pruivo", "createdAt": "2020-02-13T10:42:26Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteAmendOfflineStatusCommand.java", "diffHunk": "@@ -5,21 +5,21 @@\n import java.io.ObjectOutput;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.util.concurrent.CompletableFutures;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Amend a sites offline status.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteAmendOfflineStatusCommand extends BaseRpcCommand {\n+public class XSiteAmendOfflineStatusCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTI2NQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781265", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "author": "pruivo", "createdAt": "2020-02-13T10:42:40Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteBringOnlineCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Take a site offline.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteBringOnlineCommand extends BaseRpcCommand {\n+public class XSiteBringOnlineCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTM2Ng==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781366", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "author": "pruivo", "createdAt": "2020-02-13T10:42:50Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteOfflineStatusCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Get the offline status of a {@link BackupSender}.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteOfflineStatusCommand extends BaseRpcCommand {\n+public class XSiteOfflineStatusCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4OTgzOA==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378789838", "bodyText": "After this refactor. this command is only invoked in the local site. It can extend BaseRpcCommand (or implement CacheRpcCommand directly).", "author": "pruivo", "createdAt": "2020-02-13T10:57:58Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferCancelSendCommand.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Cancel sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferCancelSendCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MDI3OQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378790279", "bodyText": "Same as above. It is a local site only command.", "author": "pruivo", "createdAt": "2020-02-13T10:58:48Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferClearStatusCommand.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Clear XSite state transfer status.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferClearStatusCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5Mjk2OQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378792969", "bodyText": "This command is local site only. It doesn't need to extend XSiteReplicateCommand.", "author": "pruivo", "createdAt": "2020-02-13T11:04:23Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferFinishSendCommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Finish sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferFinishSendCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwNjIwMQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378806201", "bodyText": "I was trying to reduce the amount of duplication, but you're right extending XSiteReplicateCommand is not the way todo it.", "author": "ryanemerson", "createdAt": "2020-02-13T11:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5Mjk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MzE1NA==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378793154", "bodyText": "same as above.", "author": "pruivo", "createdAt": "2020-02-13T11:04:43Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferRestartSendingCommand.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Restart sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferRestartSendingCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NDExMw==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378794113", "bodyText": "local site only command.", "author": "pruivo", "createdAt": "2020-02-13T11:06:42Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStartSendCommand.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Start send XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferStartSendCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NTExNw==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378795117", "bodyText": "local only site.", "author": "pruivo", "createdAt": "2020-02-13T11:08:50Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStatusRequestCommand.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Get XSite state transfer status.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferStatusRequestCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjAyNQ==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796025", "bodyText": "can be reverted. the command never goes to the remote site.", "author": "pruivo", "createdAt": "2020-02-13T11:10:53Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStatusCommand.java", "diffHunk": "@@ -3,28 +3,28 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Return the status of a {@link BackupSender}.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteStatusCommand extends BaseRpcCommand {\n+public class XSiteStatusCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjExNg==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796116", "bodyText": "same here", "author": "pruivo", "createdAt": "2020-02-13T11:11:02Z", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteTakeOfflineCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Take a site offline.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteTakeOfflineCommand extends BaseRpcCommand {\n+public class XSiteTakeOfflineCommand extends XSiteReplicateCommand {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjQ0MA==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796440", "bodyText": "this cannot be deleted. Otherwise, the remote site never receives the state.", "author": "pruivo", "createdAt": "2020-02-13T11:11:40Z", "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStatePushCommand.java", "diffHunk": "@@ -25,23 +24,17 @@\n    private long timeoutMillis;\n \n    public XSiteStatePushCommand(ByteString cacheName, XSiteState[] chunk, long timeoutMillis) {\n-      super(cacheName);\n+      super(COMMAND_ID, cacheName);\n       this.chunk = chunk;\n       this.timeoutMillis = timeoutMillis;\n    }\n \n    public XSiteStatePushCommand(ByteString cacheName) {\n-      super(cacheName);\n-   }\n-\n-   @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NzM5Mg==", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378797392", "bodyText": "should be CacheRpcCommand as parameter.", "author": "pruivo", "createdAt": "2020-02-13T11:13:53Z", "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStateTransferManagerImpl.java", "diffHunk": "@@ -319,34 +328,33 @@ private void handleFailure(XSiteBackup xSiteBackup) {\n       }\n       siteCollector.remove(xSiteBackup.getSiteName());\n       try {\n-         controlStateTransferOnLocalSite(StateTransferControl.CANCEL_SEND, xSiteBackup.getSiteName());\n+         XSiteReplicateCommand command = commandsFactory.buildXSiteStateTransferCancelSendCommand(xSiteBackup.getSiteName());\n+         controlStateTransferOnLocalSite(command);\n       } catch (Exception e) {\n          if (debug) {\n             log.debugf(e, \"Exception while cancel sending to remote site %s\", xSiteBackup.getSiteName());\n          }\n       }\n       try {\n-         controlStateTransferOnRemoteSite(xSiteBackup, StateTransferControl.FINISH_RECEIVE, null);\n+         XSiteReplicateCommand command = commandsFactory.buildXSiteStateTransferFinishReceiveCommand(null);\n+         controlStateTransferOnRemoteSite(xSiteBackup, command, null);\n       } catch (Throwable throwable) {\n          if (debug) {\n             log.debugf(throwable, \"Exception while cancel receiving in remote site %s\", xSiteBackup.getSiteName());\n          }\n       }\n    }\n \n-   private void controlStateTransferOnRemoteSite(XSiteBackup xSiteBackup, StateTransferControl control,\n+   private void controlStateTransferOnRemoteSite(XSiteBackup xSiteBackup, XSiteReplicateCommand command,\n                                                  BackupRpcConfiguration backupRpcConfiguration) throws Throwable {\n-      XSiteStateTransferControlCommand command = commandsFactory.buildXSiteStateTransferControlCommand(control, null);\n       RetryPolicy retryPolicy = backupRpcConfiguration == null ? NO_RETRY :\n             new MaxRetriesPolicy(backupRpcConfiguration.maxRetries);\n       long waitTime = backupRpcConfiguration == null ? 1 : backupRpcConfiguration.waitTime;\n       RetryOnFailureXSiteCommand remoteSite = RetryOnFailureXSiteCommand.newInstance(xSiteBackup, command, retryPolicy);\n       remoteSite.execute(rpcManager, waitTime, TimeUnit.MILLISECONDS);\n    }\n \n-   private void controlStateTransferOnLocalSite(StateTransferControl control, String siteName) throws Exception {\n-      XSiteStateTransferControlCommand command = commandsFactory.buildXSiteStateTransferControlCommand(control, siteName);\n-      command.setTopologyId(currentTopologyId());\n+   private void controlStateTransferOnLocalSite(XSiteReplicateCommand command) throws Exception {", "originalCommit": "97ab010b86916f4796e5092f108576746cf3cb09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f78bb7bea890f3417eb30b431ae2680a11402f3", "url": "https://github.com/infinispan/infinispan/commit/2f78bb7bea890f3417eb30b431ae2680a11402f3", "message": "ISPN-11316 Split XSiteStateTransferControlCommand into individual commands", "committedDate": "2020-02-13T12:17:34Z", "type": "commit"}, {"oid": "2f78bb7bea890f3417eb30b431ae2680a11402f3", "url": "https://github.com/infinispan/infinispan/commit/2f78bb7bea890f3417eb30b431ae2680a11402f3", "message": "ISPN-11316 Split XSiteStateTransferControlCommand into individual commands", "committedDate": "2020-02-13T12:17:34Z", "type": "forcePushed"}]}