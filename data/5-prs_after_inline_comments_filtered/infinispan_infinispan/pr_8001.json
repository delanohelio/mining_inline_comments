{"pr_number": 8001, "pr_title": "ISPN-10539 Server loggers management", "pr_createdAt": "2020-03-05T13:19:23Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8001", "timeline": [{"oid": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "url": "https://github.com/infinispan/infinispan/commit/b4bbf5a3966fbc90a13b82880e250e6bba36335a", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-05T13:21:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMDY2NQ==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388330665", "bodyText": "unused?", "author": "pruivo", "createdAt": "2020-03-05T14:33:23Z", "path": "cli/cli-client/src/main/java/org/infinispan/cli/commands/CommandInputLine.java", "diffHunk": "@@ -80,6 +80,9 @@ public long longOption(String option) {\n    public boolean boolOption(String option) {\n       return (Boolean) options.get(option);\n    }\n+   public <T> T optionAs(String option) {", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY4ODY0Mw==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389688643", "bodyText": "Done", "author": "tristantarrant", "createdAt": "2020-03-09T13:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMDY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1MzI0Nw==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388353247", "bodyText": "why?", "author": "pruivo", "createdAt": "2020-03-05T15:06:43Z", "path": "cli/cli-client/src/main/java/org/infinispan/cli/connection/rest/RestConnection.java", "diffHunk": "@@ -361,7 +361,7 @@ public String execute(List<CommandInputLine> commands) throws IOException {\n                response = cache.get(command.arg(CliCommand.KEY));\n                break;\n             }\n-            case Ls.CMD: {\n+            case org.infinispan.cli.commands.Ls.CMD: {", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1NDgyMg==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388354822", "bodyText": "why in RestServerClient? Shouldn't the logging affect all nodes in the cluster?\nmaybe under RestClient or RestClusterClient?", "author": "pruivo", "createdAt": "2020-03-05T15:09:14Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/RestServerClient.java", "diffHunk": "@@ -36,4 +36,6 @@\n    CompletionStage<RestResponse> unIgnoreCache(String cacheManagerName, String cacheName);\n \n    CompletionStage<RestResponse> listIgnoredCaches(String cacheManagerName);\n+\n+   RestLoggingClient logging();", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1NTI0OA==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388355248", "bodyText": "isn't \"/loggers/\" missing?", "author": "pruivo", "createdAt": "2020-03-05T15:09:53Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestLoggingClientOkHttp.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.infinispan.client.rest.impl.okhttp;\n+\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.sanitize;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.client.rest.RestLoggingClient;\n+import org.infinispan.client.rest.RestResponse;\n+\n+import okhttp3.Request;\n+import okhttp3.internal.Util;\n+\n+/**\n+ * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n+ * @since 11.0\n+ **/\n+public class RestLoggingClientOkHttp implements RestLoggingClient {\n+\n+   private final RestClientOkHttp client;\n+   private final String baseLoggingURL;\n+\n+   RestLoggingClientOkHttp(RestClientOkHttp restClient) {\n+      this.client = restClient;\n+      this.baseLoggingURL = String.format(\"%s%s/v2/logging\", restClient.getBaseURL(), restClient.getConfiguration().contextPath());\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> listLoggers() {\n+      return client.execute(baseLoggingURL, \"loggers\");\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> listAppenders() {\n+      return client.execute(baseLoggingURL, \"appenders\");\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> setLogger(String name, String level, String... appenders) {\n+      Request.Builder builder = new Request.Builder();\n+      StringBuilder sb = new StringBuilder(baseLoggingURL);\n+      sb.append(\"/loggers/\").append(sanitize(name)).append(\"?\");\n+      boolean amp = false;\n+      if (level != null) {\n+         sb.append(\"level=\").append(level);\n+         amp = true;\n+      }\n+      if (appenders != null) {\n+         for(String appender : appenders) {\n+            if (amp) {\n+               sb.append(\"&\");\n+            }\n+            sb.append(\"appender=\").append(appender);\n+            amp = true;\n+         }\n+      }\n+      builder.url(sb.toString()).put(Util.EMPTY_REQUEST);\n+      return client.execute(builder);\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> removeLogger(String name) {\n+      Request.Builder builder = new Request.Builder();\n+      builder.url(baseLoggingURL + \"/\" + sanitize(name)).delete();", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNTY5Mw==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389705693", "bodyText": "Fixed", "author": "tristantarrant", "createdAt": "2020-03-09T14:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1NTI0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM1NjYxOQ==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388356619", "bodyText": "nitpick: sb.append(\"appender=\").append(String.join(\"%appender=\", appenders))", "author": "pruivo", "createdAt": "2020-03-05T15:11:51Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestLoggingClientOkHttp.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.infinispan.client.rest.impl.okhttp;\n+\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.sanitize;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.client.rest.RestLoggingClient;\n+import org.infinispan.client.rest.RestResponse;\n+\n+import okhttp3.Request;\n+import okhttp3.internal.Util;\n+\n+/**\n+ * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n+ * @since 11.0\n+ **/\n+public class RestLoggingClientOkHttp implements RestLoggingClient {\n+\n+   private final RestClientOkHttp client;\n+   private final String baseLoggingURL;\n+\n+   RestLoggingClientOkHttp(RestClientOkHttp restClient) {\n+      this.client = restClient;\n+      this.baseLoggingURL = String.format(\"%s%s/v2/logging\", restClient.getBaseURL(), restClient.getConfiguration().contextPath());\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> listLoggers() {\n+      return client.execute(baseLoggingURL, \"loggers\");\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> listAppenders() {\n+      return client.execute(baseLoggingURL, \"appenders\");\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> setLogger(String name, String level, String... appenders) {\n+      Request.Builder builder = new Request.Builder();\n+      StringBuilder sb = new StringBuilder(baseLoggingURL);\n+      sb.append(\"/loggers/\").append(sanitize(name)).append(\"?\");\n+      boolean amp = false;\n+      if (level != null) {\n+         sb.append(\"level=\").append(level);\n+         amp = true;\n+      }\n+      if (appenders != null) {\n+         for(String appender : appenders) {", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2NDY4Nw==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388364687", "bodyText": "layout isn't used.", "author": "pruivo", "createdAt": "2020-03-05T15:23:33Z", "path": "server/rest/src/main/java/org/infinispan/rest/resources/LoggingResource.java", "diffHunk": "@@ -0,0 +1,180 @@\n+package org.infinispan.rest.resources;\n+\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static org.infinispan.commons.dataconversion.MediaType.APPLICATION_JSON_TYPE;\n+import static org.infinispan.rest.framework.Method.DELETE;\n+import static org.infinispan.rest.framework.Method.GET;\n+import static org.infinispan.rest.framework.Method.PUT;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.NoSuchElementException;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.core.Appender;\n+import org.apache.logging.log4j.core.Layout;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.config.LoggerConfig;\n+import org.infinispan.rest.InvocationHelper;\n+import org.infinispan.rest.NettyRestResponse;\n+import org.infinispan.rest.framework.ResourceHandler;\n+import org.infinispan.rest.framework.RestRequest;\n+import org.infinispan.rest.framework.RestResponse;\n+import org.infinispan.rest.framework.impl.Invocations;\n+import org.infinispan.tasks.TaskContext;\n+import org.infinispan.tasks.TaskManager;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+\n+/**\n+ * Logging configuration resource. This resource is log4j 2.x-specific\n+ *\n+ * @author tristan@infinispan.org\n+ * @since 11.0\n+ */\n+public final class LoggingResource implements ResourceHandler {\n+   private final InvocationHelper invocationHelper;\n+\n+   public LoggingResource(InvocationHelper invocationHelper) {\n+      this.invocationHelper = invocationHelper;\n+      // Register our custom serializers\n+      SimpleModule module = new SimpleModule();\n+      module.addSerializer(LoggerConfig.class, new Log4j2LoggerConfigSerializer());\n+      module.addSerializer(Appender.class, new Log4j2AppenderSerializer());\n+      this.invocationHelper.getMapper().registerModule(module);\n+   }\n+\n+   @Override\n+   public Invocations getInvocations() {\n+      return new Invocations.Builder()\n+            .invocation().methods(GET).path(\"/v2/logging/loggers\").handleWith(this::listLoggers)\n+            .invocation().methods(GET).path(\"/v2/logging/appenders\").handleWith(this::listAppenders)\n+            .invocation().methods(DELETE).path(\"/v2/logging/loggers/{loggerName}\").handleWith(this::deleteLogger)\n+            .invocation().methods(PUT).path(\"/v2/logging/loggers/{loggerName}\").handleWith(this::setLogger)\n+            .create();\n+   }\n+\n+   private CompletionStage<RestResponse> setLogger(RestRequest request) {\n+      TaskManager taskManager = invocationHelper.getServer().getTaskManager();\n+      String loggerName = request.variables().get(\"loggerName\");\n+      String level = request.getParameter(\"level\");\n+      List<String> appenders = request.parameters().get(\"appender\");\n+      if (level == null && appenders == null) {\n+         return completedFuture(new NettyRestResponse.Builder().status(HttpResponseStatus.BAD_REQUEST).build());\n+      }\n+      return taskManager.runTask(\"@@logging@set\",\n+            new TaskContext()\n+                  .addParameter(\"loggerName\", loggerName)\n+                  .addOptionalParameter(\"level\", level)\n+                  .addOptionalParameter(\"appenders\", appenders)\n+      ).handle((o, t) -> {\n+         NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n+         if (t == null) {\n+            response.status(HttpResponseStatus.NO_CONTENT);\n+         } else {\n+            while (t.getCause() != null) {\n+               t = t.getCause();\n+            }\n+            if (t instanceof IllegalStateException) {\n+               response.status(HttpResponseStatus.CONFLICT).entity(t.getMessage());\n+            } else if (t instanceof IllegalArgumentException) {\n+               response.status(HttpResponseStatus.BAD_REQUEST).entity(t.getMessage());\n+            } else if (t instanceof NoSuchElementException) {\n+               response.status(HttpResponseStatus.NOT_FOUND).entity(t.getMessage());\n+            } else {\n+               response.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).entity(t.getMessage());\n+            }\n+         }\n+         return response.build();\n+      });\n+   }\n+\n+   private CompletionStage<RestResponse> deleteLogger(RestRequest request) {\n+      TaskManager taskManager = invocationHelper.getServer().getTaskManager();\n+      String loggerName = request.variables().get(\"loggerName\");\n+      return taskManager.runTask(\"@@logging@remove\", new TaskContext().addParameter(\"loggerName\", loggerName))\n+            .thenApply(o -> {\n+               NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n+               response.status(HttpResponseStatus.NO_CONTENT);\n+               return response.build();\n+            });\n+   }\n+\n+   private CompletionStage<RestResponse> listLoggers(RestRequest request) {\n+      LoggerContext logContext = (LoggerContext) LogManager.getContext(false);\n+      NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n+      try {\n+         // We only return loggers declared in the configuration\n+         Collection<LoggerConfig> loggers = logContext.getConfiguration().getLoggers().values();\n+         byte[] resultBytes = invocationHelper.getMapper().writeValueAsBytes(loggers);\n+         response.contentType(APPLICATION_JSON_TYPE).entity(resultBytes);\n+      } catch (JsonProcessingException e) {\n+         response.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).entity(e.getMessage());\n+      }\n+      return completedFuture(response.build());\n+   }\n+\n+   private CompletionStage<RestResponse> listAppenders(RestRequest request) {\n+      LoggerContext logContext = (LoggerContext) LogManager.getContext(false);\n+      NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n+      try {\n+         byte[] resultBytes = invocationHelper.getMapper().writeValueAsBytes(logContext.getConfiguration().getAppenders());\n+         response.contentType(APPLICATION_JSON_TYPE).entity(resultBytes);\n+      } catch (JsonProcessingException e) {\n+         response.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).entity(e.getMessage());\n+      }\n+      return completedFuture(response.build());\n+   }\n+\n+   public static class Log4j2LoggerConfigSerializer extends StdSerializer<LoggerConfig> {\n+\n+      public Log4j2LoggerConfigSerializer() {\n+         this(null);\n+      }\n+\n+      public Log4j2LoggerConfigSerializer(Class<LoggerConfig> t) {\n+         super(t);\n+      }\n+\n+      @Override\n+      public void serialize(LoggerConfig logger, JsonGenerator json, SerializerProvider serializerProvider) throws IOException {\n+         json.writeStartObject();\n+         json.writeStringField(\"name\", logger.getName());\n+         json.writeStringField(\"level\", logger.getLevel().name());\n+         json.writeArrayFieldStart(\"appenders\");\n+         for (String appender : logger.getAppenders().keySet()) {\n+            json.writeString(appender);\n+         }\n+         json.writeEndArray();\n+         json.writeEndObject();\n+      }\n+   }\n+\n+   public static class Log4j2AppenderSerializer extends StdSerializer<Appender> {\n+\n+      public Log4j2AppenderSerializer() {\n+         this(null);\n+      }\n+\n+      public Log4j2AppenderSerializer(Class<Appender> t) {\n+         super(t);\n+      }\n+\n+      @Override\n+      public void serialize(Appender appender, JsonGenerator json, SerializerProvider serializerProvider) throws IOException {\n+         json.writeStartObject();\n+         json.writeStringField(\"name\", appender.getName());\n+         Layout<? extends Serializable> layout = appender.getLayout();", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY4NzcwMw==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389687703", "bodyText": "Done", "author": "tristantarrant", "createdAt": "2020-03-09T13:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2NDY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3MjY5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388372696", "bodyText": "static?", "author": "pruivo", "createdAt": "2020-03-05T15:35:24Z", "path": "server/runtime/src/main/java/org/infinispan/server/tasks/admin/LoggingSetTask.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.infinispan.server.tasks.admin;\n+\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.core.Appender;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.config.Configuration;\n+import org.apache.logging.log4j.core.config.LoggerConfig;\n+import org.infinispan.commons.api.CacheContainerAdmin;\n+import org.infinispan.manager.EmbeddedCacheManager;\n+import org.infinispan.server.core.admin.AdminServerTask;\n+import org.infinispan.tasks.TaskExecutionMode;\n+\n+/**\n+ * Admin operation to add/modify a logger\n+ *\n+ * @author Tristan Tarrant\n+ * @since 11.0\n+ */\n+public class LoggingSetTask extends AdminServerTask<byte[]> {\n+   private final Set<String> PARAMETERS;\n+\n+   public LoggingSetTask() {\n+      PARAMETERS = Stream.of(\"loggerName\", \"level\", \"appenders\", \"create\").collect(Collectors.toSet());", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY4NzU3NQ==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389687575", "bodyText": "Done", "author": "tristantarrant", "createdAt": "2020-03-09T13:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3MjY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3NzIxMA==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r388377210", "bodyText": "can you duplicate the test using RestLoggingClient? It would avoid issues in RestLoggingClient :)", "author": "pruivo", "createdAt": "2020-03-05T15:42:04Z", "path": "server/tests/src/test/java/org/infinispan/server/functional/RestLoggingResource.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.infinispan.server.functional;\n+\n+import static org.infinispan.server.security.Common.sync;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.RestResponse;\n+import org.infinispan.server.test.junit4.InfinispanServerRule;\n+import org.infinispan.server.test.junit4.InfinispanServerTestMethodRule;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+/**\n+ * @since 11.0\n+ */\n+public class RestLoggingResource {\n+\n+   @ClassRule\n+   public static InfinispanServerRule SERVERS = ClusteredIT.SERVERS;\n+\n+   @Rule\n+   public InfinispanServerTestMethodRule SERVER_TEST = new InfinispanServerTestMethodRule(SERVERS);\n+\n+   private final ObjectMapper mapper = new ObjectMapper();\n+\n+   @Test\n+   public void testListLoggers() throws Exception {\n+      RestClient client = SERVER_TEST.rest().create();\n+      RestResponse response = sync(client.raw().get(\"/rest/v2/logging/loggers\"));\n+      JsonNode loggers = mapper.readTree(response.getBody());\n+      assertTrue(loggers.size() > 0);\n+   }\n+\n+   @Test\n+   public void testListAppenders() throws Exception {\n+      RestClient client = SERVER_TEST.rest().create();\n+      RestResponse response = sync(client.raw().get(\"/rest/v2/logging/appenders\"));\n+      JsonNode appenders = mapper.readTree(response.getBody());\n+      assertEquals(2, appenders.size());\n+   }\n+\n+   @Test\n+   public void testManipulateLogger() throws Exception {", "originalCommit": "b4bbf5a3966fbc90a13b82880e250e6bba36335a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY4NzQyOQ==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389687429", "bodyText": "Done", "author": "tristantarrant", "createdAt": "2020-03-09T13:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3NzIxMA=="}], "type": "inlineReview"}, {"oid": "8f76af7f076e854b27a432df728a4ea3a8ee55a8", "url": "https://github.com/infinispan/infinispan/commit/8f76af7f076e854b27a432df728a4ea3a8ee55a8", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-09T13:41:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5Nzg4NA==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389697884", "bodyText": "This resource will only affect the local server, correct? I am wondering if it should be mapped under /v2/server/logging", "author": "gustavonalle", "createdAt": "2020-03-09T13:58:36Z", "path": "server/rest/src/main/java/org/infinispan/rest/resources/LoggingResource.java", "diffHunk": "@@ -0,0 +1,177 @@\n+package org.infinispan.rest.resources;\n+\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static org.infinispan.commons.dataconversion.MediaType.APPLICATION_JSON_TYPE;\n+import static org.infinispan.rest.framework.Method.DELETE;\n+import static org.infinispan.rest.framework.Method.GET;\n+import static org.infinispan.rest.framework.Method.PUT;\n+\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.NoSuchElementException;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.core.Appender;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.config.LoggerConfig;\n+import org.infinispan.rest.InvocationHelper;\n+import org.infinispan.rest.NettyRestResponse;\n+import org.infinispan.rest.framework.ResourceHandler;\n+import org.infinispan.rest.framework.RestRequest;\n+import org.infinispan.rest.framework.RestResponse;\n+import org.infinispan.rest.framework.impl.Invocations;\n+import org.infinispan.tasks.TaskContext;\n+import org.infinispan.tasks.TaskManager;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+\n+/**\n+ * Logging configuration resource. This resource is log4j 2.x-specific\n+ *\n+ * @author tristan@infinispan.org\n+ * @since 11.0\n+ */\n+public final class LoggingResource implements ResourceHandler {\n+   private final InvocationHelper invocationHelper;\n+\n+   public LoggingResource(InvocationHelper invocationHelper) {\n+      this.invocationHelper = invocationHelper;\n+      // Register our custom serializers\n+      SimpleModule module = new SimpleModule();\n+      module.addSerializer(LoggerConfig.class, new Log4j2LoggerConfigSerializer());\n+      module.addSerializer(Appender.class, new Log4j2AppenderSerializer());\n+      this.invocationHelper.getMapper().registerModule(module);\n+   }\n+\n+   @Override\n+   public Invocations getInvocations() {\n+      return new Invocations.Builder()\n+            .invocation().methods(GET).path(\"/v2/logging/loggers\").handleWith(this::listLoggers)", "originalCommit": "8f76af7f076e854b27a432df728a4ea3a8ee55a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMTgwOA==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389701808", "bodyText": "Tricky, because the set and remove ops are clustered", "author": "tristantarrant", "createdAt": "2020-03-09T14:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMzI2NQ==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389703265", "bodyText": "So GET /v2/server/logging/loggers and GET /v2/server/logging/appenders but PUT /v2/cluster/logging/loggers/org.infinispan.ABC and DELETE /v2/cluster/logging/loggers/org.infinispan.ABC", "author": "tristantarrant", "createdAt": "2020-03-09T14:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzg3OA==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389707878", "bodyText": "WDYM? PUT and DELETE are sent to all nodes, but not GET?", "author": "gustavonalle", "createdAt": "2020-03-09T14:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMTU4Mg==", "url": "https://github.com/infinispan/infinispan/pull/8001#discussion_r389711582", "bodyText": "PUT and DELETE are handled by clustered tasks.\nGET is only handled by the local node. In a symmetrical cluster that should be fine. Making it clustered would mean returning a map of list of loggers (one list per server) which seems overkill", "author": "tristantarrant", "createdAt": "2020-03-09T14:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5Nzg4NA=="}], "type": "inlineReview"}, {"oid": "a86e5f83b8edbf77000b1ddeeccb80ea7345725d", "url": "https://github.com/infinispan/infinispan/commit/a86e5f83b8edbf77000b1ddeeccb80ea7345725d", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-09T14:23:01Z", "type": "forcePushed"}, {"oid": "bf2ffb8e6ae717ca8bc5384fb31b420d19724be4", "url": "https://github.com/infinispan/infinispan/commit/bf2ffb8e6ae717ca8bc5384fb31b420d19724be4", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-10T10:39:32Z", "type": "forcePushed"}, {"oid": "601c4e3d07daef470a3456c386e618bad806f8e9", "url": "https://github.com/infinispan/infinispan/commit/601c4e3d07daef470a3456c386e618bad806f8e9", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-12T15:25:22Z", "type": "forcePushed"}, {"oid": "9a6c4b648e99d2fc421f1cf3e8f1a48eed2125a2", "url": "https://github.com/infinispan/infinispan/commit/9a6c4b648e99d2fc421f1cf3e8f1a48eed2125a2", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-16T14:09:27Z", "type": "forcePushed"}, {"oid": "5aca06209cb43f2034c7ad107f18eada8ca5c469", "url": "https://github.com/infinispan/infinispan/commit/5aca06209cb43f2034c7ad107f18eada8ca5c469", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-16T16:39:55Z", "type": "forcePushed"}, {"oid": "4aeb0bcc50e00b07b1ccd0c141155d80d22bef6c", "url": "https://github.com/infinispan/infinispan/commit/4aeb0bcc50e00b07b1ccd0c141155d80d22bef6c", "message": "ISPN-11477 CLI: show available help commands", "committedDate": "2020-03-19T13:28:38Z", "type": "commit"}, {"oid": "8e7ba0f02f54b55732c4a4ad73b9c47ea4c7ae00", "url": "https://github.com/infinispan/infinispan/commit/8e7ba0f02f54b55732c4a4ad73b9c47ea4c7ae00", "message": "ISPN-10539 Server Logging management via REST", "committedDate": "2020-03-19T13:30:22Z", "type": "commit"}, {"oid": "8e9b242cd44fe18b031a8a543a0228c932cbdbb9", "url": "https://github.com/infinispan/infinispan/commit/8e9b242cd44fe18b031a8a543a0228c932cbdbb9", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-19T13:30:22Z", "type": "commit"}, {"oid": "8e9b242cd44fe18b031a8a543a0228c932cbdbb9", "url": "https://github.com/infinispan/infinispan/commit/8e9b242cd44fe18b031a8a543a0228c932cbdbb9", "message": "ISPN-11238 Server Logging management via CLI", "committedDate": "2020-03-19T13:30:22Z", "type": "forcePushed"}]}