{"pr_number": 7367, "pr_title": "Support oracle connect descriptor url", "pr_createdAt": "2020-09-09T15:07:18Z", "pr_url": "https://github.com/apache/shardingsphere/pull/7367", "timeline": [{"oid": "69530f7217f20b8549e0eea52fe5f806a332d00b", "url": "https://github.com/apache/shardingsphere/commit/69530f7217f20b8549e0eea52fe5f806a332d00b", "message": "support oracle connect descriptor url see\uff1ahttps://docs.oracle.com/en/database/oracle/oracle-database/18/netag/identifying-and-accessing-database.html#GUID-2BDF9E52-4147-4F46-84E2-A5AE1018A373", "committedDate": "2020-09-09T15:04:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNjE1NQ==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486026155", "bodyText": "Could we merge two of the patterns?", "author": "tristaZero", "createdAt": "2020-09-10T02:30:52Z", "path": "shardingsphere-infra/shardingsphere-infra-common/src/main/java/org/apache/shardingsphere/infra/database/metadata/dialect/OracleDataSourceMetaData.java", "diffHunk": "@@ -33,24 +33,39 @@\n     \n     private static final int DEFAULT_PORT = 1521;\n     \n-    private final String hostName;\n+    private String hostName;\n     \n-    private final int port;\n+    private int port;\n     \n-    private final String catalog;\n+    private String catalog;\n     \n-    private final String schema;\n+    private String schema;\n     \n-    private final Pattern pattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);\n+    private final Pattern thinUrlPattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);\n+    \n+    private final Pattern connectDescriptorUrlPattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@[(\\\\w\\\\s=)]+HOST\\\\s*=\\\\s*(\\\\d+(\\\\.\"", "originalCommit": "69530f7217f20b8549e0eea52fe5f806a332d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzMzA2Mg==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486033062", "bodyText": "hard be, this is refer to oracle JDBC driver's implementation", "author": "xbkaishui", "createdAt": "2020-09-10T02:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzMzc0NA==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486033744", "bodyText": "As you know. those are totally different, those have different patterns and different group counts", "author": "xbkaishui", "createdAt": "2020-09-10T02:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNjE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMzNjA0Nw==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486336047", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-09-10T13:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNjE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNzIxOA==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486027218", "bodyText": "Why did you remove the final?", "author": "tristaZero", "createdAt": "2020-09-10T02:35:09Z", "path": "shardingsphere-infra/shardingsphere-infra-common/src/main/java/org/apache/shardingsphere/infra/database/metadata/dialect/OracleDataSourceMetaData.java", "diffHunk": "@@ -33,24 +33,39 @@\n     \n     private static final int DEFAULT_PORT = 1521;\n     \n-    private final String hostName;\n+    private String hostName;\n     \n-    private final int port;\n+    private int port;\n     \n-    private final String catalog;\n+    private String catalog;\n     \n-    private final String schema;", "originalCommit": "69530f7217f20b8549e0eea52fe5f806a332d00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzMzUxOQ==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486033519", "bodyText": "it is used in method matchWithConnectDescriptorPattern, which is not in constructor method", "author": "xbkaishui", "createdAt": "2020-09-10T02:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNzIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMzNjEwOA==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486336108", "bodyText": "done", "author": "xbkaishui", "createdAt": "2020-09-10T13:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAyNzIxOA=="}], "type": "inlineReview"}, {"oid": "4cbc45aa6c22b25225974f7f7556a4182e14286d", "url": "https://github.com/apache/shardingsphere/commit/4cbc45aa6c22b25225974f7f7556a4182e14286d", "message": "change variable to final", "committedDate": "2020-09-10T10:06:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc0MjI2NQ==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486742265", "bodyText": "Hi, why did you rename it as thinUrlPattern? Did you quote it somewhere?", "author": "tristaZero", "createdAt": "2020-09-11T02:49:31Z", "path": "shardingsphere-infra/shardingsphere-infra-common/src/main/java/org/apache/shardingsphere/infra/database/metadata/dialect/OracleDataSourceMetaData.java", "diffHunk": "@@ -41,12 +41,23 @@\n     \n     private final String schema;\n     \n-    private final Pattern pattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);\n+    private final Pattern thinUrlPattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);", "originalCommit": "4cbc45aa6c22b25225974f7f7556a4182e14286d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc1MDU4OQ==", "url": "https://github.com/apache/shardingsphere/pull/7367#discussion_r486750589", "bodyText": "It seems not so concise. How about this programing clip?\nCollection<Matcher> matchers;\nfor each `matchers`\nif each.find() {\n}\nend\nthrow new Exception", "author": "tristaZero", "createdAt": "2020-09-11T03:22:33Z", "path": "shardingsphere-infra/shardingsphere-infra-common/src/main/java/org/apache/shardingsphere/infra/database/metadata/dialect/OracleDataSourceMetaData.java", "diffHunk": "@@ -41,12 +41,23 @@\n     \n     private final String schema;\n     \n-    private final Pattern pattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);\n+    private final Pattern thinUrlPattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@(//)?([\\\\w\\\\-\\\\.]+):?([0-9]*)[:/]([\\\\w\\\\-]+)\", Pattern.CASE_INSENSITIVE);\n+    \n+    private final Pattern connectDescriptorUrlPattern = Pattern.compile(\"jdbc:oracle:(thin|oci|kprb):@[(\\\\w\\\\s=)]+HOST\\\\s*=\\\\s*(\\\\d+(\\\\.\"\n+            + \"((2(5[0-5]|[0-4]\\\\d))|[0-1]?\\\\d{1,2})){3}).*PORT\\\\s*=\\\\s*(\\\\d+).*SERVICE_NAME\\\\s*=\\\\s*(\\\\w+)\\\\)\");\n     \n     public OracleDataSourceMetaData(final String url, final String username) {\n-        Matcher matcher = pattern.matcher(url);\n+        Matcher matcher = thinUrlPattern.matcher(url);\n         if (!matcher.find()) {\n-            throw new UnrecognizedDatabaseURLException(url, pattern.pattern());\n+            matcher = connectDescriptorUrlPattern.matcher(url);\n+            if (!matcher.find()) {\n+                throw new UnrecognizedDatabaseURLException(url, connectDescriptorUrlPattern.pattern());", "originalCommit": "4cbc45aa6c22b25225974f7f7556a4182e14286d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "acfca7769627082d7f276b99002fe15cb563dcfa", "url": "https://github.com/apache/shardingsphere/commit/acfca7769627082d7f276b99002fe15cb563dcfa", "message": "adjust code structure", "committedDate": "2020-09-11T03:54:46Z", "type": "commit"}]}