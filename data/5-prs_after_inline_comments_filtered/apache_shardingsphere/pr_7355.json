{"pr_number": 7355, "pr_title": "Support multi replica extension", "pr_createdAt": "2020-09-09T09:54:37Z", "pr_url": "https://github.com/apache/shardingsphere/pull/7355", "timeline": [{"oid": "01e14c1801a50338f212171b1add5cc691bb8ef7", "url": "https://github.com/apache/shardingsphere/commit/01e14c1801a50338f212171b1add5cc691bb8ef7", "message": "Support multi replica extension", "committedDate": "2020-09-09T04:16:08Z", "type": "commit"}, {"oid": "85df10184354919254818a89bd50cefb0fec8a6d", "url": "https://github.com/apache/shardingsphere/commit/85df10184354919254818a89bd50cefb0fec8a6d", "message": "Merge branch 'master' into features/replica\n\n# Conflicts:\n#\tshardingsphere-features/shardingsphere-encrypt/shardingsphere-encrypt-rewrite/src/test/java/org/apache/shardingsphere/encrypt/rewrite/parameterized/EncryptSQLRewriterParameterizedTest.java\n#\tshardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/test/java/org/apache/shardingsphere/sharding/rewrite/parameterized/MixSQLRewriterParameterizedTest.java\n#\tshardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/test/java/org/apache/shardingsphere/sharding/rewrite/parameterized/ShardingSQLRewriterParameterizedTest.java\n#\tshardingsphere-governance/shardingsphere-governance-core/shardingsphere-governance-core-context/src/main/java/org/apache/shardingsphere/governance/context/schema/GovernanceSchemaContexts.java\n#\tshardingsphere-infra/shardingsphere-infra-common/src/main/java/org/apache/shardingsphere/infra/metadata/ShardingSphereMetaData.java\n#\tshardingsphere-infra/shardingsphere-infra-executor/src/main/java/org/apache/shardingsphere/infra/executor/sql/context/ExecutionContextBuilder.java\n#\tshardingsphere-infra/shardingsphere-infra-executor/src/test/java/org/apache/shardingsphere/infra/executor/sql/context/ExecutionContextBuilderTest.java\n#\tshardingsphere-jdbc/shardingsphere-jdbc-core/src/main/java/org/apache/shardingsphere/driver/jdbc/core/statement/ShardingSpherePreparedStatement.java\n#\tshardingsphere-jdbc/shardingsphere-jdbc-core/src/main/java/org/apache/shardingsphere/driver/jdbc/core/statement/ShardingSphereStatement.java\n#\tshardingsphere-proxy/shardingsphere-proxy-backend/src/main/java/org/apache/shardingsphere/proxy/backend/communication/jdbc/wrapper/PreparedStatementExecutorWrapper.java\n#\tshardingsphere-proxy/shardingsphere-proxy-backend/src/test/java/org/apache/shardingsphere/proxy/backend/text/sctl/hint/ShardingCTLHintBackendHandlerTest.java", "committedDate": "2020-09-09T10:18:38Z", "type": "commit"}, {"oid": "981f6b080832a44b6c20d67d6415aa4aa60c2e72", "url": "https://github.com/apache/shardingsphere/commit/981f6b080832a44b6c20d67d6415aa4aa60c2e72", "message": "merge from apache/master", "committedDate": "2020-09-09T10:36:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwMjEyNw==", "url": "https://github.com/apache/shardingsphere/pull/7355#discussion_r485702127", "bodyText": "Please rename primaryKeyColumns as result for return value", "author": "terrymanu", "createdAt": "2020-09-09T15:27:07Z", "path": "shardingsphere-infra/shardingsphere-infra-executor/src/main/java/org/apache/shardingsphere/infra/executor/sql/context/ExecutionContextBuilder.java", "diffHunk": "@@ -42,22 +50,77 @@\n      * \n      * @param metaData meta data\n      * @param sqlRewriteResult SQL rewrite result\n+     * @param sqlStatementContext SQL statement context\n      * @return execution contexts\n      */\n-    public static Collection<ExecutionUnit> build(final ShardingSphereMetaData metaData, final SQLRewriteResult sqlRewriteResult) {\n-        return sqlRewriteResult instanceof GenericSQLRewriteResult ? build(metaData, (GenericSQLRewriteResult) sqlRewriteResult) : build((RouteSQLRewriteResult) sqlRewriteResult);\n+    public static Collection<ExecutionUnit> build(final ShardingSphereMetaData metaData, final SQLRewriteResult sqlRewriteResult, final SQLStatementContext sqlStatementContext) {\n+        return sqlRewriteResult instanceof GenericSQLRewriteResult ? build(metaData, (GenericSQLRewriteResult) sqlRewriteResult, sqlStatementContext)\n+                : build(metaData, (RouteSQLRewriteResult) sqlRewriteResult);\n     }\n     \n-    private static Collection<ExecutionUnit> build(final ShardingSphereMetaData metaData, final GenericSQLRewriteResult sqlRewriteResult) {\n+    private static Collection<ExecutionUnit> build(final ShardingSphereMetaData metaData, final GenericSQLRewriteResult sqlRewriteResult, final SQLStatementContext sqlStatementContext) {\n         String dataSourceName = metaData.getDataSourceMetaDatas().getAllInstanceDataSourceNames().iterator().next();\n-        return Collections.singletonList(new ExecutionUnit(dataSourceName, new SQLUnit(sqlRewriteResult.getSqlRewriteUnit().getSql(), sqlRewriteResult.getSqlRewriteUnit().getParameters())));\n+        return Collections.singletonList(new ExecutionUnit(dataSourceName,\n+                new SQLUnit(sqlRewriteResult.getSqlRewriteUnit().getSql(), sqlRewriteResult.getSqlRewriteUnit().getParameters(), getActualTableNames(sqlStatementContext),\n+                        getPrimaryKeyColumns(metaData, sqlStatementContext))));\n     }\n     \n-    private static Collection<ExecutionUnit> build(final RouteSQLRewriteResult sqlRewriteResult) {\n+    private static Collection<ExecutionUnit> build(final ShardingSphereMetaData metaData, final RouteSQLRewriteResult sqlRewriteResult) {\n         Collection<ExecutionUnit> result = new LinkedHashSet<>();\n         for (Entry<RouteUnit, SQLRewriteUnit> entry : sqlRewriteResult.getSqlRewriteUnits().entrySet()) {\n-            result.add(new ExecutionUnit(entry.getKey().getDataSourceMapper().getActualName(), new SQLUnit(entry.getValue().getSql(), entry.getValue().getParameters())));\n+            Collection<RouteMapper> tableMappers = entry.getKey().getTableMappers();\n+            result.add(new ExecutionUnit(entry.getKey().getDataSourceMapper().getActualName(),\n+                    new SQLUnit(entry.getValue().getSql(), entry.getValue().getParameters(), getActualTableNames(tableMappers), getPrimaryKeyColumns(metaData, tableMappers))));\n         }\n         return result;\n     }\n+    \n+    private static Set<String> getActualTableNames(final SQLStatementContext sqlStatementContext) {\n+        return getGenericTableNames(sqlStatementContext);\n+    }\n+\n+    private static Set<String> getActualTableNames(final Collection<RouteMapper> tableMappers) {\n+        if (null == tableMappers) {\n+            return Collections.emptySet();\n+        }\n+        return tableMappers.stream().map(RouteMapper::getActualName).collect(Collectors.toSet());\n+    }\n+    \n+    private static Map<String, List<String>> getPrimaryKeyColumns(final ShardingSphereMetaData metaData, final SQLStatementContext sqlStatementContext) {\n+        return getPrimaryKeyColumns(metaData, getLogicTableNames(sqlStatementContext));\n+    }\n+    \n+    private static Map<String, List<String>> getPrimaryKeyColumns(final ShardingSphereMetaData metaData, final Collection<RouteMapper> tableMappers) {\n+        return getPrimaryKeyColumns(metaData, getLogicTableNames(tableMappers));\n+    }\n+    \n+    private static Map<String, List<String>> getPrimaryKeyColumns(final ShardingSphereMetaData metaData, final Set<String> logicTableNames) {\n+        Map<String, List<String>> primaryKeyColumns = new HashMap<>(logicTableNames.size());\n+        for (String each: logicTableNames) {\n+            primaryKeyColumns.put(each, metaData.getRuleSchemaMetaData().getSchemaMetaData().get(each).getPrimaryKeyColumns());\n+        }\n+        return primaryKeyColumns;", "originalCommit": "981f6b080832a44b6c20d67d6415aa4aa60c2e72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwMzQyMA==", "url": "https://github.com/apache/shardingsphere/pull/7355#discussion_r485703420", "bodyText": "What is the useful of the structure of Map<String, List<String>>?\nCan we use a object to define this structure?", "author": "terrymanu", "createdAt": "2020-09-09T15:28:57Z", "path": "shardingsphere-infra/shardingsphere-infra-executor/src/main/java/org/apache/shardingsphere/infra/executor/sql/context/SQLUnit.java", "diffHunk": "@@ -36,4 +40,15 @@\n     private final String sql;\n     \n     private final List<Object> parameters;\n+\n+    private final Set<String> actualTables;\n+    \n+    private final Map<String, List<String>> primaryKeyColumns;", "originalCommit": "981f6b080832a44b6c20d67d6415aa4aa60c2e72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cad6075621983d49787a1ec5217d4767a596dd4c", "url": "https://github.com/apache/shardingsphere/commit/cad6075621983d49787a1ec5217d4767a596dd4c", "message": "add a blank line in the end of RawExecutorCallback's SPI META-INF file\nrename primaryKeyColumns as result for return value in ExecutionContextBuilder\nuse a object to define Map<String, List<String>> structure for primaryKeyColumns", "committedDate": "2020-09-10T03:24:23Z", "type": "commit"}, {"oid": "5106743a8a71399ef86f0abc6c2ddbfa89853f69", "url": "https://github.com/apache/shardingsphere/commit/5106743a8a71399ef86f0abc6c2ddbfa89853f69", "message": "refactor SQLUnit, add SQLRuntimeContext", "committedDate": "2020-09-10T09:04:31Z", "type": "commit"}, {"oid": "019949a37a28d9ce639d3ea970be56a235efc02e", "url": "https://github.com/apache/shardingsphere/commit/019949a37a28d9ce639d3ea970be56a235efc02e", "message": "Merge branch 'master' into features/replica\n\n# Conflicts:\n#\tshardingsphere-proxy/shardingsphere-proxy-backend/src/main/java/org/apache/shardingsphere/proxy/backend/communication/jdbc/execute/engine/jdbc/JDBCExecuteEngine.java", "committedDate": "2020-09-10T09:10:28Z", "type": "commit"}, {"oid": "4d37777c11f5d9f706f6835b9b1e1b5b3d3bc436", "url": "https://github.com/apache/shardingsphere/commit/4d37777c11f5d9f706f6835b9b1e1b5b3d3bc436", "message": "merge from master", "committedDate": "2020-09-10T09:31:12Z", "type": "commit"}]}