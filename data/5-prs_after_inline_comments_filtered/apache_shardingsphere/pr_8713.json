{"pr_number": 8713, "pr_title": "Support create replica_query rule.", "pr_createdAt": "2020-12-22T06:44:30Z", "pr_url": "https://github.com/apache/shardingsphere/pull/8713", "timeline": [{"oid": "d1752fdfe21da35f239285bd0c5771c532d2db80", "url": "https://github.com/apache/shardingsphere/commit/d1752fdfe21da35f239285bd0c5771c532d2db80", "message": "add parser for CreateReplicaQueryRule", "committedDate": "2020-12-21T04:00:45Z", "type": "commit"}, {"oid": "933b16f3d97549bba3dae5cb2bfcd4e973fd13d8", "url": "https://github.com/apache/shardingsphere/commit/933b16f3d97549bba3dae5cb2bfcd4e973fd13d8", "message": "merge upstream/master", "committedDate": "2020-12-21T06:03:19Z", "type": "commit"}, {"oid": "b43c735db3dbd3dcffdb4e70c41d8048df860314", "url": "https://github.com/apache/shardingsphere/commit/b43c735db3dbd3dcffdb4e70c41d8048df860314", "message": "fix", "committedDate": "2020-12-21T06:12:46Z", "type": "commit"}, {"oid": "95fc867593abb4e42911546122345d5e4b68b6c0", "url": "https://github.com/apache/shardingsphere/commit/95fc867593abb4e42911546122345d5e4b68b6c0", "message": "fix", "committedDate": "2020-12-22T06:37:45Z", "type": "commit"}, {"oid": "22ae6fb9cb3e74fecdbaf87f9c6a656dd6be8a09", "url": "https://github.com/apache/shardingsphere/commit/22ae6fb9cb3e74fecdbaf87f9c6a656dd6be8a09", "message": "fix", "committedDate": "2020-12-22T06:43:33Z", "type": "commit"}, {"oid": "e61da7eed91fd614c19633fc8930a0ea20e45e53", "url": "https://github.com/apache/shardingsphere/commit/e61da7eed91fd614c19633fc8930a0ea20e45e53", "message": "fix", "committedDate": "2020-12-22T10:26:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNzE4Ng==", "url": "https://github.com/apache/shardingsphere/pull/8713#discussion_r547607186", "bodyText": "What is useful of @RequiredArgsConstructor?", "author": "terrymanu", "createdAt": "2020-12-23T02:37:20Z", "path": "shardingsphere-distsql-parser/shardingsphere-distsql-parser-statement/src/main/java/org/apache/shardingsphere/distsql/parser/segment/rdl/ReplicaQueryRuleSegment.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.distsql.parser.segment.rdl;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Setter;\n+import org.apache.shardingsphere.sql.parser.api.visitor.ASTNode;\n+\n+import java.util.Collection;\n+import java.util.Properties;\n+\n+/**\n+ * Table rule segment.\n+ */\n+@RequiredArgsConstructor", "originalCommit": "e61da7eed91fd614c19633fc8930a0ea20e45e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNzMwOA==", "url": "https://github.com/apache/shardingsphere/pull/8713#discussion_r547607308", "bodyText": "The javadoc is incorrect", "author": "terrymanu", "createdAt": "2020-12-23T02:37:52Z", "path": "shardingsphere-distsql-parser/shardingsphere-distsql-parser-statement/src/main/java/org/apache/shardingsphere/distsql/parser/statement/rdl/create/impl/CreateReplicaQueryRuleStatement.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.distsql.parser.statement.rdl.create.impl;\n+\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import org.apache.shardingsphere.distsql.parser.segment.rdl.ReplicaQueryRuleSegment;\n+import org.apache.shardingsphere.distsql.parser.statement.rdl.create.CreateRDLStatement;\n+\n+import java.util.Collection;\n+\n+/**\n+ * Create sharding rule statement.", "originalCommit": "e61da7eed91fd614c19633fc8930a0ea20e45e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNzY0Ng==", "url": "https://github.com/apache/shardingsphere/pull/8713#discussion_r547607646", "bodyText": "context to YAML sharding rule configuration?", "author": "terrymanu", "createdAt": "2020-12-23T02:39:22Z", "path": "shardingsphere-features/shardingsphere-replica-query/shardingsphere-replica-query-common/src/main/java/org/apache/shardingsphere/replicaquery/yaml/converter/CreateReplicaQueryRuleStatementConverter.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.replicaquery.yaml.converter;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.shardingsphere.distsql.parser.segment.rdl.ReplicaQueryRuleSegment;\n+import org.apache.shardingsphere.distsql.parser.statement.rdl.create.impl.CreateReplicaQueryRuleStatement;\n+import org.apache.shardingsphere.infra.yaml.config.algorithm.YamlShardingSphereAlgorithmConfiguration;\n+import org.apache.shardingsphere.replicaquery.yaml.config.YamlReplicaQueryRuleConfiguration;\n+import org.apache.shardingsphere.replicaquery.yaml.config.rule.YamlReplicaQueryDataSourceRuleConfiguration;\n+\n+/**\n+ * Create replica query rule statement converter.\n+ */\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public final class CreateReplicaQueryRuleStatementConverter {\n+    \n+    /**\n+     * Convert create replica query rule statement context to YAML sharding rule configuration.", "originalCommit": "e61da7eed91fd614c19633fc8930a0ea20e45e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a9fba716ca6e7696b54eae2eb2ee80feebfc1da", "url": "https://github.com/apache/shardingsphere/commit/1a9fba716ca6e7696b54eae2eb2ee80feebfc1da", "message": "fix", "committedDate": "2020-12-23T04:26:46Z", "type": "commit"}, {"oid": "ef9132056d36dcfcead6305ffc5a9077316fc6b5", "url": "https://github.com/apache/shardingsphere/commit/ef9132056d36dcfcead6305ffc5a9077316fc6b5", "message": "fix", "committedDate": "2020-12-23T06:36:02Z", "type": "commit"}, {"oid": "264e9db2970afaa047d2b51a2a6ecb83113c5659", "url": "https://github.com/apache/shardingsphere/commit/264e9db2970afaa047d2b51a2a6ecb83113c5659", "message": "Merge remote-tracking branch 'upstream/master' into issue-8615", "committedDate": "2020-12-23T06:55:14Z", "type": "commit"}, {"oid": "f79c1f40e30edfa120cf3c28fe7512c1cfeab017", "url": "https://github.com/apache/shardingsphere/commit/f79c1f40e30edfa120cf3c28fe7512c1cfeab017", "message": "fix", "committedDate": "2020-12-23T09:49:55Z", "type": "commit"}, {"oid": "f1099eb56cf3f1fdbc452a233b91e43dc269be80", "url": "https://github.com/apache/shardingsphere/commit/f1099eb56cf3f1fdbc452a233b91e43dc269be80", "message": "fix", "committedDate": "2020-12-23T09:56:27Z", "type": "commit"}, {"oid": "8a6509e1ed9321a68cffa3919d2e13d08da07d56", "url": "https://github.com/apache/shardingsphere/commit/8a6509e1ed9321a68cffa3919d2e13d08da07d56", "message": "fix", "committedDate": "2020-12-23T10:05:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNDE3Mg==", "url": "https://github.com/apache/shardingsphere/pull/8713#discussion_r547914172", "bodyText": "Please keep the original indent", "author": "terrymanu", "createdAt": "2020-12-23T11:33:08Z", "path": "shardingsphere-distsql-parser/shardingsphere-distsql-parser-engine/src/main/java/org/apache/shardingsphere/distsql/parser/core/DistSQLVisitor.java", "diffHunk": "@@ -86,29 +91,57 @@ public ASTNode visitCreateShardingRule(final CreateShardingRuleContext ctx) {\n         }\n         return new CreateShardingRuleStatement(tables);\n     }\n-    \n+\n+    @Override\n+    public ASTNode visitCreateReplicaQueryRule(final CreateReplicaQueryRuleContext ctx) {\n+        Collection<ReplicaQueryRuleSegment> replicaQueryRules = new LinkedList<>();\n+        for (ReplicaQueryRuleDefinitionContext each : ctx.replicaQueryRuleDefinition()) {\n+            replicaQueryRules.add((ReplicaQueryRuleSegment) visit(each));\n+        }\n+        return new CreateReplicaQueryRuleStatement(replicaQueryRules);\n+    }\n+\n+    @Override\n+    public ASTNode visitReplicaQueryRuleDefinition(final ReplicaQueryRuleDefinitionContext ctx) {\n+        ReplicaQueryRuleSegment result = new ReplicaQueryRuleSegment();\n+        Collection<String> replicaDatasources = new LinkedList<>();\n+        for (SchemaNameContext each : ctx.schemaNames().schemaName()) {\n+            replicaDatasources.add(each.getText());\n+        }\n+        Properties props = new Properties();\n+        for (AlgorithmPropertyContext each : ctx.algorithmProperties().algorithmProperty()) {\n+            props.setProperty(each.key.getText(), each.value.getText());\n+        }\n+        result.setName(ctx.ruleName.getText());\n+        result.setPrimaryDatasource(ctx.primary.getText());\n+        result.setReplicaDatasources(replicaDatasources);\n+        result.setLoadBalancer(ctx.loadBalancer.getText());\n+        result.setProps(props);\n+        return result;\n+    }\n+\n     @Override\n     public ASTNode visitShardingTableRuleDefinition(final ShardingTableRuleDefinitionContext ctx) {\n         TableRuleSegment result = new TableRuleSegment();\n         result.setLogicTable(ctx.tableName().getText());\n-        result.setShardingColumn(ctx.columName().getText());\n-        result.setAlgorithmType(ctx.shardingAlgorithmDefinition().shardingAlgorithmType().getText());\n+        result.setShardingColumn(ctx.columnName().getText());\n+        result.setAlgorithmType(ctx.shardingAlgorithmType.getText());\n         // TODO Future feature.\n         result.setDataSources(new LinkedList<>());\n-        PropertiesValue propertiesValue = (PropertiesValue) visit(ctx.shardingAlgorithmDefinition().shardingAlgorithmProperties());\n+        PropertiesValue propertiesValue = (PropertiesValue) visit(ctx.algorithmProperties());\n         result.setAlgorithmProps(propertiesValue.getValue());\n         return result;\n     }\n     \n     @Override\n-    public ASTNode visitShardingAlgorithmProperties(final ShardingAlgorithmPropertiesContext ctx) {\n+    public ASTNode visitAlgorithmProperties(final AlgorithmPropertiesContext ctx) {\n         PropertiesValue result = new PropertiesValue();\n-        for (ShardingAlgorithmPropertyContext each : ctx.shardingAlgorithmProperty()) {\n-            result.getValue().setProperty(each.shardingAlgorithmPropertyKey().getText(), each.shardingAlgorithmPropertyValue().getText());\n+        for (AlgorithmPropertyContext each : ctx.algorithmProperty()) {\n+            result.getValue().setProperty(each.key.getText(), each.value.getText());\n         }\n         return result;\n     }\n-    \n+", "originalCommit": "8a6509e1ed9321a68cffa3919d2e13d08da07d56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8e89f2d3eaf99ba9f513cd887841fb4c820da41b", "url": "https://github.com/apache/shardingsphere/commit/8e89f2d3eaf99ba9f513cd887841fb4c820da41b", "message": "fix", "committedDate": "2020-12-23T11:41:06Z", "type": "commit"}, {"oid": "31e846b71d30a688b40f78de9e887918303c868e", "url": "https://github.com/apache/shardingsphere/commit/31e846b71d30a688b40f78de9e887918303c868e", "message": "Update DistSQLVisitor.java", "committedDate": "2020-12-23T11:46:14Z", "type": "commit"}]}