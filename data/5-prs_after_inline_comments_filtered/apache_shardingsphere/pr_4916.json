{"pr_number": 4916, "pr_title": "add tableReferences in selectStatement", "pr_createdAt": "2020-03-24T09:49:11Z", "pr_url": "https://github.com/apache/shardingsphere/pull/4916", "timeline": [{"oid": "3311eb49c08c919666d1236333bc59be1cd856a2", "url": "https://github.com/apache/shardingsphere/commit/3311eb49c08c919666d1236333bc59be1cd856a2", "message": "add JoinTableSegment", "committedDate": "2020-03-23T11:35:33Z", "type": "commit"}, {"oid": "1ea66f83628762438fba6888a8e7da196e2a43df", "url": "https://github.com/apache/shardingsphere/commit/1ea66f83628762438fba6888a8e7da196e2a43df", "message": "fix mysql visitor", "committedDate": "2020-03-24T09:23:56Z", "type": "commit"}, {"oid": "a278b79b431c078a45715cae948bbd142d2f333e", "url": "https://github.com/apache/shardingsphere/commit/a278b79b431c078a45715cae948bbd142d2f333e", "message": "merge", "committedDate": "2020-03-24T09:31:25Z", "type": "commit"}, {"oid": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "url": "https://github.com/apache/shardingsphere/commit/0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "message": "fix", "committedDate": "2020-03-24T09:41:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDY5OQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397594699", "bodyText": "The definition of tableFactor in DMLStatement.g4 shows this can happen, why do you remove it?", "author": "tristaZero", "createdAt": "2020-03-25T03:48:32Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -479,78 +495,67 @@ public ASTNode visitEscapedTableReference(final EscapedTableReferenceContext ctx\n     \n     @Override\n     public ASTNode visitTableReference(final TableReferenceContext ctx) {\n-        CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n+        TableReferenceSegment result = new TableReferenceSegment();\n         if (null != ctx.tableFactor()) {\n-            // TODO :Ignore subquery table segment\n             ASTNode tableFactor = visit(ctx.tableFactor());\n-            if (tableFactor instanceof SimpleTableSegment) {\n-                result.getValue().add((SimpleTableSegment) tableFactor);\n+            if (null != tableFactor) {\n+                result.setTable((TableSegment) tableFactor);\n             }\n         }\n-        if (null != ctx.joinedTable()) {\n-            for (JoinedTableContext each : ctx.joinedTable()) {\n-                result.getValue().addAll(getTableSegments(result.getValue(), each));\n+        if (!ctx.joinedTable().isEmpty()) {\n+            for (JoinedTableContext jc : ctx.joinedTable()) {\n+                JoinedTableSegment joinedTableSegment = (JoinedTableSegment) visit(jc);\n+                result.getJoinedTables().add(joinedTableSegment);\n             }\n         }\n         return result;\n     }\n     \n     @Override\n     public ASTNode visitTableFactor(final TableFactorContext ctx) {\n+        if (null != ctx.subquery()) {\n+            visit(ctx.subquery());\n+        }\n         if (null != ctx.tableName()) {\n             SimpleTableSegment result = (SimpleTableSegment) visit(ctx.tableName());\n             if (null != ctx.alias()) {\n                 result.setAlias((AliasSegment) visit(ctx.alias()));\n             }\n             return result;\n         }\n-        if (null != ctx.tableReferences()) {", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyOTA0OA==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397629048", "bodyText": "I'll add it.", "author": "jingshanglu", "createdAt": "2020-03-25T06:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDg3NQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397594875", "bodyText": "How to handle the alias for subquery?", "author": "tristaZero", "createdAt": "2020-03-25T03:49:10Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -479,78 +495,67 @@ public ASTNode visitEscapedTableReference(final EscapedTableReferenceContext ctx\n     \n     @Override\n     public ASTNode visitTableReference(final TableReferenceContext ctx) {\n-        CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n+        TableReferenceSegment result = new TableReferenceSegment();\n         if (null != ctx.tableFactor()) {\n-            // TODO :Ignore subquery table segment\n             ASTNode tableFactor = visit(ctx.tableFactor());\n-            if (tableFactor instanceof SimpleTableSegment) {\n-                result.getValue().add((SimpleTableSegment) tableFactor);\n+            if (null != tableFactor) {\n+                result.setTable((TableSegment) tableFactor);\n             }\n         }\n-        if (null != ctx.joinedTable()) {\n-            for (JoinedTableContext each : ctx.joinedTable()) {\n-                result.getValue().addAll(getTableSegments(result.getValue(), each));\n+        if (!ctx.joinedTable().isEmpty()) {\n+            for (JoinedTableContext jc : ctx.joinedTable()) {\n+                JoinedTableSegment joinedTableSegment = (JoinedTableSegment) visit(jc);\n+                result.getJoinedTables().add(joinedTableSegment);\n             }\n         }\n         return result;\n     }\n     \n     @Override\n     public ASTNode visitTableFactor(final TableFactorContext ctx) {\n+        if (null != ctx.subquery()) {\n+            visit(ctx.subquery());\n+        }\n         if (null != ctx.tableName()) {\n             SimpleTableSegment result = (SimpleTableSegment) visit(ctx.tableName());\n             if (null != ctx.alias()) {\n                 result.setAlias((AliasSegment) visit(ctx.alias()));\n             }\n             return result;\n         }\n-        if (null != ctx.tableReferences()) {\n-            return visit(ctx.tableReferences());\n-        }\n-        SubqueryTableSegment result = new SubqueryTableSegment(new SubquerySegment(ctx.getStart().getStartIndex(), ctx.getStop().getStopIndex(), (SelectStatement) visit(ctx.subquery())));", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNTM3Mw==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397625373", "bodyText": "I'll add it.", "author": "jingshanglu", "createdAt": "2020-03-25T06:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTQ0Ng==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397595446", "bodyText": "Is it likely to remove this member?", "author": "tristaZero", "createdAt": "2020-03-25T03:51:47Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/segment/dml/TableReferenceSegment.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.sql.segment.dml;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import org.apache.shardingsphere.sql.parser.sql.segment.SQLSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.generic.table.SimpleTableSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.generic.table.TableSegment;\n+\n+import java.util.Collection;\n+import java.util.LinkedList;\n+\n+@Getter\n+@Setter\n+public final class TableReferenceSegment implements SQLSegment {\n+    \n+    private int startIndex;\n+    \n+    private int stopIndex;\n+    \n+    private TableSegment table;\n+    \n+    private final Collection<JoinedTableSegment> joinedTables = new LinkedList<>();\n+    \n+    private final Collection<SimpleTableSegment> tables = new LinkedList<>();", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNTQ0Mg==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397625442", "bodyText": "yes", "author": "jingshanglu", "createdAt": "2020-03-25T06:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczOTA5NQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397739095", "bodyText": "So? Why not now?", "author": "tristaZero", "createdAt": "2020-03-25T10:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTg4OQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397595889", "bodyText": "Do you think private final Collection<TableSegment> tables = new LinkedList<>(); can be deleted from this class?", "author": "tristaZero", "createdAt": "2020-03-25T03:53:55Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/statement/dml/SelectStatement.java", "diffHunk": "@@ -44,6 +45,8 @@\n     \n     private ProjectionsSegment projections;\n     \n+    private final Collection<TableReferenceSegment> tableReferences = new LinkedList<>();", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYyNTY4Ng==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397625686", "bodyText": "yes", "author": "jingshanglu", "createdAt": "2020-03-25T06:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MDc3Nw==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397740777", "bodyText": "Why do not you delete them right now?", "author": "tristaZero", "createdAt": "2020-03-25T10:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5MDUzMw==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397790533", "bodyText": "It has been deleted.", "author": "jingshanglu", "createdAt": "2020-03-25T11:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI5ODQwMQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r398298401", "bodyText": "But I can not find any relevant changes on this page.", "author": "tristaZero", "createdAt": "2020-03-26T03:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzA2NQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597065", "bodyText": "Why did not you comment on this sentence instead of deleting it?", "author": "tristaZero", "createdAt": "2020-03-25T03:59:02Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -315,7 +326,12 @@ public ASTNode visitSelectClause(final SelectClauseContext ctx) {\n             result.getProjections().setDistinctRow(isDistinct(ctx));\n         }\n         if (null != ctx.fromClause()) {\n-            result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.fromClause())).getValue());\n+            CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.fromClause());\n+            for (TableReferenceSegment t : tableReferences.getValue()) {\n+                result.getTables().addAll(t.getTables());\n+                result.getTableReferences().add(t);\n+            }\n+//            result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.fromClause())).getValue());", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzMwNg==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597306", "bodyText": "Please use the value named each for for loop.", "author": "tristaZero", "createdAt": "2020-03-25T04:00:04Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -315,7 +326,12 @@ public ASTNode visitSelectClause(final SelectClauseContext ctx) {\n             result.getProjections().setDistinctRow(isDistinct(ctx));\n         }\n         if (null != ctx.fromClause()) {\n-            result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.fromClause())).getValue());\n+            CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.fromClause());\n+            for (TableReferenceSegment t : tableReferences.getValue()) {", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzMyMg==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597322", "bodyText": "Why did not you comment on this sentence instead of deleting it?", "author": "tristaZero", "createdAt": "2020-03-25T04:00:09Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -279,7 +286,11 @@ public ASTNode visitSingleTableClause(final SingleTableClauseContext ctx) {\n     public ASTNode visitMultipleTablesClause(final MultipleTablesClauseContext ctx) {\n         CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n         result.combine((CollectionValue<SimpleTableSegment>) visit(ctx.multipleTableNames()));\n-        result.combine((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences()));\n+        CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.tableReferences());\n+        for (TableReferenceSegment t : tableReferences.getValue()) {\n+            result.getValue().addAll(t.getTables());\n+        }\n+//        result.combine((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences()));", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzM0MA==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597340", "bodyText": "Why did not you comment on this sentence instead of deleting it?", "author": "tristaZero", "createdAt": "2020-03-25T04:00:17Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -201,7 +204,11 @@ public ASTNode visitOnDuplicateKeyClause(final OnDuplicateKeyClauseContext ctx)\n     @Override\n     public ASTNode visitUpdate(final UpdateContext ctx) {\n         UpdateStatement result = new UpdateStatement();\n-        result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences())).getValue());\n+        CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.tableReferences());\n+        for (TableReferenceSegment t : tableReferences.getValue()) {\n+            result.getTables().addAll(t.getTables());\n+        }\n+//        result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences())).getValue());", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzU4MQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597581", "bodyText": "Please use the value named each for for loop.", "author": "tristaZero", "createdAt": "2020-03-25T04:01:28Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -279,7 +286,11 @@ public ASTNode visitSingleTableClause(final SingleTableClauseContext ctx) {\n     public ASTNode visitMultipleTablesClause(final MultipleTablesClauseContext ctx) {\n         CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n         result.combine((CollectionValue<SimpleTableSegment>) visit(ctx.multipleTableNames()));\n-        result.combine((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences()));\n+        CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.tableReferences());\n+        for (TableReferenceSegment t : tableReferences.getValue()) {", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzY1Ng==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397597656", "bodyText": "Please use the value named each for for loop.", "author": "tristaZero", "createdAt": "2020-03-25T04:01:49Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -479,78 +495,67 @@ public ASTNode visitEscapedTableReference(final EscapedTableReferenceContext ctx\n     \n     @Override\n     public ASTNode visitTableReference(final TableReferenceContext ctx) {\n-        CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n+        TableReferenceSegment result = new TableReferenceSegment();\n         if (null != ctx.tableFactor()) {\n-            // TODO :Ignore subquery table segment\n             ASTNode tableFactor = visit(ctx.tableFactor());\n-            if (tableFactor instanceof SimpleTableSegment) {\n-                result.getValue().add((SimpleTableSegment) tableFactor);\n+            if (null != tableFactor) {\n+                result.setTable((TableSegment) tableFactor);\n             }\n         }\n-        if (null != ctx.joinedTable()) {\n-            for (JoinedTableContext each : ctx.joinedTable()) {\n-                result.getValue().addAll(getTableSegments(result.getValue(), each));\n+        if (!ctx.joinedTable().isEmpty()) {\n+            for (JoinedTableContext jc : ctx.joinedTable()) {", "originalCommit": "0b41af1a4cfe9603410db346aaaf51a9d8f41f01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a42a77f68987f23b5f51e0b2518a13eee3151d3e", "url": "https://github.com/apache/shardingsphere/commit/a42a77f68987f23b5f51e0b2518a13eee3151d3e", "message": "fix mysql visitor", "committedDate": "2020-03-25T06:01:50Z", "type": "commit"}, {"oid": "36ef256f74a7bc11afa7c65995a4240ef1e531ef", "url": "https://github.com/apache/shardingsphere/commit/36ef256f74a7bc11afa7c65995a4240ef1e531ef", "message": "format code", "committedDate": "2020-03-25T06:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyODc1NQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397728755", "bodyText": "Use each value name for for loop.", "author": "tristaZero", "createdAt": "2020-03-25T09:54:18Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -201,7 +205,10 @@ public ASTNode visitOnDuplicateKeyClause(final OnDuplicateKeyClauseContext ctx)\n     @Override\n     public ASTNode visitUpdate(final UpdateContext ctx) {\n         UpdateStatement result = new UpdateStatement();\n-        result.getTables().addAll(((CollectionValue<SimpleTableSegment>) visit(ctx.tableReferences())).getValue());\n+        CollectionValue<TableReferenceSegment> tableReferences = (CollectionValue<TableReferenceSegment>) visit(ctx.tableReferences());", "originalCommit": "36ef256f74a7bc11afa7c65995a4240ef1e531ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczMzgyMA==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397733820", "bodyText": "Please use SubqueryTableSegment", "author": "tristaZero", "createdAt": "2020-03-25T10:02:24Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-dialect/shardingsphere-sql-parser-mysql/src/main/java/org/apache/shardingsphere/sql/parser/mysql/visitor/impl/MySQLDMLVisitor.java", "diffHunk": "@@ -479,78 +493,73 @@ public ASTNode visitEscapedTableReference(final EscapedTableReferenceContext ctx\n     \n     @Override\n     public ASTNode visitTableReference(final TableReferenceContext ctx) {\n-        CollectionValue<SimpleTableSegment> result = new CollectionValue<>();\n+        TableReferenceSegment result = new TableReferenceSegment();\n         if (null != ctx.tableFactor()) {\n-            // TODO :Ignore subquery table segment\n-            ASTNode tableFactor = visit(ctx.tableFactor());\n-            if (tableFactor instanceof SimpleTableSegment) {\n-                result.getValue().add((SimpleTableSegment) tableFactor);\n-            }\n+            TableFactorSegment tableFactor = (TableFactorSegment) visit(ctx.tableFactor());\n+            result.setTableFactor(tableFactor);\n         }\n-        if (null != ctx.joinedTable()) {\n+        if (!ctx.joinedTable().isEmpty()) {\n             for (JoinedTableContext each : ctx.joinedTable()) {\n-                result.getValue().addAll(getTableSegments(result.getValue(), each));\n+                JoinedTableSegment joinedTableSegment = (JoinedTableSegment) visit(each);\n+                result.getJoinedTables().add(joinedTableSegment);\n             }\n         }\n         return result;\n     }\n     \n     @Override\n     public ASTNode visitTableFactor(final TableFactorContext ctx) {\n+        TableFactorSegment result = new TableFactorSegment();\n+        if (null != ctx.subquery()) {\n+            SelectStatement subquery = (SelectStatement) visit(ctx.subquery());\n+            result.setSubquery(new SubquerySegment(ctx.subquery().start.getStartIndex(), ctx.subquery().stop.getStopIndex(), subquery));", "originalCommit": "36ef256f74a7bc11afa7c65995a4240ef1e531ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MDUyMg==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397740522", "bodyText": "Delete system out.", "author": "tristaZero", "createdAt": "2020-03-25T10:13:28Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-test/src/test/java/org/apache/shardingsphere/sql/parser/integrate/engine/SQLParserParameterizedTest.java", "diffHunk": "@@ -133,6 +133,9 @@ private static boolean isPlaceholderWithoutParameter(final Object[] sqlTestParam\n     \n     @Test\n     public void assertSupportedSQL() {\n+        if (\"select_alias_as_keyword\".equals(sqlCaseId) && \"MySQL\".equals(databaseType)) {\n+            System.out.println(\"dadf\");", "originalCommit": "36ef256f74a7bc11afa7c65995a4240ef1e531ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MTU3NA==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397741574", "bodyText": "Two of SimpleTableSegment and SubqueryTableSegment implement TableSegment and have Alias which means you can remove alias and subquery from this class, right?", "author": "tristaZero", "createdAt": "2020-03-25T10:15:08Z", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/segment/dml/TableFactorSegment.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.sql.segment.dml;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import org.apache.shardingsphere.sql.parser.sql.segment.SQLSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.subquery.SubquerySegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.generic.table.TableSegment;\n+\n+import java.util.Collection;\n+import java.util.LinkedList;\n+\n+@Getter\n+@Setter\n+public final class TableFactorSegment implements SQLSegment {\n+    \n+    private int startIndex;\n+    \n+    private int stopIndex;\n+    \n+    private TableSegment table;", "originalCommit": "36ef256f74a7bc11afa7c65995a4240ef1e531ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5MDg5OQ==", "url": "https://github.com/apache/shardingsphere/pull/4916#discussion_r397790899", "bodyText": "ok", "author": "jingshanglu", "createdAt": "2020-03-25T11:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MTU3NA=="}], "type": "inlineReview"}, {"oid": "7377aa5f1c70c521ed30918f25830765273eeeb8", "url": "https://github.com/apache/shardingsphere/commit/7377aa5f1c70c521ed30918f25830765273eeeb8", "message": "fix", "committedDate": "2020-03-25T10:56:07Z", "type": "commit"}]}