{"pr_number": 3014, "pr_title": "Continuing S5856", "pr_createdAt": "2020-06-15T15:15:34Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3014", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1MTcwOQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3014#discussion_r440251709", "bodyText": "There is something fishy here... related to reporting.", "author": "m-g-sonar", "createdAt": "2020-06-15T15:16:37Z", "path": "java-frontend/src/main/java/org/sonar/java/regex/ast/BackReferenceTree.java", "diffHunk": "@@ -28,7 +28,7 @@\n   private final JavaCharacter key;\n \n   public BackReferenceTree(RegexSource source, JavaCharacter backslash, @Nullable JavaCharacter key, JavaCharacter start, JavaCharacter end) {\n-    super(source, backslash.getRange().merge(end.getRange()));\n+    super(source, backslash.getRange().extendTo(end.getRange().getBeginningOffset()));", "originalCommit": "d182d5e89ea1c2028d2079774bcc439d8b6c8920", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fb379d96591b9df9cb6adbdaab98cacdca992f6", "url": "https://github.com/SonarSource/sonar-java/commit/5fb379d96591b9df9cb6adbdaab98cacdca992f6", "message": "fix", "committedDate": "2020-06-15T15:20:58Z", "type": "forcePushed"}, {"oid": "9cd753bf7f2d6ebab94a7fe8ebc85598b30cca68", "url": "https://github.com/SonarSource/sonar-java/commit/9cd753bf7f2d6ebab94a7fe8ebc85598b30cca68", "message": "SONARJAVA-3420 Handle invalid groups in S5856", "committedDate": "2020-06-15T17:59:00Z", "type": "forcePushed"}, {"oid": "10d931c6dd746060a77dbc6891b53dc9e1b542b5", "url": "https://github.com/SonarSource/sonar-java/commit/10d931c6dd746060a77dbc6891b53dc9e1b542b5", "message": "[REGEX] Add group numbers", "committedDate": "2020-06-16T09:05:17Z", "type": "commit"}, {"oid": "48a9da839a368928e9c4bef513370b369d7fac5a", "url": "https://github.com/SonarSource/sonar-java/commit/48a9da839a368928e9c4bef513370b369d7fac5a", "message": "[REGEX] Make group names Optional", "committedDate": "2020-06-16T09:05:17Z", "type": "commit"}, {"oid": "9760169c20d11e301e831c1179ade6e9530a1734", "url": "https://github.com/SonarSource/sonar-java/commit/9760169c20d11e301e831c1179ade6e9530a1734", "message": "[REGEX] Fix issue with reporting of empty locations", "committedDate": "2020-06-16T09:05:17Z", "type": "commit"}, {"oid": "b9b0e5556ab88d9ccdd73f82c9e28e7d702dace3", "url": "https://github.com/SonarSource/sonar-java/commit/b9b0e5556ab88d9ccdd73f82c9e28e7d702dace3", "message": "SONARJAVA-3420 Handle invalid groups in S5856", "committedDate": "2020-06-16T09:05:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3ODAxNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3014#discussion_r440978016", "bodyText": "Interestingly, unlike named back references, numbered back references don't cause an exception when they don't exist. They just don't match anything when the group doesn't exist yet. You could even produce a marginally useful regex that refers to a group defined later that can actually produce a match: (?:(?:x|\\\\1)(.))+. This will match strings where the first character is an x and every other odd-numbered character is either an x or equal to the previous character. The equivalent using named captures will throw an exception.\nSo we might consider either not complaining about numbered back references at all (so we'd only be complaining about errors that cause an exception) or only complaining if the numbered back reference refers to a group that does not exist in the regex at all (i.e. referring to a group defined later would be allowed when using numbers), in which case the regex would still not cause an exception, but definitely be wrong.\nOn the other hand, we might also just say \"99% of the time referencing a not-yet-defined group is a mistake and the 1% FPs is acceptable\" and just leave it as-is.", "author": "sebastian-hungerecker-sonarsource", "createdAt": "2020-06-16T16:18:58Z", "path": "java-checks-test-sources/src/main/java/checks/regex/InvalidRegexCheck.java", "diffHunk": "@@ -13,10 +13,26 @@ void noncompliant(String str) {\n     str.replaceAll(\"x{1,2,3}|(\", \"x\"); // Noncompliant [[sc=26;ec=27;secondary=13,13]] {{Fix the syntax errors inside this regex.}}\n \n     str.matches(\"(\\\\w+-(\\\\d+)\"); // Noncompliant [[sc=30;ec=31;secondary=15]] {{Fix the syntax error inside this regex.}}\n+  }\n+\n+  void noncompliant_backreference(String str) {\n+    str.matches(\"(\\\\w+)-\\\\2\"); // Noncompliant {{Fix the back reference error inside this regex.}}\n+\n+    str.matches(\"(?<name>\\\\w+)-\\\\k<nae>\"); // Noncompliant {{Fix the back reference error inside this regex.}}\n \n-    str.matches(\"(\\\\w+)-\\\\2\"); // False Negative - group numbers not handled in rule\n+    str.matches(\n+      \"(?<g1>ab)\"\n+        + \"\\\\k<g2>\" // Noncompliant [[sc=12;ec=19;secondary=25,26]] {{Fix the back reference errors inside this regex.}}\n+        + \"\\\\k<g3>\"\n+        + \"(?<g2>cd)\"\n+        + \"(?<g3>ed)\");\n \n-    str.matches(\"(?<name>\\\\w+)-\\\\k<nae>\"); // False Negative - group names not handled in rule\n+    str.matches(\n+      \"(?<g1>ab)\"\n+        + \"\\\\2\" // Noncompliant [[sc=12;ec=15;secondary=32,33]] {{Fix the back reference errors inside this regex.}}", "originalCommit": "b9b0e5556ab88d9ccdd73f82c9e28e7d702dace3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk4MjgxMg==", "url": "https://github.com/SonarSource/sonar-java/pull/3014#discussion_r440982812", "bodyText": "On second thought, given that they do not cause an exception, it'd probably be best to not handle numeric back references here and instead handle them in the \"this pattern can never match\" rule.", "author": "sebastian-hungerecker-sonarsource", "createdAt": "2020-06-16T16:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3ODAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxMTY2Mg==", "url": "https://github.com/SonarSource/sonar-java/pull/3014#discussion_r441311662", "bodyText": "Fine by me, I'll only take into account named reference. And it will simplify the code of the rule as well!", "author": "m-g-sonar", "createdAt": "2020-06-17T06:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk3ODAxNg=="}], "type": "inlineReview"}, {"oid": "cf6971820690615ccc8b4dc357c661cfaf081121", "url": "https://github.com/SonarSource/sonar-java/commit/cf6971820690615ccc8b4dc357c661cfaf081121", "message": "SONARJAVA-3420 Handle invalid groups in S5856", "committedDate": "2020-06-17T07:16:18Z", "type": "commit"}, {"oid": "cf6971820690615ccc8b4dc357c661cfaf081121", "url": "https://github.com/SonarSource/sonar-java/commit/cf6971820690615ccc8b4dc357c661cfaf081121", "message": "SONARJAVA-3420 Handle invalid groups in S5856", "committedDate": "2020-06-17T07:16:18Z", "type": "forcePushed"}]}