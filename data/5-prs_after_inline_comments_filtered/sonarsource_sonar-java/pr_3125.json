{"pr_number": 3125, "pr_title": "SONARJAVA-3494: Improve performance of S2095", "pr_createdAt": "2020-08-03T08:40:20Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3125", "timeline": [{"oid": "f4e8a8f9f96be1f8b07e894b09d00913926d2999", "url": "https://github.com/SonarSource/sonar-java/commit/f4e8a8f9f96be1f8b07e894b09d00913926d2999", "message": "Do not recompute pattern all the time", "committedDate": "2020-08-05T11:55:58Z", "type": "commit"}, {"oid": "cd86413cc5bf8b910ea706ed24c3aeed1ffdebee", "url": "https://github.com/SonarSource/sonar-java/commit/cd86413cc5bf8b910ea706ed24c3aeed1ffdebee", "message": "Avoid checking for parents to get the enclosing type", "committedDate": "2020-08-05T11:55:58Z", "type": "commit"}, {"oid": "90bb5c16f80c13a076bbd14a314c275bf653d714", "url": "https://github.com/SonarSource/sonar-java/commit/90bb5c16f80c13a076bbd14a314c275bf653d714", "message": "Use stream instead of loop to simplify logic", "committedDate": "2020-08-05T11:55:58Z", "type": "commit"}, {"oid": "67ada734b4d09b096f1f2ba306813ba67f0c438f", "url": "https://github.com/SonarSource/sonar-java/commit/67ada734b4d09b096f1f2ba306813ba67f0c438f", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header", "committedDate": "2020-08-05T11:55:58Z", "type": "forcePushed"}, {"oid": "a310d06cd8469220803848f27b4c41cc6e889eb8", "url": "https://github.com/SonarSource/sonar-java/commit/a310d06cd8469220803848f27b4c41cc6e889eb8", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header", "committedDate": "2020-08-05T12:02:15Z", "type": "forcePushed"}, {"oid": "ddfff71d51160e04b6313e82f9c4f51cd0e83214", "url": "https://github.com/SonarSource/sonar-java/commit/ddfff71d51160e04b6313e82f9c4f51cd0e83214", "message": "Get rid of call to parent() when checking if resouces are within a try-with-resource header", "committedDate": "2020-08-05T12:30:59Z", "type": "commit"}, {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "url": "https://github.com/SonarSource/sonar-java/commit/2fa6afc04d6dc94149cc582e6a693c3707508ab2", "message": "Fix nullness issues", "committedDate": "2020-08-05T12:45:33Z", "type": "commit"}, {"oid": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "url": "https://github.com/SonarSource/sonar-java/commit/2fa6afc04d6dc94149cc582e6a693c3707508ab2", "message": "Fix nullness issues", "committedDate": "2020-08-05T12:45:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4NzEyMw==", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465787123", "bodyText": "What about going one step further and avoid creating it for every instance of PostStatementVisitor (having a static field of the check).", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-08-05T14:53:50Z", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -448,13 +467,15 @@ public void visitIdentifier(IdentifierTree tree) {\n \n   private class PostStatementVisitor extends CheckerTreeNodeVisitor {\n \n+    private final Pattern methodNamesOpeningResource = Pattern.compile(\"(new|create|open).*\");", "originalCommit": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMzQ0Mw==", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465803443", "bodyText": "It was not clear to me that the content of this set was used only to know if you already collected the resources from the try. Maybe renaming it as visitedTryWithResourcesTrees  or something like this would help?", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-08-05T15:16:11Z", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -87,6 +89,8 @@ public String valueAsString() {\n   public String excludedTypes = \"\";\n   private final List<String> excludedTypesList = new ArrayList<>();\n \n+  private final Set<TryStatementTree> tryWithResourcesTrees = new HashSet<>();", "originalCommit": "ddfff71d51160e04b6313e82f9c4f51cd0e83214", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwODE5OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r465808199", "bodyText": "Question: I would typically use a BaseTreeVisitor to do something like this, is there any reasons you are using something else?", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-08-05T15:22:46Z", "path": "java-frontend/src/main/java/org/sonar/java/se/checks/UnclosedResourcesCheck.java", "diffHunk": "@@ -129,18 +135,60 @@ public String valueAsString() {\n     .addWithoutParametersMatcher()\n     .build();\n \n+  @Override\n+  public void scanFile(JavaFileScannerContext context) {\n+    this.tryWithResourcesTrees.clear();\n+    this.knownResources.clear();\n+    super.scanFile(context);\n+  }\n+\n   @Override\n   public void init(MethodTree methodTree, CFG cfg) {\n     this.visitedMethodOwnerType = methodTree.symbol().owner().type();\n   }\n \n   @Override\n   public ProgramState checkPreStatement(CheckerContext context, Tree syntaxNode) {\n+    collectTryWithResources(syntaxNode);\n     final PreStatementVisitor visitor = new PreStatementVisitor(context);\n     syntaxNode.accept(visitor);\n     return visitor.programState;\n   }\n \n+  private void collectTryWithResources(Tree syntaxNode) {\n+    if (syntaxNode.is(Tree.Kind.TRY_STATEMENT)) {\n+      TryStatementTree tryStatementTree = (TryStatementTree) syntaxNode;\n+      ListTree<Tree> resourceList = tryStatementTree.resourceList();\n+      if (!resourceList.isEmpty() && tryWithResourcesTrees.add(tryStatementTree)) {\n+        knownResources.addAll(collectAllResourceTrees(resourceList));\n+      }\n+    }\n+  }\n+\n+  private static Set<Tree> collectAllResourceTrees(Tree tree) {", "originalCommit": "2fa6afc04d6dc94149cc582e6a693c3707508ab2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5NzU5MQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3125#discussion_r466197591", "bodyText": "I initially wanted to collect all possible trees, without exception, and with a BaseTreeVisitor I would have had to override all the methods to do so. On a second pass, I only collected identifiers, method invocations, and initializers, so the approach with a visitor is indeed easier to get.", "author": "m-g-sonar", "createdAt": "2020-08-06T07:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwODE5OQ=="}], "type": "inlineReview"}, {"oid": "becd0d4b26a186348000f1bd4cecf19814d6a0a8", "url": "https://github.com/SonarSource/sonar-java/commit/becd0d4b26a186348000f1bd4cecf19814d6a0a8", "message": "Fix from review", "committedDate": "2020-08-06T07:31:42Z", "type": "commit"}]}