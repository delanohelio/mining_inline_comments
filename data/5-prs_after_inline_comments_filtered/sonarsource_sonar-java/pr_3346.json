{"pr_number": 3346, "pr_title": "SONARJAVA-3632 Rule S6104: Map \"computeIfAbsent()\" should not be used to add \"null\" values.", "pr_createdAt": "2020-12-10T16:00:48Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/3346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc1NTU3OQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540755579", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n          \n          \n            \n              privvate static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T07:56:43Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc1NTcwMg==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540755702", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n          \n          \n            \n              privvate static final String SECONDARY_MESSAGE = \"null literal in the arguments\";", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T07:56:58Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc1NzMwMg==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540757302", "bodyText": "Let's put these two methods at the end, in order to respect the convention we have on the main code, and let the interesting code actually testing stuff at the beginning.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:00:19Z", "path": "java-checks-test-sources/src/main/java/checks/NullReturnedOnComputeIfPresentOrAbsent.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package checks;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.TreeMap;\n+\n+public class NullReturnedOnComputeIfPresentOrAbsent {\n+\n+  public static String presentLambda(String k, String v) {\n+    return null;\n+  }\n+\n+  public static String absentLambda(String k) {\n+    return null;\n+  }", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2MTQyOA==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540761428", "bodyText": "Just to clarify, by default, AbstractMethodDetection visits the three nodes Tree.Kind.METHOD_INVOCATION, Tree.Kind.NEW_CLASS, Tree.Kind.METHOD_REFERENCE, so if you don't add this method, the check would still work fine.\nThat being said, we are only looking for METHOD_INVOCATION, so overriding this method here sounds like a nice optimization.\nMaybe this deserves a small comment?", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:08:37Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2Mzc5MQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540763791", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                getNullReturn(arguments.get(1))\n          \n          \n            \n                  .ifPresent(body -> reportIssue(ExpressionUtils.methodName(invocation),\n          \n          \n            \n                getNullReturn(arguments.get(1)).ifPresent(body -> \n          \n          \n            \n                   reportIssue(ExpressionUtils.methodName(invocation),\n          \n      \n    \n    \n  \n\nWe are usually following this formatting instead.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:12:55Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }\n+\n+  @Override\n+  public void onMethodInvocationFound(MethodInvocationTree invocation) {\n+    Arguments arguments = invocation.arguments();\n+    getNullReturn(arguments.get(1))\n+      .ifPresent(body -> reportIssue(ExpressionUtils.methodName(invocation),", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2NjU0OA==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540766548", "bodyText": "I would not add a new line for this method call and put it next to the type, the same way you would do for stream for example:\nlist.stream()\n  .map(...)\n  .collect(...)", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:18:07Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2ODU0MQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540768541", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static Optional<Tree> getNullReturn(Tree tree) {\n          \n          \n            \n              private static Optional<Tree> getNullReturn(Tree tree) {", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:21:48Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }\n+\n+  @Override\n+  public void onMethodInvocationFound(MethodInvocationTree invocation) {\n+    Arguments arguments = invocation.arguments();\n+    getNullReturn(arguments.get(1))\n+      .ifPresent(body -> reportIssue(ExpressionUtils.methodName(invocation),\n+        PRIMARY_MESSAGE,\n+        Collections.singletonList(new JavaFileScannerContext.Location(SECONDARY_MESSAGE, body)),\n+        null));\n+  }\n+\n+  @Override\n+  protected MethodMatchers getMethodInvocationMatchers() {\n+    return COMPUTE_IF;\n+  }\n+\n+  public static Optional<Tree> getNullReturn(Tree tree) {", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2OTcyMA==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540769720", "bodyText": "I would rather put this method above onMethodInvocationFound so that when reading the code from top to bottom, we know what kind of MethodInvocationTree will be received by onMethodInvocationFound.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:24:00Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }\n+\n+  @Override\n+  public void onMethodInvocationFound(MethodInvocationTree invocation) {\n+    Arguments arguments = invocation.arguments();\n+    getNullReturn(arguments.get(1))\n+      .ifPresent(body -> reportIssue(ExpressionUtils.methodName(invocation),\n+        PRIMARY_MESSAGE,\n+        Collections.singletonList(new JavaFileScannerContext.Location(SECONDARY_MESSAGE, body)),\n+        null));\n+  }\n+\n+  @Override\n+  protected MethodMatchers getMethodInvocationMatchers() {\n+    return COMPUTE_IF;\n+  }", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3MTcwNg==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540771706", "bodyText": "Maybe getNullReturnInLambda would better describe what it is actually doing.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:27:29Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }\n+\n+  @Override\n+  public void onMethodInvocationFound(MethodInvocationTree invocation) {\n+    Arguments arguments = invocation.arguments();\n+    getNullReturn(arguments.get(1))", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3MzUzMw==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540773533", "bodyText": "body as the name of the lambda parameter sounds strange, I have no indication that this will actually always be a null literal. We should rename it to reflect what it really is.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T08:30:29Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  public static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  public static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers\n+    .create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override\n+  public List<Tree.Kind> nodesToVisit() {\n+    return Collections.singletonList(Tree.Kind.METHOD_INVOCATION);\n+  }\n+\n+  @Override\n+  public void onMethodInvocationFound(MethodInvocationTree invocation) {\n+    Arguments arguments = invocation.arguments();\n+    getNullReturn(arguments.get(1))\n+      .ifPresent(body -> reportIssue(ExpressionUtils.methodName(invocation),\n+        PRIMARY_MESSAGE,\n+        Collections.singletonList(new JavaFileScannerContext.Location(SECONDARY_MESSAGE, body)),", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NDIzMw==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r540794233", "bodyText": "Same here idea as the comment in the main code, you don't need to separate the method call from the type.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-11T09:06:23Z", "path": "java-checks/src/test/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheckTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import org.junit.jupiter.api.Test;\n+import org.sonar.java.checks.verifier.JavaCheckVerifier;\n+\n+import static org.sonar.java.CheckTestUtils.testSourcesPath;\n+\n+class NullReturnedOnComputeIfPresentOrAbsentCheckTest {\n+  @Test\n+  void test() {\n+    JavaCheckVerifier\n+      .newVerifier()", "originalCommit": "52543908c0ea5ee3718419763c580a3a8f55c03d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ba5fa33c8231c643bafcb883bd45dae3ccdff66", "url": "https://github.com/SonarSource/sonar-java/commit/2ba5fa33c8231c643bafcb883bd45dae3ccdff66", "message": "SONAR-3632 Tweaks from code review feedback", "committedDate": "2020-12-11T15:23:06Z", "type": "forcePushed"}, {"oid": "8f3304cfa4ba7af7cb0f2e49296f3edce7813fb9", "url": "https://github.com/SonarSource/sonar-java/commit/8f3304cfa4ba7af7cb0f2e49296f3edce7813fb9", "message": "SONARJAVA-3632 S6104: Generation of rule files", "committedDate": "2020-12-14T10:39:32Z", "type": "commit"}, {"oid": "54b76ebf00183d702abd3d295561d8e424cbf4c1", "url": "https://github.com/SonarSource/sonar-java/commit/54b76ebf00183d702abd3d295561d8e424cbf4c1", "message": "SONARJAVA-3632 S6104: Report issue for computeIfPresent", "committedDate": "2020-12-14T10:39:41Z", "type": "commit"}, {"oid": "a906c0bed8e95fea4445faefe19ed78e1b4478d0", "url": "https://github.com/SonarSource/sonar-java/commit/a906c0bed8e95fea4445faefe19ed78e1b4478d0", "message": "SONARJAVA-3632 S6104: Report issue on computeIfAbsent", "committedDate": "2020-12-14T10:39:52Z", "type": "commit"}, {"oid": "239bb7b772c8a1515bde5ed6b3f010525d73402a", "url": "https://github.com/SonarSource/sonar-java/commit/239bb7b772c8a1515bde5ed6b3f010525d73402a", "message": "SONARJAVA-3632 S6104: Add message for secondary location", "committedDate": "2020-12-14T10:39:52Z", "type": "commit"}, {"oid": "d1756c7e77c692c7bb47950b62ee4b16ca94e93b", "url": "https://github.com/SonarSource/sonar-java/commit/d1756c7e77c692c7bb47950b62ee4b16ca94e93b", "message": "SONARJAVA-3632 Fix remaining issues on pull request", "committedDate": "2020-12-14T10:41:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ3Njc2NQ==", "url": "https://github.com/SonarSource/sonar-java/pull/3346#discussion_r542476765", "bodyText": "This annotation should go after the javadoc.", "author": "quentin-jaquier-sonarsource", "createdAt": "2020-12-14T15:31:58Z", "path": "java-checks/src/main/java/org/sonar/java/checks/NullReturnedOnComputeIfPresentOrAbsentCheck.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.java.checks;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import org.sonar.check.Rule;\n+import org.sonar.java.checks.methods.AbstractMethodDetection;\n+import org.sonar.java.model.ExpressionUtils;\n+import org.sonar.plugins.java.api.JavaFileScannerContext;\n+import org.sonar.plugins.java.api.semantic.MethodMatchers;\n+import org.sonar.plugins.java.api.tree.Arguments;\n+import org.sonar.plugins.java.api.tree.LambdaExpressionTree;\n+import org.sonar.plugins.java.api.tree.MethodInvocationTree;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+@Rule(key = \"S6104\")\n+public class NullReturnedOnComputeIfPresentOrAbsentCheck extends AbstractMethodDetection {\n+  private static final String PRIMARY_MESSAGE = \"Use \\\"Map.containsKey(key)\\\" followed by \\\"Map.put(key, null)\\\" to add null values.\";\n+  private static final String SECONDARY_MESSAGE = \"null literal in the arguments\";\n+  private static final MethodMatchers COMPUTE_IF = MethodMatchers.create()\n+    .ofTypes(\"java.util.Map\")\n+    .names(\"computeIfPresent\", \"computeIfAbsent\")\n+    .addParametersMatcher(MethodMatchers.ANY, MethodMatchers.ANY)\n+    .build();\n+\n+  @Override", "originalCommit": "d1756c7e77c692c7bb47950b62ee4b16ca94e93b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "07a92d615f7922e98697bc8b35fdb78f9c881eca", "url": "https://github.com/SonarSource/sonar-java/commit/07a92d615f7922e98697bc8b35fdb78f9c881eca", "message": "SONARJAVA-3632 S6104: Refactor check as an AbstractMethodDetection and enable in checklist", "committedDate": "2020-12-14T15:55:52Z", "type": "commit"}, {"oid": "d2e89ebbabc51f3520197608524ba92f3c2ec201", "url": "https://github.com/SonarSource/sonar-java/commit/d2e89ebbabc51f3520197608524ba92f3c2ec201", "message": "SONARJAVA-3632 Tweaks from code review feedback", "committedDate": "2020-12-14T15:56:15Z", "type": "commit"}, {"oid": "78bee60e3a15ad25626e82990d00ac3386495809", "url": "https://github.com/SonarSource/sonar-java/commit/78bee60e3a15ad25626e82990d00ac3386495809", "message": "SONARJAVA-3632 Fix remaining issues on pull request", "committedDate": "2020-12-14T15:56:15Z", "type": "commit"}, {"oid": "55f7350fd95a57488a6c50ce1dad9525ad8f918e", "url": "https://github.com/SonarSource/sonar-java/commit/55f7350fd95a57488a6c50ce1dad9525ad8f918e", "message": "SONARJAVA-3632 Move annotation closer to method signature", "committedDate": "2020-12-14T15:57:48Z", "type": "commit"}, {"oid": "55f7350fd95a57488a6c50ce1dad9525ad8f918e", "url": "https://github.com/SonarSource/sonar-java/commit/55f7350fd95a57488a6c50ce1dad9525ad8f918e", "message": "SONARJAVA-3632 Move annotation closer to method signature", "committedDate": "2020-12-14T15:57:48Z", "type": "forcePushed"}]}