{"pr_number": 2880, "pr_title": "SONARJAVA-3310 Provide source maps for generated files", "pr_createdAt": "2020-03-17T22:58:22Z", "pr_url": "https://github.com/SonarSource/sonar-java/pull/2880", "timeline": [{"oid": "96ab88d321952bf581fbf062fe6c26fb981fbdbc", "url": "https://github.com/SonarSource/sonar-java/commit/96ab88d321952bf581fbf062fe6c26fb981fbdbc", "message": "SONARJAVA-3310 Provide source maps for generated files", "committedDate": "2020-03-17T23:18:23Z", "type": "forcePushed"}, {"oid": "3b95013bcf75686be2ed470cd3af657ba366bd6e", "url": "https://github.com/SonarSource/sonar-java/commit/3b95013bcf75686be2ed470cd3af657ba366bd6e", "message": "more tests", "committedDate": "2020-03-18T16:44:22Z", "type": "forcePushed"}, {"oid": "31eaee57538c83d2e6e156e07ebdf29feec2492f", "url": "https://github.com/SonarSource/sonar-java/commit/31eaee57538c83d2e6e156e07ebdf29feec2492f", "message": "more tests", "committedDate": "2020-03-18T20:26:37Z", "type": "forcePushed"}, {"oid": "852d0ff446f68afed1997ab388fc35e56147a780", "url": "https://github.com/SonarSource/sonar-java/commit/852d0ff446f68afed1997ab388fc35e56147a780", "message": "more tests", "committedDate": "2020-03-18T22:34:02Z", "type": "forcePushed"}, {"oid": "1c18985e790d4ae10c3342bd183b47df32b23aa1", "url": "https://github.com/SonarSource/sonar-java/commit/1c18985e790d4ae10c3342bd183b47df32b23aa1", "message": "SONARJAVA-3310 Provide source maps for generated files", "committedDate": "2020-03-19T08:28:30Z", "type": "forcePushed"}, {"oid": "1d348e3779676e5c54900ae86614eff9d9bec74a", "url": "https://github.com/SonarSource/sonar-java/commit/1d348e3779676e5c54900ae86614eff9d9bec74a", "message": "SONARJAVA-3310 Provide source maps for generated files", "committedDate": "2020-03-19T08:52:03Z", "type": "forcePushed"}, {"oid": "4f16e667a61b6ffc3cecc9ee4cd63f480cc662de", "url": "https://github.com/SonarSource/sonar-java/commit/4f16e667a61b6ffc3cecc9ee4cd63f480cc662de", "message": "SONARJAVA-3310 Provide source maps for generated files", "committedDate": "2020-03-20T14:22:13Z", "type": "forcePushed"}, {"oid": "85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "url": "https://github.com/SonarSource/sonar-java/commit/85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "message": "Add -webapp parameter to Jasper", "committedDate": "2020-03-23T08:05:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5NjU1OA==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396496558", "bodyText": "Why not rely on Optional, rather than introducing another method which could lead to NPEs?", "author": "m-g-sonar", "createdAt": "2020-03-23T14:34:45Z", "path": "java-frontend/src/main/java/org/sonar/plugins/java/api/JavaFileScannerContext.java", "diffHunk": "@@ -225,4 +225,14 @@ public int hashCode() {\n       return Objects.hash(msg, syntaxNode);\n     }\n   }\n+\n+  /**\n+   * Return JSR 45 source map for current input file\n+   * @return source map or {@code null} if there is no source map available\n+   */\n+  @Nullable\n+  default SourceMap sourceMap() {", "originalCommit": "85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5OTUzOA==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396499538", "bodyText": "if this can throws a runtime exception, are we going to be able to recover from it?\nIt seems to me that it's not the case and it will interrupt the whole process, ultimately interrupting the analysis.\nAre you sure it is working according to our failfast policy? I can't see a test recovering from it, only some test checking the thrown exception.", "author": "m-g-sonar", "createdAt": "2020-03-23T14:38:45Z", "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -27,24 +28,131 @@\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n import javax.annotation.CheckForNull;\n+import javax.annotation.Nullable;\n import org.sonar.api.batch.fs.InputFile;\n import org.sonar.api.batch.fs.TextPointer;\n import org.sonar.api.batch.fs.TextRange;\n+import org.sonar.plugins.java.api.SourceMap;\n+import org.sonar.plugins.java.api.SourceMap.Location;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n \n public class GeneratedFile implements InputFile {\n \n   private final Path path;\n \n-  private final InputFile source;\n+  private final List<SmapFile> smapFiles = new ArrayList<>();\n+\n+  private SourceMap sourceMap;\n \n-  public GeneratedFile(Path path, InputFile source) {\n+  public GeneratedFile(Path path) {\n     this.path = path;\n-    this.source = source;\n   }\n \n-  public InputFile getSource() {\n-    return source;\n+  public SourceMap sourceMap() {\n+    if (sourceMap == null) {\n+      sourceMap = new SourceMapImpl();\n+    }\n+    return sourceMap;\n+  }\n+\n+  public void addSmap(SmapFile smap) {\n+    if (!smap.getGeneratedFile().equals(path)) {\n+      throw new IllegalStateException(\"Invalid smap \" + smap + \" for this generated file \" + path);", "originalCommit": "85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwOTgwNw==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396609807", "bodyText": "good point, I changed that it only prints warning into the log. I had to refactor unit test to use log tester", "author": "saberduck", "createdAt": "2020-03-23T17:03:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5OTUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwNzk3NQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396507975", "bodyText": "I'm really not a big fan of double-nesting lambdas. I strongly feel it does not help debugging either.\nWould it be possible to just rewrite the first one in a more traditional foreach loop : for(SmapFile sm : smapFiles) { ... } and maybe extract the second big block into a dedicated method?", "author": "m-g-sonar", "createdAt": "2020-03-23T14:49:50Z", "path": "java-frontend/src/main/java/org/sonar/java/model/GeneratedFile.java", "diffHunk": "@@ -27,24 +28,131 @@\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n import javax.annotation.CheckForNull;\n+import javax.annotation.Nullable;\n import org.sonar.api.batch.fs.InputFile;\n import org.sonar.api.batch.fs.TextPointer;\n import org.sonar.api.batch.fs.TextRange;\n+import org.sonar.plugins.java.api.SourceMap;\n+import org.sonar.plugins.java.api.SourceMap.Location;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+import static java.lang.Math.max;\n+import static java.lang.Math.min;\n \n public class GeneratedFile implements InputFile {\n \n   private final Path path;\n \n-  private final InputFile source;\n+  private final List<SmapFile> smapFiles = new ArrayList<>();\n+\n+  private SourceMap sourceMap;\n \n-  public GeneratedFile(Path path, InputFile source) {\n+  public GeneratedFile(Path path) {\n     this.path = path;\n-    this.source = source;\n   }\n \n-  public InputFile getSource() {\n-    return source;\n+  public SourceMap sourceMap() {\n+    if (sourceMap == null) {\n+      sourceMap = new SourceMapImpl();\n+    }\n+    return sourceMap;\n+  }\n+\n+  public void addSmap(SmapFile smap) {\n+    if (!smap.getGeneratedFile().equals(path)) {\n+      throw new IllegalStateException(\"Invalid smap \" + smap + \" for this generated file \" + path);\n+    }\n+    smapFiles.add(smap);\n+  }\n+\n+  class SourceMapImpl implements SourceMap {\n+\n+    final Map<Integer, Location> lines = new HashMap<>();\n+\n+    private SourceMapImpl() {\n+      smapFiles.forEach(sm -> sm.getLineSection().forEach(lineInfo -> {", "originalCommit": "85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxMDgyMg==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396610822", "bodyText": "I removed the lambdas, but I don't think there is a need for dedicated method in this case", "author": "saberduck", "createdAt": "2020-03-23T17:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwNzk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NjAyOQ==", "url": "https://github.com/SonarSource/sonar-java/pull/2880#discussion_r396566029", "bodyText": "What about using Optional here as well?", "author": "m-g-sonar", "createdAt": "2020-03-23T16:04:18Z", "path": "java-frontend/src/main/java/org/sonar/plugins/java/api/SourceMap.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * SonarQube Java\n+ * Copyright (C) 2012-2020 SonarSource SA\n+ * mailto:info AT sonarsource DOT com\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public License\n+ * along with this program; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n+ */\n+package org.sonar.plugins.java.api;\n+\n+import com.google.common.annotations.Beta;\n+import java.nio.file.Path;\n+import javax.annotation.Nullable;\n+import org.sonar.plugins.java.api.tree.Tree;\n+\n+/**\n+ * Represents source map between generated Java code and JSP file\n+ */\n+@Beta\n+public interface SourceMap {\n+\n+  /**\n+   * Return location in JSP file corresponding to the AST node\n+   *\n+   * @return location in JSP file or null\n+   */\n+  @Nullable\n+  Location sourceMapLocationFor(Tree tree);", "originalCommit": "85a0941a71788d26bd1fd1d9f90fb3a0fe6b0f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dcc21b5746c13b0584d1acf69d6df525662dab04", "url": "https://github.com/SonarSource/sonar-java/commit/dcc21b5746c13b0584d1acf69d6df525662dab04", "message": "SONARJAVA-3310 Provide source maps for generated files", "committedDate": "2020-03-23T17:05:53Z", "type": "commit"}, {"oid": "dec67506bb8a3836ecf2c0ec2635d06ae68a7e98", "url": "https://github.com/SonarSource/sonar-java/commit/dec67506bb8a3836ecf2c0ec2635d06ae68a7e98", "message": "Add -webapp parameter to Jasper", "committedDate": "2020-03-23T17:05:53Z", "type": "commit"}, {"oid": "c966b672354c92859bfd0a744d2942ee0abc63bc", "url": "https://github.com/SonarSource/sonar-java/commit/c966b672354c92859bfd0a744d2942ee0abc63bc", "message": "feedback from review", "committedDate": "2020-03-23T17:05:53Z", "type": "commit"}, {"oid": "c966b672354c92859bfd0a744d2942ee0abc63bc", "url": "https://github.com/SonarSource/sonar-java/commit/c966b672354c92859bfd0a744d2942ee0abc63bc", "message": "feedback from review", "committedDate": "2020-03-23T17:05:53Z", "type": "forcePushed"}]}