{"pr_number": 366, "pr_title": "NMA-453 Fix for Notification / Network Monitor do not update during sync process", "pr_createdAt": "2020-04-03T05:22:58Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/366", "timeline": [{"oid": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "url": "https://github.com/dashevo/dash-wallet/commit/2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "message": "BlockchainServiceImpl: Replace sync percentage, broadcast actions and\nupdate blockchains state more regularly", "committedDate": "2020-04-03T05:11:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0MzM2NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402743365", "bodyText": "before the Prevent Sending when Syncing story in v7 or v6, this was where the blockchain state was updated and broadcast.", "author": "HashEngineering", "createdAt": "2020-04-03T05:24:23Z", "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -377,19 +378,32 @@ public void run() {\n                     if(timeAgo < DateUtils.DAY_IN_MILLIS)\n                         config.setRestoringBackup(false);\n                 }\n+                // this method is always called after progress or doneDownload\n+                updateBlockchainState();", "originalCommit": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDQ5NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402744495", "bodyText": "There may be a better way to do this in the BlockListFragment, with a database observer.  For now this is the quickest way to trigger the block loader in BlockListFragment without more significant rewrites.", "author": "HashEngineering", "createdAt": "2020-04-03T05:28:55Z", "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -1026,6 +1040,11 @@ private void broadcastPeerState(final int numPeers) {\n     }\n \n     private void handleBlockchainStateNotification(BlockchainState blockchainState) {\n+        // send this out for the Network Monitor, other activities observe the database\n+        final Intent broadcast = new Intent(ACTION_BLOCKCHAIN_STATE);\n+        broadcast.setPackage(getPackageName());\n+        LocalBroadcastManager.getInstance(this).sendBroadcast(broadcast);", "originalCommit": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDkwOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/366#discussion_r402744909", "bodyText": "This is a calculation that gives the percentage in terms how much the entire blockchain is synced (from block 0).  This is some left over code that should have been caught in a previous review 4 months ago when the method was changed to match what dashj provides in the progress method above.  If a user starts the app after 1 week with this code, the % will be displayed as 99% instead of 0 when the app starts to sync.", "author": "HashEngineering", "createdAt": "2020-04-03T05:30:52Z", "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -1045,19 +1064,7 @@ private void handleBlockchainStateNotification(BlockchainState blockchainState)\n     }\n \n     private int percentageSync() {\n-        int chainHeadHeight = blockChain.getChainHead().getHeight();\n-        int mostCommonChainHeight;\n-        if (peerGroup == null) {\n-            return 0;\n-        }\n-        if (peerGroup.getMostCommonChainHeight() > 0) {\n-            mostCommonChainHeight = peerGroup.getMostCommonChainHeight();\n-        } else {\n-            mostCommonChainHeight = chainHeadHeight;\n-        }\n-        float percentage = ((float) chainHeadHeight / (float) mostCommonChainHeight) * 100;\n-        log.info(\"mostCommonChainHeight: \" + mostCommonChainHeight + \"\\tchainHeadHeight: \" + chainHeadHeight + \"\\t\" + percentage + \"%\\t\" + config.getBestChainHeightEver());\n-        return (int) percentage;\n+        return syncPercentage;", "originalCommit": "2db5bdef8f4081ff839dfe541f30f6937a4ca99b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}