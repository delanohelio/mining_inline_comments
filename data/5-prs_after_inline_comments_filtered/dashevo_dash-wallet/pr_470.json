{"pr_number": 470, "pr_title": "Another attempt to fix the KRIP crash on Android 8.0/8.1", "pr_createdAt": "2020-08-03T13:52:43Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/470", "timeline": [{"oid": "0d2036f271a6b0cd26883b03294db4286730084c", "url": "https://github.com/dashevo/dash-wallet/commit/0d2036f271a6b0cd26883b03294db4286730084c", "message": "Using JobScheduler instead of AlarmManager to trigger periodic blockchain sync on Android 8.0 and 8.1", "committedDate": "2020-08-03T13:51:10Z", "type": "commit"}, {"oid": "2ced1beeac1526981290831ac55cd1449cb2b26f", "url": "https://github.com/dashevo/dash-wallet/commit/2ced1beeac1526981290831ac55cd1449cb2b26f", "message": "Force startForeground of BlockchainServiceImpl from ServiceConnection to make sure the Krip crash is fixed", "committedDate": "2020-08-03T16:05:03Z", "type": "commit"}, {"oid": "b6b8e6bc45e80ba23739559f3dde61176ef1be42", "url": "https://github.com/dashevo/dash-wallet/commit/b6b8e6bc45e80ba23739559f3dde61176ef1be42", "message": "Avoid rescheduling existing  blockchain sync job with the same interval", "committedDate": "2020-08-03T16:39:14Z", "type": "commit"}, {"oid": "91474fb2861fc7637f61e60ca1682c1c69da94c9", "url": "https://github.com/dashevo/dash-wallet/commit/91474fb2861fc7637f61e60ca1682c1c69da94c9", "message": "Moved the custom sync scheduling below `alarmManager.cancel(alarmIntent);` to force removing existing alarms also on Android 8/8.1", "committedDate": "2020-08-03T16:59:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4ODU3Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/470#discussion_r467188572", "bodyText": "Lets report the interval in minutes.", "author": "HashEngineering", "createdAt": "2020-08-07T17:58:17Z", "path": "wallet/src/de/schildbach/wallet/WalletApplication.java", "diffHunk": "@@ -713,10 +720,27 @@ else if (lastUsedAgo < Constants.LAST_USAGE_THRESHOLD_RECENTLY_MS)\n         }\n         alarmManager.cancel(alarmIntent);\n \n-        // workaround for no inexact set() before KitKat\n-        final long now = System.currentTimeMillis();\n-        alarmManager.setInexactRepeating(AlarmManager.RTC_WAKEUP, now + alarmInterval, AlarmManager.INTERVAL_DAY,\n-                alarmIntent);\n+        if (Build.VERSION.SDK_INT == Build.VERSION_CODES.O || Build.VERSION.SDK_INT == Build.VERSION_CODES.O_MR1) {\n+            log.info(\"custom sync scheduling with JobScheduler for Android 8 and 8.1\");\n+            JobScheduler jobScheduler = (JobScheduler) context.getSystemService(Context.JOB_SCHEDULER_SERVICE);\n+            JobInfo pendingJob = jobScheduler.getPendingJob(BLOCKCHAIN_SYNC_JOB_ID);\n+            if (pendingJob == null || pendingJob.getIntervalMillis() != alarmInterval) {\n+                ComponentName jobService = new ComponentName(context, BlockchainSyncJobService.class);\n+                JobInfo jobInfo = new JobInfo.Builder(BLOCKCHAIN_SYNC_JOB_ID, jobService)\n+                        .setPeriodic(alarmInterval)\n+                        .setPersisted(true)\n+                        .build();\n+                int scheduleResult = jobScheduler.schedule(jobInfo);\n+                log.info(\"scheduling blockchain sync job with interval of {}s, result: {}\", alarmInterval / 1000, scheduleResult);\n+            } else {\n+                log.info(\"blockchain sync job already scheduled with interval of {}s\", alarmInterval / 1000);", "originalCommit": "91474fb2861fc7637f61e60ca1682c1c69da94c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgyMjY4OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/470#discussion_r467822689", "bodyText": "Fixed", "author": "tomasz-ludek", "createdAt": "2020-08-10T10:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4ODU3Mg=="}], "type": "inlineReview"}, {"oid": "69c39b39ffb457655562090df16b10d209e14ca0", "url": "https://github.com/dashevo/dash-wallet/commit/69c39b39ffb457655562090df16b10d209e14ca0", "message": "Changed unit of logging periodic sync time from seconds to minutes in order to increase readability", "committedDate": "2020-08-10T10:45:58Z", "type": "commit"}]}