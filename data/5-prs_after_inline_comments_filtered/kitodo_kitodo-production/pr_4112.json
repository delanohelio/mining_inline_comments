{"pr_number": 4112, "pr_title": "Implement variable replacer for copy data", "pr_createdAt": "2020-12-01T09:40:01Z", "pr_url": "https://github.com/kitodo/kitodo-production/pull/4112", "timeline": [{"oid": "b76b558af752e547a03d5d47bd9295e6f045ed77", "url": "https://github.com/kitodo/kitodo-production/commit/b76b558af752e547a03d5d47bd9295e6f045ed77", "message": "add script for addData", "committedDate": "2020-11-26T13:25:08Z", "type": "commit"}, {"oid": "1e40812d2c451cf62e10ad1789c32007a52a38a6", "url": "https://github.com/kitodo/kitodo-production/commit/1e40812d2c451cf62e10ad1789c32007a52a38a6", "message": "fix issues", "committedDate": "2020-11-26T13:25:08Z", "type": "commit"}, {"oid": "8526bbb642a699cd26ccf3f8e87e1f48daef7eb6", "url": "https://github.com/kitodo/kitodo-production/commit/8526bbb642a699cd26ccf3f8e87e1f48daef7eb6", "message": "add deleteDataScript", "committedDate": "2020-11-30T13:11:13Z", "type": "commit"}, {"oid": "b3a512a437d6abd828cb5bde45081ddc67c7b70d", "url": "https://github.com/kitodo/kitodo-production/commit/b3a512a437d6abd828cb5bde45081ddc67c7b70d", "message": "fix codacy", "committedDate": "2020-11-30T13:11:14Z", "type": "commit"}, {"oid": "766b0cb8bc40217b5aa5ea5f2597aaa704afecc5", "url": "https://github.com/kitodo/kitodo-production/commit/766b0cb8bc40217b5aa5ea5f2597aaa704afecc5", "message": "fix testSyntax", "committedDate": "2020-11-30T13:33:53Z", "type": "commit"}, {"oid": "5901bd0d9df87dfb7694b4f1db5e4b609ba48ad0", "url": "https://github.com/kitodo/kitodo-production/commit/5901bd0d9df87dfb7694b4f1db5e4b609ba48ad0", "message": "add overwrite functionality", "committedDate": "2020-11-30T13:34:31Z", "type": "commit"}, {"oid": "4c02aa3db2f194419afac352efb7bdb2d118020d", "url": "https://github.com/kitodo/kitodo-production/commit/4c02aa3db2f194419afac352efb7bdb2d118020d", "message": "fix codacy", "committedDate": "2020-12-01T09:56:10Z", "type": "commit"}, {"oid": "ad864c7a9b05e6dfc772e24dfc143308d3d7cff3", "url": "https://github.com/kitodo/kitodo-production/commit/ad864c7a9b05e6dfc772e24dfc143308d3d7cff3", "message": "integrate variable replacer", "committedDate": "2020-12-01T09:56:44Z", "type": "commit"}, {"oid": "ad864c7a9b05e6dfc772e24dfc143308d3d7cff3", "url": "https://github.com/kitodo/kitodo-production/commit/ad864c7a9b05e6dfc772e24dfc143308d3d7cff3", "message": "integrate variable replacer", "committedDate": "2020-12-01T09:56:44Z", "type": "forcePushed"}, {"oid": "b5051a92a386d6638e6d1760e9e4ff99c6a7faf2", "url": "https://github.com/kitodo/kitodo-production/commit/b5051a92a386d6638e6d1760e9e4ff99c6a7faf2", "message": "fix codacy", "committedDate": "2020-12-02T09:13:40Z", "type": "commit"}, {"oid": "b5051a92a386d6638e6d1760e9e4ff99c6a7faf2", "url": "https://github.com/kitodo/kitodo-production/commit/b5051a92a386d6638e6d1760e9e4ff99c6a7faf2", "message": "fix codacy", "committedDate": "2020-12-02T09:13:40Z", "type": "forcePushed"}, {"oid": "0fd979e97727c2848fecad71b5441832ab56c9a3", "url": "https://github.com/kitodo/kitodo-production/commit/0fd979e97727c2848fecad71b5441832ab56c9a3", "message": "add tests for whitespace and multiple scripts", "committedDate": "2020-12-03T08:01:49Z", "type": "commit"}, {"oid": "0fd979e97727c2848fecad71b5441832ab56c9a3", "url": "https://github.com/kitodo/kitodo-production/commit/0fd979e97727c2848fecad71b5441832ab56c9a3", "message": "add tests for whitespace and multiple scripts", "committedDate": "2020-12-03T08:01:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjA0NQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539102045", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.production.services.ServiceManager;", "author": "solth", "createdAt": "2020-12-09T08:26:18Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopier.java", "diffHunk": "@@ -19,6 +19,7 @@\n import org.apache.commons.configuration.ConfigurationException;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.kitodo.production.services.ServiceManager;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMzAwNw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539103007", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.production.services.data.ImportService;\n          \n          \n            \n            import org.primefaces.PrimeFaces;", "author": "solth", "createdAt": "2020-12-09T08:27:37Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopyrule.java", "diffHunk": "@@ -11,79 +11,34 @@\n \n package org.kitodo.production.metadata.copier;\n \n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n import org.apache.commons.configuration.ConfigurationException;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.MetadataGroup;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;\n import org.kitodo.exceptions.MetadataException;\n+import org.kitodo.production.helper.Helper;\n+import org.kitodo.production.services.ServiceManager;\n+import org.kitodo.production.services.data.ImportService;\n+import org.primefaces.PrimeFaces;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMzMyNw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539103327", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.production.helper.Helper;", "author": "solth", "createdAt": "2020-12-09T08:28:08Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopyrule.java", "diffHunk": "@@ -11,79 +11,34 @@\n \n package org.kitodo.production.metadata.copier;\n \n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n import org.apache.commons.configuration.ConfigurationException;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.MetadataGroup;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;\n import org.kitodo.exceptions.MetadataException;\n+import org.kitodo.production.helper.Helper;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNDEwOQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539104109", "bodyText": "Use Helper or logger instead of System.out.println", "author": "solth", "createdAt": "2020-12-09T08:29:26Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopyrule.java", "diffHunk": "@@ -92,44 +47,27 @@ public static DataCopyrule createFor(List<String> arguments) throws Configuratio\n      * @param data\n      *            data to apply yourself on\n      */\n-    protected abstract void apply(CopierData data);\n-\n-    /**\n-     * The function getMinObject must return the maximal number of objects\n-     * required by the rule to work as expected. If it returns 0, the\n-     * setObjects() method will not be called.\n-     *\n-     * @return the maximal number of objects required by the rule\n-     */\n-    protected abstract int getMaxObjects();\n+    public void apply(CopierData data) {\n+        Workpiece workpiece = data.getDigitalDocument().getWorkpiece();\n+        List<IncludedStructuralElement> allIncludedStructuralElements = workpiece.getAllIncludedStructuralElements();\n \n-    /**\n-     * The function getMinObject must return the minimal number of objects\n-     * required by the rule to work as expected.\n-     *\n-     * @return the minimal number of objects required by the rule\n-     */\n-    protected abstract int getMinObjects();\n+        for (IncludedStructuralElement child : allIncludedStructuralElements) {\n+            Collection<Metadata> metadata = child.getMetadata();\n+            MdSec domain = null;\n+            MetadataEntry metadataEntry = new MetadataEntry();\n+            metadataEntry.setKey(command.get(0));\n+            metadataEntry.setValue(command.get(2));\n+            metadataEntry.setDomain(domain);\n+            child.getMetadata().add(metadataEntry);\n \n-    /**\n-     * The method is called to pass the rule its objects. The list\n-     * passed is reliable to the restrictions defined by getMinObjects() and\n-     * getMaxObjects().\n-     *\n-     * @param objects\n-     *            a list of objects to be used by the rule\n-     * @throws ConfigurationException\n-     *             may be thrown if one of the objects cannot be processed\n-     */\n-    protected abstract void setObjects(List<String> objects) throws ConfigurationException;\n+            try (OutputStream out = ServiceManager.getFileService()\n+                    .write(ServiceManager.getFileService().getMetadataFilePath(data.getProcess()))) {\n+                ServiceManager.getMetsService().save(workpiece, out);\n+                ServiceManager.getProcessService().saveToIndex(data.getProcess(), false);\n+            } catch (IOException | CustomResponseException | DataException e) {\n+                System.out.println(\"log me\");", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNDYyMw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539104623", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Collection<Metadata> metadata = child.getMetadata();\n          \n      \n    \n    \n  \n\nmetadata is never used", "author": "solth", "createdAt": "2020-12-09T08:30:11Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopyrule.java", "diffHunk": "@@ -92,44 +47,27 @@ public static DataCopyrule createFor(List<String> arguments) throws Configuratio\n      * @param data\n      *            data to apply yourself on\n      */\n-    protected abstract void apply(CopierData data);\n-\n-    /**\n-     * The function getMinObject must return the maximal number of objects\n-     * required by the rule to work as expected. If it returns 0, the\n-     * setObjects() method will not be called.\n-     *\n-     * @return the maximal number of objects required by the rule\n-     */\n-    protected abstract int getMaxObjects();\n+    public void apply(CopierData data) {\n+        Workpiece workpiece = data.getDigitalDocument().getWorkpiece();\n+        List<IncludedStructuralElement> allIncludedStructuralElements = workpiece.getAllIncludedStructuralElements();\n \n-    /**\n-     * The function getMinObject must return the minimal number of objects\n-     * required by the rule to work as expected.\n-     *\n-     * @return the minimal number of objects required by the rule\n-     */\n-    protected abstract int getMinObjects();\n+        for (IncludedStructuralElement child : allIncludedStructuralElements) {\n+            Collection<Metadata> metadata = child.getMetadata();", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNTY3NA==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539105674", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.api.MetadataGroup;", "author": "solth", "createdAt": "2020-12-09T08:31:55Z", "path": "Kitodo/src/main/java/org/kitodo/production/metadata/copier/DataCopyrule.java", "diffHunk": "@@ -11,79 +11,34 @@\n \n package org.kitodo.production.metadata.copier;\n \n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n \n import org.apache.commons.configuration.ConfigurationException;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.MetadataGroup;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNjQ1MQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539106451", "bodyText": "Even though it should probably never happen I would always recommend checking if a list is empty before retrieving its first element.", "author": "solth", "createdAt": "2020-12-09T08:33:13Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;\n+import org.kitodo.production.helper.metadata.legacytypeimplementations.LegacyMetsModsDigitalDocumentHelper;\n+import org.kitodo.production.services.ServiceManager;\n+\n+public class AddDataScript extends EditDataScript {\n+\n+    private static final Logger logger = LogManager.getLogger(AddDataScript.class);\n+\n+    /**\n+     * Executes the given script on the given file for the given process.\n+     * @param metadataFile the file to edit\n+     * @param process the related process\n+     * @param metadataScript the script to execute\n+     */\n+    public void executeScript(LegacyMetsModsDigitalDocumentHelper metadataFile, Process process,\n+            MetadataScript metadataScript) {\n+        Workpiece workpiece = metadataFile.getWorkpiece();\n+        List<IncludedStructuralElement> allIncludedStructuralElements = workpiece.getAllIncludedStructuralElements();\n+\n+        IncludedStructuralElement child = allIncludedStructuralElements.get(0);", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNjcxMw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539106713", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.io.IOException;\n          \n          \n            \n            import java.io.OutputStream;", "author": "solth", "createdAt": "2020-12-09T08:33:38Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNjgxOQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539106819", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.Objects;", "author": "solth", "createdAt": "2020-12-09T08:33:48Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzExNw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539107117", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Logger logger = LogManager.getLogger(AddDataScript.class);\n          \n      \n    \n    \n  \n\nLogger is never used", "author": "solth", "createdAt": "2020-12-09T08:34:18Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;\n+import org.kitodo.production.helper.metadata.legacytypeimplementations.LegacyMetsModsDigitalDocumentHelper;\n+import org.kitodo.production.services.ServiceManager;\n+\n+public class AddDataScript extends EditDataScript {\n+\n+    private static final Logger logger = LogManager.getLogger(AddDataScript.class);", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzYwMQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539107601", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.logging.log4j.LogManager;\n          \n          \n            \n            import org.apache.logging.log4j.Logger;\n          \n      \n    \n    \n  \n\nThese imports can be removed because the variable Logger, for which they are required, is never used.", "author": "solth", "createdAt": "2020-12-09T08:35:01Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzc4Nw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539107787", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n          \n          \n            \n            import org.kitodo.data.exceptions.DataException;", "author": "solth", "createdAt": "2020-12-09T08:35:19Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzg1MA==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539107850", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.kitodo.production.services.ServiceManager;", "author": "solth", "createdAt": "2020-12-09T08:35:29Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/AddDataScript.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.data.elasticsearch.exceptions.CustomResponseException;\n+import org.kitodo.data.exceptions.DataException;\n+import org.kitodo.production.helper.metadata.legacytypeimplementations.LegacyMetsModsDigitalDocumentHelper;\n+import org.kitodo.production.services.ServiceManager;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwODg4Mw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539108883", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<Metadata> metadataCollectionCopy = new ArrayList<>();\n          \n          \n            \n                    metadataCollectionCopy.addAll(metadataCollection);\n          \n          \n            \n                    List<Metadata> metadataCollectionCopy = new ArrayList<>(metadataCollection);", "author": "solth", "createdAt": "2020-12-09T08:37:05Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/DeleteDataScript.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.production.helper.metadata.legacytypeimplementations.LegacyMetsModsDigitalDocumentHelper;\n+\n+public class DeleteDataScript extends EditDataScript {\n+\n+    /**\n+     * Executes the given script on the given file for the given process.\n+     * @param metadataFile the file to edit\n+     * @param process the related process\n+     * @param metadataScript the script to execute\n+     */\n+    public void executeScript(LegacyMetsModsDigitalDocumentHelper metadataFile, Process process,\n+                               MetadataScript metadataScript) {\n+        Workpiece workpiece = metadataFile.getWorkpiece();\n+        List<IncludedStructuralElement> allIncludedStructuralElements = workpiece.getAllIncludedStructuralElements();\n+\n+        IncludedStructuralElement child = allIncludedStructuralElements.get(0);\n+        Collection<Metadata> metadataCollection = child.getMetadata();\n+\n+        generateValueForMetadataScript(metadataScript, metadataCollection, process, metadataFile);\n+\n+        List<Metadata> metadataCollectionCopy = new ArrayList<>();\n+        metadataCollectionCopy.addAll(metadataCollection);", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTI2Ng==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539115266", "bodyText": "I am not sure if this will work. AFAIK only CDI managed beans have access to the FacesContext that is needed to render messages in the frontend pages. (same goes for the other usages of Helper.setMessage or Helper.setErrorMessage in this class.)", "author": "solth", "createdAt": "2020-12-09T08:46:42Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/KitodoScriptService.java", "diffHunk": "@@ -181,6 +187,44 @@ private boolean executeScript(List<Process> processes, String script) throws Dat\n         return true;\n     }\n \n+    private void deleteData(List<Process> processes, String script) {\n+        String currentProcessTitle = null;\n+        try {\n+            script = script.replaceFirst(\"\\\\s*action:deleteData\\\\s+(.*?)[\\r\\n\\\\s]*\", \"$1\");\n+            DeleteDataScript deleteDataScript = new DeleteDataScript();\n+            for (Process process : processes) {\n+                currentProcessTitle = process.getTitle();\n+                LegacyMetsModsDigitalDocumentHelper metadataFile = ServiceManager.getProcessService()\n+                        .readMetadataFile(process);\n+                deleteDataScript.process(metadataFile, process, script);\n+                ServiceManager.getMetsService().saveWorkpiece(metadataFile.getWorkpiece(),\n+                        ServiceManager.getProcessService().getMetadataFileUri(process));\n+                Helper.setMessage(\"deleteDataOk\", currentProcessTitle);\n+            }\n+        } catch (IOException e) {\n+            Helper.setErrorMessage(\"addDataError\", currentProcessTitle + \":\" + e.getMessage(), logger, e);\n+        }\n+    }\n+\n+    private void overwriteData(List<Process> processes, String script) {\n+        String currentProcessTitle = null;\n+        try {\n+            script = script.replaceFirst(\"\\\\s*action:overwriteData\\\\s+(.*?)[\\r\\n\\\\s]*\", \"$1\");\n+            OverwriteDataScript overwriteDataScript = new OverwriteDataScript();\n+            for (Process process : processes) {\n+                currentProcessTitle = process.getTitle();\n+                LegacyMetsModsDigitalDocumentHelper metadataFile = ServiceManager.getProcessService()\n+                        .readMetadataFile(process);\n+                overwriteDataScript.process(metadataFile, process, script);\n+                ServiceManager.getMetsService().saveWorkpiece(metadataFile.getWorkpiece(),\n+                        ServiceManager.getProcessService().getMetadataFileUri(process));\n+                Helper.setMessage(\"overwriteDataOk\", currentProcessTitle);\n+            }\n+        } catch (IOException e) {\n+            Helper.setErrorMessage(\"overwriteDataError\", currentProcessTitle + \":\" + e.getMessage(), logger, e);", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MjA1Nw==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r540952057", "bodyText": "It is actually working!", "author": "Kathrin-Huber", "createdAt": "2020-12-11T13:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExNTI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyMzI1MQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539123251", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.Objects;", "author": "solth", "createdAt": "2020-12-09T08:58:21Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/OverwriteDataScript.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNjMxMQ==", "url": "https://github.com/kitodo/kitodo-production/pull/4112#discussion_r539126311", "bodyText": "Same as above. I think you should check if allIncludedStructuralElements contains an element before \"getting\" it.", "author": "solth", "createdAt": "2020-12-09T09:02:34Z", "path": "Kitodo/src/main/java/org/kitodo/production/services/command/OverwriteDataScript.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.services.command;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.MetadataEntry;\n+import org.kitodo.api.MetadataGroup;\n+import org.kitodo.api.dataformat.IncludedStructuralElement;\n+import org.kitodo.api.dataformat.Workpiece;\n+import org.kitodo.data.database.beans.Process;\n+import org.kitodo.production.helper.metadata.legacytypeimplementations.LegacyMetsModsDigitalDocumentHelper;\n+\n+public class OverwriteDataScript extends EditDataScript {\n+\n+    @Override\n+    public void executeScript(LegacyMetsModsDigitalDocumentHelper metadataFile, Process process,\n+            MetadataScript metadataScript) {\n+        Workpiece workpiece = metadataFile.getWorkpiece();\n+        List<IncludedStructuralElement> allIncludedStructuralElements = workpiece\n+                .getAllIncludedStructuralElements();\n+\n+        IncludedStructuralElement child = allIncludedStructuralElements.get(0);", "originalCommit": "0fd979e97727c2848fecad71b5441832ab56c9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6660bcafff834ce971664f7e8e584ea3792935b0", "url": "https://github.com/kitodo/kitodo-production/commit/6660bcafff834ce971664f7e8e584ea3792935b0", "message": "add review", "committedDate": "2020-12-11T13:39:26Z", "type": "commit"}, {"oid": "6660bcafff834ce971664f7e8e584ea3792935b0", "url": "https://github.com/kitodo/kitodo-production/commit/6660bcafff834ce971664f7e8e584ea3792935b0", "message": "add review", "committedDate": "2020-12-11T13:39:26Z", "type": "forcePushed"}]}