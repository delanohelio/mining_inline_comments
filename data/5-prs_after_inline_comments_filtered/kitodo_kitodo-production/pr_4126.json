{"pr_number": 4126, "pr_title": "Realize file upload", "pr_createdAt": "2020-12-14T19:37:36Z", "pr_url": "https://github.com/kitodo/kitodo-production/pull/4126", "timeline": [{"oid": "c9b501173a2b216a197bb11b9a3ab199137a5bad", "url": "https://github.com/kitodo/kitodo-production/commit/c9b501173a2b216a197bb11b9a3ab199137a5bad", "message": "cleanup", "committedDate": "2020-12-14T19:52:32Z", "type": "forcePushed"}, {"oid": "f79d3f032afda60857dc121448aee9536be17446", "url": "https://github.com/kitodo/kitodo-production/commit/f79d3f032afda60857dc121448aee9536be17446", "message": "cleanup", "committedDate": "2020-12-15T08:19:35Z", "type": "forcePushed"}, {"oid": "b53805f99f5785c2e16fec906d6153786021b1b2", "url": "https://github.com/kitodo/kitodo-production/commit/b53805f99f5785c2e16fec906d6153786021b1b2", "message": "cleanup", "committedDate": "2020-12-15T17:17:02Z", "type": "forcePushed"}, {"oid": "3e0be59e2f64c882b8f53bfbfe71ba34256e14cd", "url": "https://github.com/kitodo/kitodo-production/commit/3e0be59e2f64c882b8f53bfbfe71ba34256e14cd", "message": "add fileUploadTag to test opac.xml", "committedDate": "2020-12-18T09:31:41Z", "type": "forcePushed"}, {"oid": "44d80182254670a7c4d262bf50e1b48b086dd3d0", "url": "https://github.com/kitodo/kitodo-production/commit/44d80182254670a7c4d262bf50e1b48b086dd3d0", "message": "add javadoc", "committedDate": "2020-12-21T08:29:09Z", "type": "forcePushed"}, {"oid": "3261221ab9cb8b1ddd3418462d043d745b3ba882", "url": "https://github.com/kitodo/kitodo-production/commit/3261221ab9cb8b1ddd3418462d043d745b3ba882", "message": "add javadoc", "committedDate": "2021-01-05T08:20:15Z", "type": "forcePushed"}, {"oid": "f4d3faa6b00e8253b811dfb02d1ec726c4e28812", "url": "https://github.com/kitodo/kitodo-production/commit/f4d3faa6b00e8253b811dfb02d1ec726c4e28812", "message": "add javadoc", "committedDate": "2021-01-05T08:26:38Z", "type": "forcePushed"}, {"oid": "afb121193ab1e01e5d38f30c263cc051cc19b26a", "url": "https://github.com/kitodo/kitodo-production/commit/afb121193ab1e01e5d38f30c263cc051cc19b26a", "message": "fix merge issues", "committedDate": "2021-01-07T14:27:05Z", "type": "forcePushed"}, {"oid": "25e5a5e44ed297c62b7501190b8780857cfcb70b", "url": "https://github.com/kitodo/kitodo-production/commit/25e5a5e44ed297c62b7501190b8780857cfcb70b", "message": "enable import via fileUpload for monographs", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "ac58b917b1c751b3b481ca6f41d6d8f9509c3d89", "url": "https://github.com/kitodo/kitodo-production/commit/ac58b917b1c751b3b481ca6f41d6d8f9509c3d89", "message": "cleanup", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "f54469a2617648bbdef6cae2c841487b4beb53bd", "url": "https://github.com/kitodo/kitodo-production/commit/f54469a2617648bbdef6cae2c841487b4beb53bd", "message": "styling", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "d8eb98218b47a93be710d6c173fb411821f668d1", "url": "https://github.com/kitodo/kitodo-production/commit/d8eb98218b47a93be710d6c173fb411821f668d1", "message": "add fileUploadTag to test opac.xml", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "2d0592a1cdbd37ce036484ca6fb5c76381b6a4b6", "url": "https://github.com/kitodo/kitodo-production/commit/2d0592a1cdbd37ce036484ca6fb5c76381b6a4b6", "message": "add javadoc", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "846fe2b9ed0e9a21c07265ba8a4e91ee76aca2e9", "url": "https://github.com/kitodo/kitodo-production/commit/846fe2b9ed0e9a21c07265ba8a4e91ee76aca2e9", "message": "fix merge issues", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "3d8761c899de8c69568b2dfbebb790a796e6794b", "url": "https://github.com/kitodo/kitodo-production/commit/3d8761c899de8c69568b2dfbebb790a796e6794b", "message": "fixCodacy", "committedDate": "2021-01-08T10:32:10Z", "type": "commit"}, {"oid": "3d8761c899de8c69568b2dfbebb790a796e6794b", "url": "https://github.com/kitodo/kitodo-production/commit/3d8761c899de8c69568b2dfbebb790a796e6794b", "message": "fixCodacy", "committedDate": "2021-01-08T10:32:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgzNDkxNw==", "url": "https://github.com/kitodo/kitodo-production/pull/4126#discussion_r553834917", "bodyText": "I would suggest to make the configuration parameter optional and interpret a missing parameter as false.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return getCatalog(catalogName).getBoolean(\"fileUpload\");\n          \n          \n            \n                    return getCatalog(catalogName).containsKey(\"fileUpload\") \n          \n          \n            \n                            && getCatalog(catalogName).getBoolean(\"fileUpload\");", "author": "solth", "createdAt": "2021-01-08T09:31:28Z", "path": "Kitodo-API/src/main/java/org/kitodo/config/OPACConfig.java", "diffHunk": "@@ -103,6 +103,15 @@ public static HierarchicalConfiguration getUrlParameters(String catalogName) {\n         return getCatalog(catalogName).configurationAt(\"urlParameters\");\n     }\n \n+    /**\n+     * Retrieve the \"fileUpload\" configuration of the catalog identified by its title.\n+     * @param catalogName String identifying the catalog by its title\n+     * @return boolean if catalog is configured to use FileUpload\n+     */\n+    public static boolean getFileUploadConfig(String catalogName) {\n+        return getCatalog(catalogName).getBoolean(\"fileUpload\");", "originalCommit": "afb121193ab1e01e5d38f30c263cc051cc19b26a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg2MjQ2NA==", "url": "https://github.com/kitodo/kitodo-production/pull/4126#discussion_r553862464", "bodyText": "I think since you handle the uploaded file directly in the handleFileUpload listener, this variable here is never used and therefor can be removed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private UploadedFile file;", "author": "solth", "createdAt": "2021-01-08T10:26:17Z", "path": "Kitodo/src/main/java/org/kitodo/production/forms/createprocess/FileUploadDialog.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.forms.createprocess;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.charset.Charset;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import javax.xml.parsers.ParserConfigurationException;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.schemaconverter.DataRecord;\n+import org.kitodo.api.schemaconverter.FileFormat;\n+import org.kitodo.api.schemaconverter.MetadataFormat;\n+import org.kitodo.config.OPACConfig;\n+import org.kitodo.exceptions.ConfigException;\n+import org.kitodo.exceptions.ParameterNotFoundException;\n+import org.kitodo.exceptions.ProcessGenerationException;\n+import org.kitodo.exceptions.UnsupportedFormatException;\n+import org.kitodo.production.helper.Helper;\n+import org.kitodo.production.helper.TempProcess;\n+import org.kitodo.production.services.ServiceManager;\n+import org.kitodo.production.services.data.ImportService;\n+import org.primefaces.event.FileUploadEvent;\n+import org.primefaces.model.UploadedFile;\n+import org.w3c.dom.Document;\n+import org.xml.sax.SAXException;\n+\n+public class FileUploadDialog extends MetadataImportDialog {\n+\n+    private UploadedFile file;", "originalCommit": "afb121193ab1e01e5d38f30c263cc051cc19b26a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg2NzYxNA==", "url": "https://github.com/kitodo/kitodo-production/pull/4126#discussion_r553867614", "bodyText": "Since the file variable isn't used, this setter is also not required.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * Set the file.\n          \n          \n            \n                 * @param file the file to upload\n          \n          \n            \n                 */\n          \n          \n            \n                public void setFile(UploadedFile file) {\n          \n          \n            \n                    this.file = file;\n          \n          \n            \n                }", "author": "solth", "createdAt": "2021-01-08T10:36:28Z", "path": "Kitodo/src/main/java/org/kitodo/production/forms/createprocess/FileUploadDialog.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * (c) Kitodo. Key to digital objects e. V. <contact@kitodo.org>\n+ *\n+ * This file is part of the Kitodo project.\n+ *\n+ * It is licensed under GNU General Public License version 3 or later.\n+ *\n+ * For the full copyright and license information, please read the\n+ * GPL3-License.txt file that was distributed with this source code.\n+ */\n+\n+package org.kitodo.production.forms.createprocess;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.charset.Charset;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import javax.xml.parsers.ParserConfigurationException;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.kitodo.api.MdSec;\n+import org.kitodo.api.Metadata;\n+import org.kitodo.api.schemaconverter.DataRecord;\n+import org.kitodo.api.schemaconverter.FileFormat;\n+import org.kitodo.api.schemaconverter.MetadataFormat;\n+import org.kitodo.config.OPACConfig;\n+import org.kitodo.exceptions.ConfigException;\n+import org.kitodo.exceptions.ParameterNotFoundException;\n+import org.kitodo.exceptions.ProcessGenerationException;\n+import org.kitodo.exceptions.UnsupportedFormatException;\n+import org.kitodo.production.helper.Helper;\n+import org.kitodo.production.helper.TempProcess;\n+import org.kitodo.production.services.ServiceManager;\n+import org.kitodo.production.services.data.ImportService;\n+import org.primefaces.event.FileUploadEvent;\n+import org.primefaces.model.UploadedFile;\n+import org.w3c.dom.Document;\n+import org.xml.sax.SAXException;\n+\n+public class FileUploadDialog extends MetadataImportDialog {\n+\n+    private UploadedFile file;\n+    private String selectedCatalog;\n+    private static final Logger logger = LogManager.getLogger(FileUploadDialog.class);\n+\n+    public FileUploadDialog(CreateProcessForm createProcessForm) {\n+        super(createProcessForm);\n+    }\n+\n+    /**\n+     * import from csv file.\n+     *\n+     * @param event\n+     *            the file upload event\n+     */\n+    public void handleFileUpload(FileUploadEvent event) {\n+        UploadedFile uploadedFile = event.getFile();\n+        ImportService importService = ServiceManager.getImportService();\n+        try {\n+            Document internalDocument = importService.convertDataRecordToInternal(\n+                createRecordFromXMLElement(IOUtils.toString(uploadedFile.getInputstream(), Charset.defaultCharset())),\n+                selectedCatalog, false);\n+            TempProcess tempProcess = importService.createTempProcessFromDocument(internalDocument,\n+                createProcessForm.getTemplate().getId(), createProcessForm.getProject().getId());\n+\n+            LinkedList<TempProcess> processes = new LinkedList<>();\n+            processes.add(tempProcess);\n+            this.createProcessForm.setProcesses(processes);\n+            if (!processes.isEmpty() && processes.getFirst().getMetadataNodes().getLength() > 0) {\n+                TempProcess firstProcess = processes.getFirst();\n+                this.createProcessForm.getProcessDataTab()\n+                        .setDocType(firstProcess.getWorkpiece().getRootElement().getType());\n+                Collection<Metadata> metadata = ImportService.importMetadata(firstProcess.getMetadataNodes(),\n+                    MdSec.DMD_SEC);\n+                createProcessForm.getProcessMetadataTab().getProcessDetails().setMetadata(metadata);\n+            }\n+            showRecord();\n+        } catch (IOException | ProcessGenerationException | URISyntaxException | ParserConfigurationException\n+                | UnsupportedFormatException | SAXException | ConfigException e) {\n+            Helper.setErrorMessage(e.getLocalizedMessage(), logger, e);\n+        }\n+    }\n+\n+    private DataRecord createRecordFromXMLElement(String xmlContent) {\n+        DataRecord record = new DataRecord();\n+        try {\n+            record.setMetadataFormat(\n+                MetadataFormat.getMetadataFormat(OPACConfig.getConfigValue(selectedCatalog, \"metadataFormat\")));\n+            record.setFileFormat(FileFormat.getFileFormat(OPACConfig.getConfigValue(selectedCatalog, \"returnFormat\")));\n+        } catch (ParameterNotFoundException e) {\n+            Helper.setErrorMessage(e.getLocalizedMessage(), logger, e);\n+        }\n+        record.setOriginalData(xmlContent);\n+        return record;\n+    }\n+\n+    @Override\n+    public List<String> getCatalogs() {\n+        List<String> catalogs = super.getCatalogs();\n+        List<String> catalogsWithFileUpload = new ArrayList<>();\n+        for (String catalog : catalogs) {\n+            boolean isFileUpload = OPACConfig.getFileUploadConfig(catalog);\n+            if (isFileUpload) {\n+                catalogsWithFileUpload.add(catalog);\n+            }\n+        }\n+        return catalogsWithFileUpload;\n+    }\n+\n+    /**\n+     * Set the file.\n+     * @param file the file to upload\n+     */\n+    public void setFile(UploadedFile file) {\n+        this.file = file;\n+    }", "originalCommit": "3d8761c899de8c69568b2dfbebb790a796e6794b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2aec886a8487bef85d9bbd21e9949c171058e149", "url": "https://github.com/kitodo/kitodo-production/commit/2aec886a8487bef85d9bbd21e9949c171058e149", "message": "add review", "committedDate": "2021-01-08T13:20:28Z", "type": "commit"}, {"oid": "432b451a8474636a05af35487d966eadfed7638a", "url": "https://github.com/kitodo/kitodo-production/commit/432b451a8474636a05af35487d966eadfed7638a", "message": "Apply suggestions from code review\n\nCo-authored-by: Arved Solth <solth@effective-webwork.de>", "committedDate": "2021-01-12T10:49:39Z", "type": "commit"}]}