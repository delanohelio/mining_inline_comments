{"pr_number": 1595, "pr_title": "Child Entities Duplicated in Aggregate Model", "pr_createdAt": "2020-11-09T16:37:48Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1595", "timeline": [{"oid": "c9639176f44d902644356ddc84a942281779bc23", "url": "https://github.com/AxonFramework/AxonFramework/commit/c9639176f44d902644356ddc84a942281779bc23", "message": "Add child entity class method\n\nAdd a method which exposes the class of the child entity. This can\nfurther be used to verify whether a given ChildEntity is included twice\ninto an annotated meta model", "committedDate": "2020-11-03T16:04:31Z", "type": "commit"}, {"oid": "a280c8e49c4a1dfa946ea77b3185b9f54d33fc18", "url": "https://github.com/AxonFramework/AxonFramework/commit/a280c8e49c4a1dfa946ea77b3185b9f54d33fc18", "message": "Use a map of class to ChildEntity\n\nUse a map of class to ChildEntity to ensure a second instance of a given\n ChildEntity will override the previous, thus ensuring no duplicate\n entries of a ChildEntity can occur between an annotated meta model's\n children", "committedDate": "2020-11-03T16:05:42Z", "type": "commit"}, {"oid": "b26d01543403371f2685cbe56ebcab93925249a0", "url": "https://github.com/AxonFramework/AxonFramework/commit/b26d01543403371f2685cbe56ebcab93925249a0", "message": "Add a test case validating correct amount of handler invocations\n\nAdd a test case which creates a polymorphic aggregate with aggregate\nmembers on the root. Validate in this test case that the AggregateEvent\nhandler will only be invoked twice (once for the root and once for the\nmember) and that the MemberEvent is only invoked once (for the member).", "committedDate": "2020-11-03T16:07:13Z", "type": "commit"}, {"oid": "ffb8d7dc320e7514b39ecde3099661c24588614b", "url": "https://github.com/AxonFramework/AxonFramework/commit/ffb8d7dc320e7514b39ecde3099661c24588614b", "message": "Clean up touched code\n\nClean up the touched classes, by fine tuning javadoc, resolving warnings\n and renaming some parameters", "committedDate": "2020-11-03T16:08:40Z", "type": "commit"}, {"oid": "41439493baa67bc8a8fdc3c9672450c18d6e56e3", "url": "https://github.com/AxonFramework/AxonFramework/commit/41439493baa67bc8a8fdc3c9672450c18d6e56e3", "message": "Add non-recursive option to find fields/methods\n\nAdd an option to chose whether fieldsOf and methodsOf should perform\ntheir search recursively by defining a boolean. Add tests for the\nadjustment and remove any warnings were possible\n\n#duplicate-child-entities", "committedDate": "2020-11-09T13:51:52Z", "type": "commit"}, {"oid": "2e77373be4804822fe9e8496167406a67ec30962", "url": "https://github.com/AxonFramework/AxonFramework/commit/2e77373be4804822fe9e8496167406a67ec30962", "message": "Rename test class\n\nRename test class\n\n#duplicate-child-entities", "committedDate": "2020-11-09T13:54:10Z", "type": "commit"}, {"oid": "34d6fc62d63eeafae0c10d9ba57f414c49731ed5", "url": "https://github.com/AxonFramework/AxonFramework/commit/34d6fc62d63eeafae0c10d9ba57f414c49731ed5", "message": "Introduce a getAllInspectedTypes method\n\nIntroduce an operation to return all the inspected types. This can\nfurther be used to drive model creation for example\n\n#duplicate-child-entities", "committedDate": "2020-11-09T16:04:22Z", "type": "commit"}, {"oid": "62ab41fd35daafd5c95f92abd44eef822dc3d8d7", "url": "https://github.com/AxonFramework/AxonFramework/commit/62ab41fd35daafd5c95f92abd44eef822dc3d8d7", "message": "Adjust model factory to be based on inspected types\n\nThe meta model factory currently has two problems: (1) it only takes\ninto account actual classes which contain handler methods and (2) for\neach of these it will recursively find all the handlers. Point one\nsignals that some parts of the Aggregate hierarchy can be completed\ndisregarded when it comes to searching for aggregate members for\nexample, as it is perfectly fine for a class to have no handlers and\nsome members. Point 2 is a hard requirement because _if_ several levels\nof the hierarchy contain handlers, then we would recursively find all\nfields and methods which should partake in model creation. This however\nmeans that objects on the root will be taken into account every time a\nlower level implementation is scanned. We should thus adjust the\nbehavior to base itself on the inspected classes, and only take the\nfields/methods on each of those into account.\n\n#duplicate-child-entities", "committedDate": "2020-11-09T16:08:19Z", "type": "commit"}, {"oid": "2dce079ddadfa40bc609d39235a749896aca7874", "url": "https://github.com/AxonFramework/AxonFramework/commit/2dce079ddadfa40bc609d39235a749896aca7874", "message": "Undo commit c9639176f44d902644356ddc84a942281779bc23\n\nRemove the option to check a child entities class, as it's not needed\nanymore\n\n#duplicate-child-entities", "committedDate": "2020-11-09T16:10:05Z", "type": "commit"}, {"oid": "6d9211fa6ebbf7912d5ccc2fd6e3c69496b4758a", "url": "https://github.com/AxonFramework/AxonFramework/commit/6d9211fa6ebbf7912d5ccc2fd6e3c69496b4758a", "message": "Introduce polymorphic test case\n\nIntroduce a test case which validate the same behavior of a polymorphic\naggregate is being used\n\n#duplicate-child-entities", "committedDate": "2020-11-09T16:24:59Z", "type": "commit"}, {"oid": "5cd5b654fc9b84319d238cfb33257572a9f453e5", "url": "https://github.com/AxonFramework/AxonFramework/commit/5cd5b654fc9b84319d238cfb33257572a9f453e5", "message": "Correct javadoc\n\nCorrect javadoc to reflect the class hierarchy\n\n#duplicate-child-entities", "committedDate": "2020-11-09T16:36:47Z", "type": "commit"}, {"oid": "deae192bc3793efcf38095deaf0eab972aeaea24", "url": "https://github.com/AxonFramework/AxonFramework/commit/deae192bc3793efcf38095deaf0eab972aeaea24", "message": "Fix test case\n\nFix test case by adjusting counter on start up\n\n#duplicate-child-entities", "committedDate": "2020-11-10T08:19:29Z", "type": "commit"}, {"oid": "32b1f8b5655a2e3ea9e1922757ab34b016e3985a", "url": "https://github.com/AxonFramework/AxonFramework/commit/32b1f8b5655a2e3ea9e1922757ab34b016e3985a", "message": "Rename field\n\nRename field to not bump with global inspectedType field\n\n#duplicate-child-entities", "committedDate": "2020-11-10T09:01:40Z", "type": "commit"}, {"oid": "0914e33b277a66b5d3b77b9ec566c80612da1de2", "url": "https://github.com/AxonFramework/AxonFramework/commit/0914e33b277a66b5d3b77b9ec566c80612da1de2", "message": "Merge remote-tracking branch 'origin/axon-4.4.x' into bug/deduplicate-child-entities", "committedDate": "2020-11-10T09:02:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzOTQxMg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1595#discussion_r520539412", "bodyText": "Nit: Would be good also verify the count of inspected types, or reverse the assertion to verify that all of the expectedInspectedTypes are contained in getAllInspectedTypes().\nThe current verification allows for getAllInspectedTypes() to return only a subset of expectedInspectedTypes", "author": "sandjelkovic", "createdAt": "2020-11-10T12:54:15Z", "path": "messaging/src/test/java/org/axonframework/messaging/annotation/AnnotatedHandlerInspectorTest.java", "diffHunk": "@@ -148,6 +150,14 @@ void testInterceptors() throws Exception {\n         assertThrows(MockException.class, () -> chain.handle(testEventTwo, testTarget, resultHandler));\n     }\n \n+    @Test\n+    void testGetAllInspectedTypes() {\n+        Set<Class<?>> expectedInspectedTypes = Sets.newSet(pA.class, A.class, B.class, C.class, D.class);\n+\n+        inspector.getAllInspectedTypes()\n+                 .forEach(inspectedType -> assertTrue(expectedInspectedTypes.contains(inspectedType)));", "originalCommit": "0914e33b277a66b5d3b77b9ec566c80612da1de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU0OTcxNA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1595#discussion_r520549714", "bodyText": "Couldn't agree more with you here. We'll make it so!", "author": "smcvb", "createdAt": "2020-11-10T13:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUzOTQxMg=="}], "type": "inlineReview"}, {"oid": "742d60ad9920416c2cefdfb2bf202e52701db9b5", "url": "https://github.com/AxonFramework/AxonFramework/commit/742d60ad9920416c2cefdfb2bf202e52701db9b5", "message": "Fine tune test case\n\nFine tune test case to include the validation the other way around, to\nensure both sets are completely equal\n\n#duplicate-child-entities", "committedDate": "2020-11-10T13:11:20Z", "type": "commit"}]}