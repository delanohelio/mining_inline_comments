{"pr_number": 7404, "pr_title": "IGNITE-12433 checking column names for duplicates on create table statement", "pr_createdAt": "2020-02-11T08:46:45Z", "pr_url": "https://github.com/apache/ignite/pull/7404", "timeline": [{"oid": "302b1dcd869ed82f9313498168a4dc66e6fe0fee", "url": "https://github.com/apache/ignite/commit/302b1dcd869ed82f9313498168a4dc66e6fe0fee", "message": "checking column names for duplicates on create table statement", "committedDate": "2020-02-11T08:45:50Z", "type": "commit"}, {"oid": "49ecf0105361258911842f686d471de2cae0aa20", "url": "https://github.com/apache/ignite/commit/49ecf0105361258911842f686d471de2cae0aa20", "message": "test update", "committedDate": "2020-02-11T12:08:57Z", "type": "commit"}, {"oid": "0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "url": "https://github.com/apache/ignite/commit/0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "message": "added whitespace", "committedDate": "2020-02-12T08:05:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMDc3Mw==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379420773", "bodyText": "You could just analyze return value of cols.put instead of using containsKey", "author": "joooger", "createdAt": "2020-02-14T13:08:03Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/sql/GridSqlQueryParser.java", "diffHunk": "@@ -1181,8 +1181,12 @@ private GridSqlCreateTable parseCreateTable(CreateTable createTbl) {\n \n         LinkedHashMap<String, GridSqlColumn> cols = new LinkedHashMap<>(data.columns.size());\n \n-        for (Column col : data.columns)\n+        for (Column col : data.columns) {\n+            if (cols.containsKey(col.getName()))\n+                throw new IgniteSQLException(\"Duplicate column name: \" + col.getName(), IgniteQueryErrorCode.PARSING);", "originalCommit": "0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NDgzMQ==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379474831", "bodyText": "Done.", "author": "sergeyuttsel", "createdAt": "2020-02-14T14:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMDc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMTI0MA==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379421240", "bodyText": "Let's add another one check with different type of columns with the same name", "author": "joooger", "createdAt": "2020-02-14T13:09:12Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheSqlQueryErrorSelfTest.java", "diffHunk": "@@ -160,6 +160,12 @@ public void testDdlWrongColumnName() throws Exception {\n \n         checkSqlErrorMessage(\"alter table test drop column wrong\",\n             \"Failed to parse query. Column \\\"WRONG\\\" not found\");\n+\n+        checkSqlErrorMessage(\"create table test(id integer primary key, AgE integer, AGe integer)\",\n+            \"Duplicate column name: AGE\");\n+\n+        checkSqlErrorMessage(\"create table test(\\\"id\\\" integer primary key, \\\"age\\\" integer, \\\"age\\\" integer)\",\n+            \"Duplicate column name: age\");", "originalCommit": "0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NDg2MQ==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379474861", "bodyText": "Done.", "author": "sergeyuttsel", "createdAt": "2020-02-14T14:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMTI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMTQyNg==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379421426", "bodyText": "The same as for IgniteCacheSqlQueryErrorSelfTest.java", "author": "joooger", "createdAt": "2020-02-14T13:09:44Z", "path": "modules/clients/src/test/java/org/apache/ignite/jdbc/JdbcErrorsAbstractSelfTest.java", "diffHunk": "@@ -719,6 +719,12 @@ public void testDdlWrongColumnName() throws SQLException {\n \n         checkSqlErrorMessage(\"alter table test drop column wrong\", \"42000\",\n             \"Failed to parse query. Column \\\"WRONG\\\" not found\");\n+\n+        checkSqlErrorMessage(\"create table test(id integer primary key, AgE integer, AGe integer)\", \"42000\",\n+            \"Duplicate column name: AGE\");\n+\n+        checkSqlErrorMessage(\"create table test(\\\"id\\\" integer primary key, \\\"age\\\" integer, \\\"age\\\" integer)\", \"42000\",\n+            \"Duplicate column name: age\");", "originalCommit": "0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NDg5Ng==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379474896", "bodyText": "Done.", "author": "sergeyuttsel", "createdAt": "2020-02-14T14:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMTQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMjM0Nw==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379422347", "bodyText": "do we have specific code for such case or may be we could add it?", "author": "joooger", "createdAt": "2020-02-14T13:12:04Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/sql/GridSqlQueryParser.java", "diffHunk": "@@ -1181,8 +1181,12 @@ private GridSqlCreateTable parseCreateTable(CreateTable createTbl) {\n \n         LinkedHashMap<String, GridSqlColumn> cols = new LinkedHashMap<>(data.columns.size());\n \n-        for (Column col : data.columns)\n+        for (Column col : data.columns) {\n+            if (cols.containsKey(col.getName()))\n+                throw new IgniteSQLException(\"Duplicate column name: \" + col.getName(), IgniteQueryErrorCode.PARSING);", "originalCommit": "0ffbd7142af9c05d6dba61f725cf3566bf7d7532", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NTA1MA==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r379475050", "bodyText": "There are exists TABLE_DROP_FAILED.\nSo I added TABLE_CREATE_FAILED.", "author": "sergeyuttsel", "createdAt": "2020-02-14T14:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2MjY4Mw==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r380162683", "bodyText": "Seems your first varian was better. Let's return PARSING error.", "author": "joooger", "createdAt": "2020-02-17T12:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ5NTg4NA==", "url": "https://github.com/apache/ignite/pull/7404#discussion_r380495884", "bodyText": "Done", "author": "sergeyuttsel", "createdAt": "2020-02-18T07:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyMjM0Nw=="}], "type": "inlineReview"}, {"oid": "15f70e9d1c8fe74d0750476a971c5629063feef7", "url": "https://github.com/apache/ignite/commit/15f70e9d1c8fe74d0750476a971c5629063feef7", "message": "fix after code review", "committedDate": "2020-02-14T14:40:12Z", "type": "commit"}, {"oid": "fc24384a24fdef32bffff8d20919a499d87e5919", "url": "https://github.com/apache/ignite/commit/fc24384a24fdef32bffff8d20919a499d87e5919", "message": "fix after code review: returned PARSING error instead of TABLE_CREATE_FAILED", "committedDate": "2020-02-17T14:17:12Z", "type": "commit"}, {"oid": "b58e522722a537d87e43f2ab24374767672aef01", "url": "https://github.com/apache/ignite/commit/b58e522722a537d87e43f2ab24374767672aef01", "message": "Merge remote-tracking branch 'apache/master' into ignite-12433", "committedDate": "2020-02-27T15:50:10Z", "type": "commit"}]}