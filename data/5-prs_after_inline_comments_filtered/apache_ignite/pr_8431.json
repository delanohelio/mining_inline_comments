{"pr_number": 8431, "pr_title": "IGNITE-13633 Fix ServiceDescriptor.serviceClass failure in case of de\u2026", "pr_createdAt": "2020-11-06T13:46:53Z", "pr_url": "https://github.com/apache/ignite/pull/8431", "timeline": [{"oid": "5531f0c01a1bd7070bb9372b589641efcb6f0544", "url": "https://github.com/apache/ignite/commit/5531f0c01a1bd7070bb9372b589641efcb6f0544", "message": "IGNITE-13633 Fix ServiceDescriptor.serviceClass failure in case of deployed via DeploymentSPI service", "committedDate": "2020-11-06T13:46:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2OTI2Ng==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525269266", "bodyText": "I think that we shouldn't remove this check because this test is relevant only for the new Service Grid implementation.\nWe can remove such checks with the legacy SG-processor in future.", "author": "daradurvs", "createdAt": "2020-11-17T15:49:14Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/service/ServiceHotRedeploymentViaDeploymentSpiTest.java", "diffHunk": "@@ -61,12 +66,6 @@\n         return cfg;\n     }\n \n-    /** */\n-    @BeforeClass", "originalCommit": "5531f0c01a1bd7070bb9372b589641efcb6f0544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4NDA2OA==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525284068", "bodyText": "New test added to this class testServiceDeploymentViaDeploymentSpi which also relevant to legacy implementation, so I've moved this check to serviceHotRedeploymentTest to skip legacy implementation only for testServiceHotRedeploymentNode and testServiceHotRedeploymentThinClient", "author": "alex-plekhanov", "createdAt": "2020-11-17T16:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2OTI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NTIwMQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525295201", "bodyText": "Got it.\nThank you for your clarification.", "author": "daradurvs", "createdAt": "2020-11-17T16:22:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2OTI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525276115", "bodyText": "ServiceInfo is a serializable unit.\nI'm not sure that there is a sense to transfer GridKernalContext instance.\nMaybe it's better to make the field transient and initialize it after deserialization.\nWhat do you think?", "author": "daradurvs", "createdAt": "2020-11-17T15:57:46Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/service/ServiceInfo.java", "diffHunk": "@@ -37,6 +39,9 @@\n     /** */\n     private static final long serialVersionUID = 0L;\n \n+    /** Context. */\n+    private final GridKernalContext ctx;", "originalCommit": "5531f0c01a1bd7070bb9372b589641efcb6f0544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4NzAzNQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525287035", "bodyText": "Ok, I will fix it.", "author": "alex-plekhanov", "createdAt": "2020-11-17T16:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk3MTcyNw==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r526971727", "bodyText": "We can't get context after deserialization, because we don't know Ignite instance at this stage. I've marked the field as transient and added a check for null to avoid NPE. I think this is the best we can do. The class resolving logic will not work for services with lazy configuration and deployed via deployment SPI, after serialization/deserialization of ServiceInfo. But I think it's not such a common case - ServiceInfo not serialized by Ignite and serialization of ServiceInfo by the user looks strange. I think this class should not be Serializable at all.", "author": "alex-plekhanov", "createdAt": "2020-11-19T15:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkyOTczNQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r530929735", "bodyText": "We can handle it in IgniteServiceProcessor in places where registeredServices#putis called.\nAdding to registeredServices is the first place when Ignite's node receives ServiceInfo\nWe can introduce a new method:\nprivate void registerService(ServiceInfo desc) {\n    desc.setContext(ctx);\n    registeredServices.put(desc.serviceId(), desc);\n}\n\nWhat do you think?", "author": "daradurvs", "createdAt": "2020-11-26T10:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAxNTg5NQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r531015895", "bodyText": "I have missed the point. ctx already passed to ServiceInfo constructor right before registeredServices#put. And this works fine, the only problem will show up if the user will serialize and deserialize ServiceInfo items in some circumstances. But this problem is not solved by your proposal either.", "author": "alex-plekhanov", "createdAt": "2020-11-26T13:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEzMTI3OQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r531131279", "bodyText": "I've tried to cover the case with statically configured services, which will be received during node joining.\nIn this case server (not user) will deserialize ServiceInfo without calling the new constructor.\nLook at:\n\n  \n    \n      ignite/modules/core/src/main/java/org/apache/ignite/internal/processors/service/IgniteServiceProcessor.java\n    \n    \n         Line 350\n      in\n      8f824ca\n    \n    \n    \n    \n\n        \n          \n           ServiceProcessorCommonDiscoveryData clusterData = (ServiceProcessorCommonDiscoveryData)data.commonData(); \n        \n    \n  \n\n\nI think we need a test for this case too.", "author": "daradurvs", "createdAt": "2020-11-26T16:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzMDgxMw==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r534030813", "bodyText": "Thanks, fixed it, and added a check to the test.\nI found one more problem with services using classes deployed by deployment SPI: such services can't be deployed to the joined node. It can be reproduced if we change in testServiceDeploymentViaDeploymentSpi from deployClusterSingleton to deployNodeSingleton. We can't register class in deployment SPI before node starts, so, after new node joins it receives services information from the cluster and tries to start service locally, but can't find deployment SPI classes, so a registration of such services fails. This issue is not related to this thicket. It looks conceptual and I don't have any ideas on how to solve it right now.\nAlso, looks like deployment SPI is not supported by the old service processor implementation, so I've reverted my changes related to GridServiceProcessor. I don't know why TC bot visa was green, I've double-checked it manually, and test testServiceDeploymentViaDeploymentSpi failed. This issue can be easily fixed, if we copy-paste copyAndInject method from the new implementation, but since the old implementation is deprecated I think we can live with these known issues.", "author": "alex-plekhanov", "createdAt": "2020-12-02T09:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEyMjkwOA==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r534122908", "bodyText": "Looks like desc.context(ctx) should be called here as well:\n\n\n\n  \n    \n      ignite/modules/core/src/main/java/org/apache/ignite/internal/processors/service/IgniteServiceProcessor.java\n    \n    \n         Line 389\n      in\n      1ce95c6\n    \n    \n    \n    \n\n        \n          \n           registeredServices.put(desc.serviceId(), desc); \n        \n    \n  \n\n\n\n\n\n  \n    \n      ignite/modules/core/src/main/java/org/apache/ignite/internal/processors/service/IgniteServiceProcessor.java\n    \n    \n         Line 1519\n      in\n      1ce95c6\n    \n    \n    \n    \n\n        \n          \n           staticServicesInfo.forEach(desc -> registeredServices.put(desc.serviceId(), desc)); \n        \n    \n  \n\n\n\n\nI'd suggest to introduce a new method to have a single point oof adding services in registeredServices to not miss such places in future.\n    private void registerService(ServiceInfo desc) {\n        desc.context(ctx);\n        \n        registeredServices.put(desc.serviceId(), desc);\n    }\n\nWhat do you think?", "author": "daradurvs", "createdAt": "2020-12-02T12:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE5NDI3OQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r534194279", "bodyText": "Ok, fixed", "author": "alex-plekhanov", "createdAt": "2020-12-02T14:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjU4OA==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525276588", "bodyText": "We have similar logic here IgniteServiceProcessor#copyAndInject\nCan't we reuse it?", "author": "daradurvs", "createdAt": "2020-11-17T15:58:24Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/service/ServiceInfo.java", "diffHunk": "@@ -116,15 +125,28 @@ public IgniteUuid serviceId() {\n     }\n \n     /** {@inheritDoc} */\n-    @SuppressWarnings(\"unchecked\")\n     @Override public Class<? extends Service> serviceClass() {\n         if (cfg instanceof LazyServiceConfiguration) {\n+            if (srvcCls != null)\n+                return srvcCls;\n+\n             String clsName = ((LazyServiceConfiguration)cfg).serviceClassName();\n \n             try {\n-                return (Class<? extends Service>)Class.forName(clsName);\n+                srvcCls = (Class<? extends Service>)Class.forName(clsName);\n+\n+                return srvcCls;\n             }\n             catch (ClassNotFoundException e) {\n+                GridDeployment srvcDep = ctx.deploy().getDeployment(clsName);", "originalCommit": "5531f0c01a1bd7070bb9372b589641efcb6f0544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4ODIxNg==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525288216", "bodyText": "It's only one line of code can be reused, I think it's not such a good idea to make a new method to reuse only ctx.deploy().getDeployment(clsName).", "author": "alex-plekhanov", "createdAt": "2020-11-17T16:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5MzM5MQ==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525293391", "bodyText": "I didn't mean copy/paste :)\nI thought that there is another way to load className.\nFor example, load and set a className externally (without KernalContext field in ServiceInfo).\nNot sure if IgniteServiceProcessor#copyAndInject is a suitable place for that or not.", "author": "daradurvs", "createdAt": "2020-11-17T16:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwNzQwNg==", "url": "https://github.com/apache/ignite/pull/8431#discussion_r525307406", "bodyText": "I've tried to implement class resolving logic in IgniteServiceProcessor before ServiceInfo constructor and pass it as an argument, but I think it's risky if we fail in processServicesChangeRequest, so I've moved class resolving logic to  ServiceInfo.serviceClass() method.", "author": "alex-plekhanov", "createdAt": "2020-11-17T16:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NjU4OA=="}], "type": "inlineReview"}, {"oid": "9245c9ba23d85e42eade478c774510505ccaf436", "url": "https://github.com/apache/ignite/commit/9245c9ba23d85e42eade478c774510505ccaf436", "message": "IGNITE-13633 Review fixes", "committedDate": "2020-11-19T15:06:47Z", "type": "commit"}, {"oid": "1144b052f3ac4be2fbd97c37cc53c25f701e5051", "url": "https://github.com/apache/ignite/commit/1144b052f3ac4be2fbd97c37cc53c25f701e5051", "message": "IGNITE-13663 Review fixes, partial revert", "committedDate": "2020-12-02T09:48:17Z", "type": "commit"}, {"oid": "1ce95c603e15aa81d665c0be5b2b89466982d0fb", "url": "https://github.com/apache/ignite/commit/1ce95c603e15aa81d665c0be5b2b89466982d0fb", "message": "IGNITE-13663 Unused imports removed", "committedDate": "2020-12-02T10:43:15Z", "type": "commit"}, {"oid": "880b49754dfdd14fb9dbdd1c63bc22ae88a8d49f", "url": "https://github.com/apache/ignite/commit/880b49754dfdd14fb9dbdd1c63bc22ae88a8d49f", "message": "IGNITE-13663 Review fixes", "committedDate": "2020-12-02T12:58:17Z", "type": "commit"}, {"oid": "b37d9802d1be71efa74a8e243fbd2493b1f2a6cc", "url": "https://github.com/apache/ignite/commit/b37d9802d1be71efa74a8e243fbd2493b1f2a6cc", "message": "IGNITE-13663 Review fixes", "committedDate": "2020-12-02T13:00:32Z", "type": "commit"}]}