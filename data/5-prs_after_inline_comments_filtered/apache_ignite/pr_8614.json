{"pr_number": 8614, "pr_title": "IGNITE-13897 .NET: Service can't assign correct type to passed array parameters", "pr_createdAt": "2020-12-25T09:21:40Z", "pr_url": "https://github.com/apache/ignite/pull/8614", "timeline": [{"oid": "59f97db795eea3a35180cc578faae2a8a0cd0368", "url": "https://github.com/apache/ignite/commit/59f97db795eea3a35180cc578faae2a8a0cd0368", "message": "IGNITE-13897: Bug reproducer.", "committedDate": "2020-12-25T09:19:46Z", "type": "commit"}, {"oid": "da985e953f081042980c0a7e0f54b8f58a478ba0", "url": "https://github.com/apache/ignite/commit/da985e953f081042980c0a7e0f54b8f58a478ba0", "message": "IGNITE-13897: WIP", "committedDate": "2020-12-25T15:37:23Z", "type": "commit"}, {"oid": "cbdc7743f3b86890388b5074739c7706858dbae9", "url": "https://github.com/apache/ignite/commit/cbdc7743f3b86890388b5074739c7706858dbae9", "message": "Merge branch 'master' into IGNITE-13897", "committedDate": "2020-12-25T15:55:00Z", "type": "commit"}, {"oid": "9166f42b2c3678665f79e4b7798e3546ad1325c8", "url": "https://github.com/apache/ignite/commit/9166f42b2c3678665f79e4b7798e3546ad1325c8", "message": "Merge branch 'master' into IGNITE-13897", "committedDate": "2020-12-26T07:51:28Z", "type": "commit"}, {"oid": "b95f64ba9bff0d1ed3a2f1256a4f3e2a10a056c5", "url": "https://github.com/apache/ignite/commit/b95f64ba9bff0d1ed3a2f1256a4f3e2a10a056c5", "message": "IGNITE-13897: WIP. Dirty fix of the bug.", "committedDate": "2020-12-26T16:48:37Z", "type": "commit"}, {"oid": "c0aebe2263bf4061e8cf9145a626970552b06678", "url": "https://github.com/apache/ignite/commit/c0aebe2263bf4061e8cf9145a626970552b06678", "message": "IGNITE-13897: WIP. Dirty fix of the bug.", "committedDate": "2020-12-26T16:50:08Z", "type": "commit"}, {"oid": "03b4085f85bb9e0ca47186ed1cc383994e1828d2", "url": "https://github.com/apache/ignite/commit/03b4085f85bb9e0ca47186ed1cc383994e1828d2", "message": "IGNITE-13897: WIP. Dirty fix of the bug.", "committedDate": "2020-12-26T16:52:27Z", "type": "commit"}, {"oid": "f096e42f7e565db4dac4f0c7b7e84d50ffefefc5", "url": "https://github.com/apache/ignite/commit/f096e42f7e565db4dac4f0c7b7e84d50ffefefc5", "message": "IGNITE-13897: WIP. Dirty fix of the bug.", "committedDate": "2020-12-26T16:54:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA4NjI0NQ==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549086245", "bodyText": "Great! It was strange, that here was untyped array. Great catch!", "author": "ivandasch", "createdAt": "2020-12-27T09:04:11Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformUtils.java", "diffHunk": "@@ -989,7 +990,9 @@ private static boolean knownMap(Object o) {\n      * @return Result.\n      */\n     public static Object[] unwrapBinariesInArray(Object[] arr) {\n-        Object[] res = new Object[arr.length];\n+        Class<?> compType = arr.getClass().getComponentType();\n+\n+        Object[] res = (Object[])Array.newInstance(compType, arr.length);", "originalCommit": "f096e42f7e565db4dac4f0c7b7e84d50ffefefc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxNjgyMQ==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549616821", "bodyText": "Now that we have a check for component type above, this can be changed back to Object[] res = new Object[arr.length];", "author": "ptupitsyn", "createdAt": "2020-12-29T08:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA4NjI0NQ=="}], "type": "inlineReview"}, {"oid": "ac2deaf1c6789a702de53be155cdc6d0bfdd9fff", "url": "https://github.com/apache/ignite/commit/ac2deaf1c6789a702de53be155cdc6d0bfdd9fff", "message": "IGNITE-13897: Tests fixes.", "committedDate": "2020-12-28T08:57:23Z", "type": "commit"}, {"oid": "cf8bc6c00706d3fa37762f65489c491bc3a0fec8", "url": "https://github.com/apache/ignite/commit/cf8bc6c00706d3fa37762f65489c491bc3a0fec8", "message": "IGNITE-13897: Tests fixes.", "committedDate": "2020-12-28T09:01:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxMzgyOQ==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549313829", "bodyText": "Seems to be unnecessary, please revert", "author": "ptupitsyn", "createdAt": "2020-12-28T11:27:13Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/services/PlatformServices.java", "diffHunk": "@@ -559,7 +561,7 @@ public static void convertArrayArgs(Object[] args, Method mtd) {\n     @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n     private static class ServiceProxyHolder extends PlatformAbstractTarget {\n         /** */\n-        private final Object proxy;\n+        public final Object proxy;", "originalCommit": "cf8bc6c00706d3fa37762f65489c491bc3a0fec8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549315847", "bodyText": "What is the use case when compType is not Object, is it covered with some test? I thought we are unwrapping binary objects here, so arr is either Object[], or maybe BinaryObject[].\nIn my understanding, res[i] = unwrapBinary(arr[i]) line below can return an instance of any class, so res must be an Object[].", "author": "ptupitsyn", "createdAt": "2020-12-28T11:34:38Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/utils/PlatformUtils.java", "diffHunk": "@@ -989,7 +990,9 @@ private static boolean knownMap(Object o) {\n      * @return Result.\n      */\n     public static Object[] unwrapBinariesInArray(Object[] arr) {\n-        Object[] res = new Object[arr.length];\n+        Class<?> compType = arr.getClass().getComponentType();", "originalCommit": "cf8bc6c00706d3fa37762f65489c491bc3a0fec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMyMjU2Mw==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549322563", "bodyText": "unwrapBinary keeps the original object if it's not a BinaryObject.\nContract broke in the unwrapBinariesInArray it because converts any typed array into Object[].\nThese changes fix it.", "author": "nizhikov", "createdAt": "2020-12-28T11:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMyNTQ2Mg==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549325462", "bodyText": "Understood, thanks. Which test covers this scenario?", "author": "ptupitsyn", "createdAt": "2020-12-28T12:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMyODI5NA==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549328294", "bodyText": ".Net test ServicesTypeAutoResolveTest#TestCallJavaService will not pass if changes reverted.\nCall of the testOverload method goes over change.", "author": "nizhikov", "createdAt": "2020-12-28T12:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMzMzUxNg==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549333516", "bodyText": "I think we can change the logic to the following:\nif (arr.getClass().getComponentType() != Object.class)\n    return arr;\n\nArrays like this do not require further unwrapping.", "author": "ptupitsyn", "createdAt": "2020-12-28T12:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMzNjM1Mw==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549336353", "bodyText": "What about an array of maps java.util.collection.Map[] or something similar(Collection[])?", "author": "nizhikov", "createdAt": "2020-12-28T12:49:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM0NjI3Mw==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549346273", "bodyText": "Can you add a test to demonstrate?", "author": "ptupitsyn", "createdAt": "2020-12-28T13:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYwOTczNA==", "url": "https://github.com/apache/ignite/pull/8614#discussion_r549609734", "bodyText": "Looks like you are right.\nI've added some tests and the proposed clause.\nThanks!", "author": "nizhikov", "createdAt": "2020-12-29T08:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTMxNTg0Nw=="}], "type": "inlineReview"}, {"oid": "2fd079a577e63781bb65829d5fb82bdaf0589b80", "url": "https://github.com/apache/ignite/commit/2fd079a577e63781bb65829d5fb82bdaf0589b80", "message": "IGNITE-13897: Code review fixes.", "committedDate": "2020-12-28T11:59:36Z", "type": "commit"}, {"oid": "b0f72c226cd866af64cf28e049ffaf849e51f179", "url": "https://github.com/apache/ignite/commit/b0f72c226cd866af64cf28e049ffaf849e51f179", "message": "Merge branch 'master' into IGNITE-13897", "committedDate": "2020-12-28T12:43:53Z", "type": "commit"}, {"oid": "7b97b457497cf6e348e78f905be74215b310818d", "url": "https://github.com/apache/ignite/commit/7b97b457497cf6e348e78f905be74215b310818d", "message": "IGNITE-13897: Code review fixes.", "committedDate": "2020-12-29T08:08:55Z", "type": "commit"}, {"oid": "9012c944bfcc74d69566f4974b45a644c8fea7d2", "url": "https://github.com/apache/ignite/commit/9012c944bfcc74d69566f4974b45a644c8fea7d2", "message": "IGNITE-13897: Code review fixes.", "committedDate": "2020-12-29T09:21:48Z", "type": "commit"}]}