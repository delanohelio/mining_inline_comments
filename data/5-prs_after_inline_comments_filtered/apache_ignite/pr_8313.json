{"pr_number": 8313, "pr_title": "IGNITE-13495: fix ZookeeperDiscoveryImpl#getCoordinator()", "pr_createdAt": "2020-10-03T17:28:06Z", "pr_url": "https://github.com/apache/ignite/pull/8313", "timeline": [{"oid": "7dd1190de78ee2dd8fabed2932de7a22f0029775", "url": "https://github.com/apache/ignite/commit/7dd1190de78ee2dd8fabed2932de7a22f0029775", "message": "IGNITE-13495: fix ZookeeperDiscoveryImpl#getCoordinator()", "committedDate": "2020-10-03T17:26:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2ODMyNg==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499168326", "bodyText": "n -> !n.isClient() && !n.isDaemon()", "author": "ivandasch", "createdAt": "2020-10-03T17:56:02Z", "path": "modules/zookeeper/src/main/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryImpl.java", "diffHunk": "@@ -4582,9 +4582,11 @@ else if (connState == ConnectionState.STOPPED) {\n \n     /** */\n     public UUID getCoordinator() {\n-        Map.Entry<Long, ZookeeperClusterNode> e = rtState.top.nodesByOrder.firstEntry();\n-\n-        return e != null ? e.getValue().id() : null;\n+        return rtState.top.nodesByOrder.values().stream()\n+                .filter(n -> !n.isClient())", "originalCommit": "7dd1190de78ee2dd8fabed2932de7a22f0029775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2ODgyMQ==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499168821", "bodyText": "fixed", "author": "Sega76", "createdAt": "2020-10-03T18:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2ODMyNg=="}], "type": "inlineReview"}, {"oid": "3b5698a97ebbf6dfc861c31d07357007aaad6ce8", "url": "https://github.com/apache/ignite/commit/3b5698a97ebbf6dfc861c31d07357007aaad6ce8", "message": "IGNITE-13495: fix comments", "committedDate": "2020-10-03T18:02:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTE1Ng==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499169156", "bodyText": "stopGrid(0)", "author": "ivandasch", "createdAt": "2020-10-03T18:06:44Z", "path": "modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryMiscTest.java", "diffHunk": "@@ -241,6 +241,23 @@ public void testMbean() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testMbeanGetCoordinator() throws Exception {\n+        startGrid(0);\n+        startClientGrid(1);\n+        IgniteEx srv2 = startGrid(2);\n+\n+        ZookeeperDiscoverySpiMBean mbean = getMxBean(srv2.context().igniteInstanceName(), \"SPIs\",\n+                ZookeeperDiscoverySpi.class, ZookeeperDiscoverySpiMBean.class);\n+\n+        grid(0).close();", "originalCommit": "7dd1190de78ee2dd8fabed2932de7a22f0029775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTY1Mg==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499169652", "bodyText": "fixed", "author": "Sega76", "createdAt": "2020-10-03T18:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTI1NA==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499169254", "bodyText": "Could you please check also the other method? Just to ensure that both methods are correct", "author": "ivandasch", "createdAt": "2020-10-03T18:07:58Z", "path": "modules/zookeeper/src/test/java/org/apache/ignite/spi/discovery/zk/internal/ZookeeperDiscoveryMiscTest.java", "diffHunk": "@@ -241,6 +241,23 @@ public void testMbean() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testMbeanGetCoordinator() throws Exception {\n+        startGrid(0);\n+        startClientGrid(1);\n+        IgniteEx srv2 = startGrid(2);\n+\n+        ZookeeperDiscoverySpiMBean mbean = getMxBean(srv2.context().igniteInstanceName(), \"SPIs\",\n+                ZookeeperDiscoverySpi.class, ZookeeperDiscoverySpiMBean.class);\n+\n+        grid(0).close();\n+\n+        assertEquals(mbean.getCoordinatorNodeFormatted(), String.valueOf(srv2.localNode()));", "originalCommit": "7dd1190de78ee2dd8fabed2932de7a22f0029775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTY0NA==", "url": "https://github.com/apache/ignite/pull/8313#discussion_r499169644", "bodyText": "done", "author": "Sega76", "createdAt": "2020-10-03T18:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE2OTI1NA=="}], "type": "inlineReview"}, {"oid": "27c0264bc70f081610ff4d12392ca76e4677ff48", "url": "https://github.com/apache/ignite/commit/27c0264bc70f081610ff4d12392ca76e4677ff48", "message": "IGNITE-13495: fix comments", "committedDate": "2020-10-03T18:12:30Z", "type": "commit"}, {"oid": "ade99433dd7ec06b0de3a1c94b7aa7b4852f5d33", "url": "https://github.com/apache/ignite/commit/ade99433dd7ec06b0de3a1c94b7aa7b4852f5d33", "message": "IGNITE-13495: little fix", "committedDate": "2020-10-03T18:14:45Z", "type": "commit"}]}