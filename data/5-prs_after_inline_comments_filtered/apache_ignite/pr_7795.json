{"pr_number": 7795, "pr_title": "IGNITE-12989 TxRecovery should log statuses to TimeBag", "pr_createdAt": "2020-05-12T14:58:47Z", "pr_url": "https://github.com/apache/ignite/pull/7795", "timeline": [{"oid": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "url": "https://github.com/apache/ignite/commit/e98c28ea856c4282edf4705fa9c5a427f80ba301", "message": "WIP", "committedDate": "2020-05-12T14:56:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NzYyMA==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424377620", "bodyText": "Typo: future -> fut", "author": "nizhikov", "createdAt": "2020-05-13T11:53:31Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3016,6 +3031,13 @@ else if (tx.setRollbackOnly())\n                     }\n                 }\n \n+                timeBag.finishGlobalStage(\"Initialized\");\n+\n+                doneFut.markInitialized();\n+\n+                if (txCnt.get() > 0)\n+                    doneFut.listen(future -> finishAndRecordTimings());", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3OTEyMw==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424379123", "bodyText": "This would be executed on each transaction?\nOr only on recovery after some node failed?", "author": "nizhikov", "createdAt": "2020-05-13T11:56:22Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3051,6 +3073,37 @@ else if (tx.setRollbackOnly())\n                 cctx.kernalContext().gateway().readUnlock();\n             }\n         }\n+\n+        /**\n+         * @param tx Tx.\n+         * @param failedNode Failed node.\n+         */\n+        private void processPrepared(IgniteInternalTx tx, UUID failedNode) {\n+            IgniteInternalFuture<Boolean> fut = commitIfPrepared(tx, Collections.singleton(failedNode));\n+\n+            if (fut != null)\n+                doneFut.add(fut);\n+\n+            txCnt.incrementAndGet();\n+        }\n+\n+        /**\n+         *\n+         */\n+        private void finishAndRecordTimings() {", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNzEwOA==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424407108", "bodyText": "only on recovery after some node failed", "author": "anton-vinogradov", "createdAt": "2020-05-13T12:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3OTEyMw=="}], "type": "inlineReview"}, {"oid": "74c0c63d301e3edc41540e08d2086b3b0d48a9a1", "url": "https://github.com/apache/ignite/commit/74c0c63d301e3edc41540e08d2086b3b0d48a9a1", "message": "WIP", "committedDate": "2020-05-13T12:03:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5MjkxMg==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424392912", "bodyText": "Let's wrap in:\nif (log.isInfoEnabled()) {\n            StringBuilder timingsToLog = new StringBuilder();\n\n            timingsToLog.append(\"TxRecovery Status and Timings [txs=\").append(txCnt.get());\n\n            for (String stageTiming : timeBag.stagesTimings())\n                timingsToLog.append(\", \").append(stageTiming);\n\n            timingsToLog.append(\"]\");\n\n            log.info(timingsToLog.toString());\n}", "author": "nizhikov", "createdAt": "2020-05-13T12:21:39Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3051,6 +3073,37 @@ else if (tx.setRollbackOnly())\n                 cctx.kernalContext().gateway().readUnlock();\n             }\n         }\n+\n+        /**\n+         * @param tx Tx.\n+         * @param failedNode Failed node.\n+         */\n+        private void processPrepared(IgniteInternalTx tx, UUID failedNode) {\n+            IgniteInternalFuture<Boolean> fut = commitIfPrepared(tx, Collections.singleton(failedNode));\n+\n+            if (fut != null)\n+                doneFut.add(fut);\n+\n+            txCnt.incrementAndGet();\n+        }\n+\n+        /**\n+         *\n+         */\n+        private void finishAndRecordTimings() {\n+            timeBag.finishGlobalStage(\"Finished\");\n+\n+            StringBuilder timingsToLog = new StringBuilder();\n+\n+            timingsToLog.append(\"TxRecovery Status and Timings [txs=\").append(txCnt.get());\n+\n+            for (String stageTiming : timeBag.stagesTimings())\n+                timingsToLog.append(\", \").append(stageTiming);\n+\n+            timingsToLog.append(\"]\");\n+\n+            log.info(timingsToLog.toString());", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNzUzNQ==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424407535", "bodyText": "do we really need to check isInfoEnabled?", "author": "anton-vinogradov", "createdAt": "2020-05-13T12:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5MjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3NTA3OQ==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r425775079", "bodyText": "done", "author": "anton-vinogradov", "createdAt": "2020-05-15T12:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5MjkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjk1OA==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424402958", "bodyText": "Let's rename it to preparedTxCnt", "author": "nizhikov", "createdAt": "2020-05-13T12:38:12Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -2948,6 +2952,15 @@ private void broadcastToNodesSupportingFeature(IgniteRunnable job, IgniteFeature\n         /** */\n         private final MvccCoordinator mvccCrd;\n \n+        /** Time bag to measure and store tx recovery stages times. */\n+        private final TimeBag timeBag = new TimeBag();\n+\n+        /** Prepared tx to be recovered count. */\n+        private final AtomicLong txCnt = new AtomicLong();", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDIxNQ==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424404215", "bodyText": "Let's check here - is info level enabled.\nOtherwise, we perform a lot of unnecessary work - finishGlobalStage includes acquiring write lock, creating some objects, etc.", "author": "nizhikov", "createdAt": "2020-05-13T12:40:16Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -2959,6 +2972,8 @@ private TxRecoveryInitRunnable(ClusterNode node, MvccCoordinator mvccCrd) {\n \n         /** {@inheritDoc} */\n         @Override public void run() {\n+            timeBag.finishGlobalStage(\"Started\");", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwODY3Mw==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424408673", "bodyText": "info is always enabled on adequate deployments?\nuseless code I think", "author": "anton-vinogradov", "createdAt": "2020-05-13T12:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3NTE3Ng==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r425775176", "bodyText": "done", "author": "anton-vinogradov", "createdAt": "2020-05-15T12:43:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDM1OA==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r424404358", "bodyText": "Let's check here - is info level enabled.\nOtherwise, we perform a lot of unnecessary work - finishGlobalStage includes acquiring write lock, creating some objects, etc.", "author": "nizhikov", "createdAt": "2020-05-13T12:40:29Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/transactions/IgniteTxManager.java", "diffHunk": "@@ -3016,6 +3031,13 @@ else if (tx.setRollbackOnly())\n                     }\n                 }\n \n+                timeBag.finishGlobalStage(\"Initialized\");", "originalCommit": "e98c28ea856c4282edf4705fa9c5a427f80ba301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc3NTI2Mw==", "url": "https://github.com/apache/ignite/pull/7795#discussion_r425775263", "bodyText": "done", "author": "anton-vinogradov", "createdAt": "2020-05-15T12:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNDM1OA=="}], "type": "inlineReview"}, {"oid": "dad61c278417598c57532ff972acfdefe22d52c4", "url": "https://github.com/apache/ignite/commit/dad61c278417598c57532ff972acfdefe22d52c4", "message": "WIP", "committedDate": "2020-05-13T12:46:13Z", "type": "commit"}, {"oid": "1aaa05b55227120dc8877f4c9b0878d9eefd2b30", "url": "https://github.com/apache/ignite/commit/1aaa05b55227120dc8877f4c9b0878d9eefd2b30", "message": "Merge remote-tracking branch 'remotes/origin/master' into ignite-12989", "committedDate": "2020-05-15T10:50:01Z", "type": "commit"}, {"oid": "0bf4d184156158728ef3b80612cfab83aac901d9", "url": "https://github.com/apache/ignite/commit/0bf4d184156158728ef3b80612cfab83aac901d9", "message": "WIP", "committedDate": "2020-05-15T10:55:32Z", "type": "commit"}, {"oid": "c6ffd7f3f2df9e2b79a3c9411c491cc50d426b3d", "url": "https://github.com/apache/ignite/commit/c6ffd7f3f2df9e2b79a3c9411c491cc50d426b3d", "message": "WIP", "committedDate": "2020-05-18T08:10:42Z", "type": "commit"}]}