{"pr_number": 7714, "pr_title": "IGNITE-12930 DistributedProcess fails node if unable to send single message to coordinator", "pr_createdAt": "2020-04-22T11:24:45Z", "pr_url": "https://github.com/apache/ignite/pull/7714", "timeline": [{"oid": "841a347221b363f82f7fd3060f682890b93efd1a", "url": "https://github.com/apache/ignite/commit/841a347221b363f82f7fd3060f682890b93efd1a", "message": "Fix node failing if coordinator failed", "committedDate": "2020-04-22T13:09:22Z", "type": "commit"}, {"oid": "841a347221b363f82f7fd3060f682890b93efd1a", "url": "https://github.com/apache/ignite/commit/841a347221b363f82f7fd3060f682890b93efd1a", "message": "Fix node failing if coordinator failed", "committedDate": "2020-04-22T13:09:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY5OTM3NQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413699375", "bodyText": "initilized -> initialized", "author": "Mmuzaf", "createdAt": "2020-04-23T10:26:58Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/util/distributed/DistributedProcess.java", "diffHunk": "@@ -257,11 +258,20 @@ private void sendSingleMessage(Process p) {\n         SingleNodeMessage<R> singleMsg = new SingleNodeMessage<>(p.id, type, p.resFut.result(),\n             (Exception)p.resFut.error());\n \n-        if (F.eq(ctx.localNodeId(), p.crdId))\n-            onSingleNodeMessageReceived(singleMsg, p.crdId);\n+        UUID crdId = p.crdId;\n+\n+        if (F.eq(ctx.localNodeId(), crdId))\n+            onSingleNodeMessageReceived(singleMsg, crdId);\n         else {\n             try {\n-                ctx.io().sendToGridTopic(p.crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+                ctx.io().sendToGridTopic(crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+            }\n+            catch (ClusterTopologyCheckedException e) {\n+                // The coordinator was failed. The single message will be sent when a new coordinator initilized.", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczOTU3MA==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413739570", "bodyText": "Fixed. Thank you.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY5OTM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMDE3OA==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413700178", "bodyText": "Can you please check, do we need logging here? It seems FailureHandler will log exactly the same message.", "author": "Mmuzaf", "createdAt": "2020-04-23T10:28:18Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/util/distributed/DistributedProcess.java", "diffHunk": "@@ -257,11 +258,20 @@ private void sendSingleMessage(Process p) {\n         SingleNodeMessage<R> singleMsg = new SingleNodeMessage<>(p.id, type, p.resFut.result(),\n             (Exception)p.resFut.error());\n \n-        if (F.eq(ctx.localNodeId(), p.crdId))\n-            onSingleNodeMessageReceived(singleMsg, p.crdId);\n+        UUID crdId = p.crdId;\n+\n+        if (F.eq(ctx.localNodeId(), crdId))\n+            onSingleNodeMessageReceived(singleMsg, crdId);\n         else {\n             try {\n-                ctx.io().sendToGridTopic(p.crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+                ctx.io().sendToGridTopic(crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+            }\n+            catch (ClusterTopologyCheckedException e) {\n+                // The coordinator was failed. The single message will be sent when a new coordinator initilized.\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Failed to send a single message to coordinator: [crdId=\" + crdId +\n+                        \", processId=\" + p.id +\", error=\" + e.getMessage() + ']');\n+                }\n             }\n             catch (IgniteCheckedException e) {\n                 log.error(\"Unable to send message to coordinator.\", e);", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNTEyNg==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413735126", "bodyText": "This is debug logging. Also, I reuse it in the test to make sure that was an attempt to sent a single message. (Another way is override distributed process and watching for calling sendSingleMessage (should be not private))", "author": "NSAmelchev", "createdAt": "2020-04-23T11:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMDE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMTcxOA==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413701718", "bodyText": "Personally, I don't support such cases.\n\nwe can use the DEFAULT type of the distributed process which can be used on all nodes. It's also nice to mention that a newly created distributed process must be registered on all nodes (e.g. via compute?).\nalready existing types can be also reused in tests.", "author": "Mmuzaf", "createdAt": "2020-04-23T10:30:51Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/util/distributed/DistributedProcess.java", "diffHunk": "@@ -367,6 +377,9 @@ private Process(UUID id) {\n \n     /** Defines distributed processes. */\n     public enum DistributedProcessType {\n+        /** For test purpose only. */", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNzc1Mg==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413737752", "bodyText": "I'm against using existing types. It'll require unnecessary configuration and logic for such processes and will make tests more difficult.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMTcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczOTA4OQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413739089", "bodyText": "What means the DEFAULT process? What if we want to add test logic to the action and the finish callbacks? When it will be registered?", "author": "NSAmelchev", "createdAt": "2020-04-23T11:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMTcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMzQ1NQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413703455", "bodyText": "Should we release latch only after the single-message future completed? It's still possible that a new coordinator will be assigned prior to the single message sent.", "author": "Mmuzaf", "createdAt": "2020-04-23T10:33:32Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/util/DistributedProcessCoordinatorLeftTest.java", "diffHunk": "@@ -0,0 +1,158 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.util;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.failure.FailureContext;\n+import org.apache.ignite.failure.FailureHandler;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.util.distributed.DistributedProcess;\n+import org.apache.ignite.internal.util.typedef.G;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.ListeningTestLogger;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static org.apache.ignite.events.EventType.EVT_NODE_FAILED;\n+import static org.apache.ignite.events.EventType.EVT_NODE_LEFT;\n+import static org.apache.ignite.internal.util.distributed.DistributedProcess.DistributedProcessType.TEST_PROCESS;\n+\n+/**\n+ * Tests {@link DistributedProcess} in case of coordinator node left.\n+ */\n+public class DistributedProcessCoordinatorLeftTest extends GridCommonAbstractTest {\n+    /** */\n+    public static final long TIMEOUT = 20_000L;\n+\n+    /** */\n+    public static final int NODES_CNT = 3;\n+\n+    /** Latch to send single message on node left. */\n+    private final CountDownLatch nodeLeftLatch = new CountDownLatch(NODES_CNT - 1);\n+\n+    /** Latch to await sending single messages to a failed coordinator. */\n+    private final CountDownLatch msgSendLatch = new CountDownLatch(NODES_CNT - 1);\n+\n+    /** Failure handler invocation flag. */\n+    private final AtomicBoolean failure = new AtomicBoolean();\n+\n+    /** */\n+    private final ListeningTestLogger listeningLog = new ListeningTestLogger(true, log);\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setGridLogger(listeningLog);\n+\n+        cfg.setLocalEventListeners(Collections.singletonMap(event -> {\n+            nodeLeftLatch.countDown();\n+\n+            try {\n+                msgSendLatch.await();\n+            }\n+            catch (InterruptedException e) {\n+                fail(\"Unexpected interrupt.\");\n+            }\n+\n+            return false;\n+        }, new int[] {EVT_NODE_LEFT, EVT_NODE_FAILED}));\n+\n+        cfg.setFailureHandler(new FailureHandler() {\n+            @Override public boolean onFailure(Ignite ignite, FailureContext failureCtx) {\n+                failure.set(true);\n+\n+                return false;\n+            }\n+        });\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests that coordinator failing during sending single result not cause node failure and the process finishes.\n+     *\n+     * <ol>\n+     *  <li>Start new process of {@link DistributedProcess}.</li>\n+     *  <li>The coordinator fails.</li>\n+     *  <li>Nodes try to send a single message to the not-alive coordinator.</li>\n+     *  <li>{@link DistributedProcess} process a node left event and reinitialize a new coordinator.</li>\n+     *  <li>Process finishes.</li>\n+     * </ol>\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testCoordinatorFailed() throws Exception {\n+        startGrids(NODES_CNT);\n+\n+        CountDownLatch startLatch = new CountDownLatch(NODES_CNT);\n+        CountDownLatch finishLatch = new CountDownLatch(NODES_CNT - 1);\n+\n+        HashMap<String, DistributedProcess<Integer, Integer>> processes = new HashMap<>();\n+\n+        int processRes = 1;\n+\n+        for (Ignite grid : G.allGrids()) {\n+            DistributedProcess<Integer, Integer> dp = new DistributedProcess<>(((IgniteEx)grid).context(), TEST_PROCESS,\n+                req -> GridTestUtils.runAsync(() -> {\n+                    startLatch.countDown();", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMjA0OQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413732049", "bodyText": "The mentioned startLatch is to make sure that process started and we can drop coordinator.\nA new coordinator can't be reassigned because the event queue is blocked by msgSendLatch until single messages sent.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMzQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczODMyMQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413738321", "bodyText": "The single message future must be completed prior to the event queue processing released. Is it true for now? Currently, this will happen at the same time and we will have a race with a new coordinator assigned to the Process.", "author": "Mmuzaf", "createdAt": "2020-04-23T11:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMzQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0MjMzNA==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413742334", "bodyText": "Yes, it's true. 'msgSendLatch' guarantees this. The coordinator will be changed at the event thread after releasing the latch.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwMzQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwNDA3Mw==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413704073", "bodyText": "was failed -> has failed?", "author": "Mmuzaf", "createdAt": "2020-04-23T10:34:29Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/util/distributed/DistributedProcess.java", "diffHunk": "@@ -257,11 +258,20 @@ private void sendSingleMessage(Process p) {\n         SingleNodeMessage<R> singleMsg = new SingleNodeMessage<>(p.id, type, p.resFut.result(),\n             (Exception)p.resFut.error());\n \n-        if (F.eq(ctx.localNodeId(), p.crdId))\n-            onSingleNodeMessageReceived(singleMsg, p.crdId);\n+        UUID crdId = p.crdId;\n+\n+        if (F.eq(ctx.localNodeId(), crdId))\n+            onSingleNodeMessageReceived(singleMsg, crdId);\n         else {\n             try {\n-                ctx.io().sendToGridTopic(p.crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+                ctx.io().sendToGridTopic(crdId, GridTopic.TOPIC_DISTRIBUTED_PROCESS, singleMsg, SYSTEM_POOL);\n+            }\n+            catch (ClusterTopologyCheckedException e) {\n+                // The coordinator was failed. The single message will be sent when a new coordinator initilized.", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczOTYzMQ==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413739631", "bodyText": "Fixed. Thank you.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwNDA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwNDY5OA==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413704698", "bodyText": "I don't think we need such comments :-)", "author": "Mmuzaf", "createdAt": "2020-04-23T10:35:34Z", "path": "modules/core/src/test/java/org/apache/ignite/testsuites/IgniteUtilSelfTestSuite.java", "diffHunk": "@@ -136,7 +137,10 @@\n     // control.sh\n     CommandHandlerParsingTest.class,\n \n-    GridCountDownCallbackTest.class\n+    GridCountDownCallbackTest.class,\n+\n+    // Distributed process.", "originalCommit": "841a347221b363f82f7fd3060f682890b93efd1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczOTY5Mg==", "url": "https://github.com/apache/ignite/pull/7714#discussion_r413739692", "bodyText": "Fixed. Thank you.", "author": "NSAmelchev", "createdAt": "2020-04-23T11:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcwNDY5OA=="}], "type": "inlineReview"}, {"oid": "f5e57209bb02ec592263fa78eed5bb6aedca8115", "url": "https://github.com/apache/ignite/commit/f5e57209bb02ec592263fa78eed5bb6aedca8115", "message": "Review fixes", "committedDate": "2020-04-23T11:33:53Z", "type": "commit"}, {"oid": "f289ff26eac87d891039eeb0d1f7d3828ca89b0e", "url": "https://github.com/apache/ignite/commit/f289ff26eac87d891039eeb0d1f7d3828ca89b0e", "message": "Fix event listener removing", "committedDate": "2020-04-23T11:45:57Z", "type": "commit"}, {"oid": "0afff8f6ccbeef467365ecf43a187ef38657e369", "url": "https://github.com/apache/ignite/commit/0afff8f6ccbeef467365ecf43a187ef38657e369", "message": "Enum override", "committedDate": "2020-04-23T12:30:16Z", "type": "commit"}, {"oid": "03ab0f4eb369834c47e25d8fe9a70570edaa0f47", "url": "https://github.com/apache/ignite/commit/03ab0f4eb369834c47e25d8fe9a70570edaa0f47", "message": "Fix codestyle", "committedDate": "2020-04-23T14:05:57Z", "type": "commit"}, {"oid": "60f81a66b3526f0510564a5d91962a19abcf6539", "url": "https://github.com/apache/ignite/commit/60f81a66b3526f0510564a5d91962a19abcf6539", "message": "Use fut listener to release msg sent latch", "committedDate": "2020-04-23T16:31:09Z", "type": "commit"}, {"oid": "965eae8f08517450359a57cb9f625a12a8699792", "url": "https://github.com/apache/ignite/commit/965eae8f08517450359a57cb9f625a12a8699792", "message": "Add javadocs.", "committedDate": "2020-04-23T16:40:41Z", "type": "commit"}, {"oid": "cea91c101b3ae5bf1855dba68f2fa832b55b6da6", "url": "https://github.com/apache/ignite/commit/cea91c101b3ae5bf1855dba68f2fa832b55b6da6", "message": "Fix startLatch", "committedDate": "2020-04-23T19:06:23Z", "type": "commit"}, {"oid": "2d3021974a8c06c899c782673b69c38c1920f32e", "url": "https://github.com/apache/ignite/commit/2d3021974a8c06c899c782673b69c38c1920f32e", "message": "Merge branch 'master' into ignite-12930\n\n# Conflicts:\n#\tmodules/core/src/main/java/org/apache/ignite/internal/util/distributed/DistributedProcess.java", "committedDate": "2020-05-02T10:57:18Z", "type": "commit"}, {"oid": "352a94bf62c09e99a72726b368f00cdd4cf21887", "url": "https://github.com/apache/ignite/commit/352a94bf62c09e99a72726b368f00cdd4cf21887", "message": "Without Enum override in tests", "committedDate": "2020-05-02T11:05:29Z", "type": "commit"}, {"oid": "8798269afcd35b8c736a68fe3b693d3e649148ca", "url": "https://github.com/apache/ignite/commit/8798269afcd35b8c736a68fe3b693d3e649148ca", "message": "Fix codestyle", "committedDate": "2020-05-02T11:13:12Z", "type": "commit"}, {"oid": "edfd4f784ddceffe9545a7e927b177b4c06e6e34", "url": "https://github.com/apache/ignite/commit/edfd4f784ddceffe9545a7e927b177b4c06e6e34", "message": "Merge branch 'master' into ignite-12930\n\n# Conflicts:\n#\tmodules/core/src/test/java/org/apache/ignite/testsuites/IgniteUtilSelfTestSuite.java", "committedDate": "2020-07-10T08:08:03Z", "type": "commit"}, {"oid": "f4fc5a0552555b4fedbfc2795a4870430f5321da", "url": "https://github.com/apache/ignite/commit/f4fc5a0552555b4fedbfc2795a4870430f5321da", "message": "Merge branch 'master' into ignite-12930", "committedDate": "2020-07-20T13:56:50Z", "type": "commit"}]}