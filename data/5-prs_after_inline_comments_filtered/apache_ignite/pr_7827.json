{"pr_number": 7827, "pr_title": "IGNITE-12978: add cancel snapshot support", "pr_createdAt": "2020-05-21T08:46:00Z", "pr_url": "https://github.com/apache/ignite/pull/7827", "timeline": [{"oid": "57ed11abeadaef6b579012fc85438ca72054e13f", "url": "https://github.com/apache/ignite/commit/57ed11abeadaef6b579012fc85438ca72054e13f", "message": "IGNITE-12978: add cancel snapshot method", "committedDate": "2020-05-21T08:45:18Z", "type": "commit"}, {"oid": "23997eaf93d2972c8149f6cdf235bf5f1a0151cc", "url": "https://github.com/apache/ignite/commit/23997eaf93d2972c8149f6cdf235bf5f1a0151cc", "message": "IGNITE-12978: wip", "committedDate": "2020-05-21T14:58:47Z", "type": "commit"}, {"oid": "c5094c3f444299fe9d23b0c4699814c620305a64", "url": "https://github.com/apache/ignite/commit/c5094c3f444299fe9d23b0c4699814c620305a64", "message": "Squashed commit of the following:\n\ncommit d3f34c98def73893a4039e44ecd8cccd8ada11fc\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu May 21 18:10:56 2020 +0300\n\n    IGNITE-12961: fix test 2\n\ncommit 5693d160214246627abab7eae187bc837b461f9a\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu May 21 18:05:45 2020 +0300\n\n    IGNITE-12961: fix test\n\ncommit 9b617dade43d17f3a24423628dac97b269ddd64f\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu May 21 13:25:34 2020 +0300\n\n    IGNITE-12961: set jmx exporter locally\n\ncommit 4849381426bfb74b280be1a4c3375ba24a206951\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu May 21 11:54:53 2020 +0300\n\n    IGNITE-12961: set default test timeout\n\ncommit ceffd82a660c429add6318ccec19cfdc72258388\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Wed May 20 19:45:06 2020 +0300\n\n    IGNITE-12961: improve test err logging\n\ncommit 8390b16130f91cb3c4c9a597c1c907fbe0970727\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Wed May 20 13:39:01 2020 +0300\n\n    IGNITE-12961: fix flaky test\n\ncommit 5a9501759d4b4cb88cedecae0129d5888a5c4939\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Tue May 19 21:50:42 2020 +0300\n\n    IGNITE-12961: fix usage\n\ncommit d642397caafc57124b93b03edc7a0ed3a0a5b2f5\nMerge: 340aecbc6a 832f7414e3\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Tue May 19 21:29:27 2020 +0300\n\n    Merge branch 'master' into ignite-12961\n\ncommit 340aecbc6a5fbad57aea8b12ec60046d2fd3854e\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Tue May 19 20:47:42 2020 +0300\n\n    IGNITE-12961: fix review comments 2\n\ncommit bcf7a4ccf46d0fc09f38b6ae30918c5680228aa3\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Mon May 18 23:18:51 2020 +0300\n\n    IGNITE-12961: fix review comments\n\ncommit d192284441843893206b9f9e3731c9dc95089830\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Mon May 18 18:46:56 2020 +0300\n\n    IGNITE-12961: fix snapshot control.sh command\n\ncommit 218c312bef42753ede5fbb3754e7ac62992b05b9\nMerge: 7ac2e1baf4 f5e5bfc366\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Mon May 18 13:36:58 2020 +0300\n\n    Merge branch 'master' into ignite-12961\n\ncommit 7ac2e1baf4289346a2a7720e167c843abc705bec\nMerge: 8b1095e7df fb2f608005\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu May 14 16:32:33 2020 +0300\n\n    Merge branch 'master' into ignite-12961\n\ncommit 8b1095e7df1886457e3758da1585966c33eb3286\nMerge: e55031ca00 895eab28a7\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Fri May 8 18:31:43 2020 +0300\n\n    Merge branch 'master' into ignite-12961\n\ncommit e55031ca0022ec65ef952f07e432298f5bfe1f67\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Sun May 3 17:21:40 2020 +0300\n\n    IGNITE-12961: throw ex immediately\n\ncommit 25ae1baa892b85f00cbfa45b79e5b4aa528e2845\nMerge: 5b434540cf 5ad8944992\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Sun May 3 12:43:29 2020 +0300\n\n    Merge branch 'master' into ignite-12961\n\ncommit 5b434540cf2426d3435b67e64f9e8032a9273cf9\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Sat May 2 15:41:23 2020 +0300\n\n    IGNITE-12961: implement snapshot command\n\ncommit c85361f7c61776febb3ac8ff85ec4b4804b6069e\nAuthor: Maxim Muzafarov <maxmuzaf@gmail.com>\nDate:   Thu Apr 30 18:09:47 2020 +0300\n\n    IGNITE-12961: WIP", "committedDate": "2020-05-21T16:02:12Z", "type": "commit"}, {"oid": "16b9bdb82f46b429da239cb1d46353bd9668bae7", "url": "https://github.com/apache/ignite/commit/16b9bdb82f46b429da239cb1d46353bd9668bae7", "message": "IGNITE-12978: wip", "committedDate": "2020-05-21T16:03:11Z", "type": "commit"}, {"oid": "78a8f21e915f4d3fef5ab11b1b55da1a1691ca57", "url": "https://github.com/apache/ignite/commit/78a8f21e915f4d3fef5ab11b1b55da1a1691ca57", "message": "Merge branch 'master' into ignite-12978", "committedDate": "2020-05-21T16:18:41Z", "type": "commit"}, {"oid": "3a3c245538b5bc5642b33a593ba819c11fc34328", "url": "https://github.com/apache/ignite/commit/3a3c245538b5bc5642b33a593ba819c11fc34328", "message": "IGNITE-12978: add cancel snapshot method", "committedDate": "2020-05-21T19:27:32Z", "type": "commit"}, {"oid": "a001b401d4cdd865a29955cfb09fb316940fd3db", "url": "https://github.com/apache/ignite/commit/a001b401d4cdd865a29955cfb09fb316940fd3db", "message": "IGNITE-12978: support snapshot kill and cancel commands", "committedDate": "2020-05-22T18:40:30Z", "type": "commit"}, {"oid": "2c6bf3ba0c3e5ac88cf81d2b115af3bfee4f125b", "url": "https://github.com/apache/ignite/commit/2c6bf3ba0c3e5ac88cf81d2b115af3bfee4f125b", "message": "IGNITE-12978: fix minor issues", "committedDate": "2020-05-22T18:44:44Z", "type": "commit"}, {"oid": "adb6b7a6f07ae09fb9d379f6ada5032580c446fa", "url": "https://github.com/apache/ignite/commit/adb6b7a6f07ae09fb9d379f6ada5032580c446fa", "message": "IGNITE-12978: fix minor issues 2", "committedDate": "2020-05-22T18:53:15Z", "type": "commit"}, {"oid": "d95d20593882b5d00e6cdc546654fa585df45fc9", "url": "https://github.com/apache/ignite/commit/d95d20593882b5d00e6cdc546654fa585df45fc9", "message": "IGNITE-12978: code style issues", "committedDate": "2020-05-22T18:54:35Z", "type": "commit"}, {"oid": "7bc7a7884e8ef43895ef882f2a06acede727e8c9", "url": "https://github.com/apache/ignite/commit/7bc7a7884e8ef43895ef882f2a06acede727e8c9", "message": "IGNITE-12978: fix merge issue", "committedDate": "2020-05-23T08:32:33Z", "type": "commit"}, {"oid": "e7be9b1a4742f9d0c33c4b33e862ca7d0bcb0121", "url": "https://github.com/apache/ignite/commit/e7be9b1a4742f9d0c33c4b33e862ca7d0bcb0121", "message": "IGNITE-12978: cancel snapshot", "committedDate": "2020-05-23T16:20:38Z", "type": "commit"}, {"oid": "2742535747a916b054f75b22ec89458838462869", "url": "https://github.com/apache/ignite/commit/2742535747a916b054f75b22ec89458838462869", "message": "IGNITE-12978: fix exception handling", "committedDate": "2020-05-23T17:08:12Z", "type": "commit"}, {"oid": "04b7565c1a8f73a23f0ed93ebf1053348db69e12", "url": "https://github.com/apache/ignite/commit/04b7565c1a8f73a23f0ed93ebf1053348db69e12", "message": "IGNITE-12978: fix client naming", "committedDate": "2020-05-23T17:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MTQ3Nw==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429581477", "bodyText": "else should be on a new line.", "author": "NSAmelchev", "createdAt": "2020-05-23T21:59:57Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -540,10 +542,14 @@ private void processLocalSnapshotStartStageResult(UUID id, Map<UUID, SnapshotOpe\n             missed.removeAll(res.keySet());\n             missed.removeAll(err.keySet());\n \n-            snpReq.hasErr = !F.isEmpty(err) || !missed.isEmpty();\n+            boolean cancelled = err.values().stream()\n+                .anyMatch(e -> e instanceof IgniteFutureCancelledCheckedException);\n \n-            if (snpReq.hasErr) {\n-                U.warn(log, \"Execution of local snapshot tasks fails or them haven't been executed \" +\n+            if (cancelled) {\n+                snpReq.err = new IgniteFutureCancelledCheckedException(\"Execution of snapshot tasks \" +\n+                    \"has been cancelled by external process [err=\" + err + \", missed=\" + missed + ']');\n+            } else if (!F.isEmpty(err) || !missed.isEmpty()) {", "originalCommit": "7bc7a7884e8ef43895ef882f2a06acede727e8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNzk3Nw==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429617977", "bodyText": "Fixed.", "author": "Mmuzaf", "createdAt": "2020-05-24T09:40:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MTQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MjY0NA==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429582644", "bodyText": "Suppose that next processes in the cluster will happen simultaneously:\n\nThe END_SNAPSHOT DP will be at the finish stage and only part of nodes processed their 'this::processLocalSnapshotEndStageResult'\nPart of nodes executes broadcasted closure cancelLocalSnapshotTask\n\nThey are processed by different threads. Can we get a situation when part of nodes finish clusterSnpFut successfully and other ones with error? It's ok?", "author": "NSAmelchev", "createdAt": "2020-05-23T22:21:27Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -634,6 +642,66 @@ public boolean isSnapshotCreating() {\n         }\n     }\n \n+    /** {@inheritDoc} */\n+    @Override public IgniteFuture<Void> cancelSnapshot(String name) {\n+        A.notNullOrEmpty(name, \"Snapshot name must be not empty or null\");\n+\n+        IgniteInternalFuture<Void> fut0 = cctx.kernalContext().closure()\n+            .broadcast(new CancelSnapshotClosure(),", "originalCommit": "7bc7a7884e8ef43895ef882f2a06acede727e8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNjcxNg==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429626716", "bodyText": "Nikita,\n\nIt's true that some operations may execute concurrently on snapshot cancellation operation.\nSnapshot operation consists of four stages:\n\n\nstart-stage\nstart-stage result\nend-stage\nend-stage result\n\nIf cancel operation occurred when on start-stage than snapshot operation will be canceled. On other stages, it will have no effect since all the cache data already collected.\n\nclusterSnpFut is set on coordinator only, so it has no effect in case described by you. If some of the local snapshot tasks finish with an error an the other with CancelledException than all results will be finished with CancelledException (all intermediate results will be deleted).", "author": "Mmuzaf", "createdAt": "2020-05-24T11:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MjY0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY3MDk2Mg==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429670962", "bodyText": "Ok, got it.", "author": "NSAmelchev", "createdAt": "2020-05-24T20:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MjcwNQ==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429582705", "bodyText": "Can be in one line", "author": "NSAmelchev", "createdAt": "2020-05-23T22:22:41Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/IgniteSnapshotManager.java", "diffHunk": "@@ -540,10 +542,14 @@ private void processLocalSnapshotStartStageResult(UUID id, Map<UUID, SnapshotOpe\n             missed.removeAll(res.keySet());\n             missed.removeAll(err.keySet());\n \n-            snpReq.hasErr = !F.isEmpty(err) || !missed.isEmpty();\n+            boolean cancelled = err.values().stream()\n+                .anyMatch(e -> e instanceof IgniteFutureCancelledCheckedException);", "originalCommit": "7bc7a7884e8ef43895ef882f2a06acede727e8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNzk3MA==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429617970", "bodyText": "Fixed.", "author": "Mmuzaf", "createdAt": "2020-05-24T09:40:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MjcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MzU4OQ==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429583589", "bodyText": "Too long line", "author": "NSAmelchev", "createdAt": "2020-05-23T22:39:07Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/snapshot/SnapshotFutureTask.java", "diffHunk": "@@ -627,7 +629,7 @@ private Runnable wrapExceptionIfStarted(IgniteThrowableRunner exec) {\n \n     /** {@inheritDoc} */\n     @Override public boolean cancel() {\n-        acceptException(new IgniteCheckedException(\"Snapshot operation has been cancelled by external process \" +\n+        acceptException(new IgniteFutureCancelledCheckedException(\"Snapshot operation has been cancelled by external process \" +", "originalCommit": "7bc7a7884e8ef43895ef882f2a06acede727e8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNzk2MQ==", "url": "https://github.com/apache/ignite/pull/7827#discussion_r429617961", "bodyText": "Fixed.", "author": "Mmuzaf", "createdAt": "2020-05-24T09:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU4MzU4OQ=="}], "type": "inlineReview"}, {"oid": "3fb01562a997c37d1fb3cc9686e8801a90ad8488", "url": "https://github.com/apache/ignite/commit/3fb01562a997c37d1fb3cc9686e8801a90ad8488", "message": "IGNITE-12978: fix flacky scan query test", "committedDate": "2020-05-24T09:37:43Z", "type": "commit"}, {"oid": "042e53ce1929a5e82f78e613092378ba6f4d65e1", "url": "https://github.com/apache/ignite/commit/042e53ce1929a5e82f78e613092378ba6f4d65e1", "message": "IGNITE-12978: fix review comments", "committedDate": "2020-05-24T09:41:09Z", "type": "commit"}, {"oid": "5cee8d77ffccaf29cf7529eaecf0b03795735999", "url": "https://github.com/apache/ignite/commit/5cee8d77ffccaf29cf7529eaecf0b03795735999", "message": "IGNITE-12978: concurrent delete directory", "committedDate": "2020-05-24T10:43:34Z", "type": "commit"}, {"oid": "65484616830e8735cc8a39a9c6aad8f75df2c10f", "url": "https://github.com/apache/ignite/commit/65484616830e8735cc8a39a9c6aad8f75df2c10f", "message": "IGNITE-12978: concurrent delete directory 2", "committedDate": "2020-05-24T11:21:45Z", "type": "commit"}, {"oid": "142173e1b2942020da52bbab76a510941c1d5360", "url": "https://github.com/apache/ignite/commit/142173e1b2942020da52bbab76a510941c1d5360", "message": "IGNITE-12978: scan query cancel test flaky", "committedDate": "2020-05-25T14:04:53Z", "type": "commit"}, {"oid": "d2571c2d9578dffca74e758f50786c806203b37c", "url": "https://github.com/apache/ignite/commit/d2571c2d9578dffca74e758f50786c806203b37c", "message": "Merge branch 'master' into ignite-12978", "committedDate": "2020-05-25T18:13:06Z", "type": "commit"}, {"oid": "c7e70a01a7b813c20267cc70858c7679897abb96", "url": "https://github.com/apache/ignite/commit/c7e70a01a7b813c20267cc70858c7679897abb96", "message": "IGNITE-12978: cleanup persistence dir", "committedDate": "2020-05-25T18:24:34Z", "type": "commit"}, {"oid": "14e82b7d923f8f85d794a0706b6e7e382d261316", "url": "https://github.com/apache/ignite/commit/14e82b7d923f8f85d794a0706b6e7e382d261316", "message": "IGNITE-12978: cleanup persistence dir 2", "committedDate": "2020-05-25T18:25:01Z", "type": "commit"}, {"oid": "8168eebf67f37e57ebf31ef2f9b519d1d2490f65", "url": "https://github.com/apache/ignite/commit/8168eebf67f37e57ebf31ef2f9b519d1d2490f65", "message": "IGNITE-12978: keep cursor opened", "committedDate": "2020-05-26T13:09:31Z", "type": "commit"}, {"oid": "7a47a362fe8e89460cc9866abcb7815a217c7c6c", "url": "https://github.com/apache/ignite/commit/7a47a362fe8e89460cc9866abcb7815a217c7c6c", "message": "IGNITE-12978: don't create dirs on delete", "committedDate": "2020-05-26T13:38:01Z", "type": "commit"}, {"oid": "ff3648969cb89fd9782578bb2eb476cb82a93f67", "url": "https://github.com/apache/ignite/commit/ff3648969cb89fd9782578bb2eb476cb82a93f67", "message": "IGNITE-12978: add ex handling", "committedDate": "2020-05-26T14:27:17Z", "type": "commit"}, {"oid": "a8b2d70ca0f48b8c9a454ff65c9e608168b24d5c", "url": "https://github.com/apache/ignite/commit/a8b2d70ca0f48b8c9a454ff65c9e608168b24d5c", "message": "IGNITE-12978: add constant pages count", "committedDate": "2020-05-26T15:31:53Z", "type": "commit"}, {"oid": "47a06cb2090f7751f833190be8f8cbd85bdb203a", "url": "https://github.com/apache/ignite/commit/47a06cb2090f7751f833190be8f8cbd85bdb203a", "message": "IGNITE-12978: code cleanup", "committedDate": "2020-05-26T15:41:57Z", "type": "commit"}, {"oid": "04bf64f2b4b2d929812244e0040164d643644ae8", "url": "https://github.com/apache/ignite/commit/04bf64f2b4b2d929812244e0040164d643644ae8", "message": "IGNITE-12978: fix timeout index rebuild", "committedDate": "2020-05-26T16:38:40Z", "type": "commit"}, {"oid": "1e651be289cdb13485ebaf1ff357cd4f08823a9c", "url": "https://github.com/apache/ignite/commit/1e651be289cdb13485ebaf1ff357cd4f08823a9c", "message": "IGNITE-12978: fix unused import", "committedDate": "2020-05-26T16:46:55Z", "type": "commit"}, {"oid": "0eef42c2dae3e976d51f47cc42fac87baf6aa284", "url": "https://github.com/apache/ignite/commit/0eef42c2dae3e976d51f47cc42fac87baf6aa284", "message": "IGNITE-12978: marshaller and binary mappings", "committedDate": "2020-05-26T19:09:21Z", "type": "commit"}, {"oid": "0b00df27ec624e6e5116904ae649809b5391d316", "url": "https://github.com/apache/ignite/commit/0b00df27ec624e6e5116904ae649809b5391d316", "message": "IGNITE-12978: minor code changes", "committedDate": "2020-05-26T19:11:43Z", "type": "commit"}, {"oid": "21928977a39e928af8220a83c63ce6aa746f3dce", "url": "https://github.com/apache/ignite/commit/21928977a39e928af8220a83c63ce6aa746f3dce", "message": "IGNITE-12978: minor fix", "committedDate": "2020-05-26T19:21:20Z", "type": "commit"}, {"oid": "b8806370ac7bdab04c1501bbac36c44e25e50848", "url": "https://github.com/apache/ignite/commit/b8806370ac7bdab04c1501bbac36c44e25e50848", "message": "IGNITE-12978: minor fix", "committedDate": "2020-05-27T08:43:39Z", "type": "commit"}]}