{"pr_number": 8252, "pr_title": "IGNITE-13450 Add event fired before query execution", "pr_createdAt": "2020-09-16T15:35:47Z", "pr_url": "https://github.com/apache/ignite/pull/8252", "timeline": [{"oid": "2f26d7e6d3aeade0e480978fed929bea43b183f9", "url": "https://github.com/apache/ignite/commit/2f26d7e6d3aeade0e480978fed929bea43b183f9", "message": "IGNITE-13450 Add event fired before query execution", "committedDate": "2020-09-16T15:29:27Z", "type": "commit"}, {"oid": "d4a83afffa9741eb48ca8925243876525ca8efa2", "url": "https://github.com/apache/ignite/commit/d4a83afffa9741eb48ca8925243876525ca8efa2", "message": "IGNITE-13450 fix javadoc", "committedDate": "2020-09-16T15:43:01Z", "type": "commit"}, {"oid": "694951d38b53821e7099fa41177f8a7ff9d6c1a3", "url": "https://github.com/apache/ignite/commit/694951d38b53821e7099fa41177f8a7ff9d6c1a3", "message": "IGNITE-13450 fix code style", "committedDate": "2020-09-17T07:51:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxOTgxMA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r490819810", "bodyText": "Why not 149?", "author": "timoninmaxim", "createdAt": "2020-09-18T09:26:30Z", "path": "modules/core/src/main/java/org/apache/ignite/events/EventType.java", "diffHunk": "@@ -879,6 +879,16 @@\n      */\n     public static final int EVT_BASELINE_AUTO_ADJUST_AWAITING_TIME_CHANGED = 148;\n \n+    /**\n+     * Built-in event type: query execution.\n+     * <p>\n+     * NOTE: all types in range <b>from 1 to 1000 are reserved</b> for\n+     * internal Ignite events and should not be used by user-defined events.\n+     *\n+     * @see QueryExecutionEvent\n+     */\n+    public static final int EVT_QUERY_EXECUTION = 150;", "originalCommit": "694951d38b53821e7099fa41177f8a7ff9d6c1a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkwNTc0Nw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r490905747", "bodyText": "I suppose events should be grouped by tens. At least the first 100 looks grouped, then we have a mess of events. May be put this event as 95 (96 and 97 are cache query events)?", "author": "SomeFire", "createdAt": "2020-09-18T12:10:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxOTgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMzMDg1MA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494330850", "bodyText": "Looks like 150 is ok. Really strange sequence for cache query events. Let do not touch it.", "author": "timoninmaxim", "createdAt": "2020-09-24T13:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxOTgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMTIxMg==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r490821212", "bodyText": "Use 0L instead.", "author": "timoninmaxim", "createdAt": "2020-09-18T09:29:07Z", "path": "modules/core/src/main/java/org/apache/ignite/events/QueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_QUERY_EXECUTION\n+ */\n+public class QueryExecutionEvent<K, V> extends EventAdapter {\n+    /** */\n+    private static final long serialVersionUID = 3738753361235304496L;", "originalCommit": "694951d38b53821e7099fa41177f8a7ff9d6c1a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2MzY0NQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r491963645", "bodyText": "Done.", "author": "SomeFire", "createdAt": "2020-09-21T11:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgyMTIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzMTkwOQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r490831909", "bodyText": "Please reword it , a query is not executed yet in this moment.", "author": "timoninmaxim", "createdAt": "2020-09-18T09:45:49Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -1085,6 +1088,17 @@ private void checkClusterState(QueryParserResult parseRes) {\n                 // Check if cluster state is valid.\n                 checkClusterState(parseRes);\n \n+                if (ctx.event().isRecordable(EVT_QUERY_EXECUTION)) {\n+                    ctx.event().record(new QueryExecutionEvent<>(\n+                        ctx.discovery().localNode(),\n+                        CacheQueryType.SQL_FIELDS.name() + \" query executed.\",", "originalCommit": "694951d38b53821e7099fa41177f8a7ff9d6c1a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2MzYwMA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r491963600", "bodyText": "Reworded.", "author": "SomeFire", "createdAt": "2020-09-21T11:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgzMTkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r490859218", "bodyText": "I see trigger only for SQL_FIELDS event. What about others?", "author": "timoninmaxim", "createdAt": "2020-09-18T10:40:28Z", "path": "modules/core/src/main/java/org/apache/ignite/events/QueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_QUERY_EXECUTION\n+ */\n+public class QueryExecutionEvent<K, V> extends EventAdapter {\n+    /** */\n+    private static final long serialVersionUID = 3738753361235304496L;\n+\n+    /** Query type. */\n+    private final String qryType;\n+\n+    /** Clause. */\n+    private final String clause;\n+\n+    /** Query arguments. */\n+    @GridToStringInclude\n+    private final Object[] args;\n+\n+    /** Security subject ID. */\n+    private final UUID subjId;\n+\n+    /**\n+     * @param node Node where event was fired.\n+     * @param msg Event message.\n+     * @param type Event type.\n+     * @param qryType Query type.\n+     * @param clause Clause.\n+     * @param args Query arguments.\n+     * @param subjId Security subject ID.\n+     */\n+    public QueryExecutionEvent(\n+        ClusterNode node,\n+        String msg,\n+        int type,\n+        String qryType,\n+        @Nullable String clause,\n+        @Nullable Object[] args,\n+        @Nullable UUID subjId\n+    ) {\n+        super(node, msg, type);\n+\n+        assert qryType != null;\n+\n+        this.qryType = qryType;\n+        this.clause = clause;\n+        this.args = args;\n+        this.subjId = subjId;\n+    }\n+\n+    /**\n+     * Gets query type.\n+     *\n+     * @return Query type. Can be {@code \"SQL\"}, {@code \"SQL_FIELDS\"}, {@code \"FULL_TEXT\"}, {@code \"SCAN\"},", "originalCommit": "694951d38b53821e7099fa41177f8a7ff9d6c1a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2MzU0MQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r491963541", "bodyText": "Added.", "author": "SomeFire", "createdAt": "2020-09-21T11:17:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk2ODE5OQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494968199", "bodyText": "I think we should trigger only SQL_FIELDS and SQL types. Other types are not about SQL.", "author": "joooger", "createdAt": "2020-09-25T12:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4MzkzOQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494983939", "bodyText": "But we fire event for any query, isn't it?", "author": "SomeFire", "createdAt": "2020-09-25T13:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwMTM1Nw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r507901357", "bodyText": "@joooger @SomeFire hi, is there some understanding?", "author": "timoninmaxim", "createdAt": "2020-10-19T16:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3MjM2Nw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r526872367", "bodyText": "@joooger, I removed other types as you suggested.", "author": "SomeFire", "createdAt": "2020-11-19T13:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNDQzMg==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r526914432", "bodyText": "I still see all types in Java Doc :)", "author": "joooger", "createdAt": "2020-11-19T14:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNTYzNQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r526915635", "bodyText": "also, what about SQL type?", "author": "joooger", "createdAt": "2020-11-19T14:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkyNjc5Mw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r526926793", "bodyText": "Actually I don't understand why are others queries skipped? Is SCAN query different to SQL from this point of view?", "author": "timoninmaxim", "createdAt": "2020-11-19T14:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMjQ4OA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r526932488", "bodyText": "querySql() have querySqlFields() inside, so, no additions needed.\nI'll fix docs in a few minutes.", "author": "SomeFire", "createdAt": "2020-11-19T14:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1OTIxOA=="}], "type": "inlineReview"}, {"oid": "d79c89b413eb6d9f6b6f44e6598b39db5406a53a", "url": "https://github.com/apache/ignite/commit/d79c89b413eb6d9f6b6f44e6598b39db5406a53a", "message": "IGNITE-13450 review", "committedDate": "2020-09-18T12:11:45Z", "type": "commit"}, {"oid": "f7b2b9f958276cb0c7a709bf4c7033508db715ec", "url": "https://github.com/apache/ignite/commit/f7b2b9f958276cb0c7a709bf4c7033508db715ec", "message": "IGNITE-13450 add SCAN", "committedDate": "2020-09-18T14:38:29Z", "type": "commit"}, {"oid": "ca306b7b24367d75816eb26297eea634146e5190", "url": "https://github.com/apache/ignite/commit/ca306b7b24367d75816eb26297eea634146e5190", "message": "IGNITE-13450 add TEXT", "committedDate": "2020-09-18T15:07:19Z", "type": "commit"}, {"oid": "772c795675457ca440157833f2a51d8f4e9c7f7c", "url": "https://github.com/apache/ignite/commit/772c795675457ca440157833f2a51d8f4e9c7f7c", "message": "IGNITE-13450 add SPI", "committedDate": "2020-09-21T10:19:42Z", "type": "commit"}, {"oid": "a927d3a1fd21911913f2c9b29019fa2951443536", "url": "https://github.com/apache/ignite/commit/a927d3a1fd21911913f2c9b29019fa2951443536", "message": "IGNITE-13450 more tests", "committedDate": "2020-09-21T10:46:20Z", "type": "commit"}, {"oid": "b94fbf69bba69b2f6435cd72cedbbcd7a4521fe3", "url": "https://github.com/apache/ignite/commit/b94fbf69bba69b2f6435cd72cedbbcd7a4521fe3", "message": "IGNITE-13450 remove redundant changes", "committedDate": "2020-09-21T15:19:24Z", "type": "commit"}, {"oid": "c5be398fc90f1cd92fbb6391533e6516b7418710", "url": "https://github.com/apache/ignite/commit/c5be398fc90f1cd92fbb6391533e6516b7418710", "message": "Merge branch 'master' into IGNITE-13450\n\n# Conflicts:\n#\tmodules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "committedDate": "2020-09-22T07:56:33Z", "type": "commit"}, {"oid": "eb40bb2d82b52b9963ee23143aff0ff97c2d49e8", "url": "https://github.com/apache/ignite/commit/eb40bb2d82b52b9963ee23143aff0ff97c2d49e8", "message": "IGNITE-13450 refactor test", "committedDate": "2020-09-22T08:15:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0MTI0Nw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494341247", "bodyText": "Skipped in docs. Also, do we need info about it? It's serializable, but actually does user matter about serialization when implement it? I mean is there a real case how one can use this filter later?", "author": "timoninmaxim", "createdAt": "2020-09-24T13:57:23Z", "path": "modules/core/src/main/java/org/apache/ignite/events/QueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.lang.IgniteBiPredicate;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_QUERY_EXECUTION\n+ */\n+public class QueryExecutionEvent<K, V> extends EventAdapter {\n+    /** */\n+    private static final long serialVersionUID = 0L;\n+\n+    /** Query type. */\n+    private final String qryType;\n+\n+    /** Clause. */\n+    private final String clause;\n+\n+    /** Query arguments. */\n+    @GridToStringInclude\n+    private final Object[] args;\n+\n+    /** Scan query filter. */\n+    @GridToStringInclude\n+    private final IgniteBiPredicate<K, V> scanQryFilter;\n+\n+    /** Security subject ID. */\n+    private final UUID subjId;\n+\n+    /**\n+     * @param node Node where event was fired.\n+     * @param msg Event message.\n+     * @param type Event type.\n+     * @param qryType Query type.\n+     * @param clause Clause.\n+     * @param args Query arguments.\n+     * @param subjId Security subject ID.\n+     */\n+    public QueryExecutionEvent(\n+        ClusterNode node,\n+        String msg,\n+        int type,\n+        String qryType,\n+        @Nullable String clause,\n+        @Nullable Object[] args,\n+        @Nullable IgniteBiPredicate<K, V> scanQryFilter,", "originalCommit": "eb40bb2d82b52b9963ee23143aff0ff97c2d49e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NDkyMQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494374921", "bodyText": "I made it the same as in the CacheQueryExecutedEvent.", "author": "SomeFire", "createdAt": "2020-09-24T14:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0MTI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NjUxNw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494376517", "bodyText": "Javadoc added.", "author": "SomeFire", "createdAt": "2020-09-24T14:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0MTI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NDY4Nw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494364687", "bodyText": "Remove commented code.", "author": "timoninmaxim", "createdAt": "2020-09-24T14:27:19Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheAbstractQuerySelfTest.java", "diffHunk": "@@ -1545,6 +1555,98 @@ private void checkSqlQueryEvents() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testQueryExecutionEvents() throws Exception {\n+        CountDownLatch execLatch = new CountDownLatch(13);\n+\n+        IgnitePredicate<Event> lsnr = evt -> {\n+            assert evt instanceof QueryExecutionEvent;\n+\n+            System.out.println(\">>> EVENT: \" + evt);\n+\n+            QueryExecutionEvent qe = (QueryExecutionEvent)evt;\n+\n+            if (SQL_FIELDS.name().equals(qe.queryType()) ||\n+                TEXT.name().equals(qe.queryType())\n+            )\n+                assertNotNull(qe.queryType() + \" query clause is empty!\", qe.clause());\n+            else\n+                assertNull(qe.queryType() + \" query clause is not empty!\", qe.clause());\n+\n+            execLatch.countDown();\n+\n+            return true;\n+        };\n+\n+        ignite().events().localListen(lsnr, EVT_QUERY_EXECUTION);\n+\n+        String cacheName = \"CACHE_NAME\";\n+\n+        CacheConfiguration<String, String> ccfg = new CacheConfiguration<>();\n+\n+        ccfg.setName(cacheName);\n+        ccfg.setIndexedTypes(String.class, String.class);\n+\n+        ClientConfiguration cc = new ClientConfiguration().setAddresses(Config.SERVER);\n+\n+        try (IgniteClient client = Ignition.startClient(cc)) {\n+            ignite().createCache(ccfg).query(new TextQuery<>(String.class, \"text\"))\n+                .getAll();\n+\n+            ignite().getOrCreateCache(ccfg).query(new SpiQuery<Integer, Integer>())\n+                .getAll();\n+\n+            ignite().getOrCreateCache(ccfg).query(new ScanQuery<>())\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"create table TEST_TABLE(key int primary key, val int)\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"insert into TEST_TABLE values (?, ?)\").setArgs(1, 1))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"update TEST_TABLE set val = ?2 where key = ?1\").setArgs(1, 2))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"select * from TEST_TABLE\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"create index idx_1 on TEST_TABLE(key)\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"drop index idx_1\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"alter table TEST_TABLE add column val2 int\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"alter table TEST_TABLE drop val2\"))\n+                .getAll();\n+\n+            client.query(new SqlFieldsQuery(\"drop table TEST_TABLE\"))\n+                .getAll();\n+\n+            // Currently, not supported.\n+//            client.getOrCreateCache(cacheName).query(new TextQuery<>(String.class, \"text\"))", "originalCommit": "eb40bb2d82b52b9963ee23143aff0ff97c2d49e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NjEzNA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r494376134", "bodyText": "Done.", "author": "SomeFire", "createdAt": "2020-09-24T14:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NDY4Nw=="}], "type": "inlineReview"}, {"oid": "23875767b60c59fd04c8eba6443de5b498c039d2", "url": "https://github.com/apache/ignite/commit/23875767b60c59fd04c8eba6443de5b498c039d2", "message": "IGNITE-13450 review - missed javadoc", "committedDate": "2020-09-24T14:40:16Z", "type": "commit"}, {"oid": "4a8afbd26d74c633186d349c775a29e71b1b9201", "url": "https://github.com/apache/ignite/commit/4a8afbd26d74c633186d349c775a29e71b1b9201", "message": "IGNITE-13450 review - remove comment with not supported calls", "committedDate": "2020-09-24T14:41:38Z", "type": "commit"}, {"oid": "fa57b56cc2397d1a31f622d4328793bba13959a8", "url": "https://github.com/apache/ignite/commit/fa57b56cc2397d1a31f622d4328793bba13959a8", "message": "Merge branch 'master' into IGNITE-13450\n\n# Conflicts:\n#\tmodules/core/src/main/java/org/apache/ignite/events/EventType.java", "committedDate": "2020-10-21T15:58:11Z", "type": "commit"}, {"oid": "74690a88b5e0c9f06d70d67bd5567cfbc93058ca", "url": "https://github.com/apache/ignite/commit/74690a88b5e0c9f06d70d67bd5567cfbc93058ca", "message": "Merge branch 'master' into IGNITE-13450", "committedDate": "2020-11-16T18:32:40Z", "type": "commit"}, {"oid": "5b415b63b26189fcec032991e5c8d274782462b3", "url": "https://github.com/apache/ignite/commit/5b415b63b26189fcec032991e5c8d274782462b3", "message": "Revert \"IGNITE-13450 add SPI\"\n\nThis reverts commit 772c7956", "committedDate": "2020-11-17T14:52:36Z", "type": "commit"}, {"oid": "0175bb84f094bafedb7cd929d823687ec6e8a092", "url": "https://github.com/apache/ignite/commit/0175bb84f094bafedb7cd929d823687ec6e8a092", "message": "Revert \"IGNITE-13450 add TEXT\"\n\nThis reverts commit ca306b7b", "committedDate": "2020-11-17T15:09:41Z", "type": "commit"}, {"oid": "57f3f89488dfb8e9e10707bfdd09189a497314f1", "url": "https://github.com/apache/ignite/commit/57f3f89488dfb8e9e10707bfdd09189a497314f1", "message": "Revert \"IGNITE-13450 add SCAN\"\n\nThis reverts commit f7b2b9f9", "committedDate": "2020-11-17T16:09:55Z", "type": "commit"}, {"oid": "ced4401532c59f767700c8da1cbb10be3dc47a72", "url": "https://github.com/apache/ignite/commit/ced4401532c59f767700c8da1cbb10be3dc47a72", "message": "IGNITE-13450 fix intend", "committedDate": "2020-11-17T16:12:34Z", "type": "commit"}, {"oid": "52f8f55dcfbd0f1e79d3310845f371000660ce0a", "url": "https://github.com/apache/ignite/commit/52f8f55dcfbd0f1e79d3310845f371000660ce0a", "message": "IGNITE-13450 fix javadocs", "committedDate": "2020-11-19T14:35:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyODMwNA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527528304", "bodyText": "Event type and event class name look like they reflect all types of the queries (SCAN, SQL, SQL_FIELDS, CONTINUOUS, TEXT), but, in fact, only SQL queries handled.\nWe should, either rename event id and class name or throw events for all types of queries.", "author": "nizhikov", "createdAt": "2020-11-20T08:42:30Z", "path": "modules/core/src/main/java/org/apache/ignite/events/QueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_QUERY_EXECUTION\n+ */\n+public class QueryExecutionEvent<K, V> extends EventAdapter {", "originalCommit": "52f8f55dcfbd0f1e79d3310845f371000660ce0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMjIxNg==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527532216", "bodyText": "We have CacheQueryExecutedEvent, already.\nSo, let's rename as following:\nEVT_SQL_QUERY_EXECUTION\nSqlQueryExecutionEvent", "author": "nizhikov", "createdAt": "2020-11-20T08:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyODMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NTA3MQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r528245071", "bodyText": "Renamed.", "author": "SomeFire", "createdAt": "2020-11-21T21:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyODMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTAzNg==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527529036", "bodyText": "AFAIK this is not correct secSubjId.\nWhat if SQL query executed from thin client?", "author": "nizhikov", "createdAt": "2020-11-20T08:43:48Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -1114,6 +1117,17 @@ private void checkClusterState(QueryParserResult parseRes) {\n                     // Check if cluster state is valid.\n                     checkClusterState(parseRes);\n \n+                    if (ctx.event().isRecordable(EVT_QUERY_EXECUTION)) {\n+                        ctx.event().record(new QueryExecutionEvent<>(\n+                            ctx.discovery().localNode(),\n+                            CacheQueryType.SQL_FIELDS.name() + \" query execution.\",\n+                            EVT_QUERY_EXECUTION,\n+                            CacheQueryType.SQL_FIELDS.name(),\n+                            newQryDesc.sql(),\n+                            newQryParams.arguments(),\n+                            ctx.localNodeId()));", "originalCommit": "52f8f55dcfbd0f1e79d3310845f371000660ce0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NTExNQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r528245115", "bodyText": "Fixed.", "author": "SomeFire", "createdAt": "2020-11-21T21:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTM1Ng==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527529356", "bodyText": "Please, remove System.out.println from test code.", "author": "nizhikov", "createdAt": "2020-11-20T08:44:27Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/IgniteCacheAbstractQuerySelfTest.java", "diffHunk": "@@ -1545,6 +1544,66 @@ private void checkSqlQueryEvents() throws Exception {\n         }\n     }\n \n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testClientQueryExecutedEvents() throws Exception {\n+        CountDownLatch execLatch = new CountDownLatch(9);\n+\n+        IgnitePredicate<Event> lsnr = evt -> {\n+            assert evt instanceof QueryExecutionEvent;\n+\n+            System.out.println(\">>> EVENT: \" + evt);", "originalCommit": "52f8f55dcfbd0f1e79d3310845f371000660ce0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI0NTE1NA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r528245154", "bodyText": "Replaced by log.info().", "author": "SomeFire", "createdAt": "2020-11-21T21:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyOTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDc0OA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527530748", "bodyText": "Let's rename clause to the text.", "author": "nizhikov", "createdAt": "2020-11-20T08:46:55Z", "path": "modules/core/src/main/java/org/apache/ignite/events/QueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_QUERY_EXECUTION\n+ */\n+public class QueryExecutionEvent<K, V> extends EventAdapter {\n+    /** */\n+    private static final long serialVersionUID = 0L;\n+\n+    /** Query type. */\n+    private final String qryType;\n+\n+    /** Clause. */\n+    private final String clause;", "originalCommit": "52f8f55dcfbd0f1e79d3310845f371000660ce0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzODQ1Ng==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r527538456", "bodyText": "It is the same as in CacheQueryExecutedEvent. I think we should keep similarity.", "author": "SomeFire", "createdAt": "2020-11-20T09:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzMDc0OA=="}], "type": "inlineReview"}, {"oid": "1da73d1cdcc3e0a4d8c3807be29e3453b3b78f74", "url": "https://github.com/apache/ignite/commit/1da73d1cdcc3e0a4d8c3807be29e3453b3b78f74", "message": "IGNITE-13450 review", "committedDate": "2020-11-21T20:59:28Z", "type": "commit"}, {"oid": "1a82343d6dada240ccb7e4363f2a385414c08f3b", "url": "https://github.com/apache/ignite/commit/1a82343d6dada240ccb7e4363f2a385414c08f3b", "message": "IGNITE-13450 review - move event record closer to runningQryMgr.register", "committedDate": "2020-11-21T21:25:32Z", "type": "commit"}, {"oid": "c83f5535a195ed7e40185bdc3b66bbfd20bd7f09", "url": "https://github.com/apache/ignite/commit/c83f5535a195ed7e40185bdc3b66bbfd20bd7f09", "message": "IGNITE-13450 review - expand tests", "committedDate": "2020-11-21T21:26:07Z", "type": "commit"}, {"oid": "c6d763b9cc712f127f3a719f67708ebe48c7b14c", "url": "https://github.com/apache/ignite/commit/c6d763b9cc712f127f3a719f67708ebe48c7b14c", "message": "Update IgniteH2Indexing.java\n\nCorrect subjId initialization.", "committedDate": "2020-11-24T06:17:41Z", "type": "commit"}, {"oid": "1aeb2babbda48765254026421f40c55ba4878d71", "url": "https://github.com/apache/ignite/commit/1aeb2babbda48765254026421f40c55ba4878d71", "message": "Update SqlQueryExecutionEvent.java", "committedDate": "2020-11-24T06:22:12Z", "type": "commit"}, {"oid": "3ac7efe20b7f952165646bf9e2ff22e91fed0128", "url": "https://github.com/apache/ignite/commit/3ac7efe20b7f952165646bf9e2ff22e91fed0128", "message": "Update IgniteH2Indexing.java", "committedDate": "2020-11-24T06:22:56Z", "type": "commit"}, {"oid": "f7a64c3a7770a65471eb5a0197196fa81f6029a9", "url": "https://github.com/apache/ignite/commit/f7a64c3a7770a65471eb5a0197196fa81f6029a9", "message": "Update UserQueriesTestBase.java", "committedDate": "2020-11-24T06:25:31Z", "type": "commit"}, {"oid": "0793e92f5ef8d087a8eaad44fd95ca669f5d7694", "url": "https://github.com/apache/ignite/commit/0793e92f5ef8d087a8eaad44fd95ca669f5d7694", "message": "Update UserQueriesTestBase.java", "committedDate": "2020-11-24T06:26:42Z", "type": "commit"}, {"oid": "31b113130eac9944b59673349555ebbdeb35408b", "url": "https://github.com/apache/ignite/commit/31b113130eac9944b59673349555ebbdeb35408b", "message": "Update SqlQueryExecutionEvent.java", "committedDate": "2020-11-24T06:29:11Z", "type": "commit"}, {"oid": "e3fc08f50785c7f75ae0905e9a6c97217691e6eb", "url": "https://github.com/apache/ignite/commit/e3fc08f50785c7f75ae0905e9a6c97217691e6eb", "message": "Update SqlQueryExecutionEvent.java", "committedDate": "2020-11-24T06:30:59Z", "type": "commit"}, {"oid": "57662c98661d19d3440668632eafd4aba44519e3", "url": "https://github.com/apache/ignite/commit/57662c98661d19d3440668632eafd4aba44519e3", "message": "Update UserQueriesTestBase.java", "committedDate": "2020-11-24T06:35:47Z", "type": "commit"}, {"oid": "243adebb4449a96d5401ec586c26bc7f99e26525", "url": "https://github.com/apache/ignite/commit/243adebb4449a96d5401ec586c26bc7f99e26525", "message": "Update UserQueriesTestBase.java", "committedDate": "2020-11-24T06:36:33Z", "type": "commit"}, {"oid": "bf3ca679c35196603418922a3872f37372890a6d", "url": "https://github.com/apache/ignite/commit/bf3ca679c35196603418922a3872f37372890a6d", "message": "Update IgniteCacheAbstractQuerySelfTest.java", "committedDate": "2020-11-24T06:38:00Z", "type": "commit"}, {"oid": "34c4c3c55bc5bc94ce30ca2c5ec33a94e906c526", "url": "https://github.com/apache/ignite/commit/34c4c3c55bc5bc94ce30ca2c5ec33a94e906c526", "message": "Update IgniteH2Indexing.java", "committedDate": "2020-11-24T06:41:25Z", "type": "commit"}, {"oid": "e4026f817f3755a132c2558eb99a6c3204b606c8", "url": "https://github.com/apache/ignite/commit/e4026f817f3755a132c2558eb99a6c3204b606c8", "message": "Update UserQueriesTestBase.java", "committedDate": "2020-11-24T06:50:57Z", "type": "commit"}, {"oid": "9faaa5ff96f06a57281aebfec716fafe869dddc7", "url": "https://github.com/apache/ignite/commit/9faaa5ff96f06a57281aebfec716fafe869dddc7", "message": "Update SqlStatisticsUserQueriesFastTest.java", "committedDate": "2020-11-24T06:52:31Z", "type": "commit"}, {"oid": "24bbe80dd391cde21b8aad3d8f25b0febc3591f9", "url": "https://github.com/apache/ignite/commit/24bbe80dd391cde21b8aad3d8f25b0febc3591f9", "message": "Update SqlStatisticsUserQueriesLongTest.java", "committedDate": "2020-11-24T06:53:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDczNw==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530040737", "bodyText": "It seems to me, this Javadoc is just a copy&paste and it looks useless.", "author": "sk0x50", "createdAt": "2020-11-25T00:59:59Z", "path": "modules/core/src/main/java/org/apache/ignite/events/SqlQueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+import static org.apache.ignite.events.EventType.EVT_SQL_QUERY_EXECUTION;\n+\n+/**\n+ * Query execution event.", "originalCommit": "24bbe80dd391cde21b8aad3d8f25b0febc3591f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MTg4MA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530141880", "bodyText": "Thanks, @sk0x50!\nYour patch for this issue is welcome.", "author": "nizhikov", "createdAt": "2020-11-25T06:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDg2NQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530040865", "bodyText": "Could you please provide a comprehensive description of this event?\nThe current Javadoc gives no clue on this event. Moreover, SqlQueryExecutionEvent itself does not provide any specific information too.\nAt least, it would be useful to clearly state the phase of query execution that triggers this event and etc.", "author": "sk0x50", "createdAt": "2020-11-25T01:00:23Z", "path": "modules/core/src/main/java/org/apache/ignite/events/EventType.java", "diffHunk": "@@ -922,6 +922,16 @@\n      */\n     public static final int EVT_CLUSTER_SNAPSHOT_FAILED = 151;\n \n+    /**\n+     * Built-in event type: query execution.", "originalCommit": "24bbe80dd391cde21b8aad3d8f25b0febc3591f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MjgzMA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530142830", "bodyText": "Thanks, @sk0x50!\nYour patch for this issue is welcome.\n\nSqlQueryExecutionEvent\n\nWhat kind of specific information do you have in mind?\nFor now, we have text, type, user, args.\nIt's enough for any kind of event handling I can imagine.", "author": "nizhikov", "createdAt": "2020-11-25T06:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4MDQ3OA==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r532880478", "bodyText": "Hello @nizhikov ,\n\nWhat kind of specific information do you have in mind?\n\nAt least, it would be useful to clearly state the phase of query execution that triggers this event.\nCurrently, this important information cannot be obtained via Javadoc. So, this is the reason for kindly asking @SomeFire (as a contributor) and @nizhikov (as a reviewer) to provide something useful instead of Query execution event. :)", "author": "sk0x50", "createdAt": "2020-11-30T20:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5NDI1Ng==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r532894256", "bodyText": "Perhaps, something as follows:\nThis event is triggered after a corresponding SQL query validated and before it is executed.\nUnlike {@link #EVT_CACHE_QUERY_EXECUTED}, EVT_SQL_QUERY_EXECUTION is fired only once for a request and does not relate to a specific cache.\n\nWhat do you think? Is it good enough?", "author": "sk0x50", "createdAt": "2020-11-30T20:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwNDA1NQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r534404055", "bodyText": "Sounds good", "author": "nizhikov", "createdAt": "2020-12-02T18:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MTYxMQ==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530041611", "bodyText": "args may contain sensitive information and should be masked by *** when  IgniteSystemProperties#IGNITE_TO_STRING_INCLUDE_SENSITIVE is false.", "author": "sk0x50", "createdAt": "2020-11-25T01:02:52Z", "path": "modules/core/src/main/java/org/apache/ignite/events/SqlQueryExecutionEvent.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.events;\n+\n+import java.util.UUID;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.jetbrains.annotations.Nullable;\n+\n+import static org.apache.ignite.events.EventType.EVT_SQL_QUERY_EXECUTION;\n+\n+/**\n+ * Query execution event.\n+ * <p>\n+ * Grid events are used for notification about what happens within the grid. Note that by\n+ * design Ignite keeps all events generated on the local node locally and it provides\n+ * APIs for performing a distributed queries across multiple nodes:\n+ * <ul>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#remoteQuery(org.apache.ignite.lang.IgnitePredicate, long, int...)} -\n+ *          asynchronously querying events occurred on the nodes specified, including remote nodes.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localQuery(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          querying only local events stored on this local node.\n+ *      </li>\n+ *      <li>\n+ *          {@link org.apache.ignite.IgniteEvents#localListen(org.apache.ignite.lang.IgnitePredicate, int...)} -\n+ *          listening to local grid events (events from remote nodes not included).\n+ *      </li>\n+ * </ul>\n+ * User can also wait for events using method {@link org.apache.ignite.IgniteEvents#waitForLocal(org.apache.ignite.lang.IgnitePredicate, int...)}.\n+ * <h1 class=\"header\">Events and Performance</h1>\n+ * Note that by default all events in Ignite are enabled and therefore generated and stored\n+ * by whatever event storage SPI is configured. Ignite can and often does generate thousands events per seconds\n+ * under the load and therefore it creates a significant additional load on the system. If these events are\n+ * not needed by the application this load is unnecessary and leads to significant performance degradation.\n+ * <p>\n+ * It is <b>highly recommended</b> to enable only those events that your application logic requires\n+ * by using {@link org.apache.ignite.configuration.IgniteConfiguration#getIncludeEventTypes()} method in Ignite configuration. Note that certain\n+ * events are required for Ignite's internal operations and such events will still be generated but not stored by\n+ * event storage SPI if they are disabled in Ignite configuration.\n+ *\n+ * @see EventType#EVT_SQL_QUERY_EXECUTION\n+ */\n+public class SqlQueryExecutionEvent extends EventAdapter {\n+    /** */\n+    private static final long serialVersionUID = 0L;\n+\n+    /** Query text. */\n+    private final String text;\n+\n+    /** Query arguments. */\n+    @GridToStringInclude\n+    private final Object[] args;", "originalCommit": "24bbe80dd391cde21b8aad3d8f25b0febc3591f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0Mjk4Ng==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530142986", "bodyText": "Thanks. I will fix it in the nearest time.", "author": "nizhikov", "createdAt": "2020-11-25T06:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MTYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1Njg5Mg==", "url": "https://github.com/apache/ignite/pull/8252#discussion_r530156892", "bodyText": "Fixed with 2ed8e7c\nThanks for reporting.", "author": "nizhikov", "createdAt": "2020-11-25T07:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0MTYxMQ=="}], "type": "inlineReview"}]}