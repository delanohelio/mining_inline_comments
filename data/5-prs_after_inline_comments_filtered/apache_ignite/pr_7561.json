{"pr_number": 7561, "pr_title": "IGNITE-12788 Adds cluster fully rebalanced state metric.", "pr_createdAt": "2020-03-23T23:12:40Z", "pr_url": "https://github.com/apache/ignite/pull/7561", "timeline": [{"oid": "fc89f34475c3c31b6ce6f445372387a21497483d", "url": "https://github.com/apache/ignite/commit/fc89f34475c3c31b6ce6f445372387a21497483d", "message": "IGNITE-12788 Adds cluster fully rebalanced state metric.", "committedDate": "2020-03-24T06:51:34Z", "type": "commit"}, {"oid": "fc89f34475c3c31b6ce6f445372387a21497483d", "url": "https://github.com/apache/ignite/commit/fc89f34475c3c31b6ce6f445372387a21497483d", "message": "IGNITE-12788 Adds cluster fully rebalanced state metric.", "committedDate": "2020-03-24T06:51:34Z", "type": "forcePushed"}, {"oid": "a70bf947d411d31d4698fd58cd8b83dec12e6aca", "url": "https://github.com/apache/ignite/commit/a70bf947d411d31d4698fd58cd8b83dec12e6aca", "message": "IGNITE-12788 Adds client nodes testing.", "committedDate": "2020-03-24T10:23:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3NjQyMw==", "url": "https://github.com/apache/ignite/pull/7561#discussion_r397076423", "bodyText": "allMatch result ignored.", "author": "NSAmelchev", "createdAt": "2020-03-24T11:18:36Z", "path": "modules/core/src/test/java/org/apache/ignite/spi/discovery/ClusterRebalancedMetricTest.java", "diffHunk": "@@ -0,0 +1,208 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.spi.discovery;\n+\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.DataRegionConfiguration;\n+import org.apache.ignite.configuration.DataStorageConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.processors.cache.distributed.dht.preloader.GridDhtPartitionDemandMessage;\n+import org.apache.ignite.internal.processors.metric.GridMetricManager;\n+import org.apache.ignite.internal.util.typedef.G;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+import org.apache.ignite.spi.metric.BooleanMetric;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.cache.CacheAtomicityMode.TRANSACTIONAL;\n+import static org.apache.ignite.cache.CacheMode.PARTITIONED;\n+import static org.apache.ignite.cluster.ClusterState.ACTIVE;\n+import static org.apache.ignite.cluster.ClusterState.INACTIVE;\n+import static org.apache.ignite.internal.processors.metric.GridMetricManager.CLUSTER_REBALANCED;\n+import static org.apache.ignite.internal.processors.metric.GridMetricManager.REBALANCE_METRICS;\n+\n+/**\n+ * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric.\n+ */\n+public class ClusterRebalancedMetricTest extends GridCommonAbstractTest {\n+    /** Test cache name. */\n+    private static final String TEST_CACHE = \"TEST_CACHE\";\n+\n+    /**\n+     * @param idx Index of the node to be started.\n+     * @param persistenceEnabled Whether node native persistence is enabled.\n+     */\n+    protected IgniteConfiguration getConfiguration(int idx, boolean persistenceEnabled) throws Exception {\n+        DataRegionConfiguration drCfg = new DataRegionConfiguration()\n+            .setPersistenceEnabled(persistenceEnabled);\n+\n+        DataStorageConfiguration dsCfg = new DataStorageConfiguration()\n+            .setDefaultDataRegionConfiguration(drCfg);\n+\n+        return getConfiguration(getTestIgniteInstanceName(idx))\n+            .setDataStorageConfiguration(dsCfg);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @SuppressWarnings(\"rawtypes\")\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        TestRecordingCommunicationSpi commSpi = new TestRecordingCommunicationSpi();\n+\n+        CacheConfiguration cCfg = new CacheConfiguration(TEST_CACHE)\n+            .setBackups(2)\n+            .setCacheMode(PARTITIONED)\n+            .setAtomicityMode(TRANSACTIONAL);\n+\n+        return super.getConfiguration(igniteInstanceName)\n+            .setCacheConfiguration(cCfg)\n+            .setCommunicationSpi(commSpi)\n+            .setClusterStateOnStart(INACTIVE);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected void afterTest() throws Exception {\n+        super.afterTest();\n+\n+        stopAllGrids(true);\n+\n+        cleanPersistenceDir();\n+    }\n+\n+    /**\n+     * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric in case of in-memory cluster.\n+     */\n+    @Test\n+    public void testInMemoryClusterRebalancedMetric() throws Exception {\n+        checkClusterRebalancedMetric(false);\n+    }\n+\n+    /**\n+     * Tests {@link GridMetricManager#CLUSTER_REBALANCED} metric in case of cluster with native persistence enabled.\n+     */\n+    @Test\n+    public void testPersistenceClusterRebalancedMetric() throws Exception {\n+        checkClusterRebalancedMetric(true);\n+    }\n+\n+    /**\n+     * @param persistenceEnabled Whether native persistence is enabled.\n+     */\n+    public void checkClusterRebalancedMetric(boolean persistenceEnabled) throws Exception {\n+        IgniteEx ignite = startGrid(0, persistenceEnabled);\n+\n+        startClientGrid(1, persistenceEnabled);\n+\n+        assertClusterRebalancedMetricOnAllNodes(false);\n+\n+        ignite.cluster().state(ACTIVE);\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+\n+        ignite.cache(TEST_CACHE).put(\"key\", \"val\");\n+\n+        startClientGrid(2, persistenceEnabled);\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+\n+        TestRecordingCommunicationSpi spi = startGridWithRebalanceBlocked(3, persistenceEnabled);\n+\n+        if (persistenceEnabled) {\n+            awaitPartitionMapExchange(true, true, null, false);\n+\n+            assertClusterRebalancedMetricOnAllNodes(true);\n+\n+            ignite.cluster().setBaselineTopology(ignite.cluster().forServers().nodes());\n+        }\n+\n+        spi.waitForBlocked();\n+\n+        assertClusterRebalancedMetricOnAllNodes(false);\n+\n+        spi.stopBlock();\n+\n+        awaitPmeAndAssertRebalancedMetricOnAllNodes(true);\n+    }\n+\n+    /**\n+     * @param exp Expected value of {@link GridMetricManager#CLUSTER_REBALANCED} metric.\n+     */\n+    private void awaitPmeAndAssertRebalancedMetricOnAllNodes(boolean exp) throws Exception {\n+        awaitPartitionMapExchange(true, true, null, true);\n+\n+        assertClusterRebalancedMetricOnAllNodes(exp);\n+    }\n+\n+    /**\n+     * Checks that {@link GridMetricManager#CLUSTER_REBALANCED} metric is set to {@code exp} on all cluster nodes.\n+     */\n+    private void assertClusterRebalancedMetricOnAllNodes(boolean exp) {\n+        G.allGrids().stream().allMatch(ignite -> {", "originalCommit": "a70bf947d411d31d4698fd58cd8b83dec12e6aca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5Njc1NA==", "url": "https://github.com/apache/ignite/pull/7561#discussion_r397096754", "bodyText": "Thanks. Done.", "author": "ololo3000", "createdAt": "2020-03-24T11:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3NjQyMw=="}], "type": "inlineReview"}, {"oid": "d9326378012f879a8a86a3aab9ef3702c44bc749", "url": "https://github.com/apache/ignite/commit/d9326378012f879a8a86a3aab9ef3702c44bc749", "message": "IGNITE-12788 Refactors test configuration.", "committedDate": "2020-03-24T11:57:35Z", "type": "commit"}, {"oid": "d9326378012f879a8a86a3aab9ef3702c44bc749", "url": "https://github.com/apache/ignite/commit/d9326378012f879a8a86a3aab9ef3702c44bc749", "message": "IGNITE-12788 Refactors test configuration.", "committedDate": "2020-03-24T11:57:35Z", "type": "forcePushed"}, {"oid": "f7cba8dbe533e41871e43d46818f2add225e1d6a", "url": "https://github.com/apache/ignite/commit/f7cba8dbe533e41871e43d46818f2add225e1d6a", "message": "IGNITE-12788 Fixes minor issues.", "committedDate": "2020-03-24T12:08:13Z", "type": "commit"}, {"oid": "984ff9d5e0d3496b6819f8116a61a79c2ca29cf3", "url": "https://github.com/apache/ignite/commit/984ff9d5e0d3496b6819f8116a61a79c2ca29cf3", "message": "IGNITE-12788 Fixes minor issues.", "committedDate": "2020-03-24T12:19:45Z", "type": "commit"}, {"oid": "19775e7466ef8cdb9798aa47e63619741539feb5", "url": "https://github.com/apache/ignite/commit/19775e7466ef8cdb9798aa47e63619741539feb5", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state.", "committedDate": "2020-03-24T20:56:30Z", "type": "forcePushed"}, {"oid": "9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "url": "https://github.com/apache/ignite/commit/9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state.", "committedDate": "2020-03-24T21:28:34Z", "type": "commit"}, {"oid": "9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "url": "https://github.com/apache/ignite/commit/9ba4b12a152efa26e9e77cc322e38690ba9dd8a6", "message": "IGNITE-12788 Sets cluster rebalanced metric in false in case cluster is in INACTIVE state.", "committedDate": "2020-03-24T21:28:34Z", "type": "forcePushed"}, {"oid": "0a07e4216a2e7a489a19d9d05866f3149d8715fb", "url": "https://github.com/apache/ignite/commit/0a07e4216a2e7a489a19d9d05866f3149d8715fb", "message": "IGNITE-12788 Adds a test case for node leaving.", "committedDate": "2020-03-25T08:30:17Z", "type": "commit"}, {"oid": "0a07e4216a2e7a489a19d9d05866f3149d8715fb", "url": "https://github.com/apache/ignite/commit/0a07e4216a2e7a489a19d9d05866f3149d8715fb", "message": "IGNITE-12788 Adds a test case for node leaving.", "committedDate": "2020-03-25T08:30:17Z", "type": "forcePushed"}, {"oid": "eabf75d986b224caad0813bc2671b14f740ab1b5", "url": "https://github.com/apache/ignite/commit/eabf75d986b224caad0813bc2671b14f740ab1b5", "message": "IGNITE-12788 Removes unused imports.", "committedDate": "2020-03-25T10:39:23Z", "type": "commit"}, {"oid": "d0f7ceeb936abdc1bd043e3cd57737117ab1387e", "url": "https://github.com/apache/ignite/commit/d0f7ceeb936abdc1bd043e3cd57737117ab1387e", "message": "Merge branch 'master' of https://github.com/apache/ignite into IGNITE-12788", "committedDate": "2020-03-25T15:14:37Z", "type": "commit"}, {"oid": "fff92705664d90a0386c3d25bc9e96a131ccf760", "url": "https://github.com/apache/ignite/commit/fff92705664d90a0386c3d25bc9e96a131ccf760", "message": "IGNITE-12788 Renames rebalnce metric registry to cluster.", "committedDate": "2020-03-25T15:19:05Z", "type": "commit"}, {"oid": "20ab68a8bd4db6be2930030831b6212b11ea782e", "url": "https://github.com/apache/ignite/commit/20ab68a8bd4db6be2930030831b6212b11ea782e", "message": "IGNITE-12788 Fixes minor issues.", "committedDate": "2020-03-25T17:37:46Z", "type": "commit"}, {"oid": "197b5550a5c6070f1c141ae87efe5b46326a037f", "url": "https://github.com/apache/ignite/commit/197b5550a5c6070f1c141ae87efe5b46326a037f", "message": "IGNITE-12788 Transfers activation check from metric to exchange future side.", "committedDate": "2020-03-27T07:38:55Z", "type": "commit"}, {"oid": "197b5550a5c6070f1c141ae87efe5b46326a037f", "url": "https://github.com/apache/ignite/commit/197b5550a5c6070f1c141ae87efe5b46326a037f", "message": "IGNITE-12788 Transfers activation check from metric to exchange future side.", "committedDate": "2020-03-27T07:38:55Z", "type": "forcePushed"}, {"oid": "6d63efcf0661d91c047ea25ccefaaaacb65e8984", "url": "https://github.com/apache/ignite/commit/6d63efcf0661d91c047ea25ccefaaaacb65e8984", "message": "IGNITE-12788 Fixes minor issues.", "committedDate": "2020-03-27T12:07:56Z", "type": "commit"}]}