{"pr_number": 683, "pr_title": "Fixes #682 - Added support for GTS Encoders in PIVOT", "pr_createdAt": "2020-03-04T08:34:35Z", "pr_url": "https://github.com/senx/warp10-platform/pull/683", "timeline": [{"oid": "41fa0b668b54bfa8a639a45fd57a11239d89add8", "url": "https://github.com/senx/warp10-platform/commit/41fa0b668b54bfa8a639a45fd57a11239d89add8", "message": "Fixes #682 - Added support for GTS Encoders in PIVOT", "committedDate": "2020-03-04T08:30:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMDk4Mg==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r393810982", "bodyText": "Should binary values be also checked? If so, a more optimal way than using getBinaryValue should be used.", "author": "ftence", "createdAt": "2020-03-17T16:31:26Z", "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSDecoder.java", "diffHunk": "@@ -528,26 +528,52 @@ public Object getBinaryValue() {\n   /**\n    * Decode any remaining values into a GTS instance.\n    * \n+   * @param type TYPE to force for the resulting GTS\n+   * @param strict Set to true to force values to be of uniform types, will throw RuntimeException if not\n+   * \n    * @return A GTS instance containing the remaining values.\n    */\n-  public GeoTimeSerie decode(TYPE type) {\n+  public GeoTimeSerie decode(TYPE type, boolean strict) {\n     GeoTimeSerie gts = new GeoTimeSerie(this.count > 0 ? (int) Math.min(Integer.MAX_VALUE, this.count) : Math.max(16, this.buffer.remaining() / 10));\n     \n     if (null != type) {\n       gts.setType(type);\n     }\n     \n     gts.setMetadata(this.getMetadata());\n-    \n-    while(next()) {\n-      GTSHelper.setValue(gts, getTimestamp(), getLocation(), getElevation(), getValue(), false);\n+  \n+    if (strict) {\n+      Class lastClass = null;\n+      \n+      while(next()) {        \n+        Object value = getValue();", "originalCommit": "41fa0b668b54bfa8a639a45fd57a11239d89add8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1MzQwMA==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r394653400", "bodyText": "I am not sure we should differentiate binary values here, since in the GeoTimeSerie world they are mixed with STRING values anyway. Let's stick with that approach for now, I'll add a TODO to remind that we may differentiate the two later if need be, for now I don't think there might be many use cases that would require it. The most common type of mixed type encoders is having LONG and DOUBLE I think.", "author": "hbs", "createdAt": "2020-03-18T21:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMDk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjkwMQ==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r393812901", "bodyText": "Creating and using a subclass of RuntimeException could be nicer.", "author": "ftence", "createdAt": "2020-03-17T16:34:18Z", "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSDecoder.java", "diffHunk": "@@ -528,26 +528,52 @@ public Object getBinaryValue() {\n   /**\n    * Decode any remaining values into a GTS instance.\n    * \n+   * @param type TYPE to force for the resulting GTS\n+   * @param strict Set to true to force values to be of uniform types, will throw RuntimeException if not\n+   * \n    * @return A GTS instance containing the remaining values.\n    */\n-  public GeoTimeSerie decode(TYPE type) {\n+  public GeoTimeSerie decode(TYPE type, boolean strict) {\n     GeoTimeSerie gts = new GeoTimeSerie(this.count > 0 ? (int) Math.min(Integer.MAX_VALUE, this.count) : Math.max(16, this.buffer.remaining() / 10));\n     \n     if (null != type) {\n       gts.setType(type);\n     }\n     \n     gts.setMetadata(this.getMetadata());\n-    \n-    while(next()) {\n-      GTSHelper.setValue(gts, getTimestamp(), getLocation(), getElevation(), getValue(), false);\n+  \n+    if (strict) {\n+      Class lastClass = null;\n+      \n+      while(next()) {        \n+        Object value = getValue();\n+        Class valClass = value.getClass();\n+        // getValue could return a BigDecimal, we need to smooth the comparison so\n+        // they are considered as Double\n+        if (value instanceof BigDecimal) {\n+          valClass = Double.class;\n+        }\n+        if (null != lastClass && !(valClass.equals(lastClass))) {\n+          throw new RuntimeException(\"Non homogeneous GTS Encoder.\");", "originalCommit": "41fa0b668b54bfa8a639a45fd57a11239d89add8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NzIzMQ==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r394667231", "bodyText": "The only reason it's a RuntimeException is that it avoids declaring it is thrown, no plan to subclass it.", "author": "hbs", "createdAt": "2020-03-18T22:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMjkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxOTI2OA==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r393819268", "bodyText": "Catch the RuntimeException to display a nice error message.", "author": "ftence", "createdAt": "2020-03-17T16:43:36Z", "path": "warp10/src/main/java/io/warp10/script/functions/PIVOT.java", "diffHunk": "@@ -45,19 +46,28 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object top = stack.pop();\n     \n     if (!(top instanceof List) || (0 == ((List) top).size())) {\n-      throw new WarpScriptException(getName() + \" expects a non empty list of labeling Geo Time Series\u2122.\");\n+      throw new WarpScriptException(getName() + \" expects a non empty list of labeling Geo Time Series.\");\n     }\n     \n-    List<Object> labeling = (List<Object>) top;\n+    List<Object> paramLabeling = (List<Object>) top;\n+    List<Object> labeling = new ArrayList<Object>(paramLabeling.size());\n     \n     Set<String> classes = new HashSet<String>();\n-    for (Object o: labeling) {\n+    for (Object o: paramLabeling) {\n+      if (o instanceof GTSEncoder) {\n+        GTSEncoder encoder = (GTSEncoder) o;\n+        GTSDecoder decoder = encoder.getDecoder(true);\n+        o = decoder.decode(null, true);", "originalCommit": "41fa0b668b54bfa8a639a45fd57a11239d89add8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM1OTU4MQ==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r394359581", "bodyText": "I agree. It will could be usefull for other functions too.", "author": "pi-r-p", "createdAt": "2020-03-18T13:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxOTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyNjc3NQ==", "url": "https://github.com/senx/warp10-platform/pull/683#discussion_r393826775", "bodyText": "Ditto.", "author": "ftence", "createdAt": "2020-03-17T16:54:07Z", "path": "warp10/src/main/java/io/warp10/script/functions/PIVOT.java", "diffHunk": "@@ -70,15 +80,24 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     top = stack.pop();\n     \n     if (!(top instanceof List) || 0 == ((List) top).size()) {\n-      throw new WarpScriptException(getName() + \" operates on a non empty list of labeling Geo Time Series\u2122.\");\n+      throw new WarpScriptException(getName() + \" operates on a non empty list of Geo Time Series or GTS Encoders.\");\n     }\n \n-    List<Object> gts = (List<Object>) top;\n+    List<Object> paramGts = (List<Object>) top;\n+    List<Object> gts = new ArrayList<Object>(paramGts.size());\n     \n-    for (Object o: gts) {\n+    for (Object o: paramGts) {\n+      if (o instanceof GTSEncoder) {\n+        GTSEncoder encoder = (GTSEncoder) o;\n+        GTSDecoder decoder = encoder.getDecoder(true);\n+        o = decoder.decode(null, true);", "originalCommit": "41fa0b668b54bfa8a639a45fd57a11239d89add8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4fa8257e6eca22506ef14d1a5f04b5e919263ef4", "url": "https://github.com/senx/warp10-platform/commit/4fa8257e6eca22506ef14d1a5f04b5e919263ef4", "message": "Merge branch 'master' into issue-682", "committedDate": "2020-03-18T21:32:19Z", "type": "commit"}, {"oid": "7c74b9cbe094d8c40273c0f74909f36da2490428", "url": "https://github.com/senx/warp10-platform/commit/7c74b9cbe094d8c40273c0f74909f36da2490428", "message": "Addressed PR comments", "committedDate": "2020-03-18T22:06:50Z", "type": "commit"}, {"oid": "b2d08d67be06951ff813ba20f4f5adcd05b10170", "url": "https://github.com/senx/warp10-platform/commit/b2d08d67be06951ff813ba20f4f5adcd05b10170", "message": "Addressed PR comments", "committedDate": "2020-03-18T22:08:35Z", "type": "commit"}]}