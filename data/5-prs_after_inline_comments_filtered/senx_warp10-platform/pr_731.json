{"pr_number": 731, "pr_title": "#Fixes 716 - Fixes edge cases of boundary fetch", "pr_createdAt": "2020-04-14T09:54:18Z", "pr_url": "https://github.com/senx/warp10-platform/pull/731", "timeline": [{"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "url": "https://github.com/senx/warp10-platform/commit/62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long.", "committedDate": "2020-04-09T20:22:15Z", "type": "commit"}, {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "url": "https://github.com/senx/warp10-platform/commit/78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "message": "Merge branch 'master' of github.com:senx/warp10-platform into boundaries-fix", "committedDate": "2020-04-14T09:53:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExMjY1Nw==", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408112657", "bodyText": "There's also a nvalues > 0 line 348, should it be fixed too?", "author": "ftence", "createdAt": "2020-04-14T12:54:31Z", "path": "warp10/src/main/java/io/warp10/continuum/store/MultiScanGTSDecoderIterator.java", "diffHunk": "@@ -357,7 +357,7 @@ public GTSDecoder next() {\n       CellScanner cscanner = result.cellScanner();\n       \n       try {\n-        while(nvalues > 0 && cscanner.advance()) {\n+        while((nvalues > 0 || preBoundaryScan || postBoundaryScan) && cscanner.advance()) {", "originalCommit": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyNjkzOA==", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408126938", "bodyText": "Could be simplified by keeping GTSHelper.setValue(base, ts, location, elevation, value, false); here and adding\nif (countOnly && lastCount + dpcount >= count) {\n  break;\n}\n\nearlier in the loop or even in the while condition.", "author": "ftence", "createdAt": "2020-04-14T13:16:03Z", "path": "warp10/src/main/java/io/warp10/script/functions/FETCH.java", "diffHunk": "@@ -572,16 +556,35 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n                   base.setMetadata(decoderMeta);\n                   \n                   // Force type attribute\n-                  base.getMetadata().putToAttributes(typelabel, typename);\n+                  base.getMetadata().putToAttributes(typeattr, typename);\n                   if (null != uuid) {\n                     base.getMetadata().putToAttributes(Constants.UUID_ATTRIBUTE, uuid.toString());\n                   }\n                 }\n-                \n-                GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+\n+                //\n+                // When using HBase, fetch requests which do not have boundaries may be served\n+                // using a custom filter. This filter may return more data for a GTS than the requested\n+                // count if the GTS spans multiple regions because the filtering is performed on the Region Servers\n+                // and in this specific case the request will be forwarded to all RS serving regions for a given GTS.\n+                // It is therefore necessary to keep track of how many datapoints were already fetched and\n+                // shrink the GTS so we do not return too many.\n+                //\n+\n+                if (countOnly) {\n+                  if (lastCount + dpcount < count) {\n+                    GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+                  } else {\n+                    // We are done, exit\n+                    break;\n+                  }\n+                } else {\n+                  // Consider all points returned by the underlying system\n+                  GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+                }", "originalCommit": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNzMwMg==", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408207302", "bodyText": "Keeping the conditional just above the call to setValue.", "author": "hbs", "createdAt": "2020-04-14T15:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyNjkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyOTAyMQ==", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408129021", "bodyText": "Use countOnly.", "author": "ftence", "createdAt": "2020-04-14T13:19:05Z", "path": "warp10/src/main/java/io/warp10/script/functions/FETCH.java", "diffHunk": "@@ -610,27 +613,20 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n               }\n               lastType = gts.getType();\n             }\n-        \n-            if (null == base && count >= 0 && postBoundary > 0) {\n-              // This is the first GTS, so we need to count the size of the post boundary\n-              // so we get a correct estimate of the number of datapoints we fetched\n-              for (int i = 0; i < GTSHelper.nvalues(gts); i++) {\n-                if (GTSHelper.tickAtIndex(gts, i) > end) {\n-                  boundary++;\n-                } else {\n-                  // We can exit as soon as we find a timestamp <= end\n-                  break;                  \n-                }\n-              }\n-            }\n+\n+            //\n+            // When using HBase, fetch requests which do not have boundaries may be served\n+            // using a custom filter. This filter may return more data for a GTS than the requested\n+            // count if the GTS spans multiple regions because the filtering is performed on the Region Servers\n+            // and in this specific case the request will be forwarded to all RS serving regions for a given GTS.\n+            // It is therefore necessary to keep track of how many datapoints were already fetched and\n+            // shrink the GTS so we do not return too many.\n+            //\n             \n-            if (count >= 0 && lastCount + GTSHelper.nvalues(gts) - boundary > count) {\n-              // We would add too many datapoints, we will shrink the GTS.\n-              // As it it sorted in reverse order of the ticks (since the datapoints are organized\n-              // this way in HBase), we just need to shrink the GTS.\n-              gts = GTSHelper.shrinkTo(gts, (int) Math.max(count - lastCount + boundary, 0));\n+            if (count >= 0 && 0 == postBoundary && 0 == preBoundary && lastCount + GTSHelper.nvalues(gts) > count) {", "originalCommit": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "065973c88bb24c7b424d46ca409b521978e9c37b", "url": "https://github.com/senx/warp10-platform/commit/065973c88bb24c7b424d46ca409b521978e9c37b", "message": "Addressed PR comments", "committedDate": "2020-04-14T15:03:17Z", "type": "commit"}]}