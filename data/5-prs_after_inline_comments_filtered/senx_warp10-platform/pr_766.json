{"pr_number": 766, "pr_title": "Macro value encoder", "pr_createdAt": "2020-05-19T07:55:43Z", "pr_url": "https://github.com/senx/warp10-platform/pull/766", "timeline": [{"oid": "406a00f92fe26d9fce05a818a8b5cf0ecef2f2fb", "url": "https://github.com/senx/warp10-platform/commit/406a00f92fe26d9fce05a818a8b5cf0ecef2f2fb", "message": "Made per function metrics optional", "committedDate": "2020-05-17T15:57:39Z", "type": "commit"}, {"oid": "9c62dc30ede1f037b55e03ecb21bea8c6fc96c46", "url": "https://github.com/senx/warp10-platform/commit/9c62dc30ede1f037b55e03ecb21bea8c6fc96c46", "message": "Modified order of checks", "committedDate": "2020-05-17T15:57:58Z", "type": "commit"}, {"oid": "43e63100594602795878f46bc82f2378716db858", "url": "https://github.com/senx/warp10-platform/commit/43e63100594602795878f46bc82f2378716db858", "message": "Initial commit", "committedDate": "2020-05-18T12:26:17Z", "type": "commit"}, {"oid": "27dd501898c83668b6c530b549dfdeb2f6ba13c9", "url": "https://github.com/senx/warp10-platform/commit/27dd501898c83668b6c530b549dfdeb2f6ba13c9", "message": "Merge branch 'master' into MacroValueEncoder", "committedDate": "2020-05-19T07:39:57Z", "type": "commit"}, {"oid": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "url": "https://github.com/senx/warp10-platform/commit/9436e36f93ee087895c7ebc8bdfae44c24240d82", "message": "Fixed length", "committedDate": "2020-05-19T07:43:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0OTIzMQ==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427149231", "bodyText": "typo: update", "author": "ftence", "createdAt": "2020-05-19T09:09:28Z", "path": "warp10/src/main/java/io/warp10/script/MemoryWarpScriptStack.java", "diffHunk": "@@ -61,6 +61,11 @@\n     DEFAULT_PROPERTIES = WarpConfig.getProperties();\n   }\n \n+  /**\n+   * Should we updatr per function metrics", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MTE2Mw==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427151163", "bodyText": "That naming convention should be only reserved to constants.", "author": "ftence", "createdAt": "2020-05-19T09:12:36Z", "path": "warp10/src/main/java/io/warp10/script/MemoryWarpScriptStack.java", "diffHunk": "@@ -61,6 +61,11 @@\n     DEFAULT_PROPERTIES = WarpConfig.getProperties();\n   }\n \n+  /**\n+   * Should we updatr per function metrics\n+   */\n+  private boolean FUNCTION_METRICS = true;", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2NTMxMg==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427165312", "bodyText": "You cannot use macro.length() because it is prepended with this.macroPrefix. You have to store value.indexOf(':', prefixLen) and reuse that.", "author": "ftence", "createdAt": "2020-05-19T09:35:05Z", "path": "warp10/src/main/java/io/warp10/continuum/ingress/MacroValueEncoder.java", "diffHunk": "@@ -0,0 +1,95 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.continuum.ingress;\n+\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.warp10.WarpConfig;\n+import io.warp10.continuum.Configuration;\n+import io.warp10.continuum.gts.ValueEncoder;\n+import io.warp10.script.MemoryWarpScriptStack;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStack.Macro;\n+import io.warp10.script.WarpScriptStackRegistry;\n+import io.warp10.warp.sdk.WarpScriptExtension;\n+\n+public class MacroValueEncoder extends ValueEncoder {\n+  \n+  private static final String DEFAULT_PREFIX = \":m:\";\n+  private static final String DEFAULT_MACRO_PREFIX =\"\";\n+  private static final String KEY_STACK = \":m:stack\";\n+  \n+  private final String prefix;\n+  private final String macroPrefix;\n+  private final int prefixLen;\n+  \n+  public static final class Extension extends WarpScriptExtension {\n+\n+    public Extension() {\n+      ValueEncoder.register(new MacroValueEncoder());\n+    }\n+    \n+    @Override\n+    public Map<String, Object> getFunctions() {\n+      return null;\n+    }\n+  }\n+  \n+  private static final Macro NOOP_MACRO = new Macro();\n+  \n+  public MacroValueEncoder() {\n+    this.prefix = WarpConfig.getProperty(Configuration.CONFIG_MACRO_VALUE_ENCODER_PREFIX, DEFAULT_PREFIX);\n+    this.prefixLen = this.prefix.length();\n+    String mprefix = WarpConfig.getProperty(Configuration.CONFIG_MACRO_VALUE_ENCODER_MACRO_PREFIX, DEFAULT_MACRO_PREFIX);\n+    if (!mprefix.isEmpty() && !mprefix.endsWith(\"/\")) {\n+      this.macroPrefix = mprefix + \"/\";\n+    } else {\n+      this.macroPrefix = mprefix;\n+    }\n+  }\n+  \n+  @Override\n+  public Object parseValue(String value) throws Exception {\n+    if (!value.startsWith(prefix)) {\n+      return null;\n+    }\n+    \n+    // Extract the macro name, adding the specified prefix\n+    String macro = this.macroPrefix + value.substring(prefixLen, value.indexOf(':', prefixLen));\n+\n+    MemoryWarpScriptStack stack = (MemoryWarpScriptStack) WarpConfig.getThreadProperty(KEY_STACK);\n+    \n+    if (null == stack) {\n+      stack = new MemoryWarpScriptStack(null, null);\n+      stack.setAttribute(WarpScriptStack.ATTRIBUTE_NAME, \"[MacroValueEncoder @\" + macro + \" \" + Thread.currentThread().getName() + \"]\");      \n+      // Disable function metrics so execution is faster\n+      stack.setFunctionMetrics(false);\n+      WarpConfig.setThreadProperty(KEY_STACK, stack);\n+    }\n+    \n+    try {\n+      stack.push(value.substring(prefixLen + macro.length() + 1));", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE3MjcyMg==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427172722", "bodyText": "Unused.", "author": "ftence", "createdAt": "2020-05-19T09:47:08Z", "path": "warp10/src/main/java/io/warp10/continuum/ingress/MacroValueEncoder.java", "diffHunk": "@@ -0,0 +1,95 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.continuum.ingress;\n+\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.warp10.WarpConfig;\n+import io.warp10.continuum.Configuration;\n+import io.warp10.continuum.gts.ValueEncoder;\n+import io.warp10.script.MemoryWarpScriptStack;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStack.Macro;\n+import io.warp10.script.WarpScriptStackRegistry;\n+import io.warp10.warp.sdk.WarpScriptExtension;\n+\n+public class MacroValueEncoder extends ValueEncoder {\n+  \n+  private static final String DEFAULT_PREFIX = \":m:\";\n+  private static final String DEFAULT_MACRO_PREFIX =\"\";\n+  private static final String KEY_STACK = \":m:stack\";\n+  \n+  private final String prefix;\n+  private final String macroPrefix;\n+  private final int prefixLen;\n+  \n+  public static final class Extension extends WarpScriptExtension {\n+\n+    public Extension() {\n+      ValueEncoder.register(new MacroValueEncoder());\n+    }\n+    \n+    @Override\n+    public Map<String, Object> getFunctions() {\n+      return null;\n+    }\n+  }\n+  \n+  private static final Macro NOOP_MACRO = new Macro();", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE3Mjk3Mg==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427172972", "bodyText": "Unused.", "author": "ftence", "createdAt": "2020-05-19T09:47:33Z", "path": "warp10/src/main/java/io/warp10/continuum/ingress/MacroValueEncoder.java", "diffHunk": "@@ -0,0 +1,95 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.continuum.ingress;\n+\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.warp10.WarpConfig;\n+import io.warp10.continuum.Configuration;\n+import io.warp10.continuum.gts.ValueEncoder;\n+import io.warp10.script.MemoryWarpScriptStack;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStack.Macro;\n+import io.warp10.script.WarpScriptStackRegistry;", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE3MzA0OQ==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427173049", "bodyText": "Unused.", "author": "ftence", "createdAt": "2020-05-19T09:47:41Z", "path": "warp10/src/main/java/io/warp10/continuum/ingress/MacroValueEncoder.java", "diffHunk": "@@ -0,0 +1,95 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.continuum.ingress;\n+\n+import java.util.Map;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;", "originalCommit": "9436e36f93ee087895c7ebc8bdfae44c24240d82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2fe759a34bad30e1b4a2d3450e7fd3e649273a1", "url": "https://github.com/senx/warp10-platform/commit/d2fe759a34bad30e1b4a2d3450e7fd3e649273a1", "message": "Addressed PR comments", "committedDate": "2020-05-19T11:50:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI3NDgzMQ==", "url": "https://github.com/senx/warp10-platform/pull/766#discussion_r427274831", "bodyText": "Typo: name", "author": "ftence", "createdAt": "2020-05-19T12:48:44Z", "path": "warp10/src/main/java/io/warp10/continuum/ingress/MacroValueEncoder.java", "diffHunk": "@@ -0,0 +1,102 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.continuum.ingress;\n+\n+import java.util.Map;\n+\n+import io.warp10.WarpConfig;\n+import io.warp10.continuum.gts.ValueEncoder;\n+import io.warp10.script.MemoryWarpScriptStack;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStack.Macro;\n+import io.warp10.warp.sdk.WarpScriptExtension;\n+\n+public class MacroValueEncoder extends ValueEncoder {\n+  \n+  /**\n+   * Prefix to use for values which trigger a macro, defaults to ':m:', should not be changed\n+   * except for security by obscurity strategies...\n+   */\n+  public static final String CONFIG_MACRO_VALUE_ENCODER_PREFIX = \"macro.value.encoder.prefix\";\n+  \n+  /**\n+   * Prefix to add to macro names specified in values handled by MacroValueEncoder.\n+   * A value of ':m:foo/bar:xxx' with a macro prefix of 'pre' will trigger macro @pre/foo/bar.\n+   */\n+  public static final String CONFIG_MACRO_VALUE_ENCODER_MACRO_PREFIX = \"macro.value.encoder.macro.prefix\";\n+  \n+  private static final String DEFAULT_PREFIX = \":m:\";\n+  private static final String DEFAULT_MACRO_PREFIX =\"\";\n+  private static final String KEY_STACK = \":m:stack\";\n+  \n+  private final String prefix;\n+  private final String macroPrefix;\n+  private final int prefixLen;\n+  \n+  public static final class Extension extends WarpScriptExtension {\n+\n+    public Extension() {\n+      ValueEncoder.register(new MacroValueEncoder());\n+    }\n+    \n+    @Override\n+    public Map<String, Object> getFunctions() {\n+      return null;\n+    }\n+  }\n+  \n+  public MacroValueEncoder() {\n+    this.prefix = WarpConfig.getProperty(CONFIG_MACRO_VALUE_ENCODER_PREFIX, DEFAULT_PREFIX);\n+    this.prefixLen = this.prefix.length();\n+    String mprefix = WarpConfig.getProperty(CONFIG_MACRO_VALUE_ENCODER_MACRO_PREFIX, DEFAULT_MACRO_PREFIX);\n+    if (!mprefix.isEmpty() && !mprefix.endsWith(\"/\")) {\n+      this.macroPrefix = mprefix + \"/\";\n+    } else {\n+      this.macroPrefix = mprefix;\n+    }\n+  }\n+  \n+  @Override\n+  public Object parseValue(String value) throws Exception {\n+    if (!value.startsWith(prefix)) {\n+      return null;\n+    }\n+    \n+    // Extract the macro namex", "originalCommit": "d2fe759a34bad30e1b4a2d3450e7fd3e649273a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b3ac30fa09e157f23616b17b8b0b2fc8164c8ba9", "url": "https://github.com/senx/warp10-platform/commit/b3ac30fa09e157f23616b17b8b0b2fc8164c8ba9", "message": "Addressed PR comments", "committedDate": "2020-05-19T14:10:53Z", "type": "commit"}]}