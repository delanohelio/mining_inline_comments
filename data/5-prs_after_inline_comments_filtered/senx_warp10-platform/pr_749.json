{"pr_number": 749, "pr_title": "Initial commit of ->VARINT and VARINT->", "pr_createdAt": "2020-04-30T09:12:41Z", "pr_url": "https://github.com/senx/warp10-platform/pull/749", "timeline": [{"oid": "d8242ae080d2749a361f1919397fe28db9f4fb63", "url": "https://github.com/senx/warp10-platform/commit/d8242ae080d2749a361f1919397fe28db9f4fb63", "message": "Initial commit of ->VARINT and VARINT->", "committedDate": "2020-04-30T09:12:13Z", "type": "commit"}, {"oid": "999b76a16fcdbdeed5866a3f2e4323aafe943199", "url": "https://github.com/senx/warp10-platform/commit/999b76a16fcdbdeed5866a3f2e4323aafe943199", "message": "Added signature to only extract a given number of varints", "committedDate": "2020-05-02T13:07:06Z", "type": "commit"}, {"oid": "8e88ea4a228536b5a10b9110d61757244b7d4663", "url": "https://github.com/senx/warp10-platform/commit/8e88ea4a228536b5a10b9110d61757244b7d4663", "message": "Added support for converting a single LONG", "committedDate": "2020-05-04T09:00:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNzAyMg==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419537022", "bodyText": "Which exception do you intend to catch?\nbaos.write can throw NPE or OutOfBound but it cannot happen because it is not given Null and baos is of sufficient length.\nAlso you will catch the WarpScriptException which is unnecessary.", "author": "ftence", "createdAt": "2020-05-04T15:49:07Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOVARINT.java", "diffHunk": "@@ -0,0 +1,68 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.util.List;\n+\n+import io.warp10.continuum.gts.Varint;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+/**\n+ * Converts a list of LONGs to a byte array containing varint encoding of the numbers\n+ */\n+public class TOVARINT extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+  \n+  public TOVARINT(String name) {\n+    super(name);\n+  }\n+  \n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    \n+    Object top = stack.pop();\n+    \n+    if (!(top instanceof List) && !(top instanceof Long)) {\n+      throw new WarpScriptException(getName() + \" operates on a LONG or LIST of LONGs.\");\n+    }\n+    \n+    if (top instanceof Long) {\n+      stack.push(Varint.encodeUnsignedLong(((Long) top).longValue()));\n+    } else {\n+      List<Object> longs = (List<Object>) top;\n+      \n+      ByteArrayOutputStream baos = new ByteArrayOutputStream(longs.size());\n+      \n+      try {\n+        for (int i = 0; i < longs.size(); i++) {\n+          if (!(longs.get(i) instanceof Long)) {\n+            throw new WarpScriptException(getName() + \" operates on a LIST of LONGs.\");\n+          }\n+          baos.write(Varint.encodeUnsignedLong(((Long) longs.get(i)).longValue()));\n+        }\n+        stack.push(baos.toByteArray());\n+      } catch (Exception e) {", "originalCommit": "8e88ea4a228536b5a10b9110d61757244b7d4663", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY5NTgwMQ==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419695801", "bodyText": "ByteArrayOutputStream.write throws IOException, so catching this.", "author": "hbs", "createdAt": "2020-05-04T20:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNzAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNzc4Mw==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419537783", "bodyText": "I think the only Exception you can catch here is IllegalArgument, you should change to that.", "author": "ftence", "createdAt": "2020-05-04T15:50:11Z", "path": "warp10/src/main/java/io/warp10/script/functions/VARINTTO.java", "diffHunk": "@@ -0,0 +1,82 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import io.warp10.continuum.gts.Varint;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+/**\n+ * Converts a byte array containing varints into a list of varints\n+ */\n+public class VARINTTO extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+  \n+  public VARINTTO(String name) {\n+    super(name);\n+  }\n+  \n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    \n+    Object top = stack.pop();\n+    \n+    long count = Long.MAX_VALUE;\n+    boolean countbased = false;\n+    if (top instanceof Long) {\n+      count = ((Long) top).longValue();\n+      countbased = true;\n+      top = stack.pop();\n+    }\n+    \n+    if (!(top instanceof byte[])) {\n+      throw new WarpScriptException(getName() + \" operates on a byte array.\");\n+    }\n+    \n+    byte[] data = (byte[]) top;\n+\n+    ByteBuffer bb = ByteBuffer.wrap(data);\n+    \n+    List<Object> values = new ArrayList<Object>();\n+\n+    try {\n+      while(bb.hasRemaining() && count > 0) {\n+        long value = Varint.decodeUnsignedLong(bb);\n+        values.add(value);\n+        count--;\n+      }\n+    } catch (Exception e) {", "originalCommit": "8e88ea4a228536b5a10b9110d61757244b7d4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzODI4NQ==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419538285", "bodyText": "Unnecessary cast to int.", "author": "ftence", "createdAt": "2020-05-04T15:50:57Z", "path": "warp10/src/main/java/io/warp10/script/functions/VARINTTO.java", "diffHunk": "@@ -0,0 +1,82 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import io.warp10.continuum.gts.Varint;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+/**\n+ * Converts a byte array containing varints into a list of varints\n+ */\n+public class VARINTTO extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+  \n+  public VARINTTO(String name) {\n+    super(name);\n+  }\n+  \n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    \n+    Object top = stack.pop();\n+    \n+    long count = Long.MAX_VALUE;\n+    boolean countbased = false;\n+    if (top instanceof Long) {\n+      count = ((Long) top).longValue();\n+      countbased = true;\n+      top = stack.pop();\n+    }\n+    \n+    if (!(top instanceof byte[])) {\n+      throw new WarpScriptException(getName() + \" operates on a byte array.\");\n+    }\n+    \n+    byte[] data = (byte[]) top;\n+\n+    ByteBuffer bb = ByteBuffer.wrap(data);\n+    \n+    List<Object> values = new ArrayList<Object>();\n+\n+    try {\n+      while(bb.hasRemaining() && count > 0) {\n+        long value = Varint.decodeUnsignedLong(bb);\n+        values.add(value);\n+        count--;\n+      }\n+    } catch (Exception e) {\n+      throw new WarpScriptException(getName() + \" error while decoding values.\", e);\n+    }\n+    \n+    stack.push(values);\n+    \n+    //\n+    // If we were count based, output the number of bytes we consumed\n+    //\n+    if (countbased) {\n+      stack.push((long) (data.length - (int) bb.remaining())); ", "originalCommit": "8e88ea4a228536b5a10b9110d61757244b7d4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzOTEyOQ==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419539129", "bodyText": "typo: a list of LONGs.", "author": "ftence", "createdAt": "2020-05-04T15:52:07Z", "path": "warp10/src/main/java/io/warp10/script/functions/VARINTTO.java", "diffHunk": "@@ -0,0 +1,82 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.functions;\n+\n+import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import io.warp10.continuum.gts.Varint;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+/**\n+ * Converts a byte array containing varints into a list of varints", "originalCommit": "8e88ea4a228536b5a10b9110d61757244b7d4663", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fa95701bf44f0025cbab1bfa7b09a2d3328be94b", "url": "https://github.com/senx/warp10-platform/commit/fa95701bf44f0025cbab1bfa7b09a2d3328be94b", "message": "Addressed PR comments", "committedDate": "2020-05-04T20:08:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzMzI1Ng==", "url": "https://github.com/senx/warp10-platform/pull/749#discussion_r419933256", "bodyText": "typo: decoding->encoding", "author": "ftence", "createdAt": "2020-05-05T08:08:25Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOVARINT.java", "diffHunk": "@@ -58,8 +59,8 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n           baos.write(Varint.encodeUnsignedLong(((Long) longs.get(i)).longValue()));\n         }\n         stack.push(baos.toByteArray());\n-      } catch (Exception e) {\n-        throw new WarpScriptException(getName() + \" error while decoding values.\", e);\n+      } catch (IOException ioe) {\n+        throw new WarpScriptException(getName() + \" error while decoding values.\", ioe);", "originalCommit": "fa95701bf44f0025cbab1bfa7b09a2d3328be94b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "695e292b354b156cafbcba9388d68c96d9476170", "url": "https://github.com/senx/warp10-platform/commit/695e292b354b156cafbcba9388d68c96d9476170", "message": "Fixed typo", "committedDate": "2020-05-05T08:13:19Z", "type": "commit"}]}