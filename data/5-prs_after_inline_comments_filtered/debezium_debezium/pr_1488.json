{"pr_number": 1488, "pr_title": "DBZ-651 Quarkus-based implementation of standalone Debezium server", "pr_createdAt": "2020-05-11T08:47:11Z", "pr_url": "https://github.com/debezium/debezium/pull/1488", "timeline": [{"oid": "7598963087e8032abea3cfde4fc6f5022ac1d7f5", "url": "https://github.com/debezium/debezium/commit/7598963087e8032abea3cfde4fc6f5022ac1d7f5", "message": "DBZ-651 Quarkus-based implementation of standalone Debezium server", "committedDate": "2020-05-11T13:04:59Z", "type": "commit"}, {"oid": "7598963087e8032abea3cfde4fc6f5022ac1d7f5", "url": "https://github.com/debezium/debezium/commit/7598963087e8032abea3cfde4fc6f5022ac1d7f5", "message": "DBZ-651 Quarkus-based implementation of standalone Debezium server", "committedDate": "2020-05-11T13:04:59Z", "type": "forcePushed"}, {"oid": "53ae8bf966283568f0deb1610844ea21af1de370", "url": "https://github.com/debezium/debezium/commit/53ae8bf966283568f0deb1610844ea21af1de370", "message": "DBZ-651 Added logging", "committedDate": "2020-05-11T13:56:44Z", "type": "commit"}, {"oid": "5598d909aa1d10578c66b8f286519986ba1fb128", "url": "https://github.com/debezium/debezium/commit/5598d909aa1d10578c66b8f286519986ba1fb128", "message": "DBZ-651 Support for JSON key and Avro value", "committedDate": "2020-05-11T13:59:34Z", "type": "commit"}, {"oid": "25df123d702a72a669bdfef5eb5a6e85fea002c3", "url": "https://github.com/debezium/debezium/commit/25df123d702a72a669bdfef5eb5a6e85fea002c3", "message": "DBZ-651 Misc improvements", "committedDate": "2020-05-12T06:24:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMDQ2Mg==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423500462", "bodyText": "As above: io.debezium.server.", "author": "gunnarmorling", "createdAt": "2020-05-12T06:51:46Z", "path": "debezium-standalone-quarkus/src/main/java/io/debezium/standalone/quarkus/Server.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.standalone.quarkus;", "originalCommit": "25df123d702a72a669bdfef5eb5a6e85fea002c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwMzcyNw==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423503727", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<Object, Object>> {\n          \n          \n            \n            public class KinesisChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<Object, Object>> {", "author": "gunnarmorling", "createdAt": "2020-05-12T06:58:39Z", "path": "debezium-standalone-quarkus/src/main/java/io/debezium/standalone/quarkus/kinesis/ChangeConsumer.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.standalone.quarkus.kinesis;\n+\n+import java.util.List;\n+\n+import javax.annotation.PostConstruct;\n+import javax.annotation.PreDestroy;\n+import javax.enterprise.context.Dependent;\n+import javax.enterprise.inject.Instance;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.ConfigProvider;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.debezium.DebeziumException;\n+import io.debezium.engine.ChangeEvent;\n+import io.debezium.engine.DebeziumEngine;\n+import io.debezium.engine.DebeziumEngine.RecordCommitter;\n+import io.debezium.standalone.quarkus.CustomConsumerBuilder;\n+\n+import software.amazon.awssdk.auth.credentials.ProfileCredentialsProvider;\n+import software.amazon.awssdk.core.SdkBytes;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.kinesis.KinesisClient;\n+import software.amazon.awssdk.services.kinesis.model.PutRecordRequest;\n+\n+/**\n+ * Implementation of the consumer that delivers the messages into Amazon Kinesis destination.\n+ *\n+ * @author Jiri Pechanec\n+ *\n+ */\n+@Named(\"kinesis\")\n+@Dependent\n+public class ChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<Object, Object>> {", "originalCommit": "25df123d702a72a669bdfef5eb5a6e85fea002c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNDA0MQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423504041", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>> {\n          \n          \n            \n            public class GooglePubSubChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>> {", "author": "gunnarmorling", "createdAt": "2020-05-12T06:59:17Z", "path": "debezium-standalone-quarkus/src/main/java/io/debezium/standalone/quarkus/pubsub/ChangeConsumer.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.standalone.quarkus.pubsub;\n+\n+import java.util.List;\n+\n+import javax.enterprise.context.Dependent;\n+import javax.inject.Named;\n+\n+import io.debezium.engine.ChangeEvent;\n+import io.debezium.engine.DebeziumEngine;\n+import io.debezium.engine.DebeziumEngine.RecordCommitter;\n+\n+/**\n+ * Implementation of the consumer that delivers the messages into Google Pub/Sub destination.\n+ *\n+ * @author Jiri Pechanec\n+ *\n+ */\n+@Named(\"pub-sub\")\n+@Dependent\n+public class ChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>> {", "originalCommit": "25df123d702a72a669bdfef5eb5a6e85fea002c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUwNDgxMQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423504811", "bodyText": "Could you add a test that runs against Kinesis? It can (and should) be disabled by default, but would be interesting to see the required config and be easily able to run it against one own's account.", "author": "gunnarmorling", "createdAt": "2020-05-12T07:00:48Z", "path": "debezium-standalone-quarkus/src/test/java/io/debezium/standalone/quarkus/ServerIT.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.standalone.quarkus;\n+\n+import java.time.Duration;\n+\n+import javax.enterprise.event.Observes;\n+import javax.inject.Inject;\n+\n+import org.awaitility.Awaitility;\n+import org.fest.assertions.Assertions;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Test;\n+\n+import io.debezium.standalone.quarkus.events.ConnectorCompletedEvent;\n+import io.debezium.standalone.quarkus.events.ConnectorStartedEvent;\n+import io.debezium.util.Testing;\n+import io.quarkus.test.junit.QuarkusTest;\n+\n+/**\n+ * Integration test that verifies basic reading from PostgreSQL database.\n+ *\n+ * @author Jiri Pechanec\n+ */\n+@QuarkusTest\n+public class ServerIT {", "originalCommit": "25df123d702a72a669bdfef5eb5a6e85fea002c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ded13a5605ce162659e7462456379c0f81217bc", "url": "https://github.com/debezium/debezium/commit/2ded13a5605ce162659e7462456379c0f81217bc", "message": "DBZ-651 Rename of module and classes; Kinesis test", "committedDate": "2020-05-12T08:36:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzNzI0MQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423637241", "bodyText": "What is this about? Can you add JavaDoc, please?", "author": "gunnarmorling", "createdAt": "2020-05-12T10:43:36Z", "path": "debezium-api/src/main/java/io/debezium/engine/ChangeEvent.java", "diffHunk": "@@ -19,4 +19,6 @@\n     public K key();\n \n     public V value();\n+\n+    public String destination();", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5NjA4NQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424196085", "bodyText": "It is the topic name as created by Debezium - we forgot about exposing it. We should not call it topic name but I describe it as a logical destination string.", "author": "jpechane", "createdAt": "2020-05-13T06:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzNzI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0MzUyOQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423643529", "bodyText": "How about DebeziumServer?", "author": "gunnarmorling", "createdAt": "2020-05-12T10:55:39Z", "path": "debezium-server/src/main/java/io/debezium/server/Server.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.spi.CreationalContext;\n+import javax.enterprise.event.Observes;\n+import javax.enterprise.inject.spi.Bean;\n+import javax.enterprise.inject.spi.BeanManager;\n+import javax.inject.Inject;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.ConfigProvider;\n+import org.eclipse.microprofile.health.Liveness;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.debezium.DebeziumException;\n+import io.debezium.engine.ChangeEvent;\n+import io.debezium.engine.DebeziumEngine;\n+import io.debezium.engine.DebeziumEngine.ChangeConsumer;\n+import io.debezium.engine.format.Avro;\n+import io.debezium.engine.format.Json;\n+import io.debezium.engine.format.SerializationFormat;\n+import io.quarkus.runtime.ShutdownEvent;\n+import io.quarkus.runtime.Startup;\n+\n+/**\n+ * <p>The entry point of the Quarkus-based standalone server. The server is configured via Quarkus/Microprofile Configuration sources\n+ * and provides few out-of-the-box target implementations.</p>\n+ * <p>The implementation uses CDI to find all classes that implements {@link DebeziumEngine.ChangeConsumer} interface.\n+ * The candidate classes should be annotated with {@code @Named} annotation and should be {@code Dependent}.</p>\n+ * <p>The configuration option {@code debezium.consumer} provides a name of the consumer that should be used and the value\n+ * must match to exactly one of the implementation classes.</p>\n+ *\n+ * @author Jiri Pechanec\n+ *\n+ */\n+@ApplicationScoped\n+@Startup\n+public class Server {", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5NTgzMQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424195831", "bodyText": "Done", "author": "jpechane", "createdAt": "2020-05-13T06:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0MzUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0OTIwNQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423649205", "bodyText": "How about putting all properties into two namespaces:\ndebezium.sink.type=kinesis\ndebezium.sink.user=...\ndebezium.source.connector.class=...", "author": "gunnarmorling", "createdAt": "2020-05-12T11:06:48Z", "path": "debezium-server/src/test/java/io/debezium/server/TestConfigSource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.kafka.connect.runtime.standalone.StandaloneConfig;\n+import org.eclipse.microprofile.config.spi.ConfigSource;\n+\n+import io.debezium.util.Testing;\n+\n+public class TestConfigSource implements ConfigSource {\n+\n+    public static final String KINESIS_REGION = \"eu-central-1\";\n+    public static final Path OFFSET_STORE_PATH = Testing.Files.createTestingPath(\"file-connector-offsets.txt\").toAbsolutePath();\n+    public static final Path TEST_FILE_PATH = Testing.Files.createTestingPath(\"file-connector-input.txt\").toAbsolutePath();\n+\n+    final Map<String, String> integrationTest = new HashMap<>();\n+    final Map<String, String> e2eTest = new HashMap<>();\n+    final Map<String, String> unitTest = new HashMap<>();\n+    final Map<String, String> config;\n+\n+    public TestConfigSource() {\n+        e2eTest.put(\"debezium.consumer\", \"kinesis\");", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5Mzk2MA==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423693960", "bodyText": "Or more precisely, how about those four: debezium.source. ..., debezium.format. ..., debezium.transforms. ..., and debezium.sink. ...?", "author": "gunnarmorling", "createdAt": "2020-05-12T12:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0OTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5NzMwNg==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424197306", "bodyText": "Done\ndebezium.format is common for both key and value converters and can be specialized with debezium.format.key and debezium.format.value", "author": "jpechane", "createdAt": "2020-05-13T06:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0OTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNDEzOQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424914139", "bodyText": "Sweet!", "author": "gunnarmorling", "createdAt": "2020-05-14T07:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY0OTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4Mzk1OQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423683959", "bodyText": "debezium.sink.kinesis.region?", "author": "gunnarmorling", "createdAt": "2020-05-12T12:13:22Z", "path": "debezium-server/src/test/java/io/debezium/server/TestConfigSource.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.kafka.connect.runtime.standalone.StandaloneConfig;\n+import org.eclipse.microprofile.config.spi.ConfigSource;\n+\n+import io.debezium.util.Testing;\n+\n+public class TestConfigSource implements ConfigSource {\n+\n+    public static final String KINESIS_REGION = \"eu-central-1\";\n+    public static final Path OFFSET_STORE_PATH = Testing.Files.createTestingPath(\"file-connector-offsets.txt\").toAbsolutePath();\n+    public static final Path TEST_FILE_PATH = Testing.Files.createTestingPath(\"file-connector-input.txt\").toAbsolutePath();\n+\n+    final Map<String, String> integrationTest = new HashMap<>();\n+    final Map<String, String> e2eTest = new HashMap<>();\n+    final Map<String, String> unitTest = new HashMap<>();\n+    final Map<String, String> config;\n+\n+    public TestConfigSource() {\n+        e2eTest.put(\"debezium.consumer\", \"kinesis\");\n+        e2eTest.put(\"kinesis.region\", KINESIS_REGION);", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjY5MA==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423692690", "bodyText": "Where is the serialization format configured here?", "author": "gunnarmorling", "createdAt": "2020-05-12T12:28:15Z", "path": "debezium-server/src/test/java/io/debezium/server/KinesisIT.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.enterprise.event.Observes;\n+import javax.inject.Inject;\n+\n+import org.awaitility.Awaitility;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Test;\n+\n+import io.debezium.server.events.ConnectorCompletedEvent;\n+import io.debezium.server.events.ConnectorStartedEvent;\n+import io.debezium.util.Testing;\n+import io.quarkus.test.junit.QuarkusTest;\n+\n+import software.amazon.awssdk.auth.credentials.ProfileCredentialsProvider;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.kinesis.KinesisClient;\n+import software.amazon.awssdk.services.kinesis.model.GetRecordsRequest;\n+import software.amazon.awssdk.services.kinesis.model.GetRecordsResponse;\n+import software.amazon.awssdk.services.kinesis.model.GetShardIteratorRequest;\n+import software.amazon.awssdk.services.kinesis.model.GetShardIteratorResponse;\n+import software.amazon.awssdk.services.kinesis.model.Record;\n+import software.amazon.awssdk.services.kinesis.model.ShardIteratorType;\n+\n+/**\n+ * Integration test that verifies basic reading from PostgreSQL database and writing to Kinesis stream.\n+ *\n+ * @author Jiri Pechanec\n+ */\n+@QuarkusTest\n+public class KinesisIT {", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE2NzUxOQ==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424167519", "bodyText": "It uses default JSON serializer if not configured", "author": "jpechane", "createdAt": "2020-05-13T04:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5MjY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NTYwNw==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423695607", "bodyText": "We really need to get other types enabled (like Integer for keys), but that can be done separately.", "author": "gunnarmorling", "createdAt": "2020-05-12T12:33:10Z", "path": "debezium-server/src/main/java/io/debezium/server/Server.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.util.Properties;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.spi.CreationalContext;\n+import javax.enterprise.event.Observes;\n+import javax.enterprise.inject.spi.Bean;\n+import javax.enterprise.inject.spi.BeanManager;\n+import javax.inject.Inject;\n+\n+import org.eclipse.microprofile.config.Config;\n+import org.eclipse.microprofile.config.ConfigProvider;\n+import org.eclipse.microprofile.health.Liveness;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import io.debezium.DebeziumException;\n+import io.debezium.engine.ChangeEvent;\n+import io.debezium.engine.DebeziumEngine;\n+import io.debezium.engine.DebeziumEngine.ChangeConsumer;\n+import io.debezium.engine.format.Avro;\n+import io.debezium.engine.format.Json;\n+import io.debezium.engine.format.SerializationFormat;\n+import io.quarkus.runtime.ShutdownEvent;\n+import io.quarkus.runtime.Startup;\n+\n+/**\n+ * <p>The entry point of the Quarkus-based standalone server. The server is configured via Quarkus/Microprofile Configuration sources\n+ * and provides few out-of-the-box target implementations.</p>\n+ * <p>The implementation uses CDI to find all classes that implements {@link DebeziumEngine.ChangeConsumer} interface.\n+ * The candidate classes should be annotated with {@code @Named} annotation and should be {@code Dependent}.</p>\n+ * <p>The configuration option {@code debezium.consumer} provides a name of the consumer that should be used and the value\n+ * must match to exactly one of the implementation classes.</p>\n+ *\n+ * @author Jiri Pechanec\n+ *\n+ */\n+@ApplicationScoped\n+@Startup\n+public class Server {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Server.class);\n+\n+    private static final String PROP_PREFIX = \"debezium.\";\n+    private static final String PROP_CONSUMER_NAME = PROP_PREFIX + \"consumer\";\n+    private static final String PROP_KEY_FORMAT = PROP_PREFIX + \"format.key\";\n+    private static final String PROP_VALUE_FORMAT = PROP_PREFIX + \"format.value\";\n+    private static final String PROP_TERMINATION_WAIT = PROP_PREFIX + \"termination.wait\";\n+\n+    private static final String FORMAT_JSON = Json.class.getSimpleName().toLowerCase();\n+    private static final String FORMAT_AVRO = Avro.class.getSimpleName().toLowerCase();\n+\n+    private ExecutorService executor = Executors.newSingleThreadExecutor();\n+\n+    @Inject\n+    BeanManager beanManager;\n+\n+    @Inject\n+    @Liveness\n+    ConnectorLifecycle health;\n+\n+    private Bean<DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>>> consumerBean;\n+    private CreationalContext<ChangeConsumer<ChangeEvent<?, ?>>> consumerBeanCreationalContext;\n+    private DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>> consumer;\n+    private DebeziumEngine<?> engine;\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @PostConstruct\n+    public void start() {\n+        final Config config = ConfigProvider.getConfig();\n+        final String name = config.getValue(PROP_CONSUMER_NAME, String.class);\n+\n+        final Set<Bean<?>> beans = beanManager.getBeans(name).stream()\n+                .filter(x -> DebeziumEngine.ChangeConsumer.class.isAssignableFrom(x.getBeanClass()))\n+                .collect(Collectors.toSet());\n+        LOGGER.debug(\"Found {} candidate consumer(s)\", beans.size());\n+\n+        if (beans.size() == 0) {\n+            throw new DebeziumException(\"No Debezium consumer named '\" + name + \"' is available\");\n+        }\n+        else if (beans.size() > 1) {\n+            throw new DebeziumException(\"Multiple Debezium consumers named '\" + name + \"' were found\");\n+        }\n+\n+        consumerBean = (Bean<DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>>>) beans.iterator().next();\n+        consumerBeanCreationalContext = beanManager.createCreationalContext(consumerBean);\n+        consumer = consumerBean.create(consumerBeanCreationalContext);\n+        LOGGER.info(\"Consumer '{}' instantiated\", consumer.getClass().getName());\n+\n+        final Class<? extends SerializationFormat<?>> keyFormat = getFormat(config, PROP_KEY_FORMAT);\n+        final Class<? extends SerializationFormat<?>> valueFormat = getFormat(config, PROP_VALUE_FORMAT);\n+        final Properties props = configToProperties(config);\n+        props.setProperty(\"name\", name);\n+\n+        DebeziumEngine.Builder<?> builder = null;\n+        // TODO - apply variance and covariance rules on Debezium API to\n+        // support direct assignment to DebeziumEngine.Builder<ChangeEvent<?, ?>>\n+        if (keyFormat == Json.class && valueFormat == Json.class) {", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5Njk0MA==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424196940", "bodyText": "Yes, but for that we need first to solve to generification of Debezium API using covariance and contravariance", "author": "jpechane", "createdAt": "2020-05-13T06:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5Njk1Nw==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r423696957", "bodyText": "Might make sense to move them into separate modules, but can be done as a follow-up.", "author": "gunnarmorling", "createdAt": "2020-05-12T12:35:21Z", "path": "debezium-server/src/main/java/io/debezium/server/pubsub/PubSubChangeConsumer.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server.pubsub;\n+\n+import java.util.List;\n+\n+import javax.enterprise.context.Dependent;\n+import javax.inject.Named;\n+\n+import io.debezium.engine.ChangeEvent;\n+import io.debezium.engine.DebeziumEngine;\n+import io.debezium.engine.DebeziumEngine.RecordCommitter;\n+\n+/**\n+ * Implementation of the consumer that delivers the messages into Google Pub/Sub destination.\n+ *\n+ * @author Jiri Pechanec\n+ *\n+ */\n+@Named(\"pub-sub\")\n+@Dependent\n+public class PubSubChangeConsumer implements DebeziumEngine.ChangeConsumer<ChangeEvent<?, ?>> {", "originalCommit": "2ded13a5605ce162659e7462456379c0f81217bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "694ff6db41bca6bf4b44d7d963f313ed2a471b24", "url": "https://github.com/debezium/debezium/commit/694ff6db41bca6bf4b44d7d963f313ed2a471b24", "message": "DBZ-651 Renamed server class; config namespace split", "committedDate": "2020-05-13T06:16:38Z", "type": "commit"}, {"oid": "2bcce6f8882d3397957f3272e0df70d5de71119b", "url": "https://github.com/debezium/debezium/commit/2bcce6f8882d3397957f3272e0df70d5de71119b", "message": "DBZ-651 Add server distribution", "committedDate": "2020-05-13T14:26:00Z", "type": "commit"}, {"oid": "2bcce6f8882d3397957f3272e0df70d5de71119b", "url": "https://github.com/debezium/debezium/commit/2bcce6f8882d3397957f3272e0df70d5de71119b", "message": "DBZ-651 Add server distribution", "committedDate": "2020-05-13T14:26:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxMzY5Mw==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424913693", "bodyText": "Ok, very nice now with the more consistent properties structure. I think we should add \"debezium.source.type\"=\"postgres\" as a simplified alias, too (can be done separately).", "author": "gunnarmorling", "createdAt": "2020-05-14T07:04:30Z", "path": "debezium-server/src/test/java/io/debezium/server/TestConfigSource.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.server;\n+\n+import java.nio.file.Path;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.kafka.connect.runtime.standalone.StandaloneConfig;\n+import org.eclipse.microprofile.config.spi.ConfigSource;\n+\n+import io.debezium.util.Testing;\n+\n+public class TestConfigSource implements ConfigSource {\n+\n+    public static final String KINESIS_REGION = \"eu-central-1\";\n+    public static final Path OFFSET_STORE_PATH = Testing.Files.createTestingPath(\"file-connector-offsets.txt\").toAbsolutePath();\n+    public static final Path TEST_FILE_PATH = Testing.Files.createTestingPath(\"file-connector-input.txt\").toAbsolutePath();\n+\n+    final Map<String, String> integrationTest = new HashMap<>();\n+    final Map<String, String> e2eTest = new HashMap<>();\n+    final Map<String, String> unitTest = new HashMap<>();\n+    final Map<String, String> config;\n+\n+    public TestConfigSource() {\n+        e2eTest.put(\"debezium.sink.type\", \"kinesis\");\n+        e2eTest.put(\"debezium.sink.kinesis.region\", KINESIS_REGION);\n+        e2eTest.put(\"debezium.source.connector.class\", \"io.debezium.connector.postgresql.PostgresConnector\");\n+        e2eTest.put(\"debezium.source.\" + StandaloneConfig.OFFSET_STORAGE_FILE_FILENAME_CONFIG, OFFSET_STORE_PATH.toAbsolutePath().toString());\n+        e2eTest.put(\"debezium.source.offset.flush.interval.ms\", \"0\");\n+        e2eTest.put(\"debezium.source.database.hostname\", TestDatabase.POSTGRES_HOST);\n+        e2eTest.put(\"debezium.source.database.port\", Integer.toString(TestDatabase.POSTGRES_PORT));\n+        e2eTest.put(\"debezium.source.database.user\", TestDatabase.POSTGRES_USER);\n+        e2eTest.put(\"debezium.source.database.password\", TestDatabase.POSTGRES_PASSWORD);\n+        e2eTest.put(\"debezium.source.database.dbname\", TestDatabase.POSTGRES_DBNAME);\n+        e2eTest.put(\"debezium.source.database.server.name\", \"testc\");\n+        e2eTest.put(\"debezium.source.schema.whitelist\", \"inventory\");\n+        e2eTest.put(\"debezium.source.table.whitelist\", \"inventory.customers\");", "originalCommit": "2bcce6f8882d3397957f3272e0df70d5de71119b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNTQzNg==", "url": "https://github.com/debezium/debezium/pull/1488#discussion_r424915436", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return - a name of the logical destination for which the event is intended\n          \n          \n            \n                 * @return A name of the logical destination for which the event is intended", "author": "gunnarmorling", "createdAt": "2020-05-14T07:08:09Z", "path": "debezium-api/src/main/java/io/debezium/engine/ChangeEvent.java", "diffHunk": "@@ -19,4 +19,9 @@\n     public K key();\n \n     public V value();\n+\n+    /**\n+     * @return - a name of the logical destination for which the event is intended", "originalCommit": "2bcce6f8882d3397957f3272e0df70d5de71119b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90af266a30b338cf7ff62055e2c928c40a36d167", "url": "https://github.com/debezium/debezium/commit/90af266a30b338cf7ff62055e2c928c40a36d167", "message": "DBZ-651 Change JavaDoc\n\nCo-authored-by: Gunnar Morling <gunnar.morling@googlemail.com>", "committedDate": "2020-05-14T07:24:48Z", "type": "commit"}]}