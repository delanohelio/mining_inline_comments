{"pr_number": 1900, "pr_title": "DBZ-2617 Failing heartbeats should put Postgres connector into FAILED state", "pr_createdAt": "2020-10-20T15:20:15Z", "pr_url": "https://github.com/debezium/debezium/pull/1900", "timeline": [{"oid": "fd8b70a747a1cba0dd261537d42d34ebe0a27c97", "url": "https://github.com/debezium/debezium/commit/fd8b70a747a1cba0dd261537d42d34ebe0a27c97", "message": "DBZ-2617 failing heartbeats should put Postgres connector into FAILED state to allow proper shutdown of Postgres when shutdown was triggered with shutdown mode \"fast\"", "committedDate": "2020-10-20T15:48:17Z", "type": "commit"}, {"oid": "fd8b70a747a1cba0dd261537d42d34ebe0a27c97", "url": "https://github.com/debezium/debezium/commit/fd8b70a747a1cba0dd261537d42d34ebe0a27c97", "message": "DBZ-2617 failing heartbeats should put Postgres connector into FAILED state to allow proper shutdown of Postgres when shutdown was triggered with shutdown mode \"fast\"", "committedDate": "2020-10-20T15:48:17Z", "type": "forcePushed"}, {"oid": "185f18766b035c734ca02bf8f323f383bdf1c232", "url": "https://github.com/debezium/debezium/commit/185f18766b035c734ca02bf8f323f383bdf1c232", "message": "DBZ-2617 refactor to proper HeartbeatErrorHandler injection", "committedDate": "2020-10-21T13:30:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4ODk1Ng==", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r509288956", "bodyText": "I decoupled Heartbeat from the dependency to Configuration. Instead heartbeatInterval is passed explicitly (and heartbeatQuery where applicable).", "author": "rk3rn3r", "createdAt": "2020-10-21T13:36:22Z", "path": "debezium-core/src/main/java/io/debezium/heartbeat/DatabaseHeartbeatImpl.java", "diffHunk": "@@ -34,21 +35,27 @@\n \n     private final String heartBeatActionQuery;\n     private final JdbcConnection jdbcConnection;\n+    private final HeartbeatErrorHandler errorHandler;\n \n-    DatabaseHeartbeatImpl(Configuration configuration, String topicName, String key, JdbcConnection jdbcConnection, String heartBeatActionQuery) {\n-        super(configuration, topicName, key);\n+    DatabaseHeartbeatImpl(Duration heartbeatInterval, String topicName, String key, JdbcConnection jdbcConnection, String heartBeatActionQuery,", "originalCommit": "185f18766b035c734ca02bf8f323f383bdf1c232", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDQ5NA==", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r509294494", "bodyText": "@jpechane I don't think that this is a reason for a graceful shutdown of the connector. I think the connector should go into FAILED state and the user needs to resolve the Postgres issue. Then the user can simply resume the connector via Kafka Connect REST API.\ncannot_connect_now can also maybe also happen during boot or reboot and might be retriable (depending on the timing). At least we can now specify the behavior per connector and maybe see how it behaves in the wild, wdyt?", "author": "rk3rn3r", "createdAt": "2020-10-21T13:43:22Z", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresConnectorTask.java", "diffHunk": "@@ -151,12 +153,28 @@ public ChangeEventSourceCoordinator start(Configuration config) {\n                     .loggingContextSupplier(() -> taskContext.configureLoggingContext(CONTEXT_NAME))\n                     .build();\n \n-            errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n+            ErrorHandler errorHandler = new PostgresErrorHandler(connectorConfig.getLogicalName(), queue);\n \n             final PostgresEventMetadataProvider metadataProvider = new PostgresEventMetadataProvider();\n \n-            Heartbeat heartbeat = Heartbeat.create(connectorConfig.getConfig(), topicSelector.getHeartbeatTopic(),\n-                    connectorConfig.getLogicalName(), heartbeatConnection);\n+            Configuration configuration = connectorConfig.getConfig();\n+            Heartbeat heartbeat = Heartbeat.create(\n+                    configuration.getDuration(Heartbeat.HEARTBEAT_INTERVAL, ChronoUnit.MILLIS),\n+                    configuration.getString(DatabaseHeartbeatImpl.HEARTBEAT_ACTION_QUERY),\n+                    topicSelector.getHeartbeatTopic(),\n+                    connectorConfig.getLogicalName(), heartbeatConnection, exception -> {\n+                        String sqlErrorId = exception.getSQLState();\n+                        switch (sqlErrorId) {\n+                            case \"57P01\":\n+                                // Postgres error admin_shutdown, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new DebeziumException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);\n+                            case \"57P03\":\n+                                // Postgres error cannot_connect_now, see https://www.postgresql.org/docs/12/errcodes-appendix.html\n+                                throw new RetriableException(\"Could not execute heartbeat action (Error: \" + sqlErrorId + \")\", exception);", "originalCommit": "185f18766b035c734ca02bf8f323f383bdf1c232", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0Njc0Ng==", "url": "https://github.com/debezium/debezium/pull/1900#discussion_r516446746", "bodyText": "@rk3rn3r You are right!", "author": "jpechane", "createdAt": "2020-11-03T06:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDQ5NA=="}], "type": "inlineReview"}]}