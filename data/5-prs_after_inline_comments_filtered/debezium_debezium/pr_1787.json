{"pr_number": 1787, "pr_title": "DBZ 2466 Add a locking mode which doesn't conflict with DML and existing reads on Percona Server", "pr_createdAt": "2020-09-04T20:55:30Z", "pr_url": "https://github.com/debezium/debezium/pull/1787", "timeline": [{"oid": "2bebab9bc066e11a724aefa6755dbf55462c7123", "url": "https://github.com/debezium/debezium/commit/2bebab9bc066e11a724aefa6755dbf55462c7123", "message": "DBZ-2466 Add Percona Server profile to assembly", "committedDate": "2020-09-04T20:53:48Z", "type": "commit"}, {"oid": "8eb1f4e28c6778d81a7c36864aa8d2055fc2498b", "url": "https://github.com/debezium/debezium/commit/8eb1f4e28c6778d81a7c36864aa8d2055fc2498b", "message": "DBZ-2466 Percona Backup Locks option for snapshots", "committedDate": "2020-09-04T20:53:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODM5MA==", "url": "https://github.com/debezium/debezium/pull/1787#discussion_r484708390", "bodyText": "How about providing the statement from a method on the SnapshotLockingMode enum?", "author": "gunnarmorling", "createdAt": "2020-09-08T07:29:41Z", "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/SnapshotReader.java", "diffHunk": "@@ -310,7 +310,12 @@ protected void execute() {\n                 if (!snapshotLockingMode.equals(MySqlConnectorConfig.SnapshotLockingMode.NONE) && useGlobalLock) {\n                     try {\n                         logger.info(\"Step 1: flush and obtain global read lock to prevent writes to database\");\n-                        sql.set(\"FLUSH TABLES WITH READ LOCK\");\n+                        if (snapshotLockingMode.equals(MySqlConnectorConfig.SnapshotLockingMode.MINIMAL_PERCONA)) {", "originalCommit": "8eb1f4e28c6778d81a7c36864aa8d2055fc2498b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODcyOA==", "url": "https://github.com/debezium/debezium/pull/1787#discussion_r484708728", "bodyText": "Could this be retrieved from a method on the enum, e.g. isMinimal(), or requiresMinimalLocking() or something similar?", "author": "gunnarmorling", "createdAt": "2020-09-08T07:30:18Z", "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/SnapshotReader.java", "diffHunk": "@@ -541,7 +546,8 @@ protected void execute() {\n                 // ------\n                 // STEP 7\n                 // ------\n-                if (snapshotLockingMode.equals(MySqlConnectorConfig.SnapshotLockingMode.MINIMAL) && isLocked) {\n+                if ((snapshotLockingMode.equals(MySqlConnectorConfig.SnapshotLockingMode.MINIMAL) ||", "originalCommit": "8eb1f4e28c6778d81a7c36864aa8d2055fc2498b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI4Njc5NA==", "url": "https://github.com/debezium/debezium/pull/1787#discussion_r488286794", "bodyText": "I went with usesMinimalLocking -- the read best to me, but happy with any name, the method is a good suggestion \ud83d\udc4d", "author": "insom", "createdAt": "2020-09-14T23:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwODcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwOTMxMw==", "url": "https://github.com/debezium/debezium/pull/1787#discussion_r484709313", "bodyText": "Wow, TIL about SLEEP :)", "author": "gunnarmorling", "createdAt": "2020-09-08T07:31:21Z", "path": "debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/SnapshotReaderIT.java", "diffHunk": "@@ -224,6 +226,54 @@ private void snapshotOfSingleDatabase(boolean useGlobalLock, boolean storeOnlyMo\n         }\n     }\n \n+    @Test\n+    public void snapshotWithBackupLocksShouldNotWaitForReads() throws Exception {\n+        final Builder builder = simpleConfig();\n+        builder\n+                .with(MySqlConnectorConfig.USER, \"cloud\")\n+                .with(MySqlConnectorConfig.PASSWORD, \"cloudpass\")\n+                .with(MySqlConnectorConfig.SNAPSHOT_LOCKING_MODE, MySqlConnectorConfig.SnapshotLockingMode.MINIMAL_PERCONA);\n+\n+        config = builder.build();\n+        context = new MySqlTaskContext(config, new Filters.Builder(config).build());\n+        context.start();\n+\n+        reader = new SnapshotReader(\"snapshot\", context, true);\n+        reader.generateInsertEvents();\n+\n+        if (!MySQLConnection.isPerconaServer()) {\n+            return; // Skip these tests for non-Percona flavours of MySQL\n+        }\n+\n+        MySQLConnection db = MySQLConnection.forTestDatabase(DATABASE.getDatabaseName());\n+        Thread t = new Thread() {\n+            public void run() {\n+                try {\n+                    JdbcConnection connection = db.connect();\n+                    connection.executeWithoutCommitting(\"SELECT *, SLEEP(20) FROM products_on_hand\");", "originalCommit": "8eb1f4e28c6778d81a7c36864aa8d2055fc2498b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c8cacb31f4dcd39ec954f6880144fb8bcc90813", "url": "https://github.com/debezium/debezium/commit/0c8cacb31f4dcd39ec954f6880144fb8bcc90813", "message": "DBZ-2466 Address Backup Lock review feedback", "committedDate": "2020-09-14T23:09:38Z", "type": "commit"}, {"oid": "0c8cacb31f4dcd39ec954f6880144fb8bcc90813", "url": "https://github.com/debezium/debezium/commit/0c8cacb31f4dcd39ec954f6880144fb8bcc90813", "message": "DBZ-2466 Address Backup Lock review feedback", "committedDate": "2020-09-14T23:09:38Z", "type": "forcePushed"}, {"oid": "975f8af8312d69b2443cf79631b966cdd61546dc", "url": "https://github.com/debezium/debezium/commit/975f8af8312d69b2443cf79631b966cdd61546dc", "message": "DBZ-2466 Start connector when using Oracle MySQL, so afterEach can stop it", "committedDate": "2020-09-15T01:06:48Z", "type": "commit"}]}