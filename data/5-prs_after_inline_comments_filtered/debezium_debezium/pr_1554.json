{"pr_number": 1554, "pr_title": "DBZ-2118 Close TX after type query", "pr_createdAt": "2020-06-03T13:06:26Z", "pr_url": "https://github.com/debezium/debezium/pull/1554", "timeline": [{"oid": "df57008446bcdd2049c8169c2ce42c422852d818", "url": "https://github.com/debezium/debezium/commit/df57008446bcdd2049c8169c2ce42c422852d818", "message": "DBZ-2118 Close TX after type query", "committedDate": "2020-06-04T06:52:29Z", "type": "commit"}, {"oid": "df57008446bcdd2049c8169c2ce42c422852d818", "url": "https://github.com/debezium/debezium/commit/df57008446bcdd2049c8169c2ce42c422852d818", "message": "DBZ-2118 Close TX after type query", "committedDate": "2020-06-04T06:52:29Z", "type": "forcePushed"}, {"oid": "db382e3b716fe93d085e9da62b59a27afb8a8829", "url": "https://github.com/debezium/debezium/commit/db382e3b716fe93d085e9da62b59a27afb8a8829", "message": "DBZ-2118 Type registry provided only for dedicated connections", "committedDate": "2020-06-04T11:16:08Z", "type": "commit"}, {"oid": "db382e3b716fe93d085e9da62b59a27afb8a8829", "url": "https://github.com/debezium/debezium/commit/db382e3b716fe93d085e9da62b59a27afb8a8829", "message": "DBZ-2118 Type registry provided only for dedicated connections", "committedDate": "2020-06-04T11:16:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIyOTM2OA==", "url": "https://github.com/debezium/debezium/pull/1554#discussion_r435229368", "bodyText": "This looks like it could be race condition. Relying on the 5 ms poll in consumeRecordsByTopic to ensure that the connector picked up the records seems flaky. A specific case where this would be problematic is if a developer wanted to use a debugger on the connecter during this test. What about polling on the JMX field totalNumberOfEventsSeen to wait till we are sure the connector pushed the record?", "author": "grantcooksey", "createdAt": "2020-06-04T12:53:46Z", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -826,6 +826,43 @@ public void shouldRemoveWhiteSpaceChars() throws Exception {\n         assertThat(sourceTable).isEqualTo(\"b\");\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2118\")\n+    public void shouldCloseTxAfterTypeQuery() throws Exception {\n+        String setupStmt = SETUP_TABLES_STMT;\n+\n+        TestHelper.execute(setupStmt);\n+        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n+                .with(PostgresConnectorConfig.SNAPSHOT_MODE, SnapshotMode.INITIAL.getValue())\n+                .with(PostgresConnectorConfig.DROP_SLOT_ON_STOP, Boolean.TRUE)\n+                .with(PostgresConnectorConfig.SCHEMA_WHITELIST, \"s1\")\n+                .with(PostgresConnectorConfig.TABLE_WHITELIST, \"s1.b\");\n+\n+        start(PostgresConnector.class, configBuilder.build());\n+        assertConnectorIsRunning();\n+        waitForSnapshotToBeCompleted();\n+\n+        TestHelper.execute(\"CREATE TABLE s1.b (pk SERIAL, aa isbn, PRIMARY KEY(pk));\", \"INSERT INTO s1.b (aa) VALUES ('978-0-393-04002-9')\");\n+        SourceRecords actualRecords = consumeRecordsByTopic(1);", "originalCommit": "db382e3b716fe93d085e9da62b59a27afb8a8829", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5OTkzMQ==", "url": "https://github.com/debezium/debezium/pull/1554#discussion_r435899931", "bodyText": "While I agree in theory, it's not a problem in practice. The poll timeout is 5 seconds and it's tried three times, i.e. 15 sec overall. That's more than enough even on our slow CI environment and this method doesn't show caus any troubles there (that said, we do have flaky tests due to similar causes, but that's not one of them). In terms of debugging, you'd typically have two breakpoints: one in the event loop and one in the main thread, right before this call. Then you can take all the time you need to step through the event loop.", "author": "gunnarmorling", "createdAt": "2020-06-05T12:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTIyOTM2OA=="}], "type": "inlineReview"}, {"oid": "0bf9d11a168df3613574ba656731115bc62b9b09", "url": "https://github.com/debezium/debezium/commit/0bf9d11a168df3613574ba656731115bc62b9b09", "message": "DBZ-2118 Switch to manual tx management", "committedDate": "2020-06-04T13:31:58Z", "type": "commit"}, {"oid": "f5cce8624248edb17adc32291b5980a18380e9b3", "url": "https://github.com/debezium/debezium/commit/f5cce8624248edb17adc32291b5980a18380e9b3", "message": "DBZ-2118 Slot dropping more resilient to race", "committedDate": "2020-06-04T13:54:35Z", "type": "commit"}, {"oid": "c4767abac1bc17144f2a49da04f70ad9b73e8495", "url": "https://github.com/debezium/debezium/commit/c4767abac1bc17144f2a49da04f70ad9b73e8495", "message": "DBZ-2118 Document type registry connection capability", "committedDate": "2020-06-05T04:17:14Z", "type": "commit"}]}