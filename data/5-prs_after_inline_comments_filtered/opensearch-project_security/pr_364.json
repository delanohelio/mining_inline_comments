{"pr_number": 364, "pr_title": "Migrate dynamic config from listener pattern to publish/subscribe event bus", "pr_createdAt": "2020-04-08T16:30:41Z", "pr_url": "https://github.com/opensearch-project/security/pull/364", "timeline": [{"oid": "03b75e69e0eef86b8c5c82f6e3ac2c7c81da935e", "url": "https://github.com/opensearch-project/security/commit/03b75e69e0eef86b8c5c82f6e3ac2c7c81da935e", "message": "Migrate dynamic config from listener pattern to publish/subscribe event bus", "committedDate": "2020-04-08T16:27:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxODA3OA==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405718078", "bodyText": "Since we're removing DCFListener maybe a more generic name like registerListener?", "author": "debjanibnrj", "createdAt": "2020-04-08T18:11:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -225,12 +223,12 @@ public final boolean isInitialized() {\n         return initialized.get();\n     }\n     \n-    public void registerDCFListener(DCFListener listener) {\n-        listeners.add(listener);\n+    public void registerDCFListener(Object listener) {", "originalCommit": "03b75e69e0eef86b8c5c82f6e3ac2c7c81da935e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNTg0Nw==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405725847", "bodyText": "I think it would be OK to keep the original name. It signifies the event bus the listener subscribes to. Note that in the past it was also not necessary to have DCF in the registerDCFListener() name, as it was clear that the registration is done for DCFListener.", "author": "vrozov", "createdAt": "2020-04-08T18:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxODA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0NzYxNg==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405747616", "bodyText": "Wondering if this should be injected from the constructor as some other classes can post on the same event bus.", "author": "sujithvm", "createdAt": "2020-04-08T19:01:52Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -81,7 +82,7 @@ private void loadStaticConfig() throws IOException {\n     protected final Logger log = LogManager.getLogger(this.getClass());\n     private final ConfigurationRepository cr;\n     private final AtomicBoolean initialized = new AtomicBoolean();\n-    private final List<DCFListener> listeners = new ArrayList<>();\n+    private final EventBus eventBus = new EventBus(\"DynamicConfig\");", "originalCommit": "03b75e69e0eef86b8c5c82f6e3ac2c7c81da935e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NjA4OA==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405756088", "bodyText": "Currently eventBus is not shared across DynamicConfigFactory class instances similar to how listeners was not shared. Till there is a use case where eventBus needs to be shared, I'd prefer to keep it encapsulated inside DynamicConfigFactory.", "author": "vrozov", "createdAt": "2020-04-08T19:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0NzYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODMwNQ==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405748305", "bodyText": "How does this know which event bus to subscribe to?\nWhat happens if I make another event bus and post DynamicConfigModel ? Does this automatically subscribe for both?", "author": "sujithvm", "createdAt": "2020-04-08T19:03:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auth/BackendRegistry.java", "diffHunk": "@@ -207,8 +206,8 @@ public void invalidateCache() {\n         transportImpersonationCache.invalidateAll();\n     }\n \n-    @Override\n-    public void onChanged(ConfigModel cm, DynamicConfigModel dcm, InternalUsersModel ium) {\n+    @Subscribe\n+    public void onDynamicConfigModelChanged(DynamicConfigModel dcm) {", "originalCommit": "03b75e69e0eef86b8c5c82f6e3ac2c7c81da935e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NzEzMQ==", "url": "https://github.com/opensearch-project/security/pull/364#discussion_r405757131", "bodyText": "It is necessary to register with the event bus. Please see DynamicConfigFactory.registerDCFListener().", "author": "vrozov", "createdAt": "2020-04-08T19:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0ODMwNQ=="}], "type": "inlineReview"}]}