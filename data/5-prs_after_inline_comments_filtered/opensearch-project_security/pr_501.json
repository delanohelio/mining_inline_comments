{"pr_number": 501, "pr_title": "Avoid using Basic Authorization header as JWT token", "pr_createdAt": "2020-06-11T19:22:42Z", "pr_url": "https://github.com/opensearch-project/security/pull/501", "timeline": [{"oid": "1b5e39130eba95f2f87d7f7cf2796ba166e59609", "url": "https://github.com/opensearch-project/security/commit/1b5e39130eba95f2f87d7f7cf2796ba166e59609", "message": "Avoid using Basic Authorization header as JWT token", "committedDate": "2020-06-11T19:16:14Z", "type": "commit"}, {"oid": "1342b68df46e612351f0bbd80eb8a1376277e893", "url": "https://github.com/opensearch-project/security/commit/1342b68df46e612351f0bbd80eb8a1376277e893", "message": "Fix NPE", "committedDate": "2020-06-11T20:31:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2MTQ5Mg==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r439061492", "bodyText": "Instead of skipping basic Auth headers, can we skip any non \"bearer\" headers ?", "author": "dinusX", "createdAt": "2020-06-11T20:45:55Z", "path": "src/main/java/com/amazon/dlic/auth/http/jwt/HTTPJwtAuthenticator.java", "diffHunk": "@@ -51,9 +53,12 @@\n \n     protected final Logger log = LogManager.getLogger(this.getClass());\n \n+    private static final Pattern BASIC = Pattern.compile(\"^\\\\s*Basic\\\\s.*\", Pattern.CASE_INSENSITIVE);", "originalCommit": "1b5e39130eba95f2f87d7f7cf2796ba166e59609", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNTY5Mg==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r439105692", "bodyText": "It sounds that \"Bearer\" scheme is optional. Please see HTTPJwtAuthenticatorTest.testNonBearer() that test that HTTPJwtAuthenticator can accept JWT in Authorization header without Bearer.", "author": "vrozov", "createdAt": "2020-06-11T22:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2MTQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMDU2OQ==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r441100569", "bodyText": "I see.\nWould be great if you can add a unit-test for this use-case.\nIn addition to this, there might be other \"Authorization\" headers that needs to be checked similarly as \"Basic\".\nI would prefer also to discuss this internally if we should push this change, because usually this issue is happening when users configure incorrectly the order of authentication configurations.", "author": "dinusX", "createdAt": "2020-06-16T19:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2MTQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE5MzY2Mg==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r441193662", "bodyText": "In addition to this, there might be other \"Authorization\" headers that needs to be checked similarly as \"Basic\".\n\nCan be addressed in a follow up PR if necessary.\n\nI would prefer also to discuss this internally if we should push this change, because usually this issue is happening when users configure incorrectly the order of authentication configurations.\n\nActually it is the correct order. Putting Basic authenticator in front will cause No 'Basic Authorization' header, send 401 and 'WWW-Authenticate Basic' warning message even when a valid JWT token is present and inability to login with JWT. Please see HTTPHelper", "author": "vrozov", "createdAt": "2020-06-16T23:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA2MTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5OTI1NQ==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r441099255", "bodyText": "According to the specifications the token will always start with \"Basic \". I don't think we should allow spaces before.\nhttps://tools.ietf.org/html/rfc2617#page-5", "author": "dinusX", "createdAt": "2020-06-16T19:43:44Z", "path": "src/main/java/com/amazon/dlic/auth/http/jwt/AbstractHTTPJwtAuthenticator.java", "diffHunk": "@@ -46,17 +48,20 @@\n     private final static Logger log = LogManager.getLogger(AbstractHTTPJwtAuthenticator.class);\n \n     private static final String BEARER = \"bearer \";\n+    private static final Pattern BASIC = Pattern.compile(\"^\\\\s*Basic\\\\s.*\", Pattern.CASE_INSENSITIVE);", "originalCommit": "1342b68df46e612351f0bbd80eb8a1376277e893", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxODg0Mg==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r441218842", "bodyText": "As we don't need to ensure that it is a valid \"Basic\" authentication scheme here, but only need to filter out invalid JWT tokens to avoid JWT validation warnings, it is OK to allow spaces before \"Basic\" to be consistent with trim() used in HttpHelper.java", "author": "vrozov", "createdAt": "2020-06-17T00:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5OTI1NQ=="}], "type": "inlineReview"}, {"oid": "0efaf3bf26c4798ef11a18c57f155b70cf60526e", "url": "https://github.com/opensearch-project/security/commit/0efaf3bf26c4798ef11a18c57f155b70cf60526e", "message": "Add unit test", "committedDate": "2020-06-19T18:10:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwOTg2MA==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r445909860", "bodyText": "Factor out BASIC pattern as it is re-used ?", "author": "sujithvm", "createdAt": "2020-06-26T00:36:09Z", "path": "src/main/java/com/amazon/dlic/auth/http/jwt/AbstractHTTPJwtAuthenticator.java", "diffHunk": "@@ -46,17 +48,20 @@\n     private final static Logger log = LogManager.getLogger(AbstractHTTPJwtAuthenticator.class);\n \n     private static final String BEARER = \"bearer \";\n+    private static final Pattern BASIC = Pattern.compile(\"^\\\\s*Basic\\\\s.*\", Pattern.CASE_INSENSITIVE);", "originalCommit": "0efaf3bf26c4798ef11a18c57f155b70cf60526e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxMDAzNA==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r445910034", "bodyText": "Out of scope for PR but any reason why HTTPJwtAuthenticator\ndoes not inherit from AbstractHTTPJwtAuthenticator ?", "author": "sujithvm", "createdAt": "2020-06-26T00:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwOTg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxMzYzNQ==", "url": "https://github.com/opensearch-project/security/pull/501#discussion_r445913635", "bodyText": "I don't see any good reason, will be good to cleanup this in a follow up PR.", "author": "vrozov", "createdAt": "2020-06-26T00:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwOTg2MA=="}], "type": "inlineReview"}]}