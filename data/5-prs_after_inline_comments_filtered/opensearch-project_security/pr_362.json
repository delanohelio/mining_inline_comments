{"pr_number": 362, "pr_title": "Implement APIs and datamodel to configure nodes_dn dynamically.", "pr_createdAt": "2020-04-07T19:09:35Z", "pr_url": "https://github.com/opensearch-project/security/pull/362", "timeline": [{"oid": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "url": "https://github.com/opensearch-project/security/commit/6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "message": "Implement APIs and datamodel to configure nodes_dn dynamically.\n\nThe primary usecase is targeted at cross-cluster where in nodes restart\ncan be avoided by populating the coordinating cluster's nodes_dn values\nto facilitate cross-cluster usecases.\n\n**Summary of changes**:\n\n- Introduce \"nodesdn\" datatype to be stored in security index. In a way\n  it is another permission entity similar to internaluser, role etc\n- Make the above datatype backward compatible i.e do not fail other\n  operations (roles, users etc)\n- Implement APIs for CRUD operations that are only super-admin\n  accessible and are only enabled based on a YML config value.", "committedDate": "2020-04-07T18:59:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTE2OA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405191168", "bodyText": "What is the difference between NodesDnModelV6 and NodesDnModelV7?", "author": "vrozov", "createdAt": "2020-04-08T00:30:26Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -320,5 +328,39 @@ public String getHash(String user) {\n             return Collections.emptyList();\n         }\n     }\n+\n+    private static class NodesDnModelV7 extends NodesDnModel {", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNjgxMg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405926812", "bodyText": "+1 about difference question,\nand as this is new configuration, do we really need  V6 as well? Are we supporting this for 6x and needed for 6.8 to 7.x migration?", "author": "hardik-k-shah", "createdAt": "2020-04-09T02:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MDEzNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405980135", "bodyText": "+1 about difference question,\nand as this is new configuration, do we really need V6 as well? Are we supporting this for 6x and needed for 6.8 to 7.x migration?\n\nYes, will be supporting 6.7+", "author": "krishna-ggk", "createdAt": "2020-04-09T06:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2Nzc0OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406767749", "bodyText": "Merged the classes.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTE2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTUzNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405191535", "bodyText": "What is the difference between NodesDnV6 and NodesDnV7?", "author": "vrozov", "createdAt": "2020-04-08T00:31:45Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/v6/NodesDnV6.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6;", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4OTAxMQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405289011", "bodyText": "Though no difference in structure, the classes serve as a way to identify the config version. V7 versions when persisted to index includes meta fields while V6 versions don't.\nI'll take another look to see if we can make it work with single class.", "author": "krishna-ggk", "createdAt": "2020-04-08T06:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2ODMyMA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406768320", "bodyText": "Merged the classes.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzk1Mw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405193953", "bodyText": "I don't think that changing the interface is well justified. Only DefaultInterClusterRequestEvaluator is interested in NodesDnModel, all other classes that implement DCFListener actually do not use NodesDnModel on the callback event.", "author": "vrozov", "createdAt": "2020-04-08T00:40:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/DynamicConfigFactory.java", "diffHunk": "@@ -230,7 +238,7 @@ public void registerDCFListener(DCFListener listener) {\n     }\n     \n     public static interface DCFListener {\n-        void onChanged(ConfigModel cm, DynamicConfigModel dcm, InternalUsersModel ium);\n+        void onChanged(ConfigModel cm, DynamicConfigModel dcm, InternalUsersModel ium, NodesDnModel nm);", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5MTI2OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405291269", "bodyText": "The behavior in opendistroforelasticsearch/security for older versions (0.9 and 0.10) had support for subscribing and listening to changes for specific type.\nHowever that was removed in later versions where irrespective of type that changed, listener receives everything - https://github.com/opendistro-for-elasticsearch/security/blob/master/src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java#L294-L298\nI'll give this another thought, but do you have any suggestion?", "author": "krishna-ggk", "createdAt": "2020-04-08T06:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1ODY0NQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405658645", "bodyText": "Please see #364", "author": "vrozov", "createdAt": "2020-04-08T16:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNzU1OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405727559", "bodyText": "Please see #364\n\nI left a comment on yours. May be Hardik has some context on the behavior change. But I an adapt to your change quickly once it is pushed", "author": "krishna-ggk", "createdAt": "2020-04-08T18:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzk1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2ODUxMg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406768512", "bodyText": "Adapted to pub-sub changes in master.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NDM0OA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405894348", "bodyText": "for PUT, PATCH and DELETE are we allowing users to modify nodesdn for the existing cluster? is there a way in the current design to distinguish between \"cross_cluster\" node dn and ones for the existing cluster?", "author": "debjanibnrj", "createdAt": "2020-04-09T00:45:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.NodesDnV6;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.NodesDnV7;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MDU5Nw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405980597", "bodyText": "Yes, the GET has a show_all which shows the existing cluster nodesdn from YML with special key (STATIC_ES_YML_NODES_DN)", "author": "krishna-ggk", "createdAt": "2020-04-09T06:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NDM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2OTE5Mw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406769193", "bodyText": "Please reopen conv if this doesn't answer your question.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:57:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NDM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgxNzgzNA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406817834", "bodyText": "thanks for the explanation", "author": "debjanibnrj", "createdAt": "2020-04-10T15:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NDM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NzI3OA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405897278", "bodyText": "For PUT requests where API can enter free-form value for nodesdn you may want to validate the actual DN string. Eg: \"CN=OpenDistro,OU=Server CA,O=OpenDistro,C=US\" is acceptable but \"xyz\" is not.", "author": "debjanibnrj", "createdAt": "2020-04-09T00:55:33Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/NodesDnValidator.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class NodesDnValidator extends AbstractConfigurationValidator {\n+\n+    public NodesDnValidator(final RestRequest request, boolean isSuperAdmin, final BytesReference ref, final Settings esSettings, Object... param) {\n+        super(request, ref, esSettings, param);", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MDk3OA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405980978", "bodyText": "Good point, but I noticed there is no validation while loading values from ES YML. Let me look this up and accommodate the validation.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NzI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2ODkzNg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406768936", "bodyText": "I took another look and realized, we support both regex and wildcard, similar to how the YML value is consumed. So we won't be able to validate.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NzI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg1ODk1NA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405858954", "bodyText": "couldn't understand this case.\nWhen this (existingConfiguration.getSeqNo() < 0) can happen?\nAnd are you suggesting Security Admin tool to initialize the index?", "author": "hardik-k-shah", "createdAt": "2020-04-08T22:50:01Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AbstractApiAction.java", "diffHunk": "@@ -192,6 +192,11 @@ protected void handlePut(final RestChannel channel, final RestRequest request, f\n \n \t\tfinal SecurityDynamicConfiguration<?> existingConfiguration = load(getConfigName(), false);\n \n+\t\tif (existingConfiguration.getSeqNo() < 0) {\n+\t\t    forbidden(channel, \"Security index need to be updated to support '\" + getConfigName().toLCString() + \"'. Use OpenDistroSecurityAdmin to populate.\");", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NTIyOQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405985229", "bodyText": "couldn't understand this case.\nWhen this (existingConfiguration.getSeqNo() < 0) can happen?\nAnd are you suggesting Security Admin tool to initialize the index?\n\nCorrect. The need comes from nodesdn usecase. This is being introduced in older versions and hence it should be backward compatible, which means in the cases where the index is already created, the APIs will not work out of the box and will need security admin to create the document in index.\nSince the need is there, I added this generic check to provide better error message rather than ending with 5xx.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg1ODk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NTU5NA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405985594", "bodyText": "When this (existingConfiguration.getSeqNo() < 0) can happen?\n\nThis will happen when the index doesn't exist. ConfigurationLoader handles empty scenario and returns an object with negative seq number.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg1ODk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwMzgyOA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405903828", "bodyText": "couldn't get this condition here.\nReserved is a type of configuration (roles, users, mapping etc) which can be only updated by super admin.\nwhy are we checking ES_YML_NODES_DN here?", "author": "hardik-k-shah", "createdAt": "2020-04-09T01:21:08Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.NodesDnV6;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.NodesDnV7;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    protected void consumeParameters(final RestRequest request) {\n+        request.param(\"name\");\n+        request.param(\"show_all\");\n+    }\n+\n+    @Override\n+    protected boolean isReservedAndAccessible(SecurityDynamicConfiguration<?> existingConfiguration, String name) {\n+        if (STATIC_ES_YML_NODES_DN.equals(name)) {\n+            return false;\n+        }", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NDE5Mg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405984192", "bodyText": "couldn't get this condition here.\nReserved is a type of configuration (roles, users, mapping etc) which can be only updated by super admin.\nwhy are we checking ES_YML_NODES_DN here?\n\nIt is an amalgamation of super-admin and accessible. Since this is static coming from YML, the intention is to not allow updates to this key.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwMzgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwNzA4Mw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405907083", "bodyText": "are we putting primary DN  into security index as well? It will duplicate the information may create confusion.\nAs Primary DN will be now present into elasticsearch.yml as well as nodes_dn.yml .\nOne can export and change this value through security admin tool.", "author": "hardik-k-shah", "createdAt": "2020-04-09T01:34:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.NodesDnV6;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.NodesDnV7;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    protected void consumeParameters(final RestRequest request) {\n+        request.param(\"name\");\n+        request.param(\"show_all\");\n+    }\n+\n+    @Override\n+    protected boolean isReservedAndAccessible(SecurityDynamicConfiguration<?> existingConfiguration, String name) {\n+        if (STATIC_ES_YML_NODES_DN.equals(name)) {\n+            return false;\n+        }\n+        return super.isReservedAndAccessible(existingConfiguration, name);\n+    }\n+\n+    @Override\n+    protected void handleGet(final RestChannel channel, RestRequest request, Client client, final JsonNode content) throws IOException {\n+        final String resourcename = request.param(\"name\");\n+\n+        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), true);\n+        filter(configuration);\n+\n+        // no specific resource requested, return complete config\n+        if (resourcename == null || resourcename.length() == 0) {\n+            final Boolean showAll = request.paramAsBoolean(\"show_all\", Boolean.FALSE);\n+            if (showAll) {\n+                putStaticEntry(configuration);\n+            }\n+            successResponse(channel, configuration);\n+            return;\n+        }\n+\n+        if (!configuration.exists(resourcename)) {\n+            notFound(channel, \"Resource '\" + resourcename + \"' not found.\");\n+            return;\n+        }\n+\n+        configuration.removeOthers(resourcename);\n+        successResponse(channel, configuration);\n+    }\n+\n+    private void putStaticEntry(SecurityDynamicConfiguration<?> configuration) {\n+        if (NodesDnV7.class.equals(configuration.getImplementingClass())) {\n+            NodesDnV7 nodesDnV7 = new NodesDnV7();\n+            nodesDnV7.setNodesDn(staticNodesDnFromEsYml);", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYyMTk4Mg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406621982", "bodyText": "Primary DN will continue to be only in elasticsearch.yml.\nIf you notice, the static entry only shows up with explicit \"show_all\" flag. It is never propagated to index and the SecurityAdmin will also not use this flag while backing up or backfilling.", "author": "krishna-ggk", "createdAt": "2020-04-10T06:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwNzA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwNzM5MA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405907390", "bodyText": "super admin check will be evaluated through handleApiRequest() ?", "author": "hardik-k-shah", "createdAt": "2020-04-09T01:35:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,150 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.NodesDnV6;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.NodesDnV7;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    protected void consumeParameters(final RestRequest request) {\n+        request.param(\"name\");\n+        request.param(\"show_all\");\n+    }\n+\n+    @Override\n+    protected boolean isReservedAndAccessible(SecurityDynamicConfiguration<?> existingConfiguration, String name) {\n+        if (STATIC_ES_YML_NODES_DN.equals(name)) {\n+            return false;\n+        }\n+        return super.isReservedAndAccessible(existingConfiguration, name);\n+    }\n+\n+    @Override\n+    protected void handleGet(final RestChannel channel, RestRequest request, Client client, final JsonNode content) throws IOException {\n+        final String resourcename = request.param(\"name\");\n+", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MzcyOA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405983728", "bodyText": "super admin check will be evaluated through handleApiRequest() ?\n\nCorrect. handleApiRequest is invoked first which further dispatches to handleGet, handlePut etc", "author": "krishna-ggk", "createdAt": "2020-04-09T06:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwNzM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMDY4OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405910689", "bodyText": "where are we using isSuperAdmin boolean?", "author": "hardik-k-shah", "createdAt": "2020-04-09T01:48:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/NodesDnValidator.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class NodesDnValidator extends AbstractConfigurationValidator {\n+\n+    public NodesDnValidator(final RestRequest request, boolean isSuperAdmin, final BytesReference ref, final Settings esSettings, Object... param) {", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MzM5MA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405983390", "bodyText": "where are we using isSuperAdmin boolean?\n\nWill remove, not using this anymore.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMDY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2OTYyMg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406769622", "bodyText": "Done.", "author": "krishna-ggk", "createdAt": "2020-04-10T13:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxMDY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyODA2Nw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405928067", "bodyText": "if both models are same, do we need migration?", "author": "hardik-k-shah", "createdAt": "2020-04-09T02:56:34Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/Migration.java", "diffHunk": "@@ -96,7 +96,20 @@\n         }\n         return c7;\n     }\n-    \n+\n+    public static SecurityDynamicConfiguration<NodesDnV7> migrateNodesDn(SecurityDynamicConfiguration<NodesDnV6> n6) {", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3MDczOQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406770739", "bodyText": "I did merge the classes. However this migration section remains since the version is part of the configuration in v7 as Meta fields.\nV7\n_meta:\n  type: \"nodesdn\"\n  config_version: 2\ncluster1:\n  nodes_dn:\n    - \"CN=abc.com\"\nV6\ncluster1:\n  nodes_dn:\n    - \"CN=abc.com\"", "author": "krishna-ggk", "createdAt": "2020-04-10T14:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyODA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzY2NA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405937664", "bodyText": "We are already listening changes and updating it\ndo we still need to make it volatile?", "author": "hardik-k-shah", "createdAt": "2020-04-09T03:37:10Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/DefaultInterClusterRequestEvaluator.java", "diffHunk": "@@ -47,15 +56,34 @@\n import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n \n-public final class DefaultInterClusterRequestEvaluator implements InterClusterRequestEvaluator {\n+public final class DefaultInterClusterRequestEvaluator implements InterClusterRequestEvaluator, DCFListener {\n \n     private final Logger log = LogManager.getLogger(this.getClass());\n     private final String certOid;\n-    private final List<String> nodesDn;\n+    private final List<String> staticNodesDnFromEsYml;\n+    private boolean dynamicNodesDnConfigEnabled;\n+    private volatile Map<String, List<String>> dynamicNodesDn;", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MzExNw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405983117", "bodyText": "We are already listening changes and updating it\ndo we still need to make it volatile?\n\nYes, it is mostly to ensure the writes are quickly picked up in the subsequent reads. Otherwise further reads could end up reading from cache and miss the update.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNDg5OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406424899", "bodyText": "Consider using AtomicReference instead of volatile: private final AtomicReference<Map<String, List<String>>> dynamicNodesDn = new AtomicReference<>(Collections.emptyMap());", "author": "vrozov", "createdAt": "2020-04-09T19:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1OTE0OA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406659148", "bodyText": "Consider using AtomicReference instead of volatile: private final AtomicReference<Map<String, List<String>>> dynamicNodesDn = new AtomicReference<>(Collections.emptyMap());\n\nSince I don't need CAS semantics, it seems like using volatile direclty is simpler. Do you see any other benefits of using AtomicReference in this specific scenario?", "author": "krishna-ggk", "createdAt": "2020-04-10T08:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgxNTEyNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r406815125", "bodyText": "1. Can you please make sure if nodes_dn API calls are being audit logged properly?\n2. Under which event it is being audit logged? Do we need to create separate audit log events?\n\n\nThe current audit coverage covers limited REST API access audit logging\nSince the Admin access is checked after the section in the above link, they are not logged currently. However this behavior is consistent with other security API such as SSL certs APIs that were recently added. Since these are all admin API, do you think we can add them collectively?\n(It looks like security index updates aren't logged, or that would have had the required info).\n\n3. Can we verify 6.8 to 7.1 migration?\n4. Can we test if security admin tools are working as expected ?\n\n\nGood point. This was already being tested in SecurityAdminMigrationTests, but added a non-empty file to improve coverage.\n$ pwd\n~/code/native_es_stuff/fork/security/data/utest_n1_ffork_1_t17447483324660_migration\n\n$ cat nodes_dn.yml\n---\ncluster1:\n  nodes_dn:\n  - \"cn=popeye\"\n\n$ cat v7/nodes_dn.yml\n---\n_meta:\n  type: \"nodesdn\"\n  config_version: 2\ncluster1:\n  nodes_dn:\n  - \"cn=popeye\"\n\n5. Do we need any code change for certificate oid?\n\n\nNope. CertOid is fall back logic if there is no match for nodes_dn. It is singular value and hence makes sense only in YML.", "author": "krishna-ggk", "createdAt": "2020-04-10T15:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzg1Mw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405937853", "bodyText": "what will happen during the node/cluster boot up time when .security_index is not available? dynamicNodesDn will be initialized with empty list?", "author": "hardik-k-shah", "createdAt": "2020-04-09T03:37:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/transport/DefaultInterClusterRequestEvaluator.java", "diffHunk": "@@ -47,15 +56,34 @@\n import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n import com.amazon.opendistroforelasticsearch.security.support.WildcardMatcher;\n \n-public final class DefaultInterClusterRequestEvaluator implements InterClusterRequestEvaluator {\n+public final class DefaultInterClusterRequestEvaluator implements InterClusterRequestEvaluator, DCFListener {\n \n     private final Logger log = LogManager.getLogger(this.getClass());\n     private final String certOid;\n-    private final List<String> nodesDn;\n+    private final List<String> staticNodesDnFromEsYml;\n+    private boolean dynamicNodesDnConfigEnabled;\n+    private volatile Map<String, List<String>> dynamicNodesDn;\n \n     public DefaultInterClusterRequestEvaluator(final Settings settings) {\n         this.certOid = settings.get(ConfigConstants.OPENDISTRO_SECURITY_CERT_OID, \"1.2.3.4.5.5\");\n-        this.nodesDn = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+        this.dynamicNodesDnConfigEnabled = settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false);\n+        this.dynamicNodesDn = Collections.emptyMap();\n+    }\n+\n+    public void subscribeForChanges(DynamicConfigFactory dynamicConfigFactory) {\n+        if (this.dynamicNodesDnConfigEnabled) {\n+            dynamicConfigFactory.registerDCFListener(this);\n+        }\n+    }\n+\n+    private List<String> getNodesDnToEvaluate() {", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MjIxMg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405982212", "bodyText": "what will happen during the node/cluster boot up time when .security_index is not available? dynamicNodesDn will be initialized with empty list?\n\nCorrect. For boot up it uses the value from YML alone.", "author": "krishna-ggk", "createdAt": "2020-04-09T06:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk0MDEyNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405940125", "bodyText": "should we also add -ve test? where we do not add new cert dynamically and statically?", "author": "hardik-k-shah", "createdAt": "2020-04-09T03:47:58Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/ccstest/CrossClusterSearchTests.java", "diffHunk": "@@ -827,4 +879,113 @@ public void testCcsAggregationsDnfof() throws Exception {\n         ccs = new RestHelper(cl1Info, false, false, getResourceFolder()).executePostRequest(\"cross_cluster_two:not*,notf*/_search?pretty\", agg, encodeBasicHeader(\"twitter\",\"nagilum\"));\n         Assert.assertEquals(HttpStatus.SC_OK, ccs.getStatusCode());\n     }\n-}\n\\ No newline at end of file\n+\n+\n+    private ClusterTransportClientSettings getBaseSettingsWithDifferentCert() {\n+        Settings cluster = Settings.builder()\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_HTTP_ENABLED, true)\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_HTTP_KEYSTORE_FILEPATH,\n+                FileHelper.getAbsoluteFilePathFromClassPath(\"restapi/node-0-keystore.jks\"))\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_HTTP_TRUSTSTORE_FILEPATH,\n+                FileHelper.getAbsoluteFilePathFromClassPath(\"restapi/truststore.jks\"))\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_TRANSPORT_KEYSTORE_FILEPATH, FileHelper.getAbsoluteFilePathFromClassPath(\"node-untspec5-keystore.p12\"))\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_TRANSPORT_KEYSTORE_ALIAS, \"1\")\n+            .put(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, true)\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_TRANSPORT_KEYSTORE_TYPE, \"PKCS12\")\n+            .putList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN,\n+                \"EMAILADDRESS=unt@tst.com,CN=node-untspec5.example.com,OU=SSL,O=Te\\\\, st,L=Test,C=DE\")//, \"CN=node-0.example.com,OU=SSL,O=Test,L=Test,C=DE\")\n+            .putList(ConfigConstants.OPENDISTRO_SECURITY_AUTHCZ_ADMIN_DN,\n+                \"EMAILADDRESS=unt@xxx.com,CN=node-untspec6.example.com,OU=SSL,O=Te\\\\, st,L=Test,C=DE\",\n+                \"CN=kirk,OU=client,O=client,l=tEst, C=De\")\n+            .put(ConfigConstants.OPENDISTRO_SECURITY_CERT_OID,\"1.2.3.4.5.6\")\n+            .build();\n+        Settings transport = Settings.builder()\n+            .put(SSLConfigConstants.OPENDISTRO_SECURITY_SSL_TRANSPORT_KEYSTORE_FILEPATH, FileHelper.getAbsoluteFilePathFromClassPath(\"node-untspec6-keystore.p12\"))\n+            .build();\n+        return new ClusterTransportClientSettings(cluster, transport);\n+    }\n+\n+    private void populateBaseData(ClusterTransportClientSettings cluster1, ClusterTransportClientSettings cluster2) throws Exception {\n+        final String cl1BodyMain = rh1.executeGetRequest(\"\", encodeBasicHeader(\"twitter\",\"nagilum\")).getBody();\n+        Assert.assertTrue(cl1BodyMain, cl1BodyMain.contains(\"crl1\"));\n+\n+        final String cl2BodyMain = rh2.executeGetRequest(\"\", encodeBasicHeader(\"twitter\",\"nagilum\")).getBody();\n+        Assert.assertTrue(cl2BodyMain.contains(\"crl2\"));\n+\n+        try (TransportClient tc = getInternalTransportClient(cl1Info, cluster1.transportClientSettings())) {\n+            tc.index(new IndexRequest(\"twitter\").type(\"tweet\").setRefreshPolicy(RefreshPolicy.IMMEDIATE).id(\"0\")\n+                .source(\"{\\\"cluster\\\": \\\"\"+cl1Info.clustername+\"\\\"}\", XContentType.JSON)).actionGet();\n+        }\n+\n+        try (TransportClient tc = getInternalTransportClient(cl2Info, cluster2.transportClientSettings())) {\n+            tc.index(new IndexRequest(\"twitter\").type(\"tweet\").setRefreshPolicy(RefreshPolicy.IMMEDIATE).id(\"0\")\n+                .source(\"{\\\"cluster\\\": \\\"\"+cl2Info.clustername+\"\\\"}\", XContentType.JSON)).actionGet();\n+        }\n+    }\n+\n+    @Test\n+    public void testCcsWithDiffCertsWithNoNodesDnUpdate() throws Exception {\n+        final ClusterTransportClientSettings cluster1 = new ClusterTransportClientSettings();\n+        final ClusterTransportClientSettings cluster2 = getBaseSettingsWithDifferentCert();\n+\n+        setupCcs(new DynamicSecurityConfig(), cluster1, cluster2);\n+        populateBaseData(cluster1, cluster2);\n+\n+        String uri = \"cross_cluster_two:twitter/tweet/_search?pretty\";\n+        HttpResponse ccs = rh1.executeGetRequest(uri, encodeBasicHeader(\"twitter\", \"nagilum\"));\n+        System.out.println(ccs.getBody());\n+        assertThat(ccs.getStatusCode(), equalTo(HttpStatus.SC_INTERNAL_SERVER_ERROR));\n+        assertThat(ccs.getBody(), containsString(\"no OID or security.nodes_dn incorrect configured\"));\n+    }\n+\n+    @Test\n+    public void testCcsWithDiffCertsWithNodesDnStaticallyAdded() throws Exception {\n+        final ClusterTransportClientSettings cluster1 = new ClusterTransportClientSettings();\n+        ClusterTransportClientSettings cluster2 = getBaseSettingsWithDifferentCert();\n+        Settings updatedCluster2 = Settings.builder()\n+            .put(cluster2.clusterSettings())\n+            .putList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN,\n+                \"EMAILADDRESS=unt@tst.com,CN=node-untspec5.example.com,OU=SSL,O=Te\\\\, st,L=Test,C=DE\",\n+                \"CN=node-0.example.com,OU=SSL,O=Test,L=Test,C=DE\")\n+            .build();\n+        cluster2 = new ClusterTransportClientSettings(updatedCluster2, cluster2.transportClientSettings());\n+\n+        setupCcs(new DynamicSecurityConfig(), cluster1, cluster2);\n+        populateBaseData(cluster1, cluster2);\n+\n+        String uri = \"cross_cluster_two:twitter/tweet/_search?pretty\";\n+        HttpResponse ccs = rh1.executeGetRequest(uri, encodeBasicHeader(\"twitter\", \"nagilum\"));\n+        System.out.println(ccs.getBody());\n+        assertThat(ccs.getStatusCode(), equalTo(HttpStatus.SC_OK));\n+        assertThat(ccs.getBody(), not(containsString(\"security_exception\")));\n+        assertThat(ccs.getBody(), containsString(\"\\\"timed_out\\\" : false\"));\n+        assertThat(ccs.getBody(), not(containsString(\"crl1\")));\n+        assertThat(ccs.getBody(), containsString(\"crl2\"));\n+        assertThat(ccs.getBody(), containsString(\"cross_cluster_two:twitter\"));\n+    }\n+\n+    @Test\n+    public void testCcsWithDiffCertsWithNodesDnDynamicallyAdded() throws Exception {", "originalCommit": "6c709ebf8e9b4c1edf8415cd1d8e1be7042ac198", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4MjA2Nw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r405982067", "bodyText": "There is, testCcsWithDiffCertsWithNoNodesDnUpdate()", "author": "krishna-ggk", "createdAt": "2020-04-09T06:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk0MDEyNQ=="}], "type": "inlineReview"}, {"oid": "e16f78df8763d1315cc32a34cdd835eafe2ddaf9", "url": "https://github.com/opensearch-project/security/commit/e16f78df8763d1315cc32a34cdd835eafe2ddaf9", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-10T13:03:24Z", "type": "commit"}, {"oid": "19579db53f9150368efc97b26887396d9ebb4c46", "url": "https://github.com/opensearch-project/security/commit/19579db53f9150368efc97b26887396d9ebb4c46", "message": "Merge NodesDnV7 and NodesDnV6.", "committedDate": "2020-04-10T13:53:15Z", "type": "commit"}, {"oid": "015e51a184434a493c399d7b12192d3a11f73246", "url": "https://github.com/opensearch-project/security/commit/015e51a184434a493c399d7b12192d3a11f73246", "message": "Remove unused param in NodesDnValidator.", "committedDate": "2020-04-10T14:03:49Z", "type": "commit"}, {"oid": "ae636ae77b85ecbf143ea8a904f9490dbcbc5bda", "url": "https://github.com/opensearch-project/security/commit/ae636ae77b85ecbf143ea8a904f9490dbcbc5bda", "message": "Ensure nodes_dn migration coverage.", "committedDate": "2020-04-10T15:31:55Z", "type": "commit"}, {"oid": "2896c6cfae198ecc35fc460fd2550981e05d27b4", "url": "https://github.com/opensearch-project/security/commit/2896c6cfae198ecc35fc460fd2550981e05d27b4", "message": "Remove unused imports.", "committedDate": "2020-04-11T15:42:23Z", "type": "commit"}, {"oid": "62b578198a3a8179fff25d0c2b00c9eb4fb48269", "url": "https://github.com/opensearch-project/security/commit/62b578198a3a8179fff25d0c2b00c9eb4fb48269", "message": "Remove terminal newline from unrelated files for NodesDn changes.", "committedDate": "2020-04-11T15:51:19Z", "type": "commit"}, {"oid": "24690d616eda6d1b194fbb9ed4e87b2589ac2ab3", "url": "https://github.com/opensearch-project/security/commit/24690d616eda6d1b194fbb9ed4e87b2589ac2ab3", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-11T16:00:09Z", "type": "commit"}, {"oid": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "url": "https://github.com/opensearch-project/security/commit/cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "message": "Switch from Guava EventBus to Greenrobot for DefaultInterClusterRequestEvaluator", "committedDate": "2020-04-11T16:04:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2ODQwMQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407368401", "bodyText": "Do we need some validation here of the input as we accepting directly List ?", "author": "sujithvm", "createdAt": "2020-04-13T08:05:37Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/NodesDnValidator.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;\n+\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class NodesDnValidator extends AbstractConfigurationValidator {\n+\n+    public NodesDnValidator(final RestRequest request, final BytesReference ref, final Settings esSettings, Object... param) {\n+        super(request, ref, esSettings, param);\n+        this.payloadMandatory = true;\n+\n+        allowedKeys.put(\"nodes_dn\", DataType.ARRAY);\n+        mandatoryKeys.add(\"nodes_dn\");\n+    }", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQxNTQxNg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407415416", "bodyText": "The nodes_dn accepts regex and wildcard similar to how the YML config is consumed. Hence chose not to validate.", "author": "krishna-ggk", "createdAt": "2020-04-13T10:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2ODQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcxODYyMQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407718621", "bodyText": "I m just worried about how bad requests are handled. Will passing any random string be accepted like Random= testing?", "author": "sujithvm", "createdAt": "2020-04-13T21:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM2ODQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3Mzg0MA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407373840", "bodyText": "I am slightly confused here. isReservedAndAccessible checks if class implements StaticDefinable interface which NodeDn does not.\nDid you mean to override isReserved() here instead ?\nSince we are calling super.isReservedAndAccessible(), this function will always never return false ?", "author": "sujithvm", "createdAt": "2020-04-13T08:22:10Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.NodesDn;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    protected void consumeParameters(final RestRequest request) {\n+        request.param(\"name\");\n+        request.param(\"show_all\");\n+    }\n+\n+    @Override\n+    protected boolean isReservedAndAccessible(SecurityDynamicConfiguration<?> existingConfiguration, String name) {", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQxODk3MQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407418971", "bodyText": "I am slightly confused here. isReservedAndAccessible checks if class implements StaticDefinable interface which NodeDn does not.\nDid you mean to override isReserved() here instead ?\n\nReserved means, it is only updateable by Admin. In this case, the STATIC_ES_YML_NODES_DN key shouldn't be updateable by Admin too.\n\nSince we are calling super.isReservedAndAccessible(), this function will always return false ?\nNope. On the contrary, it returns true all the time\n\n\tprotected boolean isReservedAndAccessible(final SecurityDynamicConfiguration<?> existingConfiguration,\n\t\t\t\t\t\t\t\t\t\t\t  String name) {\n\t\tif( isReserved(existingConfiguration, name) && !isSuperAdmin()) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\nSince isReserved returns false, it defaults to returning true.", "author": "krishna-ggk", "createdAt": "2020-04-13T10:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3Mzg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcxMjUzNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407712535", "bodyText": "Yes. Sorry I did mean that function will never return false.\nIf we override isReserved() and put the check STATIC_ES_YML_NODES_DN.equals(name)  in the function, won't we have a same behaviour?  Because what we are trying to override here is the reservedness of a resource.", "author": "sujithvm", "createdAt": "2020-04-13T20:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3Mzg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3NTEzMw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407375133", "bodyText": "Is this gonna handle a PUT request of this form ? PUT /_opendistro/_security/api/nodesdn/STATIC_ES_YML_NODES_DN  ? as thats what is passed as name.", "author": "sujithvm", "createdAt": "2020-04-13T08:25:46Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.NodesDn;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    protected void consumeParameters(final RestRequest request) {\n+        request.param(\"name\");\n+        request.param(\"show_all\");\n+    }\n+\n+    @Override\n+    protected boolean isReservedAndAccessible(SecurityDynamicConfiguration<?> existingConfiguration, String name) {\n+        if (STATIC_ES_YML_NODES_DN.equals(name)) {\n+            return false;", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQxOTEzNQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407419135", "bodyText": "correct.", "author": "krishna-ggk", "createdAt": "2020-04-13T10:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3NTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3NjkxOA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407376918", "bodyText": "Can the API be blocked from RestApiPrivilegeEvaluator instead of doing this here?\nhttps://github.com/opendistro-for-elasticsearch/security/blob/master/src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/RestApiPrivilegesEvaluator.java#L213", "author": "sujithvm", "createdAt": "2020-04-13T08:30:34Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/NodesDnApiAction.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.NodesDnValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.NodesDn;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestRequest.Method;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * This class implements CRUD operations to manage dynamic NodesDn. The primary usecase is targeted at cross-cluster where\n+ * in node restart can be avoided by populating the coordinating cluster's nodes_dn values.\n+ *\n+ * The APIs are only accessible to SuperAdmin since the configuration controls the core application layer trust validation.\n+ * By default the APIs are disabled and can be enabled by a YML setting - {@link ConfigConstants#OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED}\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ *\n+ * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.NodesDnApiTest} for usage examples.\n+ */\n+public class NodesDnApiAction extends PatchableResourceApiAction {\n+    public static final String STATIC_ES_YML_NODES_DN = \"STATIC_ES_YML_NODES_DN\";\n+    private final List<String> staticNodesDnFromEsYml;\n+\n+    @Inject\n+    public NodesDnApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+        final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+        final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+        this.staticNodesDnFromEsYml = settings.getAsList(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN, Collections.emptyList());\n+    }\n+\n+    @Override\n+    protected void registerHandlers(RestController controller, Settings settings) {\n+        if (settings.getAsBoolean(ConfigConstants.OPENDISTRO_SECURITY_NODES_DN_DYNAMIC_CONFIG_ENABLED, false)) {\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.GET, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.DELETE, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PUT, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/\", this);\n+            controller.registerHandler(Method.PATCH, \"/_opendistro/_security/api/nodesdn/{name}\", this);\n+        }\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(RestChannel channel, RestRequest request, Client client) throws IOException {\n+        if (!isSuperAdmin()) {", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODQ2Mg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407498462", "bodyText": "I tried that approach - however that handles RBAC which doesn't support special casing for admin DN (AdminDN is required since this is sensitive setting parallel to cert hot-reload)", "author": "krishna-ggk", "createdAt": "2020-04-13T14:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3NjkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcwNDYyMw==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407704623", "bodyText": "AdminDN is already injected in the constructor and user can be determined from the thread pool context. How differently are they handled in the api action ?", "author": "sujithvm", "createdAt": "2020-04-13T20:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3NjkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4MjQ0NQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407382445", "bodyText": "Do we reach this stage when node is re-started or opendistro index is already initialized ? I assumed it would throw exception from line #136 ? ResourceAlreadyExistsException", "author": "sujithvm", "createdAt": "2020-04-13T08:46:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java", "diffHunk": "@@ -144,14 +138,16 @@ public void run() {\n                                             .actionGet().isAcknowledged();\n                                     LOGGER.info(\"Index {} created?: {}\", opendistrosecurityIndex, ok);\n                                     if(ok) {\n-                                        ConfigHelper.uploadFile(client, cd+\"config.yml\", opendistrosecurityIndex, CType.CONFIG, configVersion);\n-                                        ConfigHelper.uploadFile(client, cd+\"roles.yml\", opendistrosecurityIndex, CType.ROLES, configVersion);\n-                                        ConfigHelper.uploadFile(client, cd+\"roles_mapping.yml\", opendistrosecurityIndex, CType.ROLESMAPPING, configVersion);\n-                                        ConfigHelper.uploadFile(client, cd+\"internal_users.yml\", opendistrosecurityIndex, CType.INTERNALUSERS, configVersion);\n-                                        ConfigHelper.uploadFile(client, cd+\"action_groups.yml\", opendistrosecurityIndex, CType.ACTIONGROUPS, configVersion);\n-                                        if(configVersion == 2) {\n-                                            ConfigHelper.uploadFile(client, cd+\"tenants.yml\", opendistrosecurityIndex, CType.TENANTS, configVersion);\n+                                        ConfigHelper.uploadFile(client, cd+\"config.yml\", opendistrosecurityIndex, CType.CONFIG, DEFAULT_CONFIG_VERSION);\n+                                        ConfigHelper.uploadFile(client, cd+\"roles.yml\", opendistrosecurityIndex, CType.ROLES, DEFAULT_CONFIG_VERSION);\n+                                        ConfigHelper.uploadFile(client, cd+\"roles_mapping.yml\", opendistrosecurityIndex, CType.ROLESMAPPING, DEFAULT_CONFIG_VERSION);\n+                                        ConfigHelper.uploadFile(client, cd+\"internal_users.yml\", opendistrosecurityIndex, CType.INTERNALUSERS, DEFAULT_CONFIG_VERSION);\n+                                        ConfigHelper.uploadFile(client, cd+\"action_groups.yml\", opendistrosecurityIndex, CType.ACTIONGROUPS, DEFAULT_CONFIG_VERSION);\n+                                        if(DEFAULT_CONFIG_VERSION == 2) {\n+                                            ConfigHelper.uploadFile(client, cd+\"tenants.yml\", opendistrosecurityIndex, CType.TENANTS, DEFAULT_CONFIG_VERSION);\n                                         }\n+                                        final boolean populateEmptyIfFileMissing = true;\n+                                        ConfigHelper.uploadFile(client, cd+\"nodes_dn.yml\", opendistrosecurityIndex, CType.NODESDN, DEFAULT_CONFIG_VERSION, populateEmptyIfFileMissing);", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQyMDc0OQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407420749", "bodyText": "It won't reach here if index is already created. However it reaches here on the first time bootstrap of the cluster, where after index creation it populates the documents.", "author": "krishna-ggk", "createdAt": "2020-04-13T10:36:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4MjQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4NDk5MQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407384991", "bodyText": "Do we need this populateEmptyIfFileMissing logic? Can we add the file and assume the file to exists in the builds like we do for other configs in securityconfig dir ?", "author": "sujithvm", "createdAt": "2020-04-13T08:53:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/support/ConfigHelper.java", "diffHunk": "@@ -70,11 +78,36 @@ public static void uploadFile(Client tc, String filepath, String index, CType cT\n                 throw new Exception(\"   FAIL: Configuration for '\" + cType.toLCString()\n                         + \"' failed for unknown reasons. Pls. consult logfile of elasticsearch\");\n             }\n-        } catch (Exception e) {\n-            throw e;\n         }\n     }\n-    \n+\n+    public static Reader createFileOrStringReader(CType cType, int configVersion, String filepath, boolean populateEmptyIfFileMissing) throws Exception {", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5NTM2NA==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407495364", "bodyText": "The intention is to keep it backward compatible so that if customers perform minor version upgrade, they are not impacted by the document not being present. That said, there are following paths overall.\n\nConfigurationRepository.uploadFile() - This path is invoked only during index bootstrap which means folks performing minor version upgrade would not hit this path as the index already exists. Missing file handling can be removed from here.\nOpenDistroSecurityAdmin.migrate(),upload() - These paths provide a way to populate missing documents and thus having missing file handling will be useful.\n\nNow I can remove path 1, but it could help remote cases of migration without using SecurityAdmin tool and ensure the index is always populated. Let me know if you strongly feel the need to remove and I can remove it.", "author": "krishna-ggk", "createdAt": "2020-04-13T14:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4NDk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4NTYxMQ==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407385611", "bodyText": "Do need any of these imports? Just seeing the diff", "author": "sujithvm", "createdAt": "2020-04-13T08:55:03Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/SecurityAdminMigrationTests.java", "diffHunk": "@@ -21,6 +21,9 @@\n import java.util.ArrayList;\n import java.util.List;\n \n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;", "originalCommit": "cdd20b22ca37d7ee6e4166dbc2af29d932fbde75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQyMTcyMg==", "url": "https://github.com/opensearch-project/security/pull/362#discussion_r407421722", "bodyText": "Good point - I'll do another scan to rid off these stray imports.", "author": "krishna-ggk", "createdAt": "2020-04-13T10:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4NTYxMQ=="}], "type": "inlineReview"}, {"oid": "02f2502f1808e7ec06048330c433ca1c8d83ec6d", "url": "https://github.com/opensearch-project/security/commit/02f2502f1808e7ec06048330c433ca1c8d83ec6d", "message": "Remove unused import - try-2 :(", "committedDate": "2020-04-13T14:19:12Z", "type": "commit"}, {"oid": "956daf8ecac65d1a274965bc76b8b233264f1431", "url": "https://github.com/opensearch-project/security/commit/956daf8ecac65d1a274965bc76b8b233264f1431", "message": "Address remaining comments.\n\n- Added a test to validate audit logging\n- Added copyright headers", "committedDate": "2020-04-14T08:13:38Z", "type": "commit"}, {"oid": "dec1411040d583b91c6250aa273eb2f673150830", "url": "https://github.com/opensearch-project/security/commit/dec1411040d583b91c6250aa273eb2f673150830", "message": "Changes in Migrater to also migrate NodesDn.", "committedDate": "2020-04-14T14:56:23Z", "type": "commit"}, {"oid": "f651c7e2fe63654d4a6d207df9bbd9bd73dfc9bb", "url": "https://github.com/opensearch-project/security/commit/f651c7e2fe63654d4a6d207df9bbd9bd73dfc9bb", "message": "Fix the default legacy config for nodes_dn.\n\nWhile backporting to 0.9, I realized an empty YAML file results in parse\nfailures as it expects an object. So use \"{}\" as default content.", "committedDate": "2020-04-14T19:05:02Z", "type": "commit"}]}