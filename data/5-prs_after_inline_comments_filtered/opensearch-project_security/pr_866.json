{"pr_number": 866, "pr_title": "Use reflection to get reduceOrder, termBytes and format due to java.lang.IllegalAccessError", "pr_createdAt": "2020-12-02T06:35:45Z", "pr_url": "https://github.com/opensearch-project/security/pull/866", "timeline": [{"oid": "09d9594a2db99e4667fc167ab75e6155d5192c49", "url": "https://github.com/opensearch-project/security/commit/09d9594a2db99e4667fc167ab75e6155d5192c49", "message": "Use reflection to get reduceOrder, termBytes and format due to java.lang.IllegalAccessError", "committedDate": "2020-12-02T06:32:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NDUzOQ==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534364539", "bodyText": "nit: single line {}?", "author": "palashhedau", "createdAt": "2020-12-02T17:50:20Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/DlsFlsValveImpl.java", "diffHunk": "@@ -253,4 +260,58 @@ public void accept(StringTerms.Bucket bucket) {\n             this.bucket = bucket;\n         }\n     }\n+\n+    private static class StringTermsGetter {\n+        private static final Field REDUCE_ORDER = getField(InternalTerms.class, \"reduceOrder\");\n+        private static final Field TERM_BYTES = getField(StringTerms.Bucket.class, \"termBytes\");\n+        private static final Field FORMAT = getField(InternalTerms.Bucket.class, \"format\");\n+\n+        private StringTermsGetter() {\n+        }", "originalCommit": "09d9594a2db99e4667fc167ab75e6155d5192c49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM4NDk3Mw==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534384973", "bodyText": "I don't think it is a common style to have single line {}.", "author": "vrozov", "createdAt": "2020-12-02T18:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NDUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NzE1Mg==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534367152", "bodyText": "Cant it be handled the same way as \"throw new RuntimeException(e)\" ?", "author": "palashhedau", "createdAt": "2020-12-02T17:54:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/DlsFlsValveImpl.java", "diffHunk": "@@ -253,4 +260,58 @@ public void accept(StringTerms.Bucket bucket) {\n             this.bucket = bucket;\n         }\n     }\n+\n+    private static class StringTermsGetter {\n+        private static final Field REDUCE_ORDER = getField(InternalTerms.class, \"reduceOrder\");\n+        private static final Field TERM_BYTES = getField(StringTerms.Bucket.class, \"termBytes\");\n+        private static final Field FORMAT = getField(InternalTerms.Bucket.class, \"format\");\n+\n+        private StringTermsGetter() {\n+        }\n+\n+        private static <T> Field getFieldPrivileged(Class<T> cls, String name) {\n+            try {\n+                final Field field = cls.getDeclaredField(name);\n+                field.setAccessible(true);\n+                return field;\n+            } catch (NoSuchFieldException | SecurityException e) {\n+                log.error(\"Failed to get class {} declared field {}\", cls.getSimpleName(), name, e);\n+                if (e instanceof RuntimeException) {\n+                    throw (RuntimeException) e;\n+                } else {\n+                    throw new RuntimeException(e);\n+                }\n+            }\n+        }\n+\n+        private static <T> Field getField(Class<T> cls, String name) {\n+            SpecialPermission.check();\n+            return AccessController.doPrivileged((PrivilegedAction<Field>) () -> getFieldPrivileged(cls, name));\n+        }\n+\n+        private static <T, C> T getFieldValue(Field field, C c) {\n+            try {\n+                return (T)field.get(c);\n+            } catch (IllegalArgumentException | IllegalAccessException e) {\n+                log.error(\"Exception while getting value {} of class {}\", field.getName(), c.getClass().getSimpleName(), e);\n+                if (e instanceof RuntimeException) {\n+                    throw (RuntimeException) e;", "originalCommit": "09d9594a2db99e4667fc167ab75e6155d5192c49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM4NTI0Ng==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534385246", "bodyText": "There is no need to wrap RuntimeException in another RuntimeException", "author": "vrozov", "createdAt": "2020-12-02T18:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM2NzE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTAyNw==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534565027", "bodyText": "Curious why we are using the InternalTerms.class instead of the previous StringTerms.class", "author": "debjanibnrj", "createdAt": "2020-12-03T00:01:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/DlsFlsValveImpl.java", "diffHunk": "@@ -253,4 +260,58 @@ public void accept(StringTerms.Bucket bucket) {\n             this.bucket = bucket;\n         }\n     }\n+\n+    private static class StringTermsGetter {\n+        private static final Field REDUCE_ORDER = getField(InternalTerms.class, \"reduceOrder\");", "originalCommit": "09d9594a2db99e4667fc167ab75e6155d5192c49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NzE5MQ==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534567191", "bodyText": "Nvm, I see that StringTerms is a child class of InternalTerms.", "author": "debjanibnrj", "createdAt": "2020-12-03T00:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2Nzg5NQ==", "url": "https://github.com/opensearch-project/security/pull/866#discussion_r534567895", "bodyText": "For getDeclaredField() to find the field it needs to be called for the class where the field is declared. In case of reduceOrder it is declared in InternalTerms.class and is accessible from subclasses (StringTerms.class)", "author": "vrozov", "createdAt": "2020-12-03T00:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTAyNw=="}], "type": "inlineReview"}]}