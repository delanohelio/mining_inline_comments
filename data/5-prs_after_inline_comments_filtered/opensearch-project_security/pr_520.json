{"pr_number": 520, "pr_title": "Add configuration for REST API whitelisting", "pr_createdAt": "2020-06-25T13:07:10Z", "pr_url": "https://github.com/opensearch-project/security/pull/520", "timeline": [{"oid": "39ccc96544d0d16b6fd5dd7f5d741ec267597165", "url": "https://github.com/opensearch-project/security/commit/39ccc96544d0d16b6fd5dd7f5d741ec267597165", "message": "Add REST API whitelisting\n\nThis commit introduces a whitelisting feature into the security plugin.\nThis feature allows the SuperAdmin to whitelist APIs by URI for use by users.\nAll users except SuperAdmin can only access whitelisted APIs.\nWhitelisting can be configured in 2 ways:\n1. Using the whitelisting_settings.yml file and pushing using command line (securityadmin.sh).\n2. Using the REST API /_opendistro/_security/api/whitelist to update current whitelisting settings.\nThe REST API /_opendistro/_security/api/whitelist is only accessible by the SuperAdmin.\nIt has 2 endpoints:\n1. GET - returns the existing whitelist configuration\n2. PUT - allows changing the existing configuration.\nWhitelisting can be turned off dynamically by setting 'whitelistingEnabled' to false\nby using either the API or securityadmin.sh", "committedDate": "2020-06-25T09:48:27Z", "type": "commit"}, {"oid": "5549215bc2fbd9c6a87abcd3ec8d093e5f0c56ef", "url": "https://github.com/opensearch-project/security/commit/5549215bc2fbd9c6a87abcd3ec8d093e5f0c56ef", "message": "Merge changes from master and fix some tests", "committedDate": "2020-07-01T07:47:54Z", "type": "commit"}, {"oid": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "url": "https://github.com/opensearch-project/security/commit/8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "message": "Merge branch 'master' into merge-conflict-fix", "committedDate": "2020-07-01T08:52:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NzEyNw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448567127", "bodyText": "nit: , populateEmptyIfFileMissing", "author": "debjanibnrj", "createdAt": "2020-07-01T19:17:39Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationRepository.java", "diffHunk": "@@ -141,6 +141,7 @@ public void run() {\n                                         }\n                                         final boolean populateEmptyIfFileMissing = true;\n                                         ConfigHelper.uploadFile(client, cd+\"nodes_dn.yml\", opendistrosecurityIndex, CType.NODESDN, DEFAULT_CONFIG_VERSION, populateEmptyIfFileMissing);\n+                                        ConfigHelper.uploadFile(client, cd +\"whitelisting_settings.yml\", opendistrosecurityIndex, CType.WHITELISTING_SETTINGS, DEFAULT_CONFIG_VERSION,populateEmptyIfFileMissing);", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NDcyMg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448954722", "bodyText": "Fixed", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NzEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwODU3OQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448608579", "bodyText": "remove unused imports", "author": "debjanibnrj", "createdAt": "2020-07-01T20:49:09Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.RolesMappingValidator;", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NDgyMg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448954822", "bodyText": "Fixed", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwODU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMDY1MA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448610650", "bodyText": "nit: remove st", "author": "debjanibnrj", "createdAt": "2020-07-01T20:53:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.RolesMappingValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.WhitelistValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+\n+/**\n+ * This class implements GET and PUT operations to manage dynamic WhitelistingSettings.\n+ * <p>\n+ * These APIs are only accessible to SuperAdmin since the configuration controls what APIs are accessible by normal users.\n+ * Eg: If whitelisting is enabled, and a specific API like \"/_cat/nodes\" is not whitelisted, then only the SuperAdmin can use \"/_cat/nodes\"st", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NDkyOQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448954929", "bodyText": "Fixed", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMDY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMjcwOQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448612709", "bodyText": "We can remove all extra '/' from the API name and then compare for equality so that the user does not need to worry about this. Let me know what you think.\nIt may also be useful to specify the API format you're looking for as a comment in whitelist.yml file.", "author": "debjanibnrj", "createdAt": "2020-07-01T20:58:11Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.RolesMappingValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.WhitelistValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+\n+/**\n+ * This class implements GET and PUT operations to manage dynamic WhitelistingSettings.\n+ * <p>\n+ * These APIs are only accessible to SuperAdmin since the configuration controls what APIs are accessible by normal users.\n+ * Eg: If whitelisting is enabled, and a specific API like \"/_cat/nodes\" is not whitelisted, then only the SuperAdmin can use \"/_cat/nodes\"st\n+ * These APIs allow the SuperAdmin to enable/disable whitelisting, and also change the list of whitelisted APIs.\n+ * <p>\n+ * A SuperAdmin is identified by a certificate which represents a distinguished name(DN).\n+ * SuperAdmin DN's can be set in {@link ConfigConstants#OPENDISTRO_SECURITY_AUTHCZ_ADMIN_DN}\n+ * SuperAdmin certificate for the default superuser is stored as a kirk.pem file in config folder of elasticsearch\n+ * <p>\n+ * Example calling the PUT API as SuperAdmin using curl (if http basic auth is on):\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPUT https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ * \"whitelistingEnabled\" : false,\n+ * \"whitelistedAPIs\" : [\"/_cat/nodes\",\"/_opendistro/_security/api/whitelist\",\"/_opendistro/_security/api/securityconfig\"]\n+ * }\n+ * \u2018\n+ * <p>\n+ * Currently, whitelisting checks the path for equality, so make sure you don't have errors in the whitelisted APIs.", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3NTczOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r449375738", "bodyText": "Will definitely add a comment in the yml file for the expected format. I had avoided handling the extra '/', because I thought it would increase the time complexity, since I'd have to iterate through each new element in the set and remove extra '/' from the API name.", "author": "rahulkarajgikar", "createdAt": "2020-07-03T04:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMjcwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY1Njk5Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r449656996", "bodyText": "Fixed this, added additional logic to allow extra '/'.", "author": "rahulkarajgikar", "createdAt": "2020-07-03T16:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMjcwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDk0NA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448664944", "bodyText": "Think you can remove new ArrayList<>. Also should this be a Set? Saw that you converted it to a HashSet here - https://github.com/opendistro-for-elasticsearch/security/pull/520/files#diff-252524d3598f0d934aec492210aac861R105", "author": "debjanibnrj", "createdAt": "2020-07-01T23:21:46Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -70,6 +79,16 @@\n     private final Settings settings;\n     private final Path configPath;\n     private final CompatConfig compatConfig;\n+    private static final List<String> defaultWhitelistedAPIs = new ArrayList<>(Arrays.asList(", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM3NTgyOQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r449375829", "bodyText": "Yes, I have changed this, default values now handled in WhitelistingSettingsModelImpl", "author": "rahulkarajgikar", "createdAt": "2020-07-03T04:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxMTE3Nw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448711177", "bodyText": "you can just return user != null && adminDNs.isAdmin(user) here.", "author": "debjanibnrj", "createdAt": "2020-07-02T02:18:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -82,22 +101,86 @@ public OpenDistroSecurityRestFilter(final BackendRegistry registry, final AuditL\n         this.settings = settings;\n         this.configPath = configPath;\n         this.compatConfig = compatConfig;\n+        this.whitelistingEnabled = false;\n+        this.whitelistedAPIs = new HashSet<>(defaultWhitelistedAPIs);\n+\n     }\n-    \n-    public RestHandler wrap(RestHandler original) {\n+\n+    /**\n+     * This function wraps around all rest requests\n+     * If the request is authenticated, then it goes through a whitelisting check.\n+     * The whitelisting check works as follows:\n+     * If whitelisting is not enabled, then requests are handled normally.\n+     * If whitelisting is enabled, then SuperAdmin is allowed access to all APIs, regardless of what is currently whitelisted.\n+     * If whitelisting is enabled, then Non-SuperAdmin is allowed to access only those APIs that are whitelisted in {@link #whitelistedAPIs}\n+     * For example: if whitelisting is enabled and whitelistedAPIs = [\"/_cat/nodes\"], then SuperAdmin can access all APIs, but non SuperAdmin\n+     * can only access \"/_cat/nodes\"\n+     * Note: if whitelistedAPIs = [\"/_cat/nodes\"] is whitelisted, \"/_cat/nodes/\" will not work, because of the extra '/'.\n+     * Further note: Some APIs are only accessible by SuperAdmin, regardless of whitelisting. For example: /_opendistro/_security/api/whitelist is only accessible by SuperAdmin.\n+     * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.WhitelistApiAction} for the implementation of this API.\n+     * SuperAdmin is identified by credentials, which can be passed in the curl request.\n+     */\n+    public RestHandler wrap(RestHandler original, AdminDNs adminDNs) {\n         return new RestHandler() {\n             \n             @Override\n             public void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n                 org.apache.logging.log4j.ThreadContext.clearAll();\n-                if(!checkAndAuthenticateRequest(request, channel, client)) {\n-                    original.handleRequest(request, channel, client);\n+                if (!checkAndAuthenticateRequest(request, channel, client)) {\n+                    User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+                    if (userIsSuperAdmin(user, adminDNs) || checkRequestIsWhitelisted(request, channel, client)) {\n+                        original.handleRequest(request, channel, client);\n+                    }\n                 }\n             }\n         };\n     }\n \n-    private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+    /**\n+     * Checks if a given user is a SuperAdmin\n+     */\n+    private Boolean userIsSuperAdmin(User user, AdminDNs adminDNs) {\n+        if (user != null && adminDNs.isAdmin(user)) {", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NjcxOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448956718", "bodyText": "Have made this change", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:13:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxMTE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxMTQwOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448711408", "bodyText": "Separate helper function may not be needed for this since I see it is being used only once in https://github.com/opendistro-for-elasticsearch/security/pull/520/files#diff-252524d3598f0d934aec492210aac861R171", "author": "debjanibnrj", "createdAt": "2020-07-02T02:19:55Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -82,22 +101,86 @@ public OpenDistroSecurityRestFilter(final BackendRegistry registry, final AuditL\n         this.settings = settings;\n         this.configPath = configPath;\n         this.compatConfig = compatConfig;\n+        this.whitelistingEnabled = false;\n+        this.whitelistedAPIs = new HashSet<>(defaultWhitelistedAPIs);\n+\n     }\n-    \n-    public RestHandler wrap(RestHandler original) {\n+\n+    /**\n+     * This function wraps around all rest requests\n+     * If the request is authenticated, then it goes through a whitelisting check.\n+     * The whitelisting check works as follows:\n+     * If whitelisting is not enabled, then requests are handled normally.\n+     * If whitelisting is enabled, then SuperAdmin is allowed access to all APIs, regardless of what is currently whitelisted.\n+     * If whitelisting is enabled, then Non-SuperAdmin is allowed to access only those APIs that are whitelisted in {@link #whitelistedAPIs}\n+     * For example: if whitelisting is enabled and whitelistedAPIs = [\"/_cat/nodes\"], then SuperAdmin can access all APIs, but non SuperAdmin\n+     * can only access \"/_cat/nodes\"\n+     * Note: if whitelistedAPIs = [\"/_cat/nodes\"] is whitelisted, \"/_cat/nodes/\" will not work, because of the extra '/'.\n+     * Further note: Some APIs are only accessible by SuperAdmin, regardless of whitelisting. For example: /_opendistro/_security/api/whitelist is only accessible by SuperAdmin.\n+     * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.WhitelistApiAction} for the implementation of this API.\n+     * SuperAdmin is identified by credentials, which can be passed in the curl request.\n+     */\n+    public RestHandler wrap(RestHandler original, AdminDNs adminDNs) {\n         return new RestHandler() {\n             \n             @Override\n             public void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n                 org.apache.logging.log4j.ThreadContext.clearAll();\n-                if(!checkAndAuthenticateRequest(request, channel, client)) {\n-                    original.handleRequest(request, channel, client);\n+                if (!checkAndAuthenticateRequest(request, channel, client)) {\n+                    User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+                    if (userIsSuperAdmin(user, adminDNs) || checkRequestIsWhitelisted(request, channel, client)) {\n+                        original.handleRequest(request, channel, client);\n+                    }\n                 }\n             }\n         };\n     }\n \n-    private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+    /**\n+     * Checks if a given user is a SuperAdmin\n+     */\n+    private Boolean userIsSuperAdmin(User user, AdminDNs adminDNs) {\n+        if (user != null && adminDNs.isAdmin(user)) {\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Helper function to generate an error when an unauthorized user (i.e non superadmin) tries to access an API that is not whitelisted.\n+     */\n+    private BytesRestResponse createNotWhitelistedErrorResponse(RestChannel channel, String errorMessage,", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NzM0Mw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448957343", "bodyText": "Yeah, this makes sense. I have removed this helper function and combined it into checkRequestIsWhitelisted()", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxMTQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMTYwOQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448721609", "bodyText": "Instead of managing default values here could default value checks be moved to WhitelistingSettingsImpl?", "author": "debjanibnrj", "createdAt": "2020-07-02T03:00:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -155,4 +238,11 @@ private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel cha\n         \n         return false;\n     }\n+\n+    @Subscribe\n+    public void onWhitelistingSettingChanged(WhitelistingSettingsModel whitelistingSettingsModel) {\n+        WhitelistingSettings whitelistingSettings = whitelistingSettingsModel.getWhitelistingSettings();", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NzY1OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448957658", "bodyText": "Yes, I have made this change.", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjE0Mg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448722142", "bodyText": "Best practice to avoid .* imports", "author": "debjanibnrj", "createdAt": "2020-07-02T03:03:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/CType.java", "diffHunk": "@@ -13,12 +13,7 @@\n import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.InternalUserV6;\n import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.RoleMappingsV6;\n import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v6.RoleV6;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.ActionGroupsV7;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.ConfigV7;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.InternalUserV7;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.RoleMappingsV7;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.RoleV7;\n-import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.TenantV7;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.v7.*;", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1Nzc0Mw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448957743", "bodyText": "Fixed this", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjM3Nw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448722377", "bodyText": "Should this be an empty list? Why are these enabled by default?", "author": "debjanibnrj", "createdAt": "2020-07-02T03:04:18Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class WhitelistingSettings {\n+    @JsonProperty(value = \"whitelistingEnabled\")\n+    private boolean whitelistingEnabled;\n+    @JsonProperty(value = \"whitelistedAPIs\")\n+    private List<String> whitelistedAPIs;\n+\n+    public WhitelistingSettings() {\n+        whitelistingEnabled = false;\n+        whitelistedAPIs = new ArrayList<>(Arrays.asList(", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc1MTMzNw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448751337", "bodyText": "Since whitelistingEnabled is false by default, this list doesn't really matter, so I didn't change it while making the PR. I can see how this is confusing though, so I'll make it an empty list so that it makes more sense", "author": "rahulkarajgikar", "createdAt": "2020-07-02T05:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2MDE1NQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448960155", "bodyText": "Initially, I had whitelisted these APIs because they were required for some cluster tests when I was making the standalone plugin, and I forgot to change this. Didn't need to change it because whitelistedAPIs is read from the index as soon as the cluster starts, so it is irrelevant. For clarity, I have made this change though.", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjY5OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448722698", "bodyText": "Any reason why these values changed?", "author": "debjanibnrj", "createdAt": "2020-07-02T03:05:47Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/UserApiTest.java", "diffHunk": "@@ -470,12 +467,12 @@ public void testUserApiWithDots() throws Exception {\n         rh.keystore = \"restapi/kirk-keystore.jks\";\n         rh.sendAdminCertificate = true;\n \n-        // initial configuration, 5 users\n+        // initial configuration, 6 users\n         HttpResponse response = rh\n                 .executeGetRequest(\"_opendistro/_security/api/\" + CType.INTERNALUSERS.toLCString());\n         Assert.assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n         Settings settings = Settings.builder().loadFromSource(response.getBody(), XContentType.JSON).build();\n-        Assert.assertEquals(49, settings.size());\n+        Assert.assertEquals(56, settings.size());", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc1MDUxNA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448750514", "bodyText": "I added another user to internal_users.yml to test whitelisting, so the value changed.", "author": "rahulkarajgikar", "createdAt": "2020-07-02T05:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMjY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMzQxMw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448723413", "bodyText": "may want to remove any print statements used for debugging.", "author": "debjanibnrj", "createdAt": "2020-07-02T03:09:16Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiTest.java", "diffHunk": "@@ -0,0 +1,211 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditMessage;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.integration.TestAuditlogImpl;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.file.FileHelper;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.rest.RestHelper;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.http.Header;\n+import org.apache.http.HttpStatus;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+/**\n+ * Unit testing class to verify that {@link WhitelistApiAction} works correctly.\n+ * Check {@link com.amazon.opendistroforelasticsearch.security.filter.OpenDistroSecurityRestFilter} for extra tests for whitelisting functionality.\n+ */\n+public class WhitelistApiTest extends AbstractRestApiUnitTest {\n+    private RestHelper.HttpResponse response;\n+\n+    /**\n+     * admin_all_access is a user who has all permissions - essentially an admin user, not the same as superadmin.\n+     * superadmin is identified by a certificate that should be passed as a part of the request header.\n+     */\n+    private final Header adminCredsHeader = encodeBasicHeader(\"admin_all_access\", \"admin_all_access\");\n+    private final Header nonAdminCredsHeader = encodeBasicHeader(\"sarek\", \"sarek\");\n+\n+    /**\n+     * Helper function to test the GET and PUT endpoints.\n+     *\n+     * @param expectedStatus\n+     * @param headers\n+     * @throws Exception\n+     */\n+    private void testGetAndPut(final int expectedStatus, final Header... headers) throws Exception {\n+\n+        //CHECK GET REQUEST\n+        response = rh.executeGetRequest(\"_opendistro/_security/api/whitelist\", headers);\n+        assertThat(response.getBody(), response.getStatusCode(), equalTo(expectedStatus));\n+        if (expectedStatus == HttpStatus.SC_OK) {\n+            //Note: the response has no whitespaces, so the .json file does not have whitespaces\n+            Assert.assertEquals(FileHelper.loadFile(\"restapi/whitelist_response_success.json\"), FileHelper.loadFile(\"restapi/whitelist_response_success.json\"));\n+        }\n+        //FORBIDDEN FOR NON SUPER ADMIN\n+        if (expectedStatus == HttpStatus.SC_FORBIDDEN) {\n+            Assert.assertTrue(response.getBody().contains(\"API allowed only for super admin.\"));\n+        }\n+        //CHECK PUT REQUEST\n+        response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{\\\"whitelistingEnabled\\\": true, \\\"whitelistedAPIs\\\": [\\\"/_cat/nodes\\\",\\\"/_cat/indices\\\"]}\", headers);\n+        assertThat(response.getBody(), response.getStatusCode(), equalTo(expectedStatus));\n+    }\n+\n+    /**\n+     * Tests that the response does not have a _meta header\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testResponseDoesNotContainMetaHeader() throws Exception {\n+\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executeGetRequest(\"_opendistro/_security/api/whitelist\");\n+        Assert.assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n+        Assert.assertFalse(response.getBody().contains(\"_meta\"));\n+    }\n+\n+    /**\n+     * Tests that putting an unknown key fails\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPutUnknownKey() throws Exception {\n+\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{ \\\"unknownkey\\\": true, \\\"whitelistedAPIs\\\": [\\\"/_cat/nodes\\\",\\\"/_cat/plugins\\\"] }\");\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        Assert.assertTrue(response.getBody().contains(\"invalid_keys\"));\n+        assertHealthy();\n+    }\n+\n+    /**\n+     * Tests that invalid json body fails\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPutInvalidJson() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{ \\\"invalid\\\"::{{ [\\\"*\\\"], \\\"whitelistedAPIs\\\": [\\\"/_cat/nodes\\\",\\\"/_cat/plugins\\\"] }\");\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        Assert.assertTrue(response.getBody().contains(\"JsonParseException\"));\n+        assertHealthy();\n+    }\n+\n+    /**\n+     * Tests that the PUT API requires a payload. i.e non empty payloads give an error.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPayloadMandatory() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        response = rh.executePutRequest(\"/_opendistro/_security/api/whitelist\", \"\", new Header[0]);\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        JsonNode settings = DefaultObjectMapper.readTree(response.getBody());\n+        Assert.assertEquals(AbstractConfigurationValidator.ErrorType.PAYLOAD_MANDATORY.getMessage(), settings.get(\"reason\").asText());\n+    }\n+\n+    /**\n+     * Tests 4 scenarios for accessing and using the API.\n+     * No creds, no admin certificate - UNAUTHORIZED\n+     * non admin creds, no admin certificate - FORBIDDEN\n+     * admin creds, no admin certificate - FORBIDDEN\n+     * any creds, admin certificate - OK\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testWhitelistApi() throws Exception {\n+        setupWithRestRoles(null);\n+\n+        {\n+            // No creds, no admin certificate - UNAUTHORIZED\n+            rh.keystore = \"restapi/kirk-keystore.jks\";\n+            rh.sendAdminCertificate = false;\n+            testGetAndPut(HttpStatus.SC_UNAUTHORIZED);\n+        }\n+\n+\n+        {\n+            //non admin creds, no admin certificate - FORBIDDEN\n+            rh.keystore = \"restapi/kirk-keystore.jks\";\n+            rh.sendAdminCertificate = false;\n+            testGetAndPut(HttpStatus.SC_FORBIDDEN, nonAdminCredsHeader);\n+        }\n+\n+        {\n+            // admin creds, no admin certificate - FORBIDDEN\n+            rh.keystore = \"restapi/kirk-keystore.jks\";\n+            rh.sendAdminCertificate = false;\n+            testGetAndPut(HttpStatus.SC_FORBIDDEN, adminCredsHeader);\n+        }\n+\n+        {\n+            // any creds, admin certificate - OK\n+            rh.keystore = \"restapi/kirk-keystore.jks\";\n+            rh.sendAdminCertificate = true;\n+            testGetAndPut(HttpStatus.SC_OK, nonAdminCredsHeader);\n+        }\n+    }\n+\n+    @Test\n+    public void testWhitelistAuditComplianceLogging() throws Exception {\n+        Settings settings = Settings.builder()\n+                .put(\"opendistro_security.audit.type\", TestAuditlogImpl.class.getName())\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_TRANSPORT, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_ENABLE_REST, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_RESOLVE_BULK_REQUESTS, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_WRITE_LOG_DIFFS, true)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_EXTERNAL_CONFIG_ENABLED, false)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_COMPLIANCE_HISTORY_INTERNAL_CONFIG_ENABLED, true)\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_TRANSPORT_CATEGORIES, \"authenticated,GRANTED_PRIVILEGES\")\n+                .put(ConfigConstants.OPENDISTRO_SECURITY_AUDIT_CONFIG_DISABLED_REST_CATEGORIES, \"authenticated,GRANTED_PRIVILEGES\")\n+                .build();\n+        setupWithRestRoles(settings);\n+        TestAuditlogImpl.clear();\n+\n+        {\n+            // any creds, admin certificate - OK\n+            rh.keystore = \"restapi/kirk-keystore.jks\";\n+            rh.sendAdminCertificate = true;\n+            testGetAndPut(HttpStatus.SC_OK, nonAdminCredsHeader);\n+        }\n+\n+        System.out.println(TestAuditlogImpl.sb.toString());", "originalCommit": "8c471b3a2da2c7c0833bcb2c1003274e09fe4810", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc1MTgyOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448751828", "bodyText": "Yes, I will. I copied this test case from NodesDnApiTest, which still has this println statement, and I forgot to remove it.", "author": "rahulkarajgikar", "createdAt": "2020-07-02T05:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMzQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2MDc2NQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r448960765", "bodyText": "Fixed", "author": "rahulkarajgikar", "createdAt": "2020-07-02T12:20:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcyMzQxMw=="}], "type": "inlineReview"}, {"oid": "3a4f9eea29952a1f380bd93979f9d57ae9e19981", "url": "https://github.com/opensearch-project/security/commit/3a4f9eea29952a1f380bd93979f9d57ae9e19981", "message": "Make minor changes\n\nThis commit makes minor style changes like fixing typos, removing unnecessary imports, adding newline at end of all yml files.\nAlso, default value checking is shifted from OpenDistroSecurityRestFilter to WhitelistSettingsModelImpl.", "committedDate": "2020-07-02T10:33:01Z", "type": "commit"}, {"oid": "0e0fd095dede8c4c9ce2d57bf544c954f02b8b12", "url": "https://github.com/opensearch-project/security/commit/0e0fd095dede8c4c9ce2d57bf544c954f02b8b12", "message": "Merge branch 'master' into merge-conflict-fix", "committedDate": "2020-07-02T10:40:38Z", "type": "commit"}, {"oid": "0f6c819cba067e78096d0a3cc8b90d4fb22b5661", "url": "https://github.com/opensearch-project/security/commit/0f6c819cba067e78096d0a3cc8b90d4fb22b5661", "message": "Add Http request method whitelisting and extra '/' support, make minor changes", "committedDate": "2020-07-03T14:35:53Z", "type": "commit"}, {"oid": "24a4575c146bdb64750744fc98d4cc810bac8af2", "url": "https://github.com/opensearch-project/security/commit/24a4575c146bdb64750744fc98d4cc810bac8af2", "message": "Fix minor bugs", "committedDate": "2020-07-03T15:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxODk5NA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450018994", "bodyText": "Just this line can be moved above DynamicConfigFactory ? Just reducing diffs which will help in resolving conflicts during backports/patches", "author": "sujithvm", "createdAt": "2020-07-06T06:57:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -773,6 +760,19 @@ public AsyncSender interceptSender(AsyncSender sender) {\n             principalExtractor = ReflectionHelper.instantiatePrincipalExtractor(principalExtractorClass);\n         }\n \n+        securityRestHandler = new OpenDistroSecurityRestFilter(backendRegistry, auditLog, threadPool,", "originalCommit": "24a4575c146bdb64750744fc98d4cc810bac8af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA3MjgxNQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450072815", "bodyText": "Actually I couldn't do this because this line depends on principalExtractor, which earlier was initialized after DynamicConfigFactory. After adding securityRestHandler, DCF initialization is dependent on principalExtractor, so I moved DCF initialization after principalExtractor.", "author": "rahulkarajgikar", "createdAt": "2020-07-06T08:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxODk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxOTc5OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450019798", "bodyText": "If exactly the same empty version is returned similar to NODESDN, we can update the condition by making it cType == CType.NODESDN || cType == CType.WHITELIST ?", "author": "sujithvm", "createdAt": "2020-07-06T06:59:19Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/configuration/ConfigurationLoaderSecurity7.java", "diffHunk": "@@ -131,7 +131,20 @@ public void noData(String id, String type) {\n \n                 // Since NODESDN is newly introduced data-type applying for existing clusters as well, we make it backward compatible by returning valid empty\n                 // SecurityDynamicConfiguration.\n-                if(cType == CType.NODESDN) {\n+                if (cType == CType.NODESDN) {\n+                    try {\n+                        SecurityDynamicConfiguration<?> empty = ConfigHelper.createEmptySdc(cType, ConfigurationRepository.getDefaultConfigVersion());\n+                        rs.put(cType, empty);\n+                        latch.countDown();\n+                        return;\n+                    } catch (Exception e) {\n+                        throw new RuntimeException(e);\n+                    }\n+                }\n+\n+                // Since WHITELISTING_SETTINGS is newly introduced data-type applying for existing clusters as well, we make it backward compatible by returning valid empty\n+                // SecurityDynamicConfiguration.\n+                if (cType == CType.WHITELIST) {", "originalCommit": "24a4575c146bdb64750744fc98d4cc810bac8af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA2ODUyMg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450068522", "bodyText": "Yes, I will make this change.", "author": "rahulkarajgikar", "createdAt": "2020-07-06T08:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxOTc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzMTM1Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450131356", "bodyText": "Changed.", "author": "rahulkarajgikar", "createdAt": "2020-07-06T10:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxOTc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMzM1OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450023358", "bodyText": "We cannot reuse elasticsearch org.elasticsearch.rest.RestRequest.Method enum ?", "author": "sujithvm", "createdAt": "2020-07-06T07:07:48Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/HttpRequestMethods.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+public enum HttpRequestMethods {", "originalCommit": "24a4575c146bdb64750744fc98d4cc810bac8af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0Njg0MA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450046840", "bodyText": "I initially tried doing this. This is not possible. You need an enum with String values, since the yml file contents are parsed as strings.", "author": "rahulkarajgikar", "createdAt": "2020-07-06T07:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMzM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMDM3Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452500376", "bodyText": "Wonder why this is happening though. Jackson should handle with correct type.", "author": "sujithvm", "createdAt": "2020-07-09T21:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMzM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyNjk4OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450026988", "bodyText": "PATCH request needed ?", "author": "sujithvm", "createdAt": "2020-07-06T07:16:13Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.WhitelistValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+\n+/**\n+ * This class implements GET and PUT operations to manage dynamic WhitelistingSettings.\n+ * <p>\n+ * These APIs are only accessible to SuperAdmin since the configuration controls what APIs are accessible by normal users.\n+ * Eg: If whitelisting is enabled, and a specific API like \"/_cat/nodes\" is not whitelisted, then only the SuperAdmin can use \"/_cat/nodes\"\n+ * These APIs allow the SuperAdmin to enable/disable whitelisting, and also change the list of whitelisted APIs.\n+ * <p>\n+ * A SuperAdmin is identified by a certificate which represents a distinguished name(DN).\n+ * SuperAdmin DN's can be set in {@link ConfigConstants#OPENDISTRO_SECURITY_AUTHCZ_ADMIN_DN}\n+ * SuperAdmin certificate for the default superuser is stored as a kirk.pem file in config folder of elasticsearch\n+ * <p>\n+ * Example calling the PUT API as SuperAdmin using curl (if http basic auth is on):\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPUT https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ * \"whitelisting_enabled\" : false,\n+ * \"whitelisted_APIs\" : {\"/_cat/nodes\": [\"GET\"], \"/_opendistro/_security/api/whitelist\": [\"GET\"]}\n+ * }\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ * <p>\n+ */\n+public class WhitelistApiAction extends AbstractApiAction {\n+    private static final List<Route> routes = ImmutableList.of(\n+            new Route(RestRequest.Method.GET, \"/_opendistro/_security/api/whitelist\"),\n+            new Route(RestRequest.Method.PUT, \"/_opendistro/_security/api/whitelist\")", "originalCommit": "24a4575c146bdb64750744fc98d4cc810bac8af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA3MTQ1Nw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r450071457", "bodyText": "I will work on adding PATCH request.", "author": "rahulkarajgikar", "createdAt": "2020-07-06T08:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyNjk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMwNTg3NQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452305875", "bodyText": "PATCH request has been added.", "author": "rahulkarajgikar", "createdAt": "2020-07-09T15:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyNjk4OA=="}], "type": "inlineReview"}, {"oid": "5310896d0622e0fdb2f4f90700de908a2da2e22e", "url": "https://github.com/opensearch-project/security/commit/5310896d0622e0fdb2f4f90700de908a2da2e22e", "message": "Make more minor changes", "committedDate": "2020-07-06T10:03:19Z", "type": "commit"}, {"oid": "dba66d88bb1c1fb848769420fde655276122c839", "url": "https://github.com/opensearch-project/security/commit/dba66d88bb1c1fb848769420fde655276122c839", "message": "minor improvement", "committedDate": "2020-07-07T08:21:25Z", "type": "commit"}, {"oid": "ed30a513b12f171eac8587f673f9aca83dbb2170", "url": "https://github.com/opensearch-project/security/commit/ed30a513b12f171eac8587f673f9aca83dbb2170", "message": "Add PATCH Api and tests", "committedDate": "2020-07-08T05:54:11Z", "type": "commit"}, {"oid": "f5ae3d06ae29cf5f19781a329b64540cf08b11a5", "url": "https://github.com/opensearch-project/security/commit/f5ae3d06ae29cf5f19781a329b64540cf08b11a5", "message": "Change schema of whitelist.yml", "committedDate": "2020-07-08T06:17:05Z", "type": "commit"}, {"oid": "3878cd18a55998e077b8a5d1f9877d59029bea83", "url": "https://github.com/opensearch-project/security/commit/3878cd18a55998e077b8a5d1f9877d59029bea83", "message": "Merge changes from master", "committedDate": "2020-07-08T08:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5MDUxOQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452490519", "bodyText": "Can reuse the parent class handleGet ? No need to override and re-implement\nnit: last return not needed.", "author": "sujithvm", "createdAt": "2020-07-09T21:06:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.WhitelistValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+\n+/**\n+ * This class implements GET and PUT operations to manage dynamic WhitelistingSettings.\n+ * <p>\n+ * These APIs are only accessible to SuperAdmin since the configuration controls what APIs are accessible by normal users.\n+ * Eg: If whitelisting is enabled, and a specific API like \"/_cat/nodes\" is not whitelisted, then only the SuperAdmin can use \"/_cat/nodes\"\n+ * These APIs allow the SuperAdmin to enable/disable whitelisting, and also change the list of whitelisted APIs.\n+ * <p>\n+ * A SuperAdmin is identified by a certificate which represents a distinguished name(DN).\n+ * SuperAdmin DN's can be set in {@link ConfigConstants#OPENDISTRO_SECURITY_AUTHCZ_ADMIN_DN}\n+ * SuperAdmin certificate for the default superuser is stored as a kirk.pem file in config folder of elasticsearch\n+ * <p>\n+ * Example calling the PUT API as SuperAdmin using curl (if http basic auth is on):\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPUT https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"enabled\" : false,\n+ *      \"requests\" : {\"/_cat/nodes\": [\"GET\"], \"/_opendistro/_security/api/whitelist\": [\"GET\"]}\n+ * }\n+ *\n+ * Example using the PATCH API to change the requests as SuperAdmin:\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPATCH https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"op\":\"replace\",\n+ *      \"path\":\"/config/requests\",\n+ *      \"value\": {\"/_cat/nodes\": [\"GET\"], \"/_opendistro/_security/api/whitelist\": [\"GET\"]}\n+ * }\n+ *\n+ * To update enabled, use the \"add\" operation instead of the \"replace\" operation, since boolean variables are not recognized as valid paths when they are false.\n+ * eg:\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPATCH https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"op\":\"add\",\n+ *      \"path\":\"/config/enabled\",\n+ *      \"value\": true\n+ * }\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ * <p>\n+ */\n+public class WhitelistApiAction extends PatchableResourceApiAction {\n+    private static final List<Route> routes = ImmutableList.of(\n+            new Route(RestRequest.Method.GET, \"/_opendistro/_security/api/whitelist\"),\n+            new Route(RestRequest.Method.PUT, \"/_opendistro/_security/api/whitelist\"),\n+            new Route(RestRequest.Method.PATCH, \"/_opendistro/_security/api/whitelist\")\n+    );\n+\n+    private static final String name = \"config\";\n+\n+    @Inject\n+    public WhitelistApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+                              final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+                              final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(final RestChannel channel, final RestRequest request, final Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for super admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    @Override\n+    protected void handleGet(final RestChannel channel, RestRequest request, Client client, final JsonNode content)\n+            throws IOException {\n+\n+\n+        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), true);\n+        filter(configuration);\n+        successResponse(channel, configuration);\n+        return;", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5Mjg0OQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452492849", "bodyText": "Why is this under the same file check as nodesdn ?", "author": "sujithvm", "createdAt": "2020-07-09T21:12:10Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/test/DynamicSecurityConfig.java", "diffHunk": "@@ -157,10 +159,15 @@ public String getType() {\n \n         if (null != FileHelper.getAbsoluteFilePathFromClassPath(prefix + securityNodesDn)) {\n             ret.add(new IndexRequest(securityIndexName)\n-                .type(type)\n-                .id(CType.NODESDN.toLCString())\n-                .setRefreshPolicy(RefreshPolicy.IMMEDIATE)\n-                .source(CType.NODESDN.toLCString(), FileHelper.readYamlContent(prefix+securityNodesDn)));\n+                    .type(type)\n+                    .id(CType.NODESDN.toLCString())\n+                    .setRefreshPolicy(RefreshPolicy.IMMEDIATE)\n+                    .source(CType.NODESDN.toLCString(), FileHelper.readYamlContent(prefix + securityNodesDn)));\n+            ret.add(new IndexRequest(securityIndexName)", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5NDUzNg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452494536", "bodyText": "Remove setting the keystore everytime if it is the same?\nnit: pass sendAdminCertificate as param so that it can be reset everytime to prev value?\nref: https://github.com/opendistro-for-elasticsearch/security/blob/master/src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AuditApiActionTest.java#L81", "author": "sujithvm", "createdAt": "2020-07-09T21:15:29Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiTest.java", "diffHunk": "@@ -0,0 +1,264 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditCategory;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.impl.AuditMessage;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.integration.TestAuditlogImpl;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.file.FileHelper;\n+import com.amazon.opendistroforelasticsearch.security.test.helper.rest.RestHelper;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.http.Header;\n+import org.apache.http.HttpStatus;\n+import org.elasticsearch.common.settings.Settings;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Testing class to verify that {@link WhitelistApiAction} works correctly.\n+ * Check {@link com.amazon.opendistroforelasticsearch.security.filter.OpenDistroSecurityRestFilter} for extra tests for whitelisting functionality.\n+ */\n+public class WhitelistApiTest extends AbstractRestApiUnitTest {\n+    private RestHelper.HttpResponse response;\n+\n+    /**\n+     * admin_all_access is a user who has all permissions - essentially an admin user, not the same as superadmin.\n+     * superadmin is identified by a certificate that should be passed as a part of the request header.\n+     */\n+    private final Header adminCredsHeader = encodeBasicHeader(\"admin_all_access\", \"admin_all_access\");\n+    private final Header nonAdminCredsHeader = encodeBasicHeader(\"sarek\", \"sarek\");\n+\n+    /**\n+     * Helper function to test the GET and PUT endpoints.\n+     *\n+     * @throws Exception\n+     */\n+    private void testGetAndPut(final int expectedStatus, final Header... headers) throws Exception {\n+\n+        //CHECK GET REQUEST\n+        response = rh.executeGetRequest(\"_opendistro/_security/api/whitelist\", headers);\n+        assertThat(response.getBody(), response.getStatusCode(), equalTo(expectedStatus));\n+        if (expectedStatus == HttpStatus.SC_OK) {\n+            //Note: the response has no whitespaces, so the .json file does not have whitespaces\n+            Assert.assertEquals(FileHelper.loadFile(\"restapi/whitelist_response_success.json\"), FileHelper.loadFile(\"restapi/whitelist_response_success.json\"));\n+        }\n+        //FORBIDDEN FOR NON SUPER ADMIN\n+        if (expectedStatus == HttpStatus.SC_FORBIDDEN) {\n+            assertTrue(response.getBody().contains(\"API allowed only for super admin.\"));\n+        }\n+        //CHECK PUT REQUEST\n+        response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{\\\"enabled\\\": true, \\\"requests\\\": {\\\"/_cat/nodes\\\": [\\\"GET\\\"],\\\"/_cat/indices\\\": [\\\"GET\\\"] }}\", headers);\n+        assertThat(response.getBody(), response.getStatusCode(), equalTo(expectedStatus));\n+    }\n+\n+    /**\n+     * Tests that the response does not have a _meta header\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testResponseDoesNotContainMetaHeader() throws Exception {\n+\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executeGetRequest(\"_opendistro/_security/api/whitelist\");\n+        Assert.assertEquals(HttpStatus.SC_OK, response.getStatusCode());\n+        Assert.assertFalse(response.getBody().contains(\"_meta\"));\n+    }\n+\n+    /**\n+     * Tests that putting an unknown key fails\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPutUnknownKey() throws Exception {\n+\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{ \\\"unknownkey\\\": true, \\\"requests\\\": {\\\"/_cat/nodes\\\": [\\\"GET\\\"],\\\"/_cat/indices\\\": [\\\"GET\\\"] }}\");\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        assertTrue(response.getBody().contains(\"invalid_keys\"));\n+        assertHealthy();\n+    }\n+\n+    /**\n+     * Tests that invalid json body fails\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPutInvalidJson() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        RestHelper.HttpResponse response = rh.executePutRequest(\"_opendistro/_security/api/whitelist\", \"{ \\\"invalid\\\"::{{ [\\\"*\\\"], \\\"requests\\\": {\\\"/_cat/nodes\\\": [\\\"GET\\\"],\\\"/_cat/indices\\\": [\\\"GET\\\"] }}\");\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        assertTrue(response.getBody().contains(\"JsonParseException\"));\n+        assertHealthy();\n+    }\n+\n+    /**\n+     * Tests that the PUT API requires a payload. i.e non empty payloads give an error.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testPayloadMandatory() throws Exception {\n+        setup();\n+\n+        rh.keystore = \"restapi/kirk-keystore.jks\";\n+        rh.sendAdminCertificate = true;\n+        response = rh.executePutRequest(\"/_opendistro/_security/api/whitelist\", \"\", new Header[0]);\n+        Assert.assertEquals(HttpStatus.SC_BAD_REQUEST, response.getStatusCode());\n+        JsonNode settings = DefaultObjectMapper.readTree(response.getBody());\n+        Assert.assertEquals(AbstractConfigurationValidator.ErrorType.PAYLOAD_MANDATORY.getMessage(), settings.get(\"reason\").asText());\n+    }\n+\n+    /**\n+     * Tests 4 scenarios for accessing and using the API.\n+     * No creds, no admin certificate - UNAUTHORIZED\n+     * non admin creds, no admin certificate - FORBIDDEN\n+     * admin creds, no admin certificate - FORBIDDEN\n+     * any creds, admin certificate - OK\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testWhitelistApi() throws Exception {\n+        setupWithRestRoles(null);\n+\n+        {\n+            // No creds, no admin certificate - UNAUTHORIZED\n+            rh.keystore = \"restapi/kirk-keystore.jks\";", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ5NTkxMw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452495913", "bodyText": "You can remove all the @JsonProperty in this class, as same variable name & matching getter/setters are used so Jackson will bind them correctly.", "author": "sujithvm", "createdAt": "2020-07-09T21:18:26Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class WhitelistingSettings {\n+    @JsonProperty(value = \"enabled\")", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMDU0Mw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452500543", "bodyText": "Do we need this model & implementation class instead of just WhitelistingSettings ?", "author": "sujithvm", "createdAt": "2020-07-09T21:28:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/WhitelistingSettingsModel.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf;\n+\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.HttpRequestMethods;\n+import java.util.List;\n+import java.util.Map;\n+\n+public abstract class WhitelistingSettingsModel {", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYyNTQ4OQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452625489", "bodyText": "Initially tried to follow how NodesDn was implemented, I'll remove this to make it simpler", "author": "rahulkarajgikar", "createdAt": "2020-07-10T05:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMDU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwNzQwNg==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452507406", "bodyText": "nit: use camel case? Or just manintain instance of WhitelistSetting", "author": "sujithvm", "createdAt": "2020-07-09T21:44:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -71,6 +79,10 @@\n     private final Path configPath;\n     private final CompatConfig compatConfig;\n \n+    private boolean whitelisting_enabled;", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwOTY1MA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452509650", "bodyText": "nit: would recommend using EnumSet in place of List", "author": "sujithvm", "createdAt": "2020-07-09T21:49:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class WhitelistingSettings {\n+    @JsonProperty(value = \"enabled\")\n+    private boolean enabled;\n+    @JsonProperty(value = \"requests\")\n+    private Map<String, List<HttpRequestMethods>> requests;", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxMDEyOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452510128", "bodyText": "nit: Would be nice reuse elasticsearch Request.Method to avoid this conversion", "author": "sujithvm", "createdAt": "2020-07-09T21:50:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -82,22 +94,106 @@ public OpenDistroSecurityRestFilter(final BackendRegistry registry, final AuditL\n         this.settings = settings;\n         this.configPath = configPath;\n         this.compatConfig = compatConfig;\n+        this.whitelisting_enabled = false;\n+        this.whitelisted_requests = Collections.emptyMap();\n     }\n-    \n-    public RestHandler wrap(RestHandler original) {\n+\n+    /**\n+     * This function wraps around all rest requests\n+     * If the request is authenticated, then it goes through a whitelisting check.\n+     * The whitelisting check works as follows:\n+     * If whitelisting is not enabled, then requests are handled normally.\n+     * If whitelisting is enabled, then SuperAdmin is allowed access to all APIs, regardless of what is currently whitelisted.\n+     * If whitelisting is enabled, then Non-SuperAdmin is allowed to access only those APIs that are whitelisted in {@link #requests}\n+     * For example: if whitelisting is enabled and requests = [\"/_cat/nodes\"], then SuperAdmin can access all APIs, but non SuperAdmin\n+     * can only access \"/_cat/nodes\"\n+     * Further note: Some APIs are only accessible by SuperAdmin, regardless of whitelisting. For example: /_opendistro/_security/api/whitelist is only accessible by SuperAdmin.\n+     * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.WhitelistApiAction} for the implementation of this API.\n+     * SuperAdmin is identified by credentials, which can be passed in the curl request.\n+     */\n+    public RestHandler wrap(RestHandler original, AdminDNs adminDNs) {\n         return new RestHandler() {\n             \n             @Override\n             public void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n                 org.apache.logging.log4j.ThreadContext.clearAll();\n-                if(!checkAndAuthenticateRequest(request, channel, client)) {\n-                    original.handleRequest(request, channel, client);\n+                if (!checkAndAuthenticateRequest(request, channel, client)) {\n+                    User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+                    if (userIsSuperAdmin(user, adminDNs) || checkRequestIsAllowed(request, channel, client)) {\n+                        original.handleRequest(request, channel, client);\n+                    }\n                 }\n             }\n         };\n     }\n \n-    private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+    /**\n+     * Checks if a given user is a SuperAdmin\n+     */\n+    private boolean userIsSuperAdmin(User user, AdminDNs adminDNs) {\n+        return user != null && adminDNs.isAdmin(user);\n+    }\n+\n+    /**\n+     * Helper function to check if a rest request is whitelisted, by checking if the path is whitelisted,\n+     * and then if the Http method is whitelisted.\n+     * This method also contains logic to trim the path request, and check both with and without extra '/'\n+     * This allows users to whitelist either /_cluster/settings/ or /_cluster/settings, to avoid potential issues.\n+     * This also ensures that requests to the cluster can have a trailing '/'\n+     * Scenarios:\n+     * 1. Whitelisted API does not have an extra '/'. eg: If GET /_cluster/settings is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     *\n+     * 2. Whitelisted API has an extra '/'. eg: If GET /_cluster/settings/ is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     */\n+    private boolean requestIsWhitelisted(RestRequest request){\n+\n+        //ALSO ALLOWS REQUEST TO HAVE TRAILING '/'\n+        //pathWithoutTrailingSlash stores the endpoint path without extra '/'. eg: /_cat/nodes\n+        //pathWithTrailingSlash stores the endpoint path with extra '/'. eg: /_cat/nodes/\n+        String path = request.path();\n+        String pathWithoutTrailingSlash;\n+        String pathWithTrailingSlash;\n+\n+        //first obtain pathWithoutTrailingSlash, then add a '/' to it to get pathWithTrailingSlash\n+        pathWithoutTrailingSlash = path.endsWith(\"/\") ? path.substring(0, path.length() - 1) : path;\n+        pathWithTrailingSlash = pathWithoutTrailingSlash + '/';\n+\n+        //check if pathWithoutTrailingSlash is whitelisted\n+        if(this.whitelisted_requests.containsKey(pathWithoutTrailingSlash) && this.whitelisted_requests.get(pathWithoutTrailingSlash).contains(HttpRequestMethods.valueOf(request.method().toString())))", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxMTAwOA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452511008", "bodyText": "Would suggest moving this function inside WhitelistSetting and test if request is whitelisted. Even enabled check can be done there.", "author": "sujithvm", "createdAt": "2020-07-09T21:52:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -82,22 +94,106 @@ public OpenDistroSecurityRestFilter(final BackendRegistry registry, final AuditL\n         this.settings = settings;\n         this.configPath = configPath;\n         this.compatConfig = compatConfig;\n+        this.whitelisting_enabled = false;\n+        this.whitelisted_requests = Collections.emptyMap();\n     }\n-    \n-    public RestHandler wrap(RestHandler original) {\n+\n+    /**\n+     * This function wraps around all rest requests\n+     * If the request is authenticated, then it goes through a whitelisting check.\n+     * The whitelisting check works as follows:\n+     * If whitelisting is not enabled, then requests are handled normally.\n+     * If whitelisting is enabled, then SuperAdmin is allowed access to all APIs, regardless of what is currently whitelisted.\n+     * If whitelisting is enabled, then Non-SuperAdmin is allowed to access only those APIs that are whitelisted in {@link #requests}\n+     * For example: if whitelisting is enabled and requests = [\"/_cat/nodes\"], then SuperAdmin can access all APIs, but non SuperAdmin\n+     * can only access \"/_cat/nodes\"\n+     * Further note: Some APIs are only accessible by SuperAdmin, regardless of whitelisting. For example: /_opendistro/_security/api/whitelist is only accessible by SuperAdmin.\n+     * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.WhitelistApiAction} for the implementation of this API.\n+     * SuperAdmin is identified by credentials, which can be passed in the curl request.\n+     */\n+    public RestHandler wrap(RestHandler original, AdminDNs adminDNs) {\n         return new RestHandler() {\n             \n             @Override\n             public void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n                 org.apache.logging.log4j.ThreadContext.clearAll();\n-                if(!checkAndAuthenticateRequest(request, channel, client)) {\n-                    original.handleRequest(request, channel, client);\n+                if (!checkAndAuthenticateRequest(request, channel, client)) {\n+                    User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+                    if (userIsSuperAdmin(user, adminDNs) || checkRequestIsAllowed(request, channel, client)) {\n+                        original.handleRequest(request, channel, client);\n+                    }\n                 }\n             }\n         };\n     }\n \n-    private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+    /**\n+     * Checks if a given user is a SuperAdmin\n+     */\n+    private boolean userIsSuperAdmin(User user, AdminDNs adminDNs) {\n+        return user != null && adminDNs.isAdmin(user);\n+    }\n+\n+    /**\n+     * Helper function to check if a rest request is whitelisted, by checking if the path is whitelisted,\n+     * and then if the Http method is whitelisted.\n+     * This method also contains logic to trim the path request, and check both with and without extra '/'\n+     * This allows users to whitelist either /_cluster/settings/ or /_cluster/settings, to avoid potential issues.\n+     * This also ensures that requests to the cluster can have a trailing '/'\n+     * Scenarios:\n+     * 1. Whitelisted API does not have an extra '/'. eg: If GET /_cluster/settings is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     *\n+     * 2. Whitelisted API has an extra '/'. eg: If GET /_cluster/settings/ is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     */\n+    private boolean requestIsWhitelisted(RestRequest request){", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNDI4MA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452514280", "bodyText": "Does this imply customers can set different http whitelisting methods for paths with & without trailing '/' ? Not sure if this is the desired behavior", "author": "sujithvm", "createdAt": "2020-07-09T22:00:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -82,22 +94,106 @@ public OpenDistroSecurityRestFilter(final BackendRegistry registry, final AuditL\n         this.settings = settings;\n         this.configPath = configPath;\n         this.compatConfig = compatConfig;\n+        this.whitelisting_enabled = false;\n+        this.whitelisted_requests = Collections.emptyMap();\n     }\n-    \n-    public RestHandler wrap(RestHandler original) {\n+\n+    /**\n+     * This function wraps around all rest requests\n+     * If the request is authenticated, then it goes through a whitelisting check.\n+     * The whitelisting check works as follows:\n+     * If whitelisting is not enabled, then requests are handled normally.\n+     * If whitelisting is enabled, then SuperAdmin is allowed access to all APIs, regardless of what is currently whitelisted.\n+     * If whitelisting is enabled, then Non-SuperAdmin is allowed to access only those APIs that are whitelisted in {@link #requests}\n+     * For example: if whitelisting is enabled and requests = [\"/_cat/nodes\"], then SuperAdmin can access all APIs, but non SuperAdmin\n+     * can only access \"/_cat/nodes\"\n+     * Further note: Some APIs are only accessible by SuperAdmin, regardless of whitelisting. For example: /_opendistro/_security/api/whitelist is only accessible by SuperAdmin.\n+     * See {@link com.amazon.opendistroforelasticsearch.security.dlic.rest.api.WhitelistApiAction} for the implementation of this API.\n+     * SuperAdmin is identified by credentials, which can be passed in the curl request.\n+     */\n+    public RestHandler wrap(RestHandler original, AdminDNs adminDNs) {\n         return new RestHandler() {\n             \n             @Override\n             public void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n                 org.apache.logging.log4j.ThreadContext.clearAll();\n-                if(!checkAndAuthenticateRequest(request, channel, client)) {\n-                    original.handleRequest(request, channel, client);\n+                if (!checkAndAuthenticateRequest(request, channel, client)) {\n+                    User user = threadContext.getTransient(ConfigConstants.OPENDISTRO_SECURITY_USER);\n+                    if (userIsSuperAdmin(user, adminDNs) || checkRequestIsAllowed(request, channel, client)) {\n+                        original.handleRequest(request, channel, client);\n+                    }\n                 }\n             }\n         };\n     }\n \n-    private boolean checkAndAuthenticateRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+    /**\n+     * Checks if a given user is a SuperAdmin\n+     */\n+    private boolean userIsSuperAdmin(User user, AdminDNs adminDNs) {\n+        return user != null && adminDNs.isAdmin(user);\n+    }\n+\n+    /**\n+     * Helper function to check if a rest request is whitelisted, by checking if the path is whitelisted,\n+     * and then if the Http method is whitelisted.\n+     * This method also contains logic to trim the path request, and check both with and without extra '/'\n+     * This allows users to whitelist either /_cluster/settings/ or /_cluster/settings, to avoid potential issues.\n+     * This also ensures that requests to the cluster can have a trailing '/'\n+     * Scenarios:\n+     * 1. Whitelisted API does not have an extra '/'. eg: If GET /_cluster/settings is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     *\n+     * 2. Whitelisted API has an extra '/'. eg: If GET /_cluster/settings/ is whitelisted, these requests have the following response:\n+     *      GET /_cluster/settings  - OK\n+     *      GET /_cluster/settings/ - OK\n+     */\n+    private boolean requestIsWhitelisted(RestRequest request){\n+\n+        //ALSO ALLOWS REQUEST TO HAVE TRAILING '/'\n+        //pathWithoutTrailingSlash stores the endpoint path without extra '/'. eg: /_cat/nodes\n+        //pathWithTrailingSlash stores the endpoint path with extra '/'. eg: /_cat/nodes/\n+        String path = request.path();\n+        String pathWithoutTrailingSlash;\n+        String pathWithTrailingSlash;\n+\n+        //first obtain pathWithoutTrailingSlash, then add a '/' to it to get pathWithTrailingSlash\n+        pathWithoutTrailingSlash = path.endsWith(\"/\") ? path.substring(0, path.length() - 1) : path;\n+        pathWithTrailingSlash = pathWithoutTrailingSlash + '/';\n+\n+        //check if pathWithoutTrailingSlash is whitelisted\n+        if(this.whitelisted_requests.containsKey(pathWithoutTrailingSlash) && this.whitelisted_requests.get(pathWithoutTrailingSlash).contains(HttpRequestMethods.valueOf(request.method().toString())))\n+            return true;\n+\n+        //check if pathWithTrailingSlash is whitelisted\n+        if(this.whitelisted_requests.containsKey(pathWithTrailingSlash) && this.whitelisted_requests.get(pathWithTrailingSlash).contains(HttpRequestMethods.valueOf(request.method().toString())))", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNTA2MQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452515061", "bodyText": "What is the preference order?", "author": "sujithvm", "createdAt": "2020-07-09T22:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNDI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MTQ4OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452641488", "bodyText": "Think this implies that if we whitelist GET /_cat/nodes both customer request for GET /_cat/nodes and GET /_cat/nodes/ are permissible.", "author": "debjanibnrj", "createdAt": "2020-07-10T06:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNDI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1OTcxMQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452659711", "bodyText": "Okay. Just wanted to know these entries could be consolidated into one but can be done in a later task", "author": "sujithvm", "createdAt": "2020-07-10T07:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUxNDI4MA=="}], "type": "inlineReview"}, {"oid": "05daef9d00c076e2601291d5166873d62e1d1ed4", "url": "https://github.com/opensearch-project/security/commit/05daef9d00c076e2601291d5166873d62e1d1ed4", "message": "Make minor changes, and remove WhitelistingSettingsModel", "committedDate": "2020-07-10T05:58:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYzNjY0Mw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452636643", "bodyText": "don't think we are implementing handlePost either. May want to add a new handler function like handleDelete for handlePost", "author": "debjanibnrj", "createdAt": "2020-07-10T05:55:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;\n+\n+import com.amazon.opendistroforelasticsearch.security.DefaultObjectMapper;\n+import com.amazon.opendistroforelasticsearch.security.auditlog.AuditLog;\n+import com.amazon.opendistroforelasticsearch.security.configuration.AdminDNs;\n+import com.amazon.opendistroforelasticsearch.security.configuration.ConfigurationRepository;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.AbstractConfigurationValidator;\n+import com.amazon.opendistroforelasticsearch.security.dlic.rest.validation.WhitelistValidator;\n+import com.amazon.opendistroforelasticsearch.security.privileges.PrivilegesEvaluator;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.CType;\n+import com.amazon.opendistroforelasticsearch.security.securityconf.impl.SecurityDynamicConfiguration;\n+import com.amazon.opendistroforelasticsearch.security.ssl.transport.PrincipalExtractor;\n+import com.amazon.opendistroforelasticsearch.security.support.ConfigConstants;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+\n+/**\n+ * This class implements GET and PUT operations to manage dynamic WhitelistingSettings.\n+ * <p>\n+ * These APIs are only accessible to SuperAdmin since the configuration controls what APIs are accessible by normal users.\n+ * Eg: If whitelisting is enabled, and a specific API like \"/_cat/nodes\" is not whitelisted, then only the SuperAdmin can use \"/_cat/nodes\"\n+ * These APIs allow the SuperAdmin to enable/disable whitelisting, and also change the list of whitelisted APIs.\n+ * <p>\n+ * A SuperAdmin is identified by a certificate which represents a distinguished name(DN).\n+ * SuperAdmin DN's can be set in {@link ConfigConstants#OPENDISTRO_SECURITY_AUTHCZ_ADMIN_DN}\n+ * SuperAdmin certificate for the default superuser is stored as a kirk.pem file in config folder of elasticsearch\n+ * <p>\n+ * Example calling the PUT API as SuperAdmin using curl (if http basic auth is on):\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPUT https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"enabled\" : false,\n+ *      \"requests\" : {\"/_cat/nodes\": [\"GET\"], \"/_opendistro/_security/api/whitelist\": [\"GET\"]}\n+ * }\n+ *\n+ * Example using the PATCH API to change the requests as SuperAdmin:\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPATCH https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"op\":\"replace\",\n+ *      \"path\":\"/config/requests\",\n+ *      \"value\": {\"/_cat/nodes\": [\"GET\"], \"/_opendistro/_security/api/whitelist\": [\"GET\"]}\n+ * }\n+ *\n+ * To update enabled, use the \"add\" operation instead of the \"replace\" operation, since boolean variables are not recognized as valid paths when they are false.\n+ * eg:\n+ * curl -v --cacert path_to_config/root-ca.pem --cert path_to_config/kirk.pem --key path_to_config/kirk-key.pem -XPATCH https://localhost:9200/_opendistro/_security/api/whitelist -H \"Content-Type: application/json\" -d\u2019\n+ * {\n+ *      \"op\":\"add\",\n+ *      \"path\":\"/config/enabled\",\n+ *      \"value\": true\n+ * }\n+ *\n+ * The backing data is stored in {@link ConfigConstants#OPENDISTRO_SECURITY_CONFIG_INDEX_NAME} which is populated during bootstrap.\n+ * For existing clusters, {@link com.amazon.opendistroforelasticsearch.security.tools.OpenDistroSecurityAdmin} tool can\n+ * be used to populate the index.\n+ * <p>\n+ */\n+public class WhitelistApiAction extends PatchableResourceApiAction {\n+    private static final List<Route> routes = ImmutableList.of(\n+            new Route(RestRequest.Method.GET, \"/_opendistro/_security/api/whitelist\"),\n+            new Route(RestRequest.Method.PUT, \"/_opendistro/_security/api/whitelist\"),\n+            new Route(RestRequest.Method.PATCH, \"/_opendistro/_security/api/whitelist\")\n+    );\n+\n+    private static final String name = \"config\";\n+\n+    @Inject\n+    public WhitelistApiAction(final Settings settings, final Path configPath, final RestController controller, final Client client,\n+                              final AdminDNs adminDNs, final ConfigurationRepository cl, final ClusterService cs,\n+                              final PrincipalExtractor principalExtractor, final PrivilegesEvaluator evaluator, ThreadPool threadPool, AuditLog auditLog) {\n+        super(settings, configPath, controller, client, adminDNs, cl, cs, principalExtractor, evaluator, threadPool, auditLog);\n+    }\n+\n+    @Override\n+    protected void handleApiRequest(final RestChannel channel, final RestRequest request, final Client client) throws IOException {\n+        if (!isSuperAdmin()) {\n+            forbidden(channel, \"API allowed only for super admin.\");\n+            return;\n+        }\n+        super.handleApiRequest(channel, request, client);\n+    }\n+\n+    @Override\n+    protected void handleGet(final RestChannel channel, RestRequest request, Client client, final JsonNode content)\n+            throws IOException {\n+\n+\n+        final SecurityDynamicConfiguration<?> configuration = load(getConfigName(), true);\n+        filter(configuration);\n+        successResponse(channel, configuration);\n+        return;\n+    }\n+\n+    @Override\n+    protected void handleDelete(final RestChannel channel, final RestRequest request, final Client client, final JsonNode content) throws IOException {", "originalCommit": "3878cd18a55998e077b8a5d1f9877d59029bea83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0Mzk0Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452643946", "bodyText": "Post is by default not implemented in AbstractApiAction, so I didn't need to add another function for that.\nref: https://github.com/opendistro-for-elasticsearch/security/blob/bca8fe37b06eb8eb930321247619e5bd85b6c5c0/src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/AbstractApiAction.java#L226", "author": "rahulkarajgikar", "createdAt": "2020-07-10T06:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYzNjY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0Nzc2OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452647768", "bodyText": "Thanks for confirming", "author": "debjanibnrj", "createdAt": "2020-07-10T06:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYzNjY0Mw=="}], "type": "inlineReview"}, {"oid": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "url": "https://github.com/opensearch-project/security/commit/786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "message": "move whitelisting checks into WhitelistingSettings", "committedDate": "2020-07-10T06:35:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1MjI2Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452652266", "bodyText": "Don't think you need to reset the value of  rh.sendAdminCertificate every time. Looks like this is being set everytime you call this method.", "author": "debjanibnrj", "createdAt": "2020-07-10T06:44:55Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiTest.java", "diffHunk": "@@ -44,7 +44,10 @@\n      *\n      * @throws Exception\n      */\n-    private void testGetAndPut(final int expectedStatus, final Header... headers) throws Exception {\n+    private void testGetAndPut(final int expectedStatus, final boolean sendAdminCertificate, final Header... headers) throws Exception {\n+\n+        final boolean prevSendAdminCertificate = rh.sendAdminCertificate;", "originalCommit": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1NDI4NA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452654284", "bodyText": "Mark this as volatile if the object is being changed under subscribe.", "author": "sujithvm", "createdAt": "2020-07-10T06:50:21Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilter.java", "diffHunk": "@@ -71,6 +74,9 @@\n     private final Path configPath;\n     private final CompatConfig compatConfig;\n \n+    private WhitelistingSettings whitelistingSettings;", "originalCommit": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY1NzQyNw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452657427", "bodyText": "nit: whats the use case of this copy constuctor?", "author": "sujithvm", "createdAt": "2020-07-10T06:58:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestStatus;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class WhitelistingSettings {\n+    private boolean enabled;\n+    private Map<String, List<HttpRequestMethods>> requests;\n+\n+    /**\n+     * Used to parse the yml files, do not remove.\n+     */\n+    public WhitelistingSettings() {\n+        enabled = false;\n+        requests = Collections.emptyMap();\n+    }\n+\n+    public WhitelistingSettings(WhitelistingSettings whitelistingSettings) {", "originalCommit": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY2MTg3Nw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r452661877", "bodyText": "nit: consider moving this null check to setter as getter is more likely accessed", "author": "sujithvm", "createdAt": "2020-07-10T07:08:18Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;\n+\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestStatus;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class WhitelistingSettings {\n+    private boolean enabled;\n+    private Map<String, List<HttpRequestMethods>> requests;\n+\n+    /**\n+     * Used to parse the yml files, do not remove.\n+     */\n+    public WhitelistingSettings() {\n+        enabled = false;\n+        requests = Collections.emptyMap();\n+    }\n+\n+    public WhitelistingSettings(WhitelistingSettings whitelistingSettings) {\n+        this.enabled = whitelistingSettings.getEnabled();\n+        this.requests = whitelistingSettings.getRequests();\n+    }\n+\n+    public boolean getEnabled() {\n+        return this.enabled;\n+    }\n+\n+    public void setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+    }\n+\n+    public Map<String, List<HttpRequestMethods>> getRequests() {\n+        return this.requests == null ? Collections.emptyMap(): this.requests;", "originalCommit": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "url": "https://github.com/opensearch-project/security/commit/786fc7cd2bceee4f0e7a9dc3891a1e2eb933e9b0", "message": "move whitelisting checks into WhitelistingSettings", "committedDate": "2020-07-10T06:35:54Z", "type": "forcePushed"}, {"oid": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "url": "https://github.com/opensearch-project/security/commit/1f14ba450db1edc528e51975d8e2d26bf1c142db", "message": "ensure null object not posted", "committedDate": "2020-07-10T09:04:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg3OTI5MQ==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455879291", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:35:03Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiAction.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg3OTgxNw==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455879817", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:35:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/validation/WhitelistValidator.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.validation;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4MDc0Ng==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455880746", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:37:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/HttpRequestMethods.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4MDg0NA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455880844", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:37:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/securityconf/impl/WhitelistingSettings.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.amazon.opendistroforelasticsearch.security.securityconf.impl;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4MTE4OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455881188", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:37:48Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/dlic/rest/api/WhitelistApiTest.java", "diffHunk": "@@ -0,0 +1,249 @@\n+package com.amazon.opendistroforelasticsearch.security.dlic.rest.api;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4MTU1OA==", "url": "https://github.com/opensearch-project/security/pull/520#discussion_r455881558", "bodyText": "Missing copyright.", "author": "vrozov", "createdAt": "2020-07-16T15:38:20Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/security/filter/OpenDistroSecurityRestFilterTest.java", "diffHunk": "@@ -0,0 +1,240 @@\n+package com.amazon.opendistroforelasticsearch.security.filter;", "originalCommit": "1f14ba450db1edc528e51975d8e2d26bf1c142db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}