{"pr_number": 2260, "pr_title": "Gh 2259 FederatedStore mitigate infinite loop", "pr_createdAt": "2020-03-16T12:24:42Z", "pr_url": "https://github.com/gchq/Gaffer/pull/2260", "timeline": [{"oid": "28de2aa2d2c7272f8bd2df7dd5e2436eb1078863", "url": "https://github.com/gchq/Gaffer/commit/28de2aa2d2c7272f8bd2df7dd5e2436eb1078863", "message": "gh-2259 FederatedStore test for infinite loop", "committedDate": "2020-03-16T11:13:30Z", "type": "commit"}, {"oid": "4096ed0cdf453b0201c88a874aa783ca9c82d012", "url": "https://github.com/gchq/Gaffer/commit/4096ed0cdf453b0201c88a874aa783ca9c82d012", "message": "gh-2259 FederatedStore will not return graphs more than once for the same operation.", "committedDate": "2020-03-16T12:46:38Z", "type": "commit"}, {"oid": "4096ed0cdf453b0201c88a874aa783ca9c82d012", "url": "https://github.com/gchq/Gaffer/commit/4096ed0cdf453b0201c88a874aa783ca9c82d012", "message": "gh-2259 FederatedStore will not return graphs more than once for the same operation.", "committedDate": "2020-03-16T12:46:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwMjExMQ==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r393002111", "bodyText": "Is there any value in keeping this signature as an overload, and perhaps adding one for getGraphs(user)?", "author": "t11947", "createdAt": "2020-03-16T12:54:06Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -334,10 +350,23 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {", "originalCommit": "4096ed0cdf453b0201c88a874aa783ca9c82d012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTY2Ng==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r393115666", "bodyText": "I don't think it would or should be used anywhere.\nThe graphIdsCsv is optional value from operations during federation, ignoring this will ignore the users request to scope the operation.\nRemoving the the Operation parameter will remove the attempt to mitigate infinite loops, making this ticket change potentially useless.", "author": "GCHQDev404", "createdAt": "2020-03-16T15:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwMjExMQ=="}], "type": "inlineReview"}, {"oid": "861bb0b94ec045638f50146865184060dc2e20d0", "url": "https://github.com/gchq/Gaffer/commit/861bb0b94ec045638f50146865184060dc2e20d0", "message": "gh-2259 FederatedStore Logging, Test fixes.", "committedDate": "2020-03-17T15:58:37Z", "type": "commit"}, {"oid": "861bb0b94ec045638f50146865184060dc2e20d0", "url": "https://github.com/gchq/Gaffer/commit/861bb0b94ec045638f50146865184060dc2e20d0", "message": "gh-2259 FederatedStore Logging, Test fixes.", "committedDate": "2020-03-17T15:58:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397686671", "bodyText": "Re-add old method to maintain public api. Old tests should be reverted and should pass.", "author": "d47853", "createdAt": "2020-03-25T08:44:11Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1NTk4MQ==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399155981", "bodyText": "If that is done, then all infinate loop mitigation can be completely bypassed.\nYou will be completely reliant on at least 1 FederatedStore in the loop being standard with standard handlers.", "author": "GCHQDev404", "createdAt": "2020-03-27T10:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNDMyMg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399224322", "bodyText": "Ah okay. Fair enough. To be safe though, it would be a good idea to re-add it and deprecate it with a comment on why it shouldn't be used.", "author": "d47853", "createdAt": "2020-03-27T12:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzMjQ3Mg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r400532472", "bodyText": "Any handers already written will continue to use the deprecated by passed method.\nAnd will not be changed until the deprecation is removed.\nI prefer to force the change to make them update. Are you happy with mitigation reliant on 1 FederatedStore?", "author": "GCHQDev404", "createdAt": "2020-03-30T22:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2ODk4OA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r402168988", "bodyText": "I guess as the Federated Store is labeled experimental and this mitigates a serious bug, as you say, it's probably better to force the change.", "author": "d47853", "createdAt": "2020-04-02T09:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNDAwMA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397704000", "bodyText": "Does this mean that two FederatedStores in seperate JVMs could have the same id?", "author": "d47853", "createdAt": "2020-03-25T09:14:31Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();\n+    private final int id;\n+\n+    public FederatedStore() {\n+        Integer i = null;\n+        while (isNull(i) || ALL_IDS.contains(i)) {\n+            i = new Random().nextInt();\n+        }\n+        ALL_IDS.add(id = i);", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1NDMyMQ==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399154321", "bodyText": "Yes, but collision is chance is very low. This is to mitigate against infinite loops not guarantee it doesn't ever happen. Next time one of the JVM is turned on and off again it should be okay.", "author": "GCHQDev404", "createdAt": "2020-03-27T10:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNDAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzA0NA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397707044", "bodyText": "Does operation.getOpertions() need wrapping here?", "author": "d47853", "createdAt": "2020-03-25T09:19:32Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {\n+        Collection<Graph> rtn = new ArrayList<>();\n+        if (nonNull(operation)) {\n+            String optionKey = FEDERATED_STORE_PROCESSED + id;\n+            boolean isIdFound = !operation.getOption(optionKey, \"\").isEmpty();\n+            if (!isIdFound) {\n+                HashMap<String, String> updatedOptions = isNull(operation.getOptions()) ? new HashMap<>() : new HashMap<>(operation.getOptions());", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMTk5Mg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399221992", "bodyText": "Sorry my question wasn't very clear. I was more referring to the final part of the ternary where you wrap the options in a hashmap. I don't think it needs the extra wrap as you've already don a null check.", "author": "d47853", "createdAt": "2020-03-27T12:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyNjM4Nw==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r400526387", "bodyText": "regarding new HashMap<>(operation.getOptions())?\nThis is because the operations interface makes each operation responsible for creating and returning the options map. It might be immutable.", "author": "GCHQDev404", "createdAt": "2020-03-30T22:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzk0NA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397707944", "bodyText": "Why not just use operation.addOption()?", "author": "d47853", "createdAt": "2020-03-25T09:21:02Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {\n+        Collection<Graph> rtn = new ArrayList<>();\n+        if (nonNull(operation)) {\n+            String optionKey = FEDERATED_STORE_PROCESSED + id;\n+            boolean isIdFound = !operation.getOption(optionKey, \"\").isEmpty();\n+            if (!isIdFound) {\n+                HashMap<String, String> updatedOptions = isNull(operation.getOptions()) ? new HashMap<>() : new HashMap<>(operation.getOptions());\n+                updatedOptions.put(optionKey, getGraphId());\n+                operation.setOptions(updatedOptions);", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE2MDU1Mg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399160552", "bodyText": "Coz I was looking for a put() method which wasn't there since I was dealing with properties map.", "author": "GCHQDev404", "createdAt": "2020-03-27T10:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397799522", "bodyText": "Is it worth hoisting the Random object to stop it being created every loop, and instantiating i to a random int off the bat to prevent the need for a null check?", "author": "t11947", "createdAt": "2020-03-25T11:57:54Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();\n+    private final int id;\n+\n+    public FederatedStore() {\n+        Integer i = null;\n+        while (isNull(i) || ALL_IDS.contains(i)) {\n+            i = new Random().nextInt();", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1MzU3MA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399153570", "bodyText": "99% of the time the loop will happen once.\nIt will require storing an additional variable for a simple loop.\nDo you wish me to make the change?", "author": "GCHQDev404", "createdAt": "2020-03-27T10:01:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NTI0OQ==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399175249", "bodyText": "Is there a reason you're not assigning the value right away rather than assigning null and then checking for null?", "author": "t11947", "createdAt": "2020-03-27T10:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE4MTgxMg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399181812", "bodyText": "Because if there is collision I will need to rewrite the logic to assign the value again. which means duplicate line of code.\nvariable = assign value logic\ncheck(variable)\nvariable = re-assign logic again // duplicate code.", "author": "GCHQDev404", "createdAt": "2020-03-27T10:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE4NjI1NA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399186254", "bodyText": "If you're worried about code duplication, consider using a private method. Is there a reason you're not assigning to the field directly from the get go?", "author": "t11947", "createdAt": "2020-03-27T11:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzOTM3Mg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r400539372", "bodyText": "variable = methodAssingment()\ncheck(variable) {\n    variable = methodAssingment() // still a duplicate line\n}\nmethodAssingment(){ \n    //now an extra method with a one liner sitting in the class used only once 99.99% of instantiation.\n}", "author": "GCHQDev404", "createdAt": "2020-03-30T22:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDM5MA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399174390", "bodyText": "Consider not using constant case for mutable lists.", "author": "t11947", "createdAt": "2020-03-27T10:39:35Z", "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();", "originalCommit": "9965c0644a99b3a77a829a64da37fb8d486cc445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0MDQyNw==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r400540427", "bodyText": "This is global list held and modified by all classes, to understand and know which ID number have been used by other classes.\nWhat would you consider using?", "author": "GCHQDev404", "createdAt": "2020-03-30T22:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE0NjQwOA==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r402146408", "bodyText": "Camel case for mutable class members.", "author": "t11947", "createdAt": "2020-04-02T08:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUxOTI3Mg==", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r402519272", "bodyText": "OOooooooh completely misunderstood  you.\nI don't think you've selected the correct naming convention.\n-> \"error: Name 'allIds' must match pattern '^[A-Z][A-Z0-9\"", "author": "GCHQDev404", "createdAt": "2020-04-02T18:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDM5MA=="}], "type": "inlineReview"}, {"oid": "440c30c6accf423fa0878d3bf791f30f6768f4b1", "url": "https://github.com/gchq/Gaffer/commit/440c30c6accf423fa0878d3bf791f30f6768f4b1", "message": "gh-2259 FederatedStore PR", "committedDate": "2020-04-01T18:23:11Z", "type": "forcePushed"}, {"oid": "f6195da26af27a1b81d6f6647218d140e67dbdb0", "url": "https://github.com/gchq/Gaffer/commit/f6195da26af27a1b81d6f6647218d140e67dbdb0", "message": "gh-2259 FederatedStore PR", "committedDate": "2020-04-02T20:55:08Z", "type": "commit"}, {"oid": "2cc8a98cf13a839de714d5c2fa15f0bc390877b3", "url": "https://github.com/gchq/Gaffer/commit/2cc8a98cf13a839de714d5c2fa15f0bc390877b3", "message": "Merge remote-tracking branch 'origin/develop' into gh-2259-FedeatedStore-mitigate-infinate-loop", "committedDate": "2020-04-02T20:56:02Z", "type": "commit"}]}