{"pr_number": 2289, "pr_title": "Gh 1836 mini accumulo changes 2", "pr_createdAt": "2020-07-03T12:32:11Z", "pr_url": "https://github.com/gchq/Gaffer/pull/2289", "timeline": [{"oid": "c7ee3349d4a1808be70144155b0a7f4706958f0c", "url": "https://github.com/gchq/Gaffer/commit/c7ee3349d4a1808be70144155b0a7f4706958f0c", "message": "Test to run pipeline", "committedDate": "2020-02-20T09:48:22Z", "type": "commit"}, {"oid": "06dd29d4d67d6ebe9925e98b4337a7ce240e1beb", "url": "https://github.com/gchq/Gaffer/commit/06dd29d4d67d6ebe9925e98b4337a7ce240e1beb", "message": "Updated AccumuloStoreITs", "committedDate": "2020-06-11T14:48:00Z", "type": "commit"}, {"oid": "e16e33347170bd043f7361cfb47637dd56eb4272", "url": "https://github.com/gchq/Gaffer/commit/e16e33347170bd043f7361cfb47637dd56eb4272", "message": "spelling error", "committedDate": "2020-06-11T15:03:00Z", "type": "commit"}, {"oid": "120fdca3b2cafb7e944661f4bca82e19366f9aae", "url": "https://github.com/gchq/Gaffer/commit/120fdca3b2cafb7e944661f4bca82e19366f9aae", "message": "removed outdated comment", "committedDate": "2020-06-11T15:07:51Z", "type": "commit"}, {"oid": "cfdcc5307536a84741573ef18e94f54353366516", "url": "https://github.com/gchq/Gaffer/commit/cfdcc5307536a84741573ef18e94f54353366516", "message": "Merge branch 'develop' of github.com:gchq/Gaffer into develop", "committedDate": "2020-06-18T10:46:19Z", "type": "commit"}, {"oid": "096eb6212341cfc0780997ff03a206f60ff770fb", "url": "https://github.com/gchq/Gaffer/commit/096eb6212341cfc0780997ff03a206f60ff770fb", "message": "Merge branch 'gh-1836-demo' of github.com:gchq/Gaffer into develop", "committedDate": "2020-06-18T10:51:07Z", "type": "commit"}, {"oid": "b4a030e3129eb619e4412944a58bb70528865473", "url": "https://github.com/gchq/Gaffer/commit/b4a030e3129eb619e4412944a58bb70528865473", "message": "Basic set up for tests to use mini accumulo.", "committedDate": "2020-06-19T16:12:03Z", "type": "commit"}, {"oid": "c85e87f1b8b3ba316c593784f49c9b9c5db4f7c8", "url": "https://github.com/gchq/Gaffer/commit/c85e87f1b8b3ba316c593784f49c9b9c5db4f7c8", "message": "Completed AccumuloStoreTest changes.", "committedDate": "2020-06-22T12:42:16Z", "type": "commit"}, {"oid": "586547bcab66a2239a9a84fe3f23a8acd7c6fa96", "url": "https://github.com/gchq/Gaffer/commit/586547bcab66a2239a9a84fe3f23a8acd7c6fa96", "message": "First set of amendments for Mock to Mini Accumulo testing change", "committedDate": "2020-06-23T09:07:55Z", "type": "commit"}, {"oid": "5d7029d09ac30b504ce8d0132484daf2e7aad266", "url": "https://github.com/gchq/Gaffer/commit/5d7029d09ac30b504ce8d0132484daf2e7aad266", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-23T13:29:21Z", "type": "commit"}, {"oid": "a0d5d86363607af17a0be33554f07a8ce988f49f", "url": "https://github.com/gchq/Gaffer/commit/a0d5d86363607af17a0be33554f07a8ce988f49f", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-23T15:16:14Z", "type": "commit"}, {"oid": "474d2f8ffe5c586bb0c854c6dc8db1dada446b2d", "url": "https://github.com/gchq/Gaffer/commit/474d2f8ffe5c586bb0c854c6dc8db1dada446b2d", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-24T09:12:28Z", "type": "commit"}, {"oid": "fd976bc99a2337c07e9dbb5f2651cee931912768", "url": "https://github.com/gchq/Gaffer/commit/fd976bc99a2337c07e9dbb5f2651cee931912768", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-24T10:14:32Z", "type": "commit"}, {"oid": "d2546f7bd5bfaedb8bf974f04117cee7fbf51978", "url": "https://github.com/gchq/Gaffer/commit/d2546f7bd5bfaedb8bf974f04117cee7fbf51978", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-24T11:16:42Z", "type": "commit"}, {"oid": "9be5f47e2cff024f212606b1265c4d3abb310034", "url": "https://github.com/gchq/Gaffer/commit/9be5f47e2cff024f212606b1265c4d3abb310034", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-24T14:07:56Z", "type": "commit"}, {"oid": "7f1878918b14bbde5493ff7ab9e8a4a6af50914a", "url": "https://github.com/gchq/Gaffer/commit/7f1878918b14bbde5493ff7ab9e8a4a6af50914a", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-24T14:10:00Z", "type": "commit"}, {"oid": "32a0719c03b6957aeb5d49ef49991e87aa5909ef", "url": "https://github.com/gchq/Gaffer/commit/32a0719c03b6957aeb5d49ef49991e87aa5909ef", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-25T08:42:07Z", "type": "commit"}, {"oid": "fd65ee35800cb291e722cd480b8708ce1a36b20c", "url": "https://github.com/gchq/Gaffer/commit/fd65ee35800cb291e722cd480b8708ce1a36b20c", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-25T11:32:39Z", "type": "commit"}, {"oid": "33f485e66e1615793e6e353e02aea63f5db1651d", "url": "https://github.com/gchq/Gaffer/commit/33f485e66e1615793e6e353e02aea63f5db1651d", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-25T12:28:37Z", "type": "commit"}, {"oid": "401175346487db17d96b4901be62345159016027", "url": "https://github.com/gchq/Gaffer/commit/401175346487db17d96b4901be62345159016027", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-25T14:35:59Z", "type": "commit"}, {"oid": "9060149d402e75b67f1976a3db9162a8d86dd7a1", "url": "https://github.com/gchq/Gaffer/commit/9060149d402e75b67f1976a3db9162a8d86dd7a1", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-26T06:16:10Z", "type": "commit"}, {"oid": "af2dfa4fe8a1c5dde87e3d2447a05ddf28cfe622", "url": "https://github.com/gchq/Gaffer/commit/af2dfa4fe8a1c5dde87e3d2447a05ddf28cfe622", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-26T06:55:49Z", "type": "commit"}, {"oid": "8643f8509a71b9a0d33d2db8b3996a52842e38ff", "url": "https://github.com/gchq/Gaffer/commit/8643f8509a71b9a0d33d2db8b3996a52842e38ff", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-26T07:26:45Z", "type": "commit"}, {"oid": "a37d6855e9d4846491c02999015972dae7bc26ac", "url": "https://github.com/gchq/Gaffer/commit/a37d6855e9d4846491c02999015972dae7bc26ac", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-26T08:11:43Z", "type": "commit"}, {"oid": "e37f86db8e188abe1275ee1e49a014ab8efc32de", "url": "https://github.com/gchq/Gaffer/commit/e37f86db8e188abe1275ee1e49a014ab8efc32de", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-26T11:26:49Z", "type": "commit"}, {"oid": "f2a6b492d5a12f8c7e5c6a7ef1bbe6e4faaab3a9", "url": "https://github.com/gchq/Gaffer/commit/f2a6b492d5a12f8c7e5c6a7ef1bbe6e4faaab3a9", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-29T07:10:03Z", "type": "commit"}, {"oid": "07687e3c42b9510247304bab3443c79356efd9ce", "url": "https://github.com/gchq/Gaffer/commit/07687e3c42b9510247304bab3443c79356efd9ce", "message": "Mock to mini accumulo changes for federated-store.", "committedDate": "2020-06-30T14:31:45Z", "type": "commit"}, {"oid": "be1d5a34e8ece5b52ff7374f794181f4e8cfa5ba", "url": "https://github.com/gchq/Gaffer/commit/be1d5a34e8ece5b52ff7374f794181f4e8cfa5ba", "message": "Amendments for Mock to Mini Accumulo testing change.", "committedDate": "2020-06-30T14:45:01Z", "type": "commit"}, {"oid": "ec6b3729a3b116790dbb4fd5f7b0ad1ca4012266", "url": "https://github.com/gchq/Gaffer/commit/ec6b3729a3b116790dbb4fd5f7b0ad1ca4012266", "message": ".travis.yml changed to move :spark-accumulo-library to a different module so accumulo one doesn't timeout.", "committedDate": "2020-07-01T06:34:04Z", "type": "commit"}, {"oid": "4f2aec76259d1ff57d2500fad7e3c01024cd0c5f", "url": "https://github.com/gchq/Gaffer/commit/4f2aec76259d1ff57d2500fad7e3c01024cd0c5f", "message": "Amendments for Mock to Mini Accumulo testing change - tidying.", "committedDate": "2020-07-02T07:38:26Z", "type": "commit"}, {"oid": "31077bc100751aa272c65c996481977ab25a9431", "url": "https://github.com/gchq/Gaffer/commit/31077bc100751aa272c65c996481977ab25a9431", "message": "Amendments for Mock to Mini Accumulo testing change - tidying.", "committedDate": "2020-07-02T08:53:43Z", "type": "commit"}, {"oid": "e50094d0674f81549e796650eb71aa539c4030c5", "url": "https://github.com/gchq/Gaffer/commit/e50094d0674f81549e796650eb71aa539c4030c5", "message": "Amendments for Mock to Mini Accumulo testing change - accumulo-rest.", "committedDate": "2020-07-02T15:34:53Z", "type": "commit"}, {"oid": "185bdbaed13ada2ceae6515e6ceec95c8c22aa8a", "url": "https://github.com/gchq/Gaffer/commit/185bdbaed13ada2ceae6515e6ceec95c8c22aa8a", "message": "Amendments for Mock to Mini Accumulo testing change - tidying of documentation and fix unused import audit error.", "committedDate": "2020-07-03T09:59:56Z", "type": "commit"}, {"oid": "da76dedb072567da25aad2b8c452eb24e0f2b852", "url": "https://github.com/gchq/Gaffer/commit/da76dedb072567da25aad2b8c452eb24e0f2b852", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T10:04:01Z", "type": "commit"}, {"oid": "56dabb991cb2cf26ad4a8af2760075e23a465b65", "url": "https://github.com/gchq/Gaffer/commit/56dabb991cb2cf26ad4a8af2760075e23a465b65", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T10:17:11Z", "type": "commit"}, {"oid": "a24cdcfdc8865f0a3400bc3fac2a2cd510f4c29c", "url": "https://github.com/gchq/Gaffer/commit/a24cdcfdc8865f0a3400bc3fac2a2cd510f4c29c", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T10:44:13Z", "type": "commit"}, {"oid": "7aacd2323b4106ee79e3e43c646942ce891967ff", "url": "https://github.com/gchq/Gaffer/commit/7aacd2323b4106ee79e3e43c646942ce891967ff", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T12:43:53Z", "type": "commit"}, {"oid": "6be03bdcab7355682d53b11ee3cf1481f16349fb", "url": "https://github.com/gchq/Gaffer/commit/6be03bdcab7355682d53b11ee3cf1481f16349fb", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T12:51:39Z", "type": "commit"}, {"oid": "b3c82c56f9a83eea717ad50d781d1a81fb6d7fce", "url": "https://github.com/gchq/Gaffer/commit/b3c82c56f9a83eea717ad50d781d1a81fb6d7fce", "message": "Amendments for Mock to Mini Accumulo unit testing changes.", "committedDate": "2020-07-06T13:34:13Z", "type": "commit"}, {"oid": "5898d5dae01f7e7ae645950cfe7ef4e371720791", "url": "https://github.com/gchq/Gaffer/commit/5898d5dae01f7e7ae645950cfe7ef4e371720791", "message": "Amendments for Mock to Mini Accumulo unit testing changes.\nDempMiniAccumuloStore: self-starting/stopping mini accumulo store for demo use.", "committedDate": "2020-07-06T13:52:13Z", "type": "commit"}, {"oid": "7890fb31f1a2991c341893577476f4e18d106d33", "url": "https://github.com/gchq/Gaffer/commit/7890fb31f1a2991c341893577476f4e18d106d33", "message": "Amendments for Mock Accumulo elimination from demo apps.", "committedDate": "2020-07-07T13:47:57Z", "type": "commit"}, {"oid": "240b1ec015be3b954f01e8537f18dc59a11bfd91", "url": "https://github.com/gchq/Gaffer/commit/240b1ec015be3b954f01e8537f18dc59a11bfd91", "message": "Amendments to remove Mock Accumulo from demo apps.", "committedDate": "2020-07-07T14:40:23Z", "type": "commit"}, {"oid": "f25d4484fd7887fa4775c459ebe860bb5a7ce2bd", "url": "https://github.com/gchq/Gaffer/commit/f25d4484fd7887fa4775c459ebe860bb5a7ce2bd", "message": "Amendments to remove Mock Accumulo from demo apps.", "committedDate": "2020-07-07T14:44:08Z", "type": "commit"}, {"oid": "65d1544ac4182a116ccab08dce3c609d81a74942", "url": "https://github.com/gchq/Gaffer/commit/65d1544ac4182a116ccab08dce3c609d81a74942", "message": "Amendments to remove Mock Accumulo from demo apps.", "committedDate": "2020-07-07T14:49:16Z", "type": "commit"}, {"oid": "d85acef65bcff01424522a713b83f27b9a7d3b4b", "url": "https://github.com/gchq/Gaffer/commit/d85acef65bcff01424522a713b83f27b9a7d3b4b", "message": "Amendments to remove Mock Accumulo from unit tests.", "committedDate": "2020-07-07T14:53:24Z", "type": "commit"}, {"oid": "721f580d4abd039b9e2659f402bb260026146911", "url": "https://github.com/gchq/Gaffer/commit/721f580d4abd039b9e2659f402bb260026146911", "message": "Amendments to remove Mock Accumulo from unit tests.", "committedDate": "2020-07-08T09:41:35Z", "type": "commit"}, {"oid": "dbe4a24982862875491cbeb372c4ff47084461f2", "url": "https://github.com/gchq/Gaffer/commit/dbe4a24982862875491cbeb372c4ff47084461f2", "message": "Amendments to pass required mini accumulo directory name into AccumuloTestClusterManager.", "committedDate": "2020-07-10T08:22:41Z", "type": "commit"}, {"oid": "ca275f5811d3998088c80c7bbcc2c896967fba8e", "url": "https://github.com/gchq/Gaffer/commit/ca275f5811d3998088c80c7bbcc2c896967fba8e", "message": "Amendments to remove Mock Accumulo from unit tests.", "committedDate": "2020-07-14T10:45:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0NTczNQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454245735", "bodyText": "Not really sure this will work as you'll probably get a hostname resolution failure", "author": "d47853", "createdAt": "2020-07-14T10:03:17Z", "path": "store-implementation/accumulo-store/src/main/java/uk/gov/gchq/gaffer/accumulostore/DemoMiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2016-2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+import java.io.File;\n+\n+public class DemoMiniAccumuloStore extends AccumuloStore {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DemoMiniAccumuloStore.class);\n+    private static AccumuloTestClusterManager accumuloTestClusterManager;\n+    private static final AccumuloProperties ACCUMULO_PROPERTIES = new AccumuloProperties();\n+\n+    static {\n+        ACCUMULO_PROPERTIES.setStoreClass(MiniAccumuloStore.class);\n+        ACCUMULO_PROPERTIES.setZookeepers(\"aZookeeper\");", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NTIzMQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454395231", "bodyText": "It works because the properties instance gets updated by the AccumuloTestClusterManager with the actual zookeeper details for the cluster it has started.\nThat is why I made accumuloTestClusterManager accept a StoreProperties object rather than a file reference or name: it allows the zookeeper details to be passed back seamlessly.", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0NTczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkxMjcwNA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454912704", "bodyText": "Okay in that case is it worth removing it to avoid confusion?", "author": "d47853", "createdAt": "2020-07-15T09:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0NTczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAyMDQ0MQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r455020441", "bodyText": "I shall remove it.", "author": "phosphorbronze50", "createdAt": "2020-07-15T12:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0NTczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0ODk4NA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454248984", "bodyText": "Won't this fail because the manager checks the class is Mini or SingleUseMini? Would changing the class to extend Mini and modifying the check to also look at extensions work?", "author": "d47853", "createdAt": "2020-07-14T10:09:37Z", "path": "store-implementation/accumulo-store/src/main/java/uk/gov/gchq/gaffer/accumulostore/DemoMiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2016-2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+import java.io.File;\n+\n+public class DemoMiniAccumuloStore extends AccumuloStore {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DemoMiniAccumuloStore.class);\n+    private static AccumuloTestClusterManager accumuloTestClusterManager;\n+    private static final AccumuloProperties ACCUMULO_PROPERTIES = new AccumuloProperties();\n+\n+    static {\n+        ACCUMULO_PROPERTIES.setStoreClass(MiniAccumuloStore.class);\n+        ACCUMULO_PROPERTIES.setZookeepers(\"aZookeeper\");\n+        ACCUMULO_PROPERTIES.setUser(\"user01\");\n+        ACCUMULO_PROPERTIES.setPassword(\"password01\");\n+        ACCUMULO_PROPERTIES.setInstance(\"instance01\");\n+\n+        final String tmpDirectoryProperty = System.getProperty(\"java.io.tmpdir\");\n+        File storeFolder = null;\n+        if (null != tmpDirectoryProperty) {\n+            storeFolder = new File(tmpDirectoryProperty);\n+        } else {\n+            LOGGER.error(DemoMiniAccumuloStore.class + \": Could not create storeFolder directory\");\n+        }\n+\n+        accumuloTestClusterManager = new AccumuloTestClusterManager(ACCUMULO_PROPERTIES, storeFolder.getAbsolutePath());", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NTEwNg==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454395106", "bodyText": "The manager checks the class specified in the properties which has been set to MiniAccumuloStore so it works OK.\nDemo is only intended for very limited and specific use (hence the hard coding of the properties) and not for general use as a store.", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0ODk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0OTIwNA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454249204", "bodyText": "Log just in case", "author": "d47853", "createdAt": "2020-07-14T10:10:01Z", "path": "store-implementation/accumulo-store/src/main/java/uk/gov/gchq/gaffer/accumulostore/SingleUseMiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2016-2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.TableNotFoundException;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+public class SingleUseMiniAccumuloStore extends MiniAccumuloStore {\n+    @Override\n+    public void preInitialise(final String graphId, final Schema schema, final StoreProperties properties)\n+            throws StoreException {\n+        // Initialise is deliberately called both before and after the deletion of the table.\n+        // The first call sets up a connection to the MiniAccumulo instance\n+        // The second call is used to re-create the table\n+\n+        try {\n+            super.preInitialise(graphId, schema, properties);\n+        } catch (final StoreException e) {\n+            // This is due to an invalid table, but the table is about to be deleted to we can ignore it.", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NTA0NA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454395044", "bodyText": "Logger INFO message added.\nThis is a hangover from the MockAccumuloStore on which this method is closely based.", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0OTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0OTM2Nw==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454249367", "bodyText": "Same as above", "author": "d47853", "createdAt": "2020-07-14T10:10:17Z", "path": "store-implementation/accumulo-store/src/main/java/uk/gov/gchq/gaffer/accumulostore/SingleUseMiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2016-2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.TableNotFoundException;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+public class SingleUseMiniAccumuloStore extends MiniAccumuloStore {\n+    @Override\n+    public void preInitialise(final String graphId, final Schema schema, final StoreProperties properties)\n+            throws StoreException {\n+        // Initialise is deliberately called both before and after the deletion of the table.\n+        // The first call sets up a connection to the MiniAccumulo instance\n+        // The second call is used to re-create the table\n+\n+        try {\n+            super.preInitialise(graphId, schema, properties);\n+        } catch (final StoreException e) {\n+            // This is due to an invalid table, but the table is about to be deleted to we can ignore it.\n+        }\n+\n+        try {\n+            getConnection().tableOperations().delete(getTableName());\n+        } catch (final StoreException | AccumuloException | AccumuloSecurityException | TableNotFoundException e) {\n+            // no action required", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5Nzk1OA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454397958", "bodyText": "Same as above, except a WARN message this time.", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0OTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MDcwOA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454250708", "bodyText": "Can you use two temporary folders to skip this?", "author": "d47853", "createdAt": "2020-07-14T10:12:57Z", "path": "store-implementation/accumulo-store/src/test/java/uk/gov/gchq/gaffer/accumulostore/AccumuloStoreTest.java", "diffHunk": "@@ -102,21 +109,41 @@\n import static uk.gov.gchq.gaffer.store.StoreTrait.VISIBILITY;\n \n public class AccumuloStoreTest {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AccumuloStoreTest.class);\n     private static final String BYTE_ENTITY_GRAPH = \"byteEntityGraph\";\n     private static final String GAFFER_1_GRAPH = \"gaffer1Graph\";\n-    private static SingleUseMockAccumuloStore byteEntityStore;\n-    private static SingleUseMockAccumuloStore gaffer1KeyStore;\n+    private static AccumuloStore byteEntityStore;\n+    private static AccumuloStore gaffer1KeyStore;\n     private static final Schema SCHEMA = Schema.fromJson(StreamUtil.schemas(AccumuloStoreTest.class));\n     private static final AccumuloProperties PROPERTIES = AccumuloProperties.loadStoreProperties(StreamUtil.storeProps(AccumuloStoreTest.class));\n     private static final AccumuloProperties CLASSIC_PROPERTIES = AccumuloProperties.loadStoreProperties(StreamUtil.openStream(AccumuloStoreTest.class, \"/accumuloStoreClassicKeys.properties\"));\n+    private static AccumuloTestClusterManager accumuloTestClusterManagerByteEntity = null;\n+    private static AccumuloTestClusterManager accumuloTestClusterManagerGaffer1Key = null;\n+\n+    @ClassRule\n+    public static TemporaryFolder storeBaseFolder = new TemporaryFolder(CommonTestConstants.TMP_DIRECTORY);\n \n     @Rule\n     public ExpectedException thrown = ExpectedException.none();\n \n     @BeforeClass\n     public static void setup() {\n-        byteEntityStore = new SingleUseMockAccumuloStore();\n-        gaffer1KeyStore = new SingleUseMockAccumuloStore();\n+        File storeFolder1 = null;", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwNTEzNg==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454405136", "bodyText": "I have found that sometimes multiple TemporaryFolder entries get set by JUnit4 with the same file store location.\nAdditionally, TemporaryFolder is deprecated in the coming JUnit5 changes so this will be quite short lived anyway.\nI will leave as is, if that is OK with you.", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MDcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NDkxNw==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454254917", "bodyText": "Can you remove the Test part of this as it's used outside of tests? Something Like MiniAccumuloClusterManager would be more descriptive.", "author": "d47853", "createdAt": "2020-07-14T10:20:51Z", "path": "store-implementation/accumulo-store/src/main/java/uk/gov/gchq/gaffer/accumulostore/AccumuloTestClusterManager.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2016-2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.apache.accumulo.core.security.Authorizations;\n+import org.apache.accumulo.core.security.SystemPermission;\n+import org.apache.accumulo.minicluster.MiniAccumuloCluster;\n+import org.apache.accumulo.minicluster.MiniAccumuloConfig;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+public class AccumuloTestClusterManager {", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMzQ2MQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454413461", "bodyText": "Done.\nIt started out life in test but had to migrate to the main codebase for various reasons (e.g. the rest demos). The name ended up the same in the change..", "author": "phosphorbronze50", "createdAt": "2020-07-14T14:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454258405", "bodyText": "Some of the setup logic seems to be repeated here and other classes. Would it be possible to move the PropertiesDrivenTest from sparkaccumulo and use it here?", "author": "d47853", "createdAt": "2020-07-14T10:27:24Z", "path": "store-implementation/accumulo-store/src/test/java/uk/gov/gchq/gaffer/accumulostore/inputformat/InputFormatTest.java", "diffHunk": "@@ -134,6 +141,30 @@\n     @Rule\n     public final TemporaryFolder testFolder = new TemporaryFolder(CommonTestConstants.TMP_DIRECTORY);\n \n+    @ClassRule\n+    public static TemporaryFolder storeBaseFolder = new TemporaryFolder(CommonTestConstants.TMP_DIRECTORY);\n+\n+    private static SingleUseAccumuloStore store;\n+    private static AccumuloTestClusterManager accumuloTestClusterManager;\n+    private static final AccumuloProperties PROPERTIES = AccumuloProperties.loadStoreProperties(StreamUtil.storeProps(InputFormatTest.class));\n+\n+    @BeforeClass\n+    public static void setup() {", "originalCommit": "dbe4a24982862875491cbeb372c4ff47084461f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0ODA0NA==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454448044", "bodyText": "I have removed all the repeating code.\nThe MiniAccumuloClusterManager creates a unique sub-directory under the TemporaryFolder for each cluster instance. This means where more than one MiniAccumuloClusterManager is used in tests each can be instantiated using the same temporary directory name from the TemporaryFolder.\nThe filename is supplied to the MiniAccumuloClusterManager constructor rather than the TemporaryFolder object because the TemporaryFolder class is a JUnit4 artifact so ought not to be used in a main codebase class. Additionally the @rule / @ClassRule / TemporaryFolder construct is effectively deprecated by the arrival of JUnit5.\nThis fix is more wide-ranging than the Abstract superclass would be as it can be used in tests that are already subclasses.", "author": "phosphorbronze50", "createdAt": "2020-07-14T15:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNzE1MQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r454927151", "bodyText": "Mainly it's the directory setup and cluster creation that could be delegated to a superclass. I'm also not too sure about having a static store and re-initialising it. As it's merely a connection object, could we create a new one for each test?", "author": "d47853", "createdAt": "2020-07-15T09:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxODE3MQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r455018171", "bodyText": "Sorry - hadn't been expecting your input so soon so updated my previous comments!\nPlease see the replacement comment.", "author": "phosphorbronze50", "createdAt": "2020-07-15T12:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA4MTkzMQ==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r455081931", "bodyText": "Tah. I shall take another look", "author": "d47853", "createdAt": "2020-07-15T14:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEyOTI3Nw==", "url": "https://github.com/gchq/Gaffer/pull/2289#discussion_r455129277", "bodyText": "Made the connection object local again.", "author": "phosphorbronze50", "createdAt": "2020-07-15T15:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1ODQwNQ=="}], "type": "inlineReview"}, {"oid": "2eabb62f4a70f39830a3d2d9dca007c662885b81", "url": "https://github.com/gchq/Gaffer/commit/2eabb62f4a70f39830a3d2d9dca007c662885b81", "message": "Tidy away an unused file.", "committedDate": "2020-07-14T13:23:33Z", "type": "commit"}, {"oid": "b22f1b67bc5ef55656b9182fcd6a7f3d27a671ee", "url": "https://github.com/gchq/Gaffer/commit/b22f1b67bc5ef55656b9182fcd6a7f3d27a671ee", "message": "Address comments made about pull request #2289 including rename of MiniAccumuloClusterManager.", "committedDate": "2020-07-15T07:51:13Z", "type": "commit"}, {"oid": "9de23465a9148267a595dd8138cada426db9f3c1", "url": "https://github.com/gchq/Gaffer/commit/9de23465a9148267a595dd8138cada426db9f3c1", "message": "Remove excessive sub-directory layer creation for MiniAccumuloClusterManager use.", "committedDate": "2020-07-15T10:36:04Z", "type": "commit"}, {"oid": "9a11930f0bc67c822f5a8e4e92e0d4081db01c00", "url": "https://github.com/gchq/Gaffer/commit/9a11930f0bc67c822f5a8e4e92e0d4081db01c00", "message": "Final snagging fixes.", "committedDate": "2020-07-15T15:18:53Z", "type": "commit"}, {"oid": "0c4b7303b9f2343027b49968074211ee790bffc8", "url": "https://github.com/gchq/Gaffer/commit/0c4b7303b9f2343027b49968074211ee790bffc8", "message": "xx", "committedDate": "2020-07-15T15:19:26Z", "type": "commit"}, {"oid": "f9f3612974395208c3e449d2faf5669d9dee6335", "url": "https://github.com/gchq/Gaffer/commit/f9f3612974395208c3e449d2faf5669d9dee6335", "message": "Final snagging.", "committedDate": "2020-07-16T17:16:22Z", "type": "commit"}, {"oid": "01ae9103b4c4b5c10a5104387689bee31c7614ba", "url": "https://github.com/gchq/Gaffer/commit/01ae9103b4c4b5c10a5104387689bee31c7614ba", "message": "Add comment about the zookeeper property entry.", "committedDate": "2020-07-21T12:59:03Z", "type": "commit"}, {"oid": "95713733aa4a237b8a23b5ddb5d320353fc49dc3", "url": "https://github.com/gchq/Gaffer/commit/95713733aa4a237b8a23b5ddb5d320353fc49dc3", "message": "Amendments to remove Mock Accumulo from unit tests - final tidy of unnecessary files.", "committedDate": "2020-07-24T11:18:06Z", "type": "commit"}]}