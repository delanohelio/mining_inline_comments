{"pr_number": 1116, "pr_title": "HBASE-23783: Address tests writing and reading SSL/Security files in \u2026", "pr_createdAt": "2020-02-02T20:56:14Z", "pr_url": "https://github.com/apache/hbase/pull/1116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MzkyNA==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374273924", "bodyText": "Statics. normally capitalized as in HTU rather than htu.", "author": "saintstack", "createdAt": "2020-02-03T18:45:47Z", "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;", "originalCommit": "271ab347e09fb8531a250e3a40abd437f6749f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDU1Mw==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374274553", "bodyText": "Above its sslconf... you want conf here?", "author": "saintstack", "createdAt": "2020-02-03T18:47:04Z", "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;\n \n   @BeforeClass\n   public static void setup() throws Exception {\n     conf = new Configuration();\n     conf.setInt(HttpServer.HTTP_MAX_THREADS, TestHttpServer.MAX_THREADS);\n \n-    File base = new File(BASEDIR);\n-    FileUtil.fullyDelete(base);\n-    base.mkdirs();\n-    keystoresDir = new File(BASEDIR).getAbsolutePath();\n+    htu = new HBaseCommonTestingUtility(conf);\n+\n+    keystoresDir = new File(htu.getDataTestDir(\"keystore\").toString());\n+    keystoresDir.mkdirs();\n+\n     sslConfDir = KeyStoreTestUtil.getClasspathDir(TestSSLHttpServer.class);\n \n-    KeyStoreTestUtil.setupSSLConfig(keystoresDir, sslConfDir, conf, false);\n+    KeyStoreTestUtil.setupSSLConfig(keystoresDir.getAbsolutePath(), sslConfDir, conf, false);\n     Configuration sslConf = new Configuration(false);\n-    sslConf.addResource(\"ssl-server.xml\");\n-    sslConf.addResource(\"ssl-client.xml\");\n-\n+    sslConf.addResource(conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    conf.addResource(conf.get(SSLFactory.SSL_SERVER_CONF_KEY));\n+    sslConf.set(SSLFactory.SSL_CLIENT_CONF_KEY, conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    \n     clientSslFactory = new SSLFactory(SSLFactory.Mode.CLIENT, sslConf);\n     clientSslFactory.init();\n \n     server = new HttpServer.Builder()\n-        .setName(\"test\")\n-        .addEndpoint(new URI(\"https://localhost\"))\n-        .setConf(conf)\n-        .keyPassword(HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.keypassword\",\n-            null))\n-        .keyStore(sslConf.get(\"ssl.server.keystore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.password\", null),\n-            sslConf.get(\"ssl.server.keystore.type\", \"jks\"))\n-        .trustStore(sslConf.get(\"ssl.server.truststore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.truststore.password\", null),\n-            sslConf.get(\"ssl.server.truststore.type\", \"jks\")).build();\n+      .setName(\"test\")\n+      .addEndpoint(new URI(\"https://localhost\"))\n+      .setConf(conf)\n+      .keyPassword(HBaseConfiguration.getPassword(conf, \"ssl.server.keystore.keypassword\",", "originalCommit": "271ab347e09fb8531a250e3a40abd437f6749f07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0MzY2MA==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374443660", "bodyText": "It's more client / server now, tried a rename", "author": "markrmiller", "createdAt": "2020-02-04T02:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDkzNg==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374274936", "bodyText": "Ditto. We use conf instead of sslconf here... That intentional?", "author": "saintstack", "createdAt": "2020-02-03T18:47:51Z", "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;\n \n   @BeforeClass\n   public static void setup() throws Exception {\n     conf = new Configuration();\n     conf.setInt(HttpServer.HTTP_MAX_THREADS, TestHttpServer.MAX_THREADS);\n \n-    File base = new File(BASEDIR);\n-    FileUtil.fullyDelete(base);\n-    base.mkdirs();\n-    keystoresDir = new File(BASEDIR).getAbsolutePath();\n+    htu = new HBaseCommonTestingUtility(conf);\n+\n+    keystoresDir = new File(htu.getDataTestDir(\"keystore\").toString());\n+    keystoresDir.mkdirs();\n+\n     sslConfDir = KeyStoreTestUtil.getClasspathDir(TestSSLHttpServer.class);\n \n-    KeyStoreTestUtil.setupSSLConfig(keystoresDir, sslConfDir, conf, false);\n+    KeyStoreTestUtil.setupSSLConfig(keystoresDir.getAbsolutePath(), sslConfDir, conf, false);\n     Configuration sslConf = new Configuration(false);\n-    sslConf.addResource(\"ssl-server.xml\");\n-    sslConf.addResource(\"ssl-client.xml\");\n-\n+    sslConf.addResource(conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    conf.addResource(conf.get(SSLFactory.SSL_SERVER_CONF_KEY));\n+    sslConf.set(SSLFactory.SSL_CLIENT_CONF_KEY, conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    \n     clientSslFactory = new SSLFactory(SSLFactory.Mode.CLIENT, sslConf);\n     clientSslFactory.init();\n \n     server = new HttpServer.Builder()\n-        .setName(\"test\")\n-        .addEndpoint(new URI(\"https://localhost\"))\n-        .setConf(conf)\n-        .keyPassword(HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.keypassword\",\n-            null))\n-        .keyStore(sslConf.get(\"ssl.server.keystore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.password\", null),\n-            sslConf.get(\"ssl.server.keystore.type\", \"jks\"))\n-        .trustStore(sslConf.get(\"ssl.server.truststore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.truststore.password\", null),\n-            sslConf.get(\"ssl.server.truststore.type\", \"jks\")).build();\n+      .setName(\"test\")\n+      .addEndpoint(new URI(\"https://localhost\"))\n+      .setConf(conf)\n+      .keyPassword(HBaseConfiguration.getPassword(conf, \"ssl.server.keystore.keypassword\",\n+        null))\n+      .keyStore(conf.get(\"ssl.server.keystore.location\"),", "originalCommit": "271ab347e09fb8531a250e3a40abd437f6749f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NTczMQ==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374275731", "bodyText": "Capitalize", "author": "saintstack", "createdAt": "2020-02-03T18:49:33Z", "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/log/TestLogLevel.java", "diffHunk": "@@ -84,31 +83,29 @@\n   private final static String KEYTAB  = \"loglevel.keytab\";\n \n   private static MiniKdc kdc;\n-  private static HBaseCommonTestingUtility htu = new HBaseCommonTestingUtility();\n \n   private static final String LOCALHOST = \"localhost\";\n   private static final String clientPrincipal = \"client/\" + LOCALHOST;\n   private static String HTTP_PRINCIPAL = \"HTTP/\" + LOCALHOST;\n-\n-  private static final File KEYTAB_FILE = new File(\n-      htu.getDataTestDir(\"keytab\").toUri().getPath());\n+  private static HBaseCommonTestingUtility htu;", "originalCommit": "271ab347e09fb8531a250e3a40abd437f6749f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NjQyOQ==", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374276429", "bodyText": "And maybe you want to use the HTU's conf. Do HTU.getConfiguration instead of creating a 'new Configuration()' in line above ... and FYI, for configs that will include hbase config, you want HBaseConfiguration.create.... instead of new Configuration.", "author": "saintstack", "createdAt": "2020-02-03T18:50:57Z", "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/log/TestLogLevel.java", "diffHunk": "@@ -84,31 +83,29 @@\n   private final static String KEYTAB  = \"loglevel.keytab\";\n \n   private static MiniKdc kdc;\n-  private static HBaseCommonTestingUtility htu = new HBaseCommonTestingUtility();\n \n   private static final String LOCALHOST = \"localhost\";\n   private static final String clientPrincipal = \"client/\" + LOCALHOST;\n   private static String HTTP_PRINCIPAL = \"HTTP/\" + LOCALHOST;\n-\n-  private static final File KEYTAB_FILE = new File(\n-      htu.getDataTestDir(\"keytab\").toUri().getPath());\n+  private static HBaseCommonTestingUtility htu;\n+  private static File keyTabFile;\n \n   @BeforeClass\n   public static void setUp() throws Exception {\n-    BASEDIR = new File(htu.getDataTestDir().toUri().getPath());\n-\n-    FileUtil.fullyDelete(BASEDIR);\n-    if (!BASEDIR.mkdirs()) {\n-      throw new Exception(\"unable to create the base directory for testing\");\n-    }\n     serverConf = new Configuration();\n+    htu = new HBaseCommonTestingUtility(serverConf);", "originalCommit": "271ab347e09fb8531a250e3a40abd437f6749f07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "url": "https://github.com/apache/hbase/commit/f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line.", "committedDate": "2020-02-04T01:32:22Z", "type": "forcePushed"}, {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "url": "https://github.com/apache/hbase/commit/7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line.", "committedDate": "2020-02-04T01:44:01Z", "type": "commit"}, {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "url": "https://github.com/apache/hbase/commit/7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line.", "committedDate": "2020-02-04T01:44:01Z", "type": "forcePushed"}]}