{"pr_number": 1441, "pr_title": "HBASE-24120 Flakey Test: TestReplicationAdminWithClusters timeout", "pr_createdAt": "2020-04-06T20:30:23Z", "pr_url": "https://github.com/apache/hbase/pull/1441", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQ2Mw==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r404418463", "bodyText": "You sure you don't want to propagate the InterruptedException? Looks like run loop in ReplicationSourceShipper is designed to handle that exception. return here would continue the thread executing, which I think is not what we want.", "author": "ndimiduk", "createdAt": "2020-04-06T22:09:02Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -579,8 +579,8 @@ private void interruptOrAbortWhenFail(ReplicationQueueOperation op) {\n       if (e.getCause() != null && e.getCause() instanceof KeeperException.SystemErrorException\n           && e.getCause().getCause() != null && e.getCause()\n           .getCause() instanceof InterruptedException) {\n-        throw new RuntimeException(\n-            \"Thread is interrupted, the replication source may be terminated\");\n+        LOG.info(\"Thread is interrupted, the replication source may be terminated\");\n+        return;", "originalCommit": "1c89328b2fa7128663877ce71ea34cf3aa690165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0OTA5Nw==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r404449097", "bodyText": "the interrupt flap has been set up in the zkwatcher layer and upper layer handles this flag nicely.\n  zkw.interruptedException(ie);\n\nhttps://github.com/apache/hbase/blob/master/hbase-zookeeper/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKWatcher.java#L637, in the outside loop, it will handle this interrupt flag and terminate the thread.\nInside  isActive() of the following loop, it will return false if isInterrupted flag is true.\nhttps://github.com/apache/hbase/blob/master/hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java#L101", "author": "huaxiangsun", "createdAt": "2020-04-06T23:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MDA5NA==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r404450094", "bodyText": "I have manually tested the code path by injecting an InterruptException at zkwatcher and made sure thread exits and  no region server abort.", "author": "huaxiangsun", "createdAt": "2020-04-06T23:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQ2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MzYzNA==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r404453634", "bodyText": "Thanks for checking.", "author": "ndimiduk", "createdAt": "2020-04-06T23:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODg4MQ==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r404418881", "bodyText": "I tried rewriting this big nasty if-expression using an Optional. Tell me what you think\n      if (Optional.of(e.getCause())\n        .filter(c -> c instanceof KeeperException.SystemErrorException)\n        .map(c -> (KeeperException.SystemErrorException) c)\n        .map(Exception::getCause)\n        .filter(c -> c instanceof InterruptedException)\n        .isPresent()) {", "author": "ndimiduk", "createdAt": "2020-04-06T22:10:07Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -579,8 +579,8 @@ private void interruptOrAbortWhenFail(ReplicationQueueOperation op) {\n       if (e.getCause() != null && e.getCause() instanceof KeeperException.SystemErrorException", "originalCommit": "1c89328b2fa7128663877ce71ea34cf3aa690165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NTM4Nw==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405195387", "bodyText": "missed this comment, will get back.", "author": "huaxiangsun", "createdAt": "2020-04-08T00:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxODg4MQ=="}], "type": "inlineReview"}, {"oid": "80fb7551eb3246106da3f9f4ddea90292c7cf683", "url": "https://github.com/apache/hbase/commit/80fb7551eb3246106da3f9f4ddea90292c7cf683", "message": "HBASE-24120 Flakey Test: TestReplicationAdminWithClusters timeout", "committedDate": "2020-04-08T00:30:10Z", "type": "forcePushed"}, {"oid": "328b048ee94b4a7275133c6fc6bb9532300a260a", "url": "https://github.com/apache/hbase/commit/328b048ee94b4a7275133c6fc6bb9532300a260a", "message": "HBASE-24120 Flakey Test: TestReplicationAdminWithClusters timeout", "committedDate": "2020-04-08T01:09:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMjExOA==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405202118", "bodyText": "Added this check because the flakey test run into the following Nullpointer exception.\n2020-04-07 03:30:03,677 WARN  [RS_REFRESH_PEER-regionserver/asf905:0-0.replicationSource,2.replicationSource.wal-reader.asf905.gq1.ygridcore.net%2C41391%2C1586230117579,2] impl.BlockReaderFactory(768): I/O error constructing remote block reader. java.nio.channels.ClosedByInterruptException at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:202) at sun.nio.ch.SocketChannelImpl.connect(SocketChannelImpl.java:659) at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:192) at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:531) at org.apache.hadoop.hdfs.DFSClient.newConnectedPeer(DFSClient.java:2881) at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.nextTcpPeer(BlockReaderFactory.java:825) at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.getRemoteBlockReaderFromTcp(BlockReaderFactory.java:750) at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.build(BlockReaderFactory.java:387) at org.apache.hadoop.hdfs.DFSInputStream.getBlockReader(DFSInputStream.java:717) at org.apache.hadoop.hdfs.DFSInputStream.blockSeekTo(DFSInputStream.java:665) at org.apache.hadoop.hdfs.DFSInputStream.seekToBlockSource(DFSInputStream.java:1697) at org.apache.hadoop.hdfs.DFSInputStream.readBuffer(DFSInputStream.java:915) at org.apache.hadoop.hdfs.DFSInputStream.readWithStrategy(DFSInputStream.java:950) at org.apache.hadoop.hdfs.DFSInputStream.read(DFSInputStream.java:996) at java.io.DataInputStream.read(DataInputStream.java:149) at java.io.FilterInputStream.read(FilterInputStream.java:133) at java.io.PushbackInputStream.read(PushbackInputStream.java:186) at org.apache.hadoop.io.IOUtils.readFully(IOUtils.java:209) at org.apache.hadoop.hbase.KeyValueUtil.createKeyValueFromInputStream(KeyValueUtil.java:716) at org.apache.hadoop.hbase.codec.KeyValueCodecWithTags$KeyValueDecoder.parseCell(KeyValueCodecWithTags.java:81) at org.apache.hadoop.hbase.codec.BaseDecoder.advance(BaseDecoder.java:68) at org.apache.hadoop.hbase.wal.WALEdit.readFromCells(WALEdit.java:276) at org.apache.hadoop.hbase.regionserver.wal.ProtobufLogReader.readNext(ProtobufLogReader.java:382) at org.apache.hadoop.hbase.regionserver.wal.ReaderBase.next(ReaderBase.java:98) at org.apache.hadoop.hbase.regionserver.wal.ReaderBase.next(ReaderBase.java:86) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.readNextEntryAndRecordReaderPosition(WALEntryStream.java:263) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.tryAdvanceEntry(WALEntryStream.java:176) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.hasNext(WALEntryStream.java:101) at org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceWALReader.readWALEntries(ReplicationSourceWALReader.java:221) at org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceWALReader.run(ReplicationSourceWALReader.java:138) 2020-04-07 03:30:03,678 ERROR [RS_REFRESH_PEER-regionserver/asf905:0-0.replicationSource,2.replicationSource.wal-reader.asf905.gq1.ygridcore.net%2C41391%2C1586230117579,2] regionserver.ReplicationSource(397): Unexpected exception in RS_REFRESH_PEER-regionserver/asf905:0-0.replicationSource,2.replicationSource.wal-reader.asf905.gq1.ygridcore.net%2C41391%2C1586230117579,2 currentPath=hdfs://localhost:37359/user/jenkins/test-data/260e1f0f-a3fd-6192-b1d7-6568614aef58/WALs/asf905.gq1.ygridcore.net,41391,1586230117579/asf905.gq1.ygridcore.net%2C41391%2C1586230117579.1586230122806 java.lang.NullPointerException at org.apache.hadoop.hbase.regionserver.wal.ProtobufLogReader.extractHiddenEof(ProtobufLogReader.java:449) at org.apache.hadoop.hbase.regionserver.wal.ProtobufLogReader.readNext(ProtobufLogReader.java:396) at org.apache.hadoop.hbase.regionserver.wal.ReaderBase.next(ReaderBase.java:98) at org.apache.hadoop.hbase.regionserver.wal.ReaderBase.next(ReaderBase.java:86) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.readNextEntryAndRecordReaderPosition(WALEntryStream.java:263) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.tryAdvanceEntry(WALEntryStream.java:176) at org.apache.hadoop.hbase.replication.regionserver.WALEntryStream.hasNext(WALEntryStream.java:101) at org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceWALReader.readWALEntries(ReplicationSourceWALReader.java:221) at org.apache.hadoop.hbase.replication.regionserver.ReplicationSourceWALReader.run(ReplicationSourceWALReader.java:138)", "author": "huaxiangsun", "createdAt": "2020-04-08T01:11:53Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/ProtobufLogReader.java", "diffHunk": "@@ -445,7 +445,7 @@ private IOException extractHiddenEof(Exception ex) {\n         && ex.getCause() != null && ex.getCause() instanceof IOException) {\n       ioEx = (IOException)ex.getCause();\n     }\n-    if (ioEx != null) {\n+    if ((ioEx != null) && (ioEx.getMessage() != null)) {", "originalCommit": "328b048ee94b4a7275133c6fc6bb9532300a260a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMjM1Mw==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405202353", "bodyText": "I think we could do this\ncatch (InterruptedException | ReplicationRuntimeException e) {\n  blabla\n}", "author": "Apache9", "createdAt": "2020-04-08T01:12:47Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "diffHunk": "@@ -122,6 +122,10 @@ public final void run() {\n       } catch (InterruptedException e) {\n         LOG.trace(\"Interrupted while waiting for next replication entry batch\", e);\n         Thread.currentThread().interrupt();\n+      } catch (ReplicationRuntimeException rre) {", "originalCommit": "328b048ee94b4a7275133c6fc6bb9532300a260a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMzE5OA==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405203198", "bodyText": "Will do, and updated the patch to fix the NullPointerException as well, thanks.", "author": "huaxiangsun", "createdAt": "2020-04-08T01:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMjUwNg==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405202506", "bodyText": "Add a  so it will not be reformated by IDE.", "author": "Apache9", "createdAt": "2020-04-08T01:13:23Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationRuntimeException.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.replication.regionserver;\n+\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/**\n+ * This exception is thrown when replication source is terminated and source threads got\n+ * interrupted.\n+ *", "originalCommit": "328b048ee94b4a7275133c6fc6bb9532300a260a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMjY3Ng==", "url": "https://github.com/apache/hbase/pull/1441#discussion_r405202676", "bodyText": "Good.", "author": "Apache9", "createdAt": "2020-04-08T01:13:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/ProtobufLogReader.java", "diffHunk": "@@ -445,7 +445,7 @@ private IOException extractHiddenEof(Exception ex) {\n         && ex.getCause() != null && ex.getCause() instanceof IOException) {\n       ioEx = (IOException)ex.getCause();\n     }\n-    if (ioEx != null) {\n+    if ((ioEx != null) && (ioEx.getMessage() != null)) {", "originalCommit": "328b048ee94b4a7275133c6fc6bb9532300a260a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "306ce75e4dc7d78a63f31b84260b2ac456c9535a", "url": "https://github.com/apache/hbase/commit/306ce75e4dc7d78a63f31b84260b2ac456c9535a", "message": "HBASE-24120 Flakey Test: TestReplicationAdminWithClusters timeout", "committedDate": "2020-04-08T06:13:50Z", "type": "commit"}, {"oid": "306ce75e4dc7d78a63f31b84260b2ac456c9535a", "url": "https://github.com/apache/hbase/commit/306ce75e4dc7d78a63f31b84260b2ac456c9535a", "message": "HBASE-24120 Flakey Test: TestReplicationAdminWithClusters timeout", "committedDate": "2020-04-08T06:13:50Z", "type": "forcePushed"}]}