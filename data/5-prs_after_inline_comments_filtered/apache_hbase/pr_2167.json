{"pr_number": 2167, "pr_title": "HBASE-24791 Improve HFileOutputFormat2 to avoid always call getTableRelativePath method", "pr_createdAt": "2020-07-29T06:49:38Z", "pr_url": "https://github.com/apache/hbase/pull/2167", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4NDg4NQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462084885", "bodyText": "Remove HBASE-24790  related change in this PR.", "author": "pankaj72981", "createdAt": "2020-07-29T07:09:15Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/SplitLogCounters.java", "diffHunk": "@@ -32,8 +32,6 @@\n   public final static LongAdder tot_mgr_log_split_batch_start = new LongAdder();\n   public final static LongAdder tot_mgr_log_split_batch_success = new LongAdder();\n   public final static LongAdder tot_mgr_log_split_batch_err = new LongAdder();\n-  public final static LongAdder tot_mgr_new_unexpected_wals = new LongAdder();", "originalCommit": "e7553034bd68b13666e4571530974df0a7625ebd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjMxOQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462102319", "bodyText": "Thanks for view @pankaj72981\nI will remove the HBASE-24790 related change in this PR", "author": "utf7", "createdAt": "2020-07-29T07:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4NDg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwNTAwMA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462105000", "bodyText": "That is a nice find.\nBTW reading this part of code, I think so much of optimization we can do.  It might not be relevant as this change. Though good to do IMO\n...\n} else {\ntableNameBytes = Bytes.toBytes(writeTableNames);\n}\nString tableName = Bytes.toString(tableNameBytes);\n...\nOnly in case of multiTable, we need create tableName  and tableNameBytes  again and again for every write. So we can make sure this is created at 1st and do not create every time for not multiTable case.\nprivate Path getTableRelativePath(byte[] tableNameBytes) {\nString tableName = Bytes.toString(tableNameBytes);\nString[] tableNameParts = tableName.split(\":\");\nPath tableRelPath = new Path(tableName.split(\":\")[0]);\nif (tableNameParts.length > 1) {\ntableRelPath = new Path(tableRelPath, tableName.split(\":\")[1]);\n}\nreturn tableRelPath;\n}\nsplit is done 3 times. We can just refer tableNameParts[0], tableNameParts[1] and other places.\nCan u pls include these kind of fixes also in PR?", "author": "anoopsjohn", "createdAt": "2020-07-29T07:47:48Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -248,7 +248,6 @@ public void write(ImmutableBytesWritable row, V cell) throws IOException {\n           tableNameBytes = Bytes.toBytes(writeTableNames);\n         }\n         String tableName = Bytes.toString(tableNameBytes);\n-        Path tableRelPath = getTableRelativePath(tableNameBytes);", "originalCommit": "e7553034bd68b13666e4571530974df0a7625ebd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMDkwNw==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462120907", "bodyText": "tableName split 3 times int  getTableRelativePath method has fixed in this PR\ni will do some other fixes  in next commit , the code there is a little mess", "author": "utf7", "createdAt": "2020-07-29T08:15:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwNTAwMA=="}], "type": "inlineReview"}, {"oid": "68dcef9376b8ec9e5f97834d53a439e7d40bed9e", "url": "https://github.com/apache/hbase/commit/68dcef9376b8ec9e5f97834d53a439e7d40bed9e", "message": "HBASE-24791 Improve HFileOutputFormat2 to avoid always call getTableRelativePath method", "committedDate": "2020-07-29T09:14:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwMzczNw==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462203737", "bodyText": "Remove extra semicolon at end.", "author": "pankaj72981", "createdAt": "2020-07-29T10:36:41Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -222,6 +222,7 @@ public RegionLocator getRegionLocator() {\n       private final Map<byte[], WriterLength> writers = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n       private final Map<byte[], byte[]> previousRows = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n       private final long now = EnvironmentEdgeManager.currentTime();\n+      private byte[] tableNameBytes =  Bytes.toBytes(writeTableNames);;", "originalCommit": "68dcef9376b8ec9e5f97834d53a439e7d40bed9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMyNTU1NQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462325555", "bodyText": "ok,thanks for ponit it", "author": "utf7", "createdAt": "2020-07-29T14:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwMzczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0MjEyNA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462342124", "bodyText": "has finished", "author": "utf7", "createdAt": "2020-07-29T14:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjIwMzczNw=="}], "type": "inlineReview"}, {"oid": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "url": "https://github.com/apache/hbase/commit/0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "message": "Code format and remove extra semicolon", "committedDate": "2020-07-29T14:05:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4Mzg2NA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462583864", "bodyText": "Does this apply when LOCALITY_SENSITIVE_CONF_KEY check on line 274 is false ?", "author": "tedyu", "createdAt": "2020-07-29T20:57:13Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -274,39 +270,36 @@ public void write(ImmutableBytesWritable row, V cell) throws IOException {\n \n         // create a new WAL writer, if necessary\n         if (wl == null || wl.writer == null) {\n+          InetSocketAddress[] favoredNodes = null;\n           if (conf.getBoolean(LOCALITY_SENSITIVE_CONF_KEY, DEFAULT_LOCALITY_SENSITIVE)) {\n             HRegionLocation loc = null;\n-\n+            String tableName = Bytes.toString(tableNameBytes);\n             if (tableName != null) {\n               try (Connection connection = ConnectionFactory.createConnection(conf);\n-                     RegionLocator locator =\n-                       connection.getRegionLocator(TableName.valueOf(tableName))) {\n+                RegionLocator locator = connection.getRegionLocator(TableName.valueOf(tableName))) {\n                 loc = locator.getRegionLocation(rowKey);\n               } catch (Throwable e) {\n-                LOG.warn(\"Something wrong locating rowkey {} in {}\",\n-                  Bytes.toString(rowKey), tableName, e);\n+                LOG.warn(\"Something wrong locating rowkey {} in {}\", Bytes.toString(rowKey),\n+                  tableName, e);\n                 loc = null;\n-              } }\n-\n+              }\n+            }\n             if (null == loc) {\n               LOG.trace(\"Failed get of location, use default writer {}\", Bytes.toString(rowKey));\n-              wl = getNewWriter(tableNameBytes, family, conf, null);\n             } else {\n               LOG.debug(\"First rowkey: [{}]\", Bytes.toString(rowKey));\n               InetSocketAddress initialIsa =\n                   new InetSocketAddress(loc.getHostname(), loc.getPort());\n               if (initialIsa.isUnresolved()) {\n                 LOG.trace(\"Failed resolve address {}, use default writer\", loc.getHostnamePort());\n-                wl = getNewWriter(tableNameBytes, family, conf, null);\n               } else {\n                 LOG.debug(\"Use favored nodes writer: {}\", initialIsa.getHostString());\n-                wl = getNewWriter(tableNameBytes, family, conf, new InetSocketAddress[] { initialIsa\n-                });\n+                favoredNodes = new InetSocketAddress[] { initialIsa};", "originalCommit": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3MjQwMQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r462672401", "bodyText": "Yes, if the LOCALITY_SENSITIVE_CONF_KEY  is false or get locality failed,the favoredNodes  will be null\nif LOCALITY_SENSITIVE_CONF_KEY   = true and get localicy success ,the favoredNodes will be not null\nsame logic with before , just code clean\nbefore this pr, too much  wl = getNewWriter  in the code", "author": "utf7", "createdAt": "2020-07-30T00:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4Mzg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3MzAwOA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464173008", "bodyText": "Looks like a format issue here?", "author": "anoopsjohn", "createdAt": "2020-08-03T03:12:39Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -274,39 +270,36 @@ public void write(ImmutableBytesWritable row, V cell) throws IOException {\n \n         // create a new WAL writer, if necessary\n         if (wl == null || wl.writer == null) {\n+          InetSocketAddress[] favoredNodes = null;\n           if (conf.getBoolean(LOCALITY_SENSITIVE_CONF_KEY, DEFAULT_LOCALITY_SENSITIVE)) {\n             HRegionLocation loc = null;\n-\n+            String tableName = Bytes.toString(tableNameBytes);", "originalCommit": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3MzEzOQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464173139", "bodyText": "Here also.", "author": "anoopsjohn", "createdAt": "2020-08-03T03:13:17Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -274,39 +270,36 @@ public void write(ImmutableBytesWritable row, V cell) throws IOException {\n \n         // create a new WAL writer, if necessary\n         if (wl == null || wl.writer == null) {\n+          InetSocketAddress[] favoredNodes = null;\n           if (conf.getBoolean(LOCALITY_SENSITIVE_CONF_KEY, DEFAULT_LOCALITY_SENSITIVE)) {\n             HRegionLocation loc = null;\n-\n+            String tableName = Bytes.toString(tableNameBytes);\n             if (tableName != null) {\n               try (Connection connection = ConnectionFactory.createConnection(conf);\n-                     RegionLocator locator =\n-                       connection.getRegionLocator(TableName.valueOf(tableName))) {\n+                RegionLocator locator = connection.getRegionLocator(TableName.valueOf(tableName))) {\n                 loc = locator.getRegionLocation(rowKey);\n               } catch (Throwable e) {\n-                LOG.warn(\"Something wrong locating rowkey {} in {}\",\n-                  Bytes.toString(rowKey), tableName, e);\n+                LOG.warn(\"Something wrong locating rowkey {} in {}\", Bytes.toString(rowKey),\n+                  tableName, e);\n                 loc = null;\n-              } }\n-\n+              }\n+            }", "originalCommit": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3MzM4NA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464173384", "bodyText": "Pls check format issue at these changed/added lines once.", "author": "anoopsjohn", "createdAt": "2020-08-03T03:14:21Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -376,16 +369,15 @@ private WriterLength getNewWriter(byte[] tableName, byte[] family, Configuration\n         DataBlockEncoding encoding = overriddenEncoding;\n         encoding = encoding == null ? datablockEncodingMap.get(tableAndFamily) : encoding;\n         encoding = encoding == null ? DataBlockEncoding.NONE : encoding;\n-        HFileContextBuilder contextBuilder = new HFileContextBuilder()\n-          .withCompression(compression).withChecksumType(HStore.getChecksumType(conf))\n-          .withBytesPerCheckSum(HStore.getBytesPerChecksum(conf)).withBlockSize(blockSize)\n-          .withColumnFamily(family).withTableName(tableName);\n+        HFileContextBuilder contextBuilder = new HFileContextBuilder().withCompression(compression)", "originalCommit": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIwOTgwMg==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464209802", "bodyText": "i move the compression set config to here and has been use hbase-eclipse-format format the code here", "author": "utf7", "createdAt": "2020-08-03T06:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3MzM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3NDg1NA==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464174854", "bodyText": "Should we do this under writeMultipleTables check?\nprivate byte[] tableNameBytes = (writeMultipleTables)? null: Bytes.toBytes(writeTableNames);", "author": "anoopsjohn", "createdAt": "2020-08-03T03:21:32Z", "path": "hbase-mapreduce/src/main/java/org/apache/hadoop/hbase/mapreduce/HFileOutputFormat2.java", "diffHunk": "@@ -222,6 +222,7 @@ public RegionLocator getRegionLocator() {\n       private final Map<byte[], WriterLength> writers = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n       private final Map<byte[], byte[]> previousRows = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n       private final long now = EnvironmentEdgeManager.currentTime();\n+      private byte[] tableNameBytes = Bytes.toBytes(writeTableNames);", "originalCommit": "0bd75fac9e8256e2c5135a5da7981823aa6afe9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIwNzU4MQ==", "url": "https://github.com/apache/hbase/pull/2167#discussion_r464207581", "bodyText": "yes\uff0ci want to make code simple, so just keep init no matter multiple or not\nIt is a good ponit to  use use writeMultipleTables  check,will address it", "author": "utf7", "createdAt": "2020-08-03T05:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE3NDg1NA=="}], "type": "inlineReview"}, {"oid": "29b4332b96d3d0b871c519a582abd5bf78138995", "url": "https://github.com/apache/hbase/commit/29b4332b96d3d0b871c519a582abd5bf78138995", "message": "Code format", "committedDate": "2020-08-03T06:10:57Z", "type": "commit"}]}