{"pr_number": 2057, "pr_title": "HBASE-24720: Meta replicas not cleaned when disabled", "pr_createdAt": "2020-07-13T13:00:40Z", "pr_url": "https://github.com/apache/hbase/pull/2057", "timeline": [{"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b", "url": "https://github.com/apache/hbase/commit/1baf3ad44e479f1e9bb46a5661f177a332efc30b", "message": "clean up after disabling meta replcation\n\n- make sure to always clean up excess meta replicas not just when their\nnumber get decreased\n- make sure NotServingRegionException is handled properly even when\nwrapped\n- add test", "committedDate": "2020-07-01T13:57:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453745766", "bodyText": "This change is related to this PR?", "author": "virajjasani", "createdAt": "2020-07-13T15:42:33Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -715,7 +716,10 @@ public static void closeRegionSilentlyAndWait(AsyncClusterConnection connection,\n           return;\n         }\n       } catch (IOException ioe) {\n-        if (ioe instanceof NotServingRegionException) {\n+        if (ioe instanceof NotServingRegionException ||\n+          (ioe instanceof RemoteWithExtrasException &&\n+            ((RemoteWithExtrasException)ioe).unwrapRemoteException()\n+              instanceof NotServingRegionException)) {", "originalCommit": "1baf3ad44e479f1e9bb46a5661f177a332efc30b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzMTE1Mg==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454231152", "bodyText": "Yes, it is. The excess meta replicas are not assigned so when we try to close them a NotServingRegionException is thrown. Unfortunately it gets wrapped in a RemoteWithExtrasException which was not handled so the logic kept trying to close the region not realizing it was not necessary.", "author": "BukrosSzabolcs", "createdAt": "2020-07-14T09:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwODYzNA==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454508634", "bodyText": "Sounds good, I thought it was specific to unit test and only in the case of unit test (based on config), this is happening but yeah if this is generic, we are good.\nThanks @BukrosSzabolcs", "author": "virajjasani", "createdAt": "2020-07-14T17:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDY2OA==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814668", "bodyText": "The parameter order for assertEquals should be switched.", "author": "petersomogyi", "createdAt": "2020-07-13T17:32:48Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);", "originalCommit": "1baf3ad44e479f1e9bb46a5661f177a332efc30b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMjkwOA==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454322908", "bodyText": "Switched", "author": "BukrosSzabolcs", "createdAt": "2020-07-14T12:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDc2Nw==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814767", "bodyText": "The parameter order for assertEquals should be switched.", "author": "petersomogyi", "createdAt": "2020-07-13T17:32:58Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);\n+\n+    final HMaster master = TEST_UTIL.getMiniHBaseCluster().getMaster();\n+    master.stop(\"Restarting\");\n+    TEST_UTIL.waitFor(30000, () -> master.isStopped());\n+    TEST_UTIL.getMiniHBaseCluster().getConfiguration().setInt(HConstants.META_REPLICAS_NUM, 1);\n+\n+    JVMClusterUtil.MasterThread newMasterThread = TEST_UTIL.getMiniHBaseCluster().startMaster();\n+    final HMaster newMaster = newMasterThread.getMaster();\n+\n+    //wait until new master finished meta replica assignment logic\n+    TEST_UTIL.waitFor(30000, () -> newMaster.getMasterQuotaManager() != null);\n+    zkw = TEST_UTIL.getZooKeeperWatcher();\n+    metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 1);", "originalCommit": "1baf3ad44e479f1e9bb46a5661f177a332efc30b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMjk1OA==", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454322958", "bodyText": "Switched", "author": "BukrosSzabolcs", "createdAt": "2020-07-14T12:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDc2Nw=="}], "type": "inlineReview"}, {"oid": "6ffa272b333d995095f548eed841be5363af9138", "url": "https://github.com/apache/hbase/commit/6ffa272b333d995095f548eed841be5363af9138", "message": "HBASE-24720: Meta replicas not cleaned when disabled\n\ncheckstyle\nfix assertEquals param order", "committedDate": "2020-07-14T12:15:29Z", "type": "commit"}]}