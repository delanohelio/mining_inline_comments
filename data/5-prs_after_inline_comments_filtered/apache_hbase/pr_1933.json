{"pr_number": 1933, "pr_title": "HBASE-24588 : Submit task for NormalizationPlan", "pr_createdAt": "2020-06-19T13:54:54Z", "pr_url": "https://github.com/apache/hbase/pull/1933", "timeline": [{"oid": "86c475c539184ca5e853c3e4dbe2f6569781643b", "url": "https://github.com/apache/hbase/commit/86c475c539184ca5e853c3e4dbe2f6569781643b", "message": "HBASE-24588 : Submit task for NormalizationPlan", "committedDate": "2020-06-19T13:51:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQ4Nw==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443664487", "bodyText": "This changes behaviors for normalizer. Can we give some timeout for blocking so it wont block forever if something goes wrong with one of plans?", "author": "huaxiangsun", "createdAt": "2020-06-22T15:59:06Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1957,17 +1959,27 @@ public boolean normalizeRegions() throws IOException {\n             continue;\n           }\n \n-          // as of this writing, `plan.execute()` is non-blocking, so there's no artificial rate-\n-          // limiting of merge requests due to this serial loop.\n+          // as of this writing, `plan.submit()` is non-blocking and uses Async Admin APIs to\n+          // submit task , so there's no artificial rate-\n+          // limiting of merge/split requests due to this serial loop.\n           for (NormalizationPlan plan : plans) {\n-            plan.execute(admin);\n+            Future<Void> future = plan.submit(admin);\n+            submittedPlanList.add(future);\n             if (plan.getType() == PlanType.SPLIT) {\n               splitPlanCount++;\n             } else if (plan.getType() == PlanType.MERGE) {\n               mergePlanCount++;\n             }\n           }\n         }\n+        for (Future<?> submittedPlan : submittedPlanList) {\n+          try {\n+            submittedPlan.get();", "originalCommit": "86c475c539184ca5e853c3e4dbe2f6569781643b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY4MDA1MA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443680050", "bodyText": "True, there are either of these options we can follow:\n\nTimeout with Future.get()\nPerform all .get() operations asynchronously\n\nWith huge no of submitted plans, do you think it makes sense to even perform .get() asynchronously by ThreadPoolExecutor and let it block until all plans are done and even update normalizationPlanFailureCount count. What do you think?", "author": "virajjasani", "createdAt": "2020-06-22T16:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNDYyNQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443704625", "bodyText": "I don't think the counter as a metric will help an operator very much. Regions can split or merge in the background, causing a planed action to fail. The failure should be logged, I think (maybe the normal split/merge pathways do this already? I haven't checked).\nIt would be nice to have a final log message for the normalizer run that says something like \"successfully executed x of y normalization actions.\"", "author": "ndimiduk", "createdAt": "2020-06-22T17:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3NTY0OA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443875648", "bodyText": "As Nick commented, need to think about the purpose of this change. I think the purpose is to know the result of plans, which comes with cost.\n1). Timeout with Future.get().\nWhen it times out, we do not know if plan succeeds or not. The only info it gives us is that the plan does not finish within a certain amount of time.\n2). Perform all.get() asynchronously.\nIf get() blocks for whatever reason, there will be huge number of threads blocking for get(), system resource leak.\nMaybe the best approach is per Nick's comments, log how many plans submitted. If some plans fail, we can go to procedure system for root cause.", "author": "huaxiangsun", "createdAt": "2020-06-22T23:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NDQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NTU5OA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443665598", "bodyText": "Do not see count is being used. Want to add a logging message at the end to see how many plans fail.", "author": "huaxiangsun", "createdAt": "2020-06-22T16:00:44Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1957,17 +1959,27 @@ public boolean normalizeRegions() throws IOException {\n             continue;\n           }\n \n-          // as of this writing, `plan.execute()` is non-blocking, so there's no artificial rate-\n-          // limiting of merge requests due to this serial loop.\n+          // as of this writing, `plan.submit()` is non-blocking and uses Async Admin APIs to\n+          // submit task , so there's no artificial rate-\n+          // limiting of merge/split requests due to this serial loop.\n           for (NormalizationPlan plan : plans) {\n-            plan.execute(admin);\n+            Future<Void> future = plan.submit(admin);\n+            submittedPlanList.add(future);\n             if (plan.getType() == PlanType.SPLIT) {\n               splitPlanCount++;\n             } else if (plan.getType() == PlanType.MERGE) {\n               mergePlanCount++;\n             }\n           }\n         }\n+        for (Future<?> submittedPlan : submittedPlanList) {\n+          try {\n+            submittedPlan.get();\n+          } catch (Exception e) {\n+            normalizationPlanFailureCount++;", "originalCommit": "86c475c539184ca5e853c3e4dbe2f6569781643b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY3ODQxNg==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443678416", "bodyText": "Yeah sure, we can put logger but my intention was to expose this as metric. Intentionally kept this as is for now, if you and other reviewers are fine with exposing this count as metric, we should be good to add it.", "author": "virajjasani", "createdAt": "2020-06-22T16:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNDQ2Nw==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443704467", "bodyText": "Going through the client's admin interface seems unnecessary for this as well. There's no way, for example, to log the PID of the action procedure that failed (unless it happens to be included in an exception message).\n\nCan the action be taken via the MasterServices interface?\nMaybe it's fine to not wait on these actions, so long as the PIDs are successfully submitted. I wonder what kind of back-pressure the system has, though, if multiple normalizer runs result in 1000's of split/merge actions that can't be completed backing up over time. Right now, our protection against this is the lock against multiple concurrent normalizer runs.", "author": "ndimiduk", "createdAt": "2020-06-22T17:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MzUzOQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443783539", "bodyText": "Although going through client interface is not necessary, in some way it might simplify things:\n\nWe won't have to re-write the code to convert encodedRegionName to RegionInfo, derive TableName etc and then use MasterServices interface, which requires additional info.\nSince our goal is to submit async plans and not execute blocking operations, Admin interface already has nice non-blocking utility, which is again something we will have to implement on our own if we directly want to use MasterServices (which does use ProcV2 but we want to finally log: x/y plans succeeded, and for that to happen, using Future.get() and handling Exceptions sound better plan).", "author": "virajjasani", "createdAt": "2020-06-22T19:40:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwMzUyMw==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443803523", "bodyText": "Maybe we don't actually want to log \"plans succeeded\". Maybe it's enough that we log \"N plans submitted\". I would be okay with that. Even better if the debug level could log the PIDs  of the submitted plans, which, I believe, requires going through MasterServices.", "author": "ndimiduk", "createdAt": "2020-06-22T20:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2NTU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY5NjYxMA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443696610", "bodyText": "Can this be made final as well?", "author": "ndimiduk", "createdAt": "2020-06-22T16:51:27Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java", "diffHunk": "@@ -1294,7 +1294,7 @@ private void checkAndGetTableName(byte[] encodeRegionName, AtomicReference<Table\n         return;\n       }\n \n-      MergeTableRegionsRequest request = null;\n+      MergeTableRegionsRequest request;", "originalCommit": "86c475c539184ca5e853c3e4dbe2f6569781643b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwNzI5MA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443707290", "bodyText": "No need for an anonymous class, just use CompletableFuture.completedFuture.", "author": "ndimiduk", "createdAt": "2020-06-22T17:10:54Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/EmptyNormalizationPlan.java", "diffHunk": "@@ -44,7 +45,34 @@ public static EmptyNormalizationPlan getInstance(){\n    * No-op for empty plan.\n    */\n   @Override\n-  public void execute(Admin admin) {\n+  public Future<Void> submit(Admin admin) {\n+    return new Future<Void>() {", "originalCommit": "86c475c539184ca5e853c3e4dbe2f6569781643b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7ab8efc24f7bb8c69a743fe9f3c387e57783627", "url": "https://github.com/apache/hbase/commit/c7ab8efc24f7bb8c69a743fe9f3c387e57783627", "message": "addressing review comments", "committedDate": "2020-06-22T19:28:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwNDg3OA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443804878", "bodyText": "yes please for method references, \ud83d\udc4d", "author": "ndimiduk", "createdAt": "2020-06-22T20:24:20Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java", "diffHunk": "@@ -1304,8 +1304,8 @@ private void checkAndGetTableName(byte[] encodeRegionName, AtomicReference<Table\n       }\n \n       addListener(\n-        this.<MergeTableRegionsRequest, MergeTableRegionsResponse> procedureCall(tableName, request,\n-          (s, c, req, done) -> s.mergeTableRegions(c, req, done), (resp) -> resp.getProcId(),\n+        this.procedureCall(tableName, request,\n+          MasterService.Interface::mergeTableRegions, MergeTableRegionsResponse::getProcId,", "originalCommit": "c7ab8efc24f7bb8c69a743fe9f3c387e57783627", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwNTQzMQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443805431", "bodyText": "nit: i like to include a unit in these types of constants. i.e., NORMALIZATION_PLAN_WAIT_TIMEOUT_SEC.", "author": "ndimiduk", "createdAt": "2020-06-22T20:25:19Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -473,6 +473,10 @@ public void run() {\n   // Cached clusterId on stand by masters to serve clusterID requests from clients.\n   private final CachedClusterId cachedClusterId;\n \n+  // Split/Merge Normalization plan executes asynchronously and the caller blocks on\n+  // waiting max 5 sec for single plan to complete with success/failure.\n+  private static final int NORMALIZATION_PLAN_WAIT_TIMEOUT = 5;", "originalCommit": "c7ab8efc24f7bb8c69a743fe9f3c387e57783627", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwNTYzMQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r443805631", "bodyText": "I'm still not convinced we should do this, per my other comment :)", "author": "ndimiduk", "createdAt": "2020-06-22T20:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgwNTQzMQ=="}], "type": "inlineReview"}, {"oid": "66a566b8248e0e8c67bc6ed587c2c479a17826a1", "url": "https://github.com/apache/hbase/commit/66a566b8248e0e8c67bc6ed587c2c479a17826a1", "message": "use MasterServices to perform split/merge", "committedDate": "2020-06-23T14:37:46Z", "type": "commit"}, {"oid": "bc4d0d3fd3ce06ac301dcb279110b1720332967c", "url": "https://github.com/apache/hbase/commit/bc4d0d3fd3ce06ac301dcb279110b1720332967c", "message": "update comment", "committedDate": "2020-06-24T13:25:47Z", "type": "commit"}, {"oid": "0071d872c013a6718a428a48c305af085dc6e107", "url": "https://github.com/apache/hbase/commit/0071d872c013a6718a428a48c305af085dc6e107", "message": "use constant NO_NONCE", "committedDate": "2020-06-24T13:30:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5MTQyMA==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r445191420", "bodyText": "nit: \"means the request was submitted successfully.\"", "author": "ndimiduk", "createdAt": "2020-06-24T21:49:18Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -833,6 +833,9 @@ void unassign(byte[] regionName, boolean force)\n \n   /**\n    * Invoke region normalizer. Can NOT run for various reasons.  Check logs.\n+   * This is a non-blocking invocation to region normalizer. If return value is true, it means\n+   * the invocation was successful. We need to check logs for the details of which regions", "originalCommit": "0071d872c013a6718a428a48c305af085dc6e107", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5MjYxMQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r445192611", "bodyText": "@huaxiangsun does the pid -1 carry a special meaning? Just in case...", "author": "ndimiduk", "createdAt": "2020-06-24T21:51:57Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/normalizer/EmptyNormalizationPlan.java", "diffHunk": "@@ -44,7 +44,8 @@ public static EmptyNormalizationPlan getInstance(){\n    * No-op for empty plan.\n    */\n   @Override\n-  public void execute(Admin admin) {\n+  public long submit(MasterServices masterServices) throws IOException {\n+    return -1;", "originalCommit": "0071d872c013a6718a428a48c305af085dc6e107", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc5NjIxOQ==", "url": "https://github.com/apache/hbase/pull/1933#discussion_r445796219", "bodyText": "Actually, this class isn't even used. I think you can delete it.", "author": "ndimiduk", "createdAt": "2020-06-25T19:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE5MjYxMQ=="}], "type": "inlineReview"}, {"oid": "15a00ee5f40cd00e30711803dad1fe63cc2411f8", "url": "https://github.com/apache/hbase/commit/15a00ee5f40cd00e30711803dad1fe63cc2411f8", "message": "addressing review comments", "committedDate": "2020-06-26T11:51:04Z", "type": "commit"}]}