{"pr_number": 1102, "pr_title": "HBASE-23752: Fix remaining test failures from nightly runs", "pr_createdAt": "2020-01-28T21:03:30Z", "pr_url": "https://github.com/apache/hbase/pull/1102", "timeline": [{"oid": "f8e6e20c866322284eadce2f58b813bc5903e836", "url": "https://github.com/apache/hbase/commit/f8e6e20c866322284eadce2f58b813bc5903e836", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-28T23:35:30Z", "type": "forcePushed"}, {"oid": "efa33a6b3d98219de69d2819957d380ea57be62d", "url": "https://github.com/apache/hbase/commit/efa33a6b3d98219de69d2819957d380ea57be62d", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-29T00:55:19Z", "type": "forcePushed"}, {"oid": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "url": "https://github.com/apache/hbase/commit/65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-29T05:41:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTAzMw==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r372515033", "bodyText": "Why is this test forced onto the blocking rpc client? Can/Should it be parameterized over both implementations?\ncan we not use the MasterRegistry with hedged rpcs disabled? It appears this configuration is supported by the MasterRegistry constructor.", "author": "ndimiduk", "createdAt": "2020-01-29T17:10:34Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -431,9 +431,13 @@ public static void setupCluster() throws Exception {\n         UTIL.getDataTestDir(\"keytab\").toUri().getPath());\n     final MiniKdc kdc = UTIL.setupMiniKdc(KEYTAB_FILE);\n \n-    // Switch back to NIO for now.\n+    // Switch to blocking RPC impl.\n     CONF.set(RpcClientFactory.CUSTOM_RPC_CLIENT_IMPL_CONF_KEY, BlockingRpcClient.class.getName());\n     CONF.set(RpcServerFactory.CUSTOM_RPC_SERVER_IMPL_CONF_KEY, SimpleRpcServer.class.getName());\n+    // Set the connection registry to ZKConnectionRegistry since hedging is not supported on\n+    // blocking rpc clients.", "originalCommit": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUzMDQ1NA==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r372530454", "bodyText": "Why is this test forced onto the blocking rpc client? Can/Should it be parameterized over both implementations?\n\nNot totally sure why it should only be a blocking rpc client (and a SimpleRpcServer impl). @joshelser Any idea? I see that you are the author of this test.\n\ncan we not use the MasterRegistry with hedged rpcs disabled? It appears this configuration is supported by the MasterRegistry constructor.\n\nWe can. But my comment above has nothing to do with whether hedging is enabled/disabled. HedgingRpcChannel is a non-blocking channel implementation. Using a non-blocking-channel wrapped over a blocking-rpc-connection defeats the purpose.", "author": "bharathv", "createdAt": "2020-01-29T17:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NTEwMQ==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373065101", "bodyText": "Why is this test forced onto the blocking rpc client? Can/Should it be parameterized over both implementations?\n\nOversight on my part! Like Nick says -- we should use both via parameterization. There's another test which does this .... TestSecureIPC!\nDo you want to add that parameterization as a part of this PR? Or I can open up an issue and fix this test (as the negligent author ;)). LMK!", "author": "joshelser", "createdAt": "2020-01-30T16:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMTkzMQ==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373321931", "bodyText": "No worries, I parameterized it. Thanks for the quick response.", "author": "bharathv", "createdAt": "2020-01-31T05:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTAzMw=="}], "type": "inlineReview"}, {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993", "url": "https://github.com/apache/hbase/commit/c371dab95388cf1bab15d88c9449e0edd46c7993", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-31T05:30:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373525226", "bodyText": "There's a throws Exception on run() so we need  a fail() \"close\" to the return null. Right now, an exception other than MasterRegistryFetchException and RetriesExhaustedException would not cause a unit test failure.\nYou can just move the fail from inside the try, next to this return null and change the message to be something like Expected an authentication failure.", "author": "joshelser", "createdAt": "2020-01-31T15:04:17Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -527,12 +568,22 @@ public void testNegativeAuthentication() throws Exception {\n     user1.addToken(createPasswordToken(\"user1\", \"definitely not the password\", clusterId));\n     user1.doAs(new PrivilegedExceptionAction<Void>() {\n       @Override public Void run() throws Exception {\n+        // Depending on the registry in use, the following code can throw exceptions at different\n+        // places. Master registry fails at the createConnection() step because the RPC to the\n+        // master fails with sasl auth. With ZK registry, connection creation succeeds (since there\n+        // is no RPC to HBase services involved) but the subsequent get() fails. The root cause\n+        // should still be a SaslException in both the cases.\n         try (Connection conn = ConnectionFactory.createConnection(clientConf);\n             Table t = conn.getTable(tableName)) {\n           t.get(new Get(Bytes.toBytes(\"r1\")));\n           fail(\"Should not successfully authenticate with HBase\");\n-          return null;\n+        } catch (MasterRegistryFetchException mfe) {\n+          Throwable cause = mfe.getCause();\n+          assertTrue(cause.getMessage(), cause.getMessage().contains(\"SaslException\"));\n+        } catch (RetriesExhaustedException re) {\n+          assertTrue(re.getMessage(), re.getMessage().contains(\"SaslException\"));\n         }\n+        return null;", "originalCommit": "c371dab95388cf1bab15d88c9449e0edd46c7993", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU4MTk5NQ==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373581995", "bodyText": "Right now, an exception other than MasterRegistryFetchException and RetriesExhaustedException would not cause a unit test failure.\n\nNot sure I follow you, the exception should be propagated back to the test (since it is not caught) and it should fail, no? I tried the following it works (meaning the IAE is thrown by the unit test runner). Did I miss something?\nuser1.doAs(new PrivilegedExceptionAction<Void>() {\n     @Override public Void run() throws Exception {\n       // Depending on the registry in use, the following code can throw exceptions at different\n       // places. Master registry fails at the createConnection() step because the RPC to the\n       // master fails with sasl auth. With ZK registry, connection creation succeeds (since there\n       // is no RPC to HBase services involved) but the subsequent get() fails. The root cause\n       // should still be a SaslException in both the cases.\n       try (Connection conn = ConnectionFactory.createConnection(clientConf);\n           Table t = conn.getTable(tableName)) {\n         if (true) {\n           throw new IllegalArgumentException(\"test\");\n         }\n         t.get(new Get(Bytes.toBytes(\"r1\")));\n\njava.lang.IllegalArgumentException: test\n\n   at org.apache.hadoop.hbase.security.provider.TestCustomSaslAuthenticationProvider$3.run(TestCustomSaslAuthenticationProvider.java:579)\n   at org.apache.hadoop.hbase.security.provider.TestCustomSaslAuthenticationProvider$3.run(TestCustomSaslAuthenticationProvider.java:569)\n   at java.security.AccessController.doPrivileged(Native Method)\n   at javax.security.auth.Subject.doAs(Subject.java:422)", "author": "bharathv", "createdAt": "2020-01-31T16:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxODk4OQ==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373618989", "bodyText": "You're right that the thrown, uncaught exception will ultimately cause the test to fail, but you're removing the nice exception stating the reason the test failed :)", "author": "joshelser", "createdAt": "2020-01-31T18:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1ODEyNg==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373658126", "bodyText": "Okay, added back a nice exception. The issue with moving fail() towards the end is that we need sprinkle the \"return null\" statements in the catch blocks. This is more readable IMO.", "author": "bharathv", "createdAt": "2020-01-31T19:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY2NTM1Ng==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373665356", "bodyText": "Yup, what you did is fine. Thanks!", "author": "joshelser", "createdAt": "2020-01-31T20:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg=="}], "type": "inlineReview"}, {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "url": "https://github.com/apache/hbase/commit/298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-31T19:52:18Z", "type": "commit"}, {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "url": "https://github.com/apache/hbase/commit/298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state.", "committedDate": "2020-01-31T19:52:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0OTkxOA==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r374249918", "bodyText": "Sucks that we have to spin the new cluster for every test method. It is not possible to do this cluster configuration and initialization in the constructor instead?", "author": "ndimiduk", "createdAt": "2020-02-03T17:56:15Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -443,9 +464,23 @@ public static void setupCluster() throws Exception {\n         InMemoryServerProvider.class.getName());\n     CONF.set(SaslClientAuthenticationProviders.SELECTOR_KEY,\n         InMemoryProviderSelector.class.getName());\n+    createBaseCluster(UTIL, KEYTAB_FILE, kdc);\n+  }\n \n-    CLUSTER = createCluster(UTIL, KEYTAB_FILE, kdc);\n+  @Before\n+  public void setUpBeforeTest() throws Exception {\n+    CONF.unset(HConstants.CLIENT_CONNECTION_REGISTRY_IMPL_CONF_KEY);\n+    CONF.set(RpcClientFactory.CUSTOM_RPC_CLIENT_IMPL_CONF_KEY, rpcClientImpl);\n+    CONF.set(RpcServerFactory.CUSTOM_RPC_SERVER_IMPL_CONF_KEY, rpcServerImpl);\n+    if (rpcClientImpl.equals(BlockingRpcClient.class.getName())) {\n+      // Set the connection registry to ZKConnectionRegistry since hedging is not supported on\n+      // blocking rpc clients.\n+      CONF.set(HConstants.CLIENT_CONNECTION_REGISTRY_IMPL_CONF_KEY,\n+          HConstants.ZK_CONNECTION_REGISTRY_CLASS);\n+    }\n+    CLUSTER = new LocalHBaseCluster(CONF, 1);", "originalCommit": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NTA0OQ==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r374255049", "bodyText": "Ya, unfortunately its the same problem, JUnit calls the ctor for every parameterized test invocation. So we'd need to have some logic like\nif (same instance of params) don't restart\nWe did that in TestFromClientSide but the code becomes ugly. Lucikly, there are fewer tests, so this works out ok here.", "author": "bharathv", "createdAt": "2020-02-03T18:07:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0OTkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NzMxMw==", "url": "https://github.com/apache/hbase/pull/1102#discussion_r374257313", "bodyText": "Okay, makes sense. Thanks.", "author": "ndimiduk", "createdAt": "2020-02-03T18:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0OTkxOA=="}], "type": "inlineReview"}]}