{"pr_number": 1550, "pr_title": "HBASE-24135 TableStateNotFoundException happends when table creation if rsgroup is enable", "pr_createdAt": "2020-04-20T03:41:40Z", "pr_url": "https://github.com/apache/hbase/pull/1550", "timeline": [{"oid": "d7fe1f92d150226958e5ddf5bd7dfa53ff0eb511", "url": "https://github.com/apache/hbase/commit/d7fe1f92d150226958e5ddf5bd7dfa53ff0eb511", "message": "HBASE-24135 TableStateNotFoundException happends when table creation if rsgroup is enable", "committedDate": "2020-04-20T04:01:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MTAzOA==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414271038", "bodyText": "Avoid empty throws javadoc.", "author": "Apache9", "createdAt": "2020-04-24T03:47:37Z", "path": "hbase-rsgroup/src/test/java/org/apache/hadoop/hbase/rsgroup/TestDetermineRSGroupInfoForTable.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.rsgroup;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.NamespaceDescriptor;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.Admin;\n+import org.apache.hadoop.hbase.coprocessor.CoprocessorHost;\n+import org.apache.hadoop.hbase.master.HMaster;\n+import org.apache.hadoop.hbase.regionserver.HRegionServer;\n+import org.apache.hadoop.hbase.rsgroup.RSGroupInfoManagerImpl.RSGroupMappingScript;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Test {@link RSGroupInfoManager#determineRSGroupInfoForTable(TableName)}\n+ */\n+@Category({ MediumTests.class })\n+public class TestDetermineRSGroupInfoForTable {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDetermineRSGroupInfoForTable.class);\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestDetermineRSGroupInfoForTable.class);\n+\n+  private static final HBaseTestingUtility UTIL = new HBaseTestingUtility();\n+\n+  private static HMaster master;\n+\n+  private static Admin admin;\n+\n+  private static RSGroupInfoManager rsGroupInfoManager;\n+\n+  private static RSGroupAdminClient rsGroupAdminClient;\n+\n+  private static final String GROUP_NAME = \"rsg\";\n+\n+  private static final String NAMESPACE_NAME = \"ns\";\n+  private static final String OTHER_NAMESPACE_NAME = \"other\";\n+\n+  private static final TableName TABLE_NAME = TableName.valueOf(NAMESPACE_NAME, \"tb\");\n+\n+  @BeforeClass\n+  public static void setUp() throws Exception {\n+    UTIL.getConfiguration().set(\n+      HConstants.HBASE_MASTER_LOADBALANCER_CLASS,\n+      RSGroupBasedLoadBalancer.class.getName());\n+    UTIL.getConfiguration().set(CoprocessorHost.MASTER_COPROCESSOR_CONF_KEY,\n+      RSGroupAdminEndpoint.class.getName());\n+    UTIL.startMiniCluster(5);\n+    master = UTIL.getMiniHBaseCluster().getMaster();\n+    admin = UTIL.getAdmin();\n+    rsGroupAdminClient = new RSGroupAdminClient(UTIL.getConnection());\n+\n+    HRegionServer rs = UTIL.getHBaseCluster().getRegionServer(0);\n+    rsGroupAdminClient.addRSGroup(GROUP_NAME);\n+    rsGroupAdminClient.moveServers(\n+      Collections.singleton(rs.getServerName().getAddress()), GROUP_NAME);\n+    admin.createNamespace(NamespaceDescriptor.create(NAMESPACE_NAME)\n+      .addConfiguration(RSGroupInfo.NAMESPACE_DESC_PROP_GROUP, GROUP_NAME)\n+      .build());\n+    admin.createNamespace(NamespaceDescriptor.create(OTHER_NAMESPACE_NAME).build());\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws IOException {\n+    admin.deleteNamespace(NAMESPACE_NAME);\n+\n+    UTIL.shutdownMiniCluster();\n+  }\n+\n+  @Before\n+  public void setUpBeforeMethod() throws IOException {\n+    rsGroupInfoManager = RSGroupInfoManagerImpl.getInstance(master);\n+    rsGroupInfoManager.start();\n+  }\n+\n+  @After\n+  public void tearDownAfterMethod() throws IOException {\n+    rsGroupInfoManager = RSGroupInfoManagerImpl.getInstance(master);\n+  }\n+\n+  @Test\n+  public void test1() throws IOException {\n+    RSGroupInfo group =\n+      rsGroupInfoManager.determineRSGroupInfoForTable(TableName.valueOf(\"tb\"));\n+    assertEquals(group.getName(), RSGroupInfo.DEFAULT_GROUP);\n+  }\n+\n+  /**\n+   * determine by namespace config\n+   * @throws IOException", "originalCommit": "d7fe1f92d150226958e5ddf5bd7dfa53ff0eb511", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyOTY3Mw==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414329673", "bodyText": "I've fixed it", "author": "ddupg", "createdAt": "2020-04-24T06:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MTAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MTEwNA==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414271104", "bodyText": "Ditto.", "author": "Apache9", "createdAt": "2020-04-24T03:47:47Z", "path": "hbase-rsgroup/src/test/java/org/apache/hadoop/hbase/rsgroup/TestDetermineRSGroupInfoForTable.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.rsgroup;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.NamespaceDescriptor;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.Admin;\n+import org.apache.hadoop.hbase.coprocessor.CoprocessorHost;\n+import org.apache.hadoop.hbase.master.HMaster;\n+import org.apache.hadoop.hbase.regionserver.HRegionServer;\n+import org.apache.hadoop.hbase.rsgroup.RSGroupInfoManagerImpl.RSGroupMappingScript;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Test {@link RSGroupInfoManager#determineRSGroupInfoForTable(TableName)}\n+ */\n+@Category({ MediumTests.class })\n+public class TestDetermineRSGroupInfoForTable {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDetermineRSGroupInfoForTable.class);\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestDetermineRSGroupInfoForTable.class);\n+\n+  private static final HBaseTestingUtility UTIL = new HBaseTestingUtility();\n+\n+  private static HMaster master;\n+\n+  private static Admin admin;\n+\n+  private static RSGroupInfoManager rsGroupInfoManager;\n+\n+  private static RSGroupAdminClient rsGroupAdminClient;\n+\n+  private static final String GROUP_NAME = \"rsg\";\n+\n+  private static final String NAMESPACE_NAME = \"ns\";\n+  private static final String OTHER_NAMESPACE_NAME = \"other\";\n+\n+  private static final TableName TABLE_NAME = TableName.valueOf(NAMESPACE_NAME, \"tb\");\n+\n+  @BeforeClass\n+  public static void setUp() throws Exception {\n+    UTIL.getConfiguration().set(\n+      HConstants.HBASE_MASTER_LOADBALANCER_CLASS,\n+      RSGroupBasedLoadBalancer.class.getName());\n+    UTIL.getConfiguration().set(CoprocessorHost.MASTER_COPROCESSOR_CONF_KEY,\n+      RSGroupAdminEndpoint.class.getName());\n+    UTIL.startMiniCluster(5);\n+    master = UTIL.getMiniHBaseCluster().getMaster();\n+    admin = UTIL.getAdmin();\n+    rsGroupAdminClient = new RSGroupAdminClient(UTIL.getConnection());\n+\n+    HRegionServer rs = UTIL.getHBaseCluster().getRegionServer(0);\n+    rsGroupAdminClient.addRSGroup(GROUP_NAME);\n+    rsGroupAdminClient.moveServers(\n+      Collections.singleton(rs.getServerName().getAddress()), GROUP_NAME);\n+    admin.createNamespace(NamespaceDescriptor.create(NAMESPACE_NAME)\n+      .addConfiguration(RSGroupInfo.NAMESPACE_DESC_PROP_GROUP, GROUP_NAME)\n+      .build());\n+    admin.createNamespace(NamespaceDescriptor.create(OTHER_NAMESPACE_NAME).build());\n+  }\n+\n+  @AfterClass\n+  public static void tearDown() throws IOException {\n+    admin.deleteNamespace(NAMESPACE_NAME);\n+\n+    UTIL.shutdownMiniCluster();\n+  }\n+\n+  @Before\n+  public void setUpBeforeMethod() throws IOException {\n+    rsGroupInfoManager = RSGroupInfoManagerImpl.getInstance(master);\n+    rsGroupInfoManager.start();\n+  }\n+\n+  @After\n+  public void tearDownAfterMethod() throws IOException {\n+    rsGroupInfoManager = RSGroupInfoManagerImpl.getInstance(master);\n+  }\n+\n+  @Test\n+  public void test1() throws IOException {\n+    RSGroupInfo group =\n+      rsGroupInfoManager.determineRSGroupInfoForTable(TableName.valueOf(\"tb\"));\n+    assertEquals(group.getName(), RSGroupInfo.DEFAULT_GROUP);\n+  }\n+\n+  /**\n+   * determine by namespace config\n+   * @throws IOException\n+   */\n+  @Test\n+  public void test2() throws IOException {\n+    RSGroupInfo group = rsGroupInfoManager.determineRSGroupInfoForTable(TABLE_NAME);\n+    assertEquals(group.getName(), GROUP_NAME);\n+\n+    group = rsGroupInfoManager.determineRSGroupInfoForTable(\n+      TableName.valueOf(OTHER_NAMESPACE_NAME, \"tb\"));\n+    assertEquals(group.getName(), RSGroupInfo.DEFAULT_GROUP);\n+  }\n+\n+  /**\n+   * determine by script\n+   * @throws IOException", "originalCommit": "d7fe1f92d150226958e5ddf5bd7dfa53ff0eb511", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1MDQ5MA==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r423650490", "bodyText": "fixed", "author": "ddupg", "createdAt": "2020-05-12T11:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MjIzNw==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414272237", "bodyText": "This method is removed? Then where will we call assignTableToGroup?", "author": "Apache9", "createdAt": "2020-04-24T03:51:34Z", "path": "hbase-rsgroup/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupAdminEndpoint.java", "diffHunk": "@@ -535,17 +476,22 @@ public void preCreateTableAction(\n       final ObserverContext<MasterCoprocessorEnvironment> ctx,\n       final TableDescriptor desc,\n       final RegionInfo[] regions) throws IOException {\n-    if (!desc.getTableName().isSystemTable() && !rsgroupHasServersOnline(desc)) {\n-      throw new HBaseIOException(\"No online servers in the rsgroup, which table \" +\n-          desc.getTableName().getNameAsString() + \" belongs to\");\n+    if (desc.getTableName().isSystemTable()) {\n+      return;\n+    }\n+    RSGroupInfo rsGroupInfo = groupInfoManager.determineRSGroupInfoForTable(desc.getTableName());\n+    if (rsGroupInfo == null) {\n+      throw new ConstraintException(\"Default RSGroup for this table \" + desc.getTableName()\n+        + \" does not exist.\");\n+    }\n+    if (!RSGroupUtil.rsGroupHasOnlineServer(master, rsGroupInfo)) {\n+      throw new HBaseIOException(\"No online servers in the rsgroup \" + rsGroupInfo.getName()\n+        + \" which table \" + desc.getTableName().getNameAsString() + \" belongs to\");\n+    }\n+    synchronized (groupInfoManager) {\n+      groupInfoManager.moveTables(\n+        Collections.singleton(desc.getTableName()), rsGroupInfo.getName());\n     }\n-  }\n-\n-  // Assign table to default RSGroup.\n-  @Override\n-  public void postCreateTable(ObserverContext<MasterCoprocessorEnvironment> ctx,", "originalCommit": "d7fe1f92d150226958e5ddf5bd7dfa53ff0eb511", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNzM0Nw==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414327347", "bodyText": "Method assignTableToGroup do two things\uff1a\n\ngroupInfoManager.moveTables to store which group that the table belong to\nmove regions. In this case, it always fails.\n\nwe just need to do the first one in preCreateTableAction, CreateTableProcedure will assign regions to right RS via RSGroupableBalancer.", "author": "ddupg", "createdAt": "2020-04-24T06:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MjIzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM5OTgyNw==", "url": "https://github.com/apache/hbase/pull/1550#discussion_r414399827", "bodyText": "Got it.", "author": "Apache9", "createdAt": "2020-04-24T08:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI3MjIzNw=="}], "type": "inlineReview"}, {"oid": "8793e912e9b89ef811bab3d5e18cf9bcf2132d17", "url": "https://github.com/apache/hbase/commit/8793e912e9b89ef811bab3d5e18cf9bcf2132d17", "message": "HBASE-24135 TableStateNotFoundException happends when table creation if rsgroup is enable", "committedDate": "2020-04-24T06:31:58Z", "type": "forcePushed"}, {"oid": "34f9a6a258b880e4300956a0bf6dab3f1894ee15", "url": "https://github.com/apache/hbase/commit/34f9a6a258b880e4300956a0bf6dab3f1894ee15", "message": "HBASE-24135 TableStateNotFoundException happends when table creation if rsgroup is enable", "committedDate": "2020-04-24T06:52:05Z", "type": "commit"}, {"oid": "34f9a6a258b880e4300956a0bf6dab3f1894ee15", "url": "https://github.com/apache/hbase/commit/34f9a6a258b880e4300956a0bf6dab3f1894ee15", "message": "HBASE-24135 TableStateNotFoundException happends when table creation if rsgroup is enable", "committedDate": "2020-04-24T06:52:05Z", "type": "forcePushed"}]}