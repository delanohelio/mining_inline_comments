{"pr_number": 1924, "pr_title": "HBASE-24552 Replica region needs to check if primary region directory\u2026", "pr_createdAt": "2020-06-18T22:25:45Z", "pr_url": "https://github.com/apache/hbase/pull/1924", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNDI0MQ==", "url": "https://github.com/apache/hbase/pull/1924#discussion_r443714241", "bodyText": "This is a mistake then? Master is the authority. If it can't make a call on read replicas, then read replicas are not done right?", "author": "saintstack", "createdAt": "2020-06-22T17:23:46Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/TransitRegionStateProcedure.java", "diffHunk": "@@ -338,6 +345,35 @@ protected Flow executeFromState(MasterProcedureEnv env, RegionStateTransitionSta\n     try {\n       switch (state) {\n         case REGION_STATE_TRANSITION_GET_ASSIGN_CANDIDATE:\n+\n+          // Need to do some sanity check for replica region, if the region does not exist at file\n+          // system, do not try to assign the replica region, log error and return.\n+          // Do not rely on master's in-memory state, primary region got its own life, it can be\n+          // closed, offline for various reasons.", "originalCommit": "3650719184e325c2c241ea1f640befef9c9488ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczNTQ3Mw==", "url": "https://github.com/apache/hbase/pull/1924#discussion_r443735473", "bodyText": "Probably you are right here. The defense in master can be changed to check its in-memory data structures, if master is not aware of the primary region, then there is something wrong. I will move this check to region server' region open.", "author": "huaxiangsun", "createdAt": "2020-06-22T18:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNDI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc5NjgxNw==", "url": "https://github.com/apache/hbase/pull/1924#discussion_r443796817", "bodyText": "Updated to check primary region's inmemory state for defense.", "author": "huaxiangsun", "createdAt": "2020-06-22T20:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNDI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNTA1NA==", "url": "https://github.com/apache/hbase/pull/1924#discussion_r443715054", "bodyText": "Ouch.\nWe need follow-on to fix read replicas so Master is authority?", "author": "saintstack", "createdAt": "2020-06-22T17:25:13Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/TransitRegionStateProcedure.java", "diffHunk": "@@ -338,6 +345,35 @@ protected Flow executeFromState(MasterProcedureEnv env, RegionStateTransitionSta\n     try {\n       switch (state) {\n         case REGION_STATE_TRANSITION_GET_ASSIGN_CANDIDATE:\n+\n+          // Need to do some sanity check for replica region, if the region does not exist at file\n+          // system, do not try to assign the replica region, log error and return.\n+          // Do not rely on master's in-memory state, primary region got its own life, it can be\n+          // closed, offline for various reasons.\n+          if (!RegionReplicaUtil.isDefaultReplica(regionNode.getRegionInfo())) {\n+            MasterFileSystem mfs = env.getMasterServices().getMasterFileSystem();\n+            RegionInfo replicaRI = regionNode.getRegionInfo();\n+            Path tableDir = CommonFSUtils.getTableDir(mfs.getRootDir(), regionNode.getTable());\n+            Path regionDir = FSUtils.getRegionDirFromTableDir(tableDir, replicaRI);\n+            FileSystem fs = mfs.getFileSystem();\n+            // Check if primary region directory exists\n+            if (!fs.exists(regionDir)) {\n+              LOG.error(\n+                \"Cannot assign replica region {} because its primary region {} does not exist\"\n+                  + \" at Filesystem\", replicaRI,\n+                ServerRegionReplicaUtil.getRegionInfoForDefaultReplica(replicaRI));\n+              return Flow.NO_MORE_STATE;\n+            }\n+            // check if .regionInfo exists in primary region\n+            Path regionInfoFile = new Path(regionDir, HRegionFileSystem.REGION_INFO_FILE);\n+            if (!fs.exists(regionInfoFile)) {\n+              LOG.error(\n+                \"Cannot assign replica region {} because region info file does not exist in its\"\n+                  + \" primary region {}\", replicaRI,\n+                ServerRegionReplicaUtil.getRegionInfoForDefaultReplica(replicaRI));\n+              return Flow.NO_MORE_STATE;\n+            }\n+          }", "originalCommit": "3650719184e325c2c241ea1f640befef9c9488ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyNzMxMw==", "url": "https://github.com/apache/hbase/pull/1924#discussion_r443727313", "bodyText": "Yeah, this is planned. Hbck2 needs work to fix any inconsistency for read replica, including but not limited to 1). Check consistency for replica regions (holes/overlaps). Jiras need to be created.", "author": "huaxiangsun", "createdAt": "2020-06-22T17:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNTA1NA=="}], "type": "inlineReview"}, {"oid": "1cabf822600631c324dae0211f98bb9328db31a6", "url": "https://github.com/apache/hbase/commit/1cabf822600631c324dae0211f98bb9328db31a6", "message": "HBASE-24552 Replica region needs to check if primary region directory exists at file system in TransitRegionStateProcedure", "committedDate": "2020-06-22T20:06:24Z", "type": "commit"}, {"oid": "1cabf822600631c324dae0211f98bb9328db31a6", "url": "https://github.com/apache/hbase/commit/1cabf822600631c324dae0211f98bb9328db31a6", "message": "HBASE-24552 Replica region needs to check if primary region directory exists at file system in TransitRegionStateProcedure", "committedDate": "2020-06-22T20:06:24Z", "type": "forcePushed"}]}