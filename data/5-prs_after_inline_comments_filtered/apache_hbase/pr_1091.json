{"pr_number": 1091, "pr_title": "HBASE-23731: De-flake TestFromClientSide", "pr_createdAt": "2020-01-27T00:11:25Z", "pr_url": "https://github.com/apache/hbase/pull/1091", "timeline": [{"oid": "56b798cfe4007557a7d3dc43966f0a4699b4975b", "url": "https://github.com/apache/hbase/commit/56b798cfe4007557a7d3dc43966f0a4699b4975b", "message": "HBASE-23731: De-flake TestFromClientSide\n\nThere were a couple of issues.\n\n- There was a leak of a file descriptor for hbck lock file. This\nwas contributing to all the \"ConnectionRefused\" stack traces since\nit was trying to renew lease for an already expired mini dfs cluster.\nThis issue was there for a while, just that we noticed it now.\n\n- After upgrade to JUnit 4.13, it looks like the behavior for test\ntimeouts has changed. Earlier the timeout seems to have applied for\neach parameterized run, but now it looks like it is applied across\nall the runs.\n\nThis patch fixes both the issues.", "committedDate": "2020-01-27T04:25:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2ODg4OQ==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371068889", "bodyText": "FYI, isTestParameterized is name of a method, not a variable. testParameterized would be the variable name.", "author": "saintstack", "createdAt": "2020-01-27T05:32:54Z", "path": "hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseClassTestRule.java", "diffHunk": "@@ -82,6 +99,49 @@ private static long getTimeoutInSeconds(Class<?> clazz) {\n         clazz.getName() + \" does not have SmallTests/MediumTests/LargeTests in @Category\");\n   }\n \n+  /**\n+   * @param clazz Test class that is running.\n+   * @return the number of parameters for this given test class. If the test is not parameterized or\n+   *   if there is any issue determining the number of parameters, returns 1.\n+   */\n+  private static int getNumParameters(Class<?> clazz) {\n+    RunWith[] runWiths = clazz.getAnnotationsByType(RunWith.class);\n+    boolean isTestParameterized = runWiths != null && Arrays.stream(runWiths).anyMatch(", "originalCommit": "56b798cfe4007557a7d3dc43966f0a4699b4975b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3MjgxNg==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371072816", "bodyText": "renamed.", "author": "bharathv", "createdAt": "2020-01-27T06:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2ODg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2OTAzMg==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371069032", "bodyText": "Can you make a test for this?", "author": "saintstack", "createdAt": "2020-01-27T05:33:54Z", "path": "hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseClassTestRule.java", "diffHunk": "@@ -82,6 +99,49 @@ private static long getTimeoutInSeconds(Class<?> clazz) {\n         clazz.getName() + \" does not have SmallTests/MediumTests/LargeTests in @Category\");\n   }\n \n+  /**\n+   * @param clazz Test class that is running.\n+   * @return the number of parameters for this given test class. If the test is not parameterized or\n+   *   if there is any issue determining the number of parameters, returns 1.\n+   */\n+  private static int getNumParameters(Class<?> clazz) {", "originalCommit": "56b798cfe4007557a7d3dc43966f0a4699b4975b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA4MzQ1OQ==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371083459", "bodyText": "Done.", "author": "bharathv", "createdAt": "2020-01-27T06:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2OTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2OTMyMg==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371069322", "bodyText": "Style nit, rather than have an if with a big indented clause, I'd avoid the indent by testing for the opposite case and just doing an early return if succeeds -- especially when near the opening of a method. No biggie. Just a consideration for future.", "author": "saintstack", "createdAt": "2020-01-27T05:36:17Z", "path": "hbase-common/src/test/java/org/apache/hadoop/hbase/HBaseClassTestRule.java", "diffHunk": "@@ -82,6 +99,49 @@ private static long getTimeoutInSeconds(Class<?> clazz) {\n         clazz.getName() + \" does not have SmallTests/MediumTests/LargeTests in @Category\");\n   }\n \n+  /**\n+   * @param clazz Test class that is running.\n+   * @return the number of parameters for this given test class. If the test is not parameterized or\n+   *   if there is any issue determining the number of parameters, returns 1.\n+   */\n+  private static int getNumParameters(Class<?> clazz) {\n+    RunWith[] runWiths = clazz.getAnnotationsByType(RunWith.class);\n+    boolean isTestParameterized = runWiths != null && Arrays.stream(runWiths).anyMatch(\n+      (r) -> r.value().equals(Parameterized.class));\n+    if (isTestParameterized) {\n+      for (Method method : clazz.getMethods()) {", "originalCommit": "56b798cfe4007557a7d3dc43966f0a4699b4975b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA3Mjg2MQ==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371072861", "bodyText": "Refactored to make more sense. Agree with your comment.", "author": "bharathv", "createdAt": "2020-01-27T06:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA2OTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMzkwMA==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371323900", "bodyText": "NIT: Would it be better to split this one into three separate tests according to their categorization?\nNIT: Better put the Test annotation on a separate line.", "author": "HorizonNet", "createdAt": "2020-01-27T15:55:37Z", "path": "hbase-common/src/test/java/org/apache/hadoop/hbase/TestHBaseClassTestRule.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase;\n+\n+import static junit.framework.TestCase.assertEquals;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import org.apache.hadoop.hbase.testclassification.SmallTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+import org.apache.hbase.thirdparty.com.google.common.collect.Iterables;\n+\n+/**\n+ * Tests HBaseClassTestRule.\n+ */\n+@Category(SmallTests.class)\n+public class TestHBaseClassTestRule {\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(\n+      TestHBaseClassTestRule.class);\n+\n+  // Test input classes of various kinds.\n+  private static class NonParameterizedClass {\n+    void dummy() {\n+    }\n+    int dummy(int a) {\n+      return 0;\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ParameterizedClassWithNoParametersMethod {\n+    void dummy() {\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class InValidParameterizedClass {\n+    // Not valid because parameters method is private.\n+    @Parameters\n+    private static List<Object> parameters() {\n+      return Arrays.asList(1, 2, 3, 4);\n+    }\n+    int dummy(int a) {\n+      return 0;\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ValidParameterizedClass1 {\n+    @Parameters\n+    public static List<Object> parameters() {\n+      return Arrays.asList(1, 2, 3, 4, 5);\n+    }\n+    int dummy(int a) {\n+      return 0;\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ValidParameterizedClass2 {\n+    @Parameters\n+    public static Object[] parameters() {\n+      return new Integer[] {1, 2, 3, 4, 5, 6};\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ValidParameterizedClass3 {\n+    @Parameters\n+    public static Iterable<Integer> parameters() {\n+      return Arrays.asList(1, 2, 3, 4, 5, 6, 7);\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ValidParameterizedClass4 {\n+    @Parameters\n+    public static Collection<Integer> parameters() {\n+      return Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9);\n+    }\n+  }\n+\n+\n+  @RunWith(Parameterized.class)\n+  private static class ExtendedParameterizedClass1 extends ValidParameterizedClass1 {\n+    // Should be inferred from the parent class.\n+    int dummy2(int a) {\n+      return 0;\n+    }\n+  }\n+\n+  @RunWith(Parameterized.class)\n+  private static class ExtendedParameterizedClass2 extends ValidParameterizedClass1 {\n+    // Should override the parent parameters class.\n+    @Parameters\n+    public static List<Object> parameters() {\n+      return Arrays.asList(1, 2, 3);\n+    }\n+  }\n+\n+  @Test public void testNumParameters() {", "originalCommit": "bcc237d965f2ed5d66bcc0975523f6f55bc8c2a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3NDcwMQ==", "url": "https://github.com/apache/hbase/pull/1091#discussion_r371374701", "bodyText": "Better put the Test annotation on a separate line. - Done.\nWould it be better to split this one into three separate tests according to their categorization? - TBH, I don't see much value, I feel it is better to group them together because all of them belong to a single logical test (which is testing the number of parameters).", "author": "bharathv", "createdAt": "2020-01-27T17:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMzkwMA=="}], "type": "inlineReview"}, {"oid": "7c1e6ea9c5665bf8fefea74e0120740447324fa8", "url": "https://github.com/apache/hbase/commit/7c1e6ea9c5665bf8fefea74e0120740447324fa8", "message": "HBASE-23731: De-flake TestFromClientSide\n\nThere were a couple of issues.\n\n- There was a leak of a file descriptor for hbck lock file. This\nwas contributing to all the \"ConnectionRefused\" stack traces since\nit was trying to renew lease for an already expired mini dfs cluster.\nThis issue was there for a while, just that we noticed it now.\n\n- After upgrade to JUnit 4.13, it looks like the behavior for test\ntimeouts has changed. Earlier the timeout seems to have applied for\neach parameterized run, but now it looks like it is applied across\nall the runs.\n\nThis patch fixes both the issues.", "committedDate": "2020-01-27T17:24:58Z", "type": "commit"}, {"oid": "7c1e6ea9c5665bf8fefea74e0120740447324fa8", "url": "https://github.com/apache/hbase/commit/7c1e6ea9c5665bf8fefea74e0120740447324fa8", "message": "HBASE-23731: De-flake TestFromClientSide\n\nThere were a couple of issues.\n\n- There was a leak of a file descriptor for hbck lock file. This\nwas contributing to all the \"ConnectionRefused\" stack traces since\nit was trying to renew lease for an already expired mini dfs cluster.\nThis issue was there for a while, just that we noticed it now.\n\n- After upgrade to JUnit 4.13, it looks like the behavior for test\ntimeouts has changed. Earlier the timeout seems to have applied for\neach parameterized run, but now it looks like it is applied across\nall the runs.\n\nThis patch fixes both the issues.", "committedDate": "2020-01-27T17:24:58Z", "type": "forcePushed"}]}