{"pr_number": 2313, "pr_title": "HBASE-24900 Make retain assignment configurable during SCP", "pr_createdAt": "2020-08-25T18:35:16Z", "pr_url": "https://github.com/apache/hbase/pull/2313", "timeline": [{"oid": "743876d60ff596e9c3081e655352cc93729502b6", "url": "https://github.com/apache/hbase/commit/743876d60ff596e9c3081e655352cc93729502b6", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-08-27T15:34:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5ODk3NQ==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r478798975", "bodyText": "On a method call, we set a state variable. !  Is that really wanted?  Seems before also this was happening but always set to true.  Now it can change.  I did not see the class how this var being used.  But can we check pls?", "author": "anoopsjohn", "createdAt": "2020-08-28T02:40:28Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/TransitRegionStateProcedure.java", "diffHunk": "@@ -416,13 +416,8 @@ public void reportTransition(MasterProcedureEnv env, RegionStateNode regionNode,\n \n   // Should be called with RegionStateNode locked\n   public void serverCrashed(MasterProcedureEnv env, RegionStateNode regionNode,\n-      ServerName serverName) throws IOException {\n-    // force to assign to a new candidate server\n-    // AssignmentManager#regionClosedAbnormally will set region location to null\n-    // TODO: the forceNewPlan flag not be persistent so if master crash then the flag will be lost.\n-    // But assign to old server is not big deal because it not effect correctness.\n-    // See HBASE-23035 for more details.\n-    forceNewPlan = true;\n+      ServerName serverName, boolean forceNewPlan) throws IOException {\n+    this.forceNewPlan = forceNewPlan;", "originalCommit": "960530cb0fd261a702fff542b51dd0895d4315b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMjUzNQ==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r499202535", "bodyText": "Sorry for the late reply Anoop.\n\nOn a method call, we set a state variable. ! Is that really wanted? Seems before also this was happening but always set to true. Now it can change. I did not see the class how this var being used. But can we check pls?\n\nYeah, based on this flag we decide whether to retain assignment to last host during SCP.\n\n  \n    \n      hbase/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/TransitRegionStateProcedure.java\n    \n    \n         Line 181\n      in\n      b0170d0\n    \n    \n    \n    \n\n        \n          \n           if (forceNewPlan) { \n        \n    \n  \n\n\n\n  \n    \n      hbase/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java\n    \n    \n         Line 2054\n      in\n      b0170d0\n    \n    \n    \n    \n\n        \n          \n           if (regionStateNode.getRegionLocation() != null) { \n        \n    \n  \n\n\n\n  \n    \n      hbase/hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java\n    \n    \n         Line 2125\n      in\n      b0170d0\n    \n    \n    \n    \n\n        \n          \n           acceptPlan(regions, balancer.retainAssignment(retainMap, servers));", "author": "pankaj72981", "createdAt": "2020-10-04T03:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5ODk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5OTM0Mw==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r478799343", "bodyText": "Can u add few more lines as code level comments here?  What is the pros and cons of setting this. Will be easy for some one coming in here later to understand clearly.", "author": "anoopsjohn", "createdAt": "2020-08-28T02:41:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/ServerCrashProcedure.java", "diffHunk": "@@ -65,6 +65,14 @@\n     implements ServerProcedureInterface {\n   private static final Logger LOG = LoggerFactory.getLogger(ServerCrashProcedure.class);\n \n+  /**\n+   * Configuration parameter to retain the region assignment during ServerCrashProcedure, see", "originalCommit": "960530cb0fd261a702fff542b51dd0895d4315b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMjU5Mg==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r499202592", "bodyText": "Sure, will address it in next commit in this PR.", "author": "pankaj72981", "createdAt": "2020-10-04T03:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5OTM0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5OTkxMw==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r478799913", "bodyText": "Give a better name for the test method?", "author": "anoopsjohn", "createdAt": "2020-08-28T02:44:38Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestRetainAssignmentOnRestart.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.MiniHBaseCluster;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure;\n+import org.apache.hadoop.hbase.testclassification.MasterTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.util.JVMClusterUtil;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MasterTests.class, MediumTests.class })\n+public class TestRetainAssignmentOnRestart extends AbstractTestRestartCluster {\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+      HBaseClassTestRule.forClass(TestRetainAssignmentOnRestart.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestRetainAssignmentOnRestart.class);\n+\n+  @Override\n+  protected boolean splitWALCoordinatedByZk() {\n+    return true;\n+  }\n+\n+  /**\n+   * This tests retaining assignments on a cluster restart\n+   */\n+  @Test\n+  public void test() throws Exception {", "originalCommit": "960530cb0fd261a702fff542b51dd0895d4315b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMjYyMQ==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r499202621", "bodyText": "Ok", "author": "pankaj72981", "createdAt": "2020-10-04T03:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc5OTkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwMTA2Mg==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r478801062", "bodyText": "Here at restart , making it to 3 RSs from 2??  The value for rsPorts[2] is HM port", "author": "anoopsjohn", "createdAt": "2020-08-28T02:49:27Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestRetainAssignmentOnRestart.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.MiniHBaseCluster;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure;\n+import org.apache.hadoop.hbase.testclassification.MasterTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.util.JVMClusterUtil;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MasterTests.class, MediumTests.class })\n+public class TestRetainAssignmentOnRestart extends AbstractTestRestartCluster {\n+\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+      HBaseClassTestRule.forClass(TestRetainAssignmentOnRestart.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestRetainAssignmentOnRestart.class);\n+\n+  @Override\n+  protected boolean splitWALCoordinatedByZk() {\n+    return true;\n+  }\n+\n+  /**\n+   * This tests retaining assignments on a cluster restart\n+   */\n+  @Test\n+  public void test() throws Exception {\n+    // Set Zookeeper based connection registry since we will stop master and start a new master\n+    // without populating the underlying config for the connection.\n+    UTIL.getConfiguration().set(HConstants.CLIENT_CONNECTION_REGISTRY_IMPL_CONF_KEY,\n+      HConstants.ZK_CONNECTION_REGISTRY_CLASS);\n+    // Enable retain assignment during ServerCrashProcedure\n+    UTIL.getConfiguration().setBoolean(ServerCrashProcedure.MASTER_SCP_RETAIN_ASSIGNMENT, true);\n+    UTIL.startMiniCluster(2);\n+    // Turn off balancer\n+    UTIL.getMiniHBaseCluster().getMaster().getMasterRpcServices().synchronousBalanceSwitch(false);\n+    LOG.info(\"\\n\\nCreating tables\");\n+    for (TableName TABLE : TABLES) {\n+      UTIL.createTable(TABLE, FAMILY);\n+    }\n+    for (TableName TABLE : TABLES) {\n+      UTIL.waitTableEnabled(TABLE);\n+    }\n+\n+    HMaster master = UTIL.getMiniHBaseCluster().getMaster();\n+    UTIL.waitUntilNoRegionsInTransition(60000);\n+\n+    // We don't have to use SnapshotOfRegionAssignmentFromMeta.\n+    // We use it here because AM used to use it to load all user region placements\n+    SnapshotOfRegionAssignmentFromMeta snapshot =\n+        new SnapshotOfRegionAssignmentFromMeta(master.getConnection());\n+    snapshot.initialize();\n+    Map<RegionInfo, ServerName> regionToRegionServerMap = snapshot.getRegionToRegionServerMap();\n+\n+    MiniHBaseCluster cluster = UTIL.getHBaseCluster();\n+    List<JVMClusterUtil.RegionServerThread> threads = cluster.getLiveRegionServerThreads();\n+    assertEquals(2, threads.size());\n+    int[] rsPorts = new int[3];\n+    for (int i = 0; i < 2; i++) {\n+      rsPorts[i] = threads.get(i).getRegionServer().getServerName().getPort();\n+    }\n+    rsPorts[2] = cluster.getMaster().getServerName().getPort();\n+    for (ServerName serverName : regionToRegionServerMap.values()) {\n+      boolean found = false; // Test only, no need to optimize\n+      for (int k = 0; k < 3 && !found; k++) {\n+        found = serverName.getPort() == rsPorts[k];\n+      }\n+      assertTrue(found);\n+    }\n+\n+    LOG.info(\"\\n\\nShutting down HBase cluster\");\n+    cluster.stopMaster(0);\n+    cluster.shutdown();\n+    cluster.waitUntilShutDown();\n+\n+    LOG.info(\"\\n\\nSleeping a bit\");\n+    Thread.sleep(2000);\n+\n+    LOG.info(\"\\n\\nStarting cluster the second time with the same ports\");\n+    cluster.getConf().setInt(ServerManager.WAIT_ON_REGIONSERVERS_MINTOSTART, 3);\n+    master = cluster.startMaster().getMaster();\n+    for (int i = 0; i < 3; i++) {", "originalCommit": "960530cb0fd261a702fff542b51dd0895d4315b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwMjE5MQ==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r478802191", "bodyText": "This tests the cluster restart case.  The config is applicable for single RS down and that getting restarted within the zk session time out.  Then also we will go with retain assign as per the config.  Can we add test for that?", "author": "anoopsjohn", "createdAt": "2020-08-28T02:54:08Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestRetainAssignmentOnRestart.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.master;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.MiniHBaseCluster;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.master.procedure.ServerCrashProcedure;\n+import org.apache.hadoop.hbase.testclassification.MasterTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.apache.hadoop.hbase.util.JVMClusterUtil;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MasterTests.class, MediumTests.class })\n+public class TestRetainAssignmentOnRestart extends AbstractTestRestartCluster {", "originalCommit": "960530cb0fd261a702fff542b51dd0895d4315b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2NDU5MQ==", "url": "https://github.com/apache/hbase/pull/2313#discussion_r499364591", "bodyText": "During single RS crash we will set the region location, so balncer will retain the region assignment if same server comes up otherwise regions will be assigned to availalble live servers.\nAdding the test will be little tricky, let me check.", "author": "pankaj72981", "createdAt": "2020-10-05T06:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgwMjE5MQ=="}], "type": "inlineReview"}, {"oid": "b36b3d21f8892a789a95e4fd679bb8d2ce5167a5", "url": "https://github.com/apache/hbase/commit/b36b3d21f8892a789a95e4fd679bb8d2ce5167a5", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-10-13T03:13:00Z", "type": "commit"}, {"oid": "828b79ed30fc2ee439c535531a82ee3542b1be71", "url": "https://github.com/apache/hbase/commit/828b79ed30fc2ee439c535531a82ee3542b1be71", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-10-13T03:13:00Z", "type": "commit"}, {"oid": "0514221a5f18ccadd86e40e04caadd31a13aeb19", "url": "https://github.com/apache/hbase/commit/0514221a5f18ccadd86e40e04caadd31a13aeb19", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-10-13T03:13:00Z", "type": "commit"}, {"oid": "2b169e22bcd8017dc5955f5777040df6913818c1", "url": "https://github.com/apache/hbase/commit/2b169e22bcd8017dc5955f5777040df6913818c1", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-10-13T06:59:24Z", "type": "commit"}, {"oid": "2b169e22bcd8017dc5955f5777040df6913818c1", "url": "https://github.com/apache/hbase/commit/2b169e22bcd8017dc5955f5777040df6913818c1", "message": "HBASE-24900 Make retain assignment configurable during SCP", "committedDate": "2020-10-13T06:59:24Z", "type": "forcePushed"}]}