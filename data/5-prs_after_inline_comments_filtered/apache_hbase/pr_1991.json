{"pr_number": 1991, "pr_title": "HBASE-24650 Change the return types of the new checkAndMutate methods\u2026", "pr_createdAt": "2020-06-28T00:52:43Z", "pr_url": "https://github.com/apache/hbase/pull/1991", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Njc3NQ==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446586775", "bodyText": "For IA.Public, we do not use the IS annotation since it should always be Stable.", "author": "Apache9", "createdAt": "2020-06-28T01:24:48Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/CheckAndMutateResult.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import org.apache.yetus.audience.InterfaceAudience;\n+import org.apache.yetus.audience.InterfaceStability;\n+\n+/**\n+ * Represents a result of a CheckAndMutate operation\n+ */\n+@InterfaceAudience.Public\n+@InterfaceStability.Evolving", "originalCommit": "713b4a3992cdef358fb07d35bb3cb2a1fd266451", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NzY1Nw==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446587657", "bodyText": "Okay. I will remove the IS annotation. Thanks.", "author": "brfrn169", "createdAt": "2020-06-28T01:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Njc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Njk0MQ==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446586941", "bodyText": "We have already make use of generic type so why here we still need to cast?", "author": "Apache9", "createdAt": "2020-06-28T01:27:03Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncTableImpl.java", "diffHunk": "@@ -349,7 +349,7 @@ private void preCheck() {\n           loc, stub, mutation,\n           (rn, rm) -> RequestConverter.buildMutateRequest(rn, row, family, qualifier, op, value,\n             null, timeRange, rm),\n-          resp -> resp.getExists()))\n+          resp -> ((CheckAndMutateResult) resp).isSuccess()))", "originalCommit": "713b4a3992cdef358fb07d35bb3cb2a1fd266451", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4ODQ1Mw==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446588453", "bodyText": "I will modify it to make use of generic type. Thanks.", "author": "brfrn169", "createdAt": "2020-06-28T01:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Njk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NzAwNA==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446587004", "bodyText": "Object is too generic. Please explain why we need to do this change?", "author": "Apache9", "createdAt": "2020-06-28T01:27:47Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncTableImpl.java", "diffHunk": "@@ -431,49 +431,49 @@ public CheckAndMutateWithFilterBuilder checkAndMutate(byte[] row, Filter filter)\n       if (mutation instanceof Put) {\n         validatePut((Put) mutation, conn.connConf.getMaxKeyValueSize());\n       }\n-      return RawAsyncTableImpl.this.<Boolean> newCaller(checkAndMutate.getRow(),\n+      return RawAsyncTableImpl.this.<CheckAndMutateResult> newCaller(checkAndMutate.getRow(),\n         mutation.getPriority(), rpcTimeoutNs)\n         .action((controller, loc, stub) -> RawAsyncTableImpl.mutate(controller,\n           loc, stub, mutation,\n           (rn, m) -> RequestConverter.buildMutateRequest(rn, checkAndMutate.getRow(),\n             checkAndMutate.getFamily(), checkAndMutate.getQualifier(),\n             checkAndMutate.getCompareOp(), checkAndMutate.getValue(), checkAndMutate.getFilter(),\n             checkAndMutate.getTimeRange(), m),\n-          (c, r) -> r.getProcessed()))\n+          (c, r) -> ResponseConverter.getCheckAndMutateResult(r)))\n         .call();\n     } else if (checkAndMutate.getAction() instanceof RowMutations) {\n       RowMutations rowMutations = (RowMutations) checkAndMutate.getAction();\n-      return RawAsyncTableImpl.this.<Boolean> newCaller(checkAndMutate.getRow(),\n+      return RawAsyncTableImpl.this.<CheckAndMutateResult> newCaller(checkAndMutate.getRow(),\n         rowMutations.getMaxPriority(), rpcTimeoutNs)\n         .action((controller, loc, stub) -> RawAsyncTableImpl.this.mutateRow(controller,\n           loc, stub, rowMutations,\n           (rn, rm) -> RequestConverter.buildMutateRequest(rn, checkAndMutate.getRow(),\n             checkAndMutate.getFamily(), checkAndMutate.getQualifier(),\n             checkAndMutate.getCompareOp(), checkAndMutate.getValue(), checkAndMutate.getFilter(),\n             checkAndMutate.getTimeRange(), rm),\n-          resp -> resp.getExists()))\n+          resp -> (CheckAndMutateResult) resp))\n         .call();\n     } else {\n-      CompletableFuture<Boolean> future = new CompletableFuture<>();\n+      CompletableFuture<CheckAndMutateResult> future = new CompletableFuture<>();\n       future.completeExceptionally(new DoNotRetryIOException(\n         \"CheckAndMutate doesn't support \" + checkAndMutate.getAction().getClass().getName()));\n       return future;\n     }\n   }\n \n   @Override\n-  public List<CompletableFuture<Boolean>> checkAndMutate(List<CheckAndMutate> checkAndMutates) {\n+  public List<CompletableFuture<CheckAndMutateResult>> checkAndMutate(\n+    List<CheckAndMutate> checkAndMutates) {\n     return batch(checkAndMutates, rpcTimeoutNs).stream()\n-      .map(f -> f.thenApply(r -> ((Result)r).getExists()))\n-      .collect(toList());\n+      .map(f -> f.thenApply(r -> (CheckAndMutateResult) r)).collect(toList());\n   }\n \n   // We need the MultiRequest when constructing the org.apache.hadoop.hbase.client.MultiResponse,\n   // so here I write a new method as I do not want to change the abstraction of call method.\n   private <RESP> CompletableFuture<RESP> mutateRow(HBaseRpcController controller,\n       HRegionLocation loc, ClientService.Interface stub, RowMutations mutation,\n       Converter<MultiRequest, byte[], RowMutations> reqConvert,\n-      Function<Result, RESP> respConverter) {\n+      Function<Object, RESP> respConverter) {", "originalCommit": "713b4a3992cdef358fb07d35bb3cb2a1fd266451", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4ODc2NA==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r446588764", "bodyText": "The reason why I changed Result to Object here is that this method is used by both checkAndMutate() and mutateRow() and we need to use different types each case (respectively CheckAndMutateResult and Result). However as you mentioned, we can make use of generic type here. I will modify it. Thanks.", "author": "brfrn169", "createdAt": "2020-06-28T01:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NzAwNA=="}], "type": "inlineReview"}, {"oid": "5bb5e3ae4e3f28f1d1399d92b2bb82e1c02abc84", "url": "https://github.com/apache/hbase/commit/5bb5e3ae4e3f28f1d1399d92b2bb82e1c02abc84", "message": "HBASE-24650 Change the return types of the new CheckAndMutate methods introduced in HBASE-8458", "committedDate": "2020-06-28T02:17:00Z", "type": "forcePushed"}, {"oid": "80cbe529cdea6bbe6c6b21e8594c31a9ff4d4b3d", "url": "https://github.com/apache/hbase/commit/80cbe529cdea6bbe6c6b21e8594c31a9ff4d4b3d", "message": "HBASE-24650 Change the return types of the new CheckAndMutate methods introduced in HBASE-8458", "committedDate": "2020-07-04T01:14:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4MDU2Mg==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r449780562", "bodyText": "Better to return a List?", "author": "Apache9", "createdAt": "2020-07-04T15:07:43Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/TableOverAsyncTable.java", "diffHunk": "@@ -300,13 +300,16 @@ public boolean thenMutate(RowMutations mutation) throws IOException {\n   }\n \n   @Override\n-  public boolean checkAndMutate(CheckAndMutate checkAndMutate) throws IOException {\n+  public CheckAndMutateResult checkAndMutate(CheckAndMutate checkAndMutate) throws IOException {\n     return FutureUtils.get(table.checkAndMutate(checkAndMutate));\n   }\n \n   @Override\n-  public boolean[] checkAndMutate(List<CheckAndMutate> checkAndMutates) throws IOException {\n-    return Booleans.toArray(FutureUtils.get(table.checkAndMutateAll(checkAndMutates)));\n+  public CheckAndMutateResult[] checkAndMutate(List<CheckAndMutate> checkAndMutates)", "originalCommit": "80cbe529cdea6bbe6c6b21e8594c31a9ff4d4b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1NDA4Nw==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r449854087", "bodyText": "Yeah that's better. I will change it.", "author": "brfrn169", "createdAt": "2020-07-05T09:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4MDU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4MTk0Nw==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r449781947", "bodyText": "OK, so the problem here is that, the result for a multi operation is an Object? And we will have two types, one is Result, for normal mutateRow, and the other is CheckAndMutateResult, for checkAndMutate?", "author": "Apache9", "createdAt": "2020-07-04T15:27:52Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncTableImpl.java", "diffHunk": "@@ -497,7 +497,7 @@ public void run(MultiResponse resp) {\n                     \"Failed to mutate row: \" + Bytes.toStringBinary(mutation.getRow()), ex));\n               } else {\n                 future.complete(respConverter\n-                  .apply((Result) multiResp.getResults().get(regionName).result.get(0)));\n+                  .apply((RES) multiResp.getResults().get(regionName).result.get(0)));", "originalCommit": "80cbe529cdea6bbe6c6b21e8594c31a9ff4d4b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1NDQ1OQ==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r449854459", "bodyText": "Yes, correct. Previously, we returned only Result type but after this fix, we will return Result (for normal mutateRow) and CheckAndMutateResult (for checkAndMutate). So I used a generic type here.", "author": "brfrn169", "createdAt": "2020-07-05T09:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4MTk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDExMjIxNQ==", "url": "https://github.com/apache/hbase/pull/1991#discussion_r450112215", "bodyText": "Is there any problem here?", "author": "brfrn169", "createdAt": "2020-07-06T09:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4MTk0Nw=="}], "type": "inlineReview"}, {"oid": "9ce68c47d1b83504ea2cb0d9b872ba2df105c74a", "url": "https://github.com/apache/hbase/commit/9ce68c47d1b83504ea2cb0d9b872ba2df105c74a", "message": "HBASE-24650 Change the return types of the new CheckAndMutate methods introduced in HBASE-8458", "committedDate": "2020-07-05T12:39:41Z", "type": "commit"}, {"oid": "9ce68c47d1b83504ea2cb0d9b872ba2df105c74a", "url": "https://github.com/apache/hbase/commit/9ce68c47d1b83504ea2cb0d9b872ba2df105c74a", "message": "HBASE-24650 Change the return types of the new CheckAndMutate methods introduced in HBASE-8458", "committedDate": "2020-07-05T12:39:41Z", "type": "forcePushed"}]}