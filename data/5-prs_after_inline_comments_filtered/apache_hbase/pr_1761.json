{"pr_number": 1761, "pr_title": "HBASE-21406 \"status 'replication'\" should not show SINK if the cluste\u2026", "pr_createdAt": "2020-05-22T09:44:32Z", "pr_url": "https://github.com/apache/hbase/pull/1761", "timeline": [{"oid": "54444c76cfe176cb51844ad8451c78ff97805341", "url": "https://github.com/apache/hbase/commit/54444c76cfe176cb51844ad8451c78ff97805341", "message": "HBASE-21406 \"status 'replication'\" should not show SINK if the cluster does not act as sink", "committedDate": "2020-05-22T09:39:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwNjgxNQ==", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429206815", "bodyText": "Although 10s seems more than enough time, we can use Waiter.wait() / HBASE_TESTING_UTILITY.waitFor() with predicate to check if loadSink.getTimestampsOfLastAppliedOp()>loadSink.getTimestampStarted().", "author": "virajjasani", "createdAt": "2020-05-22T12:03:29Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationStatus.java", "diffHunk": "@@ -120,6 +124,28 @@ public void testReplicationStatus() throws Exception {\n     assertEquals(PEER_ID2, rLoadSourceList.get(0).getPeerID());\n   }\n \n+  @Test\n+  public void testReplicationStatusSink() throws Exception {\n+    try (Admin hbaseAdmin = UTIL2.getConnection().getAdmin()) {\n+      ServerName server = UTIL2.getHBaseCluster().getRegionServer(0).getServerName();\n+      ReplicationLoadSink loadSink = getLatestSinkMetric(hbaseAdmin, server);\n+      //First checks if status of timestamp of last applied op is same as RS start, since no edits\n+      //were replicated yet\n+      assertEquals(loadSink.getTimestampStarted(), loadSink.getTimestampsOfLastAppliedOp());\n+      //now insert some rows on source, so that it gets delivered to target\n+      insertRowsOnSource();\n+      Thread.sleep(10000);", "originalCommit": "54444c76cfe176cb51844ad8451c78ff97805341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxMzEwNA==", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429213104", "bodyText": "nit: Gets the total number of OPs delivered to this sink would be better? WDYT?", "author": "virajjasani", "createdAt": "2020-05-22T12:18:56Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/MetricsSink.java", "diffHunk": "@@ -98,4 +99,21 @@ public long getAgeOfLastAppliedOp() {\n   public long getTimestampOfLastAppliedOp() {\n     return this.lastTimestampForAge;\n   }\n+\n+  /**\n+   * Gets the time stamp from when the Sink was initialized.\n+   * @return startTimestamp\n+   */\n+  public long getStartTimestamp() {\n+    return startTimestamp;\n+  }\n+\n+  /**\n+   * Gets the total number of OPs delivered to target by this sink.", "originalCommit": "54444c76cfe176cb51844ad8451c78ff97805341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28562e0ce894bb21defc1c24a4ff174e34c6cf93", "url": "https://github.com/apache/hbase/commit/28562e0ce894bb21defc1c24a4ff174e34c6cf93", "message": "fixing build issues", "committedDate": "2020-05-23T13:56:54Z", "type": "commit"}, {"oid": "64a3888f78f70619ffca60ee1407730aae9d86ad", "url": "https://github.com/apache/hbase/commit/64a3888f78f70619ffca60ee1407730aae9d86ad", "message": "addressing Viraj suggestions.", "committedDate": "2020-05-23T17:57:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5NTMzNA==", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429595334", "bodyText": "Want to keep it 10s instead of 100s? :)", "author": "virajjasani", "createdAt": "2020-05-24T03:21:15Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationStatus.java", "diffHunk": "@@ -120,6 +124,35 @@ public void testReplicationStatus() throws Exception {\n     assertEquals(PEER_ID2, rLoadSourceList.get(0).getPeerID());\n   }\n \n+  @Test\n+  public void testReplicationStatusSink() throws Exception {\n+    try (Admin hbaseAdmin = UTIL2.getConnection().getAdmin()) {\n+      ServerName server = UTIL2.getHBaseCluster().getRegionServer(0).getServerName();\n+      ReplicationLoadSink loadSink = getLatestSinkMetric(hbaseAdmin, server);\n+      //First checks if status of timestamp of last applied op is same as RS start, since no edits\n+      //were replicated yet\n+      assertEquals(loadSink.getTimestampStarted(), loadSink.getTimestampsOfLastAppliedOp());\n+      //now insert some rows on source, so that it gets delivered to target\n+      insertRowsOnSource();\n+      long wait = Waiter.waitFor(UTIL2.getConfiguration(),\n+        100000, new Waiter.Predicate<Exception>() {", "originalCommit": "64a3888f78f70619ffca60ee1407730aae9d86ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6645ae431b52b8beadde563b946229b3abbc26fd", "url": "https://github.com/apache/hbase/commit/6645ae431b52b8beadde563b946229b3abbc26fd", "message": "Adjusting the waiter timeout", "committedDate": "2020-05-25T18:44:56Z", "type": "commit"}, {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec", "url": "https://github.com/apache/hbase/commit/5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec", "message": "Adjusting checkstyles", "committedDate": "2020-05-25T20:27:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3MzYzNA==", "url": "https://github.com/apache/hbase/pull/1761#discussion_r431373634", "bodyText": "Add this to stay consistent to the other getters here.", "author": "HorizonNet", "createdAt": "2020-05-27T19:00:59Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/MetricsSink.java", "diffHunk": "@@ -98,4 +99,21 @@ public long getAgeOfLastAppliedOp() {\n   public long getTimestampOfLastAppliedOp() {\n     return this.lastTimestampForAge;\n   }\n+\n+  /**\n+   * Gets the time stamp from when the Sink was initialized.\n+   * @return startTimestamp\n+   */\n+  public long getStartTimestamp() {\n+    return startTimestamp;", "originalCommit": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d19ea42341ec3a5a8d112fe551fe344a090fcd48", "url": "https://github.com/apache/hbase/commit/d19ea42341ec3a5a8d112fe551fe344a090fcd48", "message": "Addressing latest comments from Josh and Jan, together with shell UT failures", "committedDate": "2020-06-01T18:36:22Z", "type": "commit"}]}