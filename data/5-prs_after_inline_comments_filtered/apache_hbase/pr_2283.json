{"pr_number": 2283, "pr_title": "HBASE-24885 STUCK RIT by hbck2 assigns", "pr_createdAt": "2020-08-19T19:32:38Z", "pr_url": "https://github.com/apache/hbase/pull/2283", "timeline": [{"oid": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5", "url": "https://github.com/apache/hbase/commit/0883df9e6fa1bf7a08cad5162c91bdc6695323e5", "message": "HBASE-24885 STUCK RIT by hbck2 assigns\n\nAdds region state check on hbck2 assigns/unassigns. Returns pid of -1\nif in inappropriate state with logging explaination which suggests\npassing override if operator wants to assign/unassign anyways. Here\nis an example of what happens now if hbck2 tries an unassign and\nRegion already unassigned:\n\n  2020-08-19 11:22:06,926 INFO  [RpcServer.default.FPBQ.Fifo.handler=1,queue=0,port=50086] assignment.AssignmentManager(820): Failed {ENCODED => d1112e553991e938b6852f87774c91ee, NAME => 'TestHbck,zzzzz,1597861310769.d1112e553991e938b6852f87774c91ee.', STARTKEY => 'zzzzz', ENDKEY => ''} unassign, override=false; set override to by-pass state checks.\n  org.apache.hadoop.hbase.client.DoNotRetryRegionException: Unexpected state for state=CLOSED, location=null, table=TestHbck, region=d1112e553991e938b6852f87774c91ee\n          at org.apache.hadoop.hbase.master.assignment.AssignmentManager.preTransitCheck(AssignmentManager.java:583)\n          at org.apache.hadoop.hbase.master.assignment.AssignmentManager.createOneUnassignProcedure(AssignmentManager.java:812)\n          at org.apache.hadoop.hbase.master.MasterRpcServices.unassigns(MasterRpcServices.java:2616)\n          at org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos$HbckService$2.callBlockingMethod(MasterProtos.java)\n          at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:397)\n          at org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:133)\n          at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:338)\n          at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:318)\n\nPrevious it would just create the unassign anyways. Now must pass override\nto queue the procedure regardless. Safer.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n javadoc on assigns/unassigns. Minor refactor in assigns/unassigns to cater to\n case where procedure may come back null (if override not set and fails state checks).\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java\n checkstyle cleanups.\n Clarifying javadoc on how there is no state checking when bulk assigns creating/enabling\n tables.\n\n createOneAssignProcedure and createOneUnassignProcedure now handle exceptions which now\n can be thrown if no override and region state is not appropriate.\n\n Aggregation of createAssignProcedure and createUnassignProcedure instances adding in\n region state check invoked if override is NOT set.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateNode.java\n Change to setProcedure so it returns passed proc as result instead of void", "committedDate": "2020-08-19T19:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0NTU0OQ==", "url": "https://github.com/apache/hbase/pull/2283#discussion_r474445549", "bodyText": "What is the purpose of this change?", "author": "Apache9", "createdAt": "2020-08-21T06:58:24Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateNode.java", "diffHunk": "@@ -190,10 +190,11 @@ public ServerName setRegionLocation(final ServerName serverName) {\n     return lastRegionLocation;\n   }\n \n-  public void setProcedure(TransitRegionStateProcedure proc) {\n+  public TransitRegionStateProcedure setProcedure(TransitRegionStateProcedure proc) {", "originalCommit": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MTM4MA==", "url": "https://github.com/apache/hbase/pull/2283#discussion_r474781380", "bodyText": "Thanks for review.\nChange was to make the method adhere to fluent style https://en.wikipedia.org/wiki/Fluent_interface\nI had:\nsetProcedure(p);\nreturn p;\n\nand wanted to do below instead:\nreturn setProcedure(p);\nCan undo it if you'd prefer.", "author": "saintstack", "createdAt": "2020-08-21T15:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0NTU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4NTE4OA==", "url": "https://github.com/apache/hbase/pull/2283#discussion_r475385188", "bodyText": "Just want to know the reason. I'm neutral with this change.", "author": "Apache9", "createdAt": "2020-08-24T07:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0NTU0OQ=="}], "type": "inlineReview"}]}