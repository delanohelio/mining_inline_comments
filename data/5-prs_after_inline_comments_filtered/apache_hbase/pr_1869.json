{"pr_number": 1869, "pr_title": "HBASE-24518 : waitForNamespaceOnline() should return false if any region is offline", "pr_createdAt": "2020-06-08T13:54:08Z", "pr_url": "https://github.com/apache/hbase/pull/1869", "timeline": [{"oid": "60d45ad52c30676faf3b0550d92bdf17346f6bdd", "url": "https://github.com/apache/hbase/commit/60d45ad52c30676faf3b0550d92bdf17346f6bdd", "message": "HBASE-24518 : waitForNamespaceOnline() should return false if any region is offline", "committedDate": "2020-06-08T13:50:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r438941753", "bodyText": "Actually isRegionOnline() is waiting in a loop until this region's status become opened and that server is online.  So there is no bug as such right?  isRegionOnline() might return false iff the server is being stopped", "author": "anoopsjohn", "createdAt": "2020-06-11T17:12:15Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1285,7 +1285,9 @@ private boolean waitForNamespaceOnline() throws InterruptedException, IOExceptio\n     }\n     // Else there are namespace regions up in meta. Ensure they are assigned before we go on.\n     for (RegionInfo ri : ris) {\n-      isRegionOnline(ri);\n+      if (!isRegionOnline(ri)) {", "originalCommit": "60d45ad52c30676faf3b0550d92bdf17346f6bdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2MTQ0MA==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r438961440", "bodyText": "Same question. So even if one region is offline you will not wait for namespace correct? That means that indicates some case where regions are gong down? What if a split region was opened and that has status offline? Even then we wont wait for namespace?", "author": "ramkrish86", "createdAt": "2020-06-11T17:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5NjkwNA==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r438996904", "bodyText": "isRegionOnline might also return false if region doesn't come online after all retry attempts with exponential backoff are completed (rare but valid case)", "author": "virajjasani", "createdAt": "2020-06-11T18:44:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTIwNjg5Mg==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r439206892", "bodyText": "BTW our RetryCounterFactory is with infinite retry. maxAttempts are Integer.MAX_VALUE.  Also we don't account for a case whether RetryCounterFactory finishes the retry attempts.\nThere is no harm in adding this fix.  But should we see whether the RetryCounterFactory  usage is correct also?\nAm I missing some thing?", "author": "anoopsjohn", "createdAt": "2020-06-12T04:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0NjU2Mg==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r439246562", "bodyText": "Oh I see, for infinite retries, it is not a problem but then ideally we should change the signature of isRegionOnline() because boolean is of no use. Also, it is being used in similar manner for meta region also, and that's why I wanted to make namespace region open logic look same.\ne.g\n  public boolean waitForMetaOnline() throws InterruptedException {\n    return isRegionOnline(RegionInfoBuilder.FIRST_META_REGIONINFO);\n  }\n\n\nHowever, now I understand the main purpose of isRegionOnline() which is to keep retrying infinite times and only when server is going down, return false. And with the current logic, waitForNamespaceOnline() returns true no matter what isRegionOnline() returns and hence, instead of returning from HMaster active initializations, it proceeds further.\n    if (!waitForNamespaceOnline()) {\n      return;\n    }\n    status.setStatus(\"Starting cluster schema service\");\n    initClusterSchemaService();\n....\n....\n....\n\nWe should return from the above if condition ideally. Good to maintain same logic for namespace and meta regions initializations. Thought?", "author": "virajjasani", "createdAt": "2020-06-12T07:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE5OTAwNQ==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r440199005", "bodyText": "@ramkrish86 from this code block, we just return false and we return back from finishActiveMasterInitialization() without any further initialization because mostly this will happen when HM server is going down so we expect finishActiveMasterInitialization() to return instead of going further with any further init:\nfinishActiveMasterInitialization():\n    if (!waitForNamespaceOnline()) {\n      return;\n    }\n\n\nwaitForNamespaceOnline():\n      if (!isRegionOnline(ri)) {\n        return false;\n      }", "author": "virajjasani", "createdAt": "2020-06-15T14:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ0NTAwMg==", "url": "https://github.com/apache/hbase/pull/1869#discussion_r441445002", "bodyText": "Ya seeing the meta case this seems fine. Just a unification. +1.", "author": "ramkrish86", "createdAt": "2020-06-17T10:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk0MTc1Mw=="}], "type": "inlineReview"}]}