{"pr_number": 1879, "pr_title": "HBASE-24525 [branch-1] Support ZooKeeper 3.6.0+", "pr_createdAt": "2020-06-09T18:41:53Z", "pr_url": "https://github.com/apache/hbase/pull/1879", "timeline": [{"oid": "291537e063f9abe11168d59ad9b71e80126cb013", "url": "https://github.com/apache/hbase/commit/291537e063f9abe11168d59ad9b71e80126cb013", "message": "HBASE-24525 [branch-1] Support ZooKeeper 3.6.0+", "committedDate": "2020-06-09T18:35:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0MzExNw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437643117", "bodyText": "ZooKeeper 3.6 throws NPE if the multi list is empty", "author": "apurtell", "createdAt": "2020-06-09T18:44:39Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/zookeeper/ZKUtil.java", "diffHunk": "@@ -1811,9 +1811,10 @@ private static Op toZooKeeperOp(ZooKeeperWatcher zkw, ZKUtilOp op)\n    */\n   public static void multiOrSequential(ZooKeeperWatcher zkw, List<ZKUtilOp> ops,\n       boolean runSequentialOnMultiFailure) throws KeeperException {\n-    if (ops == null) return;\n+    if (ops == null || ops.isEmpty()) {", "originalCommit": "291537e063f9abe11168d59ad9b71e80126cb013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2MTg2Mg==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r438261862", "bodyText": "Did our unit tests catch this one or you knew it already? I just want to know what preparation we should do while upgrading ZK or any other heavy dependency.", "author": "virajjasani", "createdAt": "2020-06-10T16:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0MzExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTI1Mw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437681253", "bodyText": "UnknownHostException is also an IOE, so I think you can just remove UnknownHostException from the method signature and all is good? no need to try/catch/wrap blocks?", "author": "bharathv", "createdAt": "2020-06-09T19:55:37Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/zookeeper/HQuorumPeer.java", "diffHunk": "@@ -85,14 +85,20 @@ public static void main(String[] args) {\n   }\n \n   private static void runZKServer(QuorumPeerConfig zkConfig) throws UnknownHostException, IOException {", "originalCommit": "291537e063f9abe11168d59ad9b71e80126cb013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczNzUwNQ==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437737505", "bodyText": "The current signature proposes we throw IOException or UnknownHostException. ZK 3.6 throws another type of checked exception, which causes a compilation error. Therefore I catch that and potentially others, and wrap it into an IOE.\nAdding the new checked exception to the signature would cause a compilation problem with 3.4, so that is not possible due to this legacy.", "author": "apurtell", "createdAt": "2020-06-09T21:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczODE3MQ==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437738171", "bodyText": "UnknownHostException is also an IOE\n\nMight be true but the method signature here was what it was and there is no need to fix it. I have little opinion either way other than a preference to minimize change.", "author": "apurtell", "createdAt": "2020-06-09T21:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc0NTkyMw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437745923", "bodyText": "Ah, okay. I missed the AdminServerException exception from the signature, wfm to keep it as-is.", "author": "bharathv", "createdAt": "2020-06-09T21:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MTI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437683153", "bodyText": "Why this? Any un-checked exception is propagated as-is?", "author": "bharathv", "createdAt": "2020-06-09T19:59:00Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperMainServer.java", "diffHunk": "@@ -66,8 +66,14 @@ public HACK_UNTIL_ZOOKEEPER_1897_ZooKeeperMain(String[] args)\n      * @throws IOException\n      * @throws InterruptedException\n      */\n-    void runCmdLine() throws KeeperException, IOException, InterruptedException {\n-      processCmd(this.cl);\n+    void runCmdLine() throws IOException, InterruptedException {\n+      try {\n+        processCmd(this.cl);\n+      } catch (IOException | InterruptedException e) {\n+        throw e;\n+      } catch (Exception e) {", "originalCommit": "291537e063f9abe11168d59ad9b71e80126cb013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczNzEzNA==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437737134", "bodyText": "The current signature proposes we throw IOException or InterruptedException. ZK 3.6 throws another type of checked exception, which causes a compilation error. Therefore I catch that and potentially others, and wrap it into an IOE.\nAdding the new checked exception to the signature would cause a compilation problem with 3.4, so that is not possible due to this legacy.", "author": "apurtell", "createdAt": "2020-06-09T21:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc0Nzg5OQ==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437747899", "bodyText": "ZK 3.6 throws another type of checked exception, which causes a compilation error\n\nI didn't see it here [1], hence my question.  May be I missed something.\n[1] https://github.com/apache/zookeeper/blob/branch-3.6/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeperMain.java#L380", "author": "bharathv", "createdAt": "2020-06-09T22:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4NzI3NA==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437787274", "bodyText": "This is a port of internal work, let me remove this hunk and check again.", "author": "apurtell", "createdAt": "2020-06-10T00:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4ODQ2Mw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437788463", "bodyText": "[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile (default-compile) on project hbase-server: Compilation failure\n[ERROR] /Users/apurtell/src/hbase/hbase-server/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperMainServer.java:[70,17] unreported exception org.apache.zookeeper.cli.CliException; must be caught or declared to be thrown", "author": "apurtell", "createdAt": "2020-06-10T00:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0NjAxMw==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437846013", "bodyText": "Looks like the root cause is this https://issues.apache.org/jira/browse/ZOOKEEPER-3760. I was looking in the branch-3.6 but the release bits of 3.6.0 didn't include this patch.", "author": "bharathv", "createdAt": "2020-06-10T03:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzkwMA==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437683900", "bodyText": "nit: I think this for cross-version compatibility, a quick comment would be nice.", "author": "bharathv", "createdAt": "2020-06-09T20:00:21Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/zookeeper/TestHQuorumPeer.java", "diffHunk": "@@ -111,25 +115,39 @@\n     QuorumPeerConfig config = new QuorumPeerConfig();\n     config.parseProperties(properties);\n \n-    assertEquals(this.dataDir.toString(), config.getDataDir());\n+    assertEquals(this.dataDir.toString(), config.getDataDir().toString());\n     assertEquals(2181, config.getClientPortAddress().getPort());\n     Map<Long,QuorumServer> servers = config.getServers();\n     assertEquals(3, servers.size());\n     assertTrue(servers.containsKey(Long.valueOf(0)));\n     QuorumServer server = servers.get(Long.valueOf(0));\n-    assertEquals(\"localhost\", server.addr.getHostName());\n+    assertEquals(\"localhost\", getHostName(server));\n \n     // Override with system property.\n     System.setProperty(\"hbase.master.hostname\", \"foo.bar\");\n     is = new ByteArrayInputStream(s.getBytes());\n     properties = ZKConfig.parseZooCfg(conf, is);\n     assertEquals(\"foo.bar:2888:3888\", properties.get(\"server.0\"));\n-\n     config.parseProperties(properties);\n \n     servers = config.getServers();\n     server = servers.get(Long.valueOf(0));\n-    assertEquals(\"foo.bar\", server.addr.getHostName());\n+    assertEquals(\"foo.bar\", getHostName(server));\n+  }\n+\n+  private static String getHostName(QuorumServer server) throws Exception {\n+    String hostname;\n+    switch (server.addr.getClass().getName()) {", "originalCommit": "291537e063f9abe11168d59ad9b71e80126cb013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzczODU0NA==", "url": "https://github.com/apache/hbase/pull/1879#discussion_r437738544", "bodyText": "I can add a comment. I think the cross-version issues are clear enough by this resort to reflection :-(", "author": "apurtell", "createdAt": "2020-06-09T21:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4MzkwMA=="}], "type": "inlineReview"}, {"oid": "38734b0008df027edbeb2b349153019ed3ad82e5", "url": "https://github.com/apache/hbase/commit/38734b0008df027edbeb2b349153019ed3ad82e5", "message": "Add comments per review feedback", "committedDate": "2020-06-09T21:50:10Z", "type": "commit"}, {"oid": "f201c47ebed3f0af75654c17ac3339cb8f9c55f7", "url": "https://github.com/apache/hbase/commit/f201c47ebed3f0af75654c17ac3339cb8f9c55f7", "message": "Fix checkstyle nit", "committedDate": "2020-06-09T21:53:00Z", "type": "commit"}]}