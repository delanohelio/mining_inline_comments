{"pr_number": 2652, "pr_title": "HBASE-25280 [meta replicas] ArrayIndexOutOfBoundsException in ZKConne\u2026", "pr_createdAt": "2020-11-13T01:31:00Z", "pr_url": "https://github.com/apache/hbase/pull/2652", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522562320", "bodyText": "I do not think use index instead of replicaId is the correct way to fix the problem here.\nYou should use replicaId, and the problem here is the size of the array is incorrect. You should find out the maximum replicaId and create the locs array with maxReplicaId + 1 as its size.", "author": "Apache9", "createdAt": "2020-11-13T02:05:43Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ZKConnectionRegistry.java", "diffHunk": "@@ -133,13 +133,17 @@ private static void tryComplete(MutableInt remaining, HRegionLocation[] locs,\n       ServerName.valueOf(snProto.getHostName(), snProto.getPort(), snProto.getStartCode()));\n   }\n \n-  private void getMetaRegionLocation(CompletableFuture<RegionLocations> future,\n+  @VisibleForTesting\n+  void getMetaRegionLocation(CompletableFuture<RegionLocations> future,\n       List<String> metaReplicaZNodes) {\n     if (metaReplicaZNodes.isEmpty()) {\n       future.completeExceptionally(new IOException(\"No meta znode available\"));\n     }\n     HRegionLocation[] locs = new HRegionLocation[metaReplicaZNodes.size()];\n     MutableInt remaining = new MutableInt(locs.length);\n+    // Do NOT use replicaid as index into locations array. The location set may not be complete", "originalCommit": "5613f4b5c7c2fa4cf3bcd31faf064f71854b827c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5ODUxMw==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522598513", "bodyText": "Thanks for the review @Apache9\nI need help understanding here why returning an array with empty slots is the way to go instead? What you thinking? Is it that you are afraid that elsewhere we are using replicaid as index?\nWhen you say find the max replicaid, are you suggesting the max replicaid present in the list metaReplicaZNodes (doable)?  Or are you thinking the array should be same as the configured replica count (hard -- hard to pass an active table schema reference down to ConnectionRegistry)?\nThanks for the fast review.", "author": "saintstack", "createdAt": "2020-11-13T04:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYyMzYwNA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522623604", "bodyText": "Based on Duo and Stack's comments, I spend quite some time trying to understand how locs is being used.\nIt is being used in\nhttps://github.com/apache/hbase/blob/master/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ZKConnectionRegistry.java#L162\nIt is used for initialize RegionLocations() object.\nWithin RegionLocations(), all logic is there trying to allocate a location array with replica id as index.\nhttps://github.com/apache/hbase/blob/master/hbase-client/src/main/java/org/apache/hadoop/hbase/RegionLocations.java#L74\nSo it seems that at least in this place, it is fine to do in this way. Otherwise, the logic is duplicated twice?", "author": "huaxiangsun", "createdAt": "2020-11-13T04:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY0MjAwNw==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522642007", "bodyText": "Thanks @huaxiangsun . That helps (Its also used here https://github.com/apache/hbase/blob/master/hbase-client/src/main/java/org/apache/hadoop/hbase/client/ZKConnectionRegistry.java#L187 but if error, we don't get to this point because of ArrayOutOfBoundsException).\nLet me just do what @Apache9 suggests. Looks like there is precedent around the handling of this situation. Let me follow the model (even if it means double work as you point out).\nWill be back in a bit w/ new patch.", "author": "saintstack", "createdAt": "2020-11-13T04:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY2NTg4Mw==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522665883", "bodyText": "The problem is for RegionLocations. As Huaxiang pointed out that in RegionLocations we will handle the out of order replicas, I think it is fine to do something like this here. Maybe we could use a List instead of an array? And add a comment here to say that \"we do not care about the order of the replicas or if there are holes, the constructor of RegionLocations will handle this\". And we could add a Constructor for RegionLoations to accept a List. And for the old constructor which accepts an array, just do this(Arrays.asList(locations));", "author": "Apache9", "createdAt": "2020-11-13T05:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MDg2Mw==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522670863", "bodyText": "Let me try and do what you suggest later @Apache9 with a list and pointers back to RegionLocations. Making an array that is maxReplicaId+1 is going to have the tryComplete do more work than was asked for (see 'remaining' param). Thanks for the help.", "author": "saintstack", "createdAt": "2020-11-13T05:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MjMyMA=="}], "type": "inlineReview"}, {"oid": "cfa0594066b741ddbde13abb393a8a5983540099", "url": "https://github.com/apache/hbase/commit/cfa0594066b741ddbde13abb393a8a5983540099", "message": "HBASE-25280 [meta replicas] ArrayIndexOutOfBoundsException in ZKConnectionRegistry", "committedDate": "2020-11-13T07:03:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjczMzgyNA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r522733824", "bodyText": "Better to not expose this method here but write fake znode on zk to simulate discontinuous meta replicas? I do not think it is very difficult to do...", "author": "Apache9", "createdAt": "2020-11-13T07:35:13Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestZKConnectionRegistry.java", "diffHunk": "@@ -125,4 +127,20 @@ public void testNoMetaAvailable() throws InterruptedException {\n       }\n     }\n   }\n+\n+  /**\n+   * Pass discontinuous list of znodes to registry getMetaRegionLocation. Should work fine.\n+   * It used to throw ArrayOutOfBoundsException. See HBASE-25280.\n+   */\n+  @Test\n+  public void testDiscontinuousLocations() throws ExecutionException, InterruptedException {\n+    Configuration conf = new Configuration(TEST_UTIL.getConfiguration());\n+    try (ZKConnectionRegistry registry = new ZKConnectionRegistry(conf)) {\n+      CompletableFuture<RegionLocations> cf = new CompletableFuture<>();\n+      List<String> znodes = Arrays.asList(\n+        new String[] { ZNodePaths.META_ZNODE_PREFIX, ZNodePaths.META_ZNODE_PREFIX + \"_003\" });\n+      registry.getMetaRegionLocation(cf, znodes);", "originalCommit": "cfa0594066b741ddbde13abb393a8a5983540099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE3OTc5OA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r523179798", "bodyText": "Done", "author": "saintstack", "createdAt": "2020-11-13T19:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjczMzgyNA=="}], "type": "inlineReview"}, {"oid": "adbf81c010a5fbfebfcc4aae68e35dbd12da1601", "url": "https://github.com/apache/hbase/commit/adbf81c010a5fbfebfcc4aae68e35dbd12da1601", "message": "HBASE-25280 [meta replicas] ArrayIndexOutOfBoundsException in ZKConnectionRegistry\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>\nSigned-off-by: Huaxiang Sun <huaxiangsun@apache.com>", "committedDate": "2020-11-13T19:28:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NzcwMA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r523297700", "bodyText": "This will generate a generic type warning, please use new TreeMap<>()", "author": "Apache9", "createdAt": "2020-11-14T00:20:47Z", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ZKConnectionRegistry.java", "diffHunk": "@@ -138,8 +141,15 @@ private void getMetaRegionLocation(CompletableFuture<RegionLocations> future,\n     if (metaReplicaZNodes.isEmpty()) {\n       future.completeExceptionally(new IOException(\"No meta znode available\"));\n     }\n-    HRegionLocation[] locs = new HRegionLocation[metaReplicaZNodes.size()];\n-    MutableInt remaining = new MutableInt(locs.length);\n+    // Note, the list of metaReplicaZNodes may be discontiguous regards replicaId; i.e. we may have\n+    // a znode for the default -- replicaId=0 -- and perhaps replicaId '2' but be could be missing\n+    // znode for replicaId '1'. This is a transient condition. Because of this we are careful\n+    // accumulating locations. We use a Map so retries overwrite rather than aggregate and the\n+    // Map sorts just to be kind to further processing. The Map will retain the discontinuity on\n+    // replicaIds but on completion (of the future), the Map values are passed to the\n+    // RegionLocations constructor which knows how to deal with discontinuities.\n+    final Map<Integer, HRegionLocation> locs = new TreeMap();", "originalCommit": "adbf81c010a5fbfebfcc4aae68e35dbd12da1601", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjM1OA==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r524416358", "bodyText": "Fixed", "author": "saintstack", "createdAt": "2020-11-16T16:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5NzcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5ODM3NQ==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r523298375", "bodyText": "I recall that you mentioned many times that the operator must be at the end of a line so I changed my formatter config to do this, so now you prefer the operator at the start of a line?\nI'm fine with both, just want to know which one do you want, or it is not important?", "author": "Apache9", "createdAt": "2020-11-14T00:24:12Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestZKConnectionRegistry.java", "diffHunk": "@@ -101,8 +116,8 @@ public void testIndependentZKConnections() throws IOException {\n       otherConf.set(HConstants.ZOOKEEPER_QUORUM, MiniZooKeeperCluster.HOST);\n       try (ZKConnectionRegistry otherRegistry = new ZKConnectionRegistry(otherConf)) {\n         ReadOnlyZKClient zk2 = otherRegistry.getZKClient();\n-        assertNotSame(\"Using a different configuration / quorum should result in different \" +\n-          \"backing zk connection.\", zk1, zk2);\n+        assertNotSame(\"Using a different configuration / quorum should result in different \"\n+          + \"backing zk connection.\", zk1, zk2);", "originalCommit": "adbf81c010a5fbfebfcc4aae68e35dbd12da1601", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjkxOQ==", "url": "https://github.com/apache/hbase/pull/2652#discussion_r524416919", "bodyText": "Mistake. I like '+' at end of line. Let me fix.", "author": "saintstack", "createdAt": "2020-11-16T16:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI5ODM3NQ=="}], "type": "inlineReview"}, {"oid": "4ccd537fc49946e9dc7f1253901a3935e5237074", "url": "https://github.com/apache/hbase/commit/4ccd537fc49946e9dc7f1253901a3935e5237074", "message": "HBASE-25280 [meta replicas] ArrayIndexOutOfBoundsException in ZKConnectionRegistry\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>\nSigned-off-by: Huaxiang Sun <huaxiangsun@apache.com>", "committedDate": "2020-11-16T16:52:57Z", "type": "commit"}, {"oid": "4ccd537fc49946e9dc7f1253901a3935e5237074", "url": "https://github.com/apache/hbase/commit/4ccd537fc49946e9dc7f1253901a3935e5237074", "message": "HBASE-25280 [meta replicas] ArrayIndexOutOfBoundsException in ZKConnectionRegistry\n\nSigned-off-by: Duo Zhang <zhangduo@apache.org>\nSigned-off-by: Huaxiang Sun <huaxiangsun@apache.com>", "committedDate": "2020-11-16T16:52:57Z", "type": "forcePushed"}]}