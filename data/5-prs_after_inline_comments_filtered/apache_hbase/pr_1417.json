{"pr_number": 1417, "pr_title": "HBASE-24102 : Remove decommissioned RS from target servers while unlo\u2026", "pr_createdAt": "2020-04-02T09:33:32Z", "pr_url": "https://github.com/apache/hbase/pull/1417", "timeline": [{"oid": "f02c99d1f8b18ef04494520f82e1322547ffeb19", "url": "https://github.com/apache/hbase/commit/f02c99d1f8b18ef04494520f82e1322547ffeb19", "message": "HBASE-24102 : Remove decommissioned RS from target servers while unloading regions", "committedDate": "2020-04-02T09:32:00Z", "type": "commit"}, {"oid": "4a33dfdbecde864b75aaf86b2eca0d47a9404a5e", "url": "https://github.com/apache/hbase/commit/4a33dfdbecde864b75aaf86b2eca0d47a9404a5e", "message": "adding tests", "committedDate": "2020-04-02T14:41:56Z", "type": "commit"}, {"oid": "8e18b4696c2961da8131ece67353b62bf27cff89", "url": "https://github.com/apache/hbase/commit/8e18b4696c2961da8131ece67353b62bf27cff89", "message": "review comment - refactor test code", "committedDate": "2020-04-02T17:20:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTU3OA==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402495578", "bodyText": "Should we wait for the decom to happen or just start the region mover tool and then finally assert that none of the regions are in the decom node - assuming the region plan was created even before the decom was completed. Else LGTM.", "author": "ramkrish86", "createdAt": "2020-04-02T17:39:46Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover.java", "diffHunk": "@@ -238,4 +245,139 @@ public void testTargetServerDeadWhenLoading() throws Exception {\n       assertFalse(rm.load());\n     }\n   }\n+\n+  @Test\n+  public void testDecomServerExclusionWithAck() throws Exception {\n+    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n+    HRegionServer excludeServer = cluster.getRegionServer(1);\n+    List<HRegion> regions = excludeServer.getRegions();\n+    int regionsExcludeServer = excludeServer.getNumberOfOnlineRegions();\n+    TEST_UTIL.getAdmin().decommissionRegionServers(\n+      Collections.singletonList(excludeServer.getServerName()), false);\n+\n+    waitForServerDecom(excludeServer);\n+\n+    HRegionServer regionServer = cluster.getRegionServer(0);\n+    String rsName = regionServer.getServerName().getHostname();\n+    int port = regionServer.getServerName().getPort();\n+    String hostname = rsName + \":\" + Integer.toString(port);\n+    RegionMoverBuilder rmBuilder = new RegionMoverBuilder(hostname, TEST_UTIL.getConfiguration())\n+      .ack(true);\n+\n+    int targetServerRegions = cluster.getRegionServer(2).getRegions().size();\n+    int sourceServerRegions = regionServer.getRegions().size();\n+\n+    try (RegionMover regionMover = rmBuilder.build()) {\n+      Assert.assertTrue(regionMover.unload());\n+      LOG.info(\"Unloading {}\", hostname);\n+      assertEquals(0, regionServer.getNumberOfOnlineRegions());\n+      assertEquals(regionsExcludeServer, cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      LOG.info(\"Before:\" + regionsExcludeServer + \" After:\" +\n+        cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      List<HRegion> regionList = cluster.getRegionServer(1).getRegions();\n+      int index = 0;\n+      for (HRegion hRegion : regionList) {\n+        Assert.assertEquals(hRegion, regions.get(index++));\n+      }\n+      Assert.assertEquals(targetServerRegions + sourceServerRegions,\n+        cluster.getRegionServer(2).getNumberOfOnlineRegions());\n+      Assert.assertTrue(regionMover.load());\n+    }\n+\n+    TEST_UTIL.getAdmin().recommissionRegionServer(excludeServer.getServerName(),\n+      Collections.emptyList());\n+  }\n+\n+  private void waitForServerDecom(HRegionServer excludeServer) throws IOException {", "originalCommit": "8e18b4696c2961da8131ece67353b62bf27cff89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMTE2MA==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402531160", "bodyText": "assuming the region plan was created even before the decom was completed.\n\nIn this case, admin.listDecommissionedRegionServers() might not return server which is going to be decommissioned right? Hence, I put wait here to ensure asynchronously, RS is in decom state. What we want to do as part of unload() function is to not include any server which is decommissioned by retrieving them from admin.listDecommissionedRegionServers(). If by any chance, while unload is busy unloading regions to many region servers, we might start decommission of some servers. So in this case, we might not be able to stop unloading regions to such nodes. or let's say we unloaded regions to all other servers and after that some were put to decommissioning, if regions are still online on that servers, we should be able to load them back successfully. What we want is for unload() to ensure any server already marked as decom should not be selected. Or I am missing something?", "author": "virajjasani", "createdAt": "2020-04-02T18:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTMyNw==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402495327", "bodyText": "Add debug logging at least of set of decommissioned RS found?", "author": "saintstack", "createdAt": "2020-04-02T17:39:31Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/util/RegionMover.java", "diffHunk": "@@ -432,6 +434,11 @@ public boolean unload() throws InterruptedException, ExecutionException, Timeout\n         }\n         // Remove RS present in the exclude file\n         stripExcludes(regionServers);\n+\n+        // Remove decommissioned RS\n+        Set<ServerName> decommissionedRS = new HashSet<>(admin.listDecommissionedRegionServers());\n+        regionServers.removeIf(decommissionedRS::contains);", "originalCommit": "8e18b4696c2961da8131ece67353b62bf27cff89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjI4NA==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402532284", "bodyText": "Sure thing", "author": "virajjasani", "createdAt": "2020-04-02T18:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5NTU2Nw==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402495567", "bodyText": "Good", "author": "saintstack", "createdAt": "2020-04-02T17:39:45Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover.java", "diffHunk": "@@ -51,7 +58,7 @@\n  * Tests for Region Mover Load/Unload functionality with and without ack mode and also to test\n  * exclude functionality useful for rack decommissioning\n  */\n-@Category({ MiscTests.class, MediumTests.class })\n+@Category({MiscTests.class, LargeTests.class})", "originalCommit": "8e18b4696c2961da8131ece67353b62bf27cff89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "832a67d119ed1c48a259d597a962abe044e5dad5", "url": "https://github.com/apache/hbase/commit/832a67d119ed1c48a259d597a962abe044e5dad5", "message": "review comment - adding debug log & updating some access specifiers", "committedDate": "2020-04-02T18:53:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMTEwMg==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402621102", "bodyText": "extra space line", "author": "xcangCRM", "createdAt": "2020-04-02T22:00:54Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover.java", "diffHunk": "@@ -238,4 +245,139 @@ public void testTargetServerDeadWhenLoading() throws Exception {\n       assertFalse(rm.load());\n     }\n   }\n+\n+  @Test\n+  public void testDecomServerExclusionWithAck() throws Exception {\n+    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n+    HRegionServer excludeServer = cluster.getRegionServer(1);\n+    List<HRegion> regions = excludeServer.getRegions();\n+    int regionsExcludeServer = excludeServer.getNumberOfOnlineRegions();\n+    TEST_UTIL.getAdmin().decommissionRegionServers(\n+      Collections.singletonList(excludeServer.getServerName()), false);\n+\n+    waitForServerDecom(excludeServer);\n+\n+    HRegionServer regionServer = cluster.getRegionServer(0);\n+    String rsName = regionServer.getServerName().getHostname();\n+    int port = regionServer.getServerName().getPort();\n+    String hostname = rsName + \":\" + Integer.toString(port);\n+    RegionMoverBuilder rmBuilder = new RegionMoverBuilder(hostname, TEST_UTIL.getConfiguration())\n+      .ack(true);\n+\n+    int targetServerRegions = cluster.getRegionServer(2).getRegions().size();\n+    int sourceServerRegions = regionServer.getRegions().size();\n+\n+    try (RegionMover regionMover = rmBuilder.build()) {\n+      Assert.assertTrue(regionMover.unload());\n+      LOG.info(\"Unloading {}\", hostname);\n+      assertEquals(0, regionServer.getNumberOfOnlineRegions());\n+      assertEquals(regionsExcludeServer, cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      LOG.info(\"Before:\" + regionsExcludeServer + \" After:\" +\n+        cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      List<HRegion> regionList = cluster.getRegionServer(1).getRegions();\n+      int index = 0;\n+      for (HRegion hRegion : regionList) {\n+        Assert.assertEquals(hRegion, regions.get(index++));\n+      }\n+      Assert.assertEquals(targetServerRegions + sourceServerRegions,\n+        cluster.getRegionServer(2).getNumberOfOnlineRegions());\n+      Assert.assertTrue(regionMover.load());\n+    }\n+\n+    TEST_UTIL.getAdmin().recommissionRegionServer(excludeServer.getServerName(),\n+      Collections.emptyList());\n+  }\n+\n+  private void waitForServerDecom(HRegionServer excludeServer) throws IOException {\n+\n+    TEST_UTIL.getAdmin().decommissionRegionServers(\n+      Collections.singletonList(excludeServer.getServerName()), false);\n+\n+    TEST_UTIL.waitFor(3000, () -> {\n+      try {\n+        List<ServerName> decomServers = TEST_UTIL.getAdmin().listDecommissionedRegionServers();\n+        return decomServers.size() == 1\n+          && decomServers.get(0).equals(excludeServer.getServerName());\n+      } catch (IOException e) {\n+        throw new RuntimeException(e);\n+      }\n+    });\n+", "originalCommit": "832a67d119ed1c48a259d597a962abe044e5dad5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMTUwOQ==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402621509", "bodyText": "is this 3s? If so, is this enough?", "author": "xcangCRM", "createdAt": "2020-04-02T22:01:53Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/util/TestRegionMover.java", "diffHunk": "@@ -238,4 +245,139 @@ public void testTargetServerDeadWhenLoading() throws Exception {\n       assertFalse(rm.load());\n     }\n   }\n+\n+  @Test\n+  public void testDecomServerExclusionWithAck() throws Exception {\n+    MiniHBaseCluster cluster = TEST_UTIL.getHBaseCluster();\n+    HRegionServer excludeServer = cluster.getRegionServer(1);\n+    List<HRegion> regions = excludeServer.getRegions();\n+    int regionsExcludeServer = excludeServer.getNumberOfOnlineRegions();\n+    TEST_UTIL.getAdmin().decommissionRegionServers(\n+      Collections.singletonList(excludeServer.getServerName()), false);\n+\n+    waitForServerDecom(excludeServer);\n+\n+    HRegionServer regionServer = cluster.getRegionServer(0);\n+    String rsName = regionServer.getServerName().getHostname();\n+    int port = regionServer.getServerName().getPort();\n+    String hostname = rsName + \":\" + Integer.toString(port);\n+    RegionMoverBuilder rmBuilder = new RegionMoverBuilder(hostname, TEST_UTIL.getConfiguration())\n+      .ack(true);\n+\n+    int targetServerRegions = cluster.getRegionServer(2).getRegions().size();\n+    int sourceServerRegions = regionServer.getRegions().size();\n+\n+    try (RegionMover regionMover = rmBuilder.build()) {\n+      Assert.assertTrue(regionMover.unload());\n+      LOG.info(\"Unloading {}\", hostname);\n+      assertEquals(0, regionServer.getNumberOfOnlineRegions());\n+      assertEquals(regionsExcludeServer, cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      LOG.info(\"Before:\" + regionsExcludeServer + \" After:\" +\n+        cluster.getRegionServer(1).getNumberOfOnlineRegions());\n+      List<HRegion> regionList = cluster.getRegionServer(1).getRegions();\n+      int index = 0;\n+      for (HRegion hRegion : regionList) {\n+        Assert.assertEquals(hRegion, regions.get(index++));\n+      }\n+      Assert.assertEquals(targetServerRegions + sourceServerRegions,\n+        cluster.getRegionServer(2).getNumberOfOnlineRegions());\n+      Assert.assertTrue(regionMover.load());\n+    }\n+\n+    TEST_UTIL.getAdmin().recommissionRegionServer(excludeServer.getServerName(),\n+      Collections.emptyList());\n+  }\n+\n+  private void waitForServerDecom(HRegionServer excludeServer) throws IOException {\n+\n+    TEST_UTIL.getAdmin().decommissionRegionServers(\n+      Collections.singletonList(excludeServer.getServerName()), false);\n+\n+    TEST_UTIL.waitFor(3000, () -> {", "originalCommit": "832a67d119ed1c48a259d597a962abe044e5dad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4OTQyMw==", "url": "https://github.com/apache/hbase/pull/1417#discussion_r402789423", "bodyText": "Actually, 3s is too much :) Upper bound ideally should not be more than 1s, this is just to be on safer side.", "author": "virajjasani", "createdAt": "2020-04-03T07:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyMTUwOQ=="}], "type": "inlineReview"}, {"oid": "ee976772d9c0bf09fcb52acf9e13159ae654455f", "url": "https://github.com/apache/hbase/commit/ee976772d9c0bf09fcb52acf9e13159ae654455f", "message": "removing extra space", "committedDate": "2020-04-03T07:36:18Z", "type": "commit"}, {"oid": "ed55c8b98d6652eddb3874c522fa2bbde2c799ea", "url": "https://github.com/apache/hbase/commit/ed55c8b98d6652eddb3874c522fa2bbde2c799ea", "message": "minor formatter changes", "committedDate": "2020-04-03T11:35:19Z", "type": "commit"}]}