{"pr_number": 2675, "pr_title": "HBASE-25277 postScannerFilterRow impacts Scan performance a lot in HBase 2.x", "pr_createdAt": "2020-11-18T16:23:57Z", "pr_url": "https://github.com/apache/hbase/pull/2675", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQwMTA5NA==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r529401094", "bodyText": "Actually in RegionObserver we don't do any copy so this comment was irrelevant. So it is ok to remove the default impl in the security CP that we have with hbase.", "author": "ramkrish86", "createdAt": "2020-11-24T10:13:51Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/security/access/AccessController.java", "diffHunk": "@@ -1848,13 +1848,6 @@ public void postScannerClose(final ObserverContext<RegionCoprocessorEnvironment>\n     scannerOwners.remove(s);\n   }\n \n-  @Override\n-  public boolean postScannerFilterRow(final ObserverContext<RegionCoprocessorEnvironment> e,\n-      final InternalScanner s, final Cell curRowCell, final boolean hasMore) throws IOException {\n-    // 'default' in RegionObserver might do unnecessary copy for Off heap backed Cells.", "originalCommit": "dd0ae8dfb63f69ff91e7468bca8c15f47aafedee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDExNjUxMw==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r530116513", "bodyText": "Actually change can be at begin of this loop\nif (clazz == null) {\n// we must have directly implemented RegionObserver\nhasCustomPostScannerFilterRow = true;\nbreak out;\n}\nIn 1.x we have interface with no def impl. So we have to consider like hasCustomPostScannerFilterRow = true then. But in 2.x we have Interface with default impl.  So its safe to change there to be hasCustomPostScannerFilterRow = false only.\nIn fact that check can be as urs\nif (clazz == Object.class) {\nbreak out;\n}", "author": "anoopsjohn", "createdAt": "2020-11-25T05:28:46Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RegionCoprocessorHost.java", "diffHunk": "@@ -299,6 +304,11 @@ public RegionCoprocessorHost(final HRegion region,\n           } catch (NoSuchMethodException ignore) {\n           }\n           clazz = clazz.getSuperclass();\n+", "originalCommit": "dd0ae8dfb63f69ff91e7468bca8c15f47aafedee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU1NTQ4Mw==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r530555483", "bodyText": "In fact that check can be as urs\nif (clazz == Object.class) {\nbreak out;\n}\n\nmake sense, will update the PR.", "author": "pankaj72981", "createdAt": "2020-11-25T17:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDExNjUxMw=="}], "type": "inlineReview"}, {"oid": "a43d31b69f3a5cd73922d692b7ec2fd9822103da", "url": "https://github.com/apache/hbase/commit/a43d31b69f3a5cd73922d692b7ec2fd9822103da", "message": "HBASE-25277 Addressed review comment", "committedDate": "2020-11-25T18:27:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NTAwNg==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r531575006", "bodyText": "U can basically break at this point? Come out of the inner loop.\nCould have kept for(;;) {  as is also.\nJust to keep the change to be 3 lines only\nMinor suggestion though", "author": "anoopsjohn", "createdAt": "2020-11-27T12:30:17Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RegionCoprocessorHost.java", "diffHunk": "@@ -275,11 +280,11 @@ public RegionCoprocessorHost(final HRegion region,\n     out: for (RegionCoprocessorEnvironment env: coprocEnvironments) {\n       if (env.getInstance() instanceof RegionObserver) {\n         Class<?> clazz = env.getInstance().getClass();\n-        for(;;) {\n-          if (clazz == null) {\n-            // we must have directly implemented RegionObserver\n-            hasCustomPostScannerFilterRow = true;\n-            break out;\n+        while (clazz != null) {\n+          if (clazz == Object.class) {\n+            // we dont need to look postScannerFilterRow into Object class\n+            clazz = null;\n+            continue;", "originalCommit": "6653ceecf92d5f4da21916eab8d36ac13924e3bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "af0dada87f1ac210594349dfe859bf13627eac14", "url": "https://github.com/apache/hbase/commit/af0dada87f1ac210594349dfe859bf13627eac14", "message": "HBASE-25277 Addressed the review comment", "committedDate": "2020-12-02T19:21:09Z", "type": "forcePushed"}, {"oid": "861da710201d50354f4084b133bc937fa80d02f3", "url": "https://github.com/apache/hbase/commit/861da710201d50354f4084b133bc937fa80d02f3", "message": "HBASE-25277 postScannerFilterRow impacts Scan performance a lot in HBase 2.x", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "b1d2cb28caf4a5272487a5345047abd4ab9b658c", "url": "https://github.com/apache/hbase/commit/b1d2cb28caf4a5272487a5345047abd4ab9b658c", "message": "HBASE-25277 postScannerFilterRow impacts Scan performance a lot in HBase 2.x", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "7488642b3da94d1a32f77d5b24704c2c46667316", "url": "https://github.com/apache/hbase/commit/7488642b3da94d1a32f77d5b24704c2c46667316", "message": "HBASE-25277 Addressed the checkstyle & spotbugs errors", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "08a38625c6fa6baf334be1cdee82bae4d8a0a45d", "url": "https://github.com/apache/hbase/commit/08a38625c6fa6baf334be1cdee82bae4d8a0a45d", "message": "HBASE-25277 Fixed the compilation issue", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "03ffeafcbc04a52f1f15a3ee511b73b3fa4bb26a", "url": "https://github.com/apache/hbase/commit/03ffeafcbc04a52f1f15a3ee511b73b3fa4bb26a", "message": "HBASE-25277 Addressed review comment", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "e88a88dbc9514c07e4d95aea9ea923ae4366ba9c", "url": "https://github.com/apache/hbase/commit/e88a88dbc9514c07e4d95aea9ea923ae4366ba9c", "message": "HBASE-25277 hasCustomPostScannerFilterRow will be set wrong when multiple CPs are configured and few CP override postScannerFilterRow", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "82c525c4b4f62d584f71c620a22e89f78fc55441", "url": "https://github.com/apache/hbase/commit/82c525c4b4f62d584f71c620a22e89f78fc55441", "message": "HBASE-25277 Checkstyle error fix", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "da26bbfd5ad36613006459f8ed30722a99c361af", "url": "https://github.com/apache/hbase/commit/da26bbfd5ad36613006459f8ed30722a99c361af", "message": "HBASE-25277 Addressed the review comment", "committedDate": "2020-12-06T05:35:20Z", "type": "commit"}, {"oid": "c612df8e3050b77276c051335974a339659f4c79", "url": "https://github.com/apache/hbase/commit/c612df8e3050b77276c051335974a339659f4c79", "message": "HBASE-25277 Checkstyle warn fix", "committedDate": "2020-12-06T05:37:50Z", "type": "commit"}, {"oid": "c612df8e3050b77276c051335974a339659f4c79", "url": "https://github.com/apache/hbase/commit/c612df8e3050b77276c051335974a339659f4c79", "message": "HBASE-25277 Checkstyle warn fix", "committedDate": "2020-12-06T05:37:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzAzNjg0Mg==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r537036842", "bodyText": "Let's use private here? I do not think this method needs to be called in other classes?", "author": "Apache9", "createdAt": "2020-12-06T13:15:44Z", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/coprocessor/TestRegionCoprocessorHost.java", "diffHunk": "@@ -79,19 +81,36 @@\n \n   @Before\n   public void setup() throws IOException {\n+    init(null);\n+  }\n+\n+  public void init(Boolean flag) throws IOException {", "originalCommit": "c612df8e3050b77276c051335974a339659f4c79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzAzODcyMg==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r537038722", "bodyText": "OK, VisibleForTesting...\nWe have a dicussion thread in the mailing list, and @apurtell concluded that we do not use annotation at all, just use a javadoc, and had already done a PR to remove all the VisibleForTesting annotations from our code base. I'm still trying to convince him to allow this annotation on IA.Private classes.\nThere is still no consensus yet, you can see the discussion in this PR\n#2714\nSo here I suggest that we remove this annotation to align with the current rule in our code base first. But anyway, I think this is an example that developers want to use this annotation, so maybe @apurtell could change his opinion.\nThanks.", "author": "Apache9", "createdAt": "2020-12-06T13:26:04Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RegionCoprocessorHost.java", "diffHunk": "@@ -102,6 +102,11 @@\n   // optimization: no need to call postScannerFilterRow, if no coprocessor implements it\n   private final boolean hasCustomPostScannerFilterRow;\n \n+  @VisibleForTesting", "originalCommit": "c612df8e3050b77276c051335974a339659f4c79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMxNDg3OQ==", "url": "https://github.com/apache/hbase/pull/2675#discussion_r537314879", "bodyText": "Yeah, VisibleForTesting is useless. Will remove this.", "author": "pankaj72981", "createdAt": "2020-12-07T08:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzAzODcyMg=="}], "type": "inlineReview"}, {"oid": "9a153f49ec2d441484ebdd875af9f6928200906d", "url": "https://github.com/apache/hbase/commit/9a153f49ec2d441484ebdd875af9f6928200906d", "message": "HBASE-25277 Review comment fix", "committedDate": "2020-12-07T08:34:07Z", "type": "commit"}]}