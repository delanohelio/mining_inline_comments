{"pr_number": 2521, "pr_title": "HBASE-25117 ReplicationSourceShipper thread can not be finished", "pr_createdAt": "2020-10-09T07:46:58Z", "pr_url": "https://github.com/apache/hbase/pull/2521", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MTI1MA==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r502741250", "bodyText": "This means we eat the interrupted exception at some places? Can we propagate it to the upper layer?", "author": "Apache9", "createdAt": "2020-10-10T03:44:55Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/HBaseInterClusterReplicationEndpoint.java", "diffHunk": "@@ -475,7 +476,7 @@ public boolean replicate(ReplicateContext replicateContext) {\n     }\n \n     List<List<Entry>> batches = createBatches(replicateContext.getEntries());\n-    while (this.isRunning() && !exec.isShutdown()) {\n+    while (this.isRunning() && !exec.isShutdown() && !Thread.currentThread().isInterrupted()) {", "originalCommit": "76d357e8616a9428f821a04005bf3532710f4071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0Mjg2Mw==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r502742863", "bodyText": "Yes, InterruptedException catched in method sleepForRetries, but no further processing. The upper layer, you said, means ReplicationSourceShipper? We just keep the interrupted status of the current thread, ReplicationSourceShipper.isActive() can sense it.", "author": "ddupg", "createdAt": "2020-10-10T04:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1MzczMA==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r502753730", "bodyText": "Then I think we should reset the running or shutdown flag in sleepForRetries when we get InterruptedException? Then here we know that we should quit?", "author": "Apache9", "createdAt": "2020-10-10T06:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MTI1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzODkwMw==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r503638903", "bodyText": "How about using ReplicationSource.isSourceActive() instead of !Thread.currentThread().isInterrupted() ? HBaseReplicationEndpoint manages lifecycle by extent AbstractService, adding a flag in HBaseInterClusterReplicationEndpoint is a bit redundant?", "author": "ddupg", "createdAt": "2020-10-13T02:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MTI1MA=="}], "type": "inlineReview"}, {"oid": "0bb3ce5874edc2cdb55690a10c3e59c143094abf", "url": "https://github.com/apache/hbase/commit/0bb3ce5874edc2cdb55690a10c3e59c143094abf", "message": "HBASE-25117 ReplicationSourceShipper thread can not be finished", "committedDate": "2020-10-13T03:15:04Z", "type": "commit"}, {"oid": "0bb3ce5874edc2cdb55690a10c3e59c143094abf", "url": "https://github.com/apache/hbase/commit/0bb3ce5874edc2cdb55690a10c3e59c143094abf", "message": "HBASE-25117 ReplicationSourceShipper thread can not be finished", "committedDate": "2020-10-13T03:15:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0OTQyMg==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r503649422", "bodyText": "ReplicationSourceShipper and entryReader are thread. replicationEndpoint is not a thread and is used by ReplicationSourceShipper thread. I am +1 for this: stop firstly, then interrupt thread.", "author": "infraio", "createdAt": "2020-10-13T03:43:19Z", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -691,6 +691,9 @@ public void terminate(String reason, Exception cause, boolean clearMetrics,\n       }\n     }\n \n+    if (this.replicationEndpoint != null) {", "originalCommit": "0bb3ce5874edc2cdb55690a10c3e59c143094abf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4OTQ2Mw==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r503889463", "bodyText": "I think the intenion here to interrupt thread first is that, we want to make sure that, we could still do replication when shutting down the worker.\nIn general, I'm fine with this approach as in distributed system, we should have the ability to deal with this type error. But it is still a bit strange that, the above stop worker and setReaderRunning to false can not stop the work?", "author": "Apache9", "createdAt": "2020-10-13T11:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0OTQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM1OTIxNg==", "url": "https://github.com/apache/hbase/pull/2521#discussion_r504359216", "bodyText": "But it is still a bit strange that, the above stop worker and setReaderRunning to false can not stop the work?\n\nYes, stop worker and setReaderRunning to false just set flag non-running, if happens exception in while loop of method replicationEndpoint.replicate, will go into retry and cannot sense the flag changing. Leaving the retry can be achieved by calling replicationEndpoint.stop().", "author": "ddupg", "createdAt": "2020-10-14T02:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0OTQyMg=="}], "type": "inlineReview"}]}