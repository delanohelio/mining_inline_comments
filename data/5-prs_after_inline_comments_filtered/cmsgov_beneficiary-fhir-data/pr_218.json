{"pr_number": 218, "pr_title": "Faster startup time", "pr_createdAt": "2020-02-13T13:02:02Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218", "timeline": [{"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/310cbe31149ad97b921b81d32c29aa40d9b269bf", "message": "Faster startup time\n\nInstead of calling refreshFilters, just set transactionTime during init time. RefreshFilters will happen periodically in the background.", "committedDate": "2020-02-13T12:59:29Z", "type": "commit"}, {"oid": "740f25758f479826c5576ee1460ef7fcdc663bda", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/740f25758f479826c5576ee1460ef7fcdc663bda", "message": "Fixup the set method", "committedDate": "2020-02-13T13:24:18Z", "type": "commit"}, {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "message": "Readability of BEFORE_LAST_UPDATE_FEATURE", "committedDate": "2020-02-13T13:38:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MTk5NQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378851995", "bodyText": "This date is used in the case that the LoadedBatches table is empty. It just needs to be sometime in the past.", "author": "RickHawesUSDS", "createdAt": "2020-02-13T13:16:06Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -27,6 +31,10 @@\n public class LoadedFilterManager {\n   private static final Logger LOGGER = LoggerFactory.getLogger(LoadedFilterManager.class);\n \n+  // A date before the lastUpdate feature was rolled out\n+  private static final Date BEFORE_LAST_UPDATE = Date.from(Instant.parse(\"2020-01-01T00:00:00Z\"));\n+\n+  // The size of the beneficiaryId column", "originalCommit": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MjM2OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378852368", "bodyText": "lastBatchCreated is set by the refreshFilters.", "author": "RickHawesUSDS", "createdAt": "2020-02-13T13:16:52Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -35,11 +43,14 @@\n   // The filter set\n   private List<LoadedFileFilter> filters;\n \n-  // Max created date from the database's LoadedBatch table\n+  // The latest transaction time from the LoadedBatch files\n   private Date transactionTime;\n \n-  // Min created date from the databases's LoadedBatch table\n-  private Date firstBatchUpdate;\n+  // The last LoadedBatch.created in the filter set\n+  private Date lastBatchCreated;\n+", "originalCommit": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MjY1Ng==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378852656", "bodyText": "transactionTime is set by init and refreshFilters", "author": "RickHawesUSDS", "createdAt": "2020-02-13T13:17:26Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -35,11 +43,14 @@\n   // The filter set\n   private List<LoadedFileFilter> filters;\n \n-  // Max created date from the database's LoadedBatch table\n+  // The latest transaction time from the LoadedBatch files\n   private Date transactionTime;\n ", "originalCommit": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MzI5MQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378853291", "bodyText": "Here's the algorithm change. fetchLastLoadedBatchCreated will have a consistent duration because of the index on LoadedBatches", "author": "RickHawesUSDS", "createdAt": "2020-02-13T13:18:39Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -115,8 +138,8 @@ public void setEntityManager(EntityManager entityManager) {\n \n   /** Called to finish initialization of the manager */\n   @PostConstruct\n-  public void init() {\n-    refreshFilters();\n+  public synchronized void init() {\n+    transactionTime = fetchLastLoadedBatchCreated();", "originalCommit": "310cbe31149ad97b921b81d32c29aa40d9b269bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg2NTI3OA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378865278", "bodyText": "I've moved this else clause out of this function to the caller for code readability reasons. This logic shouldn't handle the case when the table is empty.", "author": "RickHawesUSDS", "createdAt": "2020-02-13T13:41:33Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -341,29 +375,30 @@ public static LoadedFileFilter buildFilter(\n   /* DB Operations */\n \n   /**\n-   * Return the max date from the LoadedBatch table\n+   * Return the max date from the LoadedBatch table. If no batches are present, then the schema\n+   * migration time which will be a timestamp before the first loaded batch\n    *\n    * @return the max date\n    */\n-  private Date fetchLastLoadedBatchTime() {\n+  private Optional<Date> fetchLastLoadedBatchCreated() {\n     Date maxCreated =\n         entityManager\n             .createQuery(\"select max(b.created) from LoadedBatch b\", Date.class)\n             .getSingleResult();\n-    return Optional.ofNullable(maxCreated).orElse(new Date());\n+    return Optional.ofNullable(maxCreated);\n   }", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378971883", "bodyText": "If I'm not mistaken the parameters have changed but the general logic behind this statement has not correct?  I ask because currently in the test environment this is logging every second and causing logs to fill up quite a bit.\nCould this be changed to a debug level?", "author": "njdister", "createdAt": "2020-02-13T16:27:26Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4ODI3Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378988273", "bodyText": "This code shouldn't put a log entry every second, only when new RIF batch was loaded. It doesn't on my laptop. Can you send me the logs where it is?", "author": "RickHawesUSDS", "createdAt": "2020-02-13T16:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDYwMQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r379040601", "bodyText": "Got your logs. I understand the problem and was able to reproduce it locally. The cause was using now() for the case where there was an empty LoadedBatches table.  I also confirmed that this change fixes the problem.", "author": "RickHawesUSDS", "createdAt": "2020-02-13T18:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjM2Mw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972363", "bodyText": "Same as above, this is currently logging every second in test.  Can this be changed to debug?", "author": "njdister", "createdAt": "2020-02-13T16:28:08Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(\n             \"Refreshing LoadedFile filters with new filters from {} to {}\",\n-            transactionTime,\n-            currentLastDatabaseUpdate);\n-        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.transactionTime);\n+            lastBatchCreated,\n+            currentLastBatchCreated);\n+        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.lastBatchCreated);\n         this.filters = updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n-        this.transactionTime = currentLastDatabaseUpdate;\n+        this.lastBatchCreated = currentLastBatchCreated;\n \n         // If batches been trimmed, then remove filters which are no longer present\n-        final Date currentFirstBatchUpdate = fetchFirstLoadedBatchTime();\n-        if (this.firstBatchUpdate == null\n-            || this.firstBatchUpdate.before(currentFirstBatchUpdate)) {\n+        final Date currentFirstBatchUpdate =\n+            fetchFirstLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+        if (this.firstBatchCreated == null\n+            || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjEzMA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972130", "bodyText": "Is this the equivalent of saying if lastBatchCreated is null or lastBatchCreated is before transactionTime?", "author": "whytheplatypus", "createdAt": "2020-02-13T16:27:48Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {", "originalCommit": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}