{"pr_number": 421, "pr_title": "BFD-351: EOB resource and PDE Profile for BFD V2", "pr_createdAt": "2020-12-15T01:35:58Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/421", "timeline": [{"oid": "cf9264c16c8bb9b9bbe7ce8349c180357a5bd414", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/cf9264c16c8bb9b9bbe7ce8349c180357a5bd414", "message": "PDE POC", "committedDate": "2020-11-09T00:33:33Z", "type": "commit"}, {"oid": "2ae4ff01375fb1843204c4b704f7512c09b31290", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/2ae4ff01375fb1843204c4b704f7512c09b31290", "message": "PDE POC", "committedDate": "2020-11-09T00:49:04Z", "type": "commit"}, {"oid": "6b6a5031598b7ea59732ef74acdcf3c42aa28b9b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/6b6a5031598b7ea59732ef74acdcf3c42aa28b9b", "message": "V2 EOB POC Capabaility", "committedDate": "2020-11-09T01:43:23Z", "type": "commit"}, {"oid": "3dd9b0d578f503374c21609eea5114d0cf6316ba", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3dd9b0d578f503374c21609eea5114d0cf6316ba", "message": "CARIN-BB Code Systems and Value Sets", "committedDate": "2020-11-13T01:46:55Z", "type": "commit"}, {"oid": "2221a44406c097d4289d0af3c4906b0e456fe10c", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/2221a44406c097d4289d0af3c4906b0e456fe10c", "message": "CARIN-BB Code Systems and Value Sets", "committedDate": "2020-11-13T01:47:47Z", "type": "commit"}, {"oid": "7791923c44e8f726c840b1dba46c8eacb4351f2e", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/7791923c44e8f726c840b1dba46c8eacb4351f2e", "message": "C4BB and FHIR Claims Values Sets", "committedDate": "2020-11-13T04:17:52Z", "type": "commit"}, {"oid": "e3ae3eb6b1adfe3078f8dd1bd128efc9f1bde15d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e3ae3eb6b1adfe3078f8dd1bd128efc9f1bde15d", "message": "C4BB and FHIR Claims Values Sets", "committedDate": "2020-11-13T04:19:41Z", "type": "commit"}, {"oid": "53536abb379fe43ee4ca0a7bce6997656919c917", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/53536abb379fe43ee4ca0a7bce6997656919c917", "message": "Bug fix for CARIN V2 EOB Indentifier UC", "committedDate": "2020-11-13T21:30:52Z", "type": "commit"}, {"oid": "e3e1241eec5d1acd6d199e94a578be8286aa598b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e3e1241eec5d1acd6d199e94a578be8286aa598b", "message": "PDE POC Merge branch 'master' into dshekhar/BFD-351-v2_PDE_EOB_POC", "committedDate": "2020-11-13T23:14:29Z", "type": "commit"}, {"oid": "014bb8a0b430ae8e91420bdbd77ee16b5de0548e", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/014bb8a0b430ae8e91420bdbd77ee16b5de0548e", "message": "CARIN BB Adjudication Value Sets", "committedDate": "2020-11-18T18:15:59Z", "type": "commit"}, {"oid": "8bb6e0ad744e96c56472409c7e3462c53de4b629", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8bb6e0ad744e96c56472409c7e3462c53de4b629", "message": "JEssentials refactoring Merge branch 'master' into dshekhar/BFD-351-v2_PDE_EOB_POC", "committedDate": "2020-11-20T00:13:21Z", "type": "commit"}, {"oid": "f6a3ba01178084149817019c42a697908506d931", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f6a3ba01178084149817019c42a697908506d931", "message": "integrated with BFD Shared Utils", "committedDate": "2020-11-20T03:08:06Z", "type": "commit"}, {"oid": "076d3f04c846cc526d5467243ae208464395d41d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/076d3f04c846cc526d5467243ae208464395d41d", "message": "Merge branch 'master' into dshekhar/BFD-351-v2_PDE_EOB_POC", "committedDate": "2020-12-09T20:17:34Z", "type": "commit"}, {"oid": "3a12099bebdc506ac90e0f912013e29579b1135a", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3a12099bebdc506ac90e0f912013e29579b1135a", "message": "updating transformer constants comments and vars", "committedDate": "2020-12-31T01:19:45Z", "type": "commit"}, {"oid": "74beaab842329a56874f01af881cf1fbd4418258", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/74beaab842329a56874f01af881cf1fbd4418258", "message": "updating partd transformer identifier type", "committedDate": "2020-12-31T18:03:15Z", "type": "commit"}, {"oid": "0bac00c7edadfd2a8062e98ec0d1d1cfb318bebf", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0bac00c7edadfd2a8062e98ec0d1d1cfb318bebf", "message": "renaming CARIN vars", "committedDate": "2020-12-31T18:04:08Z", "type": "commit"}, {"oid": "cba6e2989b8c2791a57571639215e93aca04a861", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/cba6e2989b8c2791a57571639215e93aca04a861", "message": "adding serviceDate filter to V2", "committedDate": "2020-12-31T18:06:36Z", "type": "commit"}, {"oid": "e40536e97f5f1dae1451a8add93a824d2ad3e9c1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e40536e97f5f1dae1451a8add93a824d2ad3e9c1", "message": "adding claim type test for v2", "committedDate": "2020-12-31T18:37:41Z", "type": "commit"}, {"oid": "84397429ea23179b9c1005ef24232f0f9e345ac8", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/84397429ea23179b9c1005ef24232f0f9e345ac8", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2020-12-31T18:52:30Z", "type": "commit"}, {"oid": "775964a7cb72c925f54fe2151d0c44f46aa00a3b", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/775964a7cb72c925f54fe2151d0c44f46aa00a3b", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2021-01-04T23:49:40Z", "type": "commit"}, {"oid": "eb3a94a9ba188524acf895516e85be33307bde7a", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/eb3a94a9ba188524acf895516e85be33307bde7a", "message": "typo in javadoc", "committedDate": "2021-01-05T00:20:48Z", "type": "commit"}, {"oid": "f0cf33d8984f45b769dfd186f37e6e70947852ac", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f0cf33d8984f45b769dfd186f37e6e70947852ac", "message": "fix typos and deprecated options", "committedDate": "2021-01-06T04:46:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyMDU3MA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/421#discussion_r557720570", "bodyText": "Arg constructor is deprecated. Use no args construct.\nref: https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-structures-r4/org/hl7/fhir/r4/hapi/rest/server/ServerCapabilityStatementProvider.html", "author": "jzulim", "createdAt": "2021-01-14T21:49:24Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/V2Server.java", "diffHunk": "@@ -66,7 +66,7 @@ private void configureServerInfoMetadata() {\n \n     // Lightly customize the capability provider to set publisher name.\n     ServerCapabilityStatementProvider capabilityStatementProvider =\n-        new ServerCapabilityStatementProvider(this);", "originalCommit": "f0cf33d8984f45b769dfd186f37e6e70947852ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyNDkwNA==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/421#discussion_r557724904", "bodyText": "Should be V2_EOB", "author": "jzulim", "createdAt": "2021-01-14T21:57:53Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/R4ExplanationOfBenefitResourceProvider.java", "diffHunk": "@@ -0,0 +1,491 @@\n+package gov.cms.bfd.server.war.r4.providers;\n+\n+import ca.uhn.fhir.model.api.annotation.Description;\n+import ca.uhn.fhir.model.primitive.IdDt;\n+import ca.uhn.fhir.rest.annotation.IdParam;\n+import ca.uhn.fhir.rest.annotation.OptionalParam;\n+import ca.uhn.fhir.rest.annotation.Read;\n+import ca.uhn.fhir.rest.annotation.RequiredParam;\n+import ca.uhn.fhir.rest.annotation.Search;\n+import ca.uhn.fhir.rest.api.server.RequestDetails;\n+import ca.uhn.fhir.rest.param.DateRangeParam;\n+import ca.uhn.fhir.rest.param.ParamPrefixEnum;\n+import ca.uhn.fhir.rest.param.ReferenceParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+import ca.uhn.fhir.rest.param.TokenOrListParam;\n+import ca.uhn.fhir.rest.param.TokenParam;\n+import ca.uhn.fhir.rest.server.IResourceProvider;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import com.codahale.metrics.MetricRegistry;\n+import com.codahale.metrics.Timer;\n+import com.newrelic.api.agent.Trace;\n+import gov.cms.bfd.model.rif.Beneficiary;\n+import gov.cms.bfd.server.war.Operation;\n+import gov.cms.bfd.server.war.commons.LoadedFilterManager;\n+import gov.cms.bfd.server.war.commons.OffsetLinkBuilder;\n+import gov.cms.bfd.server.war.commons.QueryUtils;\n+import gov.cms.bfd.server.war.commons.TransformerConstants;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Comparator;\n+import java.util.Date;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+import javax.inject.Inject;\n+import javax.persistence.EntityManager;\n+import javax.persistence.NoResultException;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.criteria.CriteriaBuilder;\n+import javax.persistence.criteria.CriteriaQuery;\n+import javax.persistence.criteria.Predicate;\n+import javax.persistence.criteria.Root;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.r4.model.Bundle;\n+import org.hl7.fhir.r4.model.ExplanationOfBenefit;\n+import org.hl7.fhir.r4.model.IdType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This FHIR {@link IResourceProvider} adds support for R4 {@link ExplanationOfBenefit} resources,\n+ * derived from the CCW claims.\n+ */\n+@Component\n+public final class R4ExplanationOfBenefitResourceProvider implements IResourceProvider {\n+  private static final Logger LOGGER =\n+      LoggerFactory.getLogger(R4ExplanationOfBenefitResourceProvider.class);\n+\n+  /**\n+   * A {@link Pattern} that will match the {@link ExplanationOfBenefit#getId()}s used in this\n+   * application, e.g. <code>pde-1234</code> or <code>pde--1234</code> (for negative IDs).\n+   */\n+  private static final Pattern EOB_ID_PATTERN = Pattern.compile(\"(\\\\p{Alpha}+)-(-?\\\\p{Alnum}+)\");\n+\n+  private EntityManager entityManager;\n+  private MetricRegistry metricRegistry;\n+  private R4SamhsaMatcher samhsaMatcher;\n+  private LoadedFilterManager loadedFilterManager;\n+\n+  /** @param entityManager a JPA {@link EntityManager} connected to the application's database */\n+  @PersistenceContext\n+  public void setEntityManager(EntityManager entityManager) {\n+    this.entityManager = entityManager;\n+  }\n+\n+  /** @param metricRegistry the {@link MetricRegistry} to use */\n+  @Inject\n+  public void setMetricRegistry(MetricRegistry metricRegistry) {\n+    this.metricRegistry = metricRegistry;\n+  }\n+\n+  /** @param samhsaMatcher the {@link R4SamhsaMatcher} to use */\n+  @Inject\n+  public void setSamhsaFilterer(R4SamhsaMatcher samhsaMatcher) {\n+    this.samhsaMatcher = samhsaMatcher;\n+  }\n+\n+  /** @param loadedFilterManager the {@link LoadedFilterManager} to use */\n+  @Inject\n+  public void setLoadedFilterManager(LoadedFilterManager loadedFilterManager) {\n+    this.loadedFilterManager = loadedFilterManager;\n+  }\n+\n+  /** @see ca.uhn.fhir.rest.server.IResourceProvider#getResourceType() */\n+  @Override\n+  public Class<? extends IBaseResource> getResourceType() {\n+    return ExplanationOfBenefit.class;\n+  }\n+\n+  /**\n+   * Adds support for the FHIR \"read\" operation, for {@link ExplanationOfBenefit}s. The {@link Read}\n+   * annotation indicates that this method supports the read operation.\n+   *\n+   * <p>Read operations take a single parameter annotated with {@link IdParam}, and should return a\n+   * single resource instance.\n+   *\n+   * @param eobId The read operation takes one parameter, which must be of type {@link IdType} and\n+   *     must be annotated with the {@link IdParam} annotation.\n+   * @return Returns a resource matching the specified {@link IdDt}, or <code>null</code> if none\n+   *     exists.\n+   */\n+  @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+  @Read(version = false)\n+  @Trace\n+  public ExplanationOfBenefit read(@IdParam IdType eobId) {\n+    if (eobId == null) throw new IllegalArgumentException();\n+    if (eobId.getVersionIdPartAsLong() != null) throw new IllegalArgumentException();\n+\n+    String eobIdText = eobId.getIdPart();\n+    if (eobIdText == null || eobIdText.trim().isEmpty()) throw new IllegalArgumentException();\n+\n+    Matcher eobIdMatcher = EOB_ID_PATTERN.matcher(eobIdText);\n+    if (!eobIdMatcher.matches())\n+      throw new IllegalArgumentException(\"Unsupported ID pattern: \" + eobIdText);\n+\n+    String eobIdTypeText = eobIdMatcher.group(1);\n+    Optional<ClaimType> eobIdType = ClaimType.parse(eobIdTypeText);\n+    if (!eobIdType.isPresent()) throw new ResourceNotFoundException(eobId);\n+    String eobIdClaimIdText = eobIdMatcher.group(2);\n+\n+    Operation operation = new Operation(Operation.Endpoint.V1_EOB);", "originalCommit": "f0cf33d8984f45b769dfd186f37e6e70947852ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzczMzM2NQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/421#discussion_r557733365", "bodyText": "BFD", "author": "jzulim", "createdAt": "2021-01-14T22:15:28Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/ClaimType.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package gov.cms.bfd.server.war.r4.providers;\n+\n+import com.codahale.metrics.MetricRegistry;\n+import gov.cms.bfd.model.rif.Beneficiary;\n+import gov.cms.bfd.model.rif.PartDEvent;\n+import gov.cms.bfd.model.rif.PartDEvent_;\n+import java.time.LocalDate;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Optional;\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+import javax.persistence.Entity;\n+import javax.persistence.FetchType;\n+import javax.persistence.Id;\n+import javax.persistence.metamodel.PluralAttribute;\n+import javax.persistence.metamodel.SingularAttribute;\n+import org.hl7.fhir.r4.model.ExplanationOfBenefit;\n+\n+/**\n+ * Enumerates the various Blue Button claim types that are supported by {@link", "originalCommit": "f0cf33d8984f45b769dfd186f37e6e70947852ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc3MDgwNQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/421#discussion_r559770805", "bodyText": "@jarwilliams1971 Here's the PDE Mapping", "author": "jzulim", "createdAt": "2021-01-18T19:53:46Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/PartDEventTransformerV2.java", "diffHunk": "@@ -0,0 +1,406 @@\n+package gov.cms.bfd.server.war.r4.providers;\n+\n+import com.codahale.metrics.MetricRegistry;\n+import com.codahale.metrics.Timer;\n+import com.newrelic.api.agent.Trace;\n+import gov.cms.bfd.model.codebook.data.CcwCodebookVariable;\n+import gov.cms.bfd.model.rif.PartDEvent;\n+import gov.cms.bfd.model.rif.parse.InvalidRifValueException;\n+import gov.cms.bfd.server.war.commons.IdentifierType;\n+import gov.cms.bfd.server.war.commons.MedicareSegment;\n+import gov.cms.bfd.server.war.commons.TransformerConstants;\n+import gov.cms.bfd.sharedutils.exceptions.BadCodeMonkeyException;\n+import java.math.BigDecimal;\n+import java.util.Optional;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.DateType;\n+import org.hl7.fhir.r4.model.ExplanationOfBenefit;\n+import org.hl7.fhir.r4.model.ExplanationOfBenefit.ItemComponent;\n+import org.hl7.fhir.r4.model.SimpleQuantity;\n+import org.hl7.fhir.r4.model.codesystems.ClaimCareteamrole;\n+import org.hl7.fhir.r4.model.codesystems.V3ActCode;\n+\n+/** Transforms CCW {@link PartDEvent} instances into FHIR {@link ExplanationOfBenefit} resources. */\n+final class PartDEventTransformerV2 {\n+  /**\n+   * @param metricRegistry the {@link MetricRegistry} to use\n+   * @param claim the CCW {@link PartDEvent} to transform\n+   * @return a FHIR {@link ExplanationOfBenefit} resource that represents the specified {@link\n+   *     PartDEvent}\n+   */\n+  @Trace\n+  static ExplanationOfBenefit transform(MetricRegistry metricRegistry, Object claim) {\n+    Timer.Context timer =\n+        metricRegistry\n+            .timer(MetricRegistry.name(PartDEventTransformerV2.class.getSimpleName(), \"transform\"))\n+            .time();\n+\n+    if (!(claim instanceof PartDEvent)) throw new BadCodeMonkeyException();\n+    ExplanationOfBenefit eob = transformClaim((PartDEvent) claim);\n+\n+    timer.stop();\n+    return eob;\n+  }\n+\n+  /**\n+   * @param claimGroup the CCW {@link PartDEvent} to transform", "originalCommit": "f0cf33d8984f45b769dfd186f37e6e70947852ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d53bd2ccc5fb9a8dced90896c901936105052fc8", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d53bd2ccc5fb9a8dced90896c901936105052fc8", "message": "comment clarity and typo fix", "committedDate": "2021-01-18T19:55:47Z", "type": "commit"}, {"oid": "779c3dbec3300afc337de520d93593e483c13a20", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/779c3dbec3300afc337de520d93593e483c13a20", "message": "Add missing bfd server war ops endpoint for EOB v2", "committedDate": "2021-01-18T23:06:13Z", "type": "commit"}, {"oid": "9e8f514435a69434719cb833afb08e70949c3636", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9e8f514435a69434719cb833afb08e70949c3636", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2021-01-20T19:51:35Z", "type": "commit"}, {"oid": "a50a792ecf2ca0d503518dce12bf459be3c61225", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a50a792ecf2ca0d503518dce12bf459be3c61225", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2021-01-26T01:22:16Z", "type": "commit"}, {"oid": "13e5f9a0f654493dda72227dfbba1696d81fae7e", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/13e5f9a0f654493dda72227dfbba1696d81fae7e", "message": "use newly renamed TAX identifier constant", "committedDate": "2021-01-26T01:27:56Z", "type": "commit"}, {"oid": "a6b04eacb253c3e83dcdc2ce3ad5e454d7f938aa", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a6b04eacb253c3e83dcdc2ce3ad5e454d7f938aa", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2021-01-27T23:27:48Z", "type": "commit"}, {"oid": "62fd484b6031fcd80fc7c9b390fbcfec775fc363", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/62fd484b6031fcd80fc7c9b390fbcfec775fc363", "message": "Merge branch 'master' into jzulim/BFD-351-v2-eob-pde", "committedDate": "2021-01-28T00:12:57Z", "type": "commit"}]}