{"pr_number": 228, "pr_title": "Fix latency issue when RIF files are being loaded. ", "pr_createdAt": "2020-02-23T16:01:03Z", "pr_url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228", "timeline": [{"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/00ca4365fd810192b33c0aefd37d629d2c80157d", "message": "Improve refreshFilters locking\n\n- Replace a lock for the entire refreshFilters call with one at the end.", "committedDate": "2020-02-23T15:56:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjc1Nw==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383016757", "bodyText": "This the mistake. The design calls for this function to not interfere with requests. By making the call synchronous, it locks the manger and requests have to wait.", "author": "RickHawesUSDS", "createdAt": "2020-02-23T16:04:19Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -204,10 +204,11 @@ public synchronized boolean isInBounds(DateRangeParam range) {\n    * call.\n    */\n   @Scheduled(fixedDelay = 1000, initialDelay = 2000)\n-  public synchronized void refreshFilters() {\n+  public void refreshFilters() {\n     /*", "originalCommit": "00ca4365fd810192b33c0aefd37d629d2c80157d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjgwNQ==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383016805", "bodyText": "Now, instead of setting the filters and other states during the method, the state is set once at the end.", "author": "RickHawesUSDS", "createdAt": "2020-02-23T16:05:11Z", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -232,26 +233,25 @@ public synchronized void refreshFilters() {\n             || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);\n           List<LoadedFile> loadedFiles = fetchLoadedFiles();\n-          this.filters = trimFilters(this.filters, loadedFiles);\n-          this.firstBatchCreated = currentFirstBatchUpdate;\n+          newFilters = trimFilters(newFilters, loadedFiles);\n         }\n \n-        // update the transaction time as well\n-        this.transactionTime = currentLastBatchCreated;\n+        set(newFilters, currentFirstBatchUpdate, currentFirstBatchUpdate);", "originalCommit": "00ca4365fd810192b33c0aefd37d629d2c80157d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxOTUxNg==", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383019516", "bodyText": "Shouldn't the third parameter passed into set be currentLastBatchCreated rather than currentFirstBatchUpdate or am I misunderstanding the workflow?", "author": "njdister", "createdAt": "2020-02-23T16:40:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjgwNQ=="}], "type": "inlineReview"}, {"oid": "888ce25ac89a0ffd3b0826dd32bd909806032fc3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/888ce25ac89a0ffd3b0826dd32bd909806032fc3", "message": "Fixed a mistake in setting state", "committedDate": "2020-02-23T16:51:36Z", "type": "commit"}]}