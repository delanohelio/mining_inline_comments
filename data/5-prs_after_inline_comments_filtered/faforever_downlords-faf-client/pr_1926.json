{"pr_number": 1926, "pr_title": "Allow to watch replays while in game option", "pr_createdAt": "2020-09-19T12:42:50Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/1926", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0NjM5Mw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r497546393", "bodyText": "Could a check to see if the game is running also be added to the updateGameIfNecessary function? This way it doesn't even try to download if another game is running saving the network cycles as I think currently it only errors out after download when it tries to move the files", "author": "Sheikah45", "createdAt": "2020-09-30T14:17:27Z", "path": "src/main/java/com/faforever/client/game/GameService.java", "diffHunk": "@@ -457,10 +473,14 @@ private void notifyCantPlayReplay(@Nullable Integer replayId, Throwable throwabl\n         .thenCompose(featuredModBean -> updateGameIfNecessary(featuredModBean, null, modVersions, simModUids))", "originalCommit": "840cf913c84eb0359a73502657462165a9754ccb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d36760250ee4ced823c18e1ba8c1d17d27aa6c77", "url": "https://github.com/FAForever/downlords-faf-client/commit/d36760250ee4ced823c18e1ba8c1d17d27aa6c77", "message": "Fix unit tests and error logic", "committedDate": "2020-11-06T23:49:36Z", "type": "forcePushed"}, {"oid": "c0194202aab3474ee7a76a6ae538d206cd190d12", "url": "https://github.com/FAForever/downlords-faf-client/commit/c0194202aab3474ee7a76a6ae538d206cd190d12", "message": "Allow to watch replays while in game option\n\nFixes #1898", "committedDate": "2020-11-07T00:06:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519184555", "bodyText": "please always pass on previous Exceptions\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new UnsupportedOperationException(\"Unable to patch Forged Alliance to the required version due to conflicting version running\");\n          \n          \n            \n                        throw new UnsupportedOperationException(\"Unable to patch Forged Alliance to the required version due to conflicting version running\", throwable);", "author": "1-alex98", "createdAt": "2020-11-07T14:46:13Z", "path": "src/main/java/com/faforever/client/patch/GameUpdaterImpl.java", "diffHunk": "@@ -99,6 +95,19 @@ public GameUpdater addFeaturedModUpdater(FeaturedModUpdater featuredModUpdater)\n             createFaPathLuaFile(initFile.getParent().getParent());\n             copyLegacyInitFile(initFile);\n           }\n+        })\n+        .exceptionally(throwable -> {\n+          boolean allowReplaysWhileInGame = preferencesService.getPreferences().getForgedAlliance().isAllowReplaysWhileInGame();\n+          if (throwable.getCause().getCause() instanceof AccessDeniedException && allowReplaysWhileInGame) {\n+            log.info(\"Unable to update file cause they are not writeable. \" +\n+                \"Experimental feature is turned on \" +\n+                \"that allows multiple game instances to run in parallel this is most likely the cause.\");\n+            throw new UnsupportedOperationException(\"Unable to patch Forged Alliance to the required version due to conflicting version running\");", "originalCommit": "2871df1bf59c2fa4656e8274c0c155d488779088", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDc0Mg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519184742", "bodyText": "also don't we want to display a meaningful Exception", "author": "1-alex98", "createdAt": "2020-11-07T14:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NzI1Ng==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519187256", "bodyText": "what do you mean? To the user? That is done in an exceptionally", "author": "Sheikah45", "createdAt": "2020-11-07T15:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMzU5OQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r520933599", "bodyText": "Have you ever seen\nRuntimeException at X \n   at ...\n   at ....\nCaused by RealException: the message you are really looking for\n   at ....\n\nThat happens if you pass on the causing Exception to a new on e thrown like here, what I suggested....", "author": "1-alex98", "createdAt": "2020-11-10T23:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMzg3OA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r520933878", "bodyText": "https://www.baeldung.com/java-wrapping-vs-rethrowing-exceptions", "author": "1-alex98", "createdAt": "2020-11-10T23:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNDgyNA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r520934824", "bodyText": "What if there is an unexpected Exception it is never logged we will never know what throwable really contained", "author": "1-alex98", "createdAt": "2020-11-10T23:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDY3NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r520940674", "bodyText": "ah yeah got it just misunderstood", "author": "Sheikah45", "createdAt": "2020-11-10T23:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDc4MA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519184780", "bodyText": "this solves the issues with the game not terminating correctly... just so u understand.", "author": "1-alex98", "createdAt": "2020-11-07T14:48:35Z", "path": "src/main/java/com/faforever/client/patch/GameBinariesUpdateTaskImpl.java", "diffHunk": "@@ -133,7 +133,11 @@ void copyGameFilesToFafBinDirectory() throws IOException {\n \n             logger.debug(\"Copying file '{}' to '{}'\", source, destination);\n             noCatch(() -> createDirectories(destination.getParent()));\n-            noCatch(() -> copy(source, destination, REPLACE_EXISTING));\n+            noCatch(() -> {\n+              if (!Files.exists(destination)) {\n+                copy(source, destination, REPLACE_EXISTING);\n+              }", "originalCommit": "2871df1bf59c2fa4656e8274c0c155d488779088", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4Njk4Mg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519186982", "bodyText": "got it", "author": "Sheikah45", "createdAt": "2020-11-07T15:12:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NDg5Mg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519184892", "bodyText": "This message is not really up to date anymore. it could really be anything that caused it but the game not terminating correctly should not be an issue anymore", "author": "1-alex98", "createdAt": "2020-11-07T14:49:50Z", "path": "src/main/java/com/faforever/client/patch/GameUpdaterImpl.java", "diffHunk": "@@ -99,6 +95,19 @@ public GameUpdater addFeaturedModUpdater(FeaturedModUpdater featuredModUpdater)\n             createFaPathLuaFile(initFile.getParent().getParent());\n             copyLegacyInitFile(initFile);\n           }\n+        })\n+        .exceptionally(throwable -> {\n+          boolean allowReplaysWhileInGame = preferencesService.getPreferences().getForgedAlliance().isAllowReplaysWhileInGame();\n+          if (throwable.getCause().getCause() instanceof AccessDeniedException && allowReplaysWhileInGame) {\n+            log.info(\"Unable to update file cause they are not writeable. \" +\n+                \"Experimental feature is turned on \" +\n+                \"that allows multiple game instances to run in parallel this is most likely the cause.\");\n+            throw new UnsupportedOperationException(\"Unable to patch Forged Alliance to the required version due to conflicting version running\");\n+          } else if (!(allowReplaysWhileInGame && version != null)) {\n+            log.warn(\"Game not terminated correctly\", throwable);\n+            notificationService.addImmediateErrorNotification(throwable, \"error.game.notTerminatedCorrectly\");", "originalCommit": "2871df1bf59c2fa4656e8274c0c155d488779088", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NTA1Ng==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519185056", "bodyText": "also log the Exception (always)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.warn(\"Failed evaluating if game.prefs file is patched for multiple instances.\");\n          \n          \n            \n                  log.warn(\"Failed evaluating if game.prefs file is patched for multiple instances.\", e);", "author": "1-alex98", "createdAt": "2020-11-07T14:51:14Z", "path": "src/main/java/com/faforever/client/preferences/ui/SettingsController.java", "diffHunk": "@@ -356,6 +365,17 @@ private void initNotifyMeOnAtMention() {\n     notifyAtMentionDescription.setText(i18n.get(\"settings.chat.notifyOnAtMentionOnly.description\", \"@\" + username));\n   }\n \n+  private void initAllowReplaysWhileInGame(Preferences preferences) {\n+    JavaFxUtil.bindBidirectional(allowReplayWhileInGameCheckBox.selectedProperty(), preferences.getForgedAlliance().allowReplaysWhileInGameProperty());\n+    try {\n+      gameService.isGamePrefsPatchedToAllowMultiInstances()\n+          .thenAccept(isPatched -> allowReplayWhileInGameButton.setDisable(isPatched));\n+    } catch (IOException e) {\n+      log.warn(\"Failed evaluating if game.prefs file is patched for multiple instances.\");", "originalCommit": "2871df1bf59c2fa4656e8274c0c155d488779088", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NTA5NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1926#discussion_r519185094", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      .thenRun(() -> Platform.runLater(() -> allowReplayWhileInGameButton.setDisable(true))).exceptionally(throwable -> {\n          \n          \n            \n                      .thenRun(() -> Platform.runLater(() -> allowReplayWhileInGameButton.setDisable(true)))\n          \n          \n            \n                      .exceptionally(throwable -> {", "author": "1-alex98", "createdAt": "2020-11-07T14:51:46Z", "path": "src/main/java/com/faforever/client/preferences/ui/SettingsController.java", "diffHunk": "@@ -595,5 +615,19 @@ public void onAddAutoChannel() {\n     preferencesService.storeInBackground();\n     channelTextField.clear();\n   }\n+\n+  public void onPatchGamePrefsForMultipleInstances() {\n+    try {\n+      gameService.patchGamePrefsForMultiInstances()\n+          .thenRun(() -> Platform.runLater(() -> allowReplayWhileInGameButton.setDisable(true))).exceptionally(throwable -> {", "originalCommit": "2871df1bf59c2fa4656e8274c0c155d488779088", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "484952be296bdf43fd12d80b1c0dfe79a11c2cd7", "url": "https://github.com/FAForever/downlords-faf-client/commit/484952be296bdf43fd12d80b1c0dfe79a11c2cd7", "message": "update unit test", "committedDate": "2020-11-10T00:26:26Z", "type": "forcePushed"}, {"oid": "ac07a07a83c7675b1fc612e82a9008701ee88fc7", "url": "https://github.com/FAForever/downlords-faf-client/commit/ac07a07a83c7675b1fc612e82a9008701ee88fc7", "message": "Allow to watch replays while in game option\n\nFixes #1898", "committedDate": "2020-11-12T12:57:27Z", "type": "commit"}, {"oid": "7138c869b38a129136ebf316af28abbee95b801a", "url": "https://github.com/FAForever/downlords-faf-client/commit/7138c869b38a129136ebf316af28abbee95b801a", "message": "Mock forgedAlliancePrefs in test", "committedDate": "2020-11-12T13:44:15Z", "type": "commit"}, {"oid": "7f2c50ddfa27fbebee54e7b855ce80f929a8d78c", "url": "https://github.com/FAForever/downlords-faf-client/commit/7f2c50ddfa27fbebee54e7b855ce80f929a8d78c", "message": "Only alert if experimental feature not on.", "committedDate": "2020-11-12T13:44:57Z", "type": "commit"}, {"oid": "7f2c50ddfa27fbebee54e7b855ce80f929a8d78c", "url": "https://github.com/FAForever/downlords-faf-client/commit/7f2c50ddfa27fbebee54e7b855ce80f929a8d78c", "message": "Only alert if experimental feature not on.", "committedDate": "2020-11-12T13:44:57Z", "type": "forcePushed"}, {"oid": "c280e9b29697b0b99f6e4ebde029c1c18a726fb5", "url": "https://github.com/FAForever/downlords-faf-client/commit/c280e9b29697b0b99f6e4ebde029c1c18a726fb5", "message": "Ensure create game button disabled if replay playing", "committedDate": "2020-11-12T14:03:14Z", "type": "commit"}, {"oid": "61db7bbdc9adf59256765a698574ce6495268ab5", "url": "https://github.com/FAForever/downlords-faf-client/commit/61db7bbdc9adf59256765a698574ce6495268ab5", "message": "Log patching fail error", "committedDate": "2020-11-12T14:10:27Z", "type": "commit"}, {"oid": "500c29efbc640fbd811dcf6497762e481705b50c", "url": "https://github.com/FAForever/downlords-faf-client/commit/500c29efbc640fbd811dcf6497762e481705b50c", "message": "Fix formatting", "committedDate": "2020-11-12T14:12:03Z", "type": "commit"}, {"oid": "08e34c0feb562785eafadd700b8057295f04fad0", "url": "https://github.com/FAForever/downlords-faf-client/commit/08e34c0feb562785eafadd700b8057295f04fad0", "message": "Mock startReplay", "committedDate": "2020-11-12T23:23:47Z", "type": "commit"}, {"oid": "488999aa7e22b412d5703c81c6cb8ef3d280c1f4", "url": "https://github.com/FAForever/downlords-faf-client/commit/488999aa7e22b412d5703c81c6cb8ef3d280c1f4", "message": "Use matcher for verify", "committedDate": "2020-11-13T02:13:39Z", "type": "commit"}, {"oid": "2f6dd8b4879fedfa91d74406098195cc3380dc95", "url": "https://github.com/FAForever/downlords-faf-client/commit/2f6dd8b4879fedfa91d74406098195cc3380dc95", "message": "Use completable future for run with replay", "committedDate": "2020-11-13T03:39:18Z", "type": "commit"}, {"oid": "f81c3a35c6af4fa378251656690e6d479ac837b6", "url": "https://github.com/FAForever/downlords-faf-client/commit/f81c3a35c6af4fa378251656690e6d479ac837b6", "message": "Stop Ladder search on start replay", "committedDate": "2020-11-13T13:14:33Z", "type": "commit"}, {"oid": "46dcae9343508fece84d47a579f9ec3bb5d9664b", "url": "https://github.com/FAForever/downlords-faf-client/commit/46dcae9343508fece84d47a579f9ec3bb5d9664b", "message": "Add warning on start ladder search", "committedDate": "2020-11-13T13:47:13Z", "type": "commit"}]}