{"pr_number": 1808, "pr_title": "Feature/#1764 online replays pagination", "pr_createdAt": "2020-07-02T10:27:51Z", "pr_url": "https://github.com/FAForever/downlords-faf-client/pull/1808", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwNjE0MQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r448906141", "bodyText": "Either it needs a platform run later in both lines or it needs none", "author": "1-alex98", "createdAt": "2020-07-02T10:29:59Z", "path": "src/main/java/com/faforever/client/replay/OnlineReplayVaultController.java", "diffHunk": "@@ -226,12 +235,39 @@ private void enterResultState() {\n     searchResultGroup.setVisible(false);\n     loadingPane.setVisible(false);\n     backButton.setVisible(false);\n-    moreButton.setVisible(false);\n+    pagination.setVisible(false);\n   }\n \n   private void onSearch(SearchConfig searchConfig) {\n+    replaySearchType = ReplaySearchType.SEARCH;\n+    //FIXME pagination setcount geh\u00f6rt hier nicht hin\n+    Platform.runLater(() -> pagination.setPageCount(0));\n+    if (pagination.getCurrentPageIndex() != 0) {\n+      pagination.setCurrentPageIndex(0);", "originalCommit": "c1aa8d5507ada37f2afa3c261975429e5a422d16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwNzMwOQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r448907309", "bodyText": "Code duplication", "author": "1-alex98", "createdAt": "2020-07-02T10:32:22Z", "path": "src/main/java/com/faforever/client/replay/OnlineReplayVaultController.java", "diffHunk": "@@ -264,13 +300,21 @@ private void loadPreselectedReplays() {\n   }\n \n   public void onMoreNewestButtonClicked() {\n-    enterSearchingState();\n-    displayReplaysFromSupplier(() -> replayService.getNewestReplays(TOP_MORE_ELEMENT_COUNT, currentPage++));\n+    replaySearchType = ReplaySearchType.NEWEST;\n+    if (pagination.getCurrentPageIndex() != 0) {\n+      pagination.setCurrentPageIndex(0);\n+    } else {", "originalCommit": "c1aa8d5507ada37f2afa3c261975429e5a422d16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwNzc1NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r448907754", "bodyText": "final and END_TIME_QUERY", "author": "1-alex98", "createdAt": "2020-07-02T10:33:16Z", "path": "src/main/java/com/faforever/client/vault/search/SearchController.java", "diffHunk": "@@ -66,6 +70,8 @@\n    * Type of the searchable entity.\n    */\n   private Class<?> rootType;\n+  private static String endTimeQueryStart = \"endTime=ge=\";", "originalCommit": "c1aa8d5507ada37f2afa3c261975429e5a422d16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwOTA5NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r448909094", "bodyText": "String.format", "author": "1-alex98", "createdAt": "2020-07-02T10:35:49Z", "path": "src/main/java/com/faforever/client/vault/search/SearchController.java", "diffHunk": "@@ -223,7 +243,16 @@ private String buildQuery(SpecificationController initialSpecification, List<Log\n       }\n       condition = currentCondition;\n     }\n-    return (String) condition.get().query(new RSQLVisitor());\n+    String queryWithoutLastYear = (String) condition.get().query(new RSQLVisitor());\n+    return queryWithoutLastYear + \";\" + lastYearQuery;", "originalCommit": "c1aa8d5507ada37f2afa3c261975429e5a422d16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODkwOTU4MA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r448909580", "bodyText": "OffsetDatetime LcoalDtaeTinme Instant", "author": "1-alex98", "createdAt": "2020-07-02T10:36:48Z", "path": "src/main/java/com/faforever/client/vault/search/SearchController.java", "diffHunk": "@@ -223,7 +243,16 @@ private String buildQuery(SpecificationController initialSpecification, List<Log\n       }\n       condition = currentCondition;\n     }\n-    return (String) condition.get().query(new RSQLVisitor());\n+    String queryWithoutLastYear = (String) condition.get().query(new RSQLVisitor());\n+    return queryWithoutLastYear + \";\" + lastYearQuery;\n+  }\n+\n+  private String generateOnlyLastYearQuery() {\n+    Calendar calendar = Calendar.getInstance();\n+    calendar.add(Calendar.YEAR, -1);\n+    Date date = calendar.getTime();\n+    SimpleDateFormat dateFormater = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss'Z'\");", "originalCommit": "c1aa8d5507ada37f2afa3c261975429e5a422d16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDEwMg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r450674102", "bodyText": "did i not push this to develop... in that case you should merge develop in or rebase", "author": "1-alex98", "createdAt": "2020-07-07T07:49:34Z", "path": "src/main/java/com/faforever/client/api/JsonApiMessageConverter.java", "diffHunk": "@@ -28,17 +28,19 @@ public JsonApiMessageConverter(ResourceConverter resourceConverter) {\n   @Override\n   protected boolean supports(Class<?> clazz) {\n     return Collection.class.isAssignableFrom(clazz)\n-        || ReflectionUtils.getTypeName(clazz) != null;\n+        || ReflectionUtils.getTypeName(clazz) != null\n+        || clazz.equals(JSONAPIDocument.class);\n   }\n \n   @Override\n   @SneakyThrows\n-  @SuppressWarnings(\"unchecked\")\n   protected Object readInternal(Class<?> clazz, HttpInputMessage inputMessage) {\n     try (InputStream inputStream = inputMessage.getBody()) {\n       JSONAPIDocument<?> document;\n       if (Iterable.class.isAssignableFrom(clazz)) {\n         document = resourceConverter.readDocumentCollection(inputStream, Object.class);\n+      } else if (clazz.equals(JSONAPIDocument.class)) {\n+        return resourceConverter.readDocumentCollection(inputStream, Object.class);", "originalCommit": "927222a7c1379d885cdc77b44ecf17e8066d791a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcwMTU2Nw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r452701567", "bodyText": "WithMetadata", "author": "1-alex98", "createdAt": "2020-07-10T08:30:54Z", "path": "src/main/java/com/faforever/client/api/FafApiAccessorImpl.java", "diffHunk": "@@ -311,33 +308,37 @@ public ModVersion getModVersion(String uid) {\n   }\n \n   @Override\n-  public List<Game> getNewestReplays(int count, int page) {\n-    return getPage(\"/data/game\", count, page, ImmutableMap.of(\n+  public Tuple<List<Game>, java.util.Map<String, ?>> getNewestReplays(int count, int page) {", "originalCommit": "e7c3cb71bc8da70bee234c834cfdb1dc8c85fac3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcwMTY0OA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r452701648", "bodyText": "WithMetadata", "author": "1-alex98", "createdAt": "2020-07-10T08:31:04Z", "path": "src/main/java/com/faforever/client/api/FafApiAccessorImpl.java", "diffHunk": "@@ -311,33 +308,37 @@ public ModVersion getModVersion(String uid) {\n   }\n \n   @Override\n-  public List<Game> getNewestReplays(int count, int page) {\n-    return getPage(\"/data/game\", count, page, ImmutableMap.of(\n+  public Tuple<List<Game>, java.util.Map<String, ?>> getNewestReplays(int count, int page) {\n+    JSONAPIDocument<List<Game>> jsonApiDoc = getPageWithMeta(\"/data/game\", count, page, ImmutableMap.of(\n         \"sort\", \"-endTime\",\n         \"include\", REPLAY_INCLUDES,\n         \"filter\", \"endTime=isnull=false\"\n     ));\n+    return new Tuple<>(jsonApiDoc.get(), jsonApiDoc.getMeta());\n   }\n \n   @Override\n-  public List<Game> getHighestRatedReplays(int count, int page) {\n-    return this.<GameReviewsSummary>getPage(\"/data/gameReviewsSummary\", count, page, ImmutableMap.of(\n+  public Tuple<List<Game>, java.util.Map<String, ?>> getHighestRatedReplays(int count, int page) {", "originalCommit": "e7c3cb71bc8da70bee234c834cfdb1dc8c85fac3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcwNjE2Nw==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r452706167", "bodyText": "These changes dont belong here", "author": "1-alex98", "createdAt": "2020-07-10T08:40:02Z", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +237,10 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    Matcher matcher = invalidCharacters.matcher(mapPath);\n+    if (matcher.find()) {\n+      throw new IllegalArgumentException(\"Map Name Contains Invalid Characters\");\n+    }", "originalCommit": "e7c3cb71bc8da70bee234c834cfdb1dc8c85fac3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4ODcxNQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r452988715", "bodyText": "Is that really not needed? Are u sure? Is is to suppress warning about missing type safety.", "author": "1-alex98", "createdAt": "2020-07-10T17:53:00Z", "path": "src/main/java/com/faforever/client/api/FafApiAccessorImpl.java", "diffHunk": "@@ -192,7 +189,6 @@ public AchievementDefinition getAchievementDefinition(String achievementId) {\n   @Override\n   @Cacheable(CacheNames.LADDER_1V1_LEADERBOARD)\n   @SneakyThrows\n-  @SuppressWarnings(\"unchecked\")", "originalCommit": "26e929ba01355c1bb6c2af3d321a9c3418f83ddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzNDU1NA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r453334554", "bodyText": "It is marked as redundant by IntelliJ", "author": "IAmAlife", "createdAt": "2020-07-12T16:07:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4ODcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4OTk5MA==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r452989990", "bodyText": "How about u get the total page count in the replay service already u dont need the complete metadata anyway right?", "author": "1-alex98", "createdAt": "2020-07-10T17:55:32Z", "path": "src/main/java/com/faforever/client/replay/OnlineReplayVaultController.java", "diffHunk": "@@ -226,36 +244,66 @@ private void enterResultState() {\n     searchResultGroup.setVisible(false);\n     loadingPane.setVisible(false);\n     backButton.setVisible(false);\n-    moreButton.setVisible(false);\n+    pagination.setVisible(false);\n+    firstPageButton.setVisible(false);\n+    lastPageButton.setVisible(false);\n   }\n \n   private void onSearch(SearchConfig searchConfig) {\n+    replaySearchType = ReplaySearchType.SEARCH;\n+    onFirstPageOpened(searchConfig);\n+  }\n+\n+  private void onPageChange(SearchConfig searchConfig, int page, boolean firstLoad) {\n     enterSearchingState();\n-    displayReplaysFromSupplier(() -> replayService.findByQuery(searchConfig.getSearchQuery(), MAX_SEARCH_RESULTS, currentPage++, searchConfig.getSortConfig()));\n+    switch (replaySearchType) {\n+      case SEARCH:\n+        displayReplaysFromSupplier(() -> replayService.findByQueryWithMeta(searchConfig.getSearchQuery(), PAGE_SIZE, page, searchConfig.getSortConfig()), firstLoad);\n+        break;\n+      case OWN:\n+        displayReplaysFromSupplier(() -> replayService.getOwnReplaysWithMeta(PAGE_SIZE, page), firstLoad);\n+        break;\n+      case NEWEST:\n+        displayReplaysFromSupplier(() -> replayService.getNewestReplaysWithMeta(PAGE_SIZE, page), firstLoad);\n+        break;\n+      case HIGHEST_RATED:\n+        displayReplaysFromSupplier(() -> replayService.getHighestRatedReplaysWithMeta(PAGE_SIZE, page), firstLoad);\n+        break;\n+      case PLAYER:\n+        displayReplaysFromSupplier(() -> replayService.getReplaysForPlayerWithMeta(playerId, PAGE_SIZE, page, new SortConfig(\"startTime\", SortOrder.DESC)), firstLoad);\n+        break;\n+    }\n+  }\n+\n+  private void onFirstPageOpened(SearchConfig searchConfig) {\n+    onPageChange(searchConfig, 1, true);\n+    if (pagination.getCurrentPageIndex() != 0) {\n+      pagination.setCurrentPageIndex(0);\n+    }\n   }\n \n   private void displaySearchResult(List<Replay> replays) {\n     displaySearchResult(replays, false);\n   }\n \n   public void onBackButtonClicked() {\n-    if (newestReplaysLoaded) {\n-      enterResultState();\n-    } else {\n-      loadPreselectedReplays();\n-    }\n+    loadPreselectedReplays();\n   }\n \n   public void onRefreshButtonClicked() {\n-    loadPreselectedReplays();\n+    if (pagination.isVisible()) {\n+      onPageChange(searchController.getLastSearchConfig(), pagination.currentPageIndexProperty().getValue() + 1, false);\n+    } else {\n+      loadPreselectedReplays();\n+    }\n   }\n \n   private void loadPreselectedReplays() {\n     enterSearchingState();\n-    replayService.getNewestReplays(TOP_ELEMENT_COUNT, 1)\n-        .thenAccept(replays -> populateReplays(replays, newestPane))\n-        .thenCompose(aVoid -> replayService.getHighestRatedReplays(TOP_ELEMENT_COUNT, 1).thenAccept(highestRatedReplays -> populateReplays(highestRatedReplays, highestRatedPane)))\n-        .thenCompose(aVoid -> replayService.getOwnReplays(TOP_ELEMENT_COUNT, 1).thenAccept(highestRatedReplays -> populateReplays(highestRatedReplays, ownReplaysPane)))\n+    replayService.getNewestReplaysWithMeta(TOP_ELEMENT_COUNT, 1)", "originalCommit": "26e929ba01355c1bb6c2af3d321a9c3418f83ddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzNjEyNg==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r453336126", "bodyText": "We decided against that, as we would still need to carry a tuple as far as we are doing since the pagination gets set in the controller.\nThis also opens up the possibility to use more of the metadata than just the page amount", "author": "Tarmandan", "createdAt": "2020-07-12T16:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4OTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY1ODMyNQ==", "url": "https://github.com/FAForever/downlords-faf-client/pull/1808#discussion_r456658325", "bodyText": "There is never gonna be any other metadata than page counts", "author": "1-alex98", "createdAt": "2020-07-17T20:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4OTk5MA=="}], "type": "inlineReview"}, {"oid": "f7fcdb5ef3cfa66ffa74fa4a0de84452f8510bd2", "url": "https://github.com/FAForever/downlords-faf-client/commit/f7fcdb5ef3cfa66ffa74fa4a0de84452f8510bd2", "message": "Fixed weird behaviour when setting pagecount", "committedDate": "2020-07-12T15:46:19Z", "type": "forcePushed"}, {"oid": "78c22d3898adbdf49c4069844ae88a5a3b602a62", "url": "https://github.com/FAForever/downlords-faf-client/commit/78c22d3898adbdf49c4069844ae88a5a3b602a62", "message": "Pagination Online Replay Vault\n\nFixes #1764", "committedDate": "2020-07-14T20:21:42Z", "type": "forcePushed"}, {"oid": "0ec84abc99d184f3aaaa8c73493a0a2ae53a4552", "url": "https://github.com/FAForever/downlords-faf-client/commit/0ec84abc99d184f3aaaa8c73493a0a2ae53a4552", "message": "Pagination Online Replay Vault\n\nFixes #1764\n\nCo-Authored-By: tarmandan <58087411+tarmandan@users.noreply.github.com>\nCo-Authored-By: aclrian <32142988+aclrian@users.noreply.github.com>\nCo-Authored-By: Jia Hong Frenki Zhang <64331094+frezha@users.noreply.github.com>", "committedDate": "2020-07-15T15:34:41Z", "type": "forcePushed"}, {"oid": "c567d6fb97a8eb1fd108bb2484eb01082be28902", "url": "https://github.com/FAForever/downlords-faf-client/commit/c567d6fb97a8eb1fd108bb2484eb01082be28902", "message": "Pagination Online Replay Vault\n\nFixes #1764\n\nCo-Authored-By: tarmandan <58087411+tarmandan@users.noreply.github.com>\nCo-Authored-By: aclrian <32142988+aclrian@users.noreply.github.com>\nCo-Authored-By: Jia Hong Frenki Zhang <64331094+frezha@users.noreply.github.com>", "committedDate": "2020-07-22T09:34:58Z", "type": "forcePushed"}, {"oid": "7b48f74b1f019224acefc7d11b6b20a82ed75524", "url": "https://github.com/FAForever/downlords-faf-client/commit/7b48f74b1f019224acefc7d11b6b20a82ed75524", "message": "Pagination Online Replay Vault\n\nFixes #1764\n\nCo-Authored-By: tarmandan <58087411+tarmandan@users.noreply.github.com>\nCo-Authored-By: aclrian <32142988+aclrian@users.noreply.github.com>\nCo-Authored-By: Jia Hong Frenki Zhang <64331094+frezha@users.noreply.github.com>", "committedDate": "2020-07-25T19:46:11Z", "type": "commit"}, {"oid": "8db2ad546003338262ff5eb9875fd6d1fd67b92c", "url": "https://github.com/FAForever/downlords-faf-client/commit/8db2ad546003338262ff5eb9875fd6d1fd67b92c", "message": "replace Metadata with PageCount", "committedDate": "2020-07-25T19:46:11Z", "type": "commit"}, {"oid": "1cd002229ca5763a398491837e191cba24d2fdcf", "url": "https://github.com/FAForever/downlords-faf-client/commit/1cd002229ca5763a398491837e191cba24d2fdcf", "message": "Refactor", "committedDate": "2020-07-25T21:01:22Z", "type": "commit"}, {"oid": "1cd002229ca5763a398491837e191cba24d2fdcf", "url": "https://github.com/FAForever/downlords-faf-client/commit/1cd002229ca5763a398491837e191cba24d2fdcf", "message": "Refactor", "committedDate": "2020-07-25T21:01:22Z", "type": "forcePushed"}]}