{"pr_number": 531, "pr_title": "Filter upgrades to support kw params", "pr_createdAt": "2020-11-12T13:18:42Z", "pr_url": "https://github.com/HubSpot/jinjava/pull/531", "timeline": [{"oid": "eab8cb4175d62090cc30ff96ac96885d8f683768", "url": "https://github.com/HubSpot/jinjava/commit/eab8cb4175d62090cc30ff96ac96885d8f683768", "message": "AbstractFilter: handle Number=> Any numeric conversion without string. Null parameter value is treated as missing", "committedDate": "2020-11-12T10:26:11Z", "type": "commit"}, {"oid": "279c03587da25f706ec89c45cf754fa320092849", "url": "https://github.com/HubSpot/jinjava/commit/279c03587da25f706ec89c45cf754fa320092849", "message": "regex_replace, replace, round, truncatehtml, urlize filters migrated to AbstractFilter", "committedDate": "2020-11-12T10:32:48Z", "type": "commit"}, {"oid": "a571c8a631eee97026738842029e055ba61c448d", "url": "https://github.com/HubSpot/jinjava/commit/a571c8a631eee97026738842029e055ba61c448d", "message": "join, slice, sort, split, sum filter migrated to AbstractFilter.\njoin filter: `attr` renamed to `attribute` matching unit test", "committedDate": "2020-11-12T11:22:58Z", "type": "commit"}, {"oid": "e5b850bf91634ad6eda9ae9f4b53b9c4069d57ce", "url": "https://github.com/HubSpot/jinjava/commit/e5b850bf91634ad6eda9ae9f4b53b9c4069d57ce", "message": "datetimeformat, truncate: upgrade to abstract.\ndatetimeformat: fix function jinjavadoc and param defaults", "committedDate": "2020-11-12T13:09:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NDYxNg==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r522484616", "bodyText": "Must all of these be null?", "author": "boulter", "createdAt": "2020-11-12T22:53:12Z", "path": "src/main/java/com/hubspot/jinjava/lib/filter/DateTimeFormatFilter.java", "diffHunk": "@@ -40,19 +41,29 @@\n     )\n   }\n )\n-public class DateTimeFormatFilter implements Filter {\n+public class DateTimeFormatFilter extends AbstractFilter implements Filter {\n+  public static final String FORMAT_PARAM = \"format\";\n+  public static final String TIMEZONE_PARAM = \"timezone\";\n+  public static final String LOCALE_PARAM = \"locale\";\n \n   @Override\n   public String getName() {\n     return \"datetimeformat\";\n   }\n \n   @Override\n-  public Object filter(Object var, JinjavaInterpreter interpreter, String... args) {\n-    if (args.length > 0) {\n-      return Functions.dateTimeFormat(var, args);\n-    } else {\n+  public Object filter(\n+    Object var,\n+    JinjavaInterpreter interpreter,\n+    Map<String, Object> parsedArgs\n+  ) {\n+    String format = (String) parsedArgs.get(FORMAT_PARAM);\n+    String timezone = (String) parsedArgs.get(TIMEZONE_PARAM);\n+    String locale = (String) parsedArgs.get(LOCALE_PARAM);\n+    if (format == null && timezone == null && locale == null) {", "originalCommit": "e5b850bf91634ad6eda9ae9f4b53b9c4069d57ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwMTQ1MA==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r522501450", "bodyText": "I could probably fix up the Functions code, but currently it errors out on zone being null. Let me know if you are happy for me to change it", "author": "michaelpro1", "createdAt": "2020-11-12T23:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4OTkwNA==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r522489904", "bodyText": "I really appreciate the static constants!", "author": "boulter", "createdAt": "2020-11-12T23:01:22Z", "path": "src/main/java/com/hubspot/jinjava/lib/filter/DateTimeFormatFilter.java", "diffHunk": "@@ -40,19 +41,29 @@\n     )\n   }\n )\n-public class DateTimeFormatFilter implements Filter {\n+public class DateTimeFormatFilter extends AbstractFilter implements Filter {\n+  public static final String FORMAT_PARAM = \"format\";", "originalCommit": "e5b850bf91634ad6eda9ae9f4b53b9c4069d57ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5MTgwNQ==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r522491805", "bodyText": "wow, this removes a lot of code! Can you ensure that this is still covered in the unit tests?", "author": "boulter", "createdAt": "2020-11-12T23:06:18Z", "path": "src/main/java/com/hubspot/jinjava/lib/filter/TruncateHtmlFilter.java", "diffHunk": "@@ -64,87 +57,21 @@ public String getName() {\n   public Object filter(\n     Object var,\n     JinjavaInterpreter interpreter,\n-    Object[] args,\n-    Map<String, Object> kwargs\n+    Map<String, Object> parsedArgs\n   ) {\n-    String length = null;\n-    if (kwargs.containsKey(LENGTH_KEY)) {\n-      length = Objects.toString(kwargs.get(LENGTH_KEY));\n-    }\n-    String end = null;\n-    if (kwargs.containsKey(END_KEY)) {\n-      end = Objects.toString(kwargs.get(END_KEY));\n-    }\n-    String breakword = null;\n-    if (kwargs.containsKey(BREAKWORD_KEY)) {\n-      breakword = Objects.toString(kwargs.get(BREAKWORD_KEY));\n-    }\n-\n-    String[] newArgs = new String[3];\n-    for (int i = 0; i < args.length; i++) {\n-      if (i >= newArgs.length) {\n-        break;\n-      }\n-      newArgs[i] = Objects.toString(args[i]);\n-    }\n-\n-    if (length != null) {\n-      newArgs[0] = length;\n-    }\n-    if (end != null) {\n-      newArgs[1] = end;\n-    }\n-    if (breakword != null) {\n-      newArgs[2] = breakword;\n-    }\n-\n-    if (var instanceof SafeString) {\n-      return filter((SafeString) var, interpreter, newArgs);\n-    }\n-\n-    return filter(var, interpreter, newArgs);\n-  }\n-\n-  @Override\n-  public Object filter(Object var, JinjavaInterpreter interpreter, String... args) {\n-    if (var instanceof String) {\n-      int length = DEFAULT_TRUNCATE_LENGTH;\n-      String ends = DEFAULT_END;\n-\n-      if (args.length > 0) {\n-        try {\n-          length = Integer.parseInt(Objects.toString(args[0]));\n-        } catch (Exception e) {\n-          ENGINE_LOG.warn(", "originalCommit": "e5b850bf91634ad6eda9ae9f4b53b9c4069d57ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwNTUyMQ==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r522505521", "bodyText": "Ah I see your point, it ignores parsing errors. Given that we are using defaultValue now did you want to keep parse-and-ignore-error functionality or rely on correct user input/sensible default value?", "author": "michaelpro1", "createdAt": "2020-11-12T23:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5MTgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwMjYxMw==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r523202613", "bodyText": "I think we should just confirm that it still validates the value but we don't need to log a warning. It's pretty useless.", "author": "boulter", "createdAt": "2020-11-13T20:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5MTgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyODg0Nw==", "url": "https://github.com/HubSpot/jinjava/pull/531#discussion_r523728847", "bodyText": "Take a look at the last commits, I've added a default on error. Additionally I've fixed up the number parsing as NumberUtils seems to default to 0 if not parsed.", "author": "michaelpro1", "createdAt": "2020-11-15T08:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5MTgwNQ=="}], "type": "inlineReview"}, {"oid": "f1df1b3355e096a0ee3874b27e3787efdd1bc139", "url": "https://github.com/HubSpot/jinjava/commit/f1df1b3355e096a0ee3874b27e3787efdd1bc139", "message": "AbstractFilter: pre-parse default values. Validate input numbers instead of returning default 0", "committedDate": "2020-11-15T08:31:36Z", "type": "commit"}, {"oid": "7ae931d86995119cc3b017cbbc64b4993163cce3", "url": "https://github.com/HubSpot/jinjava/commit/7ae931d86995119cc3b017cbbc64b4993163cce3", "message": "AbstractFilter: pre-parse default values. Validate input numbers instead of returning default 0. Expose defaultValue for parameter name", "committedDate": "2020-11-15T08:46:26Z", "type": "commit"}, {"oid": "8de2f0965bf36da2221e6680c44e1ab604b94b12", "url": "https://github.com/HubSpot/jinjava/commit/8de2f0965bf36da2221e6680c44e1ab604b94b12", "message": "truncatehtml: add param defaulting as per review comments", "committedDate": "2020-11-15T08:52:26Z", "type": "commit"}]}