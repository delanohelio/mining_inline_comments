{"pr_number": 605, "pr_title": "More JSSEngine Memory Leak Fixes", "pr_createdAt": "2020-07-23T22:37:46Z", "pr_url": "https://github.com/dogtagpki/jss/pull/605", "timeline": [{"oid": "6351d54d4888d0c18951a6dec9fbdf5def3a93da", "url": "https://github.com/dogtagpki/jss/commit/6351d54d4888d0c18951a6dec9fbdf5def3a93da", "message": "Fix memory leak during BufferPRFD destruction\n\nBufferPRFDs must destroy their layer when they're they only layer left,\notherwise closing a layer will leave allocated resources around.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-23T14:31:51Z", "type": "commit"}, {"oid": "2ac14c645014acf6e4e58ee5e169bb8bc953dbd9", "url": "https://github.com/dogtagpki/jss/commit/2ac14c645014acf6e4e58ee5e169bb8bc953dbd9", "message": "Fix memory leaks in TestBufferPRFDSSL\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-23T14:33:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2OTMxNw==", "url": "https://github.com/dogtagpki/jss/pull/605#discussion_r459769317", "bodyText": "Should this be done later when it's actually needed, i.e. in line 1000?", "author": "edewata", "createdAt": "2020-07-23T22:46:21Z", "path": "org/mozilla/jss/ssl/javax/JSSEngine.java", "diffHunk": "@@ -980,6 +980,15 @@ protected static SSLFDProxy getServerTemplate(PK11Cert cert, PK11PrivKey key) {\n \n         SSLFDProxy fd = serverTemplates.get(cert);\n         if (fd == null) {\n+            // Here we clone the certificate. This certificate is functionally\n+            // the same, but its scope is owned by the serverTemplates map.\n+            // This allows the certificate to persist, even when the original\n+            // key is closed by the owning JSSEngine instance. Note that we\n+            // need not clone the key: ConfigServerCert will maintain its own\n+            // copy of the key and cert, so we are free to let it get garbage\n+            // collected.\n+            PK11Cert cert_clone = cert.duplicate();", "originalCommit": "db0815eb2ed338c7b6763236c74ffe5c896c82ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2OTgwNA==", "url": "https://github.com/dogtagpki/jss/pull/605#discussion_r459769804", "bodyText": "Could we log a warning if there's an exception so at least we know if there's something wrong?", "author": "edewata", "createdAt": "2020-07-23T22:47:53Z", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -1435,21 +1439,45 @@ public void cleanup() {\n             session.close();\n             session = null;\n         }\n+\n+        cleanupKeys();\n+    }\n+\n+    private void cleanupKeys() {\n+        // Clean up the keys used in this transaction.\n+        if (cert != null) {\n+            try {\n+                cert.close();\n+            } catch (Exception e) {}", "originalCommit": "db0815eb2ed338c7b6763236c74ffe5c896c82ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2OTgyNw==", "url": "https://github.com/dogtagpki/jss/pull/605#discussion_r459769827", "bodyText": "Same here.", "author": "edewata", "createdAt": "2020-07-23T22:48:01Z", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -1435,21 +1439,45 @@ public void cleanup() {\n             session.close();\n             session = null;\n         }\n+\n+        cleanupKeys();\n+    }\n+\n+    private void cleanupKeys() {\n+        // Clean up the keys used in this transaction.\n+        if (cert != null) {\n+            try {\n+                cert.close();\n+            } catch (Exception e) {}\n+\n+            cert = null;\n+        }\n+\n+        if (key != null) {\n+            try {\n+                key.close();\n+            } catch (Exception e) {}", "originalCommit": "db0815eb2ed338c7b6763236c74ffe5c896c82ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MDQ4MA==", "url": "https://github.com/dogtagpki/jss/pull/605#discussion_r459770480", "bodyText": "Should we create separate if-statements for each socket?\nif (s_socket != null) {\n   ... close s_socket ...\n}\nif (c_socket != null) {\n   ... close c_socket ...\n}", "author": "edewata", "createdAt": "2020-07-23T22:50:00Z", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -1435,21 +1439,45 @@ public void cleanup() {\n             session.close();\n             session = null;\n         }\n+\n+        cleanupKeys();\n+    }\n+\n+    private void cleanupKeys() {\n+        // Clean up the keys used in this transaction.\n+        if (cert != null) {\n+            try {\n+                cert.close();\n+            } catch (Exception e) {}\n+\n+            cert = null;\n+        }\n+\n+        if (key != null) {\n+            try {\n+                key.close();\n+            } catch (Exception e) {}\n+\n+            key = null;\n+        }\n     }\n \n     private void cleanupLoggingSocket() {\n-        if (debug_port > 0) {\n+        if (debug_port > 0 && s_socket != null && c_socket != null && ss_socket != null) {", "originalCommit": "db0815eb2ed338c7b6763236c74ffe5c896c82ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ac14c645014acf6e4e58ee5e169bb8bc953dbd9", "url": "https://github.com/dogtagpki/jss/commit/2ac14c645014acf6e4e58ee5e169bb8bc953dbd9", "message": "Fix memory leaks in TestBufferPRFDSSL\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-23T14:33:25Z", "type": "forcePushed"}]}