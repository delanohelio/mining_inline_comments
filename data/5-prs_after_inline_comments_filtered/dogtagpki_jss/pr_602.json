{"pr_number": 602, "pr_title": "Fix SSLEngine memory leaks", "pr_createdAt": "2020-07-22T19:20:49Z", "pr_url": "https://github.com/dogtagpki/jss/pull/602", "timeline": [{"oid": "1b5109c730b73971fffb4d4417c8e9da51876184", "url": "https://github.com/dogtagpki/jss/commit/1b5109c730b73971fffb4d4417c8e9da51876184", "message": "Handle NULL return from SSL_ImportFD\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T14:56:08Z", "type": "commit"}, {"oid": "098899a5c70575e0eb220fd023d17206081e953a", "url": "https://github.com/dogtagpki/jss/commit/098899a5c70575e0eb220fd023d17206081e953a", "message": "Close SSLEngine inbound during socket close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T14:56:27Z", "type": "commit"}, {"oid": "3a3decbff23a233e7adfe9cdd0ba21d8998ef1dc", "url": "https://github.com/dogtagpki/jss/commit/3a3decbff23a233e7adfe9cdd0ba21d8998ef1dc", "message": "Track SSLSocket close, inform user on re-use\n\nSockets in Java cannot be reused, per javadocs:\n\n    Once a socket has been closed, it is not available for\n    further networking use (i.e. can't be reconnected or\n    rebound). A new socket needs to be created.\n\nPrevent this use in JSSSocket.\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T14:57:15Z", "type": "commit"}, {"oid": "433ab6bd11c53f1261033f92fb9afec246493a4f", "url": "https://github.com/dogtagpki/jss/commit/433ab6bd11c53f1261033f92fb9afec246493a4f", "message": "Fix TokenProxy leak\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T18:01:22Z", "type": "commit"}, {"oid": "e3e2e8adba8939ebdeca41e3de272905bfe99e09", "url": "https://github.com/dogtagpki/jss/commit/e3e2e8adba8939ebdeca41e3de272905bfe99e09", "message": "Allow sessions to clear PK11Cert instances\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T18:01:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMTYxNA==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459031614", "bodyText": "Does it mean we need to do this in PKI as well? Or will PK11Cert.close() get called automatically when it's garbage collected?", "author": "edewata", "createdAt": "2020-07-22T19:28:42Z", "path": "org/mozilla/jss/provider/javax/crypto/JSSTokenKeyManager.java", "diffHunk": "@@ -118,8 +118,10 @@ public PrivateKey getPrivateKey(String alias) {\n \n         try {\n             if (jks == null) {\n-                org.mozilla.jss.crypto.X509Certificate cert = cm.findCertByNickname(alias);\n-                return cm.findPrivKeyByCert(cert);\n+                try (PK11Cert cert = (PK11Cert) cm.findCertByNickname(alias)) {", "originalCommit": "b93e6580be8427aa8175cf8eba3e4f05675b477b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTE2MQ==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039161", "bodyText": "No, this isn't strictly necessary. It'll get called automatically when it is garbage collected. However, because the scope is small here, it is good to use the try-with-resources pattern to ensure it gets closed and freed quickly. This means the GC pass will just clean up the destroyed Java objects (PK11Cert, CertProxy, and TokenProxy instances), and not need to call into the JNI layer to free NSS stuff.", "author": "cipherboy", "createdAt": "2020-07-22T19:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMTYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMjU4Nw==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459032587", "bodyText": "Do we need to call fd.clear() if ssl_fd == null?", "author": "edewata", "createdAt": "2020-07-22T19:30:27Z", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();", "originalCommit": "b93e6580be8427aa8175cf8eba3e4f05675b477b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTUyNw==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039527", "bodyText": "We should probably close it, not clear it in that case. I'll update it.", "author": "cipherboy", "createdAt": "2020-07-22T19:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzMjU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTYxMQ==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459039611", "bodyText": "fd is a local variable, and usually it's not necessary to nullify a local variable, but do you think it's necessary here?", "author": "edewata", "createdAt": "2020-07-22T19:43:23Z", "path": "org/mozilla/jss/ssl/javax/JSSEngineReferenceImpl.java", "diffHunk": "@@ -195,6 +195,12 @@ private void createBufferFD() throws SSLException {\n \n         // Initialize ssl_fd from the model Buffer-backed PRFileDesc.\n         ssl_fd = SSL.ImportFD(model, fd);\n+        if (ssl_fd == null) {\n+            throw new SSLException(\"Error creating SSL socket on top of buffer-backed PRFileDesc.\");\n+        }\n+\n+        fd.clear();\n+        fd = null;", "originalCommit": "b93e6580be8427aa8175cf8eba3e4f05675b477b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0MDkyOQ==", "url": "https://github.com/dogtagpki/jss/pull/602#discussion_r459040929", "bodyText": "It isn't necessary to nullify a local variable to trigger the GC, I agree.\nHowever, it just ensures that if we were to use fd again later without thinking about it, we'd get a NPE rather than a segfault (if we tried to call into the JNI layer using fd again and something didn't adequately defend against a cleared pointer).\nIMO this is preferable so I nulled it.", "author": "cipherboy", "createdAt": "2020-07-22T19:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTYxMQ=="}], "type": "inlineReview"}, {"oid": "bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "url": "https://github.com/dogtagpki/jss/commit/bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "message": "Clear PRFDProxy after import, session on close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T20:01:25Z", "type": "commit"}, {"oid": "bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "url": "https://github.com/dogtagpki/jss/commit/bbeadc6221666ebf024aa8ba7c4da50b520de8f3", "message": "Clear PRFDProxy after import, session on close\n\nSigned-off-by: Alexander Scheel <ascheel@redhat.com>", "committedDate": "2020-07-22T20:01:25Z", "type": "forcePushed"}]}