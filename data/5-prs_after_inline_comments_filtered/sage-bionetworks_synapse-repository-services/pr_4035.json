{"pr_number": 4035, "pr_title": "Plfm 6158", "pr_createdAt": "2020-05-07T15:57:12Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035", "timeline": [{"oid": "82aab5c95d99509baa4c226c6677ffe6891ffc9d", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/82aab5c95d99509baa4c226c6677ffe6891ffc9d", "message": "PLFM-6158: Move providers at the manager level", "committedDate": "2020-05-07T04:04:04Z", "type": "commit"}, {"oid": "2b84b127afce50ba8646b4f234bd2273448df422", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2b84b127afce50ba8646b4f234bd2273448df422", "message": "PLFM-6158: Store view subtype as varchar", "committedDate": "2020-05-07T04:53:07Z", "type": "commit"}, {"oid": "25b4c8a3156f1050cfbcf2e3d3dbf614355568d8", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/25b4c8a3156f1050cfbcf2e3d3dbf614355568d8", "message": "PLFM-6158: Remove complexity in scope filter -> SQL", "committedDate": "2020-05-07T05:38:02Z", "type": "commit"}, {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9bdb28d9909850f1b130d1d0d258f62f572ab520", "message": "Move test to junit5", "committedDate": "2020-05-07T05:47:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NTk4Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421665983", "bodyText": "rename", "author": "john-hill", "createdAt": "2020-05-07T17:18:25Z", "path": "lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java", "diffHunk": "@@ -3020,7 +3023,66 @@ public void testGetDeleteRowsFromViewSql() {\n \t\tassertEquals(\"DELETE FROM T999 WHERE ROW_ID = ?\", sql);\r\n \t}\r\n \t\r\n-\tprivate SQLScopeFilter getSQLScopeFilter(Long typeMask) {\r\n-\t\treturn new SQLScopeFilterBuilder(scopeFilterProvider, typeMask).build();\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithSingleType(){\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('file')\", result);\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithMultipleTypes(){\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file, EntityType.table);\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('file','table')\", result);\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithAllEntityTypes(){\r\n+\t\tList<Enum<?>> subTypes = Arrays.asList(EntityType.values());\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('project','folder','file','table','link','entityview','dockerrepo')\", result);\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testGetViewScopeFilterColumn() {\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\t\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeFilterColumn(scopeFilter);\r\n+\t\t\r\n+\t\tassertEquals(TableConstants.OBJECT_REPLICATION_COL_PARENT_ID, result);\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testGetViewScopeFilterColumnWithFilterByObjectId() {\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\t\r\n+\t\tboolean filterByObjectId = true;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeFilterColumn(scopeFilter);\r\n+\t\t\r\n+\t\tassertEquals(TableConstants.OBJECT_REPLICATION_COL_OBJECT_ID, result);\r\n+\t}\r\n+\t\r\n+\tprivate ViewScopeFilter getSQLScopeFilter(List<Enum<?>> subTypes, boolean filterByObjectId) {\r", "originalCommit": "9bdb28d9909850f1b130d1d0d258f62f572ab520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4OTU1NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421689554", "bodyText": "remove it not needed", "author": "john-hill", "createdAt": "2020-05-07T17:57:45Z", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/metadata/ObjectFieldTypeMapper.java", "diffHunk": "@@ -10,6 +11,11 @@\n  * @author Marco Marasca\r\n  */\r\n public interface ObjectFieldTypeMapper {\r\n+\t\r\n+\t/**\r\n+\t * @return The object type this mapper applies to\r\n+\t */\r\n+\tObjectType getObjectType();\r", "originalCommit": "9bdb28d9909850f1b130d1d0d258f62f572ab520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5NjMyMg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421696322", "bodyText": "Consider a List here since at this level it does not matter that they were enums.", "author": "john-hill", "createdAt": "2020-05-07T18:08:55Z", "path": "lib/models/src/main/java/org/sagebionetworks/repo/model/table/ViewScopeFilter.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.sagebionetworks.repo.model.table;\r\n+\r\n+import java.util.List;\r\n+import java.util.Objects;\r\n+import java.util.Set;\r\n+\r\n+import org.sagebionetworks.repo.model.ObjectType;\r\n+\r\n+/**\r\n+ * DTO that specifies the scope filter to apply when working with a view\r\n+ * \r\n+ * @author Marco Marasca\r\n+ */\r\n+public class ViewScopeFilter {\r\n+\r\n+\tprivate final ObjectType objectType;\r\n+\tprivate final List<Enum<?>> subTypes;\r\n+\tprivate final boolean filterByObjectId;\r\n+\tprivate final Set<Long> containerIds;\r\n+\r\n+\tpublic ViewScopeFilter(ObjectType objectType, List<Enum<?>> subTypes, boolean filterByObjectId, Set<Long> containerIds) {\r\n+\t\tthis.objectType = objectType;\r\n+\t\tthis.subTypes = subTypes;\r\n+\t\tthis.filterByObjectId = filterByObjectId;\r\n+\t\tthis.containerIds = containerIds;\r\n+\t}\r\n+\t\r\n+\tpublic ObjectType getObjectType() {\r\n+\t\treturn objectType;\r\n+\t}\r\n+\r\n+\tpublic List<Enum<?>> getSubTypes() {\r", "originalCommit": "9bdb28d9909850f1b130d1d0d258f62f572ab520", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}