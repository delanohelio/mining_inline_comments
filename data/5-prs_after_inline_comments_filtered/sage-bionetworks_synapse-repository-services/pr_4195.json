{"pr_number": 4195, "pr_title": "Submission Limits and Evaluation Rounds (PLFM-6240)", "pr_createdAt": "2020-09-09T08:15:28Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195", "timeline": [{"oid": "ef05dee8bea9071c71ee2f46bc670867e6958207", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ef05dee8bea9071c71ee2f46bc670867e6958207", "message": "intermediate changes", "committedDate": "2020-08-11T01:59:41Z", "type": "commit"}, {"oid": "063326ca14c7ce10787931c938a177601ccb4e5d", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/063326ca14c7ce10787931c938a177601ccb4e5d", "message": "evaluation round", "committedDate": "2020-08-28T03:34:25Z", "type": "commit"}, {"oid": "1c0448d8bf2ca62931e290948592bd945ef2d9c0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1c0448d8bf2ca62931e290948592bd945ef2d9c0", "message": "testerino", "committedDate": "2020-09-02T05:28:03Z", "type": "commit"}, {"oid": "6ec86e4d2721c280ea77c89f8c6a6c818473fbb9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6ec86e4d2721c280ea77c89f8c6a6c818473fbb9", "message": "testerino", "committedDate": "2020-09-03T07:06:47Z", "type": "commit"}, {"oid": "fe84ee605c45c77736fc15b4959a216bbeee399d", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fe84ee605c45c77736fc15b4959a216bbeee399d", "message": "Merge branch 'develop' of github.com:Sage-Bionetworks/Synapse-Repository-Services into PLFM-6240", "committedDate": "2020-09-03T07:46:05Z", "type": "commit"}, {"oid": "1b530e1d54974055f85ba5d019b9d62e3ded5516", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1b530e1d54974055f85ba5d019b9d62e3ded5516", "message": "TESTSSS", "committedDate": "2020-09-04T02:53:20Z", "type": "commit"}, {"oid": "673d82b0d63fb7ba3cd64accf657ccc674c4c356", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/673d82b0d63fb7ba3cd64accf657ccc674c4c356", "message": "apparently there's more stuff to do", "committedDate": "2020-09-04T08:02:08Z", "type": "commit"}, {"oid": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9e68dcd409d83664ad9d1f4f01c517a8756effbc", "message": "plz work", "committedDate": "2020-09-09T07:28:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2NTQ3OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485965479", "bodyText": "We might want to drop the JDO", "author": "marcomarasca", "createdAt": "2020-09-09T22:54:30Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/repo/model/query/SQLConstants.java", "diffHunk": "@@ -34,6 +34,16 @@\n \tpublic static final String COL_EVALUATION_QUOTA\t\t\t\t= \"QUOTA\";\n \tpublic static final String COL_EVALUATION_START_TIMESTAMP\t\t= \"START_TIMESTAMP\";\n \tpublic static final String COL_EVALUATION_END_TIMESTAMP\t\t= \"END_TIMESTAMP\";\n+\n+\t// Evaluation Round table constants\n+\tpublic static final String DDL_FILE_EVALUATION_ROUND\t\t\t= \"schema/evaluation/EvaluationRound-ddl.sql\";\n+\tpublic static final String TABLE_EVALUATION_ROUND\t\t\t\t= \"JDOEVALUATIONROUNDS\";", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2ODgwMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485968803", "bodyText": "You might want to update the hashcode and equals as well (Shouldn't the tests fail?)", "author": "marcomarasca", "createdAt": "2020-09-09T23:04:26Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/SubmissionDBO.java", "diffHunk": "@@ -145,7 +155,15 @@ public Long getEvalId() {\n \tpublic void setEvalId(Long evalId) {\n \t\tthis.evalId = evalId;\n \t}\n-\t\n+\n+\tpublic Long getEvalRoundId() {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2OTE2OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485969168", "bodyText": "Do you need the ObservableEntity interface?", "author": "marcomarasca", "createdAt": "2020-09-09T23:05:27Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2OTU5MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485969590", "bodyText": "You might want remove this (Now the round is referenced by both the submission and the evaluation)", "author": "marcomarasca", "createdAt": "2020-09-09T23:06:43Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationDBO.java", "diffHunk": "@@ -263,7 +263,7 @@ public MigrationType getMigratableTableType() {\n \t}\n \t@Override\n \tpublic List<MigratableDatabaseObject<?,?>> getSecondaryTypes() {\n-\t\treturn null;\n+\t\treturn Arrays.asList(new EvaluationRoundDBO());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2OTk2MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485969961", "bodyText": "Long vs long", "author": "marcomarasca", "createdAt": "2020-09-09T23:07:54Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {\n+\n+\tprivate static final FieldColumn[] FIELDS = new FieldColumn[] {\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ID, COL_EVALUATION_ROUND_ID, true).withIsBackupId(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ETAG, COL_EVALUATION_ROUND_ETAG).withIsEtag(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_EVALUATION_ID, COL_EVALUATION_ROUND_EVALUATION_ID),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_START, COL_EVALUATION_ROUND_ROUND_START),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_END, COL_EVALUATION_ROUND_ROUND_END),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_LIMITS_JSON, COL_EVALUATION_ROUND_LIMITS)\n+\t};\n+\n+\tprivate Long id;\n+\tprivate String etag;\n+\tprivate Long evaluationId;\n+\tprivate long roundStart;", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MDExMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485970111", "bodyText": "Can be extracted to a constant", "author": "marcomarasca", "createdAt": "2020-09-09T23:08:27Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {\n+\n+\tprivate static final FieldColumn[] FIELDS = new FieldColumn[] {\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ID, COL_EVALUATION_ROUND_ID, true).withIsBackupId(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ETAG, COL_EVALUATION_ROUND_ETAG).withIsEtag(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_EVALUATION_ID, COL_EVALUATION_ROUND_EVALUATION_ID),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_START, COL_EVALUATION_ROUND_ROUND_START),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_END, COL_EVALUATION_ROUND_ROUND_END),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_LIMITS_JSON, COL_EVALUATION_ROUND_LIMITS)\n+\t};\n+\n+\tprivate Long id;\n+\tprivate String etag;\n+\tprivate Long evaluationId;\n+\tprivate long roundStart;\n+\tprivate long roundEnd;\n+\tprivate String limitsJson;\n+\n+\t@Override\n+\tpublic String getIdString() {\n+\t\treturn id.toString();\n+\t}\n+\n+\t@Override\n+\tpublic ObjectType getObjectType() {\n+\t\treturn ObjectType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigrationType getMigratableTableType() {\n+\t\treturn MigrationType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigratableTableTranslation<EvaluationRoundDBO, EvaluationRoundDBO> getTranslator() {\n+\t\treturn new BasicMigratableTableTranslation<>();", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MDE5Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485970193", "bodyText": "Remove comment", "author": "marcomarasca", "createdAt": "2020-09-09T23:08:46Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {\n+\n+\tprivate static final FieldColumn[] FIELDS = new FieldColumn[] {\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ID, COL_EVALUATION_ROUND_ID, true).withIsBackupId(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ETAG, COL_EVALUATION_ROUND_ETAG).withIsEtag(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_EVALUATION_ID, COL_EVALUATION_ROUND_EVALUATION_ID),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_START, COL_EVALUATION_ROUND_ROUND_START),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_END, COL_EVALUATION_ROUND_ROUND_END),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_LIMITS_JSON, COL_EVALUATION_ROUND_LIMITS)\n+\t};\n+\n+\tprivate Long id;\n+\tprivate String etag;\n+\tprivate Long evaluationId;\n+\tprivate long roundStart;\n+\tprivate long roundEnd;\n+\tprivate String limitsJson;\n+\n+\t@Override\n+\tpublic String getIdString() {\n+\t\treturn id.toString();\n+\t}\n+\n+\t@Override\n+\tpublic ObjectType getObjectType() {\n+\t\treturn ObjectType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigrationType getMigratableTableType() {\n+\t\treturn MigrationType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigratableTableTranslation<EvaluationRoundDBO, EvaluationRoundDBO> getTranslator() {\n+\t\treturn new BasicMigratableTableTranslation<>();\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getBackupClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getDatabaseObjectClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic List<MigratableDatabaseObject<?, ?>> getSecondaryTypes() {\n+//\t\treturn Arrays.asList(new SubmissionDBO());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MDIyNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485970226", "bodyText": "Can be extracted to a constant", "author": "marcomarasca", "createdAt": "2020-09-09T23:08:54Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {\n+\n+\tprivate static final FieldColumn[] FIELDS = new FieldColumn[] {\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ID, COL_EVALUATION_ROUND_ID, true).withIsBackupId(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ETAG, COL_EVALUATION_ROUND_ETAG).withIsEtag(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_EVALUATION_ID, COL_EVALUATION_ROUND_EVALUATION_ID),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_START, COL_EVALUATION_ROUND_ROUND_START),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_END, COL_EVALUATION_ROUND_ROUND_END),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_LIMITS_JSON, COL_EVALUATION_ROUND_LIMITS)\n+\t};\n+\n+\tprivate Long id;\n+\tprivate String etag;\n+\tprivate Long evaluationId;\n+\tprivate long roundStart;\n+\tprivate long roundEnd;\n+\tprivate String limitsJson;\n+\n+\t@Override\n+\tpublic String getIdString() {\n+\t\treturn id.toString();\n+\t}\n+\n+\t@Override\n+\tpublic ObjectType getObjectType() {\n+\t\treturn ObjectType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigrationType getMigratableTableType() {\n+\t\treturn MigrationType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigratableTableTranslation<EvaluationRoundDBO, EvaluationRoundDBO> getTranslator() {\n+\t\treturn new BasicMigratableTableTranslation<>();\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getBackupClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getDatabaseObjectClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic List<MigratableDatabaseObject<?, ?>> getSecondaryTypes() {\n+//\t\treturn Arrays.asList(new SubmissionDBO());\n+\t\treturn null;\n+\t}\n+\n+\t@Override\n+\tpublic TableMapping<EvaluationRoundDBO> getTableMapping() {\n+\t\treturn new TableMapping<EvaluationRoundDBO>() {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MDQ4Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485970486", "bodyText": "You probably don't need this validation at this point", "author": "marcomarasca", "createdAt": "2020-09-09T23:09:40Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBO.java", "diffHunk": "@@ -0,0 +1,214 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_LIMITS_JSON;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.evaluation.dbo.DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ETAG;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_EVALUATION_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ID;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_LIMITS;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_END;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.COL_EVALUATION_ROUND_ROUND_START;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.DDL_FILE_EVALUATION_ROUND;\n+import static org.sagebionetworks.repo.model.query.SQLConstants.TABLE_EVALUATION_ROUND;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import org.sagebionetworks.repo.model.ObjectType;\n+import org.sagebionetworks.repo.model.ObservableEntity;\n+import org.sagebionetworks.repo.model.dbo.FieldColumn;\n+import org.sagebionetworks.repo.model.dbo.MigratableDatabaseObject;\n+import org.sagebionetworks.repo.model.dbo.TableMapping;\n+import org.sagebionetworks.repo.model.dbo.migration.BasicMigratableTableTranslation;\n+import org.sagebionetworks.repo.model.dbo.migration.MigratableTableTranslation;\n+import org.sagebionetworks.repo.model.migration.MigrationType;\n+\n+public class EvaluationRoundDBO implements MigratableDatabaseObject<EvaluationRoundDBO, EvaluationRoundDBO>, ObservableEntity {\n+\n+\tprivate static final FieldColumn[] FIELDS = new FieldColumn[] {\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ID, COL_EVALUATION_ROUND_ID, true).withIsBackupId(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ETAG, COL_EVALUATION_ROUND_ETAG).withIsEtag(true),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_EVALUATION_ID, COL_EVALUATION_ROUND_EVALUATION_ID),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_START, COL_EVALUATION_ROUND_ROUND_START),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_ROUND_END, COL_EVALUATION_ROUND_ROUND_END),\n+\t\t\tnew FieldColumn(PARAM_EVALUATION_ROUND_LIMITS_JSON, COL_EVALUATION_ROUND_LIMITS)\n+\t};\n+\n+\tprivate Long id;\n+\tprivate String etag;\n+\tprivate Long evaluationId;\n+\tprivate long roundStart;\n+\tprivate long roundEnd;\n+\tprivate String limitsJson;\n+\n+\t@Override\n+\tpublic String getIdString() {\n+\t\treturn id.toString();\n+\t}\n+\n+\t@Override\n+\tpublic ObjectType getObjectType() {\n+\t\treturn ObjectType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigrationType getMigratableTableType() {\n+\t\treturn MigrationType.EVALUATION_ROUND;\n+\t}\n+\n+\t@Override\n+\tpublic MigratableTableTranslation<EvaluationRoundDBO, EvaluationRoundDBO> getTranslator() {\n+\t\treturn new BasicMigratableTableTranslation<>();\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getBackupClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic Class<? extends EvaluationRoundDBO> getDatabaseObjectClass() {\n+\t\treturn EvaluationRoundDBO.class;\n+\t}\n+\n+\t@Override\n+\tpublic List<MigratableDatabaseObject<?, ?>> getSecondaryTypes() {\n+//\t\treturn Arrays.asList(new SubmissionDBO());\n+\t\treturn null;\n+\t}\n+\n+\t@Override\n+\tpublic TableMapping<EvaluationRoundDBO> getTableMapping() {\n+\t\treturn new TableMapping<EvaluationRoundDBO>() {\n+\t\t\t@Override\n+\t\t\tpublic String getTableName() {\n+\t\t\t\treturn TABLE_EVALUATION_ROUND;\n+\t\t\t}\n+\n+\t\t\t@Override\n+\t\t\tpublic String getDDLFileName() {\n+\t\t\t\treturn DDL_FILE_EVALUATION_ROUND;\n+\t\t\t}\n+\n+\t\t\t@Override\n+\t\t\tpublic FieldColumn[] getFieldColumns() {\n+\t\t\t\treturn FIELDS;\n+\t\t\t}\n+\n+\t\t\t@Override\n+\t\t\tpublic Class<? extends EvaluationRoundDBO> getDBOClass() {\n+\t\t\t\treturn EvaluationRoundDBO.class;\n+\t\t\t}\n+\n+\t\t\t@Override\n+\t\t\tpublic EvaluationRoundDBO mapRow(ResultSet resultSet, int rowNum) throws SQLException {\n+\t\t\t\tEvaluationRoundDBO evaluationRoundDBO = new EvaluationRoundDBO();\n+\t\t\t\tevaluationRoundDBO.setId(resultSet.getLong(COL_EVALUATION_ROUND_ID));\n+\t\t\t\tevaluationRoundDBO.setEtag(resultSet.getString(COL_EVALUATION_ROUND_ETAG));\n+\t\t\t\tevaluationRoundDBO.setEvaluationId(resultSet.getLong(COL_EVALUATION_ROUND_EVALUATION_ID));\n+\t\t\t\tevaluationRoundDBO.setRoundStart(resultSet.getLong(COL_EVALUATION_ROUND_ROUND_START));\n+\t\t\t\tif (resultSet.wasNull()){", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MjkyOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485972929", "bodyText": "You might want to initialize this to the size of the jsonArray.length()", "author": "marcomarasca", "createdAt": "2020-09-09T23:18:04Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBOUtil.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.sagebionetworks.evaluation.model.EvaluationRound;\n+import org.sagebionetworks.evaluation.model.EvaluationRoundLimit;\n+import org.sagebionetworks.repo.model.jdo.JDOSecondaryPropertyUtils;\n+import org.sagebionetworks.schema.adapter.JSONArrayAdapter;\n+import org.sagebionetworks.schema.adapter.JSONObjectAdapterException;\n+import org.sagebionetworks.schema.adapter.org.json.EntityFactory;\n+import org.sagebionetworks.schema.adapter.org.json.JSONArrayAdapterImpl;\n+import org.sagebionetworks.schema.adapter.org.json.JSONObjectAdapterImpl;\n+import org.sagebionetworks.util.ValidateArgument;\n+\n+public class EvaluationRoundDBOUtil {\n+\tpublic static EvaluationRoundDBO toDBO(EvaluationRound dto){\n+\t\tValidateArgument.requiredNotBlank(dto.getId(), \"id\");\n+\t\tValidateArgument.requiredNotBlank(dto.getEtag(), \"etag\");\n+\t\tValidateArgument.requiredNotBlank(dto.getEvaluationId(), \"evaluationId\");\n+\n+\t\tEvaluationRoundDBO dbo = new EvaluationRoundDBO();\n+\n+\t\tdbo.setId(Long.parseLong(dto.getId()));\n+\t\tdbo.setEtag(dto.getEtag());\n+\t\tdbo.setEvaluationId(Long.parseLong(dto.getEvaluationId()));\n+\n+\t\tdbo.setRoundStart(dto.getRoundStart().getTime());\n+\t\tdbo.setRoundEnd(dto.getRoundEnd().getTime());\n+\n+\t\tList<EvaluationRoundLimit> limit = dto.getLimits();\n+\t\tif(CollectionUtils.isNotEmpty(limit)) {\n+\t\t\ttry {\n+\t\t\t\tJSONArrayAdapter jsonArray = new JSONArrayAdapterImpl();\n+\t\t\t\tfor (int i = 0; i < limit.size(); i++) {\n+\t\t\t\t\tEvaluationRoundLimit val = limit.get(i);\n+\t\t\t\t\tif(val != null) {\n+\t\t\t\t\t\tjsonArray.put(i, val.writeToJSONObject(new JSONObjectAdapterImpl()));\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tdbo.setLimitsJson(jsonArray.toJSONString());\n+\t\t\t} catch (JSONObjectAdapterException e) {\n+\t\t\t\tthrow new IllegalStateException(\"Could not serialize EvaluationRoundLimit\", e);\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn dbo;\n+\t}\n+\n+\tpublic static EvaluationRound toDTO(EvaluationRoundDBO dbo){\n+\t\tEvaluationRound dto = new EvaluationRound();\n+\n+\t\tdto.setId(dbo.getId().toString());\n+\t\tdto.setEtag(dbo.getEtag());\n+\t\tdto.setEvaluationId(dbo.getEvaluationId().toString());\n+\n+\t\tdto.setRoundStart(new Date(dbo.getRoundStart()));\n+\t\tdto.setRoundEnd(new Date(dbo.getRoundEnd()));\n+\n+\t\tString limitsJson = dbo.getLimitsJson();\n+\t\tif(StringUtils.isNotEmpty(limitsJson)) {\n+\t\t\ttry {\n+\t\t\t\tList<EvaluationRoundLimit> limits = new ArrayList<EvaluationRoundLimit>();", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3MzEyOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485973129", "bodyText": "if null probably throw illegalState", "author": "marcomarasca", "createdAt": "2020-09-09T23:18:30Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dbo/EvaluationRoundDBOUtil.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.sagebionetworks.evaluation.dbo;\n+\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.sagebionetworks.evaluation.model.EvaluationRound;\n+import org.sagebionetworks.evaluation.model.EvaluationRoundLimit;\n+import org.sagebionetworks.repo.model.jdo.JDOSecondaryPropertyUtils;\n+import org.sagebionetworks.schema.adapter.JSONArrayAdapter;\n+import org.sagebionetworks.schema.adapter.JSONObjectAdapterException;\n+import org.sagebionetworks.schema.adapter.org.json.EntityFactory;\n+import org.sagebionetworks.schema.adapter.org.json.JSONArrayAdapterImpl;\n+import org.sagebionetworks.schema.adapter.org.json.JSONObjectAdapterImpl;\n+import org.sagebionetworks.util.ValidateArgument;\n+\n+public class EvaluationRoundDBOUtil {\n+\tpublic static EvaluationRoundDBO toDBO(EvaluationRound dto){\n+\t\tValidateArgument.requiredNotBlank(dto.getId(), \"id\");\n+\t\tValidateArgument.requiredNotBlank(dto.getEtag(), \"etag\");\n+\t\tValidateArgument.requiredNotBlank(dto.getEvaluationId(), \"evaluationId\");\n+\n+\t\tEvaluationRoundDBO dbo = new EvaluationRoundDBO();\n+\n+\t\tdbo.setId(Long.parseLong(dto.getId()));\n+\t\tdbo.setEtag(dto.getEtag());\n+\t\tdbo.setEvaluationId(Long.parseLong(dto.getEvaluationId()));\n+\n+\t\tdbo.setRoundStart(dto.getRoundStart().getTime());\n+\t\tdbo.setRoundEnd(dto.getRoundEnd().getTime());\n+\n+\t\tList<EvaluationRoundLimit> limit = dto.getLimits();\n+\t\tif(CollectionUtils.isNotEmpty(limit)) {\n+\t\t\ttry {\n+\t\t\t\tJSONArrayAdapter jsonArray = new JSONArrayAdapterImpl();\n+\t\t\t\tfor (int i = 0; i < limit.size(); i++) {\n+\t\t\t\t\tEvaluationRoundLimit val = limit.get(i);\n+\t\t\t\t\tif(val != null) {\n+\t\t\t\t\t\tjsonArray.put(i, val.writeToJSONObject(new JSONObjectAdapterImpl()));\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tdbo.setLimitsJson(jsonArray.toJSONString());\n+\t\t\t} catch (JSONObjectAdapterException e) {\n+\t\t\t\tthrow new IllegalStateException(\"Could not serialize EvaluationRoundLimit\", e);\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn dbo;\n+\t}\n+\n+\tpublic static EvaluationRound toDTO(EvaluationRoundDBO dbo){\n+\t\tEvaluationRound dto = new EvaluationRound();\n+\n+\t\tdto.setId(dbo.getId().toString());\n+\t\tdto.setEtag(dbo.getEtag());\n+\t\tdto.setEvaluationId(dbo.getEvaluationId().toString());\n+\n+\t\tdto.setRoundStart(new Date(dbo.getRoundStart()));\n+\t\tdto.setRoundEnd(new Date(dbo.getRoundEnd()));\n+\n+\t\tString limitsJson = dbo.getLimitsJson();\n+\t\tif(StringUtils.isNotEmpty(limitsJson)) {\n+\t\t\ttry {\n+\t\t\t\tList<EvaluationRoundLimit> limits = new ArrayList<EvaluationRoundLimit>();\n+\t\t\t\tJSONArrayAdapter jsonArray = new JSONArrayAdapterImpl(limitsJson);\n+\t\t\t\tfor (int i = 0; i<jsonArray.length(); i ++) {\n+\t\t\t\t\tif(!jsonArray.isNull(i)) {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NDI5Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485974296", "bodyText": "Pass the original exception in the cause", "author": "marcomarasca", "createdAt": "2020-09-09T23:22:17Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionUtils.java", "diffHunk": "@@ -43,6 +43,11 @@ public static void copyDtoToDbo(Submission dto, SubmissionDBO dbo) {\n \t\t} catch (NumberFormatException e) {\n \t\t\tthrow new NumberFormatException(\"Invalid Evaluation ID: \" + dto.getEvaluationId());\n \t\t}\n+\t\ttry {\n+\t\t\tdbo.setEvalRoundId(dto.getEvaluationRoundId() == null ? null : Long.parseLong(dto.getEvaluationRoundId()));\n+\t\t} catch (NumberFormatException e) {\n+\t\t\tthrow new NumberFormatException(\"Invalid Round Evaluation ID: \" + dto.getEvaluationId());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NTQyNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485975426", "bodyText": "Consider removing the evaluation id parameter (the round id is globally unique)", "author": "marcomarasca", "createdAt": "2020-09-09T23:25:53Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImpl.java", "diffHunk": "@@ -868,6 +870,19 @@ public void truncateAll() {\n \t\tjdbcTemplate.update(\"DELETE FROM \" + TABLE_SUBMISSION);\n \t\tjdbcTemplate.update(\"DELETE FROM \" + TABLE_EVALUATION);\n \t}\n+\n+\t@Override\n+\tpublic boolean hasSubmissionForEvaluationRound(String evalId, String evalRoundId){\n+\t\tMapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+\t\tparameterSource.addValue(DBOConstants.PARAM_SUBMISSION_EVAL_ID, evalId);", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NTg3Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485975872", "bodyText": "public modifier not needed", "author": "marcomarasca", "createdAt": "2020-09-09T23:27:13Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAO.java", "diffHunk": "@@ -57,4 +60,79 @@ public void update(Evaluation dto) throws DatastoreException, InvalidModelExcept\n \t */\n \tSet<Long> getAvailableEvaluations(List<Long> ids);\n \n+\t/**\n+\t * Creates a new evaluation round\n+\t * @param evaluationRound\n+\t * @return the stored evaluation round\n+\t */\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound);", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3NzUwMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485977500", "bodyText": "Provide docs for the currentRoundId", "author": "marcomarasca", "createdAt": "2020-09-09T23:32:56Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAO.java", "diffHunk": "@@ -57,4 +60,79 @@ public void update(Evaluation dto) throws DatastoreException, InvalidModelExcept\n \t */\n \tSet<Long> getAvailableEvaluations(List<Long> ids);\n \n+\t/**\n+\t * Creates a new evaluation round\n+\t * @param evaluationRound\n+\t * @return the stored evaluation round\n+\t */\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound);\n+\n+\t/**\n+\t * Update an existing evaluation round\n+\t * @param evaluationRound\n+\t */\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound);\n+\n+\t/**\n+\t * Deletes the evaluation round identified by the provided ID\n+\t * @param evaluationId\n+\t * @param evaluationRoundId\n+\t */\n+\tpublic void deleteEvaluationRound(String evaluationId, String evaluationRoundId);\n+\n+\t/**\n+\t * Get the evaluation round identified by the provided ID\n+\t * @param evaluationId\n+\t * @param evaluationRoundId\n+\t * @return EvaluationRound for the current Id.\n+\t */\n+\tpublic EvaluationRound getEvaluationRound(String evaluationId, String evaluationRoundId);\n+\n+\t/**\n+\t * Get evaluation rounds associated with the evaluationId.\n+\t * Results will be ordered by Round's start date\n+\t * @param evaluationId id of the Evaluation\n+\t * @param limit maximum number of results to return\n+\t * @param offset starting offset for results\n+\t * @return EvaluationRounds associated with the evaluationId, ordered by roundStart dates in the EvaluationRound\n+\t * Empty list if no results.\n+\t */\n+\tpublic List<EvaluationRound> getAssociatedEvaluationRounds(String evaluationId, long limit, long offset);\n+\n+\t/**\n+\t * Get the EvaluationRound for a specified Evaluation ID such that the specified timestamp\n+\t * resides between the EvaluationRound's start and end timestamps.\n+\t *\n+\t * The start timestamp is inclusive\n+\t * The end timestamp is exclusive\n+\t *\n+\t * For example:\n+\t * EvaluationRound A : start=5 , end=35\n+\t * EvaluationRound B : start=40, end=55\n+\t *\n+\t * Any of {timestamp=25, timestamp=5} would return A\n+\t * {timestamp=45, timestamp=40} return B,\n+\t * {timestamp=35, timestamp=37, timestamp=4, timestamp=55, timestamp=56} return Optional.empty()\n+\t * @param evaluationId id of the Evaluation to search\n+\t * @param timestamp the timestamp for which a matching EvaluationRound's round start and round end timestamp must encapsulate\n+\t * @return\n+\t */\n+\tpublic Optional<EvaluationRound> getEvaluationRoundForTimestamp(String evaluationId, Instant timestamp);\n+\n+\t/**\n+\t *\n+\t * @param evaluationId id of the Evaluation\n+\t * @return true if the Evaluation has any EvaluationRounds associated with it. Otherwise, false.\n+\t */\n+\tboolean hasEvaluationRounds(String evaluationId);\n+\n+\t/**\n+\t * Lists existing EvaluationRounds for which provided start-end timestamp range overlap", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3ODg4Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485978882", "bodyText": "Maybe just catch the needed exception", "author": "marcomarasca", "createdAt": "2020-09-09T23:37:35Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTEyNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485979125", "bodyText": "pull the exception in the cause", "author": "marcomarasca", "createdAt": "2020-09-09T23:38:27Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new DatastoreException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound) {\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\ttry{\n+\t\t\t//update etag\n+\t\t\tString newEtag = lockAndGenerateEtag(dbo.getId().toString(), dbo.getEtag(),\n+\t\t\t\t\tTABLE_EVALUATION_ROUND, COL_EVALUATION_ROUND_ETAG, EvaluationRound.class);\n+\t\t\tdbo.setEtag(newEtag);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTk4Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485979987", "bodyText": "You can use the special single SinglePrimaryKeySqlParameterSource", "author": "marcomarasca", "createdAt": "2020-09-09T23:41:26Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new DatastoreException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound) {\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\ttry{\n+\t\t\t//update etag\n+\t\t\tString newEtag = lockAndGenerateEtag(dbo.getId().toString(), dbo.getEtag(),\n+\t\t\t\t\tTABLE_EVALUATION_ROUND, COL_EVALUATION_ROUND_ETAG, EvaluationRound.class);\n+\t\t\tdbo.setEtag(newEtag);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\n+\t\t// create DBO\n+\t\tif( ! basicDao.update(dbo) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void deleteEvaluationRound(String evaluationId, String evaluationRoundId) {\n+\t\tMapSqlParameterSource param = new MapSqlParameterSource();", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MDYzMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485980633", "bodyText": "YOu can either use the optional variant or pass the exception as cause", "author": "marcomarasca", "createdAt": "2020-09-09T23:43:35Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new DatastoreException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound) {\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\ttry{\n+\t\t\t//update etag\n+\t\t\tString newEtag = lockAndGenerateEtag(dbo.getId().toString(), dbo.getEtag(),\n+\t\t\t\t\tTABLE_EVALUATION_ROUND, COL_EVALUATION_ROUND_ETAG, EvaluationRound.class);\n+\t\t\tdbo.setEtag(newEtag);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\n+\t\t// create DBO\n+\t\tif( ! basicDao.update(dbo) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void deleteEvaluationRound(String evaluationId, String evaluationRoundId) {\n+\t\tMapSqlParameterSource param = new MapSqlParameterSource();\n+\t\tparam.addValue(ID, evaluationRoundId);\n+\t\tif( ! basicDao.deleteObjectByPrimaryKey(EvaluationRoundDBO.class, param) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(String evaluationId, String evaluationRoundId) {\n \t\tMapSqlParameterSource param = new MapSqlParameterSource();\n-\t\tparam.addValue(DBOConstants.PARAM_EVALUATION_ID, id);\n+\t\tparam.addValue(ID, evaluationRoundId);\n \t\ttry {\n-\t\t\tEvaluationDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationDBO.class, param);\n-\t\t\treturn dbo;\n+\t\t\tEvaluationRoundDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationRoundDBO.class, param);\n+\t\t\tEvaluationRound dto = EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t\treturn dto;\n \t\t} catch (NotFoundException e) {\n-\t\t\tthrow new NotFoundException(EVALUATION_NOT_FOUND + id);\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MjI1MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485982250", "bodyText": "You can move the evaluationId as the last param", "author": "marcomarasca", "createdAt": "2020-09-09T23:49:09Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new DatastoreException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound) {\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\ttry{\n+\t\t\t//update etag\n+\t\t\tString newEtag = lockAndGenerateEtag(dbo.getId().toString(), dbo.getEtag(),\n+\t\t\t\t\tTABLE_EVALUATION_ROUND, COL_EVALUATION_ROUND_ETAG, EvaluationRound.class);\n+\t\t\tdbo.setEtag(newEtag);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\n+\t\t// create DBO\n+\t\tif( ! basicDao.update(dbo) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void deleteEvaluationRound(String evaluationId, String evaluationRoundId) {\n+\t\tMapSqlParameterSource param = new MapSqlParameterSource();\n+\t\tparam.addValue(ID, evaluationRoundId);\n+\t\tif( ! basicDao.deleteObjectByPrimaryKey(EvaluationRoundDBO.class, param) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(String evaluationId, String evaluationRoundId) {\n \t\tMapSqlParameterSource param = new MapSqlParameterSource();\n-\t\tparam.addValue(DBOConstants.PARAM_EVALUATION_ID, id);\n+\t\tparam.addValue(ID, evaluationRoundId);\n \t\ttry {\n-\t\t\tEvaluationDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationDBO.class, param);\n-\t\t\treturn dbo;\n+\t\t\tEvaluationRoundDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationRoundDBO.class, param);\n+\t\t\tEvaluationRound dto = EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t\treturn dto;\n \t\t} catch (NotFoundException e) {\n-\t\t\tthrow new NotFoundException(EVALUATION_NOT_FOUND + id);\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));\n \t\t}\n \t}\n-\t\n-\tprivate String lockForUpdate(String id) {\n-\t\t// Create a Select for update query\n-\t\treturn jdbcTemplate.queryForObject(SQL_ETAG_FOR_UPDATE, String.class, id);\n+\n+\t@Override\n+\tpublic List<EvaluationRound> getAssociatedEvaluationRounds(String evaluationId, long limit, long offset) {\n+\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID, evaluationId);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_LIMIT, limit);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_OFFSET, offset);\n+\n+\n+\t\treturn namedJdbcTemplate.query(SELECT_ALL_ROUNDS_FOR_EVALUATION, sqlParameterSource, (ResultSet resultSet, int rowNumber) ->{\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(EVALUATION_ROUND_ROW_MAPPER.mapRow(resultSet, rowNumber));\n+\t\t});\n \t}\n \n+\t@Override\n+\tpublic Optional<EvaluationRound> getEvaluationRoundForTimestamp(String evaluationId, Instant timestamp) {\n+\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID, evaluationId);\n+\t\tsqlParameterSource.addValue(PARAM_BETWEEN_DATE, timestamp.toEpochMilli());\n+\n+\t\ttry {\n+\t\t\treturn namedJdbcTemplate.queryForObject(SELECT_ROUND_BETWEEN_RANGE, sqlParameterSource,\n+\t\t\t\t\t(ResultSet resultSet, int rowNumber) -> {\n+\t\t\t\t\t\treturn Optional.of(EvaluationRoundDBOUtil.toDTO(EVALUATION_ROUND_ROW_MAPPER.mapRow(resultSet, rowNumber)));\n+\t\t\t\t\t}\n+\t\t\t);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic boolean hasEvaluationRounds(String evaluationId){\n+\t\treturn jdbcTemplate.queryForObject(\"SELECT COUNT(*) > 0 FROM \" + TABLE_EVALUATION_ROUND +\n+\t\t\t\t\t\t\" WHERE \" + COL_EVALUATION_ROUND_EVALUATION_ID +\" = ? \",\n+\t\t\t\tnew Object[]{evaluationId} ,", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4Mjc5NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485982794", "bodyText": "<> rather than !=??", "author": "marcomarasca", "createdAt": "2020-09-09T23:50:59Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImpl.java", "diffHunk": "@@ -273,35 +296,135 @@ public String lookupByName(String name) throws DatastoreException {\n \t}\n \n \n-\tprivate String lockAndGenerateEtag(String id, String eTag, ChangeType changeType)\n+\tprivate String lockAndGenerateEtag(String id, String eTag, String tableName, String etagColName, Class<?> clazz)\n \t\t\tthrows NotFoundException, ConflictingUpdateException, DatastoreException {\n-\t\tString currentTag = lockForUpdate(id);\n+\t\t// Create a Select for update query\n+\t\tString sql = String.format(SQL_ETAG_FOR_UPDATE_FORMAT, etagColName, tableName);\n+\t\tString currentTag = jdbcTemplate.queryForObject(sql, String.class, id);\n \t\t// Check the eTags\n \t\tif(!currentTag.equals(eTag)){\n-\t\t\tthrow new ConflictingUpdateException(\"Evaluation: \" + id + \" has been updated since \" +\n+\t\t\tthrow new ConflictingUpdateException(clazz.getSimpleName() + \": \" + id + \" has been updated since \" +\n \t\t\t\t\t\"you last fetched it; please retrieve it again and re-apply the update\");\n \t\t}\n-\t\t// Get a new e-tag\n-\t\tEvaluationDBO dbo = getDBO(id);\n-\t\tdbo.seteTag(UUID.randomUUID().toString());\n-\t\treturn dbo.getEtag();\n+\t\t// Generate a new e-tag\n+\t\treturn UUID.randomUUID().toString();\n \t}\n-\t\n-\tprivate EvaluationDBO getDBO(String id) throws NotFoundException {\n-\t\tEvaluationUtils.ensureNotNull(id, \"Evaluation id\");\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound evaluationRound){\n+\t\t//generate initial etag\n+\t\tevaluationRound.setEtag(UUID.randomUUID().toString());\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\t// create DBO\n+\t\ttry {\n+\t\t\tdbo = basicDao.createNew(dbo);\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new DatastoreException(e);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void updateEvaluationRound(EvaluationRound evaluationRound) {\n+\t\tEvaluationRoundDBO dbo = EvaluationRoundDBOUtil.toDBO(evaluationRound);\n+\n+\t\ttry{\n+\t\t\t//update etag\n+\t\t\tString newEtag = lockAndGenerateEtag(dbo.getId().toString(), dbo.getEtag(),\n+\t\t\t\t\tTABLE_EVALUATION_ROUND, COL_EVALUATION_ROUND_ETAG, EvaluationRound.class);\n+\t\t\tdbo.setEtag(newEtag);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\n+\t\t// create DBO\n+\t\tif( ! basicDao.update(dbo) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRound.getId(), evaluationRound.getEvaluationId()));\n+\t\t}\n+\n+\t}\n+\n+\t@Override\n+\t@WriteTransaction\n+\tpublic void deleteEvaluationRound(String evaluationId, String evaluationRoundId) {\n+\t\tMapSqlParameterSource param = new MapSqlParameterSource();\n+\t\tparam.addValue(ID, evaluationRoundId);\n+\t\tif( ! basicDao.deleteObjectByPrimaryKey(EvaluationRoundDBO.class, param) ){\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(String evaluationId, String evaluationRoundId) {\n \t\tMapSqlParameterSource param = new MapSqlParameterSource();\n-\t\tparam.addValue(DBOConstants.PARAM_EVALUATION_ID, id);\n+\t\tparam.addValue(ID, evaluationRoundId);\n \t\ttry {\n-\t\t\tEvaluationDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationDBO.class, param);\n-\t\t\treturn dbo;\n+\t\t\tEvaluationRoundDBO dbo = basicDao.getObjectByPrimaryKey(EvaluationRoundDBO.class, param);\n+\t\t\tEvaluationRound dto = EvaluationRoundDBOUtil.toDTO(dbo);\n+\t\t\treturn dto;\n \t\t} catch (NotFoundException e) {\n-\t\t\tthrow new NotFoundException(EVALUATION_NOT_FOUND + id);\n+\t\t\tthrow new NotFoundException(String.format(EVALUATION_ROUND_NOT_FOUND_FORMAT, evaluationRoundId, evaluationId));\n \t\t}\n \t}\n-\t\n-\tprivate String lockForUpdate(String id) {\n-\t\t// Create a Select for update query\n-\t\treturn jdbcTemplate.queryForObject(SQL_ETAG_FOR_UPDATE, String.class, id);\n+\n+\t@Override\n+\tpublic List<EvaluationRound> getAssociatedEvaluationRounds(String evaluationId, long limit, long offset) {\n+\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID, evaluationId);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_LIMIT, limit);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_OFFSET, offset);\n+\n+\n+\t\treturn namedJdbcTemplate.query(SELECT_ALL_ROUNDS_FOR_EVALUATION, sqlParameterSource, (ResultSet resultSet, int rowNumber) ->{\n+\t\t\treturn EvaluationRoundDBOUtil.toDTO(EVALUATION_ROUND_ROW_MAPPER.mapRow(resultSet, rowNumber));\n+\t\t});\n \t}\n \n+\t@Override\n+\tpublic Optional<EvaluationRound> getEvaluationRoundForTimestamp(String evaluationId, Instant timestamp) {\n+\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID, evaluationId);\n+\t\tsqlParameterSource.addValue(PARAM_BETWEEN_DATE, timestamp.toEpochMilli());\n+\n+\t\ttry {\n+\t\t\treturn namedJdbcTemplate.queryForObject(SELECT_ROUND_BETWEEN_RANGE, sqlParameterSource,\n+\t\t\t\t\t(ResultSet resultSet, int rowNumber) -> {\n+\t\t\t\t\t\treturn Optional.of(EvaluationRoundDBOUtil.toDTO(EVALUATION_ROUND_ROW_MAPPER.mapRow(resultSet, rowNumber)));\n+\t\t\t\t\t}\n+\t\t\t);\n+\t\t} catch (EmptyResultDataAccessException e){\n+\t\t\treturn Optional.empty();\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic boolean hasEvaluationRounds(String evaluationId){\n+\t\treturn jdbcTemplate.queryForObject(\"SELECT COUNT(*) > 0 FROM \" + TABLE_EVALUATION_ROUND +\n+\t\t\t\t\t\t\" WHERE \" + COL_EVALUATION_ROUND_EVALUATION_ID +\" = ? \",\n+\t\t\t\tnew Object[]{evaluationId} ,\n+\t\t\t\tBoolean.class);\n+\t}\n+\n+\t@Override\n+\tpublic List<EvaluationRound> overlappingEvaluationRounds(String evaluationId, String currentRoundId, Instant startTimestamp, Instant endTimestamp) {\n+\t\tMapSqlParameterSource sqlParameterSource = new MapSqlParameterSource();\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID, evaluationId);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_ID, currentRoundId);\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START, startTimestamp.toEpochMilli());\n+\t\tsqlParameterSource.addValue(DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END, endTimestamp.toEpochMilli());\n+\n+\t\treturn namedJdbcTemplate.query(\"SELECT * FROM \" + TABLE_EVALUATION_ROUND +\n+\t\t\t\t\" WHERE \" + COL_EVALUATION_ROUND_EVALUATION_ID + \"= :\" + DBOConstants.PARAM_EVALUATION_ROUND_EVALUATION_ID +\n+\t\t\t\t\" AND \"+ COL_EVALUATION_ROUND_ROUND_END + \" > :\" + DBOConstants.PARAM_EVALUATION_ROUND_ROUND_START +\n+\t\t\t\t\" AND \" + COL_EVALUATION_ROUND_ROUND_START + \" < :\" + DBOConstants.PARAM_EVALUATION_ROUND_ROUND_END +\n+\t\t\t\t\" AND \" + COL_EVALUATION_ROUND_ID + \"!= :\" + DBOConstants.PARAM_EVALUATION_ROUND_ID, sqlParameterSource,", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MzIwOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485983208", "bodyText": "You might want to use a fixed time", "author": "marcomarasca", "createdAt": "2020-09-09T23:52:28Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImplTest.java", "diffHunk": "@@ -83,10 +95,28 @@ private static Evaluation newEvaluation(String id, String name, String contentSo\n \tpublic void setUp() throws Exception {\n \t\ttoDelete = new ArrayList<String>();\n \t\t// Initialize Evaluation\n-\t\teval = newEvaluation(\"123\", EVALUATION_NAME, EVALUATION_CONTENT_SOURCE, EvaluationStatus.PLANNED);\n+\t\tevaluationId = \"123\";\n+\t\teval = newEvaluation(evaluationId, EVALUATION_NAME, EVALUATION_CONTENT_SOURCE, EvaluationStatus.PLANNED);\n \t\taclToDelete = null;\n \t\tfutureTime = System.currentTimeMillis()+60000L*1000L; // 1000 minutes in the future\n-\t}\n+\n+\t\tevaluationRound = new EvaluationRound();\n+\t\tevaluationRoundId = \"123455\";\n+\t\tevaluationRound.setId(evaluationRoundId);\n+\t\tevalRoundStart = Instant.now();", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NDQyNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485984425", "bodyText": "You can assertEquals on the list of Arrays.asList(createdRound, createdRound2)", "author": "marcomarasca", "createdAt": "2020-09-09T23:56:50Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImplTest.java", "diffHunk": "@@ -301,112 +331,306 @@ public void testGetAvailable() throws DatastoreException, NotFoundException {\n \t\tString aclId = aclDAO.create(acl, ObjectType.EVALUATION);\n \t\tacl.setId(aclId);\n \t\taclToDelete = acl;\n-\t\t\n+\n \t\t// As a participant, I can find:\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// make sure time filter works\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withTimeFilter(System.currentTimeMillis());\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// the evaluation is omitted if the challenge is over:\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withTimeFilter(futureTime);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n-\t\tassertTrue(evalList.isEmpty());\t\t\n-\t\t\n+\t\tassertTrue(evalList.isEmpty());\n+\n \t\t// make sure filter works\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// filtering with 'eval 2' causes no results to come back\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId2)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(0, evalList.size());\n-\t\t\n+\n \t\t// non-participants  cannot find\n \t\tfilter = new EvaluationFilter(ImmutableSet.of(110L, 111L), ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertTrue(evalList.isEmpty());\n-\t\t\n+\n \t\t// PLFM-2312 problem with repeated entries\n \t\tResourceAccess ra = new ResourceAccess();\n \t\tra.setPrincipalId(BOOTSTRAP_PRINCIPAL.AUTHENTICATED_USERS_GROUP.getPrincipalId());\n \t\tra.setAccessType(new HashSet<ACCESS_TYPE>(Arrays.asList(new ACCESS_TYPE[]{ACCESS_TYPE.SUBMIT})));\n \t\tSet<ResourceAccess> ras = acl.getResourceAccess();\n \t\tras.add(ra);\n \t\taclDAO.update(acl, ObjectType.EVALUATION);\n-\t\t\n+\n \t\t// should still find just one result, even though I'm in the ACL twice\n \t\tpids = ImmutableSet.of(participantId, BOOTSTRAP_PRINCIPAL.AUTHENTICATED_USERS_GROUP.getPrincipalId());\n-\t\t\n+\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n-\t\tassertEquals(eval, evalList.get(0));\t\t\n-\t\t\n+\t\tassertEquals(eval, evalList.get(0));\n+\n \t\t// Note:  The evaluation isn't returned for the wrong access type\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.READ);\n-\t\t\n+\n \t\tassertTrue(evaluationDAO.getAccessibleEvaluations(filter, 10, 0).isEmpty());\n    }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluations() {\n-    \t\n+\n     \tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n \n \t\ttoDelete.add(evalId);\n-    \t\n+\n \t\tLong evaluationId = Long.valueOf(evalId);\n     \tList<Long> ids = ImmutableList.of(evaluationId, 100L, 200L, 300L);\n-    \t\n+\n     \tSet<Long> result = evaluationDAO.getAvailableEvaluations(ids);\n-   \n+\n     \tassertEquals(ImmutableSet.of(evaluationId), result);\n     }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluationsWithEmptyInput() {\n-    \t\n+\n     \tList<Long> ids = Collections.emptyList();\n-    \t\n+\n     \tSet<Long> result = evaluationDAO.getAvailableEvaluations(ids);\n-    \t   \n+\n     \tassertEquals(Collections.emptySet(), result);\n-   \n+\n     }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluationsWithNullInput() {\n-    \t\n+\n     \tList<Long> ids = null;\n-    \t\n+\n     \tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n     \t\t// Call under test\n     \t\tevaluationDAO.getAvailableEvaluations(ids);\n     \t}).getMessage();\n-    \t\n+\n     \tassertEquals(\"ids is required.\", errorMessage);\n-   \n+\n+    }\n+\n+    @Test\n+\tpublic void testUpdatEvaluationRound_notFound(){\n+    \tevaluationRound.setEtag(\"asdfasdfasdf\");\n+    \t//attempt update w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, () -> {\n+\t\t\tevaluationDAO.updateEvaluationRound(evaluationRound);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testDeleteEvaluationRound_notFound(){\n+\t\t//attempt delete w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, ()-> {\n+\t\t\tevaluationDAO.deleteEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testGetEvaluationRound_notFound(){\n+\t\t//attempt update w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, ()-> {\n+\t\t\tevaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testEvaluationRound_CRUD(){\n+\t\tassertNull(evaluationRound.getEtag());\n+\t\tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n+\t\ttoDelete.add(evalId);\n+\n+\t\t//Test CREATE\n+\t\tEvaluationRound createdEvaluationRound = evaluationDAO.createEvaluationRound(evaluationRound);\n+\n+\t\t//verify that an etag was assigned\n+\t\tassertNotNull(evaluationRound.getEtag());\n+\n+\t\t//if we copy over the etag, everything else should be equivalent\n+\t\tevaluationRound.setEtag(createdEvaluationRound.getEtag());\n+\t\tassertEquals(evaluationRound, createdEvaluationRound);\n+\n+\t\t//Test UPDATE and GET\n+\t\t// Change the end date\n+\t\tcreatedEvaluationRound.setRoundEnd(Date.from(evalRoundEnd.plus(42, ChronoUnit.DAYS)));\n+\t\tevaluationDAO.updateEvaluationRound(createdEvaluationRound);\n+\t\tEvaluationRound updated = evaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\n+\t\t//if we copy over the etag, everything else should be equivalent\n+\t\tcreatedEvaluationRound.setEtag(updated.getEtag());\n+\t\tassertEquals(createdEvaluationRound, updated);\n+\n+\t\t//Test DELETE and GET\n+\t\tevaluationDAO.deleteEvaluationRound(evaluationId, evaluationRoundId);\n+\t\tString errorMessage = assertThrows(NotFoundException.class, () -> {\n+\t\t\tevaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\n+\t@Test\n+\tpublic void getAssociatedEvaluationRounds(){\n+\t\tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n+\t\ttoDelete.add(evalId);\n+\n+    \tlong evaluationRound2Id = 1122334455L;\n+\t\tEvaluationRound evaluationRound2 = new EvaluationRound();\n+\t\tevaluationRound2.setId(Long.toString(evaluationRound2Id));\n+\t\tevaluationRound2.setEvaluationId(evaluationId);\n+\t\tInstant evaluationRound2Start = Instant.now().plus(4, ChronoUnit.DAYS);\n+\t\tInstant evaluationRound2End = evaluationRound2Start.plus(42, ChronoUnit.DAYS);\n+\t\tevaluationRound2.setRoundStart(Date.from(evaluationRound2Start));\n+\t\tevaluationRound2.setRoundEnd(Date.from(evaluationRound2End));\n+\n+\t\tEvaluationRound createdRound = evaluationDAO.createEvaluationRound(evaluationRound);\n+\t\tEvaluationRound createdRound2 = evaluationDAO.createEvaluationRound(evaluationRound2);\n+\n+\t\tlong limit = 5;\n+\t\tlong offset = 0;\n+\t\t//method under test\n+\t\tList<EvaluationRound> rounds = evaluationDAO.getAssociatedEvaluationRounds(evaluationId, limit, offset);\n+\t\tassertEquals(2, rounds.size());\n+\t\tassertEquals(createdRound, rounds.get(0));", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4NTM0Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485985346", "bodyText": "-> nonExistentEvaluationId", "author": "marcomarasca", "createdAt": "2020-09-09T23:59:46Z", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/EvaluationDAOImplTest.java", "diffHunk": "@@ -301,112 +331,306 @@ public void testGetAvailable() throws DatastoreException, NotFoundException {\n \t\tString aclId = aclDAO.create(acl, ObjectType.EVALUATION);\n \t\tacl.setId(aclId);\n \t\taclToDelete = acl;\n-\t\t\n+\n \t\t// As a participant, I can find:\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// make sure time filter works\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withTimeFilter(System.currentTimeMillis());\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// the evaluation is omitted if the challenge is over:\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withTimeFilter(futureTime);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n-\t\tassertTrue(evalList.isEmpty());\t\t\n-\t\t\n+\t\tassertTrue(evalList.isEmpty());\n+\n \t\t// make sure filter works\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n \t\tassertEquals(eval, evalList.get(0));\n-\t\t\n+\n \t\t// filtering with 'eval 2' causes no results to come back\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId2)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(0, evalList.size());\n-\t\t\n+\n \t\t// non-participants  cannot find\n \t\tfilter = new EvaluationFilter(ImmutableSet.of(110L, 111L), ACCESS_TYPE.SUBMIT)\n \t\t\t\t.withIdsFilter(Arrays.asList(Long.parseLong(evalId)));\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertTrue(evalList.isEmpty());\n-\t\t\n+\n \t\t// PLFM-2312 problem with repeated entries\n \t\tResourceAccess ra = new ResourceAccess();\n \t\tra.setPrincipalId(BOOTSTRAP_PRINCIPAL.AUTHENTICATED_USERS_GROUP.getPrincipalId());\n \t\tra.setAccessType(new HashSet<ACCESS_TYPE>(Arrays.asList(new ACCESS_TYPE[]{ACCESS_TYPE.SUBMIT})));\n \t\tSet<ResourceAccess> ras = acl.getResourceAccess();\n \t\tras.add(ra);\n \t\taclDAO.update(acl, ObjectType.EVALUATION);\n-\t\t\n+\n \t\t// should still find just one result, even though I'm in the ACL twice\n \t\tpids = ImmutableSet.of(participantId, BOOTSTRAP_PRINCIPAL.AUTHENTICATED_USERS_GROUP.getPrincipalId());\n-\t\t\n+\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.SUBMIT);\n-\t\t\n+\n \t\tevalList = evaluationDAO.getAccessibleEvaluations(filter, 10, 0);\n \t\tassertEquals(1, evalList.size());\n-\t\tassertEquals(eval, evalList.get(0));\t\t\n-\t\t\n+\t\tassertEquals(eval, evalList.get(0));\n+\n \t\t// Note:  The evaluation isn't returned for the wrong access type\n \t\tfilter = new EvaluationFilter(pids, ACCESS_TYPE.READ);\n-\t\t\n+\n \t\tassertTrue(evaluationDAO.getAccessibleEvaluations(filter, 10, 0).isEmpty());\n    }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluations() {\n-    \t\n+\n     \tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n \n \t\ttoDelete.add(evalId);\n-    \t\n+\n \t\tLong evaluationId = Long.valueOf(evalId);\n     \tList<Long> ids = ImmutableList.of(evaluationId, 100L, 200L, 300L);\n-    \t\n+\n     \tSet<Long> result = evaluationDAO.getAvailableEvaluations(ids);\n-   \n+\n     \tassertEquals(ImmutableSet.of(evaluationId), result);\n     }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluationsWithEmptyInput() {\n-    \t\n+\n     \tList<Long> ids = Collections.emptyList();\n-    \t\n+\n     \tSet<Long> result = evaluationDAO.getAvailableEvaluations(ids);\n-    \t   \n+\n     \tassertEquals(Collections.emptySet(), result);\n-   \n+\n     }\n-    \n+\n     @Test\n     public void testGetAvailableEvaluationsWithNullInput() {\n-    \t\n+\n     \tList<Long> ids = null;\n-    \t\n+\n     \tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n     \t\t// Call under test\n     \t\tevaluationDAO.getAvailableEvaluations(ids);\n     \t}).getMessage();\n-    \t\n+\n     \tassertEquals(\"ids is required.\", errorMessage);\n-   \n+\n+    }\n+\n+    @Test\n+\tpublic void testUpdatEvaluationRound_notFound(){\n+    \tevaluationRound.setEtag(\"asdfasdfasdf\");\n+    \t//attempt update w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, () -> {\n+\t\t\tevaluationDAO.updateEvaluationRound(evaluationRound);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testDeleteEvaluationRound_notFound(){\n+\t\t//attempt delete w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, ()-> {\n+\t\t\tevaluationDAO.deleteEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testGetEvaluationRound_notFound(){\n+\t\t//attempt update w/out creating\n+\t\tString errorMessage = assertThrows(NotFoundException.class, ()-> {\n+\t\t\tevaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\t@Test\n+\tpublic void testEvaluationRound_CRUD(){\n+\t\tassertNull(evaluationRound.getEtag());\n+\t\tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n+\t\ttoDelete.add(evalId);\n+\n+\t\t//Test CREATE\n+\t\tEvaluationRound createdEvaluationRound = evaluationDAO.createEvaluationRound(evaluationRound);\n+\n+\t\t//verify that an etag was assigned\n+\t\tassertNotNull(evaluationRound.getEtag());\n+\n+\t\t//if we copy over the etag, everything else should be equivalent\n+\t\tevaluationRound.setEtag(createdEvaluationRound.getEtag());\n+\t\tassertEquals(evaluationRound, createdEvaluationRound);\n+\n+\t\t//Test UPDATE and GET\n+\t\t// Change the end date\n+\t\tcreatedEvaluationRound.setRoundEnd(Date.from(evalRoundEnd.plus(42, ChronoUnit.DAYS)));\n+\t\tevaluationDAO.updateEvaluationRound(createdEvaluationRound);\n+\t\tEvaluationRound updated = evaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\n+\t\t//if we copy over the etag, everything else should be equivalent\n+\t\tcreatedEvaluationRound.setEtag(updated.getEtag());\n+\t\tassertEquals(createdEvaluationRound, updated);\n+\n+\t\t//Test DELETE and GET\n+\t\tevaluationDAO.deleteEvaluationRound(evaluationId, evaluationRoundId);\n+\t\tString errorMessage = assertThrows(NotFoundException.class, () -> {\n+\t\t\tevaluationDAO.getEvaluationRound(evaluationId, evaluationRoundId);\n+\t\t}).getMessage();\n+\n+\t\tassertEquals(\"Evaluation Round with id=123455, belonging to Evaluation id=123, could not be found.\", errorMessage);\n+\t}\n+\n+\n+\t@Test\n+\tpublic void getAssociatedEvaluationRounds(){\n+\t\tString evalId = evaluationDAO.create(eval, EVALUATION_OWNER_ID);\n+\t\ttoDelete.add(evalId);\n+\n+    \tlong evaluationRound2Id = 1122334455L;\n+\t\tEvaluationRound evaluationRound2 = new EvaluationRound();\n+\t\tevaluationRound2.setId(Long.toString(evaluationRound2Id));\n+\t\tevaluationRound2.setEvaluationId(evaluationId);\n+\t\tInstant evaluationRound2Start = Instant.now().plus(4, ChronoUnit.DAYS);\n+\t\tInstant evaluationRound2End = evaluationRound2Start.plus(42, ChronoUnit.DAYS);\n+\t\tevaluationRound2.setRoundStart(Date.from(evaluationRound2Start));\n+\t\tevaluationRound2.setRoundEnd(Date.from(evaluationRound2End));\n+\n+\t\tEvaluationRound createdRound = evaluationDAO.createEvaluationRound(evaluationRound);\n+\t\tEvaluationRound createdRound2 = evaluationDAO.createEvaluationRound(evaluationRound2);\n+\n+\t\tlong limit = 5;\n+\t\tlong offset = 0;\n+\t\t//method under test\n+\t\tList<EvaluationRound> rounds = evaluationDAO.getAssociatedEvaluationRounds(evaluationId, limit, offset);\n+\t\tassertEquals(2, rounds.size());\n+\t\tassertEquals(createdRound, rounds.get(0));\n+\t\tassertEquals(createdRound2, rounds.get(1));\n+\n+\t\tlimit = 5;\n+\t\toffset = 1;\n+\t\t//method under test\n+\t\trounds = evaluationDAO.getAssociatedEvaluationRounds(evaluationId, limit, offset);\n+\t\tassertEquals(1, rounds.size());\n+\t\tassertEquals(createdRound2, rounds.get(0));\n+\n+\t\tlimit = 1;\n+\t\toffset = 0;\n+\t\t//method under test\n+\t\trounds = evaluationDAO.getAssociatedEvaluationRounds(evaluationId, limit, offset);\n+\t\tassertEquals(1, rounds.size());\n+\t\tassertEquals(createdRound, rounds.get(0));\n+\n+\t\t//for a evaluation id that does not exist\n+\t\t//method under test\n+\t\tString nonExistentRoundId = \"9999999999\";", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4OTQ3Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485989477", "bodyText": "Let us remove this as it seems to introduce complexity for a problem that can be solved client side.", "author": "marcomarasca", "createdAt": "2020-09-10T00:15:11Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/evaluation/manager/EvaluationManagerImpl.java", "diffHunk": "@@ -49,9 +60,16 @@\n \t@Autowired\n \tprivate EvaluationSubmissionsDAO evaluationSubmissionsDAO;\n \n+\t@Autowired\n+\tprivate SubmissionDAO submissionDAO;\n+\n \t@Autowired\n \tprivate SubmissionEligibilityManager submissionEligibilityManager;\n \n+\tstatic final String NON_EXISTENT_ROUND_ID = \"-1\";\n+\t//used to provide some leeway in allowed time window for updating/deleting a EvaluationRound\n+\tstatic final Duration ONE_SECOND = Duration.ofSeconds(1);", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5MjEzNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485992134", "bodyText": "Try to maintain the same conventions", "author": "marcomarasca", "createdAt": "2020-09-10T00:24:44Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/EvaluationManagerTest.java", "diffHunk": "@@ -285,20 +311,88 @@ public void testUpdateEvaluationAsOwner() throws DatastoreException, InvalidMode\n \n \t\tevaluationManager.updateEvaluation(ownerInfo, evalWithId);\n \t\tverify(mockEvaluationDAO).update(eq(evalWithId));\n+\t\t//no 'quota' field, so we skip this check\n+\t\tverify(mockEvaluationDAO, never()).hasEvaluationRounds(evalWithId.getId());\n+\t}\n+\n+\t@Test\n+\tpublic void updateEvaluationAsOwner__QuotaDefined_hasEvaluationRounds() throws DatastoreException, InvalidModelException, ConflictingUpdateException, NotFoundException, UnauthorizedException {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5MjYyMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485992623", "bodyText": "Might want to add a check on the error message", "author": "marcomarasca", "createdAt": "2020-09-10T00:26:38Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/EvaluationManagerTest.java", "diffHunk": "@@ -285,20 +311,88 @@ public void testUpdateEvaluationAsOwner() throws DatastoreException, InvalidMode\n \n \t\tevaluationManager.updateEvaluation(ownerInfo, evalWithId);\n \t\tverify(mockEvaluationDAO).update(eq(evalWithId));\n+\t\t//no 'quota' field, so we skip this check\n+\t\tverify(mockEvaluationDAO, never()).hasEvaluationRounds(evalWithId.getId());\n+\t}\n+\n+\t@Test\n+\tpublic void updateEvaluationAsOwner__QuotaDefined_hasEvaluationRounds() throws DatastoreException, InvalidModelException, ConflictingUpdateException, NotFoundException, UnauthorizedException {\n+\t\twhen(mockEvaluationDAO.get(eq(EVALUATION_ID))).thenReturn(evalWithId);\n+\n+\t\tevaluations= Collections.singletonList(evalWithId);\n+\t\twhen(mockPermissionsManager.hasAccess(eq(ownerInfo), any(), eq(ACCESS_TYPE.UPDATE))).thenReturn(AuthorizationStatus.authorized());\n+\n+\t\tassertNotNull(evalWithId.getCreatedOn());\n+\n+\t\t//an evaluation round was defined\n+\t\twhen(mockEvaluationDAO.hasEvaluationRounds(EVALUATION_ID)).thenReturn(true);\n+\t\t//quota set\n+\t\tevalWithId.setQuota(new SubmissionQuota());\n+\n+\t\tassertThrows(IllegalArgumentException.class, () ->{\n+\t\t\tevaluationManager.updateEvaluation(ownerInfo, evalWithId);\n+\t\t});", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5NjE0MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r485996140", "bodyText": "You should probably extract this in its own method and test in isolation", "author": "marcomarasca", "createdAt": "2020-09-10T00:39:12Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerImpl.java", "diffHunk": "@@ -114,17 +123,33 @@ public TeamSubmissionEligibility getTeamSubmissionEligibility(Evaluation evaluat\n \t\t\tchallenge=null;\n \t\t\tteamEligibility.setIsRegistered(null);\n \t\t}\n-\t\tisTeamEligible &= (teamEligibility.getIsRegistered()==null || teamEligibility.getIsRegistered());\n+\t\tboolean isTeamEligible = (teamEligibility.getIsRegistered()==null || teamEligibility.getIsRegistered());\n \t\t\n \t\t// now check whether the Team's quota is filled\n-\t\tDate now = new Date();\n-\t\tPair<Date,Date> roundInterval = SubmissionQuotaUtil.getRoundInterval(evaluation, now);\n-\t\tint submissionCount = (int)submissionDAO.countSubmissionsByTeam(Long.parseLong(evaluation.getId()), \n-\t\t\t\tLong.parseLong(teamId), roundInterval.getFirst(), \n-\t\t\t\troundInterval.getSecond(), STATUSES_COUNTED_TOWARD_QUOTA);\n-\t\tInteger submissionLimit = SubmissionQuotaUtil.getSubmissionQuota(evaluation);\n-\t\tteamEligibility.setIsQuotaFilled(submissionLimit!=null && submissionCount>=submissionLimit);\n-\t\tisTeamEligible &= !teamEligibility.getIsQuotaFilled();\n+\t\t//convert SubmissionQuota into EvaluationRound or lazily retrieve a defined EvaluationRound\n+\t\tEvaluationRound currentRound = (evaluationDAO.hasEvaluationRounds(evaluation.getId()) ?", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwMDI5OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486000299", "bodyText": "See above, extract the logic to its own method", "author": "marcomarasca", "createdAt": "2020-09-10T00:54:47Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerImpl.java", "diffHunk": "@@ -200,7 +230,12 @@ public TeamSubmissionEligibility getTeamSubmissionEligibility(Evaluation evaluat\n \tpublic AuthorizationStatus isTeamEligible(String evalId, String teamId, \n \t\t\tList<String> contributors, String submissionEligibilityHashString, Date now) throws DatastoreException, NotFoundException {\n \t\tEvaluation evaluation = evaluationDAO.get(evalId);\n-\t\tif (!SubmissionQuotaUtil.isSubmissionAllowed(evaluation, now)) {\n+\t\t//convert SubmissionQuota into EvaluationRound or lazily retrieve a defined EvaluationRound\n+\n+\t\tOptional<EvaluationRound> currentRound = evaluationDAO.hasEvaluationRounds(evalId) ?", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNTU5Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486005592", "bodyText": "andHASEvaluationRound", "author": "marcomarasca", "createdAt": "2020-09-10T01:14:54Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerTest.java", "diffHunk": "@@ -255,25 +410,40 @@ public void testGetTeamSubmissionEligibilityNoQuota() throws Exception {\n \t\tassertFalse(mse.getHasConflictingSubmission());\n \t\tassertTrue(mse.getIsEligible());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testGetTeamSubmissionEligibilityNoQuotaNoEvaluationRound() throws Exception {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486006401", "bodyText": "weekly limit", "author": "marcomarasca", "createdAt": "2020-09-10T01:18:00Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerTest.java", "diffHunk": "@@ -355,23 +525,151 @@ public void testGetTeamSubmissionEligibilityQuotaFilled() throws Exception {\n \t\tassertFalse(mse.getHasConflictingSubmission());\n \t\tassertFalse(mse.getIsEligible());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testGetTeamSubmissionEligibility_MultipleSubmissionLimits_exceededOneLimit() throws Exception {\n+\t\t// team is registered\n+\t\twhen(mockChallengeTeamDAO.isTeamRegistered(\n+\t\t\t\tLong.parseLong(CHALLENGE_ID),\n+\t\t\t\tLong.parseLong(SUBMITTING_TEAM_ID))).\n+\t\t\t\tthenReturn(true);\n+\t\t// add a user to submitting team\n+\t\tsubmittingTeamMembers.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\t\t// user is registered for challenge\n+\t\tchallengeParticipants.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\n+\t\tevaluation.setQuota(null);\n+\t\tevaluationRound.setLimits(Arrays.asList(dailyLimit, weeklyLimit, monthlyLimit));\n+\t\twhen(mockEvaluationDAO.hasEvaluationRounds(EVAL_ID)).thenReturn(true);\n+\t\twhen(mockEvaluationDAO.getEvaluationRoundForTimestamp(eq(EVAL_ID), any(Instant.class))).thenReturn(Optional.of(evaluationRound));\n+\n+\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(dailyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(dailyLimitCount);\n+\t\t//exceeds the monthly limit", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjU5OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486006598", "bodyText": "Call under test", "author": "marcomarasca", "createdAt": "2020-09-10T01:18:51Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerTest.java", "diffHunk": "@@ -355,23 +525,151 @@ public void testGetTeamSubmissionEligibilityQuotaFilled() throws Exception {\n \t\tassertFalse(mse.getHasConflictingSubmission());\n \t\tassertFalse(mse.getIsEligible());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testGetTeamSubmissionEligibility_MultipleSubmissionLimits_exceededOneLimit() throws Exception {\n+\t\t// team is registered\n+\t\twhen(mockChallengeTeamDAO.isTeamRegistered(\n+\t\t\t\tLong.parseLong(CHALLENGE_ID),\n+\t\t\t\tLong.parseLong(SUBMITTING_TEAM_ID))).\n+\t\t\t\tthenReturn(true);\n+\t\t// add a user to submitting team\n+\t\tsubmittingTeamMembers.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\t\t// user is registered for challenge\n+\t\tchallengeParticipants.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\n+\t\tevaluation.setQuota(null);\n+\t\tevaluationRound.setLimits(Arrays.asList(dailyLimit, weeklyLimit, monthlyLimit));\n+\t\twhen(mockEvaluationDAO.hasEvaluationRounds(EVAL_ID)).thenReturn(true);\n+\t\twhen(mockEvaluationDAO.getEvaluationRoundForTimestamp(eq(EVAL_ID), any(Instant.class))).thenReturn(Optional.of(evaluationRound));\n+\n+\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(dailyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(dailyLimitCount);\n+\t\t//exceeds the monthly limit\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(weeklyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(weeklyLimitCount + 1);\n+\n+\t\tMap<Long,Long> dailyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), dailyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tdailyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(dailyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> weeklyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), weeklyLimitCount + 1);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tweeklyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(weeklyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> monthlyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), monthlyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tmonthlyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(monthlyMemberSubmissionCounts);\n+\n+\t\tTeamSubmissionEligibility tse = submissionEligibilityManager.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNzcyNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486007725", "bodyText": "We need to add the submission round to the data stored in the submission view.", "author": "marcomarasca", "createdAt": "2020-09-10T01:23:03Z", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImpl.java", "diffHunk": "@@ -868,6 +870,19 @@ public void truncateAll() {\n \t\tjdbcTemplate.update(\"DELETE FROM \" + TABLE_SUBMISSION);\n \t\tjdbcTemplate.update(\"DELETE FROM \" + TABLE_EVALUATION);\n \t}\n+\n+\t@Override\n+\tpublic boolean hasSubmissionForEvaluationRound(String evalId, String evalRoundId){\n+\t\tMapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+\t\tparameterSource.addValue(DBOConstants.PARAM_SUBMISSION_EVAL_ID, evalId);\n+\t\tparameterSource.addValue(DBOConstants.PARAM_SUBMISSION_EVAL_ROUND_ID, evalRoundId);\n+\n+\t\tString sql = \"SELECT COUNT(*) > 0 FROM \" + TABLE_SUBMISSION +\n+\t\t\t\t\" WHERE \" + COL_SUBMISSION_EVAL_ROUND_ID + \" = :\" + DBOConstants.PARAM_SUBMISSION_EVAL_ROUND_ID +\n+\t\t\t\t\" AND \" + COL_SUBMISSION_EVAL_ID + \" = :\" + DBOConstants.PARAM_SUBMISSION_EVAL_ID;\n+\n+\t\treturn namedJdbcTemplate.queryForObject(sql, parameterSource, Boolean.class);\n+\t}\n \t\n \tprivate static ObjectDataDTO mapSubmissionDataRow(ResultSet rs, int index, int maxAnnotationChars) throws SQLException {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxODAzNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486518034", "bodyText": "Call under test", "author": "marcomarasca", "createdAt": "2020-09-10T17:36:39Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerTest.java", "diffHunk": "@@ -355,23 +525,151 @@ public void testGetTeamSubmissionEligibilityQuotaFilled() throws Exception {\n \t\tassertFalse(mse.getHasConflictingSubmission());\n \t\tassertFalse(mse.getIsEligible());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testGetTeamSubmissionEligibility_MultipleSubmissionLimits_exceededOneLimit() throws Exception {\n+\t\t// team is registered\n+\t\twhen(mockChallengeTeamDAO.isTeamRegistered(\n+\t\t\t\tLong.parseLong(CHALLENGE_ID),\n+\t\t\t\tLong.parseLong(SUBMITTING_TEAM_ID))).\n+\t\t\t\tthenReturn(true);\n+\t\t// add a user to submitting team\n+\t\tsubmittingTeamMembers.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\t\t// user is registered for challenge\n+\t\tchallengeParticipants.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\n+\t\tevaluation.setQuota(null);\n+\t\tevaluationRound.setLimits(Arrays.asList(dailyLimit, weeklyLimit, monthlyLimit));\n+\t\twhen(mockEvaluationDAO.hasEvaluationRounds(EVAL_ID)).thenReturn(true);\n+\t\twhen(mockEvaluationDAO.getEvaluationRoundForTimestamp(eq(EVAL_ID), any(Instant.class))).thenReturn(Optional.of(evaluationRound));\n+\n+\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(dailyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(dailyLimitCount);\n+\t\t//exceeds the monthly limit\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(weeklyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(weeklyLimitCount + 1);\n+\n+\t\tMap<Long,Long> dailyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), dailyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tdailyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(dailyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> weeklyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), weeklyLimitCount + 1);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tweeklyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(weeklyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> monthlyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), monthlyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tmonthlyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(monthlyMemberSubmissionCounts);\n+\n+\t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n+\n+\t\tassertEquals(EVAL_ID, tse.getEvaluationId());\n+\t\tassertEquals(SUBMITTING_TEAM_ID, tse.getTeamId());\n+\t\tassertNotNull(tse.getEligibilityStateHash());\n+\n+\t\tSubmissionEligibility teamEligibility = tse.getTeamEligibility();\n+\t\tassertTrue(teamEligibility.getIsRegistered());\n+\t\tassertFalse(teamEligibility.getIsEligible());\n+\t\tassertTrue(teamEligibility.getIsQuotaFilled());\n+\n+\t\tList<MemberSubmissionEligibility> membersEligibility = tse.getMembersEligibility();\n+\t\tassertEquals(1, membersEligibility.size());\n+\t\tMemberSubmissionEligibility mse = membersEligibility.get(0);\n+\t\tassertEquals(new Long(SUBMITTER_PRINCIPAL_ID), mse.getPrincipalId());\n+\t\tassertTrue(mse.getIsRegistered());\n+\t\tassertTrue(mse.getIsQuotaFilled());\n+\t\tassertFalse(mse.getHasConflictingSubmission());\n+\t\tassertFalse(mse.getIsEligible());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetTeamSubmissionEligibility_MultipleSubmissionLimits_noneExceeded() throws Exception {\n+\t\t// team is registered\n+\t\twhen(mockChallengeTeamDAO.isTeamRegistered(\n+\t\t\t\tLong.parseLong(CHALLENGE_ID),\n+\t\t\t\tLong.parseLong(SUBMITTING_TEAM_ID))).\n+\t\t\t\tthenReturn(true);\n+\t\t// add a user to submitting team\n+\t\tsubmittingTeamMembers.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\t\t// user is registered for challenge\n+\t\tchallengeParticipants.add(createUserGroup(SUBMITTER_PRINCIPAL_ID));\n+\n+\t\tevaluation.setQuota(null);\n+\t\tevaluationRound.setLimits(Arrays.asList(dailyLimit, weeklyLimit, monthlyLimit));\n+\t\twhen(mockEvaluationDAO.hasEvaluationRounds(EVAL_ID)).thenReturn(true);\n+\t\twhen(mockEvaluationDAO.getEvaluationRoundForTimestamp(eq(EVAL_ID), any(Instant.class))).thenReturn(Optional.of(evaluationRound));\n+\n+\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(dailyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(dailyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(weeklyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(weeklyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeam(eq(Long.parseLong(EVAL_ID)),eq(Long.parseLong(SUBMITTING_TEAM_ID)),\n+\t\t\t\teq(monthlyStart), eq(roundEnd),\n+\t\t\t\teq(STATUSES_COUNTED_TOWARD_QUOTA))).thenReturn(monthlyLimitCount);\n+\n+\t\tMap<Long,Long> dailyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), dailyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tdailyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(dailyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> weeklyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), weeklyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tweeklyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(weeklyMemberSubmissionCounts);\n+\n+\t\tMap<Long,Long> monthlyMemberSubmissionCounts = Collections.singletonMap(new Long(SUBMITTER_PRINCIPAL_ID), monthlyLimitCount);\n+\t\twhen(mockSubmissionDAO.countSubmissionsByTeamMembers(Long.parseLong(EVAL_ID),Long.parseLong(SUBMITTING_TEAM_ID),\n+\t\t\t\tmonthlyStart, roundEnd,\n+\t\t\t\tSTATUSES_COUNTED_TOWARD_QUOTA)).thenReturn(monthlyMemberSubmissionCounts);\n+\n+\t\tTeamSubmissionEligibility tse = submissionEligibilityManager.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxOTgxOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486519819", "bodyText": "You could loop through each month", "author": "marcomarasca", "createdAt": "2020-09-10T17:39:31Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionEligibilityManagerTest.java", "diffHunk": "@@ -381,136 +679,192 @@ public void testGetTeamSubmissionEligibilityConflictingSubmission() throws Excep\n \t\tassertTrue(mse.getHasConflictingSubmission());\n \t\tassertFalse(mse.getIsEligible());\n \t}\n-\t\n-\t\n+\n+\n \t@Test\n \tpublic void testIsTeamEligibleHappyCase() throws Exception {\n \t\tcreateValidTeamSubmissionState();\n \t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\tint tseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n-\t\t\n+\n \t\tassertTrue(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t}\n \n \t@Test\n \tpublic void testIsTeamEligibleOutsideSubmissionRange() throws Exception {\n \t\tcreateValidTeamSubmissionState();\n \t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\tint tseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\t// start with happy case\n \t\tassertTrue(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t\t// ... but if we're outside the allowed submission interval then submission isn't allowed\n \t\tlong longTimeAgo = System.currentTimeMillis()-1000000L;\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\t\t\"\"+tseHash, \n+\t\t\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\t\t\"\"+tseHash,\n \t\t\t\t\t\t\t\tnew Date(longTimeAgo)).isAuthorized());\n \t}\n \n-\t\n+\n \t@Test\n \tpublic void testIsTeamEligibleIncorrectHash() throws Exception {\n \t\tcreateValidTeamSubmissionState();\n \t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\tint tseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\t// start with happy case\n \t\tassertTrue(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t\t// but if the hash is missing then submission isn't allowed\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\tnull, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\tnull,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t\t// ditto for an incorrect hash\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"gobbldygook\", \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n-\t\t\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"gobbldygook\",\n+\t\t\t\t\t\tnow).isAuthorized());\n+\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+(tseHash+1), \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+(tseHash+1),\n+\t\t\t\t\t\tnow).isAuthorized());\n \t}\n \n \t@Test\n \tpublic void testIsTeamEligibleTeamIsIneligible() throws Exception {\n \t\tcreateValidTeamSubmissionState();\n \t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\tint tseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\t// start with happy case\n \t\tassertTrue(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t\t// ... but if the team is unregistered it is no longer eligible\n \t\twhen(mockChallengeTeamDAO.isTeamRegistered(\n-\t\t\t\tLong.parseLong(CHALLENGE_ID), \n+\t\t\t\tLong.parseLong(CHALLENGE_ID),\n \t\t\t\tLong.parseLong(SUBMITTING_TEAM_ID))).\n \t\t\tthenReturn(false);\n \t\ttse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\ttseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t}\n \n \t@Test\n \tpublic void testIsTeamEligibleMemberIsIneligible() throws Exception {\n \t\tcreateValidTeamSubmissionState();\n \t\tTeamSubmissionEligibility tse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\tint tseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\t// start with happy case\n \t\tassertTrue(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n \t\t// ... but if the contributor is unregistered she is no longer eligible\n \t\tchallengeParticipants.clear();\n \t\ttse = submissionEligibilityManager.\n-\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID);\n+\t\t\t\tgetTeamSubmissionEligibility(evaluation, SUBMITTING_TEAM_ID, now);\n \t\ttseHash = SubmissionEligibilityManagerImpl.computeTeamSubmissionEligibilityHash(tse);\n \t\tassertFalse(submissionEligibilityManager.\n-\t\t\t\tisTeamEligible(EVAL_ID, \n-\t\t\t\t\t\tSUBMITTING_TEAM_ID, \n-\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID), \n-\t\t\t\t\t\t\"\"+tseHash, \n-\t\t\t\t\t\tnew Date()).isAuthorized());\n+\t\t\t\tisTeamEligible(EVAL_ID,\n+\t\t\t\t\t\tSUBMITTING_TEAM_ID,\n+\t\t\t\t\t\tCollections.singletonList(SUBMITTER_PRINCIPAL_ID),\n+\t\t\t\t\t\t\"\"+tseHash,\n+\t\t\t\t\t\tnow).isAuthorized());\n+\t}\n+\n+\t@Test\n+\tpublic void submissionCountStartDate_TOTAL(){\n+\t\tDate start = submissionEligibilityManager.submissionCountStartDate(EvaluationRoundLimitType.TOTAL, roundStart, now);\n+\t\tassertEquals(roundStart, start);\n+\t}\n+\n+\t@Test\n+\tpublic void submissionCountStartDate_DAILY(){\n+\t\tDate now = Date.from(LocalDateTime.parse(\"2019-09-20T23:59:59\").toInstant(ZoneOffset.UTC));\n+\n+\t\tDate start = submissionEligibilityManager.submissionCountStartDate(EvaluationRoundLimitType.DAILY, roundStart, now);\n+\n+\t\tDate expected = Date.from(LocalDateTime.parse(\"2019-09-20T00:00:00\").toInstant(ZoneOffset.UTC));\n+\t\tassertEquals(expected, start);\n+\t}\n+\n+\t@Test\n+\tpublic void submissionCountStartDate_WEEKLY_CurrentTimeOnMonday(){\n+\t\t//this test ensures the previous week's monday is not returned if we are already on a monday\n+\t\tDate now = Date.from(LocalDateTime.parse(\"2019-09-16T00:00:00\").toInstant(ZoneOffset.UTC));\n+\n+\t\tDate start = submissionEligibilityManager.submissionCountStartDate(EvaluationRoundLimitType.WEEKLY, roundStart, now);\n+\n+\t\tDate expected = Date.from(LocalDateTime.parse(\"2019-09-16T00:00:00\").toInstant(ZoneOffset.UTC));\n+\t\tassertEquals(expected, start);\n+\t}\n+\n+\t@Test\n+\tpublic void submissionCountStartDate_WEEKLY_CurrentTimeNotOnMonday(){\n+\t\tDate now = Date.from(LocalDateTime.parse(\"2019-09-20T23:59:59\").toInstant(ZoneOffset.UTC));\n+\n+\t\tDate start = submissionEligibilityManager.submissionCountStartDate(EvaluationRoundLimitType.WEEKLY, roundStart, now);\n+\n+\t\tDate expected = Date.from(LocalDateTime.parse(\"2019-09-16T00:00:00\").toInstant(ZoneOffset.UTC));\n+\t\tassertEquals(expected, start);\n \t}\n \n+\t@Test\n+\tpublic void submissionCountStartDate_MONTHLY(){\n+\t\tDate now = Date.from(LocalDateTime.parse(\"2019-09-20T23:59:59\").toInstant(ZoneOffset.UTC));", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyMTYwOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486521608", "bodyText": "Before doing this we need to make sure that the client does not override the round id itself (Might want to throw if the evaluationRoundId is supplied, informing the user that it is computed by the server)", "author": "marcomarasca", "createdAt": "2020-09-10T17:42:43Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/evaluation/manager/SubmissionManagerImpl.java", "diffHunk": "@@ -183,10 +185,17 @@ public Submission createSubmission(UserInfo userInfo, Submission submission, Str\n \t\tString principalId = userInfo.getId().toString();\n \t\t\n \t\tsubmission.setUserId(principalId);\n-\t\t\n+\n+\t\t// tag the submission with the current submission round if it is present\n+\t\t// if it doesn't exist it could possibly be because the user does not exist yet\n+\t\tevaluationDAO.getEvaluationRoundForTimestamp(evalId, Instant.now())\n+\t\t\t.ifPresent((EvaluationRound round) -> {\n+\t\t\t\tsubmission.setEvaluationRoundId(round.getId());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyMjgxNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486522817", "bodyText": "Remove or resolve TODO?", "author": "marcomarasca", "createdAt": "2020-09-10T17:44:45Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/evaluation/manager/SubmissionQuotaUtil.java", "diffHunk": "@@ -61,20 +65,46 @@ public static boolean isSubmissionAllowed(Evaluation evaluation, Date now) {\n \t * interest is within the time range allowed for submissions.\n \t * \n \t */\n-\tpublic static Pair<Date, Date> getRoundInterval(Evaluation evaluation, Date now) {\n-\t\tif (evaluation==null) throw new IllegalArgumentException(\"evaluation is required.\");\n+\tpublic static Pair<Date, Date> getRoundInterval(SubmissionQuota submissionQuota, Date now) {\n \t\tif (now==null) throw new IllegalArgumentException(\"current date is required.\");\n-\t\tSubmissionQuota submissionQuota = evaluation.getQuota();\n-\t\tif (submissionQuota==null || \n+\t\tif (submissionQuota==null ||\n \t\t\t\t(submissionQuota.getFirstRoundStart()==null || \n \t\t\t\tsubmissionQuota.getRoundDurationMillis()==null))\n \t\t\treturn  new Pair<Date,Date>(null,null); // there is no start or end\n-\t\tif (!isSubmissionAllowed(evaluation, now)) \n+\t\tif (!isSubmissionAllowed(submissionQuota, now))\n \t\t\tthrow new IllegalArgumentException(\"The given date is outside the time range allowed for submissions.\");\n \t\tlong frs = submissionQuota.getFirstRoundStart().getTime();\n \t\tlong roundLen = submissionQuota.getRoundDurationMillis();\n \t\tlong start=frs+((now.getTime()-frs)/roundLen)*roundLen;\n \t\tlong end=start+roundLen;\n \t\treturn new Pair<Date,Date>(new Date(start),new Date(end));\n \t}\n+\n+\n+\tpublic static Optional<EvaluationRound> convertToCurrentEvaluationRound(SubmissionQuota quota, Date now){\n+\t\t//TODO: modify behavior to create a EvaluationRound for null", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyNzQ5OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486527498", "bodyText": "Make sure that when you change the createSubmission with the validation on the round id a dedicated test is added", "author": "marcomarasca", "createdAt": "2020-09-10T17:52:37Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionManagerAutowiredTest.java", "diffHunk": "@@ -189,6 +192,27 @@ public void testDockerRepoSubmissionCreateAndRead() throws Exception {\n \t\tassertEquals(DOCKER_REPOSITORY_NAME, retrieved.getDockerRepositoryName());\n \t\tassertEquals(DOCKER_DIGEST, retrieved.getDockerDigest());\n \t}\n+\n+\t@Test\n+\tpublic void testCreateSubmission_taggedWithCurrentEvaluationRound() throws Exception {", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyNzg1Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486527856", "bodyText": "This check should also be verified after line 207", "author": "marcomarasca", "createdAt": "2020-09-10T17:53:12Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionManagerAutowiredTest.java", "diffHunk": "@@ -189,6 +192,27 @@ public void testDockerRepoSubmissionCreateAndRead() throws Exception {\n \t\tassertEquals(DOCKER_REPOSITORY_NAME, retrieved.getDockerRepositoryName());\n \t\tassertEquals(DOCKER_DIGEST, retrieved.getDockerDigest());\n \t}\n+\n+\t@Test\n+\tpublic void testCreateSubmission_taggedWithCurrentEvaluationRound() throws Exception {\n+\t\tInstant now = Instant.now();\n+\t\tEvaluationRound evaluationRound = new EvaluationRound();\n+\t\tevaluationRound.setEvaluationId(evalId);\n+\t\tevaluationRound.setRoundStart(Date.from(now));\n+\t\tevaluationRound.setRoundEnd(Date.from(now.plus(42, ChronoUnit.HOURS)));\n+\t\tevaluationRound = evaluationManager.createEvaluationRound(adminUserInfo, evaluationRound);\n+\n+\t\t// create a docker repository\n+\t\tsubmission = submissionManager.createSubmission(adminUserInfo, submission,\n+\t\t\t\tretrievedNode.getETag(), null, bundle);\n+\n+\t\tassertNotNull(submission.getId());\n+\n+\t\t// retrieve the submission\n+\t\tSubmission retrieved = submissionManager.getSubmission(adminUserInfo, submission.getId());\n+\t\tassertEquals(evaluationRound.getId(), retrieved.getEvaluationRoundId());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyODMxMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486528310", "bodyText": "Should we check also the other properties?", "author": "marcomarasca", "createdAt": "2020-09-10T17:53:59Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionQuotaUtilTest.java", "diffHunk": "@@ -105,9 +112,82 @@ public void testWithoutRounds() {\n \t\teval.setQuota(quota);\n \t\tquota.setSubmissionLimit(10L);\n \n-\t\tassertTrue(SubmissionQuotaUtil.isSubmissionAllowed(eval, new Date()));\n+\t\tassertTrue(SubmissionQuotaUtil.isSubmissionAllowed(eval.getQuota(), new Date()));\n \t\tcheckPairEquals(new Pair<Date,Date>(null, null), \n-\t\t\t\tSubmissionQuotaUtil.getRoundInterval(eval, new Date()));\n+\t\t\t\tSubmissionQuotaUtil.getRoundInterval(eval.getQuota(), new Date()));\n \t}\n \n+\t@Test\n+\tpublic void testConvertToCurrentEvaluationRound_null(){\n+\t\tSubmissionQuota nullQuota = null;\n+\t\tOptional<EvaluationRound> optionalEvaluationRound = SubmissionQuotaUtil.convertToCurrentEvaluationRound(nullQuota, new Date());\n+\t\tassertTrue(optionalEvaluationRound.isPresent());\n+\t\toptionalEvaluationRound.ifPresent((round) ->{\n+\t\t\tassertNull(round.getRoundStart());\n+\t\t\tassertNull(round.getRoundEnd());", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyODkzMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486528933", "bodyText": "Call under test", "author": "marcomarasca", "createdAt": "2020-09-10T17:55:06Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/evaluation/manager/SubmissionQuotaUtilTest.java", "diffHunk": "@@ -105,9 +112,82 @@ public void testWithoutRounds() {\n \t\teval.setQuota(quota);\n \t\tquota.setSubmissionLimit(10L);\n \n-\t\tassertTrue(SubmissionQuotaUtil.isSubmissionAllowed(eval, new Date()));\n+\t\tassertTrue(SubmissionQuotaUtil.isSubmissionAllowed(eval.getQuota(), new Date()));\n \t\tcheckPairEquals(new Pair<Date,Date>(null, null), \n-\t\t\t\tSubmissionQuotaUtil.getRoundInterval(eval, new Date()));\n+\t\t\t\tSubmissionQuotaUtil.getRoundInterval(eval.getQuota(), new Date()));\n \t}\n \n+\t@Test\n+\tpublic void testConvertToCurrentEvaluationRound_null(){\n+\t\tSubmissionQuota nullQuota = null;\n+\t\tOptional<EvaluationRound> optionalEvaluationRound = SubmissionQuotaUtil.convertToCurrentEvaluationRound(nullQuota, new Date());\n+\t\tassertTrue(optionalEvaluationRound.isPresent());\n+\t\toptionalEvaluationRound.ifPresent((round) ->{\n+\t\t\tassertNull(round.getRoundStart());\n+\t\t\tassertNull(round.getRoundEnd());\n+\t\t});\n+\t}\n+\n+\t@Test\n+\tpublic void testConvertToCurrentEvaluationRound_SubmissionNotAllowed(){\n+\t\tSubmissionQuota quota = new SubmissionQuota();\n+\t\tInstant now = Instant.now();\n+\t\tquota.setFirstRoundStart(Date.from(now));\n+\t\tlong numRounds = 5;\n+\t\tlong roundDuration = 40L;\n+\t\tquota.setNumberOfRounds(numRounds);\n+\t\tquota.setRoundDurationMillis(roundDuration);\n+\n+\t\tDate roundAlreadyEnded = Date.from(now.plus(numRounds * roundDuration + 1, ChronoUnit.MILLIS));\n+\n+\t\tOptional<EvaluationRound> optionalEvaluationRound = SubmissionQuotaUtil.convertToCurrentEvaluationRound(quota, roundAlreadyEnded);", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMTQwMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486531400", "bodyText": "We might want to add the information about ACL (e.g. update on the evaluation is needed)", "author": "marcomarasca", "createdAt": "2020-09-10T17:59:14Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMTUwNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486531506", "bodyText": "See comment about, add the info about ACL", "author": "marcomarasca", "createdAt": "2020-09-10T17:59:26Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMTkwMw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486531903", "bodyText": "See comment above, let us add the ACL info", "author": "marcomarasca", "createdAt": "2020-09-10T18:00:10Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.GET)\n+\tpublic @ResponseBody\n+\tEvaluationRound getEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getEvaluationRound(userId, evalId, roundId);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve all EvaluationRounds associated with a Evaluation.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMjExNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486532115", "bodyText": "I think this should be a 200 instead.", "author": "marcomarasca", "createdAt": "2020-09-10T18:00:31Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMjIyMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486532221", "bodyText": "201 -> 200", "author": "marcomarasca", "createdAt": "2020-09-10T18:00:42Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.GET)\n+\tpublic @ResponseBody\n+\tEvaluationRound getEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getEvaluationRound(userId, evalId, roundId);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve all EvaluationRounds associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMjY4NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486532685", "bodyText": "Info about ACL", "author": "marcomarasca", "createdAt": "2020-09-10T18:01:27Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.GET)\n+\tpublic @ResponseBody\n+\tEvaluationRound getEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getEvaluationRound(userId, evalId, roundId);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve all EvaluationRounds associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND + UrlHelpers.LIST, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRoundListResponse getAllEvaluationRounds(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRoundListRequest request)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getAllEvaluationRounds(userId, evalId, request);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Update an existing EvaluationRound to associate with a Evaluation.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzMjg4MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486532881", "bodyText": "Double check the http code", "author": "marcomarasca", "createdAt": "2020-09-10T18:01:48Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.GET)\n+\tpublic @ResponseBody\n+\tEvaluationRound getEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getEvaluationRound(userId, evalId, roundId);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve all EvaluationRounds associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND + UrlHelpers.LIST, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRoundListResponse getAllEvaluationRounds(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRoundListRequest request)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getAllEvaluationRounds(userId, evalId, request);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Update an existing EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzNDA0Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486534042", "bodyText": "Delete. add ACL info", "author": "marcomarasca", "createdAt": "2020-09-10T18:04:01Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EvaluationController.java", "diffHunk": "@@ -1190,7 +1193,160 @@ QueryTableResults query(\n \t\t\t@PathVariable String subId) {\n \t\tserviceProvider.getEvaluationService().processCancelSubmissionRequest(userId, subId);\n \t}\n-\t\n+\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Creates a new EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRound createEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(evaluationRound.getEvaluationId() == null){\n+\t\t\tevaluationRound.setEvaluationId(evalId);\n+\t\t}\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"EvaluationId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().createEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve an existing EvaluationRound associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.GET)\n+\tpublic @ResponseBody\n+\tEvaluationRound getEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getEvaluationRound(userId, evalId, roundId);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Retrieve all EvaluationRounds associated with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND + UrlHelpers.LIST, method = RequestMethod.POST)\n+\tpublic @ResponseBody\n+\tEvaluationRoundListResponse getAllEvaluationRounds(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@RequestBody EvaluationRoundListRequest request)\n+\t{\n+\t\treturn serviceProvider.getEvaluationService().getAllEvaluationRounds(userId, evalId, request);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Update an existing EvaluationRound to associate with a Evaluation.\n+\t * This is a replacement for the deprecated <a href=\"${org.sagebionetworks.evaluation.model.SubmissionQuota}\">SubmissionQuota</a>\n+\t * which is a property inside of <a href=\"${org.sagebionetworks.evaluation.model.Evaluation}\">Evaluation</a>.\n+\t *\n+\t * EvaluationRounds define a fixed time period during which submissions to an Evaluation queue are accepted.\n+\t * Limits to the number of allowed submissions may be defined inside a EvaluationRound.\n+\t *\n+\t * @param userId\n+\t * @return\n+\t * @throws DatastoreException\n+\t * @throws InvalidModelException\n+\t * @throws NotFoundException\n+\t * @throws JSONObjectAdapterException\n+\t */\n+\t@RequiredScope({view,modify})\n+\t@ResponseStatus(HttpStatus.CREATED)\n+\t@RequestMapping(value = UrlHelpers.EVALUATION_ROUND_WITH_ROUND_ID, method = RequestMethod.PUT)\n+\tpublic @ResponseBody\n+\tEvaluationRound updateEvaluationRound(\n+\t\t\t@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\t\t\t@PathVariable String evalId,\n+\t\t\t@PathVariable String roundId,\n+\t\t\t@RequestBody EvaluationRound evaluationRound)\n+\t{\n+\t\tif(!evalId.equals(evaluationRound.getEvaluationId())){\n+\t\t\tthrow new IllegalArgumentException(\"evalId in URL path:\"+ evalId +\" does not match evaluationId in request body:\"+ evaluationRound.getEvaluationId());\n+\t\t}\n+\t\tif(!roundId.equals(evaluationRound.getId())){\n+\t\t\tthrow new IllegalArgumentException(\"roundId in URL path:\"+ roundId +\" does not match id in request body:\"+ evaluationRound.getId());\n+\t\t}\n+\t\treturn serviceProvider.getEvaluationService().updateEvaluationRound(userId, evaluationRound);\n+\t}\n+\t//TODO:Not deprecated, using flag to hide from documentation until ready\n+\t@Deprecated\n+\t/**\n+\t * Update an existing EvaluationRound to associate with a Evaluation.", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzNTU1Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486535556", "bodyText": "Validate the argument (trequest should not be null)", "author": "marcomarasca", "createdAt": "2020-09-10T18:06:37Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/service/EvaluationServiceImpl.java", "diffHunk": "@@ -339,4 +343,45 @@ public void processCancelSubmissionRequest(Long userId, String subId) {\n \t\tsubmissionManager.processUserCancelRequest(userInfo, subId);\n \t}\n \n+\t@Override\n+\tpublic EvaluationRound createEvaluationRound(Long userId, EvaluationRound evaluationRound){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.createEvaluationRound(userInfo, evaluationRound);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound updateEvaluationRound(Long userId, EvaluationRound evaluationRound){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.updateEvaluationRound(userInfo, evaluationRound);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(Long userId, String evaluationId, String evaluationRoundId){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.getEvaluationRound(userInfo, evaluationId, evaluationRoundId);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRoundListResponse getAllEvaluationRounds(Long userId, String evaluationId, EvaluationRoundListRequest request){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\tString nextPageTokenStr = request == null ? null : request.getNextPageToken();", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzNjA4NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486536085", "bodyText": "Consider moving the logic at the \"manager\" level", "author": "marcomarasca", "createdAt": "2020-09-10T18:07:34Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/service/EvaluationServiceImpl.java", "diffHunk": "@@ -339,4 +343,45 @@ public void processCancelSubmissionRequest(Long userId, String subId) {\n \t\tsubmissionManager.processUserCancelRequest(userInfo, subId);\n \t}\n \n+\t@Override\n+\tpublic EvaluationRound createEvaluationRound(Long userId, EvaluationRound evaluationRound){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.createEvaluationRound(userInfo, evaluationRound);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound updateEvaluationRound(Long userId, EvaluationRound evaluationRound){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.updateEvaluationRound(userInfo, evaluationRound);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(Long userId, String evaluationId, String evaluationRoundId){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\treturn evaluationManager.getEvaluationRound(userInfo, evaluationId, evaluationRoundId);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRoundListResponse getAllEvaluationRounds(Long userId, String evaluationId, EvaluationRoundListRequest request){\n+\t\tUserInfo userInfo = userManager.getUserInfo(userId);\n+\t\tString nextPageTokenStr = request == null ? null : request.getNextPageToken();\n+\t\tNextPageToken nextPageToken = new NextPageToken(nextPageTokenStr);\n+\n+\t\tList<EvaluationRound> rounds = evaluationManager.getAllEvaluationRounds(userInfo, evaluationId, nextPageToken);", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzODAxNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486538015", "bodyText": "We might get a null pointer if we don't validate the round", "author": "marcomarasca", "createdAt": "2020-09-10T18:11:04Z", "path": "client/synapseJavaClient/src/main/java/org/sagebionetworks/client/SynapseClientImpl.java", "diffHunk": "@@ -2993,6 +2997,52 @@ public void deleteEvaluation(String evalId) throws SynapseException {\n \t\tdeleteUri(getRepoEndpoint(), uri);\n \t}\n \n+\t@Override\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound round) throws SynapseException {\n+\t\tValidateArgument.required(round.getEvaluationId(), \"round.evaluationId\");", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzODEzNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486538137", "bodyText": "request required", "author": "marcomarasca", "createdAt": "2020-09-10T18:11:19Z", "path": "client/synapseJavaClient/src/main/java/org/sagebionetworks/client/SynapseClientImpl.java", "diffHunk": "@@ -2993,6 +2997,52 @@ public void deleteEvaluation(String evalId) throws SynapseException {\n \t\tdeleteUri(getRepoEndpoint(), uri);\n \t}\n \n+\t@Override\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound round) throws SynapseException {\n+\t\tValidateArgument.required(round.getEvaluationId(), \"round.evaluationId\");\n+\t\tString uri = EVALUATION_URI_PATH + \"/\" + round.getEvaluationId() + EVALUATION_ROUND;\n+\t\treturn postJSONEntity(getRepoEndpoint(), uri, round, EvaluationRound.class);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(String evalId, String roundId) throws SynapseException {\n+\t\tValidateArgument.required(evalId, \"Evaluation ID\");\n+\t\tValidateArgument.required(roundId, \"EvaluationRound ID\");\n+\n+\t\tString uri = EVALUATION_URI_PATH + \"/\" + evalId + EVALUATION_ROUND + \"/\" + roundId;\n+\n+\t\treturn getJSONEntity(getRepoEndpoint(), uri, EvaluationRound.class);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRoundListResponse getAllEvaluationRounds(String evalId, EvaluationRoundListRequest request) throws SynapseException {\n+\t\tValidateArgument.required(evalId, \"Evaluation ID\");", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzODI5Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486538296", "bodyText": "We might get a null pointer if round is null", "author": "marcomarasca", "createdAt": "2020-09-10T18:11:39Z", "path": "client/synapseJavaClient/src/main/java/org/sagebionetworks/client/SynapseClientImpl.java", "diffHunk": "@@ -2993,6 +2997,52 @@ public void deleteEvaluation(String evalId) throws SynapseException {\n \t\tdeleteUri(getRepoEndpoint(), uri);\n \t}\n \n+\t@Override\n+\tpublic EvaluationRound createEvaluationRound(EvaluationRound round) throws SynapseException {\n+\t\tValidateArgument.required(round.getEvaluationId(), \"round.evaluationId\");\n+\t\tString uri = EVALUATION_URI_PATH + \"/\" + round.getEvaluationId() + EVALUATION_ROUND;\n+\t\treturn postJSONEntity(getRepoEndpoint(), uri, round, EvaluationRound.class);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound getEvaluationRound(String evalId, String roundId) throws SynapseException {\n+\t\tValidateArgument.required(evalId, \"Evaluation ID\");\n+\t\tValidateArgument.required(roundId, \"EvaluationRound ID\");\n+\n+\t\tString uri = EVALUATION_URI_PATH + \"/\" + evalId + EVALUATION_ROUND + \"/\" + roundId;\n+\n+\t\treturn getJSONEntity(getRepoEndpoint(), uri, EvaluationRound.class);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRoundListResponse getAllEvaluationRounds(String evalId, EvaluationRoundListRequest request) throws SynapseException {\n+\t\tValidateArgument.required(evalId, \"Evaluation ID\");\n+\n+\t\tString uri = EVALUATION_URI_PATH + \"/\" + evalId + EVALUATION_ROUND + LIST;\n+\n+\t\treturn postJSONEntity(getRepoEndpoint(), uri, request, EvaluationRoundListResponse.class);\n+\t}\n+\n+\t@Override\n+\tpublic EvaluationRound updateEvaluationRound(EvaluationRound round) throws SynapseException {\n+\t\tValidateArgument.required(round.getEvaluationId(), \"round.evaluationId\");", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzOTU2OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486539569", "bodyText": "Make sure to set this right if you remove the \"one second\" check", "author": "marcomarasca", "createdAt": "2020-09-10T18:13:41Z", "path": "integration-test/src/test/java/org/sagebionetworks/IT520SynapseJavaClientEvaluationTest.java", "diffHunk": "@@ -312,7 +319,53 @@ public void testEvaluationRoundTrip() throws SynapseException, UnsupportedEncodi\n \t\t\n \t\tassertEquals(initialCount, synapseOne.getAvailableEvaluationsPaginated(100, 0).getResults().size());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testEvaluationRound_RoundTrip() throws SynapseException {\n+\t\teval1 = synapseOne.createEvaluation(eval1);\n+\t\tevaluationsToDelete.add(eval1.getId());\n+\n+\t\tInstant now = Instant.now();\n+\t\tEvaluationRound round = new EvaluationRound();\n+\t\tround.setEvaluationId(eval1.getId());\n+\t\tround.setRoundStart(Date.from(now));", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0MDY5MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486540690", "bodyText": "Add a second round", "author": "marcomarasca", "createdAt": "2020-09-10T18:15:00Z", "path": "integration-test/src/test/java/org/sagebionetworks/IT520SynapseJavaClientEvaluationTest.java", "diffHunk": "@@ -312,7 +319,53 @@ public void testEvaluationRoundTrip() throws SynapseException, UnsupportedEncodi\n \t\t\n \t\tassertEquals(initialCount, synapseOne.getAvailableEvaluationsPaginated(100, 0).getResults().size());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testEvaluationRound_RoundTrip() throws SynapseException {\n+\t\teval1 = synapseOne.createEvaluation(eval1);\n+\t\tevaluationsToDelete.add(eval1.getId());\n+\n+\t\tInstant now = Instant.now();\n+\t\tEvaluationRound round = new EvaluationRound();\n+\t\tround.setEvaluationId(eval1.getId());\n+\t\tround.setRoundStart(Date.from(now));\n+\t\tround.setRoundEnd(Date.from(now.plus(1, ChronoUnit.DAYS)));\n+\n+\t\t//create\n+\t\tEvaluationRound created = synapseOne.createEvaluationRound(round);\n+\n+\t\t//read\n+\t\tEvaluationRound retrieved = synapseOne.getEvaluationRound(created.getEvaluationId(), created.getId());\n+\t\tassertEquals(created, retrieved);\n+\n+\t\t//read all", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0MjQ0OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r486542449", "bodyText": "I would probably add also a simple test with a submission, checking that the correct round was set. I would update the limit and make sure that you cannot submit anymore.", "author": "marcomarasca", "createdAt": "2020-09-10T18:17:29Z", "path": "integration-test/src/test/java/org/sagebionetworks/IT520SynapseJavaClientEvaluationTest.java", "diffHunk": "@@ -312,7 +319,53 @@ public void testEvaluationRoundTrip() throws SynapseException, UnsupportedEncodi\n \t\t\n \t\tassertEquals(initialCount, synapseOne.getAvailableEvaluationsPaginated(100, 0).getResults().size());\n \t}\n-\t\n+\n+\t@Test\n+\tpublic void testEvaluationRound_RoundTrip() throws SynapseException {\n+\t\teval1 = synapseOne.createEvaluation(eval1);\n+\t\tevaluationsToDelete.add(eval1.getId());\n+\n+\t\tInstant now = Instant.now();\n+\t\tEvaluationRound round = new EvaluationRound();\n+\t\tround.setEvaluationId(eval1.getId());\n+\t\tround.setRoundStart(Date.from(now));\n+\t\tround.setRoundEnd(Date.from(now.plus(1, ChronoUnit.DAYS)));\n+\n+\t\t//create\n+\t\tEvaluationRound created = synapseOne.createEvaluationRound(round);\n+\n+\t\t//read\n+\t\tEvaluationRound retrieved = synapseOne.getEvaluationRound(created.getEvaluationId(), created.getId());\n+\t\tassertEquals(created, retrieved);\n+\n+\t\t//read all\n+\t\tEvaluationRound round2 = new EvaluationRound();\n+\t\tround2.setEvaluationId(eval1.getId());\n+\t\tround2.setRoundStart(Date.from(now.plus(1, ChronoUnit.DAYS)));\n+\t\tround2.setRoundEnd(Date.from(now.plus(2, ChronoUnit.DAYS)));\n+\t\tEvaluationRound created2 = synapseOne.createEvaluationRound(round2);\n+\n+\t\tEvaluationRoundListResponse listResponse = synapseOne.getAllEvaluationRounds(created.getEvaluationId(), new EvaluationRoundListRequest());\n+\t\tassertEquals(Arrays.asList(created, created2), listResponse.getPage());\n+", "originalCommit": "9e68dcd409d83664ad9d1f4f01c517a8756effbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f444aec43730e0370ae459b6dff2ff3b1d94677", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1f444aec43730e0370ae459b6dff2ff3b1d94677", "message": "code review changes part 1", "committedDate": "2020-09-11T06:49:08Z", "type": "commit"}, {"oid": "a5bba11e7e6f0d9ce07b3d48b8004717ec521ff8", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a5bba11e7e6f0d9ce07b3d48b8004717ec521ff8", "message": "code review changes part 2: electric boogaloo", "committedDate": "2020-09-13T12:07:45Z", "type": "commit"}, {"oid": "79ff43fddf217d065e6329c5838e90eb5b2a8c72", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/79ff43fddf217d065e6329c5838e90eb5b2a8c72", "message": "convert roundstart and roundend to using DATETIME", "committedDate": "2020-09-13T12:50:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI2NTM4OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4195#discussion_r488265389", "bodyText": "?", "author": "marcomarasca", "createdAt": "2020-09-14T22:26:44Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/metadata/providers/SubmissionMetadataIndexProvider.java", "diffHunk": "@@ -32,7 +32,7 @@\n @Service\r\n public class SubmissionMetadataIndexProvider implements MetadataIndexProvider {\r\n \r\n-\tprivate static final ViewObjectType OBJECT_TYPE = ViewObjectType.SUBMISSION;\r\n+\tprivate static final ViewObjectType OBJECT_TYPE = ViewObjectType.\tSUBMISSION;\r", "originalCommit": "79ff43fddf217d065e6329c5838e90eb5b2a8c72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}