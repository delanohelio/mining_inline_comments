{"pr_number": 3986, "pr_title": "Plfm 5170", "pr_createdAt": "2020-03-31T22:12:08Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986", "timeline": [{"oid": "ce04abc0220e2a25aeb34ead8d493f7e4c56ed59", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ce04abc0220e2a25aeb34ead8d493f7e4c56ed59", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T01:01:51Z", "type": "commit"}, {"oid": "b812ed31dfcb3e2707807806676b7b2a7e4f5294", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b812ed31dfcb3e2707807806676b7b2a7e4f5294", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T14:18:02Z", "type": "commit"}, {"oid": "e6a029d96d416caa3fb3aab460e283cec4da6eab", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e6a029d96d416caa3fb3aab460e283cec4da6eab", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T16:02:20Z", "type": "commit"}, {"oid": "b94155dc5fb59bad9f77dbddd9a3fd45dd2eadf2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b94155dc5fb59bad9f77dbddd9a3fd45dd2eadf2", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T16:12:55Z", "type": "commit"}, {"oid": "18675fe1324c4a578b7e8ced63b4fb2943595331", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/18675fe1324c4a578b7e8ced63b4fb2943595331", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T16:57:56Z", "type": "commit"}, {"oid": "00158e79544d9a13a5a0036f1e536143d5c42854", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/00158e79544d9a13a5a0036f1e536143d5c42854", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T16:58:51Z", "type": "commit"}, {"oid": "afd9fb46c24d591272660e23fe75fba6cceec285", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/afd9fb46c24d591272660e23fe75fba6cceec285", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T17:03:01Z", "type": "commit"}, {"oid": "3dbd62c5948ae76b65e7eb2cc2e1071260cbd622", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3dbd62c5948ae76b65e7eb2cc2e1071260cbd622", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T17:05:44Z", "type": "commit"}, {"oid": "970e6ebed133ce265b82f3e557fdac715e4d22b4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/970e6ebed133ce265b82f3e557fdac715e4d22b4", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T17:13:11Z", "type": "commit"}, {"oid": "5b81d0c7617e87b2001189466c12ed49d2d8640f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5b81d0c7617e87b2001189466c12ed49d2d8640f", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T17:22:10Z", "type": "commit"}, {"oid": "5c5f2d70a0e9a426edf6656501374aa79366a5c6", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5c5f2d70a0e9a426edf6656501374aa79366a5c6", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T21:54:06Z", "type": "commit"}, {"oid": "32dc84a5fa739a380681b2819885a405c5498ed0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/32dc84a5fa739a380681b2819885a405c5498ed0", "message": "PLFM-5170-IV", "committedDate": "2020-03-24T22:52:27Z", "type": "commit"}, {"oid": "a4fcf520fa3b3136c8cd44261ed049c8214f65ed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a4fcf520fa3b3136c8cd44261ed049c8214f65ed", "message": "PLFM-5170", "committedDate": "2020-03-25T17:26:49Z", "type": "commit"}, {"oid": "711b65c85fb66d438880829df0fd8e8a7dc13783", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/711b65c85fb66d438880829df0fd8e8a7dc13783", "message": "PLFM-5170", "committedDate": "2020-03-26T01:49:26Z", "type": "commit"}, {"oid": "bf97c1515bee1a459f4c4731d9af506dbf61b74f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/bf97c1515bee1a459f4c4731d9af506dbf61b74f", "message": "PLFM-5170", "committedDate": "2020-03-26T06:12:47Z", "type": "commit"}, {"oid": "dd19c1a4df02fb3f069eed67bd4506f8b70f48a7", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/dd19c1a4df02fb3f069eed67bd4506f8b70f48a7", "message": "PLFM-5170", "committedDate": "2020-03-26T13:14:24Z", "type": "commit"}, {"oid": "223c14a3000384eeafe1e2eb1a3c402f1b26e3cc", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/223c14a3000384eeafe1e2eb1a3c402f1b26e3cc", "message": "PLFM-5170", "committedDate": "2020-03-26T14:03:03Z", "type": "commit"}, {"oid": "e1e6fe565b9928c536d4cdfb1c1c6fb06cb257d2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e1e6fe565b9928c536d4cdfb1c1c6fb06cb257d2", "message": "PLFM-5170", "committedDate": "2020-03-26T14:28:18Z", "type": "commit"}, {"oid": "4740fa381d349d57c69ae2ae816be157c544b552", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/4740fa381d349d57c69ae2ae816be157c544b552", "message": "PLFM-5170", "committedDate": "2020-03-26T22:25:36Z", "type": "commit"}, {"oid": "bc88d6974f16464b333c2eb6d021c81361aee351", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/bc88d6974f16464b333c2eb6d021c81361aee351", "message": "PLFM-5170", "committedDate": "2020-03-26T23:49:07Z", "type": "commit"}, {"oid": "70bfa8e97842b3df95509344764c6726cc311d6c", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/70bfa8e97842b3df95509344764c6726cc311d6c", "message": "PLFM-5170", "committedDate": "2020-03-27T01:12:04Z", "type": "commit"}, {"oid": "cfb60907044c5ffe4667ee3ed47935d53cb996e7", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cfb60907044c5ffe4667ee3ed47935d53cb996e7", "message": "PLFM-5170", "committedDate": "2020-03-27T17:17:21Z", "type": "commit"}, {"oid": "3cdca29840c96d9212dff2606f27e5905315d3ef", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3cdca29840c96d9212dff2606f27e5905315d3ef", "message": "PLFM-5170", "committedDate": "2020-03-27T17:59:51Z", "type": "commit"}, {"oid": "28ebf6956b501435ccd89fba5010a01aa00e34d3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/28ebf6956b501435ccd89fba5010a01aa00e34d3", "message": "PLFM-5170", "committedDate": "2020-03-27T23:22:24Z", "type": "commit"}, {"oid": "ee6454953904e70b79ac28e799d30e2af8388532", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ee6454953904e70b79ac28e799d30e2af8388532", "message": "PLFM-5170", "committedDate": "2020-03-28T21:21:50Z", "type": "commit"}, {"oid": "3aa46634deeff5e1b008fccc17e3cea38595e432", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3aa46634deeff5e1b008fccc17e3cea38595e432", "message": "PLFM-5170", "committedDate": "2020-03-28T21:59:07Z", "type": "commit"}, {"oid": "11772d3fcf8f2a054325c4506d78789fde2e3bc4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/11772d3fcf8f2a054325c4506d78789fde2e3bc4", "message": "PLFM-5170", "committedDate": "2020-03-30T17:13:08Z", "type": "commit"}, {"oid": "a0644026d1138489044e0c71be84cd1105b1cac9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a0644026d1138489044e0c71be84cd1105b1cac9", "message": "PLFM-5170", "committedDate": "2020-03-30T17:16:22Z", "type": "commit"}, {"oid": "a6750966a7324ab20b9b0f4c6482c3a7587db606", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a6750966a7324ab20b9b0f4c6482c3a7587db606", "message": "PLFM-5170", "committedDate": "2020-03-30T18:06:45Z", "type": "commit"}, {"oid": "21c1c7a0fceb19d42641842168ee731c573e8e5c", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/21c1c7a0fceb19d42641842168ee731c573e8e5c", "message": "PLFM-5170", "committedDate": "2020-03-30T20:00:47Z", "type": "commit"}, {"oid": "56be43fa80581df6d1078a1681048a7f6a52a9f0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/56be43fa80581df6d1078a1681048a7f6a52a9f0", "message": "PLFM-5170", "committedDate": "2020-03-31T01:50:38Z", "type": "commit"}, {"oid": "4e4da42b8524b6a0e5eb2eb78f3029246dbc5466", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/4e4da42b8524b6a0e5eb2eb78f3029246dbc5466", "message": "PLFM-5170", "committedDate": "2020-03-31T03:11:31Z", "type": "commit"}, {"oid": "dc7b253ecd3f3e9aec9d11aa4243684ab23f58f3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/dc7b253ecd3f3e9aec9d11aa4243684ab23f58f3", "message": "PLFM-5170", "committedDate": "2020-03-31T15:57:18Z", "type": "commit"}, {"oid": "de958763991ae8925329f8de4ab22fd5721b02e0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/de958763991ae8925329f8de4ab22fd5721b02e0", "message": "PLFM-5170", "committedDate": "2020-03-31T20:44:37Z", "type": "commit"}, {"oid": "3d4891740f22ea34a3dcfb20f1b46b45ff12a4c5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3d4891740f22ea34a3dcfb20f1b46b45ff12a4c5", "message": "PLFM-5170", "committedDate": "2020-03-31T21:32:02Z", "type": "commit"}, {"oid": "c3ff8d215592a936196bb24fadc983b35fd0efc9", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c3ff8d215592a936196bb24fadc983b35fd0efc9", "message": "PLFM-5170", "committedDate": "2020-03-31T23:23:11Z", "type": "commit"}, {"oid": "c6967ed1707a20ea507d0bb8078b30dea6ea886f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c6967ed1707a20ea507d0bb8078b30dea6ea886f", "message": "PLFM-5170", "committedDate": "2020-03-31T23:38:55Z", "type": "commit"}, {"oid": "710d791e3d6cb200dbdba59092cb405b7771d729", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/710d791e3d6cb200dbdba59092cb405b7771d729", "message": "PLFM-5170", "committedDate": "2020-04-01T00:12:24Z", "type": "commit"}, {"oid": "c1e2293dbb2fb0a6c4b534c997ebec2e02fc271f", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c1e2293dbb2fb0a6c4b534c997ebec2e02fc271f", "message": "PLFM-5170", "committedDate": "2020-04-01T00:59:46Z", "type": "commit"}, {"oid": "8281989370dd31b4e91fb47e769cc5b2e6ed89c2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/8281989370dd31b4e91fb47e769cc5b2e6ed89c2", "message": "PLFM-5170", "committedDate": "2020-04-01T01:03:07Z", "type": "commit"}, {"oid": "4b597a48873d08f7e61e520ce6d68fbb0fd65938", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/4b597a48873d08f7e61e520ce6d68fbb0fd65938", "message": "PLFM-5170", "committedDate": "2020-04-01T01:40:33Z", "type": "commit"}, {"oid": "c927a46ce65df66ea2582b1398715503d8b68756", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c927a46ce65df66ea2582b1398715503d8b68756", "message": "PLFM-5170", "committedDate": "2020-04-01T03:08:16Z", "type": "commit"}, {"oid": "2d5e568a38715709d7f809768dfe05e654e2165a", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2d5e568a38715709d7f809768dfe05e654e2165a", "message": "PLFM-5170", "committedDate": "2020-04-01T03:11:19Z", "type": "commit"}, {"oid": "5a42cff6bf13d9716d351149206614edac928580", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5a42cff6bf13d9716d351149206614edac928580", "message": "PLFM-5170", "committedDate": "2020-04-01T03:16:07Z", "type": "commit"}, {"oid": "a5861bdbf95a8bbfd20757ed21b3d4e5d5ebb802", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a5861bdbf95a8bbfd20757ed21b3d4e5d5ebb802", "message": "PLFM-5170", "committedDate": "2020-04-01T03:45:36Z", "type": "commit"}, {"oid": "d998b488837e05759c9ea4a2260f587382049726", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d998b488837e05759c9ea4a2260f587382049726", "message": "PLFM-5170", "committedDate": "2020-04-01T04:47:34Z", "type": "commit"}, {"oid": "81bf248e407137561ae42fd335e031b3dca08152", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/81bf248e407137561ae42fd335e031b3dca08152", "message": "PLFM-5170", "committedDate": "2020-04-01T13:20:46Z", "type": "commit"}, {"oid": "ce0e63a274eeeb513fbdfcef1a5e2f887f2b7839", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/ce0e63a274eeeb513fbdfcef1a5e2f887f2b7839", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into PLFM-5170-IV", "committedDate": "2020-04-01T13:23:03Z", "type": "commit"}, {"oid": "476bc3d454cae4fb7e7254b60d5c166f921b1d08", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/476bc3d454cae4fb7e7254b60d5c166f921b1d08", "message": "PLFM-5170", "committedDate": "2020-04-01T15:49:32Z", "type": "commit"}, {"oid": "c7d096694548ba95cebe3d20f03d3c2687934c81", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c7d096694548ba95cebe3d20f03d3c2687934c81", "message": "PLFM-5170", "committedDate": "2020-04-01T15:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MDcyMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401880721", "bodyText": "Add an additional test that verifies that all the current ACCESS_TYPE enumeration values are covered so that if in the future someone adds a new ACCESS_TYPE value the test would fail and inform the developer to map it to a scope.", "author": "marcomarasca", "createdAt": "2020-04-01T20:12:09Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/manager/util/OAuthPermissionUtilsTest.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package org.sagebionetworks.manager.util;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import java.util.Collections;\n+\n+import org.junit.jupiter.api.Test;\n+import org.sagebionetworks.repo.model.ACCESS_TYPE;\n+import org.sagebionetworks.repo.model.UnauthorizedException;\n+import org.sagebionetworks.repo.model.oauth.OAuthScope;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+class OAuthPermissionUtilsTest {\n+", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MDg0Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401880842", "bodyText": "We can put some exceptions if they are not used.", "author": "marcomarasca", "createdAt": "2020-04-01T20:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MDcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NDcwNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403474707", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MDcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MjMxMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401882310", "bodyText": "add a null check on scopes", "author": "marcomarasca", "createdAt": "2020-04-01T20:15:06Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/manager/util/OAuthPermissionUtils.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package org.sagebionetworks.manager.util;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.sagebionetworks.repo.model.ACCESS_TYPE;\n+import org.sagebionetworks.repo.model.auth.AuthorizationStatus;\n+import org.sagebionetworks.repo.model.oauth.OAuthScope;\n+\n+public class OAuthPermissionUtils {\n+\tprivate static final Map<ACCESS_TYPE,OAuthScope> ACCESS_TYPE_TO_SCOPE;\n+\t\n+\tstatic {\n+\t\tACCESS_TYPE_TO_SCOPE = new HashMap<ACCESS_TYPE,OAuthScope>();\n+\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.READ, \t\t\t\t\t\tOAuthScope.view);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.READ_PRIVATE_SUBMISSION, \tOAuthScope.view);\n+\t\t\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.CREATE, \t\t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.CHANGE_PERMISSIONS, \t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.UPDATE, \t\t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.UPLOAD, \t\t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.DELETE, \t\t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.SUBMIT, \t\t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.UPDATE_SUBMISSION, \t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.DELETE_SUBMISSION, \t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.TEAM_MEMBERSHIP_UPDATE, \tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.SEND_MESSAGE, \t\t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.CHANGE_SETTINGS, \t\t\tOAuthScope.modify);\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.MODERATE, \t\t\t\t\tOAuthScope.modify);\n+\t\t\n+\t\tACCESS_TYPE_TO_SCOPE.put(ACCESS_TYPE.DOWNLOAD, \t\t\t\t\tOAuthScope.download);\n+\t}\n+\t\n+\tpublic static boolean scopeAllowsAccess(Collection<OAuthScope> scopes, ACCESS_TYPE accessType) {\n+\t\tOAuthScope scope = ACCESS_TYPE_TO_SCOPE.get(accessType);", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NDczNA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403474734", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4MjMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4NTE4Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401885187", "bodyText": "Should be accessTypeCheck", "author": "marcomarasca", "createdAt": "2020-04-01T20:20:20Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImpl.java", "diffHunk": "@@ -440,6 +443,10 @@ private AuthorizationStatus canDownload(UserInfo userInfo, String entityId, Stri\n \t\t\taccessTypeCheck = READ;\n \t\t}\n \t\t\n+\t\tif (!OAuthPermissionUtils.scopeAllowsAccess(userInfo.getScopes(), accessTypeCheck)) {\n+\t\t\treturn OAuthPermissionUtils.accessDenied(ACCESS_TYPE.DOWNLOAD);", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NDc1Nw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403474757", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4NTE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4NzcyNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401887725", "bodyText": "Add ACCESS_TYPE as a parameter that indicates the purpose for accessing the file handle so that the scope can be mapped against that", "author": "marcomarasca", "createdAt": "2020-04-01T20:24:56Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/AuthorizationManagerImpl.java", "diffHunk": "@@ -280,8 +286,12 @@ public boolean isUserCreatorOrAdmin(UserInfo userInfo, String creator) {\n \r\n \t@Override\r\n \tpublic AuthorizationStatus canAccessRawFileHandleByCreator(UserInfo userInfo, String fileHandleId, String creator) {\r", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NDc3OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403474779", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4NzcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NDI2Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401894262", "bodyText": "Might be confusing wording referring to scopes", "author": "marcomarasca", "createdAt": "2020-04-01T20:37:34Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImplUnitTest.java", "diffHunk": "@@ -872,18 +914,42 @@ public void testHasDownloadAccessWihoutOpenDataAsAnonymous() {\n \t\twhen(mockNodeDao.getBenefactor(nodeId)).thenReturn(benefactorId);\n \t\twhen(mockObjectTypeManager.getObjectsDataType(nodeId, ObjectType.ENTITY)).thenReturn(dataType);\n \n-\t\twhen(mockAclDAO.canAccess(userInfo.getGroups(), benefactorId, ObjectType.ENTITY, ACCESS_TYPE.DOWNLOAD)).thenReturn(false);\n-\t\t\n \t\t// Call under test\n \t\tAuthorizationStatus status = entityPermissionsManager.hasAccess(nodeId, ACCESS_TYPE.DOWNLOAD, userInfo);\n \t\t\n \t\tassertFalse(status.isAuthorized());\n-\t\tassertEquals(\"You lack DOWNLOAD access to the requested entity.\", status.getMessage());\n+\t\tassertEquals(\"Your authorization scope(s) do not allow DOWNLOAD access.\", status.getMessage());", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NTE5MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401895190", "bodyText": "Note: this is an issue only for the anonymous user", "author": "marcomarasca", "createdAt": "2020-04-01T20:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NDI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NTkxMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401895911", "bodyText": "Probably also in this case the anonymous user can have the full scope.", "author": "marcomarasca", "createdAt": "2020-04-01T20:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NDI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NDY4NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403474685", "bodyText": "Giving full scope to the anonymous user fixed this.", "author": "brucehoff", "createdAt": "2020-04-04T14:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5NDI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5Nzk2NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401897964", "bodyText": "Copy/Paste error :) Might need code for the case with no view scope for the user.", "author": "marcomarasca", "createdAt": "2020-04-01T20:44:32Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/AuthorizationManagerImplUnitTest.java", "diffHunk": "@@ -291,6 +298,24 @@ public void testCanAccessActivityPaginationSmallResultSet() throws Exception {\n \t\tassertFalse(canAccess);\r\n \t}\r\n \r\n+\t@Test\r\n+\tpublic void testCanAccessActivityMissingRequired() throws Exception {\t\t \r\n+\t\tActivity act = new Activity();\r", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NjQ0Ng==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403476446", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5Nzk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMzUzMg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r401903532", "bodyText": "We don't need that, we can just use the @InjectMocks annotations", "author": "marcomarasca", "createdAt": "2020-04-01T20:55:19Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/discussion/DiscussionThreadManagerImplTest.java", "diffHunk": "@@ -105,7 +108,7 @@\n \tprivate List<DiscussionThreadEntityReference> entityRefs = new ArrayList<DiscussionThreadEntityReference>();\n \tprivate List<DiscussionThreadEntityReference> titleEntityRefs = new ArrayList<DiscussionThreadEntityReference>();\n \n-\t@Before\n+\t@BeforeEach\n \tpublic void before() {\n \t\tMockitoAnnotations.initMocks(this);", "originalCommit": "c7d096694548ba95cebe3d20f03d3c2687934c81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NjU1OQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403476559", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkwMzUzMg=="}], "type": "inlineReview"}, {"oid": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5ae8d6ee9e590eb98f90345382d063ec4392ac94", "message": "PLFM-5170", "committedDate": "2020-04-02T13:22:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUxODQzNg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402518436", "bodyText": "We can consider using a HandlerMethodArgumentResolver (https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/method/support/HandlerMethodArgumentResolver.html) so that we can inject and resolve a parameter by its type in the case when we have a parsed token or alternatively a UserInfo object. Also see https://www.petrikainulainen.net/programming/spring-framework/spring-from-the-trenches-creating-a-custom-handlermethodargumentresolver.", "author": "marcomarasca", "createdAt": "2020-04-02T18:18:00Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/controller/EntityController.java", "diffHunk": "@@ -266,13 +266,15 @@\n \t */\n \t@ResponseStatus(HttpStatus.CREATED)\n \t@RequestMapping(value = { UrlHelpers.ENTITY }, method = RequestMethod.POST)\n-\tpublic @ResponseBody Entity createEntity(@RequestParam(value = AuthorizationConstants.USER_ID_PARAM) Long userId,\n+\tpublic @ResponseBody Entity createEntity(\n+\t\t\t@RequestHeader(value = AuthorizationConstants.SYNAPSE_AUTHORIZATION_HEADER_NAME, required=true) String authorizationHeader,", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ5NzIwNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403497205", "bodyText": "Done.  See the newly added file: services/repository/src/main/java/org/sagebionetworks/repo/web/UserInfoMethodArgumentResolver.java", "author": "brucehoff", "createdAt": "2020-04-04T17:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUxODQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUyODI5Mw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402528293", "bodyText": "It's not really anonymous user as the the accessToken created above we use use a specific user", "author": "marcomarasca", "createdAt": "2020-04-02T18:34:44Z", "path": "integration-test/src/test/java/org/sagebionetworks/ITAccessTokenTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package org.sagebionetworks;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.sagebionetworks.client.SynapseAdminClient;\n+import org.sagebionetworks.client.SynapseAdminClientImpl;\n+import org.sagebionetworks.client.SynapseClient;\n+import org.sagebionetworks.client.SynapseClientImpl;\n+import org.sagebionetworks.client.exceptions.SynapseException;\n+import org.sagebionetworks.client.exceptions.SynapseForbiddenException;\n+import org.sagebionetworks.repo.model.Project;\n+import org.sagebionetworks.repo.model.oauth.OAuthAuthorizationResponse;\n+import org.sagebionetworks.repo.model.oauth.OAuthClient;\n+import org.sagebionetworks.repo.model.oauth.OAuthGrantType;\n+import org.sagebionetworks.repo.model.oauth.OAuthResponseType;\n+import org.sagebionetworks.repo.model.oauth.OIDCAuthorizationRequest;\n+import org.sagebionetworks.repo.model.oauth.OIDCTokenResponse;\n+\n+/*\n+ * This is a simple test to make sure that the OAuth access token authorization is connected properly.\n+ */\n+public class ITAccessTokenTest {\n+\n+\tprivate static SynapseAdminClient adminSynapse;\n+\tprivate static SynapseClient synapseOne;\n+\tprivate static SynapseClient synapseAnonymous;\n+\tprivate static Long user1ToDelete;\n+\tprivate static Long user2ToDelete;\n+\n+\tprivate OAuthClient client;\n+\tprivate String secret;\n+\n+\tprivate Project project;\n+\n+\t@BeforeAll\n+\tpublic static void beforeClass() throws Exception {\n+\t\t// Create 2 users\n+\t\tadminSynapse = new SynapseAdminClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(adminSynapse);\n+\t\tadminSynapse.setUsername(StackConfigurationSingleton.singleton().getMigrationAdminUsername());\n+\t\tadminSynapse.setApiKey(StackConfigurationSingleton.singleton().getMigrationAdminAPIKey());\n+\t\tadminSynapse.clearAllLocks();\n+\t\tsynapseOne = new SynapseClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(synapseOne);\n+\t\tuser1ToDelete = SynapseClientHelper.createUser(adminSynapse, synapseOne);\n+\n+\t\tsynapseAnonymous = new SynapseClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(synapseAnonymous);\n+\t}\n+\n+\t@AfterAll\n+\tpublic static void afterClass() throws Exception {\n+\t\ttry {\n+\t\t\tif (user1ToDelete!=null) adminSynapse.deleteUser(user1ToDelete);\n+\t\t} catch (SynapseException e) { }\n+\t\ttry {\n+\t\t\tif (user2ToDelete!=null) adminSynapse.deleteUser(user2ToDelete);\n+\t\t} catch (SynapseException e) { }\n+\t}\n+\n+\t@BeforeEach\n+\tpublic void before() throws Exception {\n+\t\t// create the OAuth client\n+\t\tclient = new OAuthClient();\n+\t\tclient.setClient_name(UUID.randomUUID().toString());\n+\t\tclient.setRedirect_uris(Collections.singletonList(\"https://foo.bar.com\"));\n+\t\tclient = synapseOne.createOAuthClient(client);\n+\t\t// Sets the verified status of the client (only admins and ACT can do this)\n+\t\tclient = adminSynapse.updateOAuthClientVerifiedStatus(client.getClient_id(), client.getEtag(), true);\n+\t\tsecret = synapseOne.createOAuthClientSecret(client.getClient_id()).getClient_secret();\n+\t}\n+\n+\t@AfterEach\n+\tpublic void after() throws Exception {\n+\t\ttry {\n+\t\t\tif (project!=null) adminSynapse.deleteEntity(project);\n+\t\t} catch (SynapseException e) { }\n+\t\ttry {\n+\t\t\tif (client!=null) {\n+\t\t\t\tsynapseOne.deleteOAuthClient(client.getClient_id());\n+\t\t\t}\n+\t\t} catch (SynapseException e) {\n+\t\t\te.printStackTrace();\n+\t\t}\n+\t}\n+\n+\tprivate String getAccessToken(String scopes) throws Exception {\n+\t\tOIDCAuthorizationRequest authorizationRequest = new OIDCAuthorizationRequest();\n+\t\tauthorizationRequest.setClientId(client.getClient_id());\n+\t\tauthorizationRequest.setRedirectUri(client.getRedirect_uris().get(0));\n+\t\tauthorizationRequest.setResponseType(OAuthResponseType.code);\n+\t\tauthorizationRequest.setScope(scopes);\n+\t\tauthorizationRequest.setClaims(\"{\\\"id_token\\\":{},\\\"userinfo\\\":{}}\");\n+\t\tString nonce = UUID.randomUUID().toString();\n+\t\tauthorizationRequest.setNonce(nonce);\t\t\n+\t\tOAuthAuthorizationResponse oauthAuthorizationResponse = synapseOne.authorizeClient(authorizationRequest);\n+\n+\t\t// Note, we use Basic auth to authorize the client when asking for an access token\n+\t\tOIDCTokenResponse tokenResponse = null;\n+\t\ttry {\n+\t\t\tsynapseAnonymous.setBasicAuthorizationCredentials(client.getClient_id(), secret);\n+\t\t\ttokenResponse = synapseAnonymous.getTokenResponse(OAuthGrantType.authorization_code, \n+\t\t\t\t\toauthAuthorizationResponse.getAccess_code(), client.getRedirect_uris().get(0), null, null, null);\n+\t\t\treturn tokenResponse.getAccess_token();\n+\t\t} finally {\n+\t\t\tsynapseAnonymous.removeAuthorizationHeader();\n+\t\t}\n+\n+\t}\n+\n+\n+\t@Test\n+\tpublic void testAccessToken() throws Exception {\n+\t\tString accessToken = getAccessToken(\"openid modify view download\");\n+\n+\t\ttry {\n+\t\t\t// We use the bearer token to authorize the client \n+\t\t\tsynapseAnonymous.setBearerAuthorizationToken(accessToken);", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3NzQyOQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403477429", "bodyText": "Done.  I renamed multiple variables to clarify how we are using access tokens with the Synapse Java client.", "author": "brucehoff", "createdAt": "2020-04-04T14:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUyODI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUyOTExNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402529117", "bodyText": "Maybe we can add a true negative test where we try to do something that we are not supposed to be able do to yet with an access token (e.g. Create an evaluation queue).", "author": "marcomarasca", "createdAt": "2020-04-02T18:36:16Z", "path": "integration-test/src/test/java/org/sagebionetworks/ITAccessTokenTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package org.sagebionetworks;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+import java.util.Collections;\n+import java.util.UUID;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.sagebionetworks.client.SynapseAdminClient;\n+import org.sagebionetworks.client.SynapseAdminClientImpl;\n+import org.sagebionetworks.client.SynapseClient;\n+import org.sagebionetworks.client.SynapseClientImpl;\n+import org.sagebionetworks.client.exceptions.SynapseException;\n+import org.sagebionetworks.client.exceptions.SynapseForbiddenException;\n+import org.sagebionetworks.repo.model.Project;\n+import org.sagebionetworks.repo.model.oauth.OAuthAuthorizationResponse;\n+import org.sagebionetworks.repo.model.oauth.OAuthClient;\n+import org.sagebionetworks.repo.model.oauth.OAuthGrantType;\n+import org.sagebionetworks.repo.model.oauth.OAuthResponseType;\n+import org.sagebionetworks.repo.model.oauth.OIDCAuthorizationRequest;\n+import org.sagebionetworks.repo.model.oauth.OIDCTokenResponse;\n+\n+/*\n+ * This is a simple test to make sure that the OAuth access token authorization is connected properly.\n+ */\n+public class ITAccessTokenTest {\n+\n+\tprivate static SynapseAdminClient adminSynapse;\n+\tprivate static SynapseClient synapseOne;\n+\tprivate static SynapseClient synapseAnonymous;\n+\tprivate static Long user1ToDelete;\n+\tprivate static Long user2ToDelete;\n+\n+\tprivate OAuthClient client;\n+\tprivate String secret;\n+\n+\tprivate Project project;\n+\n+\t@BeforeAll\n+\tpublic static void beforeClass() throws Exception {\n+\t\t// Create 2 users\n+\t\tadminSynapse = new SynapseAdminClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(adminSynapse);\n+\t\tadminSynapse.setUsername(StackConfigurationSingleton.singleton().getMigrationAdminUsername());\n+\t\tadminSynapse.setApiKey(StackConfigurationSingleton.singleton().getMigrationAdminAPIKey());\n+\t\tadminSynapse.clearAllLocks();\n+\t\tsynapseOne = new SynapseClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(synapseOne);\n+\t\tuser1ToDelete = SynapseClientHelper.createUser(adminSynapse, synapseOne);\n+\n+\t\tsynapseAnonymous = new SynapseClientImpl();\n+\t\tSynapseClientHelper.setEndpoints(synapseAnonymous);\n+\t}\n+\n+\t@AfterAll\n+\tpublic static void afterClass() throws Exception {\n+\t\ttry {\n+\t\t\tif (user1ToDelete!=null) adminSynapse.deleteUser(user1ToDelete);\n+\t\t} catch (SynapseException e) { }\n+\t\ttry {\n+\t\t\tif (user2ToDelete!=null) adminSynapse.deleteUser(user2ToDelete);\n+\t\t} catch (SynapseException e) { }\n+\t}\n+\n+\t@BeforeEach\n+\tpublic void before() throws Exception {\n+\t\t// create the OAuth client\n+\t\tclient = new OAuthClient();\n+\t\tclient.setClient_name(UUID.randomUUID().toString());\n+\t\tclient.setRedirect_uris(Collections.singletonList(\"https://foo.bar.com\"));\n+\t\tclient = synapseOne.createOAuthClient(client);\n+\t\t// Sets the verified status of the client (only admins and ACT can do this)\n+\t\tclient = adminSynapse.updateOAuthClientVerifiedStatus(client.getClient_id(), client.getEtag(), true);\n+\t\tsecret = synapseOne.createOAuthClientSecret(client.getClient_id()).getClient_secret();\n+\t}\n+\n+\t@AfterEach\n+\tpublic void after() throws Exception {\n+\t\ttry {\n+\t\t\tif (project!=null) adminSynapse.deleteEntity(project);\n+\t\t} catch (SynapseException e) { }\n+\t\ttry {\n+\t\t\tif (client!=null) {\n+\t\t\t\tsynapseOne.deleteOAuthClient(client.getClient_id());\n+\t\t\t}\n+\t\t} catch (SynapseException e) {\n+\t\t\te.printStackTrace();\n+\t\t}\n+\t}\n+\n+\tprivate String getAccessToken(String scopes) throws Exception {\n+\t\tOIDCAuthorizationRequest authorizationRequest = new OIDCAuthorizationRequest();\n+\t\tauthorizationRequest.setClientId(client.getClient_id());\n+\t\tauthorizationRequest.setRedirectUri(client.getRedirect_uris().get(0));\n+\t\tauthorizationRequest.setResponseType(OAuthResponseType.code);\n+\t\tauthorizationRequest.setScope(scopes);\n+\t\tauthorizationRequest.setClaims(\"{\\\"id_token\\\":{},\\\"userinfo\\\":{}}\");\n+\t\tString nonce = UUID.randomUUID().toString();\n+\t\tauthorizationRequest.setNonce(nonce);\t\t\n+\t\tOAuthAuthorizationResponse oauthAuthorizationResponse = synapseOne.authorizeClient(authorizationRequest);\n+\n+\t\t// Note, we use Basic auth to authorize the client when asking for an access token\n+\t\tOIDCTokenResponse tokenResponse = null;\n+\t\ttry {\n+\t\t\tsynapseAnonymous.setBasicAuthorizationCredentials(client.getClient_id(), secret);\n+\t\t\ttokenResponse = synapseAnonymous.getTokenResponse(OAuthGrantType.authorization_code, \n+\t\t\t\t\toauthAuthorizationResponse.getAccess_code(), client.getRedirect_uris().get(0), null, null, null);\n+\t\t\treturn tokenResponse.getAccess_token();\n+\t\t} finally {\n+\t\t\tsynapseAnonymous.removeAuthorizationHeader();\n+\t\t}\n+\n+\t}\n+\n+\n+\t@Test\n+\tpublic void testAccessToken() throws Exception {\n+\t\tString accessToken = getAccessToken(\"openid modify view download\");\n+\n+\t\ttry {\n+\t\t\t// We use the bearer token to authorize the client \n+\t\t\tsynapseAnonymous.setBearerAuthorizationToken(accessToken);\n+\t\t\tproject = new Project();\n+\t\t\tproject.setName(\"access token test\");\n+\t\t\tproject = synapseAnonymous.createEntity(project);\n+\t\t\tassertNotNull(project.getId());\n+\t\t\tproject = synapseAnonymous.getEntity(project.getId(), Project.class);\n+\t\t\t\n+\t\t\t// But if we don't have 'view' scope we can't get the entity\n+\t\t\tString accessToken2 = getAccessToken(\"openid modify download\");\n+\t\t\tsynapseAnonymous.setBearerAuthorizationToken(accessToken2);\n+\t\t\tAssertions.assertThrows(SynapseForbiddenException.class, () -> {\n+\t\t\t\tproject = synapseAnonymous.getEntity(project.getId(), Project.class);\t\t\t\t\n+\t\t\t});\n+\t\t\t\n+\t\t} finally {\n+\t\t\tsynapseAnonymous.removeAuthorizationHeader();\n+\t\t}\n+\n+\t}", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3Nzk1MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403477951", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUyOTExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjQ4MA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402532480", "bodyText": "See AbstractAutowiredControllerJunit5TestBase", "author": "marcomarasca", "createdAt": "2020-04-02T18:42:05Z", "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/controller/AbstractAutowiredControllerTestBaseForJupiter.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.sagebionetworks.repo.web.controller;\r\n+\r\n+import org.junit.jupiter.api.AfterEach;\r\n+import org.junit.jupiter.api.BeforeEach;\r\n+import org.junit.jupiter.api.extension.ExtendWith;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.context.ApplicationContext;\r\n+import org.springframework.context.ApplicationContextAware;\r\n+import org.springframework.mock.web.MockServletConfig;\r\n+import org.springframework.test.context.ContextConfiguration;\r\n+import org.springframework.test.context.junit.jupiter.SpringExtension;\r\n+import org.springframework.web.context.WebApplicationContext;\r\n+import org.springframework.web.context.support.StaticWebApplicationContext;\r\n+import org.springframework.web.servlet.DispatcherServlet;\r\n+\r\n+/**\r\n+ * Base class for autowired controller tests\r\n+ * \r\n+ */\r\n+@ExtendWith(SpringExtension.class)\r\n+@ContextConfiguration(locations = { \"classpath:test-context.xml\" })\r\n+public abstract class AbstractAutowiredControllerTestBaseForJupiter implements ApplicationContextAware {\r", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3Nzk3MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403477971", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNzEzNw==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402537137", "bodyText": "Put this into the validateCLientVerificationStatus", "author": "marcomarasca", "createdAt": "2020-04-02T18:50:08Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -375,7 +373,9 @@ public UserAuthorization getUserAuthorization(String oauthToken) {\n \t\t\tthrow new IllegalArgumentException(\"Missing 'audience' value in the OAuth Access Token.\");\n \t\t}\n \n-\t\tvalidateClientVerificationStatus(oauthClientId);\n+\t\tif (!oauthClientId.equals(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID)) {", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODI0MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478241", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNzEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTM3NA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402539374", "bodyText": "Double check that the constant is a string", "author": "marcomarasca", "createdAt": "2020-04-02T18:53:42Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -384,18 +384,26 @@ public UserAuthorization getUserAuthorization(String oauthToken) {\n \n \t\t// userId is used to retrieve the user info\n \t\tString userId = getUserIdFromPPID(ppid, oauthClientId);\n-\n-\t\tUserAuthorization result = new UserAuthorization();\n-\t\tUserInfo userInfo = userManager.getUserInfo(Long.parseLong(userId));\n+\t\t// If the user belongs to the admin group they are an admin\n+\t\tSet<Long> groups = userManager.getUserGroups(Long.parseLong(userId));\n+\t\t\n+\t\t// Check to see if the user is an Admin\n+\t\tboolean isAdmin = groups.contains(AuthorizationConstants.BOOTSTRAP_PRINCIPAL.ADMINISTRATORS_GROUP.getPrincipalId());\n+\t\t// we don't let clients besides Synapse itself have admin access\n+\t\tboolean adminAccessAllowed = oauthClientId.equals(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODI1MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478251", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTk1Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402539952", "bodyText": "This should be full scope as the ACL will take care of access restrictions", "author": "marcomarasca", "createdAt": "2020-04-02T18:54:41Z", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OIDCTokenHelperImpl.java", "diffHunk": "@@ -150,7 +150,7 @@ public String createAnonymousAccessToken() {\n \t\tString subject = AuthorizationConstants.BOOTSTRAP_PRINCIPAL.ANONYMOUS_USER.getPrincipalId().toString(); // we don't encrypt the subject\n \t\tString oauthClientId = \"\"+AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID;\n \t\tString tokenId = UUID.randomUUID().toString();\n-\t\tList<OAuthScope> noScopes = Collections.EMPTY_LIST;\n+\t\tList<OAuthScope> noScopes = Collections.singletonList(OAuthScope.view);", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODMyMQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478321", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzOTk1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NDA3MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402544071", "bodyText": "maybe rename to just userGroups since this is really not admin groups", "author": "marcomarasca", "createdAt": "2020-04-02T19:01:39Z", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "diffHunk": "@@ -899,29 +900,115 @@ public void testGetUserAuthorization() {\n \t\tString token = \"access token\";\n \t\twhen(oidcTokenHelper.parseJWT(token)).thenReturn(mockJWT);\n \t\tClaims claims = Jwts.claims();\n-\t\tList<OAuthScope> scopes = Collections.singletonList(OAuthScope.openid);\n+\t\tList<OAuthScope> scopes = Arrays.asList(OAuthScope.values());\n \t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims = Collections.singletonMap(OIDCClaimName.email, null);\n \t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n \t\twhen(mockJWT.getBody()).thenReturn(claims);\n \t\tclaims.setAudience(OAUTH_CLIENT_ID);\n \t\twhen(mockOauthClientDao.getSectorIdentifierSecretForClient(OAUTH_CLIENT_ID)).thenReturn(clientSpecificEncodingSecret);\n \t\twhen(mockOauthClientDao.isOauthClientVerified(OAUTH_CLIENT_ID)).thenReturn(true);\n \t\t\n-\t\tString ppid = openIDConnectManagerImpl.ppid(USER_ID, OAUTH_CLIENT_ID);\n+\t\tString ppid = EncryptionUtils.encrypt(USER_ID, clientSpecificEncodingSecret);\n \t\tclaims.setSubject(ppid);\n \t\t\n-\t\tUserInfo userInfo = new UserInfo(false, USER_ID_LONG);\n-\t\twhen(mockUserManager.getUserInfo(USER_ID_LONG)).thenReturn(userInfo);\n+\t\tSet<Long> adminUsersGroups = ImmutableSet.of(USER_ID_LONG, \n+\t\t\t\tAuthorizationConstants.BOOTSTRAP_PRINCIPAL.ADMINISTRATORS_GROUP.getPrincipalId());\n+\t\twhen(mockUserManager.getUserGroups(USER_ID_LONG)).thenReturn(adminUsersGroups);\n \t\t\n \t\t// method under test\n-\t\tUserAuthorization actual = openIDConnectManagerImpl.getUserAuthorization(token);\n+\t\tUserInfo actual = openIDConnectManagerImpl.getUserAuthorization(token);\n \t\t\n \t\tverify(mockJWT).getBody();\n-\t\tverify(mockUserManager).getUserInfo(USER_ID_LONG);\n+\t\tverify(mockUserManager).getUserGroups(USER_ID_LONG);\n+\t\tverify(mockOauthClientDao).getSectorIdentifierSecretForClient(OAUTH_CLIENT_ID);\n \t\t\n+\t\tassertFalse(actual.isAdmin()); // it's false 'cause the oauth client is not Synapse\n+\t\tassertEquals(USER_ID_LONG, actual.getId());\n \t\tassertEquals(oidcClaims, actual.getOidcClaims());\n \t\tassertEquals(scopes, actual.getScopes());\n-\t\tassertEquals(userInfo, actual.getUserInfo());\n+\t\tassertEquals(adminUsersGroups, actual.getGroups());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetUserAuthorizationSynapseOAuthClient() {\n+\t\tString token = \"access token\";\n+\t\twhen(oidcTokenHelper.parseJWT(token)).thenReturn(mockJWT);\n+\t\tClaims claims = Jwts.claims();\n+\t\tList<OAuthScope> scopes = Collections.singletonList(OAuthScope.openid);\n+\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims = Collections.singletonMap(OIDCClaimName.email, null);\n+\t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n+\t\twhen(mockJWT.getBody()).thenReturn(claims);\n+\t\tclaims.setAudience(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);\t\t\n+\t\tclaims.setSubject(USER_ID);\t\n+\t\twhen(mockUserManager.getUserGroups(USER_ID_LONG)).thenReturn(userInfo.getGroups());\n+\t\t\n+\t\t// method under test\n+\t\topenIDConnectManagerImpl.getUserAuthorization(token);\n+\t\t\n+\t\tverify(mockOauthClientDao, never()).getSectorIdentifierSecretForClient(OAUTH_CLIENT_ID);\n+\t\tverify(mockOauthClientDao, never()).isOauthClientVerified(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);\n+\t}\n+\n+\t@Test\n+\tpublic void testGetAdminUserAuthorizationSynapseOAuthClient() {\n+\t\tString token = \"access token\";\n+\t\twhen(oidcTokenHelper.parseJWT(token)).thenReturn(mockJWT);\n+\t\tClaims claims = Jwts.claims();\n+\t\tList<OAuthScope> scopes = Arrays.asList(OAuthScope.values());\n+\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims = Collections.singletonMap(OIDCClaimName.email, null);\n+\t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n+\t\twhen(mockJWT.getBody()).thenReturn(claims);\n+\t\tclaims.setAudience(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);\t\t\n+\t\tclaims.setSubject(USER_ID);\t\n+\t\tSet<Long> adminUsersGroups = ImmutableSet.of(USER_ID_LONG, \n+\t\t\t\tAuthorizationConstants.BOOTSTRAP_PRINCIPAL.ADMINISTRATORS_GROUP.getPrincipalId());\n+\t\twhen(mockUserManager.getUserGroups(USER_ID_LONG)).thenReturn(adminUsersGroups);\n+\t\t\n+\t\t// method under test\n+\t\tUserInfo actual = openIDConnectManagerImpl.getUserAuthorization(token);\n+\t\t\n+\t\tassertTrue(actual.isAdmin());\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testGetAdminUserAuthorizationSynapseOAuthClientNotFullScope() {\n+\t\tString token = \"access token\";\n+\t\twhen(oidcTokenHelper.parseJWT(token)).thenReturn(mockJWT);\n+\t\tClaims claims = Jwts.claims();\n+\t\tList<OAuthScope> scopes = ImmutableList.of(OAuthScope.openid, OAuthScope.view);\n+\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims = Collections.singletonMap(OIDCClaimName.email, null);\n+\t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n+\t\twhen(mockJWT.getBody()).thenReturn(claims);\n+\t\tclaims.setAudience(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);\t\t\n+\t\tclaims.setSubject(USER_ID);\t\n+\t\tSet<Long> adminUsersGroups = ImmutableSet.of(USER_ID_LONG, \n+\t\t\t\tAuthorizationConstants.BOOTSTRAP_PRINCIPAL.ADMINISTRATORS_GROUP.getPrincipalId());\n+\t\twhen(mockUserManager.getUserGroups(USER_ID_LONG)).thenReturn(adminUsersGroups);\n+\t\t\n+\t\t// method under test\n+\t\tUserInfo actual = openIDConnectManagerImpl.getUserAuthorization(token);\n+\t\t\n+\t\tassertFalse(actual.isAdmin());\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testGetAdminUserAuthorizationSynapseOAuthClientNotAdminGroup() {\n+\t\tString token = \"access token\";\n+\t\twhen(oidcTokenHelper.parseJWT(token)).thenReturn(mockJWT);\n+\t\tClaims claims = Jwts.claims();\n+\t\tList<OAuthScope> scopes = Arrays.asList(OAuthScope.values());\n+\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims = Collections.singletonMap(OIDCClaimName.email, null);\n+\t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n+\t\twhen(mockJWT.getBody()).thenReturn(claims);\n+\t\tclaims.setAudience(AuthorizationConstants.SYNAPSE_OAUTH_CLIENT_ID);\t\t\n+\t\tclaims.setSubject(USER_ID);\t\n+\t\tSet<Long> adminUsersGroups = ImmutableSet.of(USER_ID_LONG);", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODQ2OA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478468", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0NDA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1MTg3MQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402551871", "bodyText": "Use the existing base class for Junit5", "author": "marcomarasca", "createdAt": "2020-04-02T19:15:08Z", "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/StackStatusInterceptorTest.java", "diffHunk": "@@ -17,38 +19,43 @@\n import org.sagebionetworks.repo.model.status.StackStatus;\r\n import org.sagebionetworks.repo.model.status.StatusEnum;\r\n import org.sagebionetworks.repo.model.versionInfo.SynapseVersionInfo;\r\n-import org.sagebionetworks.repo.web.controller.AbstractAutowiredControllerTestBase;\r\n+import org.sagebionetworks.repo.web.controller.AbstractAutowiredControllerTestBaseForJupiter;\r\n import org.springframework.beans.factory.annotation.Autowired;\r\n \r\n /**\r\n  * Test that the intercepter is working as expected.\r\n  * @author John\r\n  *\r\n  */\r\n-public class StackStatusInterceptorTest extends AbstractAutowiredControllerTestBase {\r\n+public class StackStatusInterceptorTest extends AbstractAutowiredControllerTestBaseForJupiter {\r", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODQ4NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478485", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1MTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1ODU3NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r402558575", "bodyText": "We can use @InjectMocks and get rid of the ReflectionTestUtils.setField", "author": "marcomarasca", "createdAt": "2020-04-02T19:27:12Z", "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/filter/throttle/RequestThrottleFilterTest.java", "diffHunk": "@@ -59,13 +64,17 @@ public void setUp() throws Exception{\n \t\tmockRequest.setRemoteAddr(ipAddress);\r\n \t\tmockRequest.setRequestURI(path);\r\n \t\tmockRequest.setCookies(new Cookie(SESSION_ID_COOKIE_NAME, sessionId));\r\n+\t\tmockRequest.addHeader(AuthorizationConstants.SYNAPSE_AUTHORIZATION_HEADER_NAME, \"Bearer \"+ACCESS_TOKEN);\r\n \r\n \t\tReflectionTestUtils.setField(filter, \"consumer\", mockConsumer);\r\n+\t\tReflectionTestUtils.setField(filter, \"oidcManager\", mockOidcManager);\r", "originalCommit": "5ae8d6ee9e590eb98f90345382d063ec4392ac94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3ODU3NQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3986#discussion_r403478575", "bodyText": "Done.", "author": "brucehoff", "createdAt": "2020-04-04T14:50:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1ODU3NQ=="}], "type": "inlineReview"}]}