{"pr_number": 4115, "pr_title": "PLFM-6335: Added basic auth service abstraction", "pr_createdAt": "2020-06-30T21:14:24Z", "pr_url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4115", "timeline": [{"oid": "0286d272dc9bc87d41e4f96b9112913d69a1b45b", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0286d272dc9bc87d41e4f96b9112913d69a1b45b", "message": "PLFM-6335: Abstraction for service basic auth", "committedDate": "2020-06-30T21:07:37Z", "type": "commit"}, {"oid": "3a3d8aba230f5e63b96a90202a9c2421e236ee65", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3a3d8aba230f5e63b96a90202a9c2421e236ee65", "message": "PLFM-6335: Added migration service auth filter", "committedDate": "2020-06-30T21:08:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0NzM5Mg==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4115#discussion_r448047392", "bodyText": "Is there a way we can avoid keeping this in memory?", "author": "john-hill", "createdAt": "2020-07-01T00:14:40Z", "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/StackConfigKeyAndSecretProvider.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.sagebionetworks.auth.filter;\r\n+\r\n+import org.sagebionetworks.StackConfiguration;\r\n+\r\n+/**\r\n+ * Default implementation for a {@link ServiceKeyAndSecretProvider} that grabs\r\n+ * the key/secret pair from the stack configuration\r\n+ * \r\n+ * @author Marco Marasca\r\n+ *\r\n+ */\r\n+public class StackConfigKeyAndSecretProvider implements ServiceKeyAndSecretProvider {\r\n+\r\n+\tprivate String serviceName;\r\n+\tprivate String serviceKey;\r", "originalCommit": "3a3d8aba230f5e63b96a90202a9c2421e236ee65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MjgwMA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4115#discussion_r448052800", "bodyText": "check with @brucehoff on this one.", "author": "john-hill", "createdAt": "2020-07-01T00:35:32Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/OAuthScopeInterceptor.java", "diffHunk": "@@ -61,10 +61,20 @@ public static boolean isAnonymous(HttpServletRequest request) {\n \t\t\t\tAuthorizationConstants.BOOTSTRAP_PRINCIPAL.ANONYMOUS_USER.getPrincipalId()\n \t\t\t\t\t.equals(Long.parseLong(userIdRequestParameter));\n \t}\n+\t\n+\tpublic static boolean isServiceCall(HttpServletRequest request) {\n+\t\tString serviceName = request.getHeader(AuthorizationConstants.SYNAPSE_HEADER_SERVICE_NAME);\n+\t\treturn serviceName != null;\n+\t}\n \n \t@Override\n \tpublic boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)\n \t\t\tthrows Exception {\n+\n+\t\t// Service calls do not need to have the scope checked since they are authenticated by the filter itself\n+\t\tif (isServiceCall(request)) {", "originalCommit": "3a3d8aba230f5e63b96a90202a9c2421e236ee65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDQzNQ==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4115#discussion_r448054435", "bodyText": "add a test that adds the \"magic\" and ensure it does not work.", "author": "john-hill", "createdAt": "2020-07-01T00:41:50Z", "path": "integration-test/src/test/java/org/sagebionetworks/ITMigrationTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package org.sagebionetworks;\r\n+\r\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\r\n+import static org.junit.jupiter.api.Assertions.assertThrows;\r\n+\r\n+import org.junit.jupiter.api.BeforeEach;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.sagebionetworks.client.SynapseAdminClient;\r\n+import org.sagebionetworks.client.SynapseAdminClientImpl;\r\n+import org.sagebionetworks.client.exceptions.SynapseException;\r\n+import org.sagebionetworks.client.exceptions.SynapseForbiddenException;\r\n+\r\n+public class ITMigrationTest {\r\n+\t\r\n+\tprivate static StackConfiguration stackConfig = StackConfigurationSingleton.singleton();\r\n+\tprivate static SynapseAdminClient adminSynapse;\r\n+\t\r\n+\t@BeforeEach\r\n+\tpublic void before() {\r\n+\t\tadminSynapse = new SynapseAdminClientImpl();\r\n+\t\tSynapseClientHelper.setEndpoints(adminSynapse);\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testMigrationWithServiceAuth() throws SynapseException {\r\n+\r\n+\t\tassertThrows(SynapseForbiddenException.class, () -> {\r\n+\t\t\t// No authentication\r\n+\t\t\tadminSynapse.getMigrationTypes();\r\n+\t\t});\r\n+\t\t\r\n+\t\t// Set service basic auth\r\n+\t\tString key = stackConfig.getServiceAuthKey(StackConfiguration.SERVICE_MIGRATION);\r\n+\t\tString secret = stackConfig.getServiceAuthSecret(StackConfiguration.SERVICE_MIGRATION);\r\n+\t\t\r\n+\t\tadminSynapse.setBasicAuthorizationCredentials(key, secret);\r\n+\t\t\r\n+\t\t// This should now work\r\n+\t\tassertNotNull(adminSynapse.getMigrationTypes());\r\n+\t\t\r\n+\t\t// Clear basic auth\r\n+\t\tadminSynapse.removeAuthorizationHeader();\r\n+\t\r\n+\t\t// Should still work with user/api key auth\r\n+\t\t\r\n+\t\tString migrationUser = stackConfig.getMigrationAdminUsername();\r\n+\t\tString migrationKey = stackConfig.getMigrationAdminAPIKey();\r\n+\t\t\r\n+\t\tadminSynapse.setUsername(migrationUser);\r\n+\t\tadminSynapse.setApiKey(migrationKey);\r\n+\t\t\r\n+\t\t// This should still work\r\n+\t\tassertNotNull(adminSynapse.getMigrationTypes());\r\n+\t}\r\n+\t\r", "originalCommit": "3a3d8aba230f5e63b96a90202a9c2421e236ee65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4NTAyOA==", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4115#discussion_r448585028", "bodyText": "need to make sure that a client cannot add this header to bypass the scope check", "author": "brucehoff", "createdAt": "2020-07-01T19:57:00Z", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/OAuthScopeInterceptor.java", "diffHunk": "@@ -61,10 +61,20 @@ public static boolean isAnonymous(HttpServletRequest request) {\n \t\t\t\tAuthorizationConstants.BOOTSTRAP_PRINCIPAL.ANONYMOUS_USER.getPrincipalId()\n \t\t\t\t\t.equals(Long.parseLong(userIdRequestParameter));\n \t}\n+\t\n+\tpublic static boolean isServiceCall(HttpServletRequest request) {\n+\t\tString serviceName = request.getHeader(AuthorizationConstants.SYNAPSE_HEADER_SERVICE_NAME);", "originalCommit": "3a3d8aba230f5e63b96a90202a9c2421e236ee65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}