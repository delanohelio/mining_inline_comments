{"pr_number": 4084, "pr_title": "Make fetching CMs async", "pr_createdAt": "2020-12-10T13:08:08Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4084", "timeline": [{"oid": "ef74b5bed7b214c539948535024b6e029b36c5eb", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ef74b5bed7b214c539948535024b6e029b36c5eb", "message": "Make fetching CMs async\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-10T13:07:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1NDQxNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4084#discussion_r540554415", "bodyText": "I wonder if the code would look nicer and easier to read if you wrap lines 81-83 into a method and call the method here.", "author": "scholzj", "createdAt": "2020-12-10T22:48:15Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaBridgeAssemblyOperator.java", "diffHunk": "@@ -91,7 +89,8 @@ public KafkaBridgeAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa\n         kafkaBridgeServiceAccount(namespace, bridge)\n             .compose(i -> deploymentOperations.scaleDown(namespace, bridge.getName(), bridge.getReplicas()))\n             .compose(scale -> serviceOperations.reconcile(namespace, bridge.getServiceName(), bridge.generateService()))\n-            .compose(i -> configMapOperations.reconcile(namespace, bridge.getAncillaryConfigMapName(), logAndMetricsConfigMap))\n+            .compose(i -> loggingCmFut)", "originalCommit": "ef74b5bed7b214c539948535024b6e029b36c5eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78159229295122077031d96d0c0117705c9e010c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/78159229295122077031d96d0c0117705c9e010c", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-11T07:30:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgwMzYzMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4084#discussion_r540803630", "bodyText": "Using CompositeFuture in the return type is not very nice, because it means callers of this method need to know what the elements of the composite are, and CompositeFuture is not type safe. I think it would be much nicer to declare a class which holds the metrics cm and the logging cm, like this:\npublic class MetricsAndLoggingCm {\n    public ConfigMap metricsCm;\n    public ConfigMap loggingCm;\n    MetricsAndLoggingCm(ConfigMap metricsCm, ConfigMap loggingCm) {\n        // ...\n    }\n}\nand have this method return a Future<MetricsAndLoggingCm> (by doing map on the result of the join). That way it's all much more self-describing.", "author": "tombentley", "createdAt": "2020-12-11T09:21:15Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/AbstractConnectOperator.java", "diffHunk": "@@ -698,15 +699,22 @@ protected JsonObject asJson(KafkaConnectorSpec spec) {\n         return updateStatusPromise.future();\n     }\n \n-    protected Future<ConfigMap> connectMetricsConfigMap(String namespace, KafkaConnectCluster connect) {\n+    protected CompositeFuture connectMetricsAndLoggingConfigMap(String namespace, KafkaConnectCluster connect) {", "originalCommit": "78159229295122077031d96d0c0117705c9e010c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgwNTU3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4084#discussion_r540805576", "bodyText": "Wrt previous comment, is means that here you don't need to know which indices correspond to which CM, the field or accessor method tell you. You could also, perhaps, change generateMetricsAndLogConfigMap to take an instance of the new class.", "author": "tombentley", "createdAt": "2020-12-11T09:24:19Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectAssemblyOperator.java", "diffHunk": "@@ -137,9 +132,9 @@ public KafkaConnectAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pf\n                 .compose(i -> networkPolicyOperator.reconcile(namespace, connect.getName(), connect.generateNetworkPolicy(pfa.isNamespaceAndPodSelectorNetworkPolicySupported(), isUseResources(kafkaConnect), operatorNamespace, operatorNamespaceLabels)))\n                 .compose(i -> deploymentOperations.scaleDown(namespace, connect.getName(), connect.getReplicas()))\n                 .compose(scale -> serviceOperations.reconcile(namespace, connect.getServiceName(), connect.generateService()))\n-                .compose(i -> connectMetricsConfigMap(namespace, connect))\n-                .compose(metricsCm -> {\n-                    ConfigMap logAndMetricsConfigMap = connect.generateMetricsAndLogConfigMap(loggingCm, metricsCm);\n+                .compose(i -> connectMetricsAndLoggingConfigMap(namespace, connect))\n+                .compose(metricsAndLoggingCm -> {\n+                    ConfigMap logAndMetricsConfigMap = connect.generateMetricsAndLogConfigMap(metricsAndLoggingCm.resultAt(1), metricsAndLoggingCm.resultAt(0));", "originalCommit": "78159229295122077031d96d0c0117705c9e010c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "927473d926b5ae43fb5c4f2ac751a17477d4cbcc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/927473d926b5ae43fb5c4f2ac751a17477d4cbcc", "message": "avoid using composite fut\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-11T14:28:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyNzY3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4084#discussion_r541427673", "bodyText": "This seems to be used exclusively by assembly operators. So why is it in resource operators package? Should it be moved to the assembly package?", "author": "scholzj", "createdAt": "2020-12-11T23:51:38Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/MetricsAndLoggingCm.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.cluster.operator.resource;", "originalCommit": "927473d926b5ae43fb5c4f2ac751a17477d4cbcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "815c9ec414a818d8437eab93d39f642d741c3125", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/815c9ec414a818d8437eab93d39f642d741c3125", "message": "refactor\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-14T08:03:46Z", "type": "commit"}, {"oid": "3e8dba09a5da560f83ddfae3753915799f1c2cad", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3e8dba09a5da560f83ddfae3753915799f1c2cad", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-15T10:06:39Z", "type": "forcePushed"}, {"oid": "547b20c4fe7581612316ceac8c4a6d36daec2654", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/547b20c4fe7581612316ceac8c4a6d36daec2654", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-15T10:07:45Z", "type": "commit"}, {"oid": "547b20c4fe7581612316ceac8c4a6d36daec2654", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/547b20c4fe7581612316ceac8c4a6d36daec2654", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-15T10:07:45Z", "type": "forcePushed"}]}