{"pr_number": 3311, "pr_title": "Bridge dynamic logging", "pr_createdAt": "2020-07-13T13:45:17Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311", "timeline": [{"oid": "d78d96771fd18e44892fb603edba62102e1e47ce", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d78d96771fd18e44892fb603edba62102e1e47ce", "message": "Bridge dynamic logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-13T13:49:30Z", "type": "commit"}, {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d78d96771fd18e44892fb603edba62102e1e47ce", "message": "Bridge dynamic logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-13T13:49:30Z", "type": "forcePushed"}, {"oid": "5880efce1e955bb454a32b3d7dd1e15074fffde2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5880efce1e955bb454a32b3d7dd1e15074fffde2", "message": "fix tests\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-13T14:22:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTYzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r453689635", "bodyText": "bridz?", "author": "ppatierno", "createdAt": "2020-07-13T14:27:08Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -349,6 +352,111 @@ void testDynamicallySetEOloggingLevels() throws InterruptedException {\n         assertThat(\"EO pod should not roll\", DeploymentUtils.depSnapshot(eoDeploymentName), equalTo(eoPods));\n     }\n \n+    @Test\n+    void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n+        InlineLogging ilOff = new InlineLogging();\n+        Map<String, String> loggers = new HashMap<>();\n+        loggers.put(\"rootLogger.level\", \"OFF\");\n+        loggers.put(\"logger.bridge.level\", \"OFF\");\n+        loggers.put(\"logger.healthy.level\", \"OFF\");\n+        loggers.put(\"logger.ready.level\", \"OFF\");\n+        ilOff.setLoggers(loggers);\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 1, 1).done();\n+        KafkaBridgeResource.kafkaBridge(CLUSTER_NAME, KafkaResources.tlsBootstrapAddress(CLUSTER_NAME), 1)\n+                .editSpec()\n+                    .withInlineLogging(ilOff)\n+                .endSpec()\n+                .done();\n+\n+        Map<String, String> bridgeSnapshot = DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME));\n+\n+        LOGGER.info(\"Changing rootLogger level to DEBUG with inline logging\");\n+        InlineLogging ilDebug = new InlineLogging();\n+        loggers.put(\"rootLogger.level\", \"DEBUG\");\n+        loggers.put(\"logger.bridge.level\", \"OFF\");\n+        loggers.put(\"logger.healthy.level\", \"OFF\");\n+        loggers.put(\"logger.ready.level\", \"OFF\");\n+        ilDebug.setLoggers(loggers);\n+\n+        KafkaBridgeResource.replaceBridgeResource(CLUSTER_NAME, bridz -> {\n+            bridz.getSpec().setLogging(ilDebug);\n+        });\n+\n+        final String bridgePodName = bridgeSnapshot.keySet().iterator().next();\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPodContainer(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"cat\", \"/opt/strimzi/custom-config/log4j2.properties\").out().contains(\"rootLogger.level=DEBUG\")\n+                && cmdKubeClient().execInPodContainer(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"cat\", \"/opt/strimzi/custom-config/log4j2.properties\").out().contains(\"monitorInterval=30\")\n+        );\n+\n+        LOGGER.info(\"Waiting {} ms for DEBUG log will appear\", LOGGING_RELOADING_INTERVAL * 2);\n+        // wait some time and check whether logs after this time contain anything\n+        Thread.sleep(LOGGING_RELOADING_INTERVAL * 2);\n+\n+        LOGGER.info(\"Asserting if log will contain some records\");\n+        assertThat(StUtils.getLogFromPodByTime(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"30s\"), is(not(emptyString())));\n+\n+        ConfigMap configMapBridge = new ConfigMapBuilder()\n+                .withNewMetadata()\n+                .withName(\"external-configmap-bridge\")\n+                .withNamespace(NAMESPACE)\n+                .endMetadata()\n+                .withData(Collections.singletonMap(\"log4j2.properties\",\n+                        \"name = BridgeConfig\\n\" +\n+                                \"\\n\" +\n+                                \"appender.console.type = Console\\n\" +\n+                                \"appender.console.name = STDOUT\\n\" +\n+                                \"appender.console.layout.type = PatternLayout\\n\" +\n+                                \"appender.console.layout.pattern = [%d] %-5p <%-12.12c{1}:%L> [%-12.12t] %m%n\\n\" +\n+                                \"\\n\" +\n+                                \"rootLogger.level = OFF\\n\" +\n+                                \"rootLogger.appenderRefs = console\\n\" +\n+                                \"rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+                                \"rootLogger.additivity = false\\n\" +\n+                                \"\\n\" +\n+                                \"logger.bridge.name = io.strimzi.kafka.bridge\\n\" +\n+                                \"logger.bridge.level = OFF\\n\" +\n+                                \"logger.bridge.appenderRefs = console\\n\" +\n+                                \"logger.bridge.appenderRef.console.ref = STDOUT\\n\" +\n+                                \"logger.bridge.additivity = false\\n\" +\n+                                \"\\n\" +\n+                                \"# HTTP OpenAPI specific logging levels (default is INFO)\\n\" +\n+                                \"# Logging healthy and ready endpoints is very verbose because of Kubernetes health checking.\\n\" +\n+                                \"logger.healthy.name = http.openapi.operation.healthy\\n\" +\n+                                \"logger.healthy.level = OFF\\n\" +\n+                                \"logger.ready.name = http.openapi.operation.ready\\n\" +\n+                                \"logger.ready.level = OFF\"))\n+                .build();\n+\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(configMapBridge);\n+\n+        ExternalLogging bridgeXternalLogging = new ExternalLoggingBuilder()\n+                .withName(\"external-configmap-bridge\")\n+                .build();\n+\n+        LOGGER.info(\"Setting log level of Bridge to OFF - records should not appear in the log\");\n+        // change to the external logging\n+        KafkaBridgeResource.replaceBridgeResource(CLUSTER_NAME, bridz -> {", "originalCommit": "d78d96771fd18e44892fb603edba62102e1e47ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5Mzg4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r453693886", "bodyText": "Yeah, it is a prevention of using test-scope-var and lambda-scope-var with the same name. I can rename it if you wish so.", "author": "sknot-rh", "createdAt": "2020-07-13T14:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwMjk3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r453702973", "bodyText": "is that a czech word? :-)", "author": "ppatierno", "createdAt": "2020-07-13T14:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3MTI1Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r454171256", "bodyText": "Kinda :)", "author": "sknot-rh", "createdAt": "2020-07-14T07:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTYzNQ=="}], "type": "inlineReview"}, {"oid": "474ebf4ba12b0e6fd11d3cd71543f509f8d730b3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/474ebf4ba12b0e6fd11d3cd71543f509f8d730b3", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-14T08:14:58Z", "type": "commit"}]}