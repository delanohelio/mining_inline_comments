{"pr_number": 3555, "pr_title": "[ST] test availability during nodes drain", "pr_createdAt": "2020-08-26T17:39:26Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555", "timeline": [{"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/62ec650acadbc91ac8dc856c2499365573ac4e55", "message": "[ST] test availability during nodes drain\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-08-26T17:37:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTUxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477485514", "bodyText": "Guess you want to use there different log message.", "author": "Frawless", "createdAt": "2020-08-26T17:58:12Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/annotations/RequiredMinKubeApiVersionCondition.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.annotations;\n+\n+import io.strimzi.test.k8s.KubeClusterResource;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.extension.ConditionEvaluationResult;\n+import org.junit.jupiter.api.extension.ExecutionCondition;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.util.Optional;\n+\n+import static org.junit.platform.commons.support.AnnotationSupport.findAnnotation;\n+\n+public class RequiredMinKubeApiVersionCondition implements ExecutionCondition {\n+    private static final Logger LOGGER = LogManager.getLogger(RequiredMinKubeApiVersionCondition.class);\n+\n+    @Override\n+    public ConditionEvaluationResult evaluateExecutionCondition(ExtensionContext extensionContext) {\n+        Optional<RequiredMinKubeApiVersion> annotation = findAnnotation(extensionContext.getElement(), RequiredMinKubeApiVersion.class);\n+        KubeClusterResource clusterResource = KubeClusterResource.getInstance();\n+        double version = annotation.get().version();\n+\n+        if (Double.parseDouble(clusterResource.client().clusterKubernetesVersion()) >= version) {\n+            return ConditionEvaluationResult.enabled(\"Test is enabled\");\n+        } else {\n+            LOGGER.info(\"{} is @MultiNodeClusterOnly, but the running cluster is not multi-node cluster: Ignoring {}\",", "originalCommit": "62ec650acadbc91ac8dc856c2499365573ac4e55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwNzc5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477507798", "bodyText": "right, will fix it", "author": "kornys", "createdAt": "2020-08-26T18:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTc2MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477485760", "bodyText": "Wouldn't be better to use there real version instead of 0 ?", "author": "Frawless", "createdAt": "2020-08-26T17:58:35Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/annotations/RequiredMinKubeApiVersion.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.annotations;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Target({ElementType.METHOD, ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+@ExtendWith(RequiredMinKubeApiVersionCondition.class)\n+public @interface RequiredMinKubeApiVersion {\n+    double version() default 0;", "originalCommit": "62ec650acadbc91ac8dc856c2499365573ac4e55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwNzcwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477507704", "bodyText": "impossible, you have to use constant value in annotation, so 0 is the best value I guess", "author": "kornys", "createdAt": "2020-08-26T18:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NjY0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477486644", "bodyText": "We use indentation across whole project for piece of code like this. You should follow our current practice.", "author": "Frawless", "createdAt": "2020-08-26T18:00:05Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+", "originalCommit": "62ec650acadbc91ac8dc856c2499365573ac4e55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwNzg3Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477507877", "bodyText": "weird, but I will fix it", "author": "kornys", "createdAt": "2020-08-26T18:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NjY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NzcyNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477487726", "bodyText": "Just a note: this is used to kinda simulate worse environment for clients cause we already had issues, that tests were green, but users were able to hit issues with producers and lost messages.", "author": "Frawless", "createdAt": "2020-08-26T18:01:54Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        topicNames.forEach(topicName -> KafkaTopicResource.topic(CLUSTER_NAME, topicName, 3, 3, 2).done());\n+\n+        String producerAdditionConfiguration = \"delivery.timeout.ms=20000\\nrequest.timeout.ms=20000\";", "originalCommit": "62ec650acadbc91ac8dc856c2499365573ac4e55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4ODYyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477488625", "bodyText": "Does it means we cannot use OLM/Helm install for this scenario?", "author": "Frawless", "createdAt": "2020-08-26T18:03:31Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        topicNames.forEach(topicName -> KafkaTopicResource.topic(CLUSTER_NAME, topicName, 3, 3, 2).done());\n+\n+        String producerAdditionConfiguration = \"delivery.timeout.ms=20000\\nrequest.timeout.ms=20000\";\n+        producerNames.forEach(producerName -> KafkaClientsResource.producerStrimzi(\n+                producerName,\n+                KafkaResources.plainBootstrapAddress(CLUSTER_NAME),\n+                topicNames.get(producerNames.indexOf(producerName)),\n+                continuousClientsMessageCount, producerAdditionConfiguration).done());\n+\n+\n+        consumerNames.forEach(consumerName -> KafkaClientsResource.consumerStrimzi(\n+                consumerName,\n+                KafkaResources.plainBootstrapAddress(CLUSTER_NAME),\n+                topicNames.get(consumerNames.indexOf(consumerName)),\n+                continuousClientsMessageCount, \"\",\n+                continuousConsumerGroups.get(consumerNames.indexOf(consumerName))).done());\n+\n+        // ##############################\n+        // Nodes draining\n+        // ##############################\n+        for (Node node : nodes) {\n+            drainNode(node.getMetadata().getName());\n+            setNodeSchedule(node.getMetadata().getName(), true);\n+        }\n+\n+        producerNames.forEach(producerName -> ClientUtils.waitTillContinuousClientsFinish(producerName, consumerNames.get(producerName.indexOf(producerName)), NAMESPACE, continuousClientsMessageCount));\n+        producerNames.forEach(producerName -> kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(producerName).delete());\n+        consumerNames.forEach(consumerName -> kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(consumerName).delete());\n+    }\n+\n+    @BeforeAll\n+    void setup() {\n+        ResourceManager.setClassResources();\n+        prepareEnvForOperator(NAMESPACE);\n+\n+        applyRoleBindings(NAMESPACE);\n+        BundleResource.clusterOperator(NAMESPACE).done();", "originalCommit": "62ec650acadbc91ac8dc856c2499365573ac4e55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwNzk5NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477507995", "bodyText": "just copied :) I will fix it", "author": "kornys", "createdAt": "2020-08-26T18:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4ODYyNQ=="}], "type": "inlineReview"}, {"oid": "5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6", "message": "Address comments + fix maven dependencies\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-08-26T19:31:46Z", "type": "commit"}]}