{"pr_number": 2496, "pr_title": "KafkaMirrorMaker2: Support MM2 connectors pause/resume and status", "pr_createdAt": "2020-02-03T00:20:03Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2496", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk3NjE3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2496#discussion_r373976173", "bodyText": "How does this fit with the KafkaConnectorStatus class? It seems there is some overlap, I wonder if we can reuse it or something.", "author": "scholzj", "createdAt": "2020-02-03T08:41:58Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ConnectorStatus.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.kafka.model.status;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+\n+import io.strimzi.api.kafka.model.UnknownPropertyPreserving;\n+import io.strimzi.crdgenerator.annotations.Description;\n+import io.sundr.builder.annotations.Buildable;\n+import lombok.EqualsAndHashCode;\n+\n+import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Representation of the status of a connector in the Kafka MirrorMaker 2.0 deployment\n+ */\n+@Buildable(\n+        editableEnabled = false,\n+        generateBuilderPackage = false,\n+        builderPackage = \"io.fabric8.kubernetes.api.builder\"\n+)\n+@JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+@JsonPropertyOrder({ \"name\", \"status\" })\n+@EqualsAndHashCode\n+public class ConnectorStatus implements Serializable, UnknownPropertyPreserving {", "originalCommit": "b47c336df743597aed48494fd2d841929d319578", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ5MjY4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2496#discussion_r376492681", "bodyText": "I have updated the CrdGenerator to support a list of java.util.Map object, which makes the KafkaMirrorMaker2Status class more closely line up with the KafkaConnectorStatus and means this class (ConnectorStatus) can be removed from this PR.", "author": "ajborley", "createdAt": "2020-02-07T16:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk3NjE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Mzk5NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2496#discussion_r376263995", "bodyText": "This looks to be more or less identical to the code we use for KafkaConnectors. Can we factor out a common method?", "author": "tombentley", "createdAt": "2020-02-07T08:22:17Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMaker2AssemblyOperator.java", "diffHunk": "@@ -358,6 +362,47 @@ private static void addClusterToMirrorMaker2ConnectorConfig(Map<String, Object>\n         config.putAll(cluster.getAdditionalProperties());\n     }\n \n+    private Future<Map<String, Object>> reconcileMirrorMaker2Connector(Reconciliation reconciliation, KafkaMirrorMaker2 mirrorMaker2, KafkaConnectApi apiClient, String host, String connectorName, KafkaConnectorSpec connectorSpec, KafkaMirrorMaker2Status mirrorMaker2Status) {\n+        return apiClient.createOrUpdatePutRequest(host, KafkaConnectCluster.REST_API_PORT, connectorName, asJson(connectorSpec))\n+                .compose(ignored -> apiClient.statusWithBackOff(new BackOff(200L, 2, 6), host, KafkaConnectCluster.REST_API_PORT, connectorName))\n+                .compose(status -> {\n+                    Object path = ((Map) status.getOrDefault(\"connector\", emptyMap())).get(\"state\");\n+                    if (!(path instanceof String)) {\n+                        return Future.failedFuture(\"JSON response lacked $.connector.state\");\n+                    } else {\n+                        String state = (String) path;\n+                        boolean shouldPause = Boolean.TRUE.equals(connectorSpec.getPause());\n+                        if (\"RUNNING\".equals(state) && shouldPause) {\n+                            log.debug(\"{}: Pausing connector {}\", reconciliation, connectorName);\n+                            return apiClient.pause(host, KafkaConnectCluster.REST_API_PORT, connectorName)\n+                                    .compose(ignored ->\n+                                            apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n+                                                    connectorName));\n+                        } else if (\"PAUSED\".equals(state) && !shouldPause) {\n+                            log.debug(\"{}: Resuming connector {}\", reconciliation, connectorName);\n+                            return apiClient.resume(host, KafkaConnectCluster.REST_API_PORT,\n+                                    connectorName)\n+                                    .compose(ignored ->\n+                                            apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n+                                                    connectorName));\n+", "originalCommit": "b47c336df743597aed48494fd2d841929d319578", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ5MzI5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2496#discussion_r376493290", "bodyText": "Agreed - the latest commit factors out the common code.", "author": "ajborley", "createdAt": "2020-02-07T16:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Mzk5NQ=="}], "type": "inlineReview"}, {"oid": "14f3e371af284790b2673cf0aeaacd29b28d0162", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/14f3e371af284790b2673cf0aeaacd29b28d0162", "message": "Address review comments\n\n - This commit supports using a list of maps in the CrdGenerator, which\nremoves the need for the ConnectorStatus class.\n - It also refactors the Connector and MM2 operators so that I'm not\nduplicating code.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-02-07T16:31:36Z", "type": "forcePushed"}, {"oid": "f238f862cbae62aac7b0ebebdbe92370792c8681", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f238f862cbae62aac7b0ebebdbe92370792c8681", "message": "feat: Support pausing/resuming MM2 connectors via MM2 CR\n\n - Also reports the status of mirrorMaker 2.0 connectors in the CR\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-02-07T17:46:43Z", "type": "commit"}, {"oid": "a2f9246068f829f96bf147f936322bdbb0819c3f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a2f9246068f829f96bf147f936322bdbb0819c3f", "message": "Address review comments\n\n - This commit supports using a list of maps in the CrdGenerator, which\nremoves the need for the ConnectorStatus class.\n - It also refactors the Connector and MM2 operators so that I'm not\nduplicating code.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-02-07T17:46:43Z", "type": "commit"}, {"oid": "a2f9246068f829f96bf147f936322bdbb0819c3f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a2f9246068f829f96bf147f936322bdbb0819c3f", "message": "Address review comments\n\n - This commit supports using a list of maps in the CrdGenerator, which\nremoves the need for the ConnectorStatus class.\n - It also refactors the Connector and MM2 operators so that I'm not\nduplicating code.\n\nSigned-off-by: Andrew Borley <borley@uk.ibm.com>", "committedDate": "2020-02-07T17:46:43Z", "type": "forcePushed"}]}