{"pr_number": 2777, "pr_title": "Fix NPE during RU ST", "pr_createdAt": "2020-04-02T07:54:06Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMzczOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r402123738", "bodyText": "It would be good to understand how we can get into this situation. My concern is that maybe it's fine not to roll the pod if it (momentarily) doesn't exist. But does that mean we don't wait for its readiness (I think we would wait for it's readiness, but will an NPE pop up in that code)?", "author": "tombentley", "createdAt": "2020-04-02T08:02:15Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -733,7 +733,10 @@ public void checkCustomCaSecret(CertificateAuthority ca, Secret certSecret, Secr\n                         if (Annotations.booleanAnnotation(sts, Annotations.ANNO_STRIMZI_IO_MANUAL_ROLLING_UPDATE,\n                                 false, Annotations.ANNO_OP_STRIMZI_IO_MANUAL_ROLLING_UPDATE)) {\n                             return kafkaSetOperations.maybeRollingUpdate(sts, pod -> {\n-\n+                                if (pod == null) {\n+                                    log.debug(\"Pod not found, no need to roll\");\n+                                    return \"\";", "originalCommit": "49da61c5a9fe8bc3b2a6fb95806f78d738fe79ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyODU0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r402128541", "bodyText": "Looking at the affected ST I think we are waiting for the pod readiness correctly.\nThis issue appears if these two STs run in this order: io.strimzi.systemtest.RollingUpdateST#testKafkaWontRollUpBecauseTopic, io.strimzi.systemtest.RollingUpdateST#testExternalLoggingChangeTriggerRollingUpdate", "author": "sknot-rh", "createdAt": "2020-04-02T08:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMzczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2ODI0Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r402168243", "bodyText": "That's an observation, not an explanation. What is it about running those tests in that order which causes the failure? Understanding the real reason is important. It could be an issue with the tests. It could be we find out about a much more general problem with the operator. If you never understand the true reason we'll never know.", "author": "tombentley", "createdAt": "2020-04-02T09:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMzczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NDIxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r402174214", "bodyText": "I don't think it's problem in the tests since we only delete Kafka CR and waiting for deletion. We do force deletion of pods every 10 seconds (we had issues with an automatic deletion on some environments), it might be caused by it even when CR is no longer available?", "author": "Frawless", "createdAt": "2020-04-02T09:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMzczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNTcxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r402235712", "bodyText": "AFAIK these are just race conditions when the Pods are deleted by garbage collection while reconciliation is running?", "author": "scholzj", "createdAt": "2020-04-02T11:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMzczOA=="}], "type": "inlineReview"}, {"oid": "7974567ed476440f034b275d61ae1910b64afac0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7974567ed476440f034b275d61ae1910b64afac0", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-08T14:10:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NTIzMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r405595232", "bodyText": "I think you should adapt the message both here and the log. It does not make sense in relation to the exception which essentially kills the reocnciliation.", "author": "scholzj", "createdAt": "2020-04-08T15:05:07Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -733,7 +734,10 @@ public void checkCustomCaSecret(CertificateAuthority ca, Secret certSecret, Secr\n                         if (Annotations.booleanAnnotation(sts, Annotations.ANNO_STRIMZI_IO_MANUAL_ROLLING_UPDATE,\n                                 false, Annotations.ANNO_OP_STRIMZI_IO_MANUAL_ROLLING_UPDATE)) {\n                             return kafkaSetOperations.maybeRollingUpdate(sts, pod -> {\n-\n+                                if (pod == null) {\n+                                    log.debug(\"Pod not found, no need to roll\");\n+                                    throw new ConcurrentDeletionException(\"Pod not found, no need to roll\");", "originalCommit": "7974567ed476440f034b275d61ae1910b64afac0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMTAzOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2777#discussion_r405601039", "bodyText": "@stanlyDoge think of this more like a failed assertion: If we got here it means something relatively unexpected happened, because the pod must have got deleted since we started the reconciliation loop. So something like \"Unexpectedly pod no longer exists during roll of StatefulSet\" would be better.", "author": "tombentley", "createdAt": "2020-04-08T15:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NTIzMg=="}], "type": "inlineReview"}, {"oid": "281b89e3a4895689cd9d183a22fcfd9b02d31fbe", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/281b89e3a4895689cd9d183a22fcfd9b02d31fbe", "message": "Fix NPE during RU ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-17T12:07:51Z", "type": "commit"}, {"oid": "508287cb800406cbc5f9432cf36c432ed48930e2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/508287cb800406cbc5f9432cf36c432ed48930e2", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-17T12:08:37Z", "type": "commit"}, {"oid": "8482645147d6aee72e84717ddde53ff562d1034e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8482645147d6aee72e84717ddde53ff562d1034e", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-17T12:08:37Z", "type": "commit"}, {"oid": "8482645147d6aee72e84717ddde53ff562d1034e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8482645147d6aee72e84717ddde53ff562d1034e", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-17T12:08:37Z", "type": "forcePushed"}]}