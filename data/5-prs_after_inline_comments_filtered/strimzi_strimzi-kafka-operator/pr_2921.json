{"pr_number": 2921, "pr_title": "Ensure CC topics are configured with log.cleanup.policy=delete", "pr_createdAt": "2020-04-29T23:08:07Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMTA5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r418301094", "bodyText": "I was wondering if we should not allow to do this configuration directly in the spec.kafka.config of the Kafka resource but exposing these fields in a more user friendly way in the cruiseControl field. The problem I see is that if we start in this way, then we could come up to do the same for a tons of cruise control related parameter in Kafka broker (so more related to the metrics reporter) and we fill the cruiseControl too much but maybe I am wrong.", "author": "ppatierno", "createdAt": "2020-04-30T21:31:41Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaClusterSpec.java", "diffHunk": "@@ -51,7 +51,8 @@\n             + \"zookeeper.connect, zookeeper.set.acl, authorizer., super.user\"\n             + \"cruise.control.metrics.topic, cruise.control.metrics.reporter.bootstrap.servers\";\n \n-    public static final String FORBIDDEN_PREFIX_EXCEPTIONS = \"zookeeper.connection.timeout.ms, ssl.cipher.suites, ssl.protocol, ssl.enabled.protocols\";\n+    public static final String FORBIDDEN_PREFIX_EXCEPTIONS = \"zookeeper.connection.timeout.ms, ssl.cipher.suites, ssl.protocol, ssl.enabled.protocols, \"\n+            + \"cruise.control.metrics.topic.num.partitions, cruise.control.metrics.topic.replication.factor\";", "originalCommit": "08187d53006b40e224fe6701a40d0b01bed19aeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcyMTM1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r418721355", "bodyText": "I do like the idea of keeping the cruise control configurations, including the cruise control metric reporter in one place but I think it may be be better to stay consistent with upstream Cruise Control (at least for now). Diverting from the upstream Cruise Control documentation would add overhead to our code and documentation and there shouldn't be much(if any) tweaking needed on the metric reporter side (avoiding the metric reporter configuration bloat in the Kafka broker configuration!)", "author": "kyguy", "createdAt": "2020-05-01T20:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMTA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2ODAwMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r418768000", "bodyText": "Are we sure this is the right default setting?", "author": "scholzj", "createdAt": "2020-05-01T22:44:21Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/model/KafkaBrokerConfigurationBuilderTest.java", "diffHunk": "@@ -79,7 +79,10 @@ public void testCruiseControl()  {\n                 \"cruise.control.metrics.reporter.ssl.keystore.password=${CERTS_STORE_PASSWORD}\\n\" +\n                 \"cruise.control.metrics.reporter.ssl.truststore.type=PKCS12\\n\" +\n                 \"cruise.control.metrics.reporter.ssl.truststore.location=/tmp/kafka/cluster.truststore.p12\\n\" +\n-                \"cruise.control.metrics.reporter.ssl.truststore.password=${CERTS_STORE_PASSWORD}\"));\n+                \"cruise.control.metrics.reporter.ssl.truststore.password=${CERTS_STORE_PASSWORD}\\n\" +\n+                \"cruise.control.metrics.topic.auto.create=true\\n\" +\n+                \"cruise.control.metrics.topic.num.partitions=1\\n\" +\n+                \"cruise.control.metrics.topic.replication.factor=1\"));", "originalCommit": "ec1f30583431cadceb7bea0bc20be272561fdecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzMTA3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r419331074", "bodyText": "other than that I don't see it working. I tried but the AdminClient times out 3 times fetching metadata before creating the topic and it gives up. I will investigate more.", "author": "ppatierno", "createdAt": "2020-05-04T10:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2ODAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgxNTczMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r419815730", "bodyText": "Updated these to match the Kafka configuration default; CC doesn't specify a default for these parameters", "author": "kyguy", "createdAt": "2020-05-05T01:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2ODAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2OTM3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r418769379", "bodyText": "What about other settings? Retention? Segment size? etc.? If we assume the user configures these topics, there are many options which migght make sense. So shouldn't the whole cruise.control.metrics.topic. segment be user-configurable?", "author": "scholzj", "createdAt": "2020-05-01T22:49:43Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaClusterSpec.java", "diffHunk": "@@ -51,7 +51,8 @@\n             + \"zookeeper.connect, zookeeper.set.acl, authorizer., super.user\"\n             + \"cruise.control.metrics.topic, cruise.control.metrics.reporter.bootstrap.servers\";\n \n-    public static final String FORBIDDEN_PREFIX_EXCEPTIONS = \"zookeeper.connection.timeout.ms, ssl.cipher.suites, ssl.protocol, ssl.enabled.protocols\";\n+    public static final String FORBIDDEN_PREFIX_EXCEPTIONS = \"zookeeper.connection.timeout.ms, ssl.cipher.suites, ssl.protocol, ssl.enabled.protocols, \"\n+            + \"cruise.control.metrics.topic.num.partitions, cruise.control.metrics.topic.replication.factor\";", "originalCommit": "ec1f30583431cadceb7bea0bc20be272561fdecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgxNjA2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r419816067", "bodyText": "Updated so the user is free to configure these things", "author": "kyguy", "createdAt": "2020-05-05T01:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2OTM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNDc5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r420414790", "bodyText": "I had to double back and forbid cruise.control.metrics.topic as it is used to change the name of the CC metric topic. I have added all of the other cruise.control.metrics.topic options to the exception list, there are only three of them: cruise.control.metrics.topic.num.partitions, cruise.control.metrics.topic.replication.factor, cruise.control.metrics.topic.retention.ms", "author": "kyguy", "createdAt": "2020-05-05T21:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc2OTM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg5MDMzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r419890333", "bodyText": "I am a little bit confused here. We are enabling the metrics reporter topic auto-creation but we actually know that it's not going to work when Kafka broker auto topic creation is disabled.\nRegarding the num of partitions and replication factor, I see that these parameters are coming from the KafkaCluster model where the defaults are \"1\". It sounds weird because they should be some defaults for specific metrics reporter topic creation not related to Kafka itself (which has these values by default to 1 anyway when the auto topic creation is enabled).\nWe are also enabling this stuff by default, is really what we want? It means that user cannot disable metrics reporter auto topic creation, or?", "author": "ppatierno", "createdAt": "2020-05-05T06:31:58Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaBrokerConfigurationBuilder.java", "diffHunk": "@@ -84,6 +86,9 @@ public KafkaBrokerConfigurationBuilder withCruiseControl(String clusterName, Cru\n             writer.println(\"cruise.control.metrics.reporter.ssl.truststore.type=PKCS12\");\n             writer.println(\"cruise.control.metrics.reporter.ssl.truststore.location=/tmp/kafka/cluster.truststore.p12\");\n             writer.println(\"cruise.control.metrics.reporter.ssl.truststore.password=${CERTS_STORE_PASSWORD}\");\n+            writer.println(\"cruise.control.metrics.topic.auto.create=true\");\n+            writer.println(\"cruise.control.metrics.topic.num.partitions=\" + defaultNumPartitions);\n+            writer.println(\"cruise.control.metrics.topic.replication.factor=\" + defaultReplicationFactor);", "originalCommit": "1279e6cc99e348f12c0a4c1912b12e5aec47bd6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3ODQwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r420278404", "bodyText": "I am a little bit confused here. We are enabling the metrics reporter topic auto-creation but we actually know that it's not going to work when Kafka broker auto topic creation is disabled.\n\nAs discussed earlier today, the metrics reporter topic auto-creation will work in all situations except when being started with a new Kafka cluster, so we enable by default and forbid the user from setting it. This way, the topic creation/configuration will work correctly for all other situations\n\nRegarding the num of partitions and replication factor, I see that these parameters are coming from the KafkaCluster model where the defaults are \"1\". It sounds weird because they should be some defaults for specific metrics reporter topic creation not related to Kafka itself (which has these values by default to 1 anyway when the auto topic creation is enabled).\n\nAh yes, those values should be coming from CC metric reporter config first and the Kafka config  second if the CC metric reporter config are not set for these fields. I'll update that in the next commit, nice catch!\n\nWe are also enabling this stuff by default, is really what we want? It means that user cannot disable metrics reporter auto topic creation, or?\n\nYes definitely, we only gain by having this setting locked in as enabled, plus we will this enabled anyway for the metric reporter patch will commit upstream.", "author": "kyguy", "createdAt": "2020-05-05T17:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg5MDMzMw=="}], "type": "inlineReview"}, {"oid": "e186e6e5f54e38894bf0b350a5772bbc8d2e73d9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e186e6e5f54e38894bf0b350a5772bbc8d2e73d9", "message": "Refactor for example file change\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-06T13:28:20Z", "type": "forcePushed"}, {"oid": "a5c4b370d07eac0f4b0f1d2c2956a2c687810698", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a5c4b370d07eac0f4b0f1d2c2956a2c687810698", "message": "Ensure CC topics are configured with log.cleanup.policy=delete\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:50:52Z", "type": "commit"}, {"oid": "15185b0b9e72203504e5b8515a4822615504fa19", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/15185b0b9e72203504e5b8515a4822615504fa19", "message": "Adding docs and Cruise Control topic creation example\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:52:26Z", "type": "commit"}, {"oid": "54d98918da780f8640f21cc2cd8f5f8dc4a61348", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/54d98918da780f8640f21cc2cd8f5f8dc4a61348", "message": "Add CC topic example, undo changes to CC deployment example\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "480539ee4898104482d2ddf98033d1bf51bb4952", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/480539ee4898104482d2ddf98033d1bf51bb4952", "message": "Addressing comments (Allow CC metric topic config + refactor template file)\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "c31c7ac913fcb59261add0e8b94de3c0ab1a48f8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c31c7ac913fcb59261add0e8b94de3c0ab1a48f8", "message": "Addressing more comments\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "0be8c60f4d9e83231e75bcffef665d8d78ddcc78", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0be8c60f4d9e83231e75bcffef665d8d78ddcc78", "message": "Fixing a typo\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "6ad1ca91bf5e88ed508dad20da849547b9195902", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6ad1ca91bf5e88ed508dad20da849547b9195902", "message": "Remove added line typo in doc\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "764c2e29f6a48e9304df9fb89bead42d1b5b351e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/764c2e29f6a48e9304df9fb89bead42d1b5b351e", "message": "Fix typo in helm charts\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "52732b81905774cab746b239f2ef4117ae8c9e31", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/52732b81905774cab746b239f2ef4117ae8c9e31", "message": "Fix examples in docs\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T17:53:01Z", "type": "commit"}, {"oid": "2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "message": "Addressing more doc comments\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T18:02:17Z", "type": "commit"}, {"oid": "2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "message": "Addressing more doc comments\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T18:02:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNjQwNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r424026407", "bodyText": "I think the names here are confusing. If I read the code right ... the kafkaDefault* are the defaults which will be used when user doesn't specify anything specific size? And the ccDefault* are the actual value either user configured of default? In which case they should not be named default because that is confusing and when you see default you expect there to be some other non-default value. So IMHO you should rename it (including the KafkaBrokerConfiguration etc.)", "author": "scholzj", "createdAt": "2020-05-12T20:52:47Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -221,6 +225,10 @@\n     private KafkaAuthorization authorization;\n     private KafkaVersion kafkaVersion;\n     private CruiseControlSpec cruiseControlSpec;\n+    private String kafkaDefaultNumPartitions = \"1\";\n+    private String kafkaDefaultReplicationFactor = \"1\";\n+    private String ccDefaultNumPartitions = null;\n+    private String ccDefaultReplicationFactor = null;", "originalCommit": "2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyOTA5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r424029094", "bodyText": "If I read this section right, the flow is that:\n\nThe user specifies these topions in Kafka.spec.kafka.config\nYou read them from there\nYou pass them to the KafkaBrokerConfigurationBuilder which puts them into the broker configuration file\n\nBut at the same time, they will be put into the KAfka broker configuration as part of withUserConfiguration so they will be there twice, or?", "author": "scholzj", "createdAt": "2020-05-12T20:57:38Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -457,6 +465,13 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         }\n \n         KafkaConfiguration configuration = new KafkaConfiguration(kafkaClusterSpec.getConfig().entrySet());\n+        // If  required Cruise Control metric reporter configurations are missing set them using Kafka defaults\n+        if (configuration.getConfigOption(CC_NUM_PARTITIONS_CONFIG_FIELD) == null) {\n+            result.ccDefaultNumPartitions = configuration.getConfigOption(KAFKA_NUM_PARTITIONS_CONFIG_FIELD, result.kafkaDefaultNumPartitions);\n+        }\n+        if (configuration.getConfigOption(CC_REPLICATION_FACTOR_CONFIG_FIELD) == null) {\n+            result.ccDefaultReplicationFactor = configuration.getConfigOption(KAFKA_REPLICATION_FACTOR_CONFIG_FIELD, result.kafkaDefaultReplicationFactor);\n+        }", "originalCommit": "2a441eb0d9ece5350e54c33f9a34dcb0f284fb42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MzM5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2921#discussion_r424083398", "bodyText": "This is the intended logic flow:\n\nThe user specifies options, cruise.control.metrics.topic.num.partitions and/or cruise.control.metrics.topic.replication.factor in the Kafka.spec.kafka.config\nThese options are read\nThe if-statements highlighted above will not execute since they are found in the map with getConfigOption(), so the fields ccNumPartitions and ccReplicationFactor will remain null\nThe ccNumPartitions and ccReplicationFactor fields are passed to  KafkaBrokerConfigurationBuilder, but will not be added to the broker configuration since they are null. This way these options are only added once to the broker configuration.\n\n  \n    \n      strimzi-kafka-operator/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaBrokerConfigurationBuilder.java\n    \n    \n        Lines 90 to 95\n      in\n      2a441eb\n    \n    \n    \n    \n\n        \n          \n           if (defaultNumPartitions != null) { \n        \n\n        \n          \n               writer.println(\"cruise.control.metrics.topic.num.partitions=\" + defaultNumPartitions); \n        \n\n        \n          \n           } \n        \n\n        \n          \n           if (defaultReplicationFactor != null) { \n        \n\n        \n          \n               writer.println(\"cruise.control.metrics.topic.replication.factor=\" + defaultReplicationFactor); \n        \n\n        \n          \n           }", "author": "kyguy", "createdAt": "2020-05-12T23:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyOTA5NA=="}], "type": "inlineReview"}, {"oid": "2b6d00c79863eb171da1c9907a75c8c54e8adec5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2b6d00c79863eb171da1c9907a75c8c54e8adec5", "message": "Refactoring option field names\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-12T23:09:10Z", "type": "commit"}, {"oid": "0cb6258f367bd87840f07b8f5ebf70f37a5b5eff", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0cb6258f367bd87840f07b8f5ebf70f37a5b5eff", "message": "Moving topic example to cruise-control folder\n\nSigned-off-by: Kyle Liberti <kliberti@redhat.com>", "committedDate": "2020-05-13T00:18:41Z", "type": "commit"}]}