{"pr_number": 2453, "pr_title": "ST: Add test for connect and connects2i with same name", "pr_createdAt": "2020-01-24T17:23:28Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453", "timeline": [{"oid": "72f51e2a565193b7871c1d901eeb7870060a7f9c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/72f51e2a565193b7871c1d901eeb7870060a7f9c", "message": "Add test for connect and connects2i with same name\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T09:39:23Z", "type": "commit"}, {"oid": "c7da02628bb46cf71779a98360738b6d86c7389c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c7da02628bb46cf71779a98360738b6d86c7389c", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T10:46:43Z", "type": "forcePushed"}, {"oid": "8ee48b0c656c4bbe109e2d69bdc7593ce0ea36bc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8ee48b0c656c4bbe109e2d69bdc7593ce0ea36bc", "message": "Finish the test case\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T10:47:46Z", "type": "commit"}, {"oid": "61468f0e12f286494fde47d7724324b78a903351", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/61468f0e12f286494fde47d7724324b78a903351", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T10:47:46Z", "type": "commit"}, {"oid": "61468f0e12f286494fde47d7724324b78a903351", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/61468f0e12f286494fde47d7724324b78a903351", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T10:47:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1MzM3MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372353371", "bodyText": "You have the comments from the oposite case - here is now S2I and on line 376 is regular connect.", "author": "scholzj", "createdAt": "2020-01-29T12:26:57Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,91 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Crate connect cluster with default connect image", "originalCommit": "61468f0e12f286494fde47d7724324b78a903351", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDUyMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372354523", "bodyText": "Right now both this and the connect test are in following order:\n\nCreate ConnectS2I\nCreate Connector\nCreate conflicting Connect with the same name.\n\nI wonder if the better order would be:\n\nCreate ConnectS2I\nCreate conflicting Connect with the same name.\nCreate Connector\n\nOr mybe at least try that for example connector update still works after you create the conflicting Connect.", "author": "scholzj", "createdAt": "2020-01-29T12:29:45Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,91 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Crate connect cluster with default connect image\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();", "originalCommit": "61468f0e12f286494fde47d7724324b78a903351", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDgyMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372354820", "bodyText": "That make sense, I will update it.", "author": "Frawless", "createdAt": "2020-01-29T12:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ3MDI2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372470262", "bodyText": "You probably need to test both to ensure the first-created-resource-wins strategy.", "author": "tombentley", "createdAt": "2020-01-29T15:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDUyMw=="}], "type": "inlineReview"}, {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "message": "Workin comments from review\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T15:35:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ2ODI1Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372468256", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Crate connect cluster with default connect image\n          \n          \n            \n                    // Create connect cluster with default connect image", "author": "tombentley", "createdAt": "2020-01-29T15:53:48Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,101 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Create different connect cluster via S2I resources\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();\n+\n+        // Crate connect cluster with default connect image", "originalCommit": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ2ODY2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372468662", "bodyText": "Reconciliation of what?", "author": "tombentley", "createdAt": "2020-01-29T15:54:25Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,101 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Create different connect cluster via S2I resources\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();\n+\n+        // Crate connect cluster with default connect image\n+        KafkaConnectResource.kafkaConnectWithoutWait(KafkaConnectResource.defaultKafkaConnect(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+            .editSpec()\n+                .addToConfig(\"group.id\", connectS2IClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectS2IClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectS2IClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectS2IClusterName + \"-status\")\n+            .endSpec().build());\n+\n+        KafkaConnectUtils.waitForConnectStatus(CLUSTER_NAME, \"NotReady\");\n+\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME)\n+            .editSpec()\n+                .withClassName(\"org.apache.kafka.connect.file.FileStreamSinkConnector\")\n+                .addToConfig(\"topics\", topicName)\n+                .addToConfig(\"file\", \"/tmp/test-file-sink.txt\")\n+                .addToConfig(\"key.converter\", \"org.apache.kafka.connect.storage.StringConverter\")\n+                .addToConfig(\"value.converter\", \"org.apache.kafka.connect.storage.StringConverter\")\n+            .endSpec().done();\n+        KafkaConnectUtils.waitForConnectorReady(CLUSTER_NAME);\n+\n+        // Wait for first reconciliation\n+        StUtils.waitForReconciliation(testClass, testName, NAMESPACE);", "originalCommit": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec1c101347af8c61d27c486e06ebac84988ad1fd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ec1c101347af8c61d27c486e06ebac84988ad1fd", "message": "fixup! Workin comments from review\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-01-29T16:56:48Z", "type": "commit"}]}