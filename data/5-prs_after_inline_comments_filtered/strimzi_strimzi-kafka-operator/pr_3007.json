{"pr_number": 3007, "pr_title": "[systemtest][kafkatopic] Decrease topic partitions and min.insync.replicas tests", "pr_createdAt": "2020-05-13T11:44:49Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1OTcwNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424459707", "bodyText": "The original issue wasn't just that the status was wrong, but also that it flipped back to Ready on the next reconciliation. So if this is intended as a regression test we should probably wait for a reconciliation interval and make the same assertion again.", "author": "tombentley", "createdAt": "2020-05-13T13:58:35Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);", "originalCommit": "b07d1abe6e2cdc244471769db3d2e97e663c134e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MzAxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424463011", "bodyText": "Yes, you are right, I didn't read the issue correctly, thanks for the comment.", "author": "im-konge", "createdAt": "2020-05-13T14:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1OTcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MDY5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424460690", "bodyText": "It's the reconciliation interval you need to wait for. Hard coding 60s is fragile. You could obtaint the interval by reading it from the env var of the TO container in the EO pod. That way the test would not break even if the interval later got changed.", "author": "tombentley", "createdAt": "2020-05-13T13:59:53Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);\n+    }\n+\n+    @Test\n+    void testKafkaTopicChangingInSyncReplicasStatus() throws InterruptedException {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        String invalidValue = \"x\";\n+\n+        LOGGER.info(\"Changing min.insync.replicas to random char\");\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().getConfig().replace(\"min.insync.replicas\", invalidValue));\n+        KafkaTopicUtils.waitForKafkaTopicNotReady(TEST_TOPIC_NAME);\n+\n+        assertKafkaTopicWrongMinInSyncReplicasStatus(TEST_TOPIC_NAME, invalidValue);\n+\n+        // Wait some time to check if error is still present in KafkaTopic status\n+        Thread.sleep(60_000);", "originalCommit": "b07d1abe6e2cdc244471769db3d2e97e663c134e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MTU0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424461544", "bodyText": "Thanks for comment, I'll fix it", "author": "im-konge", "createdAt": "2020-05-13T14:00:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MDY5MA=="}], "type": "inlineReview"}, {"oid": "32c8e7a96fca9822061c46500a9e5e82c8265b8c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/32c8e7a96fca9822061c46500a9e5e82c8265b8c", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-13T16:55:55Z", "type": "forcePushed"}, {"oid": "510367401b66a780bf504a739fe2f4f45e9b1bdc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/510367401b66a780bf504a739fe2f4f45e9b1bdc", "message": "add test for decrease topic partitions\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:26Z", "type": "commit"}, {"oid": "e46bda06a73a615f1bfab0cb199b28941699ecbd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e46bda06a73a615f1bfab0cb199b28941699ecbd", "message": "add test for changin min.insync.replicas\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:26Z", "type": "commit"}, {"oid": "12a06a81bed189e837f6378284f19196f6200271", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/12a06a81bed189e837f6378284f19196f6200271", "message": "add methods for assertion and add sleep\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:27Z", "type": "commit"}, {"oid": "658cbecf681f472a47487200c879afae8bfa753e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/658cbecf681f472a47487200c879afae8bfa753e", "message": "fixup! add methods for assertion and add sleep\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:27Z", "type": "commit"}, {"oid": "18576f81c127056a37882c60f0d4cdd244bb954b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18576f81c127056a37882c60f0d4cdd244bb954b", "message": "fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:27Z", "type": "commit"}, {"oid": "24a18c101bdbd54871da4fe25edb89bcd0676db9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/24a18c101bdbd54871da4fe25edb89bcd0676db9", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T11:36:27Z", "type": "commit"}, {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "message": "fix deletion of CR\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T13:31:25Z", "type": "commit"}, {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "message": "fix deletion of CR\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T13:31:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE1NTA0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r425155048", "bodyText": "I think this timeout should be longer than reconicliation interval...and Maybe I will extend at least double times", "author": "Frawless", "createdAt": "2020-05-14T13:54:10Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -404,6 +439,9 @@ void deployTestSpecificResources() {\n \n         KafkaTopicResource.topic(CLUSTER_NAME, TOPIC_NAME).done();\n         KafkaClientsResource.deployKafkaClients(false, KAFKA_CLIENTS_NAME).done();\n+\n+        topicOperatorReconciliationInterval = KafkaResource.kafkaClient().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get()", "originalCommit": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bebc9c87f6b62db82ae932ecbe011a6a21e06556", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bebc9c87f6b62db82ae932ecbe011a6a21e06556", "message": "comments vol.2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-14T15:18:54Z", "type": "commit"}]}