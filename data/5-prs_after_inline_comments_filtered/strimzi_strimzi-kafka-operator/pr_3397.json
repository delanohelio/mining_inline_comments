{"pr_number": 3397, "pr_title": "[cc] Add test for topic exclusion, fix utils methods, change annotation location", "pr_createdAt": "2020-07-28T01:41:24Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397", "timeline": [{"oid": "9fb34f945e4097036fe490ab401b262a3c713e10", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9fb34f945e4097036fe490ab401b262a3c713e10", "message": "add test, fix utils methods\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-07-28T01:34:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1ODQ0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461358442", "bodyText": "why setting throttling and leader movements for this test?", "author": "ppatierno", "createdAt": "2020-07-28T06:54:51Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlIsolatedST.java", "diffHunk": "@@ -125,6 +122,37 @@ void testCruiseControlWithSingleNodeKafka() {\n         assertThat(kafkaStatus.getConditions().get(0).getMessage(), is(not(errMessage)));\n     }\n \n+    @Test\n+    void testCruiseControlTopicExclusion() {\n+        String excludedTopic1 = \"excluded-topic-1\";\n+        String excludedTopic2 = \"excluded-topic-2\";\n+        String includedTopic = \"included-topic\";\n+\n+        KafkaResource.kafkaWithCruiseControl(CLUSTER_NAME, 3, 3).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, excludedTopic1).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, excludedTopic2).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, includedTopic).done();\n+\n+        KafkaRebalanceResource.kafkaRebalance(CLUSTER_NAME)\n+            .editOrNewSpec()\n+                .withExcludedTopics(\"excluded-.*\")\n+                .withReplicationThrottle(200000)\n+                .withConcurrentLeaderMovements(1200)", "originalCommit": "9fb34f945e4097036fe490ab401b262a3c713e10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461423319", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, \"strimzi.io/rebalance=\" + annotation.toString())\n          \n          \n            \n                        .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, KafkaRebalanceAssemblyOperator.ANNO_STRIMZI_IO_REBALANCE + \"=\" + annotation.toString())", "author": "samuel-hawker", "createdAt": "2020-07-28T08:52:45Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaRebalanceUtils.java", "diffHunk": "@@ -45,7 +47,14 @@ private static Condition rebalanceStateCondition(String resourceName) {\n \n     public static void waitForKafkaRebalanceCustomResourceState(String resourceName, KafkaRebalanceState state) {\n         KafkaRebalance kafkaRebalance = KafkaRebalanceResource.kafkaRebalanceClient().inNamespace(kubeClient().getNamespace()).withName(resourceName).get();\n-        ResourceManager.waitForResourceStatus(KafkaRebalanceResource.kafkaRebalanceClient(), kafkaRebalance, state.toString());\n+        ResourceManager.waitForResourceStatus(KafkaRebalanceResource.kafkaRebalanceClient(), kafkaRebalance, state.toString(), ResourceOperation.getTimeoutForKafkaRebalanceState(state));\n+    }\n+\n+    public static String annotateKafkaRebalanceResource(String resourceName, KafkaRebalanceAnnotation annotation) {\n+        LOGGER.info(\"Annotating KafkaRebalance:{} with annotation {}\", resourceName, annotation.toString());\n+        return ResourceManager.cmdKubeClient().namespace(kubeClient().getNamespace())\n+            .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, \"strimzi.io/rebalance=\" + annotation.toString())", "originalCommit": "9fb34f945e4097036fe490ab401b262a3c713e10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyNjM3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461426376", "bodyText": "Yeah that looks better!", "author": "im-konge", "createdAt": "2020-07-28T08:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzMDM1Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461430352", "bodyText": "why not ...\nLOGGER.info(\"Annotating KafkaRebalance:{} with annotation {}={}\", resourceName, annotation.toString());\n        return ResourceManager.cmdKubeClient().namespace(kubeClient().getNamespace())\n            .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, KafkaRebalanceAssemblyOperator.ANNO_STRIMZI_IO_REBALANCE, annotation.toString())\navoiding the last string concatenation :P", "author": "ppatierno", "createdAt": "2020-07-28T09:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ0NTAxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461445011", "bodyText": "but won't that miss out the \"=\"?", "author": "tomncooper", "createdAt": "2020-07-28T09:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1MDI0NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461450245", "bodyText": "I have put it in the formatting string \"annotation {}={}\"", "author": "ppatierno", "createdAt": "2020-07-28T09:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUxMTA1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461511058", "bodyText": "Here is needed that =, how @samuel-hawker and @tomncooper said.\nio.strimzi.test.k8s.exceptions.KubeClusterException: `oc --namespace cruise-control-isolated-test annotate kafkarebalance my-cluster strimzi.io/rebalance approve` got status code 1 and stderr:\n------\nerror: at least one annotation update is required", "author": "im-konge", "createdAt": "2020-07-28T11:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUyNTI3MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461525271", "bodyText": "I mislead with the previous logger instruction :)", "author": "ppatierno", "createdAt": "2020-07-28T12:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ=="}], "type": "inlineReview"}, {"oid": "19a4b7a34a23152e8d856f2be25970860c709f96", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/19a4b7a34a23152e8d856f2be25970860c709f96", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-07-28T11:56:53Z", "type": "commit"}, {"oid": "92b711c60550e3bc64cb0c1b23a3083ef2bd60be", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/92b711c60550e3bc64cb0c1b23a3083ef2bd60be", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-07-28T12:09:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNjU5MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461536591", "bodyText": "What is this import used for? I think it would be much better to keep clean separation between the system tests and internal code of the cluster operator.", "author": "scholzj", "createdAt": "2020-07-28T12:21:55Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaRebalanceUtils.java", "diffHunk": "@@ -6,8 +6,11 @@\n \n import io.strimzi.api.kafka.model.KafkaRebalance;\n import io.strimzi.api.kafka.model.status.Condition;\n+import io.strimzi.api.kafka.operator.assembly.KafkaRebalanceAnnotation;\n import io.strimzi.api.kafka.operator.assembly.KafkaRebalanceState;\n+import io.strimzi.operator.cluster.operator.assembly.KafkaRebalanceAssemblyOperator;", "originalCommit": "92b711c60550e3bc64cb0c1b23a3083ef2bd60be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNzU5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461537594", "bodyText": "Yeah I was thinking about that too. But this was imported after #3397 (review)", "author": "im-konge", "createdAt": "2020-07-28T12:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNjU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNzcyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461537724", "bodyText": "So maybe I should create some constant?", "author": "im-konge", "createdAt": "2020-07-28T12:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNjU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU0MTQ5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461541494", "bodyText": "I think this is similar to the enums for example. We expect the users to use the annotation but we want them to hardcode it in code. If that is good enough for the users, it is for sure good enough for the system tests. I think it should be either moved to the api module somewhere or it should be just hardcoded here instead of depending on the cluster-operator module.", "author": "scholzj", "createdAt": "2020-07-28T12:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNjU5MQ=="}], "type": "inlineReview"}, {"oid": "836ccfe177f2ac76a608a14f52006baa3db890d2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/836ccfe177f2ac76a608a14f52006baa3db890d2", "message": "comment vol2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-07-28T13:23:04Z", "type": "commit"}, {"oid": "089186bc68f6eff662863d09d4d63f5a5db1a700", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/089186bc68f6eff662863d09d4d63f5a5db1a700", "message": "change anno everywhere\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-07-28T14:02:24Z", "type": "commit"}]}