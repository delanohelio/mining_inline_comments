{"pr_number": 2833, "pr_title": "Pass the storage warnings into the KafkaStatus conditions", "pr_createdAt": "2020-04-14T23:46:30Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833", "timeline": [{"oid": "ba902f0a56fd09fe8c0e97315a8044c23379246e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ba902f0a56fd09fe8c0e97315a8044c23379246e", "message": "Pass the storage warnings into the KafkaStatus conditions\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-14T23:40:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NDQxMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408664413", "bodyText": "I wonder if adding these status conditions means we can change the log.warns to log.debugs?", "author": "samuel-hawker", "createdAt": "2020-04-15T08:19:55Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -476,6 +478,13 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n                 log.warn(\"Your desired Kafka storage configuration contains changes which are not allowed. As a \" +\n                         \"result, all storage changes will be ignored. Use DEBUG level logging for more information \" +\n                         \"about the detected changes.\");\n+\n+                Condition warning = StatusUtils.buildWarningCondition(\"KafkaStorage\",\n+                        \"The desired Kafka storage configuration contains changes which are not allowed. As a \" +", "originalCommit": "ba902f0a56fd09fe8c0e97315a8044c23379246e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMTkzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408701938", "bodyText": "I think it should still remain as a warning -> that might raise attention through other ways than the condition, for exxample in some log processing pipelines etc.", "author": "scholzj", "createdAt": "2020-04-15T09:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NDQxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyOTUzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408729531", "bodyText": "Makes sense to me!", "author": "samuel-hawker", "createdAt": "2020-04-15T10:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NDQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NjI4OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408666288", "bodyText": "Would be helpful for my context succeeding work if you added this test with context.succeeding and wrap it also in a context.verify", "author": "samuel-hawker", "createdAt": "2020-04-15T08:23:12Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaStatusTest.java", "diffHunk": "@@ -957,6 +957,101 @@ public void testInitialStatusOnOldResource() throws ParseException {\n         });\n     }\n \n+    @Test\n+    public void testModelWarnings(VertxTestContext context) throws ParseException {\n+        Kafka kafka = getKafkaCrd();\n+        Kafka oldKafka = new KafkaBuilder(getKafkaCrd())\n+                .editOrNewSpec()\n+                    .editOrNewKafka()\n+                        .withNewPersistentClaimStorage()\n+                            .withNewSize(\"100Gi\")\n+                        .endPersistentClaimStorage()\n+                    .endKafka()\n+                .endSpec()\n+                .build();\n+        KafkaCluster kafkaCluster = KafkaCluster.fromCrd(oldKafka, VERSIONS);\n+\n+        ResourceOperatorSupplier supplier = ResourceUtils.supplierWithMocks(false);\n+\n+        // Mock the CRD Operator for Kafka resources\n+        CrdOperator mockKafkaOps = supplier.kafkaOperator;\n+        when(mockKafkaOps.getAsync(eq(namespace), eq(clusterName))).thenReturn(Future.succeededFuture(kafka));\n+\n+        ArgumentCaptor<Kafka> kafkaCaptor = ArgumentCaptor.forClass(Kafka.class);\n+        when(mockKafkaOps.updateStatusAsync(kafkaCaptor.capture())).thenReturn(Future.succeededFuture());\n+\n+        // Mock the KafkaSetOperator\n+        KafkaSetOperator mockKafkaSetOps = supplier.kafkaSetOperations;\n+        when(mockKafkaSetOps.getAsync(eq(namespace), eq(KafkaCluster.kafkaClusterName(clusterName)))).thenReturn(Future.succeededFuture(kafkaCluster.generateStatefulSet(false, null, null)));\n+\n+        // Mock the ConfigMapOperator\n+        ConfigMapOperator mockCmOps = supplier.configMapOperations;\n+        when(mockCmOps.getAsync(eq(namespace), eq(clusterName))).thenReturn(Future.succeededFuture(kafkaCluster.generateMetricsAndLogConfigMap(null)));\n+\n+        // Mock Pods Operator\n+        /*Pod pod0 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 0)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        Pod pod1 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 1)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        Pod pod2 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 2)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        List<Pod> pods = new ArrayList<>();\n+        pods.add(pod0);\n+        pods.add(pod1);\n+        pods.add(pod2);\n+\n+        PodOperator mockPodOps = supplier.podOperations;\n+        when(mockPodOps.listAsync(eq(namespace), any(Labels.class))).thenReturn(Future.succeededFuture(pods));\n+\n+        // Mock Node operator\n+        NodeOperator mockNodeOps = supplier.nodeOperator;\n+        when(mockNodeOps.listAsync(any(Labels.class))).thenReturn(Future.succeededFuture(getClusterNodes()));*/\n+\n+        MockModelWarningsStatusKafkaAssemblyOperator kao = new MockModelWarningsStatusKafkaAssemblyOperator(\n+                vertx, new PlatformFeaturesAvailability(false, kubernetesVersion),\n+                certManager,\n+                passwordGenerator,\n+                supplier,\n+                config);\n+\n+        Checkpoint async = context.checkpoint();\n+        kao.createOrUpdate(new Reconciliation(\"test-trigger\", Kafka.RESOURCE_KIND, namespace, clusterName), kafka).setHandler(res -> {", "originalCommit": "ba902f0a56fd09fe8c0e97315a8044c23379246e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMjA1NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408702054", "bodyText": "Good point. Should be fixed now.", "author": "scholzj", "createdAt": "2020-04-15T09:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY2NjI4OA=="}], "type": "inlineReview"}, {"oid": "874b8634cd069081bcf2b65e2c15fadef29ebd7f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/874b8634cd069081bcf2b65e2c15fadef29ebd7f", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-15T09:21:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyMTQyOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408721428", "bodyText": "what about this big commented code block?", "author": "ppatierno", "createdAt": "2020-04-15T09:54:22Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaStatusTest.java", "diffHunk": "@@ -957,6 +957,100 @@ public void testInitialStatusOnOldResource() throws ParseException {\n         });\n     }\n \n+    @Test\n+    public void testModelWarnings(VertxTestContext context) throws ParseException {\n+        Kafka kafka = getKafkaCrd();\n+        Kafka oldKafka = new KafkaBuilder(getKafkaCrd())\n+                .editOrNewSpec()\n+                    .editOrNewKafka()\n+                        .withNewPersistentClaimStorage()\n+                            .withNewSize(\"100Gi\")\n+                        .endPersistentClaimStorage()\n+                    .endKafka()\n+                .endSpec()\n+                .build();\n+        KafkaCluster kafkaCluster = KafkaCluster.fromCrd(oldKafka, VERSIONS);\n+\n+        ResourceOperatorSupplier supplier = ResourceUtils.supplierWithMocks(false);\n+\n+        // Mock the CRD Operator for Kafka resources\n+        CrdOperator mockKafkaOps = supplier.kafkaOperator;\n+        when(mockKafkaOps.getAsync(eq(namespace), eq(clusterName))).thenReturn(Future.succeededFuture(kafka));\n+\n+        ArgumentCaptor<Kafka> kafkaCaptor = ArgumentCaptor.forClass(Kafka.class);\n+        when(mockKafkaOps.updateStatusAsync(kafkaCaptor.capture())).thenReturn(Future.succeededFuture());\n+\n+        // Mock the KafkaSetOperator\n+        KafkaSetOperator mockKafkaSetOps = supplier.kafkaSetOperations;\n+        when(mockKafkaSetOps.getAsync(eq(namespace), eq(KafkaCluster.kafkaClusterName(clusterName)))).thenReturn(Future.succeededFuture(kafkaCluster.generateStatefulSet(false, null, null)));\n+\n+        // Mock the ConfigMapOperator\n+        ConfigMapOperator mockCmOps = supplier.configMapOperations;\n+        when(mockCmOps.getAsync(eq(namespace), eq(clusterName))).thenReturn(Future.succeededFuture(kafkaCluster.generateMetricsAndLogConfigMap(null)));\n+\n+        // Mock Pods Operator\n+        /*Pod pod0 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 0)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        Pod pod1 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 1)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        Pod pod2 = new PodBuilder()\n+                .withNewMetadata()\n+                .withNewName(clusterName + \"-kafka-\" + 2)\n+                .endMetadata()\n+                .withNewStatus()\n+                .withNewHostIP(\"10.0.0.1\")\n+                .endStatus()\n+                .build();\n+\n+        List<Pod> pods = new ArrayList<>();\n+        pods.add(pod0);\n+        pods.add(pod1);\n+        pods.add(pod2);\n+\n+        PodOperator mockPodOps = supplier.podOperations;\n+        when(mockPodOps.listAsync(eq(namespace), any(Labels.class))).thenReturn(Future.succeededFuture(pods));\n+\n+        // Mock Node operator\n+        NodeOperator mockNodeOps = supplier.nodeOperator;\n+        when(mockNodeOps.listAsync(any(Labels.class))).thenReturn(Future.succeededFuture(getClusterNodes()));*/", "originalCommit": "874b8634cd069081bcf2b65e2c15fadef29ebd7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyNDA4OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2833#discussion_r408724088", "bodyText": "Good point. Thanks.", "author": "scholzj", "createdAt": "2020-04-15T09:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcyMTQyOA=="}], "type": "inlineReview"}, {"oid": "b93553e4e9b7133841d32834f8120326d774e84b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b93553e4e9b7133841d32834f8120326d774e84b", "message": "Review commmetns II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-15T09:58:14Z", "type": "commit"}]}