{"pr_number": 2857, "pr_title": "Fix waitForObserved for DeploymentConfigs to make the operator wait for roll outs", "pr_createdAt": "2020-04-18T23:07:03Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857", "timeline": [{"oid": "a75001be34d015209bb2f86937b8acbaa35350cd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a75001be34d015209bb2f86937b8acbaa35350cd", "message": "Fix waitForObserved for DeploymentConfigs to make the operator wait for roll outs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-18T23:00:57Z", "type": "commit"}, {"oid": "876f4d3fa1709b0b01bc58ecff3106ca42cd5abe", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/876f4d3fa1709b0b01bc58ecff3106ca42cd5abe", "message": "Fix imports\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-18T23:04:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg3NTk0NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r410875945", "bodyText": "Just to avoid confusion around double negatives, might it be worth changing this to\nrollOutStarted = true\n\nAs we assume it has started unless the condition states otherwise", "author": "samuel-hawker", "createdAt": "2020-04-19T10:46:52Z", "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/DeploymentConfigOperator.java", "diffHunk": "@@ -72,9 +73,35 @@ protected Integer currentScale(String namespace, String name) {\n     private boolean isObserved(String namespace, String name) {\n         DeploymentConfig dep = get(namespace, name);\n         if (dep != null)   {\n-            return dep.getMetadata().getGeneration().equals(dep.getStatus().getObservedGeneration());\n+            // Get the roll out status\n+            //     => Sometimes it takes OCP some time before the generations are updated.\n+            //        So we need to check the conditions in addition to detect such situation.\n+            boolean rollOutNotStartedYet = false;", "originalCommit": "876f4d3fa1709b0b01bc58ecff3106ca42cd5abe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDk3MTQyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r410971422", "bodyText": "I changed it to not use the double negative.", "author": "scholzj", "createdAt": "2020-04-19T19:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg3NTk0NQ=="}], "type": "inlineReview"}, {"oid": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a9ae06720e2bab4706f0ddac2bbf155c0f64615a", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-19T19:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r412082847", "bodyText": "should it be valid just for \"Ready\". Is it possible that the status is \"NotReady\" so anyway different from \"Unkown\"?", "author": "ppatierno", "createdAt": "2020-04-21T10:56:05Z", "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/DeploymentConfigOperator.java", "diffHunk": "@@ -72,9 +73,35 @@ protected Integer currentScale(String namespace, String name) {\n     private boolean isObserved(String namespace, String name) {\n         DeploymentConfig dep = get(namespace, name);\n         if (dep != null)   {\n-            return dep.getMetadata().getGeneration().equals(dep.getStatus().getObservedGeneration());\n+            // Get the roll out status\n+            //     => Sometimes it takes OCP some time before the generations are updated.\n+            //        So we need to check the conditions in addition to detect such situation.\n+            boolean rollOutNotStarting = true;\n+            DeploymentCondition progressing = getProgressingCondition(dep);\n+\n+            if (progressing != null)    {\n+                rollOutNotStarting = progressing.getReason() != null && !\"Unknown\".equals(progressing.getStatus());", "originalCommit": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4NDEzOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r412084139", "bodyText": "Not sure I understand the question. When the Reason is null and Status is Unknown, the generation has not been updated yet.", "author": "scholzj", "createdAt": "2020-04-21T10:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4NDQwMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r412084400", "bodyText": "So the state is netiehr Ready nor NotReady, but Unknown.", "author": "scholzj", "createdAt": "2020-04-21T10:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Njc4Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r412086783", "bodyText": "Right.", "author": "ppatierno", "createdAt": "2020-04-21T11:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg0Nw=="}], "type": "inlineReview"}]}