{"pr_number": 4128, "pr_title": "TO recreation", "pr_createdAt": "2020-12-18T11:59:24Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128", "timeline": [{"oid": "2569acfc19e551ea920353ba2a97453078c78030", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2569acfc19e551ea920353ba2a97453078c78030", "message": "Add ST\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-12-18T12:16:07Z", "type": "commit"}, {"oid": "3eb948f3333896866755eac3eb503f31b351e435", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3eb948f3333896866755eac3eb503f31b351e435", "message": "Patch topic recreation\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-12-18T12:16:07Z", "type": "commit"}, {"oid": "f5cbd59a2a6387a2575df377db5b7e04f0737773", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f5cbd59a2a6387a2575df377db5b7e04f0737773", "message": "Fix #4086\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-12-18T12:16:07Z", "type": "commit"}, {"oid": "dd079b2c775b49c9ee8499a7c414248e68d89b3d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dd079b2c775b49c9ee8499a7c414248e68d89b3d", "message": "Improve test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-12-18T12:16:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0OTg1MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r546549850", "bodyText": "why the need for this check on ERROR action?", "author": "ppatierno", "createdAt": "2020-12-21T07:33:05Z", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/K8sTopicWatcher.java", "diffHunk": "@@ -44,23 +45,24 @@ public void eventReceived(Action action, KafkaTopic kafkaTopic) {\n             }\n             LOGGER.info(\"{}: event {} on resource {} generation={}, labels={}\", logContext, action, name,\n                     metadata.getGeneration(), labels);\n-            Handler<AsyncResult<Void>> resultHandler = ar -> {\n-                if (ar.succeeded()) {\n-                    LOGGER.info(\"{}: Success processing event {} on resource {} with labels {}\", logContext, action, name, labels);\n-                } else {\n-                    String message;\n-                    if (ar.cause() instanceof InvalidTopicException) {\n-                        message = kind + \" \" + name + \" has an invalid spec section: \" + ar.cause().getMessage();\n-                        LOGGER.error(\"{}\", message);\n-\n+            if (!action.equals(Action.ERROR)", "originalCommit": "608b96b9bcb3a4b93b91181b6828525373304b1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAzNjc2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r552036765", "bodyText": "It's essentially the same line of code as was on the old line 63. TBH I've never really known under what circumstances we might see ERROR, but if/when we saw it, it wouldn't mean we should reconcile.", "author": "tombentley", "createdAt": "2021-01-05T16:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0OTg1MA=="}], "type": "inlineReview"}, {"oid": "8ea1e97472ead25c55700333466cb3e424f246ba", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8ea1e97472ead25c55700333466cb3e424f246ba", "message": "wip\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-12-21T14:30:39Z", "type": "commit"}, {"oid": "3fda87369c512728e7b1f663d269333ca5f33cc6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3fda87369c512728e7b1f663d269333ca5f33cc6", "message": "ST\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-07T14:51:17Z", "type": "commit"}, {"oid": "3fda87369c512728e7b1f663d269333ca5f33cc6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3fda87369c512728e7b1f663d269333ca5f33cc6", "message": "ST\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-07T14:51:17Z", "type": "forcePushed"}, {"oid": "cb4baaa62c9e3943cf4e2114eff5ee7486ce29f9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb4baaa62c9e3943cf4e2114eff5ee7486ce29f9", "message": "checkstyle\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-07T17:45:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyODQ0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r553828449", "bodyText": "indent", "author": "Frawless", "createdAt": "2021-01-08T09:18:15Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/topic/TopicST.java", "diffHunk": "@@ -165,6 +167,88 @@ void testCreateTopicViaAdminClient() throws ExecutionException, InterruptedExcep\n         assertThat(kafkaTopic.getSpec().getReplicas(), is(1));\n     }\n \n+    @Tag(NODEPORT_SUPPORTED)\n+    @Test\n+    void testCreateDeleteCreate() throws InterruptedException {\n+        String clusterName = CLUSTER_NAME + \"-sdkvnsdkjn\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3, 3)\n+                .editSpec()\n+                    .editKafka()\n+                        .withNewListeners()\n+                            .addNewGenericKafkaListener()\n+                                .withName(Constants.EXTERNAL_LISTENER_DEFAULT_NAME)\n+                                .withPort(9094)\n+                                .withType(KafkaListenerType.NODEPORT)\n+                                .withTls(false)\n+                            .endGenericKafkaListener()\n+                        .endListeners()\n+                    .endKafka()\n+                    .editEntityOperator()\n+                        .editTopicOperator()\n+                            .withReconciliationIntervalSeconds(120)\n+                        .endTopicOperator()\n+                    .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        Properties properties = new Properties();\n+\n+        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaResource.kafkaClient().inNamespace(NAMESPACE)\n+                .withName(clusterName).get().getStatus().getListeners().stream()\n+                .filter(listener -> listener.getType().equals(Constants.EXTERNAL_LISTENER_DEFAULT_NAME))\n+                .findFirst()\n+                .orElseThrow(RuntimeException::new)\n+                .getBootstrapServers());\n+\n+        try (AdminClient adminClient = AdminClient.create(properties)) {\n+\n+            String topicName = \"topic-create-delete-create\";\n+\n+            KafkaTopicResource.topic(clusterName, topicName)\n+                    .editSpec()\n+                    .withReplicas(3)\n+                    .endSpec()", "originalCommit": "cb4baaa62c9e3943cf4e2114eff5ee7486ce29f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyODUwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r553828503", "bodyText": "indent", "author": "Frawless", "createdAt": "2021-01-08T09:18:22Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/topic/TopicST.java", "diffHunk": "@@ -165,6 +167,88 @@ void testCreateTopicViaAdminClient() throws ExecutionException, InterruptedExcep\n         assertThat(kafkaTopic.getSpec().getReplicas(), is(1));\n     }\n \n+    @Tag(NODEPORT_SUPPORTED)\n+    @Test\n+    void testCreateDeleteCreate() throws InterruptedException {\n+        String clusterName = CLUSTER_NAME + \"-sdkvnsdkjn\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3, 3)\n+                .editSpec()\n+                    .editKafka()\n+                        .withNewListeners()\n+                            .addNewGenericKafkaListener()\n+                                .withName(Constants.EXTERNAL_LISTENER_DEFAULT_NAME)\n+                                .withPort(9094)\n+                                .withType(KafkaListenerType.NODEPORT)\n+                                .withTls(false)\n+                            .endGenericKafkaListener()\n+                        .endListeners()\n+                    .endKafka()\n+                    .editEntityOperator()\n+                        .editTopicOperator()\n+                            .withReconciliationIntervalSeconds(120)\n+                        .endTopicOperator()\n+                    .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        Properties properties = new Properties();\n+\n+        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaResource.kafkaClient().inNamespace(NAMESPACE)\n+                .withName(clusterName).get().getStatus().getListeners().stream()\n+                .filter(listener -> listener.getType().equals(Constants.EXTERNAL_LISTENER_DEFAULT_NAME))\n+                .findFirst()\n+                .orElseThrow(RuntimeException::new)\n+                .getBootstrapServers());\n+\n+        try (AdminClient adminClient = AdminClient.create(properties)) {\n+\n+            String topicName = \"topic-create-delete-create\";\n+\n+            KafkaTopicResource.topic(clusterName, topicName)\n+                    .editSpec()\n+                    .withReplicas(3)\n+                    .endSpec()\n+                    .done();\n+            KafkaTopicUtils.waitForKafkaTopicReady(topicName);\n+\n+            adminClient.describeTopics(singletonList(topicName)).values().get(topicName);\n+\n+            for (int i = 0; i < 10; i++) {\n+                Thread.sleep(2_000);\n+                LOGGER.info(\"Iteration {}: Deleting {}\", i, topicName);\n+                cmdKubeClient().deleteByName(KafkaTopic.RESOURCE_KIND, topicName);\n+                KafkaTopicUtils.waitForKafkaTopicDeletion(topicName);\n+                TestUtils.waitFor(\"Deletion of topic \" + topicName, 1000, 15_000, () -> {\n+                    try {\n+                        return !adminClient.listTopics().names().get().contains(topicName);\n+                    } catch (ExecutionException | InterruptedException e) {\n+                        return false;\n+                    }\n+                });\n+                Thread.sleep(2_000);\n+                long t0 = System.currentTimeMillis();\n+                LOGGER.info(\"Iteration {}: Recreating {}\", i, topicName);\n+                KafkaTopicResource.topic(clusterName, topicName)\n+                        .editSpec()\n+                        .withReplicas(3)\n+                        .endSpec()", "originalCommit": "cb4baaa62c9e3943cf4e2114eff5ee7486ce29f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyOTE0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r553829148", "bodyText": "I don't think this is needed. In case the topic is not recreated during the timeout period specified in waitFor above, the test will fail anyway. So in case, you will specify the timeout for 10s, it should be almost the same and the code will be shorter. Unless there is something I don't see.", "author": "Frawless", "createdAt": "2021-01-08T09:19:47Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/topic/TopicST.java", "diffHunk": "@@ -165,6 +167,88 @@ void testCreateTopicViaAdminClient() throws ExecutionException, InterruptedExcep\n         assertThat(kafkaTopic.getSpec().getReplicas(), is(1));\n     }\n \n+    @Tag(NODEPORT_SUPPORTED)\n+    @Test\n+    void testCreateDeleteCreate() throws InterruptedException {\n+        String clusterName = CLUSTER_NAME + \"-sdkvnsdkjn\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3, 3)\n+                .editSpec()\n+                    .editKafka()\n+                        .withNewListeners()\n+                            .addNewGenericKafkaListener()\n+                                .withName(Constants.EXTERNAL_LISTENER_DEFAULT_NAME)\n+                                .withPort(9094)\n+                                .withType(KafkaListenerType.NODEPORT)\n+                                .withTls(false)\n+                            .endGenericKafkaListener()\n+                        .endListeners()\n+                    .endKafka()\n+                    .editEntityOperator()\n+                        .editTopicOperator()\n+                            .withReconciliationIntervalSeconds(120)\n+                        .endTopicOperator()\n+                    .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        Properties properties = new Properties();\n+\n+        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, KafkaResource.kafkaClient().inNamespace(NAMESPACE)\n+                .withName(clusterName).get().getStatus().getListeners().stream()\n+                .filter(listener -> listener.getType().equals(Constants.EXTERNAL_LISTENER_DEFAULT_NAME))\n+                .findFirst()\n+                .orElseThrow(RuntimeException::new)\n+                .getBootstrapServers());\n+\n+        try (AdminClient adminClient = AdminClient.create(properties)) {\n+\n+            String topicName = \"topic-create-delete-create\";\n+\n+            KafkaTopicResource.topic(clusterName, topicName)\n+                    .editSpec()\n+                    .withReplicas(3)\n+                    .endSpec()\n+                    .done();\n+            KafkaTopicUtils.waitForKafkaTopicReady(topicName);\n+\n+            adminClient.describeTopics(singletonList(topicName)).values().get(topicName);\n+\n+            for (int i = 0; i < 10; i++) {\n+                Thread.sleep(2_000);\n+                LOGGER.info(\"Iteration {}: Deleting {}\", i, topicName);\n+                cmdKubeClient().deleteByName(KafkaTopic.RESOURCE_KIND, topicName);\n+                KafkaTopicUtils.waitForKafkaTopicDeletion(topicName);\n+                TestUtils.waitFor(\"Deletion of topic \" + topicName, 1000, 15_000, () -> {\n+                    try {\n+                        return !adminClient.listTopics().names().get().contains(topicName);\n+                    } catch (ExecutionException | InterruptedException e) {\n+                        return false;\n+                    }\n+                });\n+                Thread.sleep(2_000);\n+                long t0 = System.currentTimeMillis();\n+                LOGGER.info(\"Iteration {}: Recreating {}\", i, topicName);\n+                KafkaTopicResource.topic(clusterName, topicName)\n+                        .editSpec()\n+                        .withReplicas(3)\n+                        .endSpec()\n+                        .done();\n+                ResourceManager.waitForResourceStatus(KafkaTopicResource.kafkaTopicClient(), \"KafkaTopic\", NAMESPACE, topicName, Ready, 15_000);\n+                TestUtils.waitFor(\"Recreation of topic \" + topicName, 1000, 2_000, () -> {\n+                    try {\n+                        return adminClient.listTopics().names().get().contains(topicName);\n+                    } catch (ExecutionException | InterruptedException e) {\n+                        return false;\n+                    }\n+                });\n+                if (System.currentTimeMillis() - t0 > 10_000) {\n+                    fail(\"Took too long to recreate\");\n+                }", "originalCommit": "cb4baaa62c9e3943cf4e2114eff5ee7486ce29f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg0MDQ2MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r553840461", "bodyText": "It is needed. System.currentTimeMillis() - t0  is measuring the time for:\n\nKube to create the KafkaTopic (admittedly this should be negligable)\nThe time for the TO to react to that, creating the topic and setting the Ready status\nThe topic to actually exist in the broker's metadata cache.\n\nThe waitFor timeout is measuring only the last bullet.\nWithout this assertion the test always passes, even without the changes in this PR which fix the issue. With this assertion (but without the changes in this PR which fix the issue) it fails on the second iteration of the for loop because the TO wrongly retains some state about the topic having existed in the past, and so the TO has to wait for a full reconciliation before that wrong state gets sorted out (well, it's ignored I think).", "author": "tombentley", "createdAt": "2021-01-08T09:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyOTE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg3MTE1Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4128#discussion_r553871153", "bodyText": "I see, make sense", "author": "Frawless", "createdAt": "2021-01-08T10:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgyOTE0OA=="}], "type": "inlineReview"}, {"oid": "c205efacab97d7eb27d3d6daa24323139826eb38", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c205efacab97d7eb27d3d6daa24323139826eb38", "message": "Review comment\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-08T09:31:14Z", "type": "commit"}, {"oid": "947655b1cd5618353743c0bb26594567d7ee6bd9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/947655b1cd5618353743c0bb26594567d7ee6bd9", "message": "Review comment\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-08T09:42:46Z", "type": "commit"}, {"oid": "3c1708cf52844ba2bb978fe1081a928fe920afcd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3c1708cf52844ba2bb978fe1081a928fe920afcd", "message": "Tidy up logging\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-08T14:39:21Z", "type": "commit"}, {"oid": "32a3aa4baabb4d0f8d22bd2b06320791e0d00725", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/32a3aa4baabb4d0f8d22bd2b06320791e0d00725", "message": "fixup\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2021-01-08T14:40:11Z", "type": "commit"}]}