{"pr_number": 2894, "pr_title": "ST: Update zk upgrade tests to run upgrade/downgrade for all versions", "pr_createdAt": "2020-04-25T09:05:32Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894", "timeline": [{"oid": "f54a22a255849fbd1f5ff7744cfee04d38c905ef", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f54a22a255849fbd1f5ff7744cfee04d38c905ef", "message": "Update zk upgrade tests to run upgrade/downgrade for all versions\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T08:58:57Z", "type": "commit"}, {"oid": "f95e67d8ec2de4362f1cbd4ec43ae48a92ddba1f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f95e67d8ec2de4362f1cbd4ec43ae48a92ddba1f", "message": "add debug info\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T12:51:43Z", "type": "commit"}, {"oid": "d8bd591e60094630cfb6d4986331cffdabe886c9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d8bd591e60094630cfb6d4986331cffdabe886c9", "message": "Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T13:33:03Z", "type": "commit"}, {"oid": "15ccbff7777ffc6e4dc21055faae0c487684d450", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/15ccbff7777ffc6e4dc21055faae0c487684d450", "message": "fixup! Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T14:36:17Z", "type": "commit"}, {"oid": "4a28435837c317ffdf44405692301063ec9b2442", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4a28435837c317ffdf44405692301063ec9b2442", "message": "fixup! fixup! Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T14:51:11Z", "type": "commit"}, {"oid": "8aa7faf3a0b9dea45d08d5763e0057bffd0787fc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8aa7faf3a0b9dea45d08d5763e0057bffd0787fc", "message": "fixup! fixup! fixup! Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-25T18:38:36Z", "type": "commit"}, {"oid": "f38ad2050712d3a64fdd44cefeace6beadcece57", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f38ad2050712d3a64fdd44cefeace6beadcece57", "message": "fixup! fixup! fixup! fixup! Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-27T06:30:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415676001", "bodyText": "Just a minor question. Why are you using an int[] here instead of just an int. You only ever refer to the first cell of the array and don't use the array outside of the lambda given to waitFor. Not saying you should change it, just interested why?", "author": "tomncooper", "createdAt": "2020-04-27T09:57:29Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PodUtils.java", "diffHunk": "@@ -243,13 +243,16 @@ public static void waitUntilPodsStability(List<Pod> pods) {\n \n         TestUtils.waitFor(\"Pods stability\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n             () -> {\n-                for (Pod pod : pods) {\n+                List<Pod> actualPods = pods.stream().map(p -> kubeClient().getPod(p.getMetadata().getName())).collect(Collectors.toList());\n+\n+                for (Pod pod : actualPods) {\n                     if (pod.getStatus().getPhase().equals(\"Running\")) {\n                         LOGGER.info(\"Pod {} is in the {} state. Remaining seconds pod to be stable {}\",\n                             pod.getMetadata().getName(), pod.getStatus().getPhase(),\n                             Constants.GLOBAL_RECONCILIATION_COUNT - stabilityCounter[0]);\n                     } else {\n                         LOGGER.info(\"Pod {} is not stable with phase {}\", pod.getMetadata().getName(), pod.getStatus().getPhase());\n+                        stabilityCounter[0] = 0;", "originalCommit": "f38ad2050712d3a64fdd44cefeace6beadcece57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4MzUyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415683524", "bodyText": "He needs a final to use it within the lambda, but he also needs it to be mutable.", "author": "tombentley", "createdAt": "2020-04-27T10:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4NDQxMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415684410", "bodyText": "Getting the actual pods is good, but don't we need to check that exactly the given pods are present in the actualPods too?", "author": "tombentley", "createdAt": "2020-04-27T10:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4NjY0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415686644", "bodyText": "The array with one cell is there because of one simple reason. If you look at the whole method, you will see that this variable needs to be changed whenever the BooleanSupplier condition is TRUE. In this case, with each tick(poll) the whole code will be executed. If pods are all in running state we will increment the stability counter. Moreover, you need some outside reference from the scope of Lambda and this problem can be resolved by two options:\n\nuse atomic variables - which is not good approach to do it and should be used only in concurrent stuff...\nuse array - which completely resolve that problem", "author": "see-quick", "createdAt": "2020-04-27T10:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY5MjIzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415692233", "bodyText": "Well, see that I did not refresh and you were quicker @tombentley  :D", "author": "see-quick", "createdAt": "2020-04-27T10:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY5MzIxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415693214", "bodyText": "I think I am missing something, this lambda just checks that all the pods are ready by counting how many are ready and comparing it to a constant, and repeating that at the configured interval, why does the counter need to be outside the lambda?", "author": "tomncooper", "createdAt": "2020-04-27T10:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY5Nzk4MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415697980", "bodyText": "If you use counter inside the lambda you will override him at each poll interval(tick).", "author": "see-quick", "createdAt": "2020-04-27T10:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcwMTk5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415701998", "bodyText": "Yeah I get that, but isn't it set to zero every time a pod isn't ready anyway? Maybe this is something to do with the phases?\nAnyway, if you guys are happy, I'm happy.", "author": "tomncooper", "createdAt": "2020-04-27T10:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc2Mzg0Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415763846", "bodyText": "@tombentley I discuss that with @see-quick and it's enough from our POV. Now we can use it in situations when rolling update is not completely finished. We can override it for usage you suggested for tests, where we are for 100% sure that we don't want any rolling update during this wait.", "author": "Frawless", "createdAt": "2020-04-27T12:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NjAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4NDUyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415684524", "bodyText": "Should this be sameMinorVersion?", "author": "scholzj", "createdAt": "2020-04-27T10:10:20Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/ZookeeperUpgradeST.java", "diffHunk": "@@ -66,16 +71,34 @@ void runVersionChange(TestKafkaVersion initialVersion, TestKafkaVersion newVersi\n             logMsgFormat = newVersion.messageVersion();\n         }\n \n-        LOGGER.info(\"Deploying initial Kafka version (\" + initialVersion.version() + \")\");\n+        boolean sameMajorVersion = initialVersion.protocolVersion().equals(newVersion.protocolVersion());", "originalCommit": "f38ad2050712d3a64fdd44cefeace6beadcece57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc1MDEwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2894#discussion_r415750105", "bodyText": "Yes, I will fix it", "author": "Frawless", "createdAt": "2020-04-27T11:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4NDUyNA=="}], "type": "inlineReview"}, {"oid": "7adf03c2910f80d37b6aff43119bd66bec27d717", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7adf03c2910f80d37b6aff43119bd66bec27d717", "message": "fixup! fixup! fixup! fixup! fixup! Remove reversing the list which is not working properly on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-04-27T13:21:08Z", "type": "commit"}]}