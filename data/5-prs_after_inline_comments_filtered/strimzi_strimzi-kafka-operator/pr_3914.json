{"pr_number": 3914, "pr_title": "[systemtest] Test recovery of Kafka cluster when impossible memory request is set", "pr_createdAt": "2020-11-04T00:02:28Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MzEwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517163105", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    PodUtils.waitForPendingPod(clusterName + \"-kafka\");\n          \n          \n            \n                    PodUtils.waitForPendingPod(KafkaResources.kafkaStatefulSetName(clusterName));", "author": "sknot-rh", "createdAt": "2020-11-04T08:15:55Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {\n+        String clusterName = \"my-cluster\";\n+\n+        Map<String, Quantity> requests = new HashMap<>(2);\n+        requests.put(\"memory\", new Quantity(\"465458732Gi\"));\n+\n+        ResourceRequirements resourceReq = new ResourceRequirementsBuilder()\n+            .withRequests(requests)\n+            .build();\n+\n+        KafkaResource.kafkaWithoutWait(KafkaResource.defaultKafka(clusterName, 3, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withResources(resourceReq)\n+                .endKafka()\n+            .endSpec()\n+            .build());\n+\n+        PodUtils.waitForPendingPod(clusterName + \"-kafka\");", "originalCommit": "4bcb35af9d15969d676eadb348c49b65738e4929", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyNjU4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517226586", "bodyText": "Yep, sorry, my bad.", "author": "im-konge", "createdAt": "2020-11-04T10:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517163951", "bodyText": "Is this test different from io.strimzi.systemtest.rollingupdate.KafkaRollerST#testKafkaPodPending apart from setting memory instead of CPU?", "author": "sknot-rh", "createdAt": "2020-11-04T08:17:31Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {", "originalCommit": "4bcb35af9d15969d676eadb348c49b65738e4929", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4MDI3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517180274", "bodyText": "Yes, I think so, as least potentially...\n\nThat test stands up a cluster first and then updates it with an impossible request. One of the things we ought to be checking there is that only one pod becomes unschedulable (i.e. we don't progressively take down the cluster) and that recovery is possible.\nThis test starts with an impossible request (so all pods are unschedulable) and we want to ensure that recovery is impossible. My recollection was that this is how, despite us already having protection against the former in the KafkaRoller, we still had the recent bug with the latter.", "author": "tombentley", "createdAt": "2020-11-04T08:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4MDk3Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517180972", "bodyText": "So assuming I'm correct about this, I guess we need to improve KafkaRollerST#testKafkaPodPending so that it waits for multiple reconciliations and verifies that N-1 of the pods are still running.", "author": "tombentley", "createdAt": "2020-11-04T08:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNTA3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517235074", "bodyText": "Ok. Thanks for the explanation.", "author": "sknot-rh", "createdAt": "2020-11-04T10:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NzgwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517247803", "bodyText": "I guess I can add these checks to all KafkaRoller tests which @stanlyDoge added in his KR PR -> not just to the testKafkaPodPending", "author": "im-konge", "createdAt": "2020-11-04T10:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ=="}], "type": "inlineReview"}, {"oid": "5d7fd0b1add485cb803025a107b01057324cc145", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5d7fd0b1add485cb803025a107b01057324cc145", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-04T13:46:04Z", "type": "forcePushed"}, {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6f1c8758b53997618680023241e5bc6de9b7c775", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-04T16:38:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU1Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517864552", "bodyText": "What's the purpose of this?", "author": "Frawless", "createdAt": "2020-11-05T08:20:32Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -168,11 +171,15 @@ void testKafkaPodCrashLooping() {\n     void testKafkaPodImagePullBackOff() {\n         KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3).done();\n \n-        KafkaResource.replaceKafkaResource(CLUSTER_NAME, kafka ->\n-                kafka.getSpec().getKafka().setImage(\"strimzi/kafka:not-existent-tag\"));\n+        KafkaResource.replaceKafkaResource(CLUSTER_NAME, kafka -> {\n+            kafka.getSpec().getKafka().setImage(\"strimzi/kafka:not-existent-tag\");\n+            kafka.getSpec().getZookeeper().setImage(\"strimzi/kafka:latest-kafka-\" + Environment.ST_KAFKA_VERSION);", "originalCommit": "6f1c8758b53997618680023241e5bc6de9b7c775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NzI0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517867244", "bodyText": "When you set image just to Kafka and not the Zookeeper -> so the ZK will not have any image -> he will get the Kafka image. So this is a test where the Kafka pod should go to ImagePullBackOff not the ZK. Setting the Zookeeper image will make that just Kafka pod will \"fail\". We discussed this with @scholzj and @stanlyDoge.", "author": "im-konge", "createdAt": "2020-11-05T08:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3ODE2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517978162", "bodyText": "Ok, thanks for the explanation", "author": "Frawless", "createdAt": "2020-11-05T11:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517864599", "bodyText": "Shouldn't we have there some additional wait to see that pods are rly broken?", "author": "Frawless", "createdAt": "2020-11-05T08:20:37Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {\n+        String clusterName = \"my-cluster\";\n+\n+        Map<String, Quantity> requests = new HashMap<>(2);\n+        requests.put(\"memory\", new Quantity(\"465458732Gi\"));\n+\n+        ResourceRequirements resourceReq = new ResourceRequirementsBuilder()\n+            .withRequests(requests)\n+            .build();\n+\n+        KafkaResource.kafkaWithoutWait(KafkaResource.defaultKafka(clusterName, 3, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withResources(resourceReq)\n+                .endKafka()\n+            .endSpec()\n+            .build());\n+\n+        PodUtils.waitForPendingPod(KafkaResources.kafkaStatefulSetName(clusterName));", "originalCommit": "6f1c8758b53997618680023241e5bc6de9b7c775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2ODA0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517868041", "bodyText": "You mean some wait for Kafka is NotReady? Or do you want some stability wait?", "author": "im-konge", "createdAt": "2020-11-05T08:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3NzcwOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517977709", "bodyText": "Ye, maybe some stability wait", "author": "Frawless", "createdAt": "2020-11-05T11:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU5OQ=="}], "type": "inlineReview"}, {"oid": "ec187127d7d5510ee85a6c9e7bbb13693cc7c5cf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ec187127d7d5510ee85a6c9e7bbb13693cc7c5cf", "message": "add recovery test for starting kafka cluster with impossible memory request\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T15:26:54Z", "type": "commit"}, {"oid": "de2511aeda9f1203399eabcc7a4540ae45820976", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/de2511aeda9f1203399eabcc7a4540ae45820976", "message": "fixup! add recovery test for starting kafka cluster with impossible memory request\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T15:26:54Z", "type": "commit"}, {"oid": "bbeb531bf30a68930e357b6a1281ac4407b05558", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bbeb531bf30a68930e357b6a1281ac4407b05558", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T15:26:54Z", "type": "commit"}, {"oid": "b92aa3b072deefdc8c50c533f18989ae7c693290", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b92aa3b072deefdc8c50c533f18989ae7c693290", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T15:26:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTY5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r518195690", "bodyText": "checkIfExactlyOneKafkaPodIsNotReady would be clearer (otherwise it might be mistaken for an 'at least one' condition)", "author": "tombentley", "createdAt": "2020-11-05T16:42:09Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -266,6 +275,13 @@ void testKafkaPodPendingDueToRack() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    boolean checkIfOneKafkaPodIsNotReady(String clusterName) {", "originalCommit": "6f1c8758b53997618680023241e5bc6de9b7c775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NjM3MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r518196371", "bodyText": "Add javadoc here and to testKafkaPodPending to explain the difference between the tests.", "author": "tombentley", "createdAt": "2020-11-05T16:43:08Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {", "originalCommit": "6f1c8758b53997618680023241e5bc6de9b7c775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c56a212df511088e2f0db39475219426f0e2961", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c56a212df511088e2f0db39475219426f0e2961", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T18:11:53Z", "type": "commit"}, {"oid": "5c56a212df511088e2f0db39475219426f0e2961", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c56a212df511088e2f0db39475219426f0e2961", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T18:11:53Z", "type": "forcePushed"}, {"oid": "8f2ed2f6cff7e1396dedd922bee9b1665ae78261", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f2ed2f6cff7e1396dedd922bee9b1665ae78261", "message": "change javadoc again\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-06T09:42:22Z", "type": "commit"}]}