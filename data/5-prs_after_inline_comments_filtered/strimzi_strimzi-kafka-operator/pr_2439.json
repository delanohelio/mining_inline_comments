{"pr_number": 2439, "pr_title": "Delete zk node after user is removed", "pr_createdAt": "2020-01-22T12:20:43Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439", "timeline": [{"oid": "b5a671609b3585553b8558e641b987e424323dbb", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b5a671609b3585553b8558e641b987e424323dbb", "message": "Delete zk node after user is removed\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-22T12:19:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU3NjYwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r369576605", "bodyText": "Wouldn't configJsonIsEmpty() be a better name?", "author": "tombentley", "createdAt": "2020-01-22T14:04:19Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/operator/KafkaUserQuotasOperator.java", "diffHunk": "@@ -195,6 +195,14 @@ boolean exists(String username) {\n         return false;\n     }\n \n+    private boolean jsonConfigEmpty(byte[] data) {", "originalCommit": "b5a671609b3585553b8558e641b987e424323dbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU3OTU2OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r369579569", "bodyText": "So remove removeQuotasFromJsonUser takes a byte[], parses it as JSON, removes something, serializes it and then jsonConfigEmpty() parses it again? That's not ideal. Is there a reason why removeQuotasFromJsonUser() doesn't return the JsonObject and let the caller serialize it if&when they need to? jsonConfigEmpty would then take a JsonObject, but that's better than passing around these byte[] and having each method parse and reparse it.", "author": "tombentley", "createdAt": "2020-01-22T14:09:44Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/operator/KafkaUserQuotasOperator.java", "diffHunk": "@@ -206,7 +214,13 @@ public void delete(String username) {\n \n         if (data != null)   {\n             log.debug(\"Deleting quotas for user {}\", username);\n-            zkClient.writeData(\"/config/users/\" + username, removeQuotasFromJsonUser(data));\n+            byte[] deleteJson = removeQuotasFromJsonUser(data);\n+            if (jsonConfigEmpty(deleteJson)) {", "originalCommit": "b5a671609b3585553b8558e641b987e424323dbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU3OTc3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r369579779", "bodyText": "Again jsonConfigIsEmpty", "author": "tombentley", "createdAt": "2020-01-22T14:10:04Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/operator/ScramShaCredentials.java", "diffHunk": "@@ -56,6 +57,14 @@ public void createOrUpdate(String username, String password) {\n         notifyChanges(username);\n     }\n \n+    private boolean jsonConfigEmpty(byte[] data) {", "originalCommit": "b5a671609b3585553b8558e641b987e424323dbb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e20cca4a056cf8630416feaf37dc0adfe1ecbf96", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e20cca4a056cf8630416feaf37dc0adfe1ecbf96", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-22T14:34:11Z", "type": "commit"}, {"oid": "c34c69d6b340c3aaae10eb1b87af5fa8818041da", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c34c69d6b340c3aaae10eb1b87af5fa8818041da", "message": "checkstyle\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-22T15:43:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NTUyMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r369975521", "bodyText": "Stupid question, but do we test these things also in ITs? Assuming we have ITs for this with a real Zoo and Kafka (I know there are some open issues). That would help to test this already at Travis.", "author": "scholzj", "createdAt": "2020-01-23T08:07:38Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/UserST.java", "diffHunk": "@@ -171,12 +171,19 @@ void testUserWithQuotas() {\n         assertThat(result.out().contains(\"producer_byte_rate=\" + prodRate), is(true));\n         assertThat(result.out().contains(\"consumer_byte_rate=\" + consRate), is(true));\n \n+        String zkListCommand = \"sh /opt/kafka/bin/zookeeper-shell.sh localhost:21810 <<< 'ls /config/users'\";", "originalCommit": "c34c69d6b340c3aaae10eb1b87af5fa8818041da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NzU1Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r369977552", "bodyText": "AFAIK no. I can do it.", "author": "sknot-rh", "createdAt": "2020-01-23T08:13:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NTUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTg0Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r370009843", "bodyText": "I think we need to serialize here.", "author": "tombentley", "createdAt": "2020-01-23T09:29:51Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/operator/ScramShaCredentials.java", "diffHunk": "@@ -76,8 +73,8 @@ public void delete(String username) {\n \n         if (data != null)   {\n             log.debug(\"Deleting {} credentials for user {}\", mechanism.mechanismName(), username);\n-            byte[] deletedJson = deleteUserJson(data);\n-            if (jsonConfigEmpty(deletedJson)) {\n+            JsonObject deletedJson = deleteUserJson(data);\n+            if (configJsonIsEmpty(deletedJson)) {\n                 zkClient.deleteRecursive(\"/config/users/\" + username);\n             } else {\n                 zkClient.writeData(\"/config/users/\" + username, deletedJson);", "originalCommit": "c34c69d6b340c3aaae10eb1b87af5fa8818041da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMDk5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r370500997", "bodyText": "WDYM?", "author": "sknot-rh", "createdAt": "2020-01-24T07:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNjI3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r370526270", "bodyText": "Are you telling me that zkClient knows how to write a JsonObject? Maybe it does, by using toString and converting that to UTF-8 bytes. But maybe it doesn't.", "author": "tombentley", "createdAt": "2020-01-24T08:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMzYwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r370533608", "bodyText": "It seems the serialization is happening https://github.com/sgroschupf/zkclient/blob/master/src/main/java/org/I0Itec/zkclient/ZkClient.java#L1147", "author": "sknot-rh", "createdAt": "2020-01-24T09:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNjgxNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2439#discussion_r370536817", "bodyText": "But what does that actually do? It would be better to do it ourselves here, that way:\n\nWe know it's doing the right thing, and always will.\nWe potentially avoid a pointless intermediate String being created.", "author": "tombentley", "createdAt": "2020-01-24T09:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTg0Mw=="}], "type": "inlineReview"}, {"oid": "39f628583363f5cf2bcdef674d80bc88f8021a43", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/39f628583363f5cf2bcdef674d80bc88f8021a43", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-24T09:57:36Z", "type": "commit"}]}