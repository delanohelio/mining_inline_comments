{"pr_number": 3197, "pr_title": "[systemtest][cleanup] Kafka resource, DeploymentConfig util and ST cleanup ", "pr_createdAt": "2020-06-15T11:08:09Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3197", "timeline": [{"oid": "48ca820dbe32c29047ba4ee9b5937897b965e2cc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/48ca820dbe32c29047ba4ee9b5937897b965e2cc", "message": "add new deployment config util class\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-15T11:01:33Z", "type": "commit"}, {"oid": "c2f371cb1d1d95ac72ca655c0be4b1d6b4b08139", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c2f371cb1d1d95ac72ca655c0be4b1d6b4b08139", "message": "change naming of kafka status method and ...\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-15T11:01:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNjcyMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3197#discussion_r440116720", "bodyText": "I wonder if we really need this. In general, the operator would be waiting the operation timeout several times:\n\nfor Zoo pods\nfor Kafka pods\nfor EO pod\nfor KE pod\nfor CC pod\n\nIn the code you seem to take the 3 as one block valid for single TIMEOUT_FOR_RESOURCE_READINESS. And then for some reason you think the KE and CC pods are worth each TIMEOUT_FOR_RESOURCE_READINESS again.\nIf you think it is needed I'm fine with it. But it seems a bit weird why should KE and CC get this special treatment.", "author": "scholzj", "createdAt": "2020-06-15T11:43:38Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/crd/KafkaResource.java", "diffHunk": "@@ -234,29 +230,17 @@ private static Kafka getKafkaFromYaml(String yamlPath) {\n      * Wait until the ZK, Kafka and EO are all ready\n      */\n     private static Kafka waitFor(Kafka kafka) {\n-        String kafkaCrName = kafka.getMetadata().getName();\n-        String namespace = kafka.getMetadata().getNamespace();\n+        long timeout = Constants.TIMEOUT_FOR_RESOURCE_READINESS;\n \n-        LOGGER.info(\"Waiting for Kafka {} in namespace {}\", kafkaCrName, namespace);\n-\n-        StatefulSetUtils.waitForAllStatefulSetPodsReady(KafkaResources.zookeeperStatefulSetName(kafkaCrName), kafka.getSpec().getZookeeper().getReplicas());\n-        StatefulSetUtils.waitForAllStatefulSetPodsReady(KafkaResources.kafkaStatefulSetName(kafkaCrName), kafka.getSpec().getKafka().getReplicas());\n-\n-        // EO should not be deployed if it does not contain UO and TO\n-        if (kafka.getSpec().getEntityOperator().getTopicOperator() != null || kafka.getSpec().getEntityOperator().getUserOperator() != null) {\n-            DeploymentUtils.waitForDeploymentReady(KafkaResources.entityOperatorDeploymentName(kafkaCrName));\n-        }\n         // Kafka Exporter is not setup every time\n         if (kafka.getSpec().getKafkaExporter() != null) {\n-            DeploymentUtils.waitForDeploymentReady(KafkaExporterResources.deploymentName(kafkaCrName));\n+            timeout += Constants.TIMEOUT_FOR_RESOURCE_CREATION;\n         }\n         // Cruise Control is not setup every time\n         if (kafka.getSpec().getCruiseControl() != null) {\n-            LOGGER.info(\"Waiting for Cruise Control pods\");\n-            DeploymentUtils.waitForDeploymentReady(CruiseControlResources.deploymentName(kafkaCrName));\n-            LOGGER.info(\"Cruise Control pods are ready\");\n+            timeout += Constants.TIMEOUT_FOR_RESOURCE_CREATION;\n         }", "originalCommit": "c2f371cb1d1d95ac72ca655c0be4b1d6b4b08139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExODk4NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3197#discussion_r440118985", "bodyText": "I have there TIMEOUT_FOR_RESOURCE_CREATION and that's like 5 minutes. So the whole Kafka CR -> ZK, Kafka, EO - will have 14 minutes to be ready. If we set up KE or CC it will get +5minutes to whole timeout ... how I mentioned in description, it's only prerequisite and I'll change to proper time (3-5 minutes) in next PR, don't want to make a mess in our Constants.\nIs it OK this way?", "author": "im-konge", "createdAt": "2020-06-15T11:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNjcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTM0Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3197#discussion_r440119343", "bodyText": "And I hope that KE and CC will get up sooner than in 5 minutes. But, we know our race conditions.", "author": "im-konge", "createdAt": "2020-06-15T11:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNjcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEyMTMwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3197#discussion_r440121305", "bodyText": "Ok, I guess that makes more sense.", "author": "scholzj", "createdAt": "2020-06-15T11:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExNjcyMA=="}], "type": "inlineReview"}, {"oid": "fced5ec41f3519e12c63257fc3d5390c3f3ef337", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fced5ec41f3519e12c63257fc3d5390c3f3ef337", "message": "fixup! change naming of kafka status method and ...\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-15T12:55:19Z", "type": "commit"}, {"oid": "fced5ec41f3519e12c63257fc3d5390c3f3ef337", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fced5ec41f3519e12c63257fc3d5390c3f3ef337", "message": "fixup! change naming of kafka status method and ...\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-15T12:55:19Z", "type": "forcePushed"}]}