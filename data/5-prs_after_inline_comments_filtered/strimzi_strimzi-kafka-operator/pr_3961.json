{"pr_number": 3961, "pr_title": "Integration of OAuth over PLAIN", "pr_createdAt": "2020-11-16T10:18:02Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961", "timeline": [{"oid": "f98afa53c112f1e5806a9fc14f4e90bbc5b8b492", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f98afa53c112f1e5806a9fc14f4e90bbc5b8b492", "message": "Add SNAPSHOTS repository with latest strimzi-kafka-oauth master builds\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-12-05T09:51:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3MzU2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r539973568", "bodyText": "so as far as I understood both mechanisms can be enabled at the same time? How it's going to work in that case?", "author": "ppatierno", "createdAt": "2020-12-10T08:35:44Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaBrokerConfigurationBuilder.java", "diffHunk": "@@ -273,9 +274,24 @@ private void configureAuthentication(String listenerName, List<String> securityP\n                 options.add(\"oauth.ssl.truststore.type=\\\"PKCS12\\\"\");\n             }\n \n-            writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\", listenerNameInProperty));\n-            writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required unsecuredLoginStringClaim_sub=\\\"thePrincipalName\\\" %s;\", listenerNameInProperty, String.join(\" \", options)));\n-            writer.println(String.format(\"listener.name.%s.sasl.enabled.mechanisms=OAUTHBEARER\", listenerNameInProperty));\n+            StringBuilder enabledMechanisms = new StringBuilder();\n+            if (oauth.isEnableOauthBearer()) {\n+                writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\", listenerNameInProperty));\n+                writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required unsecuredLoginStringClaim_sub=\\\"thePrincipalName\\\" %s;\", listenerNameInProperty, String.join(\" \", options)));\n+                enabledMechanisms.append(\"OAUTHBEARER\");\n+            }\n+\n+            if (oauth.isEnablePlain()) {\n+                addOption(options, ServerPlainConfig.OAUTH_TOKEN_ENDPOINT_URI, oauth.getTokenEndpointUri());\n+                writer.println(String.format(\"listener.name.%s.plain.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.plain.JaasServerOauthOverPlainValidatorCallbackHandler\", listenerNameInProperty));\n+                writer.println(String.format(\"listener.name.%s.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required %s;\", listenerNameInProperty, String.join(\" \", options)));\n+                if (enabledMechanisms.length() > 0) {\n+                    enabledMechanisms.append(\",\");\n+                }\n+                enabledMechanisms.append(\"PLAIN\");\n+            }\n+\n+            writer.println(String.format(\"listener.name.%s.sasl.enabled.mechanisms=%s\", listenerNameInProperty, enabledMechanisms));", "originalCommit": "8ac3fb4f8ba1ae9f1ad75c95411dccc9aa3e650f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA2MTk5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r540061994", "bodyText": "SASL works by client specifying which mechanism it wants to use, and simply attempting to use that mechanism on the listener. If it fails it is free to try with some other mechanism. The broker simply delegates to the requested mechanism if it was configured and enabled, otherwise it responds to the client that the mechanism is not available.\nOn the server you therefore get multiple enabled SASL mechanisms on the listener:\nlistener.name.external-9094.sasl.enabled.mechanisms: OAUTHBEARER, PLAIN\n\nAnd then each mechanism is properly configured with correct server-side callback handlers:\nlistener.name.external-9094.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\nlistener.name.external-9094.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required  OPTIONS ...;\n\nlistener.name.external-9094.plain.sasl.server.callback.handler.class: io.strimzi.kafka.oauth.server.plain.JaasServerOauthOverPlainValidatorCallbackHandler\nlistener.name.external-9094.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required OPTIONS ...;", "author": "mstruk", "createdAt": "2020-12-10T10:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3MzU2OA=="}], "type": "inlineReview"}, {"oid": "b76e4fe9e71a6521dac014440f5fb517a5de0f1a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b76e4fe9e71a6521dac014440f5fb517a5de0f1a", "message": "Use a custom maven repo for strimzi-kafka-oauth artifacts\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-01-15T10:18:53Z", "type": "forcePushed"}, {"oid": "daf24637dfae2a3149a1830a6540703520cf6c58", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/daf24637dfae2a3149a1830a6540703520cf6c58", "message": "Integration of OAuth over PLAIN\n\nThree config properties added to 'oauth' authentication:\n- 'enablePlain' (`false` by default) and 'enableOauthBearer' (`true` by default) for controlling which SASL mechanisms to enable\n- 'tokenEndpointUri' for setting the endpoint used by broker-side to exchange the received clientId and the secret for the access token\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:35Z", "type": "commit"}, {"oid": "b85f663ac19f771b785d1e5a8b0dc619e21f2491", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b85f663ac19f771b785d1e5a8b0dc619e21f2491", "message": "Add oauth.sh script to kafka images\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:40Z", "type": "commit"}, {"oid": "ef208c57643ba3abcca83e494543182255240aa4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ef208c57643ba3abcca83e494543182255240aa4", "message": "Add jwt.sh script to kafka images + add tokenEndpointUri to authentication for to support clientId + secret with SASL_PLAIN\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:40Z", "type": "commit"}, {"oid": "dddf6e95ffe7105babf98063249180155f37ef4e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dddf6e95ffe7105babf98063249180155f37ef4e", "message": "Add some tests for SASL_PLAIN\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "9c7899b29d0515ba310665af8685dd943577937e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9c7899b29d0515ba310665af8685dd943577937e", "message": "Remove the .yaml-e files from install/cluster-operator\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "e094e53cb484eacdcda2d86f488e2ca36abb0a50", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e094e53cb484eacdcda2d86f488e2ca36abb0a50", "message": "Change ordering for the new options in the docs\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "053cc52bd8786e61829aff74767833eeaab44da5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/053cc52bd8786e61829aff74767833eeaab44da5", "message": "Fix capitalisation of enableOAuthBearer\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "e17566272cd1021e3e15769bb3d100ef7aab1303", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e17566272cd1021e3e15769bb3d100ef7aab1303", "message": "Add SNAPSHOTS repository with latest strimzi-kafka-oauth master builds\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "97336b91fd341491527a0a6d480120d1900b4bee", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97336b91fd341491527a0a6d480120d1900b4bee", "message": "Remove oauth.sh and jwt.sh scripts from docker images.\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "853e5b252a6ed040c0d7a53ab30dec6a57d898b5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/853e5b252a6ed040c0d7a53ab30dec6a57d898b5", "message": "Fix spaces in generated docs\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "31b0ba869216d67f581be53cfc84eb1b2d3cb6e0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/31b0ba869216d67f581be53cfc84eb1b2d3cb6e0", "message": "OAuth over PLAIN fix - decouple 'oauth' authentication from 'keycloak' authorization\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "66647223b0845afdf17faf04d5267fd397b957d7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/66647223b0845afdf17faf04d5267fd397b957d7", "message": "OAuth over PLAIN fix tests for after the coupling fix\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "a752f15feeabf48d616639b4313e25e2d06a2e7c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a752f15feeabf48d616639b4313e25e2d06a2e7c", "message": "OAuth over PLAIN - better fix that avoids multiple kafka.principal.builder declarations\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "b510cc906caaf80bf268564e79415015da8b6745", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b510cc906caaf80bf268564e79415015da8b6745", "message": "Use a custom maven repo for strimzi-kafka-oauth artifacts\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:00:49Z", "type": "commit"}, {"oid": "ca23b454399cd739e3d57ed42f7c17d337b64029", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ca23b454399cd739e3d57ed42f7c17d337b64029", "message": "Exclude json-path dependency of oauth-common\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:00:56Z", "type": "commit"}, {"oid": "5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "message": "Use staging maven repo for 0.7.0 CR2 and exlude json-path deps\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:08:33Z", "type": "commit"}, {"oid": "5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "message": "Use staging maven repo for 0.7.0 CR2 and exlude json-path deps\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:08:33Z", "type": "forcePushed"}, {"oid": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "message": "Fix staging maven repo for 0.7.0 CR2\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T10:16:20Z", "type": "commit"}, {"oid": "2ca084dd49d8b799db6e22421ce17688eda4fc66", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2ca084dd49d8b799db6e22421ce17688eda4fc66", "message": "Remove unnecessary staging repo\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T17:38:04Z", "type": "commit"}, {"oid": "7872e59040b167827e4b79f5520ed91cc2a219b9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7872e59040b167827e4b79f5520ed91cc2a219b9", "message": "Add kafka-oauth-server-plain.jar to kafka 2.7.0 image\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-03T12:13:09Z", "type": "commit"}, {"oid": "ba5dfc01fab86d681a84b40713614d3816d11eda", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ba5dfc01fab86d681a84b40713614d3816d11eda", "message": "Remove RC maven repository so that strimzi-kafka-oauth 0.7.0 release libs are used\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-05T14:15:24Z", "type": "commit"}]}