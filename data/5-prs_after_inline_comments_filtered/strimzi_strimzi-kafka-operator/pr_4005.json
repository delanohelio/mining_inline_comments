{"pr_number": 4005, "pr_title": "Improve Strimzi network policies for Cluster Operator access", "pr_createdAt": "2020-11-25T21:48:12Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005", "timeline": [{"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b2d314b98fe17c7b3b3256492892e8be3ed2968f", "message": "Improve Strimzi network policies for Cluster Operator access\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-11-25T21:37:32Z", "type": "commit"}, {"oid": "18f4076caa421c75f62cc1f71c868fc2fbc67680", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18f4076caa421c75f62cc1f71c868fc2fbc67680", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Jakub Scholz <www@scholzj.com>\n\nCo-authored-by: PaulRMellor <47596553+PaulRMellor@users.noreply.github.com>", "committedDate": "2020-12-01T12:54:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyNzE0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533427147", "bodyText": "Looks like this is repeated 3 times, can we extract a method?", "author": "tombentley", "createdAt": "2020-12-01T13:59:38Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -412,7 +421,20 @@ public NetworkPolicy generateNetworkPolicy(boolean namespaceAndPodSelectorNetwor\n             expressions4.put(Labels.STRIMZI_KIND_LABEL, \"cluster-operator\");\n             labelSelector4.setMatchLabels(expressions4);\n             clusterOperatorPeer.setPodSelector(labelSelector4);\n-            clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+\n+            if (!namespace.equals(operatorNamespace)) {\n+                // If CO and Zoo do not run in the same namespace, we need to handle cross namespace access\n+\n+                if (operatorNamespaceLabels != null)    {\n+                    // If user specified the namespace labels, we can use them to make the selector as tight as possible\n+                    LabelSelector nsLabelSelector = new LabelSelector();\n+                    nsLabelSelector.setMatchLabels(operatorNamespaceLabels.toMap());\n+                    clusterOperatorPeer.setNamespaceSelector(nsLabelSelector);\n+                } else {\n+                    // If no namespace labels were specified, we open the network policy to COs in all namespaces\n+                    clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+                }\n+            }", "originalCommit": "18f4076caa421c75f62cc1f71c868fc2fbc67680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4MDcwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533580708", "bodyText": "Good idea. Thanks.", "author": "scholzj", "createdAt": "2020-12-01T17:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyNzE0Nw=="}], "type": "inlineReview"}, {"oid": "e01f042299df92ab709a7f2f23baa48db4bc039b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e01f042299df92ab709a7f2f23baa48db4bc039b", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-01T17:09:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5Mzk3OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533693978", "bodyText": "\"namespace s\" -> \"namespace as\" ?", "author": "ppatierno", "createdAt": "2020-12-01T20:16:05Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java", "diffHunk": "@@ -479,4 +481,33 @@ public static AffinityBuilder populateAffinityBuilderWithRackLabelSelector(Affin\n         }\n         return builder;\n     }\n+\n+    /**\n+     * Decides whether the Cluster Operator needs namespaceSelector to be configured in the network policies in order\n+     * to talk with the operands. This follows the following rules:\n+     *     - If it runs in the same namespace s the operand, do not set namespace selector", "originalCommit": "e01f042299df92ab709a7f2f23baa48db4bc039b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-01T20:23:57Z", "type": "commit"}]}