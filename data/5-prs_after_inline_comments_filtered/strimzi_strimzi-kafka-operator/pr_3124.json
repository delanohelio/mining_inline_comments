{"pr_number": 3124, "pr_title": "Remove the Kafka.spec.topicOperator logic from the code", "pr_createdAt": "2020-05-31T18:29:05Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3124", "timeline": [{"oid": "c25cba2ad6b26af342e2efb31b7a95d1da43e1d2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c25cba2ad6b26af342e2efb31b7a95d1da43e1d2", "message": "Remove the Kafka.spec.topicOperator logic from the code\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-05-31T18:04:29Z", "type": "commit"}, {"oid": "480e127772ce8c3a0f1b27be796767b1280afc50", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/480e127772ce8c3a0f1b27be796767b1280afc50", "message": "Update CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-05-31T18:28:30Z", "type": "commit"}, {"oid": "23eb9524f5f940b751baab4f7370d3254cec5dc9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/23eb9524f5f940b751baab4f7370d3254cec5dc9", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-06-01T08:20:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyNDIyNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3124#discussion_r433124226", "bodyText": "I wonder, if, going forward renaming this to something like KafkaAssemblyOperatorUnsupportedFieldsTest might be more extensible and then we just add to this file", "author": "samuel-hawker", "createdAt": "2020-06-01T09:08:56Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.cluster.operator.assembly;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBuilder;\n+import io.strimzi.api.kafka.model.status.KafkaStatus;\n+import io.strimzi.certs.CertManager;\n+import io.strimzi.operator.KubernetesVersion;\n+import io.strimzi.operator.PlatformFeaturesAvailability;\n+import io.strimzi.operator.cluster.ClusterOperatorConfig;\n+import io.strimzi.operator.cluster.KafkaVersionTestUtils;\n+import io.strimzi.operator.cluster.ResourceUtils;\n+import io.strimzi.operator.cluster.model.KafkaVersion;\n+import io.strimzi.operator.cluster.operator.resource.ResourceOperatorSupplier;\n+import io.strimzi.operator.common.PasswordGenerator;\n+import io.strimzi.operator.common.Reconciliation;\n+import io.strimzi.operator.common.operator.MockCertManager;\n+import io.strimzi.operator.common.operator.resource.CrdOperator;\n+import io.vertx.core.Future;\n+import io.vertx.core.Vertx;\n+import io.vertx.junit5.Checkpoint;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.text.ParseException;\n+\n+import static org.hamcrest.CoreMatchers.containsString;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(VertxExtension.class)\n+public class KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest {", "originalCommit": "480e127772ce8c3a0f1b27be796767b1280afc50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyODM5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3124#discussion_r433128397", "bodyText": "Might be worth a doc comment something like\n/**\n * spec.topicOperator is now unsupported, to ensure the removal does not cause unwanted warnings for users who  \n * do not use the topicOperator. This test checks this\n */\n@Test\n    public void testNoTopicOperatorWarnings(VertxTestContext context) throws ParseException {", "author": "samuel-hawker", "createdAt": "2020-06-01T09:18:22Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.cluster.operator.assembly;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBuilder;\n+import io.strimzi.api.kafka.model.status.KafkaStatus;\n+import io.strimzi.certs.CertManager;\n+import io.strimzi.operator.KubernetesVersion;\n+import io.strimzi.operator.PlatformFeaturesAvailability;\n+import io.strimzi.operator.cluster.ClusterOperatorConfig;\n+import io.strimzi.operator.cluster.KafkaVersionTestUtils;\n+import io.strimzi.operator.cluster.ResourceUtils;\n+import io.strimzi.operator.cluster.model.KafkaVersion;\n+import io.strimzi.operator.cluster.operator.resource.ResourceOperatorSupplier;\n+import io.strimzi.operator.common.PasswordGenerator;\n+import io.strimzi.operator.common.Reconciliation;\n+import io.strimzi.operator.common.operator.MockCertManager;\n+import io.strimzi.operator.common.operator.resource.CrdOperator;\n+import io.vertx.core.Future;\n+import io.vertx.core.Vertx;\n+import io.vertx.junit5.Checkpoint;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.text.ParseException;\n+\n+import static org.hamcrest.CoreMatchers.containsString;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(VertxExtension.class)\n+public class KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest {\n+    private final KubernetesVersion kubernetesVersion = KubernetesVersion.V1_11;\n+    private final MockCertManager certManager = new MockCertManager();\n+    private final PasswordGenerator passwordGenerator = new PasswordGenerator(10, \"a\", \"a\");\n+    private final ClusterOperatorConfig config = ResourceUtils.dummyClusterOperatorConfig(VERSIONS);\n+    private static final KafkaVersion.Lookup VERSIONS = KafkaVersionTestUtils.getKafkaVersionLookup();\n+    private final String namespace = \"testns\";\n+    private final String clusterName = \"testkafka\";\n+    protected static Vertx vertx;\n+\n+    @BeforeAll\n+    public static void before() {\n+        vertx = Vertx.vertx();\n+    }\n+\n+    @AfterAll\n+    public static void after() {\n+        vertx.close();\n+    }\n+\n+    @Test\n+    public void testNoTopicOperatorWarnings(VertxTestContext context) throws ParseException {", "originalCommit": "480e127772ce8c3a0f1b27be796767b1280afc50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyODY1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3124#discussion_r433128655", "bodyText": "Checking conditions size may be a little flaky going forward if we add more default conditions but there is probably no way around this.", "author": "samuel-hawker", "createdAt": "2020-06-01T09:18:58Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest.java", "diffHunk": "@@ -0,0 +1,192 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.cluster.operator.assembly;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBuilder;\n+import io.strimzi.api.kafka.model.status.KafkaStatus;\n+import io.strimzi.certs.CertManager;\n+import io.strimzi.operator.KubernetesVersion;\n+import io.strimzi.operator.PlatformFeaturesAvailability;\n+import io.strimzi.operator.cluster.ClusterOperatorConfig;\n+import io.strimzi.operator.cluster.KafkaVersionTestUtils;\n+import io.strimzi.operator.cluster.ResourceUtils;\n+import io.strimzi.operator.cluster.model.KafkaVersion;\n+import io.strimzi.operator.cluster.operator.resource.ResourceOperatorSupplier;\n+import io.strimzi.operator.common.PasswordGenerator;\n+import io.strimzi.operator.common.Reconciliation;\n+import io.strimzi.operator.common.operator.MockCertManager;\n+import io.strimzi.operator.common.operator.resource.CrdOperator;\n+import io.vertx.core.Future;\n+import io.vertx.core.Vertx;\n+import io.vertx.junit5.Checkpoint;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.text.ParseException;\n+\n+import static org.hamcrest.CoreMatchers.containsString;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.notNullValue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(VertxExtension.class)\n+public class KafkaAssemblyOperatorWithDeprecatedTopicOperatorTest {\n+    private final KubernetesVersion kubernetesVersion = KubernetesVersion.V1_11;\n+    private final MockCertManager certManager = new MockCertManager();\n+    private final PasswordGenerator passwordGenerator = new PasswordGenerator(10, \"a\", \"a\");\n+    private final ClusterOperatorConfig config = ResourceUtils.dummyClusterOperatorConfig(VERSIONS);\n+    private static final KafkaVersion.Lookup VERSIONS = KafkaVersionTestUtils.getKafkaVersionLookup();\n+    private final String namespace = \"testns\";\n+    private final String clusterName = \"testkafka\";\n+    protected static Vertx vertx;\n+\n+    @BeforeAll\n+    public static void before() {\n+        vertx = Vertx.vertx();\n+    }\n+\n+    @AfterAll\n+    public static void after() {\n+        vertx.close();\n+    }\n+\n+    @Test\n+    public void testNoTopicOperatorWarnings(VertxTestContext context) throws ParseException {\n+        Kafka kafka = new KafkaBuilder()\n+                .withNewMetadata()\n+                    .withName(clusterName)\n+                    .withNamespace(namespace)\n+                    .withGeneration(2L)\n+                .endMetadata()\n+                .withNewSpec()\n+                    .withNewKafka()\n+                        .withReplicas(3)\n+                        .withNewListeners()\n+                            .withNewPlain()\n+                            .endPlain()\n+                        .endListeners()\n+                        .withNewEphemeralStorage()\n+                        .endEphemeralStorage()\n+                    .endKafka()\n+                    .withNewZookeeper()\n+                        .withReplicas(3)\n+                        .withNewEphemeralStorage()\n+                        .endEphemeralStorage()\n+                    .endZookeeper()\n+                .endSpec()\n+                .build();\n+\n+        ResourceOperatorSupplier supplier = ResourceUtils.supplierWithMocks(false);\n+\n+        // Mock the CRD Operator for Kafka resources\n+        CrdOperator mockKafkaOps = supplier.kafkaOperator;\n+        when(mockKafkaOps.getAsync(eq(namespace), eq(clusterName))).thenReturn(Future.succeededFuture(kafka));\n+\n+        ArgumentCaptor<Kafka> kafkaCaptor = ArgumentCaptor.forClass(Kafka.class);\n+        when(mockKafkaOps.updateStatusAsync(kafkaCaptor.capture())).thenReturn(Future.succeededFuture());\n+\n+        MockKafkaAssemblyOperator kao = new MockKafkaAssemblyOperator(\n+                vertx, new PlatformFeaturesAvailability(false, kubernetesVersion),\n+                certManager,\n+                passwordGenerator,\n+                supplier,\n+                config);\n+\n+        Checkpoint async = context.checkpoint();\n+        kao.createOrUpdate(new Reconciliation(\"test-trigger\", Kafka.RESOURCE_KIND, namespace, clusterName), kafka)\n+                .onComplete(context.succeeding(v -> context.verify(() -> {\n+                    assertThat(kafkaCaptor.getValue(), is(notNullValue()));\n+                    assertThat(kafkaCaptor.getValue().getStatus(), is(notNullValue()));\n+                    KafkaStatus status = kafkaCaptor.getValue().getStatus();\n+\n+                    assertThat(status.getConditions().size(), is(1));", "originalCommit": "480e127772ce8c3a0f1b27be796767b1280afc50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE4NjY4OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3124#discussion_r433186688", "bodyText": "I filter through the conditions now to find the two I'm interested in to make it more flexible.", "author": "scholzj", "createdAt": "2020-06-01T11:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyODY1NQ=="}], "type": "inlineReview"}, {"oid": "7d7bf0529223ee7aabd69241ee4afafbfd4e45e4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7d7bf0529223ee7aabd69241ee4afafbfd4e45e4", "message": "Review Comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-06-01T11:41:32Z", "type": "commit"}]}