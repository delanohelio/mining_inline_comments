{"pr_number": 3858, "pr_title": "Jaas config secret", "pr_createdAt": "2020-10-22T23:54:06Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858", "timeline": [{"oid": "2b4ac4908db9ccc948b3175ded68448ecee30006", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2b4ac4908db9ccc948b3175ded68448ecee30006", "message": "Scram user secrets now includes sasl.jaas.config string.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T00:02:44Z", "type": "commit"}, {"oid": "39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "message": "Updated documentation with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T00:02:44Z", "type": "commit"}, {"oid": "39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "message": "Updated documentation with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T00:02:44Z", "type": "forcePushed"}, {"oid": "5cf627554715ff510ad30bafab6313bef6f94775", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cf627554715ff510ad30bafab6313bef6f94775", "message": "Updated CHANGELOG.md with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T00:08:35Z", "type": "commit"}, {"oid": "5cf627554715ff510ad30bafab6313bef6f94775", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cf627554715ff510ad30bafab6313bef6f94775", "message": "Updated CHANGELOG.md with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T00:08:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODAzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510688036", "bodyText": "The above HashMap size should be 2.", "author": "ppatierno", "createdAt": "2020-10-23T07:28:53Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -158,7 +159,8 @@ public Secret generateSecret()  {\n             return createSecret(data);\n         } else if (authentication instanceof KafkaUserScramSha512ClientAuthentication) {\n             Map<String, String> data = new HashMap<>(1);\n-            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(this.scramSha512Password.getBytes(StandardCharsets.US_ASCII)));", "originalCommit": "5cf627554715ff510ad30bafab6313bef6f94775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA0MDUzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r511040531", "bodyText": "The HashMap size should be updated now with the last commit, together with docs and tests changes that you mentioned in other comments.", "author": "allanmoso", "createdAt": "2020-10-23T17:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODI4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510688289", "bodyText": "can you explicit KafkaUserModel.KEY_SASL_JAAS_CONFIG as for the other field please?", "author": "ppatierno", "createdAt": "2020-10-23T07:29:19Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -158,7 +159,8 @@ public Secret generateSecret()  {\n             return createSecret(data);\n         } else if (authentication instanceof KafkaUserScramSha512ClientAuthentication) {\n             Map<String, String> data = new HashMap<>(1);\n-            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(this.scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KEY_SASL_JAAS_CONFIG, Base64.getEncoder().encodeToString(getSaslJsonConfig().getBytes(StandardCharsets.US_ASCII)));", "originalCommit": "5cf627554715ff510ad30bafab6313bef6f94775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MTMyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510691325", "bodyText": "As usual not use the field name, explicit what the parameter represents.", "author": "ppatierno", "createdAt": "2020-10-23T07:35:22Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -394,6 +396,17 @@ public static String getSecretName(String secretPrefix, String username)    {\n         return secretPrefix + username;\n     }\n \n+    /**\n+     * Creates the sasl.jaas.config string for SASL/SCRAM authentication.\n+     *\n+     * @param username The SCRAM username.\n+     * @param password The SCRAM password.\n+     * @return The sasl.jaas.config string.", "originalCommit": "5cf627554715ff510ad30bafab6313bef6f94775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MTU4MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510691580", "bodyText": "ditto as already mentioned both for description and parameter.", "author": "ppatierno", "createdAt": "2020-10-23T07:35:51Z", "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -482,4 +495,14 @@ public boolean isScramUser()  {\n     public boolean isNoneUser()  {\n         return authentication == null;\n     }\n+\n+    /**\n+     * Creates the sasl.jaas.config string for SASL/SCRAM authentication.\n+     *\n+     * @return The sasl.jaas.config string.", "originalCommit": "5cf627554715ff510ad30bafab6313bef6f94775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MzI5Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510693293", "bodyText": "I think you are just testing that the base64 encoding (on Kafka user creation) and the decoding (in the assert) are working not that it returns the JAAS string you would expect. You should also have the expected string somewhere to do the assertation that it's corrected.", "author": "ppatierno", "createdAt": "2020-10-23T07:39:16Z", "path": "user-operator/src/test/java/io/strimzi/operator/user/model/KafkaUserModelTest.java", "diffHunk": "@@ -297,8 +298,12 @@ public void testGenerateSecretGeneratesPasswordWhenNoUserSecretExists()    {\n                         .withKubernetesManagedBy(KafkaUserModel.KAFKA_USER_OPERATOR_NAME)\n                         .toMap()));\n \n-        assertThat(generatedSecret.getData().keySet(), is(singleton(KafkaUserModel.KEY_PASSWORD)));\n-        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_PASSWORD))), is(\"aaaaaaaaaa\"));\n+        assertThat(generatedSecret.getData().keySet(), is(new HashSet<>(Arrays.asList(KafkaUserModel.KEY_PASSWORD, KafkaUserModel.KEY_SASL_JAAS_CONFIG))));\n+\n+        String password = \"aaaaaaaaaa\";\n+        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_PASSWORD))), is(password));\n+        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_SASL_JAAS_CONFIG))),\n+                is(KafkaUserModel.getSaslJsonConfig(ResourceUtils.NAME, password)));", "originalCommit": "5cf627554715ff510ad30bafab6313bef6f94775", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c8e7af525222c7544931294d437f0021718e078a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8e7af525222c7544931294d437f0021718e078a", "message": "PR feedback changes: updated docs and test.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>", "committedDate": "2020-10-23T17:39:36Z", "type": "commit"}]}